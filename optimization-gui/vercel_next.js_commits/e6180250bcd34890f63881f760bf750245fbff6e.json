{
    "author": "wyattjoh",
    "message": "fix(server): fix pages router resume router matching (#84158)\n\n### What?\n\nPrevents PPR resume requests on Pages Router data routes by rejecting\nthem with a 422 status code and adds debug cache entry handlers for\ntesting PPR cache behavior in standalone mode.\n\n### Why?\n\nPPR (Partial Pre-Rendering) is an App Router-specific feature that\nshould not be used with Pages Router routes. When a request includes\nboth:\n1. PPR resume headers (`next-resume: 1`)\n2. A Pages Router data route URL (`/_next/data/...`)\n\nThis represents an invalid request combination that could cause\nunexpected behavior. The server should explicitly reject these\nunprocessable requests rather than attempting to handle them.\n\nAdditionally, testing PPR cache behavior in standalone mode requires\ndebug cache entry handlers that can track cache hits/misses during PPR\nrendering scenarios.\n\n### How?\n\n**Main Fix (packages/next/src/server/base-server.ts:1102-1117):**\n- Added validation after parsing PPR resume headers to check if the\nrequest is also a next data request\n- If both conditions are true, immediately return HTTP 422\n(Unprocessable Entity) with empty response\n- This prevents the request from proceeding to the render pipeline where\nit could cause issues\n\n**Debug Infrastructure:**\n- Added support for `NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS`\nenvironment variable in test mode\n- Enhanced build tracing and required server files manifest to include\ndebug handlers\n- Modified render server to use debug cache entry handlers when\navailable for testing PPR cache behavior",
    "sha": "e6180250bcd34890f63881f760bf750245fbff6e",
    "files": [
        {
            "sha": "e55fc1bef085a18d489e109dddc99410a1c56574",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -818,5 +818,6 @@\n   \"817\": \"`cacheLifeProfiles` should always be provided.\",\n   \"818\": \"`cacheLife()` can only be called inside a \\\"use cache\\\" function.\",\n   \"819\": \"`cacheTag()` can only be called inside a \\\"use cache\\\" function.\",\n-  \"820\": \"`cacheLife()` can only be called during App Router rendering at the moment.\"\n+  \"820\": \"`cacheLife()` can only be called during App Router rendering at the moment.\",\n+  \"821\": \"Unprocessable request\"\n }"
        },
        {
            "sha": "d42f2afefe214e42f37d041a609c4f8c1fec70fe",
            "filename": "packages/next/src/build/collect-build-traces.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -141,6 +141,25 @@ export async function collectBuildTraces({\n         )\n       }\n \n+      // Under standalone mode, we need to ensure that the cache entry debug\n+      // handler is traced so it can be copied. This is only used for testing,\n+      // and is not used in production.\n+      if (\n+        process.env.__NEXT_TEST_MODE &&\n+        process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+      ) {\n+        sharedEntriesSet.push(\n+          require.resolve(\n+            path.isAbsolute(process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS)\n+              ? process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+              : path.join(\n+                  dir,\n+                  process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+                )\n+          )\n+        )\n+      }\n+\n       if (cacheHandlers) {\n         for (const handlerPath of Object.values(cacheHandlers)) {\n           if (handlerPath) {"
        },
        {
            "sha": "cc8c7ba21a1b80ea14d8c5203fdc08bf88d35114",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -2704,6 +2704,28 @@ export default async function build(\n         )\n       }\n \n+      // Under standalone mode, we need to ensure that the cache entry debug\n+      // handler is copied so that it can be used in the test. This is required\n+      // for the turbopack test to run as it's more strict about the build\n+      // directories. This is only used for testing and is not used in\n+      // production.\n+      if (\n+        process.env.__NEXT_TEST_MODE &&\n+        process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+      ) {\n+        requiredServerFilesManifest.files.push(\n+          path.relative(\n+            dir,\n+            path.isAbsolute(process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS)\n+              ? process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+              : path.join(\n+                  dir,\n+                  process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+                )\n+          )\n+        )\n+      }\n+\n       const features: EventBuildFeatureUsage[] = [\n         {\n           featureName: 'experimental/cacheComponents',"
        },
        {
            "sha": "f47923c4215a64d355b975dc8935a87822103221",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -1078,9 +1078,10 @@ export default abstract class Server<\n           if (this.normalizers.data?.match(urlPathname)) {\n             addRequestMeta(req, 'isNextDataReq', true)\n           }\n-          // In minimal mode, if PPR is enabled, then we should check to see if\n-          // the request should be a resume request.\n-          else if (\n+\n+          // It's important to execute the following block even it the request\n+          // matches a pages data route from above.\n+          if (\n             this.isAppPPREnabled &&\n             this.minimalMode &&\n             req.headers[NEXT_RESUME_HEADER] === '1' &&\n@@ -1098,6 +1099,22 @@ export default abstract class Server<\n             addRequestMeta(req, 'postponed', postponed)\n           }\n \n+          // If the request is a next data request and it has a postponed state,\n+          // we should error, as it represents an unprocessable request.\n+          if (\n+            getRequestMeta(req, 'isNextDataReq') &&\n+            getRequestMeta(req, 'postponed')\n+          ) {\n+            // The server understood that this is a PPR resume request, as the\n+            // headers were included to correctly indicate a resume request, but\n+            // because the request URL indicates that this should render a next\n+            // data route (a pages router route), this represents an\n+            // unprocessable request.\n+            res.statusCode = 422\n+            res.send()\n+            return\n+          }\n+\n           matchedPath = this.normalize(matchedPath)\n           const normalizedUrlPath = this.stripNextDataPath(urlPathname)\n "
        },
        {
            "sha": "ff5e62d33e2395395421f50408c7c4767918957e",
            "filename": "packages/next/src/server/lib/render-server.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 2,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -4,6 +4,10 @@ import type { PropagateToWorkersField } from './router-utils/types'\n \n import next from '../next'\n import type { Span } from '../../trace'\n+import type { ServerResponse } from 'http'\n+import type { OnCacheEntryHandler } from '../request-meta'\n+import { interopDefault } from '../../lib/interop-default'\n+import { formatDynamicImportPath } from '../../lib/format-dynamic-import-path'\n \n export type ServerInitResult = {\n   requestHandler: RequestHandler\n@@ -103,8 +107,55 @@ async function initializeImpl(opts: {\n     httpServer: opts.server,\n     port: opts.port,\n   }) as NextServer // should return a NextServer when `customServer: false`\n-  requestHandler = server.getRequestHandler()\n-  upgradeHandler = server.getUpgradeHandler()\n+\n+  // If we're in test mode and there's a debug cache entry handler available,\n+  // then use it to wrap the request handler instead of using the default one.\n+  if (\n+    process.env.__NEXT_TEST_MODE &&\n+    process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+  ) {\n+    // This mirrors the sole implementation of this over in:\n+    // test/production/standalone-mode/required-server-files/cache-entry-handler.js\n+    const createOnCacheEntryHandlers = interopDefault(\n+      await import(\n+        formatDynamicImportPath(\n+          opts.dir,\n+          process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n+        )\n+      )\n+    ) as (res: ServerResponse) => {\n+      // TODO: remove onCacheEntry once onCacheEntryV2 is the default.\n+      onCacheEntry: OnCacheEntryHandler\n+      onCacheEntryV2: OnCacheEntryHandler\n+    }\n+\n+    // This is not to be used in any environment other than testing, as it is\n+    // not memoized and is subject to constant change.\n+    requestHandler = async (req, res, parsedUrl) => {\n+      // Re re-create the entry handler for each request. This is not\n+      // performant, and is only used in testing environments.\n+      const {\n+        // TODO: remove onCacheEntry once onCacheEntryV2 is the default.\n+        onCacheEntry,\n+        onCacheEntryV2,\n+      } = createOnCacheEntryHandlers(res)\n+\n+      // Get the request handler, using the entry handler as the metadata each\n+      // request.\n+      const handler = server.getRequestHandlerWithMetadata({\n+        // TODO: remove onCacheEntry once onCacheEntryV2 is the default.\n+        onCacheEntry,\n+        onCacheEntryV2,\n+      })\n+\n+      return handler(req, res, parsedUrl)\n+    }\n+\n+    upgradeHandler = server.getUpgradeHandler()\n+  } else {\n+    requestHandler = server.getRequestHandler()\n+    upgradeHandler = server.getUpgradeHandler()\n+  }\n \n   await server.prepare(opts.serverFields)\n "
        },
        {
            "sha": "f1b059b3bdf7e3026173a3aa60ed570eb3c5041d",
            "filename": "packages/next/src/server/lib/trace/constants.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ftrace%2Fconstants.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -30,6 +30,7 @@ enum LoadComponentsSpan {\n \n enum NextServerSpan {\n   getRequestHandler = 'NextServer.getRequestHandler',\n+  getRequestHandlerWithMetadata = 'NextServer.getRequestHandlerWithMetadata',\n   getServer = 'NextServer.getServer',\n   getServerRequestHandler = 'NextServer.getServerRequestHandler',\n   createServer = 'createServer.createServer',"
        },
        {
            "sha": "e32db144b8d42521b26810305e1d9e49a89c62da",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -13,7 +13,11 @@ import type RenderResult from './render-result'\n import type { FetchEventResult } from './web/types'\n import type { PrerenderManifest, RoutesManifest } from '../build'\n import type { PagesManifest } from '../build/webpack/plugins/pages-manifest-plugin'\n-import type { NextParsedUrlQuery, NextUrlWithParsedQuery } from './request-meta'\n+import type {\n+  NextParsedUrlQuery,\n+  NextUrlWithParsedQuery,\n+  RequestMeta,\n+} from './request-meta'\n import type { Params } from './request/params'\n import type { MiddlewareRouteMatch } from '../shared/lib/router/utils/middleware-route-matcher'\n import type { RouteMatch } from './route-matches/route-match'\n@@ -27,7 +31,7 @@ import type { WaitUntil } from './after/builtin-request-context'\n import fs from 'fs'\n import { join, relative } from 'path'\n import { getRouteMatcher } from '../shared/lib/router/utils/route-matcher'\n-import { addRequestMeta, getRequestMeta } from './request-meta'\n+import { addRequestMeta, getRequestMeta, setRequestMeta } from './request-meta'\n import {\n   PAGES_MANIFEST,\n   BUILD_ID_FILE,\n@@ -1273,6 +1277,17 @@ export default class NextNodeServer extends BaseServer<\n     return handler\n   }\n \n+  /**\n+   * @internal - this method is internal to Next.js and should not be used directly by end-users\n+   */\n+  public getRequestHandlerWithMetadata(meta: RequestMeta): NodeRequestHandler {\n+    const handler = this.makeRequestHandler()\n+    return (req, res, parsedUrl) => {\n+      setRequestMeta(req, meta)\n+      return handler(req, res, parsedUrl)\n+    }\n+  }\n+\n   private makeRequestHandler(): NodeRequestHandler {\n     // This is just optimization to fire prepare as soon as possible. It will be\n     // properly awaited later. We add the catch here to ensure that it does not"
        },
        {
            "sha": "88de1cd32a45d3a0e507c4f7f2f808593ab5cb8f",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -6,7 +6,7 @@ import type {\n import type { UrlWithParsedQuery } from 'url'\n import type { IncomingMessage, ServerResponse } from 'http'\n import type { Duplex } from 'stream'\n-import type { NextUrlWithParsedQuery } from './request-meta'\n+import type { NextUrlWithParsedQuery, RequestMeta } from './request-meta'\n \n import './require-hook'\n import './node-polyfill-crypto'\n@@ -148,6 +148,27 @@ export class NextServer implements NextWrapperServer {\n     }\n   }\n \n+  /**\n+   * @internal - this method is internal to Next.js and should not be used\n+   * directly by end-users, only used in testing\n+   */\n+  getRequestHandlerWithMetadata(meta: RequestMeta): RequestHandler {\n+    return async (\n+      req: IncomingMessage,\n+      res: ServerResponse,\n+      parsedUrl?: UrlWithParsedQuery\n+    ) => {\n+      return getTracer().trace(\n+        NextServerSpan.getRequestHandlerWithMetadata,\n+        async () => {\n+          const server = await this.getServer()\n+          const handler = server.getRequestHandlerWithMetadata(meta)\n+          return handler(req, res, parsedUrl)\n+        }\n+      )\n+    }\n+  }\n+\n   getUpgradeHandler(): UpgradeHandler {\n     return async (req: IncomingMessage, socket: any, head: any) => {\n       const server = await this.getServer()"
        },
        {
            "sha": "7cc015a1d8e979df718d16b700725e3dbf50a065",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 12,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -21,6 +21,28 @@ export type NextIncomingMessage = (BaseNextRequest | IncomingMessage) & {\n   [NEXT_REQUEST_META]?: RequestMeta\n }\n \n+/**\n+ * The callback function to call when a response cache entry was generated or\n+ * looked up in the cache. When it returns true, the server assumes that the\n+ * handler has already responded to the request and will not do so itself.\n+ */\n+export type OnCacheEntryHandler = (\n+  /**\n+   * The response cache entry that was generated or looked up in the cache.\n+   */\n+  cacheEntry: ResponseCacheEntry,\n+\n+  /**\n+   * The request metadata.\n+   */\n+  requestMeta: {\n+    /**\n+     * The URL that was used to make the request.\n+     */\n+    url: string | undefined\n+  }\n+) => Promise<boolean | void> | boolean | void\n+\n export interface RequestMeta {\n   /**\n    * The query that was used to make the request.\n@@ -126,23 +148,13 @@ export interface RequestMeta {\n    *\n    * @deprecated Use `onCacheEntryV2` instead.\n    */\n-  onCacheEntry?: (\n-    cacheEntry: ResponseCacheEntry,\n-    requestMeta: {\n-      url: string | undefined\n-    }\n-  ) => Promise<boolean | void> | boolean | void\n+  onCacheEntry?: OnCacheEntryHandler\n \n   /**\n    * If provided, this will be called when a response cache entry was generated\n    * or looked up in the cache.\n    */\n-  onCacheEntryV2?: (\n-    cacheEntry: ResponseCacheEntry,\n-    requestMeta: {\n-      url: string | undefined\n-    }\n-  ) => Promise<boolean | void> | boolean | void\n+  onCacheEntryV2?: OnCacheEntryHandler\n \n   /**\n    * The previous revalidate before rendering 404 page for notFound: true"
        },
        {
            "sha": "1598264e2702d7d1481970e4c1c55ba6e7bed02e",
            "filename": "test/production/standalone-mode/required-server-files/app/@slot/[...catchAll]/loading.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Floading.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Floading.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Floading.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <p id=\"slot-loading\">/[...catchAll]</p>\n+}"
        },
        {
            "sha": "d512b5bb4a8b67b941f562176bfb7a4dd96db92b",
            "filename": "test/production/standalone-mode/required-server-files/app/@slot/[...catchAll]/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2F%5B...catchAll%5D%2Fpage.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,8 @@\n+export default async function Page({ params }) {\n+  return (\n+    <>\n+      <p id=\"slot-page\">/@slot/[[...catchAll]]/page.js</p>\n+      <p id=\"slot-params\">{JSON.stringify(await params)}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "bc7055e9d4c55c8bc41848eba87931ed4024af08",
            "filename": "test/production/standalone-mode/required-server-files/app/@slot/default.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2Fdefault.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2Fdefault.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2F%40slot%2Fdefault.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Default() {\n+  return '/@slot/default.js'\n+}"
        },
        {
            "sha": "e4901fafc5023bc6c61adae1d26a0f9daf48f1e5",
            "filename": "test/production/standalone-mode/required-server-files/app/default.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fdefault.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fdefault.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fdefault.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Default() {\n+  return '/default.js'\n+}"
        },
        {
            "sha": "cca9c659521b48bc6d687055833bdc47c3c89062",
            "filename": "test/production/standalone-mode/required-server-files/app/layout.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Flayout.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -1,8 +1,15 @@\n-export default function Layout({ children }) {\n+import { Suspense } from 'react'\n+\n+export default function Layout({ children, slot }) {\n   return (\n     <html lang=\"en\">\n       <head />\n-      <body>{children}</body>\n+      <body>\n+        <Suspense>\n+          <div id=\"children-slot\">{children}</div>\n+          <div id=\"slot-slot\">{slot}</div>\n+        </Suspense>\n+      </body>\n     </html>\n   )\n }"
        },
        {
            "sha": "82f1ad69cb48d5db1d9a93e6012c464e58d5ec97",
            "filename": "test/production/standalone-mode/required-server-files/app/postpone/isr/[slug]/page.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fpostpone%2Fisr%2F%5Bslug%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fpostpone%2Fisr%2F%5Bslug%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fpostpone%2Fisr%2F%5Bslug%5D%2Fpage.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -2,7 +2,7 @@ export default async function Page({ params }) {\n   return (\n     <>\n       <p id=\"page\">/postpone/isr/[slug]</p>\n-      <p id=\"params\">{JSON.stringify(params)}</p>\n+      <p id=\"params\">{JSON.stringify(await params)}</p>\n       <p id=\"now\">{Date.now()}</p>\n     </>\n   )"
        },
        {
            "sha": "8cfc4254b762b98807fa2baadf3d8f5847fd1f21",
            "filename": "test/production/standalone-mode/required-server-files/cache-entry-handlers.js",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fcache-entry-handlers.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fcache-entry-handlers.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fcache-entry-handlers.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,66 @@\n+// @ts-check\n+\n+/**\n+ * @param {import('http').ServerResponse} res\n+ * @returns {{\n+ *   onCacheEntry: import('next/dist/server/request-meta').OnCacheEntryHandler,\n+ *   onCacheEntryV2: import('next/dist/server/request-meta').OnCacheEntryHandler\n+ * }}\n+ */\n+module.exports = (res) => ({\n+  onCacheEntry: (cacheEntry, meta) => {\n+    // If this isn't a static app page response from the response cache, then\n+    // mark it as a miss.\n+    if (\n+      !cacheEntry.value ||\n+      cacheEntry.value.kind !== 'APP_PAGE' ||\n+      !cacheEntry.value.html ||\n+      typeof cacheEntry.value.html.toUnchunkedString !== 'function' ||\n+      !cacheEntry.value.postponed ||\n+      !meta.url ||\n+      typeof meta.url !== 'string'\n+    ) {\n+      res.setHeader('x-nextjs-cache-entry-handler', 'MISS_1')\n+      return false\n+    }\n+\n+    // If this is for a RSC request, then mark it as a miss.\n+    if (meta.url.endsWith('.rsc')) {\n+      res.setHeader('x-nextjs-cache-entry-handler', 'MISS_1')\n+      return false\n+    }\n+\n+    // Mark this as a hit against the cache entry handler.\n+    res.setHeader('x-nextjs-cache-entry-handler', 'HIT_1')\n+    return false\n+  },\n+  onCacheEntryV2: (cacheEntry, meta) => {\n+    // If this isn't a static app page response from the response cache, then\n+    // mark it as a miss.\n+    if (\n+      !cacheEntry.value ||\n+      cacheEntry.value.kind !== 'APP_PAGE' ||\n+      !cacheEntry.value.html ||\n+      typeof cacheEntry.value.html.toUnchunkedString !== 'function' ||\n+      !cacheEntry.value.postponed ||\n+      !meta.url ||\n+      typeof meta.url !== 'string'\n+    ) {\n+      res.setHeader('x-nextjs-cache-entry-handler', 'MISS_2')\n+      return false\n+    }\n+\n+    // If this is for a prefetch or segment request, then mark it as a miss.\n+    if (\n+      meta.url.endsWith('.prefetch.rsc') ||\n+      meta.url.endsWith('.segment.rsc')\n+    ) {\n+      res.setHeader('x-nextjs-cache-entry-handler', 'MISS_2')\n+      return false\n+    }\n+\n+    // Mark this as a hit against the cache entry handler.\n+    res.setHeader('x-nextjs-cache-entry-handler', 'HIT_2')\n+    return false\n+  },\n+})"
        },
        {
            "sha": "067c5f981936f26b33e83280367ca9d19149eda7",
            "filename": "test/production/standalone-mode/required-server-files/ppr/app/not-found.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fppr%2Fapp%2Fnot-found.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fppr%2Fapp%2Fnot-found.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fppr%2Fapp%2Fnot-found.js?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -0,0 +1,11 @@\n+import { connection } from 'next/server'\n+\n+export default async function NotFound() {\n+  await connection()\n+\n+  return (\n+    <>\n+      <p id=\"not-found\">/not-found</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "6958e1de73b03e03f2ecfc89bcdde83ab823632e",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-ppr.test.ts",
            "status": "modified",
            "additions": 114,
            "deletions": 6,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e6180250bcd34890f63881f760bf750245fbff6e/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts?ref=e6180250bcd34890f63881f760bf750245fbff6e",
            "patch": "@@ -26,24 +26,38 @@ describe('required server files app router', () => {\n   beforeAll(async () => {\n     process.env.NOW_BUILDER = '1'\n     process.env.NEXT_PRIVATE_TEST_HEADERS = '1'\n+    process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS =\n+      './cache-entry-handlers.js'\n \n     // Setup the Next.js app and build it.\n     next = await createNext({\n       files: {\n         app: new FileRef(join(__dirname, 'app')),\n+        'pages/catch-all/[[...rest]].js': new FileRef(\n+          join(__dirname, 'pages', 'catch-all', '[[...rest]].js')\n+        ),\n         lib: new FileRef(join(__dirname, 'lib')),\n         'cache-handler.js': new FileRef(join(__dirname, 'cache-handler.js')),\n         'middleware.js': new FileRef(join(__dirname, 'middleware.js')),\n         'data.txt': new FileRef(join(__dirname, 'data.txt')),\n         '.env': new FileRef(join(__dirname, '.env')),\n         '.env.local': new FileRef(join(__dirname, '.env.local')),\n         '.env.production': new FileRef(join(__dirname, '.env.production')),\n+        'cache-entry-handlers.js': new FileRef(\n+          join(__dirname, 'cache-entry-handlers.js')\n+        ),\n+      },\n+      overrideFiles: {\n+        'app/not-found.js': new FileRef(\n+          join(__dirname, 'ppr', 'app', 'not-found.js')\n+        ),\n       },\n       nextConfig: {\n         cacheHandler: './cache-handler.js',\n         experimental: {\n           ppr: true,\n           clientSegmentCache: true,\n+          clientParamParsing: true,\n         },\n         eslint: {\n           ignoreDuringBuilds: true,\n@@ -95,6 +109,7 @@ describe('required server files app router', () => {\n       /- Local:/,\n       {\n         ...process.env,\n+        __NEXT_TEST_MODE: 'e2e',\n         PORT: `${appPort}`,\n         NEXT_PRIVATE_DEBUG_CACHE: '1',\n       },\n@@ -114,6 +129,7 @@ describe('required server files app router', () => {\n   afterAll(async () => {\n     delete process.env.NOW_BUILDER\n     delete process.env.NEXT_PRIVATE_TEST_HEADERS\n+    delete process.env.NEXT_PRIVATE_DEBUG_CACHE_ENTRY_HANDLERS\n     await next.destroy()\n     if (server) await killApp(server)\n   })\n@@ -145,6 +161,10 @@ describe('required server files app router', () => {\n \n       expect(res.status).toBe(200)\n       expect(res.headers.get('content-type')).toBe('text/x-component')\n+\n+      // We expect that because we're performing a segment prefetch, we\n+      // shouldn't even get to the cache entry handler.\n+      expect(res.headers.has('x-nextjs-cache-entry-handler')).toBe(false)\n     }\n \n     expect(\n@@ -164,6 +184,9 @@ describe('required server files app router', () => {\n \n     expect(res.status).toBe(200)\n \n+    // We expect that because we're performing a resume, we should be a miss.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_2')\n+\n     let chunks = []\n \n     for await (const chunk of res.body) {\n@@ -239,6 +262,45 @@ describe('required server files app router', () => {\n     expect(rscRes.status).toBe(200)\n   })\n \n+  it('should properly handle resume request that looks like a data request', async () => {\n+    const metadata = await next.readJSON('.next/server/app/[...catchAll].meta')\n+    const postponed = metadata.postponed\n+\n+    const res = await fetchViaHTTP(\n+      appPort,\n+      // The pathname here represents a route that doesn't actually exist, but\n+      // we want to simulate a pages route Link that performs a prefetch to a\n+      // route backed by PPR.\n+      `/_next/data/${next.buildId}/index.json`,\n+      undefined,\n+      {\n+        method: 'POST',\n+        headers: {\n+          'x-matched-path': '/[...catchAll]',\n+          'x-now-route-matches': createNowRouteMatches({\n+            catchAll: `_next/data/${next.buildId}/index.json`,\n+          }).toString(),\n+          'next-resume': '1',\n+        },\n+        body: postponed,\n+      }\n+    )\n+\n+    // Expect that the status code is 422, we asked for a /_next/data route and\n+    // also indicated that we wanted to resume a PPR render (which is\n+    // impossible).\n+    expect(res.status).toBe(422)\n+\n+    // We expect that because we have a short-circuit for these unprocessable\n+    // requests, we should not have a cache entry handler header because it\n+    // should never get reached.\n+    expect(res.headers.has('x-nextjs-cache-entry-handler')).toBe(false)\n+\n+    // Expect that the response body is empty.\n+    const html = await res.text()\n+    expect(html).toBeEmpty()\n+  })\n+\n   describe('middleware rewrite', () => {\n     it('should work with a dynamic path with Next-Resume', async () => {\n       const res = await fetchViaHTTP(\n@@ -256,6 +318,10 @@ describe('required server files app router', () => {\n       )\n \n       expect(res.status).toBe(200)\n+\n+      // We expect that because we're performing a resume, we should be a miss.\n+      expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_2')\n+\n       const html = await res.text()\n       const $ = cheerio.load(html)\n \n@@ -279,6 +345,9 @@ describe('required server files app router', () => {\n \n     expect(res.status).toBe(200)\n \n+    // We expect that because we're performing a resume, we should be a miss.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_2')\n+\n     const html = await res.text()\n \n     // Expect that the closing HTML tag is still present, indicating a\n@@ -311,6 +380,12 @@ describe('required server files app router', () => {\n       })\n       expect(res.status).toBe(200)\n       expect(res.headers.get('x-next-cache-tags')).toBe(tags)\n+\n+      if (!path.startsWith('/api')) {\n+        // We expect that because these aren't ISR'ed, they should all be a\n+        // hit!\n+        expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('HIT_2')\n+      }\n     }\n   })\n \n@@ -324,8 +399,15 @@ describe('required server files app router', () => {\n       const res = await fetchViaHTTP(appPort, path, undefined, {\n         redirect: 'manual',\n       })\n+\n       expect(res.status).toBe(200)\n       expect(res.headers.get('x-next-cache-tags')).toBeFalsy()\n+\n+      if (!path.startsWith('/api')) {\n+        // We expect that because these aren't SSR'ed, they should all be a\n+        // miss.\n+        expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_1')\n+      }\n     }\n   })\n \n@@ -344,8 +426,15 @@ describe('required server files app router', () => {\n           redirect: 'manual',\n         }\n       )\n+\n       expect(res.status).toBe(200)\n       expect(res.headers.get('x-next-cache-tags')).toBeFalsy()\n+\n+      if (!path.startsWith('/api')) {\n+        // We expect that because these aren't SSR'ed, they should all be a\n+        // miss.\n+        expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_1')\n+      }\n     }\n   })\n \n@@ -382,6 +471,10 @@ describe('required server files app router', () => {\n     expect(res.status).toBe(200)\n     expect(res.headers.get('content-type')).toEqual('text/x-component')\n     expect(res.headers.has('x-nextjs-postponed')).toBeTrue()\n+\n+    // We expect that because we're performing a prefetch, we should be a miss\n+    // because it isn't handled by the cache handler.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_2')\n   })\n \n   it('should use the postponed state for the RSC requests', async () => {\n@@ -417,10 +510,15 @@ describe('required server files app router', () => {\n     expect(res.headers.get('content-type')).toEqual('text/x-component')\n     expect(res.headers.has('x-nextjs-postponed')).toBeFalse()\n \n+    // We expect that because we requested this dynamic RSC route without\n+    // resuming it, it should be a hit because it should be producing a new\n+    // static render.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('HIT_2')\n+\n     // We expect that the random value is not present in the response because\n     // we're not providing a resume data cache via the postponed state.\n     // Instead it'll contain another random number that's been generated at\n-    // runtime.\n+    // runtime during this new static render.\n     let rsc = await res.text()\n     expect(rsc).not.toContain(random)\n \n@@ -429,11 +527,10 @@ describe('required server files app router', () => {\n       expect(cliOutput.substring(start)).toContain('cache-handler get')\n       expect(cliOutput.substring(start)).toContain('cache-handler set')\n \n-      // We expect that there is no resume data cache hit or miss because\n-      // we're not providing a resume data cache via the postponed state.\n-      expect(cliOutput.substring(start)).not.toContain('rdc:miss')\n-      expect(cliOutput.substring(start)).not.toContain('rdc:hit')\n-      expect(cliOutput.substring(start)).toContain('rdc:no-resume-data')\n+      // We expect that there is both a miss and a hit because we're producing a\n+      // new static render.\n+      expect(cliOutput.substring(start)).toContain('rdc:miss')\n+      expect(cliOutput.substring(start)).toContain('rdc:set')\n     })\n \n     // Reset the start of the logs for this test.\n@@ -457,6 +554,11 @@ describe('required server files app router', () => {\n     expect(res.headers.get('content-type')).toEqual('text/x-component')\n     expect(res.headers.has('x-nextjs-postponed')).toBeFalse()\n \n+    // We expect that because we're resuming, it should be a miss, because it\n+    // won't be producing a static response, and instead will be performing a\n+    // dynamic render.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('MISS_2')\n+\n     // We expect that the random value is present in the response because\n     // we're providing a resume data cache via the postponed state.\n     rsc = await res.text()\n@@ -490,15 +592,21 @@ describe('required server files app router', () => {\n \n     expect(res.status).toBe(200)\n \n+    // We expect that the cache entry handler was hit because we're performing a\n+    // static render in minimal mode on a page that will suspend.\n+    expect(res.headers.get('x-nextjs-cache-entry-handler')).toBe('HIT_2')\n+\n     const html = await res.text()\n \n+    // We only expect a partial shell because the page will suspend.\n     expect(html).not.toContain('</html>')\n \n     const $ = cheerio.load(html)\n \n     expect($('#page').text()).toBeEmpty()\n     expect($('#params').text()).toBeEmpty()\n     expect($('#now').text()).toBeEmpty()\n+    expect($('#slot-loading').text()).toBe('/[...catchAll]')\n     expect($('#loading').text()).toBe('/postpone/isr/[slug]')\n   })\n })"
        }
    ],
    "stats": {
        "total": 428,
        "additions": 398,
        "deletions": 30
    }
}