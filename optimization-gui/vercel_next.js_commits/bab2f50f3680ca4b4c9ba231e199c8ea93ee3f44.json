{
    "author": "eps1lon",
    "message": "Cleanup webpack sourcemap middleware source URL handling (#75879)\n\nMostly clarifying where we deal with source URLs instead of paths and remove some redundant or unused code.",
    "sha": "bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44",
    "files": [
        {
            "sha": "508b370673b57a1da06844af4f43f50f4ad14a2c",
            "filename": "packages/next/src/build/webpack/plugins/wellknown-errors-plugin/parseNotFoundError.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNotFoundError.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNotFoundError.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fwellknown-errors-plugin%2FparseNotFoundError.ts?ref=bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44",
            "patch": "@@ -68,7 +68,7 @@ async function getSourceFrame(\n           ignoredSources: getIgnoredSources(sourceMap),\n           compilation,\n           moduleId,\n-          modulePath: fileName,\n+          moduleURL: fileName,\n         },\n         rootDirectory: compilation.options.context!,\n         frame: {"
        },
        {
            "sha": "c42c4196646dacb7f355499e6a4871db25cace78",
            "filename": "packages/next/src/client/components/react-dev-overlay/internal/helpers/webpack-module-path.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Finternal%2Fhelpers%2Fwebpack-module-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Finternal%2Fhelpers%2Fwebpack-module-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Finternal%2Fhelpers%2Fwebpack-module-path.ts?ref=bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44",
            "patch": "@@ -26,10 +26,10 @@ export function isWebpackInternalResource(file: string) {\n  * webpack://./src/hello.tsx => ./src/hello.tsx\n  * webpack:///./src/hello.tsx => ./src/hello.tsx\n  */\n-export function formatFrameSourceFile(file: string) {\n+export function formatFrameSourceFile(sourceURL: string) {\n   for (const regex of replacementRegExes) {\n-    file = file.replace(regex, '')\n+    sourceURL = sourceURL.replace(regex, '')\n   }\n \n-  return file\n+  return sourceURL\n }"
        },
        {
            "sha": "a56fe4320ca21094c9b8c4b939141d7631a69181",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-webpack.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 40,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts?ref=bab2f50f3680ca4b4c9ba231e199c8ea93ee3f44",
            "patch": "@@ -1,6 +1,6 @@\n import { constants as FS, promises as fs } from 'fs'\n import path from 'path'\n-import url from 'url'\n+import { fileURLToPath, pathToFileURL } from 'url'\n import {\n   SourceMapConsumer,\n   type BasicSourceMapConsumer,\n@@ -33,12 +33,12 @@ import { formatFrameSourceFile } from '../internal/helpers/webpack-module-path'\n import type { MappedPosition } from 'source-map'\n import { inspect } from 'util'\n \n-function shouldIgnorePath(modulePath: string): boolean {\n+function shouldIgnoreSource(sourceURL: string): boolean {\n   return (\n-    modulePath.includes('node_modules') ||\n+    sourceURL.includes('node_modules') ||\n     // Only relevant for when Next.js is symlinked e.g. in the Next.js monorepo\n-    modulePath.includes('next/dist') ||\n-    modulePath.startsWith('node:')\n+    sourceURL.includes('next/dist') ||\n+    sourceURL.startsWith('node:')\n   )\n }\n \n@@ -58,15 +58,15 @@ type Source =\n       type: 'file'\n       sourceMap: RawSourceMap\n       ignoredSources: IgnoredSources\n-      modulePath: string\n+      moduleURL: string\n     }\n   | {\n       type: 'bundle'\n       sourceMap: RawSourceMap\n       ignoredSources: IgnoredSources\n       compilation: webpack.Compilation\n       moduleId: string\n-      modulePath: string\n+      moduleURL: string\n     }\n \n function getModuleById(\n@@ -83,6 +83,9 @@ function findModuleNotFoundFromError(errorMessage: string | undefined) {\n }\n \n function getSourcePath(source: string) {\n+  if (source.startsWith('file://')) {\n+    return fileURLToPath(source)\n+  }\n   return source.replace(/^(webpack:\\/\\/\\/|webpack:\\/\\/|webpack:\\/\\/_N_E\\/)/, '')\n }\n \n@@ -131,10 +134,10 @@ export function getIgnoredSources(sourceMap: RawSourceMap): IgnoredSources {\n \n   for (let index = 0; index < moduleFilenames.length; index++) {\n     // bundlerFilePath case: webpack://./app/page.tsx\n-    const bundlerFilePath = moduleFilenames[index]\n+    const webpackSourceURL = moduleFilenames[index]\n     // Format the path to the normal file path\n-    const formattedFilePath = formatFrameSourceFile(bundlerFilePath)\n-    if (shouldIgnorePath(formattedFilePath)) {\n+    const formattedFilePath = formatFrameSourceFile(webpackSourceURL)\n+    if (shouldIgnoreSource(formattedFilePath)) {\n       ignoreList.add(index)\n     }\n   }\n@@ -187,7 +190,7 @@ export async function createOriginalStackFrame({\n }): Promise<OriginalStackFrameResponse | null> {\n   const { lineNumber, column } = frame\n   const moduleNotFound = findModuleNotFoundFromError(errorMessage)\n-  const result = await (async () => {\n+  const result = await (() => {\n     if (moduleNotFound) {\n       if (source.type === 'file') {\n         return undefined\n@@ -200,7 +203,7 @@ export async function createOriginalStackFrame({\n       )\n     }\n     // This returns 1-based lines and 0-based columns\n-    return await findOriginalSourcePositionAndContent(source.sourceMap, {\n+    return findOriginalSourcePositionAndContent(source.sourceMap, {\n       line: lineNumber ?? 1,\n       column,\n     })\n@@ -219,19 +222,16 @@ export async function createOriginalStackFrame({\n     isIgnoredSource(source, sourcePosition) ||\n     // If the source file is externals, should be excluded even it's not ignored source.\n     // e.g. webpack://next/dist/.. needs to be ignored\n-    shouldIgnorePath(source.modulePath)\n+    shouldIgnoreSource(source.moduleURL)\n \n   const sourcePath = getSourcePath(\n     // When sourcePosition.source is the loader path the modulePath is generally better.\n     (sourcePosition.source!.includes('|')\n-      ? source.modulePath\n-      : sourcePosition.source) || source.modulePath\n+      ? source.moduleURL\n+      : sourcePosition.source) || source.moduleURL\n   )\n   const filePath = path.resolve(rootDirectory, sourcePath)\n-\n-  const resolvedFilePath = sourceContent\n-    ? path.relative(rootDirectory, filePath)\n-    : sourcePosition.source\n+  const resolvedFilePath = path.relative(rootDirectory, filePath)\n \n   const traced: IgnorableStackFrame = {\n     file: resolvedFilePath,\n@@ -282,33 +282,33 @@ async function getSourceMapFromCompilation(\n }\n \n async function getSource(\n-  filename: string,\n+  sourceURL: string,\n   options: {\n     getCompilations: () => webpack.Compilation[]\n   }\n ): Promise<Source | undefined> {\n   const { getCompilations } = options\n \n-  if (path.isAbsolute(filename)) {\n-    filename = url.pathToFileURL(filename).href\n+  if (path.isAbsolute(sourceURL)) {\n+    sourceURL = pathToFileURL(sourceURL).href\n   }\n \n-  if (filename.startsWith('file:')) {\n-    const sourceMap = await getSourceMapFromFile(filename)\n+  if (sourceURL.startsWith('file:')) {\n+    const sourceMap = await getSourceMapFromFile(sourceURL)\n     return sourceMap\n       ? {\n           type: 'file',\n           sourceMap,\n           ignoredSources: getIgnoredSources(sourceMap),\n-          modulePath: filename.replace(/^file:\\/\\//, ''),\n+          moduleURL: sourceURL,\n         }\n       : undefined\n   }\n \n   // webpack-internal:///./src/hello.tsx => ./src/hello.tsx\n   // rsc://React/Server/webpack-internal:///(rsc)/./src/hello.tsx?42 => (rsc)/./src/hello.tsx\n   // webpack://_N_E/./src/hello.tsx => ./src/hello.tsx\n-  const moduleId = filename\n+  const moduleId = sourceURL\n     .replace(\n       /^(rsc:\\/\\/React\\/[^/]+\\/)?(webpack-internal:\\/\\/\\/|webpack:\\/\\/(_N_E\\/)?)/,\n       ''\n@@ -320,18 +320,6 @@ async function getSource(\n \n   for (const compilation of getCompilations()) {\n     const sourceMap = await getSourceMapFromCompilation(moduleId, compilation)\n-    const ignoreList = []\n-    const moduleFilenames = sourceMap?.sources ?? []\n-\n-    for (let index = 0; index < moduleFilenames.length; index++) {\n-      // bundlerFilePath case: webpack://./app/page.tsx\n-      const bundlerFilePath = moduleFilenames[index]\n-      // Format the path to the normal file path\n-      const formattedFilePath = formatFrameSourceFile(bundlerFilePath)\n-      if (shouldIgnorePath(formattedFilePath)) {\n-        ignoreList.push(index)\n-      }\n-    }\n \n     if (sourceMap) {\n       const ignoredSources = getIgnoredSources(sourceMap)\n@@ -340,7 +328,7 @@ async function getSource(\n         sourceMap,\n         compilation,\n         moduleId,\n-        modulePath,\n+        moduleURL: modulePath,\n         ignoredSources,\n       }\n     }\n@@ -468,7 +456,7 @@ async function getOriginalStackFrame({\n     lineNumber: frame.lineNumber,\n     column: frame.column ?? 1,\n     methodName: frame.methodName,\n-    ignored: shouldIgnorePath(filename),\n+    ignored: shouldIgnoreSource(filename),\n     arguments: [],\n   }\n   if (!source) {"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 32,
        "deletions": 44
    }
}