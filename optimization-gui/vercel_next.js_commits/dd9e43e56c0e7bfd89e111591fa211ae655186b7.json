{
    "author": "ijjk",
    "message": "Stabilize node middleware support (#81907)\n\nAs mentioned in our last blog post we are going to be stabilizing node\nmiddleware now so this removes the experimental flag canary gating the\nfeature.",
    "sha": "dd9e43e56c0e7bfd89e111591fa211ae655186b7",
    "files": [
        {
            "sha": "e6ac73f15a928c8ea6ef75f1a94b0fe36dddc380",
            "filename": "docs/01-app/03-api-reference/03-file-conventions/middleware.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 25,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Fmiddleware.mdx?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -180,31 +180,7 @@ Middleware will be invoked for **every route in your project**. Given this, it's\n \n ## Runtime\n \n-Middleware defaults to using the Edge runtime. As of v15.2 (canary), we have experimental support for using the Node.js runtime. To enable, add the flag to your `next.config` file:\n-\n-```ts filename=\"next.config.ts\" switcher\n-import type { NextConfig } from 'next'\n-\n-const nextConfig: NextConfig = {\n-  experimental: {\n-    nodeMiddleware: true,\n-  },\n-}\n-\n-export default nextConfig\n-```\n-\n-```js filename=\"next.config.js\" switcher\n-const nextConfig = {\n-  experimental: {\n-    nodeMiddleware: true,\n-  },\n-}\n-\n-export default nextConfig\n-```\n-\n-Then in your middleware file, set the runtime to `nodejs` in the `config` object:\n+Middleware defaults to using the Edge runtime. As of v15.5, we have support for using the Node.js runtime. To enable, in your middleware file, set the runtime to `nodejs` in the `config` object:\n \n ```js highlight={2} filename=\"middleware.js\" switcher\n export const config = {"
        },
        {
            "sha": "092c2d119554bb87bc50d40065ea461200f0e646",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -9,7 +9,6 @@ import type {\n   MiddlewareMatcher,\n   PageStaticInfo,\n } from './analysis/get-page-static-info'\n-import * as Log from './output/log'\n import type { LoadedEnvFiles } from '@next/env'\n import type { AppLoaderOptions } from './webpack/loaders/next-app-loader'\n \n@@ -674,19 +673,6 @@ export async function createEntrypoints(\n       const isInstrumentation =\n         isInstrumentationHookFile(page) && pagesType === PAGE_TYPES.ROOT\n \n-      let pageRuntime = staticInfo?.runtime\n-\n-      if (\n-        isMiddlewareFile(page) &&\n-        !config.experimental.nodeMiddleware &&\n-        pageRuntime === 'nodejs'\n-      ) {\n-        Log.warn(\n-          'nodejs runtime support for middleware requires experimental.nodeMiddleware be enabled in your next.config'\n-        )\n-        pageRuntime = 'edge'\n-      }\n-\n       runDependingOnPageType({\n         page,\n         pageRuntime: staticInfo.runtime,"
        },
        {
            "sha": "e971530f4ff41f47c39bcab261f80ebacd83e7eb",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -319,7 +319,6 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n       .strictObject({\n         adapterPath: z.string().optional(),\n         useSkewCookie: z.boolean().optional(),\n-        nodeMiddleware: z.boolean().optional(),\n         after: z.boolean().optional(),\n         appDocumentPreloading: z.boolean().optional(),\n         appNavFailHandling: z.boolean().optional(),"
        },
        {
            "sha": "2f66665c1add601b6ec51f2e2587175aa939f874",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -319,7 +319,6 @@ export interface LoggingConfig {\n export interface ExperimentalConfig {\n   adapterPath?: string\n   useSkewCookie?: boolean\n-  nodeMiddleware?: boolean\n   cacheHandlers?: {\n     default?: string\n     remote?: string\n@@ -1343,7 +1342,6 @@ export const defaultConfig = Object.freeze({\n   experimental: {\n     adapterPath: process.env.NEXT_ADAPTER_PATH || undefined,\n     useSkewCookie: false,\n-    nodeMiddleware: false,\n     cacheLife: {\n       default: {\n         stale: undefined, // defaults to staleTimes.static"
        },
        {
            "sha": "0406ed6e2833816f8ddcedd53df61f89c118fcf8",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -293,8 +293,6 @@ function assignDefaults(\n       throw new CanaryOnlyError({\n         feature: 'experimental.turbopackPersistentCaching',\n       })\n-    } else if (result.experimental?.nodeMiddleware) {\n-      throw new CanaryOnlyError({ feature: 'experimental.nodeMiddleware' })\n     }\n   }\n "
        },
        {
            "sha": "8a66527ad69fd080765674284acb1ce3513a0cd7",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -933,17 +933,6 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n \n             let pageRuntime = staticInfo?.runtime\n \n-            if (\n-              isMiddlewareFile(page) &&\n-              !this.config.experimental.nodeMiddleware &&\n-              pageRuntime === 'nodejs'\n-            ) {\n-              Log.warn(\n-                'nodejs runtime support for middleware requires experimental.nodeMiddleware be enabled in your next.config'\n-              )\n-              pageRuntime = 'edge'\n-            }\n-\n             runDependingOnPageType({\n               page,\n               pageRuntime,"
        },
        {
            "sha": "1459360295a51effdef1b599e5758ed6fd29851c",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -829,10 +829,6 @@ export function onDemandEntryHandler({\n \n       let pageRuntime = staticInfo.runtime\n \n-      if (isMiddlewareFile(page) && !nextConfig.experimental.nodeMiddleware) {\n-        pageRuntime = 'edge'\n-      }\n-\n       runDependingOnPageType({\n         page: route.page,\n         pageRuntime,"
        },
        {
            "sha": "16b649d2cf9c6e657621fc2a0362bf8d0785e770",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -1538,10 +1538,6 @@ export default class NextNodeServer extends BaseServer<\n \n   private async loadNodeMiddleware() {\n     if (!process.env.NEXT_MINIMAL) {\n-      if (!this.nextConfig.experimental.nodeMiddleware) {\n-        return\n-      }\n-\n       try {\n         const functionsConfig = this.renderOpts.dev\n           ? {}"
        },
        {
            "sha": "49fe2ae66a44080691e199993997761cebe39a2c",
            "filename": "test/e2e/app-dir/actions/app-action-size-limit-invalid.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -50,7 +50,6 @@ describe('app-dir action size limit invalid config', () => {\n       module.exports = {\n         experimental: {\n           serverActions: { bodySizeLimit: -3000 },\n-          nodeMiddleware: true\n         },\n       }\n       `\n@@ -69,7 +68,6 @@ describe('app-dir action size limit invalid config', () => {\n       module.exports = {\n         experimental: {\n           serverActions: { bodySizeLimit: 'testmb' },\n-          nodeMiddleware: true\n         },\n       }\n       `\n@@ -88,7 +86,6 @@ describe('app-dir action size limit invalid config', () => {\n       module.exports = {\n         experimental: {\n           serverActions: { bodySizeLimit: '-3000mb' },\n-          nodeMiddleware: true\n         },\n       }\n       `"
        },
        {
            "sha": "1e2e7c9e67e718660fc694d5ba889e4ace3cf99e",
            "filename": "test/e2e/app-dir/actions/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -5,7 +5,6 @@ module.exports = {\n     fetches: {},\n   },\n   experimental: {\n-    nodeMiddleware: true,\n     serverActions: { bodySizeLimit: '2mb' },\n   },\n }"
        },
        {
            "sha": "4ba52ba2c8df6758685c8f65f490306b5c44eb76",
            "filename": "test/e2e/middleware-custom-matchers/app/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fmiddleware-custom-matchers%2Fapp%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fmiddleware-custom-matchers%2Fapp%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-custom-matchers%2Fapp%2Fnext.config.js?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -1,5 +1 @@\n-module.exports = {\n-  experimental: {\n-    nodeMiddleware: true,\n-  },\n-}\n+module.exports = {}"
        },
        {
            "sha": "1b6636bad0a78e23b8ec9751452e149d783b3373",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -46,7 +46,6 @@ describe('Middleware Runtime', () => {\n         nextConfig: {\n           experimental: {\n             webpackBuildWorker: true,\n-            nodeMiddleware: true,\n           },\n           ...(i18n\n             ? {"
        },
        {
            "sha": "4ba52ba2c8df6758685c8f65f490306b5c44eb76",
            "filename": "test/integration/middleware-src-node/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fintegration%2Fmiddleware-src-node%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fintegration%2Fmiddleware-src-node%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fmiddleware-src-node%2Fnext.config.js?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -1,5 +1 @@\n-module.exports = {\n-  experimental: {\n-    nodeMiddleware: true,\n-  },\n-}\n+module.exports = {}"
        },
        {
            "sha": "d98493646563f5bce90d374bf05a8ae805be726d",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dd9e43e56c0e7bfd89e111591fa211ae655186b7/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=dd9e43e56c0e7bfd89e111591fa211ae655186b7",
            "patch": "@@ -56,9 +56,6 @@ describe('required server files', () => {\n         eslint: {\n           ignoreDuringBuilds: true,\n         },\n-        experimental: {\n-          nodeMiddleware: Boolean(process.env.TEST_NODE_MIDDLEWARE),\n-        },\n         output: 'standalone',\n         async rewrites() {\n           return {"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 3,
        "deletions": 81
    }
}