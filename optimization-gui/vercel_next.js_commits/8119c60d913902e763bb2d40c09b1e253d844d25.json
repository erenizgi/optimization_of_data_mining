{
    "author": "lubieowoce",
    "message": "initial implementation of `export const prefetch` (#82905)\n\nNo behavior changes yet, just the plumbing for a segment-level config to\ncontrol the prefetch behavior",
    "sha": "8119c60d913902e763bb2d40c09b1e253d844d25",
    "files": [
        {
            "sha": "651991e0f35f63ce4b2377f187d8e5b5db2ee8fa",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -793,5 +793,6 @@\n   \"792\": \"Unexpected empty path segments match for a pathname \\\"%s\\\" with param \\\"%s\\\" of type \\\"%s\\\"\",\n   \"793\": \"No value found for segment key: \\\"%s\\\"\",\n   \"794\": \"Invalid <Link> with <a> child. Please remove <a>.\\nLearn more: https://nextjs.org/docs/messages/invalid-new-link-with-extra-anchor\",\n-  \"795\": \"\\\\`%s\\\\` was called from a Server Component. Next.js should be preventing %s from being included in server components statically, but did not in this case.\"\n+  \"795\": \"\\\\`%s\\\\` was called from a Server Component. Next.js should be preventing %s from being included in server components statically, but did not in this case.\",\n+  \"796\": \"Page \\\"%s\\\" cannot use \\\\`export const unstable_prefetch = ...\\\\` without enabling \\\\`experimental.cacheComponents\\\\` and \\\\`experimental.clientSegmentCache\\\\`.\"\n }"
        },
        {
            "sha": "bfe3ef30a52d99f96898ce9317ffba2d1c0b6840",
            "filename": "packages/next/src/build/analysis/get-page-static-info.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -547,6 +547,17 @@ export async function getAppPageStaticInfo({\n     )\n   }\n \n+  if (\n+    'unstable_prefetch' in config &&\n+    (!nextConfig.experimental?.cacheComponents ||\n+      // don't allow in `clientSegmentCache: 'client-only'` mode\n+      nextConfig.experimental?.clientSegmentCache !== true)\n+  ) {\n+    throw new Error(\n+      `Page \"${page}\" cannot use \\`export const unstable_prefetch = ...\\` without enabling \\`experimental.cacheComponents\\` and \\`experimental.clientSegmentCache\\`.`\n+    )\n+  }\n+\n   return {\n     type: PAGE_TYPES.APP,\n     rsc,"
        },
        {
            "sha": "5ae81d1902e42c3c16d0cdd73b11a500e6b3536b",
            "filename": "packages/next/src/build/segment-config/app/app-segment-config.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segment-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segment-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segment-config.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -39,6 +39,12 @@ const AppSegmentConfigSchema = z.object({\n     ])\n     .optional(),\n \n+  /**\n+   * How this segment should be prefetched.\n+   * (only applicable when `clientSegmentCache` is enabled)\n+   */\n+  unstable_prefetch: z.enum(['unstable_static', 'unstable_runtime']).optional(),\n+\n   /**\n    * The preferred region for the page.\n    */\n@@ -127,6 +133,12 @@ export type AppSegmentConfig = {\n     | 'only-cache'\n     | 'only-no-store'\n \n+  /**\n+   * How this segment should be prefetched.\n+   * (only applicable when `clientSegmentCache` is enabled)\n+   */\n+  unstable_prefetch?: 'unstable_static' | 'unstable_runtime'\n+\n   /**\n    * The preferred region for the page.\n    */"
        },
        {
            "sha": "1a2dc6192fc91581c7d97b895bd2657073ea9da2",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -67,6 +67,7 @@ checkFields<Diff<{\n   }\n   config?: {}\n   generateStaticParams?: Function\n+  unstable_prefetch?: 'unstable_static' | 'unstable_runtime'\n   revalidate?: RevalidateRange<TEntry> | false\n   dynamic?: 'auto' | 'force-dynamic' | 'error' | 'force-static'\n   dynamicParams?: boolean"
        },
        {
            "sha": "369d6ebfef68c68d75c2a42c1e0745c48be0bf78",
            "filename": "packages/next/src/client/components/router-reducer/fill-cache-with-new-subtree-data.test.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -9,7 +9,14 @@ const getFlightData = (): NormalizedFlightData[] => {\n       segmentPath: ['children', 'linking', 'children', 'about'],\n       segment: 'about',\n       tree: ['about', { children: ['', {}] }],\n-      seedData: ['about', <h1>SubTreeData Injected!</h1>, {}, null, false],\n+      seedData: [\n+        'about',\n+        <h1>SubTreeData Injected!</h1>,\n+        {},\n+        null,\n+        false,\n+        false,\n+      ],\n       head: null,\n       isHeadPartial: false,\n       isRootRender: false,"
        },
        {
            "sha": "561dac6d54e235b2a07cadfb5de3ec654488e10d",
            "filename": "packages/next/src/client/components/router-reducer/invalidate-cache-below-flight-segmentpath.test.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -11,7 +11,7 @@ const getFlightData = (): NormalizedFlightData[] => {\n       segmentPath: ['children', 'linking', 'children', 'about'],\n       segment: 'about',\n       tree: ['about', { children: ['', {}] }],\n-      seedData: ['about', <h1>About Page!</h1>, {}, null, false],\n+      seedData: ['about', <h1>About Page!</h1>, {}, null, false, false],\n       head: null,\n       isHeadPartial: false,\n       isRootRender: false,"
        },
        {
            "sha": "192cdf016e48c4d86ebe30cce4164882343b1efc",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -358,6 +358,9 @@ function readRenderSnapshotFromCache(\n     Object.fromEntries(new URLSearchParams(route.renderedSearch))\n   )\n \n+  // We don't need this information in a render snapshot, so this can just be a placeholder.\n+  const shouldUseRuntimePrefetch = false\n+\n   return {\n     flightRouterState: [\n       segment,\n@@ -366,7 +369,14 @@ function readRenderSnapshotFromCache(\n       null,\n       tree.isRootLayout,\n     ],\n-    seedData: [segment, rsc, childSeedDatas, loading, isPartial],\n+    seedData: [\n+      segment,\n+      rsc,\n+      childSeedDatas,\n+      loading,\n+      isPartial,\n+      shouldUseRuntimePrefetch,\n+    ],\n   }\n }\n "
        },
        {
            "sha": "d77ceaa366883720abb85ce9a16da1498908acea",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -1285,6 +1285,7 @@ async function getErrorRSCPayload(\n     {},\n     null,\n     false,\n+    false, // We don't currently support runtime prefetching for error pages.\n   ]\n \n   const { GlobalError, styles: globalErrorStyles } = await getGlobalErrorStyles("
        },
        {
            "sha": "526a60b59be82e2947fb2ff9e6d76908f6299f75",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -50,6 +50,9 @@ export type TreePrefetch = {\n     [parallelRouteKey: string]: TreePrefetch\n   }\n \n+  /** Whether this segment should be fetched using a runtime prefetch */\n+  shouldUseRuntimePrefetch: boolean\n+\n   // Extra fields that only exist so we can reconstruct a FlightRouterState on\n   // the client. We may be able to unify TreePrefetch and FlightRouterState\n   // after some refactoring, but in the meantime it would be wasteful to add a\n@@ -278,6 +281,8 @@ function collectSegmentDataImpl(\n     slotMetadata[parallelRouteKey] = childTree\n   }\n \n+  const shouldUseRuntimePrefetch = seedData !== null ? seedData[5] : false\n+\n   if (seedData !== null) {\n     // Spawn a task to write the segment data to a new Flight stream.\n     segmentTasks.push(\n@@ -319,6 +324,7 @@ function collectSegmentDataImpl(\n     // case there's a bug and we need to revert.\n     // TODO: Remove once clientParamParsing is enabled everywhere.\n     paramKey: isClientParamParsingEnabled ? null : paramKey,\n+    shouldUseRuntimePrefetch,\n     slots: slotMetadata,\n     isRootLayout: route[4] === true,\n   }"
        },
        {
            "sha": "94f8eabf87b6390d8cf68a4467349365e16dc93f",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -36,6 +36,7 @@ import {\n   getConventionPathByType,\n   isNextjsBuiltinFilePath,\n } from './segment-explorer-path'\n+import type { AppSegmentConfig } from '../../build/segment-config/app/app-segment-config'\n \n /**\n  * Use the provided loader tree to create the React Component tree.\n@@ -224,6 +225,12 @@ async function createComponentTreeInternal(\n       })\n     : []\n \n+  const prefetchConfig = layoutOrPageMod\n+    ? (layoutOrPageMod as AppSegmentConfig).unstable_prefetch\n+    : undefined\n+  /** Whether this segment should use a runtime prefetch instead of a static prefetch. */\n+  const shouldUseRuntimePrefetch = prefetchConfig === 'unstable_runtime'\n+\n   const [Forbidden, forbiddenStyles] =\n     authInterrupts && forbidden\n       ? await createComponentStylesAndScripts({\n@@ -697,6 +704,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n+      shouldUseRuntimePrefetch,\n     ]\n   }\n \n@@ -729,6 +737,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       true,\n+      shouldUseRuntimePrefetch,\n     ]\n   }\n \n@@ -834,6 +843,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n+      shouldUseRuntimePrefetch,\n     ]\n   } else {\n     const SegmentComponent = Component\n@@ -1011,6 +1021,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n+      shouldUseRuntimePrefetch,\n     ]\n   }\n }"
        },
        {
            "sha": "86673e23d1cfb3abe9b34bd77dfc7e9a40b04d7d",
            "filename": "packages/next/src/shared/lib/app-router-types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -228,6 +228,8 @@ export type CacheNodeSeedData = [\n   },\n   loading: LoadingModuleData | Promise<LoadingModuleData>,\n   isPartial: boolean,\n+  /** TODO: this doesn't feel like it belongs here, because it's only used during build, in `collectSegmentData` */\n+  shouldUseRuntimePrefetch: boolean,\n ]\n \n export type FlightDataSegment = ["
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "32c5c5a37dfce6701efdd52fe35def7281169cf9",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/nested-prefetch-static/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,5 @@\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return <>{children}</>\n+}"
        },
        {
            "sha": "0a744c27a0f1a86069ef9f5f120df94efc432e1a",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/nested-prefetch-static/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,20 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export const unstable_prefetch = 'unstable_static'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1>A page that should use a static prefetch</h1>\n+      <Suspense fallback=\"Loading...\">\n+        <Dynamic />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await connection()\n+  return <div>Dynamic content</div>\n+}"
        },
        {
            "sha": "38366e2930fd8af54e3d05ae9f76d1fe6c67ce64",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/no-prefetch/page.tsx",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,21 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+// No exported prefetch value.\n+// export const unstable_prefetch = ...\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1>A page that should use a static prefetch</h1>\n+      <Suspense fallback=\"Loading...\">\n+        <Dynamic />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await connection()\n+  return <div>Dynamic content</div>\n+}"
        },
        {
            "sha": "4302e4f9d2432e6218510003f4cb26f0a27194cb",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/page.tsx",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,28 @@\n+import { LinkAccordion } from '../components/link-accordion'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <ul>\n+        <li>\n+          <LinkAccordion href=\"/prefetch-static\">\n+            /prefetch-static\n+          </LinkAccordion>\n+        </li>\n+        <li>\n+          <LinkAccordion href=\"/prefetch-runtime\">\n+            /prefetch-runtime\n+          </LinkAccordion>\n+        </li>\n+        <li>\n+          <LinkAccordion href=\"/nested-prefetch-static\">\n+            /nested-prefetch-static\n+          </LinkAccordion>\n+        </li>\n+        <li>\n+          <LinkAccordion href=\"/no-prefetch\">/no-prefetch</LinkAccordion>\n+        </li>\n+      </ul>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "abcecba06de8d333b806e397ddeec78cc5f2e978",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/prefetch-runtime/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,20 @@\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1>A page that should use a runtime prefetch</h1>\n+      <Suspense fallback=\"Loading...\">\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return <div>Runtime-prefetchable content</div>\n+}"
        },
        {
            "sha": "0a744c27a0f1a86069ef9f5f120df94efc432e1a",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/prefetch-static/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,20 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export const unstable_prefetch = 'unstable_static'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1>A page that should use a static prefetch</h1>\n+      <Suspense fallback=\"Loading...\">\n+        <Dynamic />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await connection()\n+  return <div>Dynamic content</div>\n+}"
        },
        {
            "sha": "72dafb3b9d970cedb56ec2b4908c7e9bddd46880",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/components/link-accordion.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,33 @@\n+'use client'\n+\n+import Link, { type LinkProps } from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({\n+  href,\n+  children,\n+  prefetch,\n+}: {\n+  href: string\n+  children: React.ReactNode\n+  prefetch?: LinkProps['prefetch']\n+}) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link prefetch={prefetch} href={href}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "d085500708ef73d37492e6fd6b10659d556edfc1",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/next.config.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,13 @@\n+import { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+    clientSegmentCache: true,\n+    // This is automatically enabled when running with `__NEXT_EXPERIMENTAL_PPR`,\n+    // which lets us exercise both modes.\n+    // clientParamParsing: true,\n+  },\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "a4ac898433dc324a919b4170b4fa7e66c13e2a48",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/segment-prefetch-config.test.ts",
            "status": "added",
            "additions": 190,
            "deletions": 0,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -0,0 +1,190 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import {\n+  createRequestTracker,\n+  RequestTracker,\n+} from '../../../../lib/e2e-utils/request-tracker'\n+import {\n+  RootTreePrefetch,\n+  TreePrefetch,\n+} from 'next/dist/server/app-render/collect-segment-data'\n+\n+describe('export const unstable_prefetch = ...', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+  if (isNextDev) {\n+    it('disabled in development', () => {})\n+    return\n+  }\n+\n+  // TODO: these tests aren't very good, but since the client-side part isn't implmented yet,\n+  // asserting on what the tree prefetch response contains is the best we can do.\n+  // They should be replaced with `act()` tests when the client-side changes are made.\n+\n+  async function captureTreePrefetchResponse(\n+    requestTracker: RequestTracker,\n+    action: () => Promise<void>\n+  ): Promise<string> {\n+    const [, response] = await requestTracker.captureResponse(action, {\n+      async request(req) {\n+        const headers = req.headers()\n+        return headers['next-router-segment-prefetch'] === '/_tree'\n+      },\n+    })\n+    return response.text()\n+  }\n+\n+  /** Hackily parse the first row of the RSC response. */\n+  function parseRouteTreeFromTreePrefetchResponse(response: string) {\n+    // Get row 0, the root object.\n+    const rowMatch = response.match(/(?:^|\\n)0:(.*?)\\n/)\n+    if (!rowMatch) {\n+      throw new Error('Failed to find row 0 in route tree flight data')\n+    }\n+    // `tree` is essentially plain JSON, so it's fine to not do full RSC parsing.\n+    const data = JSON.parse(rowMatch[1]) as RootTreePrefetch\n+    return data.tree\n+  }\n+\n+  it('does not mark for segments with prefetch: \"static\" as runtime-prefetchable', async () => {\n+    const browser = await next.browser('/')\n+    const requestTracker = createRequestTracker(browser)\n+\n+    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n+    const response = await captureTreePrefetchResponse(\n+      requestTracker,\n+      async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/prefetch-static\"]`\n+        )\n+        await linkToggle.click()\n+      }\n+    )\n+\n+    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n+      expect.objectContaining({\n+        name: '',\n+        shouldUseRuntimePrefetch: false,\n+        slots: {\n+          children: expect.objectContaining({\n+            name: 'prefetch-static',\n+            shouldUseRuntimePrefetch: false,\n+            slots: {\n+              children: expect.objectContaining({\n+                name: '__PAGE__',\n+                shouldUseRuntimePrefetch: false, // <-----------------\n+              }),\n+            },\n+          }),\n+        },\n+      })\n+    )\n+  })\n+\n+  it('marks segments with prefetch: \"runtime\" as runtime-prefetchable', async () => {\n+    const browser = await next.browser('/')\n+    const requestTracker = createRequestTracker(browser)\n+\n+    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n+    const response = await captureTreePrefetchResponse(\n+      requestTracker,\n+      async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/prefetch-runtime\"]`\n+        )\n+        await linkToggle.click()\n+      }\n+    )\n+\n+    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n+      expect.objectContaining({\n+        name: '',\n+        shouldUseRuntimePrefetch: false,\n+        slots: {\n+          children: expect.objectContaining({\n+            name: 'prefetch-runtime',\n+            shouldUseRuntimePrefetch: false,\n+            slots: {\n+              children: expect.objectContaining({\n+                name: '__PAGE__',\n+                shouldUseRuntimePrefetch: true, // <-----------------\n+                slots: null,\n+              }),\n+            },\n+          }),\n+        },\n+      })\n+    )\n+  })\n+\n+  it('defaults segments to static if no config is specified', async () => {\n+    const browser = await next.browser('/')\n+    const requestTracker = createRequestTracker(browser)\n+\n+    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n+    const response = await captureTreePrefetchResponse(\n+      requestTracker,\n+      async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/no-prefetch\"]`\n+        )\n+        await linkToggle.click()\n+      }\n+    )\n+\n+    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n+      expect.objectContaining({\n+        name: '',\n+        shouldUseRuntimePrefetch: false,\n+        slots: {\n+          children: expect.objectContaining({\n+            name: 'no-prefetch',\n+            shouldUseRuntimePrefetch: false,\n+            slots: {\n+              children: expect.objectContaining({\n+                name: '__PAGE__',\n+                shouldUseRuntimePrefetch: false, // <-----------------\n+                slots: null,\n+              }),\n+            },\n+          }),\n+        },\n+      }) satisfies TreePrefetch\n+    )\n+  })\n+  it('does not mark a \"static\" segment that is a child of a \"runtime\" segment as runtime-prefetchable', async () => {\n+    const browser = await next.browser('/')\n+    const requestTracker = createRequestTracker(browser)\n+\n+    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n+    const response = await captureTreePrefetchResponse(\n+      requestTracker,\n+      async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/nested-prefetch-static\"]`\n+        )\n+        await linkToggle.click()\n+      }\n+    )\n+\n+    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n+      expect.objectContaining({\n+        name: '',\n+        shouldUseRuntimePrefetch: false,\n+        slots: {\n+          children: expect.objectContaining({\n+            name: 'nested-prefetch-static',\n+            shouldUseRuntimePrefetch: true, // <-----------------\n+            slots: {\n+              children: expect.objectContaining({\n+                name: '__PAGE__',\n+                shouldUseRuntimePrefetch: false, // <-----------------\n+                slots: null,\n+              }),\n+            },\n+          }),\n+        },\n+      }) satisfies TreePrefetch\n+    )\n+  })\n+})"
        },
        {
            "sha": "7871ce1dbb6062d5938614d2f84951468837dadc",
            "filename": "test/lib/e2e-utils/request-tracker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Flib%2Fe2e-utils%2Frequest-tracker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8119c60d913902e763bb2d40c09b1e253d844d25/test%2Flib%2Fe2e-utils%2Frequest-tracker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Frequest-tracker.ts?ref=8119c60d913902e763bb2d40c09b1e253d844d25",
            "patch": "@@ -15,6 +15,8 @@ export type RequestMatcher =\n   | RequestMatcherObject\n   | ((request: PlaywrightRequest) => Promise<boolean>)\n \n+export type RequestTracker = ReturnType<typeof createRequestTracker>\n+\n /** Allows capturing responses to requests that happened as a result of running a callback. */\n export function createRequestTracker(browser: Playwright) {\n   /** Run a callback and capture requests with the given `method` and `pathname`. */"
        }
    ],
    "stats": {
        "total": 433,
        "additions": 429,
        "deletions": 4
    }
}