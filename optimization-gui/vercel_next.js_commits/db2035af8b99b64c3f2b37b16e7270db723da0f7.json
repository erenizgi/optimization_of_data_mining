{
    "author": "Cy-Tek",
    "message": "feat(turbopack) Added sending events to log how long writing entrypoints to disk takes. (#79256)\n\n## Add logging for entrypoint writing in Turbopack build\n\n### What?\nThis PR adds diagnostic event logging for the entrypoint writing process\nduring Turbopack builds, showing when the process starts and finishes\nalong with timing information.\n\n### Why?\nThis allows us to better track if we are bound by file IO in terms of\nperformance as the number of cores increases.\n\n### How?\n- Added diagnostic events at the start and end of the\n`project_write_all_entrypoints_to_disk` function\n- Added an `Event` severity level to the `Severity` enum to match the\n`Log` types in Next.js\n- Implemented event subscription in the build process to capture and\ndisplay these events",
    "sha": "db2035af8b99b64c3f2b37b16e7270db723da0f7",
    "files": [
        {
            "sha": "55099d5a616ebd104ad109a623e3510fea4b05b4",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/db2035af8b99b64c3f2b37b16e7270db723da0f7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/db2035af8b99b64c3f2b37b16e7270db723da0f7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=db2035af8b99b64c3f2b37b16e7270db723da0f7",
            "patch": "@@ -831,11 +831,14 @@ pub async fn project_write_all_entrypoints_to_disk(\n     app_dir_only: bool,\n ) -> napi::Result<TurbopackResult<NapiEntrypoints>> {\n     let turbo_tasks = project.turbo_tasks.clone();\n+    let compilation_event_sender = turbo_tasks.clone();\n+\n     let (entrypoints, issues, diags) = turbo_tasks\n         .run_once(async move {\n             let entrypoints_with_issues_op =\n                 get_all_written_entrypoints_with_issues_operation(project.container, app_dir_only);\n \n+            // Read and compile the files\n             let EntrypointsWithIssues {\n                 entrypoints,\n                 issues,\n@@ -844,8 +847,26 @@ pub async fn project_write_all_entrypoints_to_disk(\n             } = &*entrypoints_with_issues_op\n                 .read_strongly_consistent()\n                 .await?;\n+\n+            // Start timing writing the files to disk\n+            let now = Instant::now();\n+            compilation_event_sender.send_compilation_event(Arc::new(DiagnosticEvent::new(\n+                \"Starting to write all entrypoints to disk...\".to_owned(),\n+                Severity::Event,\n+            )));\n+\n+            // Write the files to disk\n             effects.apply().await?;\n \n+            // Send a compilation event to indicate that the files have been written to disk\n+            compilation_event_sender.send_compilation_event(Arc::new(DiagnosticEvent::new(\n+                format!(\n+                    \"Finished writing all entrypoints to disk in {:?}\",\n+                    now.elapsed()\n+                ),\n+                Severity::Event,\n+            )));\n+\n             Ok((entrypoints.clone(), issues.clone(), diagnostics.clone()))\n         })\n         .await"
        },
        {
            "sha": "b252d1850a0587d610ba33e59ceafa2f3214c97f",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/db2035af8b99b64c3f2b37b16e7270db723da0f7/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/db2035af8b99b64c3f2b37b16e7270db723da0f7/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=db2035af8b99b64c3f2b37b16e7270db723da0f7",
            "patch": "@@ -19,6 +19,7 @@ import loadConfig from '../../server/config'\n import { hasCustomExportOutput } from '../../export/utils'\n import { Telemetry } from '../../telemetry/storage'\n import { setGlobal } from '../../trace'\n+import * as Log from '../output/log'\n \n export async function turbopackBuild(): Promise<{\n   duration: number\n@@ -87,6 +88,14 @@ export async function turbopackBuild(): Promise<{\n     }\n   )\n   try {\n+    ;(async function logCompilationEvents() {\n+      for await (const event of project.compilationEventsSubscribe()) {\n+        if (event.severity === 'EVENT') {\n+          Log.event(event.message)\n+        }\n+      }\n+    })()\n+\n     // Write an empty file in a known location to signal this was built with Turbopack\n     await fs.writeFile(path.join(distDir, 'turbopack'), '')\n "
        },
        {
            "sha": "54f7ee391209fd6e08b8c64f1f75d3c9e5b49fb6",
            "filename": "turbopack/crates/turbo-tasks/src/message_queue.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/db2035af8b99b64c3f2b37b16e7270db723da0f7/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/db2035af8b99b64c3f2b37b16e7270db723da0f7/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs?ref=db2035af8b99b64c3f2b37b16e7270db723da0f7",
            "patch": "@@ -17,7 +17,7 @@ type CompilationEventChannel = mpsc::Sender<Arc<dyn CompilationEvent>>;\n \n pub struct CompilationEventQueue {\n     event_history: ArcMx<VecDeque<Arc<dyn CompilationEvent>>>,\n-    subscribers: DashMap<String, Vec<CompilationEventChannel>>,\n+    subscribers: Arc<DashMap<String, Vec<CompilationEventChannel>>>,\n }\n \n impl Default for CompilationEventQueue {\n@@ -27,7 +27,7 @@ impl Default for CompilationEventQueue {\n \n         Self {\n             event_history: Arc::new(Mutex::new(VecDeque::with_capacity(MAX_QUEUE_SIZE))),\n-            subscribers,\n+            subscribers: Arc::new(subscribers),\n         }\n     }\n }\n@@ -125,6 +125,7 @@ pub enum Severity {\n     Warning,\n     Error,\n     Fatal,\n+    Event,\n }\n \n impl Display for Severity {\n@@ -135,6 +136,7 @@ impl Display for Severity {\n             Severity::Warning => write!(f, \"WARNING\"),\n             Severity::Error => write!(f, \"ERROR\"),\n             Severity::Fatal => write!(f, \"FATAL\"),\n+            Severity::Event => write!(f, \"EVENT\"),\n         }\n     }\n }"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 34,
        "deletions": 2
    }
}