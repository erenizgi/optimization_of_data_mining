{
    "author": "bgw",
    "message": "refactor(napi): Implement napi traits for RcStr (#79806)\n\nThis lets us use `RcStr` directly in function arguments and as part of `#[napi(object)]`s.\n\n*You can just `RcStr` things!*\n\nHere's an example of rspack doing something similar for a custom napi type: https://github.com/web-infra-dev/rspack/blob/35f1126963d5ba6860e9eba939fd5d62f9aa217f/crates/rspack_regex/src/napi.rs",
    "sha": "8fa42deefd59d8aae87112892c9af8aa0cf1290f",
    "files": [
        {
            "sha": "4ce668e0cad220c5c5e4b60f7aa69687014550ef",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -4587,6 +4587,7 @@ name = \"next-build\"\n version = \"0.1.0\"\n dependencies = [\n  \"next-core\",\n+ \"turbo-rcstr\",\n  \"turbo-tasks-build\",\n  \"turbopack-core\",\n ]\n@@ -9558,6 +9559,7 @@ name = \"turbo-rcstr\"\n version = \"0.1.0\"\n dependencies = [\n  \"codspeed-criterion-compat\",\n+ \"napi\",\n  \"new_debug_unreachable\",\n  \"serde\",\n  \"shrink-to-fit\",\n@@ -10169,6 +10171,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"serde\",\n  \"serde_json\",\n+ \"turbo-rcstr\",\n  \"turbopack-cli-utils\",\n  \"turbopack-core\",\n ]"
        },
        {
            "sha": "3ff9584c53188259cf132855abe9fb45a8119b7c",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -251,7 +251,7 @@ next-custom-transforms = { path = \"crates/next-custom-transforms\" }\n auto-hash-map = { path = \"turbopack/crates/turbo-tasks-auto-hash-map\" }\n swc-ast-explorer = { path = \"turbopack/crates/turbopack-swc-ast-explorer\" }\n turbo-prehash = { path = \"turbopack/crates/turbo-prehash\" }\n-turbo-rcstr = { path = \"turbopack/crates/turbo-rcstr\" }\n+turbo-rcstr = { path = \"turbopack/crates/turbo-rcstr\", features = [\"napi\"] }\n turbo-esregex = { path = \"turbopack/crates/turbo-esregex\" }\n turbo-persistence = { path = \"turbopack/crates/turbo-persistence\" }\n turbo-tasks-malloc = { path = \"turbopack/crates/turbo-tasks-malloc\", default-features = false }\n@@ -370,6 +370,16 @@ lightningcss-napi = { version = \"0.4.4\", default-features = false, features = [\n ]}\n markdown = \"1.0.0-alpha.18\"\n mime = \"0.3.16\"\n+napi = { version = \"2\", default-features = false, features = [\n+    \"napi3\",\n+    \"serde-json\",\n+    \"tokio_rt\",\n+    \"error_anyhow\",\n+    # Lightningcss uses this features\n+    \"napi4\",\n+    \"napi5\",\n+    \"compat-mode\"\n+] }\n nohash-hasher = \"0.2.0\"\n notify = \"8.0.0\"\n once_cell = \"1.17.1\""
        },
        {
            "sha": "4a96077c74a922191ebe4de6cb3f72e76d128095",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -50,16 +50,7 @@ console-subscriber = { workspace = true, optional = true }\n dhat = { workspace = true, optional = true }\n indexmap = { workspace = true }\n owo-colors = { workspace = true }\n-napi = { version = \"2\", default-features = false, features = [\n-    \"napi3\",\n-    \"serde-json\",\n-    \"tokio_rt\",\n-    \"error_anyhow\",\n-    # Lightningcss uses this features\n-    \"napi4\",\n-    \"napi5\",\n-    \"compat-mode\"\n-] }\n+napi = { workspace = true }\n napi-derive = \"2\"\n next-custom-transforms = { workspace = true }\n rand = { workspace = true }"
        },
        {
            "sha": "e5bc3429c1417c4e89d2fe20ac4e4d164a7616b0",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 81,
            "deletions": 84,
            "changes": 165,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -74,23 +74,23 @@ static SOURCE_MAP_PREFIX_PROJECT: Lazy<String> =\n #[napi(object)]\n #[derive(Clone, Debug)]\n pub struct NapiEnvVar {\n-    pub name: String,\n-    pub value: String,\n+    pub name: RcStr,\n+    pub value: RcStr,\n }\n \n #[napi(object)]\n pub struct NapiDraftModeOptions {\n-    pub preview_mode_id: String,\n-    pub preview_mode_encryption_key: String,\n-    pub preview_mode_signing_key: String,\n+    pub preview_mode_id: RcStr,\n+    pub preview_mode_encryption_key: RcStr,\n+    pub preview_mode_signing_key: RcStr,\n }\n \n impl From<NapiDraftModeOptions> for DraftModeOptions {\n     fn from(val: NapiDraftModeOptions) -> Self {\n         DraftModeOptions {\n-            preview_mode_id: val.preview_mode_id.into(),\n-            preview_mode_encryption_key: val.preview_mode_encryption_key.into(),\n-            preview_mode_signing_key: val.preview_mode_signing_key.into(),\n+            preview_mode_id: val.preview_mode_id,\n+            preview_mode_encryption_key: val.preview_mode_encryption_key,\n+            preview_mode_signing_key: val.preview_mode_signing_key,\n         }\n     }\n }\n@@ -109,23 +109,23 @@ pub struct NapiWatchOptions {\n pub struct NapiProjectOptions {\n     /// A root path from which all files must be nested under. Trying to access\n     /// a file outside this root will fail. Think of this as a chroot.\n-    pub root_path: String,\n+    pub root_path: RcStr,\n \n     /// A path inside the root_path which contains the app/pages directories.\n-    pub project_path: String,\n+    pub project_path: RcStr,\n \n     /// next.config's distDir. Project initialization occurs eariler than\n     /// deserializing next.config, so passing it as separate option.\n-    pub dist_dir: String,\n+    pub dist_dir: RcStr,\n \n     /// Filesystem watcher options.\n     pub watch: NapiWatchOptions,\n \n     /// The contents of next.config.js, serialized to JSON.\n-    pub next_config: String,\n+    pub next_config: RcStr,\n \n     /// The contents of ts/config read by load-jsconfig, serialized to JSON.\n-    pub js_config: String,\n+    pub js_config: RcStr,\n \n     /// A map of environment variables to use when compiling code.\n     pub env: Vec<NapiEnvVar>,\n@@ -138,16 +138,16 @@ pub struct NapiProjectOptions {\n     pub dev: bool,\n \n     /// The server actions encryption key.\n-    pub encryption_key: String,\n+    pub encryption_key: RcStr,\n \n     /// The build id.\n-    pub build_id: String,\n+    pub build_id: RcStr,\n \n     /// Options for draft mode.\n     pub preview_props: NapiDraftModeOptions,\n \n     /// The browserslist query to use for targeting browsers.\n-    pub browserslist_query: String,\n+    pub browserslist_query: RcStr,\n \n     /// When the code is minified, this opts out of the default mangling of\n     /// local names for variables, functions etc., which can be useful for\n@@ -160,23 +160,23 @@ pub struct NapiProjectOptions {\n pub struct NapiPartialProjectOptions {\n     /// A root path from which all files must be nested under. Trying to access\n     /// a file outside this root will fail. Think of this as a chroot.\n-    pub root_path: Option<String>,\n+    pub root_path: Option<RcStr>,\n \n     /// A path inside the root_path which contains the app/pages directories.\n-    pub project_path: Option<String>,\n+    pub project_path: Option<RcStr>,\n \n     /// next.config's distDir. Project initialization occurs eariler than\n     /// deserializing next.config, so passing it as separate option.\n-    pub dist_dir: Option<Option<String>>,\n+    pub dist_dir: Option<Option<RcStr>>,\n \n     /// Filesystem watcher options.\n     pub watch: Option<NapiWatchOptions>,\n \n     /// The contents of next.config.js, serialized to JSON.\n-    pub next_config: Option<String>,\n+    pub next_config: Option<RcStr>,\n \n     /// The contents of ts/config read by load-jsconfig, serialized to JSON.\n-    pub js_config: Option<String>,\n+    pub js_config: Option<RcStr>,\n \n     /// A map of environment variables to use when compiling code.\n     pub env: Option<Vec<NapiEnvVar>>,\n@@ -189,16 +189,16 @@ pub struct NapiPartialProjectOptions {\n     pub dev: Option<bool>,\n \n     /// The server actions encryption key.\n-    pub encryption_key: Option<String>,\n+    pub encryption_key: Option<RcStr>,\n \n     /// The build id.\n-    pub build_id: Option<String>,\n+    pub build_id: Option<RcStr>,\n \n     /// Options for draft mode.\n     pub preview_props: Option<NapiDraftModeOptions>,\n \n     /// The browserslist query to use for targeting browsers.\n-    pub browserslist_query: Option<String>,\n+    pub browserslist_query: Option<RcStr>,\n \n     /// When the code is minified, this opts out of the default mangling of\n     /// local names for variables, functions etc., which can be useful for\n@@ -239,22 +239,22 @@ impl From<NapiWatchOptions> for WatchOptions {\n impl From<NapiProjectOptions> for ProjectOptions {\n     fn from(val: NapiProjectOptions) -> Self {\n         ProjectOptions {\n-            root_path: val.root_path.into(),\n-            project_path: val.project_path.into(),\n+            root_path: val.root_path,\n+            project_path: val.project_path,\n             watch: val.watch.into(),\n-            next_config: val.next_config.into(),\n-            js_config: val.js_config.into(),\n+            next_config: val.next_config,\n+            js_config: val.js_config,\n             env: val\n                 .env\n                 .into_iter()\n-                .map(|var| (var.name.into(), var.value.into()))\n+                .map(|var| (var.name, var.value))\n                 .collect(),\n             define_env: val.define_env.into(),\n             dev: val.dev,\n-            encryption_key: val.encryption_key.into(),\n-            build_id: val.build_id.into(),\n+            encryption_key: val.encryption_key,\n+            build_id: val.build_id,\n             preview_props: val.preview_props.into(),\n-            browserslist_query: val.browserslist_query.into(),\n+            browserslist_query: val.browserslist_query,\n             no_mangling: val.no_mangling,\n         }\n     }\n@@ -263,20 +263,18 @@ impl From<NapiProjectOptions> for ProjectOptions {\n impl From<NapiPartialProjectOptions> for PartialProjectOptions {\n     fn from(val: NapiPartialProjectOptions) -> Self {\n         PartialProjectOptions {\n-            root_path: val.root_path.map(From::from),\n-            project_path: val.project_path.map(From::from),\n+            root_path: val.root_path,\n+            project_path: val.project_path,\n             watch: val.watch.map(From::from),\n-            next_config: val.next_config.map(From::from),\n-            js_config: val.js_config.map(From::from),\n-            env: val.env.map(|env| {\n-                env.into_iter()\n-                    .map(|var| (var.name.into(), var.value.into()))\n-                    .collect()\n-            }),\n+            next_config: val.next_config,\n+            js_config: val.js_config,\n+            env: val\n+                .env\n+                .map(|env| env.into_iter().map(|var| (var.name, var.value)).collect()),\n             define_env: val.define_env.map(|env| env.into()),\n             dev: val.dev,\n-            encryption_key: val.encryption_key.map(From::from),\n-            build_id: val.build_id.map(From::from),\n+            encryption_key: val.encryption_key,\n+            build_id: val.build_id,\n             preview_props: val.preview_props.map(|props| props.into()),\n         }\n     }\n@@ -288,17 +286,17 @@ impl From<NapiDefineEnv> for DefineEnv {\n             client: val\n                 .client\n                 .into_iter()\n-                .map(|var| (var.name.into(), var.value.into()))\n+                .map(|var| (var.name, var.value))\n                 .collect(),\n             edge: val\n                 .edge\n                 .into_iter()\n-                .map(|var| (var.name.into(), var.value.into()))\n+                .map(|var| (var.name, var.value))\n                 .collect(),\n             nodejs: val\n                 .nodejs\n                 .into_iter()\n-                .map(|var| (var.name.into(), var.value.into()))\n+                .map(|var| (var.name, var.value))\n                 .collect(),\n         }\n     }\n@@ -363,9 +361,8 @@ pub async fn project_new(\n         let subscriber = subscriber.with(console_subscriber::spawn());\n \n         let subscriber = subscriber.with(FilterLayer::try_new(&trace).unwrap());\n-        let dist_dir = options.dist_dir.clone();\n \n-        let internal_dir = PathBuf::from(&options.project_path).join(dist_dir);\n+        let internal_dir = PathBuf::from(&options.project_path).join(&options.dist_dir);\n         std::fs::create_dir_all(&internal_dir)\n             .context(\"Unable to create .next directory\")\n             .unwrap();\n@@ -603,7 +600,7 @@ pub async fn project_shutdown(\n #[derive(Default)]\n pub struct AppPageNapiRoute {\n     /// The relative path from project_path to the route file\n-    pub original_name: Option<String>,\n+    pub original_name: Option<RcStr>,\n \n     pub html_endpoint: Option<External<ExternalEndpoint>>,\n     pub rsc_endpoint: Option<External<ExternalEndpoint>>,\n@@ -615,7 +612,7 @@ pub struct NapiRoute {\n     /// The router path\n     pub pathname: String,\n     /// The relative path from project_path to the route file\n-    pub original_name: Option<String>,\n+    pub original_name: Option<RcStr>,\n \n     /// The type of route, eg a Page or App\n     pub r#type: &'static str,\n@@ -661,7 +658,7 @@ impl NapiRoute {\n                     pages\n                         .into_iter()\n                         .map(|page_route| AppPageNapiRoute {\n-                            original_name: Some(page_route.original_name.into_owned()),\n+                            original_name: Some(page_route.original_name),\n                             html_endpoint: convert_endpoint(page_route.html_endpoint),\n                             rsc_endpoint: convert_endpoint(page_route.rsc_endpoint),\n                         })\n@@ -674,7 +671,7 @@ impl NapiRoute {\n                 endpoint,\n             } => NapiRoute {\n                 pathname,\n-                original_name: Some(original_name.into_owned()),\n+                original_name: Some(original_name),\n                 r#type: \"app-route\",\n                 endpoint: convert_endpoint(endpoint),\n                 ..Default::default()\n@@ -1011,7 +1008,7 @@ fn project_hmr_update_operation(\n #[napi(ts_return_type = \"{ __napiType: \\\"RootTask\\\" }\")]\n pub fn project_hmr_events(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n-    identifier: String,\n+    identifier: RcStr,\n     func: JsFunction,\n ) -> napi::Result<External<RootTask>> {\n     let turbo_tasks = project.turbo_tasks.clone();\n@@ -1024,7 +1021,7 @@ pub fn project_hmr_events(\n             let outer_identifier = identifier.clone();\n             let session = session.clone();\n             move || {\n-                let identifier: RcStr = outer_identifier.clone().into();\n+                let identifier: RcStr = outer_identifier.clone();\n                 let session = session.clone();\n                 async move {\n                     let project = project.project().to_resolved().await?;\n@@ -1056,7 +1053,7 @@ pub fn project_hmr_events(\n                 }\n                 .instrument(tracing::info_span!(\n                     \"HMR subscription\",\n-                    identifier = outer_identifier\n+                    identifier = %outer_identifier\n                 ))\n             }\n         },\n@@ -1099,7 +1096,7 @@ pub fn project_hmr_events(\n \n #[napi(object)]\n struct HmrIdentifiers {\n-    pub identifiers: Vec<String>,\n+    pub identifiers: Vec<RcStr>,\n }\n \n #[turbo_tasks::value(serialization = \"none\")]\n@@ -1165,10 +1162,7 @@ pub fn project_hmr_identifiers_subscribe(\n \n             Ok(vec![TurbopackResult {\n                 result: HmrIdentifiers {\n-                    identifiers: identifiers\n-                        .iter()\n-                        .map(|ident| ident.to_string())\n-                        .collect::<Vec<_>>(),\n+                    identifiers: ReadRef::into_owned(identifiers),\n                 },\n                 issues: issues\n                     .iter()\n@@ -1190,19 +1184,19 @@ pub enum UpdateMessage {\n \n #[napi(object)]\n struct NapiUpdateMessage {\n-    pub update_type: String,\n+    pub update_type: &'static str,\n     pub value: Option<NapiUpdateInfo>,\n }\n \n impl From<UpdateMessage> for NapiUpdateMessage {\n     fn from(update_message: UpdateMessage) -> Self {\n         match update_message {\n             UpdateMessage::Start => NapiUpdateMessage {\n-                update_type: \"start\".to_string(),\n+                update_type: \"start\",\n                 value: None,\n             },\n             UpdateMessage::End(info) => NapiUpdateMessage {\n-                update_type: \"end\".to_string(),\n+                update_type: \"end\",\n                 value: Some(info.into()),\n             },\n         }\n@@ -1328,12 +1322,12 @@ pub struct StackFrame {\n     pub is_server: bool,\n     pub is_internal: Option<bool>,\n     pub original_file: Option<String>,\n-    pub file: String,\n+    pub file: RcStr,\n     // 1-indexed, unlike source map tokens\n     pub line: Option<u32>,\n     // 1-indexed, unlike source map tokens\n     pub column: Option<u32>,\n-    pub method_name: Option<String>,\n+    pub method_name: Option<RcStr>,\n }\n \n #[turbo_tasks::function]\n@@ -1420,7 +1414,7 @@ pub async fn project_trace_source(\n     let container = project.container;\n     let traced_frame = turbo_tasks\n         .run_once(async move {\n-            let Some(map) = &*get_source_map_operation(container, RcStr::from(frame.file))\n+            let Some(map) = &*get_source_map_operation(container, frame.file)\n                 .read_strongly_consistent()\n                 .await?\n             else {\n@@ -1461,10 +1455,12 @@ pub async fn project_trace_source(\n             {\n                 // Client code uses file://\n                 (\n-                    get_relative_path_to(&current_directory_file_url, &original_file)\n-                        // TODO(sokra) remove this to include a ./ here to make it a relative path\n-                        .trim_start_matches(\"./\")\n-                        .to_string(),\n+                    RcStr::from(\n+                        get_relative_path_to(&current_directory_file_url, &original_file)\n+                            // TODO(sokra) remove this to include a ./ here to make it a relative\n+                            // path\n+                            .trim_start_matches(\"./\"),\n+                    ),\n                     Some(source_file.to_string()),\n                     false,\n                 )\n@@ -1474,20 +1470,21 @@ pub async fn project_trace_source(\n                 // Server code uses turbopack:///[project]\n                 // TODO should this also be file://?\n                 (\n-                    get_relative_path_to(\n-                        &current_directory_file_url,\n-                        &format!(\"{project_root_uri}{source_file}\"),\n-                    )\n-                    // TODO(sokra) remove this to include a ./ here to make it a relative path\n-                    .trim_start_matches(\"./\")\n-                    .to_string(),\n+                    RcStr::from(\n+                        get_relative_path_to(\n+                            &current_directory_file_url,\n+                            &format!(\"{project_root_uri}{source_file}\"),\n+                        )\n+                        // TODO(sokra) remove this to include a ./ here to make it a relative path\n+                        .trim_start_matches(\"./\"),\n+                    ),\n                     Some(source_file.to_string()),\n                     false,\n                 )\n             } else if let Some(source_file) = original_file.strip_prefix(&*SOURCE_MAP_PREFIX) {\n                 // All other code like turbopack:///[turbopack] is internal code\n                 // TODO(veil): Should the protocol be preserved?\n-                (source_file.to_string(), None, true)\n+                (RcStr::from(source_file), None, true)\n             } else {\n                 bail!(\n                     \"Original file ({}) outside project ({})\",\n@@ -1499,7 +1496,7 @@ pub async fn project_trace_source(\n             Ok(Some(StackFrame {\n                 file,\n                 original_file,\n-                method_name: name.as_ref().map(ToString::to_string),\n+                method_name: name,\n                 line,\n                 column,\n                 is_server: frame.is_server,\n@@ -1514,7 +1511,7 @@ pub async fn project_trace_source(\n #[napi]\n pub async fn project_get_source_for_asset(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n-    file_path: String,\n+    file_path: RcStr,\n ) -> napi::Result<Option<String>> {\n     let turbo_tasks = project.turbo_tasks.clone();\n     let source = turbo_tasks\n@@ -1525,7 +1522,7 @@ pub async fn project_get_source_for_asset(\n                 .project_path()\n                 .fs()\n                 .root()\n-                .join(file_path.clone().into())\n+                .join(file_path.clone())\n                 .read()\n                 .await?;\n \n@@ -1544,14 +1541,14 @@ pub async fn project_get_source_for_asset(\n #[napi]\n pub async fn project_get_source_map(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n-    file_path: String,\n+    file_path: RcStr,\n ) -> napi::Result<Option<String>> {\n     let turbo_tasks = project.turbo_tasks.clone();\n     let container = project.container;\n \n     let source_map = turbo_tasks\n         .run_once(async move {\n-            let Some(map) = &*get_source_map_rope_operation(container, RcStr::from(file_path))\n+            let Some(map) = &*get_source_map_rope_operation(container, file_path)\n                 .read_strongly_consistent()\n                 .await?\n             else {\n@@ -1568,7 +1565,7 @@ pub async fn project_get_source_map(\n #[napi]\n pub fn project_get_source_map_sync(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n-    file_path: String,\n+    file_path: RcStr,\n ) -> napi::Result<Option<String>> {\n     within_runtime_if_available(|| {\n         tokio::runtime::Handle::current().block_on(project_get_source_map(project, file_path))"
        },
        {
            "sha": "f06b79992e0c5a50d933e3d1b12daa27834d05b3",
            "filename": "crates/next-build/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnext-build%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnext-build%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build%2FCargo.toml?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -15,6 +15,7 @@ workspace = true\n [dependencies]\n next-core = { workspace = true }\n turbopack-core = { workspace = true }\n+turbo-rcstr = { workspace = true }\n \n [build-dependencies]\n turbo-tasks-build = { workspace = true }"
        },
        {
            "sha": "37c3395c6a0faa7aac8414d6ac5ef3c19c1f0c32",
            "filename": "crates/next-build/src/build_options.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnext-build%2Fsrc%2Fbuild_options.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/crates%2Fnext-build%2Fsrc%2Fbuild_options.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build%2Fsrc%2Fbuild_options.rs?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -1,6 +1,7 @@\n use std::path::PathBuf;\n \n use next_core::next_config::Rewrites;\n+use turbo_rcstr::RcStr;\n use turbopack_core::issue::IssueSeverity;\n \n #[derive(Clone, Debug)]\n@@ -46,7 +47,7 @@ pub struct BuildContext {\n \n #[derive(Debug, Clone)]\n pub struct DefineEnv {\n-    pub client: Vec<(String, String)>,\n-    pub edge: Vec<(String, String)>,\n-    pub nodejs: Vec<(String, String)>,\n+    pub client: Vec<(RcStr, RcStr)>,\n+    pub edge: Vec<(RcStr, RcStr)>,\n+    pub nodejs: Vec<(RcStr, RcStr)>,\n }"
        },
        {
            "sha": "3458f93d4480c99b5482f72cf0dc0e23b5d2af07",
            "filename": "examples/basic-css/tsconfig.json",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/examples%2Fbasic-css%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/examples%2Fbasic-css%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fbasic-css%2Ftsconfig.json?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -18,8 +18,9 @@\n         \"name\": \"next\"\n       }\n     ],\n-    \"strictNullChecks\": true\n+    \"strictNullChecks\": true,\n+    \"target\": \"ES2017\"\n   },\n   \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n-  \"exclude\": [\"node_modules\"]\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n }"
        },
        {
            "sha": "fb3f85cf4185d3bea9b7998737fe6783018e90ac",
            "filename": "turbopack/crates/turbo-rcstr/Cargo.toml",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbo-rcstr%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbo-rcstr%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-rcstr%2FCargo.toml?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -5,15 +5,17 @@ edition = \"2024\"\n license = \"MIT\"\n \n [features]\n-atom_size_64=[]\n-atom_size_128=[]\n+atom_size_64 = []\n+atom_size_128 = []\n+napi = [\"dep:napi\"]\n \n [dependencies]\n triomphe = { workspace = true }\n turbo-tasks-hash = { workspace = true }\n serde = { workspace = true }\n new_debug_unreachable = \"1.0.6\"\n shrink-to-fit = { workspace = true }\n+napi = { workspace = true, optional = true }\n \n [dev-dependencies]\n criterion = { workspace = true }"
        },
        {
            "sha": "d6794506b59cacaa2022adc60a9a20f93d8c9bf3",
            "filename": "turbopack/crates/turbo-rcstr/src/lib.rs",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -307,6 +307,46 @@ impl ShrinkToFit for RcStr {\n     fn shrink_to_fit(&mut self) {}\n }\n \n+#[cfg(feature = \"napi\")]\n+mod napi_impl {\n+    use napi::{\n+        bindgen_prelude::{FromNapiValue, ToNapiValue, TypeName, ValidateNapiValue},\n+        sys::{napi_env, napi_value},\n+    };\n+\n+    use super::*;\n+\n+    impl TypeName for RcStr {\n+        fn type_name() -> &'static str {\n+            String::type_name()\n+        }\n+\n+        fn value_type() -> napi::ValueType {\n+            String::value_type()\n+        }\n+    }\n+\n+    impl ToNapiValue for RcStr {\n+        unsafe fn to_napi_value(env: napi_env, val: Self) -> napi::Result<napi_value> {\n+            unsafe { ToNapiValue::to_napi_value(env, val.as_str()) }\n+        }\n+    }\n+\n+    impl FromNapiValue for RcStr {\n+        unsafe fn from_napi_value(env: napi_env, napi_val: napi_value) -> napi::Result<Self> {\n+            Ok(RcStr::from(unsafe {\n+                String::from_napi_value(env, napi_val)\n+            }?))\n+        }\n+    }\n+\n+    impl ValidateNapiValue for RcStr {\n+        unsafe fn validate(env: napi_env, napi_val: napi_value) -> napi::Result<napi_value> {\n+            unsafe { String::validate(env, napi_val) }\n+        }\n+    }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use std::mem::ManuallyDrop;"
        },
        {
            "sha": "08a5893c1ceec21a98a2192730cbaac4ce50a9d6",
            "filename": "turbopack/crates/turbopack-ecmascript-hmr-protocol/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2FCargo.toml?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -16,5 +16,6 @@ workspace = true\n serde = { workspace = true }\n serde_json = { workspace = true }\n \n+turbo-rcstr = { workspace = true }\n turbopack-cli-utils = { workspace = true }\n turbopack-core = { workspace = true }"
        },
        {
            "sha": "e8363d2270762d2de24c166768d66a135127a9f7",
            "filename": "turbopack/crates/turbopack-ecmascript-hmr-protocol/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8fa42deefd59d8aae87112892c9af8aa0cf1290f/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-hmr-protocol%2Fsrc%2Flib.rs?ref=8fa42deefd59d8aae87112892c9af8aa0cf1290f",
            "patch": "@@ -2,6 +2,7 @@ use std::{collections::BTreeMap, fmt::Display, ops::Deref, path::PathBuf};\n \n use serde::{Deserialize, Serialize};\n use serde_json::Value;\n+use turbo_rcstr::RcStr;\n use turbopack_cli_utils::issue::{LogOptions, format_issue};\n use turbopack_core::{\n     issue::{IssueSeverity, IssueStage, PlainIssue, StyledString},\n@@ -10,8 +11,8 @@ use turbopack_core::{\n \n #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, Hash)]\n pub struct ResourceIdentifier {\n-    pub path: String,\n-    pub headers: Option<BTreeMap<String, String>>,\n+    pub path: RcStr,\n+    pub headers: Option<BTreeMap<RcStr, RcStr>>,\n }\n \n impl Display for ResourceIdentifier {"
        }
    ],
    "stats": {
        "total": 256,
        "additions": 152,
        "deletions": 104
    }
}