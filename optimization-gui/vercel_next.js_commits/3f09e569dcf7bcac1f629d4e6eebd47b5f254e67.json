{
    "author": "mischnic",
    "message": "Turbopack: don't fail on export type in use server (#85054)\n\nAllow `export type ... from \"...\";`",
    "sha": "3f09e569dcf7bcac1f629d4e6eebd47b5f254e67",
    "files": [
        {
            "sha": "438fa526389d1ab6c53d5286fb0b84c4becc7fae",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 70,
            "deletions": 50,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=3f09e569dcf7bcac1f629d4e6eebd47b5f254e67",
            "patch": "@@ -1534,64 +1534,78 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                         }\n                     }\n                     ModuleItem::ModuleDecl(ModuleDecl::ExportNamed(named)) => {\n-                        if named.src.is_some() {\n-                            disallowed_export_span = named.span;\n-                        } else {\n-                            for spec in &mut named.specifiers {\n-                                if let ExportSpecifier::Named(ExportNamedSpecifier {\n-                                    orig: ModuleExportName::Ident(ident),\n-                                    exported,\n-                                    ..\n-                                }) = spec\n-                                {\n-                                    if let Some(export_name) = exported {\n-                                        if let ModuleExportName::Ident(Ident { sym, .. }) =\n-                                            export_name\n-                                        {\n-                                            // export { foo as bar }\n-                                            self.exported_idents.push((\n-                                                ident.clone(),\n-                                                sym.clone(),\n-                                                self.generate_server_reference_id(\n-                                                    sym.as_ref(),\n-                                                    in_cache_file,\n-                                                    None,\n-                                                ),\n-                                            ));\n-                                        } else if let ModuleExportName::Str(str) = export_name {\n-                                            // export { foo as \"bar\" }\n-                                            self.exported_idents.push((\n-                                                ident.clone(),\n-                                                str.value.clone(),\n-                                                self.generate_server_reference_id(\n-                                                    str.value.as_ref(),\n-                                                    in_cache_file,\n-                                                    None,\n-                                                ),\n-                                            ));\n+                        if !named.type_only {\n+                            if named.src.is_some() {\n+                                if named.specifiers.iter().any(|s| match s {\n+                                    ExportSpecifier::Namespace(_) | ExportSpecifier::Default(_) => {\n+                                        true\n+                                    }\n+                                    ExportSpecifier::Named(s) => !s.is_type_only,\n+                                }) {\n+                                    disallowed_export_span = named.span;\n+                                }\n+                            } else {\n+                                for spec in &mut named.specifiers {\n+                                    if let ExportSpecifier::Named(ExportNamedSpecifier {\n+                                        orig: ModuleExportName::Ident(ident),\n+                                        exported,\n+                                        is_type_only,\n+                                        ..\n+                                    }) = spec\n+                                    {\n+                                        if !*is_type_only {\n+                                            if let Some(export_name) = exported {\n+                                                if let ModuleExportName::Ident(Ident {\n+                                                    sym, ..\n+                                                }) = export_name\n+                                                {\n+                                                    // export { foo as bar }\n+                                                    self.exported_idents.push((\n+                                                        ident.clone(),\n+                                                        sym.clone(),\n+                                                        self.generate_server_reference_id(\n+                                                            sym.as_ref(),\n+                                                            in_cache_file,\n+                                                            None,\n+                                                        ),\n+                                                    ));\n+                                                } else if let ModuleExportName::Str(str) =\n+                                                    export_name\n+                                                {\n+                                                    // export { foo as \"bar\" }\n+                                                    self.exported_idents.push((\n+                                                        ident.clone(),\n+                                                        str.value.clone(),\n+                                                        self.generate_server_reference_id(\n+                                                            str.value.as_ref(),\n+                                                            in_cache_file,\n+                                                            None,\n+                                                        ),\n+                                                    ));\n+                                                }\n+                                            } else {\n+                                                // export { foo }\n+                                                self.exported_idents.push((\n+                                                    ident.clone(),\n+                                                    ident.sym.clone(),\n+                                                    self.generate_server_reference_id(\n+                                                        ident.sym.as_ref(),\n+                                                        in_cache_file,\n+                                                        None,\n+                                                    ),\n+                                                ));\n+                                            }\n                                         }\n                                     } else {\n-                                        // export { foo }\n-                                        self.exported_idents.push((\n-                                            ident.clone(),\n-                                            ident.sym.clone(),\n-                                            self.generate_server_reference_id(\n-                                                ident.sym.as_ref(),\n-                                                in_cache_file,\n-                                                None,\n-                                            ),\n-                                        ));\n+                                        disallowed_export_span = named.span;\n                                     }\n-                                } else {\n-                                    disallowed_export_span = named.span;\n                                 }\n                             }\n                         }\n                     }\n                     ModuleItem::ModuleDecl(ModuleDecl::ExportDefaultDecl(ExportDefaultDecl {\n                         decl,\n                         span,\n-                        ..\n                     })) => match decl {\n                         DefaultDecl::Fn(f) => {\n                             let (is_action_fn, is_cache_fn) = has_body_directive(&f.function.body);\n@@ -1760,8 +1774,14 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                             }\n                         }\n                     }\n-                    ModuleItem::ModuleDecl(ModuleDecl::ExportAll(ExportAll { span, .. })) => {\n-                        disallowed_export_span = *span;\n+                    ModuleItem::ModuleDecl(ModuleDecl::ExportAll(ExportAll {\n+                        span,\n+                        type_only,\n+                        ..\n+                    })) => {\n+                        if !*type_only {\n+                            disallowed_export_span = *span;\n+                        }\n                     }\n                     _ => {}\n                 }"
        },
        {
            "sha": "7a96eeff9cd0f76ca3a6b1a321273a82fdad9795",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/62/input.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Finput.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Finput.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Finput.ts?ref=3f09e569dcf7bcac1f629d4e6eebd47b5f254e67",
            "patch": "@@ -0,0 +1,13 @@\n+'use server'\n+\n+export type X = string\n+// @ts-ignore -- that file does not exist\n+export { type A } from './a'\n+// @ts-ignore -- that file does not exist\n+export type { B } from './b'\n+// @ts-ignore -- that file does not exist\n+export type * from './c'\n+\n+export async function actionA(): Promise<string> {\n+  return 'hello from actionA'\n+}"
        },
        {
            "sha": "af1f4d386df6bf95eff850b0792ae6a81c362fc8",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/62/output.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Foutput.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3f09e569dcf7bcac1f629d4e6eebd47b5f254e67/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Foutput.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F62%2Foutput.ts?ref=3f09e569dcf7bcac1f629d4e6eebd47b5f254e67",
            "patch": "@@ -0,0 +1,17 @@\n+/* __next_internal_action_entry_do_not_use__ {\"0095ef8ede0a8a4c822fcbdb018cb264731cb15281\":\"actionA\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n+import { encryptActionBoundArgs, decryptActionBoundArgs } from \"private-next-rsc-action-encryption\";\n+export type X = string;\n+// @ts-ignore -- that file does not exist\n+export { type A } from './a';\n+// @ts-ignore -- that file does not exist\n+export type { B } from './b';\n+// @ts-ignore -- that file does not exist\n+export type * from './c';\n+export async function actionA(): Promise<string> {\n+    return 'hello from actionA';\n+}\n+import { ensureServerEntryExports } from \"private-next-rsc-action-validate\";\n+ensureServerEntryExports([\n+    actionA\n+]);\n+registerServerReference(actionA, \"0095ef8ede0a8a4c822fcbdb018cb264731cb15281\", null);"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 100,
        "deletions": 50
    }
}