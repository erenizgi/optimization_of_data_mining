{
    "author": "styfle",
    "message": "feat(next/image): warn when images.localPatterns is undefined and src has query (#82627)\n\nAdd a warning to Next.js 15.5 to prepare for Next.js 16 when\n`images.localPatterns` is undefined and the user attempted to optimize a\n`src` image with a query string, such as\n\n```jsx\n<Image src=\"/api/user?id=1\" width=\"50\" height=\"50\" />\n```",
    "sha": "39a771662ffdd0500c770dbb5108b732f2c785e2",
    "files": [
        {
            "sha": "f45b23296a8106e2d588acb80c75ad5e3e4f2f3f",
            "filename": "errors/next-image-unconfigured-localpatterns.mdx",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/39a771662ffdd0500c770dbb5108b732f2c785e2/errors%2Fnext-image-unconfigured-localpatterns.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/39a771662ffdd0500c770dbb5108b732f2c785e2/errors%2Fnext-image-unconfigured-localpatterns.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/errors%2Fnext-image-unconfigured-localpatterns.mdx?ref=39a771662ffdd0500c770dbb5108b732f2c785e2",
            "patch": "@@ -10,6 +10,22 @@ One of your pages that leverages the `next/image` component, passed a `src` valu\n \n Add an entry to `images.localPatterns` array in `next.config.js` with the expected URL pattern. For example:\n \n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    localPatterns: [\n+      {\n+        pathname: '/assets/**',\n+      },\n+    ],\n+  },\n+}\n+```\n+\n+Omitting the `search` will allow all query strings.\n+\n+If you want to prevent the query string from matching, you can use the empty string, for example:\n+\n ```js filename=\"next.config.js\"\n module.exports = {\n   images: {"
        },
        {
            "sha": "12e23e11095282d924add5d6c304a82e018f50f3",
            "filename": "packages/next/src/client/legacy/image.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/39a771662ffdd0500c770dbb5108b732f2c785e2/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/39a771662ffdd0500c770dbb5108b732f2c785e2/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx?ref=39a771662ffdd0500c770dbb5108b732f2c785e2",
            "patch": "@@ -866,6 +866,19 @@ export default function Image({\n         )\n       }\n \n+      if (\n+        src.startsWith('/') &&\n+        src.includes('?') &&\n+        (!config?.localPatterns?.length ||\n+          (config.localPatterns.length === 1 &&\n+            config.localPatterns[0].pathname === '/_next/static/media/**'))\n+      ) {\n+        warnOnce(\n+          `Image with src \"${src}\" is using a query string which is not configured in images.localPatterns. This config will be required starting in Next.js 16.` +\n+            `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns`\n+        )\n+      }\n+\n       if (!unoptimized && loader !== defaultImageLoader) {\n         const urlStr = loader({\n           config,"
        },
        {
            "sha": "1df7028ca9e5e51bb105da4a94703f801531eb65",
            "filename": "packages/next/src/shared/lib/get-img-props.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/39a771662ffdd0500c770dbb5108b732f2c785e2/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/39a771662ffdd0500c770dbb5108b732f2c785e2/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts?ref=39a771662ffdd0500c770dbb5108b732f2c785e2",
            "patch": "@@ -538,6 +538,18 @@ export function getImgProps(\n           `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-qualities`\n       )\n     }\n+    if (\n+      src.startsWith('/') &&\n+      src.includes('?') &&\n+      (!config?.localPatterns?.length ||\n+        (config.localPatterns.length === 1 &&\n+          config.localPatterns[0].pathname === '/_next/static/media/**'))\n+    ) {\n+      warnOnce(\n+        `Image with src \"${src}\" is using a query string which is not configured in images.localPatterns. This config will be required starting in Next.js 16.` +\n+          `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns`\n+      )\n+    }\n     if (placeholder === 'blur' && !blurDataURL) {\n       const VALID_BLUR_EXT = ['jpeg', 'png', 'webp', 'avif'] // should match next-image-loader\n "
        },
        {
            "sha": "39ac3226058c23271be83d8734c0e0f7ddd58852",
            "filename": "test/unit/next-image-get-img-props.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/39a771662ffdd0500c770dbb5108b732f2c785e2/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/39a771662ffdd0500c770dbb5108b732f2c785e2/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-image-get-img-props.test.ts?ref=39a771662ffdd0500c770dbb5108b732f2c785e2",
            "patch": "@@ -401,7 +401,9 @@ describe('getImageProps()', () => {\n       width: 100,\n       height: 200,\n     })\n-    expect(warningMessages).toStrictEqual([])\n+    expect(warningMessages).toStrictEqual([\n+      'Image with src \"/test.svg?v=1\" is using a query string which is not configured in images.localPatterns. This config will be required starting in Next.js 16.\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns',\n+    ])\n     expect(Object.entries(props)).toStrictEqual([\n       ['alt', 'a nice desc'],\n       ['loading', 'lazy'],"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 44,
        "deletions": 1
    }
}