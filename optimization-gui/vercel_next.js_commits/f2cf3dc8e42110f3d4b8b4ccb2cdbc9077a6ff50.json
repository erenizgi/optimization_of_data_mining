{
    "author": "huozhi",
    "message": "[next-server] skip setting vary header for basic routes (#77797)\n\n### What\n\nAfter https://github.com/vercel/vercel/pull/13011 landed on Vercel CLI,\nnoticing that we're still checking the `vary` header in the tests, which\nis obselete now. In this PR we delete the handling for setting the\n`vary` header but still keep the cases of interception routes since it's\nstill needed.\n\n### Why\n\nSince v13.4.6 we added the `_rsc` query with the unique hash, `vary`\nheader becomes not required anymore.\n\nCloses NDX-1010",
    "sha": "f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50",
    "files": [
        {
            "sha": "2df0b83de31147034e1989c4400449c9d7e43c17",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50",
            "patch": "@@ -104,7 +104,6 @@ import {\n   NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n   NEXT_DID_POSTPONE_HEADER,\n   NEXT_URL,\n-  NEXT_ROUTER_STATE_TREE_HEADER,\n   NEXT_IS_PRERENDER_HEADER,\n } from '../client/components/app-router-headers'\n import type {\n@@ -1978,21 +1977,16 @@ export default abstract class Server<\n     isAppPath: boolean,\n     resolvedPathname: string\n   ): void {\n-    const baseVaryHeader = `${RSC_HEADER}, ${NEXT_ROUTER_STATE_TREE_HEADER}, ${NEXT_ROUTER_PREFETCH_HEADER}, ${NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`\n-    const isRSCRequest = getRequestMeta(req, 'isRSCRequest') ?? false\n-\n     let addedNextUrlToVary = false\n \n     if (isAppPath && this.pathCouldBeIntercepted(resolvedPathname)) {\n       // Interception route responses can vary based on the `Next-URL` header.\n       // We use the Vary header to signal this behavior to the client to properly cache the response.\n-      res.appendHeader('vary', `${baseVaryHeader}, ${NEXT_URL}`)\n+      res.appendHeader('vary', `${NEXT_URL}`)\n       addedNextUrlToVary = true\n-    } else if (isAppPath || isRSCRequest) {\n-      // We don't need to include `Next-URL` in the Vary header for non-interception routes since it won't affect the response.\n-      // We also set this header for pages to avoid caching issues when navigating between pages and app.\n-      res.appendHeader('vary', baseVaryHeader)\n     }\n+    // For other cases such as App Router requests or RSC requests we don't need to set vary header since we already\n+    // have the _rsc query with the unique hash value.\n \n     if (!addedNextUrlToVary) {\n       // Remove `Next-URL` from the request headers we determined it wasn't necessary to include in the Vary header."
        },
        {
            "sha": "b448d29353eb66812f296a50c387fdfa36846f65",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50",
            "patch": "@@ -323,27 +323,6 @@ describe('app dir - basic', () => {\n     expect(res.headers.get('Content-Type')).toBe('text/x-component')\n   })\n \n-  it('should return the `vary` header from edge runtime', async () => {\n-    const res = await next.fetch('/dashboard')\n-    expect(res.headers.get('x-edge-runtime')).toBe('1')\n-    expect(res.headers.get('vary')).toBe(\n-      'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch'\n-    )\n-  })\n-\n-  it('should return the `vary` header from pages for flight requests', async () => {\n-    const res = await next.fetch('/', {\n-      headers: {\n-        ['RSC'.toString()]: '1',\n-      },\n-    })\n-    expect(res.headers.get('vary')).toBe(\n-      isNextDeploy\n-        ? 'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch'\n-        : 'RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch, Accept-Encoding'\n-    )\n-  })\n-\n   it('should pass props from getServerSideProps in root layout', async () => {\n     const $ = await next.render$('/dashboard')\n     expect($('title').first().text()).toBe('hello world')"
        },
        {
            "sha": "1fcf82bd0f38cc1637bbc253193a3405c42fd80d",
            "filename": "test/e2e/vary-header/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fvary-header%2Ftest%2Findex.test.ts?ref=f2cf3dc8e42110f3d4b8b4ccb2cdbc9077a6ff50",
            "patch": "@@ -12,21 +12,16 @@ describe('Vary Header Tests', () => {\n     expect(res.headers.get('vary')).toContain('Custom-Header')\n   })\n \n-  it('should preserve custom vary header and append RSC headers in app route handlers', async () => {\n+  it('should preserve custom vary header', async () => {\n     const res = await next.fetch('/normal')\n     const varyHeader = res.headers.get('vary')\n \n     // Custom header is preserved\n     expect(varyHeader).toContain('User-Agent')\n     expect(res.headers.get('cache-control')).toBe('s-maxage=3600')\n-\n-    // Next.js internal headers are appended\n-    expect(varyHeader).toContain('RSC')\n-    expect(varyHeader).toContain('Next-Router-State-Tree')\n-    expect(varyHeader).toContain('Next-Router-Prefetch')\n   })\n \n-  it('should preserve middleware vary header in combination with route handlers', async () => {\n+  it('should preserve middleware vary header', async () => {\n     const res = await next.fetch('/normal')\n     const varyHeader = res.headers.get('vary')\n     const customHeader = res.headers.get('my-custom-header')\n@@ -37,10 +32,5 @@ describe('Vary Header Tests', () => {\n     // Both middleware and route handler vary headers are preserved\n     expect(varyHeader).toContain('my-custom-header')\n     expect(varyHeader).toContain('User-Agent')\n-\n-    // Next.js internal headers are still present\n-    expect(varyHeader).toContain('RSC')\n-    expect(varyHeader).toContain('Next-Router-State-Tree')\n-    expect(varyHeader).toContain('Next-Router-Prefetch')\n   })\n })"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 5,
        "deletions": 42
    }
}