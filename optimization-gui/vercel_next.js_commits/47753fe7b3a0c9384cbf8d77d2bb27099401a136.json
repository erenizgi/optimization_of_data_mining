{
    "author": "huozhi",
    "message": "[metadata] enable streaming metadata by default (#76221)",
    "sha": "47753fe7b3a0c9384cbf8d77d2bb27099401a136",
    "files": [
        {
            "sha": "4d0931b8c8a5f6534a4842637e283170df957f8c",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -387,7 +387,12 @@ async function exportAppImpl(\n       clientSegmentCache: nextConfig.experimental.clientSegmentCache ?? false,\n       inlineCss: nextConfig.experimental.inlineCss ?? false,\n       authInterrupts: !!nextConfig.experimental.authInterrupts,\n-      streamingMetadata: !!nextConfig.experimental.streamingMetadata,\n+      streamingMetadata:\n+        // Disable streaming metadata when dynamic IO is enabled.\n+        // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n+        // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n+        !nextConfig.experimental.dynamicIO &&\n+        !!nextConfig.experimental.streamingMetadata,\n       htmlLimitedBots: nextConfig.experimental.htmlLimitedBots,\n     },\n     reactMaxHeadersLength: nextConfig.reactMaxHeadersLength,"
        },
        {
            "sha": "26d109fc5c93494dda912ce5e0316647ef305172",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -424,8 +424,13 @@ export async function exportPages(\n             debugOutput: options.debugOutput,\n             enableExperimentalReact: needsExperimentalReact(nextConfig),\n             sriEnabled: Boolean(nextConfig.experimental.sri?.algorithm),\n-            streamingMetadata: nextConfig.experimental.streamingMetadata,\n             buildId: input.buildId,\n+            streamingMetadata:\n+              // Disable streaming metadata when dynamic IO is enabled.\n+              // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n+              // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n+              !nextConfig.experimental.dynamicIO &&\n+              !!nextConfig.experimental.streamingMetadata,\n           }),\n           // If exporting the page takes longer than the timeout, reject the promise.\n           new Promise((_, reject) => {"
        },
        {
            "sha": "0c90147c701be7bea1500853c436c464d7622b01",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -610,7 +610,12 @@ export default abstract class Server<\n           this.nextConfig.experimental.clientSegmentCache ?? false,\n         inlineCss: this.nextConfig.experimental.inlineCss ?? false,\n         authInterrupts: !!this.nextConfig.experimental.authInterrupts,\n-        streamingMetadata: !!this.nextConfig.experimental.streamingMetadata,\n+        streamingMetadata:\n+          // Disable streaming metadata when dynamic IO is enabled.\n+          // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n+          // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n+          !this.nextConfig.experimental.dynamicIO &&\n+          !!this.nextConfig.experimental.streamingMetadata,\n         htmlLimitedBots: this.nextConfig.experimental.htmlLimitedBots,\n       },\n       onInstrumentationRequestError:"
        },
        {
            "sha": "1d2a8f992ac9ba8c9633bfa05a4f946c4d9f40af",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -1258,7 +1258,7 @@ export const defaultConfig: NextConfig = {\n     staticGenerationMinPagesPerWorker: 25,\n     dynamicIO: false,\n     inlineCss: false,\n-    streamingMetadata: false,\n+    streamingMetadata: true,\n     htmlLimitedBots: undefined,\n     useCache: undefined,\n     slowModuleDetection: undefined,"
        },
        {
            "sha": "95f654cafc2fc684830466ad1e99910658830b42",
            "filename": "test/e2e/app-dir/metadata-navigation/app/async/redirect/dest/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fdest%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fdest%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fdest%2Fpage.tsx?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>redirect dest page</p>\n+}"
        },
        {
            "sha": "a1680e2a882e75ec60d51b815cf83c29c445c2de",
            "filename": "test/e2e/app-dir/metadata-navigation/app/async/redirect/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fasync%2Fredirect%2Fpage.tsx?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -1,9 +1,9 @@\n import { redirect } from 'next/navigation'\n \n export default function page() {\n-  return 'redirect to basic'\n+  return 'redirect page'\n }\n \n export async function generateMetadata() {\n-  redirect('/basic')\n+  redirect('/async/redirect/dest')\n }"
        },
        {
            "sha": "2c18e43e33304118d91bba25eb5cb8dc4af31630",
            "filename": "test/e2e/app-dir/metadata-navigation/metadata-navigation.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -3,6 +3,7 @@ import {\n   createMultiDomMatcher,\n   createMultiHtmlMatcher,\n   getTitle,\n+  retry,\n } from 'next-test-utils'\n \n describe('app dir - metadata navigation', () => {\n@@ -28,7 +29,8 @@ describe('app dir - metadata navigation', () => {\n \n     it('should support notFound in generateMetadata', async () => {\n       const res = await next.fetch('/async/not-found')\n-      expect(res.status).toBe(404)\n+      // metadata is suspended in SSR, it won't affect the response status\n+      expect(res.status).toBe(200)\n       const $ = await next.render$('/async/not-found')\n \n       // TODO-APP: support render custom not-found in SSR for generateMetadata.\n@@ -75,7 +77,14 @@ describe('app dir - metadata navigation', () => {\n       const res = await next.fetch('/async/redirect', {\n         redirect: 'manual',\n       })\n-      expect(res.status).toBe(307)\n+      // metadata is suspended in SSR, it won't affect the response status\n+      expect(res.status).toBe(200)\n+      const browser = await next.browser('/async/redirect')\n+      await retry(async () => {\n+        expect(await browser.elementByCss('p').text()).toBe(\n+          'redirect dest page'\n+        )\n+      })\n     })\n \n     it('should show the index title', async () => {"
        },
        {
            "sha": "e6765a7c12d77e4822317deaa7d9ad3c305f6536",
            "filename": "test/e2e/app-dir/metadata-static-generation/metadata-static-generation.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -2,14 +2,17 @@ import { nextTestSetup } from 'e2e-utils'\n \n const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n \n-// PPR tests are covered in test/e2e/app-dir/ppr-metadata-blocking\n ;(isPPREnabled ? describe.skip : describe)(\n   'app-dir - metadata-static-generation',\n   () => {\n-    const { next, isNextStart } = nextTestSetup({\n+    const { next, isNextDev, isNextStart } = nextTestSetup({\n       files: __dirname,\n     })\n \n+    // In dev, it suspenses as dynamic rendering so it's inserted into body;\n+    // In build, it's resolved as static rendering so it's inserted into head.\n+    const rootSelector = isNextDev ? 'body' : 'head'\n+\n     if (isNextStart) {\n       // Precondition for the following tests in build mode.\n       // This test is only useful for non-PPR mode as in PPR mode those routes\n@@ -28,20 +31,22 @@ const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n \n     it('should contain async generated metadata in head for simple static page', async () => {\n       const $ = await next.render$('/')\n-      expect($('head title').text()).toBe('index page')\n-      expect($('head meta[name=\"description\"]').attr('content')).toBe(\n-        'index page description'\n-      )\n+      expect($(`${rootSelector} title`).text()).toBe('index page')\n+      expect(\n+        $(`${rootSelector} meta[name=\"description\"]`).attr('content')\n+      ).toBe('index page description')\n     })\n \n     it('should contain async generated metadata in head static page with suspenseful content', async () => {\n       const $ = await next.render$('/suspenseful/static')\n-      expect($('head title').text()).toBe('suspenseful page - static')\n+      expect($(`${rootSelector} title`).text()).toBe(\n+        'suspenseful page - static'\n+      )\n     })\n \n-    it('should contain async generated metadata in head for dynamic page', async () => {\n+    it('should contain async generated metadata in body for dynamic page', async () => {\n       const $ = await next.render$('/suspenseful/dynamic')\n-      expect($('head title').text()).toBe('suspenseful page - dynamic')\n+      expect($('body title').text()).toBe('suspenseful page - dynamic')\n     })\n   }\n )"
        },
        {
            "sha": "74960beb06fba9635cc3035aaa61267c001da733",
            "filename": "test/e2e/app-dir/navigation/app/hash-link-back-to-same-page/page.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fhash-link-back-to-same-page%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fhash-link-back-to-same-page%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fhash-link-back-to-same-page%2Fpage.js?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -21,8 +21,8 @@ export default function HashPage() {\n         {items.map((item) => {\n           if (item.id === 160) {\n             return (\n-              <>\n-                <div key={item.id}>\n+              <div key={item.id}>\n+                <div>\n                   <div id={`hash-${item.id}`}>{item.id}</div>\n                 </div>\n                 <div key=\"to-other-page\">\n@@ -35,7 +35,7 @@ export default function HashPage() {\n                     </Link>\n                   </div>\n                 </div>\n-              </>\n+              </div>\n             )\n           }\n           return ("
        },
        {
            "sha": "37b8d12144d7d6b04b040c290c55571b67fbba1e",
            "filename": "test/e2e/app-dir/navigation/navigation.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 10,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -871,7 +871,9 @@ describe('app dir - navigation', () => {\n       const scrollPosition = await browser.eval('window.pageYOffset')\n \n       await browser.elementByCss(\"[href='/scroll-restoration/other']\").click()\n-      await browser.elementById('back-button').click()\n+      await retry(async () => {\n+        await browser.elementById('back-button').click()\n+      })\n \n       const newScrollPosition = await browser.eval('window.pageYOffset')\n \n@@ -910,15 +912,6 @@ describe('app dir - navigation', () => {\n         .click()\n \n       if (!isNextDev) {\n-        expect(\n-          await browser\n-            .waitForElementByCss(\n-              '#loading',\n-              // Give it some time to commit\n-              100\n-            )\n-            .text()\n-        ).toEqual('Loading')\n         expect(await browser.elementByCss('title').text()).toBe('Async Title')\n \n         await waitFor(resolveMetadataDuration + 500)"
        },
        {
            "sha": "d72360ccbe509c7040e865d76bba0f2b58f501b1",
            "filename": "test/e2e/app-dir/ppr-metadata-blocking/ppr-metadata-blocking-ppr-fallback.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -4,6 +4,7 @@ function countSubstring(str: string, substr: string): number {\n   return str.split(substr).length - 1\n }\n \n+// The default ppr-metadata-blocking is covered by test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts\n describe('ppr-metadata-blocking-ppr-fallback', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,"
        },
        {
            "sha": "ff18229d1d52a6470959410cb0fafece8a66a64b",
            "filename": "test/e2e/app-dir/ppr-metadata-blocking/ppr-metadata-blocking.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 161,
            "changes": 161,
            "blob_url": "https://github.com/vercel/next.js/blob/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5f596ed7bc9fe657509684b404bd4eb7786381a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking.test.ts?ref=d5f596ed7bc9fe657509684b404bd4eb7786381a",
            "patch": "@@ -1,161 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import cheerio from 'cheerio'\n-import { assertNoConsoleErrors } from 'next-test-utils'\n-\n-function countSubstring(str: string, substr: string): number {\n-  return str.split(substr).length - 1\n-}\n-\n-describe('ppr-metadata-blocking', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n-    files: __dirname,\n-    skipDeployment: true,\n-  })\n-\n-  if (skipped) return\n-\n-  // No dynamic APIs used in metadata\n-  describe('static metadata', () => {\n-    it('should generate metadata in head when page is fully static', async () => {\n-      const rootSelector = 'head'\n-      const $ = await next.render$('/fully-static')\n-      expect($(`${rootSelector} title`).text()).toBe('fully static')\n-      expect(countSubstring($.html(), '<title>')).toBe(1)\n-\n-      const browser = await next.browser('/fully-static')\n-      expect(\n-        await browser.waitForElementByCss(`${rootSelector} title`).text()\n-      ).toBe('fully static')\n-      await assertNoConsoleErrors(browser)\n-    })\n-\n-    it('should insert metadata in head when page is dynamic page content', async () => {\n-      const $ = await next.render$('/dynamic-page')\n-      expect($(`head title`).text()).toBe('dynamic page')\n-      expect(countSubstring($.html(), '<title>')).toBe(1)\n-\n-      const browser = await next.browser('/dynamic-page')\n-      expect(await browser.waitForElementByCss('head title').text()).toBe(\n-        'dynamic page'\n-      )\n-      await assertNoConsoleErrors(browser)\n-    })\n-  })\n-\n-  // Dynamic APIs used in metadata, metadata should be suspended and inserted into head\n-  describe('dynamic metadata', () => {\n-    it('should generate metadata in head when page is fully dynamic', async () => {\n-      const $ = await next.render$('/fully-dynamic')\n-      expect($('head title').text()).toBe('fully dynamic')\n-      expect(countSubstring($.html(), '<title>')).toBe(1)\n-\n-      const browser = await next.browser('/fully-dynamic')\n-      expect(await browser.waitForElementByCss('head title').text()).toBe(\n-        'fully dynamic'\n-      )\n-      await assertNoConsoleErrors(browser)\n-    })\n-\n-    it('should generate metadata in head when page content is static', async () => {\n-      const $ = await next.render$('/dynamic-metadata')\n-      expect(countSubstring($.html(), '<title>')).toBe(1)\n-      expect($('head title').text()).toBe('dynamic metadata')\n-\n-      const browser = await next.browser('/dynamic-metadata')\n-      expect(await browser.waitForElementByCss('head title').text()).toBe(\n-        'dynamic metadata'\n-      )\n-      await assertNoConsoleErrors(browser)\n-    })\n-  })\n-\n-  describe('partial shell', () => {\n-    it('should insert metadata into head with dynamic metadata and wrapped under layout Suspense boundary', async () => {\n-      const $ = await next.render$('/dynamic-metadata/partial')\n-      // Dev: dynamic rendering\n-      if (isNextDev) {\n-        expect(countSubstring($.html(), '<title>')).toBe(1)\n-        expect($('head title').text()).toBe('dynamic-metadata - partial')\n-      } else {\n-        // Production: PPR\n-        expect(countSubstring($.html(), '<title>')).toBe(0)\n-      }\n-\n-      const browser = await next.browser('/dynamic-metadata/partial')\n-      expect(await browser.waitForElementByCss('head title').text()).toBe(\n-        'dynamic-metadata - partial'\n-      )\n-      await assertNoConsoleErrors(browser)\n-    })\n-\n-    it('should insert metadata into head with dynamic metadata and dynamic page wrapped under layout Suspense boundary', async () => {\n-      const rootSelector = 'head'\n-      const $ = await next.render$('/dynamic-page/partial')\n-      expect($(`${rootSelector} title`).text()).toBe('dynamic-page - partial')\n-      expect(countSubstring($.html(), '<title>')).toBe(1)\n-\n-      const browser = await next.browser('/dynamic-page/partial')\n-      expect(\n-        await browser.waitForElementByCss(`${rootSelector} title`).text()\n-      ).toBe('dynamic-page - partial')\n-      await assertNoConsoleErrors(browser)\n-    })\n-  })\n-\n-  if (!isNextDev) {\n-    // This test is only relevant in production mode, as it's testing PPR results\n-    describe('html limited bots', () => {\n-      it('should serve partial static shell when normal UA requests the page', async () => {\n-        const res1 = await next.fetch('/dynamic-page/partial')\n-        const res2 = await next.fetch('/dynamic-page/partial')\n-\n-        const $1 = cheerio.load(await res1.text())\n-        const $2 = cheerio.load(await res2.text())\n-\n-        const attribute1 = parseInt($1('[data-date]').attr('data-date'))\n-        const attribute2 = parseInt($2('[data-date]').attr('data-date'))\n-\n-        // Normal UA should still get the partial static shell produced by PPR\n-        expect(attribute1).toBe(attribute2)\n-        expect(attribute1).toBeTruthy()\n-\n-        const headers = res1.headers\n-\n-        // Static render should have postponed header\n-        expect(headers.get('x-nextjs-postponed')).toBe('1')\n-      })\n-\n-      it('should not serve partial static shell when html limited bots requests the page', async () => {\n-        const htmlLimitedBotUA = 'Discordbot'\n-        const res1 = await next.fetch('/dynamic-page/partial', {\n-          headers: {\n-            'User-Agent': htmlLimitedBotUA,\n-          },\n-        })\n-\n-        const res2 = await next.fetch('/dynamic-page/partial', {\n-          headers: {\n-            'User-Agent': htmlLimitedBotUA,\n-          },\n-        })\n-\n-        // Dynamic render should not have postponed header\n-        const headers = res1.headers\n-        // In blocking mode of metadata, it's still postponed if metadata or page is dynamic.\n-        // It won't behave differently when the bot is visiting.\n-\n-        expect(headers.get('x-nextjs-postponed')).toBe(null)\n-\n-        const $1 = cheerio.load(await res1.text())\n-        const $2 = cheerio.load(await res2.text())\n-\n-        const attribute1 = parseInt($1('[data-date]').attr('data-date'))\n-        const attribute2 = parseInt($2('[data-date]').attr('data-date'))\n-\n-        // Two requests are dynamic and should not have the same data-date attribute\n-        expect(attribute2).not.toEqual(attribute1)\n-        expect(attribute1).toBeTruthy()\n-      })\n-    })\n-  }\n-})"
        },
        {
            "sha": "87a363139ba8daabb11a30df7f67776000505c9a",
            "filename": "test/e2e/app-dir/rsc-basic/rsc-basic.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -19,6 +19,10 @@ async function resolveStreamResponse(response: any, onData?: any) {\n   return result\n }\n \n+function stripHTMLComments(html: string): string {\n+  return html.replace(/<!--[\\s\\S]*?-->/g, '')\n+}\n+\n describe('app dir - rsc basics', () => {\n   const { next, isNextDev, isNextStart, isTurbopack } = nextTestSetup({\n     files: __dirname,\n@@ -72,13 +76,13 @@ describe('app dir - rsc basics', () => {\n   it('should correctly render page returning null', async () => {\n     const homeHTML = await next.render('/return-null/page')\n     const $ = cheerio.load(homeHTML)\n-    expect($('#return-null-layout').html()).toBeEmpty()\n+    expect(stripHTMLComments($('#return-null-layout').html())).toBeEmpty()\n   })\n \n   it('should correctly render component returning null', async () => {\n     const homeHTML = await next.render('/return-null/component')\n     const $ = cheerio.load(homeHTML)\n-    expect($('#return-null-layout').html()).toBeEmpty()\n+    expect(stripHTMLComments($('#return-null-layout').html())).toBeEmpty()\n   })\n \n   it('should correctly render layout returning null', async () => {\n@@ -90,13 +94,13 @@ describe('app dir - rsc basics', () => {\n   it('should correctly render page returning undefined', async () => {\n     const homeHTML = await next.render('/return-undefined/page')\n     const $ = cheerio.load(homeHTML)\n-    expect($('#return-undefined-layout').html()).toBeEmpty()\n+    expect(stripHTMLComments($('#return-undefined-layout').html())).toBeEmpty()\n   })\n \n   it('should correctly render component returning undefined', async () => {\n     const homeHTML = await next.render('/return-undefined/component')\n     const $ = cheerio.load(homeHTML)\n-    expect($('#return-undefined-layout').html()).toBeEmpty()\n+    expect(stripHTMLComments($('#return-undefined-layout').html())).toBeEmpty()\n   })\n \n   it('should correctly render layout returning undefined', async () => {"
        },
        {
            "sha": "815a5ce7ddf80b499503039305abd943560ae319",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47753fe7b3a0c9384cbf8d77d2bb27099401a136/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=47753fe7b3a0c9384cbf8d77d2bb27099401a136",
            "patch": "@@ -172,8 +172,8 @@ describe('opentelemetry', () => {\n                           'next.clientComponentLoadCount': isNextDev\n                             ? // In dev, additional client components are being loaded\n                               // due to RSC props being deserialized.\n-                              9\n-                            : 6,\n+                              11\n+                            : 8,\n                           'next.span_type':\n                             'NextNodeServer.clientComponentLoading',\n                         },"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 66,
        "deletions": 197
    }
}