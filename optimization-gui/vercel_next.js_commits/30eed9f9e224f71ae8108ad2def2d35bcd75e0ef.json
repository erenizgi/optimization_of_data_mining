{
    "author": "sokra",
    "message": "[Turbopack] basic production chunking for CSS (#75049)\n\n### What?\n\nEnable a very simple chunking for CSS. It's just chunking by batches, which should cause correct styling, but it not optimal from request count.",
    "sha": "30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
    "files": [
        {
            "sha": "e6f5361a9f0e35f88af734114954a24b980f2e70",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -6,6 +6,7 @@ use turbo_tasks::{FxIndexMap, ResolvedVc, Value, Vc};\n use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n+    css::chunk::CssChunkType,\n     module_options::{\n         module_options_context::ModuleOptionsContext, CssOptionsContext, EcmascriptOptionsContext,\n         JsxTransformOptions, ModuleRule, TypeofWindow, TypescriptTransformOptions,\n@@ -26,6 +27,7 @@ use turbopack_core::{\n     free_var_references,\n     resolve::{parse::Request, pattern::Pattern},\n };\n+use turbopack_ecmascript::chunk::EcmascriptChunkType;\n use turbopack_node::{\n     execution_context::ExecutionContext,\n     transforms::postcss::{PostCssConfigLocation, PostCssTransformOptions},\n@@ -457,12 +459,22 @@ pub async fn get_client_chunking_context(\n     if next_mode.is_development() {\n         builder = builder.hot_module_replacement().use_file_source_map_uris();\n     } else {\n-        builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-            min_chunk_size: 50_000,\n-            max_chunk_count_per_group: 40,\n-            max_merge_chunk_size: 200_000,\n-            ..Default::default()\n-        })\n+        builder = builder.chunking_config(\n+            Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 50_000,\n+                max_chunk_count_per_group: 40,\n+                max_merge_chunk_size: 200_000,\n+                ..Default::default()\n+            },\n+        );\n+        builder = builder.chunking_config(\n+            Vc::<CssChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 0,\n+                ..Default::default()\n+            },\n+        );\n     }\n \n     Ok(Vc::upcast(builder.build()))"
        },
        {
            "sha": "b20ee3280b6a3860268bc665758bfd47f13a21f5",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 9,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -3,7 +3,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{FxIndexMap, ResolvedVc, Value, Vc};\n use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n-use turbopack::resolve_options_context::ResolveOptionsContext;\n+use turbopack::{css::chunk::CssChunkType, resolve_options_context::ResolveOptionsContext};\n use turbopack_browser::BrowserChunkingContext;\n use turbopack_core::{\n     chunk::{\n@@ -17,6 +17,7 @@ use turbopack_core::{\n     environment::{EdgeWorkerEnvironment, Environment, ExecutionEnvironment},\n     free_var_references,\n };\n+use turbopack_ecmascript::chunk::EcmascriptChunkType;\n use turbopack_node::execution_context::ExecutionContext;\n \n use crate::{\n@@ -245,10 +246,20 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     .module_id_strategy(module_id_strategy);\n \n     if !next_mode.is_development() {\n-        builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-            min_chunk_size: 20_000,\n-            ..Default::default()\n-        })\n+        builder = builder.chunking_config(\n+            Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 20_000,\n+                ..Default::default()\n+            },\n+        );\n+        builder = builder.chunking_config(\n+            Vc::<CssChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 0,\n+                ..Default::default()\n+            },\n+        );\n     }\n \n     Ok(Vc::upcast(builder.build()))\n@@ -298,10 +309,20 @@ pub async fn get_edge_chunking_context(\n     .module_id_strategy(module_id_strategy);\n \n     if !next_mode.is_development() {\n-        builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-            min_chunk_size: 20_000,\n-            ..Default::default()\n-        })\n+        builder = builder.chunking_config(\n+            Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 20_000,\n+                ..Default::default()\n+            },\n+        );\n+        builder = builder.chunking_config(\n+            Vc::<CssChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 0,\n+                ..Default::default()\n+            },\n+        );\n     }\n \n     Ok(Vc::upcast(builder.build()))"
        },
        {
            "sha": "95b9ec3940fd04c064587bd263479b3ebdf2dfdc",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 13,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -6,6 +6,7 @@ use turbo_tasks::{FxIndexMap, ResolvedVc, Value, Vc};\n use turbo_tasks_env::{EnvMap, ProcessEnv};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n+    css::chunk::CssChunkType,\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext,\n         ModuleRule, TypeofWindow, TypescriptTransformOptions,\n@@ -25,7 +26,7 @@ use turbopack_core::{\n     free_var_references,\n     target::CompileTarget,\n };\n-use turbopack_ecmascript::references::esm::UrlRewriteBehavior;\n+use turbopack_ecmascript::{chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior};\n use turbopack_ecmascript_plugins::transform::directives::{\n     client::ClientDirectiveTransformer, client_disallowed::ClientDisallowedDirectiveTransformer,\n };\n@@ -1028,12 +1029,22 @@ pub async fn get_server_chunking_context_with_client_assets(\n     if next_mode.is_development() {\n         builder = builder.use_file_source_map_uris();\n     } else {\n-        builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-            min_chunk_size: 20_000,\n-            max_chunk_count_per_group: 100,\n-            max_merge_chunk_size: 100_000,\n-            ..Default::default()\n-        })\n+        builder = builder.chunking_config(\n+            Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 20_000,\n+                max_chunk_count_per_group: 100,\n+                max_merge_chunk_size: 100_000,\n+                ..Default::default()\n+            },\n+        );\n+        builder = builder.chunking_config(\n+            Vc::<CssChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 0,\n+                ..Default::default()\n+            },\n+        );\n     }\n \n     Ok(builder.build())\n@@ -1083,12 +1094,22 @@ pub async fn get_server_chunking_context(\n     if next_mode.is_development() {\n         builder = builder.use_file_source_map_uris()\n     } else {\n-        builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-            min_chunk_size: 20_000,\n-            max_chunk_count_per_group: 100,\n-            max_merge_chunk_size: 100_000,\n-            ..Default::default()\n-        })\n+        builder = builder.chunking_config(\n+            Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 20_000,\n+                max_chunk_count_per_group: 100,\n+                max_merge_chunk_size: 100_000,\n+                ..Default::default()\n+            },\n+        );\n+        builder = builder.chunking_config(\n+            Vc::<CssChunkType>::default().to_resolved().await?,\n+            ChunkingConfig {\n+                min_chunk_size: 0,\n+                ..Default::default()\n+            },\n+        );\n     }\n \n     Ok(builder.build())"
        },
        {
            "sha": "0b2b6ed0c18bb59c8165eb18e8e3db41d83d18ab",
            "filename": "test/e2e/app-dir/app-css/index.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -191,7 +191,12 @@ describe('app dir - css', () => {\n       it('should include css imported in loading.js', async () => {\n         const $ = await next.render$('/loading-bug/hi')\n         // The link tag should be hoist into head with precedence properties\n-        expect($('head link[data-precedence]').length).toBe(2)\n+        const styles = $('head link[data-precedence]').length\n+        if (process.env.TURBOPACK && !isNextDev) {\n+          expect(styles).toBe(3)\n+        } else {\n+          expect(styles).toBe(2)\n+        }\n \n         expect($('body h2').text()).toBe('Loading...')\n       })\n@@ -303,13 +308,16 @@ describe('app dir - css', () => {\n       it('should bundle css resources into chunks', async () => {\n         const html = await next.render('/dashboard')\n \n-        expect(\n-          [\n-            ...html.matchAll(\n-              /<link rel=\"stylesheet\" href=\"[^<]+\\.css(\\?v=\\d+)?\"/g\n-            ),\n-          ].length\n-        ).toBe(3)\n+        const stylesheets = [\n+          ...html.matchAll(\n+            /<link rel=\"stylesheet\" href=\"[^<]+\\.css(\\?v=\\d+)?\"/g\n+          ),\n+        ].length\n+        if (process.env.TURBOPACK && !isNextDev) {\n+          expect(stylesheets).toBe(5)\n+        } else {\n+          expect(stylesheets).toBe(3)\n+        }\n       })\n     })\n "
        },
        {
            "sha": "f8a129a6ea94c55eacf5212b18b8122986ca588b",
            "filename": "test/e2e/app-dir/css-order/app/nav.tsx",
            "status": "modified",
            "additions": 55,
            "deletions": 23,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fnav.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fnav.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fnav.tsx?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -6,120 +6,152 @@ export default function Nav() {\n       <h3>App</h3>\n       <ul>\n         <li>\n-          <Link href={'/first'} id=\"first\">\n+          <Link href={'/first'} id=\"first\" prefetch={false}>\n             First\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/first-client'} id=\"first-client\">\n+          <Link href={'/first-client'} id=\"first-client\" prefetch={false}>\n             First client\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/second'} id=\"second\">\n+          <Link href={'/second'} id=\"second\" prefetch={false}>\n             Second\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/second-client'} id=\"second-client\">\n+          <Link href={'/second-client'} id=\"second-client\" prefetch={false}>\n             Second client\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/third'} id=\"third\">\n+          <Link href={'/third'} id=\"third\" prefetch={false}>\n             Third\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/interleaved/a'} id=\"interleaved-a\">\n+          <Link href={'/interleaved/a'} id=\"interleaved-a\" prefetch={false}>\n             Interleaved A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/interleaved/b'} id=\"interleaved-b\">\n+          <Link href={'/interleaved/b'} id=\"interleaved-b\" prefetch={false}>\n             Interleaved B\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/big-interleaved/a'} id=\"big-interleaved-a\">\n+          <Link\n+            href={'/big-interleaved/a'}\n+            id=\"big-interleaved-a\"\n+            prefetch={false}\n+          >\n             Big Interleaved A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/big-interleaved/b'} id=\"big-interleaved-b\">\n+          <Link\n+            href={'/big-interleaved/b'}\n+            id=\"big-interleaved-b\"\n+            prefetch={false}\n+          >\n             Big Interleaved B\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/reversed/a'} id=\"reversed-a\">\n+          <Link href={'/reversed/a'} id=\"reversed-a\" prefetch={false}>\n             Reversed A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/reversed/b'} id=\"reversed-b\">\n+          <Link href={'/reversed/b'} id=\"reversed-b\" prefetch={false}>\n             Reversed B\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/partial-reversed/a'} id=\"partial-reversed-a\">\n+          <Link\n+            href={'/partial-reversed/a'}\n+            id=\"partial-reversed-a\"\n+            prefetch={false}\n+          >\n             Partial Reversed A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/partial-reversed/b'} id=\"partial-reversed-b\">\n+          <Link\n+            href={'/partial-reversed/b'}\n+            id=\"partial-reversed-b\"\n+            prefetch={false}\n+          >\n             Partial Reversed B\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/global-first'} id=\"global-first\">\n+          <Link href={'/global-first'} id=\"global-first\" prefetch={false}>\n             Global First\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/global-second'} id=\"global-second\">\n+          <Link href={'/global-second'} id=\"global-second\" prefetch={false}>\n             Global Second\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/vendor'} id=\"vendor\">\n+          <Link href={'/vendor'} id=\"vendor\" prefetch={false}>\n             Vendor\n           </Link>\n         </li>\n       </ul>\n       <h3>Pages</h3>\n       <ul>\n         <li>\n-          <Link href={'/pages/first'} id=\"pages-first\">\n+          <Link href={'/pages/first'} id=\"pages-first\" prefetch={false}>\n             First\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/pages/second'} id=\"pages-second\">\n+          <Link href={'/pages/second'} id=\"pages-second\" prefetch={false}>\n             Second\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/pages/third'} id=\"pages-third\">\n+          <Link href={'/pages/third'} id=\"pages-third\" prefetch={false}>\n             Third\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/pages/interleaved/a'} id=\"pages-interleaved-a\">\n+          <Link\n+            href={'/pages/interleaved/a'}\n+            id=\"pages-interleaved-a\"\n+            prefetch={false}\n+          >\n             Interleaved A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/pages/interleaved/b'} id=\"pages-interleaved-b\">\n+          <Link\n+            href={'/pages/interleaved/b'}\n+            id=\"pages-interleaved-b\"\n+            prefetch={false}\n+          >\n             Interleaved B\n           </Link>\n         </li>{' '}\n         <li>\n-          <Link href={'/pages/reversed/a'} id=\"pages-reversed-a\">\n+          <Link\n+            href={'/pages/reversed/a'}\n+            id=\"pages-reversed-a\"\n+            prefetch={false}\n+          >\n             Reversed A\n           </Link>\n         </li>\n         <li>\n-          <Link href={'/pages/reversed/b'} id=\"pages-reversed-b\">\n+          <Link\n+            href={'/pages/reversed/b'}\n+            id=\"pages-reversed-b\"\n+            prefetch={false}\n+          >\n             Reversed B\n           </Link>\n         </li>"
        },
        {
            "sha": "5b1416df58824d0f374fd63c6ce70b39823336de",
            "filename": "test/e2e/app-dir/css-order/app/vendor/node_modules/my-dep2/index.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.js?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -0,0 +1,10 @@\n+import { jsx as _jsx } from 'react/jsx-runtime'\n+import styles from './index.module.css'\n+\n+export function MyContainer({ children, className, ...props }) {\n+  return /*#__PURE__*/ _jsx('dev', {\n+    ...props,\n+    className: `${styles.button_my_container} ${className ?? ''}`,\n+    children: children,\n+  })\n+}"
        },
        {
            "sha": "26f6ffe278a0d6579066c76061cda70a36c182ad",
            "filename": "test/e2e/app-dir/css-order/app/vendor/node_modules/my-dep2/index.module.css",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Findex.module.css?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -0,0 +1,3 @@\n+.button_my_container {\n+  color: rgb(255, 0, 0);\n+}"
        },
        {
            "sha": "fda58b1eba2154dfaaf60a03a98033028b2ef30f",
            "filename": "test/e2e/app-dir/css-order/app/vendor/node_modules/my-dep2/package.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fnode_modules%2Fmy-dep2%2Fpackage.json?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"name\": \"my-dep\",\n+  \"version\": \"1.0.0\"\n+}"
        },
        {
            "sha": "85785462fd93362376b660acee255d1f0ab9e9f7",
            "filename": "test/e2e/app-dir/css-order/app/vendor/page.module.css",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.module.css?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -1,3 +1,7 @@\n .my_button {\n+  color: inherit;\n+}\n+\n+.my_container {\n   color: rgb(0, 255, 0);\n }"
        },
        {
            "sha": "9281345d1e71c0cdd871cb0fe1e9121bcca656e2",
            "filename": "test/e2e/app-dir/css-order/app/vendor/page.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fvendor%2Fpage.tsx?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -1,13 +1,16 @@\n import { MyLink } from 'my-dep'\n+import { MyContainer } from 'my-dep2'\n import styles from './page.module.css'\n import Nav from '../nav'\n \n export default function Page() {\n   return (\n     <div>\n-      <MyLink className={styles.my_button} id=\"vendor1\">\n-        hello world\n-      </MyLink>\n+      <MyContainer className={styles.my_container}>\n+        <MyLink className={styles.my_button} id=\"vendor1\">\n+          hello world\n+        </MyLink>\n+      </MyContainer>\n       <Nav />\n     </div>\n   )"
        },
        {
            "sha": "7efa21561436300b99eed7f22b0e5b4b3d96ca68",
            "filename": "test/e2e/app-dir/css-order/css-order.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 24,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fcss-order.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fcss-order.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fcss-order.test.ts?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -62,12 +62,16 @@ const PAGES: Record<\n   },\n   'interleaved-a': {\n     group: 'interleaved',\n+    // TODO fix this case\n+    brokenLoadingTurbo: true,\n     url: '/interleaved/a',\n     selector: '#helloia',\n     color: 'rgb(0, 255, 0)',\n   },\n   'interleaved-b': {\n     group: 'interleaved',\n+    // TODO fix this case\n+    brokenLoadingTurbo: true,\n     url: '/interleaved/b',\n     selector: '#helloib',\n     color: 'rgb(255, 0, 255)',\n@@ -140,15 +144,13 @@ const PAGES: Record<\n   'pages-interleaved-a': {\n     group: 'pages-interleaved',\n     brokenLoadingDev: true,\n-    brokenLoadingTurbo: true,\n     url: '/pages/interleaved/a',\n     selector: '#helloia',\n     color: 'rgb(0, 255, 0)',\n   },\n   'pages-interleaved-b': {\n     group: 'pages-interleaved',\n     brokenLoadingDev: true,\n-    brokenLoadingTurbo: true,\n     url: '/pages/interleaved/b',\n     selector: '#helloib',\n     color: 'rgb(255, 0, 255)',\n@@ -240,8 +242,12 @@ describe.each(process.env.TURBOPACK ? ['turbo'] : ['strict', true])(\n         continue\n       }\n       // TODO fix this case\n-      const broken =\n+      let broken =\n         isNextDev || ordering.some((page) => PAGES[page].brokenLoading)\n+      if (mode === 'turbo') {\n+        // TODO fix this case\n+        broken ||= ordering.some((page) => PAGES[page].brokenLoadingTurbo)\n+      }\n       if (broken) {\n         it.todo(name)\n         continue\n@@ -288,28 +294,23 @@ describe.each(process.env.TURBOPACK ? ['turbo'] : ['strict', 'loose'])(\n       const name = `should load correct styles navigating ${ordering.join(\n         ' -> '\n       )}`\n-      if (mode !== 'turbo') {\n-        if (ordering.some((page) => PAGES[page].conflict)) {\n-          // Conflict scenarios won't support that case\n-          continue\n-        }\n-        // TODO fix this case\n-        const broken = ordering.some(\n-          (page) =>\n-            PAGES[page].brokenLoading ||\n-            (isNextDev && PAGES[page].brokenLoadingDev)\n-        )\n-        if (broken) {\n-          it.todo(name)\n-          continue\n-        }\n-      } else {\n+      if (ordering.some((page) => PAGES[page].conflict)) {\n+        // Conflict scenarios won't support that case\n+        continue\n+      }\n+      // TODO fix this case\n+      let broken = ordering.some(\n+        (page) =>\n+          PAGES[page].brokenLoading ||\n+          (isNextDev && PAGES[page].brokenLoadingDev)\n+      )\n+      if (mode === 'turbo') {\n         // TODO fix this case\n-        const broken = ordering.some((page) => PAGES[page].brokenLoadingTurbo)\n-        if (broken) {\n-          it.todo(name)\n-          continue\n-        }\n+        broken ||= ordering.some((page) => PAGES[page].brokenLoadingTurbo)\n+      }\n+      if (broken) {\n+        it.todo(name)\n+        continue\n       }\n       it(name, async () => {\n         const start = PAGES[ordering[0]]"
        },
        {
            "sha": "d9f8c5e37772aca8d5f2bb212b2a0c4875c5cdbc",
            "filename": "test/production/pages-dir/production/fixture/components/dynamic-css/shared-css-module/with-css-2.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css-2.js",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css-2.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css-2.js?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -3,6 +3,8 @@ import stylesShared from './with-css-shared.module.css'\n \n export default () => (\n   <div className={styles.content}>\n-    <p className={stylesShared.test}>With CSS</p>\n+    <p className={stylesShared.test} id=\"with-css-2\">\n+      With CSS\n+    </p>\n   </div>\n )"
        },
        {
            "sha": "06ded415903f16c9579d1152850fe79ab4ebada7",
            "filename": "test/production/pages-dir/production/fixture/components/dynamic-css/shared-css-module/with-css.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css.js",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ffixture%2Fcomponents%2Fdynamic-css%2Fshared-css-module%2Fwith-css.js?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -3,6 +3,8 @@ import stylesShared from './with-css-shared.module.css'\n \n export default () => (\n   <div className={styles.content}>\n-    <p className={stylesShared.test}>With CSS</p>\n+    <p className={stylesShared.test} id=\"with-css\">\n+      With CSS\n+    </p>\n   </div>\n )"
        },
        {
            "sha": "63edd45f6d05175ff0094a6fa15ca466aac951e5",
            "filename": "test/production/pages-dir/production/test/dynamic.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fdynamic.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fdynamic.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Fdynamic.ts?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -64,11 +64,23 @@ export default (next: NextInstance, render) => {\n         }\n       })\n \n-      // It seem to be abnormal, dynamic CSS modules are completely self-sufficient, so shared styles are copied across files\n-      it('should output two css files even in case of three css module files while one is shared across files', async () => {\n-        const $ = await get$('/dynamic/shared-css-module')\n-        const cssFiles = $('link[rel=stylesheet]')\n-        expect(cssFiles.length).toBe(2)\n+      it('should output correct css even in case of three css module files while one is shared across files', async () => {\n+        let browser\n+        try {\n+          browser = await webdriver(next.appPort, '/dynamic/shared-css-module')\n+          await check(\n+            () => browser.elementByCss('#with-css').getComputedCss('color'),\n+            'rgb(0, 0, 0)'\n+          )\n+          await check(\n+            () => browser.elementByCss('#with-css-2').getComputedCss('color'),\n+            'rgb(0, 0, 0)'\n+          )\n+        } finally {\n+          if (browser) {\n+            await browser.close()\n+          }\n+        }\n       })\n \n       it('should render one dynamically imported component without any css files', async () => {"
        },
        {
            "sha": "4e1c5be7ea76493327614651328185a6ea58a59d",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 60,
            "deletions": 60,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -1543,113 +1543,113 @@\n   },\n   \"test/e2e/app-dir/css-order/css-order.test.ts\": {\n     \"passed\": [\n-      \"css-order turbo should load correct styles navigating back again interleaved-a -> interleaved-b -> interleaved-a -> interleaved-b\",\n+      \"css-order turbo should load correct styles navigating back again first -> first-client -> first -> first-client\",\n+      \"css-order turbo should load correct styles navigating back again first -> second -> first -> second\",\n+      \"css-order turbo should load correct styles navigating back again first -> second-client -> first -> second-client\",\n+      \"css-order turbo should load correct styles navigating back again first -> third -> first -> third\",\n+      \"css-order turbo should load correct styles navigating back again first-client -> first -> first-client -> first\",\n+      \"css-order turbo should load correct styles navigating back again first-client -> second -> first-client -> second\",\n+      \"css-order turbo should load correct styles navigating back again first-client -> second-client -> first-client -> second-client\",\n+      \"css-order turbo should load correct styles navigating back again first-client -> third -> first-client -> third\",\n+      \"css-order turbo should load correct styles navigating back again pages-first -> pages-second -> pages-first -> pages-second\",\n+      \"css-order turbo should load correct styles navigating back again pages-first -> pages-third -> pages-first -> pages-third\",\n       \"css-order turbo should load correct styles navigating back again pages-interleaved-a -> pages-interleaved-b -> pages-interleaved-a -> pages-interleaved-b\",\n-      \"css-order turbo should load correct styles navigating big-interleaved-a -> big-interleaved-b\",\n-      \"css-order turbo should load correct styles navigating big-interleaved-b -> big-interleaved-a\",\n+      \"css-order turbo should load correct styles navigating back again pages-second -> pages-first -> pages-second -> pages-first\",\n+      \"css-order turbo should load correct styles navigating back again pages-second -> pages-third -> pages-second -> pages-third\",\n+      \"css-order turbo should load correct styles navigating back again pages-third -> pages-first -> pages-third -> pages-first\",\n+      \"css-order turbo should load correct styles navigating back again pages-third -> pages-second -> pages-third -> pages-second\",\n+      \"css-order turbo should load correct styles navigating back again second -> first -> second -> first\",\n+      \"css-order turbo should load correct styles navigating back again second -> first-client -> second -> first-client\",\n+      \"css-order turbo should load correct styles navigating back again second -> second-client -> second -> second-client\",\n+      \"css-order turbo should load correct styles navigating back again second -> third -> second -> third\",\n+      \"css-order turbo should load correct styles navigating back again second-client -> first -> second-client -> first\",\n+      \"css-order turbo should load correct styles navigating back again second-client -> first-client -> second-client -> first-client\",\n+      \"css-order turbo should load correct styles navigating back again second-client -> second -> second-client -> second\",\n+      \"css-order turbo should load correct styles navigating back again second-client -> third -> second-client -> third\",\n+      \"css-order turbo should load correct styles navigating back again third -> first -> third -> first\",\n+      \"css-order turbo should load correct styles navigating back again third -> first-client -> third -> first-client\",\n+      \"css-order turbo should load correct styles navigating back again third -> second -> third -> second\",\n+      \"css-order turbo should load correct styles navigating back again third -> second-client -> third -> second-client\",\n       \"css-order turbo should load correct styles navigating first -> first-client\",\n-      \"css-order turbo should load correct styles navigating first -> second\",\n       \"css-order turbo should load correct styles navigating first -> second-client\",\n+      \"css-order turbo should load correct styles navigating first -> second\",\n       \"css-order turbo should load correct styles navigating first -> third\",\n       \"css-order turbo should load correct styles navigating first-client -> first\",\n-      \"css-order turbo should load correct styles navigating first-client -> second\",\n       \"css-order turbo should load correct styles navigating first-client -> second-client\",\n+      \"css-order turbo should load correct styles navigating first-client -> second\",\n       \"css-order turbo should load correct styles navigating first-client -> third\",\n       \"css-order turbo should load correct styles navigating global-first -> global-second\",\n       \"css-order turbo should load correct styles navigating global-second -> global-first\",\n-      \"css-order turbo should load correct styles navigating interleaved-a -> interleaved-b\",\n-      \"css-order turbo should load correct styles navigating interleaved-b -> interleaved-a\",\n+      \"css-order turbo should load correct styles navigating pages-first -> pages-second\",\n+      \"css-order turbo should load correct styles navigating pages-first -> pages-third\",\n+      \"css-order turbo should load correct styles navigating pages-interleaved-a -> pages-interleaved-b\",\n+      \"css-order turbo should load correct styles navigating pages-second -> pages-first\",\n+      \"css-order turbo should load correct styles navigating pages-second -> pages-third\",\n+      \"css-order turbo should load correct styles navigating pages-third -> pages-first\",\n+      \"css-order turbo should load correct styles navigating pages-third -> pages-second\",\n       \"css-order turbo should load correct styles navigating partial-reversed-a -> partial-reversed-b\",\n       \"css-order turbo should load correct styles navigating partial-reversed-b -> partial-reversed-a\",\n       \"css-order turbo should load correct styles navigating reversed-a -> reversed-b\",\n       \"css-order turbo should load correct styles navigating reversed-b -> reversed-a\",\n-      \"css-order turbo should load correct styles navigating second -> first\",\n       \"css-order turbo should load correct styles navigating second -> first-client\",\n+      \"css-order turbo should load correct styles navigating second -> first\",\n       \"css-order turbo should load correct styles navigating second -> second-client\",\n       \"css-order turbo should load correct styles navigating second -> third\",\n-      \"css-order turbo should load correct styles navigating second-client -> first\",\n       \"css-order turbo should load correct styles navigating second-client -> first-client\",\n+      \"css-order turbo should load correct styles navigating second-client -> first\",\n       \"css-order turbo should load correct styles navigating second-client -> second\",\n       \"css-order turbo should load correct styles navigating second-client -> third\",\n-      \"css-order turbo should load correct styles navigating third -> first\",\n       \"css-order turbo should load correct styles navigating third -> first-client\",\n-      \"css-order turbo should load correct styles navigating third -> second\",\n+      \"css-order turbo should load correct styles navigating third -> first\",\n       \"css-order turbo should load correct styles navigating third -> second-client\",\n+      \"css-order turbo should load correct styles navigating third -> second\",\n       \"css-order turbo should load correct styles on big-interleaved-a\",\n       \"css-order turbo should load correct styles on big-interleaved-b\",\n-      \"css-order turbo should load correct styles on first\",\n       \"css-order turbo should load correct styles on first-client\",\n+      \"css-order turbo should load correct styles on first\",\n       \"css-order turbo should load correct styles on global-first\",\n       \"css-order turbo should load correct styles on global-second\",\n       \"css-order turbo should load correct styles on interleaved-a\",\n       \"css-order turbo should load correct styles on interleaved-b\",\n+      \"css-order turbo should load correct styles on pages-first\",\n       \"css-order turbo should load correct styles on pages-interleaved-a\",\n+      \"css-order turbo should load correct styles on pages-interleaved-b\",\n+      \"css-order turbo should load correct styles on pages-partial-reversed-a\",\n+      \"css-order turbo should load correct styles on pages-partial-reversed-b\",\n+      \"css-order turbo should load correct styles on pages-reversed-a\",\n+      \"css-order turbo should load correct styles on pages-reversed-b\",\n+      \"css-order turbo should load correct styles on pages-second\",\n+      \"css-order turbo should load correct styles on pages-third\",\n       \"css-order turbo should load correct styles on partial-reversed-a\",\n       \"css-order turbo should load correct styles on partial-reversed-b\",\n       \"css-order turbo should load correct styles on reversed-a\",\n       \"css-order turbo should load correct styles on reversed-b\",\n-      \"css-order turbo should load correct styles on second\",\n       \"css-order turbo should load correct styles on second-client\",\n+      \"css-order turbo should load correct styles on second\",\n       \"css-order turbo should load correct styles on third\",\n       \"css-order turbo should load correct styles on vendor\"\n     ],\n     \"failed\": [\n-      \"css-order turbo should load correct styles navigating back again first -> first-client -> first -> first-client\",\n-      \"css-order turbo should load correct styles navigating back again first -> second -> first -> second\",\n-      \"css-order turbo should load correct styles navigating back again first -> second-client -> first -> second-client\",\n-      \"css-order turbo should load correct styles navigating back again first -> third -> first -> third\",\n-      \"css-order turbo should load correct styles navigating back again first-client -> first -> first-client -> first\",\n-      \"css-order turbo should load correct styles navigating back again first-client -> second -> first-client -> second\",\n-      \"css-order turbo should load correct styles navigating back again first-client -> second-client -> first-client -> second-client\",\n-      \"css-order turbo should load correct styles navigating back again first-client -> third -> first-client -> third\",\n-      \"css-order turbo should load correct styles navigating back again interleaved-b -> interleaved-a -> interleaved-b -> interleaved-a\",\n-      \"css-order turbo should load correct styles navigating back again pages-first -> pages-second -> pages-first -> pages-second\",\n-      \"css-order turbo should load correct styles navigating back again pages-first -> pages-third -> pages-first -> pages-third\",\n       \"css-order turbo should load correct styles navigating back again pages-interleaved-b -> pages-interleaved-a -> pages-interleaved-b -> pages-interleaved-a\",\n-      \"css-order turbo should load correct styles navigating back again pages-partial-reversed-a -> pages-partial-reversed-b -> pages-partial-reversed-a -> pages-partial-reversed-b\",\n-      \"css-order turbo should load correct styles navigating back again pages-partial-reversed-b -> pages-partial-reversed-a -> pages-partial-reversed-b -> pages-partial-reversed-a\",\n       \"css-order turbo should load correct styles navigating back again pages-reversed-a -> pages-reversed-b -> pages-reversed-a -> pages-reversed-b\",\n       \"css-order turbo should load correct styles navigating back again pages-reversed-b -> pages-reversed-a -> pages-reversed-b -> pages-reversed-a\",\n-      \"css-order turbo should load correct styles navigating back again pages-second -> pages-first -> pages-second -> pages-first\",\n-      \"css-order turbo should load correct styles navigating back again pages-second -> pages-third -> pages-second -> pages-third\",\n-      \"css-order turbo should load correct styles navigating back again pages-third -> pages-first -> pages-third -> pages-first\",\n-      \"css-order turbo should load correct styles navigating back again pages-third -> pages-second -> pages-third -> pages-second\",\n-      \"css-order turbo should load correct styles navigating back again second -> first -> second -> first\",\n-      \"css-order turbo should load correct styles navigating back again second -> first-client -> second -> first-client\",\n-      \"css-order turbo should load correct styles navigating back again second -> second-client -> second -> second-client\",\n-      \"css-order turbo should load correct styles navigating back again second -> third -> second -> third\",\n-      \"css-order turbo should load correct styles navigating back again second-client -> first -> second-client -> first\",\n-      \"css-order turbo should load correct styles navigating back again second-client -> first-client -> second-client -> first-client\",\n-      \"css-order turbo should load correct styles navigating back again second-client -> second -> second-client -> second\",\n-      \"css-order turbo should load correct styles navigating back again second-client -> third -> second-client -> third\",\n-      \"css-order turbo should load correct styles navigating back again third -> first -> third -> first\",\n-      \"css-order turbo should load correct styles navigating back again third -> first-client -> third -> first-client\",\n-      \"css-order turbo should load correct styles navigating back again third -> second -> third -> second\",\n-      \"css-order turbo should load correct styles navigating back again third -> second-client -> third -> second-client\",\n-      \"css-order turbo should load correct styles navigating pages-first -> pages-second\",\n-      \"css-order turbo should load correct styles navigating pages-first -> pages-third\",\n-      \"css-order turbo should load correct styles navigating pages-partial-reversed-a -> pages-partial-reversed-b\",\n-      \"css-order turbo should load correct styles navigating pages-partial-reversed-b -> pages-partial-reversed-a\",\n+      \"css-order turbo should load correct styles navigating back again pages-partial-reversed-a -> pages-partial-reversed-b -> pages-partial-reversed-a -> pages-partial-reversed-b\",\n+      \"css-order turbo should load correct styles navigating back again pages-partial-reversed-b -> pages-partial-reversed-a -> pages-partial-reversed-b -> pages-partial-reversed-a\",\n+      \"css-order turbo should load correct styles navigating pages-interleaved-b -> pages-interleaved-a\",\n       \"css-order turbo should load correct styles navigating pages-reversed-a -> pages-reversed-b\",\n       \"css-order turbo should load correct styles navigating pages-reversed-b -> pages-reversed-a\",\n-      \"css-order turbo should load correct styles navigating pages-second -> pages-first\",\n-      \"css-order turbo should load correct styles navigating pages-second -> pages-third\",\n-      \"css-order turbo should load correct styles navigating pages-third -> pages-first\",\n-      \"css-order turbo should load correct styles navigating pages-third -> pages-second\",\n-      \"css-order turbo should load correct styles on pages-first\",\n-      \"css-order turbo should load correct styles on pages-interleaved-b\",\n-      \"css-order turbo should load correct styles on pages-partial-reversed-a\",\n-      \"css-order turbo should load correct styles on pages-partial-reversed-b\",\n-      \"css-order turbo should load correct styles on pages-reversed-a\",\n-      \"css-order turbo should load correct styles on pages-reversed-b\",\n-      \"css-order turbo should load correct styles on pages-second\",\n-      \"css-order turbo should load correct styles on pages-third\"\n+      \"css-order turbo should load correct styles navigating pages-partial-reversed-a -> pages-partial-reversed-b\",\n+      \"css-order turbo should load correct styles navigating pages-partial-reversed-b -> pages-partial-reversed-a\"\n     ],\n     \"pending\": [\n       \"css-order turbo should load correct styles navigating back again big-interleaved-a -> big-interleaved-b -> big-interleaved-a -> big-interleaved-b\",\n       \"css-order turbo should load correct styles navigating back again big-interleaved-b -> big-interleaved-a -> big-interleaved-b -> big-interleaved-a\",\n-      \"css-order turbo should load correct styles navigating pages-interleaved-a -> pages-interleaved-b\",\n-      \"css-order turbo should load correct styles navigating pages-interleaved-b -> pages-interleaved-a\"\n+      \"css-order turbo should load correct styles navigating back again interleaved-a -> interleaved-b -> interleaved-a -> interleaved-b\",\n+      \"css-order turbo should load correct styles navigating back again interleaved-b -> interleaved-a -> interleaved-b -> interleaved-a\",\n+      \"css-order turbo should load correct styles navigating big-interleaved-a -> big-interleaved-b\",\n+      \"css-order turbo should load correct styles navigating big-interleaved-b -> big-interleaved-a\",\n+      \"css-order turbo should load correct styles navigating interleaved-a -> interleaved-b\",\n+      \"css-order turbo should load correct styles navigating interleaved-b -> interleaved-a\"\n     ],\n     \"flakey\": [],\n     \"runtimeError\": false"
        },
        {
            "sha": "eded7559e69e83abd6542ec87bea316467c290cd",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -1,17 +1,16 @@\n use anyhow::{bail, Context, Result};\n-use rustc_hash::FxHashMap;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, Value, ValueToString, Vc};\n+use turbo_tasks::{ResolvedVc, TryJoinIterExt, Upcast, Value, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     chunk::{\n         availability_info::AvailabilityInfo,\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n         module_id_strategies::{DevModuleIdStrategy, ModuleIdStrategy},\n-        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkingConfig, ChunkingConfigs,\n-        ChunkingContext, EntryChunkGroupResult, EvaluatableAsset, EvaluatableAssets, MinifyType,\n-        ModuleId, SourceMapsType,\n+        Chunk, ChunkGroupResult, ChunkItem, ChunkType, ChunkableModule, ChunkingConfig,\n+        ChunkingConfigs, ChunkingContext, EntryChunkGroupResult, EvaluatableAsset,\n+        EvaluatableAssets, MinifyType, ModuleId, SourceMapsType,\n     },\n     environment::Environment,\n     ident::AssetIdent,\n@@ -21,7 +20,7 @@ use turbopack_core::{\n };\n use turbopack_ecmascript::{\n     async_chunk::module::AsyncLoaderModule,\n-    chunk::{EcmascriptChunk, EcmascriptChunkType},\n+    chunk::EcmascriptChunk,\n     manifest::{chunk_asset::ManifestAsyncModule, loader_item::ManifestLoaderChunkItem},\n };\n use turbopack_ecmascript_runtime::RuntimeType;\n@@ -100,11 +99,13 @@ impl BrowserChunkingContextBuilder {\n         self\n     }\n \n-    pub fn ecmascript_chunking_config(\n-        mut self,\n-        ecmascript_chunking_config: ChunkingConfig,\n-    ) -> Self {\n-        self.chunking_context.ecmascript_chunking_config = Some(ecmascript_chunking_config);\n+    pub fn chunking_config<T>(mut self, ty: ResolvedVc<T>, chunking_config: ChunkingConfig) -> Self\n+    where\n+        T: Upcast<Box<dyn ChunkType>>,\n+    {\n+        self.chunking_context\n+            .chunking_configs\n+            .push((ResolvedVc::upcast(ty), chunking_config));\n         self\n     }\n \n@@ -162,8 +163,8 @@ pub struct BrowserChunkingContext {\n     manifest_chunks: bool,\n     /// The module id strategy to use\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n-    /// The chunking config for ecmascript\n-    ecmascript_chunking_config: Option<ChunkingConfig>,\n+    /// The chunking configs\n+    chunking_configs: Vec<(ResolvedVc<Box<dyn ChunkType>>, ChunkingConfig)>,\n }\n \n impl BrowserChunkingContext {\n@@ -198,7 +199,7 @@ impl BrowserChunkingContext {\n                 source_maps_type: SourceMapsType::Full,\n                 manifest_chunks: false,\n                 module_id_strategy: ResolvedVc::upcast(DevModuleIdStrategy::new_resolved()),\n-                ecmascript_chunking_config: None,\n+                chunking_configs: Default::default(),\n             },\n         }\n     }\n@@ -408,14 +409,7 @@ impl ChunkingContext for BrowserChunkingContext {\n \n     #[turbo_tasks::function]\n     async fn chunking_configs(&self) -> Result<Vc<ChunkingConfigs>> {\n-        let mut map = FxHashMap::default();\n-        if let Some(ecmascript) = &self.ecmascript_chunking_config {\n-            map.insert(\n-                ResolvedVc::upcast(Vc::<EcmascriptChunkType>::default().to_resolved().await?),\n-                ecmascript.clone(),\n-            );\n-        }\n-        Ok(Vc::cell(map))\n+        Ok(Vc::cell(self.chunking_configs.iter().cloned().collect()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "89660156f867d4d56ac99ad5116e540bb6d63302",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 36,
            "deletions": 13,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -17,7 +17,10 @@ use turbo_tasks_backend::{\n     noop_backing_storage, BackendOptions, NoopBackingStorage, TurboTasksBackend,\n };\n use turbo_tasks_fs::FileSystem;\n-use turbopack::global_module_ids::get_global_module_id_strategy;\n+use turbopack::{\n+    css::chunk::CssChunkType, ecmascript::chunk::EcmascriptChunkType,\n+    global_module_ids::get_global_module_id_strategy,\n+};\n use turbopack_browser::BrowserChunkingContext;\n use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n use turbopack_core::{\n@@ -335,12 +338,22 @@ async fn build_internal(\n             match *node_env.await? {\n                 NodeEnv::Development => {}\n                 NodeEnv::Production => {\n-                    builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-                        min_chunk_size: 50_000,\n-                        max_chunk_count_per_group: 40,\n-                        max_merge_chunk_size: 200_000,\n-                        ..Default::default()\n-                    })\n+                    builder = builder.chunking_config(\n+                        Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+                        ChunkingConfig {\n+                            min_chunk_size: 50_000,\n+                            max_chunk_count_per_group: 40,\n+                            max_merge_chunk_size: 200_000,\n+                            ..Default::default()\n+                        },\n+                    );\n+                    builder = builder.chunking_config(\n+                        Vc::<CssChunkType>::default().to_resolved().await?,\n+                        ChunkingConfig {\n+                            min_chunk_size: 0,\n+                            ..Default::default()\n+                        },\n+                    );\n                 }\n             }\n \n@@ -368,12 +381,22 @@ async fn build_internal(\n             match *node_env.await? {\n                 NodeEnv::Development => {}\n                 NodeEnv::Production => {\n-                    builder = builder.ecmascript_chunking_config(ChunkingConfig {\n-                        min_chunk_size: 20_000,\n-                        max_chunk_count_per_group: 100,\n-                        max_merge_chunk_size: 100_000,\n-                        ..Default::default()\n-                    })\n+                    builder = builder.chunking_config(\n+                        Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+                        ChunkingConfig {\n+                            min_chunk_size: 20_000,\n+                            max_chunk_count_per_group: 100,\n+                            max_merge_chunk_size: 100_000,\n+                            ..Default::default()\n+                        },\n+                    );\n+                    builder = builder.chunking_config(\n+                        Vc::<CssChunkType>::default().to_resolved().await?,\n+                        ChunkingConfig {\n+                            min_chunk_size: 0,\n+                            ..Default::default()\n+                        },\n+                    );\n                 }\n             }\n "
        },
        {
            "sha": "0b11641e0004ff486c8a0fe2b5646bf18d0803ff",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/mod.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fmod.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -21,6 +21,7 @@ use crate::{\n         },\n         chunking::{\n             dev::{app_vendors_split, expand_batches},\n+            ordered_production::make_production_chunks_keeping_order,\n             production::make_production_chunks,\n         },\n     },\n@@ -29,6 +30,7 @@ use crate::{\n };\n \n mod dev;\n+mod ordered_production;\n mod production;\n \n #[turbo_tasks::value]\n@@ -334,14 +336,25 @@ pub async fn make_chunks(\n \n             if let Some(chunking_config) = chunking_configs.get(&ty) {\n                 // Production chunking\n-                make_production_chunks(\n-                    chunk_items,\n-                    batch_groups.into_iter().collect(),\n-                    module_graph,\n-                    chunking_config,\n-                    split_context,\n-                )\n-                .await?;\n+                if !*ty.must_keep_item_order().await? {\n+                    make_production_chunks(\n+                        chunk_items,\n+                        batch_groups.into_iter().collect(),\n+                        module_graph,\n+                        chunking_config,\n+                        split_context,\n+                    )\n+                    .await?;\n+                } else {\n+                    make_production_chunks_keeping_order(\n+                        chunk_items,\n+                        batch_groups.into_iter().collect(),\n+                        module_graph,\n+                        chunking_config,\n+                        split_context,\n+                    )\n+                    .await?;\n+                }\n             } else {\n                 // Development chunking\n                 if !*ty.must_keep_item_order().await? {"
        },
        {
            "sha": "ff0000600deaa3206e60349c28f7064cbcc99f88",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/ordered_production.rs",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fordered_production.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fordered_production.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fordered_production.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -0,0 +1,39 @@\n+use anyhow::Result;\n+use tracing::Instrument;\n+use turbo_tasks::{ResolvedVc, Vc};\n+\n+use crate::{\n+    chunk::{\n+        chunking::{make_chunk, ChunkItemOrBatchWithInfo, SplitContext},\n+        ChunkItemBatchGroup, ChunkingConfig,\n+    },\n+    module_graph::ModuleGraph,\n+};\n+\n+pub async fn make_production_chunks_keeping_order(\n+    chunk_items: Vec<&ChunkItemOrBatchWithInfo>,\n+    _batch_groups: Vec<ResolvedVc<ChunkItemBatchGroup>>,\n+    _module_graph: Vc<ModuleGraph>,\n+    _chunking_config: &ChunkingConfig,\n+    mut split_context: SplitContext<'_>,\n+) -> Result<()> {\n+    let span_outer = tracing::info_span!(\n+        \"make production chunks keeping order\",\n+        chunk_items = chunk_items.len(),\n+    );\n+    async move {\n+        for chunk_item in chunk_items {\n+            make_chunk(\n+                vec![chunk_item],\n+                vec![],\n+                &mut String::new(),\n+                &mut split_context,\n+            )\n+            .await?;\n+        }\n+\n+        Ok(())\n+    }\n+    .instrument(span_outer)\n+    .await\n+}"
        },
        {
            "sha": "b6305c13704430091e9d0fc20558bfc95aa6bdf7",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -1,17 +1,16 @@\n use anyhow::{bail, Context, Result};\n-use rustc_hash::FxHashMap;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, Value, ValueToString, Vc};\n+use turbo_tasks::{ResolvedVc, TryJoinIterExt, Upcast, Value, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     chunk::{\n         availability_info::AvailabilityInfo,\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n         module_id_strategies::{DevModuleIdStrategy, ModuleIdStrategy},\n-        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkingConfig, ChunkingConfigs,\n-        ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType, ModuleId,\n-        SourceMapsType,\n+        Chunk, ChunkGroupResult, ChunkItem, ChunkType, ChunkableModule, ChunkingConfig,\n+        ChunkingConfigs, ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType,\n+        ModuleId, SourceMapsType,\n     },\n     environment::Environment,\n     ident::AssetIdent,\n@@ -21,7 +20,7 @@ use turbopack_core::{\n };\n use turbopack_ecmascript::{\n     async_chunk::module::AsyncLoaderModule,\n-    chunk::{EcmascriptChunk, EcmascriptChunkType},\n+    chunk::EcmascriptChunk,\n     manifest::{chunk_asset::ManifestAsyncModule, loader_item::ManifestLoaderChunkItem},\n };\n use turbopack_ecmascript_runtime::RuntimeType;\n@@ -79,11 +78,13 @@ impl NodeJsChunkingContextBuilder {\n         self\n     }\n \n-    pub fn ecmascript_chunking_config(\n-        mut self,\n-        ecmascript_chunking_config: ChunkingConfig,\n-    ) -> Self {\n-        self.chunking_context.ecmascript_chunking_config = Some(ecmascript_chunking_config);\n+    pub fn chunking_config<T>(mut self, ty: ResolvedVc<T>, chunking_config: ChunkingConfig) -> Self\n+    where\n+        T: Upcast<Box<dyn ChunkType>>,\n+    {\n+        self.chunking_context\n+            .chunking_configs\n+            .push((ResolvedVc::upcast(ty), chunking_config));\n         self\n     }\n \n@@ -127,8 +128,8 @@ pub struct NodeJsChunkingContext {\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n     /// Whether to use file:// uris for source map sources\n     should_use_file_source_map_uris: bool,\n-    /// The chunking config for ecmascript\n-    ecmascript_chunking_config: Option<ChunkingConfig>,\n+    /// The chunking configs\n+    chunking_configs: Vec<(ResolvedVc<Box<dyn ChunkType>>, ChunkingConfig)>,\n }\n \n impl NodeJsChunkingContext {\n@@ -160,7 +161,7 @@ impl NodeJsChunkingContext {\n                 manifest_chunks: false,\n                 should_use_file_source_map_uris: false,\n                 module_id_strategy: ResolvedVc::upcast(DevModuleIdStrategy::new_resolved()),\n-                ecmascript_chunking_config: None,\n+                chunking_configs: Default::default(),\n             },\n         }\n     }\n@@ -304,14 +305,7 @@ impl ChunkingContext for NodeJsChunkingContext {\n \n     #[turbo_tasks::function]\n     async fn chunking_configs(&self) -> Result<Vc<ChunkingConfigs>> {\n-        let mut map = FxHashMap::default();\n-        if let Some(ecmascript) = &self.ecmascript_chunking_config {\n-            map.insert(\n-                ResolvedVc::upcast(Vc::<EcmascriptChunkType>::default().to_resolved().await?),\n-                ecmascript.clone(),\n-            );\n-        }\n-        Ok(Vc::cell(map))\n+        Ok(Vc::cell(self.chunking_configs.iter().cloned().collect()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "0d3535d2a658709b3bec5c118243429261f99930",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/30eed9f9e224f71ae8108ad2def2d35bcd75e0ef/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=30eed9f9e224f71ae8108ad2def2d35bcd75e0ef",
            "patch": "@@ -24,7 +24,8 @@ use turbo_tasks_fs::{\n     FileSystem, FileSystemEntryType, FileSystemPath,\n };\n use turbopack::{\n-    ecmascript::TreeShakingMode,\n+    css::chunk::CssChunkType,\n+    ecmascript::{chunk::EcmascriptChunkType, TreeShakingMode},\n     module_options::{EcmascriptOptionsContext, ModuleOptionsContext, TypescriptTransformOptions},\n     ModuleAssetContext,\n };\n@@ -416,10 +417,20 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         env,\n         RuntimeType::Development,\n     )\n-    .ecmascript_chunking_config(ChunkingConfig {\n-        min_chunk_size: 10_000,\n-        ..Default::default()\n-    })\n+    .chunking_config(\n+        Vc::<EcmascriptChunkType>::default().to_resolved().await?,\n+        ChunkingConfig {\n+            min_chunk_size: 10_000,\n+            ..Default::default()\n+        },\n+    )\n+    .chunking_config(\n+        Vc::<CssChunkType>::default().to_resolved().await?,\n+        ChunkingConfig {\n+            min_chunk_size: 0,\n+            ..Default::default()\n+        },\n+    )\n     .build();\n \n     let jest_entry_source = FileSource::new(jest_entry_path);"
        }
    ],
    "stats": {
        "total": 655,
        "additions": 432,
        "deletions": 223
    }
}