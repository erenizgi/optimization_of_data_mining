{
    "author": "mischnic",
    "message": "Turbopack: don't include client-fs assets in NFT (#77799)\n\ni.e. don't include logos imported in a client reference in the NFT list of the parent RSC's serverless function\n\nCloses PACK-4257",
    "sha": "689038b3caf63cdbeb1ab0783d8d05a4d9272bc9",
    "files": [
        {
            "sha": "972612f5329cb349a1bbf57264109c3a09f498a0",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 20,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/689038b3caf63cdbeb1ab0783d8d05a4d9272bc9/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/689038b3caf63cdbeb1ab0783d8d05a4d9272bc9/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=689038b3caf63cdbeb1ab0783d8d05a4d9272bc9",
            "patch": "@@ -75,31 +75,27 @@ fn get_output_specifier(\n     path_ref: &FileSystemPath,\n     ident_folder: &FileSystemPath,\n     ident_folder_in_project_fs: &FileSystemPath,\n-    ident_folder_in_client_fs: &FileSystemPath,\n     output_root: &FileSystemPath,\n     project_root: &FileSystemPath,\n     client_root: &FileSystemPath,\n-    dist_dir: &RcStr,\n-) -> Result<RcStr> {\n+) -> Result<Option<RcStr>> {\n     // include assets in the outputs such as referenced chunks\n     if path_ref.is_inside_ref(output_root) {\n-        return Ok(ident_folder.get_relative_path_to(path_ref).unwrap());\n+        return Ok(Some(ident_folder.get_relative_path_to(path_ref).unwrap()));\n     }\n \n     // include assets in the project root such as images and traced references (externals)\n     if path_ref.is_inside_ref(project_root) {\n-        return Ok(ident_folder_in_project_fs\n-            .get_relative_path_to(path_ref)\n-            .unwrap());\n+        return Ok(Some(\n+            ident_folder_in_project_fs\n+                .get_relative_path_to(path_ref)\n+                .unwrap(),\n+        ));\n     }\n \n-    // assets that are needed on the client side such as fonts and icons\n     if path_ref.is_inside_ref(client_root) {\n-        return Ok(ident_folder_in_client_fs\n-            .get_relative_path_to(path_ref)\n-            .unwrap()\n-            .replace(\"/_next/\", dist_dir)\n-            .into());\n+        // Client assets are never needed on the server, they are served via a CDN\n+        return Ok(None);\n     }\n \n     // Make this an error for now, this should effectively be unreachable\n@@ -111,21 +107,19 @@ impl Asset for NftJsonAsset {\n     #[turbo_tasks::function]\n     async fn content(self: Vc<Self>) -> Result<Vc<AssetContent>> {\n         let this = &*self.await?;\n-        let mut result = BTreeSet::new();\n+        let mut result: BTreeSet<RcStr> = BTreeSet::new();\n \n         let output_root_ref = this.project.output_fs().root().await?;\n         let project_root_ref = this.project.project_fs().root().await?;\n         let client_root = this.project.client_fs().root();\n         let client_root_ref = client_root.await?;\n-        let dist_dir = self.dist_dir().await?;\n \n         let ident_folder = self.path().parent().await?;\n         let ident_folder_in_project_fs = this\n             .project\n             .project_path()\n             .join(ident_folder.path.clone())\n             .await?;\n-        let ident_folder_in_client_fs = client_root.join(ident_folder.path.clone()).await?;\n \n         let chunk = this.chunk;\n         let entries = this\n@@ -144,16 +138,17 @@ impl Asset for NftJsonAsset {\n                 continue;\n             }\n \n-            let specifier = get_output_specifier(\n+            let Some(specifier) = get_output_specifier(\n                 &referenced_chunk_path,\n                 &ident_folder,\n                 &ident_folder_in_project_fs,\n-                &ident_folder_in_client_fs,\n                 &output_root_ref,\n                 &project_root_ref,\n                 &client_root_ref,\n-                &dist_dir,\n-            )?;\n+            )?\n+            else {\n+                continue;\n+            };\n             result.insert(specifier);\n         }\n "
        }
    ],
    "stats": {
        "total": 35,
        "additions": 15,
        "deletions": 20
    }
}