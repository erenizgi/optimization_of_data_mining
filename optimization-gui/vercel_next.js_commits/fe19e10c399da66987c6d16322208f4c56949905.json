{
    "author": "timneutkens",
    "message": "Turbopack: Don't resolve tsconfig relative to file (#83484)\n\n## What?\n\nChanges in #83331 accidentally changed behavior of how `tsconfig.json`\nis resolved. When using Next.js we don't want it to be resolved relative\nto the current file being compiled. It should only use the application\nroot.\n\nThis PR fixes the behavior to match what it was before and adds a test\nthat fails if it breaks again.",
    "sha": "fe19e10c399da66987c6d16322208f4c56949905",
    "files": [
        {
            "sha": "8762f1d992ecb4c3ac7512fc5337215f8de2dcd5",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -188,6 +188,9 @@ pub async fn get_client_resolve_options_context(\n         .typescript_tsconfig_path()\n         .await?\n         .as_ref()\n+        // Fall back to tsconfig only for resolving. This is because we don't want Turbopack to\n+        // resolve tsconfig.json relative to the file being compiled.\n+        .or(Some(&RcStr::from(\"tsconfig.json\")))\n         .map(|p| project_path.join(p))\n         .transpose()?;\n "
        },
        {
            "sha": "b7fe1dd5f0161ef3c336009d3dd67feb0d6a8e13",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -192,6 +192,9 @@ pub async fn get_edge_resolve_options_context(\n             .typescript_tsconfig_path()\n             .await?\n             .as_ref()\n+            // Fall back to tsconfig only for resolving. This is because we don't want Turbopack to\n+            // resolve tsconfig.json relative to the file being compiled.\n+            .or(Some(&RcStr::from(\"tsconfig.json\")))\n             .map(|p| project_path.join(p))\n             .transpose()?,\n         rules: vec![("
        },
        {
            "sha": "a79da5c3ae3057dac032ecb29967b6d5190dec78",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -333,6 +333,9 @@ pub async fn get_server_resolve_options_context(\n         .typescript_tsconfig_path()\n         .await?\n         .as_ref()\n+        // Fall back to tsconfig only for resolving. This is because we don't want Turbopack to\n+        // resolve tsconfig.json relative to the file being compiled.\n+        .or(Some(&RcStr::from(\"tsconfig.json\")))\n         .map(|p| project_path.join(p))\n         .transpose()?;\n "
        },
        {
            "sha": "b66bc617d0e2ca5003446da59b5c802b3650ed93",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/.gitignore",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2F.gitignore?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1 @@\n+!tsconfig.json\n\\ No newline at end of file"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Flayout.tsx?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Fpage.tsx?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "34fc29920ce8a331f5f807b3d0974463234747ce",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/app/tsconfig.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fapp%2Ftsconfig.json?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,4 @@\n+// This file shouldn't be found by Turbopack.\n+{\n+  \"extends\": \"non-existent-package\"\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Fnext.config.js?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "9490143391dab996c232df9c8f8101a968c42a1c",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/tsconfig-no-relative-resolve.test.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig-no-relative-resolve.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig-no-relative-resolve.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig-no-relative-resolve.test.ts?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,15 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('tsconfig-no-relative-resolve', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipStart: true,\n+  })\n+\n+  // Next.js should only use the application root tsconfig.json file and not files relative to the file being compiled.\n+  it('should fail to build', async () => {\n+    const { exitCode, cliOutput } = await next.build()\n+    expect(exitCode).toBe(0)\n+    expect(cliOutput).not.toContain('non-existent-package')\n+  })\n+})"
        },
        {
            "sha": "79cbd32f43786a52f3f63851bae1b5d10b4d7edd",
            "filename": "test/production/app-dir/tsconfig-no-relative-resolve/tsconfig.json",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/fe19e10c399da66987c6d16322208f4c56949905/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftsconfig-no-relative-resolve%2Ftsconfig.json?ref=fe19e10c399da66987c6d16322208f4c56949905",
            "patch": "@@ -0,0 +1,27 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"ES2017\",\n+    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"strict\": true,\n+    \"noEmit\": true,\n+    \"esModuleInterop\": true,\n+    \"module\": \"esnext\",\n+    \"moduleResolution\": \"bundler\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"jsx\": \"react-jsx\",\n+    \"incremental\": true,\n+    \"plugins\": [\n+      {\n+        \"name\": \"next\"\n+      }\n+    ],\n+    \"paths\": {\n+      \"@/*\": [\"./*\"]\n+    }\n+  },\n+  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n+}"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 73,
        "deletions": 0
    }
}