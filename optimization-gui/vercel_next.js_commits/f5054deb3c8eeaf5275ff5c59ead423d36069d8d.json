{
    "author": "huozhi",
    "message": "[next-server] ensure prepare is done before preloading entry (#78454)",
    "sha": "f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
    "files": [
        {
            "sha": "9f6251c3212deef7a89b36de42d92b0f4d01515d",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -1720,9 +1720,11 @@ export default abstract class Server<\n   public async prepare(): Promise<void> {\n     if (this.prepared) return\n \n-    if (this.preparedPromise === null) {\n-      // Get instrumentation module\n+    // Get instrumentation module\n+    if (!this.instrumentation) {\n       this.instrumentation = await this.loadInstrumentationModule()\n+    }\n+    if (this.preparedPromise === null) {\n       this.preparedPromise = this.prepareImpl().then(() => {\n         this.prepared = true\n         this.preparedPromise = null"
        },
        {
            "sha": "f0b47dd480b72eb730f53491bddb3b82bf2cbfb1",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -376,6 +376,9 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   public async unstable_preloadEntries(): Promise<void> {\n+    // Ensure prepare process will be finished before preloading entries.\n+    await this.prepare()\n+\n     const appPathsManifest = this.getAppPathsManifest()\n     const pagesManifest = this.getPagesManifest()\n "
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/instrumentation-order/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Flayout.tsx?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0c7fea30c72f5d17b594ecb05ea4a45efeeb9090",
            "filename": "test/e2e/app-dir/instrumentation-order/app/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fapp%2Fpage.tsx?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -0,0 +1,8 @@\n+import { connection } from 'next/server'\n+\n+console.log('global-side-effect:app-router-page')\n+\n+export default async function Page() {\n+  await connection()\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "6cbb44769c29fa944bdb9df85e92b26d81a717cd",
            "filename": "test/e2e/app-dir/instrumentation-order/instrumentation-order.test.ts",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -0,0 +1,35 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { waitFor } from 'next-test-utils'\n+\n+const ORDERED_LOGS = [\n+  'instrumentation:side-effect',\n+  'instrumentation:register:begin',\n+  'instrumentation:register:timeout',\n+  'instrumentation:register:end',\n+  'global-side-effect:app-router-page',\n+]\n+\n+describe('instrumentation-order', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  it('should work using cheerio', async () => {\n+    // Wait for the timeout in the instrumentation to complete\n+    await waitFor(500)\n+\n+    // Dev mode requires to render the page to trigger the build of the page\n+    if (isNextDev) {\n+      await next.render$('/')\n+    }\n+\n+    const serverLog = next.cliOutput.split('Starting...')[1]\n+    const cliOutputLines = serverLog.split('\\n')\n+    const searchedLines = cliOutputLines.filter((line) =>\n+      ORDERED_LOGS.includes(line.trim())\n+    )\n+\n+    expect(searchedLines).toEqual(ORDERED_LOGS)\n+  })\n+})"
        },
        {
            "sha": "daf1a12de8aa61c445d30f738a4de58ac6a02e6a",
            "filename": "test/e2e/app-dir/instrumentation-order/instrumentation.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation.ts?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -0,0 +1,12 @@\n+console.log('instrumentation:side-effect')\n+\n+export async function register() {\n+  console.log('instrumentation:register:begin')\n+  await new Promise((resolve) => {\n+    setTimeout(() => {\n+      console.log('instrumentation:register:timeout')\n+      resolve(true)\n+    }, 300)\n+  })\n+  console.log('instrumentation:register:end')\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/instrumentation-order/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f5054deb3c8eeaf5275ff5c59ead423d36069d8d/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js?ref=f5054deb3c8eeaf5275ff5c59ead423d36069d8d",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 76,
        "deletions": 2
    }
}