{
    "author": "ztanner",
    "message": "prevent browser cache from using stale RSC responses from previous builds (#86554)\n\nWhen we landed #76207 we started propagating the\n`stale-while-revalidate` value to RSC responses. We wanted a way to\nexpress to CDNs that it can keep serving the cached content for some\ntime while a revalidation runs in the background, but we specifically\ndon't want that for private caches.\n\nAs a result of this header, when re-building your application locally\n(or doing something on the server that would have expired the cache),\nthe browser's disk cache would serve a stale RSC response. We currently\nencode a buildId in RSC payloads, so the client router will discard RSC\nresponses that don't match what it is expecting.\n\nUnfortunately there isn't a `s-stale-while-revalidate` header to express\nthe intended semantics. This moves the `stale-while-revalidate`\nconfiguration into the `CDN-Cache-Control` header, which is becoming\nstandardized and is supported by a wide variety of CDNs. This allows us\nto specify the SWR behavior more explicitly to CDNs while not impacting\nprivate caches like the browser. It restores the previous behavior of\nonly setting `s-maxage` on the `cache-control` itself to avoid\ninfluencing browser cache.\n\nIf Next.js is deployed to a CDN that doesn't support this header, it can\nbe customized via `nextConfig.experimental.cdnCacheControlHeader`. Eg,\nif deployed to Fastly, you'd configure this to `cdnCacheControlHeader:\n'Surrogate-Control'`.\n\nCloses NAR-525\n\nReference docs:\n\n\n[Vercel](https://vercel.com/docs/headers/cache-control-headers#cdn-cache-control-header)\n\n[Cloudflare](https://developers.cloudflare.com/cache/concepts/cdn-cache-control/)\n\n[Fastly](https://www.fastly.com/documentation/reference/http/http-headers/Surrogate-Control/)\n\n[RFC 9213](https://httpwg.org/specs/rfc9213.html)",
    "sha": "3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
    "files": [
        {
            "sha": "2323a7ab492dacec777c016a091928548bac21be",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -1134,6 +1134,8 @@ export async function handler(\n               RSC_CONTENT_TYPE_HEADER\n             ),\n             cacheControl: cacheEntry.cacheControl,\n+            cdnCacheControlHeader:\n+              nextConfig.experimental.cdnCacheControlHeader,\n           })\n         }\n \n@@ -1151,6 +1153,7 @@ export async function handler(\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: RenderResult.EMPTY,\n           cacheControl: cacheEntry.cacheControl,\n+          cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n         })\n       }\n \n@@ -1240,6 +1243,8 @@ export async function handler(\n                 poweredByHeader: nextConfig.poweredByHeader,\n                 result: RenderResult.EMPTY,\n                 cacheControl: cacheEntry.cacheControl,\n+                cdnCacheControlHeader:\n+                  nextConfig.experimental.cdnCacheControlHeader,\n               })\n             } else {\n               // Otherwise this case is not expected.\n@@ -1256,6 +1261,8 @@ export async function handler(\n             poweredByHeader: nextConfig.poweredByHeader,\n             result: cachedData.html,\n             cacheControl: cacheEntry.cacheControl,\n+            cdnCacheControlHeader:\n+              nextConfig.experimental.cdnCacheControlHeader,\n           })\n         }\n \n@@ -1271,6 +1278,7 @@ export async function handler(\n             RSC_CONTENT_TYPE_HEADER\n           ),\n           cacheControl: cacheEntry.cacheControl,\n+          cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n         })\n       }\n \n@@ -1303,6 +1311,7 @@ export async function handler(\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: body,\n           cacheControl: cacheEntry.cacheControl,\n+          cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n         })\n       }\n \n@@ -1329,6 +1338,7 @@ export async function handler(\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: body,\n           cacheControl: { revalidate: 0, expire: undefined },\n+          cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n         })\n       }\n \n@@ -1388,6 +1398,7 @@ export async function handler(\n         // the response being sent to the client it's dynamic parts are streamed\n         // to the client on the same request.\n         cacheControl: { revalidate: 0, expire: undefined },\n+        cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n       })\n     }\n "
        },
        {
            "sha": "890bc0b51d21b2b42001a032b2ac90b37ac3f567",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -22,7 +22,7 @@ import {\n   fromNodeOutgoingHttpHeaders,\n   toNodeOutgoingHttpHeaders,\n } from '../../server/web/utils'\n-import { getCacheControlHeader } from '../../server/lib/cache-control'\n+import { setCacheControlHeaders } from '../../server/lib/cache-control'\n import { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\n import { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\n import {\n@@ -450,9 +450,10 @@ export async function handler(\n         !res.getHeader('Cache-Control') &&\n         !headers.get('Cache-Control')\n       ) {\n-        headers.set(\n-          'Cache-Control',\n-          getCacheControlHeader(cacheEntry.cacheControl)\n+        setCacheControlHeaders(\n+          headers,\n+          cacheEntry.cacheControl,\n+          nextConfig.experimental.cdnCacheControlHeader\n         )\n       }\n "
        },
        {
            "sha": "9bbe2ff8e93216ef2f2174580a78b3533f31aff4",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -372,6 +372,7 @@ export default abstract class Server<\n       generateEtags: boolean\n       poweredByHeader: boolean\n       cacheControl: CacheControl | undefined\n+      cdnCacheControlHeader?: string\n     }\n   ): Promise<void>\n \n@@ -560,6 +561,8 @@ export default abstract class Server<\n         dynamicOnHover: this.nextConfig.experimental.dynamicOnHover ?? false,\n         inlineCss: this.nextConfig.experimental.inlineCss ?? false,\n         authInterrupts: !!this.nextConfig.experimental.authInterrupts,\n+        cdnCacheControlHeader:\n+          this.nextConfig.experimental.cdnCacheControlHeader,\n       },\n       onInstrumentationRequestError:\n         this.instrumentationOnRequestError.bind(this),\n@@ -1762,6 +1765,8 @@ export default abstract class Server<\n         generateEtags,\n         poweredByHeader,\n         cacheControl,\n+        cdnCacheControlHeader:\n+          this.nextConfig.experimental.cdnCacheControlHeader,\n       })\n       res.statusCode = originalStatus\n     }"
        },
        {
            "sha": "3429fa8d851e2e1aedb3f9432ac61cf4a643763f",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -192,6 +192,7 @@ export const experimentalSchema = {\n   memoryBasedWorkersCount: z.boolean().optional(),\n   craCompat: z.boolean().optional(),\n   caseSensitiveRoutes: z.boolean().optional(),\n+  cdnCacheControlHeader: z.string().optional(),\n   clientParamParsingOrigins: z.array(z.string()).optional(),\n   dynamicOnHover: z.boolean().optional(),\n   disableOptimizedLoading: z.boolean().optional(),"
        },
        {
            "sha": "969c926d3a867011149ef16714b3b932b7fca1cd",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -279,6 +279,12 @@ export interface ExperimentalConfig {\n   prerenderEarlyExit?: boolean\n   linkNoTouchStart?: boolean\n   caseSensitiveRoutes?: boolean\n+  /**\n+   * Custom header name to use for CDN cache control instead of the default\n+   * 'CDN-Cache-Control'. This can be used to target specific CDN providers\n+   * that do not support `CDN-Cache-Control` and have their own custom header.\n+   */\n+  cdnCacheControlHeader?: string\n   /**\n    * The origins that are allowed to write the rewritten headers when\n    * performing a non-relative rewrite. When undefined, no non-relative\n@@ -1507,6 +1513,7 @@ export const defaultConfig = Object.freeze({\n     serverMinification: true,\n     linkNoTouchStart: false,\n     caseSensitiveRoutes: false,\n+    cdnCacheControlHeader: undefined,\n     clientParamParsingOrigins: undefined,\n     dynamicOnHover: false,\n     preloadEntriesOnStart: true,\n@@ -1655,6 +1662,7 @@ export interface NextConfigRuntime {\n     | 'clientParamParsingOrigins'\n     | 'adapterPath'\n     | 'allowedRevalidateHeaderKeys'\n+    | 'cdnCacheControlHeader'\n     | 'fetchCacheKeyPrefix'\n     | 'isrFlushToDisk'\n     | 'optimizeCss'\n@@ -1709,6 +1717,7 @@ export function getNextConfigRuntime(\n         clientParamParsingOrigins: ex.clientParamParsingOrigins,\n         adapterPath: ex.adapterPath,\n         allowedRevalidateHeaderKeys: ex.allowedRevalidateHeaderKeys,\n+        cdnCacheControlHeader: ex.cdnCacheControlHeader,\n         fetchCacheKeyPrefix: ex.fetchCacheKeyPrefix,\n         isrFlushToDisk: ex.isrFlushToDisk,\n         optimizeCss: ex.optimizeCss,"
        },
        {
            "sha": "61ca2cdfc443603745b788f12266ba94eb1ae68c",
            "filename": "packages/next/src/server/lib/cache-control.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 5,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-control.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-control.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-control.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -1,3 +1,4 @@\n+import type { ServerResponse } from 'http'\n import { CACHE_ONE_YEAR } from '../../lib/constants'\n \n /**\n@@ -14,10 +15,15 @@ export interface CacheControl {\n   expire: number | undefined\n }\n \n+export interface CacheHeaders {\n+  'Cache-Control': string\n+  cdnCacheControl?: string\n+}\n+\n export function getCacheControlHeader({\n   revalidate,\n   expire,\n-}: CacheControl): string {\n+}: CacheControl): CacheHeaders {\n   const swrHeader =\n     typeof revalidate === 'number' &&\n     expire !== undefined &&\n@@ -26,10 +32,67 @@ export function getCacheControlHeader({\n       : ''\n \n   if (revalidate === 0) {\n-    return 'private, no-cache, no-store, max-age=0, must-revalidate'\n-  } else if (typeof revalidate === 'number') {\n-    return `s-maxage=${revalidate}${swrHeader}`\n+    return {\n+      'Cache-Control':\n+        'private, no-cache, no-store, max-age=0, must-revalidate',\n+    }\n+  }\n+\n+  // For non-zero revalidation, we want to leverage CDN stale-while-revalidate caching\n+  // semantics without allowing the browser to cache the response.\n+  const maxAge = typeof revalidate === 'number' ? revalidate : CACHE_ONE_YEAR\n+  const cdnCacheControl = `max-age=${maxAge}${swrHeader}`\n+  const cacheControl = `s-maxage=${maxAge}`\n+\n+  return {\n+    'Cache-Control': cacheControl,\n+    cdnCacheControl: cdnCacheControl,\n   }\n+}\n+\n+/**\n+ * The default header name used for CDN cache control.\n+ */\n+export const DEFAULT_CDN_CACHE_CONTROL_HEADER = 'CDN-Cache-Control'\n \n-  return `s-maxage=${CACHE_ONE_YEAR}${swrHeader}`\n+/**\n+ * Sets cache control headers on a ServerResponse object.\n+ * Use this helper to consistently set Cache-Control and CDN cache control headers.\n+ *\n+ * @param res - The ServerResponse object\n+ * @param cacheControl - The cache control configuration\n+ * @param cdnCacheControlHeader - Custom CDN cache control header name from config, falls back to 'CDN-Cache-Control' if undefined\n+ */\n+export function setResponseCacheControlHeaders(\n+  res: ServerResponse,\n+  cacheControl: CacheControl,\n+  cdnCacheControlHeader: string | undefined\n+): void {\n+  const cacheHeaders = getCacheControlHeader(cacheControl)\n+  const headerName = cdnCacheControlHeader ?? DEFAULT_CDN_CACHE_CONTROL_HEADER\n+  res.setHeader('Cache-Control', cacheHeaders['Cache-Control'])\n+  if (cacheHeaders.cdnCacheControl) {\n+    res.setHeader(headerName, cacheHeaders.cdnCacheControl)\n+  }\n+}\n+\n+/**\n+ * Sets cache control headers on a Headers object (for Web API responses).\n+ * Use this helper to consistently set Cache-Control and CDN cache control headers.\n+ *\n+ * @param headers - The Headers object\n+ * @param cacheControl - The cache control configuration\n+ * @param cdnCacheControlHeader - Custom CDN cache control header name from config, falls back to 'CDN-Cache-Control' if undefined\n+ */\n+export function setCacheControlHeaders(\n+  headers: Headers,\n+  cacheControl: CacheControl,\n+  cdnCacheControlHeader: string | undefined\n+): void {\n+  const cacheHeaders = getCacheControlHeader(cacheControl)\n+  const headerName = cdnCacheControlHeader ?? DEFAULT_CDN_CACHE_CONTROL_HEADER\n+  headers.set('Cache-Control', cacheHeaders['Cache-Control'])\n+  if (cacheHeaders.cdnCacheControl) {\n+    headers.set(headerName, cacheHeaders.cdnCacheControl)\n+  }\n }"
        },
        {
            "sha": "799b4c6acacff695e7012d4b78a7f7d088acbbd6",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -605,6 +605,7 @@ export default class NextNodeServer extends BaseServer<\n       generateEtags: boolean\n       poweredByHeader: boolean\n       cacheControl: CacheControl | undefined\n+      cdnCacheControlHeader?: string\n     }\n   ): Promise<void> {\n     return sendRenderResult({\n@@ -614,6 +615,7 @@ export default class NextNodeServer extends BaseServer<\n       generateEtags: options.generateEtags,\n       poweredByHeader: options.poweredByHeader,\n       cacheControl: options.cacheControl,\n+      cdnCacheControlHeader: options.cdnCacheControlHeader,\n     })\n   }\n "
        },
        {
            "sha": "c7a484873fbdd32a1eeb6ee92ace4b146217069a",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -101,7 +101,7 @@ import {\n import { getTracer } from './lib/trace/tracer'\n import { RenderSpan } from './lib/trace/constants'\n import { ReflectAdapter } from './web/spec-extension/adapters/reflect'\n-import { getCacheControlHeader } from './lib/cache-control'\n+import { setResponseCacheControlHeaders } from './lib/cache-control'\n import { getErrorSource } from '../shared/lib/error-source'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import type { PagesDevOverlayBridgeType } from '../next-devtools/userspace/pages/pages-dev-overlay-setup'\n@@ -287,6 +287,7 @@ export type RenderOptsPartial = {\n   expireTime?: number\n   experimental: {\n     clientTraceMetadata?: string[]\n+    cdnCacheControlHeader?: string\n   }\n }\n \n@@ -555,9 +556,10 @@ export async function renderToHTMLImpl(\n   // ensure we set cache header so it's not rendered on-demand\n   // every request\n   if (isAutoExport && !dev && isExperimentalCompile) {\n-    res.setHeader(\n-      'Cache-Control',\n-      getCacheControlHeader({ revalidate: false, expire: expireTime })\n+    setResponseCacheControlHeaders(\n+      res,\n+      { revalidate: false, expire: expireTime },\n+      renderOpts.experimental.cdnCacheControlHeader\n     )\n     isAutoExport = false\n   }"
        },
        {
            "sha": "a7b3acd60bdbc894d2113022b6a2eb3cebd76968",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -17,7 +17,7 @@ import {\n } from '../../response-cache'\n \n import {\n-  getCacheControlHeader,\n+  setResponseCacheControlHeaders,\n   type CacheControl,\n } from '../../lib/cache-control'\n import { normalizeRepeatedSlashes } from '../../../shared/lib/utils'\n@@ -607,7 +607,11 @@ export const getHandler = ({\n         // If cache control is already set on the response we don't\n         // override it to allow users to customize it via next.config\n         if (cacheControl && !res.getHeader('Cache-Control')) {\n-          res.setHeader('Cache-Control', getCacheControlHeader(cacheControl))\n+          setResponseCacheControlHeaders(\n+            res,\n+            cacheControl,\n+            nextConfig.experimental.cdnCacheControlHeader\n+          )\n         }\n \n         // notFound: true case\n@@ -718,6 +722,7 @@ export const getHandler = ({\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n           cacheControl: routeModule.isDev ? undefined : cacheControl,\n+          cdnCacheControlHeader: nextConfig.experimental.cdnCacheControlHeader,\n         })\n       }\n "
        },
        {
            "sha": "9266bc110c9493aaddc7c9b55d721650b4ce8a6c",
            "filename": "packages/next/src/server/send-payload.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -5,7 +5,7 @@ import type { CacheControl } from './lib/cache-control'\n import { isResSent } from '../shared/lib/utils'\n import { generateETag } from './lib/etag'\n import fresh from 'next/dist/compiled/fresh'\n-import { getCacheControlHeader } from './lib/cache-control'\n+import { setResponseCacheControlHeaders } from './lib/cache-control'\n import { HTML_CONTENT_TYPE_HEADER } from '../lib/constants'\n \n export function sendEtagResponse(\n@@ -39,13 +39,15 @@ export async function sendRenderResult({\n   generateEtags,\n   poweredByHeader,\n   cacheControl,\n+  cdnCacheControlHeader,\n }: {\n   req: IncomingMessage\n   res: ServerResponse\n   result: RenderResult\n   generateEtags: boolean\n   poweredByHeader: boolean\n   cacheControl: CacheControl | undefined\n+  cdnCacheControlHeader?: string\n }): Promise<void> {\n   if (isResSent(res)) {\n     return\n@@ -58,7 +60,7 @@ export async function sendRenderResult({\n   // If cache control is already set on the response we don't\n   // override it to allow users to customize it via next.config\n   if (cacheControl && !res.getHeader('Cache-Control')) {\n-    res.setHeader('Cache-Control', getCacheControlHeader(cacheControl))\n+    setResponseCacheControlHeaders(res, cacheControl, cdnCacheControlHeader)\n   }\n \n   const payload = result.isDynamic ? null : result.toUnchunkedString()"
        },
        {
            "sha": "c7295294439d6f927620e7678ae9e9b007480c93",
            "filename": "test/e2e/app-dir/cdn-cache-control-header/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Flayout.tsx?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "859eee56ca4d1d9b91020889d674d426fa5759f1",
            "filename": "test/e2e/app-dir/cdn-cache-control-header/app/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fapp%2Fpage.tsx?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -0,0 +1,8 @@\n+'use cache'\n+\n+import { cacheLife } from 'next/cache'\n+\n+export default async function Page() {\n+  cacheLife('minutes')\n+  return <p>Hello World</p>\n+}"
        },
        {
            "sha": "faf41f82849f55bb5100ee3b8b4e3c367c717f22",
            "filename": "test/e2e/app-dir/cdn-cache-control-header/cdn-cache-control-header.test.ts",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fcdn-cache-control-header.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fcdn-cache-control-header.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fcdn-cache-control-header.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -0,0 +1,28 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('cdn-cache-control-header', () => {\n+  const { next, isNextDev, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  if (isNextDeploy) {\n+    it('should skip for deploy', () => {})\n+    return\n+  }\n+\n+  it('should use custom CDN cache control header name from experimental config', async () => {\n+    const res = await next.fetch('/')\n+\n+    // In dev mode, no caching headers are set\n+    if (isNextDev) {\n+      expect(res.headers.get('cache-control')).toBe('no-store, must-revalidate')\n+      expect(res.headers.get('surrogate-control')).toBeNull()\n+      expect(res.headers.get('cdn-cache-control')).toBeNull()\n+      return\n+    }\n+\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=60')\n+    expect(res.headers.get('surrogate-control')).toMatch(/^max-age=\\d+/)\n+    expect(res.headers.get('cdn-cache-control')).toBeNull()\n+  })\n+})"
        },
        {
            "sha": "57ec2bcaa491394b104cf9c53de50b565148abb9",
            "filename": "test/e2e/app-dir/cdn-cache-control-header/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcdn-cache-control-header%2Fnext.config.js?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  cacheComponents: true,\n+  experimental: {\n+    cdnCacheControlHeader: 'Surrogate-Control',\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "ce10656eeddcfc829097096dacd1f296807bc37f",
            "filename": "test/e2e/app-dir/custom-cache-control/custom-cache-control.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcustom-cache-control%2Fcustom-cache-control.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fcustom-cache-control%2Fcustom-cache-control.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcustom-cache-control%2Fcustom-cache-control.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -31,10 +31,14 @@ describe('custom-cache-control', () => {\n       const res = await next.fetch('/app-ssg/another')\n       // eslint-disable-next-line jest/no-standalone-expect\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev\n-          ? 'no-store, must-revalidate'\n-          : 's-maxage=120, stale-while-revalidate=31535880'\n+        isNextDev ? 'no-store, must-revalidate' : 's-maxage=120'\n       )\n+      if (!isNextDev) {\n+        // eslint-disable-next-line jest/no-standalone-expect\n+        expect(res.headers.get('cdn-cache-control')).toBe(\n+          'max-age=120, stale-while-revalidate=31535880'\n+        )\n+      }\n     }\n   )\n \n@@ -69,10 +73,13 @@ describe('custom-cache-control', () => {\n   it('should have default cache-control for pages-ssg another', async () => {\n     const res = await next.fetch('/pages-ssg/another')\n     expect(res.headers.get('cache-control')).toBe(\n-      isNextDev\n-        ? 'no-store, must-revalidate'\n-        : 's-maxage=120, stale-while-revalidate=31535880'\n+      isNextDev ? 'no-store, must-revalidate' : 's-maxage=120'\n     )\n+    if (!isNextDev) {\n+      expect(res.headers.get('cdn-cache-control')).toBe(\n+        'max-age=120, stale-while-revalidate=31535880'\n+      )\n+    }\n   })\n \n   it('should have default cache-control for pages-ssr', async () => {"
        },
        {
            "sha": "0ae5c5518dbd053e60b7a26037775a43443b2fd7",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -553,17 +553,19 @@ describe('use-cache', () => {\n     it('should send an SWR cache-control header based on the revalidate and expire values', async () => {\n       let response = await next.fetch('/cache-life')\n \n-      expect(response.headers.get('cache-control')).toBe(\n+      expect(response.headers.get('cache-control')).toBe('s-maxage=100')\n+      expect(response.headers.get('cdn-cache-control')).toBe(\n         // revalidate is set to 100, expire is set to 300 => SWR 200\n-        's-maxage=100, stale-while-revalidate=200'\n+        'max-age=100, stale-while-revalidate=200'\n       )\n \n       response = await next.fetch('/cache-fetch')\n \n-      expect(response.headers.get('cache-control')).toBe(\n+      expect(response.headers.get('cache-control')).toBe('s-maxage=900')\n+      expect(response.headers.get('cdn-cache-control')).toBe(\n         // revalidate is set to 900, expire is one year (31536000, default\n         // expireTime) => SWR 31535100\n-        's-maxage=900, stale-while-revalidate=31535100'\n+        'max-age=900, stale-while-revalidate=31535100'\n       )\n     })\n "
        },
        {
            "sha": "d548f7604263bcdc58568d34899ce1a2944479dc",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 26,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -676,21 +676,25 @@ describe('Prerender', () => {\n     if (!isDev) {\n       it('should use correct caching headers for a revalidate page', async () => {\n         const initialRes = await fetchViaHTTP(next.url, '/')\n-        expect(initialRes.headers.get('cache-control')).toBe(\n-          isDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 's-maxage=2, stale-while-revalidate=31535998'\n-        )\n+        expect(initialRes.headers.get('cache-control')).toBe('s-maxage=2')\n+        if (!isDeploy) {\n+          expect(initialRes.headers.get('cdn-cache-control')).toBe(\n+            'max-age=2, stale-while-revalidate=31535998'\n+          )\n+        }\n       })\n \n       it('should use correct caching headers for a fallback-true page (prerendered)', async () => {\n         const initialRes = await fetchViaHTTP(next.url, '/fallback-true/first')\n         expect(initialRes.status).toBe(200)\n         expect(initialRes.headers.get('cache-control')).toBe(\n-          isDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 's-maxage=2, stale-while-revalidate=31535998'\n+          isDeploy ? 'public, max-age=0, must-revalidate' : 's-maxage=2'\n         )\n+        if (!isDeploy) {\n+          expect(initialRes.headers.get('cdn-cache-control')).toBe(\n+            'max-age=2, stale-while-revalidate=31535998'\n+          )\n+        }\n         expect(await initialRes.text()).not.toContain('hi fallback')\n \n         const dataRes = await fetchViaHTTP(\n@@ -699,19 +703,23 @@ describe('Prerender', () => {\n         )\n         expect(dataRes.status).toBe(200)\n         expect(dataRes.headers.get('cache-control')).toBe(\n-          isDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 's-maxage=2, stale-while-revalidate=31535998'\n+          isDeploy ? 'public, max-age=0, must-revalidate' : 's-maxage=2'\n         )\n+        if (!isDeploy) {\n+          expect(dataRes.headers.get('cdn-cache-control')).toBe(\n+            'max-age=2, stale-while-revalidate=31535998'\n+          )\n+        }\n \n         await retry(async () => {\n           const finalRes = await fetchViaHTTP(next.url, `/fallback-true/first`)\n           expect(finalRes.status).toBe(200)\n-          expect(finalRes.headers.get('cache-control')).toBe(\n-            isDeploy\n-              ? 'public, max-age=0, must-revalidate'\n-              : 's-maxage=2, stale-while-revalidate=31535998'\n-          )\n+          expect(finalRes.headers.get('cache-control')).toBe('s-maxage=2')\n+          if (!isDeploy) {\n+            expect(finalRes.headers.get('cdn-cache-control')).toBe(\n+              'max-age=2, stale-while-revalidate=31535998'\n+            )\n+          }\n           expect(await finalRes.text()).not.toContain('hi fallback')\n         })\n       })\n@@ -731,20 +739,22 @@ describe('Prerender', () => {\n           `/_next/data/${next.buildId}/fallback-true/second.json`\n         )\n         expect(dataRes.status).toBe(200)\n-        expect(dataRes.headers.get('cache-control')).toBe(\n-          isDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 's-maxage=2, stale-while-revalidate=31535998'\n-        )\n+        expect(dataRes.headers.get('cache-control')).toBe('s-maxage=2')\n+        if (!isDeploy) {\n+          expect(dataRes.headers.get('cdn-cache-control')).toBe(\n+            'max-age=2, stale-while-revalidate=31535998'\n+          )\n+        }\n \n         await retry(async () => {\n           const finalRes = await fetchViaHTTP(next.url, `/fallback-true/second`)\n           expect(finalRes.status).toBe(200)\n-          expect(finalRes.headers.get('cache-control')).toBe(\n-            isDeploy\n-              ? 'public, max-age=0, must-revalidate'\n-              : 's-maxage=2, stale-while-revalidate=31535998'\n-          )\n+          expect(finalRes.headers.get('cache-control')).toBe('s-maxage=2')\n+          if (!isDeploy) {\n+            expect(finalRes.headers.get('cdn-cache-control')).toBe(\n+              'max-age=2, stale-while-revalidate=31535998'\n+            )\n+          }\n           expect(await finalRes.text()).not.toContain('hi fallback')\n         })\n       })\n@@ -1380,6 +1390,11 @@ describe('Prerender', () => {\n         expect(initialRes.headers.get('cache-control')).toBe(\n           isDeploy ? 'public, max-age=0, must-revalidate' : 's-maxage=31536000'\n         )\n+        if (!isDeploy) {\n+          expect(initialRes.headers.get('cdn-cache-control')).toBe(\n+            'max-age=31536000'\n+          )\n+        }\n         const initialHtml = await initialRes.text()\n         expect(initialHtml).toMatch(/hello.*?world/)\n       })"
        },
        {
            "sha": "f6b5d4bd3f4e4e622687ec68d06a75ff5a44a7c9",
            "filename": "test/integration/not-found-revalidate/test/index.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 18,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fintegration%2Fnot-found-revalidate%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fintegration%2Fnot-found-revalidate%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnot-found-revalidate%2Ftest%2Findex.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -81,8 +81,9 @@ const runTests = () => {\n     let res = await fetchViaHTTP(appPort, '/fallback-blocking/hello')\n     let $ = cheerio.load(await res.text())\n \n-    expect(res.headers.get('cache-control')).toBe(\n-      `s-maxage=1, stale-while-revalidate=31535999`\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      `max-age=1, stale-while-revalidate=31535999`\n     )\n     expect(res.status).toBe(404)\n     expect(JSON.parse($('#props').text()).notFound).toBe(true)\n@@ -91,8 +92,9 @@ const runTests = () => {\n     res = await fetchViaHTTP(appPort, '/fallback-blocking/hello')\n     $ = cheerio.load(await res.text())\n \n-    expect(res.headers.get('cache-control')).toBe(\n-      `s-maxage=1, stale-while-revalidate=31535999`\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      `max-age=1, stale-while-revalidate=31535999`\n     )\n     expect(res.status).toBe(404)\n     expect(JSON.parse($('#props').text()).notFound).toBe(true)\n@@ -102,8 +104,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props.found).toBe(true)\n@@ -115,8 +118,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props2 = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props2.found).toBe(true)\n@@ -128,8 +132,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props3 = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props3.found).toBe(true)\n@@ -147,8 +152,9 @@ const runTests = () => {\n     let res = await fetchViaHTTP(appPort, '/fallback-true/world')\n     let $ = cheerio.load(await res.text())\n \n-    expect(res.headers.get('cache-control')).toBe(\n-      `s-maxage=1, stale-while-revalidate=31535999`\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      `max-age=1, stale-while-revalidate=31535999`\n     )\n     expect(res.status).toBe(404)\n     expect(JSON.parse($('#props').text()).notFound).toBe(true)\n@@ -158,8 +164,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props.found).toBe(true)\n@@ -171,8 +178,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props2 = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props2.found).toBe(true)\n@@ -184,8 +192,9 @@ const runTests = () => {\n     $ = cheerio.load(await res.text())\n \n     const props3 = JSON.parse($('#props').text())\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n     expect(res.status).toBe(200)\n     expect(props3.found).toBe(true)"
        },
        {
            "sha": "7694bd5b417165fd275aadab7554ef8f58a23f90",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-app.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -113,6 +113,7 @@ describe('required server files app router', () => {\n     })\n     expect(res.status).toBe(200)\n     expect(res.headers.get('cache-control')).toBe('s-maxage=31536000')\n+    expect(res.headers.get('cdn-cache-control')).toBe('max-age=31536000')\n   })\n \n   it('should handle optional catchall', async () => {\n@@ -171,8 +172,9 @@ describe('required server files app router', () => {\n       },\n     })\n     expect(res.status).toBe(200)\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=3600, stale-while-revalidate=31532400'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=3600')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=3600, stale-while-revalidate=31532400'\n     )\n   })\n "
        },
        {
            "sha": "f1eb6abbc2db49a0df9d1d382281b5141f33a958",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-i18n.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-i18n.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-i18n.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-i18n.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -174,8 +174,9 @@ describe('required server files i18n', () => {\n       redirect: 'manual',\n     })\n     expect(res.status).toBe(200)\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n \n     await waitFor(2000)\n@@ -185,8 +186,9 @@ describe('required server files i18n', () => {\n       redirect: 'manual',\n     })\n     expect(res2.status).toBe(404)\n-    expect(res2.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res2.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res2.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n   })\n "
        },
        {
            "sha": "0bd27ad702a1e0779c24cfad541c813e5999afa0",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=3bbb2e61d54c46df2b5bb0a4ecd7f0765ff93a72",
            "patch": "@@ -220,16 +220,18 @@ describe('required server files', () => {\n       path: '/optional-ssg/redirect-1',\n       dest: '/somewhere',\n       cacheControl: 's-maxage=31536000',\n+      cdnCacheControl: 'max-age=31536000',\n     },\n     {\n       case: 'redirect with revalidate',\n       path: '/optional-ssg/redirect-2',\n       dest: '/somewhere-else',\n-      cacheControl: 's-maxage=5, stale-while-revalidate=31535995',\n+      cacheControl: 's-maxage=5',\n+      cdnCacheControl: 'max-age=5, stale-while-revalidate=31535995',\n     },\n   ])(\n     `should have correct cache-control for $case`,\n-    async ({ path, dest, cacheControl }) => {\n+    async ({ path, dest, cacheControl, cdnCacheControl }) => {\n       const res = await fetchViaHTTP(appPort, path, undefined, {\n         redirect: 'manual',\n       })\n@@ -238,6 +240,7 @@ describe('required server files', () => {\n         dest\n       )\n       expect(res.headers.get('cache-control')).toBe(cacheControl)\n+      expect(res.headers.get('cdn-cache-control')).toBe(cdnCacheControl)\n \n       const dataRes = await fetchViaHTTP(\n         appPort,\n@@ -247,6 +250,8 @@ describe('required server files', () => {\n           redirect: 'manual',\n         }\n       )\n+      expect(dataRes.headers.get('cache-control')).toBe(cacheControl)\n+      expect(dataRes.headers.get('cdn-cache-control')).toBe(cdnCacheControl)\n       expect((await dataRes.json()).pageProps).toEqual({\n         __N_REDIRECT: dest,\n         __N_REDIRECT_STATUS: 307,\n@@ -297,21 +302,24 @@ describe('required server files', () => {\n       path: '/optional-ssg/not-found-1',\n       dest: '/somewhere',\n       cacheControl: 's-maxage=31536000',\n+      cdnCacheControl: 'max-age=31536000',\n     },\n     {\n       case: 'notFound with revalidate',\n       path: '/optional-ssg/not-found-2',\n       dest: '/somewhere-else',\n-      cacheControl: 's-maxage=5, stale-while-revalidate=31535995',\n+      cacheControl: 's-maxage=5',\n+      cdnCacheControl: 'max-age=5, stale-while-revalidate=31535995',\n     },\n   ])(\n     `should have correct cache-control for $case`,\n-    async ({ path, dest, cacheControl }) => {\n+    async ({ path, dest, cacheControl, cdnCacheControl }) => {\n       const res = await fetchViaHTTP(appPort, path, undefined, {\n         redirect: 'manual',\n       })\n       expect(res.status).toBe(404)\n       expect(res.headers.get('cache-control')).toBe(cacheControl)\n+      expect(res.headers.get('cdn-cache-control')).toBe(cdnCacheControl)\n \n       const dataRes = await fetchViaHTTP(\n         appPort,\n@@ -322,13 +330,15 @@ describe('required server files', () => {\n         }\n       )\n       expect(dataRes.headers.get('cache-control')).toBe(cacheControl)\n+      expect(dataRes.headers.get('cdn-cache-control')).toBe(cdnCacheControl)\n     }\n   )\n \n   it('should have the correct cache-control for props with no revalidate', async () => {\n     const res = await fetchViaHTTP(appPort, '/optional-ssg/props-no-revalidate')\n     expect(res.status).toBe(200)\n     expect(res.headers.get('cache-control')).toBe('s-maxage=31536000')\n+    expect(res.headers.get('cdn-cache-control')).toBe('max-age=31536000')\n     const $ = cheerio.load(await res.text())\n     expect(JSON.parse($('#props').text()).params).toEqual({\n       rest: ['props-no-revalidate'],\n@@ -341,6 +351,7 @@ describe('required server files', () => {\n     )\n     expect(dataRes.status).toBe(200)\n     expect(res.headers.get('cache-control')).toBe('s-maxage=31536000')\n+    expect(res.headers.get('cdn-cache-control')).toBe('max-age=31536000')\n     expect((await dataRes.json()).pageProps.params).toEqual({\n       rest: ['props-no-revalidate'],\n     })\n@@ -533,8 +544,9 @@ describe('required server files', () => {\n       redirect: 'manual',\n     })\n     expect(res.status).toBe(200)\n-    expect(res.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n \n     await waitFor(2000)\n@@ -544,8 +556,9 @@ describe('required server files', () => {\n       redirect: 'manual',\n     })\n     expect(res2.status).toBe(404)\n-    expect(res2.headers.get('cache-control')).toBe(\n-      's-maxage=1, stale-while-revalidate=31535999'\n+    expect(res2.headers.get('cache-control')).toBe('s-maxage=1')\n+    expect(res2.headers.get('cdn-cache-control')).toBe(\n+      'max-age=1, stale-while-revalidate=31535999'\n     )\n   })\n "
        }
    ],
    "stats": {
        "total": 375,
        "additions": 290,
        "deletions": 85
    }
}