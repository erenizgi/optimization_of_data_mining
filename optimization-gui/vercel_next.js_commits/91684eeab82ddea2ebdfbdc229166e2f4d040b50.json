{
    "author": "unstubbable",
    "message": "Remove rewrite query params from request URL when deployed to Vercel (#76548)",
    "sha": "91684eeab82ddea2ebdfbdc229166e2f4d040b50",
    "files": [
        {
            "sha": "a9d41354224c6c864b700f71f59eaaea82a0132b",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/91684eeab82ddea2ebdfbdc229166e2f4d040b50/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/91684eeab82ddea2ebdfbdc229166e2f4d040b50/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=91684eeab82ddea2ebdfbdc229166e2f4d040b50",
            "patch": "@@ -27,10 +27,8 @@ export function normalizeVercelUrl(\n   paramKeys: string[],\n   defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n ) {\n-  if (!defaultRouteRegex) return\n-\n-  // make sure to normalize req.url on Vercel to strip dynamic params\n-  // from the query which are added during routing\n+  // make sure to normalize req.url on Vercel to strip dynamic and rewrite\n+  // params from the query which are added during routing\n   const _parsedUrl = parseUrl(req.url!, true)\n   delete (_parsedUrl as any).search\n \n@@ -45,7 +43,8 @@ export function normalizeVercelUrl(\n     if (\n       isNextQueryPrefix ||\n       isNextInterceptionMarkerPrefix ||\n-      (paramKeys || Object.keys(defaultRouteRegex.groups)).includes(key)\n+      paramKeys.includes(key) ||\n+      (defaultRouteRegex && Object.keys(defaultRouteRegex.groups).includes(key))\n     ) {\n       delete _parsedUrl.query[key]\n     }"
        },
        {
            "sha": "ef7ab634dc3fcccbd1bbeb9f925fd1a4eeabaec6",
            "filename": "test/e2e/getserversideprops/app/next.config.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fnext.config.js?ref=91684eeab82ddea2ebdfbdc229166e2f4d040b50",
            "patch": "@@ -14,6 +14,10 @@ module.exports = {\n         source: '/blog-:param',\n         destination: '/blog/post-3',\n       },\n+      {\n+        source: '/rewrite-source/:path+',\n+        destination: '/rewrite-target',\n+      },\n     ]\n   },\n }"
        },
        {
            "sha": "f58eef648868f8e1c3908366508a866fa70a8beb",
            "filename": "test/e2e/getserversideprops/app/pages/index.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Findex.js?ref=91684eeab82ddea2ebdfbdc229166e2f4d040b50",
            "patch": "@@ -95,6 +95,8 @@ const Page = ({ world, time, url }) => {\n       </Link>\n       <br />\n       <Link href=\"/redirect-page\">to redirect-page</Link>\n+      <br />\n+      <Link href=\"/rewrite-source/foo\">to rewrite-source/foo</Link>\n     </>\n   )\n }"
        },
        {
            "sha": "d74fbbd7458aa521dfb5e6f00f4a84b8d51afbf5",
            "filename": "test/e2e/getserversideprops/app/pages/rewrite-target/index.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Frewrite-target%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Frewrite-target%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fgetserversideprops%2Fapp%2Fpages%2Frewrite-target%2Findex.js?ref=91684eeab82ddea2ebdfbdc229166e2f4d040b50",
            "patch": "@@ -0,0 +1,17 @@\n+import { useRouter } from 'next/router'\n+\n+export async function getServerSideProps({ req }) {\n+  return { props: { url: req.url } }\n+}\n+\n+export default function RewriteTarget({ url }) {\n+  const router = useRouter()\n+\n+  return (\n+    <>\n+      <h1>rewrite-target</h1>\n+      <p id=\"as-path\">{router.asPath}</p>\n+      <p id=\"req-url\">{url}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "9f9593d8480675a7684a1dcbe45d021429df700a",
            "filename": "test/e2e/getserversideprops/test/index.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/91684eeab82ddea2ebdfbdc229166e2f4d040b50/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts?ref=91684eeab82ddea2ebdfbdc229166e2f4d040b50",
            "patch": "@@ -169,6 +169,12 @@ const expectedManifestRoutes = () => [\n     ),\n     page: '/refresh',\n   },\n+  {\n+    dataRouteRegex: normalizeRegEx(\n+      `^\\\\/_next\\\\/data\\\\/${escapeRegex(buildId)}\\\\/rewrite-target\\\\.json$`\n+    ),\n+    page: '/rewrite-target',\n+  },\n   {\n     dataRouteRegex: normalizeRegEx(\n       `^\\\\/_next\\\\/data\\\\/${escapeRegex(buildId)}\\\\/slow\\\\.json$`\n@@ -543,6 +549,13 @@ const runTests = (isDev = false, isDeploy = false) => {\n     expect($('#as-path').text()).toBe('/something')\n   })\n \n+  it('should not include rewrite query params in `asPath` and `req.url`', async () => {\n+    const $ = await next.render$('/rewrite-source/foo')\n+    expect($('h1').text()).toBe('rewrite-target')\n+    expect($('#as-path').text()).toBe('/rewrite-source/foo')\n+    expect($('#req-url').text()).toBe('/rewrite-source/foo')\n+  })\n+\n   it('should return data correctly', async () => {\n     const data = JSON.parse(\n       await renderViaHTTP(next.url, `/_next/data/${buildId}/something.json`)"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 40,
        "deletions": 5
    }
}