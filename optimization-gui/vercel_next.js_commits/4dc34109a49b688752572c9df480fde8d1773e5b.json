{
    "author": "gaojude",
    "message": "Fix: Disambiguate Mediapartners-Google user agent (#82536)\n\n`Mediapartners-Google` used to match both `HEADLESS_BROWSER_BOT_UA_RE`\nand `HTML_LIMITED_BOT_UA_RE`, causing inconsistent state values for\n`getBotType`, `isDomBotUA`, and `isHtmlLimitedBotUA`.",
    "sha": "4dc34109a49b688752572c9df480fde8d1773e5b",
    "files": [
        {
            "sha": "ed72f2c0f890ec516b24cc3c07ab1de648d801a2",
            "filename": "packages/next/src/shared/lib/router/utils/html-bots.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4dc34109a49b688752572c9df480fde8d1773e5b/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fhtml-bots.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dc34109a49b688752572c9df480fde8d1773e5b/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fhtml-bots.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fhtml-bots.ts?ref=4dc34109a49b688752572c9df480fde8d1773e5b",
            "patch": "@@ -1,4 +1,6 @@\n // This regex contains the bots that we need to do a blocking render for and can't safely stream the response\n // due to how they parse the DOM. For example, they might explicitly check for metadata in the `head` tag, so we can't stream metadata tags after the `head` was sent.\n+// Note: The pattern [\\w-]+-Google captures all Google crawlers with \"-Google\" suffix (e.g., Mediapartners-Google, AdsBot-Google, Storebot-Google)\n+// as well as crawlers starting with \"Google-\" (e.g., Google-PageRenderer, Google-InspectionTool)\n export const HTML_LIMITED_BOT_UA_RE =\n-  /Mediapartners-Google|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti/i\n+  /[\\w-]+-Google|Google-[\\w-]+|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti|googleweblight/i"
        },
        {
            "sha": "efa935eec832b5970a690d3dd02594e5e12b7ad4",
            "filename": "packages/next/src/shared/lib/router/utils/is-bot.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4dc34109a49b688752572c9df480fde8d1773e5b/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-bot.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dc34109a49b688752572c9df480fde8d1773e5b/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-bot.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-bot.ts?ref=4dc34109a49b688752572c9df480fde8d1773e5b",
            "patch": "@@ -1,9 +1,10 @@\n import { HTML_LIMITED_BOT_UA_RE } from './html-bots'\n \n // Bot crawler that will spin up a headless browser and execute JS.\n-// By default, only googlebots are considered as DOM bots. Blow is where the regex is computed from:\n+// Only the main Googlebot search crawler executes JavaScript, not other Google crawlers.\n // x-ref: https://developers.google.com/search/docs/crawling-indexing/google-common-crawlers\n-const HEADLESS_BROWSER_BOT_UA_RE = /google/i\n+// This regex specifically matches \"Googlebot\" but NOT \"Mediapartners-Google\", \"AdsBot-Google\", etc.\n+const HEADLESS_BROWSER_BOT_UA_RE = /Googlebot(?!-)|Googlebot$/i\n \n export const HTML_LIMITED_BOT_UA_RE_STRING = HTML_LIMITED_BOT_UA_RE.source\n "
        },
        {
            "sha": "1601c422b1ee1d42d9f851a8362054ec91aa0d1c",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4dc34109a49b688752572c9df480fde8d1773e5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dc34109a49b688752572c9df480fde8d1773e5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts?ref=4dc34109a49b688752572c9df480fde8d1773e5b",
            "patch": "@@ -11,7 +11,7 @@ describe('app-dir - metadata-streaming-config', () => {\n     )\n \n     expect(requiredServerFiles.config.htmlLimitedBots).toMatchInlineSnapshot(\n-      `\"Mediapartners-Google|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti\"`\n+      `\"[\\\\w-]+-Google|Google-[\\\\w-]+|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti|googleweblight\"`\n     )\n \n     const prerenderManifest = JSON.parse(\n@@ -38,7 +38,7 @@ describe('app-dir - metadata-streaming-config', () => {\n        \"/ppr\": {\n          \"key\": \"user-agent\",\n          \"type\": \"header\",\n-         \"value\": \"Mediapartners-Google|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti\",\n+         \"value\": \"[\\\\w-]+-Google|Google-[\\\\w-]+|Chrome-Lighthouse|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview|Yeti|googleweblight\",\n        },\n      }\n     `)"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 8,
        "deletions": 5
    }
}