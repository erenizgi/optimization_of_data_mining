{
    "author": "ijjk",
    "message": "Migrate pages API routes to handler interface (#78166)\n\nThis is one of the intial migrations for\nhttps://github.com/vercel/next.js/discussions/77740 which starts by\nadding the `handler` signature for pages API routes. This new `handler`\nsignature will be added for all route types and allows a consistent way\nto invoke entries.\n\nThis also aims to align all logic to no longer be special cased between\nminimal mode, standalone mode, and just normal `next start`. All modes\nwill behave and process requests the same at the entry level after this\nis done.\n\nOnce all route types are migrated `next-server`, `web-server`, and\n`base-server` will no longer be necessary and a minimal matching layer\nwill be provided to process rewrites/dynamic routes to the related entry\ninstead.\n\nThe changes here we validated against the `vercel/vercel` [test suite\nhere](https://github.com/vercel/vercel/pull/13231) and\n\n---------\n\nCo-authored-by: Sebastian Sebbie Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "4e6c27befd32b405f252f147147622de7025bcdb",
    "files": [
        {
            "sha": "05f4c598bc3ad80add23e461e3b525ac97c2356d",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -673,5 +673,6 @@\n   \"672\": \"Expected `telemetry` to be set in globals\",\n   \"673\": \"Thrown value was ignored. This is a bug in Next.js.\",\n   \"674\": \"Route \\\"%s\\\" has a \\\\`generateViewport\\\\` that depends on Request data (\\\\`cookies()\\\\`, etc...) or uncached external data (\\\\`fetch(...)\\\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\",\n-  \"675\": \"Expected `generateMetadata` not to block the application shell but it did.\"\n+  \"675\": \"Expected `generateMetadata` not to block the application shell but it did.\",\n+  \"676\": \"Invariant: missing internal router-server-methods this is an internal bug\"\n }"
        },
        {
            "sha": "20f74375a0146e6011606cc09a9c4a67891a7f63",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 255,
            "deletions": 2,
            "changes": 257,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -1,10 +1,36 @@\n-import { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n+import type { NextApiResponse } from '../../types'\n+import type { IncomingMessage, ServerResponse } from 'node:http'\n+\n import { RouteKind } from '../../server/route-kind'\n+import { sendError } from '../../server/api-utils'\n+import { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n+import fs from 'node:fs'\n+import path from 'node:path'\n+import { parse } from 'node:url'\n \n import { hoist } from './helpers'\n \n // Import the userland code.\n import * as userland from 'VAR_USERLAND'\n+import { getTracer, SpanKind } from '../../server/lib/trace/tracer'\n+import type { Span } from '../../server/lib/trace/tracer'\n+import { BaseServerSpan } from '../../server/lib/trace/constants'\n+import {\n+  ensureInstrumentationRegistered,\n+  instrumentationOnRequestError,\n+} from '../../server/lib/router-utils/instrumentation-globals.external'\n+import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n+import { getUtils } from '../../server/server-utils'\n+import { PRERENDER_MANIFEST, ROUTES_MANIFEST } from '../../api/constants'\n+import { isDynamicRoute } from '../../shared/lib/router/utils'\n+import type { BaseNextRequest } from '../../server/base-http'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from '../../server/lib/router-utils/router-server-context'\n+import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n+import { normalizeLocalePath } from '../../shared/lib/i18n/normalize-locale-path'\n+import type { PrerenderManifest, RoutesManifest } from '..'\n \n // Re-export the handler (should be the default export).\n export default hoist(userland, 'default')\n@@ -13,7 +39,7 @@ export default hoist(userland, 'default')\n export const config = hoist(userland, 'config')\n \n // Create and export the route module that will be consumed.\n-export const routeModule = new PagesAPIRouteModule({\n+const routeModule = new PagesAPIRouteModule({\n   definition: {\n     kind: RouteKind.PAGES_API,\n     page: 'VAR_DEFINITION_PAGE',\n@@ -24,3 +50,230 @@ export const routeModule = new PagesAPIRouteModule({\n   },\n   userland,\n })\n+\n+const loadedManifests = new Map<string, any>()\n+\n+async function loadManifest(key: string, loader: () => Promise<any>) {\n+  const cached = loadedManifests.get(key)\n+\n+  if (cached) {\n+    return cached\n+  }\n+  const currentManifest = await loader()\n+  loadedManifests.set(key, currentManifest)\n+  return currentManifest\n+}\n+\n+export async function handler(\n+  req: IncomingMessage,\n+  res: ServerResponse,\n+  ctx: {\n+    waitUntil?: (prom: Promise<void>) => void\n+  }\n+): Promise<void> {\n+  const dir =\n+    routerServerGlobal[RouterServerContextSymbol]?.dir || process.cwd()\n+  const distDir = process.env.__NEXT_RELATIVE_DIST_DIR || ''\n+  const isDev = process.env.NODE_ENV === 'development'\n+\n+  const routesManifest: RoutesManifest = await loadManifest(\n+    ROUTES_MANIFEST,\n+    async () =>\n+      JSON.parse(\n+        await fs.promises.readFile(\n+          path.join(dir, distDir, ROUTES_MANIFEST),\n+          'utf8'\n+        )\n+      )\n+  )\n+  const prerenderManifest: PrerenderManifest = await loadManifest(\n+    PRERENDER_MANIFEST,\n+    async () =>\n+      JSON.parse(\n+        await fs.promises.readFile(\n+          path.join(dir, distDir, PRERENDER_MANIFEST),\n+          'utf8'\n+        )\n+      )\n+  )\n+  let srcPage = 'VAR_DEFINITION_PAGE'\n+\n+  // turbopack doesn't normalize `/index` in the page name\n+  // so we need to to process dynamic routes properly\n+  if (process.env.TURBOPACK) {\n+    srcPage = srcPage.replace(/\\/index$/, '')\n+  }\n+\n+  // We need to parse dynamic route params\n+  // and do URL normalization here.\n+  // TODO: move this into server-utils for re-use\n+  const { basePath, i18n, rewrites } = routesManifest\n+\n+  if (basePath) {\n+    req.url = removePathPrefix(req.url || '/', basePath)\n+  }\n+\n+  if (i18n) {\n+    const urlParts = (req.url || '/').split('?')\n+    const localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n+\n+    if (localeResult.detectedLocale) {\n+      req.url = `${localeResult.pathname}${\n+        urlParts[1] ? `?${urlParts[1]}` : ''\n+      }`\n+    }\n+  }\n+\n+  const parsedUrl = parse(req.url || '/', true)\n+  const pageIsDynamic = isDynamicRoute(srcPage)\n+\n+  const serverUtils = getUtils({\n+    page: srcPage,\n+    i18n,\n+    basePath,\n+    rewrites: Array.isArray(rewrites)\n+      ? { beforeFiles: [], afterFiles: rewrites, fallback: [] }\n+      : rewrites || {\n+          beforeFiles: [],\n+          afterFiles: [],\n+          fallback: [],\n+        },\n+    pageIsDynamic,\n+    trailingSlash: process.env.__NEXT_TRAILING_SLASH as any as boolean,\n+    caseSensitive: Boolean(routesManifest.caseSensitive),\n+  })\n+  const rewriteParamKeys = Object.keys(\n+    serverUtils.handleRewrites(req as any as BaseNextRequest, parsedUrl)\n+  )\n+  serverUtils.normalizeCdnUrl(req as any as BaseNextRequest, [\n+    ...rewriteParamKeys,\n+    ...Object.keys(serverUtils.defaultRouteRegex?.groups || {}),\n+  ])\n+\n+  const params: Record<string, undefined | string | string[]> =\n+    serverUtils.dynamicRouteMatcher\n+      ? serverUtils.dynamicRouteMatcher(parsedUrl.pathname || '') || {}\n+      : {}\n+\n+  const query = {\n+    ...parsedUrl.query,\n+    ...params,\n+  }\n+  serverUtils.normalizeQueryParams(query)\n+\n+  if (pageIsDynamic) {\n+    const result = serverUtils.normalizeDynamicRouteParams(query, true)\n+\n+    if (result.hasValidParams) {\n+      Object.assign(query, result.params)\n+    }\n+  }\n+\n+  // ensure instrumentation is registered and pass\n+  // onRequestError below\n+  const absoluteDistDir = path.join(dir, distDir)\n+  await ensureInstrumentationRegistered(absoluteDistDir)\n+\n+  try {\n+    const method = req.method || 'GET'\n+    const tracer = getTracer()\n+\n+    const activeSpan = tracer.getActiveScopeSpan()\n+\n+    const invokeRouteModule = async (span?: Span) => {\n+      await routeModule\n+        .render(req, res, {\n+          query,\n+          params,\n+          allowedRevalidateHeaderKeys: process.env\n+            .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n+          multiZoneDraftMode: Boolean(process.env.__NEXT_MULTI_ZONE_DRAFT_MODE),\n+          trustHostHeader: process.env\n+            .__NEXT_TRUST_HOST_HEADER as any as boolean,\n+          // TODO: get this from from runtime env so manifest\n+          // doesn't need to load\n+          previewProps: prerenderManifest.preview,\n+          propagateError: false,\n+          dev: isDev,\n+          page: 'VAR_DEFINITION_PAGE',\n+\n+          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n+            instrumentationOnRequestError(absoluteDistDir, ...args),\n+        })\n+        .finally(() => {\n+          if (!span) return\n+\n+          span.setAttributes({\n+            'http.status_code': res.statusCode,\n+            'next.rsc': false,\n+          })\n+\n+          const rootSpanAttributes = tracer.getRootSpanAttributes()\n+          // We were unable to get attributes, probably OTEL is not enabled\n+          if (!rootSpanAttributes) {\n+            return\n+          }\n+\n+          if (\n+            rootSpanAttributes.get('next.span_type') !==\n+            BaseServerSpan.handleRequest\n+          ) {\n+            console.warn(\n+              `Unexpected root span type '${rootSpanAttributes.get(\n+                'next.span_type'\n+              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n+            )\n+            return\n+          }\n+\n+          const route = rootSpanAttributes.get('next.route')\n+          if (route) {\n+            const name = `${method} ${route}`\n+\n+            span.setAttributes({\n+              'next.route': route,\n+              'http.route': route,\n+              'next.span_name': name,\n+            })\n+            span.updateName(name)\n+          } else {\n+            span.updateName(`${method} ${req.url}`)\n+          }\n+        })\n+    }\n+\n+    // TODO: activeSpan code path is for when wrapped by\n+    // next-server can be removed when this is no longer used\n+    if (activeSpan) {\n+      await invokeRouteModule(activeSpan)\n+    } else {\n+      await tracer.withPropagatedContext(req.headers, () =>\n+        tracer.trace(\n+          BaseServerSpan.handleRequest,\n+          {\n+            spanName: `${method} ${req.url}`,\n+            kind: SpanKind.SERVER,\n+            attributes: {\n+              'http.method': method,\n+              'http.target': req.url,\n+            },\n+          },\n+          invokeRouteModule\n+        )\n+      )\n+    }\n+  } catch (err) {\n+    // we re-throw in dev to show the error overlay\n+    if (isDev) {\n+      throw err\n+    }\n+    // this is technically an invariant as error handling\n+    // should be done inside of api-resolver onError\n+    sendError(res as NextApiResponse, 500, 'Internal Server Error')\n+  } finally {\n+    // We don't allow any waitUntil work in pages API routes currently\n+    // so if callback is present return with resolved promise since no\n+    // pending work\n+    ctx.waitUntil?.(Promise.resolve())\n+  }\n+}"
        },
        {
            "sha": "6856cb9166ae27da1287bfa0a036f9af7335fc6e",
            "filename": "packages/next/src/build/webpack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -120,7 +120,7 @@ export async function webpackBuildImpl(\n     reactProductionProfiling: NextBuildContext.reactProductionProfiling!,\n     noMangling: NextBuildContext.noMangling!,\n     clientRouterFilters: NextBuildContext.clientRouterFilters!,\n-    previewModeId: NextBuildContext.previewModeId!,\n+    previewProps: NextBuildContext.previewProps!,\n     allowedRevalidateHeaderKeys: NextBuildContext.allowedRevalidateHeaderKeys!,\n     fetchCacheKeyPrefix: NextBuildContext.fetchCacheKeyPrefix!,\n   }\n@@ -156,14 +156,6 @@ export async function webpackBuildImpl(\n           middlewareMatchers: entrypoints.middlewareMatchers,\n           compilerType: COMPILER_NAMES.edgeServer,\n           entrypoints: entrypoints.edgeServer,\n-          edgePreviewProps: {\n-            __NEXT_PREVIEW_MODE_ID:\n-              NextBuildContext.previewProps!.previewModeId,\n-            __NEXT_PREVIEW_MODE_ENCRYPTION_KEY:\n-              NextBuildContext.previewProps!.previewModeEncryptionKey,\n-            __NEXT_PREVIEW_MODE_SIGNING_KEY:\n-              NextBuildContext.previewProps!.previewModeSigningKey,\n-          },\n           ...info,\n         }),\n       ])"
        },
        {
            "sha": "200afb3e7afcad76d99807ef1936f843c4840df2",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -96,6 +96,7 @@ import {\n import { getRspackCore, getRspackReactRefresh } from '../shared/lib/get-rspack'\n import { RspackProfilingPlugin } from './webpack/plugins/rspack-profiling-plugin'\n import getWebpackBundler from '../shared/lib/get-webpack-bundler'\n+import type { NextBuildContext } from './build-context'\n \n type ExcludesFalse = <T>(x: T | false) => x is T\n type ClientEntries = {\n@@ -312,9 +313,10 @@ export default async function getBaseWebpackConfig(\n     supportedBrowsers,\n     clientRouterFilters,\n     fetchCacheKeyPrefix,\n-    edgePreviewProps,\n     isCompileMode,\n+    previewProps,\n   }: {\n+    previewProps: NonNullable<(typeof NextBuildContext)['previewProps']>\n     isCompileMode?: boolean\n     buildId: string\n     encryptionKey: string\n@@ -336,7 +338,6 @@ export default async function getBaseWebpackConfig(\n     jsConfigPath?: string\n     resolvedBaseUrl: ResolvedBaseUrl\n     supportedBrowsers: string[] | undefined\n-    edgePreviewProps?: Record<string, string>\n     clientRouterFilters?: {\n       staticFilter: ReturnType<\n         import('../shared/lib/bloom-filter').BloomFilter['export']\n@@ -2010,7 +2011,10 @@ export default async function getBaseWebpackConfig(\n           edgeEnvironments: {\n             __NEXT_BUILD_ID: buildId,\n             NEXT_SERVER_ACTIONS_ENCRYPTION_KEY: encryptionKey,\n-            ...edgePreviewProps,\n+            __NEXT_PREVIEW_MODE_ID: previewProps.previewModeId,\n+            __NEXT_PREVIEW_MODE_SIGNING_KEY: previewProps.previewModeSigningKey,\n+            __NEXT_PREVIEW_MODE_ENCRYPTION_KEY:\n+              previewProps.previewModeEncryptionKey,\n           },\n         }),\n       isClient &&"
        },
        {
            "sha": "0fd3db6bbe157551d4c7d865e597c893f17bb893",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -265,6 +265,21 @@ export function getDefineEnv({\n             needsExperimentalReact(config),\n         }\n       : undefined),\n+\n+    'process.env.__NEXT_MULTI_ZONE_DRAFT_MODE': JSON.stringify(\n+      config.experimental.multiZoneDraftMode\n+    ),\n+    'process.env.__NEXT_TRUST_HOST_HEADER': JSON.stringify(\n+      config.experimental.trustHostHeader\n+    ),\n+    'process.env.__NEXT_ALLOWED_REVALIDATE_HEADERS': JSON.stringify(\n+      config.experimental.allowedRevalidateHeaderKeys\n+    ),\n+    ...(isNodeServer\n+      ? {\n+          'process.env.__NEXT_RELATIVE_DIST_DIR': config.distDir,\n+        }\n+      : {}),\n   }\n \n   const userDefines = config.compiler?.define ?? {}"
        },
        {
            "sha": "f5f97f09a4da81bfea7b0b9bf184a580bcf89703",
            "filename": "packages/next/src/server/api-utils/node/api-resolver.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 22,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -3,7 +3,6 @@ import type { NextApiRequest, NextApiResponse } from '../../../shared/lib/utils'\n import type { PageConfig, ResponseLimit } from '../../../types'\n import type { __ApiPreviewProps } from '../.'\n import type { CookieSerializeOptions } from 'next/dist/compiled/cookie'\n-import type { ServerOnInstrumentationRequestError } from '../../app-render/types'\n \n import bytes from 'next/dist/compiled/bytes'\n import { generateETag } from '../../lib/etag'\n@@ -30,18 +29,16 @@ import {\n } from '../../../lib/constants'\n import { tryGetPreviewData } from './try-get-preview-data'\n import { parseBody } from './parse-body'\n-\n-type RevalidateFn = (config: {\n-  urlPath: string\n-  revalidateHeaders: { [key: string]: string | string[] }\n-  opts: { unstable_onlyGenerated?: boolean }\n-}) => Promise<void>\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from '../../lib/router-utils/router-server-context'\n+import type { InstrumentationOnRequestError } from '../../instrumentation/types'\n \n type ApiContext = __ApiPreviewProps & {\n   trustHostHeader?: boolean\n   allowedRevalidateHeaderKeys?: string[]\n   hostname?: string\n-  revalidate?: RevalidateFn\n   multiZoneDraftMode?: boolean\n   dev: boolean\n }\n@@ -288,7 +285,21 @@ async function revalidate(\n     }\n   }\n \n+  const internalRevalidate =\n+    routerServerGlobal[RouterServerContextSymbol]?.revalidate\n+\n   try {\n+    // We use the revalidate in router-server if available.\n+    // If we are operating without router-server (serverless)\n+    // we must go through network layer with fetch request\n+    if (internalRevalidate) {\n+      return await internalRevalidate({\n+        urlPath,\n+        revalidateHeaders,\n+        opts,\n+      })\n+    }\n+\n     if (context.trustHostHeader) {\n       const res = await fetch(`https://${req.headers.host}${urlPath}`, {\n         method: 'HEAD',\n@@ -307,15 +318,9 @@ async function revalidate(\n       ) {\n         throw new Error(`Invalid response ${res.status}`)\n       }\n-    } else if (context.revalidate) {\n-      await context.revalidate({\n-        urlPath,\n-        revalidateHeaders,\n-        opts,\n-      })\n     } else {\n       throw new Error(\n-        `Invariant: required internal revalidate method not passed to api-utils`\n+        `Invariant: missing internal router-server-methods this is an internal bug`\n       )\n     }\n   } catch (err: unknown) {\n@@ -334,7 +339,7 @@ export async function apiResolver(\n   propagateError: boolean,\n   dev?: boolean,\n   page?: string,\n-  onError?: ServerOnInstrumentationRequestError\n+  onError?: InstrumentationOnRequestError\n ): Promise<void> {\n   const apiReq = req as NextApiRequest\n   const apiRes = res as NextApiResponse\n@@ -445,12 +450,20 @@ export async function apiResolver(\n       }\n     }\n   } catch (err) {\n-    onError?.(err, req, {\n-      routerKind: 'Pages Router',\n-      routePath: page || '',\n-      routeType: 'route',\n-      revalidateReason: undefined,\n-    })\n+    await onError?.(\n+      err,\n+      {\n+        method: req.method || 'GET',\n+        headers: req.headers,\n+        path: req.url || '/',\n+      },\n+      {\n+        routerKind: 'Pages Router',\n+        routePath: page || '',\n+        routeType: 'route',\n+        revalidateReason: undefined,\n+      }\n+    )\n \n     if (err instanceof ApiError) {\n       sendError(apiRes, err.statusCode, err.message)"
        },
        {
            "sha": "fa89c6c8724f0eb200570de1ea4bb734a16114bb",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -1389,7 +1389,7 @@ export default abstract class Server<\n           }\n \n           if (pageIsDynamic || didRewrite) {\n-            utils.normalizeVercelUrl(req, [\n+            utils.normalizeCdnUrl(req, [\n               ...rewriteParamKeys,\n               ...Object.keys(utils.defaultRouteRegex?.groups || {}),\n             ])"
        },
        {
            "sha": "a31a91d8137321f445d1baf10e287013dae62038",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -3,6 +3,7 @@ import { basename, extname, join, relative, isAbsolute, resolve } from 'path'\n import { pathToFileURL } from 'url'\n import findUp from 'next/dist/compiled/find-up'\n import * as Log from '../build/output/log'\n+import * as ciEnvironment from '../server/ci-info'\n import { CONFIG_FILES, PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\n import { defaultConfig, normalizeConfig } from './config-shared'\n import type {\n@@ -234,7 +235,19 @@ function assignDefaults(\n     )\n   }\n \n-  const result = { ...defaultConfig, ...config }\n+  const result = {\n+    ...defaultConfig,\n+    ...config,\n+    experimental: {\n+      ...defaultConfig.experimental,\n+      ...config.experimental,\n+    },\n+  }\n+\n+  // ensure correct default is set for api-resolver revalidate handling\n+  if (!result.experimental?.trustHostHeader && ciEnvironment.hasNextSupport) {\n+    result.experimental.trustHostHeader = true\n+  }\n \n   if (\n     result.experimental?.allowDevelopmentBuild &&\n@@ -976,9 +989,6 @@ function assignDefaults(\n \n   const userProvidedOptimizePackageImports =\n     result.experimental?.optimizePackageImports || []\n-  if (!result.experimental) {\n-    result.experimental = {}\n-  }\n \n   result.experimental.optimizePackageImports = [\n     ...new Set(["
        },
        {
            "sha": "0f08d04c08fa1e3f74415717bcde4182f7710093",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -653,6 +653,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n         originalRedirects: this.config._originalRedirects,\n         runWebpackSpan: this.hotReloaderSpan,\n         appDir: this.appDir,\n+        previewProps: this.previewProps,\n       }\n \n       return webpackConfigSpan\n@@ -697,6 +698,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       dev: true,\n     })\n     const fallbackConfig = await getBaseWebpackConfig(this.dir, {\n+      previewProps: this.previewProps,\n       runWebpackSpan: this.hotReloaderSpan,\n       dev: true,\n       compilerType: COMPILER_NAMES.client,"
        },
        {
            "sha": "7ade954dfa4d38a91a64e80274a1ad508a6e6304",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -51,6 +51,10 @@ import type { ServerInitResult } from './render-server'\n import { filterInternalHeaders } from './server-ipc/utils'\n import { blockCrossSite } from './router-utils/block-cross-site'\n import { traceGlobals } from '../../trace/shared'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from './router-utils/router-server-context'\n \n const debug = setupDebug('next:router-server:main')\n const isNextFont = (pathname: string | null) =>\n@@ -646,6 +650,14 @@ export async function initialize(opts: {\n   // pre-initialize workers\n   const handlers = await renderServer.instance.initialize(renderServerOpts)\n \n+  // this must come after initialize of render server since it's\n+  // using initialized methods\n+  routerServerGlobal[RouterServerContextSymbol] = {\n+    dir: opts.dir,\n+    hostname: handlers.server.hostname,\n+    revalidate: handlers.server.revalidate.bind(handlers.server),\n+  }\n+\n   const logError = async (\n     type: 'uncaughtException' | 'unhandledRejection',\n     err: Error | undefined"
        },
        {
            "sha": "ff23fc84c62df364115e97b839892ec3c84f8e52",
            "filename": "packages/next/src/server/lib/router-utils/filesystem.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -73,24 +73,30 @@ export const buildCustomRoute = <T>(\n   item: T & { source: string },\n   basePath?: string,\n   caseSensitive?: boolean\n-): T & { match: PatchMatcher; check?: boolean } => {\n+): T & { match: PatchMatcher; check?: boolean; regex: string } => {\n   const restrictedRedirectPaths = ['/_next'].map((p) =>\n     basePath ? `${basePath}${p}` : p\n   )\n+  let builtRegex = ''\n   const match = getPathMatch(item.source, {\n     strict: true,\n     removeUnnamedParams: true,\n-    regexModifier: !(item as any).internal\n-      ? (regex: string) =>\n-          modifyRouteRegex(\n-            regex,\n-            type === 'redirect' ? restrictedRedirectPaths : undefined\n-          )\n-      : undefined,\n+    regexModifier: (regex: string) => {\n+      if (!(item as any).internal) {\n+        regex = modifyRouteRegex(\n+          regex,\n+          type === 'redirect' ? restrictedRedirectPaths : undefined\n+        )\n+      }\n+      builtRegex = regex\n+      return builtRegex\n+    },\n     sensitive: caseSensitive,\n   })\n+\n   return {\n     ...item,\n+    regex: builtRegex,\n     ...(type === 'rewrite' ? { check: true } : {}),\n     match,\n   }"
        },
        {
            "sha": "6c19dfd47335ee85ec2141be36d059e400e1b608",
            "filename": "packages/next/src/server/lib/router-utils/instrumentation-globals.external.ts",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -0,0 +1,75 @@\n+import path from 'node:path'\n+import isError from '../../../lib/is-error'\n+import { INSTRUMENTATION_HOOK_FILENAME } from '../../../lib/constants'\n+import type {\n+  InstrumentationModule,\n+  InstrumentationOnRequestError,\n+} from '../../instrumentation/types'\n+import { interopDefault } from '../../../lib/interop-default'\n+\n+let cachedInstrumentationModule: InstrumentationModule\n+\n+export async function getInstrumentationModule(\n+  distDir: string\n+): Promise<InstrumentationModule | undefined> {\n+  if (cachedInstrumentationModule && process.env.NODE_ENV === 'production') {\n+    return cachedInstrumentationModule\n+  }\n+\n+  try {\n+    cachedInstrumentationModule = interopDefault(\n+      await require(\n+        path.join(distDir, 'server', `${INSTRUMENTATION_HOOK_FILENAME}.js`)\n+      )\n+    )\n+    return cachedInstrumentationModule\n+  } catch (err: unknown) {\n+    if (\n+      isError(err) &&\n+      err.code !== 'ENOENT' &&\n+      err.code !== 'MODULE_NOT_FOUND' &&\n+      err.code !== 'ERR_MODULE_NOT_FOUND'\n+    ) {\n+      throw err\n+    }\n+  }\n+}\n+\n+let instrumentationModulePromise: Promise<any> | null = null\n+async function registerInstrumentation(distDir: string) {\n+  // Ensure registerInstrumentation is not called in production build\n+  if (process.env.NEXT_PHASE === 'phase-production-build') return\n+  if (!instrumentationModulePromise) {\n+    instrumentationModulePromise = getInstrumentationModule(distDir)\n+  }\n+  const instrumentation = await instrumentationModulePromise\n+  if (instrumentation?.register) {\n+    try {\n+      await instrumentation.register()\n+    } catch (err: any) {\n+      err.message = `An error occurred while loading instrumentation hook: ${err.message}`\n+      throw err\n+    }\n+  }\n+}\n+\n+export async function instrumentationOnRequestError(\n+  distDir: string,\n+  ...args: Parameters<InstrumentationOnRequestError>\n+) {\n+  const instrumentation = await getInstrumentationModule(distDir)\n+  try {\n+    await instrumentation?.onRequestError?.(...args)\n+  } catch (err) {\n+    // Log the soft error and continue, since the original error has already been thrown\n+    console.error('Error in instrumentation.onRequestError:', err)\n+  }\n+}\n+\n+let registerInstrumentationPromise: Promise<void> | null = null\n+export function ensureInstrumentationRegistered(distDir: string) {\n+  if (!registerInstrumentationPromise) {\n+    registerInstrumentationPromise = registerInstrumentation(distDir)\n+  }\n+  return registerInstrumentationPromise\n+}"
        },
        {
            "sha": "c76d3ae657a94589e4e7db67aaf0aa23f32bb0f1",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -0,0 +1,25 @@\n+export type RevalidateFn = (config: {\n+  urlPath: string\n+  revalidateHeaders: { [key: string]: string | string[] }\n+  opts: { unstable_onlyGenerated?: boolean }\n+}) => Promise<void>\n+\n+// The RouterServerContext contains instance specific\n+// information that isn't available/relevant when\n+// deployed in serverless environments\n+export interface RouterServerContext {\n+  dir?: string\n+  // hostname the server is started with\n+  hostname?: string\n+  // revalidate function to bypass going through network\n+  // to invoke revalidate request (uses mocked req/res)\n+  revalidate?: RevalidateFn\n+}\n+\n+export const RouterServerContextSymbol = Symbol.for(\n+  '@next/router-server-methods'\n+)\n+\n+export const routerServerGlobal = globalThis as typeof globalThis & {\n+  [RouterServerContextSymbol]?: RouterServerContext\n+}"
        },
        {
            "sha": "28b60d8b6bfe6643a3d79615694210882a7f35da",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -5,6 +5,7 @@ import {\n   getPageStaticInfo,\n   type MiddlewareMatcher,\n } from '../../../build/analysis/get-page-static-info'\n+import type { RoutesManifest } from '../../../build'\n import type { MiddlewareRouteMatch } from '../../../shared/lib/router/utils/middleware-route-matcher'\n import type { PropagateToWorkersField } from './types'\n import type { NextJsHotReloaderInterface } from '../../dev/hot-reloader-types'\n@@ -53,6 +54,8 @@ import {\n   DEV_CLIENT_MIDDLEWARE_MANIFEST,\n   PHASE_DEVELOPMENT_SERVER,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n+  ROUTES_MANIFEST,\n+  PRERENDER_MANIFEST,\n } from '../../../shared/lib/constants'\n \n import { getMiddlewareRouteMatcher } from '../../../shared/lib/router/utils/middleware-route-matcher'\n@@ -194,6 +197,31 @@ async function startWatcher(opts: SetupOpts) {\n \n   await hotReloader.start()\n \n+  // have to write this after starting hot-reloader since that\n+  // cleans the dist dir\n+  const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n+  const routesManifest: Partial<RoutesManifest> = {\n+    version: 3,\n+    caseSensitive: !!nextConfig.experimental.caseSensitiveRoutes,\n+    basePath: nextConfig.basePath,\n+    rewrites: opts.fsChecker.rewrites,\n+    redirects: opts.fsChecker.redirects,\n+    headers: opts.fsChecker.headers,\n+    dataRoutes: [],\n+    i18n: nextConfig.i18n || undefined,\n+    skipMiddlewareUrlNormalize: nextConfig.skipMiddlewareUrlNormalize,\n+  }\n+  await fs.promises.writeFile(\n+    routesManifestPath,\n+    JSON.stringify(routesManifest)\n+  )\n+\n+  const prerenderManifestPath = path.join(distDir, PRERENDER_MANIFEST)\n+  await fs.promises.writeFile(\n+    prerenderManifestPath,\n+    JSON.stringify(opts.fsChecker.prerenderManifest, null, 2)\n+  )\n+\n   if (opts.nextConfig.experimental.nextScriptWorkers) {\n     await verifyPartytownSetup(\n       opts.dir,"
        },
        {
            "sha": "e3ab44bb2450a57c5d0f0f2b91fbef0a3c699613",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 48,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -18,7 +18,6 @@ import type { Params } from './request/params'\n import type { MiddlewareRouteMatch } from '../shared/lib/router/utils/middleware-route-matcher'\n import type { RouteMatch } from './route-matches/route-match'\n import type { IncomingMessage, ServerResponse } from 'http'\n-import type { PagesAPIRouteModule } from './route-modules/pages-api/module'\n import type { UrlWithParsedQuery } from 'url'\n import type { ParsedUrlQuery } from 'querystring'\n import type { ParsedUrl } from '../shared/lib/router/utils/parse-url'\n@@ -39,7 +38,6 @@ import {\n   APP_PATHS_MANIFEST,\n   SERVER_DIRECTORY,\n   NEXT_FONT_MANIFEST,\n-  PHASE_PRODUCTION_BUILD,\n   UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   FUNCTIONS_CONFIG_MANIFEST,\n } from '../shared/lib/constants'\n@@ -96,7 +94,6 @@ import { pipeToNodeResponse } from './pipe-readable'\n import { createRequestResponseMocks } from './lib/mock-request'\n import { NEXT_RSC_UNION_QUERY } from '../client/components/app-router-headers'\n import { signalFromNodeResponse } from './web/spec-extension/adapters/next-request'\n-import { RouteModuleLoader } from './lib/module-loader/route-module-loader'\n import { loadManifest } from './load-manifest'\n import { lazyRenderAppPage } from './route-modules/app-page/module.render'\n import { lazyRenderPagesPage } from './route-modules/pages/module.render'\n@@ -113,6 +110,7 @@ import { initializeCacheHandlers, setCacheHandler } from './use-cache/handlers'\n import type { UnwrapPromise } from '../lib/coalesced-function'\n import { populateStaticEnv } from '../lib/static-env'\n import { isPostpone } from './lib/router-utils/is-postpone'\n+import { NodeModuleLoader } from './lib/module-loader/node-module-loader'\n \n export * from './base-server'\n \n@@ -654,30 +652,24 @@ export default class NextNodeServer extends BaseServer<\n         }\n       }\n     }\n-\n     // The module supports minimal mode, load the minimal module.\n-    const module = await RouteModuleLoader.load<PagesAPIRouteModule>(\n-      match.definition.filename\n-    )\n-\n-    query = { ...query, ...match.params }\n-\n-    await module.render(req.originalRequest, res.originalResponse, {\n-      previewProps: this.renderOpts.previewProps,\n-      revalidate: this.revalidate.bind(this),\n-      trustHostHeader: this.nextConfig.experimental.trustHostHeader,\n-      allowedRevalidateHeaderKeys:\n-        this.nextConfig.experimental.allowedRevalidateHeaderKeys,\n-      hostname: this.fetchHostname,\n-      minimalMode: this.minimalMode,\n-      dev: this.renderOpts.dev === true,\n-      query,\n-      params: match.params,\n-      page: match.definition.pathname,\n-      onError: this.instrumentationOnRequestError.bind(this),\n-      multiZoneDraftMode: this.nextConfig.experimental.multiZoneDraftMode,\n+    // Restore original URL as the handler handles it's own parsing\n+    const parsedInitUrl = parseUrl(getRequestMeta(req, 'initURL') || req.url)\n+    req.url = `${parsedInitUrl.pathname}${parsedInitUrl.search || ''}`\n+\n+    const loader = new NodeModuleLoader()\n+    const module = (await loader.load(match.definition.filename)) as {\n+      handler: (\n+        req: IncomingMessage,\n+        res: ServerResponse,\n+        ctx: {\n+          waitUntil: ReturnType<BaseServer['getWaitUntil']>\n+        }\n+      ) => Promise<void>\n+    }\n+    await module.handler(req.originalRequest, res.originalResponse, {\n+      waitUntil: this.getWaitUntil(),\n     })\n-\n     return true\n   }\n \n@@ -1849,29 +1841,6 @@ export default class NextNodeServer extends BaseServer<\n     if (this._cachedPreviewManifest) {\n       return this._cachedPreviewManifest\n     }\n-    if (\n-      this.renderOpts?.dev ||\n-      this.serverOptions?.dev ||\n-      process.env.NODE_ENV === 'development' ||\n-      process.env.NEXT_PHASE === PHASE_PRODUCTION_BUILD\n-    ) {\n-      this._cachedPreviewManifest = {\n-        version: 4,\n-        routes: {},\n-        dynamicRoutes: {},\n-        notFoundRoutes: [],\n-        preview: {\n-          previewModeId: require('crypto').randomBytes(16).toString('hex'),\n-          previewModeSigningKey: require('crypto')\n-            .randomBytes(32)\n-            .toString('hex'),\n-          previewModeEncryptionKey: require('crypto')\n-            .randomBytes(32)\n-            .toString('hex'),\n-        },\n-      }\n-      return this._cachedPreviewManifest\n-    }\n \n     this._cachedPreviewManifest = loadManifest(\n       join(this.distDir, PRERENDER_MANIFEST)"
        },
        {
            "sha": "3752d5964ed0a4f82640a06d59664c0b91ae975a",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -78,6 +78,10 @@ interface NextWrapperServer {\n \n   logError(...args: Parameters<NextNodeServer['logError']>): void\n \n+  revalidate(\n+    ...args: Parameters<NextNodeServer['revalidate']>\n+  ): ReturnType<NextNodeServer['revalidate']>\n+\n   render(\n     ...args: Parameters<NextNodeServer['render']>\n   ): ReturnType<NextNodeServer['render']>\n@@ -157,6 +161,11 @@ export class NextServer implements NextWrapperServer {\n     }\n   }\n \n+  async revalidate(...args: Parameters<NextWrapperServer['revalidate']>) {\n+    const server = await this.getServer()\n+    return server.revalidate(...args)\n+  }\n+\n   async render(...args: Parameters<NextWrapperServer['render']>) {\n     const server = await this.getServer()\n     return server.render(...args)\n@@ -424,6 +433,10 @@ class NextCustomServer implements NextWrapperServer {\n     this.server.logError(...args)\n   }\n \n+  async revalidate(...args: Parameters<NextWrapperServer['revalidate']>) {\n+    return this.server.revalidate(...args)\n+  }\n+\n   async renderToHTML(...args: Parameters<NextWrapperServer['renderToHTML']>) {\n     return this.server.renderToHTML(...args)\n   }"
        },
        {
            "sha": "96d569cbf8afb8d89edf516e9f3d6ab12d60e0ef",
            "filename": "packages/next/src/server/route-modules/pages-api/module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 15,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -42,17 +42,6 @@ type PagesAPIRouteHandlerContext = RouteModuleHandleContext & {\n    */\n   res?: ServerResponse\n \n-  /**\n-   * The revalidate method used by the `revalidate` API.\n-   *\n-   * @param config the configuration for the revalidation\n-   */\n-  revalidate: (config: {\n-    urlPath: string\n-    revalidateHeaders: { [key: string]: string | string[] }\n-    opts: { unstable_onlyGenerated?: boolean }\n-  }) => Promise<void>\n-\n   /**\n    * The hostname for the request.\n    */\n@@ -84,9 +73,10 @@ type PagesAPIRouteHandlerContext = RouteModuleHandleContext & {\n   dev: boolean\n \n   /**\n-   * True if the server is in minimal mode.\n+   * Whether errors should be left uncaught to handle\n+   * higher up\n    */\n-  minimalMode: boolean\n+  propagateError: boolean\n \n   /**\n    * The page that's being rendered.\n@@ -149,14 +139,13 @@ export class PagesAPIRouteModule extends RouteModule<\n       this.userland,\n       {\n         ...context.previewProps,\n-        revalidate: context.revalidate,\n         trustHostHeader: context.trustHostHeader,\n         allowedRevalidateHeaderKeys: context.allowedRevalidateHeaderKeys,\n         hostname: context.hostname,\n         multiZoneDraftMode: context.multiZoneDraftMode,\n         dev: context.dev,\n       },\n-      context.minimalMode,\n+      context.propagateError,\n       context.dev,\n       context.page,\n       context.onError"
        },
        {
            "sha": "25822ab35632e598d71c828a101d1e117b1ad662",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 4,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -24,13 +24,14 @@ import {\n } from '../lib/constants'\n import { normalizeNextQueryParam } from './web/utils'\n import type { IncomingHttpHeaders } from 'http'\n+import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n \n-export function normalizeVercelUrl(\n+export function normalizeCdnUrl(\n   req: BaseNextRequest,\n   paramKeys: string[],\n   defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n ) {\n-  // make sure to normalize req.url on Vercel to strip dynamic and rewrite\n+  // make sure to normalize req.url from CDNs to strip dynamic and rewrite\n   // params from the query which are added during routing\n   const _parsedUrl = parseUrl(req.url!, true)\n   delete (_parsedUrl as any).search\n@@ -362,11 +363,35 @@ export function getUtils({\n     return routeMatches\n   }\n \n+  function normalizeQueryParams(\n+    query: Record<string, string | string[] | undefined>\n+  ) {\n+    // this is used to pass query information in rewrites\n+    // but should not be exposed in final query\n+    delete query['nextInternalLocale']\n+\n+    for (const [key, value] of Object.entries(query)) {\n+      const normalizedKey = normalizeNextQueryParam(key)\n+      if (!normalizedKey) continue\n+\n+      // Remove the prefixed key from the query params because we want\n+      // to consume it for the dynamic route matcher.\n+      delete query[key]\n+\n+      if (typeof value === 'undefined') continue\n+\n+      query[normalizedKey] = Array.isArray(value)\n+        ? value.map((v) => decodeQueryPathParameter(v))\n+        : decodeQueryPathParameter(value)\n+    }\n+  }\n+\n   return {\n     handleRewrites,\n     defaultRouteRegex,\n     dynamicRouteMatcher,\n     defaultRouteMatches,\n+    normalizeQueryParams,\n     getParamsFromRouteMatches,\n     /**\n      * Normalize dynamic route params.\n@@ -390,8 +415,8 @@ export function getUtils({\n         ignoreMissingOptional\n       )\n     },\n-    normalizeVercelUrl: (req: BaseNextRequest, paramKeys: string[]) =>\n-      normalizeVercelUrl(req, paramKeys, defaultRouteRegex),\n+    normalizeCdnUrl: (req: BaseNextRequest, paramKeys: string[]) =>\n+      normalizeCdnUrl(req, paramKeys, defaultRouteRegex),\n     interpolateDynamicPath: (\n       pathname: string,\n       params: Record<string, undefined | string | string[]>"
        },
        {
            "sha": "0f21c4cf388dc6802a001bd5885966e720555e69",
            "filename": "packages/next/src/server/web-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -21,7 +21,7 @@ import { removeTrailingSlash } from '../shared/lib/router/utils/remove-trailing-\n import { isDynamicRoute } from '../shared/lib/router/utils'\n import {\n   interpolateDynamicPath,\n-  normalizeVercelUrl,\n+  normalizeCdnUrl,\n   normalizeDynamicRouteParams,\n } from './server-utils'\n import { getNamedRouteRegex } from '../shared/lib/router/utils/route-regex'\n@@ -186,7 +186,7 @@ export default class NextWebServer extends BaseServer<\n           normalizedParams,\n           routeRegex\n         )\n-        normalizeVercelUrl(req, Object.keys(routeRegex.routeKeys), routeRegex)\n+        normalizeCdnUrl(req, Object.keys(routeRegex.routeKeys), routeRegex)\n       }\n     }\n "
        },
        {
            "sha": "c7bc448544e668daa3588f2a32b1125e35ac6b90",
            "filename": "packages/next/src/server/web/get-edge-preview-props.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fget-edge-preview-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fget-edge-preview-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fget-edge-preview-props.ts?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -5,10 +5,7 @@\n  */\n export function getEdgePreviewProps() {\n   return {\n-    previewModeId:\n-      process.env.NODE_ENV === 'production'\n-        ? process.env.__NEXT_PREVIEW_MODE_ID!\n-        : 'development-id',\n+    previewModeId: process.env.__NEXT_PREVIEW_MODE_ID || '',\n     previewModeSigningKey: process.env.__NEXT_PREVIEW_MODE_SIGNING_KEY || '',\n     previewModeEncryptionKey:\n       process.env.__NEXT_PREVIEW_MODE_ENCRYPTION_KEY || '',"
        },
        {
            "sha": "96d337d6f5d44802ece3cf66ad6992413dc17c41",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 40,
            "deletions": 13,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/4e6c27befd32b405f252f147147622de7025bcdb/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4e6c27befd32b405f252f147147622de7025bcdb/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=4e6c27befd32b405f252f147147622de7025bcdb",
            "patch": "@@ -209,14 +209,27 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-\n-      expect(stderrOutput).toStartWith(\n-        ' ReferenceError: missingVar is not defined' +\n-          '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n+      if (isTurbopack) {\n+        expect(stderrOutput).toStartWith(\n+          ' ReferenceError: missingVar is not defined' +\n+            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n+            '\\n  1 | export default function handler(req, res) {' +\n+            \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\" +\n+            '\\n    |  ^'\n+        )\n+      } else {\n+        expect(stderrOutput).toStartWith(\n+          ' ReferenceError: missingVar is not defined' +\n+            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/hello.js:2:2)' +\n+            // TODO(veil): Why not ignore-listed?\n+            '\\n    at '\n+        )\n+        expect(stderrOutput).toContain(\n           '\\n  1 | export default function handler(req, res) {' +\n-          \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\" +\n-          '\\n    |  ^'\n-      )\n+            \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\" +\n+            '\\n    |  ^'\n+        )\n+      }\n \n       await expect(browser).toDisplayRedbox(`\n         {\n@@ -270,13 +283,27 @@ describe('server-side dev errors', () => {\n       })\n \n       const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n-      expect(stderrOutput).toStartWith(\n-        ' ReferenceError: missingVar is not defined' +\n-          '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n+      if (isTurbopack) {\n+        expect(stderrOutput).toStartWith(\n+          ' ReferenceError: missingVar is not defined' +\n+            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n+            '\\n  1 | export default function handler(req, res) {' +\n+            '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })' +\n+            '\\n    |  ^'\n+        )\n+      } else {\n+        expect(stderrOutput).toStartWith(\n+          ' ReferenceError: missingVar is not defined' +\n+            '\\n    at handler (../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js:2:2)' +\n+            // TODO(veil): Why not ignore-listed?\n+            '\\n    at'\n+        )\n+        expect(stderrOutput).toContain(\n           '\\n  1 | export default function handler(req, res) {' +\n-          '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })' +\n-          '\\n    |  ^'\n-      )\n+            '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })' +\n+            '\\n    |  ^'\n+        )\n+      }\n \n       await expect(browser).toDisplayRedbox(`\n         {"
        }
    ],
    "stats": {
        "total": 728,
        "additions": 592,
        "deletions": 136
    }
}