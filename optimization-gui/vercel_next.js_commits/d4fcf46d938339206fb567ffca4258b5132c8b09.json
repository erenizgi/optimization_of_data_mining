{
    "author": "wyattjoh",
    "message": "fix: mark the shared cache controls as external so it's memory is shared (#80588)\n\nThis PR refactors the default cache handler and shared cache controls to\nbe marked as external modules, improving build optimization and module\nboundaries.\n\n### Changes\n\n- **Marked shared cache controls as external**: Renamed\n`shared-cache-controls.ts` to `shared-cache-controls.external.ts` and\nupdated all imports\n- **Refactored default cache handler**: Moved the implementation to\n`default.external.ts` and converted the original file to a re-export\n- **Updated import paths**: Fixed the import path in\n`incremental-cache/index.ts` to reference the external module\n\n### Details\n\nThe changes ensure that both the default cache handler and shared cache\ncontrols are properly marked as external modules. This follows Next.js\nconventions for modules that should be treated as external dependencies\nduring the build process.\n\nThe refactoring maintains backward compatibility by using re-exports in\nthe original locations while moving the actual implementations to\n`.external.ts` files.",
    "sha": "d4fcf46d938339206fb567ffca4258b5132c8b09",
    "files": [
        {
            "sha": "88674f775ab09e14005a3b4ae01f766e73397317",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-app-route-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -37,7 +37,7 @@ const EdgeAppRouteLoader: webpack.LoaderDefinitionFunction<EdgeAppRouteLoaderQue\n \n     if (!cacheHandlers.default) {\n       cacheHandlers.default = require.resolve(\n-        '../../../../server/lib/cache-handlers/default'\n+        '../../../../server/lib/cache-handlers/default.external'\n       )\n     }\n "
        },
        {
            "sha": "db441d6a8173699c5ce328c3c2d08c3d8ece9695",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-ssr-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -89,7 +89,7 @@ const edgeSSRLoader: webpack.LoaderDefinitionFunction<EdgeSSRLoaderQuery> =\n \n     if (!cacheHandlers.default) {\n       cacheHandlers.default = require.resolve(\n-        '../../../../server/lib/cache-handlers/default'\n+        '../../../../server/lib/cache-handlers/default.external'\n       )\n     }\n "
        },
        {
            "sha": "5e6044207071e035e6b8e7bc4e319d818fa4ae7e",
            "filename": "packages/next/src/server/lib/cache-handlers/default.external.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Fdefault.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Fdefault.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Fdefault.external.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "previous_filename": "packages/next/src/server/lib/cache-handlers/default.ts"
        },
        {
            "sha": "2794b4c0bf19e72569d30f9ab0c5e59c293b6186",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -24,7 +24,7 @@ import {\n   PRERENDER_REVALIDATE_HEADER,\n } from '../../../lib/constants'\n import { toRoute } from '../to-route'\n-import { SharedCacheControls } from './shared-cache-controls'\n+import { SharedCacheControls } from './shared-cache-controls.external'\n import {\n   getPrerenderResumeDataCache,\n   getRenderResumeDataCache,"
        },
        {
            "sha": "02c428cbf1117ed32d832550dba0475d52f19102",
            "filename": "packages/next/src/server/lib/incremental-cache/shared-cache-controls.external.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.test.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -3,7 +3,7 @@ import type {\n   PrerenderManifestRoute,\n } from '../../../build'\n import { RenderingMode } from '../../../build/rendering-mode'\n-import { SharedCacheControls } from './shared-cache-controls'\n+import { SharedCacheControls } from './shared-cache-controls.external'\n \n describe('SharedCacheControls', () => {\n   let sharedCacheControls: SharedCacheControls",
            "previous_filename": "packages/next/src/server/lib/incremental-cache/shared-cache-controls.test.ts"
        },
        {
            "sha": "52394678c378b21a3ec3e233ee83a98853724e1a",
            "filename": "packages/next/src/server/lib/incremental-cache/shared-cache-controls.external.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fshared-cache-controls.external.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "previous_filename": "packages/next/src/server/lib/incremental-cache/shared-cache-controls.ts"
        },
        {
            "sha": "de98066909d425d51bc47486ad06be73b702627b",
            "filename": "packages/next/src/server/use-cache/handlers.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -1,4 +1,4 @@\n-import DefaultCacheHandler from '../lib/cache-handlers/default'\n+import DefaultCacheHandler from '../lib/cache-handlers/default.external'\n import type { CacheHandlerCompat } from '../lib/cache-handlers/types'\n \n const debug = process.env.NEXT_PRIVATE_DEBUG_CACHE"
        },
        {
            "sha": "c0198d7387fd0eabe8f09092665f6c6e7406ae4e",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/handler.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -1,7 +1,7 @@\n // @ts-check\n \n const defaultCacheHandler =\n-  require('next/dist/server/lib/cache-handlers/default').default\n+  require('next/dist/server/lib/cache-handlers/default.external').default\n \n /**\n  * @type {import('next/dist/server/lib/cache-handlers/types').CacheHandlerV2}"
        },
        {
            "sha": "6fe8f06b4b291f7edba99ebddad29c7b0530b395",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/legacy-handler.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -1,7 +1,7 @@\n // @ts-check\n \n const defaultCacheHandler =\n-  require('next/dist/server/lib/cache-handlers/default').default\n+  require('next/dist/server/lib/cache-handlers/default.external').default\n \n /**\n  * @type {import('next/dist/server/lib/cache-handlers/types').CacheHandler}"
        },
        {
            "sha": "c0f1900b22e56343ee75f63402ff98eb2a3c2339",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/instrumentation.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -1,4 +1,4 @@\n-import DefaultCacheHandler from 'next/dist/server/lib/cache-handlers/default'\n+import DefaultCacheHandler from 'next/dist/server/lib/cache-handlers/default.external'\n \n export function register() {\n   globalThis[Symbol.for('@next/cache-handlers')] = {"
        },
        {
            "sha": "43f3262ce0e7b3765ca11119547b94df7b9b7dfd",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/use-cache-unknown-cache-kind.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -16,7 +16,9 @@ const nextConfigWithCacheHandler: NextConfig = {\n   experimental: {\n     dynamicIO: true,\n     cacheHandlers: {\n-      custom: require.resolve('next/dist/server/lib/cache-handlers/default'),\n+      custom: require.resolve(\n+        'next/dist/server/lib/cache-handlers/default.external'\n+      ),\n     },\n   },\n }"
        },
        {
            "sha": "3a2f883b8245b32fb85c9e22f4bda63f3d259d8f",
            "filename": "test/e2e/app-dir/use-cache/next.config.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -13,7 +13,9 @@ const nextConfig = {\n       },\n     },\n     cacheHandlers: {\n-      custom: require.resolve('next/dist/server/lib/cache-handlers/default'),\n+      custom: require.resolve(\n+        'next/dist/server/lib/cache-handlers/default.external'\n+      ),\n     },\n   },\n   cacheHandler: require.resolve('./incremental-cache-handler'),"
        },
        {
            "sha": "e52062d48ab725c7df61498909f9b5fc3734b518",
            "filename": "test/integration/telemetry/next.config.use-cache",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -2,7 +2,7 @@ module.exports = {\n   experimental: {\n     dynamicIO: true,\n     cacheHandlers: {\n-      custom: require.resolve('next/dist/server/lib/cache-handlers/default'),\n+      custom: require.resolve('next/dist/server/lib/cache-handlers/default.external'),\n     },\n   },\n }"
        },
        {
            "sha": "283beaa1f3ab4c1bb503c3fa791fa4ba6f10f9db",
            "filename": "test/production/custom-server/cache-handler.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fproduction%2Fcustom-server%2Fcache-handler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4fcf46d938339206fb567ffca4258b5132c8b09/test%2Fproduction%2Fcustom-server%2Fcache-handler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fcache-handler.js?ref=d4fcf46d938339206fb567ffca4258b5132c8b09",
            "patch": "@@ -3,7 +3,7 @@\n const { requestIdStorage } = require('./als')\n \n const defaultCacheHandler =\n-  require('next/dist/server/lib/cache-handlers/default').default\n+  require('next/dist/server/lib/cache-handlers/default.external').default\n \n /**\n  * @type {import('next/dist/server/lib/cache-handlers/types').CacheHandlerV2}"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 16,
        "deletions": 12
    }
}