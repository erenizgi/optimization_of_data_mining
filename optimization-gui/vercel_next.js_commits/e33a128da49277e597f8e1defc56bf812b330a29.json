{
    "author": "styfle",
    "message": "BREAKING CHANGE!: next/image only allow quality 75 by default (#83175)\n\n## Background\nWe have default allowlists for the `url` (localPatterns/remotePatterns\nconfig) and `w` (imageSizes/deviceSizes config) but we don't have a\ndefault allowlist for `q` (currently opt-in with via qualities config).\n\n## What's changing?\nBREAKING CHANGE: This PR is a breaking change that sets the default\nallowlist to `qualities: [75]`, meaning that anything other than 75 is\ninvalid. Since most images don't set the quality prop and therefore\ndefault to 75, most apps will be unaffected.\n\nHowever, we can be even more gracious when users upgrade because we can\ncoerce the value automatically to 75 (or rather any value in `qualities`\nallowlist). In dev, this will print a warning explaining why the prop\nwas not observed. This also works if you had `qualities` configured but\nremoved 75, since the closet matching value in the array will be used\ninstead.",
    "sha": "e33a128da49277e597f8e1defc56bf812b330a29",
    "files": [
        {
            "sha": "4b0505bbf8cd69ae956ddb9771397679e7819ecf",
            "filename": "docs/01-app/03-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -684,15 +684,33 @@ module.exports = {\n \n `qualities` allows you to specify a list of image quality values.\n \n+If not configuration is provided, the default below is used:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    qualities: [75],\n+  },\n+}\n+```\n+\n+> **Good to know**: This field is required starting with Next.js 16 because unrestricted access could allow malicious actors to optimize more qualities than you intended.\n+\n+You can add more image qualities to the allowlist, such as the following:\n+\n ```js filename=\"next.config.js\"\n module.exports = {\n   images: {\n-    qualities: [25, 50, 75],\n+    qualities: [25, 50, 75, 100],\n   },\n }\n ```\n \n-In the example above, only three qualities are allowed: 25, 50, and 75. If the [`quality`](#quality) prop does not match a value in this array, the image will fail with a `400` Bad Request.\n+In the example above, only four qualities are allowed: 25, 50, 75, and 100.\n+\n+If the [`quality`](#quality) prop does not match a value in this array, the closest allowed value will be used.\n+\n+If the REST API is visited directly with a quality that does not match a value in this array, the server will return a 400 Bad Request response.\n \n #### `formats`\n \n@@ -1251,6 +1269,7 @@ export default function Home() {\n \n | Version    | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n+| `v16.0.0`  | `qualities` default configuration changed to `[75]`.                                                                                                                                                                                                                                                                                                                                                                                                                                       |\n | `v15.3.0`  | `remotePatterns` added support for array of `URL` objects.                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n | `v15.0.0`  | `contentDispositionType` configuration default changed to `attachment`.                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | `v14.2.23` | `qualities` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |"
        },
        {
            "sha": "3567c911f0613e5c715a222c96fc09251e74a2e0",
            "filename": "packages/next/src/client/legacy/image.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 16,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Flegacy%2Fimage.tsx?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -23,13 +23,13 @@ import { useIntersection } from '../use-intersection'\n import { ImageConfigContext } from '../../shared/lib/image-config-context.shared-runtime'\n import { warnOnce } from '../../shared/lib/utils/warn-once'\n import { normalizePathTrailingSlash } from '../normalize-trailing-slash'\n+import { findClosestQuality } from '../../shared/lib/find-closest-quality'\n \n function normalizeSrc(src: string): string {\n   return src[0] === '/' ? src.slice(1) : src\n }\n \n const supportsFloat = typeof ReactDOM.preload === 'function'\n-const DEFAULT_Q = 75\n const configEnv = process.env.__NEXT_IMAGE_OPTS as any as ImageConfigComplete\n const loadedImageURLs = new Set<string>()\n const allImgs = new Map<\n@@ -188,21 +188,9 @@ function defaultLoader({\n         }\n       }\n     }\n-\n-    if (quality && config.qualities && !config.qualities.includes(quality)) {\n-      throw new Error(\n-        `Invalid quality prop (${quality}) on \\`next/image\\` does not match \\`images.qualities\\` configured in your \\`next.config.js\\`\\n` +\n-          `See more info: https://nextjs.org/docs/messages/next-image-unconfigured-qualities`\n-      )\n-    }\n   }\n \n-  const q =\n-    quality ||\n-    config.qualities?.reduce((prev, cur) =>\n-      Math.abs(cur - DEFAULT_Q) < Math.abs(prev - DEFAULT_Q) ? cur : prev\n-    ) ||\n-    DEFAULT_Q\n+  const q = findClosestQuality(quality, config)\n \n   if (!config.dangerouslyAllowSVG && src.split('?', 1)[0].endsWith('.svg')) {\n     // Special case to make svg serve as-is to avoid proxying\n@@ -859,9 +847,13 @@ export default function Image({\n         )\n       }\n \n-      if (qualityInt && qualityInt !== 75 && !config.qualities) {\n+      if (\n+        qualityInt &&\n+        config.qualities &&\n+        !config.qualities.includes(qualityInt)\n+      ) {\n         warnOnce(\n-          `Image with src \"${src}\" is using quality \"${qualityInt}\" which is not configured in images.qualities. This config will be required starting in Next.js 16.` +\n+          `Image with src \"${src}\" is using quality \"${qualityInt}\" which is not configured in images.qualities [${config.qualities.join(', ')}]. Please update your config to [${[...config.qualities, qualityInt].sort().join(', ')}].` +\n             `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-qualities`\n         )\n       }"
        },
        {
            "sha": "9f964bcd2716851e2ae00adfc81b37bd85d35266",
            "filename": "packages/next/src/shared/lib/find-closest-quality.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Ffind-closest-quality.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Ffind-closest-quality.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Ffind-closest-quality.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -0,0 +1,21 @@\n+import type { NextConfig } from '../../server/config-shared'\n+\n+/**\n+ * Find the closest matching `quality` in the list of `config.qualities`\n+ * @param quality the quality prop passed to the image component\n+ * @param config the \"images\" configuration from next.config.js\n+ * @returns the closest matching quality value\n+ */\n+export function findClosestQuality(\n+  quality: number | undefined,\n+  config: NextConfig['images'] | undefined\n+): number {\n+  const q = quality || 75\n+  if (!config?.qualities?.length) {\n+    return q\n+  }\n+  return config.qualities.reduce(\n+    (prev, cur) => (Math.abs(cur - q) < Math.abs(prev - q) ? cur : prev),\n+    0\n+  )\n+}"
        },
        {
            "sha": "3ebb05c5e2437c8582ce131c5efbaa3d8ed6210f",
            "filename": "packages/next/src/shared/lib/get-img-props.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -532,9 +532,13 @@ export function getImgProps(\n         )\n       }\n     }\n-    if (qualityInt && qualityInt !== 75 && !config.qualities) {\n+    if (\n+      qualityInt &&\n+      config.qualities &&\n+      !config.qualities.includes(qualityInt)\n+    ) {\n       warnOnce(\n-        `Image with src \"${src}\" is using quality \"${qualityInt}\" which is not configured in images.qualities. This config will be required starting in Next.js 16.` +\n+        `Image with src \"${src}\" is using quality \"${qualityInt}\" which is not configured in images.qualities [${config.qualities.join(', ')}]. Please update your config to [${[...config.qualities, qualityInt].sort().join(', ')}].` +\n           `\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-qualities`\n       )\n     }"
        },
        {
            "sha": "3934003395acd06e827bffc3e0496ec0b60c6c14",
            "filename": "packages/next/src/shared/lib/image-config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -142,6 +142,6 @@ export const imageConfigDefault: ImageConfigComplete = {\n   contentDispositionType: 'attachment',\n   localPatterns: undefined, // default: allow all local images\n   remotePatterns: [], // default: allow no remote images\n-  qualities: undefined, // default: allow all qualities\n+  qualities: [75],\n   unoptimized: false,\n }"
        },
        {
            "sha": "5eaa61217b8ab8e42381ab27c96686f0fc173f0e",
            "filename": "packages/next/src/shared/lib/image-loader.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -1,6 +1,5 @@\n import type { ImageLoaderPropsWithConfig } from './image-config'\n-\n-const DEFAULT_Q = 75\n+import { findClosestQuality } from './find-closest-quality'\n \n function defaultLoader({\n   config,\n@@ -78,21 +77,9 @@ function defaultLoader({\n         }\n       }\n     }\n-\n-    if (quality && config.qualities && !config.qualities.includes(quality)) {\n-      throw new Error(\n-        `Invalid quality prop (${quality}) on \\`next/image\\` does not match \\`images.qualities\\` configured in your \\`next.config.js\\`\\n` +\n-          `See more info: https://nextjs.org/docs/messages/next-image-unconfigured-qualities`\n-      )\n-    }\n   }\n \n-  const q =\n-    quality ||\n-    config.qualities?.reduce((prev, cur) =>\n-      Math.abs(cur - DEFAULT_Q) < Math.abs(prev - DEFAULT_Q) ? cur : prev\n-    ) ||\n-    DEFAULT_Q\n+  const q = findClosestQuality(quality, config)\n \n   return `${config.path}?url=${encodeURIComponent(src)}&w=${width}&q=${q}${\n     src.startsWith('/_next/static/media/') && process.env.NEXT_DEPLOYMENT_ID"
        },
        {
            "sha": "83e86aa0de01a0a1c82c185a4cd82de37b138811",
            "filename": "test/e2e/app-dir/next-image/next.config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -3,6 +3,7 @@ import type { NextConfig } from 'next'\n const nextConfig: NextConfig = {\n   images: {\n     remotePatterns: [new URL('https://image-optimization-test.vercel.app/**')],\n+    qualities: [50, 55, 60, 65, 70, 75, 80, 85, 90],\n   },\n }\n "
        },
        {
            "sha": "a5b1c7f96c129a2d5b5817efd6bba4c440431e16",
            "filename": "test/integration/image-optimizer/test/util.ts",
            "status": "modified",
            "additions": 111,
            "deletions": 93,
            "changes": 204,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -28,6 +28,7 @@ type SetupTestsCtx = {\n \n type RunTestsCtx = SetupTestsCtx & {\n   w: number\n+  q: number\n   app?: import('child_process').ChildProcess\n   appDir?: string\n   appPort?: number\n@@ -174,7 +175,7 @@ export function runTests(ctx: RunTestsCtx) {\n   if (domains.length > 0) {\n     it('should normalize invalid status codes', async () => {\n       const url = `http://localhost:${slowImageServer.port}/slow.png?delay=${1}&status=308`\n-      const query = { url, w: ctx.w, q: 39 }\n+      const query = { url, w: ctx.w, q: ctx.q }\n       const opts: RequestInit = {\n         headers: { accept: 'image/webp' },\n         redirect: 'manual',\n@@ -186,7 +187,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n     it('should timeout for upstream image exceeding 7 seconds', async () => {\n       const url = `http://localhost:${slowImageServer.port}/slow.png?delay=${8000}`\n-      const query = { url, w: ctx.w, q: 100 }\n+      const query = { url, w: ctx.w, q: ctx.q }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n       expect(res.status).toBe(504)\n     })\n@@ -198,13 +199,13 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should handle non-ascii characters in image url', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/äöüščří.png' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/äöüščří.png' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n   })\n \n   it('should maintain icns', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/test.icns' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.icns' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('Content-Type')).toContain('image/x-icns')\n@@ -220,7 +221,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain jxl', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/test.jxl' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.jxl' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('Content-Type')).toContain('image/jxl')\n@@ -236,7 +237,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain heic', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/test.heic' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.heic' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('Content-Type')).toContain('image/heic')\n@@ -252,7 +253,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain jp2', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/test.jp2' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.jp2' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('Content-Type')).toContain('image/jp2')\n@@ -268,7 +269,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain animated gif', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/animated.gif' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/animated.gif' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('content-type')).toContain('image/gif')\n@@ -285,7 +286,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain animated png', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/animated.png' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/animated.png' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('content-type')).toContain('image/png')\n@@ -302,7 +303,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain animated png 2', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/animated2.png' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/animated2.png' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('content-type')).toContain('image/png')\n@@ -319,7 +320,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain animated webp', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/animated.webp' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/animated.webp' }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(200)\n     expect(res.headers.get('content-type')).toContain('image/webp')\n@@ -336,15 +337,15 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should not forward cookie header', async () => {\n-    const query = { w: ctx.w, q: 30, url: '/api/conditional-cookie' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/api/conditional-cookie' }\n     const opts = { headers: { accept: 'image/webp', cookie: '1' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n   })\n \n   if (ctx.nextConfigImages?.dangerouslyAllowSVG) {\n     it('should maintain vector svg', async () => {\n-      const query = { w: ctx.w, q: 90, url: '/test.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/test.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(200)\n@@ -369,15 +370,15 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n   } else {\n     it('should not allow vector svg', async () => {\n-      const query = { w: ctx.w, q: 35, url: '/test.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/test.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(400)\n       expect(await res.text()).toContain('valid but image type is not allowed')\n     })\n \n     it('should not allow svg with application header', async () => {\n-      const query = { w: ctx.w, q: 45, url: '/api/application.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/api/application.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(400)\n@@ -387,7 +388,7 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n \n     it('should not allow svg with comma header', async () => {\n-      const query = { w: ctx.w, q: 55, url: '/api/comma.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/api/comma.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(400)\n@@ -397,7 +398,7 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n \n     it('should not allow svg with uppercase header', async () => {\n-      const query = { w: ctx.w, q: 65, url: '/api/uppercase.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/api/uppercase.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(400)\n@@ -407,7 +408,7 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n \n     it('should not allow svg with wrong header', async () => {\n-      const query = { w: ctx.w, q: 65, url: '/api/wrong-header.svg' }\n+      const query = { w: ctx.w, q: ctx.q, url: '/api/wrong-header.svg' }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(400)\n@@ -418,7 +419,7 @@ export function runTests(ctx: RunTestsCtx) {\n   }\n \n   it('should not allow pdf format', async () => {\n-    const query = { w: ctx.w, q: 90, url: '/test.pdf' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.pdf' }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n@@ -428,7 +429,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should maintain ico format', async () => {\n-    const query = { w: ctx.w, q: 90, url: `/test.ico` }\n+    const query = { w: ctx.w, q: ctx.q, url: `/test.ico` }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -452,7 +453,7 @@ export function runTests(ctx: RunTestsCtx) {\n   it('should maintain jpg format for old Safari', async () => {\n     const accept =\n       'image/png,image/svg+xml,image/*;q=0.8,video/*;q=0.8,*/*;q=0.5'\n-    const query = { w: ctx.w, q: 90, url: '/test.jpg' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.jpg' }\n     const opts = { headers: { accept } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -470,7 +471,7 @@ export function runTests(ctx: RunTestsCtx) {\n   it('should maintain png format for old Safari', async () => {\n     const accept =\n       'image/png,image/svg+xml,image/*;q=0.8,video/*;q=0.8,*/*;q=0.5'\n-    const query = { w: ctx.w, q: 75, url: '/test.png' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.png' }\n     const opts = { headers: { accept } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -488,7 +489,7 @@ export function runTests(ctx: RunTestsCtx) {\n   it('should downlevel webp format to jpeg for old Safari', async () => {\n     const accept =\n       'image/png,image/svg+xml,image/*;q=0.8,video/*;q=0.8,*/*;q=0.5'\n-    const query = { w: ctx.w, q: 74, url: '/test.webp' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.webp' }\n     const opts = { headers: { accept } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -507,7 +508,7 @@ export function runTests(ctx: RunTestsCtx) {\n   it('should downlevel avif format to jpeg for old Safari', async () => {\n     const accept =\n       'image/png,image/svg+xml,image/*;q=0.8,video/*;q=0.8,*/*;q=0.5'\n-    const query = { w: ctx.w, q: 74, url: '/test.avif' }\n+    const query = { w: ctx.w, q: ctx.q, url: '/test.avif' }\n     const opts = { headers: { accept } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -524,14 +525,14 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when url is missing', async () => {\n-    const query = { w: ctx.w, q: 100 }\n+    const query = { w: ctx.w, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(`\"url\" parameter is required`)\n   })\n \n   it('should fail when w is missing', async () => {\n-    const query = { url: '/test.png', q: 100 }\n+    const query = { url: '/test.png', q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(`\"w\" parameter (width) is required`)\n@@ -562,8 +563,19 @@ export function runTests(ctx: RunTestsCtx) {\n     )\n   })\n \n+  if (ctx?.nextConfigImages?.qualities) {\n+    it('should fail when q is not in config', async () => {\n+      const query = { url: '/test.png', w: ctx.w, q: 13 }\n+      const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n+      expect(res.status).toBe(400)\n+      expect(await res.text()).toBe(\n+        `\"q\" parameter (quality) of 13 is not allowed`\n+      )\n+    })\n+  }\n+\n   it('should fail when w is 0', async () => {\n-    const query = { url: '/test.png', w: 0, q: 100 }\n+    const query = { url: '/test.png', w: 0, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -572,7 +584,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when w is less than 0', async () => {\n-    const query = { url: '/test.png', w: -100, q: 100 }\n+    const query = { url: '/test.png', w: -100, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -581,7 +593,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when w is not a number', async () => {\n-    const query = { url: '/test.png', w: 'foo', q: 100 }\n+    const query = { url: '/test.png', w: 'foo', q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -590,7 +602,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when w is not an integer', async () => {\n-    const query = { url: '/test.png', w: 99.9, q: 100 }\n+    const query = { url: '/test.png', w: 99.9, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -618,15 +630,15 @@ export function runTests(ctx: RunTestsCtx) {\n \n   it('should fail when domain is not defined in next.config.js', async () => {\n     const url = `http://vercel.com/button`\n-    const query = { url, w: ctx.w, q: 100 }\n+    const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(`\"url\" parameter is not allowed`)\n   })\n \n   it('should fail when width is not in next.config.js', async () => {\n-    const query = { url: '/test.png', w: 1000, q: 100 }\n+    const query = { url: '/test.png', w: 1000, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n@@ -668,7 +680,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url and webp Firefox accept header', async () => {\n-    const query = { url: '/test.png', w: ctx.w, q: 80 }\n+    const query = { url: '/test.png', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp,*/*' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -685,7 +697,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url and png accept header', async () => {\n-    const query = { url: '/test.png', w: ctx.w, q: 80 }\n+    const query = { url: '/test.png', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/png' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -702,7 +714,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url with invalid accept header as png', async () => {\n-    const query = { url: '/test.png', w: ctx.w, q: 80 }\n+    const query = { url: '/test.png', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/invalid' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -719,7 +731,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url with invalid accept header as gif', async () => {\n-    const query = { url: '/test.gif', w: ctx.w, q: 80 }\n+    const query = { url: '/test.gif', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/invalid' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -736,7 +748,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url with invalid accept header as tiff', async () => {\n-    const query = { url: '/test.tiff', w: ctx.w, q: 80 }\n+    const query = { url: '/test.tiff', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/invalid' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -753,7 +765,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize gif (not animated)', async () => {\n-    const query = { url: '/test.gif', w: ctx.w, q: 75 }\n+    const query = { url: '/test.gif', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -770,7 +782,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize tiff', async () => {\n-    const query = { url: '/test.tiff', w: ctx.w, q: 75 }\n+    const query = { url: '/test.tiff', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -787,7 +799,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize avif', async () => {\n-    const query = { url: '/test.avif', w: ctx.w, q: 75 }\n+    const query = { url: '/test.avif', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -804,7 +816,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should resize relative url and old Chrome accept header as webp', async () => {\n-    const query = { url: '/test.png', w: ctx.w, q: 80 }\n+    const query = { url: '/test.png', w: ctx.w, q: ctx.q }\n     const opts = {\n       headers: { accept: 'image/webp,image/apng,image/*,*/*;q=0.8' },\n     }\n@@ -824,7 +836,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n   if (avifEnabled) {\n     it('should resize relative url and new Chrome accept header as avif', async () => {\n-      const query = { url: '/test.png', w: ctx.w, q: 80 }\n+      const query = { url: '/test.png', w: ctx.w, q: ctx.q }\n       const opts = {\n         headers: {\n           accept: 'image/avif,image/webp,image/apng,image/*,*/*;q=0.8',\n@@ -845,7 +857,7 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n \n     it('should resize avif and maintain format', async () => {\n-      const query = { url: '/test.avif', w: ctx.w, q: 75 }\n+      const query = { url: '/test.avif', w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/avif' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(200)\n@@ -877,7 +889,7 @@ export function runTests(ctx: RunTestsCtx) {\n   if (domains.length > 0) {\n     it('should resize absolute url from localhost', async () => {\n       const url = `http://localhost:${ctx.appPort}/test.png`\n-      const query = { url, w: ctx.w, q: 80 }\n+      const query = { url, w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(200)\n@@ -900,7 +912,7 @@ export function runTests(ctx: RunTestsCtx) {\n       expect(resOrig.headers.get('Content-Type')).toBe(\n         'application/octet-stream'\n       )\n-      const query = { url, w: ctx.w, q: 80 }\n+      const query = { url, w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/webp' } }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n       expect(res.status).toBe(200)\n@@ -923,14 +935,8 @@ export function runTests(ctx: RunTestsCtx) {\n       await cleanImagesDir(ctx)\n       const delay = 500\n \n-      if (globalThis.isrImgQuality) {\n-        globalThis.isrImgQuality++\n-      } else {\n-        globalThis.isrImgQuality = 40\n-      }\n-\n       const url = `http://localhost:${slowImageServer.port}/slow.png?delay=${delay}`\n-      const query = { url, w: ctx.w, q: globalThis.isrImgQuality }\n+      const query = { url, w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/webp' } }\n \n       const one = await fetchWithDuration(\n@@ -1037,7 +1043,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n   it('should fail when url has file protocol', async () => {\n     const url = `file://localhost:${ctx.appPort}/test.png`\n-    const query = { url, w: ctx.w, q: 80 }\n+    const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n@@ -1046,22 +1052,22 @@ export function runTests(ctx: RunTestsCtx) {\n \n   it('should fail when url has ftp protocol', async () => {\n     const url = `ftp://localhost:${ctx.appPort}/test.png`\n-    const query = { url, w: ctx.w, q: 80 }\n+    const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(`\"url\" parameter is invalid`)\n   })\n \n   it('should fail when url is too long', async () => {\n-    const query = { url: `/${'a'.repeat(4000)}`, w: ctx.w, q: 1 }\n+    const query = { url: `/${'a'.repeat(4000)}`, w: ctx.w, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(`\"url\" parameter is too long`)\n   })\n \n   it('should fail when url is protocol relative', async () => {\n-    const query = { url: `//example.com`, w: ctx.w, q: 1 }\n+    const query = { url: `//example.com`, w: ctx.w, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -1071,7 +1077,11 @@ export function runTests(ctx: RunTestsCtx) {\n \n   describe('recursive url is not allowed', () => {\n     it('should fail with relative next image url', async () => {\n-      const query = { url: `/_next/image?url=test.pngw=1&q=1`, w: ctx.w, q: 1 }\n+      const query = {\n+        url: `/_next/image?url=test.pngw=1&q=75`,\n+        w: ctx.w,\n+        q: ctx.q,\n+      }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n       expect(res.status).toBe(400)\n       expect(await res.text()).toBe(`\"url\" parameter cannot be recursive`)\n@@ -1081,7 +1091,7 @@ export function runTests(ctx: RunTestsCtx) {\n       const query = {\n         url: '%2F_next%2Fimage%3Furl%3Dtest.pngw%3D1%26q%3D1',\n         w: ctx.w,\n-        q: 1,\n+        q: ctx.q,\n       }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n       expect(res.status).toBe(400)\n@@ -1092,7 +1102,7 @@ export function runTests(ctx: RunTestsCtx) {\n       it('should pass with absolute next image url', async () => {\n         const fullUrl =\n           'https://image-optimization-test.vercel.app/_next/image?url=%2Ffrog.jpg&w=1024&q=75'\n-        const query = { url: fullUrl, w: ctx.w, q: 1 }\n+        const query = { url: fullUrl, w: ctx.w, q: ctx.q }\n         const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n         expect(res.status).toBe(200)\n         await expectWidth(res, ctx.w)\n@@ -1101,7 +1111,7 @@ export function runTests(ctx: RunTestsCtx) {\n       it('should fail with absolute next image url', async () => {\n         const fullUrl =\n           'https://image-optimization-test.vercel.app/_next/image?url=%2Ffrog.jpg&w=1024&q=75'\n-        const query = { url: fullUrl, w: ctx.w, q: 1 }\n+        const query = { url: fullUrl, w: ctx.w, q: ctx.q }\n         const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n         expect(res.status).toBe(400)\n         expect(await res.text()).toBe(`\"url\" parameter is not allowed`)\n@@ -1110,7 +1120,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n     it('should fail with relative image url with assetPrefix', async () => {\n       const fullUrl = '/assets/_next/image?url=%2Ftest.png&w=128&q=75'\n-      const query = { url: fullUrl, w: ctx.w, q: 1 }\n+      const query = { url: fullUrl, w: ctx.w, q: ctx.q }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n       expect(res.status).toBe(400)\n       expect(await res.text()).toBe(`\"url\" parameter cannot be recursive`)\n@@ -1119,7 +1129,7 @@ export function runTests(ctx: RunTestsCtx) {\n \n   it('should fail when internal url is not an image', async () => {\n     const url = `/api/no-header`\n-    const query = { url, w: ctx.w, q: 39 }\n+    const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n@@ -1131,7 +1141,7 @@ export function runTests(ctx: RunTestsCtx) {\n   if (domains.length > 0) {\n     it('should fail when url fails to load an image', async () => {\n       const url = `http://localhost:${ctx.appPort}/not-an-image`\n-      const query = { w: ctx.w, url, q: 100 }\n+      const query = { w: ctx.w, url, q: ctx.q }\n       const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n       expect(res.status).toBe(404)\n       expect(await res.text()).toBe(\n@@ -1146,16 +1156,10 @@ export function runTests(ctx: RunTestsCtx) {\n     }\n     await cleanImagesDir(ctx)\n \n-    if (globalThis.isrImgQuality) {\n-      globalThis.isrImgQuality++\n-    } else {\n-      globalThis.isrImgQuality = 80\n-    }\n-\n     const query = {\n       url: '/api/stateful/test.png',\n       w: ctx.w,\n-      q: globalThis.isrImgQuality,\n+      q: ctx.q,\n     }\n     const opts = { headers: { accept: 'image/webp' } }\n \n@@ -1259,7 +1263,7 @@ export function runTests(ctx: RunTestsCtx) {\n     it('should use cached image file when parameters are the same for svg', async () => {\n       await cleanImagesDir(ctx)\n \n-      const query = { url: '/test.svg', w: ctx.w, q: 80 }\n+      const query = { url: '/test.svg', w: ctx.w, q: ctx.q }\n       const opts = { headers: { accept: 'image/webp' } }\n \n       const res1 = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n@@ -1299,7 +1303,7 @@ export function runTests(ctx: RunTestsCtx) {\n     }\n     await cleanImagesDir(ctx)\n \n-    const query = { url: '/animated.gif', w: ctx.w, q: 80 }\n+    const query = { url: '/animated.gif', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n \n     const res1 = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n@@ -1328,7 +1332,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should set 304 status without body when etag matches if-none-match', async () => {\n-    const query = { url: '/test.jpg', w: ctx.w, q: 80 }\n+    const query = { url: '/test.jpg', w: ctx.w, q: ctx.q }\n     const opts1 = { headers: { accept: 'image/webp' } }\n \n     const res1 = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts1)\n@@ -1357,27 +1361,35 @@ export function runTests(ctx: RunTestsCtx) {\n     expect(res2.headers.get('Content-Disposition')).toBeFalsy()\n     expect((await res2.buffer()).length).toBe(0)\n \n-    const query3 = { url: '/test.jpg', w: ctx.w, q: 25 }\n-    const res3 = await fetchViaHTTP(ctx.appPort, '/_next/image', query3, opts2)\n-    expect(res3.status).toBe(200)\n-    expect(res3.headers.get('Content-Type')).toBe('image/webp')\n-    expect(res3.headers.get('Cache-Control')).toBe(\n-      `public, max-age=${isDev ? 0 : minimumCacheTTL}, must-revalidate`\n-    )\n-    expect(res3.headers.get('Vary')).toBe('Accept')\n-    expect(res3.headers.get('Etag')).toBeTruthy()\n-    expect(res3.headers.get('Etag')).not.toBe(etag)\n-    expect(res3.headers.get('Content-Disposition')).toBe(\n-      `${contentDispositionType}; filename=\"test.webp\"`\n-    )\n-    await expectWidth(res3, ctx.w)\n+    if (ctx?.nextConfigImages?.qualities) {\n+      const q = ctx.nextConfigImages.qualities[0]\n+      const query3 = { url: '/test.jpg', w: ctx.w, q }\n+      const res3 = await fetchViaHTTP(\n+        ctx.appPort,\n+        '/_next/image',\n+        query3,\n+        opts2\n+      )\n+      expect(res3.status).toBe(200)\n+      expect(res3.headers.get('Content-Type')).toBe('image/webp')\n+      expect(res3.headers.get('Cache-Control')).toBe(\n+        `public, max-age=${isDev ? 0 : minimumCacheTTL}, must-revalidate`\n+      )\n+      expect(res3.headers.get('Vary')).toBe('Accept')\n+      expect(res3.headers.get('Etag')).toBeTruthy()\n+      expect(res3.headers.get('Etag')).not.toBe(etag)\n+      expect(res3.headers.get('Content-Disposition')).toBe(\n+        `${contentDispositionType}; filename=\"test.webp\"`\n+      )\n+      await expectWidth(res3, ctx.w)\n+    }\n   })\n \n   it('should maintain bmp', async () => {\n     const json1 = await fsToJson(ctx.imagesDir)\n     expect(json1).toBeTruthy()\n \n-    const query = { url: '/test.bmp', w: ctx.w, q: 80 }\n+    const query = { url: '/test.bmp', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/invalid' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -1409,7 +1421,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should not resize if requested width is larger than original source image', async () => {\n-    const query = { url: '/test.jpg', w: largeSize, q: 80 }\n+    const query = { url: '/test.jpg', w: largeSize, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(200)\n@@ -1431,7 +1443,7 @@ export function runTests(ctx: RunTestsCtx) {\n       const query = {\n         url: `/_next/static/media/${filename}.fab2915d.jpg`,\n         w: ctx.w,\n-        q: 100,\n+        q: ctx.q,\n       }\n       const opts = { headers: { accept: 'image/webp' } }\n \n@@ -1461,15 +1473,15 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it(\"should error if the resource isn't a valid image\", async () => {\n-    const query = { url: '/test.txt', w: ctx.w, q: 80 }\n+    const query = { url: '/test.txt', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\"The requested resource isn't a valid image.\")\n   })\n \n   it('should error if the image file does not exist', async () => {\n-    const query = { url: '/does_not_exist.jpg', w: ctx.w, q: 80 }\n+    const query = { url: '/does_not_exist.jpg', w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n     expect(res.status).toBe(400)\n@@ -1483,7 +1495,7 @@ export function runTests(ctx: RunTestsCtx) {\n       const query = {\n         url: `http://localhost:${slowImageServer.port}/slow.png?delay=${delay}`,\n         w: ctx.w,\n-        q: 80,\n+        q: ctx.q,\n       }\n       const opts = { headers: { accept: 'image/webp,*/*' } }\n       const [res1, res2, res3] = await Promise.all([\n@@ -1549,6 +1561,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n+      q: 75,\n       isDev: true,\n     }\n \n@@ -1582,6 +1595,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n+      q: 100,\n       isDev: true,\n       nextConfigImages: {\n         domains: [\n@@ -1594,6 +1608,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n         formats: ['image/avif', 'image/webp'] as any,\n         deviceSizes: [largeSize],\n         imageSizes: [size],\n+        qualities: [50, 75, 100],\n         ...ctx.nextConfigImages,\n       },\n     }\n@@ -1633,6 +1648,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n+      q: 75,\n       isDev: false,\n     }\n     beforeAll(async () => {\n@@ -1667,6 +1683,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     const curCtx: RunTestsCtx = {\n       ...ctx,\n       w: size,\n+      q: 100,\n       isDev: false,\n       nextConfigImages: {\n         domains: [\n@@ -1678,6 +1695,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n         ],\n         formats: ['image/avif', 'image/webp'] as any,\n         deviceSizes: [size, largeSize],\n+        qualities: [50, 75, 100],\n         ...ctx.nextConfigImages,\n       },\n     }"
        },
        {
            "sha": "36d9c8f0c6e2a4d9cf73564984a55c4f279c7593",
            "filename": "test/integration/next-image-legacy/default/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -923,7 +923,7 @@ function runTests(mode) {\n         .join('\\n')\n       await assertNoRedbox(browser)\n       expect(warnings).toMatch(\n-        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities. This config will be required starting in Next.js 16./gm\n+        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities \\[75\\]. Please update your config to \\[50, 75\\]./gm\n       )\n     })\n "
        },
        {
            "sha": "6f4efede5692052e1b943ffb256c2e5b7aac1783",
            "filename": "test/integration/next-image-new/app-dir-localpatterns/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -98,7 +98,7 @@ function runTests(mode: 'dev' | 'server') {\n           ],\n           minimumCacheTTL: 60,\n           path: '/_next/image',\n-          qualities: undefined,\n+          qualities: [75],\n           sizes: [\n             640, 750, 828, 1080, 1200, 1920, 2048, 3840, 16, 32, 48, 64, 96,\n             128, 256, 384,"
        },
        {
            "sha": "b3186ba9f9f2a3b6473512c8fb0021023924a4d9",
            "filename": "test/integration/next-image-new/app-dir-qualities/test/index.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -1,12 +1,10 @@\n /* eslint-env jest */\n \n import {\n-  assertHasRedbox,\n   assertNoRedbox,\n   fetchViaHTTP,\n   findPort,\n   getImagesManifest,\n-  getRedboxHeader,\n   killApp,\n   launchApp,\n   nextBuild,\n@@ -73,19 +71,16 @@ function runTests(mode: 'dev' | 'server') {\n     expect(res.status).toStrictEqual(200)\n   })\n \n-  it('should fail to load img when quality is 100', async () => {\n+  it('should coerce quality 100 to closest matching of 88', async () => {\n     const page = '/invalid-quality'\n     const browser = await webdriver(appPort, page)\n     if (mode === 'dev') {\n-      await assertHasRedbox(browser)\n-      expect(await getRedboxHeader(browser)).toMatch(\n-        /Invalid quality prop (.+) on `next\\/image` does not match `images.qualities` configured/g\n-      )\n-    } else {\n-      const url = await getSrc(browser, 'q-100')\n-      const res = await fetchViaHTTP(appPort, url)\n-      expect(res.status).toBe(400)\n+      await assertNoRedbox(browser)\n     }\n+    const url = await getSrc(browser, 'q-100')\n+    expect(url).toContain('&q=88') // coerced to closest matching of 88\n+    const res = await fetchViaHTTP(appPort, url)\n+    expect(res.status).toBe(200)\n   })\n \n   if (mode === 'server') {"
        },
        {
            "sha": "1a4abf5d717763431d38f580a2670001532e8119",
            "filename": "test/integration/next-image-new/app-dir/test/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -792,10 +792,10 @@ function runTests(mode: 'dev' | 'server') {\n     expect(await img.getAttribute('data-nimg')).toBe('fill')\n     expect(await img.getAttribute('sizes')).toBe('200px')\n     expect(await img.getAttribute('src')).toBe(\n-      '/_next/image?url=%2Ftest.jpg&w=3840&q=50'\n+      '/_next/image?url=%2Ftest.jpg&w=3840&q=75'\n     )\n     expect(await img.getAttribute('srcset')).toContain(\n-      '/_next/image?url=%2Ftest.jpg&w=640&q=50 640w,'\n+      '/_next/image?url=%2Ftest.jpg&w=640&q=75 640w,'\n     )\n     expect(await img.getAttribute('style')).toBe(\n       'position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:cover;object-position:10% 10%;color:transparent'\n@@ -1060,7 +1060,7 @@ function runTests(mode: 'dev' | 'server') {\n         .join('\\n')\n       await assertNoRedbox(browser)\n       expect(warnings).toMatch(\n-        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities. This config will be required starting in Next.js 16./gm\n+        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities \\[75\\]. Please update your config to \\[50, 75\\]./gm\n       )\n     })\n \n@@ -1636,7 +1636,7 @@ function runTests(mode: 'dev' | 'server') {\n           localPatterns: undefined,\n           minimumCacheTTL: 60,\n           path: '/_next/image',\n-          qualities: undefined,\n+          qualities: [75],\n           sizes: [\n             640, 750, 828, 1080, 1200, 1920, 2048, 3840, 16, 32, 48, 64, 96,\n             128, 256, 384,"
        },
        {
            "sha": "108131a03300cdcc14056be4c6dbd1572caef9a2",
            "filename": "test/integration/next-image-new/default/test/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -794,10 +794,10 @@ function runTests(mode) {\n     expect(await img.getAttribute('data-nimg')).toBe('fill')\n     expect(await img.getAttribute('sizes')).toBe('200px')\n     expect(await img.getAttribute('src')).toBe(\n-      '/_next/image?url=%2Ftest.jpg&w=3840&q=50'\n+      '/_next/image?url=%2Ftest.jpg&w=3840&q=75'\n     )\n     expect(await img.getAttribute('srcset')).toContain(\n-      '/_next/image?url=%2Ftest.jpg&w=640&q=50 640w,'\n+      '/_next/image?url=%2Ftest.jpg&w=640&q=75 640w,'\n     )\n     expect(await img.getAttribute('style')).toBe(\n       'position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:cover;object-position:10% 10%;color:transparent'\n@@ -1062,7 +1062,7 @@ function runTests(mode) {\n         .join('\\n')\n       await assertNoRedbox(browser)\n       expect(warnings).toMatch(\n-        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities. This config will be required starting in Next.js 16./gm\n+        /Image with src (.*)jpg(.*) is using quality \"50\" which is not configured in images.qualities \\[75\\]. Please update your config to \\[50, 75\\]/gm\n       )\n     })\n "
        },
        {
            "sha": "9f96725fad842e1d2d4af5bf21f4b2459ceeb2f5",
            "filename": "test/integration/next-image-new/loader-config-default-loader-with-file/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Floader-config-default-loader-with-file%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Floader-config-default-loader-with-file%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Floader-config-default-loader-with-file%2Fnext.config.js?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -2,5 +2,6 @@ module.exports = {\n   images: {\n     loader: 'default',\n     loaderFile: './dummy-loader.js',\n+    qualities: [50, 75],\n   },\n }"
        },
        {
            "sha": "388df8aac998248dc1c58d12fa0baa57a05e1fe9",
            "filename": "test/integration/next-image-new/unicode/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -96,6 +96,7 @@ function runTests(mode: 'server' | 'dev') {\n           ],\n           minimumCacheTTL: 60,\n           path: '/_next/image',\n+          qualities: [75],\n           sizes: [\n             640, 750, 828, 1080, 1200, 1920, 2048, 3840, 16, 32, 48, 64, 96,\n             128, 256, 384,"
        },
        {
            "sha": "de58283a03ac24c27e9eba7280abe422d2c8fd06",
            "filename": "test/integration/next-image-new/unoptimized/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -112,7 +112,7 @@ function runTests(url: string, mode: 'dev' | 'server') {\n           localPatterns: undefined,\n           minimumCacheTTL: 60,\n           path: '/_next/image',\n-          qualities: undefined,\n+          qualities: [75],\n           sizes: [\n             640, 750, 828, 1080, 1200, 1920, 2048, 3840, 16, 32, 48, 64, 96,\n             128, 256, 384,"
        },
        {
            "sha": "cacd0573f59d743ccf30de6a099ab62a51a851ef",
            "filename": "test/unit/image-optimizer/find-closest-quality.test.ts",
            "status": "added",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Funit%2Fimage-optimizer%2Ffind-closest-quality.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Funit%2Fimage-optimizer%2Ffind-closest-quality.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fimage-optimizer%2Ffind-closest-quality.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -0,0 +1,77 @@\n+/* eslint-env jest */\n+import { findClosestQuality } from 'next/dist/shared/lib/find-closest-quality'\n+\n+describe('findClosestQuality', () => {\n+  it.each<{ input: Parameters<typeof findClosestQuality>; output: number }>([\n+    {\n+      input: [undefined, undefined],\n+      output: 75,\n+    },\n+    {\n+      input: [50, undefined],\n+      output: 50,\n+    },\n+    {\n+      input: [50, { qualities: undefined }],\n+      output: 50,\n+    },\n+    {\n+      input: [35, { qualities: [10, 30, 50] }],\n+      output: 30,\n+    },\n+    {\n+      input: [30, { qualities: [10, 30, 50] }],\n+      output: 30,\n+    },\n+    {\n+      input: [31, { qualities: [10, 30, 50] }],\n+      output: 30,\n+    },\n+    {\n+      input: [29, { qualities: [10, 30, 50] }],\n+      output: 30,\n+    },\n+    {\n+      input: [39, { qualities: [10, 30, 50] }],\n+      output: 30,\n+    },\n+    {\n+      input: [40, { qualities: [10, 30, 50] }],\n+      output: 30, // favor the lower number when halfway\n+    },\n+    {\n+      input: [41, { qualities: [10, 30, 50] }],\n+      output: 50,\n+    },\n+    {\n+      input: [75, { qualities: [50, 75, 100] }],\n+      output: 75,\n+    },\n+    {\n+      input: [undefined, { qualities: [50, 75, 100] }],\n+      output: 75,\n+    },\n+    {\n+      input: [undefined, { qualities: [25, 60, 100] }],\n+      output: 60, // use closest to 75 when 75 is not in the config\n+    },\n+    {\n+      input: [undefined, { qualities: [25, 50, 75] }],\n+      output: 75, // use 75 when 75 is in the config\n+    },\n+    {\n+      input: [undefined, { qualities: [100, 10, 75, 15] }],\n+      output: 75, // use 75 when 75 is in the config, even out of order\n+    },\n+    {\n+      input: [10, { qualities: [100, 10, 75, 15] }],\n+      output: 10, // use input even when config is out of order\n+    },\n+    {\n+      input: [14, { qualities: [100, 10, 75, 15] }],\n+      output: 15, // use closet input even when config is out of order\n+    },\n+  ])('for quality $input expected $output', ({ input, output }) => {\n+    expect(findClosestQuality(...input)).toEqual(output)\n+  })\n+})"
        },
        {
            "sha": "3eed7d6bef2e7c2ec6e4a2e4b5a27705b9301f0a",
            "filename": "test/unit/next-image-get-img-props.test.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 4,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/e33a128da49277e597f8e1defc56bf812b330a29/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33a128da49277e597f8e1defc56bf812b330a29/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-image-get-img-props.test.ts?ref=e33a128da49277e597f8e1defc56bf812b330a29",
            "patch": "@@ -111,7 +111,7 @@ describe('getImageProps()', () => {\n       ['src', '/_next/image?url=%2Ftest.png&w=256&q=75'],\n     ])\n   })\n-  it('should handle quality', async () => {\n+  it('should handle quality coercion from 50 to 75', async () => {\n     const { props } = getImageProps({\n       alt: 'a nice desc',\n       id: 'my-image',\n@@ -121,7 +121,7 @@ describe('getImageProps()', () => {\n       quality: 50,\n     })\n     expect(warningMessages).toStrictEqual([\n-      'Image with src \"/test.png\" is using quality \"50\" which is not configured in images.qualities. This config will be required starting in Next.js 16.\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-qualities',\n+      'Image with src \"/test.png\" is using quality \"50\" which is not configured in images.qualities [75]. Please update your config to [50, 75].\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-qualities',\n     ])\n     expect(Object.entries(props)).toStrictEqual([\n       ['alt', 'a nice desc'],\n@@ -133,9 +133,34 @@ describe('getImageProps()', () => {\n       ['style', { color: 'transparent' }],\n       [\n         'srcSet',\n-        '/_next/image?url=%2Ftest.png&w=128&q=50 1x, /_next/image?url=%2Ftest.png&w=256&q=50 2x',\n+        '/_next/image?url=%2Ftest.png&w=128&q=75 1x, /_next/image?url=%2Ftest.png&w=256&q=75 2x',\n       ],\n-      ['src', '/_next/image?url=%2Ftest.png&w=256&q=50'],\n+      ['src', '/_next/image?url=%2Ftest.png&w=256&q=75'],\n+    ])\n+  })\n+  it('should handle quality exact match config and not warn', async () => {\n+    const { props } = getImageProps({\n+      alt: 'a nice desc',\n+      id: 'my-image',\n+      src: '/test.png',\n+      width: 100,\n+      height: 200,\n+      quality: 75,\n+    })\n+    expect(warningMessages).toStrictEqual([])\n+    expect(Object.entries(props)).toStrictEqual([\n+      ['alt', 'a nice desc'],\n+      ['id', 'my-image'],\n+      ['loading', 'lazy'],\n+      ['width', 100],\n+      ['height', 200],\n+      ['decoding', 'async'],\n+      ['style', { color: 'transparent' }],\n+      [\n+        'srcSet',\n+        '/_next/image?url=%2Ftest.png&w=128&q=75 1x, /_next/image?url=%2Ftest.png&w=256&q=75 2x',\n+      ],\n+      ['src', '/_next/image?url=%2Ftest.png&w=256&q=75'],\n     ])\n   })\n   it('should handle quality as a string and not warn', async () => {"
        }
    ],
    "stats": {
        "total": 449,
        "additions": 295,
        "deletions": 154
    }
}