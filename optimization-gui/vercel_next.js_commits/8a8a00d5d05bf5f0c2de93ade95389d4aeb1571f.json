{
    "author": "ztanner",
    "message": "Revert \"Move next-env.d.ts to dist dir\" (#87311)\n\nReverts vercel/next.js#86752\n\nThis has consequences when `.next` is in `exclude`. Reverting for now.",
    "sha": "8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
    "files": [
        {
            "sha": "211117216e8882a5b4c6fc7199bc87e35fa2d0ce",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -224,7 +224,6 @@ import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n   writeValidatorFile,\n-  writeDynamicTypesFile,\n } from '../server/lib/router-utils/route-types-utils'\n import { Lockfile } from './lockfile'\n import {\n@@ -1485,12 +1484,6 @@ export default async function build(\n             config\n           )\n           await writeValidatorFile(routeTypesManifest, validatorFilePath)\n-          await writeDynamicTypesFile({\n-            distDir,\n-            imageImportsEnabled: !config.images.disableStaticImages,\n-            hasPagesDir: !!pagesDir,\n-            hasAppDir: !!appDir,\n-          })\n         })\n \n       // Turbopack already handles conflicting app and page routes."
        },
        {
            "sha": "95fad78cedf3bbaec8623dcc54a74bfb0d5e38af",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -22,6 +22,7 @@ function verifyTypeScriptSetup(\n   distDir: string,\n   typeCheckPreflight: boolean,\n   tsconfigPath: string | undefined,\n+  disableStaticImages: boolean,\n   cacheDir: string | undefined,\n   enableWorkerThreads: boolean | undefined,\n   hasAppDir: boolean,\n@@ -51,6 +52,7 @@ function verifyTypeScriptSetup(\n       distDir,\n       typeCheckPreflight,\n       tsconfigPath,\n+      disableStaticImages,\n       cacheDir,\n       hasAppDir,\n       hasPagesDir,\n@@ -117,6 +119,7 @@ export async function startTypeChecking({\n           config.distDir,\n           !ignoreTypeScriptErrors,\n           config.typescript.tsconfigPath,\n+          config.images.disableStaticImages,\n           cacheDir,\n           config.experimental.workerThreads,\n           !!appDir,"
        },
        {
            "sha": "91a76a7e4a924e2d31199239d5ef0660577930e9",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -142,6 +142,7 @@ async function runPlaywright(\n       distDir: nextConfig.distDir,\n       typeCheckPreflight: false,\n       tsconfigPath: nextConfig.typescript.tsconfigPath,\n+      disableStaticImages: nextConfig.images.disableStaticImages,\n       hasAppDir: !!appDir,\n       hasPagesDir: !!pagesDir,\n       isolatedDevBuild: nextConfig.experimental.isolatedDevBuild,"
        },
        {
            "sha": "796a5d0e7332d401a2baab5c5130b3bd3c91a939",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -29,7 +29,6 @@ import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n   writeValidatorFile,\n-  writeDynamicTypesFile,\n } from '../server/lib/router-utils/route-types-utils'\n import { writeCacheLifeTypes } from '../server/lib/router-utils/cache-life-type-utils'\n import { createValidFileMatcher } from '../server/lib/find-page-file'\n@@ -60,6 +59,7 @@ const nextTypegen = async (\n     distDir: nextConfig.distDir,\n     typeCheckPreflight: false,\n     tsconfigPath: nextConfig.typescript.tsconfigPath,\n+    disableStaticImages: nextConfig.images.disableStaticImages,\n     hasAppDir: !!appDir,\n     hasPagesDir: !!pagesDir,\n     isolatedDevBuild: nextConfig.experimental.isolatedDevBuild,\n@@ -171,13 +171,6 @@ const nextTypegen = async (\n \n   await writeValidatorFile(routeTypesManifest, validatorFilePath)\n \n-  await writeDynamicTypesFile({\n-    distDir,\n-    imageImportsEnabled: !nextConfig.images.disableStaticImages,\n-    hasPagesDir: !!pagesDir,\n-    hasAppDir: !!appDir,\n-  })\n-\n   // Generate cache-life types if cacheLife config exists\n   const cacheLifeFilePath = join(distDir, 'types', 'cache-life.d.ts')\n   writeCacheLifeTypes(nextConfig.cacheLife, cacheLifeFilePath)"
        },
        {
            "sha": "772f9cfaa0493c551de98604af12d66d980999cb",
            "filename": "packages/next/src/lib/typescript/writeAppTypeDeclarations.ts",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -0,0 +1,82 @@\n+import os from 'os'\n+import path from 'path'\n+import { promises as fs } from 'fs'\n+\n+export async function writeAppTypeDeclarations({\n+  baseDir,\n+  distDir,\n+  imageImportsEnabled,\n+  hasPagesDir,\n+  hasAppDir,\n+}: {\n+  baseDir: string\n+  distDir: string\n+  imageImportsEnabled: boolean\n+  hasPagesDir: boolean\n+  hasAppDir: boolean\n+}): Promise<void> {\n+  // Reference `next` types\n+  const appTypeDeclarations = path.join(baseDir, 'next-env.d.ts')\n+\n+  // Defaults EOL to system default\n+  let eol = os.EOL\n+  let currentContent: string | undefined\n+\n+  try {\n+    currentContent = await fs.readFile(appTypeDeclarations, 'utf8')\n+    // If file already exists then preserve its line ending\n+    const lf = currentContent.indexOf('\\n', /* skip first so we can lf - 1 */ 1)\n+\n+    if (lf !== -1) {\n+      if (currentContent[lf - 1] === '\\r') {\n+        eol = '\\r\\n'\n+      } else {\n+        eol = '\\n'\n+      }\n+    }\n+  } catch {}\n+\n+  /**\n+   * \"Triple-slash directives\" used to create typings files for Next.js projects\n+   * using Typescript .\n+   *\n+   * @see https://www.typescriptlang.org/docs/handbook/triple-slash-directives.html\n+   */\n+  const directives: string[] = [\n+    // Include the core Next.js typings.\n+    '/// <reference types=\"next\" />',\n+  ]\n+\n+  if (imageImportsEnabled) {\n+    directives.push('/// <reference types=\"next/image-types/global\" />')\n+  }\n+\n+  if (hasAppDir && hasPagesDir) {\n+    directives.push(\n+      '/// <reference types=\"next/navigation-types/compat/navigation\" />'\n+    )\n+  }\n+\n+  const routeTypesPath = path.posix.join(\n+    distDir.replaceAll(path.win32.sep, path.posix.sep),\n+    'types/routes.d.ts'\n+  )\n+\n+  // Use ESM import instead of triple-slash reference for better ESLint compatibility\n+  directives.push(`import \"./${routeTypesPath}\";`)\n+\n+  // Push the notice in.\n+  directives.push(\n+    '',\n+    '// NOTE: This file should not be edited',\n+    `// see https://nextjs.org/docs/${hasAppDir ? 'app' : 'pages'}/api-reference/config/typescript for more information.`\n+  )\n+\n+  const content = directives.join(eol) + eol\n+\n+  // Avoids an un-necessary write on read-only fs\n+  if (currentContent === content) {\n+    return\n+  }\n+  await fs.writeFile(appTypeDeclarations, content)\n+}"
        },
        {
            "sha": "b4b7a73d1129aa4cc127601593d2396b982a2d30",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -84,6 +84,7 @@ describe('writeConfigurationDefaults()', () => {\n            \"node_modules\",\n          ],\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -106,7 +107,7 @@ describe('writeConfigurationDefaults()', () => {\n          \t- strict was set to false\n          \t- noEmit was set to true\n          \t- incremental was set to true\n-         \t- include was set to ['.next/types/**/*.ts', '.next/dev/types/**/*.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n+         \t- include was set to ['next-env.d.ts', '.next/types/**/*.ts', '.next/dev/types/**/*.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n          \t- plugins was updated to add { name: 'next' }\n          \t- exclude was set to ['node_modules']\n "
        },
        {
            "sha": "e8f452dc6e8f34751bb0784e0a9ae5aedb7bc029",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -282,16 +282,19 @@ export async function writeConfigurationDefaults(\n   )\n \n   if (!('include' in userTsConfig)) {\n-    // Always include .next/types for dynamic types (image imports, route types, etc.)\n-    userTsConfig.include = [...nextAppTypes, '**/*.mts', '**/*.ts', '**/*.tsx']\n+    userTsConfig.include = hasAppDir\n+      ? ['next-env.d.ts', ...nextAppTypes, '**/*.mts', '**/*.ts', '**/*.tsx']\n+      : ['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n     suggestedActions.push(\n       cyan('include') +\n         ' was set to ' +\n         bold(\n-          `[${nextAppTypes.map((type) => `'${type}'`).join(', ')}, '**/*.mts', '**/*.ts', '**/*.tsx']`\n+          hasAppDir\n+            ? `['next-env.d.ts', ${nextAppTypes.map((type) => `'${type}'`).join(', ')}, '**/*.mts', '**/*.ts', '**/*.tsx']`\n+            : `['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']`\n         )\n     )\n-  } else {\n+  } else if (hasAppDir) {\n     const missingFromResolved = []\n     for (const type of nextAppTypes) {\n       if (!userTsConfig.include.includes(type)) {"
        },
        {
            "sha": "bec4cedd8a50dd1f3b6af2653ff23a2971c938b2",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -9,6 +9,7 @@ import * as log from '../build/output/log'\n \n import { getTypeScriptIntent } from './typescript/getTypeScriptIntent'\n import type { TypeCheckResult } from './typescript/runTypeCheck'\n+import { writeAppTypeDeclarations } from './typescript/writeAppTypeDeclarations'\n import { writeConfigurationDefaults } from './typescript/writeConfigurationDefaults'\n import { installDependencies } from './install-dependencies'\n import { isCI } from '../server/ci-info'\n@@ -38,6 +39,7 @@ export async function verifyTypeScriptSetup({\n   cacheDir,\n   tsconfigPath,\n   typeCheckPreflight,\n+  disableStaticImages,\n   hasAppDir,\n   hasPagesDir,\n   isolatedDevBuild,\n@@ -50,6 +52,7 @@ export async function verifyTypeScriptSetup({\n   cacheDir?: string\n   tsconfigPath: string | undefined\n   typeCheckPreflight: boolean\n+  disableStaticImages: boolean\n   hasAppDir: boolean\n   hasPagesDir: boolean\n   isolatedDevBuild: boolean | undefined\n@@ -135,6 +138,16 @@ export async function verifyTypeScriptSetup({\n       hasPagesDir,\n       isolatedDevBuild\n     )\n+    // Write out the necessary `next-env.d.ts` file to correctly register\n+    // Next.js' types:\n+    await writeAppTypeDeclarations({\n+      baseDir: dir,\n+      distDir,\n+      imageImportsEnabled: !disableStaticImages,\n+      hasPagesDir,\n+      hasAppDir,\n+    })\n+\n     let result\n     if (typeCheckPreflight) {\n       const { runTypeCheck } ="
        },
        {
            "sha": "9a1ba32da5fc9764cdd09a569f7d46d1fcfe27dc",
            "filename": "packages/next/src/server/lib/router-utils/route-types-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -10,7 +10,6 @@ import {\n   generateRouteTypesFile,\n   generateLinkTypesFile,\n   generateValidatorFile,\n-  generateDynamicTypesFile,\n } from './typegen'\n import { tryToParsePath } from '../../../lib/try-to-parse-path'\n import {\n@@ -383,35 +382,3 @@ export async function writeValidatorFile(\n \n   await fs.promises.writeFile(filePath, generateValidatorFile(manifest))\n }\n-\n-/**\n- * Writes the dynamic types file (.next/types/next-env.d.ts) that contains\n- * config-dependent type references (image imports, navigation compat, etc.)\n- */\n-export async function writeDynamicTypesFile({\n-  distDir,\n-  imageImportsEnabled,\n-  hasPagesDir,\n-  hasAppDir,\n-}: {\n-  distDir: string\n-  imageImportsEnabled: boolean\n-  hasPagesDir: boolean\n-  hasAppDir: boolean\n-}) {\n-  const typesDir = path.join(distDir, 'types')\n-  const filePath = path.join(typesDir, 'next-env.d.ts')\n-\n-  // Directory should already be created by writeRouteTypesManifest, but ensure it exists\n-  if (!fs.existsSync(typesDir)) {\n-    await fs.promises.mkdir(typesDir, { recursive: true })\n-  }\n-\n-  const content = generateDynamicTypesFile({\n-    imageImportsEnabled,\n-    hasPagesDir,\n-    hasAppDir,\n-  })\n-\n-  await fs.promises.writeFile(filePath, content)\n-}"
        },
        {
            "sha": "c2d8b8c9f96ec272d8c1154048e49ebe87532aa3",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -85,7 +85,6 @@ import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n   writeValidatorFile,\n-  writeDynamicTypesFile,\n } from './route-types-utils'\n import { writeCacheLifeTypes } from './cache-life-type-utils'\n import { isParallelRouteSegment } from '../../../shared/lib/segment'\n@@ -146,6 +145,7 @@ async function verifyTypeScript(opts: SetupOpts) {\n     distDir: opts.nextConfig.distDir,\n     typeCheckPreflight: false,\n     tsconfigPath: opts.nextConfig.typescript.tsconfigPath,\n+    disableStaticImages: opts.nextConfig.images.disableStaticImages,\n     hasAppDir: !!opts.appDir,\n     hasPagesDir: !!opts.pagesDir,\n     isolatedDevBuild: opts.nextConfig.experimental.isolatedDevBuild,\n@@ -265,12 +265,6 @@ async function startWatcher(\n     path.join(distTypesDir, 'routes.d.ts'),\n     opts.nextConfig\n   )\n-  await writeDynamicTypesFile({\n-    distDir,\n-    imageImportsEnabled: !opts.nextConfig.images.disableStaticImages,\n-    hasPagesDir: !!pagesDir,\n-    hasAppDir: !!appDir,\n-  })\n \n   const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n   const routesManifest: DevRoutesManifest = {"
        },
        {
            "sha": "b9149e84b69539cacc0a32a64669059b7aeb293d",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 38,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -1,43 +1,6 @@\n import type { RouteTypesManifest } from './route-types-utils'\n import { isDynamicRoute } from '../../../shared/lib/router/utils/is-dynamic'\n \n-/**\n- * Generates the content for .next/types/next-env.d.ts\n- * This file contains dynamic type references that depend on project configuration.\n- */\n-export function generateDynamicTypesFile({\n-  imageImportsEnabled,\n-  hasPagesDir,\n-  hasAppDir,\n-}: {\n-  imageImportsEnabled: boolean\n-  hasPagesDir: boolean\n-  hasAppDir: boolean\n-}): string {\n-  const directives: string[] = [\n-    // Include the core Next.js typings.\n-    '/// <reference types=\"next\" />',\n-    '// This file is generated automatically by Next.js',\n-    '// Do not edit this file manually',\n-    '',\n-  ]\n-\n-  if (imageImportsEnabled) {\n-    directives.push('/// <reference types=\"next/image-types/global\" />')\n-  }\n-\n-  if (hasAppDir && hasPagesDir) {\n-    directives.push(\n-      '/// <reference types=\"next/navigation-types/compat/navigation\" />'\n-    )\n-  }\n-\n-  // Import routes types from the same directory\n-  directives.push('import \"./routes.d.ts\"')\n-\n-  return directives.join('\\n') + '\\n'\n-}\n-\n function generateRouteTypes(routesManifest: RouteTypesManifest): string {\n   const appRoutes = Object.keys(routesManifest.appRoutes).sort()\n   const pageRoutes = Object.keys(routesManifest.pageRoutes).sort()\n@@ -611,7 +574,7 @@ export function generateValidatorFile(\n   default: (req: any, res: any) => ReturnType<NextApiHandler>\n   config?: {\n     api?: {\n-      bodyParser?: boolean | { sizeLimit?: string | number }\n+      bodyParser?: boolean | { sizeLimit?: string }\n       responseLimit?: string | number | boolean\n       externalResolver?: boolean\n     }"
        },
        {
            "sha": "b7c736eec04ddb93b4e66b5bc484e5406f0fc0e9",
            "filename": "test/e2e/tsconfig-module-preserve/index.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 29,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -38,35 +38,34 @@ describe('tsconfig module: preserve', () => {\n     expect(output).not.toContain('resolveJsonModule')\n \n     expect(await next.readFile('tsconfig.json')).toMatchInlineSnapshot(`\n-     \"{\n-       \"compilerOptions\": {\n-         \"module\": \"preserve\",\n-         \"target\": \"ES2017\",\n-         \"lib\": [\n-           \"dom\",\n-           \"dom.iterable\",\n-           \"esnext\"\n-         ],\n-         \"allowJs\": true,\n-         \"skipLibCheck\": true,\n-         \"strict\": false,\n-         \"noEmit\": true,\n-         \"incremental\": true,\n-         \"isolatedModules\": true,\n-         \"jsx\": \"react-jsx\"\n-       },\n-       \"include\": [\n-         \".next/types/**/*.ts\",\n-         \".next/dev/types/**/*.ts\",\n-         \"**/*.mts\",\n-         \"**/*.ts\",\n-         \"**/*.tsx\"\n-       ],\n-       \"exclude\": [\n-         \"node_modules\"\n-       ]\n-     }\n-     \"\n+      \"{\n+        \"compilerOptions\": {\n+          \"module\": \"preserve\",\n+          \"target\": \"ES2017\",\n+          \"lib\": [\n+            \"dom\",\n+            \"dom.iterable\",\n+            \"esnext\"\n+          ],\n+          \"allowJs\": true,\n+          \"skipLibCheck\": true,\n+          \"strict\": false,\n+          \"noEmit\": true,\n+          \"incremental\": true,\n+          \"isolatedModules\": true,\n+          \"jsx\": \"react-jsx\"\n+        },\n+        \"include\": [\n+          \"next-env.d.ts\",\n+          \"**/*.mts\",\n+          \"**/*.ts\",\n+          \"**/*.tsx\"\n+        ],\n+        \"exclude\": [\n+          \"node_modules\"\n+        ]\n+      }\n+      \"\n     `)\n   })\n })"
        },
        {
            "sha": "c9dba8f87a66a509150c8289dc658370c6c66443",
            "filename": "test/integration/next-image-legacy/typescript/test/index.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 17,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -8,15 +8,10 @@ import {\n   launchApp,\n   nextBuild,\n   killApp,\n-  retry,\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '..')\n const nextConfig = join(appDir, 'next.config.js')\n-// Dynamic types (image types, navigation compat) are now generated in .next/types/\n-// In dev mode with isolatedDevBuild (default), types are in .next/dev/types/\n-const dynamicTypesFileBuild = join(appDir, '.next/types/next-env.d.ts')\n-const dynamicTypesFileDev = join(appDir, '.next/dev/types/next-env.d.ts')\n let appPort\n let app\n let output\n@@ -25,14 +20,6 @@ const handleOutput = (msg) => {\n   output += msg\n }\n \n-// Helper to read dynamic types file with retry (file may be written async)\n-async function readDynamicTypesFile(isDev: boolean) {\n-  const filePath = isDev ? dynamicTypesFileDev : dynamicTypesFileBuild\n-  return retry(async () => {\n-    return await fs.readFile(filePath, 'utf8')\n-  })\n-}\n-\n describe('TypeScript Image Component', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n     'production mode',\n@@ -42,7 +29,10 @@ describe('TypeScript Image Component', () => {\n         expect(stderr).toMatch(/Failed to compile/)\n         expect(stderr).toMatch(/is not assignable to type/)\n         expect(code).toBe(1)\n-        const envTypes = await readDynamicTypesFile(false)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).toContain('image-types/global')\n       })\n \n@@ -57,7 +47,10 @@ describe('TypeScript Image Component', () => {\n         expect(stderr).toMatch(/is not assignable to type/)\n         expect(code).toBe(1)\n         await fs.writeFile(nextConfig, content)\n-        const envTypes = await readDynamicTypesFile(false)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).not.toContain('image-types/global')\n       })\n     }\n@@ -76,7 +69,10 @@ describe('TypeScript Image Component', () => {\n       afterAll(() => killApp(app))\n \n       it('should have image types when enabled', async () => {\n-        const envTypes = await readDynamicTypesFile(true)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).toContain('image-types/global')\n       })\n \n@@ -103,7 +99,7 @@ describe('TypeScript Image Component', () => {\n       const app = await launchApp(appDir, await findPort())\n       await killApp(app)\n       await fs.writeFile(nextConfig, content)\n-      const envTypes = await readDynamicTypesFile(true)\n+      const envTypes = await fs.readFile(join(appDir, 'next-env.d.ts'), 'utf8')\n       expect(envTypes).not.toContain('image-types/global')\n     })\n   })"
        },
        {
            "sha": "57929d8f5fec48996aea592a80d1f63d5dc04d47",
            "filename": "test/integration/next-image-new/typescript/test/index.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 17,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -8,15 +8,10 @@ import {\n   launchApp,\n   nextBuild,\n   killApp,\n-  retry,\n } from 'next-test-utils'\n \n const appDir = join(__dirname, '..')\n const nextConfig = join(appDir, 'next.config.js')\n-// Dynamic types (image types, navigation compat) are now generated in .next/types/\n-// In dev mode with isolatedDevBuild (default), types are in .next/dev/types/\n-const dynamicTypesFileBuild = join(appDir, '.next/types/next-env.d.ts')\n-const dynamicTypesFileDev = join(appDir, '.next/dev/types/next-env.d.ts')\n let appPort\n let app\n let output\n@@ -25,14 +20,6 @@ const handleOutput = (msg) => {\n   output += msg\n }\n \n-// Helper to read dynamic types file with retry (file may be written async)\n-async function readDynamicTypesFile(isDev: boolean) {\n-  const filePath = isDev ? dynamicTypesFileDev : dynamicTypesFileBuild\n-  return retry(async () => {\n-    return await fs.readFile(filePath, 'utf8')\n-  })\n-}\n-\n describe('TypeScript Image Component', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n     'production mode',\n@@ -42,7 +29,10 @@ describe('TypeScript Image Component', () => {\n         expect(stderr).toMatch(/Failed to compile/)\n         expect(stderr).toMatch(/is not assignable to type/)\n         expect(code).toBe(1)\n-        const envTypes = await readDynamicTypesFile(false)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).toContain('image-types/global')\n       })\n \n@@ -57,7 +47,10 @@ describe('TypeScript Image Component', () => {\n         expect(stderr).toMatch(/is not assignable to type/)\n         expect(code).toBe(1)\n         await fs.writeFile(nextConfig, content)\n-        const envTypes = await readDynamicTypesFile(false)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).not.toContain('image-types/global')\n       })\n     }\n@@ -76,7 +69,10 @@ describe('TypeScript Image Component', () => {\n       afterAll(() => killApp(app))\n \n       it('should have image types when enabled', async () => {\n-        const envTypes = await readDynamicTypesFile(true)\n+        const envTypes = await fs.readFile(\n+          join(appDir, 'next-env.d.ts'),\n+          'utf8'\n+        )\n         expect(envTypes).toContain('image-types/global')\n       })\n \n@@ -102,7 +98,7 @@ describe('TypeScript Image Component', () => {\n     const app = await launchApp(appDir, await findPort())\n     await killApp(app)\n     await fs.writeFile(nextConfig, content)\n-    const envTypes = await readDynamicTypesFile(true)\n+    const envTypes = await fs.readFile(join(appDir, 'next-env.d.ts'), 'utf8')\n     expect(envTypes).not.toContain('image-types/global')\n   })\n })"
        },
        {
            "sha": "7c7cee21b0db13963790d1646bec11da073c2af3",
            "filename": "test/integration/tsconfig-verifier/test/index.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -52,6 +52,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -108,6 +109,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -183,6 +185,7 @@ import path from 'path'\n          // in-object comment 2\n          ,\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -237,6 +240,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -290,6 +294,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -347,6 +352,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -404,6 +410,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -458,6 +465,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -515,6 +523,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -572,6 +581,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n@@ -619,6 +629,7 @@ import path from 'path'\n            \"strictNullChecks\": true\n          },\n          \"include\": [\n+           \"next-env.d.ts\",\n            \".next/types/**/*.ts\",\n            \"**/*.mts\",\n            \"**/*.ts\",\n@@ -677,6 +688,7 @@ import path from 'path'\n           \"strictNullChecks\": true\n         },\n         \"include\": [\n+          \"next-env.d.ts\",\n           \".next/types/**/*.ts\",\n           \"**/*.mts\",\n           \"**/*.ts\",\n@@ -738,6 +750,7 @@ import path from 'path'\n           \"strictNullChecks\": true\n         },\n         \"include\": [\n+          \"next-env.d.ts\",\n           \".next/types/**/*.ts\",\n           \"**/*.mts\",\n           \"**/*.ts\",\n@@ -808,6 +821,7 @@ import path from 'path'\n                   \"strictNullChecks\": true\n                 },\n                 \"include\": [\n+                  \"next-env.d.ts\",\n                   \".next/types/**/*.ts\",\n                   \"**/*.ts\",\n                   \"**/*.tsx\""
        },
        {
            "sha": "7996d352f43b1634b55c59fbf6d9621ea3da97a2",
            "filename": "test/integration/typescript-app-type-declarations/next-env.d.ts",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -0,0 +1,6 @@\n+/// <reference types=\"next\" />\n+/// <reference types=\"next/image-types/global\" />\n+import \"./.next/dev/types/routes.d.ts\";\n+\n+// NOTE: This file should not be edited\n+// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        },
        {
            "sha": "fe655be6671491de356ff5f9c10530024fa70bde",
            "filename": "test/integration/typescript-app-type-declarations/test/index.test.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 39,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -5,61 +5,53 @@ import { findPort, launchApp, killApp } from 'next-test-utils'\n import { promises as fs } from 'fs'\n \n const appDir = join(__dirname, '..')\n-const rootTypeDeclarations = join(appDir, 'next-env.d.ts')\n-const distTypeDeclarations = join(appDir, '.next/dev/types/next-env.d.ts')\n+const appTypeDeclarations = join(appDir, 'next-env.d.ts')\n \n describe('TypeScript App Type Declarations', () => {\n-  it('should not create next-env.d.ts in project root', async () => {\n-    // Ensure no next-env.d.ts exists before starting\n+  it('should write a new next-env.d.ts if none exist', async () => {\n+    const prevContent = await fs.readFile(appTypeDeclarations, 'utf8')\n     try {\n-      await fs.unlink(rootTypeDeclarations)\n-    } catch {\n-      // File doesn't exist, which is fine\n-    }\n-\n-    const appPort = await findPort()\n-    let app\n-    try {\n-      app = await launchApp(appDir, appPort, {})\n-      // Verify next-env.d.ts was NOT created in project root\n-      await expect(fs.access(rootTypeDeclarations)).rejects.toThrow()\n+      await fs.unlink(appTypeDeclarations)\n+      const appPort = await findPort()\n+      let app\n+      try {\n+        app = await launchApp(appDir, appPort, {})\n+        const content = await fs.readFile(appTypeDeclarations, 'utf8')\n+        expect(content).toEqual(prevContent)\n+      } finally {\n+        await killApp(app)\n+      }\n     } finally {\n-      await killApp(app)\n+      await fs.writeFile(appTypeDeclarations, prevContent)\n     }\n   })\n \n-  it('should not modify existing next-env.d.ts in project root', async () => {\n-    const existingContent = '// custom next-env.d.ts content\\n'\n-    await fs.writeFile(rootTypeDeclarations, existingContent)\n-    const prevStat = await fs.stat(rootTypeDeclarations)\n-\n-    const appPort = await findPort()\n-    let app\n+  it('should overwrite next-env.d.ts if an incorrect one exists', async () => {\n+    const prevContent = await fs.readFile(appTypeDeclarations, 'utf8')\n     try {\n-      app = await launchApp(appDir, appPort, {})\n-      // Verify next-env.d.ts was NOT modified\n-      const stat = await fs.stat(rootTypeDeclarations)\n-      expect(stat.mtime).toEqual(prevStat.mtime)\n-      const content = await fs.readFile(rootTypeDeclarations, 'utf8')\n-      expect(content).toEqual(existingContent)\n+      await fs.writeFile(appTypeDeclarations, prevContent + 'modification')\n+      const appPort = await findPort()\n+      let app\n+      try {\n+        app = await launchApp(appDir, appPort, {})\n+        const content = await fs.readFile(appTypeDeclarations, 'utf8')\n+        expect(content).toEqual(prevContent)\n+      } finally {\n+        await killApp(app)\n+      }\n     } finally {\n-      await killApp(app)\n-      // Clean up\n-      await fs.unlink(rootTypeDeclarations).catch(() => {})\n+      await fs.writeFile(appTypeDeclarations, prevContent)\n     }\n   })\n \n-  it('should generate next-env.d.ts in .next/types', async () => {\n-    // Clean up any existing .next directory\n-    await fs.rm(join(appDir, '.next'), { recursive: true, force: true })\n-\n+  it('should not touch an existing correct next-env.d.ts', async () => {\n+    const prevStat = await fs.stat(appTypeDeclarations)\n     const appPort = await findPort()\n     let app\n     try {\n       app = await launchApp(appDir, appPort, {})\n-      // Verify next-env.d.ts was generated in .next/types\n-      const content = await fs.readFile(distTypeDeclarations, 'utf8')\n-      expect(content).toContain('/// <reference types=\"next\" />')\n+      const stat = await fs.stat(appTypeDeclarations)\n+      expect(stat.mtime).toEqual(prevStat.mtime)\n     } finally {\n       await killApp(app)\n     }"
        },
        {
            "sha": "bad53066af0cdf8dcf3bee332cef02ef9bfb62dd",
            "filename": "test/integration/typescript-app-type-declarations/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftsconfig.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -17,10 +17,5 @@\n     \"isolatedModules\": true\n   },\n   \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"],\n-  \"include\": [\n-    \"components\",\n-    \"pages\",\n-    \".next/types/**/*.ts\",\n-    \".next/dev/types/**/*.ts\"\n-  ]\n+  \"include\": [\"next-env.d.ts\", \"components\", \"pages\"]\n }"
        },
        {
            "sha": "52e831b43424828d38887dee6a5fb73d955d308f",
            "filename": "test/production/typescript-basic/app/next-env.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fproduction%2Ftypescript-basic%2Fapp%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fproduction%2Ftypescript-basic%2Fapp%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-basic%2Fapp%2Fnext-env.d.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -1,4 +1,5 @@\n /// <reference types=\"next\" />\n+/// <reference types=\"next/image-types/global\" />\n \n // NOTE: This file should not be edited\n // see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        },
        {
            "sha": "b427f3a9fb8f8f531cec121e59a51263f59e40f2",
            "filename": "test/production/typescript-basic/typechecking/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fproduction%2Ftypescript-basic%2Ftypechecking%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fproduction%2Ftypescript-basic%2Ftypechecking%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-basic%2Ftypechecking%2Ftsconfig.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -22,6 +22,6 @@\n       \"@/*\": [\"./*\"]\n     }\n   },\n-  \"include\": [\"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n+  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n   \"exclude\": [\"node_modules\"]\n }"
        },
        {
            "sha": "35020ebd08888d9318ef40c8f3f3ad73bc90d3f9",
            "filename": "test/rspack-build-tests-manifest.json",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Frspack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Frspack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-build-tests-manifest.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -19994,6 +19994,17 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n+    \"passed\": [\n+      \"TypeScript App Type Declarations should not touch an existing correct next-env.d.ts\",\n+      \"TypeScript App Type Declarations should overwrite next-env.d.ts if an incorrect one exists\",\n+      \"TypeScript App Type Declarations should write a new next-env.d.ts if none exist\"\n+    ],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/integration/typescript-baseurl/test/index.test.ts\": {\n     \"passed\": [\"TypeScript Features default behavior should render the page\"],\n     \"failed\": [],\n@@ -22098,16 +22109,5 @@\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n-  },\n-  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n-    \"passed\": [\n-      \"TypeScript App Type Declarations should not create next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should not modify existing next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should overwrite next-env.d.ts in .next/types if incorrect\"\n-    ],\n-    \"failed\": [],\n-    \"pending\": [],\n-    \"flakey\": [],\n-    \"runtimeError\": false\n   }\n }"
        },
        {
            "sha": "1a21f7684e4200774092c8277a94415028374446",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -21995,6 +21995,17 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n+    \"passed\": [\n+      \"TypeScript App Type Declarations should not touch an existing correct next-env.d.ts\",\n+      \"TypeScript App Type Declarations should overwrite next-env.d.ts if an incorrect one exists\",\n+      \"TypeScript App Type Declarations should write a new next-env.d.ts if none exist\"\n+    ],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/integration/typescript-baseurl/test/index.test.ts\": {\n     \"passed\": [\"TypeScript Features default behavior should render the page\"],\n     \"failed\": [],\n@@ -22188,16 +22199,5 @@\n     ],\n     \"flakey\": [],\n     \"runtimeError\": false\n-  },\n-  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n-    \"passed\": [\n-      \"TypeScript App Type Declarations should not create next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should not modify existing next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should overwrite next-env.d.ts in .next/types if incorrect\"\n-    ],\n-    \"failed\": [],\n-    \"pending\": [],\n-    \"flakey\": [],\n-    \"runtimeError\": false\n   }\n }"
        },
        {
            "sha": "a4b9bc1fbe834ebd3800ea364a0296a794d46d0a",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -17865,6 +17865,17 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n+    \"passed\": [\n+      \"TypeScript App Type Declarations should not touch an existing correct next-env.d.ts\",\n+      \"TypeScript App Type Declarations should overwrite next-env.d.ts if an incorrect one exists\",\n+      \"TypeScript App Type Declarations should write a new next-env.d.ts if none exist\"\n+    ],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/integration/typescript-baseurl/test/index.test.ts\": {\n     \"passed\": [\"TypeScript Features default behavior should render the page\"],\n     \"failed\": [],\n@@ -19620,16 +19631,5 @@\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n-  },\n-  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n-    \"passed\": [\n-      \"TypeScript App Type Declarations should not create next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should not modify existing next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should overwrite next-env.d.ts in .next/types if incorrect\"\n-    ],\n-    \"failed\": [],\n-    \"pending\": [],\n-    \"flakey\": [],\n-    \"runtimeError\": false\n   }\n }"
        },
        {
            "sha": "e86ad4277f6999094ebac64c780411ede55ac05b",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -21395,6 +21395,17 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n+    \"passed\": [\n+      \"TypeScript App Type Declarations should not touch an existing correct next-env.d.ts\",\n+      \"TypeScript App Type Declarations should overwrite next-env.d.ts if an incorrect one exists\",\n+      \"TypeScript App Type Declarations should write a new next-env.d.ts if none exist\"\n+    ],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/integration/typescript-baseurl/test/index.test.ts\": {\n     \"passed\": [\"TypeScript Features default behavior should render the page\"],\n     \"failed\": [],\n@@ -21625,16 +21636,5 @@\n     ],\n     \"flakey\": [],\n     \"runtimeError\": false\n-  },\n-  \"test/integration/typescript-app-type-declarations/test/index.test.ts\": {\n-    \"passed\": [\n-      \"TypeScript App Type Declarations should not create next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should not modify existing next-env.d.ts in project root\",\n-      \"TypeScript App Type Declarations should overwrite next-env.d.ts in .next/types if incorrect\"\n-    ],\n-    \"failed\": [],\n-    \"pending\": [],\n-    \"flakey\": [],\n-    \"runtimeError\": false\n   }\n }"
        },
        {
            "sha": "b0344052c25a18515354023f370c78716e3ab700",
            "filename": "test/unit/write-app-declarations.test.ts",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/vercel/next.js/blob/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Funit%2Fwrite-app-declarations.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f/test%2Funit%2Fwrite-app-declarations.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fwrite-app-declarations.test.ts?ref=8a8a00d5d05bf5f0c2de93ade95389d4aeb1571f",
            "patch": "@@ -0,0 +1,124 @@\n+/* eslint-env jest */\n+import os from 'os'\n+import fs from 'fs-extra'\n+import { join } from 'path'\n+import { writeAppTypeDeclarations } from 'next/dist/lib/typescript/writeAppTypeDeclarations'\n+\n+const fixtureDir = join(__dirname, 'fixtures/app-declarations')\n+const declarationFile = join(fixtureDir, 'next-env.d.ts')\n+const imageImportsEnabled = false\n+\n+describe('find config', () => {\n+  beforeEach(async () => {\n+    await fs.ensureDir(fixtureDir)\n+  })\n+  afterEach(() => fs.remove(declarationFile))\n+\n+  it('should preserve CRLF EOL', async () => {\n+    const eol = '\\r\\n'\n+    const content =\n+      '/// <reference types=\"next\" />' +\n+      eol +\n+      (imageImportsEnabled\n+        ? '/// <reference types=\"next/image-types/global\" />' + eol\n+        : '') +\n+      `import \"./.next/types/routes.d.ts\";` +\n+      eol +\n+      eol +\n+      '// NOTE: This file should not be edited' +\n+      eol +\n+      '// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.' +\n+      eol\n+\n+    await fs.writeFile(declarationFile, content)\n+\n+    await writeAppTypeDeclarations({\n+      baseDir: fixtureDir,\n+      distDir: '.next',\n+      imageImportsEnabled,\n+      hasPagesDir: false,\n+      hasAppDir: false,\n+    })\n+    expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n+  })\n+\n+  it('should preserve LF EOL', async () => {\n+    const eol = '\\n'\n+    const content =\n+      '/// <reference types=\"next\" />' +\n+      eol +\n+      (imageImportsEnabled\n+        ? '/// <reference types=\"next/image-types/global\" />' + eol\n+        : '') +\n+      `import \"./.next/types/routes.d.ts\";` +\n+      eol +\n+      eol +\n+      '// NOTE: This file should not be edited' +\n+      eol +\n+      '// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.' +\n+      eol\n+\n+    await fs.writeFile(declarationFile, content)\n+\n+    await writeAppTypeDeclarations({\n+      baseDir: fixtureDir,\n+      distDir: '.next',\n+      imageImportsEnabled,\n+      hasPagesDir: false,\n+      hasAppDir: false,\n+    })\n+    expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n+  })\n+\n+  it('should use OS EOL by default', async () => {\n+    const eol = os.EOL\n+    const content =\n+      '/// <reference types=\"next\" />' +\n+      eol +\n+      (imageImportsEnabled\n+        ? '/// <reference types=\"next/image-types/global\" />' + eol\n+        : '') +\n+      `import \"./.next/types/routes.d.ts\";` +\n+      eol +\n+      eol +\n+      '// NOTE: This file should not be edited' +\n+      eol +\n+      '// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.' +\n+      eol\n+\n+    await writeAppTypeDeclarations({\n+      baseDir: fixtureDir,\n+      distDir: '.next',\n+      imageImportsEnabled,\n+      hasPagesDir: false,\n+      hasAppDir: false,\n+    })\n+    expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n+  })\n+\n+  it('should include navigation types if app directory is enabled', async () => {\n+    await writeAppTypeDeclarations({\n+      baseDir: fixtureDir,\n+      distDir: '.next',\n+      imageImportsEnabled,\n+      hasPagesDir: false,\n+      hasAppDir: true,\n+    })\n+\n+    await expect(fs.readFile(declarationFile, 'utf8')).resolves.not.toContain(\n+      'next/navigation-types/compat/navigation'\n+    )\n+\n+    await writeAppTypeDeclarations({\n+      baseDir: fixtureDir,\n+      distDir: '.next',\n+      imageImportsEnabled,\n+      hasPagesDir: true,\n+      hasAppDir: true,\n+    })\n+\n+    await expect(fs.readFile(declarationFile, 'utf8')).resolves.toContain(\n+      'next/navigation-types/compat/navigation'\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 638,
        "additions": 387,
        "deletions": 251
    }
}