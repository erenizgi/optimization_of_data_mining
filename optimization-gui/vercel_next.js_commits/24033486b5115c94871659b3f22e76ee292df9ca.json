{
    "author": "wbinnssmith",
    "message": "next-analyze: improve network error visuals (#86222)\n\nThis improves how network errors (such as when the bundle analyzer error server is shut down) are shown.\n\nFixes PACK-5877\n\n![image.png](https://app.graphite.com/user-attachments/assets/69e57bb7-03ca-45ec-9816-f4bc512bfd58.png)\n\n![image.png](https://app.graphite.com/user-attachments/assets/450ed52c-5368-49ee-a149-e7b17a8c21db.png)",
    "sha": "24033486b5115c94871659b3f22e76ee292df9ca",
    "files": [
        {
            "sha": "f57ce4c7c7aed7362b28d58bfc0c00bed2164884",
            "filename": "apps/bundle-analyzer/app/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 17,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -4,6 +4,7 @@ import type React from 'react'\n import { useEffect, useMemo, useRef, useState } from 'react'\n import useSWR from 'swr'\n import { ImportChain } from '@/components/import-chain'\n+import { ErrorState } from '@/components/error-state'\n import {\n   RouteTypeahead,\n   type RouteTypeaheadRef,\n@@ -15,7 +16,7 @@ import { Skeleton, TreemapSkeleton } from '@/components/ui/skeleton'\n import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'\n import { AnalyzeData, ModulesData } from '@/lib/analyze-data'\n import { SpecialModule } from '@/lib/types'\n-import { getSpecialModuleType } from '@/lib/utils'\n+import { getSpecialModuleType, fetchStrict } from '@/lib/utils'\n \n function formatBytes(bytes: number): string {\n   if (bytes === 0) return '0 B'\n@@ -164,12 +165,6 @@ export default function Home() {\n         </div>\n \n         <div className=\"basis-2/3 flex justify-end\">\n-          {error && (\n-            <div className=\"text-sm text-red-600 font-medium\">\n-              Error: {error?.message}\n-            </div>\n-          )}\n-\n           {analyzeData && (\n             <>\n               <ToggleGroup\n@@ -227,7 +222,9 @@ export default function Home() {\n       </div>\n \n       <div className=\"flex-1 flex min-h-0\">\n-        {isAnyLoading ? (\n+        {error && !analyzeData ? (\n+          <ErrorState error={error} />\n+        ) : isAnyLoading ? (\n           <>\n             <div className=\"flex-1 min-w-0 p-4 bg-background\">\n               <TreemapSkeleton />\n@@ -414,12 +411,3 @@ async function fetchModulesData(url: string): Promise<ModulesData> {\n   const resp = await fetchStrict(url)\n   return new ModulesData(await resp.arrayBuffer())\n }\n-\n-function fetchStrict(url: string): Promise<Response> {\n-  return fetch(url).then((res) => {\n-    if (!res.ok) {\n-      throw new Error(`Failed to fetch ${url}: ${res.status} ${res.statusText}`)\n-    }\n-    return res\n-  })\n-}"
        },
        {
            "sha": "c14bd145fedad15bddf5adacd7230ce59fda1dab",
            "filename": "apps/bundle-analyzer/components/error-state.tsx",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Ferror-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Ferror-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Ferror-state.tsx?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -0,0 +1,42 @@\n+'use client'\n+\n+import { RefreshCw, AlertTriangle } from 'lucide-react'\n+import { NetworkError } from '@/lib/errors'\n+\n+interface ErrorStateProps {\n+  error: unknown\n+  onRetry?: () => void\n+}\n+\n+export function ErrorState({ error }: ErrorStateProps) {\n+  const isNetwork = error instanceof NetworkError\n+  const title = isNetwork ? 'Server Connection Lost' : 'Error'\n+  const message = isNetwork\n+    ? 'Unable to connect to the bundle analyzer server. Please ensure the server is running and try again.'\n+    : ((error as any)?.message ?? 'An unexpected error occurred.')\n+\n+  return (\n+    <div className=\"flex-1 flex items-center justify-center\">\n+      <div className=\"text-center space-y-4 max-w-md px-6\">\n+        <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-destructive/10 text-destructive mb-2\">\n+          <AlertTriangle className=\"w-8 h-8\" />\n+        </div>\n+        <div>\n+          <h3 className=\"text-lg font-semibold text-foreground mb-2\">\n+            {title}\n+          </h3>\n+          <p className=\"text-sm text-muted-foreground mb-4\">{message}</p>\n+          <button\n+            onClick={() => {\n+              window.location.reload()\n+            }}\n+            className=\"inline-flex items-center gap-2 px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors text-sm font-medium\"\n+          >\n+            <RefreshCw className=\"w-4 h-4\" />\n+            Retry Connection\n+          </button>\n+        </div>\n+      </div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "640e468964edcedebdebed4b1c6bb20da419f15d",
            "filename": "apps/bundle-analyzer/components/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Findex.ts?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -1,3 +1,4 @@\n export { ImportChain } from './import-chain'\n export { RouteTypeahead } from './route-typeahead'\n export { TreemapVisualizer } from './treemap-visualizer'\n+export { ErrorState } from './error-state'"
        },
        {
            "sha": "e452c66f6b4f57e3874661fea1dbe1ddd8f8d0d6",
            "filename": "apps/bundle-analyzer/components/route-typeahead.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -18,6 +18,7 @@ import {\n   PopoverTrigger,\n } from '@/components/ui/popover'\n import { cn, jsonFetcher } from '@/lib/utils'\n+import { NetworkError } from '@/lib/errors'\n \n interface RouteTypeaheadProps {\n   selectedRoute: string | null\n@@ -55,8 +56,13 @@ export const RouteTypeahead = forwardRef<\n \n   if (error) {\n     return (\n-      <div className=\"flex max-w-full text-red-600\">\n-        Failed to load routes manifest: {error.message}\n+      <div className=\"flex items-center gap-2 px-3 py-2 rounded-md bg-destructive/10 border border-destructive/20 text-destructive text-sm max-w-full\">\n+        <span className=\"font-medium\">âš </span>\n+        <span className=\"truncate\">\n+          {error instanceof NetworkError\n+            ? 'Unable to connect to server'\n+            : error.message}\n+        </span>\n       </div>\n     )\n   }"
        },
        {
            "sha": "9ad22dca0c22935538cd4a3d40d9e73a42404b75",
            "filename": "apps/bundle-analyzer/lib/errors.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Flib%2Ferrors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Flib%2Ferrors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Ferrors.ts?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -0,0 +1,10 @@\n+export class NetworkError extends Error {\n+  constructor(message: string, options?: { cause?: unknown }) {\n+    super(message)\n+    this.name = 'NetworkError'\n+    // Preserve error cause when supported\n+    if (options && 'cause' in options) {\n+      ;(this as any).cause = options.cause\n+    }\n+  }\n+}"
        },
        {
            "sha": "116b2c8cbe8758c6f587305aed62aefd4fe847f0",
            "filename": "apps/bundle-analyzer/lib/utils.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/24033486b5115c94871659b3f22e76ee292df9ca/apps%2Fbundle-analyzer%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Flib%2Futils.ts?ref=24033486b5115c94871659b3f22e76ee292df9ca",
            "patch": "@@ -1,14 +1,30 @@\n import { type ClassValue, clsx } from 'clsx'\n import { twMerge } from 'tailwind-merge'\n import { SpecialModule } from './types'\n+import { NetworkError } from './errors'\n import { AnalyzeData } from './analyze-data'\n \n export function cn(...inputs: ClassValue[]) {\n   return twMerge(clsx(inputs))\n }\n \n-export function jsonFetcher<T>(url: string): Promise<T> {\n-  return fetch(url).then((res) => res.json())\n+export async function fetchStrict(url: string): Promise<Response> {\n+  let res: Response\n+  try {\n+    res = await fetch(url)\n+  } catch (err) {\n+    throw new NetworkError(`Failed to fetch ${url}`, { cause: err })\n+  }\n+\n+  if (!res.ok) {\n+    throw new Error(`Failed to fetch ${url}: ${res.status} ${res.statusText}`)\n+  }\n+  return res\n+}\n+\n+export async function jsonFetcher<T>(url: string): Promise<T> {\n+  const res = await fetchStrict(url)\n+  return res.json() as Promise<T>\n }\n \n export function getSpecialModuleType("
        }
    ],
    "stats": {
        "total": 105,
        "additions": 84,
        "deletions": 21
    }
}