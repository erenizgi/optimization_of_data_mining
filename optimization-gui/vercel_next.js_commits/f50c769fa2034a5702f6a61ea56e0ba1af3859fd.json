{
    "author": "serhalp",
    "message": "fix: add backwards compat for middleware → proxy field renames (#85183)\n\n### What?\n\nThese config keys were recently soft-renamed with forward compatibility\non the _resolved_ config object:\n\n- `experimental.proxyPrefetch` → `experimental.middlewarePrefetch`\n- `experimental.externalProxyRewritesResolve` →\n`experimental.externalMiddlewareRewritesResolve`\n- `skipProxyUrlNormalize` → `skipMiddlewareUrlNormalize`\n\nBut there was no backwards compatibility on the resolved, which is\n(arguably) an undocumented breaking change.\n\n### Why?\n\nThis avoids introducing a last-minute breaking change for providers and\nother integrations that read the the `.next/` build output files (which\nis necessary until we all move to the upcoming [Adapter\nAPI](https://github.com/vercel/next.js/discussions/77740).\n\n### How?\n\nWhen a new `proxy` config key is set but the old `middleware` name is\nnot, copy the value to the old name on the *resolved* config object.\n\nThis also adds test coverage for both the existing forward compat\n(old→new) and the new backwards compat (new→old).\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "f50c769fa2034a5702f6a61ea56e0ba1af3859fd",
    "files": [
        {
            "sha": "d7d558925cfa91b36e34fb96f00bcbc7985bd1d1",
            "filename": "packages/next/src/server/config.test.ts",
            "status": "modified",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/f50c769fa2034a5702f6a61ea56e0ba1af3859fd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f50c769fa2034a5702f6a61ea56e0ba1af3859fd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts?ref=f50c769fa2034a5702f6a61ea56e0ba1af3859fd",
            "patch": "@@ -134,4 +134,77 @@ describe('loadConfig', () => {\n       )\n     })\n   })\n+\n+  describe('middleware to proxy config key rename backward/forward compatibility', () => {\n+    it('should copy `skipMiddlewareUrlNormalize value` to `skipProxyUrlNormalize`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          skipMiddlewareUrlNormalize: true,\n+        },\n+      })\n+\n+      expect(result.skipProxyUrlNormalize).toBe(true)\n+    })\n+\n+    it('should copy `experimental.middlewarePrefetch` to `experimental.proxyPrefetch`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          experimental: {\n+            middlewarePrefetch: 'strict',\n+          },\n+        },\n+      })\n+\n+      expect(result.experimental.proxyPrefetch).toBe('strict')\n+    })\n+\n+    it('should copy `experimental.externalMiddlewareRewritesResolve` to `experimental.externalProxyRewritesResolve`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          experimental: {\n+            externalMiddlewareRewritesResolve: true,\n+          },\n+        },\n+      })\n+\n+      expect(result.experimental.externalProxyRewritesResolve).toBe(true)\n+    })\n+\n+    it('should copy `skipProxyUrlNormalize` to `skipMiddlewareUrlNormalize`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          skipProxyUrlNormalize: true,\n+        },\n+      })\n+\n+      expect(result.skipMiddlewareUrlNormalize).toBe(true)\n+      expect(result.skipProxyUrlNormalize).toBe(true)\n+    })\n+\n+    it('should copy `experimental.proxyPrefetch` to `experimental.middlewarePrefetch`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          experimental: {\n+            proxyPrefetch: 'strict',\n+          },\n+        },\n+      })\n+\n+      expect(result.experimental.middlewarePrefetch).toBe('strict')\n+      expect(result.experimental.proxyPrefetch).toBe('strict')\n+    })\n+\n+    it('should copy `experimental.externalProxyRewritesResolve` to `experimental.externalMiddlewareRewritesResolve`', async () => {\n+      const result = await loadConfig(PHASE_PRODUCTION_BUILD, __dirname, {\n+        customConfig: {\n+          experimental: {\n+            externalProxyRewritesResolve: true,\n+          },\n+        },\n+      })\n+\n+      expect(result.experimental.externalMiddlewareRewritesResolve).toBe(true)\n+      expect(result.experimental.externalProxyRewritesResolve).toBe(true)\n+    })\n+  })\n })"
        },
        {
            "sha": "c42c171d2f62b6fbb622c2114a5aa59fc3f8a990",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/f50c769fa2034a5702f6a61ea56e0ba1af3859fd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f50c769fa2034a5702f6a61ea56e0ba1af3859fd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=f50c769fa2034a5702f6a61ea56e0ba1af3859fd",
            "patch": "@@ -836,6 +836,28 @@ function assignDefaultsAndValidate(\n   ) {\n     result.skipProxyUrlNormalize = userConfig.skipMiddlewareUrlNormalize\n   }\n+  // Inverse case: when new name is set but not the old name, copy the value to the old name\n+  // to avoid breaking change on resolved config object written to `.next/`\n+  if (\n+    userConfig.experimental?.proxyPrefetch !== undefined &&\n+    userConfig.experimental?.middlewarePrefetch === undefined\n+  ) {\n+    result.experimental.middlewarePrefetch =\n+      userConfig.experimental.proxyPrefetch\n+  }\n+  if (\n+    userConfig.experimental?.externalProxyRewritesResolve !== undefined &&\n+    userConfig.experimental?.externalMiddlewareRewritesResolve === undefined\n+  ) {\n+    result.experimental.externalMiddlewareRewritesResolve =\n+      userConfig.experimental.externalProxyRewritesResolve\n+  }\n+  if (\n+    userConfig.skipProxyUrlNormalize !== undefined &&\n+    userConfig.skipMiddlewareUrlNormalize === undefined\n+  ) {\n+    result.skipMiddlewareUrlNormalize = userConfig.skipProxyUrlNormalize\n+  }\n \n   // Normalize & validate experimental.proxyClientMaxBodySize\n   if (typeof result.experimental?.proxyClientMaxBodySize !== 'undefined') {"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 95,
        "deletions": 0
    }
}