{
    "author": "mischnic",
    "message": "Improve tests (#84374)\n\n- should encode chunk path correctly\n    - Run a base version for all bundlers\n    - Use `beforePageLoad`\n- nonce test:\n    - open page once and wait for scripts to load\n    - doesn't make sense to retry the whole thing",
    "sha": "ba1dd267ae50d04ec562cabe76903120dfe439ce",
    "files": [
        {
            "sha": "159f10367f0cb25aee53d8e7444dc9b44bc2b18d",
            "filename": "test/e2e/app-dir/app/app/script-manual-nonce/show-order.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js?ref=ba1dd267ae50d04ec562cabe76903120dfe439ce",
            "patch": "@@ -10,7 +10,9 @@ export function ShowScriptOrder() {\n       <button\n         id=\"get-order\"\n         onClick={() => {\n-          setOrder(window._script_order)\n+          // Copy the array, otherwise React won't rerender after the\n+          // `window._script_order.push()` call\n+          setOrder([...(window._script_order || [])])\n         }}\n       >\n         get order"
        },
        {
            "sha": "159f10367f0cb25aee53d8e7444dc9b44bc2b18d",
            "filename": "test/e2e/app-dir/app/app/script-nonce/show-order.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-nonce%2Fshow-order.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-nonce%2Fshow-order.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-nonce%2Fshow-order.js?ref=ba1dd267ae50d04ec562cabe76903120dfe439ce",
            "patch": "@@ -10,7 +10,9 @@ export function ShowScriptOrder() {\n       <button\n         id=\"get-order\"\n         onClick={() => {\n-          setOrder(window._script_order)\n+          // Copy the array, otherwise React won't rerender after the\n+          // `window._script_order.push()` call\n+          setOrder([...(window._script_order || [])])\n         }}\n       >\n         get order"
        },
        {
            "sha": "14d99686d7e8bc382249ffa21f601b8844d7d62d",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 56,
            "deletions": 62,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=ba1dd267ae50d04ec562cabe76903120dfe439ce",
            "patch": "@@ -13,26 +13,25 @@ import {\n const isPPREnabledByDefault = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n \n describe('app dir - basic', () => {\n-  const { next, isNextDev, isNextStart, isNextDeploy, isTurbopack } =\n-    nextTestSetup({\n-      files: __dirname,\n-      buildCommand: process.env.NEXT_EXPERIMENTAL_COMPILE\n-        ? 'pnpm compile-mode'\n-        : undefined,\n-      packageJson: {\n-        scripts: {\n-          'compile-mode': process.env.NEXT_EXPERIMENTAL_COMPILE\n-            ? `next build --experimental-build-mode=compile && next build --experimental-build-mode=generate-env`\n-            : undefined,\n-        },\n-      },\n-      dependencies: {\n-        nanoid: '4.0.1',\n-      },\n-      env: {\n-        NEXT_PUBLIC_TEST_ID: Date.now() + '',\n+  const { next, isNextDev, isNextStart, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+    buildCommand: process.env.NEXT_EXPERIMENTAL_COMPILE\n+      ? 'pnpm compile-mode'\n+      : undefined,\n+    packageJson: {\n+      scripts: {\n+        'compile-mode': process.env.NEXT_EXPERIMENTAL_COMPILE\n+          ? `next build --experimental-build-mode=compile && next build --experimental-build-mode=generate-env`\n+          : undefined,\n       },\n-    })\n+    },\n+    dependencies: {\n+      nanoid: '4.0.1',\n+    },\n+    env: {\n+      NEXT_PUBLIC_TEST_ID: Date.now() + '',\n+    },\n+  })\n \n   if (isNextStart) {\n     it('should have correct cache-control for SSR routes', async () => {\n@@ -169,32 +168,32 @@ describe('app dir - basic', () => {\n     })\n   }\n \n-  // Turbopack has different chunking in dev/production which results in the entrypoint name not being included in the outputs.\n-  if (!process.env.IS_TURBOPACK_TEST) {\n-    it('should encode chunk path correctly', async () => {\n-      await next.fetch('/dynamic-client/first/second')\n-      const browser = await next.browser('/')\n-      const requests = []\n-      browser.on('request', (req) => {\n-        requests.push(req.url())\n-      })\n+  it('should encode chunk path correctly', async () => {\n+    const requests = []\n+    const browser = await next.browser('/dynamic-client/first/second', {\n+      beforePageLoad(page) {\n+        page.on('request', (req) => {\n+          requests.push(req.url())\n+        })\n+      },\n+    })\n \n-      await browser.eval(\n-        'window.location.href = \"/dynamic-client/first/second\"'\n-      )\n+    await browser.waitForElementByCss('#id-page-params')\n \n-      await browser.waitForElementByCss('#id-page-params')\n+    expect(requests).not.toEqual(\n+      expect.arrayContaining([expect.stringContaining('[category]')])\n+    )\n \n-      expect(\n-        requests.some(\n-          (req) =>\n-            req.includes(\n-              encodeURI(isTurbopack ? '[category]_[id]' : '/[category]/[id]')\n-            ) && req.includes('.js')\n-        )\n-      ).toBe(true)\n-    })\n-  }\n+    // Turbopack doesn't recreate the original folder structure for the output chunks\n+    if (!process.env.IS_TURBOPACK_TEST) {\n+      expect(requests).toEqual(\n+        // e.g. _next/static/chunks/app/dynamic-client/%5Bcategory%5D/%5Bid%5D/page-6e188d657a208f8e.js?dpl=...\n+        expect.arrayContaining([\n+          expect.stringMatching(/.*%5Bcategory%5D\\/%5Bid%5D.*\\.js/),\n+        ])\n+      )\n+    }\n+  })\n \n   it.each([\n     { pathname: '/redirect-1' },\n@@ -393,7 +392,7 @@ describe('app dir - basic', () => {\n     it('should serve polyfills for browsers that do not support modules', async () => {\n       const html = await next.render('/dashboard/index')\n       expect(html).toMatch(\n-        isTurbopack\n+        process.env.IS_TURBOPACK_TEST\n           ? /<script src=\"\\/_next\\/static\\/chunks\\/([\\w-]*polyfill-nomodule|[0-9a-f]+)\\.js\" noModule=\"\">/\n           : /<script src=\"\\/_next\\/static\\/chunks\\/polyfills(-\\w+)?\\.js\" noModule=\"\">/\n       )\n@@ -1721,12 +1720,12 @@ describe('app dir - basic', () => {\n       })\n \n       if (!isNextDev) {\n+        // Fails in dev due to CSP header\n         const browser = await next.browser('/script-nonce')\n-\n         await retry(async () => {\n           await browser.elementByCss('#get-order').click()\n           const order = JSON.parse(await browser.elementByCss('#order').text())\n-          expect(order?.length).toBe(2)\n+          expect(order).toEqual([2, 1])\n         })\n       }\n     })\n@@ -1746,15 +1745,12 @@ describe('app dir - basic', () => {\n         expect(element.attribs.nonce).toBeTruthy()\n       })\n \n-      if (!isNextDev) {\n-        const browser = await next.browser('/script-manual-nonce')\n-\n-        await retry(async () => {\n-          await browser.elementByCss('#get-order').click()\n-          const order = JSON.parse(await browser.elementByCss('#order').text())\n-          expect(order?.length).toBe(2)\n-        })\n-      }\n+      const browser = await next.browser('/script-manual-nonce')\n+      await retry(async () => {\n+        await browser.elementByCss('#get-order').click()\n+        const order = JSON.parse(await browser.elementByCss('#order').text())\n+        expect(order).toEqual([2, 1])\n+      })\n     })\n \n     it('should pass manual `nonce` pages', async () => {\n@@ -1772,14 +1768,12 @@ describe('app dir - basic', () => {\n         expect(element.attribs.nonce).toBeTruthy()\n       })\n \n-      if (!isNextDev) {\n-        await retry(async () => {\n-          const browser = await next.browser('/pages-script-manual-nonce')\n-          await browser.elementByCss('#get-order').click()\n-          const order = JSON.parse(await browser.elementByCss('#order').text())\n-          expect(order?.length).toBe(2)\n-        })\n-      }\n+      const browser = await next.browser('/pages-script-manual-nonce')\n+      await retry(async () => {\n+        await browser.elementByCss('#get-order').click()\n+        const order = JSON.parse(await browser.elementByCss('#order').text())\n+        expect(order).toEqual([2, 1])\n+      })\n     })\n \n     it('should pass nonce when using next/font', async () => {"
        },
        {
            "sha": "374bf46cbdcf7cffaf99b6089100d88976c486b6",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ba1dd267ae50d04ec562cabe76903120dfe439ce/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=ba1dd267ae50d04ec562cabe76903120dfe439ce",
            "patch": "@@ -111,6 +111,13 @@ export class NextDeployInstance extends NextInstance {\n       )\n     }\n \n+    if (process.env.IS_TURBOPACK_TEST) {\n+      additionalEnv.push(`IS_TURBOPACK_TEST=1`)\n+    }\n+    if (process.env.IS_WEBPACK_TEST) {\n+      additionalEnv.push(`IS_WEBPACK_TEST=1`)\n+    }\n+\n     const deployRes = await execa(\n       'vercel',\n       ["
        }
    ],
    "stats": {
        "total": 133,
        "additions": 69,
        "deletions": 64
    }
}