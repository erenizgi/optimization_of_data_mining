{
    "author": "sokra",
    "message": "Turbopack: fix passing project options from napi (#86256)\n\n### What?\n\nMake stuff more type safe. Use destructuring to avoid forgetting fields",
    "sha": "8325e3c1d112f3b23806cae3454ad40f07fc5cba",
    "files": [
        {
            "sha": "b8b0133c814f49eecc55fc4647f766aa09f18b34",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 58,
            "deletions": 36,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/8325e3c1d112f3b23806cae3454ad40f07fc5cba/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8325e3c1d112f3b23806cae3454ad40f07fc5cba/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=8325e3c1d112f3b23806cae3454ad40f07fc5cba",
            "patch": "@@ -137,8 +137,8 @@ pub struct NapiProjectOptions {\n     /// Unix path. E.g. `apps/my-app`\n     pub project_path: RcStr,\n \n-    /// A path where to emit the build outputs, relative to [`Project::project_path`], always Unix\n-    /// path. Corresponds to next.config.js's `distDir`.\n+    /// A path where tracing output will be written to and/or cache is read/written.\n+    /// Usually equal to the `distDir` in next.config.js.\n     /// E.g. `.next`\n     pub dist_dir: RcStr,\n \n@@ -192,11 +192,6 @@ pub struct NapiPartialProjectOptions {\n     /// E.g. `apps/my-app`\n     pub project_path: Option<RcStr>,\n \n-    /// A path where to emit the build outputs, relative to [`Project::project_path`], always a\n-    /// Unix path. Corresponds to next.config.js's `distDir`.\n-    /// E.g. `.next`\n-    pub dist_dir: Option<Option<RcStr>>,\n-\n     /// Filesystem watcher options.\n     pub watch: Option<NapiWatchOptions>,\n \n@@ -267,43 +262,70 @@ impl From<NapiWatchOptions> for WatchOptions {\n \n impl From<NapiProjectOptions> for ProjectOptions {\n     fn from(val: NapiProjectOptions) -> Self {\n+        let NapiProjectOptions {\n+            root_path,\n+            project_path,\n+            // Only used for initializing cache and tracing\n+            dist_dir: _,\n+            watch,\n+            next_config,\n+            env,\n+            define_env,\n+            dev,\n+            encryption_key,\n+            build_id,\n+            preview_props,\n+            browserslist_query,\n+            no_mangling,\n+            current_node_js_version,\n+        } = val;\n         ProjectOptions {\n-            root_path: val.root_path,\n-            project_path: val.project_path,\n-            watch: val.watch.into(),\n-            next_config: val.next_config,\n-            env: val\n-                .env\n-                .into_iter()\n-                .map(|var| (var.name, var.value))\n-                .collect(),\n-            define_env: val.define_env.into(),\n-            dev: val.dev,\n-            encryption_key: val.encryption_key,\n-            build_id: val.build_id,\n-            preview_props: val.preview_props.into(),\n-            browserslist_query: val.browserslist_query,\n-            no_mangling: val.no_mangling,\n-            current_node_js_version: val.current_node_js_version,\n+            root_path,\n+            project_path,\n+            watch: watch.into(),\n+            next_config,\n+            env: env.into_iter().map(|var| (var.name, var.value)).collect(),\n+            define_env: define_env.into(),\n+            dev,\n+            encryption_key,\n+            build_id,\n+            preview_props: preview_props.into(),\n+            browserslist_query,\n+            no_mangling,\n+            current_node_js_version,\n         }\n     }\n }\n \n impl From<NapiPartialProjectOptions> for PartialProjectOptions {\n     fn from(val: NapiPartialProjectOptions) -> Self {\n+        let NapiPartialProjectOptions {\n+            root_path,\n+            project_path,\n+            watch,\n+            next_config,\n+            env,\n+            define_env,\n+            dev,\n+            encryption_key,\n+            build_id,\n+            preview_props,\n+            browserslist_query,\n+            no_mangling,\n+        } = val;\n         PartialProjectOptions {\n-            root_path: val.root_path,\n-            project_path: val.project_path,\n-            watch: val.watch.map(From::from),\n-            next_config: val.next_config,\n-            env: val\n-                .env\n-                .map(|env| env.into_iter().map(|var| (var.name, var.value)).collect()),\n-            define_env: val.define_env.map(|env| env.into()),\n-            dev: val.dev,\n-            encryption_key: val.encryption_key,\n-            build_id: val.build_id,\n-            preview_props: val.preview_props.map(|props| props.into()),\n+            root_path,\n+            project_path,\n+            watch: watch.map(From::from),\n+            next_config,\n+            env: env.map(|env| env.into_iter().map(|var| (var.name, var.value)).collect()),\n+            define_env: define_env.map(|env| env.into()),\n+            dev,\n+            encryption_key,\n+            build_id,\n+            preview_props: preview_props.map(|props| props.into()),\n+            browserslist_query,\n+            no_mangling,\n         }\n     }\n }"
        },
        {
            "sha": "9efcfcc916aee8eba6dbfd4f0575fb2e8a0ed4e4",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/8325e3c1d112f3b23806cae3454ad40f07fc5cba/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8325e3c1d112f3b23806cae3454ad40f07fc5cba/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=8325e3c1d112f3b23806cae3454ad40f07fc5cba",
            "patch": "@@ -229,6 +229,14 @@ pub struct PartialProjectOptions {\n \n     /// Options for draft mode.\n     pub preview_props: Option<DraftModeOptions>,\n+\n+    /// The browserslist query to use for targeting browsers.\n+    pub browserslist_query: Option<RcStr>,\n+\n+    /// When the code is minified, this opts out of the default mangling of\n+    /// local names for variables, functions etc., which can be useful for\n+    /// debugging/profiling purposes.\n+    pub no_mangling: Option<bool>,\n }\n \n #[derive(\n@@ -347,6 +355,8 @@ impl ProjectContainer {\n             encryption_key,\n             build_id,\n             preview_props,\n+            browserslist_query,\n+            no_mangling,\n         } = options;\n \n         let resolved_self = self.to_resolved().await?;\n@@ -388,6 +398,12 @@ impl ProjectContainer {\n         if let Some(preview_props) = preview_props {\n             new_options.preview_props = preview_props;\n         }\n+        if let Some(browserslist_query) = browserslist_query {\n+            new_options.browserslist_query = browserslist_query;\n+        }\n+        if let Some(no_mangling) = no_mangling {\n+            new_options.no_mangling = no_mangling;\n+        }\n \n         // TODO: Handle mode switch, should prevent mode being switched.\n         let watch = new_options.watch;"
        },
        {
            "sha": "b2bfc13857b4edbb2291ea5a3670f6251a2cc2cf",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=8325e3c1d112f3b23806cae3454ad40f07fc5cba",
            "patch": "@@ -123,8 +123,8 @@ export interface NapiProjectOptions {\n    */\n   projectPath: RcStr\n   /**\n-   * A path where to emit the build outputs, relative to [`Project::project_path`], always Unix\n-   * path. Corresponds to next.config.js's `distDir`.\n+   * A path where tracing output will be written to and/or cache is read/written.\n+   * Usually equal to the `distDir` in next.config.js.\n    * E.g. `.next`\n    */\n   distDir: RcStr\n@@ -172,12 +172,6 @@ export interface NapiPartialProjectOptions {\n    * E.g. `apps/my-app`\n    */\n   projectPath?: RcStr\n-  /**\n-   * A path where to emit the build outputs, relative to [`Project::project_path`], always a\n-   * Unix path. Corresponds to next.config.js's `distDir`.\n-   * E.g. `.next`\n-   */\n-  distDir?: RcStr | undefined | null\n   /** Filesystem watcher options. */\n   watch?: NapiWatchOptions\n   /** The contents of next.config.js, serialized to JSON. */"
        },
        {
            "sha": "c0ff835a8f49a841c2b5af25a33b3ac250b86da6",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=8325e3c1d112f3b23806cae3454ad40f07fc5cba",
            "patch": "@@ -29,6 +29,7 @@ import type {\n   Endpoint,\n   HmrIdentifiers,\n   Lockfile,\n+  PartialProjectOptions,\n   Project,\n   ProjectOptions,\n   RawEntrypoints,\n@@ -651,15 +652,15 @@ function bindingToApi(\n   }\n \n   async function rustifyPartialProjectOptions(\n-    options: Partial<ProjectOptions>\n+    options: PartialProjectOptions\n   ): Promise<NapiPartialProjectOptions> {\n     return {\n       ...options,\n       nextConfig:\n         options.nextConfig &&\n         (await serializeNextConfig(\n           options.nextConfig,\n-          path.join(options.rootPath!, options.projectPath!)\n+          path.join(options.rootPath, options.projectPath)\n         )),\n       env: options.env && rustifyEnv(options.env),\n     }\n@@ -672,7 +673,7 @@ function bindingToApi(\n       this._nativeProject = nativeProject\n     }\n \n-    async update(options: Partial<ProjectOptions>) {\n+    async update(options: PartialProjectOptions) {\n       await binding.projectUpdate(\n         this._nativeProject,\n         await rustifyPartialProjectOptions(options)"
        },
        {
            "sha": "b9e0fee184c24d66378abe7dfdb742ffb234c1b8",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 62,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8325e3c1d112f3b23806cae3454ad40f07fc5cba/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=8325e3c1d112f3b23806cae3454ad40f07fc5cba",
            "patch": "@@ -5,6 +5,8 @@ import type {\n   RefCell,\n   NapiTurboEngineOptions,\n   NapiSourceDiagnostic,\n+  NapiProjectOptions,\n+  NapiPartialProjectOptions,\n } from './generated-native'\n \n export type { NapiTurboEngineOptions as TurboEngineOptions }\n@@ -367,27 +369,8 @@ export type WrittenEndpoint =\n       config: EndpointConfig\n     }\n \n-export interface ProjectOptions {\n-  /**\n-   * An absolute root path (Unix or Windows path) from which all files must be nested under. Trying\n-   * to access a file outside this root will fail, so think of this as a chroot.\n-   * E.g. `/home/user/projects/my-repo`.\n-   */\n-  rootPath: string\n-\n-  /**\n-   * A path which contains the app/pages directories, relative to `root_path`, always a Unix path.\n-   * E.g. `apps/my-app`\n-   */\n-  projectPath: string\n-\n-  /**\n-   * A path where to emit the build outputs, relative to [`Project::project_path`], always a Unix\n-   * path. Corresponds to next.config.js's `distDir`.\n-   * E.g. `.next`\n-   */\n-  distDir: string\n-\n+export interface ProjectOptions\n+  extends Omit<NapiProjectOptions, 'nextConfig' | 'env'> {\n   /**\n    * The next.config.js contents.\n    */\n@@ -397,53 +380,21 @@ export interface ProjectOptions {\n    * A map of environment variables to use when compiling code.\n    */\n   env: Record<string, string>\n+}\n \n-  defineEnv: DefineEnv\n-\n-  /**\n-   * Whether to watch the filesystem for file changes.\n-   */\n-  watch: {\n-    enable: boolean\n-    pollIntervalMs?: number\n-  }\n-\n-  /**\n-   * The mode in which Next.js is running.\n-   */\n-  dev: boolean\n-\n-  /**\n-   * The server actions encryption key.\n-   */\n-  encryptionKey: string\n-\n-  /**\n-   * The build id.\n-   */\n-  buildId: string\n-\n-  /**\n-   * Options for draft mode.\n-   */\n-  previewProps: __ApiPreviewProps\n-\n-  /**\n-   * The browserslist query to use for targeting browsers.\n-   */\n-  browserslistQuery: string\n-\n+export interface PartialProjectOptions\n+  extends Omit<NapiPartialProjectOptions, 'nextConfig' | 'env'> {\n+  rootPath: NapiProjectOptions['rootPath']\n+  projectPath: NapiProjectOptions['projectPath']\n   /**\n-   * When the code is minified, this opts out of the default mangling of local\n-   * names for variables, functions etc., which can be useful for\n-   * debugging/profiling purposes.\n+   * The next.config.js contents.\n    */\n-  noMangling: boolean\n+  nextConfig?: NextConfigComplete\n \n   /**\n-   * The version of Node.js that is available/currently running.\n+   * A map of environment variables to use when compiling code.\n    */\n-  currentNodeJsVersion: string\n+  env?: Record<string, string>\n }\n \n export interface DefineEnv {"
        }
    ],
    "stats": {
        "total": 202,
        "additions": 93,
        "deletions": 109
    }
}