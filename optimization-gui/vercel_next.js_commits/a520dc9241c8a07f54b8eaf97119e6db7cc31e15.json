{
    "author": "ztanner",
    "message": "fix: worker logs should still support color (#84024)\n\nLogs emitted from the static export worker lost their ANSI colors\nbecause the worker process starts with piped stdio, so picocolors\ndisables coloring. Most terminal-color helpers treat ANSI styling as a\nTTY-only feature. At module load it checks process.stdout.isTTY; when a\nprocess’ stdout is piped to another stream (as is the case in our export\nworker), Node marks it as non‑TTY.\n\nTo fix, when spawning the worker, this PR will re-check color support\nusing the parent’s TTY/env state and set `FORCE_COLOR=1` only when the\nparent would have colored output (respecting user opt-outs).",
    "sha": "a520dc9241c8a07f54b8eaf97119e6db7cc31e15",
    "files": [
        {
            "sha": "ead67172aaeab60f3e2f77d8732e3a00aca985b4",
            "filename": "packages/next/src/lib/worker.test.ts",
            "status": "added",
            "additions": 127,
            "deletions": 0,
            "changes": 127,
            "blob_url": "https://github.com/vercel/next.js/blob/a520dc9241c8a07f54b8eaf97119e6db7cc31e15/packages%2Fnext%2Fsrc%2Flib%2Fworker.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a520dc9241c8a07f54b8eaf97119e6db7cc31e15/packages%2Fnext%2Fsrc%2Flib%2Fworker.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.test.ts?ref=a520dc9241c8a07f54b8eaf97119e6db7cc31e15",
            "patch": "@@ -0,0 +1,127 @@\n+import { PassThrough } from 'stream'\n+\n+let latestForkEnv: NodeJS.ProcessEnv | undefined\n+\n+jest.mock('next/dist/compiled/jest-worker', () => {\n+  const WorkerMock = jest.fn().mockImplementation((_path, options) => {\n+    latestForkEnv = options?.forkOptions?.env\n+    return {\n+      _workerPool: { _workers: [] },\n+      getStdout: () => new PassThrough(),\n+      getStderr: () => new PassThrough(),\n+      end: jest.fn().mockResolvedValue(undefined),\n+      close: jest.fn(),\n+    }\n+  })\n+\n+  return { Worker: WorkerMock }\n+})\n+\n+const noopOptions = {\n+  debuggerPortOffset: -1,\n+  isolatedMemory: false,\n+  exposedMethods: [] as string[],\n+}\n+\n+const restoreDescriptors: Array<() => void> = []\n+\n+const overrideBooleanDescriptor = (\n+  target: NodeJS.WriteStream,\n+  property: 'isTTY',\n+  value: boolean | undefined\n+) => {\n+  const descriptor = Object.getOwnPropertyDescriptor(target, property)\n+  restoreDescriptors.push(() => {\n+    if (descriptor) {\n+      Object.defineProperty(target, property, descriptor)\n+    } else {\n+      delete (target as any)[property]\n+    }\n+  })\n+  Object.defineProperty(target, property, {\n+    configurable: true,\n+    enumerable: false,\n+    value,\n+    writable: true,\n+  })\n+}\n+\n+describe('lib/worker color propagation', () => {\n+  const originalEnv = { ...process.env }\n+\n+  const restoreEnv = () => {\n+    for (const key of Object.keys(process.env)) {\n+      delete process.env[key]\n+    }\n+    Object.assign(process.env, originalEnv)\n+  }\n+\n+  afterEach(() => {\n+    restoreEnv()\n+    while (restoreDescriptors.length > 0) {\n+      const restore = restoreDescriptors.pop()\n+      restore?.()\n+    }\n+    jest.resetModules()\n+    latestForkEnv = undefined\n+  })\n+\n+  it('enables FORCE_COLOR when the parent supports colors', () => {\n+    delete process.env.FORCE_COLOR\n+    delete process.env.NO_COLOR\n+    delete process.env.CI\n+    process.env.TERM = 'xterm-256color'\n+\n+    overrideBooleanDescriptor(process.stdout, 'isTTY', true)\n+    overrideBooleanDescriptor(process.stderr, 'isTTY', false)\n+\n+    const { Worker } = require('./worker') as typeof import('./worker')\n+\n+    const worker = new Worker(__filename, noopOptions)\n+    worker.close()\n+\n+    expect(latestForkEnv?.FORCE_COLOR).toBe('1')\n+  })\n+\n+  it('does not overwrite existing FORCE_COLOR', () => {\n+    process.env.FORCE_COLOR = '0'\n+\n+    const { Worker } = require('./worker') as typeof import('./worker')\n+\n+    const worker = new Worker(__filename, noopOptions)\n+    worker.close()\n+\n+    expect(latestForkEnv?.FORCE_COLOR).toBe('0')\n+  })\n+\n+  it('respects NO_COLOR', () => {\n+    delete process.env.FORCE_COLOR\n+    process.env.NO_COLOR = '1'\n+\n+    overrideBooleanDescriptor(process.stdout, 'isTTY', true)\n+\n+    const { Worker } = require('./worker') as typeof import('./worker')\n+\n+    const worker = new Worker(__filename, noopOptions)\n+    worker.close()\n+\n+    expect(latestForkEnv?.FORCE_COLOR).toBeUndefined()\n+  })\n+\n+  it('does not force color when not attached to a TTY', () => {\n+    delete process.env.FORCE_COLOR\n+    delete process.env.CI\n+    delete process.env.NO_COLOR\n+    process.env.TERM = 'xterm-256color'\n+\n+    overrideBooleanDescriptor(process.stdout, 'isTTY', false)\n+    overrideBooleanDescriptor(process.stderr, 'isTTY', false)\n+\n+    const { Worker } = require('./worker') as typeof import('./worker')\n+\n+    const worker = new Worker(__filename, noopOptions)\n+    worker.close()\n+\n+    expect(latestForkEnv?.FORCE_COLOR).toBeUndefined()\n+  })\n+})"
        },
        {
            "sha": "bbbf6aeea5ba5f67530e7a7ab8f71c27a0eb78ba",
            "filename": "packages/next/src/lib/worker.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 6,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/a520dc9241c8a07f54b8eaf97119e6db7cc31e15/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a520dc9241c8a07f54b8eaf97119e6db7cc31e15/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts?ref=a520dc9241c8a07f54b8eaf97119e6db7cc31e15",
            "patch": "@@ -103,16 +103,35 @@ export class Worker {\n     }\n \n     const createWorker = () => {\n+      const workerEnv: NodeJS.ProcessEnv = {\n+        ...process.env,\n+        ...((farmOptions.forkOptions?.env || {}) as any),\n+        IS_NEXT_WORKER: 'true',\n+        NODE_OPTIONS: formatNodeOptions(nodeOptions),\n+      }\n+\n+      if (workerEnv.FORCE_COLOR === undefined) {\n+        // Mirror the enablement heuristic from picocolors (see https://github.com/vercel/next.js/blob/6a40da0345939fe4f7b1ae519b296a86dd103432/packages/next/src/lib/picocolors.ts#L21-L24).\n+        // Picocolors snapshots `process.env`/`stdout.isTTY` at module load time, so when the worker\n+        // process bootstraps with piped stdio its own check would disable colors. Re-evaluating the\n+        // same conditions here lets us opt the worker into color output only when the parent would\n+        // have seen colors, while still respecting explicit opt-outs like NO_COLOR.\n+        const supportsColors =\n+          !workerEnv.NO_COLOR &&\n+          !workerEnv.CI &&\n+          workerEnv.TERM !== 'dumb' &&\n+          (process.stdout.isTTY || process.stderr?.isTTY)\n+\n+        if (supportsColors) {\n+          workerEnv.FORCE_COLOR = '1'\n+        }\n+      }\n+\n       this._worker = new JestWorker(workerPath, {\n         ...farmOptions,\n         forkOptions: {\n           ...farmOptions.forkOptions,\n-          env: {\n-            ...process.env,\n-            ...((farmOptions.forkOptions?.env || {}) as any),\n-            IS_NEXT_WORKER: 'true',\n-            NODE_OPTIONS: formatNodeOptions(nodeOptions),\n-          } as any,\n+          env: workerEnv,\n         },\n         maxRetries: 0,\n       }) as JestWorker"
        }
    ],
    "stats": {
        "total": 158,
        "additions": 152,
        "deletions": 6
    }
}