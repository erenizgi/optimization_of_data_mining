{
    "author": "eps1lon",
    "message": "[dev-overlay] Stop appending wrong Owner Stacks to SSR-only shell errors (#77302)",
    "sha": "d6f9e080d726211d358960306031184b7a8e15aa",
    "files": [
        {
            "sha": "c03a95ca655ece82ff0ef2b2132ea68cc26b15ac",
            "filename": "packages/next/src/client/components/errors/stitched-error.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -18,17 +18,13 @@ export function setOwnerStack(error: Error, stack: string | null) {\n   ownerStacks.set(error, stack)\n }\n \n-export function getReactStitchedError(err: unknown): Error {\n-  const newError = isError(err)\n-    ? err\n-    : // TODO: stringify thrown value\n-      new Error('Thrown value was ignored. This is a bug in Next.js.')\n+export function coerceError(value: unknown): Error {\n+  return isError(value) ? value : new Error('' + value)\n+}\n \n+export function setOwnerStackIfAvailable(error: Error): void {\n   // React 18 and prod does not have `captureOwnerStack`\n   if ('captureOwnerStack' in React) {\n-    // TODO: Hoist these to callsites to ensure we set the correct Owner Stack.\n-    setOwnerStack(newError, React.captureOwnerStack())\n+    setOwnerStack(error, React.captureOwnerStack())\n   }\n-\n-  return newError\n }"
        },
        {
            "sha": "d881485fcb882db120b89ea1b4c3a52b16f00777",
            "filename": "packages/next/src/client/components/errors/use-error-handler.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 21,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fuse-error-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fuse-error-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fuse-error-handler.ts?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -3,7 +3,7 @@ import { isNextRouterError } from '../is-next-router-error'\n import { formatConsoleArgs, parseConsoleArgs } from '../../lib/console'\n import isError from '../../../lib/is-error'\n import { createConsoleError } from './console-error'\n-import { getReactStitchedError } from '../errors/stitched-error'\n+import { coerceError, setOwnerStackIfAvailable } from '../errors/stitched-error'\n \n const queueMicroTask =\n   globalThis.queueMicrotask || ((cb: () => void) => Promise.resolve().then(cb))\n@@ -29,7 +29,7 @@ export function handleConsoleError(\n       environmentName\n     )\n   }\n-  error = getReactStitchedError(error)\n+  setOwnerStackIfAvailable(error)\n \n   errorQueue.push(error)\n   for (const handler of errorHandlers) {\n@@ -41,17 +41,7 @@ export function handleConsoleError(\n   }\n }\n \n-export function handleClientError(originError: unknown) {\n-  let error: Error\n-  if (isError(originError)) {\n-    error = originError\n-  } else {\n-    // If it's not an error, format the args into an error\n-    const formattedErrorMessage = originError + ''\n-    error = new Error(formattedErrorMessage)\n-  }\n-  error = getReactStitchedError(error)\n-\n+export function handleClientError(error: Error) {\n   errorQueue.push(error)\n   for (const handler of errorHandlers) {\n     // Delayed the error being passed to React Dev Overlay,\n@@ -91,28 +81,30 @@ export function useErrorHandler(\n }\n \n function onUnhandledError(event: WindowEventMap['error']): void | boolean {\n-  if (isNextRouterError(event.error)) {\n+  const thrownValue: unknown = event.error\n+  if (isNextRouterError(thrownValue)) {\n     event.preventDefault()\n     return false\n   }\n   // When there's an error property present, we log the error to error overlay.\n   // Otherwise we don't do anything as it's not logging in the console either.\n-  if (event.error) {\n-    handleClientError(event.error)\n+  if (thrownValue) {\n+    const error = coerceError(thrownValue)\n+    setOwnerStackIfAvailable(error)\n+\n+    handleClientError(error)\n   }\n }\n \n function onUnhandledRejection(ev: WindowEventMap['unhandledrejection']): void {\n-  const reason = ev?.reason\n+  const reason: unknown = ev?.reason\n   if (isNextRouterError(reason)) {\n     ev.preventDefault()\n     return\n   }\n \n-  let error = reason\n-  if (error && !isError(error)) {\n-    error = new Error(error + '')\n-  }\n+  const error = coerceError(reason)\n+  setOwnerStackIfAvailable(error)\n \n   rejectionQueue.push(error)\n   for (const handler of rejectionHandlers) {"
        },
        {
            "sha": "7e50855f3a2552353e31505af39b13e1b84f789b",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/app-dev-overlay.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -52,7 +52,7 @@ function ReplaySsrOnlyErrors({\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n     useEffect(() => {\n       if (ssrError !== null) {\n-        // TODO(veil): Produces wrong Owner Stack\n+        // TODO(veil): Include original Owner Stack (NDX-905)\n         // TODO(veil): Mark as recoverable error\n         // TODO(veil): console.error\n         handleClientError(ssrError)"
        },
        {
            "sha": "da5605c44c17e120958c4b2d5e37f9517c0db1c0",
            "filename": "packages/next/src/client/react-client-callbacks/error-boundary-callbacks.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 15,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -2,8 +2,9 @@\n \n import type { ErrorInfo } from 'react'\n import {\n-  getReactStitchedError,\n+  setOwnerStackIfAvailable,\n   setComponentStack,\n+  coerceError,\n } from '../components/errors/stitched-error'\n import { handleClientError } from '../components/errors/use-error-handler'\n import { isNextRouterError } from '../components/is-next-router-error'\n@@ -16,7 +17,7 @@ import {\n } from '../components/error-boundary'\n \n export function onCaughtError(\n-  err: unknown,\n+  thrownValue: unknown,\n   errorInfo: ErrorInfo & { errorBoundary?: React.Component }\n ) {\n   const errorBoundaryComponent = errorInfo.errorBoundary?.constructor\n@@ -41,11 +42,11 @@ export function onCaughtError(\n     // We don't consider errors caught unless they're caught by an explicit error\n     // boundary. The built-in ones are considered implicit.\n     // This mimics how the same app would behave without Next.js.\n-    return onUncaughtError(err, errorInfo)\n+    return onUncaughtError(thrownValue, errorInfo)\n   }\n \n   // Skip certain custom errors which are not expected to be reported on client\n-  if (isBailoutToCSRError(err) || isNextRouterError(err)) return\n+  if (isBailoutToCSRError(thrownValue) || isNextRouterError(thrownValue)) return\n \n   if (process.env.NODE_ENV !== 'production') {\n     const errorBoundaryName =\n@@ -72,37 +73,43 @@ export function onCaughtError(\n \n     const errorLocation = `${componentErrorMessage} ${errorBoundaryMessage}`\n \n-    const stitchedError = getReactStitchedError(err)\n+    const error = coerceError(thrownValue)\n+    setOwnerStackIfAvailable(error)\n     // TODO: change to passing down errorInfo later\n     // In development mode, pass along the component stack to the error\n     if (errorInfo.componentStack) {\n-      setComponentStack(stitchedError, errorInfo.componentStack)\n+      setComponentStack(error, errorInfo.componentStack)\n     }\n \n     // Log and report the error with location but without modifying the error stack\n-    originConsoleError('%o\\n\\n%s', err, errorLocation)\n+    originConsoleError('%o\\n\\n%s', thrownValue, errorLocation)\n \n-    handleClientError(stitchedError)\n+    handleClientError(error)\n   } else {\n-    originConsoleError(err)\n+    originConsoleError(thrownValue)\n   }\n }\n \n-export function onUncaughtError(err: unknown, errorInfo: React.ErrorInfo) {\n+export function onUncaughtError(\n+  thrownValue: unknown,\n+  errorInfo: React.ErrorInfo\n+) {\n   // Skip certain custom errors which are not expected to be reported on client\n-  if (isBailoutToCSRError(err) || isNextRouterError(err)) return\n+  if (isBailoutToCSRError(thrownValue) || isNextRouterError(thrownValue)) return\n \n   if (process.env.NODE_ENV !== 'production') {\n-    const stitchedError = getReactStitchedError(err)\n+    const error = coerceError(thrownValue)\n+    setOwnerStackIfAvailable(error)\n+\n     // TODO: change to passing down errorInfo later\n     // In development mode, pass along the component stack to the error\n     if (errorInfo.componentStack) {\n-      setComponentStack(stitchedError, errorInfo.componentStack)\n+      setComponentStack(error, errorInfo.componentStack)\n     }\n \n     // TODO: Add an adendum to the overlay telling people about custom error boundaries.\n-    reportGlobalError(stitchedError)\n+    reportGlobalError(error)\n   } else {\n-    reportGlobalError(err)\n+    reportGlobalError(thrownValue)\n   }\n }"
        },
        {
            "sha": "9ac557a62fcb16c70648e494a7322d0ab996ed24",
            "filename": "packages/next/src/client/react-client-callbacks/on-recoverable-error.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -2,25 +2,29 @@\n \n import type { HydrationOptions } from 'react-dom/client'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n-import { reportGlobalError } from './report-global-error'\n import {\n-  getReactStitchedError,\n+  setOwnerStackIfAvailable,\n   setComponentStack,\n+  coerceError,\n } from '../components/errors/stitched-error'\n import isError from '../../lib/is-error'\n+import { reportGlobalError } from './report-global-error'\n \n export const onRecoverableError: HydrationOptions['onRecoverableError'] = (\n   error,\n   errorInfo\n ) => {\n   // x-ref: https://github.com/facebook/react/pull/28736\n   const cause = isError(error) && 'cause' in error ? error.cause : error\n-  const stitchedError = getReactStitchedError(cause)\n-  if (process.env.NODE_ENV === 'development' && errorInfo.componentStack) {\n-    setComponentStack(stitchedError, errorInfo.componentStack)\n-  }\n   // Skip certain custom errors which are not expected to be reported on client\n   if (isBailoutToCSRError(cause)) return\n \n-  reportGlobalError(stitchedError)\n+  const causeError = coerceError(cause)\n+  setOwnerStackIfAvailable(causeError)\n+\n+  if (process.env.NODE_ENV === 'development' && errorInfo.componentStack) {\n+    setComponentStack(causeError, errorInfo.componentStack)\n+  }\n+\n+  reportGlobalError(causeError)\n }"
        },
        {
            "sha": "b9f2a3b2c5ee0073b1f784b5d330a89c24ed0b79",
            "filename": "test/development/app-dir/ssr-only-error/ssr-only-error.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d6f9e080d726211d358960306031184b7a8e15aa/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6f9e080d726211d358960306031184b7a8e15aa/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts?ref=d6f9e080d726211d358960306031184b7a8e15aa",
            "patch": "@@ -9,7 +9,7 @@ describe('ssr-only-error', () => {\n   it('should show ssr only error in error overlay', async () => {\n     const browser = await next.browser('/')\n \n-    // TODO(veil): Missing Owner Stack\n+    // TODO(veil): Missing Owner Stack (NDX-905)\n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"description\": \"Error: SSR only error\","
        }
    ],
    "stats": {
        "total": 107,
        "additions": 53,
        "deletions": 54
    }
}