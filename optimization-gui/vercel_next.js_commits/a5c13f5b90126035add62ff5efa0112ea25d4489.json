{
    "author": "ztanner",
    "message": "[tests]: de-flake client-cache.parallel-routes.test.ts (#84655)\n\nSaw this flaking when deployed. This switches it to use `router-act` which more consistently passes in my testing.",
    "sha": "a5c13f5b90126035add62ff5efa0112ea25d4489",
    "files": [
        {
            "sha": "e268d298d2bff53424594f573ce4bb3f1532a56d",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.parallel-routes.test.ts",
            "status": "modified",
            "additions": 103,
            "deletions": 51,
            "changes": 154,
            "blob_url": "https://github.com/vercel/next.js/blob/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.parallel-routes.test.ts?ref=a5c13f5b90126035add62ff5efa0112ea25d4489",
            "patch": "@@ -1,12 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n-import { Playwright } from 'next-webdriver'\n-import {\n-  browserConfigWithFixedTime,\n-  createRequestsListener,\n-  fastForwardTo,\n-  getPathname,\n-} from './test-utils'\n+import { createRouterAct } from 'router-act'\n+import { browserConfigWithFixedTime, fastForwardTo } from './test-utils'\n import path from 'path'\n \n describe('app dir client cache with parallel routes', () => {\n@@ -21,62 +15,120 @@ describe('app dir client cache with parallel routes', () => {\n   }\n \n   describe('prefetch={true}', () => {\n-    let browser: Playwright\n-\n-    beforeEach(async () => {\n-      browser = await next.browser('/', browserConfigWithFixedTime)\n-    })\n-\n     it('should prefetch the full page', async () => {\n-      const { getRequests, clearRequests } =\n-        await createRequestsListener(browser)\n-      await check(() => {\n-        return getRequests().some(\n-          ([url, didPartialPrefetch]) =>\n-            getPathname(url) === '/0' && !didPartialPrefetch\n-        )\n-          ? 'success'\n-          : 'fail'\n-      }, 'success')\n-\n-      clearRequests()\n-\n-      await browser\n-        .elementByCss('[href=\"/0\"]')\n-        .click()\n-        .waitForElementByCss('#random-number')\n-\n-      expect(getRequests().every(([url]) => getPathname(url) !== '/0')).toEqual(\n-        true\n+      let act: ReturnType<typeof createRouterAct>\n+      const browser = await next.browser('/', {\n+        beforePageLoad(page) {\n+          browserConfigWithFixedTime.beforePageLoad(page)\n+          act = createRouterAct(page)\n+        },\n+      })\n+\n+      // Reveal the link to trigger prefetch and wait for it to complete\n+      const link = await act(\n+        async () => {\n+          const reveal = await browser.elementByCss(\n+            '[data-link-accordion=\"/0\"]'\n+          )\n+          await reveal.click()\n+          return await browser.elementByCss('[href=\"/0\"]')\n+        },\n+        { includes: 'random-number' }\n       )\n+\n+      // Navigate to /0 - should not make additional requests\n+      await act(async () => {\n+        await link.click()\n+        await browser.waitForElementByCss('#random-number')\n+      }, 'no-requests')\n     })\n \n     it('should re-use the cache for the full page, only for 5 mins', async () => {\n-      const randomNumber = await browser\n-        .elementByCss('[href=\"/0\"]')\n-        .click()\n-        .waitForElementByCss('#random-number')\n-        .text()\n+      let act: ReturnType<typeof createRouterAct>\n+      const browser = await next.browser('/', {\n+        beforePageLoad(page) {\n+          browserConfigWithFixedTime.beforePageLoad(page)\n+          act = createRouterAct(page)\n+        },\n+      })\n+\n+      // Toggle the link, assert on the prefetch content\n+      const link = await act(\n+        async () => {\n+          const reveal = await browser.elementByCss(\n+            '[data-link-accordion=\"/0\"]'\n+          )\n+          await reveal.click()\n+          return await browser.elementByCss('[href=\"/0\"]')\n+        },\n+        { includes: 'random-number' }\n+      )\n \n-      await browser.elementByCss('[href=\"/\"]').click()\n+      // Navigate to the page, assert no requests are made\n+      const randomNumber = await act(async () => {\n+        await link.click()\n+        await browser.waitForElementByCss('#random-number')\n+        return await browser.elementByCss('#random-number').text()\n+      }, 'no-requests')\n+\n+      // Toggle the home link, assert on the homepage content\n+      const homeLink = await act(\n+        async () => {\n+          const reveal = await browser.elementByCss('[data-link-accordion=\"/\"]')\n+          await reveal.click()\n+          return await browser.elementByCss('[href=\"/\"]')\n+        },\n+        { includes: 'home-page' }\n+      )\n \n-      const number = await browser\n-        .elementByCss('[href=\"/0\"]')\n-        .click()\n-        .waitForElementByCss('#random-number')\n-        .text()\n+      // Navigate home, assert no requests are made\n+      await act(async () => {\n+        await homeLink.click()\n+        await browser.waitForElementByCss('#home-page')\n+      }, 'no-requests')\n+\n+      // Toggle the link to the other page again, navigate, assert no requests (because it's cached)\n+      const number = await act(async () => {\n+        const reveal = await browser.elementByCss('[data-link-accordion=\"/0\"]')\n+        await reveal.click()\n+        const link = await browser.elementByCss('[href=\"/0\"]')\n+        await link.click()\n+        await browser.waitForElementByCss('#random-number')\n+        return await browser.elementByCss('#random-number').text()\n+      }, 'no-requests')\n \n       expect(number).toBe(randomNumber)\n \n+      // Navigate back home\n+      await act(async () => {\n+        const reveal = await browser.elementByCss('[data-link-accordion=\"/\"]')\n+        await reveal.click()\n+        const homeLink = await browser.elementByCss('[href=\"/\"]')\n+        await homeLink.click()\n+        await browser.waitForElementByCss('#home-page')\n+      }, 'no-requests')\n+\n+      // Fast forward 5 minutes\n       await browser.eval(fastForwardTo, 5 * 60 * 1000)\n \n-      await browser.elementByCss('[href=\"/\"]').click()\n+      // Toggle the link to the other page again, assert on prefetch content\n+      const linkAfterExpiry = await act(\n+        async () => {\n+          const reveal = await browser.elementByCss(\n+            '[data-link-accordion=\"/0\"]'\n+          )\n+          await reveal.click()\n+          return await browser.elementByCss('[href=\"/0\"]')\n+        },\n+        { includes: 'random-number' }\n+      )\n \n-      const newNumber = await browser\n-        .elementByCss('[href=\"/0\"]')\n-        .click()\n-        .waitForElementByCss('#random-number')\n-        .text()\n+      // Navigate to the page and verify the content is fresh (different from cached)\n+      const newNumber = await act(async () => {\n+        await linkAfterExpiry.click()\n+        await browser.waitForElementByCss('#random-number')\n+        return await browser.elementByCss('#random-number').text()\n+      }, 'no-requests')\n \n       expect(newNumber).not.toBe(randomNumber)\n     })"
        },
        {
            "sha": "b366e197faf64290c156275efefa5e9148214cdf",
            "filename": "test/e2e/app-dir/app-client-cache/fixtures/parallel-routes/app/[id]/page.js",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2F%5Bid%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2F%5Bid%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2F%5Bid%5D%2Fpage.js?ref=a5c13f5b90126035add62ff5efa0112ea25d4489",
            "patch": "@@ -1,4 +1,4 @@\n-import Link from 'next/link'\n+import { LinkAccordion } from '../components/link-accordion'\n \n export default async function Page() {\n   const randomNumber = await new Promise((resolve) => {\n@@ -8,11 +8,9 @@ export default async function Page() {\n   })\n \n   return (\n-    <>\n-      <div>\n-        <Link href=\"/\">Back to Home</Link>\n-      </div>\n+    <div id=\"dynamic-page\">\n+      <LinkAccordion href=\"/\">Back to Home</LinkAccordion>\n       <div id=\"random-number\">{randomNumber}</div>\n-    </>\n+    </div>\n   )\n }"
        },
        {
            "sha": "eeb6094873185dd6b864203c71fb5e1a4d80133d",
            "filename": "test/e2e/app-dir/app-client-cache/fixtures/parallel-routes/app/components/link-accordion.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fcomponents%2Flink-accordion.tsx?ref=a5c13f5b90126035add62ff5efa0112ea25d4489",
            "patch": "@@ -0,0 +1,25 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({ href, children, prefetch = undefined }) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href} prefetch={prefetch}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "cf2a3cd5e10dede4dadbbf1d0b66efffedd77045",
            "filename": "test/e2e/app-dir/app-client-cache/fixtures/parallel-routes/app/page.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a5c13f5b90126035add62ff5efa0112ea25d4489/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Ffixtures%2Fparallel-routes%2Fapp%2Fpage.js?ref=a5c13f5b90126035add62ff5efa0112ea25d4489",
            "patch": "@@ -1,11 +1,11 @@\n-import Link from 'next/link'\n+import { LinkAccordion } from './components/link-accordion'\n \n export default function Page() {\n   return (\n-    <div>\n-      <Link href=\"/0\" prefetch={true}>\n+    <div id=\"home-page\">\n+      <LinkAccordion href=\"/0\" prefetch={true}>\n         To Dynamic Page\n-      </Link>\n+      </LinkAccordion>\n     </div>\n   )\n }"
        }
    ],
    "stats": {
        "total": 197,
        "additions": 136,
        "deletions": 61
    }
}