{
    "author": "unstubbable",
    "message": "Only log `pending revalidates...` debug log if applicable (#88221)\n\nWhen [verbose cache\nlogging](https://nextjs.org/docs/app/guides/incremental-static-regeneration#verifying-correct-production-behavior)\nis enabled, we were always adding a debug log as follows after rendering\na page (during prerendering or at request time):\n\n```\npending revalidates promise finished for: {\n  auth: null,\n  host: null,\n  hostname: null,\n  pathname: '/',\n  port: null,\n  protocol: null,\n  query: undefined,\n  search: '',\n  hash: '',\n  href: '/',\n  slashes: null\n}\n```\n\nHowever, if there were no pending revalidates to process, this log is\nmisleading as it suggests that there were pending revalidates that have\nnow been processed, while in reality there were none. So with this PR,\nwe now only log this message if there are actually any pending\nrevalidates, i.e. some tags were revalidated, a `fetch` cache entry was\nrevalidated, an `unstable_cache` entry was revalidated, or a `'use\ncache'` entry was saved to a cache handler.\n\nIn addition, the log is now shortened to only log the URL string instead\nof the full URL object for better readability, e.g.:\n\n```\npending revalidates promise finished for: /\n```",
    "sha": "bda89d1d3aeb714acaec30977045550ab7ffaf26",
    "files": [
        {
            "sha": "417ece239994302d1a2cdba5f35c513eaf039da5",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=bda89d1d3aeb714acaec30977045550ab7ffaf26",
            "patch": "@@ -1086,18 +1086,23 @@ export async function handleAction({\n \n         // For form actions, we need to continue rendering the page.\n         if (isFetchAction) {\n+          // If we skip page rendering, we need to ensure pending revalidates\n+          // are awaited before closing the response. Otherwise, this will be\n+          // done after rendering the page.\n+          const maybeRevalidatesPromise = skipPageRendering\n+            ? executeRevalidates(workStore)\n+            : false\n+\n           return {\n             type: 'done',\n             result: await generateFlight(req, ctx, requestStore, {\n               actionResult: Promise.resolve(actionResult),\n               skipPageRendering,\n               temporaryReferences,\n-              // If we skip page rendering, we need to ensure pending\n-              // revalidates are awaited before closing the response. Otherwise,\n-              // this will be done after rendering the page.\n-              waitUntil: skipPageRendering\n-                ? executeRevalidates(workStore)\n-                : undefined,\n+              waitUntil:\n+                maybeRevalidatesPromise === false\n+                  ? undefined\n+                  : maybeRevalidatesPromise,\n             }),\n           }\n         } else {"
        },
        {
            "sha": "4b8fca0eee28f1e00497a2927c2b3d0006c31820",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 20,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=bda89d1d3aeb714acaec30977045550ab7ffaf26",
            "patch": "@@ -2108,22 +2108,19 @@ async function renderToHTMLOrFlightImpl(\n       metadata,\n       contentType: HTML_CONTENT_TYPE_HEADER,\n     }\n+\n     // If we have pending revalidates, wait until they are all resolved.\n-    if (\n-      workStore.pendingRevalidates ||\n-      workStore.pendingRevalidateWrites ||\n-      workStore.pendingRevalidatedTags\n-    ) {\n-      const pendingPromise = executeRevalidates(workStore).finally(() => {\n+    const maybeRevalidatesPromise = executeRevalidates(workStore)\n+    if (maybeRevalidatesPromise !== false) {\n+      const revalidatesPromise = maybeRevalidatesPromise.finally(() => {\n         if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n-          console.log('pending revalidates promise finished for:', url)\n+          console.log('pending revalidates promise finished for:', url.href)\n         }\n       })\n-\n       if (renderOpts.waitUntil) {\n-        renderOpts.waitUntil(pendingPromise)\n+        renderOpts.waitUntil(revalidatesPromise)\n       } else {\n-        options.waitUntil = pendingPromise\n+        options.waitUntil = revalidatesPromise\n       }\n     }\n \n@@ -2290,21 +2287,17 @@ async function renderToHTMLOrFlightImpl(\n     }\n \n     // If we have pending revalidates, wait until they are all resolved.\n-    if (\n-      workStore.pendingRevalidates ||\n-      workStore.pendingRevalidateWrites ||\n-      workStore.pendingRevalidatedTags\n-    ) {\n-      const pendingPromise = executeRevalidates(workStore).finally(() => {\n+    const maybeRevalidatesPromise = executeRevalidates(workStore)\n+    if (maybeRevalidatesPromise !== false) {\n+      const revalidatesPromise = maybeRevalidatesPromise.finally(() => {\n         if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n-          console.log('pending revalidates promise finished for:', url)\n+          console.log('pending revalidates promise finished for:', url.href)\n         }\n       })\n-\n       if (renderOpts.waitUntil) {\n-        renderOpts.waitUntil(pendingPromise)\n+        renderOpts.waitUntil(revalidatesPromise)\n       } else {\n-        options.waitUntil = pendingPromise\n+        options.waitUntil = revalidatesPromise\n       }\n     }\n "
        },
        {
            "sha": "5a2f844f720fbd38864ca239e2bc2ec25f5b9a39",
            "filename": "packages/next/src/server/revalidation-utils.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 12,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts?ref=bda89d1d3aeb714acaec30977045550ab7ffaf26",
            "patch": "@@ -183,26 +183,39 @@ async function revalidateTags(\n   await Promise.all(promises)\n }\n \n-export async function executeRevalidates(\n+export function executeRevalidates(\n   workStore: WorkStore,\n   state?: RevalidationState\n-) {\n+): false | Promise<void> {\n+  const promises: Promise<unknown>[] = []\n+\n   const pendingRevalidatedTags =\n     state?.pendingRevalidatedTags ?? workStore.pendingRevalidatedTags ?? []\n \n-  const pendingRevalidates =\n+  if (pendingRevalidatedTags.length > 0) {\n+    promises.push(\n+      revalidateTags(\n+        pendingRevalidatedTags,\n+        workStore.incrementalCache,\n+        workStore\n+      )\n+    )\n+  }\n+\n+  const pendingRevalidates = Object.values(\n     state?.pendingRevalidates ?? workStore.pendingRevalidates ?? {}\n+  )\n+\n+  promises.push(...pendingRevalidates)\n \n   const pendingRevalidateWrites =\n     state?.pendingRevalidateWrites ?? workStore.pendingRevalidateWrites ?? []\n \n-  return Promise.all([\n-    revalidateTags(\n-      pendingRevalidatedTags,\n-      workStore.incrementalCache,\n-      workStore\n-    ),\n-    ...Object.values(pendingRevalidates),\n-    ...pendingRevalidateWrites,\n-  ])\n+  promises.push(...pendingRevalidateWrites)\n+\n+  if (promises.length === 0) {\n+    return false\n+  }\n+\n+  return Promise.all(promises).then(() => undefined)\n }"
        },
        {
            "sha": "a6e1c8d1f88902bbd22004fd99ff09301d22d2e5",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda89d1d3aeb714acaec30977045550ab7ffaf26/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=bda89d1d3aeb714acaec30977045550ab7ffaf26",
            "patch": "@@ -331,16 +331,20 @@ export class AppRouteRouteModule extends RouteModule<\n     }\n \n     const resolvePendingRevalidations = () => {\n-      context.renderOpts.pendingWaitUntil = executeRevalidates(\n-        workStore\n-      ).finally(() => {\n-        if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n-          console.log(\n-            'pending revalidates promise finished for:',\n-            requestStore.url\n-          )\n-        }\n-      })\n+      const maybeRevalidatesPromise = executeRevalidates(workStore)\n+\n+      if (maybeRevalidatesPromise !== false) {\n+        context.renderOpts.pendingWaitUntil = maybeRevalidatesPromise.finally(\n+          () => {\n+            if (process.env.NEXT_PRIVATE_DEBUG_CACHE) {\n+              console.log(\n+                'pending revalidates promise finished for:',\n+                requestStore.url.pathname + requestStore.url.search\n+              )\n+            }\n+          }\n+        )\n+      }\n     }\n \n     let prerenderStore: null | PrerenderStore = null"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 63,
        "deletions": 48
    }
}