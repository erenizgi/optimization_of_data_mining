{
    "author": "bgw",
    "message": "feat: Acquire a lockfile on `distDir` in `next dev` and `next build` (#84428)\n\nhttps://github.com/vercel/next.js/pull/83961 lets you run both `next dev` and `next build` at the same time, however it's still problematic to run two instances of `next dev` or two instances of `next build` at the same time with the same `distDir`.\n\nThis sort of thing can happen to anyone by accident, but we've seen reports of this sort of behavior with AI agents.\n\nhttps://github.com/vercel/next.js/pull/84378 adds a lockfile around just the persistent cache database in Turbopack, which helps, but it's not the only reason this is problematic, so we also need a lock around all of Next.js itself.\n\nI was not able to find a cross-platform lockfile implementation in node that I felt was of sufficient quality, so on POSIX platforms this uses the recently-stabilized Rust stdlib implementation, which appears to be derived from rustc's own lockfile implementation, which has seen widespread use/deployment.\n\nOn Windows, since we'd rather have an advisory lock than a mandatory one, this emulates that by instead opening a file with write permissions, and a sharing mode that prohibits shared write access. That means that other processes can safely read the (empty) lockfile without blowing up.\n\n<img width=\"500\" src=\"https://github.com/user-attachments/assets/1ee4a6c6-2280-4f64-8bf2-ec5369c26db1\" />\n<img width=\"500\" src=\"https://github.com/user-attachments/assets/2b04b566-c0b4-42ce-af34-912f3f6afa72\" />\n\nTested on Windows as well:\n\n<img width=\"1224\" height=\"690\" alt=\"Screenshot 2025-10-07 at 5 44 33â€¯PM\" src=\"https://github.com/user-attachments/assets/e36085b6-9c32-40ac-aca6-4c83e2a53842\" />",
    "sha": "0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
    "files": [
        {
            "sha": "ea64ac1c9536e6622f893809d71d27b2065a853a",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 89,
            "deletions": 36,
            "changes": 125,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -1063,7 +1063,7 @@ dependencies = [\n  \"num-traits\",\n  \"serde\",\n  \"wasm-bindgen\",\n- \"windows-link\",\n+ \"windows-link 0.1.1\",\n ]\n \n [[package]]\n@@ -2951,16 +2951,17 @@ dependencies = [\n \n [[package]]\n name = \"iana-time-zone\"\n-version = \"0.1.57\"\n+version = \"0.1.64\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"2fad5b825842d2b38bd206f3e81d6957625fd7f0a361e345c30e01a0ae2dd613\"\n+checksum = \"33e57f83510bb73707521ebaffa789ec8caf86f9657cad665b092b581d40e9fb\"\n dependencies = [\n  \"android_system_properties\",\n  \"core-foundation-sys\",\n  \"iana-time-zone-haiku\",\n  \"js-sys\",\n+ \"log\",\n  \"wasm-bindgen\",\n- \"windows\",\n+ \"windows-core\",\n ]\n \n [[package]]\n@@ -4441,6 +4442,7 @@ dependencies = [\n  \"url\",\n  \"urlencoding\",\n  \"vergen-gitcl\",\n+ \"windows-sys 0.60.2\",\n ]\n \n [[package]]\n@@ -4885,7 +4887,7 @@ dependencies = [\n  \"libc\",\n  \"redox_syscall\",\n  \"smallvec\",\n- \"windows-targets 0.48.1\",\n+ \"windows-targets 0.48.5\",\n ]\n \n [[package]]\n@@ -11194,12 +11196,38 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f\"\n \n [[package]]\n-name = \"windows\"\n-version = \"0.48.0\"\n+name = \"windows-core\"\n+version = \"0.62.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b8e83a14d34d0623b51dce9581199302a221863196a1dde71a7663a4c2be9deb\"\n+dependencies = [\n+ \"windows-implement\",\n+ \"windows-interface\",\n+ \"windows-link 0.2.1\",\n+ \"windows-result\",\n+ \"windows-strings\",\n+]\n+\n+[[package]]\n+name = \"windows-implement\"\n+version = \"0.60.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"053e2e040ab57b9dc951b72c264860db7eb3b0200ba345b4e4c3b14f67855ddf\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.104\",\n+]\n+\n+[[package]]\n+name = \"windows-interface\"\n+version = \"0.59.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e686886bc078bc1b0b600cac0147aadb815089b6e4da64016cbd754b6342700f\"\n+checksum = \"3f316c4a2570ba26bbec722032c4099d8c8bc095efccdc15688708623367e358\"\n dependencies = [\n- \"windows-targets 0.48.1\",\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.104\",\n ]\n \n [[package]]\n@@ -11208,6 +11236,30 @@ version = \"0.1.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"76840935b766e1b0a05c0066835fb9ec80071d4c09a16f6bd5f7e655e3c14c38\"\n \n+[[package]]\n+name = \"windows-link\"\n+version = \"0.2.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"f0805222e57f7521d6a62e36fa9163bc891acd422f971defe97d64e70d0a4fe5\"\n+\n+[[package]]\n+name = \"windows-result\"\n+version = \"0.4.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7781fa89eaf60850ac3d2da7af8e5242a5ea78d1a11c49bf2910bb5a73853eb5\"\n+dependencies = [\n+ \"windows-link 0.2.1\",\n+]\n+\n+[[package]]\n+name = \"windows-strings\"\n+version = \"0.5.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7837d08f69c77cf6b07689544538e017c1bfcf57e34b4c0ff58e6c2cd3b37091\"\n+dependencies = [\n+ \"windows-link 0.2.1\",\n+]\n+\n [[package]]\n name = \"windows-sys\"\n version = \"0.42.0\"\n@@ -11238,7 +11290,7 @@ version = \"0.48.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"677d2418bec65e3338edb076e806bc1ec15693c5d0104683f2efe857f61056a9\"\n dependencies = [\n- \"windows-targets 0.48.1\",\n+ \"windows-targets 0.48.5\",\n ]\n \n [[package]]\n@@ -11265,7 +11317,7 @@ version = \"0.60.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"f2f500e4d28234f72040990ec9d39e3a6b950f9f22d3dba18416c35882612bcb\"\n dependencies = [\n- \"windows-targets 0.53.2\",\n+ \"windows-targets 0.53.5\",\n ]\n \n [[package]]\n@@ -11285,17 +11337,17 @@ dependencies = [\n \n [[package]]\n name = \"windows-targets\"\n-version = \"0.48.1\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"05d4b17490f70499f20b9e791dcf6a299785ce8af4d709018206dc5b4953e95f\"\n+checksum = \"9a2fa6e2155d7247be68c096456083145c183cbbbc2764150dda45a87197940c\"\n dependencies = [\n- \"windows_aarch64_gnullvm 0.48.0\",\n- \"windows_aarch64_msvc 0.48.0\",\n- \"windows_i686_gnu 0.48.0\",\n- \"windows_i686_msvc 0.48.0\",\n- \"windows_x86_64_gnu 0.48.0\",\n- \"windows_x86_64_gnullvm 0.48.0\",\n- \"windows_x86_64_msvc 0.48.0\",\n+ \"windows_aarch64_gnullvm 0.48.5\",\n+ \"windows_aarch64_msvc 0.48.5\",\n+ \"windows_i686_gnu 0.48.5\",\n+ \"windows_i686_msvc 0.48.5\",\n+ \"windows_x86_64_gnu 0.48.5\",\n+ \"windows_x86_64_gnullvm 0.48.5\",\n+ \"windows_x86_64_msvc 0.48.5\",\n ]\n \n [[package]]\n@@ -11316,10 +11368,11 @@ dependencies = [\n \n [[package]]\n name = \"windows-targets\"\n-version = \"0.53.2\"\n+version = \"0.53.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"c66f69fcc9ce11da9966ddb31a40968cad001c5bedeb5c2b82ede4253ab48aef\"\n+checksum = \"4945f9f551b88e0d65f3db0bc25c33b8acea4d9e41163edf90dcd0b19f9069f3\"\n dependencies = [\n+ \"windows-link 0.2.1\",\n  \"windows_aarch64_gnullvm 0.53.0\",\n  \"windows_aarch64_msvc 0.53.0\",\n  \"windows_i686_gnu 0.53.0\",\n@@ -11338,9 +11391,9 @@ checksum = \"597a5118570b68bc08d8d59125332c54f1ba9d9adeedeef5b99b02ba2b0698f8\"\n \n [[package]]\n name = \"windows_aarch64_gnullvm\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"91ae572e1b79dba883e0d315474df7305d12f569b400fcf90581b06062f7e1bc\"\n+checksum = \"2b38e32f0abccf9987a4e3079dfb67dcd799fb61361e53e2882c3cbaf0d905d8\"\n \n [[package]]\n name = \"windows_aarch64_gnullvm\"\n@@ -11362,9 +11415,9 @@ checksum = \"e08e8864a60f06ef0d0ff4ba04124db8b0fb3be5776a5cd47641e942e58c4d43\"\n \n [[package]]\n name = \"windows_aarch64_msvc\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"b2ef27e0d7bdfcfc7b868b317c1d32c641a6fe4629c171b8928c7b08d98d7cf3\"\n+checksum = \"dc35310971f3b2dbbf3f0690a219f40e2d9afcf64f9ab7cc1be722937c26b4bc\"\n \n [[package]]\n name = \"windows_aarch64_msvc\"\n@@ -11386,9 +11439,9 @@ checksum = \"c61d927d8da41da96a81f029489353e68739737d3beca43145c8afec9a31a84f\"\n \n [[package]]\n name = \"windows_i686_gnu\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"622a1962a7db830d6fd0a69683c80a18fda201879f0f447f065a3b7467daa241\"\n+checksum = \"a75915e7def60c94dcef72200b9a8e58e5091744960da64ec734a6c6e9b3743e\"\n \n [[package]]\n name = \"windows_i686_gnu\"\n@@ -11422,9 +11475,9 @@ checksum = \"44d840b6ec649f480a41c8d80f9c65108b92d89345dd94027bfe06ac444d1060\"\n \n [[package]]\n name = \"windows_i686_msvc\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"4542c6e364ce21bf45d69fdd2a8e455fa38d316158cfd43b3ac1c5b1b19f8e00\"\n+checksum = \"8f55c233f70c4b27f66c523580f78f1004e8b5a8b659e05a4eb49d4166cca406\"\n \n [[package]]\n name = \"windows_i686_msvc\"\n@@ -11446,9 +11499,9 @@ checksum = \"8de912b8b8feb55c064867cf047dda097f92d51efad5b491dfb98f6bbb70cb36\"\n \n [[package]]\n name = \"windows_x86_64_gnu\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"ca2b8a661f7628cbd23440e50b05d705db3686f894fc9580820623656af974b1\"\n+checksum = \"53d40abd2583d23e4718fddf1ebec84dbff8381c07cae67ff7768bbf19c6718e\"\n \n [[package]]\n name = \"windows_x86_64_gnu\"\n@@ -11470,9 +11523,9 @@ checksum = \"26d41b46a36d453748aedef1486d5c7a85db22e56aff34643984ea85514e94a3\"\n \n [[package]]\n name = \"windows_x86_64_gnullvm\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"7896dbc1f41e08872e9d5e8f8baa8fdd2677f29468c4e156210174edc7f7b953\"\n+checksum = \"0b7b52767868a23d5bab768e390dc5f5c55825b6d30b86c844ff2dc7414044cc\"\n \n [[package]]\n name = \"windows_x86_64_gnullvm\"\n@@ -11494,9 +11547,9 @@ checksum = \"9aec5da331524158c6d1a4ac0ab1541149c0b9505fde06423b02f5ef0106b9f0\"\n \n [[package]]\n name = \"windows_x86_64_msvc\"\n-version = \"0.48.0\"\n+version = \"0.48.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"1a515f5799fe4961cb532f983ce2b23082366b898e52ffbce459c86f67c8378a\"\n+checksum = \"ed94fce61571a4006852b7389a063ab983c02eb1bb37b47f8272ce92d06d9538\"\n \n [[package]]\n name = \"windows_x86_64_msvc\""
        },
        {
            "sha": "f78a8112914485b39baff30dff2f247ed4f1840b",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -123,6 +123,8 @@ turbopack-trace-utils = { workspace = true }\n turbopack-trace-server = { workspace = true }\n turbopack-ecmascript-plugins = { workspace = true, optional = true }\n \n+[target.'cfg(windows)'.dependencies]\n+windows-sys = \"0.60\"\n \n # Dependencies for the wasm32 build.\n [target.'cfg(target_arch = \"wasm32\")'.dependencies]"
        },
        {
            "sha": "dbb00d0591032e31ed17c303e51f8dac680c14b5",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -43,8 +43,10 @@ use swc_core::{\n     base::{Compiler, TransformOutput},\n     common::{FilePathMapping, SourceMap},\n };\n+\n #[cfg(not(target_arch = \"wasm32\"))]\n pub mod css;\n+pub mod lockfile;\n pub mod mdx;\n pub mod minify;\n #[cfg(not(target_arch = \"wasm32\"))]"
        },
        {
            "sha": "3566d6612864330d228c9ef2f6fdd06a55300137",
            "filename": "crates/napi/src/lockfile.rs",
            "status": "added",
            "additions": 120,
            "deletions": 0,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2Fsrc%2Flockfile.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/crates%2Fnapi%2Fsrc%2Flockfile.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flockfile.rs?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -0,0 +1,120 @@\n+use std::{\n+    fs::{File, OpenOptions},\n+    mem::ManuallyDrop,\n+    sync::Mutex,\n+};\n+\n+use anyhow::Context;\n+use napi::bindgen_prelude::External;\n+\n+/// A wrapper around [`File`] that is passed to JS, and is set to `None` when [`lockfile_unlock`] is\n+/// called.\n+///\n+/// This uses [`ManuallyDrop`] to prevent exposing close-on-drop semantics to JS, as its not\n+/// idiomatic to rely on GC behaviors in JS.\n+///\n+/// When the file is unlocked, the file at that path will be deleted (best-effort).\n+type JsLockfile = Mutex<ManuallyDrop<Option<LockfileInner>>>;\n+\n+pub struct LockfileInner {\n+    file: File,\n+    #[cfg(not(windows))]\n+    path: std::path::PathBuf,\n+}\n+\n+#[napi(ts_return_type = \"{ __napiType: \\\"Lockfile\\\" } | null\")]\n+pub fn lockfile_try_acquire_sync(path: String) -> napi::Result<Option<External<JsLockfile>>> {\n+    let mut open_options = OpenOptions::new();\n+    open_options.write(true).create(true);\n+\n+    // On Windows, we don't use `File::lock` because that grabs a mandatory lock. That can break\n+    // tools or code that read the contents of the `.next` directory because the mandatory lock\n+    // file will fail with EBUSY when read. Instead, we open a file with write mode, but without\n+    // `FILE_SHARE_WRITE`. That gives us behavior closer to what we get on POSIX platforms.\n+    //\n+    // On POSIX platforms, Rust uses `flock` which creates an advisory lock, which can be\n+    // read/written/deleted.\n+\n+    #[cfg(windows)]\n+    return {\n+        use std::os::windows::fs::OpenOptionsExt;\n+\n+        use windows_sys::Win32::{Foundation, Storage::FileSystem};\n+\n+        open_options\n+            .share_mode(FileSystem::FILE_SHARE_READ | FileSystem::FILE_SHARE_DELETE)\n+            .custom_flags(FileSystem::FILE_FLAG_DELETE_ON_CLOSE);\n+        match open_options.open(&path) {\n+            Ok(file) => Ok(Some(External::new(Mutex::new(ManuallyDrop::new(Some(\n+                LockfileInner { file },\n+            )))))),\n+            Err(err)\n+                if err.raw_os_error()\n+                    == Some(Foundation::ERROR_SHARING_VIOLATION.try_into().unwrap()) =>\n+            {\n+                Ok(None)\n+            }\n+            Err(err) => Err(err.into()),\n+        }\n+    };\n+\n+    #[cfg(not(windows))]\n+    return {\n+        use std::fs::TryLockError;\n+\n+        let file = open_options.open(&path)?;\n+        match file.try_lock() {\n+            Ok(_) => Ok(Some(External::new(Mutex::new(ManuallyDrop::new(Some(\n+                LockfileInner {\n+                    file,\n+                    path: path.into(),\n+                },\n+            )))))),\n+            Err(TryLockError::WouldBlock) => Ok(None),\n+            Err(TryLockError::Error(err)) => Err(err.into()),\n+        }\n+    };\n+}\n+\n+#[napi(ts_return_type = \"Promise<{ __napiType: \\\"Lockfile\\\" } | null>\")]\n+pub async fn lockfile_try_acquire(path: String) -> napi::Result<Option<External<JsLockfile>>> {\n+    tokio::task::spawn_blocking(move || lockfile_try_acquire_sync(path))\n+        .await\n+        .context(\"panicked while attempting to acquire lockfile\")?\n+}\n+\n+#[napi]\n+pub fn lockfile_unlock_sync(\n+    #[napi(ts_arg_type = \"{ __napiType: \\\"Lockfile\\\" }\")] lockfile: External<JsLockfile>,\n+) {\n+    // We don't need the file handle anymore, so we don't need to call `File::unlock`. Locks are\n+    // released during `drop`. Remove it from the `ManuallyDrop` wrapper.\n+    let Some(inner): Option<LockfileInner> = lockfile\n+        .lock()\n+        .expect(\"poisoned: another thread panicked during `lockfile_unlock_sync`?\")\n+        .take()\n+    else {\n+        return;\n+    };\n+\n+    // - We use `FILE_FLAG_DELETE_ON_CLOSE` on Windows, so we don't need to delete the file there.\n+    // - Ignore possible errors while removing the file, it only matters that we release the lock.\n+    // - Delete *before* releasing the lock to avoid race conditions where we might accidentally\n+    //   delete another process's lockfile. This relies on POSIX semantics, letting us delete an\n+    //   open file.\n+    #[cfg(not(windows))]\n+    let _ = std::fs::remove_file(inner.path);\n+\n+    drop(inner.file);\n+}\n+\n+#[napi]\n+pub async fn lockfile_unlock(\n+    #[napi(ts_arg_type = \"{ __napiType: \\\"Lockfile\\\" }\")] lockfile: External<JsLockfile>,\n+) -> napi::Result<()> {\n+    Ok(\n+        tokio::task::spawn_blocking(move || lockfile_unlock_sync(lockfile))\n+            .await\n+            .context(\"panicked while attempting to unlock lockfile\")?,\n+    )\n+}"
        },
        {
            "sha": "850446c6fe5a626400e37da40e273c79bb2eee1d",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -852,5 +852,10 @@\n   \"851\": \"Pass either `webpack` or `turbopack`, not both.\",\n   \"852\": \"Only custom servers can pass `webpack`, `turbo`, or `turbopack`.\",\n   \"853\": \"Turbopack build failed\",\n-  \"854\": \"Expected a %s request header.\"\n+  \"854\": \"Expected a %s request header.\",\n+  \"855\": \"`lockfileTryAcquire` is not supported by the wasm bindings.\",\n+  \"856\": \"`lockfileTryAcquireSync` is not supported by the wasm bindings.\",\n+  \"857\": \"`lockfileUnlock` is not supported by the wasm bindings.\",\n+  \"858\": \"`lockfileUnlockSync` is not supported by the wasm bindings.\",\n+  \"859\": \"An IO error occurred while attempting to create and acquire the lockfile\"\n }"
        },
        {
            "sha": "fd059406d324ad93eda5a09eb099f2a8604dfe58",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -226,6 +226,7 @@ import {\n   writeRouteTypesManifest,\n   writeValidatorFile,\n } from '../server/lib/router-utils/route-types-utils'\n+import { Lockfile } from './lockfile'\n \n type Fallback = null | boolean | string\n \n@@ -1036,11 +1037,20 @@ export default async function build(\n         )\n       }\n \n+      if (config.experimental.lockDistDir) {\n+        // This leaks the lock file descriptor. That's okay, it'll be cleaned up by the OS upon\n+        // process exit.\n+        await Lockfile.acquireWithRetriesOrExit(\n+          path.join(distDir, 'lock'),\n+          'next build'\n+        )\n+      }\n+\n       if (config.cleanDistDir && !isGenerateMode) {\n         await nextBuildSpan\n           .traceChild('clean')\n           .traceAsyncFn(() =>\n-            recursiveDeleteSyncWithAsyncRetries(distDir, /^(cache|dev)/)\n+            recursiveDeleteSyncWithAsyncRetries(distDir, /^(cache|dev|lock)/)\n           )\n       }\n "
        },
        {
            "sha": "c06d21145594759a1d70ae55dd73ef289048ed76",
            "filename": "packages/next/src/build/lockfile.ts",
            "status": "added",
            "additions": 170,
            "deletions": 0,
            "changes": 170,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -0,0 +1,170 @@\n+import { bold, cyan } from '../lib/picocolors'\n+import * as Log from './output/log'\n+\n+import type { Binding, Lockfile as NativeLockfile } from './swc/types'\n+\n+const RETRY_DELAY_MS = 10\n+const MAX_RETRY_MS = 1000\n+\n+/**\n+ * A cross-platform on-disk best-effort advisory exclusive lockfile\n+ * implementation.\n+ *\n+ * On Windows, this opens a file in write mode with the `FILE_SHARE_WRITE` flag\n+ * unset, so it still allows reading the lockfile. This avoids breaking tools\n+ * that read the contents of `.next`.\n+ *\n+ * On POSIX platforms, this uses `flock()` via `std::fs::File::try_lock`:\n+ * https://doc.rust-lang.org/std/fs/struct.File.html#method.try_lock\n+ *\n+ * On WASM, a dummy implementation is used which always \"succeeds\" in acquiring\n+ * the lock.\n+ *\n+ * This provides a more idiomatic wrapper around the lockfile APIs exposed on\n+ * the native bindings object.\n+ *\n+ * If this lock is not explicitly closed with `unlock`, we will:\n+ * - If `unlockOnExit` is set (the default), it will make a best-effort attempt\n+ *   to unlock the lockfile using `process.on('exit', ...)`. This is preferrable\n+ *   on Windows where it may take some time after process exit for the operating\n+ *   system to clean up locks that are not explicitly released by the process.\n+ * - If we fail to ever release the lockfile, the operating system will clean up\n+ *   the lock and file descriptor upon process exit.\n+ */\n+export class Lockfile {\n+  /**\n+   * The underlying `Lockfile` object returned by the native bindings.\n+   *\n+   * This can be `undefined` on wasm, where we don't acquire a real lockfile.\n+   */\n+  private bindings: Binding\n+  private nativeLockfile: NativeLockfile | undefined\n+  private listener: NodeJS.ExitListener | undefined\n+\n+  private constructor(\n+    bindings: Binding,\n+    nativeLockfile: NativeLockfile | undefined\n+  ) {\n+    this.bindings = bindings\n+    this.nativeLockfile = nativeLockfile\n+  }\n+\n+  /**\n+   * Attempts to create or acquire an exclusive lockfile on disk. Lockfiles are\n+   * best-effort, depending on the platform.\n+   *\n+   * - If we fail to acquire the lock, we return `undefined`.\n+   * - If we're on wasm, this always returns a dummy `Lockfile` object.\n+   */\n+  static async tryAcquire(\n+    path: string,\n+    unlockOnExit: boolean = true\n+  ): Promise<Lockfile | undefined> {\n+    const { loadBindings } = require('./swc') as typeof import('./swc')\n+    // Ideally we could provide a sync version of `tryAcquire`, but\n+    // `loadBindings` is async. We're okay with skipping async-loaded wasm\n+    // bindings and the internal `loadNative` function is synchronous, but it\n+    // lacks some checks that `loadBindings` has.\n+    const bindings = await loadBindings()\n+    if (bindings.isWasm) {\n+      Log.info(\n+        `Skipping creating a lockfile at ${cyan(path)} because we're using WASM bindings`\n+      )\n+      return new Lockfile(bindings, undefined)\n+    } else {\n+      let nativeLockfile\n+      try {\n+        nativeLockfile = await bindings.lockfileTryAcquire(path)\n+      } catch (e) {\n+        // this happens if there's an IO error (e.g. `ENOENT`), which is\n+        // different than if we just didn't acquire the lock\n+        throw new Error(\n+          'An IO error occurred while attempting to create and acquire the lockfile',\n+          { cause: e }\n+        )\n+      }\n+      if (nativeLockfile != null) {\n+        const jsLockfile = new Lockfile(bindings, nativeLockfile)\n+        if (unlockOnExit) {\n+          const exitListener = () => {\n+            // Best-Effort: If we don't do this, the operating system will\n+            // release the lock for us. This gives an opportunity to delete the\n+            // unlocked lockfile (which is not otherwise deleted on POSIX).\n+            //\n+            // This must be synchronous because `process.on('exit', ...)` is\n+            // synchronous.\n+            jsLockfile.unlockSync()\n+          }\n+          process.on('exit', exitListener)\n+          jsLockfile.listener = exitListener\n+        }\n+        return jsLockfile\n+      } else {\n+        return undefined\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Attempts to create or acquire a lockfile using `Lockfile.tryAcquire`. If\n+   * that returns `undefined`, indicating that another process or caller has the\n+   * lockfile, then this will output an error message and exit the process with\n+   * a non-zero exit code.\n+   *\n+   * This will retry a small number of times. This can be useful when running\n+   * processes in a loop, e.g. if cleanup isn't fully synchronous due to child\n+   * parent/processes.\n+   */\n+  static async acquireWithRetriesOrExit(\n+    path: string,\n+    processName: string,\n+    unlockOnExit: boolean = true\n+  ): Promise<Lockfile> {\n+    const startMs = Date.now()\n+    let lockfile\n+    while (Date.now() - startMs < MAX_RETRY_MS) {\n+      lockfile = await Lockfile.tryAcquire(path, unlockOnExit)\n+      if (lockfile !== undefined) break\n+      await new Promise((resolve) => setTimeout(resolve, RETRY_DELAY_MS))\n+    }\n+    if (lockfile === undefined) {\n+      Log.error(\n+        `Unable to acquire lock at ${cyan(path)}, is another instance of ${cyan(processName)} running?`\n+      )\n+      Log.info(\n+        `${bold('Suggestion:')} If you intended to restart ${cyan(processName)}, terminate the other process, and then try again.`\n+      )\n+      process.exit(1)\n+    }\n+    return lockfile\n+  }\n+\n+  /**\n+   * Releases the lockfile and closes the file descriptor.\n+   *\n+   * If this is not called, the lock will be released by the operating system\n+   * when the file handle is closed during process exit.\n+   */\n+  async unlock(): Promise<void> {\n+    const { nativeLockfile, listener } = this\n+    if (nativeLockfile !== undefined) {\n+      await this.bindings.lockfileUnlock(nativeLockfile)\n+    }\n+    if (listener !== undefined) {\n+      process.off('exit', listener)\n+    }\n+  }\n+\n+  /**\n+   * A blocking version of `unlock`.\n+   */\n+  unlockSync(): void {\n+    const { nativeLockfile, listener } = this\n+    if (nativeLockfile !== undefined) {\n+      this.bindings.lockfileUnlockSync(nativeLockfile)\n+    }\n+    if (listener !== undefined) {\n+      process.off('exit', listener)\n+    }\n+  }\n+}"
        },
        {
            "sha": "f5b55f6f0f11801632275c9b8519e63de631e406",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 6,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -34,18 +34,30 @@ export declare class ExternalObject<T> {\n     [K: symbol]: T\n   }\n }\n-export interface TransformOutput {\n-  code: string\n-  map?: string\n-  output?: string\n-  diagnostics: Array<string>\n-}\n+export declare function lockfileTryAcquireSync(\n+  path: string\n+): { __napiType: 'Lockfile' } | null\n+export declare function lockfileTryAcquire(\n+  path: string\n+): Promise<{ __napiType: 'Lockfile' } | null>\n+export declare function lockfileUnlockSync(lockfile: {\n+  __napiType: 'Lockfile'\n+}): void\n+export declare function lockfileUnlock(lockfile: {\n+  __napiType: 'Lockfile'\n+}): Promise<void>\n export declare function mdxCompile(\n   value: string,\n   option: Buffer,\n   signal?: AbortSignal | undefined | null\n ): Promise<unknown>\n export declare function mdxCompileSync(value: string, option: Buffer): string\n+export interface TransformOutput {\n+  code: string\n+  map?: string\n+  output?: string\n+  diagnostics: Array<string>\n+}\n export declare function minify(\n   input: Buffer,\n   opts: Buffer,"
        },
        {
            "sha": "6bf3b014d32e28d7d7695ecba329710c2a5615c6",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 4,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -29,6 +29,7 @@ import type {\n   DefineEnv,\n   Endpoint,\n   HmrIdentifiers,\n+  Lockfile,\n   Project,\n   ProjectOptions,\n   RawEntrypoints,\n@@ -184,15 +185,15 @@ export const lockfilePatchPromise: { cur?: Promise<void> } = {}\n export async function loadBindings(\n   useWasmBinary: boolean = false\n ): Promise<Binding> {\n+  if (pendingBindings) {\n+    return pendingBindings\n+  }\n+\n   // Increase Rust stack size as some npm packages being compiled need more than the default.\n   if (!process.env.RUST_MIN_STACK) {\n     process.env.RUST_MIN_STACK = '8388608'\n   }\n \n-  if (pendingBindings) {\n-    return pendingBindings\n-  }\n-\n   if (process.env.NEXT_TEST_WASM) {\n     useWasmBinary = true\n   }\n@@ -1283,6 +1284,24 @@ async function loadWasm(importPath = '') {\n         imports\n       )\n     },\n+    lockfileTryAcquire(_filePath: string) {\n+      throw new Error(\n+        '`lockfileTryAcquire` is not supported by the wasm bindings.'\n+      )\n+    },\n+    lockfileTryAcquireSync(_filePath: string) {\n+      throw new Error(\n+        '`lockfileTryAcquireSync` is not supported by the wasm bindings.'\n+      )\n+    },\n+    lockfileUnlock(_lockfile: Lockfile) {\n+      throw new Error('`lockfileUnlock` is not supported by the wasm bindings.')\n+    },\n+    lockfileUnlockSync(_lockfile: Lockfile) {\n+      throw new Error(\n+        '`lockfileUnlockSync` is not supported by the wasm bindings.'\n+      )\n+    },\n   }\n   return wasmBindings\n }\n@@ -1485,6 +1504,18 @@ function loadNative(importPath?: string) {\n           imports\n         )\n       },\n+      lockfileTryAcquire(filePath: string) {\n+        return bindings.lockfileTryAcquire(filePath)\n+      },\n+      lockfileTryAcquireSync(filePath: string) {\n+        return bindings.lockfileTryAcquireSync(filePath)\n+      },\n+      lockfileUnlock(lockfile: Lockfile) {\n+        return bindings.lockfileUnlock(lockfile)\n+      },\n+      lockfileUnlockSync(lockfile: Lockfile) {\n+        return bindings.lockfileUnlockSync(lockfile)\n+      },\n     }\n     return nativeBindings\n   }"
        },
        {
            "sha": "7e251f2b515b7511664bcbdc55139f426f4f5c9f",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -9,6 +9,8 @@ import type {\n \n export type { NapiTurboEngineOptions as TurboEngineOptions }\n \n+export type Lockfile = { __napiType: 'Lockfile' }\n+\n export interface Binding {\n   isWasm: boolean\n   turbo: {\n@@ -63,6 +65,11 @@ export interface Binding {\n     injections: Record<string, string>,\n     imports: Record<string, string | null>\n   ): string\n+\n+  lockfileTryAcquire(path: string): Promise<Lockfile | null>\n+  lockfileTryAcquireSync(path: string): Lockfile | null\n+  lockfileUnlock(lockfile: Lockfile): Promise<void>\n+  lockfileUnlockSync(lockfile: Lockfile): void\n }\n \n export type StyledString ="
        },
        {
            "sha": "31ddf66d65a7c9370ce03d7ae544f9bac8dfc82c",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -344,7 +344,9 @@ export const experimentalSchema = {\n       }),\n     ])\n     .optional(),\n+  lockDistDir: z.boolean().optional(),\n }\n+\n export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n   z.strictObject({\n     allowedDevOrigins: z.array(z.string()).optional(),"
        },
        {
            "sha": "5ec7cf193f2cacd3c65856f9f5c86d46a60fc382",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -491,6 +491,13 @@ export interface ExperimentalConfig {\n    */\n   turbopackUseBuiltinSass?: boolean\n \n+  /**\n+   * The module ID strategy to use for Turbopack.\n+   * If not set, the default is `'named'` for development and `'deterministic'`\n+   * for production.\n+   */\n+  turbopackModuleIds?: 'named' | 'deterministic'\n+\n   /**\n    * For use with `@next/mdx`. Compile MDX files using the new Rust compiler.\n    * @see https://nextjs.org/docs/app/api-reference/next-config-js/mdxRs\n@@ -800,11 +807,17 @@ export interface ExperimentalConfig {\n   mcpServer?: boolean\n \n   /**\n-   * The module ID strategy to use for Turbopack.\n-   * If not set, the default is `'named'` for development and `'deterministic'`\n-   * for production.\n+   * Acquires a lockfile at `<distDir>/lock` when starting `next dev` or `next\n+   * build`. Failing to acquire the lock causes the process to exit with an\n+   * error message.\n+   *\n+   * This is because if multiple processes write to the same `distDir` at the\n+   * same time, it can mangle the state of the directory. Disabling this option\n+   * is not recommended.\n+   *\n+   * @default true\n    */\n-  turbopackModuleIds?: 'named' | 'deterministic'\n+  lockDistDir?: boolean\n }\n \n export type ExportPathMap = {\n@@ -1512,6 +1525,7 @@ export const defaultConfig = Object.freeze({\n     browserDebugInfoInTerminal: false,\n     isolatedDevBuild:\n       process.env.__NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD === 'true',\n+    lockDistDir: true,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "e3f6bda1fa72912d34d40a12d8f470732ba21316",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -636,7 +636,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       .traceAsyncFn(() =>\n         recursiveDeleteSyncWithAsyncRetries(\n           join(this.dir, this.config.distDir),\n-          /^cache/\n+          /^(cache|lock)/\n         )\n       )\n   }"
        },
        {
            "sha": "9588d3551453c4284ab2ee95a54ba35513a0f56c",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -14,7 +14,8 @@ import './node-polyfill-crypto'\n import type { default as NextNodeServer } from './next-server'\n import * as log from '../build/output/log'\n import loadConfig from './config'\n-import path from 'path'\n+import path from 'node:path'\n+import { mkdirSync } from 'node:fs'\n import { NON_STANDARD_NODE_ENV } from '../lib/constants'\n import {\n   PHASE_DEVELOPMENT_SERVER,\n@@ -31,6 +32,7 @@ import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n } from './lib/router-utils/router-server-context'\n+import { Lockfile } from '../build/lockfile'\n \n let ServerImpl: typeof NextNodeServer\n \n@@ -129,6 +131,7 @@ export class NextServer implements NextWrapperServer {\n   private reqHandler?: NodeRequestHandler\n   private reqHandlerPromise?: Promise<NodeRequestHandler>\n   private preparedAssetPrefix?: string\n+  private lockfile?: Lockfile\n \n   public options: NextServerOptions\n \n@@ -258,6 +261,9 @@ export class NextServer implements NextWrapperServer {\n     if (this.server) {\n       await this.server.close()\n     }\n+    if (this.lockfile !== undefined) {\n+      await this.lockfile.unlock()\n+    }\n   }\n \n   private async createServer(\n@@ -317,7 +323,22 @@ export class NextServer implements NextWrapperServer {\n   private async getServer() {\n     if (!this.serverPromise) {\n       this.serverPromise = this[SYMBOL_LOAD_CONFIG]().then(async (conf) => {\n-        if (!this.options.dev) {\n+        if (this.options.dev) {\n+          if (conf.experimental.lockDistDir) {\n+            const dir = path.resolve(\n+              /* turbopackIgnore: true */ this.options.dir || '.'\n+            )\n+            const distDir = path.join(\n+              /* turbopackIgnore: true */ dir,\n+              conf.distDir\n+            )\n+            mkdirSync(distDir, { recursive: true })\n+            this.lockfile = await Lockfile.acquireWithRetriesOrExit(\n+              path.join(/* turbopackIgnore: true */ distDir, 'lock'),\n+              'next dev'\n+            )\n+          }\n+        } else {\n           if (conf.output === 'standalone') {\n             if (!process.env.__NEXT_PRIVATE_STANDALONE_CONFIG) {\n               log.warn("
        },
        {
            "sha": "29ce690fcb330f0307c4bbee3895d4e846cb9e7a",
            "filename": "run-tests.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/run-tests.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/run-tests.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/run-tests.js?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -689,7 +689,7 @@ ${ENDGROUP}`)\n \n       // we only restrict 1 test per directory for\n       // legacy integration tests\n-      if (test.file.startsWith('test/integration') && dirSema === undefined) {\n+      if (/^test[/\\\\]integration/.test(test.file) && dirSema === undefined) {\n         directorySemas.set(dirName, (dirSema = new Sema(1)))\n       }\n       if (dirSema) await dirSema.acquire()\n@@ -734,7 +734,7 @@ ${ENDGROUP}`)\n               // if test is nested in a test folder traverse up a dir to ensure\n               // we clean up relevant test files\n               if (testDir.endsWith('/test') || testDir.endsWith('\\\\test')) {\n-                testDir = path.join(testDir, '../')\n+                testDir = path.join(testDir, '..')\n               }\n               console.log('Cleaning test files at', testDir)\n               await exec(`git clean -fdx \"${testDir}\"`)"
        },
        {
            "sha": "a3a86a5ca1e12cd18b557ea38532170ea1e49622",
            "filename": "test/development/lockfile/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Flockfile%2Fapp%2Flayout.js?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "f6818ff77bd17acc1fce2247578045cad52e2cb6",
            "filename": "test/development/lockfile/app/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Flockfile%2Fapp%2Fpage.js?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>Page</p>\n+}"
        },
        {
            "sha": "fcf2b3c6f7bf1a67a8bb8a2d9de1cd80bb673390",
            "filename": "test/development/lockfile/lockfile.test.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts?ref=0b74ff9b2b7a92fdc5ee7d11cd433dd1746f2a44",
            "patch": "@@ -0,0 +1,26 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import execa from 'execa'\n+import stripAnsi from 'strip-ansi'\n+\n+describe('lockfile', () => {\n+  const { next, isTurbopack } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('only allows a single instance of `next dev` to run at a time', async () => {\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('p').text()).toBe('Page')\n+\n+    const { stdout, stderr, exitCode } = await execa(\n+      'pnpm',\n+      ['next', 'dev', isTurbopack ? '--turbopack' : '--webpack'],\n+      {\n+        cwd: next.testDir,\n+        env: next.env as NodeJS.ProcessEnv,\n+        reject: false,\n+      }\n+    )\n+    expect(stripAnsi(stdout + stderr)).toContain('Unable to acquire lock')\n+    expect(exitCode).toBe(1)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 599,
        "additions": 542,
        "deletions": 57
    }
}