{
    "author": "raunofreiberg",
    "message": "[dev-tools] Robust shortcut detection (#81756)\n\nThis PR resolves NEXT-4610 by using `e.code` over `e.key` in both\nstoring and detecting keyboard shortcuts.\n\nConsider this problematic keybind: Alt + L\n\nIf we capture `e.key` here then it will correspond to a glyph (¬)\nbecause pressing Alt + L creates this character. While `e.code` will\ngive us `KeyL` as the value which we also later use in `useShortcuts()`\nto match the keybind correctly without having to detect glyphs.\n\n---\n\nAfter this PR:\n\n\n\nhttps://github.com/user-attachments/assets/222fc65f-7320-4487-b387-ea263acfe387",
    "sha": "ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d",
    "files": [
        {
            "sha": "9217c6900befd7c411b941f3273b72450e5d7eca",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/shortcut-recorder.tsx",
            "status": "modified",
            "additions": 71,
            "deletions": 7,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fshortcut-recorder.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fshortcut-recorder.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fshortcut-recorder.tsx?ref=ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d",
            "patch": "@@ -1,3 +1,4 @@\n+import type { JSX } from 'react'\n import { useState, useRef, useEffect } from 'react'\n import { css } from '../../../../utils/css'\n \n@@ -13,6 +14,7 @@ export function ShortcutRecorder({\n   value: string[] | null\n   onChange: (value: string | null) => void\n }) {\n+  const [pristine, setPristine] = useState(true)\n   const [show, setShow] = useState(false)\n   const [keys, setKeys] = useState<string[]>(value ?? [])\n   const [success, setSuccess] = useState<boolean>(false)\n@@ -30,6 +32,13 @@ export function ShortcutRecorder({\n       setShow(true)\n     }\n \n+    // Reset current shortcut on first key press\n+    // if this is a fresh recording session\n+    if (pristine) {\n+      setKeys([])\n+      setPristine(false)\n+    }\n+\n     function handleValidation(next: string[]) {\n       timeoutRef.current = window.setTimeout(() => {\n         setSuccess(true)\n@@ -40,15 +49,24 @@ export function ShortcutRecorder({\n       }, SUCCESS_SHOW_DELAY_MS)\n     }\n \n-    if (keys.length === 3) return\n-\n     e.preventDefault()\n     e.stopPropagation()\n \n     setKeys((prev) => {\n       // Don't add duplicate keys\n-      if (prev.includes(e.key)) return prev\n-\n+      if (prev.includes(e.code) || prev.includes(e.key)) return prev\n+\n+      /**\n+       * Why are we using `e.code` for non-modifier keys?\n+       *\n+       * Consider this keybind: Alt + L\n+       *\n+       * If we capture `e.key` here then it will correspond to an awkward symbol (¬)\n+       * because pressing Alt + L creates this symbol.\n+       *\n+       * While `e.code` will give us `KeyL` as the value which we also later use in\n+       * `useShortcuts()` to match the keybind correctly without relying on modifier symbols.\n+       */\n       // Handle non-modifier keys (action keys)\n       if (!modifierKeys.includes(e.key)) {\n         // Replace existing non-modifier key if present\n@@ -57,12 +75,12 @@ export function ShortcutRecorder({\n         )\n         if (existingNonModifierIndex !== -1) {\n           const next = [...prev]\n-          next[existingNonModifierIndex] = e.key\n+          next[existingNonModifierIndex] = e.code\n           handleValidation(next)\n           return next\n         }\n         // Add new non-modifier key at the end\n-        const next = [...prev, e.key]\n+        const next = [...prev, e.code]\n         handleValidation(next)\n         return next\n       }\n@@ -108,6 +126,7 @@ export function ShortcutRecorder({\n   function onBlur() {\n     setSuccess(false)\n     setShow(false)\n+    setPristine(true)\n   }\n \n   function onStart() {\n@@ -240,7 +259,52 @@ function Kbd({ children }: { children: string }) {\n   }\n   const key = renderKey(children)\n   const isSymbol = typeof key === 'string' ? key.length === 1 : false\n-  return <kbd data-symbol={isSymbol}>{key}</kbd>\n+  return <kbd data-symbol={isSymbol}>{parseKeyCode(key)}</kbd>\n+}\n+\n+function parseKeyCode(code: string | JSX.Element) {\n+  if (typeof code !== 'string') return code\n+\n+  // Map common KeyboardEvent.code values to their corresponding key values\n+  const codeToKeyMap: Record<string, string> = {\n+    Minus: '-',\n+    Equal: '=',\n+    BracketLeft: '[',\n+    BracketRight: ']',\n+    Backslash: '\\\\',\n+    Semicolon: ';',\n+    Quote: \"'\",\n+    Comma: ',',\n+    Period: '.',\n+    Backquote: '`',\n+    Space: ' ',\n+    Slash: '/',\n+    IntlBackslash: '\\\\',\n+    // Add more as needed\n+  }\n+\n+  if (codeToKeyMap[code]) {\n+    return codeToKeyMap[code]\n+  }\n+\n+  // Handle KeyA-Z, Digit0-9, Numpad0-9, NumpadAdd, etc.\n+  if (/^Key([A-Z])$/.test(code)) {\n+    return code.replace(/^Key/, '')\n+  }\n+  if (/^Digit([0-9])$/.test(code)) {\n+    return code.replace(/^Digit/, '')\n+  }\n+  if (/^Numpad([0-9])$/.test(code)) {\n+    return code.replace(/^Numpad/, '')\n+  }\n+  if (code === 'NumpadAdd') return '+'\n+  if (code === 'NumpadSubtract') return '-'\n+  if (code === 'NumpadMultiply') return '*'\n+  if (code === 'NumpadDivide') return '/'\n+  if (code === 'NumpadDecimal') return '.'\n+  if (code === 'NumpadEnter') return 'Enter'\n+\n+  return code\n }\n \n function MetaKey() {"
        },
        {
            "sha": "dc26431f077087466a5b953f4273951e4a0a8ec2",
            "filename": "packages/next/src/next-devtools/dev-overlay/hooks/use-shortcuts.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-shortcuts.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-shortcuts.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-shortcuts.ts?ref=ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d",
            "patch": "@@ -22,7 +22,7 @@ export function useShortcuts(\n         e.key !== 'Alt' &&\n         e.key !== 'Shift'\n       ) {\n-        keys.push(e.key)\n+        keys.push(e.code)\n       }\n \n       const shortcut = keys.join('+')"
        },
        {
            "sha": "4ed52300053b7bebbe113eb8d764a28c2415566a",
            "filename": "packages/next/src/next-devtools/dev-overlay/menu/panel-router.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx?ref=ae2c750d2ba7f0d6be9de9346bfb2e3dad59a70d",
            "patch": "@@ -138,7 +138,7 @@ export const PanelRouter = () => {\n   const { triggerRef } = usePanelRouterContext()\n   const toggleDevtools = useToggleDevtoolsVisibility()\n \n-  const [hideShortcut] = useHideShortcutStorage()\n+  const [hideShortcut, setHideShortcut] = useHideShortcutStorage()\n   useShortcuts(\n     hideShortcut ? { [hideShortcut]: toggleDevtools } : {},\n     triggerRef\n@@ -160,7 +160,10 @@ export const PanelRouter = () => {\n           closeOnClickOutside\n           header={<DevToolsHeader title=\"Preferences\" />}\n         >\n-          <UserPreferencesWrapper />\n+          <UserPreferencesWrapper\n+            hideShortcut={hideShortcut}\n+            setHideShortcut={setHideShortcut}\n+          />\n         </DynamicPanel>\n       </PanelRoute>\n \n@@ -272,13 +275,17 @@ const InfoFooter = ({ href }: { href: string }) => {\n   )\n }\n \n-const UserPreferencesWrapper = () => {\n+const UserPreferencesWrapper = ({\n+  hideShortcut,\n+  setHideShortcut,\n+}: {\n+  hideShortcut: string | null\n+  setHideShortcut: (value: string | null) => void\n+}) => {\n   const { dispatch, state } = useDevOverlayContext()\n   const { setPanel, setSelectedIndex } = usePanelRouterContext()\n   const updateAllPanelPositions = useUpdateAllPanelPositions()\n \n-  const [hideShortcut, setHideShortcut] = useHideShortcutStorage()\n-\n   return (\n     <div\n       style={{"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 84,
        "deletions": 13
    }
}