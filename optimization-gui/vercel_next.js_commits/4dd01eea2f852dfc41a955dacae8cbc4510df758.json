{
    "author": "eps1lon",
    "message": "[sourcemaps] Properly devirtualize `rsc:` URLs (#81554)",
    "sha": "4dd01eea2f852dfc41a955dacae8cbc4510df758",
    "files": [
        {
            "sha": "46c1e551c2ff67123382953543b2916d53a7c031",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -16,6 +16,7 @@ import {\n import type { Project, TurbopackStackFrame } from '../../build/swc/types'\n import {\n   type ModernSourceMapPayload,\n+  devirtualizeReactServerURL,\n   findApplicableSourceMapPayload,\n } from '../lib/source-maps'\n import { getSourceMapFromFile } from './get-source-map-from-file'\n@@ -121,13 +122,13 @@ async function batchedTraceSource(\n     source,\n   }\n }\n+\n function parseFile(fileParam: string | null): string | undefined {\n   if (!fileParam) {\n     return undefined\n   }\n \n-  // rsc://React/Server/file://<filename>?42 => file://<filename>\n-  return fileParam.replace(/^rsc:\\/\\/React\\/[^/]+\\//, '').replace(/\\?\\d+$/, '')\n+  return devirtualizeReactServerURL(fileParam)\n }\n \n function createStackFrames(\n@@ -178,8 +179,7 @@ function createStackFrame(\n async function nativeTraceSource(\n   frame: TurbopackStackFrame\n ): Promise<{ frame: IgnorableStackFrame; source: string | null } | undefined> {\n-  const sourceURL = // TODO(veil): Why are the frames sent encoded?\n-    decodeURIComponent(frame.file)\n+  const sourceURL = frame.file\n   let sourceMapPayload: ModernSourceMapPayload | undefined\n   try {\n     sourceMapPayload = findSourceMap(sourceURL)?.payload"
        },
        {
            "sha": "21f6cb87c6c484b4c5f601e63e8d688985883e5b",
            "filename": "packages/next/src/server/dev/middleware-webpack.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -5,6 +5,7 @@ import { SourceMapConsumer } from 'next/dist/compiled/source-map08'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import { getSourceMapFromFile } from './get-source-map-from-file'\n import {\n+  devirtualizeReactServerURL,\n   findApplicableSourceMapPayload,\n   sourceMapIgnoreListsEverything,\n   type BasicSourceMapPayload,\n@@ -298,8 +299,7 @@ async function getSource(\n   let sourceURL = frame.file ?? ''\n   const { getCompilations } = options\n \n-  // Rspack is now using file:// URLs for source maps. Remove the rsc prefix to produce the file:/// url.\n-  sourceURL = sourceURL.replace(/(.*)\\/(?=file:\\/\\/)/, '')\n+  sourceURL = devirtualizeReactServerURL(sourceURL)\n \n   let nativeSourceMap: SourceMap | undefined\n   try {\n@@ -346,13 +346,9 @@ async function getSource(\n   }\n \n   // webpack-internal:///./src/hello.tsx => ./src/hello.tsx\n-  // rsc://React/Server/webpack-internal:///(rsc)/./src/hello.tsx?42 => (rsc)/./src/hello.tsx\n   // webpack://_N_E/./src/hello.tsx => ./src/hello.tsx\n   const moduleId = sourceURL\n-    .replace(\n-      /^(rsc:\\/\\/React\\/[^/]+\\/)?(webpack-internal:\\/\\/\\/|webpack:\\/\\/(_N_E\\/)?)/,\n-      ''\n-    )\n+    .replace(/^(webpack-internal:\\/\\/\\/|webpack:\\/\\/(_N_E\\/)?)/, '')\n     .replace(/\\?\\d+$/, '')\n \n   // (rsc)/./src/hello.tsx => ./src/hello.tsx"
        },
        {
            "sha": "6f0fb5ccaae1cfbdbc7a93bc105fddc3d6418fd8",
            "filename": "packages/next/src/server/lib/source-maps.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -156,3 +156,15 @@ export function filterStackFrameDEV(\n     return true\n   }\n }\n+\n+export function devirtualizeReactServerURL(sourceURL: string): string {\n+  if (sourceURL.startsWith('rsc://React/')) {\n+    // rsc://React/Server/file://<filename>?42 => file://<filename>\n+    const envIdx = sourceURL.indexOf('/', 'rsc://React/'.length)\n+    const suffixIdx = sourceURL.lastIndexOf('?')\n+    if (envIdx > -1 && suffixIdx > -1) {\n+      return decodeURI(sourceURL.slice(envIdx + 1, suffixIdx))\n+    }\n+  }\n+  return sourceURL\n+}"
        },
        {
            "sha": "229e1c0d38cfebe2cf9bf59007dae75f8ab0de13",
            "filename": "test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 30,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -90,6 +90,8 @@ describe('Dynamic IO Dev Errors', () => {\n         next.cliOutput.slice(outputIndex)\n       ).replaceAll(`file:` + next.testDir, '<FIXME-file-protocol>')\n \n+      // TODO(veil): Source mapping breaks due to double-encoding of the square\n+      // brackets.\n       expect(normalizedCliOutput).toContain(\n         `\\nError: Route \"/no-accessed-data\": ` +\n           `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n@@ -101,21 +103,6 @@ describe('Dynamic IO Dev Errors', () => {\n           '\\n  3 |   return <p>Page</p>' +\n           '\\n  4 | }'\n       )\n-\n-      // TODO(veil): Source mapping breaks due to double-encoding of the square\n-      // brackets.\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       {\n-         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-         \"environmentLabel\": \"Server\",\n-         \"label\": \"Console Error\",\n-         \"source\": null,\n-         \"stack\": [\n-           \"<FIXME-file-protocol>\",\n-           \"LogSafely <anonymous>\",\n-         ],\n-       }\n-      `)\n     } else {\n       expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n         `\\nError: Route \"/no-accessed-data\": ` +\n@@ -128,22 +115,22 @@ describe('Dynamic IO Dev Errors', () => {\n           '\\n  3 |   return <p>Page</p>' +\n           '\\n  4 | }'\n       )\n-\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       {\n-         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-         \"environmentLabel\": \"Server\",\n-         \"label\": \"Console Error\",\n-         \"source\": \"app/no-accessed-data/page.js (1:31) @ Page\n-       > 1 | export default async function Page() {\n-           |                               ^\",\n-         \"stack\": [\n-           \"Page app/no-accessed-data/page.js (1:31)\",\n-           \"LogSafely <anonymous>\",\n-         ],\n-       }\n-      `)\n     }\n+\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+       \"environmentLabel\": \"Server\",\n+       \"label\": \"Console Error\",\n+       \"source\": \"app/no-accessed-data/page.js (1:31) @ Page\n+     > 1 | export default async function Page() {\n+         |                               ^\",\n+       \"stack\": [\n+         \"Page app/no-accessed-data/page.js (1:31)\",\n+         \"LogSafely <anonymous>\",\n+       ],\n+     }\n+    `)\n   })\n \n   it('should clear segment errors after correcting them', async () => {"
        },
        {
            "sha": "fa450d56c7eeca533dbdaa7f882823515397be5b",
            "filename": "test/development/app-dir/use-cache-errors/use-cache-errors.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -2,7 +2,7 @@ import { nextTestSetup } from 'e2e-utils'\n import { assertNoRedbox } from '../../../lib/next-test-utils'\n \n describe('use-cache-errors', () => {\n-  const { next, isTurbopack } = nextTestSetup({\n+  const { isTurbopack, next } = nextTestSetup({\n     files: __dirname,\n   })\n   const isRspack = Boolean(process.env.NEXT_RSPACK)\n@@ -20,18 +20,18 @@ describe('use-cache-errors', () => {\n     await browser.elementById('action-button').click()\n \n     if (isTurbopack) {\n-      // TODO(veil): The wrong stack frame is used for the source snippet.\n+      // TODO(veil): Inconsistent cursor position\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n          \"environmentLabel\": \"Cache\",\n          \"label\": \"Runtime Error\",\n-         \"source\": \"app/page.tsx (22:10) @ Page\n-       > 22 |   return <OtherClientComponent getCachedStuff={useCachedStuff} />\n-            |          ^\",\n+         \"source\": \"app/module-with-use-cache.ts (16:17) @ useCachedStuff\n+       > 16 |   return useStuff()\n+            |                 ^\",\n          \"stack\": [\n            \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n+           \"useCachedStuff app/module-with-use-cache.ts (16:17)\",\n            \"Page app/page.tsx (22:10)\",\n          ],\n        }"
        },
        {
            "sha": "010867206362b276bf5f5dc05e3728d8d3ecfca8",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 83,
            "deletions": 152,
            "changes": 235,
            "blob_url": "https://github.com/vercel/next.js/blob/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4dd01eea2f852dfc41a955dacae8cbc4510df758/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=4dd01eea2f852dfc41a955dacae8cbc4510df758",
            "patch": "@@ -153,39 +153,21 @@ describe('Dynamic IO Errors', () => {\n         it('should show a collapsed redbox error', async () => {\n           const browser = await next.browser(pathname)\n \n-          if (isTurbopack) {\n-            // TODO(veil): Source mapping breaks due to double-encoding of the\n-            // square brackets.\n-            await expect(browser).toDisplayCollapsedRedbox(`\n-             {\n-               \"description\": \"Route \"/dynamic-metadata-error-route\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-               \"environmentLabel\": \"Server\",\n-               \"label\": \"Console Error\",\n-               \"source\": null,\n-               \"stack\": [\n-                 \"<FIXME-file-protocol>\",\n-                 \"<FIXME-file-protocol>\",\n-                 \"LogSafely <anonymous>\",\n-               ],\n-             }\n-            `)\n-          } else {\n-            await expect(browser).toDisplayCollapsedRedbox(`\n-             {\n-               \"description\": \"Route \"/dynamic-metadata-error-route\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-               \"environmentLabel\": \"Server\",\n-               \"label\": \"Console Error\",\n-               \"source\": \"app/dynamic-metadata-error-route/page.tsx (21:9) @ Dynamic\n-             > 21 |   await new Promise((r) => setTimeout(r))\n-                  |         ^\",\n-               \"stack\": [\n-                 \"Dynamic app/dynamic-metadata-error-route/page.tsx (21:9)\",\n-                 \"Page app/dynamic-metadata-error-route/page.tsx (15:7)\",\n-                 \"LogSafely <anonymous>\",\n-               ],\n-             }\n-            `)\n-          }\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/dynamic-metadata-error-route\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/dynamic-metadata-error-route/page.tsx (21:9) @ Dynamic\n+           > 21 |   await new Promise((r) => setTimeout(r))\n+                |         ^\",\n+             \"stack\": [\n+               \"Dynamic app/dynamic-metadata-error-route/page.tsx (21:9)\",\n+               \"Page app/dynamic-metadata-error-route/page.tsx (15:7)\",\n+               \"LogSafely <anonymous>\",\n+             ],\n+           }\n+          `)\n         })\n       } else {\n         // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n@@ -566,29 +548,31 @@ describe('Dynamic IO Errors', () => {\n           const browser = await next.browser(pathname)\n \n           if (isTurbopack) {\n-            // TODO(veil): Source mapping breaks due to double-encoding of the\n-            // square brackets.\n             await expect(browser).toDisplayCollapsedRedbox(`\n              [\n                {\n                  \"description\": \"Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                  \"environmentLabel\": \"Server\",\n                  \"label\": \"Console Error\",\n-                 \"source\": null,\n+                 \"source\": \"app/dynamic-root/page.tsx (45:56) @ FetchingComponent\n+             > 45 |       {cached ? await fetchRandomCached(nonce) : await fetchRandom(nonce)}\n+                  |                                                        ^\",\n                  \"stack\": [\n-                   \"<FIXME-file-protocol>\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"FetchingComponent app/dynamic-root/page.tsx (45:56)\",\n+                   \"Page app/dynamic-root/page.tsx (22:9)\",\n                    \"LogSafely <anonymous>\",\n                  ],\n                },\n                {\n                  \"description\": \"Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                  \"environmentLabel\": \"Server\",\n                  \"label\": \"Console Error\",\n-                 \"source\": null,\n+                 \"source\": \"app/dynamic-root/page.tsx (45:56) @ FetchingComponent\n+             > 45 |       {cached ? await fetchRandomCached(nonce) : await fetchRandom(nonce)}\n+                  |                                                        ^\",\n                  \"stack\": [\n-                   \"<FIXME-file-protocol>\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"FetchingComponent app/dynamic-root/page.tsx (45:56)\",\n+                   \"Page app/dynamic-root/page.tsx (27:7)\",\n                    \"LogSafely <anonymous>\",\n                  ],\n                },\n@@ -1574,37 +1558,20 @@ describe('Dynamic IO Errors', () => {\n           it('should show a collapsed redbox with a sync access error', async () => {\n             const browser = await next.browser(`${pathname}/test`)\n \n-            if (isTurbopack) {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-server-params/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                              \"environmentLabel\": \"Prerender\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": \"app/sync-server-params/[slug]/page.tsx (24:39) @ ParamsReadingComponent\n-                            > 24 |       <span id=\"param\">{String(params.slug)}</span>\n-                                 |                                       ^\",\n-                              \"stack\": [\n-                                \"ParamsReadingComponent app/sync-server-params/[slug]/page.tsx (24:39)\",\n-                                \"Page app/sync-server-params/[slug]/page.tsx (12:7)\",\n-                              ],\n-                            }\n-                          `)\n-            } else {\n-              // TODO(veil): Source mapping breaks due to double-encoding of the\n-              // square brackets.\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-server-params/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                              \"environmentLabel\": \"Prerender\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": null,\n-                              \"stack\": [\n-                                \"ParamsReadingComponent rsc:/Prerender/webpack-internal:///(rsc)/app/sync-server-params/%5Bslug%5D/page.tsx (51:41)\",\n-                                \"Page rsc:/Prerender/webpack-internal:///(rsc)/app/sync-server-params/%5Bslug%5D/page.tsx (23:88)\",\n-                              ],\n-                            }\n-                          `)\n-            }\n+            await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/sync-server-params/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+               \"environmentLabel\": \"Prerender\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/sync-server-params/[slug]/page.tsx (24:39) @ ParamsReadingComponent\n+             > 24 |       <span id=\"param\">{String(params.slug)}</span>\n+                  |                                       ^\",\n+               \"stack\": [\n+                 \"ParamsReadingComponent app/sync-server-params/[slug]/page.tsx (24:39)\",\n+                 \"Page app/sync-server-params/[slug]/page.tsx (12:7)\",\n+               ],\n+             }\n+            `)\n           })\n         } else {\n           it('should not error the build when synchronously reading `params.slug`', async () => {\n@@ -1660,39 +1627,21 @@ describe('Dynamic IO Errors', () => {\n           it('should show a collapsed redbox error', async () => {\n             const browser = await next.browser(pathname)\n \n-            if (isTurbopack) {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-                              \"environmentLabel\": \"Server\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": \"app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n-                            > 5 |   const data = new Date().toISOString()\n-                                |                ^\",\n-                              \"stack\": [\n-                                \"SyncIO app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16)\",\n-                                \"<FIXME-file-protocol>\",\n-                                \"LogSafely <anonymous>\",\n-                              ],\n-                            }\n-                          `)\n-            } else {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-                              \"environmentLabel\": \"Server\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": \"app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n-                            > 5 |   const data = new Date().toISOString()\n-                                |                ^\",\n-                              \"stack\": [\n-                                \"SyncIO app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16)\",\n-                                \"Page app/sync-attribution/guarded-async-unguarded-clientsync/page.tsx (22:9)\",\n-                                \"LogSafely <anonymous>\",\n-                              ],\n-                            }\n-                          `)\n-            }\n+            await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n+             > 5 |   const data = new Date().toISOString()\n+                 |                ^\",\n+               \"stack\": [\n+                 \"SyncIO app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx (5:16)\",\n+                 \"Page app/sync-attribution/guarded-async-unguarded-clientsync/page.tsx (22:9)\",\n+                 \"LogSafely <anonymous>\",\n+               ],\n+             }\n+            `)\n           })\n         } else {\n           it('should error the build with a reason related to sync IO access', async () => {\n@@ -1788,22 +1737,22 @@ describe('Dynamic IO Errors', () => {\n           it('should show a collapsed redbox error', async () => {\n             const browser = await next.browser(pathname)\n \n-            // TODO(veil): Source mapping breaks due to double-encoding of the\n-            // square brackets.\n             if (isTurbopack) {\n               await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-attribution/unguarded-async-guarded-clientsync\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-                              \"environmentLabel\": \"Server\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": null,\n-                              \"stack\": [\n-                                \"<FIXME-file-protocol>\",\n-                                \"<FIXME-file-protocol>\",\n-                                \"LogSafely <anonymous>\",\n-                              ],\n-                            }\n-                          `)\n+               {\n+                 \"description\": \"Route \"/sync-attribution/unguarded-async-guarded-clientsync\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+                 \"environmentLabel\": \"Server\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/sync-attribution/unguarded-async-guarded-clientsync/page.tsx (34:17) @ RequestData\n+               > 34 |   ;(await cookies()).get('foo')\n+                    |                 ^\",\n+                 \"stack\": [\n+                   \"RequestData app/sync-attribution/unguarded-async-guarded-clientsync/page.tsx (34:17)\",\n+                   \"Page app/sync-attribution/unguarded-async-guarded-clientsync/page.tsx (27:9)\",\n+                   \"LogSafely <anonymous>\",\n+                 ],\n+               }\n+              `)\n             } else {\n               await expect(browser).toDisplayCollapsedRedbox(`\n                             {\n@@ -1987,39 +1936,21 @@ describe('Dynamic IO Errors', () => {\n           it('should show a collapsed redbox error', async () => {\n             const browser = await next.browser(pathname)\n \n-            if (isTurbopack) {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-                              \"environmentLabel\": \"Server\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": \"app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n-                            > 5 |   const data = new Date().toISOString()\n-                                |                ^\",\n-                              \"stack\": [\n-                                \"SyncIO app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16)\",\n-                                \"<FIXME-file-protocol>\",\n-                                \"LogSafely <anonymous>\",\n-                              ],\n-                            }\n-                          `)\n-            } else {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-                            {\n-                              \"description\": \"Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-                              \"environmentLabel\": \"Server\",\n-                              \"label\": \"Console Error\",\n-                              \"source\": \"app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n-                            > 5 |   const data = new Date().toISOString()\n-                                |                ^\",\n-                              \"stack\": [\n-                                \"SyncIO app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16)\",\n-                                \"Page app/sync-attribution/unguarded-async-unguarded-clientsync/page.tsx (22:9)\",\n-                                \"LogSafely <anonymous>\",\n-                              ],\n-                            }\n-                          `)\n-            }\n+            await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16) @ SyncIO\n+             > 5 |   const data = new Date().toISOString()\n+                 |                ^\",\n+               \"stack\": [\n+                 \"SyncIO app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx (5:16)\",\n+                 \"Page app/sync-attribution/unguarded-async-unguarded-clientsync/page.tsx (22:9)\",\n+                 \"LogSafely <anonymous>\",\n+               ],\n+             }\n+            `)\n           })\n         } else {\n           it('should error the build with a reason related to sync IO access', async () => {"
        }
    ],
    "stats": {
        "total": 324,
        "additions": 125,
        "deletions": 199
    }
}