{
    "author": "unstubbable",
    "message": "[test] Add test fixture for runtime error in `'use cache'` (#86499)\n\nIn production, when throwing an error in `'use cache'` at runtime, we are currently logging the obfuscated error that React is producing when crossing the cache-server boundary. This is not ideal for investigating production issues so we're also logging the original error in the `'use cache'` wrapper. But this error does not have a digest, which makes it non-obvious that it's the same error as the obfuscated one.\r\n\r\nThis PR is just adding a test fixture for this case, so that we can see the changes when improving the error handling in the upstack PR.",
    "sha": "f71ce534a8e9429f4341998ae386b23055c5888c",
    "files": [
        {
            "sha": "0caaf9bdf482ac87aff92b05fe0e9c00feb83dbf",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 3,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,6 +1,6 @@\n import { isNextDev, nextTestSetup } from 'e2e-utils'\n-import { waitForNoErrorToast } from 'next-test-utils'\n-import { getPrerenderOutput } from './utils'\n+import { retry, waitForNoErrorToast } from 'next-test-utils'\n+import { getDeterministicOutput, getPrerenderOutput } from './utils'\n \n describe('Cache Components Errors', () => {\n   const { next, isTurbopack, isNextStart, skipped, isRspack } = nextTestSetup({\n@@ -2648,7 +2648,6 @@ describe('Cache Components Errors', () => {\n \n       describe('reading fallback params', () => {\n         if (isNextDev) {\n-          // FIXME: This should show a redbox error, but currently does not.\n           it('should show a redbox error', async () => {\n             const browser = await next.browser('/use-cache-params/foo')\n \n@@ -2776,6 +2775,73 @@ describe('Cache Components Errors', () => {\n           })\n         }\n       })\n+\n+      describe('throwing an error at runtime', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser('/use-cache-runtime-error')\n+\n+            await expect(browser).toDisplayRedbox(`\n+             {\n+               \"description\": \"Kaputt!\",\n+               \"environmentLabel\": \"Cache\",\n+               \"label\": \"Runtime Error\",\n+               \"source\": \"app/use-cache-runtime-error/page.tsx (15:9) @ throwAnError\n+             > 15 |   throw new Error('Kaputt!')\n+                  |         ^\",\n+               \"stack\": [\n+                 \"throwAnError app/use-cache-runtime-error/page.tsx (15:9)\",\n+                 \"ThrowingComponent app/use-cache-runtime-error/page.tsx (21:3)\",\n+               ],\n+             }\n+            `)\n+          })\n+        } else {\n+          it('should show an error at runtime', async () => {\n+            try {\n+              await prerender('/use-cache-runtime-error')\n+            } catch (error) {\n+              throw new Error('expected build not to fail', { cause: error })\n+            }\n+\n+            await next.start({ skipBuild: true })\n+            cliOutputLength = next.cliOutput.length\n+            await next.fetch('/use-cache-runtime-error')\n+\n+            await retry(async () => {\n+              expect(next.cliOutput.slice(cliOutputLength)).toContain('Error')\n+            })\n+\n+            const output = getDeterministicOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            // TODO: The obfuscated error should be hidden, and the original\n+            // error should have a digest.\n+            if (isDebugPrerender) {\n+              expect(output).toMatchInlineSnapshot(`\n+               \"Error: Kaputt!\n+                   at throwAnError (<next-dist-dir>)\n+                   at ThrowingComponent (<next-dist-dir>)\n+                   at Object.then (<next-dist-dir>)\n+               тип [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n+                 digest: '<error-digest>'\n+               }\"\n+              `)\n+            } else {\n+              expect(output).toMatchInlineSnapshot(`\n+               \"Error: Kaputt!\n+                   at a (<next-dist-dir>)\n+                   at b (<next-dist-dir>)\n+               тип [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n+                 digest: '<error-digest>'\n+               }\"\n+              `)\n+            }\n+          })\n+        }\n+      })\n     })\n \n     describe('With `use cache: private`', () => {"
        },
        {
            "sha": "1346c451cc6f89f781582251f9d9e5c5c2785feb",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-runtime-error/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Flayout.tsx?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -0,0 +1,13 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>\n+          <Suspense>{children}</Suspense>\n+        </main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b8cfc46b33ad78e4ab990971ffdf03a3e4f0e1ec",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-runtime-error/page.tsx",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-runtime-error%2Fpage.tsx?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -0,0 +1,24 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return (\n+    <>\n+      <p>This page throws an error at runtime in `'use cache'`.</p>\n+      <ThrowingComponent />\n+    </>\n+  )\n+}\n+\n+function throwAnError() {\n+  throw new Error('Kaputt!')\n+}\n+\n+async function ThrowingComponent() {\n+  'use cache: remote'\n+\n+  throwAnError()\n+\n+  return null\n+}"
        },
        {
            "sha": "779dca84003b6756c6f9334c6defb5a625f9504c",
            "filename": "test/e2e/app-dir/cache-components-errors/utils.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 10,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -21,22 +21,28 @@ export function convertModuleFunctionSequenceExpression(\n   return output.replace(/\\(0 , \\w+\\.(\\w+)\\)\\(\\.\\.\\.\\)/, '<module-function>()')\n }\n \n-export function getPrerenderOutput(\n+export function getDeterministicOutput(\n   cliOutput: string,\n-  { isMinified }: { isMinified: boolean }\n+  {\n+    isMinified,\n+    startingLineMatch,\n+  }: { isMinified: boolean; startingLineMatch?: string }\n ): string {\n   const lines: string[] = []\n-  let foundPrerenderingLine = false\n+\n+  // If no starting line match is provided, we start from the beginning.\n+  let foundStartingLine = !startingLineMatch\n   let a = 0\n   let n = 0\n \n-  const replaceNextDistStackFrame = () =>\n-    `at ${abc[a++ % abc.length]} (<next-dist-dir>)`\n+  const replaceNextDistStackFrame = (_m: string, name: string) =>\n+    `at ${isMinified ? abc[a++ % abc.length] : name} (<next-dist-dir>)`\n \n   const isLikelyLibraryInternalStackFrame = (line: string) => {\n     return line.startsWith('    at InnerLayoutRouter (')\n   }\n-  const replaceAnonymousStackFrame = (_m, name) => {\n+\n+  const replaceAnonymousStackFrame = (_m: string, name: string) => {\n     const deterministicName = hostElementsUsedInFixtures.includes(name)\n       ? name\n       : abc[a++ % abc.length]\n@@ -73,8 +79,8 @@ export function getPrerenderOutput(\n         isErrorWithStackTraceStartingInLibraryInternals = false\n       }\n     }\n-    if (line.includes('Collecting page data')) {\n-      foundPrerenderingLine = true\n+    if (startingLineMatch && line.includes(startingLineMatch)) {\n+      foundStartingLine = true\n       continue\n     }\n \n@@ -87,7 +93,7 @@ export function getPrerenderOutput(\n     }\n \n     if (\n-      foundPrerenderingLine &&\n+      foundStartingLine &&\n       !ignoredLines.some((ignoredLine) => line.includes(ignoredLine))\n     ) {\n       if (isMinified) {\n@@ -103,7 +109,7 @@ export function getPrerenderOutput(\n       }\n \n       line = line\n-        .replace(/at .+? \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n+        .replace(/at (.+?) \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n         .replace(\n           // Single-letter lower-case names are likely minified.\n           /at [a-z] \\((?!(<next-dist-dir>|<anonymous>))/,\n@@ -118,3 +124,13 @@ export function getPrerenderOutput(\n \n   return lines.join('\\n').trim()\n }\n+\n+export function getPrerenderOutput(\n+  cliOutput: string,\n+  { isMinified }: { isMinified: boolean }\n+): string {\n+  return getDeterministicOutput(cliOutput, {\n+    isMinified,\n+    startingLineMatch: 'Collecting page data',\n+  })\n+}"
        }
    ],
    "stats": {
        "total": 145,
        "additions": 132,
        "deletions": 13
    }
}