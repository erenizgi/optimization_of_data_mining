{
    "author": "devjiwonchoi",
    "message": "[ts-next-plugin] auto import metadata type (#78258)\n\nFollow up of https://github.com/vercel/next.js/pull/78237\n\nAuto import the `Metadata` type when completing the `metadata` and\n`generateMetadata` option.\n\n- If there is a `'use ...'` top directive, add import below the\ndirective.\n- If there is an existing Metadata import, do not add another import.\n  - This includes aliases as well.\n\n\nhttps://github.com/user-attachments/assets/5ea1ce7e-2320-41f0-ba33-af7568bbdd11",
    "sha": "a3b9aed62a8f7098c3e4889fc2d249033431098d",
    "files": [
        {
            "sha": "5e900195e799eb9637333d339bff550c5abcdbec",
            "filename": "packages/next/src/server/typescript/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a3b9aed62a8f7098c3e4889fc2d249033431098d/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a3b9aed62a8f7098c3e4889fc2d249033431098d/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts?ref=a3b9aed62a8f7098c3e4889fc2d249033431098d",
            "patch": "@@ -118,7 +118,8 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n     ) => {\n       const entryCompletionEntryDetails = entryConfig.getCompletionEntryDetails(\n         entryName,\n-        data\n+        data,\n+        fileName\n       )\n       if (entryCompletionEntryDetails) return entryCompletionEntryDetails\n "
        },
        {
            "sha": "4d667627e511d4a7f33f753522e3f172cb98746d",
            "filename": "packages/next/src/server/typescript/rules/config.ts",
            "status": "modified",
            "additions": 99,
            "deletions": 7,
            "changes": 106,
            "blob_url": "https://github.com/vercel/next.js/blob/a3b9aed62a8f7098c3e4889fc2d249033431098d/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a3b9aed62a8f7098c3e4889fc2d249033431098d/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts?ref=a3b9aed62a8f7098c3e4889fc2d249033431098d",
            "patch": "@@ -22,14 +22,15 @@ const API_DOCS: Record<\n     type?: string\n     isValid?: (value: string) => boolean\n     getHint?: (value: any) => string | undefined\n+    insertText?: string\n   }\n > = {\n   dynamic: {\n     description:\n       'The `dynamic` option provides a few ways to opt in or out of dynamic behavior.',\n     options: {\n       '\"auto\"':\n-        'Heuristic to cache as much as possible but doesn’t prevent any component to opt-in to dynamic behavior.',\n+        \"Heuristic to cache as much as possible but doesn't prevent any component to opt-in to dynamic behavior.\",\n       '\"force-dynamic\"':\n         'This disables all caching of fetches and always revalidates. (This is equivalent to `getServerSideProps`.)',\n       '\"error\"':\n@@ -41,7 +42,7 @@ const API_DOCS: Record<\n   },\n   fetchCache: {\n     description:\n-      'The `fetchCache` option controls how Next.js statically caches fetches. By default it statically caches fetches reachable before any dynamic Hooks are used, and it doesn’t cache fetches that are discovered after that.',\n+      \"The `fetchCache` option controls how Next.js statically caches fetches. By default it statically caches fetches reachable before any dynamic Hooks are used, and it doesn't cache fetches that are discovered after that.\",\n     options: {\n       '\"force-no-store\"':\n         \"This lets you intentionally opt-out of all caching of data. This option forces all fetches to be refetched every request even if the `cache: 'force-cache'` option is passed to `fetch()`.\",\n@@ -50,7 +51,7 @@ const API_DOCS: Record<\n       '\"default-no-store\"':\n         \"Allows any explicit `cache` option to be passed to `fetch()` but if `'default'`, or no option, is provided then it defaults to `'no-store'`. This means that even fetches before a dynamic Hook are considered dynamic.\",\n       '\"auto\"':\n-        'This is the default option. It caches any fetches with the default `cache` option provided, that happened before a dynamic Hook is used and don’t cache any such fetches if they’re issued after a dynamic Hook.',\n+        \"This is the default option. It caches any fetches with the default `cache` option provided, that happened before a dynamic Hook is used and don't cache any such fetches if they're issued after a dynamic Hook.\",\n       '\"default-cache\"':\n         \"Allows any explicit `cache` option to be passed to `fetch()` but if `'default'`, or no option, is provided then it defaults to `'force-cache'`. This means that even fetches before a dynamic Hook are considered dynamic.\",\n       '\"only-cache\"':\n@@ -65,7 +66,7 @@ const API_DOCS: Record<\n       'Specify the perferred region that this layout or page should be deployed to. If the region option is not specified, it inherits the option from the nearest parent layout. The root defaults to `\"auto\"`.\\n\\nYou can also specify a region, such as \"iad1\", or an array of regions, such as `[\"iad1\", \"sfo1\"]`.',\n     options: {\n       '\"auto\"':\n-        'Next.js will first deploy to the `\"home\"` region. Then if it doesn’t detect any waterfall requests after a few requests, it can upgrade that route, to be deployed globally. If it detects any waterfall requests after that, it can eventually downgrade back to `\"home`\".',\n+        'Next.js will first deploy to the `\"home\"` region. Then if it doesn\\'t detect any waterfall requests after a few requests, it can upgrade that route, to be deployed globally. If it detects any waterfall requests after that, it can eventually downgrade back to `\"home`\".',\n       '\"global\"': 'Prefer deploying globally.',\n       '\"home\"': 'Prefer deploying to the Home region.',\n     },\n@@ -91,7 +92,7 @@ const API_DOCS: Record<\n   },\n   revalidate: {\n     description:\n-      'The `revalidate` option sets the default revalidation time for that layout or page. Note that it doesn’t override the value specify by each `fetch()`.',\n+      \"The `revalidate` option sets the default revalidation time for that layout or page. Note that it doesn't override the value specify by each `fetch()`.\",\n     type: 'mixed',\n     options: {\n       false:\n@@ -133,6 +134,12 @@ const API_DOCS: Record<\n   metadata: {\n     description: 'Next.js Metadata configurations',\n     link: 'https://nextjs.org/docs/app/building-your-application/optimizing/metadata',\n+    insertText: 'metadata: Metadata = {};',\n+  },\n+  generateMetadata: {\n+    description: 'Next.js generateMetadata configurations',\n+    link: 'https://nextjs.org/docs/app/api-reference/functions/generate-metadata',\n+    insertText: 'generateMetadata = (): Metadata => { return {} };',\n   },\n   maxDuration: {\n     description:\n@@ -185,8 +192,10 @@ function visitEntryConfig(\n \n function createAutoCompletionOptionName(sort: number, name: string) {\n   const ts = getTs()\n+\n   return {\n     name,\n+    insertText: API_DOCS[name].insertText,\n     sortText: '!' + sort,\n     kind: ts.ScriptElementKind.constElement,\n     kindModifiers: ts.ScriptElementKindModifier.exportedModifier,\n@@ -232,6 +241,7 @@ function getAPIDescription(api: string): string {\n       .join('\\n')\n   )\n }\n+\n const config = {\n   // Auto completion for entry exported configs.\n   addCompletionsAtPosition(\n@@ -348,8 +358,9 @@ const config = {\n   // Show details on the side when auto completing.\n   getCompletionEntryDetails(\n     entryName: string,\n-    data: tsModule.CompletionEntryData\n-  ) {\n+    data: tsModule.CompletionEntryData,\n+    fileName: string\n+  ): tsModule.CompletionEntryDetails | undefined {\n     const ts = getTs()\n     if (\n       data &&\n@@ -364,6 +375,87 @@ const config = {\n         if (!options) return\n         content = options[entryName]\n       }\n+\n+      if (entryName === 'metadata' || entryName === 'generateMetadata') {\n+        const sourceFile = getSource(fileName)\n+        let start = 0\n+        let foundMetadataImport = false\n+\n+        if (sourceFile) {\n+          const visitor: tsModule.Visitor = (node) => {\n+            // Check for top directive\n+            if (\n+              ts.isExpressionStatement(node) &&\n+              ts.isStringLiteral(node.expression) &&\n+              node.expression.getStart() === 0\n+            ) {\n+              const text = node.expression.text\n+              if (text.startsWith('use ')) {\n+                start = node.end + 1\n+                return node // Continue traversal\n+              }\n+            }\n+\n+            // Check for Metadata import\n+            if (\n+              ts.isImportDeclaration(node) &&\n+              (node.moduleSpecifier.getText() === '\"next\"' ||\n+                node.moduleSpecifier.getText() === \"'next'\")\n+            ) {\n+              const namedImports = node.importClause?.namedBindings\n+              if (namedImports && ts.isNamedImports(namedImports)) {\n+                foundMetadataImport = namedImports.elements.some((element) => {\n+                  const name = element.name.getText()\n+                  const propertyName = element.propertyName?.getText()\n+                  return name === 'Metadata' || propertyName === 'Metadata'\n+                })\n+                if (foundMetadataImport) {\n+                  return // Stop traversal\n+                }\n+              }\n+            }\n+\n+            return node\n+          }\n+\n+          for (const statement of sourceFile.statements) {\n+            if (foundMetadataImport) break\n+            ts.visitNode(statement, visitor)\n+          }\n+        }\n+\n+        return {\n+          name: entryName,\n+          kind: ts.ScriptElementKind.enumElement,\n+          kindModifiers: ts.ScriptElementKindModifier.none,\n+          displayParts: [],\n+          codeActions: foundMetadataImport\n+            ? undefined\n+            : [\n+                {\n+                  description: `Import type 'Metadata' from module 'next'`,\n+                  changes: [\n+                    {\n+                      fileName,\n+                      textChanges: [\n+                        {\n+                          span: { start, length: 0 },\n+                          newText: `import type { Metadata } from 'next';\\n`,\n+                        },\n+                      ],\n+                    },\n+                  ],\n+                },\n+              ],\n+          documentation: [\n+            {\n+              kind: 'text',\n+              text: content,\n+            },\n+          ],\n+        }\n+      }\n+\n       return {\n         name: entryName,\n         kind: ts.ScriptElementKind.enumElement,"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 101,
        "deletions": 8
    }
}