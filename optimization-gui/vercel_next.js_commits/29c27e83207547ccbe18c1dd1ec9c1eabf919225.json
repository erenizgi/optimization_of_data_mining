{
    "author": "eps1lon",
    "message": "[test] Fix flaky error-recovery test (#76789)\n\nFixes https://github.com/vercel/next.js/actions/runs/13651039022/job/38159568577?pr=76787#step:33:639\r\n\r\nSometimes we didn't get to assert in time before more errors come in. Now the test ensures that each error is intentional.",
    "sha": "29c27e83207547ccbe18c1dd1ec9c1eabf919225",
    "files": [
        {
            "sha": "4c989b68ce4912058cd582d200e0ec4554b1da47",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 28,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/29c27e83207547ccbe18c1dd1ec9c1eabf919225/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/29c27e83207547ccbe18c1dd1ec9c1eabf919225/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=29c27e83207547ccbe18c1dd1ec9c1eabf919225",
            "patch": "@@ -534,28 +534,31 @@ describe('Error recovery app', () => {\n       outdent`\n         import * as React from 'react';\n         let i = 0\n-        setInterval(() => {\n-          i++\n-          throw Error('no ' + i)\n-        }, 1000)\n+        window.triggerError = () => {\n+          // TODO(veil): sync thrown errors do not trigger Redbox.\n+          setTimeout(() => {\n+            i++\n+            throw Error('no ' + i)\n+          }, 0)\n+        }\n         export default function FunctionNamed() {\n           return <div />\n         }\n       `\n     )\n \n-    await new Promise((resolve) => setTimeout(resolve, 1000))\n+    await browser.eval('window.triggerError()')\n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"count\": 1,\n        \"description\": \"Error: no 1\",\n        \"environmentLabel\": null,\n        \"label\": \"Unhandled Runtime Error\",\n-       \"source\": \"index.js (5:9) @ eval\n-     > 5 |   throw Error('no ' + i)\n-         |         ^\",\n+       \"source\": \"index.js (7:11) @ eval\n+     >  7 |     throw Error('no ' + i)\n+          |           ^\",\n        \"stack\": [\n-         \"eval index.js (5:9)\",\n+         \"eval index.js (7:11)\",\n        ],\n      }\n     `)\n@@ -566,10 +569,13 @@ describe('Error recovery app', () => {\n       outdent`\n         import * as React from 'react';\n         let i = 0\n-        setInterval(() => {\n-          i++\n-          throw Error('no ' + i)\n-        }, 1000)\n+        window.triggerError = () => {\n+          // TODO(veil): sync thrown errors do not trigger Redbox.\n+          setTimeout(() => {\n+            i++\n+            throw Error('no ' + i)\n+          }, 0)\n+        }\n         export default function FunctionNamed() {\n       `\n     )\n@@ -598,13 +604,10 @@ describe('Error recovery app', () => {\n          \"label\": \"Build Error\",\n          \"source\": \"./index.js\n        Error:   x Expected '}', got '<eof>'\n-          ,-[7:1]\n-        4 |   i++\n-        5 |   throw Error('no ' + i)\n-        6 | }, 1000)\n-        7 | export default function FunctionNamed() {\n-          :                                         ^\n-          \\`----\n+           ,-[10:1]\n+        10 | export default function FunctionNamed() {\n+           :                                         ^\n+           \\`----\n        Caused by:\n            Syntax Error\n        Import trace for requested module:\n@@ -616,7 +619,7 @@ describe('Error recovery app', () => {\n     }\n \n     // Test that runtime error does not take over:\n-    await new Promise((resolve) => setTimeout(resolve, 2000))\n+    await browser.eval('window.triggerError()')\n     if (isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -640,13 +643,10 @@ describe('Error recovery app', () => {\n          \"label\": \"Build Error\",\n          \"source\": \"./index.js\n        Error:   x Expected '}', got '<eof>'\n-          ,-[7:1]\n-        4 |   i++\n-        5 |   throw Error('no ' + i)\n-        6 | }, 1000)\n-        7 | export default function FunctionNamed() {\n-          :                                         ^\n-          \\`----\n+           ,-[10:1]\n+        10 | export default function FunctionNamed() {\n+           :                                         ^\n+           \\`----\n        Caused by:\n            Syntax Error\n        Import trace for requested module:"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 28,
        "deletions": 28
    }
}