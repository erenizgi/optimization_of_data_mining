{
    "author": "wbinnssmith",
    "message": "Turbopack: Implement regex support for matching webpack loaders (#78733)\n\nInspired by https://x.com/wSokra/status/1907794635914612777, this allows you to declare a ‘marker’ in place of a glob, allowing you to express more conditions than simply just a glob pattern. To start, this allows us to implement regexes. For example, to match either `.svg` or `.svgr` files, use this `next.config.ts`:\n\n```\nconst nextConfig: NextConfig = {\n  turbopack: {\n    rules: {\n      '#svg': {\n        as: '*.js',\n        loaders: ['@svgr/webpack'],\n      }\n    },\n    conditions: {\n      '#svg': {\n        path: /\\.svgr?$/,\n      }\n    }\n  }\n};\n```",
    "sha": "83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
    "files": [
        {
            "sha": "f84e17b853a294ce21c57ba64ebfcfc98c6bf713",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -4583,10 +4583,12 @@ dependencies = [\n  \"rustc-hash 2.1.1\",\n  \"serde\",\n  \"serde_json\",\n+ \"serde_path_to_error\",\n  \"swc_core\",\n  \"swc_relay\",\n  \"thiserror 1.0.69\",\n  \"tracing\",\n+ \"turbo-esregex\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\",\n  \"turbo-tasks-build\",\n@@ -9690,6 +9692,7 @@ dependencies = [\n  \"smallvec\",\n  \"tokio\",\n  \"tracing\",\n+ \"turbo-esregex\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\",\n  \"turbo-tasks-build\","
        },
        {
            "sha": "d7f4bba95914c7efd534029e2f65562dc167ba4f",
            "filename": "crates/next-core/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2FCargo.toml?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -37,6 +37,7 @@ remove_console = \"0.37.0\"\n itertools = { workspace = true }\n auto-hash-map = { workspace = true }\n percent-encoding = \"2.3.1\"\n+serde_path_to_error = { workspace = true }\n \n swc_core = { workspace = true, features = [\n   \"base\",\n@@ -60,6 +61,7 @@ modularize_imports = { workspace = true }\n swc_relay = { workspace = true }\n \n turbo-rcstr = { workspace = true }\n+turbo-esregex = { workspace = true }\n turbo-tasks = { workspace = true }\n turbo-tasks-bytes = { workspace = true }\n turbo-tasks-env = { workspace = true }"
        },
        {
            "sha": "9fdd199c3d21ad3a2db151f232bfac287978776d",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 68,
            "deletions": 2,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -10,7 +10,10 @@ use turbo_tasks::{\n use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::{\n-    module_options_context::MdxTransformOptions, LoaderRuleItem, OptionWebpackRules,\n+    module_options_context::{\n+        ConditionItem, ConditionPath, MdxTransformOptions, OptionWebpackConditions,\n+    },\n+    LoaderRuleItem, OptionWebpackRules,\n };\n use turbopack_core::{\n     issue::{Issue, IssueSeverity, IssueStage, OptionStyledString, StyledString},\n@@ -541,11 +544,57 @@ pub struct TurbopackConfig {\n     /// This option has been replaced by `rules`.\n     pub loaders: Option<JsonValue>,\n     pub rules: Option<FxIndexMap<RcStr, RuleConfigItemOrShortcut>>,\n+    #[turbo_tasks(trace_ignore)]\n+    pub conditions: Option<FxIndexMap<RcStr, ConfigConditionItem>>,\n     pub resolve_alias: Option<FxIndexMap<RcStr, JsonValue>>,\n     pub resolve_extensions: Option<Vec<RcStr>>,\n     pub module_ids: Option<ModuleIds>,\n }\n \n+#[derive(Clone, Debug, PartialEq, Serialize, TraceRawVcs, NonLocalValue)]\n+pub struct ConfigConditionItem(ConditionItem);\n+\n+impl<'de> Deserialize<'de> for ConfigConditionItem {\n+    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error>\n+    where\n+        D: Deserializer<'de>,\n+    {\n+        #[derive(Deserialize)]\n+        struct RegexComponents {\n+            source: RcStr,\n+            flags: RcStr,\n+        }\n+\n+        #[derive(Deserialize)]\n+        struct ConfigPath {\n+            path: RegexOrGlob,\n+        }\n+\n+        #[derive(Deserialize)]\n+        #[serde(tag = \"type\", rename_all = \"lowercase\")]\n+        enum RegexOrGlob {\n+            Regexp { value: RegexComponents },\n+            Glob { value: String },\n+        }\n+\n+        let config_path = ConfigPath::deserialize(deserializer)?;\n+        let condition_item = match config_path.path {\n+            RegexOrGlob::Regexp { value } => {\n+                let regex = turbo_esregex::EsRegex::new(&value.source, &value.flags)\n+                    .map_err(serde::de::Error::custom)?;\n+                ConditionItem {\n+                    path: ConditionPath::Regex(regex.resolved_cell()),\n+                }\n+            }\n+            RegexOrGlob::Glob { value } => ConditionItem {\n+                path: ConditionPath::Glob(value.into()),\n+            },\n+        };\n+\n+        Ok(ConfigConditionItem(condition_item))\n+    }\n+}\n+\n #[derive(\n     Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n@@ -1065,7 +1114,8 @@ impl NextConfig {\n     #[turbo_tasks::function]\n     pub async fn from_string(string: Vc<RcStr>) -> Result<Vc<Self>> {\n         let string = string.await?;\n-        let config: NextConfig = serde_json::from_str(&string)\n+        let mut jdeserializer = serde_json::Deserializer::from_str(&string);\n+        let config: NextConfig = serde_path_to_error::deserialize(&mut jdeserializer)\n             .with_context(|| format!(\"failed to parse next.config.js: {}\", string))?;\n         Ok(config.cell())\n     }\n@@ -1227,6 +1277,22 @@ impl NextConfig {\n         Vc::cell(Some(ResolvedVc::cell(rules)))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn webpack_conditions(&self) -> Vc<OptionWebpackConditions> {\n+        let Some(config_conditions) = self.turbopack.as_ref().and_then(|t| t.conditions.as_ref())\n+        else {\n+            return Vc::cell(None);\n+        };\n+\n+        let conditions = FxIndexMap::from_iter(\n+            config_conditions\n+                .iter()\n+                .map(|(k, v)| (k.clone(), v.0.clone())),\n+        );\n+\n+        Vc::cell(Some(ResolvedVc::cell(conditions)))\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn persistent_caching_enabled(&self) -> Result<Vc<bool>> {\n         Ok(Vc::cell("
        },
        {
            "sha": "d2a9ce348fd525576e5815f002425a8aa61a090e",
            "filename": "crates/next-core/src/next_shared/webpack_rules/mod.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -15,19 +15,22 @@ pub async fn webpack_loader_options(\n     project_path: ResolvedVc<FileSystemPath>,\n     next_config: Vc<NextConfig>,\n     foreign: bool,\n-    conditions: Vec<RcStr>,\n+    condition_strs: Vec<RcStr>,\n ) -> Result<Option<ResolvedVc<WebpackLoadersOptions>>> {\n-    let rules = *next_config.webpack_rules(conditions).await?;\n+    let rules = *next_config.webpack_rules(condition_strs).await?;\n     let rules = *maybe_add_sass_loader(next_config.sass_config(), rules.map(|v| *v)).await?;\n     let rules = if foreign {\n         rules\n     } else {\n         *maybe_add_babel_loader(*project_path, rules.map(|v| *v)).await?\n     };\n+\n+    let conditions = next_config.webpack_conditions().to_resolved().await?;\n     Ok(if let Some(rules) = rules {\n         Some(\n             WebpackLoadersOptions {\n                 rules,\n+                conditions,\n                 loader_runner_package: Some(loader_runner_package_mapping().to_resolved().await?),\n             }\n             .resolved_cell(),"
        },
        {
            "sha": "2c2b37da94eaa2fb6c6f304ba576a6086cdd659f",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -874,6 +874,33 @@ function bindingToApi(\n       }\n     }\n \n+    const conditions: (typeof nextConfig)['turbopack']['conditions'] =\n+      nextConfigSerializable.turbopack?.conditions\n+    if (conditions) {\n+      type SerializedConditions = {\n+        [key: string]: {\n+          path:\n+            | { type: 'regexp'; value: { source: string; flags: string } }\n+            | { type: 'glob'; value: string }\n+        }\n+      }\n+\n+      const serializedConditions: SerializedConditions = {}\n+      for (const [key, value] of Object.entries(conditions)) {\n+        serializedConditions[key] = {\n+          ...value,\n+          path:\n+            value.path instanceof RegExp\n+              ? {\n+                  type: 'regexp',\n+                  value: { source: value.path.source, flags: value.path.flags },\n+                }\n+              : { type: 'glob', value: value.path },\n+        }\n+      }\n+      nextConfigSerializable.turbopack.conditions = serializedConditions\n+    }\n+\n     return JSON.stringify(nextConfigSerializable, null, 2)\n   }\n "
        },
        {
            "sha": "4c094adac5eebcbfd29aa1ed97009259a8a94c7e",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -13,6 +13,7 @@ import type {\n   TurbopackRuleConfigItem,\n   TurbopackRuleConfigItemOptions,\n   TurbopackRuleConfigItemOrShortcut,\n+  TurbopackRuleCondition,\n } from './config-shared'\n import type {\n   Header,\n@@ -128,8 +129,13 @@ const zTurboRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> = z.union([\n const zTurboRuleConfigItemOrShortcut: zod.ZodType<TurbopackRuleConfigItemOrShortcut> =\n   z.union([z.array(zTurboLoaderItem), zTurboRuleConfigItem])\n \n+const zTurboCondition: zod.ZodType<TurbopackRuleCondition> = z.object({\n+  path: z.union([z.string(), z.instanceof(RegExp)]),\n+})\n+\n const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({\n   rules: z.record(z.string(), zTurboRuleConfigItemOrShortcut).optional(),\n+  conditions: z.record(z.string(), zTurboCondition).optional(),\n   resolveAlias: z\n     .record(\n       z.string(),"
        },
        {
            "sha": "0d9e18ba9d2483f9d8b5816407f05aacaa6984bb",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -105,6 +105,10 @@ export type TurbopackLoaderItem =\n       options: Record<string, JSONValue>\n     }\n \n+export type TurbopackRuleCondition = {\n+  path: string | RegExp\n+}\n+\n export type TurbopackRuleConfigItemOrShortcut =\n   | TurbopackLoaderItem[]\n   | TurbopackRuleConfigItem\n@@ -144,6 +148,13 @@ export interface TurbopackOptions {\n    */\n   rules?: Record<string, TurbopackRuleConfigItemOrShortcut>\n \n+  /**\n+   * (`next --turbopack` only) A list of conditions to apply when running webpack loaders with Turbopack.\n+   *\n+   * @see [Turbopack Loaders](https://nextjs.org/docs/app/api-reference/next-config-js/turbo#webpack-loaders)\n+   */\n+  conditions?: Record<string, TurbopackRuleCondition>\n+\n   /**\n    * The module ID strategy to use for Turbopack.\n    * If not set, the default is `'named'` for development and `'deterministic'`"
        },
        {
            "sha": "ae9c08430f132b5d058808d719318381e66a1f38",
            "filename": "turbopack/crates/turbopack/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2FCargo.toml?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -29,6 +29,7 @@ tokio = { workspace = true }\n tracing = { workspace = true }\n \n turbo-rcstr = { workspace = true }\n+turbo-esregex = { workspace = true }\n turbo-tasks = { workspace = true }\n turbo-tasks-env = { workspace = true }\n turbo-tasks-fs = { workspace = true }"
        },
        {
            "sha": "2f1d371d3d389b1ea502dfc0251aa38cb682e087",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 5,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -627,16 +627,40 @@ impl ModuleOptions {\n                     path.context(\"need_path in ModuleOptions::new is incorrect\")?,\n                 )\n             };\n-            for (glob, rule) in webpack_loaders_options.rules.await?.iter() {\n+            for (key, rule) in webpack_loaders_options.rules.await?.iter() {\n                 rules.push(ModuleRule::new(\n                     RuleCondition::All(vec![\n-                        if !glob.contains('/') {\n-                            RuleCondition::ResourceBasePathGlob(Glob::new(glob.clone()).await?)\n-                        } else {\n+                        if key.starts_with(\"#\") {\n+                            // This is a custom marker requiring a corresponding condition entry\n+                            let conditions = (*webpack_loaders_options.conditions.await?)\n+                                .context(\n+                                    \"Expected a condition entry for the webpack loader rule \\\n+                                     matching {key}. Create a `conditions` mapping in your \\\n+                                     next.config.js\",\n+                                )?\n+                                .await?;\n+\n+                            let condition = conditions.get(key).context(\n+                                \"Expected a condition entry for the webpack loader rule matching \\\n+                                 {key}.\",\n+                            )?;\n+\n+                            match &condition.path {\n+                                ConditionPath::Glob(glob) => RuleCondition::ResourcePathGlob {\n+                                    base: execution_context.project_path().await?,\n+                                    glob: Glob::new(glob.clone()).await?,\n+                                },\n+                                ConditionPath::Regex(regex) => {\n+                                    RuleCondition::ResourcePathEsRegex(regex.await?)\n+                                }\n+                            }\n+                        } else if key.contains('/') {\n                             RuleCondition::ResourcePathGlob {\n                                 base: execution_context.project_path().await?,\n-                                glob: Glob::new(glob.clone()).await?,\n+                                glob: Glob::new(key.clone()).await?,\n                             }\n+                        } else {\n+                            RuleCondition::ResourceBasePathGlob(Glob::new(key.clone()).await?)\n                         },\n                         RuleCondition::not(RuleCondition::ResourceIsVirtualSource),\n                     ]),"
        },
        {
            "sha": "95547acf0f9df246cdbd06782e3e81647f742010",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -1,4 +1,7 @@\n+use std::fmt::Debug;\n+\n use serde::{Deserialize, Serialize};\n+use turbo_esregex::EsRegex;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{trace::TraceRawVcs, FxIndexMap, NonLocalValue, ResolvedVc, ValueDefault, Vc};\n use turbo_tasks_fs::FileSystemPath;\n@@ -31,10 +34,31 @@ pub struct WebpackRules(FxIndexMap<RcStr, LoaderRuleItem>);\n #[turbo_tasks::value(transparent)]\n pub struct OptionWebpackRules(Option<ResolvedVc<WebpackRules>>);\n \n+#[derive(Default)]\n+#[turbo_tasks::value(transparent)]\n+pub struct WebpackConditions(pub FxIndexMap<RcStr, ConditionItem>);\n+\n+#[derive(Default)]\n+#[turbo_tasks::value(transparent)]\n+pub struct OptionWebpackConditions(Option<ResolvedVc<WebpackConditions>>);\n+\n+#[derive(Clone, PartialEq, Eq, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue)]\n+pub enum ConditionPath {\n+    Glob(RcStr),\n+    Regex(ResolvedVc<EsRegex>),\n+}\n+\n+#[turbo_tasks::value(shared)]\n+#[derive(Clone, Debug)]\n+pub struct ConditionItem {\n+    pub path: ConditionPath,\n+}\n+\n #[turbo_tasks::value(shared)]\n #[derive(Clone, Debug)]\n pub struct WebpackLoadersOptions {\n     pub rules: ResolvedVc<WebpackRules>,\n+    pub conditions: ResolvedVc<OptionWebpackConditions>,\n     pub loader_runner_package: Option<ResolvedVc<ImportMapping>>,\n }\n "
        },
        {
            "sha": "2e77eedeea17079d8f8da9370a757ebb47299cf9",
            "filename": "turbopack/crates/turbopack/src/module_options/rule_condition.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Frule_condition.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Frule_condition.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Frule_condition.rs?ref=83dc2ebd25406ba29cfb8fbe57e7326d3f6b3f11",
            "patch": "@@ -1,5 +1,6 @@\n use anyhow::{bail, Result};\n use serde::{Deserialize, Serialize};\n+use turbo_esregex::EsRegex;\n use turbo_tasks::{primitives::Regex, trace::TraceRawVcs, NonLocalValue, ReadRef, ResolvedVc};\n use turbo_tasks_fs::{glob::Glob, FileSystemPath};\n use turbopack_core::{\n@@ -21,6 +22,7 @@ pub enum RuleCondition {\n     ContentTypeStartsWith(String),\n     ContentTypeEmpty,\n     ResourcePathRegex(#[turbo_tasks(trace_ignore)] Regex),\n+    ResourcePathEsRegex(#[turbo_tasks(trace_ignore)] ReadRef<EsRegex>),\n     /// For paths that are within the same filesystem as the `base`, it need to\n     /// match the relative path from base to resource. This includes `./` or\n     /// `../` prefix. For paths in a different filesystem, it need to match\n@@ -125,6 +127,7 @@ impl RuleCondition {\n             RuleCondition::ResourcePathRegex(_) => {\n                 bail!(\"ResourcePathRegex not implemented yet\")\n             }\n+            RuleCondition::ResourcePathEsRegex(regex) => regex.is_match(&path.path),\n         })\n     }\n }"
        }
    ],
    "stats": {
        "total": 188,
        "additions": 179,
        "deletions": 9
    }
}