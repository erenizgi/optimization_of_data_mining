{
    "author": "kdy1",
    "message": "perf: Check file using SWC before applying React Compiler (#75605)\n\n### What?\n\nCheck if the file is a file that is _interesting_ to the React Compiler before passing it to the React Compiler\n\n### Why?\n\nIt would skip the majority of files",
    "sha": "070d31f76dc9a336f41f676010c7ea40595c918c",
    "files": [
        {
            "sha": "0fe70803a552144f14701d78db7370d10454f341",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -50,6 +50,7 @@ pub mod minify;\n #[cfg(not(target_arch = \"wasm32\"))]\n pub mod next_api;\n pub mod parse;\n+pub mod react_compiler;\n pub mod transform;\n #[cfg(not(target_arch = \"wasm32\"))]\n pub mod turbo_trace_server;"
        },
        {
            "sha": "aa8474d120c83f060f3d93221513f4cc96c62a09",
            "filename": "crates/napi/src/react_compiler.rs",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnapi%2Fsrc%2Freact_compiler.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnapi%2Fsrc%2Freact_compiler.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Freact_compiler.rs?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -0,0 +1,62 @@\n+use std::{path::PathBuf, sync::Arc};\n+\n+use napi::bindgen_prelude::*;\n+use next_custom_transforms::react_compiler;\n+use swc_core::{\n+    common::{SourceMap, GLOBALS},\n+    ecma::{\n+        ast::EsVersion,\n+        parser::{parse_file_as_program, Syntax, TsSyntax},\n+    },\n+};\n+\n+pub struct CheckTask {\n+    pub filename: PathBuf,\n+}\n+\n+#[napi]\n+impl Task for CheckTask {\n+    type Output = bool;\n+    type JsValue = bool;\n+\n+    fn compute(&mut self) -> napi::Result<Self::Output> {\n+        GLOBALS.set(&Default::default(), || {\n+            //\n+            let cm = Arc::new(SourceMap::default());\n+            let Ok(fm) = cm.load_file(&self.filename.clone()) else {\n+                return Ok(false);\n+            };\n+            let mut errors = vec![];\n+            let Ok(program) = parse_file_as_program(\n+                &fm,\n+                Syntax::Typescript(TsSyntax {\n+                    tsx: true,\n+                    ..Default::default()\n+                }),\n+                EsVersion::EsNext,\n+                None,\n+                &mut errors,\n+            ) else {\n+                return Ok(false);\n+            };\n+            if !errors.is_empty() {\n+                return Ok(false);\n+            }\n+\n+            Ok(react_compiler::is_required(&program))\n+        })\n+    }\n+\n+    fn resolve(&mut self, _env: Env, result: Self::Output) -> napi::Result<Self::JsValue> {\n+        Ok(result)\n+    }\n+}\n+\n+#[napi]\n+pub fn is_react_compiler_required(\n+    filename: String,\n+    signal: Option<AbortSignal>,\n+) -> AsyncTask<CheckTask> {\n+    let filename = PathBuf::from(filename);\n+    AsyncTask::with_optional_signal(CheckTask { filename }, signal)\n+}"
        },
        {
            "sha": "258658e40c2db7d241dcda5a449279043f009484",
            "filename": "crates/next-custom-transforms/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnext-custom-transforms%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnext-custom-transforms%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Flib.rs?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -39,6 +39,7 @@ use rustc_hash::FxHasher;\n \n pub mod chain_transforms;\n mod linter;\n+pub mod react_compiler;\n pub mod transforms;\n \n type FxIndexMap<K, V> = IndexMap<K, V, BuildHasherDefault<FxHasher>>;"
        },
        {
            "sha": "398de1e5ad0d72bc097602ea1c63dbfc71567e96",
            "filename": "crates/next-custom-transforms/src/react_compiler.rs",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnext-custom-transforms%2Fsrc%2Freact_compiler.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/crates%2Fnext-custom-transforms%2Fsrc%2Freact_compiler.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Freact_compiler.rs?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -0,0 +1,71 @@\n+use swc_core::ecma::{\n+    ast::{Callee, Expr, FnDecl, FnExpr, Program, ReturnStmt},\n+    visit::{Visit, VisitWith},\n+};\n+\n+pub fn is_required(program: &Program) -> bool {\n+    let mut finder = Finder::default();\n+    finder.visit_program(program);\n+    finder.found\n+}\n+\n+#[derive(Default)]\n+struct Finder {\n+    found: bool,\n+\n+    /// We are in a function that starts with a capital letter or it's a function that starts with\n+    /// `use`\n+    is_interested: bool,\n+}\n+\n+impl Visit for Finder {\n+    fn visit_callee(&mut self, node: &Callee) {\n+        if self.is_interested {\n+            if let Callee::Expr(e) = node {\n+                if let Expr::Ident(c) = &**e {\n+                    if c.sym.starts_with(\"use\") {\n+                        self.found = true;\n+                        return;\n+                    }\n+                }\n+            }\n+        }\n+\n+        node.visit_children_with(self);\n+    }\n+\n+    fn visit_fn_decl(&mut self, node: &FnDecl) {\n+        let old = self.is_interested;\n+        self.is_interested = node.ident.sym.starts_with(\"use\")\n+            || node.ident.sym.starts_with(|c: char| c.is_ascii_uppercase());\n+\n+        node.visit_children_with(self);\n+\n+        self.is_interested = old;\n+    }\n+\n+    fn visit_fn_expr(&mut self, node: &FnExpr) {\n+        let old = self.is_interested;\n+\n+        self.is_interested = node.ident.as_ref().is_some_and(|ident| {\n+            ident.sym.starts_with(\"use\") || ident.sym.starts_with(|c: char| c.is_ascii_uppercase())\n+        });\n+\n+        node.visit_children_with(self);\n+\n+        self.is_interested = old;\n+    }\n+\n+    fn visit_return_stmt(&mut self, node: &ReturnStmt) {\n+        if self.is_interested {\n+            if let Some(Expr::JSXElement(..) | Expr::JSXEmpty(..) | Expr::JSXFragment(..)) =\n+                node.arg.as_deref()\n+            {\n+                self.found = true;\n+                return;\n+            }\n+        }\n+\n+        node.visit_children_with(self);\n+    }\n+}"
        },
        {
            "sha": "fecc87f08d47f965b0ba36834f0cb253e9ffa1cc",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -8,6 +8,7 @@ import type { NextBabelLoaderOptions, NextJsLoaderContext } from './types'\n import { consumeIterator } from './util'\n import * as Log from '../../output/log'\n import jsx from 'next/dist/compiled/babel/plugin-syntax-jsx'\n+import { isReactCompilerRequired } from '../../swc'\n \n const nextDistPath =\n   /(next[\\\\/]dist[\\\\/]shared[\\\\/]lib)|(next[\\\\/]dist[\\\\/]client)|(next[\\\\/]dist[\\\\/]pages)/\n@@ -257,15 +258,15 @@ function checkCustomBabelConfigDeprecation(\n  * Generate a new, flat Babel config, ready to be handed to Babel-traverse.\n  * This config should have no unresolved overrides, presets, etc.\n  */\n-function getFreshConfig(\n+async function getFreshConfig(\n   this: NextJsLoaderContext,\n   cacheCharacteristics: CharacteristicsGermaneToCaching,\n   loaderOptions: NextBabelLoaderOptions,\n   target: string,\n   filename: string,\n   inputSourceMap?: object | null\n ) {\n-  const hasReactCompiler = (() => {\n+  const hasReactCompiler = await (async () => {\n     if (\n       loaderOptions.reactCompilerPlugins &&\n       loaderOptions.reactCompilerPlugins.length === 0\n@@ -284,6 +285,10 @@ function getFreshConfig(\n       return false\n     }\n \n+    if (!(await isReactCompilerRequired(filename))) {\n+      return false\n+    }\n+\n     return true\n   })()\n \n@@ -436,7 +441,7 @@ type BabelConfig = any\n const configCache: Map<any, BabelConfig> = new Map()\n const configFiles: Set<string> = new Set()\n \n-export default function getConfig(\n+export default async function getConfig(\n   this: NextJsLoaderContext,\n   {\n     source,\n@@ -451,7 +456,7 @@ export default function getConfig(\n     filename: string\n     inputSourceMap?: object | null\n   }\n-): BabelConfig {\n+): Promise<BabelConfig> {\n   const cacheCharacteristics = getCacheCharacteristics(\n     loaderOptions,\n     source,\n@@ -493,7 +498,7 @@ export default function getConfig(\n     )\n   }\n \n-  const freshConfig = getFreshConfig.call(\n+  const freshConfig = await getFreshConfig.call(\n     this,\n     cacheCharacteristics,\n     loaderOptions,"
        },
        {
            "sha": "99c42e991006aac2bdd279a725428f7fabd1cdaf",
            "filename": "packages/next/src/build/babel/loader/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -27,16 +27,17 @@ async function nextBabelLoader(\n \n   const loaderSpanInner = parentTrace.traceChild('next-babel-turbo-transform')\n   const { code: transformedSource, map: outputSourceMap } =\n-    loaderSpanInner.traceFn(() =>\n-      transform.call(\n-        this,\n-        inputSource,\n-        inputSourceMap,\n-        loaderOptions,\n-        filename,\n-        target,\n-        loaderSpanInner\n-      )\n+    await loaderSpanInner.traceAsyncFn(\n+      async () =>\n+        await transform.call(\n+          this,\n+          inputSource,\n+          inputSourceMap,\n+          loaderOptions,\n+          filename,\n+          target,\n+          loaderSpanInner\n+        )\n     )\n \n   return [transformedSource, outputSourceMap]"
        },
        {
            "sha": "71cf68bd06872c0c9678198fe34978c977dbe7a7",
            "filename": "packages/next/src/build/babel/loader/transform.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -69,7 +69,7 @@ function transformAst(file: any, babelConfig: any, parentSpan: Span) {\n   }\n }\n \n-export default function transform(\n+export default async function transform(\n   this: NextJsLoaderContext,\n   source: string,\n   inputSourceMap: object | null | undefined,\n@@ -79,7 +79,7 @@ export default function transform(\n   parentSpan: Span\n ) {\n   const getConfigSpan = parentSpan.traceChild('babel-turbo-get-config')\n-  const babelConfig = getConfig.call(this, {\n+  const babelConfig = await getConfig.call(this, {\n     source,\n     loaderOptions,\n     inputSourceMap,"
        },
        {
            "sha": "fddf02cb0f89daf63e2c648d35afe9094615852e",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -367,6 +367,10 @@ export declare function parse(\n   filename?: string | undefined | null,\n   signal?: AbortSignal | undefined | null\n ): Promise<string>\n+export declare function isReactCompilerRequired(\n+  filename: string,\n+  signal?: AbortSignal | undefined | null\n+): Promise<boolean>\n export declare function transform(\n   src: string | Buffer | undefined,\n   isModule: boolean,"
        },
        {
            "sha": "775efa5d8831e633281f6fdc57c455e2cbd29c8a",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -1104,6 +1104,11 @@ async function loadWasm(importPath = '') {\n             return bindings.mdxCompileSync(src, getMdxOptions(options))\n           },\n         },\n+        reactCompiler: {\n+          isReactCompilerRequired(_filename: string) {\n+            return Promise.resolve(true)\n+          },\n+        },\n       }\n       return wasmBindings\n     } catch (e: any) {\n@@ -1275,6 +1280,11 @@ function loadNative(importPath?: string) {\n           },\n         },\n       },\n+      reactCompiler: {\n+        isReactCompilerRequired: (filename: string) => {\n+          return bindings.isReactCompilerRequired(filename)\n+        },\n+      },\n     }\n     return nativeBindings\n   }\n@@ -1320,6 +1330,13 @@ export async function minify(\n   return bindings.minify(src, options)\n }\n \n+export async function isReactCompilerRequired(\n+  filename: string\n+): Promise<boolean> {\n+  let bindings = await loadBindings()\n+  return bindings.reactCompiler.isReactCompilerRequired(filename)\n+}\n+\n export async function parse(src: string, options: any): Promise<any> {\n   let bindings = await loadBindings()\n   let parserOptions = getParserOptions(options)"
        },
        {
            "sha": "b328cf33a23e10565a08e599da760fed002464d7",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/070d31f76dc9a336f41f676010c7ea40595c918c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=070d31f76dc9a336f41f676010c7ea40595c918c",
            "patch": "@@ -39,6 +39,10 @@ export interface Binding {\n       transformStyleAttr(transformAttrOptions: any): Promise<any>\n     }\n   }\n+\n+  reactCompiler: {\n+    isReactCompilerRequired(filename: string): Promise<boolean>\n+  }\n }\n \n export type StyledString ="
        }
    ],
    "stats": {
        "total": 200,
        "additions": 183,
        "deletions": 17
    }
}