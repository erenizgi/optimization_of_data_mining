{
    "author": "acdlite",
    "message": "Implement runtime prefetching via segment opt-in (#83072)\n\nFollow-up to #82905.\n\nWhen prefetching a link, we should perform a runtime prefetch for any\nsegment that\n\n- has runtime prefetching enabled\n- is not a shared layout\n\nor\n\n- is a child of a segment that meets the above criteria.\n\nAnything that doesn't meet those criteria will be prefetched statically,\ni.e. the behavior before this PR. In other words, we disregard the\n`prefetch` config of shared layouts when deciding whether to perform a\nruntime prefetch.\n\nThis means if you opt into runtime prefetching in a layout, navigating\nto a page inside that layout for the first time will perform a runtime\nprefetch, but navigating across multiple pages inside that layout will\nbe static (until/unless there's a child that has also opted into runtime\nprefetching).\n\nFor example, given a route structure like `/store/[id]`, where\n`/store/layout.tsx` has runtime prefetching enabled, but\n`/store/[id]/page.tsx` does not:\n\n- A Link from `/home` to `/store/1` results in a **runtime prefetch**\n- A Link from `/store/1` to `/store/2` results in a **static prefetch**\n\nIf we didn't make this distinction, then opting into prefetching in a\nlayout would override the config of everything inside it.\n\n(However, the most common pattern will be to set this config at the page\nlevel, where the distinction doesn't matter, since there are no child\nsegments.)\n\n---------\n\nCo-authored-by: Janka Uryga <lolzatu2@gmail.com>",
    "sha": "9cd05eaef3015ebaad1a715e1ce43025939bfecf",
    "files": [
        {
            "sha": "404434215f9f40940bf1a4b323b107a90d0bc23e",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 15,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -121,6 +121,12 @@ export type RouteTree = {\n   // this value is disregarded, because in that model `loading.tsx` is treated\n   // like any other Suspense boundary.)\n   hasLoadingBoundary: HasLoadingBoundary\n+\n+  // Indicates whether this route has a runtime prefetch that we can request.\n+  // This is determined by the server; it's not purely a user configuration\n+  // because the server may determine that a route is fully static and doesn't\n+  // need runtime prefetching regardless of the configuration.\n+  hasRuntimePrefetch: boolean\n }\n \n type RouteCacheEntryShared = {\n@@ -147,10 +153,10 @@ type RouteCacheEntryShared = {\n  * Rejected depending on the response from the server.\n  */\n export const enum EntryStatus {\n-  Empty,\n-  Pending,\n-  Fulfilled,\n-  Rejected,\n+  Empty = 0,\n+  Pending = 1,\n+  Fulfilled = 2,\n+  Rejected = 3,\n }\n \n type PendingRouteCacheEntry = RouteCacheEntryShared & {\n@@ -431,8 +437,8 @@ export function readRouteCacheEntry(\n   return readExactRouteCacheEntry(now, key.href, key.nextUrl)\n }\n \n-export function getSegmentKeypathForTask(\n-  task: PrefetchTask,\n+export function getSegmentKeypath(\n+  fetchStrategy: FetchStrategy,\n   route: FulfilledRouteCacheEntry,\n   cacheKey: SegmentCacheKey\n ): Prefix<SegmentCacheKeypath> {\n@@ -443,11 +449,11 @@ export function getSegmentKeypathForTask(\n   // If we're fetching using PPR, we do not need to include the search params in\n   // the cache key, because the search params are treated as dynamic data. The\n   // cache entry is valid for all possible search param values.\n-  const isDynamicTask =\n-    task.fetchStrategy === FetchStrategy.Full ||\n-    task.fetchStrategy === FetchStrategy.PPRRuntime ||\n+  const isDynamic =\n+    fetchStrategy === FetchStrategy.Full ||\n+    fetchStrategy === FetchStrategy.PPRRuntime ||\n     !route.isPPREnabled\n-  return isDynamicTask && cacheKey.endsWith('/' + PAGE_SEGMENT_KEY)\n+  return isDynamic && cacheKey.endsWith('/' + PAGE_SEGMENT_KEY)\n     ? [cacheKey, route.renderedSearch]\n     : [cacheKey]\n }\n@@ -481,7 +487,7 @@ export function readSegmentCacheEntry(\n   // is the common case because PPR/static prerenders always treat search params\n   // as dynamic.\n   //\n-  // See corresponding logic in `getSegmentKeypathForTask`.\n+  // See corresponding logic in `getSegmentKeypath`.\n   const entryWithoutSearchParams = readExactSegmentCacheEntry(now, [cacheKey])\n   return entryWithoutSearchParams\n }\n@@ -744,11 +750,11 @@ export function requestOptimisticRouteCacheEntry(\n  */\n export function readOrCreateSegmentCacheEntry(\n   now: number,\n-  task: PrefetchTask,\n+  fetchStrategy: FetchStrategy,\n   route: FulfilledRouteCacheEntry,\n   cacheKey: SegmentCacheKey\n ): SegmentCacheEntry {\n-  const keypath = getSegmentKeypathForTask(task, route, cacheKey)\n+  const keypath = getSegmentKeypath(fetchStrategy, route, cacheKey)\n   const existingEntry = readExactSegmentCacheEntry(now, keypath)\n   if (existingEntry !== null) {\n     return existingEntry\n@@ -1158,6 +1164,7 @@ function convertTreePrefetchToRouteTree(\n     // This field is only relevant to dynamic routes. For a PPR/static route,\n     // there's always some partial loading state we can fetch.\n     hasLoadingBoundary: HasLoadingBoundary.SegmentHasLoadingBoundary,\n+    hasRuntimePrefetch: prefetch.hasRuntimePrefetch,\n   }\n }\n \n@@ -1251,6 +1258,10 @@ function convertFlightRouterStateToRouteTree(\n       flightRouterState[5] !== undefined\n         ? flightRouterState[5]\n         : HasLoadingBoundary.SubtreeHasNoLoadingBoundary,\n+\n+    // Non-static tree responses are only used by apps that haven't adopted\n+    // Cache Components. So this is always false.\n+    hasRuntimePrefetch: false,\n   }\n }\n \n@@ -2036,7 +2047,7 @@ function writeSeedDataIntoCache(\n     // There's no matching entry. Attempt to create a new one.\n     const possiblyNewEntry = readOrCreateSegmentCacheEntry(\n       now,\n-      task,\n+      fetchStrategy,\n       route,\n       cacheKey\n     )\n@@ -2065,7 +2076,7 @@ function writeSeedDataIntoCache(\n       )\n       upsertSegmentEntry(\n         now,\n-        getSegmentKeypathForTask(task, route, cacheKey),\n+        getSegmentKeypath(fetchStrategy, route, cacheKey),\n         newEntry\n       )\n     }"
        },
        {
            "sha": "587af1579531dc104c1d5809b1b242afc93138d4",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -359,7 +359,7 @@ function readRenderSnapshotFromCache(\n   )\n \n   // We don't need this information in a render snapshot, so this can just be a placeholder.\n-  const shouldUseRuntimePrefetch = false\n+  const hasRuntimePrefetch = false\n \n   return {\n     flightRouterState: [\n@@ -375,7 +375,7 @@ function readRenderSnapshotFromCache(\n       childSeedDatas,\n       loading,\n       isPartial,\n-      shouldUseRuntimePrefetch,\n+      hasRuntimePrefetch,\n     ],\n   }\n }"
        },
        {
            "sha": "b7852c8901ceca8cac485269045cdd4bd45ccc26",
            "filename": "packages/next/src/client/components/segment-cache-impl/scheduler.ts",
            "status": "modified",
            "additions": 269,
            "deletions": 26,
            "changes": 295,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -24,7 +24,7 @@ import {\n   upgradeToPendingSegment,\n   waitForSegmentCacheEntry,\n   resetRevalidatingSegmentEntry,\n-  getSegmentKeypathForTask,\n+  getSegmentKeypath,\n   canNewFetchStrategyProvideMoreContent,\n } from './cache'\n import type { RouteCacheKey } from './cache-key'\n@@ -116,11 +116,11 @@ export type PrefetchTask = {\n   phase: PrefetchPhase\n \n   /**\n-   * Temporary state for tracking the currently running task. This is currently\n-   * used to track whether a task deferred some work to run background at\n-   * priority, but we might need it for additional state in the future.\n+   * These fields are temporary state for tracking the currently running task.\n+   * They are reset after each iteration of the task queue.\n    */\n   hasBackgroundWork: boolean\n+  spawnedRuntimePrefetches: Set<SegmentCacheKey> | null\n \n   /**\n    * True if the prefetch was cancelled.\n@@ -224,6 +224,7 @@ export function schedulePrefetchTask(\n     priority,\n     phase: PrefetchPhase.RouteTree,\n     hasBackgroundWork: false,\n+    spawnedRuntimePrefetches: null,\n     fetchStrategy,\n     sortId: sortIdCounter++,\n     isCanceled: false,\n@@ -441,10 +442,11 @@ function processQueueInMicrotask() {\n     const route = readOrCreateRouteCacheEntry(now, task)\n     const exitStatus = pingRootRouteTree(now, task, route)\n \n-    // The `hasBackgroundWork` field is only valid for a single attempt. Reset\n-    // it immediately upon exit.\n+    // These fields are only valid for a single attempt. Reset them after each\n+    // iteration of the task queue.\n     const hasBackgroundWork = task.hasBackgroundWork\n     task.hasBackgroundWork = false\n+    task.spawnedRuntimePrefetches = null\n \n     switch (exitStatus) {\n       case PrefetchTaskExitStatus.InProgress:\n@@ -575,15 +577,68 @@ function pingRootRouteTree(\n           : task.fetchStrategy\n \n       switch (fetchStrategy) {\n-        case FetchStrategy.PPR:\n-          // Individually prefetch the static shell for each segment. This is\n-          // the default prefetching behavior for static routes, or when PPR is\n-          // enabled. It will not include any dynamic data.\n-          return pingPPRRouteTree(now, task, route, tree)\n+        case FetchStrategy.PPR: {\n+          // For Cache Components pages, each segment may be prefetched\n+          // statically or using a runtime request, based on various\n+          // configurations and heuristics. We'll do this in two passes: first\n+          // traverse the tree and perform all the static prefetches.\n+          //\n+          // Then, if there are any segments that need a runtime request,\n+          // do another pass to perform a runtime prefetch.\n+          const exitStatus = pingSharedPartOfCacheComponentsTree(\n+            now,\n+            task,\n+            route,\n+            task.treeAtTimeOfPrefetch,\n+            tree\n+          )\n+          if (exitStatus === PrefetchTaskExitStatus.InProgress) {\n+            // Child yielded without finishing.\n+            return PrefetchTaskExitStatus.InProgress\n+          }\n+          const spawnedRuntimePrefetches = task.spawnedRuntimePrefetches\n+          if (spawnedRuntimePrefetches !== null) {\n+            // During the first pass, we discovered segments that require a\n+            // runtime prefetch. Do a second pass to construct a request tree.\n+            const spawnedEntries = new Map<\n+              SegmentCacheKey,\n+              PendingSegmentCacheEntry\n+            >()\n+            const requestTree = pingRuntimePrefetches(\n+              now,\n+              task,\n+              route,\n+              tree,\n+              spawnedRuntimePrefetches,\n+              spawnedEntries\n+            )\n+            let needsDynamicRequest = spawnedEntries.size > 0\n+            if (needsDynamicRequest) {\n+              // Perform a dynamic prefetch request and populate the cache with\n+              // the result.\n+              spawnPrefetchSubtask(\n+                fetchSegmentPrefetchesUsingDynamicRequest(\n+                  task,\n+                  route,\n+                  FetchStrategy.PPRRuntime,\n+                  requestTree,\n+                  spawnedEntries\n+                )\n+              )\n+            }\n+          }\n+          return PrefetchTaskExitStatus.Done\n+        }\n         case FetchStrategy.Full:\n         case FetchStrategy.PPRRuntime:\n         case FetchStrategy.LoadingBoundary: {\n           // Prefetch multiple segments using a single dynamic request.\n+          // TODO: We can consolidate this branch with previous one by modeling\n+          // it as if the first segment in the new tree has runtime prefetching\n+          // enabled. Will do this as a follow-up refactor. Might want to remove\n+          // the special metatdata case below first. In the meantime, it's not\n+          // really that much duplication, just would be nice to remove one of\n+          // these codepaths.\n           const spawnedEntries = new Map<\n             SegmentCacheKey,\n             PendingSegmentCacheEntry\n@@ -656,14 +711,133 @@ function pingRootRouteTree(\n   return PrefetchTaskExitStatus.Done\n }\n \n-function pingPPRRouteTree(\n+function pingSharedPartOfCacheComponentsTree(\n+  now: number,\n+  task: PrefetchTask,\n+  route: FulfilledRouteCacheEntry,\n+  oldTree: FlightRouterState,\n+  newTree: RouteTree\n+): PrefetchTaskExitStatus {\n+  // When Cache Components is enabled (or PPR, or a fully static route when PPR\n+  // is disabled; those cases are treated equivalently to Cache Components), we\n+  // start by prefetching each segment individually. Once we reach the \"new\"\n+  // part of the tree — the part that doesn't exist on the current page — we\n+  // may choose to switch to a runtime prefetch instead, based on the\n+  // information sent by the server in the route tree.\n+  //\n+  // The traversal starts in the \"shared\" part of the tree. Once we reach the\n+  // \"new\" part of the tree, we switch to a different traversal,\n+  // pingNewPartOfCacheComponentsTree.\n+\n+  // Prefetch this segment's static data.\n+  const segment = readOrCreateSegmentCacheEntry(\n+    now,\n+    task.fetchStrategy,\n+    route,\n+    newTree.cacheKey\n+  )\n+  pingStaticSegmentData(now, task, route, segment, task.key, newTree)\n+\n+  // Recursively ping the children.\n+  const oldTreeChildren = oldTree[1]\n+  const newTreeChildren = newTree.slots\n+  if (newTreeChildren !== null) {\n+    for (const parallelRouteKey in newTreeChildren) {\n+      if (!hasNetworkBandwidth(task)) {\n+        // Stop prefetching segments until there's more bandwidth.\n+        return PrefetchTaskExitStatus.InProgress\n+      }\n+      const newTreeChild = newTreeChildren[parallelRouteKey]\n+      const newTreeChildSegment = newTreeChild.segment\n+      const oldTreeChild: FlightRouterState | void =\n+        oldTreeChildren[parallelRouteKey]\n+      const oldTreeChildSegment: FlightRouterStateSegment | void =\n+        oldTreeChild?.[0]\n+      let childExitStatus\n+      if (\n+        oldTreeChildSegment !== undefined &&\n+        doesCurrentSegmentMatchCachedSegment(\n+          route,\n+          newTreeChildSegment,\n+          oldTreeChildSegment\n+        )\n+      ) {\n+        // We're still in the \"shared\" part of the tree.\n+        childExitStatus = pingSharedPartOfCacheComponentsTree(\n+          now,\n+          task,\n+          route,\n+          oldTreeChild,\n+          newTreeChild\n+        )\n+      } else {\n+        // We've entered the \"new\" part of the tree. Switch\n+        // traversal functions.\n+        childExitStatus = pingNewPartOfCacheComponentsTree(\n+          now,\n+          task,\n+          route,\n+          newTreeChild\n+        )\n+      }\n+      if (childExitStatus === PrefetchTaskExitStatus.InProgress) {\n+        // Child yielded without finishing.\n+        return PrefetchTaskExitStatus.InProgress\n+      }\n+    }\n+  }\n+\n+  return PrefetchTaskExitStatus.Done\n+}\n+\n+function pingNewPartOfCacheComponentsTree(\n   now: number,\n   task: PrefetchTask,\n   route: FulfilledRouteCacheEntry,\n   tree: RouteTree\n ): PrefetchTaskExitStatus.InProgress | PrefetchTaskExitStatus.Done {\n-  const segment = readOrCreateSegmentCacheEntry(now, task, route, tree.cacheKey)\n-  pingPerSegment(now, task, route, segment, task.key, tree)\n+  // We're now prefetching in the \"new\" part of the tree, the part that doesn't\n+  // exist on the current page. (In other words, we're deeper than the\n+  // shared layouts.) Segments in here default to being prefetched statically.\n+  // However, if the server instructs us to, we may switch to a runtime\n+  // prefetch instead. Traverse the tree and check at each segment.\n+  if (tree.hasRuntimePrefetch) {\n+    // This route has a runtime prefetch response. Since we're below the shared\n+    // layout, everything from this point should be prefetched using a single,\n+    // combined runtime request, rather than using per-segment static requests.\n+    // This is true even if some of the child segments are known to be fully\n+    // static — once we've decided to perform a runtime prefetch, we might as\n+    // well respond with the static segments in the same roundtrip. (That's how\n+    // regular navigations work, too.) We'll still skip over segments that are\n+    // already cached, though.\n+    //\n+    // It's the server's responsibility to set a reasonable value of\n+    // `hasRuntimePrefetch`. Currently it's user-defined, but eventually, the\n+    // server may send a value of `false` even if the user opts in, if it\n+    // determines during build that the route is always fully static. There are\n+    // more optimizations we can do once we implement fallback param\n+    // tracking, too.\n+    //\n+    // Use the task object to collect the segments that need a runtime prefetch.\n+    // This will signal to the outer task queue that a second traversal is\n+    // required to construct a request tree.\n+    if (task.spawnedRuntimePrefetches === null) {\n+      task.spawnedRuntimePrefetches = new Set([tree.cacheKey])\n+    } else {\n+      task.spawnedRuntimePrefetches.add(tree.cacheKey)\n+    }\n+    // Then exit the traversal without prefetching anything further.\n+    return PrefetchTaskExitStatus.Done\n+  }\n+\n+  // This segment should not be runtime prefetched. Prefetch its static data.\n+  const segment = readOrCreateSegmentCacheEntry(\n+    now,\n+    task.fetchStrategy,\n+    route,\n+    tree.cacheKey\n+  )\n+  pingStaticSegmentData(now, task, route, segment, task.key, tree)\n   if (tree.slots !== null) {\n     if (!hasNetworkBandwidth(task)) {\n       // Stop prefetching segments until there's more bandwidth.\n@@ -672,7 +846,12 @@ function pingPPRRouteTree(\n     // Recursively ping the children.\n     for (const parallelRouteKey in tree.slots) {\n       const childTree = tree.slots[parallelRouteKey]\n-      const childExitStatus = pingPPRRouteTree(now, task, route, childTree)\n+      const childExitStatus = pingNewPartOfCacheComponentsTree(\n+        now,\n+        task,\n+        route,\n+        childTree\n+      )\n       if (childExitStatus === PrefetchTaskExitStatus.InProgress) {\n         // Child yielded without finishing.\n         return PrefetchTaskExitStatus.InProgress\n@@ -852,7 +1031,12 @@ function pingPPRDisabledRouteTreeUpToLoadingBoundary(\n   let refetchMarker: 'refetch' | 'inside-shared-layout' | null =\n     refetchMarkerContext === null ? 'inside-shared-layout' : null\n \n-  const segment = readOrCreateSegmentCacheEntry(now, task, route, tree.cacheKey)\n+  const segment = readOrCreateSegmentCacheEntry(\n+    now,\n+    task.fetchStrategy,\n+    route,\n+    tree.cacheKey\n+  )\n   switch (segment.status) {\n     case EntryStatus.Empty: {\n       // This segment is not cached. Add a refetch marker so the server knows\n@@ -955,7 +1139,17 @@ function pingRouteTreeAndIncludeDynamicData(\n   // explicit \"refetch\" marker so the server knows where to start rendering.\n   // Once the server starts rendering along a path, it keeps rendering the\n   // entire subtree.\n-  const segment = readOrCreateSegmentCacheEntry(now, task, route, tree.cacheKey)\n+  const segment = readOrCreateSegmentCacheEntry(\n+    now,\n+    // Note that `fetchStrategy` might be different from `task.fetchStrategy`,\n+    // and we have to use the former here.\n+    // We can have a task with `FetchStrategy.PPR` where some of its segments are configured to\n+    // always use runtime prefetching (via `export const prefetch`), and those should check for\n+    // entries that include search params.\n+    fetchStrategy,\n+    route,\n+    tree.cacheKey\n+  )\n \n   let spawnedSegment: PendingSegmentCacheEntry | null = null\n \n@@ -981,7 +1175,6 @@ function pingRouteTreeAndIncludeDynamicData(\n         // In either case, we need to include it in the request to get a more specific (or full) version.\n         spawnedSegment = pingFullSegmentRevalidation(\n           now,\n-          task,\n           route,\n           segment,\n           tree,\n@@ -1002,7 +1195,6 @@ function pingRouteTreeAndIncludeDynamicData(\n       ) {\n         spawnedSegment = pingFullSegmentRevalidation(\n           now,\n-          task,\n           route,\n           segment,\n           tree,\n@@ -1050,7 +1242,59 @@ function pingRouteTreeAndIncludeDynamicData(\n   return requestTree\n }\n \n-function pingPerSegment(\n+function pingRuntimePrefetches(\n+  now: number,\n+  task: PrefetchTask,\n+  route: FulfilledRouteCacheEntry,\n+  tree: RouteTree,\n+  spawnedRuntimePrefetches: Set<SegmentCacheKey>,\n+  spawnedEntries: Map<string, PendingSegmentCacheEntry>\n+): FlightRouterState {\n+  // Construct a request tree (FlightRouterState) for a runtime prefetch. If\n+  // a segment is part of the runtime prefetch, the tree is constructed by\n+  // diffing against what's already in the prefetch cache. Otherwise, we send\n+  // a regular FlightRouterState with no special markers.\n+  //\n+  // See pingRouteTreeAndIncludeDynamicData for details.\n+  if (spawnedRuntimePrefetches.has(tree.cacheKey)) {\n+    // This segment needs a runtime prefetch.\n+    return pingRouteTreeAndIncludeDynamicData(\n+      now,\n+      task,\n+      route,\n+      tree,\n+      false,\n+      spawnedEntries,\n+      FetchStrategy.PPRRuntime\n+    )\n+  }\n+  let requestTreeChildren: Record<string, FlightRouterState> = {}\n+  const slots = tree.slots\n+  if (slots !== null) {\n+    for (const parallelRouteKey in slots) {\n+      const childTree = slots[parallelRouteKey]\n+      requestTreeChildren[parallelRouteKey] = pingRuntimePrefetches(\n+        now,\n+        task,\n+        route,\n+        childTree,\n+        spawnedRuntimePrefetches,\n+        spawnedEntries\n+      )\n+    }\n+  }\n+\n+  // This segment is not part of the runtime prefetch. Clone the base tree.\n+  const requestTree: FlightRouterState = [\n+    tree.segment,\n+    requestTreeChildren,\n+    null,\n+    null,\n+  ]\n+  return requestTree\n+}\n+\n+function pingStaticSegmentData(\n   now: number,\n   task: PrefetchTask,\n   route: FulfilledRouteCacheEntry,\n@@ -1159,7 +1403,7 @@ function pingPPRSegmentRevalidation(\n       // Spawn a prefetch request and upsert the segment into the cache\n       // upon completion.\n       upsertSegmentOnCompletion(\n-        task,\n+        task.fetchStrategy,\n         route,\n         tree.cacheKey,\n         spawnPrefetchSubtask(\n@@ -1188,7 +1432,6 @@ function pingPPRSegmentRevalidation(\n \n function pingFullSegmentRevalidation(\n   now: number,\n-  task: PrefetchTask,\n   route: FulfilledRouteCacheEntry,\n   currentSegment: SegmentCacheEntry,\n   tree: RouteTree,\n@@ -1209,7 +1452,7 @@ function pingFullSegmentRevalidation(\n       fetchStrategy\n     )\n     upsertSegmentOnCompletion(\n-      task,\n+      fetchStrategy,\n       route,\n       tree.cacheKey,\n       waitForSegmentCacheEntry(pendingSegment)\n@@ -1234,7 +1477,7 @@ function pingFullSegmentRevalidation(\n         fetchStrategy\n       )\n       upsertSegmentOnCompletion(\n-        task,\n+        fetchStrategy,\n         route,\n         tree.cacheKey,\n         waitForSegmentCacheEntry(pendingSegment)\n@@ -1261,7 +1504,7 @@ function pingFullSegmentRevalidation(\n const noop = () => {}\n \n function upsertSegmentOnCompletion(\n-  task: PrefetchTask,\n+  fetchStrategy: FetchStrategy,\n   route: FulfilledRouteCacheEntry,\n   cacheKey: SegmentCacheKey,\n   promise: Promise<FulfilledSegmentCacheEntry | null>\n@@ -1270,7 +1513,7 @@ function upsertSegmentOnCompletion(\n   promise.then((fulfilled) => {\n     if (fulfilled !== null) {\n       // Received new data. Attempt to replace the existing entry in the cache.\n-      const keypath = getSegmentKeypathForTask(task, route, cacheKey)\n+      const keypath = getSegmentKeypath(fetchStrategy, route, cacheKey)\n       upsertSegmentEntry(Date.now(), keypath, fulfilled)\n     }\n   }, noop)"
        },
        {
            "sha": "96b9ff494d7c027e3a9f44e4da78f389bc76523f",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -51,7 +51,7 @@ export type TreePrefetch = {\n   }\n \n   /** Whether this segment should be fetched using a runtime prefetch */\n-  shouldUseRuntimePrefetch: boolean\n+  hasRuntimePrefetch: boolean\n \n   // Extra fields that only exist so we can reconstruct a FlightRouterState on\n   // the client. We may be able to unify TreePrefetch and FlightRouterState\n@@ -281,7 +281,7 @@ function collectSegmentDataImpl(\n     slotMetadata[parallelRouteKey] = childTree\n   }\n \n-  const shouldUseRuntimePrefetch = seedData !== null ? seedData[5] : false\n+  const hasRuntimePrefetch = seedData !== null ? seedData[5] : false\n \n   if (seedData !== null) {\n     // Spawn a task to write the segment data to a new Flight stream.\n@@ -324,7 +324,7 @@ function collectSegmentDataImpl(\n     // case there's a bug and we need to revert.\n     // TODO: Remove once clientParamParsing is enabled everywhere.\n     paramKey: isClientParamParsingEnabled ? null : paramKey,\n-    shouldUseRuntimePrefetch,\n+    hasRuntimePrefetch,\n     slots: slotMetadata,\n     isRootLayout: route[4] === true,\n   }"
        },
        {
            "sha": "3ea89a6ed4149d67e37f1d1b31fe7794ec9f1db8",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -229,7 +229,7 @@ async function createComponentTreeInternal(\n     ? (layoutOrPageMod as AppSegmentConfig).unstable_prefetch\n     : undefined\n   /** Whether this segment should use a runtime prefetch instead of a static prefetch. */\n-  const shouldUseRuntimePrefetch = prefetchConfig === 'unstable_runtime'\n+  const hasRuntimePrefetch = prefetchConfig === 'unstable_runtime'\n \n   const [Forbidden, forbiddenStyles] =\n     authInterrupts && forbidden\n@@ -704,7 +704,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n-      shouldUseRuntimePrefetch,\n+      hasRuntimePrefetch,\n     ]\n   }\n \n@@ -737,7 +737,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       true,\n-      shouldUseRuntimePrefetch,\n+      hasRuntimePrefetch,\n     ]\n   }\n \n@@ -843,7 +843,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n-      shouldUseRuntimePrefetch,\n+      hasRuntimePrefetch,\n     ]\n   } else {\n     const SegmentComponent = Component\n@@ -1021,7 +1021,7 @@ async function createComponentTreeInternal(\n       parallelRouteCacheNodeSeedData,\n       loadingData,\n       isPossiblyPartialResponse,\n-      shouldUseRuntimePrefetch,\n+      hasRuntimePrefetch,\n     ]\n   }\n }"
        },
        {
            "sha": "049ae95de4b152ab196a4b2ea8ed541e56a00042",
            "filename": "packages/next/src/shared/lib/app-router-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -229,7 +229,7 @@ export type CacheNodeSeedData = [\n   loading: LoadingModuleData | Promise<LoadingModuleData>,\n   isPartial: boolean,\n   /** TODO: this doesn't feel like it belongs here, because it's only used during build, in `collectSegmentData` */\n-  shouldUseRuntimePrefetch: boolean,\n+  hasRuntimePrefetch: boolean,\n ]\n \n export type FlightDataSegment = ["
        },
        {
            "sha": "acff397e6c3bd416c8fbbe56a9c0e8211a224eec",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/page.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -53,6 +53,16 @@ export default async function Page() {\n           />\n         </li>\n       </ul>\n+\n+      <h2>shared layout prefetching - segment config</h2>\n+      <ul>\n+        <li>\n+          This link deliberately doesn't specify a `prefetch` prop, because the\n+          page has a segment-level prefetch config:\n+          <br />\n+          <DebugLinkAccordion href=\"/segment-config/runtime-prefetchable\" />\n+        </li>\n+      </ul>\n     </main>\n   )\n }"
        },
        {
            "sha": "492b9ed32347a508b4b6160c90fe8fc137882b6e",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/configured-as-runtime/layout.tsx",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Flayout.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,39 @@\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+import { DebugRenderKind } from '../../../shared'\n+\n+// No `export const unstable_prefetch = ...` is needed, we default to static\n+\n+export default async function SubLayout({ children }) {\n+  return (\n+    <main>\n+      <div>\n+        <h3>Sub-layout</h3>\n+        <DebugRenderKind />\n+        <p id=\"static-content-sub-layout\">\n+          This sub-layout uses cookies, but did not specify that it should be\n+          runtime prefetchable, so it should be prefetched statically by\n+          default.\n+        </p>\n+        <Suspense\n+          fallback={\n+            <div id=\"runtime-prefetchable-fallback-sub-layout\">Loading ...</div>\n+          }\n+        >\n+          <RuntimePrefetchable />\n+        </Suspense>\n+      </div>\n+      <hr />\n+      {children}\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return (\n+    <div id=\"runtime-prefetchable-content-sub-layout\">\n+      Runtime-prefetchable content from sub-layout\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "45b356f32b1431e26ff52325dee2a59491b47da2",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/configured-as-runtime/page.tsx",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-runtime%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,37 @@\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1 style={{ color: 'green' }}>\n+        A runtime-prefetchable child of a runtime-prefetchable layout\n+      </h1>\n+      <p id=\"static-content-page\">\n+        This page has two relevant parent layouts:\n+        <br />\n+        1. A runtime-prefetchable shared layout layout.\n+        <br />\n+        2. A statically-prefetchable sub-layout not shared with other pages.\n+        <br />\n+        <br />\n+        We should use a runtime prefetch for it without any overrides on Link,\n+        but its sub-layout should be prefetched statically.\n+      </p>\n+      <Suspense fallback=\"Loading...\">\n+        <RuntimePrefetchable />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return (\n+    <div id=\"runtime-prefetchable-content-page\">\n+      Runtime-prefetchable content from page\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "a18f062ff3cdc15c350c9615b7bceff509a57cb3",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/configured-as-static/page.tsx",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fconfigured-as-static%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,40 @@\n+import { cookies } from 'next/headers'\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+// Technically, no `export const unstable_prefetch = ...` is needed, because we default to static,\n+// this is just to make sure that we excercise the codepaths for it\n+export const unstable_prefetch = 'unstable_static'\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1 style={{ color: 'green' }}>Statically prefetchable</h1>\n+      <p id=\"static-content-page\">\n+        This page is a child of a runtime-prefetchable layout that is not\n+        configured as runtime-prefetchable. We should not use a runtime prefetch\n+        for it.\n+      </p>\n+      <Suspense fallback=\"Loading...\">\n+        <RuntimePrefetchable />\n+      </Suspense>\n+      <Suspense fallback=\"Loading...\">\n+        <DynamicContent />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return (\n+    <div id=\"runtime-prefetchable-content-page\">\n+      Runtime-prefetchable content from page\n+    </div>\n+  )\n+}\n+\n+async function DynamicContent() {\n+  await connection()\n+  return <div id=\"dynamic-content-page\">Dynamic Content from page</div>\n+}"
        },
        {
            "sha": "0e1371b4ca04a27f53574b3ec7321bd0c1a0076e",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/fully-static/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Ffully-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Ffully-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Ffully-static%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,13 @@\n+// No `export const unstable_prefetch = ...` is needed, we default to static\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1 style={{ color: 'green' }}>Fully statically prefetchable</h1>\n+      <p id=\"static-content-page\">\n+        This page is a statically-prefetchable child of a runtime-prefetchable\n+        layout. We should not use a runtime prefetch for it.\n+      </p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "3b56e9d027f200f5343cd2d40b7b4b128163ee27",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/layout.tsx",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Flayout.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,34 @@\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+import { DebugRenderKind } from '../../shared'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n+\n+export default async function Layout({ children }) {\n+  return (\n+    <main>\n+      <div>\n+        <h2>Shared layout</h2>\n+        <DebugRenderKind />\n+        <p id=\"static-content-layout\">\n+          This shared layout uses cookies and no uncached IO, so it should be\n+          completely runtime-prefetchable.\n+        </p>\n+        <Suspense fallback=\"Loading ...\">\n+          <RuntimePrefetchable />\n+        </Suspense>\n+      </div>\n+      <hr />\n+      {children}\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return (\n+    <div id=\"runtime-prefetchable-content-layout\">\n+      Runtime-prefetchable content from shared layout\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "40608d803c73c2c137ff2b468fc019dfdcb928bb",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/app/segment-config/runtime-prefetchable/page.tsx",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fapp%2Fsegment-config%2Fruntime-prefetchable%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -0,0 +1,57 @@\n+import { cookies } from 'next/headers'\n+import { DebugLinkAccordion } from '../../../components/link-accordion'\n+import { Suspense } from 'react'\n+\n+// No `export const unstable_prefetch = ...` is needed, we default to static\n+// (but see page description for more on the actual behavior)\n+\n+export default function Page() {\n+  return (\n+    <main>\n+      <h1>Child of a runtime prefetchable layout</h1>\n+\n+      <div>\n+        <p>\n+          When this page is prefetched from outside of the{' '}\n+          <code>/segment-config/runtime-prefetchable</code> segment, the page\n+          contents will be runtime-prefetched (despite this segment not being\n+          marked as runtime-prefetchable) because the parent layout is marked as\n+          runtime-prefetchable.\n+        </p>\n+        <Suspense fallback=\"Loading...\">\n+          <RuntimePrefetchable />\n+        </Suspense>\n+      </div>\n+\n+      <ul>\n+        <li>\n+          A page that shares some layouts with this page, and should use a\n+          static prefetch:\n+          <br />\n+          <DebugLinkAccordion href=\"/segment-config/runtime-prefetchable/configured-as-static\" />\n+        </li>\n+        <li>\n+          A page that shares some layouts with this page, and should use a\n+          runtime prefetch:\n+          <br />\n+          <DebugLinkAccordion href=\"/segment-config/runtime-prefetchable/configured-as-runtime\" />\n+        </li>\n+        <li>\n+          A page that shares some layouts with this page, and has a fully static\n+          page segment\n+          <br />\n+          <DebugLinkAccordion href=\"/segment-config/runtime-prefetchable/fully-static\" />\n+        </li>\n+      </ul>\n+    </main>\n+  )\n+}\n+\n+async function RuntimePrefetchable() {\n+  await cookies()\n+  return (\n+    <div id=\"runtime-prefetchable-content-page\">\n+      Runtime-prefetchable content from page\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f1caa014052b32f6d4238f530131be6533fec24d",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-layout-sharing/prefetch-layout-sharing.test.ts",
            "status": "modified",
            "additions": 208,
            "deletions": 1,
            "changes": 209,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fprefetch-layout-sharing.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fprefetch-layout-sharing.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-layout-sharing%2Fprefetch-layout-sharing.test.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { Playwright as NextBrowser } from '../../../../lib/next-webdriver'\n import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n@@ -534,7 +535,15 @@ describe('layout sharing in non-static prefetches', () => {\n         `input[data-prefetch=\"auto\"][data-link-accordion=\"/runtime-prefetchable-layout/two\"]`\n       )\n       await linkToggle.click()\n-    })\n+    }, [\n+      // Should not fetch the shared layout, because that was already prefetched\n+      {\n+        includes: 'Shared layout',\n+        block: 'reject',\n+      },\n+      // Should fetch the static part of page two\n+      { includes: 'Page two' },\n+    ])\n \n     // Navigate to page two. We need to request the page segment dynamically, but the shared layout should be cached.\n     await act(async () => {\n@@ -566,6 +575,204 @@ describe('layout sharing in non-static prefetches', () => {\n       'Dynamic content from page two'\n     )\n   })\n+\n+  describe('segment-level prefetch config', () => {\n+    const clientNavigateToSegmentConfigPage = async (\n+      browser: NextBrowser,\n+      act: ReturnType<typeof createRouterAct>\n+    ) => {\n+      // Reveal the link to trigger a (automatic) runtime prefetch for the segment-config entrypoint page\n+      await act(async () => {\n+        const linkToggle = await browser.elementByCss(\n+          `input[data-link-accordion=\"/segment-config/runtime-prefetchable\"]`\n+        )\n+        await linkToggle.click()\n+      }, [\n+        {\n+          includes: 'runtime-prefetchable-content-layout',\n+        },\n+      ])\n+\n+      // Navigate to the segment-config entrypoint page.\n+      // The layout is configured as runtime prefetchable, but the page is not.\n+      // Both contain runtime-prefetchable content,\n+      // but nothing dynamic, so we shouldn't need any extra requests.\n+      //\n+      // Note that the page itself doesn't specify that it should use a runtime prefetch,\n+      // but we'll currently automatically include it in the runtime prefetch request\n+      // that we're doing because of the layout's config.\n+      await act(async () => {\n+        await browser\n+          .elementByCss(`a[href=\"/segment-config/runtime-prefetchable\"]`)\n+          .click()\n+      }, 'no-requests')\n+    }\n+\n+    it('does not unnecessarily use a runtime prefetch for sub-pages of runtime-prefetchable layouts', async () => {\n+      let page: Playwright.Page\n+      const browser = await next.browser('/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          page = p\n+        },\n+      })\n+\n+      const act = createRouterAct(page)\n+\n+      // First, we move from the starting page to another page that has a runtime-prefetchable layout.\n+      await clientNavigateToSegmentConfigPage(browser, act)\n+\n+      // Now we're on a page that uses the runtime-prefetchable layout,\n+      // sub-pages of the same layout that are configured as static shouldn't automatically issue a runtime prefetch.\n+      await act(async () => {\n+        await browser\n+          .elementByCss(\n+            `input[data-link-accordion=\"/segment-config/runtime-prefetchable/configured-as-static\"]`\n+          )\n+          .click()\n+      }, [\n+        // We should not prefetch anything from the parent layout again.\n+        { includes: 'static-content-layout', block: 'reject' },\n+        { includes: 'runtime-prefetchable-content-layout', block: 'reject' },\n+\n+        // We should prefetch the static content for the page, but nothing more.\n+        { includes: 'static-content-page' },\n+        { includes: 'dynamic-content-page', block: 'reject' },\n+        { includes: 'runtime-prefetchable-content-page', block: 'reject' },\n+      ])\n+    })\n+\n+    it('statically prefetches a fully-static page segment if all its runtime-prefetchable parents are available', async () => {\n+      let page: Playwright.Page\n+      const browser = await next.browser('/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          page = p\n+        },\n+      })\n+\n+      const act = createRouterAct(page)\n+\n+      // First, we move from the starting page to another page that has a runtime-prefetchable layout.\n+      await clientNavigateToSegmentConfigPage(browser, act)\n+\n+      // Now we're on a page that uses the runtime-prefetchable layout,\n+      // sub-pages of the same layout that are configured as static shouldn't automatically issue a runtime prefetch.\n+      await act(async () => {\n+        await browser\n+          .elementByCss(\n+            `input[data-link-accordion=\"/segment-config/runtime-prefetchable/fully-static\"]`\n+          )\n+          .click()\n+      }, [\n+        // We should not prefetch anything from the parent layout again.\n+        { includes: 'static-content-layout', block: 'reject' },\n+        { includes: 'runtime-prefetchable-content-layout', block: 'reject' },\n+\n+        // We should prefetch the static content for the page, but nothing more.\n+        { includes: 'static-content-page' },\n+      ])\n+\n+      // The page segment is fully static, so we shouldn't need any extra requests to navigate to it.\n+      await act(async () => {\n+        await browser\n+          .elementByCss(\n+            `a[href=\"/segment-config/runtime-prefetchable/fully-static\"]`\n+          )\n+          .click()\n+      }, 'no-requests')\n+\n+      expect(\n+        await (await browser.elementById('static-content-page')).isVisible()\n+      ).toBeTrue()\n+    })\n+\n+    it('uses a runtime prefetch for sub-pages of runtime-prefetchable layouts if requested', async () => {\n+      let page: Playwright.Page\n+      const browser = await next.browser('/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          page = p\n+        },\n+      })\n+\n+      const act = createRouterAct(page)\n+\n+      // First, we move from the starting page to another page that has a runtime-prefetchable layout.\n+      await clientNavigateToSegmentConfigPage(browser, act)\n+\n+      // Sub-pages of this layout that are configured as runtime-prefetchable should be prefetched as such.\n+      // However, if the page also has a sub-layout (not shared with the current page)\n+      // that is configured as static, that part shouldn't be runtime-prefetched.\n+      //\n+      // Note that this is a sub-optimal configuration -- in a real app, we'd likely want the sub-layout\n+      // to be runtime-prefetched as well, because it contains some runtime-prefetchable content.\n+      // However, this is deliberately set up this way to assert that we don't do a runtime prefetch unless requested.\n+      await act(async () => {\n+        await browser\n+          .elementByCss(\n+            `input[data-link-accordion=\"/segment-config/runtime-prefetchable/configured-as-runtime\"]`\n+          )\n+          .click()\n+      }, [\n+        // We should not prefetch anything from the parent layout again.\n+        { includes: 'static-content-layout', block: 'reject' },\n+        { includes: 'runtime-prefetchable-content-layout', block: 'reject' },\n+\n+        {\n+          // We should *not* prefetch the runtime parts of the sub-layout,\n+          // because it's not configured as runtime-prefetchable.\n+          includes: 'runtime-prefetchable-content-sub-layout',\n+          block: 'reject',\n+        },\n+\n+        // ...but we should prefetch the runtime parts of the page.\n+        { includes: 'runtime-prefetchable-content-page' },\n+        { includes: 'dynamic-content-page', block: 'reject' },\n+      ])\n+\n+      // Navigate to the runtime-prefetchable sub-page.\n+      await act(async () => {\n+        // We should be able to display what we've prefetched before the navigation request resolves.\n+        await act(async () => {\n+          await browser\n+            .elementByCss(\n+              `a[href=\"/segment-config/runtime-prefetchable/configured-as-runtime\"]`\n+            )\n+            .click()\n+        }, 'block')\n+\n+        // The sub-layout should show static content, but not runtime-prefetchable content.\n+        expect(\n+          await (\n+            await browser.elementById('static-content-sub-layout')\n+          ).isVisible()\n+        ).toBeTrue()\n+        expect(\n+          await (\n+            await browser.elementById(\n+              'runtime-prefetchable-fallback-sub-layout'\n+            )\n+          ).isVisible()\n+        ).toBeTrue()\n+\n+        // The sub-page should show static/runtime-prefetchable content.\n+        expect(\n+          await (await browser.elementById('static-content-page')).isVisible()\n+        ).toBeTrue()\n+        expect(\n+          await (\n+            await browser.elementById('runtime-prefetchable-content-page')\n+          ).isVisible()\n+        ).toBeTrue()\n+      })\n+\n+      // After the navigation, we should see the content that wasn't prefetched.\n+      // (because the sub-layout was configured as static)\n+      expect(\n+        await (\n+          await browser.elementById('runtime-prefetchable-content-sub-layout')\n+        ).isVisible()\n+      ).toBeTrue()\n+    })\n+  })\n })\n \n function defer(callback: () => Promise<void>) {"
        },
        {
            "sha": "85537afa9000e6e3b0a6db2e94b1a3615252b6ad",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/fully-static/page.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ffully-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ffully-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Ffully-static%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -1,3 +1,10 @@\n+// This is technically unnecessary, because this page is static\n+// and a runtime prefetch won't do any better than a static one,\n+// but it's useful to exercise this codepath.\n+// In the future, this test can be used to check whether we correctly\n+// *skip* a runtime prefetch if a page was prerendered as static.\n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "93d9a5cf41b608003c4f7372de5cc75a628d91a8",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-page/cookies-only/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies-only%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies-only%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies-only%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { cookies } from 'next/headers'\n import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind } from '../../../shared'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "14d66f0f8e88e01ae76d90bff0279037bd922555",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-page/cookies/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fcookies%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "d283331965ce258b6e59c9404e98c2c411bb5116",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-page/dynamic-params/[id]/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type Params = { id: string }\n \n export default async function Page({ params }: { params: Promise<Params> }) {"
        },
        {
            "sha": "c8e8e89f6b9bf805e8ccc865d716ce49a0a78500",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-page/search-params/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fsearch-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fsearch-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-page%2Fsearch-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type AnySearchParams = { [key: string]: string | string[] | undefined }\n \n export default async function Page({"
        },
        {
            "sha": "fa8a30120cc561c253792d25fa59135c0c32039b",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/cookies-only/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies-only%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies-only%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies-only%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { cookies } from 'next/headers'\n import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind } from '../../../shared'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "20d16f5d799271ab504ec6ebcbb642ed43b81dfe",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/cookies/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fcookies%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "f39a213c6e9037303d76f83a588fd7bbdc883111",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/date-now/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdate-now%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdate-now%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdate-now%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "f863691afa0dfc9aef1c13533dc7e9f21b298cf5",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/dynamic-params/[id]/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type Params = { id: string }\n \n export default async function Page({ params }: { params: Promise<Params> }) {"
        },
        {
            "sha": "fbfc68ffbabedb928d424b94519cda48185a03ba",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/in-private-cache/search-params/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fsearch-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fsearch-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fin-private-cache%2Fsearch-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type AnySearchParams = { [key: string]: string | string[] | undefined }\n \n export default async function Page({"
        },
        {
            "sha": "42e0687fddcd52c0e5f64430b8f3cf00123742a9",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/page.tsx",
            "status": "modified",
            "additions": 20,
            "deletions": 74,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -11,7 +11,7 @@ export default async function Page() {\n           cookies + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion href=\"/in-page/cookies\" prefetch={true} />\n+              <DebugLinkAccordion href=\"/in-page/cookies\" />\n             </li>\n           </ul>\n         </li>\n@@ -20,44 +20,29 @@ export default async function Page() {\n           search params + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-page/search-params?searchParam=123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-page/search-params?searchParam=123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-page/search-params?searchParam=456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-page/search-params?searchParam=456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           dynamic params + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-page/dynamic-params/123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-page/dynamic-params/123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-page/dynamic-params/456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-page/dynamic-params/456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           only cookies\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-page/cookies-only\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-page/cookies-only\" />\n             </li>\n           </ul>\n         </li>\n@@ -71,66 +56,45 @@ export default async function Page() {\n           cookies in private cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/cookies\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/cookies\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           dynamic params in private cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/dynamic-params/123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/dynamic-params/123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/dynamic-params/456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/dynamic-params/456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           search params in private cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/search-params?searchParam=123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/search-params?searchParam=123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/search-params?searchParam=456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/search-params?searchParam=456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           only cookies in private cache\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/cookies-only\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/cookies-only\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           Date.now() in private cache\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/in-private-cache/date-now\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/in-private-cache/date-now\" />\n             </li>\n           </ul>\n         </li>\n@@ -144,55 +108,37 @@ export default async function Page() {\n           cookies() promise passed to public cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/cookies\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/cookies\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           dynamic params promise passed to public cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/dynamic-params/123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/dynamic-params/123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/dynamic-params/456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/dynamic-params/456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           search params promise passed to public cache + dynamic content\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/search-params?searchParam=123\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/search-params?searchParam=123\" />\n             </li>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/search-params?searchParam=456\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/search-params?searchParam=456\" />\n             </li>\n           </ul>\n         </li>\n         <li>\n           only cookies passed to public cache (no dynamic content)\n           <ul>\n             <li>\n-              <DebugLinkAccordion\n-                href=\"/passed-to-public-cache/cookies-only\"\n-                prefetch={true}\n-              />\n+              <DebugLinkAccordion href=\"/passed-to-public-cache/cookies-only\" />\n             </li>\n           </ul>\n         </li>\n@@ -290,7 +236,7 @@ export default async function Page() {\n       <h2>misc</h2>\n       <ul>\n         <li>\n-          <DebugLinkAccordion href=\"/fully-static\" prefetch={true} />\n+          <DebugLinkAccordion href=\"/fully-static\" />\n         </li>\n       </ul>\n     </main>"
        },
        {
            "sha": "78d7bc3098b40c42b6b4d0f0565d1730d78fdca3",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/passed-to-public-cache/cookies-only/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies-only%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies-only%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies-only%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,8 @@ import { cookies } from 'next/headers'\n import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind } from '../../../shared'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "d1ca6267ead957f47ffb874f9d9a7adfe1ca929f",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/passed-to-public-cache/cookies/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fcookies%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind } from '../../../shared'\n import { connection } from 'next/server'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>"
        },
        {
            "sha": "037358e55235dfa05db92c4c6df0480968fea9ff",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/passed-to-public-cache/dynamic-params/[id]/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fdynamic-params%2F%5Bid%5D%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { cachedDelay, DebugRenderKind } from '../../../../shared'\n import { connection } from 'next/server'\n import { cookies } from 'next/headers'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type Params = { id: string }\n \n export default async function Page({ params }: { params: Promise<Params> }) {"
        },
        {
            "sha": "e02ad8e436442dec95b0ab651ed2b8fe49992fb5",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/passed-to-public-cache/search-params/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fsearch-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fsearch-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpassed-to-public-cache%2Fsearch-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { cachedDelay, DebugRenderKind } from '../../../shared'\n import { connection } from 'next/server'\n import { cookies } from 'next/headers'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n type AnySearchParams = { [key: string]: string | string[] | undefined }\n \n export default async function Page({"
        },
        {
            "sha": "65d8000a000b7ed29f62346147b5b6003e532d0e",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/with-root-param/[lang]/in-page/root-params/page.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-page%2Froot-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-page%2Froot-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-page%2Froot-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,6 +2,9 @@ import { Suspense } from 'react'\n import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../../shared'\n import { connection } from 'next/server'\n import { lang } from 'next/root-params'\n+import { cookies } from 'next/headers'\n+\n+export const unstable_prefetch = 'unstable_runtime'\n \n export default async function Page() {\n   return (\n@@ -12,12 +15,16 @@ export default async function Page() {\n         always be available in static prerenders, so a runtime prefetch should\n         have them too.\n       </p>\n-      <StaticallyPrefetchable />\n+      <Suspense fallback=\"Loading 1...\">\n+        <RuntimePrefetchable />\n+      </Suspense>\n     </main>\n   )\n }\n \n-async function StaticallyPrefetchable() {\n+async function RuntimePrefetchable() {\n+  await cookies()\n+\n   const currentLang = await lang()\n   await cachedDelay([__filename, currentLang])\n   return ("
        },
        {
            "sha": "e7cac76ed2b0d0824ba621eef88e1d6e8d29447a",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/with-root-param/[lang]/in-private-cache/root-params/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-private-cache%2Froot-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-private-cache%2Froot-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fin-private-cache%2Froot-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../../shared'\n import { connection } from 'next/server'\n import { lang } from 'next/root-params'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>\n@@ -14,13 +16,13 @@ export default async function Page() {\n         they should be part of a runtime prefetch.\n       </p>\n       <Suspense fallback=\"Loading 1...\">\n-        <DynamicallyPrefetchable />\n+        <RuntimePrefetchable />\n       </Suspense>\n     </main>\n   )\n }\n \n-async function DynamicallyPrefetchable() {\n+async function RuntimePrefetchable() {\n   const currentLang = await privateCache()\n   return (\n     <div style={{ border: '1px solid blue', padding: '1em' }}>"
        },
        {
            "sha": "7191d4704064cd9b1f20f3e83e93f17b610f106c",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/with-root-param/[lang]/page.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -16,13 +16,11 @@ export default async function Page() {\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${currentLang}/in-page/root-params`}\n-                prefetch={true}\n               />\n             </li>\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${otherLang}/in-page/root-params`}\n-                prefetch={true}\n               />\n             </li>\n           </ul>\n@@ -39,13 +37,11 @@ export default async function Page() {\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${currentLang}/in-private-cache/root-params`}\n-                prefetch={true}\n               />\n             </li>\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${otherLang}/in-private-cache/root-params`}\n-                prefetch={true}\n               />\n             </li>\n           </ul>\n@@ -62,13 +58,11 @@ export default async function Page() {\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${currentLang}/passed-to-public-cache/root-params`}\n-                prefetch={true}\n               />\n             </li>\n             <li>\n               <DebugLinkAccordion\n                 href={`/with-root-param/${otherLang}/passed-to-public-cache/root-params`}\n-                prefetch={true}\n               />\n             </li>\n           </ul>"
        },
        {
            "sha": "7016764f234fa41b8ff0835ae3668298bd521d4f",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/with-root-param/[lang]/passed-to-public-cache/root-params/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpassed-to-public-cache%2Froot-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpassed-to-public-cache%2Froot-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2Fwith-root-param%2F%5Blang%5D%2Fpassed-to-public-cache%2Froot-params%2Fpage.tsx?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -3,6 +3,8 @@ import { cachedDelay, DebugRenderKind, uncachedIO } from '../../../../shared'\n import { connection } from 'next/server'\n import { lang } from 'next/root-params'\n \n+export const unstable_prefetch = 'unstable_runtime'\n+\n export default async function Page() {\n   return (\n     <main>\n@@ -14,13 +16,13 @@ export default async function Page() {\n         a hanging input.\n       </p>\n       <Suspense fallback=\"Loading 1...\">\n-        <DynamicallyPrefetchable />\n+        <RuntimePrefetchable />\n       </Suspense>\n     </main>\n   )\n }\n \n-async function DynamicallyPrefetchable() {\n+async function RuntimePrefetchable() {\n   const currentLang = await publicCache(lang())\n   return (\n     <div style={{ border: '1px solid blue', padding: '1em' }}>"
        },
        {
            "sha": "2444ad1b1752af89c658d6d83615d4ed5cdaee25",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/prefetch-runtime.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cd05eaef3015ebaad1a715e1ce43025939bfecf/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts?ref=9cd05eaef3015ebaad1a715e1ce43025939bfecf",
            "patch": "@@ -2,7 +2,7 @@ import { nextTestSetup } from 'e2e-utils'\n import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n-describe('<Link prefetch={true}> (runtime prefetch)', () => {\n+describe('runtime prefetching', () => {\n   const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n   })"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Flayout.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,11 +0,0 @@\n-export default function RootLayout({\n-  children,\n-}: {\n-  children: React.ReactNode\n-}) {\n-  return (\n-    <html lang=\"en\">\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "32c5c5a37dfce6701efdd52fe35def7281169cf9",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/nested-prefetch-static/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Flayout.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,5 +0,0 @@\n-export const unstable_prefetch = 'unstable_runtime'\n-\n-export default function Layout({ children }: { children: React.ReactNode }) {\n-  return <>{children}</>\n-}"
        },
        {
            "sha": "0a744c27a0f1a86069ef9f5f120df94efc432e1a",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/nested-prefetch-static/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fnested-prefetch-static%2Fpage.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,20 +0,0 @@\n-import { connection } from 'next/server'\n-import { Suspense } from 'react'\n-\n-export const unstable_prefetch = 'unstable_static'\n-\n-export default function Page() {\n-  return (\n-    <main>\n-      <h1>A page that should use a static prefetch</h1>\n-      <Suspense fallback=\"Loading...\">\n-        <Dynamic />\n-      </Suspense>\n-    </main>\n-  )\n-}\n-\n-async function Dynamic() {\n-  await connection()\n-  return <div>Dynamic content</div>\n-}"
        },
        {
            "sha": "38366e2930fd8af54e3d05ae9f76d1fe6c67ce64",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/no-prefetch/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fno-prefetch%2Fpage.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,21 +0,0 @@\n-import { connection } from 'next/server'\n-import { Suspense } from 'react'\n-\n-// No exported prefetch value.\n-// export const unstable_prefetch = ...\n-\n-export default function Page() {\n-  return (\n-    <main>\n-      <h1>A page that should use a static prefetch</h1>\n-      <Suspense fallback=\"Loading...\">\n-        <Dynamic />\n-      </Suspense>\n-    </main>\n-  )\n-}\n-\n-async function Dynamic() {\n-  await connection()\n-  return <div>Dynamic content</div>\n-}"
        },
        {
            "sha": "4302e4f9d2432e6218510003f4cb26f0a27194cb",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fpage.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,28 +0,0 @@\n-import { LinkAccordion } from '../components/link-accordion'\n-\n-export default function Page() {\n-  return (\n-    <main>\n-      <ul>\n-        <li>\n-          <LinkAccordion href=\"/prefetch-static\">\n-            /prefetch-static\n-          </LinkAccordion>\n-        </li>\n-        <li>\n-          <LinkAccordion href=\"/prefetch-runtime\">\n-            /prefetch-runtime\n-          </LinkAccordion>\n-        </li>\n-        <li>\n-          <LinkAccordion href=\"/nested-prefetch-static\">\n-            /nested-prefetch-static\n-          </LinkAccordion>\n-        </li>\n-        <li>\n-          <LinkAccordion href=\"/no-prefetch\">/no-prefetch</LinkAccordion>\n-        </li>\n-      </ul>\n-    </main>\n-  )\n-}"
        },
        {
            "sha": "abcecba06de8d333b806e397ddeec78cc5f2e978",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/prefetch-runtime/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-runtime%2Fpage.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,20 +0,0 @@\n-import { cookies } from 'next/headers'\n-import { Suspense } from 'react'\n-\n-export const unstable_prefetch = 'unstable_runtime'\n-\n-export default function Page() {\n-  return (\n-    <main>\n-      <h1>A page that should use a runtime prefetch</h1>\n-      <Suspense fallback=\"Loading...\">\n-        <RuntimePrefetchable />\n-      </Suspense>\n-    </main>\n-  )\n-}\n-\n-async function RuntimePrefetchable() {\n-  await cookies()\n-  return <div>Runtime-prefetchable content</div>\n-}"
        },
        {
            "sha": "0a744c27a0f1a86069ef9f5f120df94efc432e1a",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/app/prefetch-static/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fapp%2Fprefetch-static%2Fpage.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,20 +0,0 @@\n-import { connection } from 'next/server'\n-import { Suspense } from 'react'\n-\n-export const unstable_prefetch = 'unstable_static'\n-\n-export default function Page() {\n-  return (\n-    <main>\n-      <h1>A page that should use a static prefetch</h1>\n-      <Suspense fallback=\"Loading...\">\n-        <Dynamic />\n-      </Suspense>\n-    </main>\n-  )\n-}\n-\n-async function Dynamic() {\n-  await connection()\n-  return <div>Dynamic content</div>\n-}"
        },
        {
            "sha": "72dafb3b9d970cedb56ec2b4908c7e9bddd46880",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/components/link-accordion.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fcomponents%2Flink-accordion.tsx?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,33 +0,0 @@\n-'use client'\n-\n-import Link, { type LinkProps } from 'next/link'\n-import { useState } from 'react'\n-\n-export function LinkAccordion({\n-  href,\n-  children,\n-  prefetch,\n-}: {\n-  href: string\n-  children: React.ReactNode\n-  prefetch?: LinkProps['prefetch']\n-}) {\n-  const [isVisible, setIsVisible] = useState(false)\n-  return (\n-    <>\n-      <input\n-        type=\"checkbox\"\n-        checked={isVisible}\n-        onChange={() => setIsVisible(!isVisible)}\n-        data-link-accordion={href}\n-      />\n-      {isVisible ? (\n-        <Link prefetch={prefetch} href={href}>\n-          {children}\n-        </Link>\n-      ) : (\n-        <>{children} (link is hidden)</>\n-      )}\n-    </>\n-  )\n-}"
        },
        {
            "sha": "d085500708ef73d37492e6fd6b10659d556edfc1",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/next.config.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fnext.config.ts?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,13 +0,0 @@\n-import { NextConfig } from 'next'\n-\n-const nextConfig: NextConfig = {\n-  experimental: {\n-    cacheComponents: true,\n-    clientSegmentCache: true,\n-    // This is automatically enabled when running with `__NEXT_EXPERIMENTAL_PPR`,\n-    // which lets us exercise both modes.\n-    // clientParamParsing: true,\n-  },\n-}\n-\n-export default nextConfig"
        },
        {
            "sha": "a4ac898433dc324a919b4170b4fa7e66c13e2a48",
            "filename": "test/e2e/app-dir/segment-cache/segment-prefetch-config/segment-prefetch-config.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 190,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d3bc037192b27e99734e524316701df9de38a1a4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsegment-prefetch-config%2Fsegment-prefetch-config.test.ts?ref=d3bc037192b27e99734e524316701df9de38a1a4",
            "patch": "@@ -1,190 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import {\n-  createRequestTracker,\n-  RequestTracker,\n-} from '../../../../lib/e2e-utils/request-tracker'\n-import {\n-  RootTreePrefetch,\n-  TreePrefetch,\n-} from 'next/dist/server/app-render/collect-segment-data'\n-\n-describe('export const unstable_prefetch = ...', () => {\n-  const { next, isNextDev } = nextTestSetup({\n-    files: __dirname,\n-  })\n-  if (isNextDev) {\n-    it('disabled in development', () => {})\n-    return\n-  }\n-\n-  // TODO: these tests aren't very good, but since the client-side part isn't implmented yet,\n-  // asserting on what the tree prefetch response contains is the best we can do.\n-  // They should be replaced with `act()` tests when the client-side changes are made.\n-\n-  async function captureTreePrefetchResponse(\n-    requestTracker: RequestTracker,\n-    action: () => Promise<void>\n-  ): Promise<string> {\n-    const [, response] = await requestTracker.captureResponse(action, {\n-      async request(req) {\n-        const headers = req.headers()\n-        return headers['next-router-segment-prefetch'] === '/_tree'\n-      },\n-    })\n-    return response.text()\n-  }\n-\n-  /** Hackily parse the first row of the RSC response. */\n-  function parseRouteTreeFromTreePrefetchResponse(response: string) {\n-    // Get row 0, the root object.\n-    const rowMatch = response.match(/(?:^|\\n)0:(.*?)\\n/)\n-    if (!rowMatch) {\n-      throw new Error('Failed to find row 0 in route tree flight data')\n-    }\n-    // `tree` is essentially plain JSON, so it's fine to not do full RSC parsing.\n-    const data = JSON.parse(rowMatch[1]) as RootTreePrefetch\n-    return data.tree\n-  }\n-\n-  it('does not mark for segments with prefetch: \"static\" as runtime-prefetchable', async () => {\n-    const browser = await next.browser('/')\n-    const requestTracker = createRequestTracker(browser)\n-\n-    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n-    const response = await captureTreePrefetchResponse(\n-      requestTracker,\n-      async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/prefetch-static\"]`\n-        )\n-        await linkToggle.click()\n-      }\n-    )\n-\n-    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n-      expect.objectContaining({\n-        name: '',\n-        shouldUseRuntimePrefetch: false,\n-        slots: {\n-          children: expect.objectContaining({\n-            name: 'prefetch-static',\n-            shouldUseRuntimePrefetch: false,\n-            slots: {\n-              children: expect.objectContaining({\n-                name: '__PAGE__',\n-                shouldUseRuntimePrefetch: false, // <-----------------\n-              }),\n-            },\n-          }),\n-        },\n-      })\n-    )\n-  })\n-\n-  it('marks segments with prefetch: \"runtime\" as runtime-prefetchable', async () => {\n-    const browser = await next.browser('/')\n-    const requestTracker = createRequestTracker(browser)\n-\n-    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n-    const response = await captureTreePrefetchResponse(\n-      requestTracker,\n-      async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/prefetch-runtime\"]`\n-        )\n-        await linkToggle.click()\n-      }\n-    )\n-\n-    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n-      expect.objectContaining({\n-        name: '',\n-        shouldUseRuntimePrefetch: false,\n-        slots: {\n-          children: expect.objectContaining({\n-            name: 'prefetch-runtime',\n-            shouldUseRuntimePrefetch: false,\n-            slots: {\n-              children: expect.objectContaining({\n-                name: '__PAGE__',\n-                shouldUseRuntimePrefetch: true, // <-----------------\n-                slots: null,\n-              }),\n-            },\n-          }),\n-        },\n-      })\n-    )\n-  })\n-\n-  it('defaults segments to static if no config is specified', async () => {\n-    const browser = await next.browser('/')\n-    const requestTracker = createRequestTracker(browser)\n-\n-    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n-    const response = await captureTreePrefetchResponse(\n-      requestTracker,\n-      async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/no-prefetch\"]`\n-        )\n-        await linkToggle.click()\n-      }\n-    )\n-\n-    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n-      expect.objectContaining({\n-        name: '',\n-        shouldUseRuntimePrefetch: false,\n-        slots: {\n-          children: expect.objectContaining({\n-            name: 'no-prefetch',\n-            shouldUseRuntimePrefetch: false,\n-            slots: {\n-              children: expect.objectContaining({\n-                name: '__PAGE__',\n-                shouldUseRuntimePrefetch: false, // <-----------------\n-                slots: null,\n-              }),\n-            },\n-          }),\n-        },\n-      }) satisfies TreePrefetch\n-    )\n-  })\n-  it('does not mark a \"static\" segment that is a child of a \"runtime\" segment as runtime-prefetchable', async () => {\n-    const browser = await next.browser('/')\n-    const requestTracker = createRequestTracker(browser)\n-\n-    // Reveal the link to trigger a runtime prefetch for one value of the dynamic param\n-    const response = await captureTreePrefetchResponse(\n-      requestTracker,\n-      async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/nested-prefetch-static\"]`\n-        )\n-        await linkToggle.click()\n-      }\n-    )\n-\n-    expect(parseRouteTreeFromTreePrefetchResponse(response)).toEqual(\n-      expect.objectContaining({\n-        name: '',\n-        shouldUseRuntimePrefetch: false,\n-        slots: {\n-          children: expect.objectContaining({\n-            name: 'nested-prefetch-static',\n-            shouldUseRuntimePrefetch: true, // <-----------------\n-            slots: {\n-              children: expect.objectContaining({\n-                name: '__PAGE__',\n-                shouldUseRuntimePrefetch: false, // <-----------------\n-                slots: null,\n-              }),\n-            },\n-          }),\n-        },\n-      }) satisfies TreePrefetch\n-    )\n-  })\n-})"
        }
    ],
    "stats": {
        "total": 1316,
        "additions": 815,
        "deletions": 501
    }
}