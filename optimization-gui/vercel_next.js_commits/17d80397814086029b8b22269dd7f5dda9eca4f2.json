{
    "author": "timneutkens",
    "message": "Turbopack: Remove 20ms overhead on bootup (#83554)\n\n## What?\n\nThis fetch, even though not awaited, was kicked off eagerly and the\nfirst `fetch()` in Node.js loads the SSL certificate store which takes\nroughly 20ms. Made sure that it's only fetched when the version is\nneeded, which is the first time errors happen, and then cached from that\npoint.\n\n\n### Additional\n\nIn `test/integration/config-output-export/test/index.test.ts` nearly all\ntests are flaky because of the way they're structured to do asserts\nafter finally that kills the application.\n\nThis causes it to race: Either the assertion is correct before it quits\nor the assertion fails unexpectedly (flaking).\n\nThis PR fixes the test suite. Accidentally found this flakiness when I\nmade the change in this PR that makes the version step take more than 50\nmilliseconds the first time. That caused the assertion to be\nconsistently slower, thus reproducing the issue all the time.",
    "sha": "17d80397814086029b8b22269dd7f5dda9eca4f2",
    "files": [
        {
            "sha": "5b0d76f09c40fbcf8521b4320282860a280430d1",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/17d80397814086029b8b22269dd7f5dda9eca4f2/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17d80397814086029b8b22269dd7f5dda9eca4f2/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=17d80397814086029b8b22269dd7f5dda9eca4f2",
            "patch": "@@ -690,7 +690,17 @@ export async function createHotReloaderTurbopack(\n     }),\n   ]\n \n-  const versionInfoPromise = getVersionInfo()\n+  let versionInfoCached: ReturnType<typeof getVersionInfo> | undefined\n+  // This fetch, even though not awaited, is not kicked off eagerly because the first `fetch()` in\n+  // Node.js adds roughly 20ms main-thread blocking to load the SSL certificate cache\n+  // We don't want that blocking time to be in the hot path for the `ready in` logging.\n+  // Instead, the fetch is kicked off lazily when the first `getVersionInfoCached()` is called.\n+  const getVersionInfoCached = (): ReturnType<typeof getVersionInfo> => {\n+    if (!versionInfoCached) {\n+      versionInfoCached = getVersionInfo()\n+    }\n+    return versionInfoCached\n+  }\n \n   let devtoolsFrontendUrl: string | undefined\n   const nodeDebugType = getNodeDebugType()\n@@ -910,7 +920,7 @@ export async function createHotReloaderTurbopack(\n         }\n \n         ;(async function () {\n-          const versionInfo = await versionInfoPromise\n+          const versionInfo = await getVersionInfoCached()\n           const devToolsConfig = await getDevToolsConfig(distDir)\n \n           const syncMessage: SyncMessage = {"
        },
        {
            "sha": "2123c4758a21440dc4fa612481dce8c059001a58",
            "filename": "test/integration/config-output-export/test/index.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 29,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/17d80397814086029b8b22269dd7f5dda9eca4f2/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17d80397814086029b8b22269dd7f5dda9eca4f2/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts?ref=17d80397814086029b8b22269dd7f5dda9eca4f2",
            "patch": "@@ -161,14 +161,14 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       response = await fetchViaHTTP(result.port, '/api/wow')\n+      expect(response.status).toBe(404)\n+      expect(result?.stderr).toContain(\n+        'API Routes cannot be used with \"output: export\".'\n+      )\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(pagesApi, { recursive: true, force: true })\n     }\n-    expect(response.status).toBe(404)\n-    expect(result?.stderr).toContain(\n-      'API Routes cannot be used with \"output: export\".'\n-    )\n   })\n \n   it('should error with middleware function', async () => {\n@@ -184,15 +184,15 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       response = await fetchViaHTTP(result.port, '/api/mw')\n+      expect(response.status).toBe(404)\n+      expect(result?.stdout + result?.stderr).not.toContain('[mw]')\n+      expect(result?.stderr).toContain(\n+        'Middleware cannot be used with \"output: export\".'\n+      )\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(middleware)\n     }\n-    expect(response.status).toBe(404)\n-    expect(result?.stdout + result?.stderr).not.toContain('[mw]')\n-    expect(result?.stderr).toContain(\n-      'Middleware cannot be used with \"output: export\".'\n-    )\n   })\n \n   it('should error with getStaticProps and revalidate 10 seconds (ISR)', async () => {\n@@ -217,17 +217,18 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       browser = await webdriver(result.port, '/blog')\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxHeader(browser)).toContain(\n+        'ISR cannot be used with \"output: export\".'\n+      )\n+      expect(result?.stderr).toContain(\n+        'ISR cannot be used with \"output: export\".'\n+      )\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(blog)\n     }\n-    await assertHasRedbox(browser)\n-    expect(await getRedboxHeader(browser)).toContain(\n-      'ISR cannot be used with \"output: export\".'\n-    )\n-    expect(result?.stderr).toContain(\n-      'ISR cannot be used with \"output: export\".'\n-    )\n   })\n \n   it('should work with getStaticProps and revalidate false', async () => {\n@@ -252,11 +253,11 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       browser = await webdriver(result.port, '/blog')\n+      await assertNoRedbox(browser)\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(blog)\n     }\n-    await assertNoRedbox(browser)\n   })\n \n   it('should work with getStaticProps and without revalidate', async () => {\n@@ -280,11 +281,11 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       browser = await webdriver(result.port, '/blog')\n+      await assertNoRedbox(browser)\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(blog)\n     }\n-    await assertNoRedbox(browser)\n   })\n \n   it('should error with getServerSideProps without fallback', async () => {\n@@ -308,17 +309,17 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       browser = await webdriver(result.port, '/blog')\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxHeader(browser)).toContain(\n+        'getServerSideProps cannot be used with \"output: export\".'\n+      )\n+      expect(result?.stderr).toContain(\n+        'getServerSideProps cannot be used with \"output: export\".'\n+      )\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(blog)\n     }\n-    await assertHasRedbox(browser)\n-    expect(await getRedboxHeader(browser)).toContain(\n-      'getServerSideProps cannot be used with \"output: export\".'\n-    )\n-    expect(result?.stderr).toContain(\n-      'getServerSideProps cannot be used with \"output: export\".'\n-    )\n   })\n \n   it('should error with getStaticPaths and fallback true', async () => {\n@@ -440,13 +441,13 @@ describe('config-output-export', () => {\n         output: 'export',\n       })\n       browser = await webdriver(result.port, '/posts/one')\n+      const h1 = await browser.elementByCss('h1')\n+      expect(await h1.text()).toContain('Hello from one')\n+      await assertNoRedbox(browser)\n+      expect(result.stderr).toBeEmpty()\n     } finally {\n       await killApp(app).catch(() => {})\n       fs.rmSync(posts, { recursive: true, force: true })\n     }\n-    const h1 = await browser.elementByCss('h1')\n-    expect(await h1.text()).toContain('Hello from one')\n-    await assertNoRedbox(browser)\n-    expect(result.stderr).toBeEmpty()\n   })\n })"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 42,
        "deletions": 31
    }
}