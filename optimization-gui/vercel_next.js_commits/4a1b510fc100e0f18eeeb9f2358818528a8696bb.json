{
    "author": "unstubbable",
    "message": "Add more test cases to the `dynamicIO` sync IO access test suite (#81045)\n\nWith this PR, we're adding test fixtures for `headers()`, `draftMode()`,\nand (fallback) `params`, by more or less copy&pasting the fixture for\n`cookies()`.\n\nWe're also adding assertions for environment prefixes of `console.log()`\ncalls that happen after the sync IO access.",
    "sha": "4a1b510fc100e0f18eeeb9f2358818528a8696bb",
    "files": [
        {
            "sha": "ea001e9a08d93671311fa408442f3da8e4a5c895",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-dynamic.test.ts",
            "status": "modified",
            "additions": 558,
            "deletions": 35,
            "changes": 593,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -1,5 +1,5 @@\n import { isNextDev, nextTestSetup } from 'e2e-utils'\n-import { getPrerenderOutput } from './utils'\n+import { assertLog, getPrerenderOutput } from './utils'\n \n describe.each(\n   isNextDev\n@@ -90,11 +90,11 @@ describe.each(\n              \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n-             \"source\": \"app/page.tsx (52:8) @ LongRunningComponent\n-         > 52 |     use(\n+             \"source\": \"app/page.tsx (48:8) @ LongRunningComponent\n+         > 48 |     use(\n               |        ^\",\n              \"stack\": [\n-               \"LongRunningComponent app/page.tsx (52:8)\",\n+               \"LongRunningComponent app/page.tsx (48:8)\",\n                \"IndirectionTwo app/indirection.tsx (7:34)\",\n                \"Page app/page.tsx (19:61)\",\n                \"main <anonymous> (1:13)\",\n@@ -276,8 +276,19 @@ describe.each(\n          }\n         `)\n       })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n     } else {\n-      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+      it('should not error the build when synchronously reading search params in a server component if all dynamic access is inside a Suspense boundary', async () => {\n         try {\n           await next.start()\n         } catch {\n@@ -314,29 +325,40 @@ describe.each(\n              \"description\": \"Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n              \"environmentLabel\": \"Prerender\",\n              \"label\": \"Console Error\",\n-             \"source\": \"app/page.tsx (40:5) @ SearchParamsReadingComponent\n-         > 40 |   ).foo\n+             \"source\": \"app/page.tsx (41:5) @ SearchParamsReadingComponent\n+         > 41 |   ).foo\n               |     ^\",\n              \"stack\": [\n-               \"SearchParamsReadingComponent app/page.tsx (40:5)\",\n-               \"Page app/page.tsx (19:11)\",\n+               \"SearchParamsReadingComponent app/page.tsx (41:5)\",\n+               \"Page app/page.tsx (20:11)\",\n              ],\n            },\n            {\n              \"description\": \"Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n-             \"source\": \"app/page.tsx (40:5) @ SearchParamsReadingComponent\n-         > 40 |   ).foo\n+             \"source\": \"app/page.tsx (41:5) @ SearchParamsReadingComponent\n+         > 41 |   ).foo\n               |     ^\",\n              \"stack\": [\n-               \"SearchParamsReadingComponent app/page.tsx (40:5)\",\n+               \"SearchParamsReadingComponent app/page.tsx (41:5)\",\n                \"LogSafely <anonymous> (0:0)\",\n              ],\n            },\n          ]\n         `)\n       })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n     } else {\n       it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n         try {\n@@ -353,14 +375,14 @@ describe.each(\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-                 at SearchParamsReadingComponent (turbopack:///[project]/app/page.tsx:40:4)\n-               38 |   const fooParams = (\n-               39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n-             > 40 |   ).foo\n+                 at SearchParamsReadingComponent (turbopack:///[project]/app/page.tsx:41:4)\n+               39 |   const fooParams = (\n+               40 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+             > 41 |   ).foo\n                   |    ^\n-               41 |   return (\n-               42 |     <div>\n-               43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+               42 |\n+               43 |   console.log(\n+               44 |     'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -380,14 +402,14 @@ describe.each(\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-                 at SearchParamsReadingComponent (webpack:///app/page.tsx:40:4)\n-               38 |   const fooParams = (\n-               39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n-             > 40 |   ).foo\n+                 at SearchParamsReadingComponent (webpack:///app/page.tsx:41:4)\n+               39 |   const fooParams = (\n+               40 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+             > 41 |   ).foo\n                   |    ^\n-               41 |   return (\n-               42 |     <div>\n-               43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+               42 |\n+               43 |   console.log(\n+               44 |     'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -431,18 +453,29 @@ describe.each(\n            \"description\": \"Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n            \"environmentLabel\": \"Server\",\n            \"label\": \"Console Error\",\n-           \"source\": \"app/page.tsx (34:67) @ CookiesReadingComponent\n-         > 34 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-              |                                                                   ^\",\n+           \"source\": \"app/page.tsx (33:66) @ CookiesReadingComponent\n+         > 33 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+              |                                                                  ^\",\n            \"stack\": [\n-             \"CookiesReadingComponent app/page.tsx (34:67)\",\n-             \"Page app/page.tsx (17:11)\",\n+             \"CookiesReadingComponent app/page.tsx (33:66)\",\n+             \"Page app/page.tsx (16:11)\",\n            ],\n          }\n         `)\n       })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n     } else {\n-      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+      it('should not error the build when synchronously reading cookies if all dynamic access is inside a Suspense boundary', async () => {\n         try {\n           await next.start()\n         } catch {\n@@ -502,6 +535,17 @@ describe.each(\n          ]\n         `)\n       })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n     } else {\n       it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n         try {\n@@ -523,9 +567,9 @@ describe.each(\n                31 |   await new Promise((r) => process.nextTick(r))\n              > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n                   |                                                                  ^\n-               33 |   return <div>this component read the \\`token\\` cookie synchronously</div>\n-               34 | }\n-               35 |\n+               33 |\n+               34 |   console.log(\n+               35 |     'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -574,4 +618,483 @@ describe.each(\n       })\n     }\n   })\n+\n+  describe('Sync Dynamic - draftMode', () => {\n+    const { next, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-draft-mode',\n+      skipStart: !isNextDev,\n+      skipDeployment: true,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`draftMode().isEnabled\\`. \\`draftMode()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (25:31) @ DraftModeReadingComponent\n+           > 25 |   const isEnabled = (draftMode() as unknown as UnsafeUnwrappedDraftMode)\n+                |                               ^\",\n+             \"stack\": [\n+               \"DraftModeReadingComponent app/page.tsx (25:31)\",\n+               \"Page app/page.tsx (16:11)\",\n+             ],\n+           }\n+          `)\n+        } else {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`draftMode().isEnabled\\`. \\`draftMode()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (25:21) @ DraftModeReadingComponent\n+           > 25 |   const isEnabled = (draftMode() as unknown as UnsafeUnwrappedDraftMode)\n+                |                     ^\",\n+             \"stack\": [\n+               \"DraftModeReadingComponent app/page.tsx (25:21)\",\n+               \"Page app/page.tsx (16:11)\",\n+             ],\n+           }\n+          `)\n+        }\n+      })\n+\n+      // TODO: We should not change the `prerenderPhase` flag in this case.\n+      it.failing(\n+        'should prefix a log after sync `draftMode().isEnabled` access with \"Prerender\"',\n+        async () => {\n+          const browser = await next.browser('/')\n+          const logs = await browser.log()\n+\n+          assertLog(\n+            logs,\n+            'Prerender',\n+            'This log should be prefixed with the \"Prerender\" environment, because the sync access above does not lead to an abort.'\n+          )\n+        }\n+      )\n+    } else {\n+      it('should not error the build when synchronously reading draftMode ', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('○ / ')\n+        const $ = await next.render$('/')\n+        expect($('#draft-mode').text()).toBe('false')\n+      })\n+    }\n+  })\n+\n+  describe('Sync Dynamic - With Fallback - headers', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-headers-with-fallback',\n+      skipStart: !isNextDev,\n+      skipDeployment: true,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/page.tsx (33:70) @ HeadersReadingComponent\n+             > 33 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                  |                                                                      ^\",\n+               \"stack\": [\n+                 \"HeadersReadingComponent app/page.tsx (33:70)\",\n+                 \"Page app/page.tsx (16:11)\",\n+               ],\n+             }\n+            `)\n+      })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n+    } else {\n+      it('should not error the build when synchronously reading headers if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n+  })\n+\n+  describe('Sync Dynamic - Without Fallback - headers', () => {\n+    const { next, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-headers-without-fallback',\n+      skipStart: !isNextDev,\n+      skipDeployment: true,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      // TODO: Ideally we'd only show the error once.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+             [\n+               {\n+                 \"description\": \"Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                 \"environmentLabel\": \"Server\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/page.tsx (32:70) @ HeadersReadingComponent\n+             > 32 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                  |                                                                      ^\",\n+                 \"stack\": [\n+                   \"HeadersReadingComponent app/page.tsx (32:70)\",\n+                   \"Page app/page.tsx (17:11)\",\n+                 ],\n+               },\n+               {\n+                 \"description\": \"Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                 \"environmentLabel\": \"Server\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/page.tsx (32:70) @ HeadersReadingComponent\n+             > 32 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                  |                                                                      ^\",\n+                 \"stack\": [\n+                   \"HeadersReadingComponent app/page.tsx (32:70)\",\n+                   \"LogSafely <anonymous> (0:0)\",\n+                 ],\n+               },\n+             ]\n+            `)\n+      })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.build()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at HeadersReadingComponent (turbopack:///[project]/app/page.tsx:32:69)\n+               30 | async function HeadersReadingComponent() {\n+               31 |   await new Promise((r) => process.nextTick(r))\n+             > 32 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                  |                                                                     ^\n+               33 |     'user-agent'\n+               34 |   )\n+               35 |\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n+        } else {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at createHeadersAccessError (webpack://<next-src>)\n+                 at Promise.get (webpack://<next-src>)\n+                 at HeadersReadingComponent (webpack:///app/page.tsx:32:69)\n+               501 | ) {\n+               502 |   const prefix = route ? \\`Route \"\\${route}\" \\` : 'This route '\n+             > 503 |   return new Error(\n+                   |         ^\n+               504 |     \\`\\${prefix}used \\${expression}. \\` +\n+               505 |       \\`\\\\\\`headers()\\\\\\` should be awaited before using its value. \\` +\n+               506 |       \\`Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\\`\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`headers().get('user-agent')\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n+        }\n+      })\n+    }\n+  })\n+\n+  describe('Sync Dynamic - With Fallback - params', () => {\n+    const { next, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-params-with-fallback',\n+      skipStart: !isNextDev,\n+      skipDeployment: true,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/test')\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/[slug]/page.tsx (32:23) @ ParamsReadingComponent\n+             > 32 |   const slug = params.slug\n+                  |                       ^\",\n+               \"stack\": [\n+                 \"ParamsReadingComponent app/[slug]/page.tsx (32:23)\",\n+                 \"Page app/[slug]/page.tsx (15:11)\",\n+               ],\n+             }\n+            `)\n+        } else {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": null,\n+             \"stack\": [\n+               \"ParamsReadingComponent rsc:/Server/webpack-internal:///(rsc)/app/%5Bslug%5D/page.tsx (85:25)\",\n+               \"Page rsc:/Prerender/webpack-internal:///(rsc)/app/%5Bslug%5D/page.tsx (30:106)\",\n+             ],\n+           }\n+          `)\n+        }\n+      })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/test')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n+    } else {\n+      it('should not error the build when synchronously reading params if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ /[slug] ')\n+        const $ = await next.render$('/test')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n+  })\n+\n+  describe('Sync Dynamic - Without Fallback - params', () => {\n+    const { next, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-params-without-fallback',\n+      skipStart: !isNextDev,\n+      skipDeployment: true,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/test')\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/[slug]/page.tsx (31:23) @ ParamsReadingComponent\n+             > 31 |   const slug = params.slug\n+                  |                       ^\",\n+               \"stack\": [\n+                 \"ParamsReadingComponent app/[slug]/page.tsx (31:23)\",\n+                 \"Page app/[slug]/page.tsx (16:11)\",\n+               ],\n+             }\n+            `)\n+        } else {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": null,\n+             \"stack\": [\n+               \"ParamsReadingComponent rsc:/Server/webpack-internal:///(rsc)/app/%5Bslug%5D/page.tsx (74:25)\",\n+               \"Page rsc:/Prerender/webpack-internal:///(rsc)/app/%5Bslug%5D/page.tsx (30:106)\",\n+             ],\n+           }\n+          `)\n+        }\n+      })\n+\n+      it('should prefix a log after sync dynamic IO with \"Server\"', async () => {\n+        const browser = await next.browser('/test')\n+        const logs = await browser.log()\n+\n+        assertLog(\n+          logs,\n+          'Server',\n+          'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+        )\n+      })\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.build()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at Reflect.get (<anonymous>)\n+                 at ParamsReadingComponent (turbopack:///[project]/app/[slug]/page.tsx:31:22)\n+               29 | async function ParamsReadingComponent({ params }) {\n+               30 |   await new Promise((r) => process.nextTick(r))\n+             > 31 |   const slug = params.slug\n+                  |                      ^\n+               32 |\n+               33 |   console.log(\n+               34 |     'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+             Error occurred prerendering page \"/[slug]\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/[slug]/page: /[slug]\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<anonymous>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+             Error occurred prerendering page \"/[slug]\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /[slug]/page: /[slug], exiting the build.\"\n+            `)\n+          }\n+        } else {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at Reflect.get (<anonymous>)\n+                 at ParamsReadingComponent (webpack:///app/[slug]/page.tsx:31:22)\n+               29 | async function ParamsReadingComponent({ params }) {\n+               30 |   await new Promise((r) => process.nextTick(r))\n+             > 31 |   const slug = params.slug\n+                  |                      ^\n+               32 |\n+               33 |   console.log(\n+               34 |     'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+             Error occurred prerendering page \"/[slug]\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/[slug]/page: /[slug]\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/[slug]\" used \\`params.slug\\`. \\`params\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<anonymous>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+             Error occurred prerendering page \"/[slug]\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /[slug]/page: /[slug], exiting the build.\"\n+            `)\n+          }\n+        }\n+      })\n+    }\n+  })\n })"
        },
        {
            "sha": "8f81a5ce9aad44e8605eac82674ed7be55a2a66c",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-client-search-with-fallback/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -42,11 +42,7 @@ function SearchParamsReadingComponent({\n   const fooParams = (\n     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n   ).foo\n-  return (\n-    <div>\n-      this component read the accessed the `foo` search param: {fooParams}\n-    </div>\n-  )\n+  return <div>this component read the `foo` search param: {fooParams}</div>\n }\n \n function LongRunningComponent() {"
        },
        {
            "sha": "591cd134173968874c1f81e3a9efd12f51f0e956",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-client-search-without-fallback/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -40,11 +40,7 @@ function SearchParamsReadingComponent({\n   const fooParams = (\n     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n   ).foo\n-  return (\n-    <div>\n-      this component read the accessed the `foo` search param: {fooParams}\n-    </div>\n-  )\n+  return <div>this component read the `foo` search param: {fooParams}</div>\n }\n \n function LongRunningComponent() {"
        },
        {
            "sha": "93b21fed775c1f5ff3d4a8ab6dddffc2467087c2",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-cookies-with-fallback/app/page.tsx",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -7,10 +7,9 @@ export default async function Page() {\n   return (\n     <>\n       <p>\n-        This page access cookies synchronously and it triggers dynamic before\n-        another component is finished which doesn't define a fallback UI with\n-        Suspense. This is considered a build error and the message should\n-        clearly indicate that it was caused by a synchronous dynamic API usage.\n+        This page accesses cookies synchronously but it does so late enough in\n+        the render that all unfinished sub-trees have a defined Suspense\n+        boundary. This is fine and doesn't need to error the build.\n       </p>\n       <Suspense fallback={<Fallback />}>\n         <IndirectionOne>\n@@ -31,8 +30,17 @@ export default async function Page() {\n \n async function CookiesReadingComponent() {\n   await new Promise((r) => process.nextTick(r))\n-  const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-  return <div>this component read the `token` cookie synchronously</div>\n+  const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n+  return (\n+    <div>\n+      this component read the `token` cookie synchronously: {token?.value}\n+    </div>\n+  )\n }\n \n async function LongRunningComponent() {"
        },
        {
            "sha": "0ebec0c88de2205799a2a20a4f939888ce92a876",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-cookies-without-fallback/app/page.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -7,7 +7,7 @@ export default async function Page() {\n   return (\n     <>\n       <p>\n-        This page access cookies synchronously and it triggers dynamic before\n+        This page accesses cookies synchronously and it triggers dynamic before\n         another component is finished which doesn't define a fallback UI with\n         Suspense. This is considered a build error and the message should\n         clearly indicate that it was caused by a synchronous dynamic API usage.\n@@ -30,6 +30,11 @@ export default async function Page() {\n async function CookiesReadingComponent() {\n   await new Promise((r) => process.nextTick(r))\n   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n   return <div>this component read the `token` cookie synchronously</div>\n }\n "
        },
        {
            "sha": "c2fe27f1f1ea92f2fe2d12904656c641be9ac54b",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-draft-mode/app/indirection.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Findirection.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function IndirectionOne({ children }) {\n+  return children\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-draft-mode/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Flayout.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "cabdfe3d69d73731febae7311bec0848a1496532",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-draft-mode/app/page.tsx",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,42 @@\n+import { Suspense } from 'react'\n+import { draftMode, UnsafeUnwrappedDraftMode } from 'next/headers'\n+\n+import { IndirectionOne } from './indirection'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses draftMode.isEnabled synchronously. This does not\n+        trigger dynamic, and the build should succeed. In dev mode, we do log an\n+        error for the sync access though.\n+      </p>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionOne>\n+          <DraftModeReadingComponent />\n+        </IndirectionOne>\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function DraftModeReadingComponent() {\n+  await new Promise((r) => process.nextTick(r))\n+  const isEnabled = (draftMode() as unknown as UnsafeUnwrappedDraftMode)\n+    .isEnabled\n+\n+  console.log(\n+    'This log should be prefixed with the \"Prerender\" environment, because the sync access above does not lead to an abort.'\n+  )\n+\n+  return (\n+    <div>\n+      this component read the draftMode isEnabled status synchronously:{' '}\n+      <span id=\"draft-mode\">{isEnabled.toString()}</span>\n+    </div>\n+  )\n+}\n+\n+function Fallback() {\n+  return <div data-fallback=\"\">loading...</div>\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-draft-mode/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-draft-mode%2Fnext.config.js?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "6afe901491d3ac3b46767368abf30a5c90fe715a",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-with-fallback/app/indirection.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Findirection.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+export function IndirectionOne({ children }) {\n+  return children\n+}\n+\n+export function IndirectionTwo({ children }) {\n+  return children\n+}\n+\n+export function IndirectionThree({ children }) {\n+  return children\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-with-fallback/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Flayout.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "c25f904a6d6e4303b2e894e62473238deac2f6e2",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-with-fallback/app/page.tsx",
            "status": "added",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,74 @@\n+import { Suspense } from 'react'\n+import { headers, UnsafeUnwrappedHeaders } from 'next/headers'\n+\n+import { IndirectionOne, IndirectionTwo, IndirectionThree } from './indirection'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses headers synchronously but it does so late enough in\n+        the render that all unfinished sub-trees have a defined Suspense\n+        boundary. This is fine and doesn't need to error the build.\n+      </p>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionOne>\n+          <HeadersReadingComponent />\n+        </IndirectionOne>\n+      </Suspense>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionTwo>\n+          <LongRunningComponent />\n+        </IndirectionTwo>\n+      </Suspense>\n+      <IndirectionThree>\n+        <ShortRunningComponent />\n+      </IndirectionThree>\n+    </>\n+  )\n+}\n+\n+async function HeadersReadingComponent() {\n+  await new Promise((r) => process.nextTick(r))\n+  const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+    'user-agent'\n+  )\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n+  return (\n+    <div>\n+      this component read the `user-agent` header synchronously: {userAgent}\n+    </div>\n+  )\n+}\n+\n+async function LongRunningComponent() {\n+  await new Promise((r) =>\n+    process.nextTick(async () => {\n+      await 1\n+      process.nextTick(r)\n+    })\n+  )\n+  return (\n+    <div>\n+      this component took a long time to resolve (but still before the dynamicIO\n+      cutoff). It might not be done before the sync headers call happens.\n+    </div>\n+  )\n+}\n+\n+async function ShortRunningComponent() {\n+  return (\n+    <div>\n+      This component runs quickly (in a microtask). It should be finished before\n+      the sync headers call is triggered.\n+    </div>\n+  )\n+}\n+\n+function Fallback() {\n+  return <div data-fallback=\"\">loading...</div>\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-with-fallback/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-with-fallback%2Fnext.config.js?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "6afe901491d3ac3b46767368abf30a5c90fe715a",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-without-fallback/app/indirection.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Findirection.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+export function IndirectionOne({ children }) {\n+  return children\n+}\n+\n+export function IndirectionTwo({ children }) {\n+  return children\n+}\n+\n+export function IndirectionThree({ children }) {\n+  return children\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-without-fallback/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Flayout.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "54ecba97359cb0e585f63d67871176a5ce8242a5",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-without-fallback/app/page.tsx",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,73 @@\n+import { Suspense } from 'react'\n+import { headers, type UnsafeUnwrappedHeaders } from 'next/headers'\n+\n+import { IndirectionOne, IndirectionTwo, IndirectionThree } from './indirection'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses headers synchronously and it triggers dynamic before\n+        another component is finished which doesn't define a fallback UI with\n+        Suspense. This is considered a build error and the message should\n+        clearly indicate that it was caused by a synchronous dynamic API usage.\n+      </p>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionOne>\n+          <HeadersReadingComponent />\n+        </IndirectionOne>\n+      </Suspense>\n+      <IndirectionTwo>\n+        <LongRunningComponent />\n+      </IndirectionTwo>\n+      <IndirectionThree>\n+        <ShortRunningComponent />\n+      </IndirectionThree>\n+    </>\n+  )\n+}\n+\n+async function HeadersReadingComponent() {\n+  await new Promise((r) => process.nextTick(r))\n+  const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+    'user-agent'\n+  )\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n+  return (\n+    <div>\n+      this component read the `user-agent` header synchronously: {userAgent}\n+    </div>\n+  )\n+}\n+\n+async function LongRunningComponent() {\n+  await new Promise((r) =>\n+    process.nextTick(async () => {\n+      await 1\n+      process.nextTick(r)\n+    })\n+  )\n+  return (\n+    <div>\n+      this component took a long time to resolve (but still before the dynamicIO\n+      cutoff). It might not be done before the sync headers call happens.\n+    </div>\n+  )\n+}\n+\n+async function ShortRunningComponent() {\n+  return (\n+    <div>\n+      This component runs quickly (in a microtask). It should be finished before\n+      the sync headers call is triggered.\n+    </div>\n+  )\n+}\n+\n+function Fallback() {\n+  return <div data-fallback=\"\">loading...</div>\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-headers-without-fallback/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-headers-without-fallback%2Fnext.config.js?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "6afe901491d3ac3b46767368abf30a5c90fe715a",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-with-fallback/app/[slug]/indirection.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+export function IndirectionOne({ children }) {\n+  return children\n+}\n+\n+export function IndirectionTwo({ children }) {\n+  return children\n+}\n+\n+export function IndirectionThree({ children }) {\n+  return children\n+}"
        },
        {
            "sha": "6894f8a086076b4c3a6d783cb34a942dbb09e4b1",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-with-fallback/app/[slug]/page.tsx",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,67 @@\n+import { Suspense } from 'react'\n+\n+import { IndirectionOne, IndirectionTwo, IndirectionThree } from './indirection'\n+\n+export default async function Page({ params }) {\n+  return (\n+    <>\n+      <p>\n+        This page accesses params synchronously but it does so late enough in\n+        the render that all unfinished sub-trees have a defined Suspense\n+        boundary. This is fine and doesn't need to error the build.\n+      </p>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionOne>\n+          <ParamsReadingComponent params={params} />\n+        </IndirectionOne>\n+      </Suspense>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionTwo>\n+          <LongRunningComponent />\n+        </IndirectionTwo>\n+      </Suspense>\n+      <IndirectionThree>\n+        <ShortRunningComponent />\n+      </IndirectionThree>\n+    </>\n+  )\n+}\n+\n+async function ParamsReadingComponent({ params }) {\n+  await new Promise((r) => process.nextTick(r))\n+  const slug = params.slug\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n+  return <div>this component read the `slug` param synchronously: {slug}</div>\n+}\n+\n+async function LongRunningComponent() {\n+  await new Promise((r) =>\n+    process.nextTick(async () => {\n+      await 1\n+      process.nextTick(r)\n+    })\n+  )\n+  return (\n+    <div>\n+      this component took a long time to resolve (but still before the dynamicIO\n+      cutoff). It might not be done before the sync params call happens.\n+    </div>\n+  )\n+}\n+\n+async function ShortRunningComponent() {\n+  return (\n+    <div>\n+      This component runs quickly (in a microtask). It should be finished before\n+      the sync params call is triggered.\n+    </div>\n+  )\n+}\n+\n+function Fallback() {\n+  return <div data-fallback=\"\">loading...</div>\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-with-fallback/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fapp%2Flayout.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-with-fallback/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-with-fallback%2Fnext.config.js?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "6afe901491d3ac3b46767368abf30a5c90fe715a",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-without-fallback/app/[slug]/indirection.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Findirection.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+export function IndirectionOne({ children }) {\n+  return children\n+}\n+\n+export function IndirectionTwo({ children }) {\n+  return children\n+}\n+\n+export function IndirectionThree({ children }) {\n+  return children\n+}"
        },
        {
            "sha": "81590155ca3bbd5d85359659176640b29269bc6f",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-without-fallback/app/[slug]/page.tsx",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2F%5Bslug%5D%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,66 @@\n+import { Suspense } from 'react'\n+\n+import { IndirectionOne, IndirectionTwo, IndirectionThree } from './indirection'\n+\n+export default async function Page({ params }) {\n+  return (\n+    <>\n+      <p>\n+        This page accesses params synchronously and it triggers dynamic before\n+        another component is finished which doesn't define a fallback UI with\n+        Suspense. This is considered a build error and the message should\n+        clearly indicate that it was caused by a synchronous dynamic API usage.\n+      </p>\n+      <Suspense fallback={<Fallback />}>\n+        <IndirectionOne>\n+          <ParamsReadingComponent params={params} />\n+        </IndirectionOne>\n+      </Suspense>\n+      <IndirectionTwo>\n+        <LongRunningComponent />\n+      </IndirectionTwo>\n+      <IndirectionThree>\n+        <ShortRunningComponent />\n+      </IndirectionThree>\n+    </>\n+  )\n+}\n+\n+async function ParamsReadingComponent({ params }) {\n+  await new Promise((r) => process.nextTick(r))\n+  const slug = params.slug\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n+  return <div>this component read the `slug` param synchronously: {slug}</div>\n+}\n+\n+async function LongRunningComponent() {\n+  await new Promise((r) =>\n+    process.nextTick(async () => {\n+      await 1\n+      process.nextTick(r)\n+    })\n+  )\n+  return (\n+    <div>\n+      this component took a long time to resolve (but still before the dynamicIO\n+      cutoff). It might not be done before the sync params call happens.\n+    </div>\n+  )\n+}\n+\n+async function ShortRunningComponent() {\n+  return (\n+    <div>\n+      This component runs quickly (in a microtask). It should be finished before\n+      the sync params call is triggered.\n+    </div>\n+  )\n+}\n+\n+function Fallback() {\n+  return <div data-fallback=\"\">loading...</div>\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-without-fallback/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fapp%2Flayout.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-params-without-fallback/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-params-without-fallback%2Fnext.config.js?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "f7e57af026fea29a2cc71e62132b7fe9062fb686",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-server-search-with-fallback/app/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -40,6 +40,11 @@ async function SearchParamsReadingComponent({\n   const fooParams = (\n     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n   ).foo\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n   return (\n     <div>\n       this component read the accessed the `foo` search param: {fooParams}"
        },
        {
            "sha": "878b35ae8bd5c40ae4f553622b9c8faaf8ad46d1",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-server-search-without-fallback/app/page.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fapp%2Fpage.tsx?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -10,9 +10,10 @@ export default async function Page(props: {\n   return (\n     <>\n       <p>\n-        This page accesses searchParams synchronously but it does so late enough\n-        in the render that all unfinished sub-trees have a defined Suspense\n-        boundary. This is fine and doesn't need to error the build.\n+        This page accesses searchParams synchronously and it triggers dynamic\n+        before another component is finished which doesn't define a fallback UI\n+        with Suspense. This is considered a build error and the message should\n+        clearly indicate that it was caused by a synchronous dynamic API usage.\n       </p>\n       <Suspense fallback={<Fallback />}>\n         <IndirectionOne>\n@@ -38,6 +39,11 @@ async function SearchParamsReadingComponent({\n   const fooParams = (\n     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n   ).foo\n+\n+  console.log(\n+    'This log should be prefixed with the \"Server\" environment, because the sync IO access above advanced the rendering out of the \"Prerender\" environment.'\n+  )\n+\n   return (\n     <div>\n       this component read the accessed the `foo` search param: {fooParams}"
        },
        {
            "sha": "5b4a07f2d8809f9586dc3be6003925f6f87b08cb",
            "filename": "test/e2e/app-dir/dynamic-io-errors/utils.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4a1b510fc100e0f18eeeb9f2358818528a8696bb/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts?ref=4a1b510fc100e0f18eeeb9f2358818528a8696bb",
            "patch": "@@ -1,6 +1,7 @@\n // Used to deterministically stub out minified local names in stack traces.\n const abc = 'abcdefghijklmnopqrstuvwxyz'\n const hostElementsUsedInFixtures = ['html', 'body', 'main', 'div']\n+import escapeStringRegexp from 'escape-string-regexp'\n \n export function getPrerenderOutput(\n   cliOutput: string,\n@@ -47,3 +48,19 @@ export function getPrerenderOutput(\n \n   return lines.join('\\n').trim()\n }\n+\n+export function assertLog(\n+  logs: Array<{ source: string; message: string }>,\n+  environment: 'Server' | 'Prerender' | 'Cache',\n+  message: string\n+) {\n+  expect(logs.map((l) => l.message)).toEqual(\n+    expect.arrayContaining([\n+      expect.stringMatching(\n+        new RegExp(\n+          `^.*${escapeStringRegexp(message)}.*  \\\\b${environment}\\\\b  $`\n+        )\n+      ),\n+    ])\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 1140,
        "additions": 1085,
        "deletions": 55
    }
}