{
    "author": "unstubbable",
    "message": "Disable fetch cache size limit for implicit caching during build (#80480)\n\nDuring build-time prerendering, when we're only caching `fetch` calls\nimplicitly to improve build performance, and not because the user has\nexplicitly opted into fetch caching, we should not enforce the 2MB size\nlimit.\n\n1. The size limit is not required of the file-system-based cache that's\nused at build time.\n2. The warning is not helpful to users, as they are not aware of the\nimplicit caching behavior.\n\nRelated PRs:\n\n- https://github.com/vercel/next.js/pull/68546\n- https://github.com/vercel/next.js/pull/79384",
    "sha": "ef2961c4ebc89571e7e30798eaace8bcdfc64648",
    "files": [
        {
            "sha": "e8e3cadab15b51d2d753115df7b51de140871cea",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -35,7 +35,7 @@ export interface WorkStore {\n   readonly cacheLifeProfiles?: { [profile: string]: CacheLife }\n \n   readonly isOnDemandRevalidate?: boolean\n-  readonly isPrerendering?: boolean\n+  readonly isBuildTimePrerendering?: boolean\n   readonly isRevalidate?: boolean\n \n   forceDynamic?: boolean"
        },
        {
            "sha": "0edfc0eb4b185de9c10ca9524af987449a2febe0",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -122,7 +122,7 @@ export function createWorkStore({\n       renderOpts.incrementalCache || (globalThis as any).__incrementalCache,\n     cacheLifeProfiles: renderOpts.cacheLifeProfiles,\n     isRevalidate: renderOpts.isRevalidate,\n-    isPrerendering: renderOpts.nextExport,\n+    isBuildTimePrerendering: renderOpts.nextExport,\n     fetchCache: renderOpts.fetchCache,\n     isOnDemandRevalidate: renderOpts.isOnDemandRevalidate,\n "
        },
        {
            "sha": "03e1bb42e8086586ec7d426d834d21f93f28a1f3",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -562,10 +562,13 @@ export class IncrementalCache implements IncrementalCacheType {\n     const itemSize = JSON.stringify(data).length\n     if (\n       ctx.fetchCache &&\n-      // we don't show this error/warning when a custom cache handler is being used\n-      // as it might not have this limit\n+      itemSize > 2 * 1024 * 1024 &&\n+      // We ignore the size limit when custom cache handler is being used, as it\n+      // might not have this limit\n       !this.hasCustomCacheHandler &&\n-      itemSize > 2 * 1024 * 1024\n+      // We also ignore the size limit when it's an implicit build-time-only\n+      // caching that the user isn't even aware of.\n+      !ctx.isImplicitBuildTimeCache\n     ) {\n       const warningText = `Failed to set Next.js data cache for ${ctx.fetchUrl || pathname}, items over 2MB can not be cached (${itemSize} bytes)`\n "
        },
        {
            "sha": "fa5f11cd74625e109d18669afe07dfc8b4c2ea58",
            "filename": "packages/next/src/server/lib/patch-fetch.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -87,6 +87,7 @@ describe('createPatchedFetcher', () => {\n           fetchIdx: 1,\n           fetchUrl: 'https://example.com/',\n           tags: [],\n+          isImplicitBuildTimeCache: false,\n         }\n       )\n     })"
        },
        {
            "sha": "81b033cce02cee3ea79a2eab66b277df0f283bbe",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 12,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -391,16 +391,24 @@ export function createPatchedFetcher(\n             currentFetchCacheConfig === 'default') &&\n           // eslint-disable-next-line eqeqeq\n           currentFetchRevalidate == undefined\n-        const autoNoCache =\n-          // this condition is hit for null/undefined\n-          // eslint-disable-next-line eqeqeq\n-          (hasNoExplicitCacheConfig &&\n-            // we disable automatic no caching behavior during build time SSG so that we can still\n-            // leverage the fetch cache between SSG workers\n-            !workStore.isPrerendering) ||\n-          ((hasUnCacheableHeader || isUnCacheableMethod) &&\n-            revalidateStore &&\n-            revalidateStore.revalidate === 0)\n+\n+        let autoNoCache = Boolean(\n+          (hasUnCacheableHeader || isUnCacheableMethod) &&\n+            revalidateStore?.revalidate === 0\n+        )\n+\n+        let isImplicitBuildTimeCache = false\n+\n+        if (!autoNoCache && hasNoExplicitCacheConfig) {\n+          // We don't enable automatic no-cache behavior during build-time\n+          // prerendering so that we can still leverage the fetch cache between\n+          // export workers.\n+          if (workStore.isBuildTimePrerendering) {\n+            isImplicitBuildTimeCache = true\n+          } else {\n+            autoNoCache = true\n+          }\n+        }\n \n         if (\n           hasNoExplicitCacheConfig &&\n@@ -670,7 +678,13 @@ export function createPatchedFetcher(\n                       data: fetchedData,\n                       revalidate: normalizedRevalidate,\n                     },\n-                    { fetchCache: true, fetchUrl, fetchIdx, tags }\n+                    {\n+                      fetchCache: true,\n+                      fetchUrl,\n+                      fetchIdx,\n+                      tags,\n+                      isImplicitBuildTimeCache,\n+                    }\n                   )\n                   await handleUnlock()\n \n@@ -716,7 +730,13 @@ export function createPatchedFetcher(\n                             data: fetchedData,\n                             revalidate: normalizedRevalidate,\n                           },\n-                          { fetchCache: true, fetchUrl, fetchIdx, tags }\n+                          {\n+                            fetchCache: true,\n+                            fetchUrl,\n+                            fetchIdx,\n+                            tags,\n+                            isImplicitBuildTimeCache,\n+                          }\n                         )\n                       }\n                     })"
        },
        {
            "sha": "04b9daa8535e19dc569c5f05a7627abcca7df988",
            "filename": "packages/next/src/server/response-cache/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -226,6 +226,7 @@ export interface SetIncrementalFetchCacheContext {\n   fetchUrl?: string\n   fetchIdx?: number\n   tags?: string[]\n+  isImplicitBuildTimeCache?: boolean\n }\n \n export interface SetIncrementalResponseCacheContext {"
        },
        {
            "sha": "9194c38d414bf8f7f40e2ff119ec05b48dc8df04",
            "filename": "test/e2e/app-dir/app-fetch-deduping/app-fetch-deduping.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp-fetch-deduping.test.ts?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -25,7 +25,10 @@ describe('app-fetch-deduping', () => {\n             successfulRequests.push(req.url)\n           }\n \n-          res.end(`Request ${req.url} received at ${Date.now()}`)\n+          // Generate a response with more than two MB of data.\n+          res.end(\n+            `Request ${req.url} received at ${Date.now()}\\n\\n${'a'.repeat(2_000_000)}`\n+          )\n         })\n \n         await new Promise<void>((resolve, reject) => {\n@@ -37,24 +40,26 @@ describe('app-fetch-deduping', () => {\n             reject(err)\n           })\n         })\n-      })\n-\n-      beforeEach(() => {\n-        successfulRequests = []\n-      })\n \n-      afterAll(() => externalServer.close())\n-\n-      it('dedupes requests amongst static workers', async () => {\n         await next.patchFile(\n           'next.config.js',\n           `module.exports = {\n             env: { TEST_SERVER_PORT: \"${externalServerPort}\" },\n           }`\n         )\n+\n         await next.build()\n+      })\n+\n+      afterAll(() => externalServer.close())\n+\n+      it('dedupes requests amongst static workers', async () => {\n         expect(successfulRequests.length).toBe(1)\n       })\n+\n+      it('does not print a fetch cache size limit warning', async () => {\n+        expect(next.cliOutput).not.toInclude('Failed to set Next.js data cache')\n+      })\n     })\n   } else if (isNextDev) {\n     describe('during next dev', () => {"
        },
        {
            "sha": "69e348c39ef1642e9fa2b7fa33de8849bb89be05",
            "filename": "test/e2e/app-dir/app-fetch-deduping/app/layout.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ef2961c4ebc89571e7e30798eaace8bcdfc64648/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef2961c4ebc89571e7e30798eaace8bcdfc64648/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-fetch-deduping%2Fapp%2Flayout.js?ref=ef2961c4ebc89571e7e30798eaace8bcdfc64648",
            "patch": "@@ -1,5 +1,3 @@\n-export const fetchCache = 'default-cache'\n-\n export default function Layout({ children }) {\n   return (\n     <html lang=\"en\">"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 56,
        "deletions": 28
    }
}