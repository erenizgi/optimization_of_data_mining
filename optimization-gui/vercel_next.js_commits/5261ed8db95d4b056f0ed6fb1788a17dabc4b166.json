{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix /index/index handling (#80413)\n\n## What?\n\nAlternative for #80385",
    "sha": "5261ed8db95d4b056f0ed6fb1788a17dabc4b166",
    "files": [
        {
            "sha": "1670e44b1b45360d451bd1882af9cb3478a83742",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5261ed8db95d4b056f0ed6fb1788a17dabc4b166/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5261ed8db95d4b056f0ed6fb1788a17dabc4b166/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=5261ed8db95d4b056f0ed6fb1788a17dabc4b166",
            "patch": "@@ -478,22 +478,29 @@ export class TurbopackManifestLoader {\n     }\n \n     const sortedPageKeys = getSortedRoutes(pagesKeys)\n-    const content: ClientBuildManifest = {\n+    const clientBuildManifest: ClientBuildManifest = {\n       __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n       ...Object.fromEntries(\n-        sortedPageKeys.map((pathname) => [\n-          pathname,\n-          [`static/chunks/pages${pathname === '/' ? '/index' : pathname}.js`],\n-        ])\n+        sortedPageKeys.map((pathname) => {\n+          let filePath\n+          if (pathname === '/') {\n+            filePath = '/index.js'\n+          } else if (pathname.endsWith('/index')) {\n+            filePath = `${pathname}/index.js`\n+          } else {\n+            filePath = `${pathname}.js`\n+          }\n+          return [pathname, [`static/chunks/pages${filePath}`]]\n+        })\n       ),\n       sortedPages: sortedPageKeys,\n     }\n-    const buildManifestJs = `self.__BUILD_MANIFEST = ${JSON.stringify(\n-      content\n+    const clientBuildManifestJs = `self.__BUILD_MANIFEST = ${JSON.stringify(\n+      clientBuildManifest\n     )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n     await writeFileAtomic(\n       join(this.distDir, 'static', this.buildId, '_buildManifest.js'),\n-      buildManifestJs\n+      clientBuildManifestJs\n     )\n     await writeFileAtomic(\n       join(this.distDir, 'static', this.buildId, '_ssgManifest.js'),"
        },
        {
            "sha": "743f10b411956744e79363e84ffc8494fbb7d5c8",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5261ed8db95d4b056f0ed6fb1788a17dabc4b166/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5261ed8db95d4b056f0ed6fb1788a17dabc4b166/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=5261ed8db95d4b056f0ed6fb1788a17dabc4b166",
            "patch": "@@ -15234,11 +15234,10 @@\n       \"nested index.js production mode should ssr page /index\",\n       \"nested index.js production mode should ssr page /index/index\",\n       \"nested index.js production mode should ssr page /index/project\",\n-      \"nested index.js production mode should ssr page /index/user\"\n-    ],\n-    \"failed\": [\n+      \"nested index.js production mode should ssr page /index/user\",\n       \"nested index.js production mode should follow link to /index/index\"\n     ],\n+    \"failed\": [],\n     \"pending\": [\n       \"nested index.js development mode should 404 on /index/index/index\",\n       \"nested index.js development mode should client render page /\",\n@@ -16895,11 +16894,10 @@\n   },\n   \"test/integration/prerender-export/test/index.test.js\": {\n     \"passed\": [\n-      \"SSG Prerender export production mode export mode should copy prerender files and honor exportTrailingSlash\"\n-    ],\n-    \"failed\": [\n+      \"SSG Prerender export production mode export mode should copy prerender files and honor exportTrailingSlash\",\n       \"SSG Prerender export production mode export mode should navigate between pages successfully\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 19,
        "deletions": 14
    }
}