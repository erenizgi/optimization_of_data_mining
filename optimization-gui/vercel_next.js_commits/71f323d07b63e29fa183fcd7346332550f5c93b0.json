{
    "author": "unstubbable",
    "message": "[Cache Components] Fix HMR for nested pages (#82776)\n\nTo bypass existing caches when editing server components, we store an\nHMR hash in a session cookie. The cookie is sent to the server when\nrefetching the RSC, and included in the cache key of all `'use cache'`\nfunctions (see #75474).\n\nBefore this fix, we weren't setting the cookie path properly, which led\nto multiple cookies for different paths being written and sent to the\nserver. This caused stale values to be used for nested pages, which\nresulted in stale components being displayed after edits.\n\nNow, we set the cookie path to `/`, ensuring that the same cookie is\nused for all nested pages.\n\ncloses NAR-204\nresolves #81538",
    "sha": "71f323d07b63e29fa183fcd7346332550f5c93b0",
    "files": [
        {
            "sha": "bfab25afab2aca058ec4f56832f5c7484ba6b53a",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/71f323d07b63e29fa183fcd7346332550f5c93b0/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/71f323d07b63e29fa183fcd7346332550f5c93b0/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=71f323d07b63e29fa183fcd7346332550f5c93b0",
            "patch": "@@ -389,7 +389,7 @@ function processMessage(\n \n       // Store the latest hash in a session cookie so that it's sent back to the\n       // server with any subsequent requests.\n-      document.cookie = `${NEXT_HMR_REFRESH_HASH_COOKIE}=${obj.hash}`\n+      document.cookie = `${NEXT_HMR_REFRESH_HASH_COOKIE}=${obj.hash};path=/`\n \n       if (RuntimeErrorHandler.hadRuntimeError) {\n         if (reloading) return"
        },
        {
            "sha": "ccb322b504e184db1c7a12031d31671ef37e3c52",
            "filename": "test/e2e/app-dir/use-cache-dev/app/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fpage.tsx?ref=71f323d07b63e29fa183fcd7346332550f5c93b0",
            "patch": "@@ -1,4 +1,5 @@\n import { revalidatePath } from 'next/cache'\n+import Link from 'next/link'\n \n async function getRandomValue() {\n   'use cache'\n@@ -36,6 +37,9 @@ export default async function Page() {\n       >\n         <button id=\"revalidate\">Revalidate</button>\n       </form>\n+      <p>\n+        <Link href=\"/some/path\">Go to /some/path</Link>\n+      </p>\n     </>\n   )\n }"
        },
        {
            "sha": "c0002a309529f1fe102f9fc27f49cb615b278c07",
            "filename": "test/e2e/app-dir/use-cache-dev/app/some/path/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fsome%2Fpath%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fsome%2Fpath%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fapp%2Fsome%2Fpath%2Fpage.tsx?ref=71f323d07b63e29fa183fcd7346332550f5c93b0",
            "patch": "@@ -0,0 +1,5 @@\n+export default async function Page() {\n+  'use cache'\n+\n+  return <p id=\"greeting\">Hi</p>\n+}"
        },
        {
            "sha": "6bb3e7dd7e1e61bf674e4e2a6d03567b537cec42",
            "filename": "test/e2e/app-dir/use-cache-dev/use-cache-dev.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fuse-cache-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/71f323d07b63e29fa183fcd7346332550f5c93b0/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fuse-cache-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-dev%2Fuse-cache-dev.test.ts?ref=71f323d07b63e29fa183fcd7346332550f5c93b0",
            "patch": "@@ -163,6 +163,33 @@ describe('use-cache-dev', () => {\n         expect(next.cliOutput.slice(cliOutputLength)).toInclude('âœ“ Compiled')\n       }, 10_000)\n     })\n+\n+    it('should handle edits on nested pages', async () => {\n+      // This is a regression test that ensures that setting the HMR refresh\n+      // hash cookie is not done per path, leading to a stale cookie being used\n+      // for nested pages.\n+      const browser = await next.browser('/')\n+\n+      // Edit something in the root page.tsx file.\n+      await next.patchFile('app/page.tsx', (content) =>\n+        content.replace('foo', 'bar')\n+      )\n+\n+      // Navigate to the nested page. This an explicit hard navigation. A soft\n+      // navigation plus refresh would also reproduce the issue.\n+      await browser.loadPage(new URL('/some/path', next.url).href)\n+\n+      expect(await browser.elementById('greeting').text()).toBe('Hi')\n+\n+      // Edit something in the nested page.tsx file.\n+      await next.patchFile('app/some/path/page.tsx', (content) =>\n+        content.replace('Hi', 'Hello')\n+      )\n+\n+      await retry(async () => {\n+        expect(await browser.elementById('greeting').text()).toBe('Hello')\n+      })\n+    })\n   } else {\n     it('should ignore an existing HMR refresh hash cookie with \"next start\"', async () => {\n       const browser = await next.browser('/')"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 37,
        "deletions": 1
    }
}