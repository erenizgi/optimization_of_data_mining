{
    "author": "ztanner",
    "message": "fix: pages router metadata bugs with React 19 (#81733)\n\nWhen we updated `experimental.strictNextHead` to be true in #65418, we\ndid not update all spots that would default to true in the case where\nthe value was omitted entirely.\n\nThis led to the default value not being correctly applied in pages\nrouter, which resulted in duplicate metadata w/ React 19.\n\nSince we made the flag the default, we can also probably clean up this\nflag all together, but that can be done separately.\n\nFixes #81655\nFixes #81689",
    "sha": "63090e20f198f7bda7bb746e29fe6a25a1391d8c",
    "files": [
        {
            "sha": "339e5a15ace7165b9027f2eb39947f0b93abd45f",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -289,9 +289,8 @@ export async function handler(\n                   reactLoadableManifest,\n \n                   assetPrefix: nextConfig.assetPrefix,\n-                  strictNextHead: Boolean(\n-                    nextConfig.experimental.strictNextHead\n-                  ),\n+                  strictNextHead:\n+                    nextConfig.experimental.strictNextHead ?? true,\n                   previewProps: prerenderManifest.preview,\n                   images: nextConfig.images as any,\n                   nextConfigOutput: nextConfig.output,"
        },
        {
            "sha": "73b5b6b01e8c9e76a0f76fe32fd54f0f3a1ae6a5",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -1466,6 +1466,7 @@ export const defaultConfig = Object.freeze({\n     devtoolSegmentExplorer: false,\n     browserDebugInfoInTerminal: false,\n     optimizeRouterScrolling: false,\n+    strictNextHead: true,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "827ccc75e11591719869ac5b91432396465dc27d",
            "filename": "test/development/pages-dir/client-navigation/fixture/next.config.js",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -4,9 +4,12 @@ module.exports = {\n     // Make sure entries are not getting disposed.\n     maxInactiveAge: 1000 * 60 * 60,\n   },\n-  experimental: {\n-    strictNextHead: process.env.TEST_STRICT_NEXT_HEAD !== 'false',\n-  },\n+  experimental:\n+    process.env.TEST_STRICT_NEXT_HEAD !== undefined\n+      ? {\n+          strictNextHead: process.env.TEST_STRICT_NEXT_HEAD === 'true',\n+        }\n+      : {},\n   // scroll position can be finicky with the\n   // indicators showing so hide by default\n   devIndicators: false,"
        },
        {
            "sha": "be2f22ded7cdb1b87d5a3e126e5a447f5782114f",
            "filename": "test/development/pages-dir/client-navigation/fixture/pages/head-with-custom-metadata.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fpages%2Fhead-with-custom-metadata.js",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fpages%2Fhead-with-custom-metadata.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fpages%2Fhead-with-custom-metadata.js?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -0,0 +1,14 @@\n+import Head from 'next/head'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <Head>\n+        <title>Title Page</title>\n+        <meta property=\"og:title\" content=\"Title Content\" />\n+        <meta name=\"description\" content=\"Description Content\" />\n+      </Head>\n+      <p>This is a page!</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "06cf0ffe9cb723a89f506adf0ef06d4c9e5067f3",
            "filename": "test/development/pages-dir/client-navigation/rendering-head.test.ts",
            "status": "modified",
            "additions": 83,
            "deletions": 49,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -8,14 +8,17 @@ import path from 'path'\n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n describe('Client Navigation rendering <Head />', () => {\n-  describe.each([[false], [true]])(\n+  describe.each([[false], [true], [undefined]])(\n     'with strictNextHead=%s',\n     (strictNextHead) => {\n       const { next } = nextTestSetup({\n         files: path.join(__dirname, 'fixture'),\n-        env: {\n-          TEST_STRICT_NEXT_HEAD: String(strictNextHead),\n-        },\n+        env:\n+          strictNextHead !== undefined\n+            ? {\n+                TEST_STRICT_NEXT_HEAD: String(strictNextHead),\n+              }\n+            : {},\n       })\n \n       function render(\n@@ -37,7 +40,7 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header renders default charset', async () => {\n         const html = await render('/default-head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta charSet=\"utf-8\" data-next-head=\"\"/>'\n             : '<meta charSet=\"utf-8\"/>'\n         )\n@@ -47,7 +50,7 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header renders default viewport', async () => {\n         const html = await render('/default-head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"viewport\" content=\"width=device-width\" data-next-head=\"\"/>'\n             : '<meta name=\"viewport\" content=\"width=device-width\"/>'\n         )\n@@ -56,17 +59,17 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header helper renders header information', async () => {\n         const html = await render('/head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>'\n             : '<meta charSet=\"iso-8859-5\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta content=\"my meta\" data-next-head=\"\"/>'\n             : '<meta content=\"my meta\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n             : '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>'\n         )\n@@ -76,17 +79,17 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header helper dedupes tags', async () => {\n         const html = await render('/head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>'\n             : '<meta charSet=\"iso-8859-5\"/>'\n         )\n         expect(html).not.toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta charSet=\"utf-8\" data-next-head=\"\"/>'\n             : '<meta charSet=\"utf-8\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n             : '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>'\n         )\n@@ -96,24 +99,25 @@ describe('Client Navigation rendering <Head />', () => {\n           '<meta name=\"viewport\" content=\"width=device-width\"'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta content=\"my meta\" data-next-head=\"\"/>'\n             : '<meta content=\"my meta\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/><link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/>'\n             : '<link rel=\"stylesheet\" href=\"/dup-style.css\"/><link rel=\"stylesheet\" href=\"/dup-style.css\"/>'\n         )\n-        const dedupeLink = strictNextHead\n-          ? '<link rel=\"stylesheet\" href=\"dedupe-style.css\" data-next-head=\"\"/>'\n-          : '<link rel=\"stylesheet\" href=\"dedupe-style.css\"/>'\n+        const dedupeLink =\n+          strictNextHead !== false\n+            ? '<link rel=\"stylesheet\" href=\"dedupe-style.css\" data-next-head=\"\"/>'\n+            : '<link rel=\"stylesheet\" href=\"dedupe-style.css\"/>'\n         expect(html).toContain(dedupeLink)\n         expect(\n           html.substring(html.indexOf(dedupeLink) + dedupeLink.length)\n         ).not.toContain('<link rel=\"stylesheet\" href=\"dedupe-style.css\"')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<link rel=\"alternate\" hrefLang=\"en\" href=\"/last/en\" data-next-head=\"\"/>'\n             : '<link rel=\"alternate\" hrefLang=\"en\" href=\"/last/en\"/>'\n         )\n@@ -129,12 +133,12 @@ describe('Client Navigation rendering <Head />', () => {\n         // Expect exactly one `viewport`\n         expect((html.match(/name=\"viewport\"/g) || []).length).toBe(1)\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta charSet=\"iso-8859-1\" data-next-head=\"\"/>'\n             : '<meta charSet=\"iso-8859-1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"viewport\" content=\"width=500\" data-next-head=\"\"/>'\n             : '<meta name=\"viewport\" content=\"width=500\"/>'\n         )\n@@ -144,98 +148,98 @@ describe('Client Navigation rendering <Head />', () => {\n         const html = await render('/head')\n         console.log(html)\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"article:tag\" content=\"tag1\" data-next-head=\"\"/>'\n             : '<meta property=\"article:tag\" content=\"tag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"article:tag\" content=\"tag2\" data-next-head=\"\"/>'\n             : '<meta property=\"article:tag\" content=\"tag2\"/>'\n         )\n         expect(html).not.toContain('<meta property=\"dedupe:tag\" content=\"tag3\"')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"dedupe:tag\" content=\"tag4\" data-next-head=\"\"/>'\n             : '<meta property=\"dedupe:tag\" content=\"tag4\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image\" content=\"ogImageTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image\" content=\"ogImageTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image\" content=\"ogImageTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image\" content=\"ogImageTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:alt\" content=\"ogImageAltTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:alt\" content=\"ogImageAltTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:alt\" content=\"ogImageAltTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:alt\" content=\"ogImageAltTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:width\" content=\"ogImageWidthTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:width\" content=\"ogImageWidthTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:width\" content=\"ogImageWidthTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:width\" content=\"ogImageWidthTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:height\" content=\"ogImageHeightTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:height\" content=\"ogImageHeightTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:height\" content=\"ogImageHeightTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:height\" content=\"ogImageHeightTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:type\" content=\"ogImageTypeTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:type\" content=\"ogImageTypeTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:type\" content=\"ogImageTypeTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:type\" content=\"ogImageTypeTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:url\" content=\"ogImageUrlTag1\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:url\" content=\"ogImageUrlTag1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"og:image:url\" content=\"ogImageUrlTag2\" data-next-head=\"\"/>'\n             : '<meta property=\"og:image:url\" content=\"ogImageUrlTag2\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"fb:pages\" content=\"fbpages1\" data-next-head=\"\"/>'\n             : '<meta property=\"fb:pages\" content=\"fbpages1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta property=\"fb:pages\" content=\"fbpages2\" data-next-head=\"\"/>'\n             : '<meta property=\"fb:pages\" content=\"fbpages2\"/>'\n         )\n@@ -244,12 +248,12 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header helper avoids dedupe of meta tags with the same name if they use unique keys', async () => {\n         const html = await render('/head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"citation_author\" content=\"authorName1\" data-next-head=\"\"/>'\n             : '<meta name=\"citation_author\" content=\"authorName1\"/>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta name=\"citation_author\" content=\"authorName2\" data-next-head=\"\"/>'\n             : '<meta name=\"citation_author\" content=\"authorName2\"/>'\n         )\n@@ -258,12 +262,12 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header helper renders Fragment children', async () => {\n         const html = await render('/head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<title data-next-head=\"\">Fragment title</title>'\n             : '<title>Fragment title</title>'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<meta content=\"meta fragment\" data-next-head=\"\"/>'\n             : '<meta content=\"meta fragment\"/>'\n         )\n@@ -272,27 +276,28 @@ describe('Client Navigation rendering <Head />', () => {\n       test('header helper renders boolean attributes correctly children', async () => {\n         const html = await render('/head')\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<script src=\"/test-async-false.js\" data-next-head=\"\">'\n             : '<script src=\"/test-async-false.js\">'\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<script src=\"/test-async-true.js\" async=\"\" data-next-head=\"\">'\n             : ''\n         )\n         expect(html).toContain(\n-          strictNextHead\n+          strictNextHead !== false\n             ? '<script src=\"/test-defer.js\" defer=\"\" data-next-head=\"\">'\n             : ''\n         )\n       })\n \n       it('should place charset element at the top of <head>', async () => {\n         const html = await render('/head-priority')\n-        const nextHeadElement = strictNextHead\n-          ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/><meta name=\"title\" content=\"head title\" data-next-head=\"\"/>'\n-          : '<meta charSet=\"iso-8859-5\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><meta name=\"title\" content=\"head title\"/><meta name=\"next-head-count\" content=\"3\"/>'\n+        const nextHeadElement =\n+          strictNextHead !== false\n+            ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/><meta name=\"title\" content=\"head title\" data-next-head=\"\"/>'\n+            : '<meta charSet=\"iso-8859-5\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><meta name=\"title\" content=\"head title\"/><meta name=\"next-head-count\" content=\"3\"/>'\n         const documentHeadElement =\n           '<meta name=\"keywords\" content=\"document head test\"/>'\n \n@@ -304,6 +309,35 @@ describe('Client Navigation rendering <Head />', () => {\n             : `<head>${nextHeadElement}${documentHeadElement}`\n         )\n       })\n+\n+      test('custom meta properties are rendered only once', async () => {\n+        const browser = await next.browser('/head-with-custom-metadata')\n+\n+        // Check that title appears only once\n+        const titleElements = await browser.elementsByCss('title')\n+        expect(titleElements).toHaveLength(1)\n+        const titleText = await browser.elementByCss('title').text()\n+        expect(titleText).toBe('Title Page')\n+\n+        // Check that each meta property appears only once\n+        const ogTitleElements = await browser.elementsByCss(\n+          'meta[property=\"og:title\"]'\n+        )\n+        expect(ogTitleElements).toHaveLength(1)\n+        const ogTitleContent = await browser\n+          .elementByCss('meta[property=\"og:title\"]')\n+          .getAttribute('content')\n+        expect(ogTitleContent).toBe('Title Content')\n+\n+        const descriptionElements = await browser.elementsByCss(\n+          'meta[name=\"description\"]'\n+        )\n+        expect(descriptionElements).toHaveLength(1)\n+        const descriptionContent = await browser\n+          .elementByCss('meta[name=\"description\"]')\n+          .getAttribute('content')\n+        expect(descriptionContent).toBe('Description Content')\n+      })\n     }\n   )\n })"
        }
    ],
    "stats": {
        "total": 161,
        "additions": 106,
        "deletions": 55
    }
}