{
    "author": "gnoff",
    "message": "[dynamicIO] use RSC dynamicness to control partial vs complete PPR result (#81627)\n\nHistorically anything dynamic in a prerender would result in a partially\nstatic shell that resumes at runtime. With this change, now partial\nshells are only possible when RSC is dynamic. If your client prerender\nhas any IO but your RSC tree was entirely prerenderable then Next.js\nwill produce a complete static result and not perform a resume at\nruntime. This simplifies how you reason about what will and wil not make\na static page. It also means that anything dynamic in the client layer\nwill only render in browser.\n\n---------\n\nCo-authored-by: Hendrik Liebau <mail@hendrik-liebau.de>",
    "sha": "3c6591c1b2c2071f195a1677c4c110552e155584",
    "files": [
        {
            "sha": "417ac9f0a522e744a2eb233456d7bcc52c62acd1",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/3c6591c1b2c2071f195a1677c4c110552e155584/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c6591c1b2c2071f195a1677c4c110552e155584/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=3c6591c1b2c2071f195a1677c4c110552e155584",
            "patch": "@@ -3264,7 +3264,6 @@ async function prerenderToStream(\n         captureOwnerStack: undefined, // Not available in production.\n       }\n \n-      let clientIsDynamic = false\n       let dynamicValidation = createDynamicValidationState()\n \n       const prerender = (\n@@ -3291,8 +3290,6 @@ async function prerenderToStream(\n                     isPrerenderInterruptedError(err) ||\n                     finalClientController.signal.aborted\n                   ) {\n-                    clientIsDynamic = true\n-\n                     const componentStack: string | undefined = (\n                       errorInfo as any\n                     ).componentStack\n@@ -3356,7 +3353,12 @@ async function prerenderToStream(\n         fallbackRouteParams\n       )\n \n-      if (serverIsDynamic || clientIsDynamic) {\n+      if (serverIsDynamic) {\n+        // Dynamic case\n+        // We will always need to perform a \"resume\" render of some kind when this route is accessed\n+        // because the RSC data itself is dynamic. We determine if there are any HTML holes or not\n+        // but generally this is a \"partial\" prerender in that there will be a per-request compute\n+        // concatenated to the static shell.\n         if (postponed != null) {\n           // Dynamic HTML case\n           metadata.postponed = await getDynamicHTMLPostponedState(\n@@ -3390,6 +3392,8 @@ async function prerenderToStream(\n         }\n       } else {\n         // Static case\n+        // We will not perform resumption per request. The result can be served statically to the requestor\n+        // and if there was anything dynamic it will only be rendered in the browser.\n         if (workStore.forceDynamic) {\n           throw new StaticGenBailoutError(\n             'Invariant: a Page with `dynamic = \"force-dynamic\"` did not trigger the dynamic pathway. This is a bug in Next.js'"
        },
        {
            "sha": "56e4a93f698bb58c0aa059e3044d0ef09dad1433",
            "filename": "test/e2e/app-dir/dynamic-io/app/cases/static-rsc-dynamic-client/client.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fclient.tsx?ref=3c6591c1b2c2071f195a1677c4c110552e155584",
            "patch": "@@ -0,0 +1,12 @@\n+'use client'\n+\n+export function Time() {\n+  return (\n+    <p>\n+      The time is{' '}\n+      <span id=\"time\" suppressHydrationWarning>\n+        {new Date().toISOString()}\n+      </span>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "17c9cdea0059aac6f040edc73328dc4be9a1ab7e",
            "filename": "test/e2e/app-dir/dynamic-io/app/cases/static-rsc-dynamic-client/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fcases%2Fstatic-rsc-dynamic-client%2Fpage.tsx?ref=3c6591c1b2c2071f195a1677c4c110552e155584",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+\n+import { getSentinelValue } from '../../getSentinelValue'\n+\n+import { Time } from './client'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page is static in RSC but dynamic in the client. It should serve a\n+        static fallback that updates in the browser.\n+      </p>\n+      <Suspense fallback={<span>Loading...</span>}>\n+        <Time />\n+      </Suspense>\n+      <div id=\"page\">{getSentinelValue()}</div>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "38b81d7e3a9d8ed283c924899806764c0dc9b8a1",
            "filename": "test/e2e/app-dir/dynamic-io/dynamic-io.test.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c6591c1b2c2071f195a1677c4c110552e155584/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.test.ts?ref=3c6591c1b2c2071f195a1677c4c110552e155584",
            "patch": "@@ -1,5 +1,6 @@\n /* eslint-disable jest/no-standalone-expect */\n import { nextTestSetup } from 'e2e-utils'\n+import cheerio from 'cheerio'\n \n describe('dynamic-io', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n@@ -330,4 +331,46 @@ describe('dynamic-io', () => {\n       expect($('#page-children').text()).toBe('at buildtime')\n     }\n   })\n+\n+  it('should not resume when client components are dynamic but the RSC render was static', async () => {\n+    let html = await next.render('/cases/static-rsc-dynamic-client', {})\n+    const $ = cheerio.load(html)\n+\n+    // Confirm the HTML document was sent completely\n+    expect(html).toContain('</body></html>')\n+\n+    if (isNextDev) {\n+      expect($('#layout').text()).toBe('at runtime')\n+      expect($('#page').text()).toBe('at runtime')\n+      // In dev we SSR the time\n+      expect($('#time').length).toBe(1)\n+    } else {\n+      expect($('#layout').text()).toBe('at buildtime')\n+      expect($('#page').text()).toBe('at buildtime')\n+      // Confirm the time span is not part of the completed HTML document\n+      expect($('#time').length).toBe(0)\n+    }\n+\n+    const browser = await next.browser('/cases/static-rsc-dynamic-client')\n+\n+    const now = new Date()\n+\n+    if (isNextDev) {\n+      expect(await browser.elementById('layout').text()).toBe('at runtime')\n+      expect(await browser.elementById('page').text()).toBe('at runtime')\n+      // Assert that we rendered a time within the last couple seconds.\n+      const inPageDate = new Date(\n+        await browser.waitForElementByCss('#time').text()\n+      )\n+      expect(inPageDate.getTime() - now.getTime()).toBeLessThan(2000)\n+    } else {\n+      expect(await browser.elementById('layout').text()).toBe('at buildtime')\n+      expect(await browser.elementById('page').text()).toBe('at buildtime')\n+      // Assert that we rendered a time within the last 2 seconds.\n+      const inPageDate = new Date(\n+        await browser.waitForElementByCss('#time').text()\n+      )\n+      expect(inPageDate.getTime() - now.getTime()).toBeLessThan(2000)\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 83,
        "deletions": 4
    }
}