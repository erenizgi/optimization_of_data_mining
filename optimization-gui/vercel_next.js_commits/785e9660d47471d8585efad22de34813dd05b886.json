{
    "author": "gaojude",
    "message": "Fix: Build error causes infinite loop on new dev overlay in Turbopack (#75984)\n\n### What?\n\nWhen you enable both Turbopack, and the new dev overlay, you will see\nthat the dev overlay is frozen and the network tab shows that it is\nfetching the stack frames API indefinitely.\n\n### Why?\n\nâ€‹During our migration to the new development overlay, we implemented a\nrefactor to ensure that logic for handling runtime errors is executed\nconsistently, even in the case of build-time errors. This change\ninvolves invoking the getErrorByType function for build errors. However,\nthis function attempts to retrieve stack frames for the build-time\nerror, inadvertently triggering Turbopack to initiate a rebuild.\n\nOnce Turbopack completes the rebuild process, it dispatches a Hot Module\nReplacement (HMR) event to indicate the presence of a new error. This\nevent prompts getErrorByType to attempt fetching the stack frames again,\nwhich in turn causes Turbopack to rebuild once more. This creates an\nendless loop of rebuilding and error signaling.\n\nYou can repro it by running\n```\n__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY='true' TURBOPACK=1 pnpm testonly-dev test/development/acceptance-app/editor-links.test.ts\n```\nwith the test file change in this PR. (Important to add that. Otherwise\nthe test would still complete successfully)\n\n### How?\n\nDo not run the runtime error logic for build errors.\n\n\nCloses NDX-816",
    "sha": "785e9660d47471d8585efad22de34813dd05b886",
    "files": [
        {
            "sha": "2890713f9b7b9c23a617604bb0375cef2426936b",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/app/react-dev-overlay.tsx",
            "status": "modified",
            "additions": 21,
            "deletions": 21,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fapp%2Freact-dev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fapp%2Freact-dev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fapp%2Freact-dev-overlay.tsx?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -10,7 +10,7 @@ import { CssReset } from '../internal/styles/css-reset'\n import { Colors } from '../internal/styles/colors'\n import { ErrorOverlay } from '../internal/components/errors/error-overlay/error-overlay'\n import { DevToolsIndicator } from '../internal/components/errors/dev-tools-indicator/dev-tools-indicator'\n-import { useErrorHook } from '../internal/container/runtime-error/use-error-hook'\n+import { RenderError } from '../internal/container/runtime-error/render-error'\n \n export default function ReactDevOverlay({\n   state,\n@@ -21,15 +21,7 @@ export default function ReactDevOverlay({\n   globalError: [GlobalErrorComponent, React.ReactNode]\n   children: React.ReactNode\n }) {\n-  const [_isErrorOverlayOpen, setIsErrorOverlayOpen] = useState(false)\n-  const { readyErrors, totalErrorCount } = useErrorHook({\n-    state,\n-    isAppDir: true,\n-  })\n-\n-  // Build errors cannot be dismissed. If one is triggered, we ignore the\n-  // user's preference and open the error overlay.\n-  const isErrorOverlayOpen = Boolean(state.buildError) || _isErrorOverlayOpen\n+  const [isErrorOverlayOpen, setIsErrorOverlayOpen] = useState(false)\n \n   const devOverlay = (\n     <ShadowPortal>\n@@ -38,18 +30,26 @@ export default function ReactDevOverlay({\n       <Colors />\n       <ComponentStyles />\n \n-      <DevToolsIndicator\n-        state={state}\n-        errorCount={totalErrorCount}\n-        setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-      />\n+      <RenderError state={state} isAppDir={true}>\n+        {({ readyErrors, totalErrorCount }) => {\n+          return (\n+            <>\n+              <DevToolsIndicator\n+                state={state}\n+                errorCount={totalErrorCount}\n+                setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+              />\n \n-      <ErrorOverlay\n-        state={state}\n-        readyErrors={readyErrors}\n-        isErrorOverlayOpen={isErrorOverlayOpen}\n-        setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-      />\n+              <ErrorOverlay\n+                state={state}\n+                readyErrors={readyErrors}\n+                isErrorOverlayOpen={isErrorOverlayOpen}\n+                setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+              />\n+            </>\n+          )\n+        }}\n+      </RenderError>\n     </ShadowPortal>\n   )\n "
        },
        {
            "sha": "ae9d99357b15f41b778cb62fa0614c22e2823b04",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/internal/components/errors/dev-tools-indicator/internal/next-logo.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Finternal%2Fnext-logo.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Finternal%2Fnext-logo.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Finternal%2Fnext-logo.tsx?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -509,7 +509,13 @@ function useMeasureWidth(ref: React.RefObject<HTMLDivElement | null>) {\n \n function NextMark({ isLoading }: { isLoading?: boolean }) {\n   return (\n-    <svg width=\"40\" height=\"40\" viewBox=\"0 0 40 40\" fill=\"none\">\n+    <svg\n+      width=\"40\"\n+      height=\"40\"\n+      viewBox=\"0 0 40 40\"\n+      fill=\"none\"\n+      data-next-mark-loading={isLoading}\n+    >\n       <g transform=\"translate(8.5, 13)\">\n         <path\n           className={isLoading ? 'path0' : 'paused'}"
        },
        {
            "sha": "492f9a52c13ec42a60ca90b2fe3a3d8726c190a6",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/internal/components/errors/error-overlay/error-overlay.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Ferror-overlay%2Ferror-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Ferror-overlay%2Ferror-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcomponents%2Ferrors%2Ferror-overlay%2Ferror-overlay.tsx?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -44,15 +44,22 @@ export function ErrorOverlay({\n     return (\n       <RootLayoutMissingTagsError\n         {...commonProps}\n-        // This is a runtime error, forcedly display error overlay\n+        // This is not a runtime error, forcedly display error overlay\n         rendered\n         missingTags={state.rootLayoutMissingTags}\n       />\n     )\n   }\n \n   if (state.buildError !== null) {\n-    return <BuildError {...commonProps} message={state.buildError} />\n+    return (\n+      <BuildError\n+        {...commonProps}\n+        message={state.buildError}\n+        // This is not a runtime error, forcedly display error overlay\n+        rendered\n+      />\n+    )\n   }\n \n   // No Runtime Errors."
        },
        {
            "sha": "530dcd2db83262d378adc778c3c1fd1bd5a8682a",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/internal/container/runtime-error/render-error.tsx",
            "status": "renamed",
            "additions": 32,
            "deletions": 18,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Finternal%2Fcontainer%2Fruntime-error%2Frender-error.tsx?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -30,18 +30,34 @@ function getErrorSignature(ev: SupportedErrorEvent): string {\n   }\n }\n \n-export function useErrorHook({\n-  state,\n-  isAppDir,\n-}: {\n+type Props = {\n+  children: (params: {\n+    readyErrors: ReadyRuntimeError[]\n+    totalErrorCount: number\n+  }) => React.ReactNode\n   state: OverlayState\n   isAppDir: boolean\n-}) {\n-  const { errors, rootLayoutMissingTags, buildError } = state\n+}\n+\n+export const RenderError = (props: Props) => {\n+  const { state } = props\n+  const isBuildError =\n+    !!state.rootLayoutMissingTags?.length || !!state.buildError\n+\n+  if (isBuildError) {\n+    return <RenderBuildError {...props} />\n+  } else {\n+    return <RenderRuntimeError {...props} />\n+  }\n+}\n+\n+const RenderRuntimeError = ({ children, state, isAppDir }: Props) => {\n+  const { errors } = state\n \n   const [lookups, setLookups] = useState<{\n     [eventId: string]: ReadyRuntimeError\n   }>({})\n+\n   const [readyErrors, nextError] = useMemo<\n     [ReadyRuntimeError[], SupportedErrorEvent | null]\n   >(() => {\n@@ -93,16 +109,14 @@ export function useErrorHook({\n     }\n   }, [nextError, isAppDir])\n \n-  return {\n-    readyErrors,\n-    // Total number of errors are based on the priority that\n-    // will be displayed. Since build error and root layout\n-    // missing tags won't be dismissed until resolved, the\n-    // total number of errors may be fixed to their length.\n-    totalErrorCount: rootLayoutMissingTags?.length\n-      ? 1\n-      : !!buildError\n-        ? 1\n-        : readyErrors.length,\n-  }\n+  return children({ readyErrors, totalErrorCount: readyErrors.length })\n+}\n+\n+const RenderBuildError = ({ children }: Props) => {\n+  return children({\n+    readyErrors: [],\n+    // Build errors and missing root layout tags persist until fixed,\n+    // so we can set a fixed error count of 1\n+    totalErrorCount: 1,\n+  })\n }",
            "previous_filename": "packages/next/src/client/components/react-dev-overlay/_experimental/internal/container/runtime-error/use-error-hook.ts"
        },
        {
            "sha": "82572e582f00a01eb0f1bf49d1d0b5b0e80dbe07",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/pages/react-dev-overlay.tsx",
            "status": "modified",
            "additions": 21,
            "deletions": 20,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fpages%2Freact-dev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fpages%2Freact-dev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Fpages%2Freact-dev-overlay.tsx?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -11,7 +11,7 @@ import { usePagesReactDevOverlay } from '../../pages/hooks'\n import { Colors } from '../internal/styles/colors'\n import { ErrorOverlay } from '../internal/components/errors/error-overlay/error-overlay'\n import { DevToolsIndicator } from '../internal/components/errors/dev-tools-indicator/dev-tools-indicator'\n-import { useErrorHook } from '../internal/container/runtime-error/use-error-hook'\n+import { RenderError } from '../internal/container/runtime-error/render-error'\n \n export type ErrorType = 'runtime' | 'build'\n \n@@ -23,11 +23,6 @@ export default function ReactDevOverlay({ children }: ReactDevOverlayProps) {\n   const { state, onComponentError, hasRuntimeErrors, hasBuildError } =\n     usePagesReactDevOverlay()\n \n-  const { readyErrors, totalErrorCount } = useErrorHook({\n-    state,\n-    isAppDir: false,\n-  })\n-\n   const [isErrorOverlayOpen, setIsErrorOverlayOpen] = useState(true)\n \n   return (\n@@ -42,20 +37,26 @@ export default function ReactDevOverlay({ children }: ReactDevOverlayProps) {\n         <Colors />\n         <ComponentStyles />\n \n-        <DevToolsIndicator\n-          state={state}\n-          errorCount={totalErrorCount}\n-          setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-        />\n-\n-        {(hasRuntimeErrors || hasBuildError) && (\n-          <ErrorOverlay\n-            state={state}\n-            readyErrors={readyErrors}\n-            isErrorOverlayOpen={isErrorOverlayOpen}\n-            setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-          />\n-        )}\n+        <RenderError state={state} isAppDir={false}>\n+          {({ readyErrors, totalErrorCount }) => (\n+            <>\n+              <DevToolsIndicator\n+                state={state}\n+                errorCount={totalErrorCount}\n+                setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+              />\n+\n+              {(hasRuntimeErrors || hasBuildError) && (\n+                <ErrorOverlay\n+                  state={state}\n+                  readyErrors={readyErrors}\n+                  isErrorOverlayOpen={isErrorOverlayOpen}\n+                  setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+                />\n+              )}\n+            </>\n+          )}\n+        </RenderError>\n       </ShadowPortal>\n     </>\n   )"
        },
        {
            "sha": "2d8b636080ddfed47f421e52ab8ca5a33ec7a153",
            "filename": "test/development/acceptance-app/editor-links.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/785e9660d47471d8585efad22de34813dd05b886/test%2Fdevelopment%2Facceptance-app%2Feditor-links.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/785e9660d47471d8585efad22de34813dd05b886/test%2Fdevelopment%2Facceptance-app%2Feditor-links.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Feditor-links.test.ts?ref=785e9660d47471d8585efad22de34813dd05b886",
            "patch": "@@ -1,4 +1,4 @@\n-import { check } from 'next-test-utils'\n+import { check, retry } from 'next-test-utils'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n import { createSandbox } from 'development-sandbox'\n@@ -65,6 +65,25 @@ describe('Error overlay - editor links', () => {\n       `\n     )\n \n+    const isNewDevOverlay =\n+      process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY === 'true'\n+\n+    // Ensure the Next Logo is not loading. This is to assert that the build did stop.\n+    if (isNewDevOverlay) {\n+      await retry(async () => {\n+        const loaded = await browser.eval(() => {\n+          return Boolean(\n+            [].slice\n+              .call(document.querySelectorAll('nextjs-portal'))\n+              .find((p) =>\n+                p.shadowRoot.querySelector('[data-next-mark-loading=\"false\"]')\n+              )\n+          )\n+        })\n+        expect(loaded).toBe(true)\n+      })\n+    }\n+\n     await session.assertHasRedbox()\n     await clickSourceFile(browser)\n     await check(() => editorRequestsCount, /1/)"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 110,
        "deletions": 63
    }
}