{
    "author": "eps1lon",
    "message": "[sourcemaps] Stop sending stackframes in third-party chunks (#81344)",
    "sha": "df2c2a8cf0b7287bed517153db5758d365b95c6c",
    "files": [
        {
            "sha": "a53d1ec586fe320e12dddd88ae844bec625837cd",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 57,
            "deletions": 6,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -633,6 +633,11 @@ async function generateDynamicFlightRenderResult(\n     )\n   }\n \n+  const filterStackFrame =\n+    process.env.NODE_ENV !== 'production'\n+      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+          .filterStackFrameDEV\n+      : undefined\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   const flightReadableStream = workUnitAsyncStorage.run(\n@@ -643,6 +648,7 @@ async function generateDynamicFlightRenderResult(\n     {\n       onError,\n       temporaryReferences: options?.temporaryReferences,\n+      filterStackFrame,\n     }\n   )\n \n@@ -734,6 +740,11 @@ async function warmupDevRender(\n     ctx\n   )\n \n+  const filterStackFrame =\n+    process.env.NODE_ENV !== 'production'\n+      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+          .filterStackFrameDEV\n+      : undefined\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   workUnitAsyncStorage.run(\n@@ -742,6 +753,7 @@ async function warmupDevRender(\n     rscPayload,\n     clientReferenceManifest.clientModules,\n     {\n+      filterStackFrame,\n       onError,\n       signal: renderController.signal,\n     }\n@@ -1865,6 +1877,11 @@ async function renderToStream(\n   const setHeader = res.setHeader.bind(res)\n   const appendHeader = res.appendHeader.bind(res)\n \n+  const filterStackFrame =\n+    process.env.NODE_ENV !== 'production'\n+      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+          .filterStackFrameDEV\n+      : undefined\n   try {\n     if (\n       // We only want this behavior when running `next dev`\n@@ -1902,12 +1919,7 @@ async function renderToStream(\n               onError: serverComponentsErrorHandler,\n               environmentName: () =>\n                 requestStore.prerenderPhase === true ? 'Prerender' : 'Server',\n-              filterStackFrame(url: string, _functionName: string): boolean {\n-                // The default implementation filters out <anonymous> stack frames\n-                // but we want to retain them because current Server Components and\n-                // built-in Components in parent stacks don't have source location.\n-                return !url.startsWith('node:') && !url.includes('node_modules')\n-              },\n+              filterStackFrame,\n             }\n           )\n         },\n@@ -1943,6 +1955,7 @@ async function renderToStream(\n           RSCPayload,\n           clientReferenceManifest.clientModules,\n           {\n+            filterStackFrame,\n             onError: serverComponentsErrorHandler,\n           }\n         )\n@@ -2161,6 +2174,7 @@ async function renderToStream(\n       errorRSCPayload,\n       clientReferenceManifest.clientModules,\n       {\n+        filterStackFrame,\n         onError: serverComponentsErrorHandler,\n       }\n     )\n@@ -2354,12 +2368,18 @@ async function spawnDynamicValidationInDev(\n     isNotFound\n   )\n \n+  const filterStackFrame =\n+    process.env.NODE_ENV !== 'production'\n+      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+          .filterStackFrameDEV\n+      : undefined\n   const pendingInitialServerResult = workUnitAsyncStorage.run(\n     initialServerPrerenderStore,\n     ComponentMod.prerender,\n     initialServerPayload,\n     clientReferenceManifest.clientModules,\n     {\n+      filterStackFrame,\n       onError: (err) => {\n         const digest = getDigestForWellKnownError(err)\n \n@@ -2561,6 +2581,7 @@ async function spawnDynamicValidationInDev(\n     ctx,\n     isNotFound\n   )\n+\n   const reactServerResult = await createReactServerPrerenderResult(\n     prerenderAndAbortInSequentialTasks(\n       async () => {\n@@ -2573,6 +2594,7 @@ async function spawnDynamicValidationInDev(\n           finalAttemptRSCPayload,\n           clientReferenceManifest.clientModules,\n           {\n+            filterStackFrame,\n             onError: (err: unknown) => {\n               if (\n                 finalServerController.signal.aborted &&\n@@ -2982,12 +3004,19 @@ async function prerenderToStream(\n         res.statusCode === 404\n       )\n \n+      const filterStackFrame =\n+        process.env.NODE_ENV !== 'production'\n+          ? (\n+              require('../lib/source-maps') as typeof import('../lib/source-maps')\n+            ).filterStackFrameDEV\n+          : undefined\n       const pendingInitialServerResult = workUnitAsyncStorage.run(\n         initialServerPrerenderStore,\n         ComponentMod.prerender,\n         initialServerPayload,\n         clientReferenceManifest.clientModules,\n         {\n+          filterStackFrame,\n           onError: (err) => {\n             const digest = getDigestForWellKnownError(err)\n \n@@ -3196,6 +3225,7 @@ async function prerenderToStream(\n                 finalAttemptRSCPayload,\n                 clientReferenceManifest.clientModules,\n                 {\n+                  filterStackFrame,\n                   onError: (err: unknown) => {\n                     return serverComponentsErrorHandler(err)\n                   },\n@@ -3464,6 +3494,12 @@ async function prerenderToStream(\n         ctx,\n         res.statusCode === 404\n       )\n+      const filterStackFrame =\n+        process.env.NODE_ENV !== 'production'\n+          ? (\n+              require('../lib/source-maps') as typeof import('../lib/source-maps')\n+            ).filterStackFrameDEV\n+          : undefined\n       const reactServerResult = (reactServerPrerenderResult =\n         await createReactServerPrerenderResultFromRender(\n           workUnitAsyncStorage.run(\n@@ -3473,6 +3509,7 @@ async function prerenderToStream(\n             RSCPayload,\n             clientReferenceManifest.clientModules,\n             {\n+              filterStackFrame,\n               onError: serverComponentsErrorHandler,\n             }\n           )\n@@ -3692,6 +3729,13 @@ async function prerenderToStream(\n         ctx,\n         res.statusCode === 404\n       )\n+\n+      const filterStackFrame =\n+        process.env.NODE_ENV !== 'production'\n+          ? (\n+              require('../lib/source-maps') as typeof import('../lib/source-maps')\n+            ).filterStackFrameDEV\n+          : undefined\n       const reactServerResult = (reactServerPrerenderResult =\n         await createReactServerPrerenderResultFromRender(\n           workUnitAsyncStorage.run(\n@@ -3700,6 +3744,7 @@ async function prerenderToStream(\n             RSCPayload,\n             clientReferenceManifest.clientModules,\n             {\n+              filterStackFrame,\n               onError: serverComponentsErrorHandler,\n             }\n           )\n@@ -3864,12 +3909,18 @@ async function prerenderToStream(\n       errorType\n     )\n \n+    const filterStackFrame =\n+      process.env.NODE_ENV !== 'production'\n+        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+            .filterStackFrameDEV\n+        : undefined\n     const errorServerStream = workUnitAsyncStorage.run(\n       prerenderLegacyStore,\n       ComponentMod.renderToReadableStream,\n       errorRSCPayload,\n       clientReferenceManifest.clientModules,\n       {\n+        filterStackFrame,\n         onError: serverComponentsErrorHandler,\n       }\n     )"
        },
        {
            "sha": "561cbe4a2401e832f0430d5076147e6dea70781a",
            "filename": "packages/next/src/server/app-render/encryption.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -141,9 +141,16 @@ export const encryptActionBoundArgs = React.cache(\n       })\n     }\n \n+    const filterStackFrame =\n+      process.env.NODE_ENV !== 'production'\n+        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+            .filterStackFrameDEV\n+        : undefined\n+\n     // Using Flight to serialize the args into a string.\n     const serialized = await streamToString(\n       renderToReadableStream(args, clientModules, {\n+        filterStackFrame,\n         signal: hangingInputAbortSignal,\n         onError(err) {\n           if (hangingInputAbortSignal?.aborted) {"
        },
        {
            "sha": "94f0d7884b21f4375acb05a59190712df78c561e",
            "filename": "packages/next/src/server/lib/source-maps.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 4,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -1,3 +1,9 @@\n+// Edge runtime does not implement `module`\n+const findSourceMap =\n+  process.env.NEXT_RUNTIME === 'edge'\n+    ? () => undefined\n+    : (require('module') as typeof import('module')).findSourceMap\n+\n /**\n  * https://tc39.es/source-map/#index-map\n  */\n@@ -48,8 +54,8 @@ export function sourceMapIgnoreListsEverything(\n  * Equal to the input unless an Index Source Map is used.\n  */\n export function findApplicableSourceMapPayload(\n-  line: number,\n-  column: number,\n+  line0: number,\n+  column0: number,\n   payload: ModernSourceMapPayload\n ): BasicSourceMapPayload | undefined {\n   if ('sections' in payload) {\n@@ -71,8 +77,8 @@ export function findApplicableSourceMapPayload(\n       const offset = section.offset\n \n       if (\n-        offset.line < line ||\n-        (offset.line === line && offset.column <= column)\n+        offset.line < line0 ||\n+        (offset.line === line0 && offset.column <= column0)\n       ) {\n         result = section\n         left = middle + 1\n@@ -86,3 +92,67 @@ export function findApplicableSourceMapPayload(\n     return payload\n   }\n }\n+\n+const didWarnAboutInvalidSourceMapDEV = new Set<string>()\n+\n+export function filterStackFrameDEV(\n+  sourceURL: string,\n+  functionName: string,\n+  line1: number,\n+  column1: number\n+): boolean {\n+  if (sourceURL === '') {\n+    // The default implementation filters out <anonymous> stack frames\n+    // but we want to retain them because current Server Components and\n+    // built-in Components in parent stacks don't have source location.\n+    // Filter out frames that show up in Promises to get good names in React's\n+    // Server Request track until we come up with a better heuristic.\n+    return (\n+      functionName !== 'new Promise' &&\n+      functionName !== 'Promise.then' &&\n+      functionName !== 'Promise.catch' &&\n+      functionName !== 'Promise.finally' &&\n+      functionName !== 'Function.withResolvers' &&\n+      functionName !== 'Function.all' &&\n+      functionName !== 'Function.allSettled'\n+    )\n+  }\n+  if (sourceURL.startsWith('node:') || sourceURL.includes('node_modules')) {\n+    return false\n+  }\n+  try {\n+    // Node.js loads source maps eagerly so this call is cheap.\n+    // TODO: ESM sourcemaps are O(1) but CommonJS sourcemaps are O(Number of CJS modules).\n+    // Make sure this doesn't adversely affect performance when CJS is used by Next.js.\n+    const sourceMap = findSourceMap(sourceURL)\n+    if (sourceMap === undefined) {\n+      // No source map assoicated.\n+      // TODO: Node.js types should reflect that `findSourceMap` can return `undefined`.\n+      return true\n+    }\n+    const sourceMapPayload = findApplicableSourceMapPayload(\n+      line1 - 1,\n+      column1 - 1,\n+      sourceMap.payload\n+    )\n+    if (sourceMapPayload === undefined) {\n+      // No source map section applicable to the frame.\n+      return true\n+    }\n+    return !sourceMapIgnoreListsEverything(sourceMapPayload)\n+  } catch (cause) {\n+    if (process.env.NODE_ENV !== 'production') {\n+      // TODO: Share cache with patch-error-inspect\n+      if (!didWarnAboutInvalidSourceMapDEV.has(sourceURL)) {\n+        didWarnAboutInvalidSourceMapDEV.add(sourceURL)\n+        // We should not log an actual error instance here because that will re-enter\n+        // this codepath during error inspection and could lead to infinite recursion.\n+        console.error(\n+          `${sourceURL}: Invalid source map. Only conformant source maps can be used to filter stack frames. Cause: ${cause}`\n+        )\n+      }\n+    }\n+\n+    return true\n+  }\n+}"
        },
        {
            "sha": "db334a3a2169551846edd33ae22c54d347a90cd7",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -490,11 +490,18 @@ async function generateCacheEntryImpl(\n       stream = prelude\n     }\n   } else {\n+    const filterStackFrame =\n+      process.env.NODE_ENV !== 'production'\n+        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+            .filterStackFrameDEV\n+        : undefined\n+\n     stream = renderToReadableStream(\n       resultPromise,\n       clientReferenceManifest.clientModules,\n       {\n         environmentName: 'Cache',\n+        filterStackFrame,\n         temporaryReferences,\n         onError: handleError,\n       }"
        },
        {
            "sha": "fde19a5366e422e37a757ba8648a59602d3c5cfc",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -141,7 +141,12 @@ declare module 'react-server-dom-webpack/server.edge' {\n     options?: {\n       temporaryReferences?: TemporaryReferenceSet\n       environmentName?: string | (() => string)\n-      filterStackFrame?: (url: string, functionName: string) => boolean\n+      filterStackFrame?: (\n+        url: string,\n+        functionName: string,\n+        lineNumber: number,\n+        columnNumber: number\n+      ) => boolean\n       onError?: (error: unknown) => void\n       onPostpone?: (reason: string) => void\n       signal?: AbortSignal\n@@ -262,7 +267,12 @@ declare module 'react-server-dom-webpack/static' {\n     },\n     options?: {\n       environmentName?: string | (() => string)\n-      filterStackFrame?: (url: string, functionName: string) => boolean\n+      filterStackFrame?: (\n+        url: string,\n+        functionName: string,\n+        lineNumber: number,\n+        columnNumber: number\n+      ) => boolean\n       identifierPrefix?: string\n       signal?: AbortSignal\n       temporaryReferences?: TemporaryReferenceSet"
        },
        {
            "sha": "188cd3dd1799684847e9a0642966bdf213f60e7e",
            "filename": "test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -41,6 +41,7 @@ describe('Dynamic IO Dev Errors', () => {\n \n     await browser.elementByCss(\"[href='/error']\").click()\n \n+    // TODO: React should not include the anon stack in the Owner Stack.\n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"description\": \"Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n@@ -51,6 +52,7 @@ describe('Dynamic IO Dev Errors', () => {\n          |                       ^\",\n        \"stack\": [\n          \"Page app/error/page.tsx (2:23)\",\n+         \"Page <anonymous>\",\n          \"LogSafely <anonymous>\",\n        ],\n      }"
        },
        {
            "sha": "4b6b351edb80dd9ec2911ebe01229f6f50c332d4",
            "filename": "test/development/app-dir/owner-stack-react-missing-key-prop/owner-stack-react-missing-key-prop.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Fowner-stack-react-missing-key-prop%2Fowner-stack-react-missing-key-prop.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Fowner-stack-react-missing-key-prop%2Fowner-stack-react-missing-key-prop.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fowner-stack-react-missing-key-prop%2Fowner-stack-react-missing-key-prop.test.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -19,10 +19,11 @@ describe('app-dir - owner-stack-react-missing-key-prop', () => {\n \n     if (isTurbopack) {\n       expect(stackFramesContent).toMatchInlineSnapshot(`\n-         \"at span ()\n-         at <anonymous> (app/rsc/page.tsx (7:9))\n-         at Page (app/rsc/page.tsx (6:13))\"\n-        `)\n+       \"at span ()\n+       at <anonymous> (app/rsc/page.tsx (7:9))\n+       at Array.map ()\n+       at Page (app/rsc/page.tsx (6:13))\"\n+      `)\n       expect(source).toMatchInlineSnapshot(`\n          \"app/rsc/page.tsx (7:9) @ <anonymous>\n \n@@ -36,10 +37,11 @@ describe('app-dir - owner-stack-react-missing-key-prop', () => {\n         `)\n     } else {\n       expect(stackFramesContent).toMatchInlineSnapshot(`\n-         \"at span ()\n-         at eval (app/rsc/page.tsx (7:9))\n-         at Page (app/rsc/page.tsx (6:13))\"\n-        `)\n+       \"at span ()\n+       at eval (app/rsc/page.tsx (7:9))\n+       at Array.map ()\n+       at Page (app/rsc/page.tsx (6:13))\"\n+      `)\n       expect(source).toMatchInlineSnapshot(`\n           \"app/rsc/page.tsx (7:9) @ eval\n "
        },
        {
            "sha": "2bb12d944d0efacc1ef5b361040ff2be821e0afb",
            "filename": "test/development/app-dir/react-performance-track/app/ReactServerRequests.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -11,7 +11,7 @@ const ServerRequestsStore = {\n   getSnapshot:\n     typeof window === 'undefined'\n       ? () => []\n-      : window.reactServerRequests.getSnapshot,\n+      : window.reactServerRequests.getStoreSnapshot,\n   getServerSnapshot: () => reactServerRequestsServerSnapshot,\n }\n \n@@ -30,7 +30,11 @@ export function ReactServerRequests() {\n           <li key={index}>\n             <details>\n               <summary>\n-                <strong>{request.name}</strong>\n+                <strong>\n+                  {request.type}: {request.name || '<Unnamed>'}\n+                </strong>\n+                ({Math.round(request.startTime)}ms–\n+                {Math.round(request.endTime)}ms)\n               </summary>\n               <pre>{JSON.stringify(request.properties, null, 2)}</pre>\n             </details>"
        },
        {
            "sha": "8eaa498120dff23349d76ea7e20a2470e504219a",
            "filename": "test/development/app-dir/react-performance-track/app/fetch/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Ffetch%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Ffetch%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Ffetch%2Fpage.tsx?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -1,16 +1,10 @@\n async function abstraction() {\n-  const response = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/random'\n-  )\n-  await response.json()\n+  await fetch('https://next-data-api-endpoint.vercel.app/api/random')\n }\n \n export default async function FetchPage() {\n   await abstraction()\n-  const response = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/random'\n-  )\n-  await response.json()\n+  await fetch('https://next-data-api-endpoint.vercel.app/api/random')\n \n   return <p>Done</p>\n }"
        },
        {
            "sha": "c56781457ca0ea798d17ab1b0129cc543d96b3d1",
            "filename": "test/development/app-dir/react-performance-track/instrumentation-client.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 1,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -1,14 +1,21 @@\n export {}\n \n type ReactServerRequests = Array<{\n+  type: 'performance' | 'console'\n   name: string\n   properties: any\n+  startTime: number\n+  endTime: number\n }>\n \n declare global {\n   interface Window {\n     reactServerRequests: {\n-      getSnapshot(): ReactServerRequests\n+      /** For tests */\n+      getSnapshot: () => Array<\n+        Omit<ReactServerRequests[number], 'startTime' | 'endTime' | 'type'>\n+      >\n+      getStoreSnapshot(): ReactServerRequests\n       subscribe(callback: () => void): () => void\n     }\n   }\n@@ -25,6 +32,19 @@ const listeners = new Set<() => void>()\n // Assertions should happen on `getSnapshot` not on the UI.\n window.reactServerRequests = {\n   getSnapshot: () => {\n+    return reactServerRequests\n+      .filter((request) => {\n+        const isRegisterTrackRequest =\n+          request.type === 'console' &&\n+          request.name === undefined &&\n+          request.startTime === 0.001 &&\n+          request.endTime === 0.001\n+\n+        return !isRegisterTrackRequest\n+      })\n+      .map(({ startTime, endTime, type, ...rest }) => rest)\n+  },\n+  getStoreSnapshot: () => {\n     return reactServerRequests\n   },\n   subscribe: (callback) => {\n@@ -35,6 +55,31 @@ window.reactServerRequests = {\n   },\n }\n \n+let registeredServerRequestsTrack = false\n+\n+const originalConsoleTimeStamp = console.timeStamp\n+console.timeStamp = (...args: any) => {\n+  originalConsoleTimeStamp.apply(console, args)\n+  const [_entryName, startTime, endTime, track, name] = args\n+\n+  if (track === 'Server Requests ⚛') {\n+    // React will always call one console.timeStamp to register the track in Chrome's performance panel.\n+    if (registeredServerRequestsTrack) {\n+      reactServerRequests.push({\n+        type: 'console',\n+        name: name ?? '',\n+        properties: [],\n+        startTime,\n+        endTime,\n+      })\n+      for (const listener of listeners) {\n+        listener()\n+      }\n+    }\n+    registeredServerRequestsTrack = true\n+  }\n+}\n+\n // We're trying to mock how the Chrome DevTools performance panel will display\n // React performance data. React might decide to use console.timeStamp instead\n // or any other method that will be picked up by the performance panel so this\n@@ -45,8 +90,11 @@ new PerformanceObserver((entries) => {\n   for (const entry of entries.getEntries()) {\n     if (entry.detail?.devtools?.track === 'Server Requests ⚛') {\n       newRequests.push({\n+        type: 'performance',\n         name: entry.name,\n         properties: entry.detail.devtools.properties,\n+        startTime: entry.startTime,\n+        endTime: entry.startTime + entry.duration,\n       })\n     }\n   }"
        },
        {
            "sha": "4e6dc85fcdc64f894a97cc4c1f23e89a5182aca8",
            "filename": "test/development/app-dir/react-performance-track/react-performance-track.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 12,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -1,7 +1,10 @@\n import { nextTestSetup } from 'e2e-utils'\n \n+// Entries are flaky in CI. Without a name and without being able to repro locally,\n+// it's impossible to fix. Deactivating while we iterate on the track.\n+// It's still useful as a fixture.\n describe('react-performance-track', () => {\n-  const { isTurbopack, next } = nextTestSetup({\n+  const { next } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -10,23 +13,27 @@ describe('react-performance-track', () => {\n     await browser.elementByCss('[data-react-server-requests-done]')\n \n     const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n-    expect(track).toEqual([\n-      { name: 'setTimeout', properties: [] },\n-      { name: 'setTimeout', properties: [] },\n-    ])\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        { name: 'setTimeout', properties: [] },\n+        { name: 'setTimeout', properties: [] },\n+      ])\n+    )\n   })\n \n   it('should show fetch', async () => {\n     const browser = await next.browser('/fetch')\n     await browser.elementByCss('[data-react-server-requests-done]')\n \n     const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n-    expect(track).toEqual([\n-      {\n-        // TODO(veil): Should always be `fetch (random)`\n-        name: isTurbopack ? 'fetch (random)' : 'fetch',\n-        properties: expect.arrayContaining([['status', '200']]),\n-      },\n-    ])\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        {\n+          // TODO: Should include the URL.\n+          name: 'fetch',\n+          properties: expect.arrayContaining([['status', '200']]),\n+        },\n+      ])\n+    )\n   })\n })"
        },
        {
            "sha": "d4a86b06e073019e2e53bb06c735b439338e309a",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df2c2a8cf0b7287bed517153db5758d365b95c6c/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=df2c2a8cf0b7287bed517153db5758d365b95c6c",
            "patch": "@@ -408,11 +408,12 @@ describe('app-dir - server source maps', () => {\n         )\n         // Expect the invalid sourcemap warning only once per render.\n         // Dynamic I/O renders three times.\n+        // One from filterStackFrameDEV.\n         expect(\n           normalizeCliOutput(next.cliOutput.slice(outputIndex)).split(\n             'Invalid source map.'\n           ).length - 1\n-        ).toEqual(3)\n+        ).toEqual(4)\n       }\n     } else {\n       // Bundlers silently drop invalid sourcemaps.\n@@ -494,8 +495,6 @@ describe('app-dir - server source maps', () => {\n              \"<FIXME-file-protocol>\",\n              \"eval rsc:/Prerender/webpack-internal:///(rsc)/app/module-evaluation/page.js (5:65)\",\n              \"<FIXME-file-protocol>\",\n-             \"Function.all <anonymous>\",\n-             \"Function.all <anonymous>\",\n              \"Page <anonymous>\",\n            ],\n          }"
        }
    ],
    "stats": {
        "total": 293,
        "additions": 247,
        "deletions": 46
    }
}