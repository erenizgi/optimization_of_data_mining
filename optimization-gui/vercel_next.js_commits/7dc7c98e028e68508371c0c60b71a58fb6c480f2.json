{
    "author": "ztanner",
    "message": "fix dynamic param extraction in edge-ssr-app (#83081)\n\nFixes edge runtime pages with dynamic routes returning 500 errors when\nthe URL segment literally contains bracket syntax that matches the\nfolder name (e.g., accessing `/[id]` for a route defined as\n`/[id]/page.tsx`).\n\nThe removal of web-server.ts in #81389 modified how route params were\nextracted for dynamic routes. The route matcher in prepare() was being\ncreated with the full internal page path (e.g., /[id]/page) which\ngenerated a regex expecting /page at the end. However, actual URL\npathnames don't include the /page suffix, causing the matcher to fail\nwhen trying to extract params. This issue specifically manifested when\nthe URL contained literal brackets (like /[id]), as the fallback param\nextraction would fail and leave params empty, leading to the error.\n\nThis PR normalizes the page path using before creating the route matcher\nin prepare(). This ensures the regex pattern matches the actual URL\npathname format (without /page suffix).\n\nFixes NEXT-4698",
    "sha": "7dc7c98e028e68508371c0c60b71a58fb6c480f2",
    "files": [
        {
            "sha": "635837ec9f7a4405d5c2c6be28bceeb16b52c2ce",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/7dc7c98e028e68508371c0c60b71a58fb6c480f2/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7dc7c98e028e68508371c0c60b71a58fb6c480f2/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=7dc7c98e028e68508371c0c60b71a58fb6c480f2",
            "patch": "@@ -598,8 +598,13 @@ export abstract class RouteModule<\n       }\n     }\n \n+    // Normalize the page path for route matching. The srcPage contains the\n+    // internal page path (e.g., /app/[slug]/page), but route matchers expect\n+    // the pathname format (e.g., /app/[slug]).\n+    const normalizedSrcPage = normalizeAppPath(srcPage)\n+\n     const serverUtils = getServerUtils({\n-      page: srcPage,\n+      page: normalizedSrcPage,\n       i18n,\n       basePath,\n       rewrites,\n@@ -807,7 +812,6 @@ export abstract class RouteModule<\n     const nextConfig =\n       routerServerContext?.nextConfig || serverFilesManifest.config\n \n-    const normalizedSrcPage = normalizeAppPath(srcPage)\n     let resolvedPathname =\n       getRequestMeta(req, 'rewroteURL') || normalizedSrcPage\n "
        },
        {
            "sha": "b3c6bf14fa1e90b6638dad631059ff3a9b9ea64d",
            "filename": "test/e2e/app-dir/rsc-basic/app/node/dynamic/[id]/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2F%5Bid%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2F%5Bid%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2F%5Bid%5D%2Fpage.js?ref=7dc7c98e028e68508371c0c60b71a58fb6c480f2",
            "patch": "@@ -0,0 +1,3 @@\n+export default function page() {\n+  return 'dynamic route [id] page'\n+}"
        },
        {
            "sha": "746462edd06c9a33b239b5320d2a3296d1ffee00",
            "filename": "test/e2e/app-dir/rsc-basic/app/node/dynamic/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Fapp%2Fnode%2Fdynamic%2Fpage.js?ref=7dc7c98e028e68508371c0c60b71a58fb6c480f2",
            "patch": "@@ -0,0 +1,3 @@\n+export default function page() {\n+  return 'dynamic route index page'\n+}"
        },
        {
            "sha": "fd9fdfc88b8a8bb85c27804f4608b5d95b04d2fd",
            "filename": "test/e2e/app-dir/rsc-basic/rsc-basic.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7dc7c98e028e68508371c0c60b71a58fb6c480f2/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts?ref=7dc7c98e028e68508371c0c60b71a58fb6c480f2",
            "patch": "@@ -382,6 +382,15 @@ describe('app dir - rsc basics', () => {\n     expect(dynamicRouteUrl).toBe(`${next.url}/edge/dynamic/123`)\n   })\n \n+  describe.each(['node', 'edge'])(`%s`, (runtime) => {\n+    it('should handle dynamic routes when URL segment matches the folder bracket syntax', async () => {\n+      const browser = await next.browser(`/${runtime}/dynamic/[id]`)\n+      expect(await browser.elementByCss('body').text()).toBe(\n+        'dynamic route [id] page'\n+      )\n+    })\n+  })\n+\n   it('should support streaming for flight response', async () => {\n     await next\n       .fetch(`/?${NEXT_RSC_UNION_QUERY}`, {"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 21,
        "deletions": 2
    }
}