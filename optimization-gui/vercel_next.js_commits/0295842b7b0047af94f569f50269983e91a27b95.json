{
    "author": "devjiwonchoi",
    "message": "Update next-lint-to-eslint-cli to support `FlatCompat.config` (#85026)\n\nESLint `FlatCompat` can be used in two ways:\n\n```js\ncompat.extends('next/core-web-vitals', 'next/typescript')\n```\n\n```js\ncompat.config({\n  extends: ['next/core-web-vitals', 'next/typescript'],\n})\n```\n\nAlthough using `.extends()` is recommended for migration, and the ESLint\nmigration tool also uses that, it is possible to use `.config()`, so\nhandle them as well for the migration.\n\nConfirmed on local apps as well.",
    "sha": "0295842b7b0047af94f569f50269983e91a27b95",
    "files": [
        {
            "sha": "c6d3f2b90d3a48fa810c4a2499fa9934afba2827",
            "filename": "packages/next-codemod/transforms/__testfixtures__/next-lint-to-eslint-cli/flat-config-flat-compat-with-other-compat/eslint.config.mjs",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Feslint.config.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Feslint.config.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Feslint.config.mjs?ref=0295842b7b0047af94f569f50269983e91a27b95",
            "patch": "@@ -0,0 +1,30 @@\n+import { dirname } from 'path'\n+import { fileURLToPath } from 'url'\n+import { FlatCompat } from '@eslint/eslintrc'\n+\n+const __filename = fileURLToPath(import.meta.url)\n+const __dirname = dirname(__filename)\n+\n+const compat = new FlatCompat({\n+  baseDirectory: __dirname,\n+})\n+\n+const eslintConfig = [\n+  ...compat.config({\n+    extends: ['next/core-web-vitals', 'next/typescript'],\n+  }),\n+  ...compat.config({\n+    extends: ['foo', 'bar'],\n+  }),\n+  {\n+    ignores: [\n+      'node_modules/**',\n+      '.next/**',\n+      'out/**',\n+      'build/**',\n+      'next-env.d.ts',\n+    ],\n+  },\n+]\n+\n+export default eslintConfig"
        },
        {
            "sha": "0c8f6fafba8a7048eddf4b85eb98b0a08f48d12a",
            "filename": "packages/next-codemod/transforms/__testfixtures__/next-lint-to-eslint-cli/flat-config-flat-compat-with-other-compat/package.json",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fnext-lint-to-eslint-cli%2Fflat-config-flat-compat-with-other-compat%2Fpackage.json?ref=0295842b7b0047af94f569f50269983e91a27b95",
            "patch": "@@ -0,0 +1,26 @@\n+{\n+  \"scripts\": {\n+    \"lint\": \"next lint --fix --dir src --dir pages\",\n+    \"lint:strict\": \"next lint --strict\",\n+    \"lint:ci\": \"next lint --quiet --output-file lint-results.json\",\n+    \"precommit\": \"next lint --fix && npm test\",\n+    \"test\": \"jest && next lint\",\n+    \"complex\": \"npm run build && next lint --dir . --ext .js,.jsx,.ts,.tsx 2>/dev/null\",\n+    \"pipe\": \"next lint | tee lint.log\",\n+    \"redirect\": \"next lint > output.txt 2>&1\",\n+    \"multi\": \"next lint; next build; next lint --fix\"\n+  },\n+  \"dependencies\": {\n+    \"react\": \"^19\",\n+    \"react-dom\": \"^19\",\n+    \"next\": \"^16\"\n+  },\n+  \"devDependencies\": {\n+    \"typescript\": \"^5\",\n+    \"@types/node\": \"^20\",\n+    \"@types/react\": \"^19\",\n+    \"@types/react-dom\": \"^19\",\n+    \"eslint\": \"^9\",\n+    \"eslint-config-next\": \"^16\"\n+  }\n+}"
        },
        {
            "sha": "fc5daf84412027c37868daa10182bd807d2b9930",
            "filename": "packages/next-codemod/transforms/__tests__/next-lint-to-eslint-cli.test.js",
            "status": "modified",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fnext-lint-to-eslint-cli.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fnext-lint-to-eslint-cli.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fnext-lint-to-eslint-cli.test.js?ref=0295842b7b0047af94f569f50269983e91a27b95",
            "patch": "@@ -307,6 +307,89 @@ describe('next-lint-to-eslint-cli', () => {\n     })\n   })\n \n+  describe('flat-config-flat-compat-with-other-compat', () => {\n+    it('should replace FlatCompat config with direct imports while preserving other configs', () => {\n+      const testDir = path.join(fixturesDir, 'flat-config-flat-compat-with-other-compat')\n+      // Check BEFORE state\n+      const beforeConfig = fs.readFileSync(\n+        path.join(testDir, 'eslint.config.mjs'),\n+        'utf8'\n+      )\n+\n+      expect(beforeConfig).toMatchInlineSnapshot(`\n+       \"import { dirname } from 'path'\n+       import { fileURLToPath } from 'url'\n+       import { FlatCompat } from '@eslint/eslintrc'\n+\n+       const __filename = fileURLToPath(import.meta.url)\n+       const __dirname = dirname(__filename)\n+\n+       const compat = new FlatCompat({\n+         baseDirectory: __dirname,\n+       })\n+\n+       const eslintConfig = [\n+         ...compat.config({\n+           extends: ['next/core-web-vitals', 'next/typescript'],\n+         }),\n+         ...compat.config({\n+           extends: ['foo', 'bar'],\n+         }),\n+         {\n+           ignores: [\n+             'node_modules/**',\n+             '.next/**',\n+             'out/**',\n+             'build/**',\n+             'next-env.d.ts',\n+           ],\n+         },\n+       ]\n+\n+       export default eslintConfig\n+       \"\n+      `)\n+\n+      // Run transformer\n+      transformer([testDir], { skipInstall: true })\n+\n+      // Check AFTER state\n+      const actualConfig = fs.readFileSync(\n+        path.join(testDir, 'eslint.config.mjs'),\n+        'utf8'\n+      )\n+      expect(actualConfig).toMatchInlineSnapshot(`\n+       \"import nextCoreWebVitals from \"eslint-config-next/core-web-vitals\";\n+       import nextTypescript from \"eslint-config-next/typescript\";\n+       import { dirname } from 'path'\n+       import { fileURLToPath } from 'url'\n+       import { FlatCompat } from '@eslint/eslintrc'\n+\n+       const __filename = fileURLToPath(import.meta.url)\n+       const __dirname = dirname(__filename)\n+\n+       const compat = new FlatCompat({\n+         baseDirectory: __dirname,\n+       })\n+\n+       const eslintConfig = [...nextCoreWebVitals, ...nextTypescript, ...compat.config({\n+         extends: ['foo', 'bar']\n+       }), {\n+         ignores: [\n+           'node_modules/**',\n+           '.next/**',\n+           'out/**',\n+           'build/**',\n+           'next-env.d.ts',\n+         ],\n+       }]\n+\n+       export default eslintConfig\n+       \"\n+      `)\n+    })\n+  })\n+\n   describe('legacy-config', () => {\n     it('should migrate legacy config to flat config and transform package.json', async () => {\n       const testDir = path.join(fixturesDir, 'legacy-config')"
        },
        {
            "sha": "e5d4173889e67bbb6668bf008d95d79f004edf78",
            "filename": "packages/next-codemod/transforms/next-lint-to-eslint-cli.ts",
            "status": "modified",
            "additions": 138,
            "deletions": 0,
            "changes": 138,
            "blob_url": "https://github.com/vercel/next.js/blob/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2Fnext-lint-to-eslint-cli.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0295842b7b0047af94f569f50269983e91a27b95/packages%2Fnext-codemod%2Ftransforms%2Fnext-lint-to-eslint-cli.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2Fnext-lint-to-eslint-cli.ts?ref=0295842b7b0047af94f569f50269983e91a27b95",
            "patch": "@@ -136,6 +136,7 @@ function replaceFlatCompatInConfig(configPath: string): boolean {\n   root.find(j.CallExpression).forEach((astPath) => {\n     const node = astPath.value\n \n+    // Detect compat.extends() calls and identify which configs are being used\n     if (\n       node.callee.type === 'MemberExpression' &&\n       (node.callee as any).object.type === 'Identifier' &&\n@@ -157,6 +158,46 @@ function replaceFlatCompatInConfig(configPath: string): boolean {\n         }\n       })\n     }\n+\n+    // Detect compat.config({ extends: [...] }) calls and identify which configs are being used\n+    if (\n+      node.callee.type === 'MemberExpression' &&\n+      (node.callee as any).object.type === 'Identifier' &&\n+      (node.callee as any).object.name === 'compat' &&\n+      (node.callee as any).property.type === 'Identifier' &&\n+      (node.callee as any).property.name === 'config'\n+    ) {\n+      // Look for extends property in the object argument\n+      node.arguments.forEach((arg: any) => {\n+        if (arg.type === 'ObjectExpression') {\n+          arg.properties?.forEach((prop: any) => {\n+            if (\n+              prop.type === 'ObjectProperty' &&\n+              prop.key.type === 'Identifier' &&\n+              prop.key.name === 'extends' &&\n+              prop.value.type === 'ArrayExpression'\n+            ) {\n+              // Process the extends array\n+              prop.value.elements?.forEach((element: any) => {\n+                if (\n+                  element.type === 'Literal' ||\n+                  element.type === 'StringLiteral'\n+                ) {\n+                  if (element.value === 'next/core-web-vitals') {\n+                    needsNextVitals = true\n+                  } else if (element.value === 'next/typescript') {\n+                    needsNextTs = true\n+                  } else if (typeof element.value === 'string') {\n+                    // Preserve other configs (non-Next.js or other Next.js variants)\n+                    otherConfigs.push(element.value)\n+                  }\n+                }\n+              })\n+            }\n+          })\n+        }\n+      })\n+    }\n   })\n \n   if (!needsNextVitals && !needsNextTs && otherConfigs.length === 0) {\n@@ -258,6 +299,8 @@ function replaceFlatCompatInConfig(configPath: string): boolean {\n   // Replace FlatCompat extends with spread imports\n   root.find(j.SpreadElement).forEach((astPath) => {\n     const node = astPath.value\n+\n+    // Replace spread of compat.extends(...) calls with direct imports\n     if (\n       node.argument.type === 'CallExpression' &&\n       node.argument.callee.type === 'MemberExpression' &&\n@@ -304,6 +347,101 @@ function replaceFlatCompatInConfig(configPath: string): boolean {\n         }\n       }\n     }\n+\n+    // Replace spread of compat.config({ extends: [...] }) calls with direct imports\n+    if (\n+      node.argument.type === 'CallExpression' &&\n+      node.argument.callee.type === 'MemberExpression' &&\n+      node.argument.callee.object.type === 'Identifier' &&\n+      node.argument.callee.object.name === 'compat' &&\n+      node.argument.callee.property.type === 'Identifier' &&\n+      node.argument.callee.property.name === 'config'\n+    ) {\n+      const replacements = []\n+      const preservedConfigs = []\n+\n+      // Process each argument to compat.config\n+      node.argument.arguments.forEach((arg: any) => {\n+        if (arg.type === 'ObjectExpression') {\n+          const updatedProperties = []\n+\n+          arg.properties?.forEach((prop: any) => {\n+            if (\n+              prop.type === 'ObjectProperty' &&\n+              prop.key.type === 'Identifier' &&\n+              prop.key.name === 'extends' &&\n+              prop.value.type === 'ArrayExpression'\n+            ) {\n+              const nonNextConfigs = []\n+\n+              // Process extends array\n+              prop.value.elements?.forEach((element: any) => {\n+                if (\n+                  element.type === 'Literal' ||\n+                  element.type === 'StringLiteral'\n+                ) {\n+                  if (element.value === 'next/core-web-vitals') {\n+                    replacements.push(\n+                      j.spreadElement(j.identifier('nextCoreWebVitals'))\n+                    )\n+                  } else if (element.value === 'next/typescript') {\n+                    replacements.push(\n+                      j.spreadElement(j.identifier('nextTypescript'))\n+                    )\n+                  } else if (typeof element.value === 'string') {\n+                    // Keep non-Next.js configs\n+                    nonNextConfigs.push(element)\n+                  }\n+                }\n+              })\n+\n+              // If there are non-Next.js configs, preserve the extends property with them\n+              if (nonNextConfigs.length > 0) {\n+                updatedProperties.push(\n+                  j.property(\n+                    'init',\n+                    j.identifier('extends'),\n+                    j.arrayExpression(nonNextConfigs)\n+                  )\n+                )\n+              }\n+            } else {\n+              // Preserve other properties (not extends)\n+              updatedProperties.push(prop)\n+            }\n+          })\n+\n+          // If we still have properties to preserve, keep the compat.config call\n+          if (updatedProperties.length > 0) {\n+            preservedConfigs.push(\n+              j.spreadElement(\n+                j.callExpression(\n+                  j.memberExpression(\n+                    j.identifier('compat'),\n+                    j.identifier('config')\n+                  ),\n+                  [j.objectExpression(updatedProperties)]\n+                )\n+              )\n+            )\n+          }\n+        }\n+      })\n+\n+      // Add all replacements\n+      const allReplacements = [...replacements, ...preservedConfigs]\n+\n+      if (allReplacements.length > 0) {\n+        // Replace the current spread element with multiple spread elements\n+        const parent = astPath.parent\n+        if (parent.value.type === 'ArrayExpression') {\n+          const index = parent.value.elements.indexOf(node)\n+          if (index !== -1) {\n+            parent.value.elements.splice(index, 1, ...allReplacements)\n+          }\n+        }\n+      }\n+    }\n   })\n \n   // Also handle the case where extends is used as a property value (not spread)"
        }
    ],
    "stats": {
        "total": 277,
        "additions": 277,
        "deletions": 0
    }
}