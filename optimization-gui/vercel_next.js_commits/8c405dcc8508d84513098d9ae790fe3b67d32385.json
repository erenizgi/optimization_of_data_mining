{
    "author": "sokra",
    "message": "Turbopack: enable content hashing in production (#77775)\n\n### What?\n\nEnable content hashing for the client assets",
    "sha": "8c405dcc8508d84513098d9ae790fe3b67d32385",
    "files": [
        {
            "sha": "a29d2c43ade99e2e5a4f0b2d71cac2d8253d6666",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -14,7 +14,8 @@ use turbopack::{\n     resolve_options_context::ResolveOptionsContext,\n };\n use turbopack_browser::{\n-    react_refresh::assert_can_resolve_react_refresh, BrowserChunkingContext, CurrentChunkMethod,\n+    react_refresh::assert_can_resolve_react_refresh, BrowserChunkingContext, ContentHashing,\n+    CurrentChunkMethod,\n };\n use turbopack_core::{\n     chunk::{\n@@ -486,6 +487,7 @@ pub async fn get_client_chunking_context(\n                 ..Default::default()\n             },\n         );\n+        builder = builder.use_content_hashing(ContentHashing::Direct { length: 16 })\n     }\n \n     Ok(Vc::upcast(builder.build()))"
        },
        {
            "sha": "66d382cfd6935cdfb92bb1c80703070046d4f46f",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -374,7 +374,7 @@ describe('app dir - basic', () => {\n       const html = await next.render('/dashboard/index')\n       expect(html).toMatch(\n         isTurbopack\n-          ? /<script src=\"\\/_next\\/static\\/chunks\\/[\\w-]*polyfill-nomodule\\.js\" noModule=\"\">/\n+          ? /<script src=\"\\/_next\\/static\\/chunks\\/([\\w-]*polyfill-nomodule|[0-9a-f]+)\\.js\" noModule=\"\">/\n           : /<script src=\"\\/_next\\/static\\/chunks\\/polyfills(-\\w+)?\\.js\" noModule=\"\">/\n       )\n     })"
        },
        {
            "sha": "0f701218b76104e8712fbf7946635a82c94c4250",
            "filename": "test/integration/css-minify/test/index.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -25,7 +25,7 @@ function runTests() {\n        \"/* [project]/test/integration/css-minify/styles/global.css [client] (css) */\n        .a{--var-1:-50%;--var-2:-50%}.b{--var-1:0;--var-2:-50%}\n \n-       /*# sourceMappingURL=test_integration_css-minify_styles_global_411632c3.css.map*/\"\n+       /*# sourceMappingURL=5c046e82fcc94f24.css.map*/\"\n       `)\n     } else {\n       expect(css).toMatchInlineSnapshot("
        },
        {
            "sha": "3d63fee30a96c28a96e0e99ed1de13eb68570fec",
            "filename": "test/integration/css/test/basic-global-support.test.js",
            "status": "modified",
            "additions": 38,
            "deletions": 33,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -62,28 +62,28 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_single-global_styles_global_04ffe231.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_single-global_styles_global_04ffe231.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n@@ -146,28 +146,28 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/aa64a_css-fixtures_single-global-special-characters_a%2Bb_styles_global_238bffda.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/aa64a_css-fixtures_single-global-special-characters_a%2Bb_styles_global_238bffda.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n@@ -225,28 +225,28 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_single-global-src_styles_global_3de272ac.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_single-global-src_styles_global_3de272ac.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/e6f86e82ed770205.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}\",\n              ]\n             `)\n@@ -305,7 +305,7 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_multi-global_styles_e0f6ec64._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\n \n \n@@ -315,7 +315,7 @@ module.exports = {\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_multi-global_styles_e0f6ec64._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red}\n \n \n@@ -325,14 +325,14 @@ module.exports = {\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/5e3a80a101f2afdd.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}.blue-text{color:#00f}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/52172921917299d1.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red}.blue-text{color:blue}\",\n              ]\n             `)\n@@ -391,7 +391,7 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_nested-global_styles_613f73a3._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:purple;font-weight:bolder}\n \n \n@@ -407,7 +407,7 @@ module.exports = {\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_nested-global_styles_613f73a3._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:purple;font-weight:bolder}\n \n \n@@ -423,14 +423,14 @@ module.exports = {\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/197173a06644483f.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:purple;font-weight:bolder;color:red}.blue-text{color:orange;font-weight:bolder;color:#00f}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/5fd4808215677a0f.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:purple;font-weight:bolder;color:red}.blue-text{color:orange;font-weight:bolder;color:blue}\",\n              ]\n             `)\n@@ -490,7 +490,7 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_multi-global-reversed_styles_9924990c._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .blue-text{color:#00f}\n \n \n@@ -500,7 +500,7 @@ module.exports = {\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_multi-global-reversed_styles_9924990c._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .blue-text{color:#00f}\n \n \n@@ -510,14 +510,14 @@ module.exports = {\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/67c5003fc41fdadb.css:\n+               \"/_next/static/css/HASH.css:\n              .blue-text{color:#00f}.red-text{color:red}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/f06b052da7bb0328.css:\n+               \"/_next/static/css/HASH.css:\n              .blue-text{color:blue}.red-text{color:red}\",\n              ]\n             `)\n@@ -576,7 +576,7 @@ module.exports = {\n           if (process.env.TURBOPACK && useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_url-global_styles_46281715._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red;background-image:url(../media/dark.993bedd3.svg),url(../media/dark2.993bedd3.svg)}\n \n \n@@ -589,7 +589,7 @@ module.exports = {\n           } else if (process.env.TURBOPACK && !useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/chunks/test_integration_css-fixtures_url-global_styles_46281715._.css:\n+               \"/_next/static/chunks/HASH.css:\n              .red-text{color:red;background-image:url(../media/dark.993bedd3.svg),url(../media/dark2.993bedd3.svg)}\n \n \n@@ -602,14 +602,14 @@ module.exports = {\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/02830b0dd136adeb.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red;background-image:url(/_next/static/media/dark.6b01655b.svg),url(/_next/static/media/dark2.6b01655b.svg)}.blue-text{color:orange;background-image:url(/_next/static/media/light.2da1d3d6.svg);font-weight:bolder;color:#00f}\",\n              ]\n             `)\n           } else {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n-               \"/_next/static/css/bf86b6e30872ca37.css:\n+               \"/_next/static/css/HASH.css:\n              .red-text{color:red;background-image:url(/_next/static/media/dark.6b01655b.svg),url(/_next/static/media/dark2.6b01655b.svg)}.blue-text{color:orange;font-weight:bolder;background-image:url(/_next/static/media/light.2da1d3d6.svg);color:blue}\",\n              ]\n             `)\n@@ -653,7 +653,7 @@ describe('CSS URL via `file-loader` and asset prefix (1)', () => {\n         if (process.env.TURBOPACK) {\n           expect(cssContent).toMatchInlineSnapshot(`\n            [\n-             \"/_next/static/chunks/test_integration_css-fixtures_url-global-asset-prefix-1_styles_e99cb7f8._.css:\n+             \"/_next/static/chunks/HASH.css:\n            .red-text{color:red;background-image:url(../media/dark.993bedd3.svg) url(../media/dark2.993bedd3.svg)}\n \n \n@@ -666,7 +666,7 @@ describe('CSS URL via `file-loader` and asset prefix (1)', () => {\n         } else {\n           expect(cssContent).toMatchInlineSnapshot(`\n            [\n-             \"/_next/static/css/18198e5ba4d54f6f.css:\n+             \"/_next/static/css/HASH.css:\n            .red-text{color:red;background-image:url(/foo/_next/static/media/dark.6b01655b.svg) url(/foo/_next/static/media/dark2.6b01655b.svg)}.blue-text{color:orange;font-weight:bolder;background-image:url(/foo/_next/static/media/light.2da1d3d6.svg);color:blue}\",\n            ]\n           `)\n@@ -709,7 +709,7 @@ describe('CSS URL via `file-loader` and asset prefix (2)', () => {\n         if (process.env.TURBOPACK) {\n           expect(cssContent).toMatchInlineSnapshot(`\n            [\n-             \"/_next/static/chunks/test_integration_css-fixtures_url-global-asset-prefix-2_styles_7b29c72b._.css:\n+             \"/_next/static/chunks/HASH.css:\n            .red-text{color:red;background-image:url(../media/dark.993bedd3.svg) url(../media/dark2.993bedd3.svg)}\n \n \n@@ -722,7 +722,7 @@ describe('CSS URL via `file-loader` and asset prefix (2)', () => {\n         } else {\n           expect(cssContent).toMatchInlineSnapshot(`\n            [\n-             \"/_next/static/css/18198e5ba4d54f6f.css:\n+             \"/_next/static/css/HASH.css:\n            .red-text{color:red;background-image:url(/foo/_next/static/media/dark.6b01655b.svg) url(/foo/_next/static/media/dark2.6b01655b.svg)}.blue-text{color:orange;font-weight:bolder;background-image:url(/foo/_next/static/media/light.2da1d3d6.svg);color:blue}\",\n            ]\n           `)\n@@ -741,7 +741,12 @@ async function getStylesheetContents($, appPort, items) {\n     if (res.status !== 200)\n       throw new Error(`Failed to load stylesheet: ${href}`)\n     const text = await res.text()\n-    results.push(`${href}:\\n${text.replace(/\\/\\*.*?\\*\\//g, '').trim()}`)\n+    results.push(\n+      `${href.replace(\n+        /[0-9a-f]{8,}/g,\n+        'HASH'\n+      )}:\\n${text.replace(/\\/\\*.*?\\*\\//g, '').trim()}`\n+    )\n   }\n   return results\n }"
        },
        {
            "sha": "82f04556d1e1c4fb51cb6ca96fad334d0fa8fe4e",
            "filename": "test/integration/script-loader/test/index.test.js",
            "status": "modified",
            "additions": 26,
            "deletions": 12,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -114,18 +114,25 @@ const runTests = (isDev) => {\n       expect(script.attr('data-nscript')).toBeDefined()\n \n       // Script is inserted before NextScripts\n+      let scriptCount\n       if (process.env.TURBOPACK) {\n         // Turbopack generates different script names\n-        expect(\n-          $(\n+        if (isDev) {\n+          scriptCount = $(\n             `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot-of-the-server%5D__\"]`\n           ).length\n-        ).toBeGreaterThan(0)\n+        } else {\n+          // In production mode, content hashes are used\n+          scriptCount = $(\n+            `#${id} ~ script[src^=\"/_next/static/chunks/\"]`\n+          ).length\n+        }\n       } else {\n-        expect(\n-          $(`#${id} ~ script[src^=\"/_next/static/chunks/main\"]`).length\n-        ).toBeGreaterThan(0)\n+        scriptCount = $(\n+          `#${id} ~ script[src^=\"/_next/static/chunks/main\"]`\n+        ).length\n       }\n+      expect(scriptCount).toBeGreaterThan(0)\n     }\n \n     test('scriptBeforeInteractive')\n@@ -144,18 +151,25 @@ const runTests = (isDev) => {\n       expect(script.attr('data-nscript')).toBeDefined()\n \n       // Script is inserted before NextScripts\n+      let scriptCount\n       if (process.env.TURBOPACK) {\n         // Turbopack generates different script names\n-        expect(\n-          $(\n+        if (isDev) {\n+          scriptCount = $(\n             `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot-of-the-server%5D__\"]`\n           ).length\n-        ).toBeGreaterThan(0)\n+        } else {\n+          // In production mode, content hashes are used\n+          scriptCount = $(\n+            `#${id} ~ script[src^=\"/_next/static/chunks/\"]`\n+          ).length\n+        }\n       } else {\n-        expect(\n-          $(`#${id} ~ script[src^=\"/_next/static/chunks/main\"]`).length\n-        ).toBeGreaterThan(0)\n+        scriptCount = $(\n+          `#${id} ~ script[src^=\"/_next/static/chunks/main\"]`\n+        ).length\n       }\n+      expect(scriptCount).toBeGreaterThan(0)\n     }\n \n     test('scriptBeforePageRenderOld')"
        },
        {
            "sha": "97dbdf152a663287870dc2783347762a336d1b82",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 65,
            "deletions": 7,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -1,10 +1,15 @@\n use anyhow::{bail, Context, Result};\n+use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, Upcast, Value, ValueToString, Vc};\n+use turbo_tasks::{\n+    trace::TraceRawVcs, NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Upcast, Value,\n+    ValueToString, Vc,\n+};\n use turbo_tasks_fs::FileSystemPath;\n+use turbo_tasks_hash::{hash_xxh3_hash64, DeterministicHash};\n use turbopack_core::{\n-    asset::Asset,\n+    asset::{Asset, AssetContent},\n     chunk::{\n         availability_info::AvailabilityInfo,\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n@@ -42,6 +47,31 @@ pub enum CurrentChunkMethod {\n pub const CURRENT_CHUNK_METHOD_DOCUMENT_CURRENT_SCRIPT_EXPR: &str =\n     \"typeof document === \\\"object\\\" ? document.currentScript : undefined\";\n \n+#[derive(\n+    Debug,\n+    TaskInput,\n+    Clone,\n+    Copy,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    DeterministicHash,\n+    NonLocalValue,\n+)]\n+pub enum ContentHashing {\n+    /// Direct content hashing: Embeds the chunk content hash directly into the referencing chunk.\n+    /// Benefit: No hash manifest needed.\n+    /// Downside: Causes cascading hash invalidation.\n+    Direct {\n+        /// The length of the content hash in hex chars. Anything lower than 8 is not recommended\n+        /// due to the high risk of collisions.\n+        length: u8,\n+    },\n+}\n+\n pub struct BrowserChunkingContextBuilder {\n     chunking_context: BrowserChunkingContext,\n }\n@@ -125,6 +155,11 @@ impl BrowserChunkingContextBuilder {\n         self\n     }\n \n+    pub fn use_content_hashing(mut self, content_hashing: ContentHashing) -> Self {\n+        self.chunking_context.content_hashing = Some(content_hashing);\n+        self\n+    }\n+\n     pub fn build(self) -> Vc<BrowserChunkingContext> {\n         BrowserChunkingContext::new(Value::new(self.chunking_context))\n     }\n@@ -173,6 +208,8 @@ pub struct BrowserChunkingContext {\n     runtime_type: RuntimeType,\n     /// Whether to minify resulting chunks\n     minify_type: MinifyType,\n+    /// Whether content hashing is enabled.\n+    content_hashing: Option<ContentHashing>,\n     /// Whether to generate source maps\n     source_maps_type: SourceMapsType,\n     /// Method to use when figuring out the current chunk src\n@@ -214,6 +251,7 @@ impl BrowserChunkingContext {\n                 environment,\n                 runtime_type,\n                 minify_type: MinifyType::NoMinify,\n+                content_hashing: None,\n                 source_maps_type: SourceMapsType::Full,\n                 current_chunk_method: CurrentChunkMethod::StringLiteral,\n                 manifest_chunks: false,\n@@ -361,15 +399,35 @@ impl ChunkingContext for BrowserChunkingContext {\n     #[turbo_tasks::function]\n     async fn chunk_path(\n         &self,\n-        _asset: Option<Vc<Box<dyn Asset>>>,\n+        asset: Option<Vc<Box<dyn Asset>>>,\n         ident: Vc<AssetIdent>,\n         extension: RcStr,\n     ) -> Result<Vc<FileSystemPath>> {\n         let root_path = self.chunk_root_path;\n-        let name = ident\n-            .output_name(*self.root_path, extension)\n-            .owned()\n-            .await?;\n+        let name = match self.content_hashing {\n+            None => {\n+                ident\n+                    .output_name(*self.root_path, extension)\n+                    .owned()\n+                    .await?\n+            }\n+            Some(ContentHashing::Direct { length }) => {\n+                let Some(asset) = asset else {\n+                    bail!(\"chunk_path requires an asset when content hashing is enabled\");\n+                };\n+                let content = asset.content().await?;\n+                if let AssetContent::File(file) = &*content {\n+                    let hash = hash_xxh3_hash64(&file.await?);\n+                    let length = length as usize;\n+                    format!(\"{hash:0length$x}{extension}\").into()\n+                } else {\n+                    bail!(\n+                        \"chunk_path requires an asset with file content when content hashing is \\\n+                         enabled\"\n+                    );\n+                }\n+            }\n+        };\n         Ok(root_path.join(name))\n     }\n "
        },
        {
            "sha": "ffc9c554362e7d79a194bfa13366ad181b2b4629",
            "filename": "turbopack/crates/turbopack-browser/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Flib.rs?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -8,7 +8,7 @@ pub mod ecmascript;\n pub mod react_refresh;\n \n pub use chunking_context::{\n-    BrowserChunkingContext, BrowserChunkingContextBuilder, CurrentChunkMethod,\n+    BrowserChunkingContext, BrowserChunkingContextBuilder, ContentHashing, CurrentChunkMethod,\n };\n \n pub fn register() {"
        },
        {
            "sha": "eec33bb857fbe01922de56c2cdbd535b01e20eb5",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8c405dcc8508d84513098d9ae790fe3b67d32385/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=8c405dcc8508d84513098d9ae790fe3b67d32385",
            "patch": "@@ -21,7 +21,7 @@ use turbopack::{\n     css::chunk::CssChunkType, ecmascript::chunk::EcmascriptChunkType,\n     global_module_ids::get_global_module_id_strategy,\n };\n-use turbopack_browser::BrowserChunkingContext;\n+use turbopack_browser::{BrowserChunkingContext, ContentHashing};\n use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n use turbopack_core::{\n     asset::Asset,\n@@ -354,6 +354,7 @@ async fn build_internal(\n                             ..Default::default()\n                         },\n                     );\n+                    builder = builder.use_content_hashing(ContentHashing::Direct { length: 16 })\n                 }\n             }\n "
        }
    ],
    "stats": {
        "total": 194,
        "additions": 137,
        "deletions": 57
    }
}