{
    "author": "devjiwonchoi",
    "message": "Show relative path from cwd for Proxy Middleware file conflict error (#84993)\n\nShow the relative path from cwd when a Proxy Middleware file conflict\nerror occurs to better inform the users. Also, good for double-checking\nthe detection logic.\n\nCloses NEXT-4740",
    "sha": "b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1",
    "files": [
        {
            "sha": "8049584d65de8d90d1f06a9f94cf95e0e773ea08",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1",
            "patch": "@@ -881,5 +881,6 @@\n   \"880\": \"Config options `experimental.proxyPrefetch` and `experimental.middlewarePrefetch` cannot be set at the same time. Please use `experimental.proxyPrefetch` instead.\",\n   \"881\": \"Invalid render stage: %s\",\n   \"882\": \"The %s file \\\"./%s\\\" must export a function named \\\\`%s\\\\` or a default function.\",\n-  \"883\": \"The %s file \\\"%s\\\" must export a function named \\\\`%s\\\\` or a default function.\"\n+  \"883\": \"The %s file \\\"%s\\\" must export a function named \\\\`%s\\\\` or a default function.\",\n+  \"884\": \"Both %s file \\\"./%s\\\" and %s file \\\"./%s\\\" are detected. Please use \\\"./%s\\\" only.\"\n }"
        },
        {
            "sha": "255924ad9e17c4677774e61fb49e267a483c7233",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 10,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1",
            "patch": "@@ -1190,24 +1190,53 @@ export default async function build(\n         .sort(sortByPageExts(config.pageExtensions))\n         .map((file) => path.join(rootDir, file).replace(dir, ''))\n \n-      const hasInstrumentationHook = rootPaths.some((p) =>\n-        p.includes(INSTRUMENTATION_HOOK_FILENAME)\n-      )\n-      const hasMiddlewareFile = rootPaths.some((p) =>\n-        p.includes(MIDDLEWARE_FILENAME)\n-      )\n-      const hasProxyFile = rootPaths.some((p) => p.includes(PROXY_FILENAME))\n-      if (hasMiddlewareFile) {\n-        if (hasProxyFile) {\n+      let instrumentationHookFilePath: string | undefined\n+      let proxyFilePath: string | undefined\n+      let middlewareFilePath: string | undefined\n+\n+      for (const rootPath of rootPaths) {\n+        const { name: fileBaseName, dir: fileDir } = path.parse(rootPath)\n+        const isAtConventionLevel =\n+          fileDir === '/' ||\n+          fileDir === '/src' ||\n+          // rootPaths are currently relative paths from the root directory.\n+          // Add safety check here for unexpected future changes.\n+          fileDir === dir ||\n+          fileDir === path.join(dir, 'src')\n+\n+        if (isAtConventionLevel && fileBaseName === MIDDLEWARE_FILENAME) {\n+          middlewareFilePath = rootPath\n+        }\n+        if (isAtConventionLevel && fileBaseName === PROXY_FILENAME) {\n+          proxyFilePath = rootPath\n+        }\n+        if (\n+          isAtConventionLevel &&\n+          fileBaseName === INSTRUMENTATION_HOOK_FILENAME\n+        ) {\n+          instrumentationHookFilePath = rootPath\n+        }\n+      }\n+\n+      if (middlewareFilePath) {\n+        if (proxyFilePath) {\n+          const cwd = process.cwd()\n+          const absoluteProxyPath = path.join(rootDir, proxyFilePath)\n+          const absoluteMiddlewarePath = path.join(rootDir, middlewareFilePath)\n+\n           throw new Error(\n-            `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+            `Both ${MIDDLEWARE_FILENAME} file \"./${path.relative(cwd, absoluteMiddlewarePath)}\" and ${PROXY_FILENAME} file \"./${path.relative(cwd, absoluteProxyPath)}\" are detected. Please use \"./${path.relative(cwd, absoluteProxyPath)}\" only.`\n           )\n         }\n         Log.warnOnce(\n           `The \"${MIDDLEWARE_FILENAME}\" file convention is deprecated. Please use \"${PROXY_FILENAME}\" instead.`\n         )\n       }\n \n+      const hasInstrumentationHook = Boolean(instrumentationHookFilePath)\n+      const hasMiddlewareFile = Boolean(middlewareFilePath)\n+      const hasProxyFile = Boolean(proxyFilePath)\n+\n       NextBuildContext.hasInstrumentationHook = hasInstrumentationHook\n \n       const previewProps: __ApiPreviewProps = await generatePreviewKeys({"
        },
        {
            "sha": "f45c5b977a0721e53cdc36cddc99167bb95de83b",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1",
            "patch": "@@ -391,8 +391,8 @@ async function startWatcher(\n         sortByPageExts(nextConfig.pageExtensions)\n       )\n \n-      let hasMiddlewareFile = false\n-      let hasProxyFile = false\n+      let proxyFilePath: string | undefined\n+      let middlewareFilePath: string | undefined\n \n       for (const fileName of sortedKnownFiles) {\n         if (\n@@ -408,16 +408,18 @@ async function startWatcher(\n           fileDir === dir || fileDir === path.join(dir, 'src')\n \n         if (isAtConventionLevel && fileBaseName === MIDDLEWARE_FILENAME) {\n-          hasMiddlewareFile = true\n+          middlewareFilePath = fileName\n         }\n         if (isAtConventionLevel && fileBaseName === PROXY_FILENAME) {\n-          hasProxyFile = true\n+          proxyFilePath = fileName\n         }\n \n-        if (hasMiddlewareFile) {\n-          if (hasProxyFile) {\n+        if (middlewareFilePath) {\n+          if (proxyFilePath) {\n+            const cwd = process.cwd()\n+\n             throw new Error(\n-              `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+              `Both ${MIDDLEWARE_FILENAME} file \"./${path.relative(cwd, middlewareFilePath)}\" and ${PROXY_FILENAME} file \"./${path.relative(cwd, proxyFilePath)}\" are detected. Please use \"./${path.relative(cwd, proxyFilePath)}\" only.`\n             )\n           }\n           Log.warnOnce("
        },
        {
            "sha": "2f2a3bb8f07d0914ea5a4f5d580743c162422311",
            "filename": "test/e2e/app-dir/proxy-with-middleware/proxy-with-middleware.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts?ref=b3bc0d8c1a774204085e8e8e1f6ceec1ecb909f1",
            "patch": "@@ -12,16 +12,15 @@ describe('proxy-with-middleware', () => {\n   }\n \n   it('should error when both middleware and proxy files are detected', async () => {\n+    const message =\n+      'Both middleware file \"./middleware.ts\" and proxy file \"./proxy.ts\" are detected. Please use \"./proxy.ts\" only.'\n+\n     if (isNextDev) {\n       await next.start().catch(() => {})\n-      expect(next.cliOutput).toContain(\n-        'Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.'\n-      )\n+      expect(next.cliOutput).toContain(message)\n     } else {\n       const { cliOutput } = await next.build()\n-      expect(cliOutput).toContain(\n-        'Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.'\n-      )\n+      expect(cliOutput).toContain(message)\n     }\n   })\n })"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 55,
        "deletions": 24
    }
}