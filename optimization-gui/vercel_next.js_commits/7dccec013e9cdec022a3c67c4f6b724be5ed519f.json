{
    "author": "huozhi",
    "message": "[global-error] fallback to default error when user one fails (#76339)",
    "sha": "7dccec013e9cdec022a3c67c4f6b724be5ed519f",
    "files": [
        {
            "sha": "16e301d04840421ea8fb162adab34b99eb10074a",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -41,8 +41,8 @@ import {\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import { useReducer, useUnwrapState } from './use-reducer'\n import {\n+  default as DefaultGlobalError,\n   ErrorBoundary,\n-  type ErrorComponent,\n   type GlobalErrorComponent,\n } from './error-boundary'\n import { isBot } from '../../shared/lib/router/utils/is-bot'\n@@ -617,6 +617,12 @@ function Router({\n   )\n \n   if (process.env.NODE_ENV !== 'production') {\n+    // In development, we apply few error boundaries and hot-reloader:\n+    // - DevRootHTTPAccessFallbackBoundary: avoid using navigation API like notFound() in root layout\n+    // - HotReloader:\n+    //  - hot-reload the app when the code changes\n+    //  - render dev overlay\n+    //  - catch runtime errors and display global-error when necessary\n     if (typeof window !== 'undefined') {\n       const { DevRootHTTPAccessFallbackBoundary } =\n         require('./dev-root-http-access-fallback-boundary') as typeof import('./dev-root-http-access-fallback-boundary')\n@@ -634,6 +640,16 @@ function Router({\n         {content}\n       </HotReloader>\n     )\n+  } else {\n+    // In production, we only apply the user-customized global error boundary.\n+    content = (\n+      <ErrorBoundary\n+        errorComponent={globalError[0]}\n+        errorStyles={globalError[1]}\n+      >\n+        {content}\n+      </ErrorBoundary>\n+    )\n   }\n \n   return (\n@@ -672,9 +688,9 @@ export default function AppRouter({\n \n   return (\n     <ErrorBoundary\n-      // globalErrorComponent doesn't need `reset`, we do a type cast here to fit the ErrorBoundary type\n-      errorComponent={globalErrorComponent as ErrorComponent}\n-      errorStyles={globalErrorStyles}\n+      // At the very top level, use the default GlobalError component as the final fallback.\n+      // When the app router itself fails, which means the framework itself fails, we show the default error.\n+      errorComponent={DefaultGlobalError}\n     >\n       <Router\n         actionQueue={actionQueue}"
        },
        {
            "sha": "b161911565c309621964fddec56f0c971d6f2140",
            "filename": "packages/next/src/client/components/error-boundary.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -28,7 +28,9 @@ const styles = {\n \n export type ErrorComponent = React.ComponentType<{\n   error: Error\n-  reset: () => void\n+  // global-error, there's no `reset` function;\n+  // regular error boundary, there's a `reset` function.\n+  reset?: () => void\n }>\n \n export interface ErrorBoundaryProps {"
        },
        {
            "sha": "662b697d42864afad0c7734559e07a3a2c88c83d",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/app-dev-overlay-error-boundary.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay-error-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay-error-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay-error-boundary.tsx?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -1,7 +1,10 @@\n-import type { GlobalErrorComponent } from '../../error-boundary'\n-\n import { PureComponent } from 'react'\n import { RuntimeErrorHandler } from '../../errors/runtime-error-handler'\n+import {\n+  ErrorBoundary,\n+  type GlobalErrorComponent,\n+  GlobalError as DefaultGlobalError,\n+} from '../../error-boundary'\n \n type AppDevOverlayErrorBoundaryProps = {\n   children: React.ReactNode\n@@ -30,10 +33,10 @@ function ErroredHtml({\n     )\n   }\n   return (\n-    <>\n+    <ErrorBoundary errorComponent={DefaultGlobalError}>\n       {globalErrorStyles}\n       <GlobalError error={error} />\n-    </>\n+    </ErrorBoundary>\n   )\n }\n "
        },
        {
            "sha": "f4b26384a1df6dda553bfcfba3973eb1042804b7",
            "filename": "test/e2e/app-dir/global-error/basic/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Fbasic%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Fbasic%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Fbasic%2Findex.test.ts?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -1,7 +1,7 @@\n import { assertHasRedbox, getRedboxDescription } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n \n-describe('app dir - global error', () => {\n+describe('app dir - global-error', () => {\n   const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n   })"
        },
        {
            "sha": "edd4cce03e6b65f5e689638e53875130dc509bbb",
            "filename": "test/e2e/app-dir/global-error/error-in-global-error/app/global-error.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fglobal-error.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fglobal-error.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fglobal-error.js?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -0,0 +1,29 @@\n+'use client'\n+\n+import { useRouter, useSearchParams } from 'next/navigation'\n+import { Suspense } from 'react'\n+\n+function InnerGlobalError({ error }) {\n+  useRouter() // do nothing but ensure the call won't fail\n+  const searchParams = useSearchParams()\n+  if (searchParams.get('error-in-global-error') === '1') {\n+    throw new Error('error in global error')\n+  }\n+\n+  return (\n+    <html>\n+      <head></head>\n+      <body>\n+        <h1>Custom Global Error</h1>\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export default function GlobalError({ error }) {\n+  return (\n+    <Suspense fallback={<p>Loading...</p>}>\n+      <InnerGlobalError error={error} />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "762515029332e8c2e3a36650c4dfc42ec2fdf9c6",
            "filename": "test/e2e/app-dir/global-error/error-in-global-error/app/layout.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Flayout.js?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <html>\n+      <head></head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "bb4c6ea043c9638e4e2ed3b0a43497a869b23f7e",
            "filename": "test/e2e/app-dir/global-error/error-in-global-error/app/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Fapp%2Fpage.js?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+import { useEffect } from 'react'\n+\n+export default function Page() {\n+  useEffect(() => {\n+    throw new Error('error in page')\n+  }, [])\n+  return <p>index page</p>\n+}"
        },
        {
            "sha": "addf46121cbc9c8f43199ec9325fb2a40be88277",
            "filename": "test/e2e/app-dir/global-error/error-in-global-error/error-in-global-error.test.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Ferror-in-global-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7dccec013e9cdec022a3c67c4f6b724be5ed519f/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Ferror-in-global-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-error%2Ferror-in-global-error%2Ferror-in-global-error.test.ts?ref=7dccec013e9cdec022a3c67c4f6b724be5ed519f",
            "patch": "@@ -0,0 +1,59 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertHasRedbox } from 'next-test-utils'\n+\n+describe('app dir - global-error - error-in-global-error', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should be able to use nextjs navigation hook in global-error', async () => {\n+    const browser = await next.browser('/')\n+    const text = await browser.elementByCss('h1').text()\n+    expect(text).toBe('Custom Global Error')\n+\n+    if (isNextDev) {\n+      await assertHasRedbox(browser)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: error in page\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"app/page.js (7:11) @ Page.useEffect\n+       >  7 |     throw new Error('error in page')\n+            |           ^\",\n+         \"stack\": [\n+           \"Page.useEffect app/page.js (7:11)\",\n+         ],\n+       }\n+      `)\n+    }\n+  })\n+\n+  it('should render fallback UI when error occurs in global-error', async () => {\n+    const browser = await next.browser('/?error-in-global-error=1')\n+    const text = await browser.elementByCss('h2').text()\n+    expect(text).toMatch(\n+      /Application error: a client-side exception has occurred while loading [\\w.-]+ \\(see the browser console for more information\\)./\n+    )\n+\n+    if (isNextDev) {\n+      await assertHasRedbox(browser)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 2,\n+         \"description\": \"Error: error in global error\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"app/global-error.js (10:11) @ InnerGlobalError\n+       > 10 |     throw new Error('error in global error')\n+            |           ^\",\n+         \"stack\": [\n+           \"InnerGlobalError app/global-error.js (10:11)\",\n+           \"GlobalError app/global-error.js (26:7)\",\n+         ],\n+       }\n+      `)\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 137,
        "deletions": 10
    }
}