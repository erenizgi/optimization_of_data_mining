{
    "author": "sokra",
    "message": "Turbopack: decode url encoding and relative paths in source maps (#86342)\n\n### What?\n\ndecode url encoding and relative paths in source maps",
    "sha": "c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e",
    "files": [
        {
            "sha": "063703995858e87f96fafc6df9c7c8d8ef4ca8f2",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e",
            "patch": "@@ -4280,6 +4280,7 @@ dependencies = [\n  \"turbopack-node\",\n  \"turbopack-nodejs\",\n  \"turbopack-wasm\",\n+ \"urlencoding\",\n  \"vergen\",\n ]\n "
        },
        {
            "sha": "01965e47de6f5d8228d10690d77fd98ae1066b62",
            "filename": "apps/bundle-analyzer/tsconfig.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/apps%2Fbundle-analyzer%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/apps%2Fbundle-analyzer%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Ftsconfig.json?ref=c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e",
            "patch": "@@ -27,7 +27,9 @@\n     \"**/*.ts\",\n     \"**/*.tsx\",\n     \".next/types/**/*.ts\",\n-    \".next/dev/types/**/*.ts\"\n+    \".next/dev/types/**/*.ts\",\n+    \"dist/types/**/*.ts\",\n+    \"dist/dev/types/**/*.ts\"\n   ],\n   \"exclude\": [\"node_modules\"]\n }"
        },
        {
            "sha": "71b93963e174c21895e3a76809837482b59b468e",
            "filename": "crates/next-api/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/crates%2Fnext-api%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/crates%2Fnext-api%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2FCargo.toml?ref=c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e",
            "patch": "@@ -40,6 +40,7 @@ turbopack-ecmascript = { workspace = true }\n turbopack-node = { workspace = true }\n turbopack-nodejs = { workspace = true }\n turbopack-wasm = { workspace = true }\n+urlencoding = { workspace = true }\n \n [dev-dependencies]\n turbo-tasks-malloc = { workspace = true }"
        },
        {
            "sha": "788f2e7384a0451a021025bb06fb76705ffe11a7",
            "filename": "crates/next-api/src/analyze.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 14,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/crates%2Fnext-api%2Fsrc%2Fanalyze.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e/crates%2Fnext-api%2Fsrc%2Fanalyze.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fanalyze.rs?ref=c42d0e3d27b4b3af4a0054261d5968ba5e6fb72e",
            "patch": "@@ -1,4 +1,4 @@\n-use std::io::Write;\n+use std::{borrow::Cow, io::Write};\n \n use anyhow::Result;\n use byteorder::{BE, WriteBytesExt};\n@@ -23,7 +23,7 @@ use turbopack_core::{\n     reference::all_assets_from_entries,\n };\n \n-use crate::route::{Endpoint, ModuleGraphs};\n+use crate::route::ModuleGraphs;\n \n #[derive(\n     Default, Clone, Debug, Deserialize, Eq, NonLocalValue, PartialEq, Serialize, TraceRawVcs,\n@@ -371,9 +371,16 @@ pub async fn analyze_output_assets(output_assets: Vc<OutputAssets>) -> Result<Vc\n         let output_file_index = builder.add_output_file(AnalyzeOutputFile { filename });\n         let chunk_parts = split_output_asset_into_parts(*asset).await?;\n         for chunk_part in chunk_parts {\n-            let source_index = builder\n-                .ensure_source(chunk_part.source.trim_start_matches(&prefix))\n-                .1;\n+            let decoded_source = urlencoding::decode(&chunk_part.source)?;\n+            let source = if let Some(stripped) = decoded_source.strip_prefix(&prefix) {\n+                Cow::Borrowed(stripped)\n+            } else {\n+                Cow::Owned(format!(\n+                    \"[project]/{}\",\n+                    decoded_source.trim_start_matches(\"../\")\n+                ))\n+            };\n+            let source_index = builder.ensure_source(&source).1;\n             let chunk_part_index = builder.add_chunk_part(AnalyzeChunkPart {\n                 source_index,\n                 output_file_index,\n@@ -533,13 +540,6 @@ pub async fn analyze_module_graphs(module_graphs: Vc<ModuleGraphs>) -> Result<Vc\n     Ok(FileContent::Content(File::from(rope)).cell())\n }\n \n-#[turbo_tasks::function]\n-pub async fn analyze_endpoint(endpoint: Vc<Box<dyn Endpoint>>) -> Result<Vc<FileContent>> {\n-    Ok(analyze_output_assets(\n-        *endpoint.output().await?.output_assets,\n-    ))\n-}\n-\n #[turbo_tasks::value]\n pub struct AnalyzeDataOutputAsset {\n     pub path: FileSystemPath,\n@@ -549,10 +549,13 @@ pub struct AnalyzeDataOutputAsset {\n #[turbo_tasks::value_impl]\n impl AnalyzeDataOutputAsset {\n     #[turbo_tasks::function]\n-    pub async fn new(path: FileSystemPath, output_assets: Vc<OutputAssets>) -> Result<Vc<Self>> {\n+    pub async fn new(\n+        path: FileSystemPath,\n+        output_assets: ResolvedVc<OutputAssets>,\n+    ) -> Result<Vc<Self>> {\n         Ok(Self {\n             path,\n-            output_assets: output_assets.to_resolved().await?,\n+            output_assets,\n         }\n         .cell())\n     }"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 22,
        "deletions": 15
    }
}