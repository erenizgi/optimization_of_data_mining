{
    "author": "styfle",
    "message": "fix(cache-tags): add `/index` to implicit tags and adjust `revalidatePath()` (#84586)\n\nThis fixes an issue where the tag was `/` but the build output was\n`/index` (and vice-versa) meaning you couldn't use `revalidatePath()` in\nsome cases because the tag didn't match.\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "75b1ceff2fb29d78f7a8566124a877bc2b7386c2",
    "files": [
        {
            "sha": "712e5e578f66bd654b2fec7e8fe521fa3194a7fe",
            "filename": "packages/next/src/server/lib/implicit-tags.test.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.test.ts?ref=75b1ceff2fb29d78f7a8566124a877bc2b7386c2",
            "patch": "@@ -0,0 +1,83 @@\n+import type { OpaqueFallbackRouteParams } from '../request/fallback-params'\n+import { getImplicitTags } from './implicit-tags'\n+\n+describe('getImplicitTags()', () => {\n+  it.each<{\n+    page: string\n+    url: { pathname: string; search: string }\n+    fallbackRouteParams: null | OpaqueFallbackRouteParams\n+    expectedTags: string[]\n+  }>([\n+    {\n+      page: '/',\n+      url: { pathname: '/', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/', '_N_T_/index'],\n+    },\n+    {\n+      page: '',\n+      url: { pathname: '/', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/', '_N_T_/index'],\n+    },\n+    {\n+      page: '/',\n+      url: { pathname: '', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout'],\n+    },\n+    {\n+      page: '/page',\n+      url: { pathname: '', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/page'],\n+    },\n+    {\n+      page: '/page',\n+      url: { pathname: '/', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/page', '_N_T_/', '_N_T_/index'],\n+    },\n+    {\n+      page: '/page',\n+      url: { pathname: '/page', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/page'],\n+    },\n+    {\n+      page: '/index',\n+      url: { pathname: '/', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: [\n+        '_N_T_/layout',\n+        '_N_T_/index/layout',\n+        '_N_T_/',\n+        '_N_T_/index',\n+      ],\n+    },\n+    {\n+      page: '/hello',\n+      url: { pathname: '/hello', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: ['_N_T_/layout', '_N_T_/hello/layout', '_N_T_/hello'],\n+    },\n+    {\n+      page: '/foo/bar/baz',\n+      url: { pathname: '/foo/bar/baz', search: '' },\n+      fallbackRouteParams: null,\n+      expectedTags: [\n+        '_N_T_/layout',\n+        '_N_T_/foo/layout',\n+        '_N_T_/foo/bar/layout',\n+        '_N_T_/foo/bar/baz/layout',\n+        '_N_T_/foo/bar/baz',\n+      ],\n+    },\n+  ])(\n+    'for page $page with url $url and $fallback',\n+    async ({ page, url, fallbackRouteParams, expectedTags }) => {\n+      const result = await getImplicitTags(page, url, fallbackRouteParams)\n+      expect(result.tags).toEqual(expectedTags)\n+    }\n+  )\n+})"
        },
        {
            "sha": "a8ec951f1576cb510ed96d3417fdae85737a9980",
            "filename": "packages/next/src/server/lib/implicit-tags.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts?ref=75b1ceff2fb29d78f7a8566124a877bc2b7386c2",
            "patch": "@@ -79,13 +79,13 @@ export async function getImplicitTags(\n   },\n   fallbackRouteParams: null | OpaqueFallbackRouteParams\n ): Promise<ImplicitTags> {\n-  const tags: string[] = []\n+  const tags = new Set<string>()\n \n   // Add the derived tags from the page.\n   const derivedTags = getDerivedTags(page)\n   for (let tag of derivedTags) {\n     tag = `${NEXT_CACHE_IMPLICIT_TAG_ID}${tag}`\n-    tags.push(tag)\n+    tags.add(tag)\n   }\n \n   // Add the tags from the pathname. If the route has unknown params, we don't\n@@ -95,11 +95,20 @@ export async function getImplicitTags(\n     (!fallbackRouteParams || fallbackRouteParams.size === 0)\n   ) {\n     const tag = `${NEXT_CACHE_IMPLICIT_TAG_ID}${url.pathname}`\n-    tags.push(tag)\n+    tags.add(tag)\n   }\n \n+  if (tags.has(`${NEXT_CACHE_IMPLICIT_TAG_ID}/`)) {\n+    tags.add(`${NEXT_CACHE_IMPLICIT_TAG_ID}/index`)\n+  }\n+\n+  if (tags.has(`${NEXT_CACHE_IMPLICIT_TAG_ID}/index`)) {\n+    tags.add(`${NEXT_CACHE_IMPLICIT_TAG_ID}/`)\n+  }\n+\n+  const tagsArray = Array.from(tags)\n   return {\n-    tags,\n-    expirationsByCacheKind: createTagsExpirationsByCacheKind(tags),\n+    tags: tagsArray,\n+    expirationsByCacheKind: createTagsExpirationsByCacheKind(tagsArray),\n   }\n }"
        },
        {
            "sha": "4b68791a767411170097ff16aa1eddf353c7c8b8",
            "filename": "packages/next/src/server/web/spec-extension/revalidate.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts?ref=75b1ceff2fb29d78f7a8566124a877bc2b7386c2",
            "patch": "@@ -37,7 +37,7 @@ export function unstable_expirePath(\n     return\n   }\n \n-  let normalizedPath = `${NEXT_CACHE_IMPLICIT_TAG_ID}${originalPath}`\n+  let normalizedPath = `${NEXT_CACHE_IMPLICIT_TAG_ID}${originalPath || '/'}`\n \n   if (type) {\n     normalizedPath += `${normalizedPath.endsWith('/') ? '' : '/'}${type}`\n@@ -46,7 +46,13 @@ export function unstable_expirePath(\n       `Warning: a dynamic page path \"${originalPath}\" was passed to \"expirePath\", but the \"type\" parameter is missing. This has no effect by default, see more info here https://nextjs.org/docs/app/api-reference/functions/unstable_expirePath`\n     )\n   }\n-  return revalidate([normalizedPath], `unstable_expirePath ${originalPath}`)\n+  const tags = [normalizedPath]\n+  if (normalizedPath === `${NEXT_CACHE_IMPLICIT_TAG_ID}/`) {\n+    tags.push(`${NEXT_CACHE_IMPLICIT_TAG_ID}/index`)\n+  } else if (normalizedPath === `${NEXT_CACHE_IMPLICIT_TAG_ID}/index`) {\n+    tags.push(`${NEXT_CACHE_IMPLICIT_TAG_ID}/`)\n+  }\n+  return revalidate(tags, `unstable_expirePath ${originalPath}`)\n }\n \n /**\n@@ -71,7 +77,7 @@ export function revalidatePath(originalPath: string, type?: 'layout' | 'page') {\n     return\n   }\n \n-  let normalizedPath = `${NEXT_CACHE_IMPLICIT_TAG_ID}${originalPath}`\n+  let normalizedPath = `${NEXT_CACHE_IMPLICIT_TAG_ID}${originalPath || '/'}`\n \n   if (type) {\n     normalizedPath += `${normalizedPath.endsWith('/') ? '' : '/'}${type}`\n@@ -80,7 +86,15 @@ export function revalidatePath(originalPath: string, type?: 'layout' | 'page') {\n       `Warning: a dynamic page path \"${originalPath}\" was passed to \"revalidatePath\", but the \"type\" parameter is missing. This has no effect by default, see more info here https://nextjs.org/docs/app/api-reference/functions/revalidatePath`\n     )\n   }\n-  return revalidate([normalizedPath], `revalidatePath ${originalPath}`)\n+\n+  const tags = [normalizedPath]\n+  if (normalizedPath === `${NEXT_CACHE_IMPLICIT_TAG_ID}/`) {\n+    tags.push(`${NEXT_CACHE_IMPLICIT_TAG_ID}/index`)\n+  } else if (normalizedPath === `${NEXT_CACHE_IMPLICIT_TAG_ID}/index`) {\n+    tags.push(`${NEXT_CACHE_IMPLICIT_TAG_ID}/`)\n+  }\n+\n+  return revalidate(tags, `revalidatePath ${originalPath}`)\n }\n \n function revalidate(tags: string[], expression: string) {"
        },
        {
            "sha": "72c5469ec999252915deebf9fd5bf6cb352199af",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/use-cache-custom-handler.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/75b1ceff2fb29d78f7a8566124a877bc2b7386c2/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts?ref=75b1ceff2fb29d78f7a8566124a877bc2b7386c2",
            "patch": "@@ -28,7 +28,7 @@ describe('use-cache-custom-handler', () => {\n     expect(cliOutput).toContain('ModernCustomCacheHandler::refreshTags')\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch(\n-      /ModernCustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"([0-9a-f]{2})+\",\\[\\]\\] \\[ '_N_T_\\/layout', '_N_T_\\/page', '_N_T_\\/' \\]/\n+      /ModernCustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"([0-9a-f]{2})+\",\\[\\]\\] \\[ '_N_T_\\/layout', '_N_T_\\/page', '_N_T_\\/', '_N_T_\\/index' \\]/\n     )\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch(\n@@ -52,7 +52,7 @@ describe('use-cache-custom-handler', () => {\n     // to compare the cache entries timestamp with the expiration of the\n     // implicit tags.\n     expect(next.cliOutput.slice(outputIndex)).toContain(\n-      `ModernCustomCacheHandler::getExpiration [\"_N_T_/layout\",\"_N_T_/page\",\"_N_T_/\"]`\n+      `ModernCustomCacheHandler::getExpiration [\"_N_T_/layout\",\"_N_T_/page\",\"_N_T_/\",\"_N_T_/index\"]`\n     )\n \n     // Because we use a low `revalidate` value for the \"use cache\" function, new"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 117,
        "deletions": 11
    }
}