{
    "author": "ztanner",
    "message": "[Segment Cache]: fix infinite prefetching when staleTime is 0 (#82388)\n\nThis PR fixes an infinite loop bug that occurred when using `cacheLife({\nstale: 0 })` with `clientSegmentCache`. When the server returned a stale\ntime of 0 seconds, cache entries would have `staleAt = Date.now()`,\nmaking them immediately stale. The cache would evict these entries on\nthe same tick they were created, triggering continuous refetch requests.\n\nThe fix updates the minimum stale time to be 30s, in the event that the\nserver sends a low value. The rationale being that a value lower than\n30s here would render prefetching ineffective. This prevents the\nimmediate eviction while still respecting the server's intent for very\nshort-lived cache entries.\n\nCloses NAR-269",
    "sha": "f63290fef95f4174044b515fafdb05956feb6022",
    "files": [
        {
            "sha": "972025cb696317eecbbe68f5143732b8071477f2",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f63290fef95f4174044b515fafdb05956feb6022/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f63290fef95f4174044b515fafdb05956feb6022/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=f63290fef95f4174044b515fafdb05956feb6022",
            "patch": "@@ -244,6 +244,14 @@ const isOutputExportMode =\n   process.env.NODE_ENV === 'production' &&\n   process.env.__NEXT_CONFIG_OUTPUT === 'export'\n \n+/**\n+ * Ensures a minimum stale time of 30s to avoid issues where the server sends a too\n+ * short-lived stale time, which would prevent anything from being prefetched.\n+ */\n+function getStaleTimeMs(staleTimeSeconds: number): number {\n+  return Math.max(staleTimeSeconds, 30) * 1000\n+}\n+\n // Route cache entries vary on multiple keys: the href and the Next-Url. Each of\n // these parts needs to be included in the internal cache key. Rather than\n // concatenate the keys into a single key, we use a multi-level map, where the\n@@ -1271,7 +1279,7 @@ export async function fetchRouteOnCacheMiss(\n         renderedPathname\n       )\n \n-      const staleTimeMs = serverData.staleTime * 1000\n+      const staleTimeMs = getStaleTimeMs(serverData.staleTime)\n       fulfillRouteCacheEntry(\n         entry,\n         routeTree,\n@@ -1641,7 +1649,7 @@ function writeDynamicTreeResponseIntoCache(\n   )\n   const staleTimeMs =\n     staleTimeHeaderSeconds !== null\n-      ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n+      ? getStaleTimeMs(parseInt(staleTimeHeaderSeconds, 10))\n       : STATIC_STALETIME_MS\n \n   // If the response contains dynamic holes, then we must conservatively assume\n@@ -1740,7 +1748,7 @@ function writeDynamicRenderResponseIntoCache(\n   )\n   const staleTimeMs =\n     staleTimeHeaderSeconds !== null\n-      ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n+      ? getStaleTimeMs(parseInt(staleTimeHeaderSeconds, 10))\n       : STATIC_STALETIME_MS\n   const staleAt = now + staleTimeMs\n "
        },
        {
            "sha": "5345383b77d590858d56c6c606ba697ff53aacc1",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/cache-life-seconds-test/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds-test%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds-test%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds-test%2Fpage.tsx?ref=f63290fef95f4174044b515fafdb05956feb6022",
            "patch": "@@ -0,0 +1,12 @@\n+import { LinkAccordion } from '../../components/link-accordion'\n+\n+export default function CacheLifeSecondsTestPage() {\n+  return (\n+    <div>\n+      <h1>Cache Life Seconds Test</h1>\n+      <LinkAccordion href=\"/cache-life-seconds\">\n+        Go to cache-life-seconds page\n+      </LinkAccordion>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f96d8fba00c877960fb1ed5a7ee637b3a67293e2",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/cache-life-seconds/loading.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Floading.tsx?ref=f63290fef95f4174044b515fafdb05956feb6022",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Loading() {\n+  return (\n+    <div>\n+      <h1>Loading...</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "23d21e1cb5b9312ca1168c0ed9a33a96d01c11fb",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/cache-life-seconds/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fcache-life-seconds%2Fpage.tsx?ref=f63290fef95f4174044b515fafdb05956feb6022",
            "patch": "@@ -0,0 +1,15 @@\n+import { unstable_cacheLife } from 'next/cache'\n+\n+export default async function CacheLifeSecondsPage() {\n+  'use cache'\n+  unstable_cacheLife({ stale: 0, revalidate: 1, expire: 60 })\n+\n+  const randomNumber = Math.random()\n+\n+  return (\n+    <div id=\"cache-life-seconds-page\">\n+      <p>Cache Life Seconds Page</p>\n+      <p id=\"random-value\">{randomNumber}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "dd1647292617ee2ceba441d1f3dceecd12343db8",
            "filename": "test/e2e/app-dir/segment-cache/basic/segment-cache-basic.test.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f63290fef95f4174044b515fafdb05956feb6022/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts?ref=f63290fef95f4174044b515fafdb05956feb6022",
            "patch": "@@ -1,5 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from '../router-act'\n+import { waitFor } from 'next-test-utils'\n \n describe('segment cache (basic tests)', () => {\n   const { next, isNextDev } = nextTestSetup({\n@@ -371,4 +372,40 @@ describe('segment cache (basic tests)', () => {\n       'no-requests'\n     )\n   })\n+\n+  it('does not cause infinite loop with cacheLife(\"seconds\")', async () => {\n+    let requestCount = 0\n+\n+    const browser = await next.browser('/cache-life-seconds-test', {\n+      beforePageLoad(page) {\n+        page.on('request', (request) => {\n+          const url = request.url()\n+          if (url.includes('/cache-life-seconds') && url.includes('_rsc')) {\n+            requestCount++\n+          }\n+        })\n+      },\n+    })\n+\n+    // Reveal the link to trigger a prefetch\n+    const reveal = await browser.elementByCss('input[type=\"checkbox\"]')\n+    await reveal.click()\n+\n+    // Wait for the link to appear\n+    const link = await browser.elementByCss('a[href=\"/cache-life-seconds\"]')\n+\n+    // Give the prefetch a moment to potentially start looping\n+    await waitFor(500)\n+\n+    // Check that we haven't made excessive requests during prefetch\n+    expect(requestCount).toBeLessThan(10)\n+\n+    // Now navigate to the page to ensure it works correctly\n+    await link.click()\n+\n+    // Wait for the page to load\n+    const page = await browser.elementById('cache-life-seconds-page')\n+    const content = await page.textContent()\n+    expect(content).toContain('Cache Life Seconds Page')\n+  })\n })"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 82,
        "deletions": 3
    }
}