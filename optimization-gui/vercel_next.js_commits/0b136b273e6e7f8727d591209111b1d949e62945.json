{
    "author": "huozhi",
    "message": "[metadata] fix streaming metadata triggering error boundaries (#76280)",
    "sha": "0b136b273e6e7f8727d591209111b1d949e62945",
    "files": [
        {
            "sha": "3a8046ffccef4b83ce3769d7a69a6bee2622539e",
            "filename": "packages/next/src/client/components/http-access-fallback/error-boundary.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-boundary.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -136,7 +136,7 @@ class HTTPAccessFallbackErrorBoundary extends React.Component<\n           <meta name=\"robots\" content=\"noindex\" />\n           {process.env.NODE_ENV === 'development' && (\n             <meta\n-              name=\"next-error\"\n+              name=\"boundary-next-error\"\n               content={getAccessFallbackErrorTypeByStatus(triggeredStatus)}\n             />\n           )}"
        },
        {
            "sha": "2fa206d74678d676b8ead641457d4bfdf585442c",
            "filename": "packages/next/src/lib/metadata/async-metadata.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -27,7 +27,10 @@ function BrowserResolvedMetadata({\n }: {\n   promise: Promise<StreamingMetadataResolvedState>\n }) {\n-  const { metadata } = use(promise)\n+  const { metadata, error } = use(promise)\n+  // If there's metadata error on client, discard the browser metadata\n+  // and let metadata outlet deal with the error. This will avoid the duplication metadata.\n+  if (error) return null\n   return metadata\n }\n "
        },
        {
            "sha": "6aac2d66a6c23616e494eff03b165e2e0f1eaac6",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -93,7 +93,7 @@ async function createComponentTreeInternal({\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n   StreamingMetadata: React.ComponentType<{}> | null\n-  StreamingMetadataOutlet: React.ComponentType\n+  StreamingMetadataOutlet: React.ComponentType | null\n }): Promise<CacheNodeSeedData> {\n   const {\n     renderOpts: { nextConfigOutput, experimental },\n@@ -397,9 +397,15 @@ async function createComponentTreeInternal({\n \n   // Only render metadata on the actual SSR'd segment not the `default` segment,\n   // as it's used as a placeholder for navigation.\n+  const isNotDefaultSegment = actualSegment !== DEFAULT_SEGMENT_KEY\n+\n   const metadata =\n-    actualSegment !== DEFAULT_SEGMENT_KEY && StreamingMetadata ? (\n-      <StreamingMetadata />\n+    isNotDefaultSegment && StreamingMetadata ? <StreamingMetadata /> : undefined\n+\n+  // Use the same condition to render metadataOutlet as metadata\n+  const metadataOutlet =\n+    isNotDefaultSegment && StreamingMetadataOutlet ? (\n+      <StreamingMetadataOutlet />\n     ) : undefined\n \n   const notFoundElement = NotFound ? (\n@@ -522,7 +528,11 @@ async function createComponentTreeInternal({\n             preloadCallbacks,\n             authInterrupts,\n             StreamingMetadata,\n-            StreamingMetadataOutlet,\n+            // `StreamingMetadataOutlet` is used to conditionally throw. In the case of parallel routes we will have more than one page\n+            // but we only want to throw on the first one.\n+            StreamingMetadataOutlet: isChildrenRouteKey\n+              ? StreamingMetadataOutlet\n+              : null,\n           })\n \n           childCacheNodeSeedData = seedData\n@@ -709,8 +719,10 @@ async function createComponentTreeInternal({\n         {layerAssets}\n         <OutletBoundary>\n           <MetadataOutlet ready={getViewportReady} />\n+          {/* Blocking metadata outlet */}\n           <MetadataOutlet ready={getMetadataReady} />\n-          <StreamingMetadataOutlet />\n+          {/* Streaming metadata outlet */}\n+          {metadataOutlet}\n         </OutletBoundary>\n       </React.Fragment>,\n       parallelRouteCacheNodeSeedData,"
        },
        {
            "sha": "df3210cec883cecd87ec717cba58686b28660215",
            "filename": "test/e2e/app-dir/metadata-streaming/app/notfound/boundary/not-found.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fnot-found.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -0,0 +1,7 @@\n+export default function NotFound() {\n+  return <h1>Custom Not Found</h1>\n+}\n+\n+export const metadata = {\n+  title: 'notfound title',\n+}"
        },
        {
            "sha": "6390e6bb069e1b1c814513f42ca81487d54b4392",
            "filename": "test/e2e/app-dir/metadata-streaming/app/notfound/boundary/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fboundary%2Fpage.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -0,0 +1,14 @@\n+import { connection } from 'next/server'\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  return <p>notfound page</p>\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 2 * 1000))\n+  notFound()\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "840bbff602b71d4f7c8bcdbca2f98791bac89bfb",
            "filename": "test/e2e/app-dir/metadata-streaming/app/notfound/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fapp%2Fnotfound%2Fpage.tsx?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -2,12 +2,12 @@ import { connection } from 'next/server'\n import { notFound } from 'next/navigation'\n \n export default function Page() {\n-  return <p>notfound page</p>\n+  return <p>boundary notfound page</p>\n }\n \n export async function generateMetadata() {\n   await connection()\n-  await new Promise((resolve) => setTimeout(resolve, 2 * 1000))\n+  await new Promise((resolve) => setTimeout(resolve, 500))\n   notFound()\n }\n "
        },
        {
            "sha": "5121e78977214b57a9912044ada72efd04c890b5",
            "filename": "test/e2e/app-dir/metadata-streaming/metadata-streaming.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0b136b273e6e7f8727d591209111b1d949e62945/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts?ref=0b136b273e6e7f8727d591209111b1d949e62945",
            "patch": "@@ -121,6 +121,19 @@ describe('app-dir - metadata-streaming', () => {\n       expect(await browser.elementByCss('p').text()).toBe('index page')\n     })\n \n+    it('should trigger custom not-found in the boundary', async () => {\n+      const browser = await next.browser('/notfound/boundary')\n+\n+      expect(await browser.elementByCss('h1').text()).toBe('Custom Not Found')\n+    })\n+\n+    it('should not duplicate metadata with navigation API', async () => {\n+      const browser = await next.browser('/notfound/boundary')\n+\n+      const titleTags = await browser.elementsByCss('title')\n+      expect(titleTags.length).toBe(1)\n+    })\n+\n     it('should render blocking 404 response status when html limited bots access notFound', async () => {\n       const { status } = await next.fetch('/notfound', {\n         headers: {"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 58,
        "deletions": 9
    }
}