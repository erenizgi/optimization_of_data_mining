{
    "author": "huozhi",
    "message": "[dev-overlay] fix duplicate re-render of errors (#80322)\n\n### What\r\n\r\nWhen there's a same error throwing constantly, we should avoid unnecessary re-renders on the exact same error. In dev overlay we already have strategies that can dedupe the error. And we noticed the error is shown correctly but just the dialog got re-rendered with animations.\r\n\r\nAfter digging deeper, noticed we are still adding the same runtime error into the error collection, just because each time it got the new \"ID\", as the \"ID\" itself is incremental based on actions. Each action will get a new error ID. Hence we're adding a condition in deduping. If we found that the new error already existed in the previous events, we'll return with the same previous events instance to tell dev overlay that errors are not changed.\r\n\r\nFixes NEXT-4493\r\n\r\n#### After\r\nhttps://github.com/user-attachments/assets/c1f004b5-2de6-445a-aad0-efdfd0ecb8c9\r\n\r\n#### Before\r\nhttps://github.com/user-attachments/assets/1249ed54-ba63-4eb6-a08a-64560ab4014a",
    "sha": "cf1f47a5d174538866b1afd384b24e14dae9c5ca",
    "files": [
        {
            "sha": "d4db7ae55123e15f750c082f6cf03941a2d1e286",
            "filename": "packages/next/src/client/components/react-dev-overlay/shared.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/cf1f47a5d174538866b1afd384b24e14dae9c5ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cf1f47a5d174538866b1afd384b24e14dae9c5ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts?ref=cf1f47a5d174538866b1afd384b24e14dae9c5ca",
            "patch": "@@ -232,8 +232,13 @@ export function useErrorOverlayReducer(\n         getOwnerStack(event.error) !== getOwnerStack(pendingEvent.error)\n       )\n     })\n-    pendingEvents.push(pendingEvent)\n-    return pendingEvents\n+    // If there's nothing filtered out, the event is a brand new error\n+    if (pendingEvents.length === events.length) {\n+      pendingEvents.push(pendingEvent)\n+      return pendingEvents\n+    }\n+    // Otherwise remain the same events\n+    return events\n   }\n \n   return useReducer((state: OverlayState, action: BusEvent): OverlayState => {"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/development/app-dir/error-overlay/duplicate-runtime-error/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Flayout.tsx?ref=cf1f47a5d174538866b1afd384b24e14dae9c5ca",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "46dc2c68908e3b7123307a269851c886aa973482",
            "filename": "test/development/app-dir/error-overlay/duplicate-runtime-error/app/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fapp%2Fpage.tsx?ref=cf1f47a5d174538866b1afd384b24e14dae9c5ca",
            "patch": "@@ -0,0 +1,15 @@\n+'use client'\n+\n+import { useEffect } from 'react'\n+\n+export default function Page() {\n+  // set a timeout to throw an error each 2 seconds\n+  useEffect(() => {\n+    const interval = setInterval(() => {\n+      throw new Error('This is a test error from the app directory')\n+    }, 500)\n+\n+    return () => clearInterval(interval)\n+  }, [])\n+  return <p>page</p>\n+}"
        },
        {
            "sha": "27ed5ce90b65d19358ebb0926505d4218474a43c",
            "filename": "test/development/app-dir/error-overlay/duplicate-runtime-error/duplicate-runtime-error.test.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fduplicate-runtime-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fduplicate-runtime-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fduplicate-runtime-error.test.ts?ref=cf1f47a5d174538866b1afd384b24e14dae9c5ca",
            "patch": "@@ -0,0 +1,29 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry, waitFor } from 'next-test-utils'\n+\n+describe('duplicate-runtime-error', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not rerender the overlay for the same runtime error', async () => {\n+    const browser = await next.browser('/')\n+    const badge = await browser.elementByCss('[data-next-badge]')\n+\n+    // Wait until the badge is showing \"errored\"\n+    await retry(async () => {\n+      const errorProp = await badge.getAttribute('data-error')\n+\n+      expect(errorProp).toBe('true')\n+    })\n+\n+    // Still present the same value after a while without re-rendersw.\n+    // Should always display the badge, should not re-render by hiding it again\n+    for (let i = 0; i < 40; i++) {\n+      const errorProp = await badge.getAttribute('data-error')\n+\n+      expect(errorProp).toBe('true')\n+      await waitFor(50)\n+    }\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/development/app-dir/error-overlay/duplicate-runtime-error/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/cf1f47a5d174538866b1afd384b24e14dae9c5ca/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Fduplicate-runtime-error%2Fnext.config.js?ref=cf1f47a5d174538866b1afd384b24e14dae9c5ca",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 65,
        "deletions": 2
    }
}