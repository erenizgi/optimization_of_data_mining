{
    "author": "gnoff",
    "message": "[dynamicIO] routes with dynamic segments should be able to be static in dev (#76691)\n\nDev mode reports static/dynamic behavior using a heuristic when\ndynamicIO is enabled. The heuristic previously incorrectly marked routes\nas dynamic when they were in fact static as a consequence of refactoring\nmetadata to support streaming. This update adjust the heuristic to not\nincorrectly assume dynamic in these situations.\n\nThe root cause is that errors in `onError` cannot be assumed to be valid\nif the render has already aborted\n\nCloses NAR-112",
    "sha": "9216ab130c0d61929b73445de812ebf2e904d804",
    "files": [
        {
            "sha": "e341d1359a4e95bbebeae1cd0148b8a232a3cc62",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=9216ab130c0d61929b73445de812ebf2e904d804",
            "patch": "@@ -387,11 +387,7 @@ async function exportAppImpl(\n     strictNextHead: nextConfig.experimental.strictNextHead ?? true,\n     deploymentId: nextConfig.deploymentId,\n     htmlLimitedBots: nextConfig.htmlLimitedBots.source,\n-    streamingMetadata:\n-      // Disable streaming metadata when dynamic IO is enabled.\n-      // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n-      // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n-      !nextConfig.experimental.dynamicIO,\n+    streamingMetadata: true,\n     experimental: {\n       clientTraceMetadata: nextConfig.experimental.clientTraceMetadata,\n       expireTime: nextConfig.expireTime,"
        },
        {
            "sha": "72d619fcd8af07ffe61389fa42f4f0252aa6b552",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=9216ab130c0d61929b73445de812ebf2e904d804",
            "patch": "@@ -425,11 +425,7 @@ export async function exportPages(\n             enableExperimentalReact: needsExperimentalReact(nextConfig),\n             sriEnabled: Boolean(nextConfig.experimental.sri?.algorithm),\n             buildId: input.buildId,\n-            streamingMetadata:\n-              // Disable streaming metadata when dynamic IO is enabled.\n-              // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n-              // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n-              !nextConfig.experimental.dynamicIO,\n+            streamingMetadata: true,\n           }),\n           // If exporting the page takes longer than the timeout, reject the promise.\n           new Promise((_, reject) => {"
        },
        {
            "sha": "82a599d5324a1a51caac5db2a3075525a0250307",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=9216ab130c0d61929b73445de812ebf2e904d804",
            "patch": "@@ -2446,6 +2446,7 @@ async function spawnDynamicValidationInDev(\n     }\n   )\n \n+  let rootDidError = false\n   const serverPhasedStream = serverPrerenderStreamResult.asPhasedStream()\n   try {\n     const prerender = require('react-dom/static.edge')\n@@ -2476,7 +2477,12 @@ async function spawnDynamicValidationInDev(\n                 isPrerenderInterruptedError(err) ||\n                 finalClientController.signal.aborted\n               ) {\n-                requestStore.usedDynamic = true\n+                if (!rootDidError) {\n+                  // If the root errored before we observe this error then it wasn't caused by something dynamic.\n+                  // If the root did not error or is erroring because of a sync dynamic API or a prerender interrupt error\n+                  // then we are a dynamic route.\n+                  requestStore.usedDynamic = true\n+                }\n \n                 const componentStack = errorInfo.componentStack\n                 if (typeof componentStack === 'string') {\n@@ -2501,6 +2507,7 @@ async function spawnDynamicValidationInDev(\n       }\n     )\n   } catch (err) {\n+    rootDidError = true\n     if (\n       isPrerenderInterruptedError(err) ||\n       finalClientController.signal.aborted"
        },
        {
            "sha": "63329722af0ed0dda2e029485e28caf6940a5ef1",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9216ab130c0d61929b73445de812ebf2e904d804/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=9216ab130c0d61929b73445de812ebf2e904d804",
            "patch": "@@ -600,11 +600,7 @@ export default abstract class Server<\n       isExperimentalCompile: this.nextConfig.experimental.isExperimentalCompile,\n       // `htmlLimitedBots` is passed to server as serialized config in string format\n       htmlLimitedBots: this.nextConfig.htmlLimitedBots,\n-      streamingMetadata:\n-        // Disable streaming metadata when dynamic IO is enabled.\n-        // FIXME: remove dynamic IO guard once we fixed the dynamic indicator case.\n-        // test/e2e/app-dir/dynamic-io/dynamic-io.test.ts - should not have static indicator on not-found route\n-        !this.nextConfig.experimental.dynamicIO,\n+      streamingMetadata: true,\n       experimental: {\n         expireTime: this.nextConfig.expireTime,\n         clientTraceMetadata: this.nextConfig.experimental.clientTraceMetadata,"
        },
        {
            "sha": "605d9f4cadadb7b8861b284e55a818485370f545",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/9216ab130c0d61929b73445de812ebf2e904d804/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9216ab130c0d61929b73445de812ebf2e904d804/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=9216ab130c0d61929b73445de812ebf2e904d804",
            "patch": "@@ -159,10 +159,16 @@ function runTests(options: { withMinification: boolean }) {\n           throw new Error('expected build not to fail for fully static project')\n         }\n \n-        expect(next.cliOutput).toContain('ƒ / ')\n-        const $ = await next.render$('/')\n-        expect($('#dynamic').text()).toBe('Dynamic')\n-        expect($('[data-fallback]').length).toBe(0)\n+        if (WITH_PPR) {\n+          expect(next.cliOutput).toContain('◐ / ')\n+          const $ = await next.render$('/')\n+          expect($('#dynamic').text()).toBe('Dynamic')\n+          expect($('[data-fallback]').length).toBe(1)\n+        } else {\n+          expect(next.cliOutput).toContain('ƒ / ')\n+          const $ = await next.render$('/')\n+          expect($('#dynamic').text()).toBe('Dynamic')\n+        }\n       })\n     })\n "
        }
    ],
    "stats": {
        "total": 41,
        "additions": 21,
        "deletions": 20
    }
}