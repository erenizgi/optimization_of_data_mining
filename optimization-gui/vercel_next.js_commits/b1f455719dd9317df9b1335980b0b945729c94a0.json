{
    "author": "gusfune",
    "message": "Refactor GTM implementation to support google tag gateway (#81011)\n\n### What?\n\nThis PR refactors the Google Tag Manager implementation on\n`@next/third-parties`, it rewrites the implementation of the script url,\nparams and types to allow `gtmId` to be optional when a script URL is\nprovided.\n\n### Why?\n\nGoogle released [Google Tag Gateway for\nAdvertisers](https://developers.google.com/tag-platform/tag-manager/gateway/setup-guide?setup=manual)\nwhich allows first-party tracking on GTM. When running GTM using the\ncurrent implementation, it doesn't work because the `?id=` is hardcoded\ninto the implementation as it doesn't consider the possibility of tag\ngateway or any other setup where the ID is already part of the url.\n\n### How?\n\n- Expanded the types\n- Refactored the initialisation of the script URL\n- Updated documentation relevant to GTM\n\nCloses #81009\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "b1f455719dd9317df9b1335980b0b945729c94a0",
    "files": [
        {
            "sha": "d4560b0e00a425d33ec006d56d03655079195be3",
            "filename": "docs/01-app/02-guides/third-party-libraries.mdx",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/b1f455719dd9317df9b1335980b0b945729c94a0/docs%2F01-app%2F02-guides%2Fthird-party-libraries.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b1f455719dd9317df9b1335980b0b945729c94a0/docs%2F01-app%2F02-guides%2Fthird-party-libraries.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fthird-party-libraries.mdx?ref=b1f455719dd9317df9b1335980b0b945729c94a0",
            "patch": "@@ -174,14 +174,16 @@ use `gtmScriptUrl` option to specify the URL of the script.\n Options to pass to the Google Tag Manager. For a full list of options, read the [Google Tag Manager\n docs](https://developers.google.com/tag-platform/tag-manager/datalayer).\n \n-| Name            | Type     | Description                                                              |\n-| --------------- | -------- | ------------------------------------------------------------------------ |\n-| `gtmId`         | Required | Your GTM container ID. Usually starts with `GTM-`.                       |\n-| `gtmScriptUrl`  | Optional | GTM script URL. Defaults to `https://www.googletagmanager.com/gtm.js`.   |\n-| `dataLayer`     | Optional | Data layer object to instantiate the container with.                     |\n-| `dataLayerName` | Optional | Name of the data layer. Defaults to `dataLayer`.                         |\n-| `auth`          | Optional | Value of authentication parameter (`gtm_auth`) for environment snippets. |\n-| `preview`       | Optional | Value of preview parameter (`gtm_preview`) for environment snippets.     |\n+| Name            | Type       | Description                                                              |\n+| --------------- | ---------- | ------------------------------------------------------------------------ |\n+| `gtmId`         | Required\\* | Your GTM container ID. Usually starts with `GTM-`.                       |\n+| `gtmScriptUrl`  | Optional\\* | GTM script URL. Defaults to `https://www.googletagmanager.com/gtm.js`.   |\n+| `dataLayer`     | Optional   | Data layer object to instantiate the container with.                     |\n+| `dataLayerName` | Optional   | Name of the data layer. Defaults to `dataLayer`.                         |\n+| `auth`          | Optional   | Value of authentication parameter (`gtm_auth`) for environment snippets. |\n+| `preview`       | Optional   | Value of preview parameter (`gtm_preview`) for environment snippets.     |\n+\n+\\*`gtmId` can be omitted when `gtmScriptUrl` is provided to support [Google tag gateway for advertisers](https://developers.google.com/tag-platform/tag-manager/gateway/setup-guide?setup=manual).\n \n ### Google Analytics\n "
        },
        {
            "sha": "40a2e8ee784ed9f93ed7f029798acccf5ed9a27a",
            "filename": "packages/third-parties/src/google/gtm.tsx",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/b1f455719dd9317df9b1335980b0b945729c94a0/packages%2Fthird-parties%2Fsrc%2Fgoogle%2Fgtm.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b1f455719dd9317df9b1335980b0b945729c94a0/packages%2Fthird-parties%2Fsrc%2Fgoogle%2Fgtm.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fthird-parties%2Fsrc%2Fgoogle%2Fgtm.tsx?ref=b1f455719dd9317df9b1335980b0b945729c94a0",
            "patch": "@@ -10,7 +10,7 @@ let currDataLayerName = 'dataLayer'\n export function GoogleTagManager(props: GTMParams) {\n   const {\n     gtmId,\n-    gtmScriptUrl = 'https://www.googletagmanager.com/gtm.js',\n+    gtmScriptUrl,\n     dataLayerName = 'dataLayer',\n     auth,\n     preview,\n@@ -20,9 +20,22 @@ export function GoogleTagManager(props: GTMParams) {\n \n   currDataLayerName = dataLayerName\n \n-  const gtmLayer = dataLayerName !== 'dataLayer' ? `&l=${dataLayerName}` : ''\n-  const gtmAuth = auth ? `&gtm_auth=${auth}` : ''\n-  const gtmPreview = preview ? `&gtm_preview=${preview}&gtm_cookies_win=x` : ''\n+  const scriptUrl = new URL(\n+    gtmScriptUrl || 'https://www.googletagmanager.com/gtm.js'\n+  )\n+  if (gtmId) {\n+    scriptUrl.searchParams.set('id', gtmId)\n+  }\n+  if (dataLayerName !== 'dataLayer') {\n+    scriptUrl.searchParams.set('l', dataLayerName)\n+  }\n+  if (auth) {\n+    scriptUrl.searchParams.set('gtm_auth', auth)\n+  }\n+  if (preview) {\n+    scriptUrl.searchParams.set('gtm_preview', preview)\n+    scriptUrl.searchParams.set('gtm_cookies_win', 'x')\n+  }\n \n   useEffect(() => {\n     // performance.mark is being used as a feature use signal. While it is traditionally used for performance\n@@ -54,7 +67,7 @@ export function GoogleTagManager(props: GTMParams) {\n       <Script\n         id=\"_next-gtm\"\n         data-ntpc=\"GTM\"\n-        src={`${gtmScriptUrl}?id=${gtmId}${gtmLayer}${gtmAuth}${gtmPreview}`}\n+        src={scriptUrl.href}\n         nonce={nonce}\n       />\n     </>"
        },
        {
            "sha": "31d600c12d6bbe2bfac3a0230aeb93701f62069a",
            "filename": "packages/third-parties/src/types/google.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b1f455719dd9317df9b1335980b0b945729c94a0/packages%2Fthird-parties%2Fsrc%2Ftypes%2Fgoogle.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b1f455719dd9317df9b1335980b0b945729c94a0/packages%2Fthird-parties%2Fsrc%2Ftypes%2Fgoogle.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fthird-parties%2Fsrc%2Ftypes%2Fgoogle.ts?ref=b1f455719dd9317df9b1335980b0b945729c94a0",
            "patch": "@@ -12,16 +12,26 @@ type JSONValue =\n   | JSONValue[]\n   | { [key: string]: JSONValue }\n \n-export type GTMParams = {\n-  gtmId: string\n-  gtmScriptUrl?: string\n+type GTMParamsBaseParams = {\n   dataLayer?: { [key: string]: JSONValue }\n   dataLayerName?: string\n   auth?: string\n   preview?: string\n   nonce?: string\n }\n \n+type GTMParamsWithId = GTMParamsBaseParams & {\n+  gtmId: string\n+  gtmScriptUrl?: string\n+}\n+\n+type GTMParamsWithScriptUrl = GTMParamsBaseParams & {\n+  gtmId?: string\n+  gtmScriptUrl: string\n+}\n+\n+export type GTMParams = GTMParamsWithId | GTMParamsWithScriptUrl\n+\n export type GAParams = {\n   gaId: string\n   dataLayerName?: string"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 41,
        "deletions": 16
    }
}