{
    "author": "devjiwonchoi",
    "message": "Fixed rewrite param parsing for interception routes in Vercel deployments (#79204)\n\n> [!NOTE]\r\n> - Introduced in [PR #67400](https://github.com/vercel/next.js/pull/67400) and released in [v15.0.0-canary.54](https://github.com/vercel/next.js/releases/tag/v15.0.0-canary.54)\r\n> - See failed test in deployment [GitHub Actions Run](https://github.com/vercel/next.js/actions/runs/15083957601/job/42405327124?pr=79204#step:34:92)\r\n\r\n### Summary\r\n\r\nThis PR resolves two issues related to interception routes and rewrite behavior in Vercel deployments:\r\n\r\n1. Rewrite params not parsed correctly from the `NEXT_ROUTER_STATE_TREE_HEADER`, resulting in server crashes due to missing dynamic params.\r\n2. Malformed search query from Vercel deployment, where unresolved dynamic params like `:foo_id` were passed instead of actual values like `1`.\r\n\r\nThese issues caused runtime errors and incorrect component behavior during navigation in deployed environments. This PR ensures consistent param resolution across local and deployed environments.\r\n\r\n### Issue 1: Missing Rewrite Params in Vercel\r\n\r\nThe `NEXT_ROUTER_STATE_TREE_HEADER` header, introduced in PR [#67400](https://github.com/vercel/next.js/pull/67400), wasn't parsed correctly during Vercel deployment. This was fine locally with `next start`, which uses [`getResolveRoutes`](https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/packages/next/src/shared/lib/router/utils/resolve-rewrites.ts#L14), but broke in Vercel which used [`handleRewrites`](https://github.com/vercel/next.js/blob/42b1c400c977cbe43147c083714e7f6bd38cff80/packages/next/src/server/server-utils.ts#L208).\r\n\r\n```\r\nTypeError: Expected \"<a_dynamic_route_slug>\" to be a string\r\n    at async Object.handler (___next_launcher.cjs:58:5)\r\n    at async Server.r (../../opt/rust/nodejs.js:2:14674)\r\n    at async Server.<anonymous> (../../opt/rust/nodejs.js:16:6262)\r\n```\r\n\r\nThis occurred because the expected dynamic route params were undefined, causing `path-to-regexp` to throw when trying to compile the destination path.\r\n\r\n### Solution\r\n\r\nWe ported the interception route rewrite logic from PR #67400, allowing consistent resolution of route params from the `NEXT_ROUTER_STATE_TREE_HEADER`.\r\n\r\n### Issue 2: Malformed Query from Vercel\r\n\r\nEven after correct interception routing, the query string received from Vercel contained unresolved params such as `:foo_id`, resulting in:\r\n\r\n```ts\r\n{\r\n  rsc: 'aaaaa',\r\n  nxtPfoo_id: ':foo_id',\r\n  nxtPbar_id: ':bar_id',\r\n  nxtPbaz: '1',\r\n}\r\n```\r\n\r\nInstead of the expected:\r\n\r\n```ts\r\n{\r\n  rsc: 'aaaaa',\r\n  nxtPfoo_id: '1',\r\n  nxtPbar_id: '1',\r\n  nxtPbaz: '1',\r\n}\r\n```\r\n\r\nThis happened because the rewrite rule:\r\n\r\n```json\r\n{\r\n  \"source\": \"/:baz_id\",\r\n  \"destination\": \"/:foo_id/:bar_id/(...)baz/:baz_id\",\r\n  ...\r\n}\r\n```\r\n\r\nDid not include `:foo_id` or `:bar_id` in the `source`, so they were never correctly mapped by Vercel CLI's [`convertRewrites`](https://github.com/vercel/vercel/blob/53e3609f144d08ad92d42291bcbf483ae592ff1b/packages/routing-utils/src/superstatic.ts#L165).\r\n\r\n### Solution\r\n\r\nSince we already parse rewrite params from the `NEXT_ROUTER_STATE_TREE_HEADER`, we now inject those resolved values into `parsedUrl.query`. If any query value still starts with `:`, it's treated as unexpected and replaced with the rewrite params accordingly.",
    "sha": "8eaf44b0364b7bca794918da990f8c73420cff7f",
    "files": [
        {
            "sha": "753479a46fb75e2ec43e1159d766df968e946b62",
            "filename": ".changeset/shaggy-owls-visit.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/.changeset%2Fshaggy-owls-visit.md",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/.changeset%2Fshaggy-owls-visit.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fshaggy-owls-visit.md?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'next': patch\n+---\n+\n+Fixed rewrite params of the interception routes not being parsed correctly in certain deployed environments"
        },
        {
            "sha": "a2089d8a118052794a3a6f7dd533c86e271e6e89",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 1,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -27,6 +27,10 @@ import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import { parseReqUrl } from '../lib/url'\n import { formatUrl } from '../shared/lib/router/utils/format-url'\n+import { parseAndValidateFlightRouterState } from './app-render/parse-and-validate-flight-router-state'\n+import { isInterceptionRouteRewrite } from '../lib/generate-interception-routes-rewrites'\n+import { NEXT_ROUTER_STATE_TREE_HEADER } from '../client/components/app-router-headers'\n+import { getSelectedParams } from '../client/components/router-reducer/compute-changed-path'\n \n export function normalizeCdnUrl(\n   req: BaseNextRequest | IncomingMessage,\n@@ -209,7 +213,7 @@ export function getServerUtils({\n     req: BaseNextRequest | IncomingMessage,\n     parsedUrl: UrlWithParsedQuery\n   ) {\n-    const rewriteParams = {}\n+    const rewriteParams: Record<string, string> = {}\n     let fsPathname = parsedUrl.pathname\n \n     const matchesPage = () => {\n@@ -250,6 +254,28 @@ export function getServerUtils({\n       }\n \n       if (params) {\n+        try {\n+          // An interception rewrite might reference a dynamic param for a route the user\n+          // is currently on, which wouldn't be extractable from the matched route params.\n+          // This attempts to extract the dynamic params from the provided router state.\n+          if (isInterceptionRouteRewrite(rewrite as Rewrite)) {\n+            const stateHeader =\n+              req.headers[NEXT_ROUTER_STATE_TREE_HEADER.toLowerCase()]\n+\n+            if (stateHeader) {\n+              params = {\n+                ...getSelectedParams(\n+                  parseAndValidateFlightRouterState(stateHeader)\n+                ),\n+                ...params,\n+              }\n+            }\n+          }\n+        } catch (err) {\n+          // this is a no-op -- we couldn't extract dynamic params from the provided router state,\n+          // so we'll just use the params from the route matcher\n+        }\n+\n         const { parsedDestination, destQuery } = prepareDestination({\n           appendParamsToQuery: true,\n           destination: rewrite.destination,\n@@ -266,6 +292,20 @@ export function getServerUtils({\n         Object.assign(parsedUrl.query, parsedDestination.query)\n         delete (parsedDestination as any).query\n \n+        // for each property in parsedUrl.query, if the value is parametrized (eg :foo), look up the value\n+        // in rewriteParams and replace the parametrized value with the actual value\n+        // this is used when the rewrite destination does not contain the original source param\n+        // and so the value is still parametrized and needs to be replaced with the actual rewrite param\n+        Object.entries(parsedUrl.query).forEach(([key, value]) => {\n+          if (value && typeof value === 'string' && value.startsWith(':')) {\n+            const paramName = value.slice(1)\n+            const actualValue = rewriteParams[paramName]\n+            if (actualValue) {\n+              parsedUrl.query[key] = actualValue\n+            }\n+          }\n+        })\n+\n         Object.assign(parsedUrl, parsedDestination)\n \n         fsPathname = parsedUrl.pathname"
        },
        {
            "sha": "fb74958818b639b2c992588dff867cddf1ee3f99",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/[foo_id]/[bar_id]/@modal/(...)baz_id/[baz_id]/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2F(...)baz_id%2F%5Bbaz_id%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2F(...)baz_id%2F%5Bbaz_id%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2F(...)baz_id%2F%5Bbaz_id%5D%2Fpage.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Home() {\n+  return <p>intercepted!</p>\n+}"
        },
        {
            "sha": "86b9e9a3881296c372d3f1de5b6988d1d31e3c9d",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/[foo_id]/[bar_id]/@modal/default.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2Fdefault.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2F%40modal%2Fdefault.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Default() {\n+  return null\n+}"
        },
        {
            "sha": "0cda69171476d30b43c6184d384baa9d4d1c0ae0",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/[foo_id]/[bar_id]/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Flayout.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,11 @@\n+export default function Layout(props: {\n+  children: React.ReactNode\n+  modal: React.ReactNode\n+}) {\n+  return (\n+    <>\n+      {props.children}\n+      {props.modal}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "2031ee0444a6fed302237a5d5c57f32eb27240df",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/[foo_id]/[bar_id]/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2F%5Bfoo_id%5D%2F%5Bbar_id%5D%2Fpage.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,15 @@\n+import Link from 'next/link'\n+\n+export default async function Page(props: {\n+  params: Promise<{ foo_id: string; bar_id: string }>\n+}) {\n+  const params = await props.params\n+  return (\n+    <>\n+      <h1>\n+        foo id {params.foo_id}, bar id {params.bar_id}\n+      </h1>\n+      <Link href=\"/baz_id/1\">Link to bug report 1</Link>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "60c78e250e33a878e6de04e6aa69c8a7033b3ab7",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/baz_id/[baz_id]/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fbaz_id%2F%5Bbaz_id%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fbaz_id%2F%5Bbaz_id%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fbaz_id%2F%5Bbaz_id%5D%2Fpage.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,8 @@\n+export default async function Home({\n+  params,\n+}: {\n+  params: Promise<{ baz_id: string }>\n+}) {\n+  const { baz_id } = await params\n+  return <p>baz_id/{baz_id}</p>\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Flayout.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "1e3702164201f7555da9c7ab19902bdfd1eec60b",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/app/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fapp%2Fpage.tsx?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,5 @@\n+import Link from 'next/link'\n+\n+export default function Home() {\n+  return <Link href=\"/1/1\">Start from /1/1</Link>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fnext.config.js?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "851b2467fbcae51515514239ae4254dd03a4cc75",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception-nested-dynamic-routes/parallel-routes-and-interception-nested-dynamic-routes.test.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fparallel-routes-and-interception-nested-dynamic-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8eaf44b0364b7bca794918da990f8c73420cff7f/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fparallel-routes-and-interception-nested-dynamic-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception-nested-dynamic-routes%2Fparallel-routes-and-interception-nested-dynamic-routes.test.ts?ref=8eaf44b0364b7bca794918da990f8c73420cff7f",
            "patch": "@@ -0,0 +1,22 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('parallel-routes-and-interception-nested-dynamic-routes', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should intercept the route for nested dynamic routes', async () => {\n+    const browser = await next.browser('/1/1')\n+    expect(await browser.elementByCss('h1').text()).toBe('foo id 1, bar id 1')\n+    await browser.elementByCss('a').click()\n+\n+    // Should intercept the route.\n+    expect(await browser.waitForElementByCss('p').text()).toBe('intercepted!')\n+    // Should preserve the previous component.\n+    expect(await browser.elementByCss('h1').text()).toBe('foo id 1, bar id 1')\n+\n+    await browser.refresh()\n+    // Should display the correct /baz_id/1 content.\n+    expect(await browser.waitForElementByCss('p').text()).toBe('baz_id/1')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 130,
        "deletions": 1
    }
}