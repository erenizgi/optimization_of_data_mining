{
    "author": "bgw",
    "message": "Turbopack: Fix logic in HMR logging code that could emit a NaN build time (#82389)\n\nThe goal of this module is to avoid logging no-op build events. Turbopack uses a bottom-up execution model which leads to a lot of really short no-op \"building\" events that we try to filter out.\n\nIf `onBuilding` isn't called before `onBuilt`, then `deferredReportHmrStartId` will be `undefined` here, causing us to report the end of a build. Since `onBuilding` wasn't called yet, the start time will be `undefined`, giving us a duration of `NaN`.\n\nWe were using `deferredReportHmrStartId` to try to determine when we'd already reported the start of a build, but it wasn't quite right. Instead, use a separate, more explicit, variable for that.\n\n---\n\nhttps://vercel.slack.com/archives/C046HAU4H7F/p1749456305992089?thread_ts=1749455727.004169&cid=C046HAU4H7F\n\n> we fire the BUILDING event from the server, before a client is present, then the client attaches, and eventually  BUILT is sent and we trigger the NaN ms log\n\nThanks for the root-causing help, @icyJoseph\n\n---\n\nTested by loading `pnpm next dev --turbopack examples/basic-css/` and modifying the source code to trigger HMRs.\n\n![Screenshot 2025-08-05 at 6.09.47â€¯PM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/6ee43248-af68-4478-ac9f-93ea6a3d3a51.png)",
    "sha": "6c1f0ee4fa50905a742f13e269f62421ce8c3881",
    "files": [
        {
            "sha": "51e60905d06f4865d499ae1ff68b8e804efdc8b3",
            "filename": "packages/next/src/client/dev/hot-reloader/turbopack-hot-reloader-common.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6c1f0ee4fa50905a742f13e269f62421ce8c3881/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fturbopack-hot-reloader-common.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6c1f0ee4fa50905a742f13e269f62421ce8c3881/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fturbopack-hot-reloader-common.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fturbopack-hot-reloader-common.ts?ref=6c1f0ee4fa50905a742f13e269f62421ce8c3881",
            "patch": "@@ -23,9 +23,11 @@ export class TurbopackHmr {\n   #startMsSinceEpoch: number | undefined\n   #lastUpdateMsSinceEpoch: number | undefined\n   #deferredReportHmrStartId: ReturnType<typeof setTimeout> | undefined\n+  #reportedHmrStart: boolean\n \n   constructor() {\n     this.#updatedModules = new Set()\n+    this.#reportedHmrStart = false\n   }\n \n   // HACK: Turbopack tends to generate a lot of irrelevant \"BUILDING\" actions,\n@@ -39,6 +41,7 @@ export class TurbopackHmr {\n   #runDeferredReportHmrStart() {\n     if (this.#deferredReportHmrStartId != null) {\n       console.log('[Fast Refresh] rebuilding')\n+      this.#reportedHmrStart = true\n       this.#cancelDeferredReportHmrStart()\n     }\n   }\n@@ -102,7 +105,7 @@ export class TurbopackHmr {\n     // which can happen during initial page load. Ignore that too!\n     const hasUpdates =\n       this.#lastUpdateMsSinceEpoch != null && this.#startMsSinceEpoch != null\n-    if (!hasUpdates && this.#deferredReportHmrStartId != null) {\n+    if (!hasUpdates && !this.#reportedHmrStart) {\n       // suppress the update entirely\n       this.#cancelDeferredReportHmrStart()\n       return null\n@@ -116,6 +119,7 @@ export class TurbopackHmr {\n       endMsSinceEpoch: this.#lastUpdateMsSinceEpoch ?? Date.now(),\n     }\n     this.#updatedModules = new Set()\n+    this.#reportedHmrStart = false\n     return result\n   }\n }"
        }
    ],
    "stats": {
        "total": 6,
        "additions": 5,
        "deletions": 1
    }
}