{
    "author": "lukesandberg",
    "message": "[turbopack] Rename is_marked_as_side_effect_free to side_effects and return ModuleSideEffects enum (#87102)\n\nRefactor the  `is_marked_side_effect_free` API\n\n* Rename `side_effects`\n* Change it to return `ModuleSideEffects` instead of a `bool`\n* Remove the `side_effect_packages` from its parameters, instead arrange to pass that to the EcmascriptModule constructor since that is where we need it.\n     - This cleans up callsites and fixes a tiny issue where we construct that glob multiple times.",
    "sha": "5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
    "files": [
        {
            "sha": "abbed4209daba52895dc081096c75e0da31bca6b",
            "filename": "crates/next-core/src/hmr_entry.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fhmr_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fhmr_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fhmr_entry.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -3,15 +3,15 @@ use std::io::Write;\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n-use turbo_tasks_fs::{FileSystem, VirtualFileSystem, glob::Glob, rope::RopeBuilder};\n+use turbo_tasks_fs::{FileSystem, VirtualFileSystem, rope::RopeBuilder};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         ChunkItem, ChunkType, ChunkableModule, ChunkableModuleReference, ChunkingContext,\n         EvaluatableAsset,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::{ModuleReference, ModuleReferences},\n@@ -76,10 +76,9 @@ impl Module for HmrEntryModule {\n                 .await?,\n         )]))\n     }\n-\n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(self: Vc<Self>, _: Vc<Glob>) -> Vc<bool> {\n-        Vc::cell(false)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n     }\n }\n "
        },
        {
            "sha": "2374540ff37b7b44669a901cf0ffab663695e7fe",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -8,6 +8,7 @@ use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::{\n     CssOptionsContext, EcmascriptOptionsContext, JsxTransformOptions, ModuleRule,\n     TypescriptTransformOptions, module_options_context::ModuleOptionsContext,\n+    side_effect_free_packages_glob,\n };\n use turbopack_browser::{\n     BrowserChunkingContext, ChunkSuffix, ContentHashing, CurrentChunkMethod,\n@@ -337,7 +338,11 @@ pub async fn get_client_module_options_context(\n         execution_context: Some(execution_context),\n         tree_shaking_mode: tree_shaking_mode_for_user_code,\n         enable_postcss_transform,\n-        side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n+        side_effect_free_packages: Some(\n+            side_effect_free_packages_glob(next_config.optimize_package_imports())\n+                .to_resolved()\n+                .await?,\n+        ),\n         keep_last_successful_parse: next_mode.is_development(),\n         analyze_mode: if next_mode.is_development() {\n             AnalyzeMode::CodeGeneration"
        },
        {
            "sha": "fc059495d68818cfcc0c93523dfd068e91e4c4a4",
            "filename": "crates/next-core/src/next_client_reference/css_client_reference/css_client_reference_module.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fcss_client_reference%2Fcss_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fcss_client_reference%2Fcss_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fcss_client_reference%2Fcss_client_reference_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -6,7 +6,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkGroupType, ChunkableModuleReference, ChunkingType, ChunkingTypeOption},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     reference::{ModuleReference, ModuleReferences},\n     resolve::ModuleResolveResult,\n     source::OptionSource,\n@@ -57,6 +57,10 @@ impl Module for CssClientReferenceModule {\n                 .await?,\n         )]))\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "8afd9b5af6729f1566de8ba1e8e41c704545e940",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -14,7 +14,7 @@ use turbopack_core::{\n     code_builder::CodeBuilder,\n     context::AssetContext,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::{ModuleGraph, binding_usage_info::ModuleExportUsageInfo},\n     output::OutputAssetsReference,\n     reference::{ModuleReference, ModuleReferences},\n@@ -241,6 +241,12 @@ impl Module for EcmascriptClientReferenceModule {\n \n         Ok(Vc::cell(references))\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // These just re-export some specially tagged functions, however we do assume that client\n+        // references are executed client side so we need to preserve these in the graph.\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "07a0c3b6b1225aea23ae231dd58efdd177977fa4",
            "filename": "crates/next-core/src/next_dynamic/dynamic_module.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext, ModuleChunkItemIdExt},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n@@ -71,6 +71,11 @@ impl Module for NextDynamicEntryModule {\n             .await?,\n         )]))\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // This just exports another import\n+        ModuleSideEffects::ModuleEvaluationIsSideEffectFree.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "df8f24c28d55b19aad0ff27e7732af0b4de1466e",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -9,6 +9,7 @@ use turbopack::{\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, ExternalsTracingOptions, JsxTransformOptions,\n         ModuleOptionsContext, ModuleRule, TypescriptTransformOptions,\n+        side_effect_free_packages_glob,\n     },\n     transition::Transition,\n };\n@@ -592,7 +593,11 @@ pub async fn get_server_module_options_context(\n             ..Default::default()\n         },\n         tree_shaking_mode: tree_shaking_mode_for_user_code,\n-        side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n+        side_effect_free_packages: Some(\n+            side_effect_free_packages_glob(next_config.optimize_package_imports())\n+                .to_resolved()\n+                .await?,\n+        ),\n         analyze_mode: if next_mode.is_development() {\n             AnalyzeMode::CodeGeneration\n         } else {"
        },
        {
            "sha": "e3f65fe7d18a339534c558e147e559d5908bdabc",
            "filename": "crates/next-core/src/next_server_component/server_component_module.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext, ModuleChunkItemIdExt},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::ModuleReferences,\n@@ -67,6 +67,11 @@ impl Module for NextServerComponentModule {\n                 .await?,\n         )]))\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // This just exports another import\n+        ModuleSideEffects::ModuleEvaluationIsSideEffectFree.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "dd2b7c41f95922348e5f8a90d8c0afb89513a8b3",
            "filename": "crates/next-core/src/next_server_utility/server_utility_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext, ModuleChunkItemIdExt},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::ModuleReferences,\n@@ -67,6 +67,12 @@ impl Module for NextServerUtilityModule {\n                 .await?,\n         )]))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // This just exports another import\n+        ModuleSideEffects::ModuleEvaluationIsSideEffectFree.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "3d67d9fea8540bb8a85786f456676b473dab5793",
            "filename": "crates/next-core/src/raw_ecmascript_module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fraw_ecmascript_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/crates%2Fnext-core%2Fsrc%2Fraw_ecmascript_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fraw_ecmascript_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -7,7 +7,7 @@ use regex::Regex;\n use tracing::Instrument;\n use turbo_rcstr::rcstr;\n use turbo_tasks::{FxIndexMap, FxIndexSet, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n-use turbo_tasks_fs::{FileContent, glob::Glob, rope::Rope};\n+use turbo_tasks_fs::{FileContent, rope::Rope};\n use turbopack::{ModuleAssetContext, module_options::CustomModuleType};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -18,7 +18,7 @@ use turbopack_core::{\n     },\n     context::AssetContext,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     resolve::ModulePart,\n@@ -99,11 +99,8 @@ impl Module for RawEcmascriptModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(false)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n     }\n }\n "
        },
        {
            "sha": "8f9177907a26d594c6016b9ec855d9d575ce1afc",
            "filename": "turbopack/crates/turbopack-core/src/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::{Result, bail};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::{FileSystemPath, glob::Glob};\n+use turbo_tasks_fs::FileSystemPath;\n \n use crate::{\n     compile_time_info::CompileTimeInfo,\n@@ -104,7 +104,4 @@ pub trait AssetContext {\n     /// Gets a new AssetContext with the transition applied.\n     #[turbo_tasks::function]\n     fn with_transition(self: Vc<Self>, transition: RcStr) -> Vc<Box<dyn AssetContext>>;\n-\n-    #[turbo_tasks::function]\n-    fn side_effect_free_packages(self: Vc<Self>) -> Vc<Glob>;\n }"
        },
        {
            "sha": "b55a6dd35394d9f50fc4d3908dcabf8bda48ce11",
            "filename": "turbopack/crates/turbopack-core/src/module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 13,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,8 +1,5 @@\n-use bincode::{Decode, Encode};\n-use serde::{Deserialize, Serialize};\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, ValueToString, Vc, trace::TraceRawVcs};\n-use turbo_tasks_fs::glob::Glob;\n+use turbo_tasks::{ResolvedVc, TaskInput, ValueToString, Vc};\n \n use crate::{asset::Asset, ident::AssetIdent, reference::ModuleReferences, source::OptionSource};\n \n@@ -13,9 +10,8 @@ pub enum StyleType {\n     GlobalStyle,\n }\n \n-#[derive(\n-    Serialize, Deserialize, Hash, Eq, PartialEq, Debug, NonLocalValue, TraceRawVcs, Encode, Decode,\n-)]\n+#[derive(Hash, Debug, Copy, Clone)]\n+#[turbo_tasks::value(shared)]\n pub enum ModuleSideEffects {\n     /// Analysis determined that the module evaluation is side effect free\n     /// the module may still be side effectful based on its imports.\n@@ -64,12 +60,7 @@ pub trait Module: Asset {\n \n     /// Returns true if the module is marked as side effect free in package.json or by other means.\n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(false)\n-    }\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects>;\n }\n \n #[turbo_tasks::value_trait]"
        },
        {
            "sha": "4e098c2f1135c540f71809c64d6c9217bdcb0062",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -48,6 +48,7 @@ pub mod chunk_group_info;\n pub mod merged_modules;\n pub mod module_batch;\n pub(crate) mod module_batches;\n+mod side_effect_module_info;\n pub(crate) mod style_groups;\n mod traced_di_graph;\n \n@@ -1959,7 +1960,7 @@ pub mod tests {\n     use crate::{\n         asset::{Asset, AssetContent},\n         ident::AssetIdent,\n-        module::Module,\n+        module::{Module, ModuleSideEffects},\n         module_graph::{\n             GraphEntries, GraphTraversalAction, ModuleGraph, ModuleGraphRef, SingleModuleGraph,\n             VisitedModules, chunk_group_info::ChunkGroupEntry,\n@@ -2357,6 +2358,10 @@ pub mod tests {\n \n             Ok(Vc::cell(references))\n         }\n+        #[turbo_tasks::function]\n+        fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+            ModuleSideEffects::SideEffectful.cell()\n+        }\n     }\n \n     /// Constructs a graph based on the provided dependency adjacency lists and calls the given test"
        },
        {
            "sha": "d643b93f119c02eff570dd3e87e57659dcbf4b5e",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/side_effect_module_info.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fside_effect_module_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fside_effect_module_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fside_effect_module_info.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -15,7 +15,7 @@ pub struct SideEffectFreeModules(FxHashSet<ResolvedVc<Box<dyn Module>>>);\n \n /// Computes the set of side effect free modules in the module graph.\n ///\n-/// This leverages the module graph to compute if modules with `ModuleEvalutationIsSideEffectFree`\n+/// This leverages the module graph to compute if modules with `ModuleEvaluationIsSideEffectFree`\n /// status are actually side effectful or not.\n ///\n /// A current limitation is that the module graph doesn't contain information on how 'late' imports"
        },
        {
            "sha": "3c359537e84bdbdf0655794b5d50adb86582b084",
            "filename": "turbopack/crates/turbopack-core/src/node_addon_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fnode_addon_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fnode_addon_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fnode_addon_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -10,7 +10,7 @@ use crate::{\n     asset::{Asset, AssetContent},\n     file_source::FileSource,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     raw_module::RawModule,\n     reference::{ModuleReferences, TracedModuleReference},\n     resolve::pattern::{Pattern, PatternMatch, read_matches},\n@@ -100,6 +100,12 @@ impl Module for NodeAddonModule {\n         // Most addon modules don't have references to other modules.\n         Ok(ModuleReferences::empty())\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // We assume that a node addon could have arbitrary side effects when loading.\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "cc0b430eeed33fde58305aab33b4f1bf70f3c07c",
            "filename": "turbopack/crates/turbopack-core/src/raw_module.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fraw_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fraw_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fraw_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -3,11 +3,11 @@ use turbo_tasks::{ResolvedVc, Vc};\n use crate::{\n     asset::{Asset, AssetContent},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     source::{OptionSource, Source},\n };\n \n-/// A module where source code doesn't need to be parsed but can be usd as is.\n+/// A module where source code doesn't need to be parsed but can be used as is.\n /// This module has no references to other modules.\n #[turbo_tasks::value]\n pub struct RawModule {\n@@ -25,6 +25,10 @@ impl Module for RawModule {\n     fn source(&self) -> Vc<OptionSource> {\n         Vc::cell(Some(self.source))\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "9cd9b5e4b38f7d2c189215893f71afcc8dbc35e4",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -8,7 +8,7 @@ use turbopack_core::{\n     context::AssetContext,\n     environment::Environment,\n     ident::AssetIdent,\n-    module::{Module, StyleModule, StyleType},\n+    module::{Module, ModuleSideEffects, StyleModule, StyleType},\n     module_graph::ModuleGraph,\n     output::{OutputAssetsReference, OutputAssetsWithReferenced},\n     reference::{ModuleReference, ModuleReferences},\n@@ -153,6 +153,11 @@ impl Module for CssModuleAsset {\n             ParseCssResult::NotFound => Ok(ModuleReferences::empty()),\n         }\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // global css is always a side effect\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "4179333ba55ad626936e345c183a26abc6fd0178",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -16,7 +16,7 @@ use turbopack_core::{\n         Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource,\n         OptionStyledString, StyledString,\n     },\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::{ModuleReference, ModuleReferences},\n@@ -111,6 +111,13 @@ impl Module for ModuleCssAsset {\n \n         Ok(Vc::cell(references))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // modules can still effect global styles using `:root` selectors and other similar features\n+        // We could do better with some static analysis if we want\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "b65c7b5c8ca7c4fab34dcf4dc179388bc7df79f2",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -77,6 +77,7 @@ async fn setup(\n         layer,\n     }\n     .resolved_cell();\n+\n     let module = EcmascriptModuleAsset::builder(\n         ResolvedVc::upcast(\n             FileSource::new(fs.root().await?.join(file).unwrap())\n@@ -96,6 +97,7 @@ async fn setup(\n         }\n         .resolved_cell(),\n         compile_time_info,\n+        None,\n     )\n     .build()\n     .to_resolved()"
        },
        {
            "sha": "4b35fa32b7da700ef79babb06801c63e13d0862e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/async_chunk/module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fmodule.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,12 +1,11 @@\n use anyhow::Result;\n use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkableModule, ChunkingContext, availability_info::AvailabilityInfo},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::{ModuleReferences, SingleModuleReference},\n };\n@@ -68,11 +67,8 @@ impl Module for AsyncLoaderModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "48afa09dd8ece2a7a35c26556f79f26d6d3dc5ca",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/placeable.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 8,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -179,31 +179,53 @@ impl Issue for SideEffectsInPackageJsonIssue {\n     }\n }\n \n+#[turbo_tasks::value(shared)]\n+#[derive(Copy, Clone)]\n+pub enum SideEffectsDeclaration {\n+    SideEffectFree,\n+    SideEffectful,\n+    None,\n+}\n+\n #[turbo_tasks::function]\n-pub async fn is_marked_as_side_effect_free(\n+pub async fn get_side_effect_free_declaration(\n     path: FileSystemPath,\n-    side_effect_free_packages: Vc<Glob>,\n-) -> Result<Vc<bool>> {\n-    if side_effect_free_packages.await?.matches(&path.path) {\n-        return Ok(Vc::cell(true));\n+    side_effect_free_packages: Option<Vc<Glob>>,\n+) -> Result<Vc<SideEffectsDeclaration>> {\n+    if let Some(side_effect_free_packages) = side_effect_free_packages\n+        && side_effect_free_packages.await?.matches(&path.path)\n+    {\n+        return Ok(SideEffectsDeclaration::SideEffectFree.cell());\n     }\n \n     let find_package_json = find_context_file(path.parent(), package_json(), false).await?;\n \n     if let FindContextFileResult::Found(package_json, _) = &*find_package_json {\n         match *side_effects_from_package_json(package_json.clone()).await? {\n             SideEffectsValue::None => {}\n-            SideEffectsValue::Constant(side_effects) => return Ok(Vc::cell(!side_effects)),\n+            SideEffectsValue::Constant(side_effects) => {\n+                return Ok(if side_effects {\n+                    SideEffectsDeclaration::SideEffectful\n+                } else {\n+                    SideEffectsDeclaration::SideEffectFree\n+                }\n+                .cell());\n+            }\n             SideEffectsValue::Glob(glob) => {\n                 if let Some(rel_path) = package_json.parent().get_relative_path_to(&path) {\n                     let rel_path = rel_path.strip_prefix(\"./\").unwrap_or(&rel_path);\n-                    return Ok(Vc::cell(!glob.await?.matches(rel_path)));\n+                    return Ok(if glob.await?.matches(rel_path) {\n+                        SideEffectsDeclaration::SideEffectful\n+                    } else {\n+                        SideEffectsDeclaration::SideEffectFree\n+                    }\n+                    .cell());\n                 }\n             }\n         }\n     }\n \n-    Ok(Vc::cell(false))\n+    Ok(SideEffectsDeclaration::None.cell())\n }\n \n #[turbo_tasks::value(shared)]"
        },
        {
            "sha": "394e2d202a2b3568b6fed50e14b8e1a256f8d309",
            "filename": "turbopack/crates/turbopack-ecmascript/src/inlined_bytes_module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -3,12 +3,12 @@ use std::io::{Read, Write};\n use anyhow::{Result, bail};\n use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n-use turbo_tasks_fs::{FileContent, glob::Glob, rope::RopeBuilder};\n+use turbo_tasks_fs::{FileContent, rope::RopeBuilder};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     source::Source,\n@@ -51,11 +51,8 @@ impl Module for InlinedBytesJsModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "e0758076b87da7b1698b2a59a89b342da3005ee2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 15,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -118,7 +118,10 @@ pub use turbopack_resolve::ecmascript as resolve;\n use self::chunk::{EcmascriptChunkItemContent, EcmascriptChunkType, EcmascriptExports};\n use crate::{\n     analyzer::graph::EvalContext,\n-    chunk::{EcmascriptChunkPlaceable, placeable::is_marked_as_side_effect_free},\n+    chunk::{\n+        EcmascriptChunkPlaceable,\n+        placeable::{SideEffectsDeclaration, get_side_effect_free_declaration},\n+    },\n     code_gen::{CodeGens, ModifiableAst},\n     merged_module::MergedEcmascriptModule,\n     parse::generate_js_source_map,\n@@ -337,6 +340,7 @@ pub struct EcmascriptModuleAssetBuilder {\n     transforms: ResolvedVc<EcmascriptInputTransforms>,\n     options: ResolvedVc<EcmascriptOptions>,\n     compile_time_info: ResolvedVc<CompileTimeInfo>,\n+    side_effect_free_packages: Option<ResolvedVc<Glob>>,\n     inner_assets: Option<ResolvedVc<InnerAssets>>,\n }\n \n@@ -360,6 +364,7 @@ impl EcmascriptModuleAssetBuilder {\n                 *self.transforms,\n                 *self.options,\n                 *self.compile_time_info,\n+                self.side_effect_free_packages.map(|g| *g),\n                 *inner_assets,\n             )\n         } else {\n@@ -370,6 +375,7 @@ impl EcmascriptModuleAssetBuilder {\n                 *self.transforms,\n                 *self.options,\n                 *self.compile_time_info,\n+                self.side_effect_free_packages.map(|g| *g),\n             )\n         }\n     }\n@@ -383,6 +389,7 @@ pub struct EcmascriptModuleAsset {\n     pub transforms: ResolvedVc<EcmascriptInputTransforms>,\n     pub options: ResolvedVc<EcmascriptOptions>,\n     pub compile_time_info: ResolvedVc<CompileTimeInfo>,\n+    pub side_effect_free_packages: Option<ResolvedVc<Glob>>,\n     pub inner_assets: Option<ResolvedVc<InnerAssets>>,\n     #[turbo_tasks(debug_ignore)]\n     last_successful_parse: turbo_tasks::TransientState<ReadRef<ParseResult>>,\n@@ -396,6 +403,7 @@ impl core::fmt::Debug for EcmascriptModuleAsset {\n             .field(\"transforms\", &self.transforms)\n             .field(\"options\", &self.options)\n             .field(\"compile_time_info\", &self.compile_time_info)\n+            .field(\"side_effect_free_packages\", &self.side_effect_free_packages)\n             .field(\"inner_assets\", &self.inner_assets)\n             .finish()\n     }\n@@ -464,6 +472,7 @@ impl EcmascriptModuleAsset {\n         transforms: ResolvedVc<EcmascriptInputTransforms>,\n         options: ResolvedVc<EcmascriptOptions>,\n         compile_time_info: ResolvedVc<CompileTimeInfo>,\n+        side_effect_free_packages: Option<ResolvedVc<Glob>>,\n     ) -> EcmascriptModuleAssetBuilder {\n         EcmascriptModuleAssetBuilder {\n             source,\n@@ -472,6 +481,7 @@ impl EcmascriptModuleAsset {\n             transforms,\n             options,\n             compile_time_info,\n+            side_effect_free_packages,\n             inner_assets: None,\n         }\n     }\n@@ -633,35 +643,37 @@ async fn determine_module_type_for_directory(\n #[turbo_tasks::value_impl]\n impl EcmascriptModuleAsset {\n     #[turbo_tasks::function]\n-    pub fn new(\n+    fn new(\n         source: ResolvedVc<Box<dyn Source>>,\n         asset_context: ResolvedVc<Box<dyn AssetContext>>,\n         ty: EcmascriptModuleAssetType,\n         transforms: ResolvedVc<EcmascriptInputTransforms>,\n         options: ResolvedVc<EcmascriptOptions>,\n         compile_time_info: ResolvedVc<CompileTimeInfo>,\n+        side_effect_free_packages: Option<ResolvedVc<Glob>>,\n     ) -> Vc<Self> {\n         Self::cell(EcmascriptModuleAsset {\n             source,\n             asset_context,\n             ty,\n             transforms,\n             options,\n-\n             compile_time_info,\n+            side_effect_free_packages,\n             inner_assets: None,\n             last_successful_parse: Default::default(),\n         })\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn new_with_inner_assets(\n+    async fn new_with_inner_assets(\n         source: ResolvedVc<Box<dyn Source>>,\n         asset_context: ResolvedVc<Box<dyn AssetContext>>,\n         ty: EcmascriptModuleAssetType,\n         transforms: ResolvedVc<EcmascriptInputTransforms>,\n         options: ResolvedVc<EcmascriptOptions>,\n         compile_time_info: ResolvedVc<CompileTimeInfo>,\n+        side_effect_free_packages: Option<ResolvedVc<Glob>>,\n         inner_assets: ResolvedVc<InnerAssets>,\n     ) -> Result<Vc<Self>> {\n         if inner_assets.await?.is_empty() {\n@@ -672,6 +684,7 @@ impl EcmascriptModuleAsset {\n                 *transforms,\n                 *options,\n                 *compile_time_info,\n+                side_effect_free_packages.map(|g| *g),\n             ))\n         } else {\n             Ok(Self::cell(EcmascriptModuleAsset {\n@@ -681,6 +694,7 @@ impl EcmascriptModuleAsset {\n                 transforms,\n                 options,\n                 compile_time_info,\n+                side_effect_free_packages,\n                 inner_assets: Some(inner_assets),\n                 last_successful_parse: Default::default(),\n             }))\n@@ -768,20 +782,21 @@ impl Module for EcmascriptModuleAsset {\n     }\n \n     #[turbo_tasks::function]\n-    async fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        side_effect_free_packages: Vc<Glob>,\n-    ) -> Result<Vc<bool>> {\n+    async fn side_effects(self: Vc<Self>) -> Result<Vc<ModuleSideEffects>> {\n+        let this = self.await?;\n         // Check package.json first, so that we can skip parsing the module if it's marked that way.\n-        let pkg_side_effect_free = is_marked_as_side_effect_free(\n+        // We need to respect package.json configuration over any static analysis we might do.\n+        Ok((match *get_side_effect_free_declaration(\n             self.ident().path().owned().await?,\n-            side_effect_free_packages,\n-        );\n-        Ok(if *pkg_side_effect_free.await? {\n-            pkg_side_effect_free\n-        } else {\n-            Vc::cell(self.analyze().await?.side_effects == ModuleSideEffects::SideEffectFree)\n+            this.side_effect_free_packages.map(|g| *g),\n+        )\n+        .await?\n+        {\n+            SideEffectsDeclaration::SideEffectful => ModuleSideEffects::SideEffectful,\n+            SideEffectsDeclaration::SideEffectFree => ModuleSideEffects::SideEffectFree,\n+            SideEffectsDeclaration::None => self.analyze().await?.side_effects,\n         })\n+        .cell())\n     }\n }\n "
        },
        {
            "sha": "826ec5c644c2cfd61389786566239c6d7eaac340",
            "filename": "turbopack/crates/turbopack-ecmascript/src/manifest/chunk_asset.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,14 +1,13 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TryJoinIterExt, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         ChunkableModule, ChunkingContext, ChunkingContextExt, availability_info::AvailabilityInfo,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::{\n         ModuleGraph, chunk_group_info::ChunkGroup, module_batch::ChunkableModuleOrBatch,\n     },\n@@ -154,11 +153,8 @@ impl Module for ManifestAsyncModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "eef2535a4dea2c8deb39ce350cd0265751594bca",
            "filename": "turbopack/crates/turbopack-ecmascript/src/merged_module.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -7,7 +7,7 @@ use turbopack_core::{\n         MergeableModuleExposure, MergeableModules, MergeableModulesExposed,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::ModuleReferences,\n@@ -83,14 +83,19 @@ impl Module for MergedEcmascriptModule {\n     }\n \n     #[turbo_tasks::function]\n-    async fn references(self: Vc<Self>) -> Result<Vc<ModuleReferences>> {\n+    fn references(self: Vc<Self>) -> Result<Vc<ModuleReferences>> {\n         panic!(\"references() should not be called\");\n     }\n \n     #[turbo_tasks::function]\n-    async fn is_self_async(&self) -> Result<Vc<bool>> {\n+    fn is_self_async(&self) -> Result<Vc<bool>> {\n         panic!(\"is_self_async() should not be called\");\n     }\n+    #[turbo_tasks::function]\n+    fn side_effects(&self) -> Vc<ModuleSideEffects> {\n+        // If needed this could be computed by merging the effects from all the merged modules\n+        panic!(\"side_effects() should not be called\");\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "f026cd85ba5c063fe919ee288938a7c5870117e7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 19,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -17,12 +17,11 @@ use turbopack_core::{\n         ChunkableModuleReference, ChunkingContext, ChunkingType, ChunkingTypeOption,\n         ModuleChunkItemIdExt,\n     },\n-    context::AssetContext,\n     issue::{\n         Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource,\n         OptionStyledString, StyledString,\n     },\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::binding_usage_info::ModuleExportUsageInfo,\n     reference::ModuleReference,\n     reference_type::{EcmaScriptModulesReferenceSubType, ImportWithType},\n@@ -424,24 +423,14 @@ impl ModuleReference for EsmAssetReference {\n         let request = Request::parse(self.request.clone().into());\n \n         if let Some(TreeShakingMode::ModuleFragments) = self.tree_shaking_mode {\n-            if let Some(ModulePart::Evaluation) = &self.export_name {\n-                let side_effect_free_packages =\n-                    self.module.asset_context().side_effect_free_packages();\n-\n-                if *self\n-                    .module\n-                    .is_marked_as_side_effect_free(side_effect_free_packages)\n-                    .await?\n-                {\n-                    return Ok(ModuleResolveResult {\n-                        primary: Box::new([(\n-                            RequestKey::default(),\n-                            ModuleResolveResultItem::Ignore,\n-                        )]),\n-                        affecting_sources: Default::default(),\n-                    }\n-                    .cell());\n+            if let Some(ModulePart::Evaluation) = &self.export_name\n+                && *self.module.side_effects().await? == ModuleSideEffects::SideEffectFree\n+            {\n+                return Ok(ModuleResolveResult {\n+                    primary: Box::new([(RequestKey::default(), ModuleResolveResultItem::Ignore)]),\n+                    affecting_sources: Default::default(),\n                 }\n+                .cell());\n             }\n \n             if let Request::Module { module, .. } = &*request.await?"
        },
        {
            "sha": "5868741e85a0cf34571684e27d265ee4443e2943",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -16,12 +16,11 @@ use turbo_tasks::{\n     FxIndexMap, NonLocalValue, ResolvedVc, TryFlatJoinIterExt, ValueToString, Vc,\n     trace::TraceRawVcs,\n };\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     chunk::{ChunkingContext, ModuleChunkItemIdExt},\n     ident::AssetIdent,\n     issue::{IssueExt, IssueSeverity, StyledString, analyze::AnalyzeIssue},\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::binding_usage_info::ModuleExportUsageInfo,\n     reference::ModuleReference,\n     resolve::ModulePart,\n@@ -190,7 +189,6 @@ pub struct FollowExportsResult {\n pub async fn follow_reexports(\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     export_name: RcStr,\n-    side_effect_free_packages: Vc<Glob>,\n     ignore_side_effect_of_entry: bool,\n ) -> Result<Vc<FollowExportsResult>> {\n     let mut ignore_side_effects = ignore_side_effect_of_entry;\n@@ -208,9 +206,7 @@ pub async fn follow_reexports(\n         };\n \n         if !ignore_side_effects\n-            && !*module\n-                .is_marked_as_side_effect_free(side_effect_free_packages)\n-                .await?\n+            && *module.side_effects().await? != ModuleSideEffects::SideEffectFree\n         {\n             // TODO It's unfortunate that we have to use the whole module here.\n             // This is often the Facade module, which includes all reexports."
        },
        {
            "sha": "d3e300476d3f9aff7f4c0cdd33d2bbf9584ee655",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -6,15 +6,14 @@ use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::{\n-    FileContent, FileSystem, FileSystemPath, LinkType, VirtualFileSystem, glob::Glob,\n-    rope::RopeBuilder,\n+    FileContent, FileSystem, FileSystemPath, LinkType, VirtualFileSystem, rope::RopeBuilder,\n };\n use turbo_tasks_hash::{encode_hex, hash_xxh3_hash64};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{AsyncModuleInfo, ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n     ident::{AssetIdent, Layer},\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::{\n         OutputAsset, OutputAssets, OutputAssetsReference, OutputAssetsReferences,\n@@ -360,7 +359,7 @@ impl Module for CachedExternalModule {\n                             // == false`. Optimize this case by using `ModuleWithoutSelfAsync` to\n                             // short circuit that computation and thus defer parsing traced modules\n                             // to emitting to not block all of chunking on this.\n-                            .map(|m| Vc::upcast(ModuleWithoutSelfAsync::new(*m))),\n+                            .map(|m| Vc::upcast(SideEffectfulModuleWithoutSelfAsync::new(*m))),\n                     )\n                     .map(|s| {\n                         Vc::upcast::<Box<dyn ModuleReference>>(TracedModuleReference::new(s))\n@@ -382,11 +381,8 @@ impl Module for CachedExternalModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(false)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n     }\n }\n \n@@ -531,31 +527,31 @@ impl EcmascriptChunkItem for CachedExternalModuleChunkItem {\n     }\n }\n \n-/// A wrapper \"passthrough\" module type that always returns `false` for `is_self_async`. Be careful\n-/// when using it, as it may hide async dependencies.\n+/// A wrapper \"passthrough\" module type that always returns `false` for `is_self_async` and\n+/// `SideEffects` for `side_effects`.Be careful when using it, as it may hide async dependencies.\n #[turbo_tasks::value]\n-pub struct ModuleWithoutSelfAsync {\n+struct SideEffectfulModuleWithoutSelfAsync {\n     module: ResolvedVc<Box<dyn Module>>,\n }\n \n #[turbo_tasks::value_impl]\n-impl ModuleWithoutSelfAsync {\n+impl SideEffectfulModuleWithoutSelfAsync {\n     #[turbo_tasks::function]\n-    pub fn new(module: ResolvedVc<Box<dyn Module>>) -> Vc<Self> {\n-        Self::cell(ModuleWithoutSelfAsync { module })\n+    fn new(module: ResolvedVc<Box<dyn Module>>) -> Vc<Self> {\n+        Self::cell(SideEffectfulModuleWithoutSelfAsync { module })\n     }\n }\n \n #[turbo_tasks::value_impl]\n-impl Asset for ModuleWithoutSelfAsync {\n+impl Asset for SideEffectfulModuleWithoutSelfAsync {\n     #[turbo_tasks::function]\n     fn content(&self) -> Vc<AssetContent> {\n         self.module.content()\n     }\n }\n \n #[turbo_tasks::value_impl]\n-impl Module for ModuleWithoutSelfAsync {\n+impl Module for SideEffectfulModuleWithoutSelfAsync {\n     #[turbo_tasks::function]\n     fn ident(&self) -> Vc<AssetIdent> {\n         self.module.ident()\n@@ -571,6 +567,10 @@ impl Module for ModuleWithoutSelfAsync {\n         self.module.references()\n     }\n \n+    #[turbo_tasks::function]\n+    fn side_effects(&self) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n     // Don't override and use default is_self_async that always returns false\n }\n "
        },
        {
            "sha": "260128e83921e93a2d1b9889504d3dd64c0f2e25",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/require_context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -20,7 +20,7 @@ use turbo_tasks::{\n     FxIndexMap, NonLocalValue, ResolvedVc, ValueToString, Vc, debug::ValueDebugFormat,\n     trace::TraceRawVcs,\n };\n-use turbo_tasks_fs::{DirectoryContent, DirectoryEntry, FileSystemPath, glob::Glob};\n+use turbo_tasks_fs::{DirectoryContent, DirectoryEntry, FileSystemPath};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n@@ -29,7 +29,7 @@ use turbopack_core::{\n     },\n     ident::AssetIdent,\n     issue::IssueSource,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     reference::{ModuleReference, ModuleReferences},\n@@ -445,11 +445,8 @@ impl Module for RequireContextAsset {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "5cd05226e16d0b9b220d3fd149ddb98733d553f5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -2,15 +2,15 @@ use std::collections::BTreeMap;\n \n use anyhow::{Result, bail};\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::{File, FileContent, glob::Glob};\n+use turbo_tasks_fs::{File, FileContent};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         AsyncModuleInfo, ChunkableModule, ChunkingContext, EvaluatableAsset, MergeableModule,\n         MergeableModules, MergeableModulesExposed,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::ModuleReferences,\n     resolve::{ExportUsage, ModulePart},\n@@ -182,16 +182,11 @@ impl Module for EcmascriptModuleFacadeModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        &self,\n-        side_effect_free_packages: Vc<Glob>,\n-    ) -> Result<Vc<bool>> {\n+    fn side_effects(&self) -> Result<Vc<ModuleSideEffects>> {\n         Ok(match self.part {\n-            ModulePart::Facade => self\n-                .module\n-                .is_marked_as_side_effect_free(side_effect_free_packages),\n+            ModulePart::Facade => self.module.side_effects(),\n             ModulePart::RenamedExport { .. } | ModulePart::RenamedNamespace { .. } => {\n-                Vc::cell(true)\n+                ModuleSideEffects::SideEffectFree.cell()\n             }\n             _ => bail!(\"Unexpected ModulePart for EcmascriptModuleFacadeModule\"),\n         })"
        },
        {
            "sha": "d9c0f005429c09221166af5e0e3102f911edd2a5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -2,15 +2,14 @@ use std::collections::BTreeMap;\n \n use anyhow::{Result, bail};\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         AsyncModuleInfo, ChunkableModule, ChunkingContext, MergeableModule, MergeableModules,\n         MergeableModulesExposed,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::ModuleReferences,\n     resolve::ModulePart,\n@@ -73,9 +72,8 @@ impl Module for EcmascriptModuleLocalsModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(&self, side_effect_free_packages: Vc<Glob>) -> Vc<bool> {\n-        self.module\n-            .is_marked_as_side_effect_free(side_effect_free_packages)\n+    fn side_effects(&self) -> Vc<ModuleSideEffects> {\n+        self.module.side_effects()\n     }\n }\n "
        },
        {
            "sha": "2c1a21f2b1bdede0e77c6cb3cbaf119071d639a8",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 33,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,16 +1,14 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{AsyncModuleInfo, ChunkableModule, ChunkingContext, EvaluatableAsset},\n-    context::AssetContext,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::{ModuleReference, ModuleReferences, SingleChunkableModuleReference},\n-    resolve::{ExportUsage, ModulePart, origin::ResolveOrigin},\n+    resolve::{ExportUsage, ModulePart},\n };\n \n use super::{\n@@ -175,17 +173,11 @@ impl EcmascriptModulePartAsset {\n                         ),\n                     ));\n                 }\n-                let side_effect_free_packages = module.asset_context().side_effect_free_packages();\n                 let source_module = Vc::upcast(module);\n                 let FollowExportsWithSideEffectsResult {\n                     side_effects,\n                     result,\n-                } = &*follow_reexports_with_side_effects(\n-                    source_module,\n-                    export.clone(),\n-                    side_effect_free_packages,\n-                )\n-                .await?;\n+                } = &*follow_reexports_with_side_effects(source_module, export.clone()).await?;\n                 let FollowExportsResult {\n                     module: final_module,\n                     export_name: new_export,\n@@ -256,30 +248,20 @@ struct FollowExportsWithSideEffectsResult {\n async fn follow_reexports_with_side_effects(\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     export_name: RcStr,\n-    side_effect_free_packages: Vc<Glob>,\n ) -> Result<Vc<FollowExportsWithSideEffectsResult>> {\n     let mut side_effects = vec![];\n \n     let mut current_module = module;\n     let mut current_export_name = export_name;\n     let result = loop {\n-        let is_side_effect_free = *current_module\n-            .is_marked_as_side_effect_free(side_effect_free_packages)\n-            .await?;\n-\n-        if !is_side_effect_free {\n+        if *current_module.side_effects().await? != ModuleSideEffects::SideEffectFree {\n             side_effects.push(only_effects(*current_module).to_resolved().await?);\n         }\n \n         // We ignore the side effect of the entry module here, because we need to proceed.\n-        let result = follow_reexports(\n-            *current_module,\n-            current_export_name.clone(),\n-            side_effect_free_packages,\n-            true,\n-        )\n-        .to_resolved()\n-        .await?;\n+        let result = follow_reexports(*current_module, current_export_name.clone(), true)\n+            .to_resolved()\n+            .await?;\n \n         let FollowExportsResult {\n             module,\n@@ -353,15 +335,12 @@ impl Module for EcmascriptModulePartAsset {\n     }\n \n     #[turbo_tasks::function]\n-    async fn is_marked_as_side_effect_free(\n-        &self,\n-        side_effect_free_packages: Vc<Glob>,\n-    ) -> Result<Vc<bool>> {\n+    async fn side_effects(&self) -> Vc<ModuleSideEffects> {\n         match self.part {\n-            ModulePart::Exports | ModulePart::Export(..) => Ok(Vc::cell(true)),\n-            _ => Ok(self\n-                .full_module\n-                .is_marked_as_side_effect_free(side_effect_free_packages)),\n+            ModulePart::Exports | ModulePart::Export(..) => {\n+                ModuleSideEffects::SideEffectFree.cell()\n+            }\n+            _ => self.full_module.side_effects(),\n         }\n     }\n }"
        },
        {
            "sha": "bc7ffb1205ef54632d57c9a31335015ee2e5041c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/side_effect_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,12 +1,12 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TryJoinIterExt, Vc};\n-use turbo_tasks_fs::{FileContent, glob::Glob};\n+use turbo_tasks_fs::FileContent;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkableModule, ChunkingContext, EvaluatableAsset},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n     resolve::{ExportUsage, ModulePart},\n@@ -114,8 +114,11 @@ impl Module for SideEffectsModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(self: Vc<Self>, _: Vc<Glob>) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // This module exists to collect side effects from references.  So it isn't side effectful\n+        // but it may depend on side effectful modules.  use this mode to allow inner graph tree\n+        // shaking to still potentially trim this module and its dependencies.\n+        ModuleSideEffects::ModuleEvaluationIsSideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "392b63ef44778b9cff27311a07a5aa3fe7cffe3c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/typescript/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -6,7 +6,7 @@ use turbo_tasks_fs::DirectoryContent;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     raw_module::RawModule,\n     reference::{ModuleReference, ModuleReferences},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n@@ -173,6 +173,11 @@ impl Module for TsConfigModuleAsset {\n         }\n         Ok(Vc::cell(references))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "11c559a57d3376f7a5e9ea34e62f060f1401fb45",
            "filename": "turbopack/crates/turbopack-ecmascript/src/webpack/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -6,7 +6,7 @@ use turbopack_core::{\n     asset::{Asset, AssetContent},\n     file_source::FileSource,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     reference::{ModuleReference, ModuleReferences},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n     resolve::{\n@@ -62,6 +62,11 @@ impl Module for WebpackModuleAsset {\n     fn references(&self) -> Vc<ModuleReferences> {\n         module_references(*self.source, *self.runtime, *self.transforms)\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "825a29bf2551fe4a315ef7a27345d1f8007e6d3e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/worker_chunk/module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fmodule.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,15 +1,14 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         ChunkGroupType, ChunkableModule, ChunkableModuleReference, ChunkingContext, ChunkingType,\n         ChunkingTypeOption,\n     },\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     reference::{ModuleReference, ModuleReferences},\n     resolve::ModuleResolveResult,\n@@ -59,11 +58,8 @@ impl Module for WorkerLoaderModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "86643337737e1747c50e549222ca46e05dd6c974",
            "filename": "turbopack/crates/turbopack-json/src/lib.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-json%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-json%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-json%2Fsrc%2Flib.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -14,13 +14,13 @@ use std::fmt::Write;\n use anyhow::{Error, Result, bail};\n use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n-use turbo_tasks_fs::{FileContent, FileJsonContent, glob::Glob};\n+use turbo_tasks_fs::{FileContent, FileJsonContent};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n     code_builder::CodeBuilder,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::OutputAssetsReference,\n     source::Source,\n@@ -59,11 +59,8 @@ impl Module for JsonModuleAsset {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "66a6c0ac0fc478aa9dda5c0326e9e14eeaa123be",
            "filename": "turbopack/crates/turbopack-static/src/css.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fcss.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,11 +1,10 @@\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::ChunkingContext,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     output::OutputAsset,\n     source::Source,\n };\n@@ -53,11 +52,9 @@ impl Module for StaticUrlCssModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "d867459a6887ac4869a49b5fd48409f7e0a6de7c",
            "filename": "turbopack/crates/turbopack-static/src/ecma.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-static%2Fsrc%2Fecma.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,12 +1,11 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::{OutputAsset, OutputAssetsReference, OutputAssetsWithReferenced},\n     source::Source,\n@@ -65,11 +64,8 @@ impl Module for StaticUrlJsModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn is_marked_as_side_effect_free(\n-        self: Vc<Self>,\n-        _side_effect_free_packages: Vc<Glob>,\n-    ) -> Vc<bool> {\n-        Vc::cell(true)\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        ModuleSideEffects::SideEffectFree.cell()\n     }\n }\n "
        },
        {
            "sha": "89bc7a43901e2ab9fc45284bc606be3d19449c30",
            "filename": "turbopack/crates/turbopack-test-utils/src/noop_asset_context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-test-utils%2Fsrc%2Fnoop_asset_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-test-utils%2Fsrc%2Fnoop_asset_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-test-utils%2Fsrc%2Fnoop_asset_context.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n-use turbo_rcstr::{RcStr, rcstr};\n+use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::{FileSystemPath, glob::Glob};\n+use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::{AssetContext, ProcessResult},\n@@ -73,9 +73,4 @@ impl AssetContext for NoopAssetContext {\n     ) -> Result<Vc<Box<dyn AssetContext>>> {\n         Ok(Vc::upcast(self))\n     }\n-\n-    #[turbo_tasks::function]\n-    async fn side_effect_free_packages(&self) -> Result<Vc<Glob>> {\n-        Ok(Glob::new(rcstr!(\"\"), Default::default()))\n-    }\n }"
        },
        {
            "sha": "0affe4b5f55ec14a9769ca7f787aa14f40ac2d12",
            "filename": "turbopack/crates/turbopack-wasm/src/module_asset.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -10,7 +10,7 @@ use turbopack_core::{\n     },\n     context::AssetContext,\n     ident::AssetIdent,\n-    module::{Module, OptionModule},\n+    module::{Module, ModuleSideEffects, OptionModule},\n     module_graph::ModuleGraph,\n     output::{OutputAssetsReference, OutputAssetsWithReferenced},\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n@@ -144,6 +144,14 @@ impl Module for WebAssemblyModuleAsset {\n     fn is_self_async(self: Vc<Self>) -> Vc<bool> {\n         Vc::cell(true)\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // Both versions of this module have a top level await that instantiates a wasm module\n+        // wasm module instantiation can trigger arbitrary side effects from the native start\n+        // function\n+        ModuleSideEffects::SideEffectful.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "1d2fa1ab9bad72cc942ce25eb94153615b2fef53",
            "filename": "turbopack/crates/turbopack-wasm/src/raw.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -6,7 +6,7 @@ use turbopack_core::{\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n     context::AssetContext,\n     ident::AssetIdent,\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     module_graph::ModuleGraph,\n     output::{OutputAsset, OutputAssetsReference, OutputAssetsWithReferenced},\n     source::{OptionSource, Source},\n@@ -64,6 +64,12 @@ impl Module for RawWebAssemblyModuleAsset {\n     fn source(&self) -> Vc<OptionSource> {\n         Vc::cell(Some(ResolvedVc::upcast(self.source)))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn side_effects(self: Vc<Self>) -> Vc<ModuleSideEffects> {\n+        // this just exports a path\n+        ModuleSideEffects::SideEffectFree.cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "20891acf86e4192d42f2608771c1cccc6caa8a52",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 49,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -17,18 +17,16 @@ use module_options::{ModuleOptions, ModuleOptionsContext, ModuleRuleEffect, Modu\n use tracing::{Instrument, field::Empty};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n-use turbo_tasks_fs::{\n-    FileSystemPath,\n-    glob::{Glob, GlobOptions},\n-};\n+use turbo_tasks_fs::FileSystemPath;\n+pub use turbopack_core::condition;\n use turbopack_core::{\n     asset::Asset,\n     chunk::SourceMapsType,\n     compile_time_info::CompileTimeInfo,\n     context::{AssetContext, ProcessResult},\n     ident::Layer,\n     issue::{IssueExt, IssueSource, module::ModuleIssue},\n-    module::Module,\n+    module::{Module, ModuleSideEffects},\n     node_addon_module::NodeAddonModule,\n     output::{ExpandedOutputAssets, OutputAsset},\n     raw_module::RawModule,\n@@ -127,6 +125,10 @@ async fn apply_module_type(\n             }\n             .to_resolved()\n             .await?;\n+            let side_effect_free_packages = module_asset_context\n+                .module_options_context()\n+                .await?\n+                .side_effect_free_packages;\n             let mut builder = EcmascriptModuleAsset::builder(\n                 source,\n                 ResolvedVc::upcast(context_for_module),\n@@ -140,6 +142,7 @@ async fn apply_module_type(\n                     .compile_time_info()\n                     .to_resolved()\n                     .await?,\n+                side_effect_free_packages,\n             );\n             match module_type {\n                 ModuleType::Ecmascript { .. } => {\n@@ -177,15 +180,7 @@ async fn apply_module_type(\n                 if tree_shaking_mode.is_some() && is_evaluation {\n                     // If we are tree shaking, skip the evaluation part if the module is marked as\n                     // side effect free.\n-                    let side_effect_free_packages = module_asset_context\n-                        .side_effect_free_packages()\n-                        .resolve()\n-                        .await?;\n-\n-                    if *module\n-                        .is_marked_as_side_effect_free(side_effect_free_packages)\n-                        .await?\n-                    {\n+                    if *module.side_effects().await? == ModuleSideEffects::SideEffectFree {\n                         return Ok(ProcessResult::Ignore.cell());\n                     }\n                 }\n@@ -208,11 +203,6 @@ async fn apply_module_type(\n                                     }\n                                 }\n                                 ModulePart::Export(_) => {\n-                                    let side_effect_free_packages = module_asset_context\n-                                        .side_effect_free_packages()\n-                                        .resolve()\n-                                        .await?;\n-\n                                     if *module.get_exports().split_locals_and_reexports().await? {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(\n@@ -224,16 +214,11 @@ async fn apply_module_type(\n                                                 .await?,\n                                             ),\n                                             part,\n-                                            side_effect_free_packages,\n                                         )\n                                         .await?\n                                     } else {\n-                                        apply_reexport_tree_shaking(\n-                                            Vc::upcast(*module),\n-                                            part,\n-                                            side_effect_free_packages,\n-                                        )\n-                                        .await?\n+                                        apply_reexport_tree_shaking(Vc::upcast(*module), part)\n+                                            .await?\n                                     }\n                                 }\n                                 _ => bail!(\n@@ -311,15 +296,7 @@ async fn apply_module_type(\n     if tree_shaking_mode.is_some() && is_evaluation {\n         // If we are tree shaking, skip the evaluation part if the module is marked as\n         // side effect free.\n-        let side_effect_free_packages = module_asset_context\n-            .side_effect_free_packages()\n-            .resolve()\n-            .await?;\n-\n-        if *module\n-            .is_marked_as_side_effect_free(side_effect_free_packages)\n-            .await?\n-        {\n+        if *module.side_effects().await? == ModuleSideEffects::SideEffectFree {\n             return Ok(ProcessResult::Ignore.cell());\n         }\n     }\n@@ -330,14 +307,13 @@ async fn apply_module_type(\n async fn apply_reexport_tree_shaking(\n     module: Vc<Box<dyn EcmascriptChunkPlaceable>>,\n     part: ModulePart,\n-    side_effect_free_packages: Vc<Glob>,\n ) -> Result<Vc<Box<dyn Module>>> {\n     if let ModulePart::Export(export) = &part {\n         let FollowExportsResult {\n             module: final_module,\n             export_name: new_export,\n             ..\n-        } = &*follow_reexports(module, export.clone(), side_effect_free_packages, true).await?;\n+        } = &*follow_reexports(module, export.clone(), true).await?;\n         let module = if let Some(new_export) = new_export {\n             if *new_export == *export {\n                 Vc::upcast(**final_module)\n@@ -1020,18 +996,6 @@ impl AssetContext for ModuleAssetContext {\n             },\n         )\n     }\n-\n-    #[turbo_tasks::function]\n-    async fn side_effect_free_packages(&self) -> Result<Vc<Glob>> {\n-        let pkgs = &self.module_options_context.await?.side_effect_free_packages;\n-\n-        let mut globs = String::new();\n-        globs.push_str(\"**/node_modules/{\");\n-        globs.push_str(&pkgs.join(\",\"));\n-        globs.push_str(\"}/**\");\n-\n-        Ok(Glob::new(globs.into(), GlobOptions::default()))\n-    }\n }\n \n #[turbo_tasks::function]"
        },
        {
            "sha": "beed1f8ffd0ebe3e5980dfe2d1f1f10e06d65f14",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5437319dd4b6354dac9a2ee2aa67cb12a983e2eb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=5437319dd4b6354dac9a2ee2aa67cb12a983e2eb",
            "patch": "@@ -1,11 +1,15 @@\n use std::fmt::Debug;\n \n+use anyhow::Result;\n use bincode::{Decode, Encode};\n use serde::{Deserialize, Serialize};\n use turbo_esregex::EsRegex;\n-use turbo_rcstr::RcStr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, ResolvedVc, ValueDefault, Vc, trace::TraceRawVcs};\n-use turbo_tasks_fs::FileSystemPath;\n+use turbo_tasks_fs::{\n+    FileSystemPath,\n+    glob::{Glob, GlobOptions},\n+};\n use turbopack_core::{\n     chunk::SourceMapsType, compile_time_info::CompileTimeInfo, condition::ContextCondition,\n     environment::Environment, resolve::options::ImportMapping,\n@@ -193,7 +197,7 @@ pub struct ModuleOptionsContext {\n \n     pub environment: Option<ResolvedVc<Environment>>,\n     pub execution_context: Option<ResolvedVc<ExecutionContext>>,\n-    pub side_effect_free_packages: Vec<RcStr>,\n+    pub side_effect_free_packages: Option<ResolvedVc<Glob>>,\n     pub tree_shaking_mode: Option<TreeShakingMode>,\n \n     /// Generate (non-emitted) output assets for static assets and externals, to facilitate\n@@ -282,3 +286,20 @@ impl ValueDefault for ModuleOptionsContext {\n         Self::cell(Default::default())\n     }\n }\n+\n+#[turbo_tasks::function]\n+pub async fn side_effect_free_packages_glob(\n+    side_effect_free_packages: ResolvedVc<Vec<RcStr>>,\n+) -> Result<Vc<Glob>> {\n+    let side_effect_free_packages = &*side_effect_free_packages.await?;\n+    if side_effect_free_packages.is_empty() {\n+        return Ok(Glob::new(rcstr!(\"\"), GlobOptions::default()));\n+    }\n+\n+    let mut globs = String::new();\n+    globs.push_str(\"**/node_modules/{\");\n+    globs.push_str(&side_effect_free_packages.join(\",\"));\n+    globs.push_str(\"}/**\");\n+\n+    Ok(Glob::new(globs.into(), GlobOptions::default()))\n+}"
        }
    ],
    "stats": {
        "total": 591,
        "additions": 309,
        "deletions": 282
    }
}