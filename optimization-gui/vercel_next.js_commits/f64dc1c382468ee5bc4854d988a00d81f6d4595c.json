{
    "author": "huozhi",
    "message": "fix global not found canont static shell with sync io (#83111)",
    "sha": "f64dc1c382468ee5bc4854d988a00d81f6d4595c",
    "files": [
        {
            "sha": "d57c7520175f42f92deb73f92b8602b21d975b41",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 11,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -1462,16 +1462,13 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n                             parallel_routes: FxIndexMap::default(),\n                             modules: if use_global_not_found {\n                                 // if global-not-found.js is present:\n-                                // we use it for the page and no layout, since layout is included in global-not-found.js;\n+                                // leaf module only keeps page pointing to empty-stub\n                                 AppDirModules {\n-                                    layout: None,\n-                                    page: match modules.global_not_found {\n-                                        Some(v) => Some(v),\n-                                        None =>  Some(get_next_package(app_dir.clone())\n-                                            .await?\n-                                            .join(\"dist/client/components/builtin/global-not-found.js\")?,\n-                                        ),\n-                                    },\n+                                    // page is built-in/empty-stub\n+                                    page: Some(get_next_package(app_dir.clone())\n+                                        .await?\n+                                        .join(\"dist/client/components/builtin/empty-stub.js\")?,\n+                                    ),\n                                     ..Default::default()\n                                 }\n                             } else {\n@@ -1503,15 +1500,22 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n                 // Otherwise, we need to compose it with the root layout to compose with\n                 // not-found.js boundary.\n                 layout: if use_global_not_found {\n-                    None\n+                    match modules.global_not_found {\n+                        Some(v) => Some(v),\n+                        None => Some(\n+                            get_next_package(app_dir.clone())\n+                                .await?\n+                                .join(\"dist/client/components/builtin/global-not-found.js\")?,\n+                        ),\n+                    }\n                 } else {\n                     modules.layout\n                 },\n                 ..not_found_root_modules\n             },\n             global_metadata,\n         }\n-            .resolved_cell();\n+        .resolved_cell();\n \n         {\n             let app_page = app_page"
        },
        {
            "sha": "d9a2314638c5025729fb9751b4b6ada6e55ada60",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -86,6 +86,7 @@ const PARALLEL_VIRTUAL_SEGMENT = 'slot$'\n const defaultGlobalErrorPath =\n   'next/dist/client/components/builtin/global-error.js'\n const defaultNotFoundPath = 'next/dist/client/components/builtin/not-found.js'\n+const defaultEmptyStubPath = 'next/dist/client/components/builtin/empty-stub'\n const defaultLayoutPath = 'next/dist/client/components/builtin/layout.js'\n const defaultGlobalNotFoundPath =\n   'next/dist/client/components/builtin/global-not-found.js'\n@@ -426,12 +427,18 @@ async function createTreeCodeFromPath(\n           if (matchedGlobalNotFound) {\n             const varName = `notFound${nestedCollectedDeclarations.length}`\n             nestedCollectedDeclarations.push([varName, matchedGlobalNotFound])\n+            const layoutName = `layout${nestedCollectedDeclarations.length}`\n+            nestedCollectedDeclarations.push([layoutName, defaultEmptyStubPath])\n             subtreeCode = `{\n               children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE)}, {\n                 children: ['${PAGE_SEGMENT_KEY}', {}, {\n-                  page: [\n+                  layout: [\n                     ${varName},\n                     ${JSON.stringify(matchedGlobalNotFound)}\n+                  ],\n+                  page: [\n+                    ${layoutName},\n+                    ${JSON.stringify(defaultEmptyStubPath)}\n                   ]\n                 }]\n               }, {}]\n@@ -475,12 +482,21 @@ async function createTreeCodeFromPath(\n       }\n \n       // For 404 route\n-      // if global-not-found is in definedFilePaths, remove root layout for /_not-found\n+      // if global-not-found is in definedFilePaths, remove root layout for /_not-found,\n+      // and change it to global-not-found route.\n       // TODO: remove this once global-not-found is stable.\n       if (isNotFoundRoute && isGlobalNotFoundEnabled) {\n         definedFilePaths = definedFilePaths.filter(\n           ([type]) => type !== 'layout'\n         )\n+\n+        // Replace the layout to global-not-found\n+        definedFilePaths.push([\n+          'layout',\n+          definedFilePaths.find(\n+            ([type]) => type === GLOBAL_NOT_FOUND_FILE_TYPE\n+          )?.[1] ?? defaultGlobalNotFoundPath,\n+        ])\n       }\n \n       if (isAppErrorRoute) {"
        },
        {
            "sha": "e9a7f8c6b8cfa78f37a506565a7085314cbbfdc8",
            "filename": "packages/next/src/client/components/builtin/empty-stub.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fempty-stub.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fempty-stub.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fempty-stub.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Empty() {\n+  return null\n+}"
        },
        {
            "sha": "f3464b2eb12a73da8f745190c3fe43c77f2d1a48",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -343,16 +343,19 @@ function parseRequestHeaders(\n function createNotFoundLoaderTree(loaderTree: LoaderTree): LoaderTree {\n   const components = loaderTree[2]\n   const hasGlobalNotFound = !!components['global-not-found']\n+  const notFoundTreeComponents: LoaderTree[2] = hasGlobalNotFound\n+    ? {\n+        layout: components['global-not-found']!,\n+        page: [() => null, 'next/dist/client/components/builtin/empty-stub'],\n+      }\n+    : {\n+        page: components['not-found'],\n+      }\n+\n   return [\n     '',\n     {\n-      children: [\n-        PAGE_SEGMENT_KEY,\n-        {},\n-        {\n-          page: components['global-not-found'] ?? components['not-found'],\n-        },\n-      ],\n+      children: [PAGE_SEGMENT_KEY, {}, notFoundTreeComponents],\n     },\n     // When global-not-found is present, skip layout from components\n     hasGlobalNotFound ? components : {},"
        },
        {
            "sha": "3b70a2c9cd9b56b0e9dc096237361afbd6f0c0ed",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/app/action/actions.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Factions.ts?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,7 @@\n+'use server'\n+\n+import { redirect } from 'next/navigation'\n+\n+export async function callNotFoundInAction() {\n+  redirect('/not-found')\n+}"
        },
        {
            "sha": "11d5304d2a6db93cb69df1500f4db810fc66804c",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/app/action/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Faction%2Fpage.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,22 @@\n+'use client'\n+\n+import { useActionState } from 'react'\n+import Form from 'next/form'\n+\n+import { callNotFoundInAction } from './actions'\n+\n+export default function Home() {\n+  const [, submit] = useActionState(callNotFoundInAction, null)\n+  return (\n+    <>\n+      <div>hello</div>\n+      <div>\n+        <Form action={submit}>\n+          <button id=\"not-found-btn\" type=\"submit\">\n+            Submit\n+          </button>\n+        </Form>\n+      </div>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "a50e8dd33ea04f8a73b34ef9486226b75ef1851c",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/app/global-not-found.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fglobal-not-found.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,20 @@\n+import type { Metadata } from 'next'\n+import { Suspense } from 'react'\n+import { Year } from './year'\n+\n+export const metadata: Metadata = {\n+  title: 'Global Not Found',\n+}\n+\n+export default function GlobalNotFound() {\n+  return (\n+    <html lang=\"en\">\n+      <body>\n+        <h1>Global Not Found</h1>\n+        <Suspense>\n+          <Year />\n+        </Suspense>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "db0be73f49876d403a0901010e754929e6e91aad",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Flayout.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: React.ReactNode\n+}>) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ede3737caabf6830df32deb910e76bb170e00d12",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/app/year.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fyear.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fyear.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fapp%2Fyear.tsx?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,6 @@\n+'use client'\n+import { Suspense } from 'react'\n+\n+export function Year() {\n+  return <Suspense>{new Date().getFullYear()}</Suspense>\n+}"
        },
        {
            "sha": "38cf810842bffac09def32941308ac0269516f12",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/cache-components.test.ts",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fcache-components.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fcache-components.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fcache-components.test.ts?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,28 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+\n+describe('global-not-found - cache-components', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render global-not-found for 404 routes', async () => {\n+    await next.fetch('/does-not-exist')\n+    expect(next.cliOutput).not.toContain(\n+      'did not produce a static shell and Next.js was unable to determine a reason. This is a bug in Next.js'\n+    )\n+  })\n+\n+  it('should render not-found boundary when calling notFound() in a page', async () => {\n+    const browser = await next.browser('/action')\n+    // submit form with #not-found-btn button\n+    await browser.elementByCss('#not-found-btn').click()\n+\n+    await retry(async () => {\n+      expect(await browser.elementByCss('h1').text()).toBe('Global Not Found')\n+    })\n+    expect(next.cliOutput).not.toContain(\n+      'did not produce a static shell and Next.js was unable to determine a reason. This is a bug in Next.js'\n+    )\n+  })\n+})"
        },
        {
            "sha": "a8cc8b017f456688866b7f3d3d3c32c22304439a",
            "filename": "test/e2e/app-dir/global-not-found/cache-components/next.config.mjs",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fnext.config.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/f64dc1c382468ee5bc4854d988a00d81f6d4595c/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fnext.config.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcache-components%2Fnext.config.mjs?ref=f64dc1c382468ee5bc4854d988a00d81f6d4595c",
            "patch": "@@ -0,0 +1,9 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+    globalNotFound: true,\n+  },\n+}\n+\n+export default nextConfig"
        }
    ],
    "stats": {
        "total": 169,
        "additions": 149,
        "deletions": 20
    }
}