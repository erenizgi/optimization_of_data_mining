{
    "author": "unstubbable",
    "message": "Discard `Infinity` expiration for implicit tags (#80387)\n\nWhen a cache handler returns `Infinity` from its `getExpiration` method,\nit signals to Next.js that soft/implicit tags are supposed to be passed\ninto the `get` method instead to be checked for expiration. Documenting\nthis in the `CacheHandlerV2` interface, and always passing in the soft\ntags was implemented in #79213. However, we missed handling the infinite\nexpiration value, which led to regarding all cache entries returned from\nthose cache handlers as stale.\n\nThe first commit provokes the error, the second commit fixes it.\n\nWe'll also soon (re-)add proper deploy tests that will verify scenarios\nlike this one end-to-end when deployed to Vercel.\n\n/cc @laugharn",
    "sha": "cd156f92329f17d0ddb70054ee13d6456c6e81fa",
    "files": [
        {
            "sha": "6a43e9430001bc3299fe42bf4852ab3221936295",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/cd156f92329f17d0ddb70054ee13d6456c6e81fa/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cd156f92329f17d0ddb70054ee13d6456c6e81fa/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=cd156f92329f17d0ddb70054ee13d6456c6e81fa",
            "patch": "@@ -867,10 +867,17 @@ export function cache(\n               workUnitStore.implicitTags.expirationsByCacheKind.get(kind)\n \n             if (lazyExpiration) {\n-              if (isResolvedLazyResult(lazyExpiration)) {\n-                implicitTagsExpiration = lazyExpiration.value\n-              } else {\n-                implicitTagsExpiration = await lazyExpiration\n+              const expiration = isResolvedLazyResult(lazyExpiration)\n+                ? lazyExpiration.value\n+                : await lazyExpiration\n+\n+              // If a cache handler returns an expiration time of Infinity, it\n+              // signals to Next.js that it handles checking cache entries for\n+              // staleness based on the expiration of the implicit tags passed\n+              // into the `get` method. In this case, we keep the default of 0,\n+              // which means that the implicit tags are not considered expired.\n+              if (expiration < Infinity) {\n+                implicitTagsExpiration = expiration\n               }\n             }\n           }"
        },
        {
            "sha": "8bb773174a3b0d810e16f10b27ee5d6907ae0e75",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/handler.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/cd156f92329f17d0ddb70054ee13d6456c6e81fa/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/cd156f92329f17d0ddb70054ee13d6456c6e81fa/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js?ref=cd156f92329f17d0ddb70054ee13d6456c6e81fa",
            "patch": "@@ -24,7 +24,9 @@ const cacheHandler = {\n \n   async getExpiration(...tags) {\n     console.log('ModernCustomCacheHandler::getExpiration', JSON.stringify(tags))\n-    return defaultCacheHandler.getExpiration(...tags)\n+    // Expecting soft tags in `get` to be used by the cache handler for checking\n+    // the expiration of a cache entry, instead of letting Next.js handle it.\n+    return Infinity\n   },\n \n   async expireTags(...tags) {"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 14,
        "deletions": 5
    }
}