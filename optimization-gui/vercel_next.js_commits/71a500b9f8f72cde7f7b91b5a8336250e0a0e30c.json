{
    "author": "kdy1",
    "message": "perf(turbo-tasks): Filter out `self` arguments (#78554)\n\n### What?\n\nThis PR is a follow-up PR of https://github.com/vercel/next.js/pull/75261\n\n### Why?\n\nThis could give us noticeable memory reduction.\n\n### How?\n\n - See: https://linear.app/vercel/issue/PACK-3828",
    "sha": "71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
    "files": [
        {
            "sha": "502882e745c18449eb3dfb3f58b3fb47ec374bae",
            "filename": "turbopack/crates/turbo-tasks-macros-shared/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Flib.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -5,10 +5,12 @@ mod expand;\n mod generic_type_input;\n mod ident;\n mod primitive_input;\n+mod self_filter;\n mod value_trait_arguments;\n \n pub use expand::*;\n pub use generic_type_input::GenericTypeInput;\n pub use ident::*;\n pub use primitive_input::PrimitiveInput;\n+pub use self_filter::is_self_used;\n pub use value_trait_arguments::ValueTraitArguments;"
        },
        {
            "sha": "2b0205dbf10e58d322f766062e2368d1cb659eae",
            "filename": "turbopack/crates/turbo-tasks-macros-shared/src/self_filter.rs",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fself_filter.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fself_filter.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fself_filter.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -0,0 +1,81 @@\n+use proc_macro2::TokenTree;\n+use quote::ToTokens;\n+use syn::visit::{visit_block, visit_expr, visit_item, visit_macro, Visit};\n+\n+pub fn is_self_used(block: &syn::Block) -> bool {\n+    let mut finder = SelfFinder { found: false };\n+    finder.visit_block(block);\n+    finder.found\n+}\n+\n+struct SelfFinder {\n+    found: bool,\n+}\n+\n+impl Visit<'_> for SelfFinder {\n+    fn visit_block(&mut self, n: &syn::Block) {\n+        if self.found {\n+            return;\n+        }\n+\n+        visit_block(self, n);\n+    }\n+\n+    fn visit_expr(&mut self, expr: &syn::Expr) {\n+        if self.found {\n+            return;\n+        }\n+\n+        if let syn::Expr::Path(path) = expr {\n+            if path.path.is_ident(\"self\") {\n+                self.found = true;\n+                return;\n+            }\n+        }\n+\n+        visit_expr(self, expr);\n+    }\n+\n+    fn visit_item(&mut self, n: &syn::Item) {\n+        if self.found {\n+            return;\n+        }\n+\n+        visit_item(self, n);\n+    }\n+\n+    fn visit_item_impl(&mut self, _: &syn::ItemImpl) {\n+        // skip children of `impl`: the definition of \"self\" inside of an impl is different than the\n+        // parent scope's definition of \"self\"\n+    }\n+\n+    fn visit_macro(&mut self, mac: &syn::Macro) {\n+        if self.found {\n+            return;\n+        }\n+\n+        for token in mac.tokens.to_token_stream() {\n+            if contains_self_token(&token) {\n+                self.found = true;\n+                return;\n+            }\n+        }\n+\n+        visit_macro(self, mac);\n+    }\n+}\n+\n+fn contains_self_token(tok: &TokenTree) -> bool {\n+    match tok {\n+        TokenTree::Group(group) => {\n+            for token in group.stream() {\n+                if contains_self_token(&token) {\n+                    return true;\n+                }\n+            }\n+            false\n+        }\n+        TokenTree::Ident(ident) => ident == \"self\",\n+        TokenTree::Punct(..) | TokenTree::Literal(..) => false,\n+    }\n+}"
        },
        {
            "sha": "1a9a163a6c5d4b1c2ea0084a58040d1f42c21e54",
            "filename": "turbopack/crates/turbo-tasks-macros/src/func.rs",
            "status": "modified",
            "additions": 71,
            "deletions": 16,
            "changes": 87,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -1,6 +1,6 @@\n use std::borrow::Cow;\n \n-use proc_macro2::{Ident, Span, TokenStream};\n+use proc_macro2::{Group, Ident, Span, TokenStream, TokenTree};\n use quote::{quote, quote_spanned, ToTokens};\n use rustc_hash::FxHashSet;\n use syn::{\n@@ -312,6 +312,7 @@ impl TurboFn<'_> {\n     pub fn inline_signature_and_block<'a>(\n         &self,\n         orig_block: &'a Block,\n+        is_self_used: bool,\n     ) -> (Signature, Cow<'a, Block>) {\n         let mut shadow_self = None;\n         let (inputs, transform_stmts): (Punctuated<_, _>, Vec<Option<_>>) = self\n@@ -320,7 +321,7 @@ impl TurboFn<'_> {\n             .iter()\n             .filter(|arg| {\n                 let FnArg::Typed(pat_type) = arg else {\n-                    return true;\n+                    return is_self_used;\n                 };\n                 let Pat::Ident(pat_id) = &*pat_type.pat else {\n                     return true;\n@@ -334,6 +335,7 @@ impl TurboFn<'_> {\n                     // arguments are explicitly `NonLocalValue`s\n                     return (arg.clone(), None);\n                 }\n+\n                 let (FnArg::Receiver(Receiver { ty, .. }) | FnArg::Typed(PatType { ty, .. })) = arg;\n                 let Cow::Owned(expanded_ty) = expand_task_input_type(ty) else {\n                     // common-case: skip if no type conversion is needed\n@@ -373,7 +375,7 @@ impl TurboFn<'_> {\n                             ..receiver.clone()\n                         });\n \n-                        // We can't shadow `self` variables, so it this argument is a `self`\n+                        // We can't shadow `self` variables, so if this argument is a `self`\n                         // argument, generate a new identifier, and rewrite\n                         // the body of the function later to use\n                         // that new identifier.\n@@ -476,7 +478,7 @@ impl TurboFn<'_> {\n \n     fn inline_input_idents(&self) -> impl Iterator<Item = &Ident> {\n         self.exposed_input_idents()\n-            .filter(|id| inline_inputs_identifier_filter(id))\n+            .filter(move |id| inline_inputs_identifier_filter(id))\n     }\n \n     fn exposed_input_idents(&self) -> impl Iterator<Item = &Ident> {\n@@ -726,7 +728,7 @@ pub struct FunctionArguments {\n     /// arguments are `OperationValue`s. Mutually exclusive with the `local` flag.\n     ///\n     /// If there is an error due to this option being set, it should be reported to this span.\n-    operation: Option<Span>,\n+    pub operation: Option<Span>,\n     /// Does not run the function as a real task, and instead runs it inside the parent task using\n     /// task-local state. The function call itself will not be cached, but cells will be created on\n     /// the parent task.\n@@ -1017,6 +1019,39 @@ impl VisitMut for RewriteSelfVisitMut {\n         // skip children of `impl`: the definition of \"self\" inside of an impl is different than the\n         // parent scope's definition of \"self\"\n     }\n+\n+    fn visit_macro_mut(&mut self, mac: &mut syn::Macro) {\n+        let new_tokens =\n+            replace_self_in_token_stream(mac.tokens.to_token_stream(), &self.self_ident);\n+        mac.tokens = new_tokens;\n+\n+        syn::visit_mut::visit_macro_mut(self, mac);\n+    }\n+}\n+\n+fn replace_self_in_token_stream(stream: TokenStream, self_ident: &Ident) -> TokenStream {\n+    stream\n+        .into_iter()\n+        .map(|tt| replace_self_in_tt(tt, self_ident))\n+        .collect()\n+}\n+\n+fn replace_self_in_tt(tt: TokenTree, self_ident: &Ident) -> TokenTree {\n+    match tt {\n+        TokenTree::Group(group) => {\n+            let new_stream = replace_self_in_token_stream(group.stream(), self_ident);\n+            TokenTree::Group(Group::new(group.delimiter(), new_stream))\n+        }\n+\n+        TokenTree::Ident(ref ident) => {\n+            if ident == \"self\" {\n+                return TokenTree::Ident(self_ident.clone());\n+            }\n+\n+            tt\n+        }\n+        _ => tt,\n+    }\n }\n \n /// The context in which the function is being defined.\n@@ -1054,6 +1089,8 @@ pub struct NativeFn {\n     pub function_path_string: String,\n     pub function_path: ExprPath,\n     pub is_method: bool,\n+    /// Used only if `is_method` is true.\n+    pub is_self_used: bool,\n     pub filter_trait_call_args: Option<FilterTraitCallArgsTokens>,\n     pub local: bool,\n }\n@@ -1068,6 +1105,7 @@ impl NativeFn {\n             function_path_string,\n             function_path,\n             is_method,\n+            is_self_used,\n             filter_trait_call_args,\n             local,\n         } = self;\n@@ -1087,17 +1125,34 @@ impl NativeFn {\n             } else {\n                 quote! { ::std::option::Option::None }\n             };\n-            quote! {\n-                {\n-                    #[allow(deprecated)]\n-                    turbo_tasks::macro_helpers::NativeFunction::new_method(\n-                        #function_path_string.to_owned(),\n-                        turbo_tasks::macro_helpers::FunctionMeta {\n-                            local: #local,\n-                        },\n-                        #arg_filter,\n-                        #function_path,\n-                    )\n+\n+            if *is_self_used {\n+                quote! {\n+                    {\n+                        #[allow(deprecated)]\n+                        turbo_tasks::macro_helpers::NativeFunction::new_method(\n+                            #function_path_string.to_owned(),\n+                            turbo_tasks::macro_helpers::FunctionMeta {\n+                                local: #local,\n+                            },\n+                            #arg_filter,\n+                            #function_path,\n+                        )\n+                    }\n+                }\n+            } else {\n+                quote! {\n+                    {\n+                        #[allow(deprecated)]\n+                        turbo_tasks::macro_helpers::NativeFunction::new_method_without_this(\n+                            #function_path_string.to_owned(),\n+                            turbo_tasks::macro_helpers::FunctionMeta {\n+                                local: #local,\n+                            },\n+                            #arg_filter,\n+                            #function_path,\n+                        )\n+                    }\n                 }\n             }\n         } else {"
        },
        {
            "sha": "ed86c317024afa2c032eda9aaf4fb5521e507a11",
            "filename": "turbopack/crates/turbo-tasks-macros/src/function_macro.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -1,7 +1,9 @@\n use proc_macro::TokenStream;\n use quote::quote;\n use syn::{parse_macro_input, parse_quote, ItemFn};\n-use turbo_tasks_macros_shared::{get_native_function_id_ident, get_native_function_ident};\n+use turbo_tasks_macros_shared::{\n+    get_native_function_id_ident, get_native_function_ident, is_self_used,\n+};\n \n use crate::func::{\n     filter_inline_attributes, DefinitionContext, FunctionArguments, NativeFn, TurboFn,\n@@ -40,6 +42,7 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n         .inspect_err(|err| errors.push(err.to_compile_error()))\n         .unwrap_or_default();\n     let local = args.local.is_some();\n+    let is_self_used = args.operation.is_some() || is_self_used(&block);\n \n     let Some(turbo_fn) = TurboFn::new(&sig, DefinitionContext::NakedFn, args) else {\n         return quote! {\n@@ -51,13 +54,15 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n     let ident = &sig.ident;\n \n     let inline_function_ident = turbo_fn.inline_ident();\n-    let (inline_signature, inline_block) = turbo_fn.inline_signature_and_block(&block);\n+    let (inline_signature, inline_block) =\n+        turbo_fn.inline_signature_and_block(&block, is_self_used);\n     let inline_attrs = filter_inline_attributes(&attrs[..]);\n \n     let native_fn = NativeFn {\n         function_path_string: ident.to_string(),\n         function_path: parse_quote! { #inline_function_ident },\n         is_method: turbo_fn.is_method(),\n+        is_self_used,\n         filter_trait_call_args: None, // not a trait method\n         local,\n     };"
        },
        {
            "sha": "fe7ee3534cb9be3d8368c9a3250b828218764c3e",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_impl_macro.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -11,7 +11,7 @@ use syn::{\n use turbo_tasks_macros_shared::{\n     get_inherent_impl_function_id_ident, get_inherent_impl_function_ident, get_path_ident,\n     get_register_trait_methods_ident, get_trait_impl_function_id_ident,\n-    get_trait_impl_function_ident, get_type_ident,\n+    get_trait_impl_function_ident, get_type_ident, is_self_used,\n };\n \n use crate::func::{\n@@ -125,6 +125,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     .inspect_err(|err| errors.push(err.to_compile_error()))\n                     .unwrap_or_default();\n                 let local = func_args.local.is_some();\n+                let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n                     TurboFn::new(sig, DefinitionContext::ValueInherentImpl, func_args)\n@@ -133,14 +134,17 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                         // An error occurred while parsing the function signature.\n                     };\n                 };\n+\n                 let inline_function_ident = turbo_fn.inline_ident();\n-                let (inline_signature, inline_block) = turbo_fn.inline_signature_and_block(block);\n+                let (inline_signature, inline_block) =\n+                    turbo_fn.inline_signature_and_block(block, is_self_used);\n                 let inline_attrs = filter_inline_attributes(attrs.iter().copied());\n \n                 let native_fn = NativeFn {\n                     function_path_string: format!(\"{ty}::{ident}\", ty = ty.to_token_stream()),\n                     function_path: parse_quote! { <#ty>::#inline_function_ident },\n                     is_method: turbo_fn.is_method(),\n+                    is_self_used,\n                     filter_trait_call_args: None, // not a trait method\n                     local,\n                 };\n@@ -225,6 +229,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     .inspect_err(|err| errors.push(err.to_compile_error()))\n                     .unwrap_or_default();\n                 let local = func_args.local.is_some();\n+                let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n                     TurboFn::new(sig, DefinitionContext::ValueTraitImpl, func_args)\n@@ -239,7 +244,8 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     &format!(\"{}_{}_{}_inline\", ty_ident, trait_ident, ident),\n                     ident.span(),\n                 );\n-                let (inline_signature, inline_block) = turbo_fn.inline_signature_and_block(block);\n+                let (inline_signature, inline_block) =\n+                    turbo_fn.inline_signature_and_block(block, is_self_used);\n                 let inline_attrs = filter_inline_attributes(attrs.iter().copied());\n \n                 let native_fn = NativeFn {\n@@ -252,6 +258,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                         <#ty as #inline_extension_trait_ident>::#inline_function_ident\n                     },\n                     is_method: turbo_fn.is_method(),\n+                    is_self_used,\n                     filter_trait_call_args: turbo_fn.filter_trait_call_args(),\n                     local,\n                 };"
        },
        {
            "sha": "3404f6be4132b84f8caecc39e3951089d324834a",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_trait_macro.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -4,7 +4,7 @@ use quote::{quote, quote_spanned};\n use syn::{parse_macro_input, parse_quote, spanned::Spanned, ItemTrait, TraitItem, TraitItemFn};\n use turbo_tasks_macros_shared::{\n     get_trait_default_impl_function_id_ident, get_trait_default_impl_function_ident,\n-    get_trait_type_id_ident, get_trait_type_ident, ValueTraitArguments,\n+    get_trait_type_id_ident, get_trait_type_ident, is_self_used, ValueTraitArguments,\n };\n \n use crate::func::{\n@@ -107,10 +107,12 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n         });\n \n         let default = if let Some(default) = default {\n+            let is_self_used = is_self_used(default);\n             let inline_function_ident = turbo_fn.inline_ident();\n             let inline_extension_trait_ident =\n                 Ident::new(&format!(\"{}_{}_inline\", trait_ident, ident), ident.span());\n-            let (inline_signature, inline_block) = turbo_fn.inline_signature_and_block(default);\n+            let (inline_signature, inline_block) =\n+                turbo_fn.inline_signature_and_block(default, is_self_used);\n             let inline_attrs = filter_inline_attributes(&attrs[..]);\n \n             let native_function = NativeFn {\n@@ -119,6 +121,7 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n                     <Box<dyn #trait_ident> as #inline_extension_trait_ident>::#inline_function_ident\n                 },\n                 is_method: turbo_fn.is_method(),\n+                is_self_used,\n                 filter_trait_call_args: turbo_fn.filter_trait_call_args(),\n                 // `local` is currently unsupported here because:\n                 // - The `#[turbo_tasks::function]` macro needs to be present for us to read this"
        },
        {
            "sha": "11a6a90bfa250089cf04dd36d751f1707c7a2aca",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/71a500b9f8f72cde7f7b91b5a8336250e0a0e30c/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=71a500b9f8f72cde7f7b91b5a8336250e0a0e30c",
            "patch": "@@ -89,13 +89,15 @@ impl ArgMeta {\n         (self.filter_owned)(args)\n     }\n \n+    /// This will return `(None, _)` even if the target is a method, if the method does not use\n+    /// `self`.\n     pub async fn filter_and_resolve(&self, args: &dyn MagicAny) -> Result<Box<dyn MagicAny>> {\n         (self.filter_and_resolve)(args).await\n     }\n }\n \n fn resolve_functor_impl<T: MagicAny + TaskInput>(value: &dyn MagicAny) -> ResolveFuture<'_> {\n-    Box::pin(async {\n+    Box::pin(async move {\n         let value = downcast_args_ref::<T>(value);\n         let resolved = value.resolve_input().await?;\n         Ok(Box::new(resolved) as Box<dyn MagicAny>)\n@@ -190,6 +192,28 @@ impl NativeFunction {\n         }\n     }\n \n+    pub fn new_method_without_this<Mode, Inputs, I>(\n+        name: String,\n+        function_meta: FunctionMeta,\n+        arg_filter: Option<(FilterOwnedArgsFunctor, FilterAndResolveFunctor)>,\n+        implementation: I,\n+    ) -> Self\n+    where\n+        Inputs: TaskInput + Serialize + for<'de> Deserialize<'de> + 'static,\n+        I: IntoTaskFn<Mode, Inputs>,\n+    {\n+        Self {\n+            name,\n+            function_meta,\n+            arg_meta: if let Some((filter_owned, filter_and_resolve)) = arg_filter {\n+                ArgMeta::with_filter_trait_call::<Inputs>(filter_owned, filter_and_resolve)\n+            } else {\n+                ArgMeta::new::<Inputs>()\n+            },\n+            implementation: Box::new(implementation.into_task_fn()),\n+        }\n+    }\n+\n     pub fn new_method<Mode, This, Inputs, I>(\n         name: String,\n         function_meta: FunctionMeta,"
        }
    ],
    "stats": {
        "total": 225,
        "additions": 201,
        "deletions": 24
    }
}