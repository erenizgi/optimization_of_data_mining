{
    "author": "mischnic",
    "message": "Upgrade CodSpeed action and add analyzer benchmarks (#84135)",
    "sha": "45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
    "files": [
        {
            "sha": "9fd2be8c655e0b1d24889782940e50e5b697ecaa",
            "filename": ".github/workflows/turbopack-benchmark.yml",
            "status": "modified",
            "additions": 51,
            "deletions": 5,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fturbopack-benchmark.yml?ref=45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
            "patch": "@@ -39,7 +39,7 @@ jobs:\n       - name: Install cargo-codspeed\n         uses: taiki-e/install-action@v2\n         with:\n-          tool: cargo-codspeed@2.10.1\n+          tool: cargo-codspeed@3.0.5\n \n       - name: Cache on ${{ github.ref_name }}\n         uses: ijjk/rust-cache@turbo-cache-v1.0.9\n@@ -56,12 +56,55 @@ jobs:\n           pnpm install --loglevel error\n \n       - name: Build app build benchmarks\n+        env:\n+          CODSPEED_RUNNER_MODE: instrumentation\n         run: cargo codspeed build -p turbopack-cli small_apps\n \n       - name: Run the benchmarks\n-        uses: CodSpeedHQ/action@v3\n+        uses: CodSpeedHQ/action@v4\n         with:\n-          run: cargo codspeed run\n+          mode: instrumentation\n+          run: cargo codspeed run -p turbopack-cli small_apps\n+          token: ${{ secrets.CODSPEED_TOKEN }}\n+\n+  benchmark-analyzer:\n+    name: Benchmark Rust Crates (analyzer)\n+    runs-on: ['self-hosted', 'linux', 'x64', 'metal']\n+    steps:\n+      - uses: actions/checkout@v4\n+\n+      - name: Setup Rust toolchain\n+        uses: ./.github/actions/setup-rust\n+\n+      - name: Install cargo-codspeed\n+        uses: taiki-e/install-action@v2\n+        with:\n+          tool: cargo-codspeed@3.0.5\n+\n+      - name: Cache on ${{ github.ref_name }}\n+        uses: ijjk/rust-cache@turbo-cache-v1.0.9\n+        with:\n+          save-if: 'true'\n+          cache-provider: 'turbo'\n+          shared-key: build-turbopack-benchmark-analyzer-${{ hashFiles('.cargo/config.toml') }}\n+\n+      - name: Install pnpm dependencies\n+        working-directory: turbopack/benchmark-apps\n+        run: |\n+          npm i -g corepack@0.31\n+          corepack enable\n+          pnpm install --loglevel error\n+\n+      - name: Build app build benchmarks\n+        env:\n+          CODSPEED_RUNNER_MODE: instrumentation\n+        run: cargo codspeed build -p turbopack-ecmascript references\n+\n+      - name: Run the benchmarks\n+        uses: CodSpeedHQ/action@v4\n+        with:\n+          mode: instrumentation\n+          run: cargo codspeed run -p turbopack-ecmascript references\n           token: ${{ secrets.CODSPEED_TOKEN }}\n \n   benchmark-large:\n@@ -77,13 +120,16 @@ jobs:\n       - name: Install cargo-codspeed\n         uses: taiki-e/install-action@v2\n         with:\n-          tool: cargo-codspeed@2.10.1\n+          tool: cargo-codspeed@3.0.5\n \n       - name: Build the benchmark target(s)\n+        env:\n+          CODSPEED_RUNNER_MODE: instrumentation\n         run: cargo codspeed build -p turbopack -p turbopack-bench\n \n       - name: Run the benchmarks\n-        uses: CodSpeedHQ/action@v3\n+        uses: CodSpeedHQ/action@v4\n         with:\n+          mode: instrumentation\n           run: cargo codspeed run\n           token: ${{ secrets.CODSPEED_TOKEN }}"
        },
        {
            "sha": "0f87ce5eecb12133776b9947bf2c0eb2b71e6154",
            "filename": "crates/next-api/src/client_references.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/crates%2Fnext-api%2Fsrc%2Fclient_references.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/crates%2Fnext-api%2Fsrc%2Fclient_references.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fclient_references.rs?ref=45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
            "patch": "@@ -194,9 +194,10 @@ pub async fn map_client_references(\n         })\n         .collect();\n \n-    Ok(ClientReferenceManifest::cell(ClientReferenceManifest {\n+    Ok(ClientReferenceManifest {\n         manifest,\n         server_components,\n         server_components_for_client_references,\n-    }))\n+    }\n+    .cell())\n }"
        },
        {
            "sha": "4daa7155eebb90b70f3c54c19a5c4cdcb285e9cd",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
            "patch": "@@ -9,6 +9,14 @@ autobenches = false\n [lib]\n bench = false\n \n+[[bench]]\n+name = \"analyzer\"\n+harness = false\n+\n+[[bench]]\n+name = \"references\"\n+harness = false\n+\n [lints]\n workspace = true\n \n@@ -80,8 +88,3 @@ turbo-tasks-backend = { workspace = true }\n turbo-tasks-malloc = { workspace = true }\n turbo-tasks-testing = { workspace = true }\n turbopack-test-utils = { workspace = true }\n-\n-\n-[[bench]]\n-name = \"mod\"\n-harness = false"
        },
        {
            "sha": "4e90d3720506079de87b0d64ab41d6b850f83868",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/analyzer.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs?ref=45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
            "patch": "@@ -1,6 +1,6 @@\n use std::{fs, path::PathBuf, sync::Arc, time::Duration};\n \n-use criterion::{Bencher, BenchmarkId, Criterion};\n+use criterion::{Bencher, BenchmarkId, Criterion, criterion_group, criterion_main};\n use swc_core::{\n     common::{FilePathMapping, GLOBALS, Mark, SourceMap},\n     ecma::{\n@@ -27,6 +27,9 @@ use turbopack_ecmascript::{\n     },\n };\n \n+#[global_allocator]\n+static ALLOC: turbo_tasks_malloc::TurboMalloc = turbo_tasks_malloc::TurboMalloc;\n+\n pub fn benchmark(c: &mut Criterion) {\n     let tests_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"tests/analyzer/graph\");\n     let results = fs::read_dir(tests_dir).unwrap();\n@@ -142,3 +145,6 @@ fn bench_link(b: &mut Bencher, input: &BenchInput) {\n         }\n     });\n }\n+\n+criterion_group!(analyzer_benches, benchmark);\n+criterion_main!(analyzer_benches);"
        },
        {
            "sha": "a0b24dc147a33f01d98e42a801ff690d0885cd2d",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/mod.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c2081b134ef6a9c54f8d005c72f8c077e8e1a699/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2081b134ef6a9c54f8d005c72f8c077e8e1a699/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs?ref=c2081b134ef6a9c54f8d005c72f8c077e8e1a699",
            "patch": "@@ -1,10 +0,0 @@\n-extern crate turbo_tasks_malloc;\n-\n-use criterion::{criterion_group, criterion_main};\n-\n-mod analyzer;\n-mod references;\n-\n-criterion_group!(analyzer_benches, analyzer::benchmark);\n-criterion_group!(full_benches, references::benchmark);\n-criterion_main!(analyzer_benches, full_benches);"
        },
        {
            "sha": "95a9a528ba039736fb45e12594da9aaed741cfad",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=45e28f8fe8a5436e0cc0b9160d5b3b92b18cbf8e",
            "patch": "@@ -1,6 +1,6 @@\n use std::{path::PathBuf, sync::Arc, time::Duration};\n \n-use criterion::{Bencher, BenchmarkId, Criterion};\n+use criterion::{Bencher, BenchmarkId, Criterion, criterion_group, criterion_main};\n use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, TurboTasks};\n use turbo_tasks_backend::{\n@@ -19,6 +19,9 @@ use turbopack_ecmascript::{\n };\n use turbopack_test_utils::noop_asset_context::NoopAssetContext;\n \n+#[global_allocator]\n+static ALLOC: turbo_tasks_malloc::TurboMalloc = turbo_tasks_malloc::TurboMalloc;\n+\n pub fn benchmark(c: &mut Criterion) {\n     let rt = tokio::runtime::Builder::new_current_thread()\n         .build()\n@@ -132,3 +135,6 @@ where\n             .unwrap()\n     });\n }\n+\n+criterion_group!(references_benches, benchmark);\n+criterion_main!(references_benches);"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 76,
        "deletions": 24
    }
}