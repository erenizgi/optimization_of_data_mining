{
    "author": "huozhi",
    "message": "[perf] only load next config once when start next dev server (#82654)",
    "sha": "df5bc544760bb3b6b65f05511245379095240088",
    "files": [
        {
            "sha": "e36a6975ce3cf7abc43c2cd046c3e0eb3929044d",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 19,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -17,7 +17,7 @@ import { getProjectDir } from '../lib/get-project-dir'\n import { PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\n import path from 'path'\n import type { NextConfigComplete } from '../server/config-shared'\n-import { setGlobal, traceGlobals } from '../trace/shared'\n+import { traceGlobals } from '../trace/shared'\n import { Telemetry } from '../telemetry/storage'\n import loadConfig from '../server/config'\n import { findPagesDir } from '../lib/find-pages-dir'\n@@ -56,6 +56,7 @@ type PortSource = 'cli' | 'default' | 'env'\n \n let dir: string\n let child: undefined | ChildProcess\n+// The config in next-dev is only used to access config.distDir for telemetry and trace.\n let config: NextConfigComplete\n let isTurboSession = false\n let traceUploadUrl: string\n@@ -95,16 +96,6 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n     const { eventCliSessionStopped } =\n       require('../telemetry/events/session-stopped') as typeof import('../telemetry/events/session-stopped')\n \n-    config = config || (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir))\n-\n-    let telemetry =\n-      (traceGlobals.get('telemetry') as InstanceType<\n-        typeof import('../telemetry/storage').Telemetry\n-      >) ||\n-      new Telemetry({\n-        distDir: path.join(dir, config.distDir),\n-      })\n-\n     let pagesDir: boolean = !!traceGlobals.get('pagesDir')\n     let appDir: boolean = !!traceGlobals.get('appDir')\n \n@@ -117,6 +108,18 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       pagesDir = !!pagesResult.pagesDir\n     }\n \n+    config =\n+      config ||\n+      (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, { silent: true }))\n+\n+    let telemetry =\n+      (traceGlobals.get('telemetry') as InstanceType<\n+        typeof import('../telemetry/storage').Telemetry\n+      >) ||\n+      new Telemetry({\n+        distDir: path.join(dir, config.distDir),\n+      })\n+\n     telemetry.record(\n       eventCliSessionStopped({\n         cliCommand: 'dev',\n@@ -228,10 +231,6 @@ const nextDev = async (\n   // some set-ups that rely on listening on other interfaces\n   const host = options.hostname\n \n-  config = await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, {\n-    silent: false,\n-  })\n-\n   if (\n     options.experimentalUploadTrace &&\n     !process.env.NEXT_TRACE_UPLOAD_DISABLED\n@@ -247,10 +246,6 @@ const nextDev = async (\n     hostname: host,\n   }\n \n-  const distDir = path.join(dir, config.distDir ?? '.next')\n-  setGlobal('phase', PHASE_DEVELOPMENT_SERVER)\n-  setGlobal('distDir', distDir)\n-\n   const startServerPath = require.resolve('../server/lib/start-server')\n \n   async function startServer(startServerOptions: StartServerOptions) {\n@@ -330,6 +325,13 @@ const nextDev = async (\n           // must upload the existing contents before restarting the server to\n           // preserve the metrics.\n           if (traceUploadUrl) {\n+            // Postpone loading next config when we need to get\n+            //  config.distDir for upload trace.\n+            config =\n+              config ||\n+              (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, {\n+                silent: true,\n+              }))\n             uploadTrace({\n               traceUploadUrl,\n               mode: 'dev',"
        },
        {
            "sha": "50695b5f342ba687abb6f18777d0204ff9959f68",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 6,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -17,9 +17,16 @@ export function findRootLockFile(cwd: string) {\n   )\n }\n \n-export function findRootDir(cwd: string): string {\n+export function findRootDirAndLockFiles(cwd: string): {\n+  lockFiles: string[]\n+  rootDir: string\n+} {\n   const lockFile = findRootLockFile(cwd)\n-  if (!lockFile) return cwd\n+  if (!lockFile)\n+    return {\n+      lockFiles: [],\n+      rootDir: cwd,\n+    }\n \n   const lockFiles = [lockFile]\n   while (true) {\n@@ -37,8 +44,14 @@ export function findRootDir(cwd: string): string {\n     lockFiles.push(newLockFile)\n   }\n \n-  // Only warn if not in a build worker to avoid duplicate warnings\n-  if (typeof process.send !== 'function' && lockFiles.length > 1) {\n+  return {\n+    lockFiles,\n+    rootDir: dirname(lockFiles[lockFiles.length - 1]),\n+  }\n+}\n+\n+export function warnDuplicatedLockFiles(lockFiles: string[]) {\n+  if (lockFiles.length > 1) {\n     const additionalLockFiles = lockFiles\n       .slice(0, -1)\n       .map((str) => `\\n   * ${str}`)\n@@ -64,6 +77,4 @@ export function findRootDir(cwd: string): string {\n       )\n     }\n   }\n-\n-  return dirname(lockFiles[lockFiles.length - 1])\n }"
        },
        {
            "sha": "b4106d1b7a73c97901a484d11d6351a1bbcff7bf",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 39,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -25,7 +25,10 @@ import { imageConfigDefault } from '../shared/lib/image-config'\n import type { ImageConfig } from '../shared/lib/image-config'\n import { loadEnvConfig, updateInitialEnv } from '@next/env'\n import { flushAndExit } from '../telemetry/flush-and-exit'\n-import { findRootDir } from '../lib/find-root'\n+import {\n+  findRootDirAndLockFiles,\n+  warnDuplicatedLockFiles,\n+} from '../lib/find-root'\n import { setHttpClientAndAgentOptions } from './setup-http-agent-env'\n import { pathHasPrefix } from '../shared/lib/router/utils/path-has-prefix'\n import { matchRemotePattern } from '../shared/lib/match-remote-pattern'\n@@ -764,7 +767,14 @@ function assignDefaults(\n     )\n   }\n \n-  const rootDir = tracingRoot || turbopackRoot || findRootDir(dir)\n+  let rootDir = tracingRoot || turbopackRoot\n+  if (!rootDir) {\n+    const { rootDir: foundRootDir, lockFiles } = findRootDirAndLockFiles(dir)\n+    rootDir = foundRootDir\n+    if (!silent) {\n+      warnDuplicatedLockFiles(lockFiles)\n+    }\n+  }\n \n   if (!rootDir) {\n     throw new Error(\n@@ -1432,43 +1442,9 @@ export default async function loadConfig(\n     // Check deprecation warnings on the actual user config before merging with defaults\n     checkDeprecations(userConfig, configFileName, silent, dir)\n \n-    // Always validate the config against schema in non minimal mode.\n-    // Only validate once in the root Next.js process, not in forked processes.\n-    const isRootProcess = typeof process.send !== 'function'\n-    if (!process.env.NEXT_MINIMAL && isRootProcess) {\n-      // We only validate the config against schema in non minimal mode\n-      const { configSchema } =\n-        require('./config-schema') as typeof import('./config-schema')\n-      const state = configSchema.safeParse(userConfig)\n-\n-      if (!state.success) {\n-        // error message header\n-        const messages = [`Invalid ${configFileName} options detected: `]\n-\n-        const [errorMessages, shouldExit] = normalizeNextConfigZodErrors(\n-          state.error\n-        )\n-        // ident list item\n-        for (const error of errorMessages) {\n-          messages.push(`    ${error}`)\n-        }\n-\n-        // error message footer\n-        messages.push(\n-          'See more info here: https://nextjs.org/docs/messages/invalid-next-config'\n-        )\n-\n-        if (shouldExit) {\n-          for (const message of messages) {\n-            console.error(message)\n-          }\n-          await flushAndExit(1)\n-        } else {\n-          for (const message of messages) {\n-            curLog.warn(message)\n-          }\n-        }\n-      }\n+    // Always validate the config against schema in non minimal mode\n+    if (!process.env.NEXT_MINIMAL && !silent) {\n+      validateConfigSchema(userConfig, configFileName, curLog.warn)\n     }\n \n     if (userConfig.target && userConfig.target !== 'server') {\n@@ -1897,3 +1873,43 @@ function cloneObject(obj: any): any {\n \n   return result\n }\n+\n+async function validateConfigSchema(\n+  userConfig: NextConfig,\n+  configFileName: string,\n+  warn: (message: string) => void\n+) {\n+  // We only validate the config against schema in non minimal mode\n+  const { configSchema } =\n+    require('./config-schema') as typeof import('./config-schema')\n+  const state = configSchema.safeParse(userConfig)\n+\n+  if (!state.success) {\n+    // error message header\n+    const messages = [`Invalid ${configFileName} options detected: `]\n+\n+    const [errorMessages, shouldExit] = normalizeNextConfigZodErrors(\n+      state.error\n+    )\n+    // ident list item\n+    for (const error of errorMessages) {\n+      messages.push(`    ${error}`)\n+    }\n+\n+    // error message footer\n+    messages.push(\n+      'See more info here: https://nextjs.org/docs/messages/invalid-next-config'\n+    )\n+\n+    if (shouldExit) {\n+      for (const message of messages) {\n+        console.error(message)\n+      }\n+      await flushAndExit(1)\n+    } else {\n+      for (const message of messages) {\n+        warn(message)\n+      }\n+    }\n+  }\n+}"
        },
        {
            "sha": "6661e5355caa118ea9f915a4e970360b554c2f37",
            "filename": "packages/next/src/server/lib/app-info-log.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -95,6 +95,7 @@ export async function getStartServerInfo({\n         )\n       },\n       debugPrerender,\n+      silent: false,\n     }\n   )\n "
        },
        {
            "sha": "a3a86a5ca1e12cd18b557ea38532170ea1e49622",
            "filename": "test/development/load-config-freq/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Flayout.js?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/development/load-config-freq/app/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fload-config-freq%2Fapp%2Fpage.js?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "8520b81df74eb55f72a71b9ac291b6bad6a3825d",
            "filename": "test/development/load-config-freq/load-config-freq.test.ts",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fload-config-freq.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fload-config-freq.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fload-config-freq%2Fload-config-freq.test.ts?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -0,0 +1,16 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('load-config-freq', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should only load next config once when start next dev server', async () => {\n+    await next.fetch('/')\n+    const output = next.cliOutput\n+\n+    // Ensure there's only one \"[ASSERTION] load nextConfig\" in the text\n+    const parts = output.split(/\\[ASSERTION\\] load nextConfig/g)\n+    expect(parts).toHaveLength(2)\n+  })\n+})"
        },
        {
            "sha": "470bf1da09a9d8b4d4ba777982a685a0795f1a1b",
            "filename": "test/development/load-config-freq/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/df5bc544760bb3b6b65f05511245379095240088/test%2Fdevelopment%2Fload-config-freq%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fload-config-freq%2Fnext.config.js?ref=df5bc544760bb3b6b65f05511245379095240088",
            "patch": "@@ -0,0 +1,8 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+console.log('[ASSERTION] load nextConfig')\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 192,
        "additions": 128,
        "deletions": 64
    }
}