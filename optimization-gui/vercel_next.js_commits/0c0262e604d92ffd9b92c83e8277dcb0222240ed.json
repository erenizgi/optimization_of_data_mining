{
    "author": "unstubbable",
    "message": "Always pass implicit/soft tags into the `CacheHandler.get` method (#79213)\n\nThis allows a cache handler to check the timestamp of a cache entry\nagainst the latest expiration of the given soft tags, and discarding the\nentry if it's stale. Subsequently, it does not need to consult a\npotentially separate tags service to retrieve a value in the\n`CacheHandler.getExpiration` call for those tags, so that Next.js could\nhandle the expiration check. It can return `Infinity` instead.",
    "sha": "0c0262e604d92ffd9b92c83e8277dcb0222240ed",
    "files": [
        {
            "sha": "cf8a76baebdbdb7c6dcf1439727c8d3de4a6d850",
            "filename": ".changeset/lovely-bulldogs-dress.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/.changeset%2Flovely-bulldogs-dress.md",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/.changeset%2Flovely-bulldogs-dress.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Flovely-bulldogs-dress.md?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+\"next\": patch\n+---\n+\n+Always pass implicit/soft tags into the `CacheHandler.get` method"
        },
        {
            "sha": "8cbb91257224db9e0dae5d4a6542c11a24683599",
            "filename": "packages/next/src/server/lib/cache-handlers/types.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcache-handlers%2Ftypes.ts?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -77,39 +77,40 @@ export interface CacheHandler {\n \n export interface CacheHandlerV2 {\n   /**\n-   * Retrieve a cache entry for the given cache key, if available.\n+   * Retrieve a cache entry for the given cache key, if available. Will return\n+   * undefined if there's no valid entry, or if the given soft tags are stale.\n    */\n-  get(cacheKey: string): Promise<undefined | CacheEntry>\n+  get(cacheKey: string, softTags: string[]): Promise<undefined | CacheEntry>\n \n   /**\n    * Store a cache entry for the given cache key. When this is called, the entry\n    * may still be pending, i.e. its value stream may still be written to. So it\n-   * needs to be awaited first. If a `get` for the same cache key is called\n+   * needs to be awaited first. If a `get` for the same cache key is called,\n    * before the pending entry is complete, the cache handler must wait for the\n    * `set` operation to finish, before returning the entry, instead of returning\n    * undefined.\n    */\n   set(cacheKey: string, pendingEntry: Promise<CacheEntry>): Promise<void>\n \n   /**\n-   * Next.js will call this method periodically, but always before starting a\n-   * new request. When working with a remote tags service, this method should\n-   * communicate with the tags service to refresh the local tags manifest\n-   * accordingly.\n+   * This function may be called periodically, but always before starting a new\n+   * request. If applicable, it should communicate with the tags service to\n+   * refresh the local tags manifest accordingly.\n    */\n   refreshTags(): Promise<void>\n \n   /**\n-   * Next.js will call this method for each set of soft tags that are relevant\n-   * at the start of a request. The result is the maximum timestamp of a\n-   * revalidate event for the tags. Returns `0` if none of the tags were ever\n-   * revalidated.\n+   * This function is called for each set of soft tags that are relevant at the\n+   * start of a request. The result is the maximum timestamp of a revalidate\n+   * event for the tags. Returns `0` if none of the tags were ever revalidated.\n+   * Returns `Infinity` if the soft tags are supposed to be passed into the\n+   * `get` method instead to be checked for expiration.\n    */\n   getExpiration(...tags: string[]): Promise<Timestamp>\n \n   /**\n-   * Next.js will call this method when `revalidateTag` or `revalidatePath()` is\n-   * called. It should update the tags manifest accordingly.\n+   * This function is called when tags are revalidated/expired. If applicable,\n+   * it should update the tags manifest accordingly.\n    */\n   expireTags(...tags: string[]): Promise<void>\n }"
        },
        {
            "sha": "ad2fde25292fd258a31a9edc261b8026815b5174",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -744,15 +744,10 @@ export function cache(\n \n         let entry = shouldForceRevalidate(workStore, workUnitStore)\n           ? undefined\n-          : 'getExpiration' in cacheHandler\n-            ? await cacheHandler.get(serializedCacheKey)\n-            : // Legacy cache handlers require implicit tags to be passed in,\n-              // instead of checking their staleness here, as we do for modern\n-              // cache handlers (see below).\n-              await cacheHandler.get(\n-                serializedCacheKey,\n-                workUnitStore?.implicitTags?.tags ?? []\n-              )\n+          : await cacheHandler.get(\n+              serializedCacheKey,\n+              workUnitStore?.implicitTags?.tags ?? []\n+            )\n \n         if (entry) {\n           const implicitTags = workUnitStore?.implicitTags?.tags ?? []"
        },
        {
            "sha": "3ba1ab1ee69e3242c7633c8a18d691bcb2134520",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/handler.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -7,9 +7,9 @@ const defaultCacheHandler =\n  * @type {import('next/dist/server/lib/cache-handlers/types').CacheHandlerV2}\n  */\n const cacheHandler = {\n-  async get(cacheKey) {\n-    console.log('ModernCustomCacheHandler::get', cacheKey)\n-    return defaultCacheHandler.get(cacheKey)\n+  async get(cacheKey, softTags) {\n+    console.log('ModernCustomCacheHandler::get', cacheKey, softTags)\n+    return defaultCacheHandler.get(cacheKey, softTags)\n   },\n \n   async set(cacheKey, pendingEntry) {"
        },
        {
            "sha": "3244b7d68611e46168be20fbe8cac469d0c91fb0",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/legacy-handler.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Flegacy-handler.js?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -13,7 +13,7 @@ const cacheHandler = {\n       cacheKey,\n       JSON.stringify(softTags)\n     )\n-    return defaultCacheHandler.get(cacheKey)\n+    return defaultCacheHandler.get(cacheKey, softTags)\n   },\n \n   async set(cacheKey, pendingEntry) {"
        },
        {
            "sha": "182116b1d4a0dcb826e182146937838e542ee336",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/use-cache-custom-handler.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0262e604d92ffd9b92c83e8277dcb0222240ed/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts?ref=0c0262e604d92ffd9b92c83e8277dcb0222240ed",
            "patch": "@@ -28,7 +28,7 @@ describe('use-cache-custom-handler', () => {\n     expect(cliOutput).toContain('ModernCustomCacheHandler::refreshTags')\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch(\n-      /ModernCustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"([0-9a-f]{2})+\",\\[\\]\\]/\n+      /ModernCustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"([0-9a-f]{2})+\",\\[\\]\\] \\[ '_N_T_\\/layout', '_N_T_\\/page', '_N_T_\\/' \\]/\n     )\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch("
        }
    ],
    "stats": {
        "total": 55,
        "additions": 28,
        "deletions": 27
    }
}