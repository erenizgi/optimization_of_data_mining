{
    "author": "kdy1",
    "message": "refactor(turbopack): Refactor usage of visitors (#79525)\n\n### What?\r\n\r\nWe are using `VisitMut`, which is very heavy, to apply simple operations. This PR refactors it to use a custom trait, which is very lightweight and has a proper signature.\r\n\r\n### Why?\r\n\r\nFor a small performance improvement and a smaller binary. I'll refactor to remove  `VisitorFactory` completely because we don't need such indirection anymore. This is possible because `AstModifier` takes `&self`, unlike `&mut self` of `VisitMut`.",
    "sha": "6679022c95bfa5a273a410bc81773f474c6acec9",
    "files": [
        {
            "sha": "42fb605363e5b368ec18f97b1a5f65fbdf2674a7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/code_gen.rs",
            "status": "modified",
            "additions": 93,
            "deletions": 12,
            "changes": 105,
            "blob_url": "https://github.com/vercel/next.js/blob/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs?ref=6679022c95bfa5a273a410bc81773f474c6acec9",
            "patch": "@@ -1,8 +1,11 @@\n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use swc_core::ecma::{\n-    ast::Stmt,\n-    visit::{AstParentKind, VisitMut},\n+    ast::{\n+        BlockStmt, CallExpr, Expr, Lit, MemberExpr, ModuleDecl, ModuleItem, Pass, Pat, Prop,\n+        SimpleAssignTarget, Stmt, Str, SwitchCase,\n+    },\n+    visit::AstParentKind,\n };\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, ResolvedVc, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n@@ -35,6 +38,7 @@ use crate::references::{\n #[derive(Default)]\n pub struct CodeGeneration {\n     /// ast nodes matching the span will be visitor by the visitor\n+    pub root_visitors: Vec<Box<dyn PassFactory>>,\n     pub visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>,\n     pub hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     pub early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n@@ -48,18 +52,34 @@ impl CodeGeneration {\n     }\n \n     pub fn new(\n+        root_visitors: Vec<Box<dyn PassFactory>>,\n         visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>,\n         hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n         early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     ) -> Self {\n         CodeGeneration {\n+            root_visitors,\n             visitors,\n             hoisted_stmts,\n             early_hoisted_stmts,\n         }\n     }\n \n+    pub fn root_visitors(root_visitors: Vec<Box<dyn PassFactory>>) -> Self {\n+        CodeGeneration {\n+            root_visitors,\n+            ..Default::default()\n+        }\n+    }\n+\n     pub fn visitors(visitors: Vec<(Vec<AstParentKind>, Box<dyn VisitorFactory>)>) -> Self {\n+        #[cfg(debug_assertions)]\n+        for (path, _) in visitors.iter() {\n+            if path.is_empty() {\n+                unreachable!(\"if the path is empty, the visitor should be a root visitor\");\n+            }\n+        }\n+\n         CodeGeneration {\n             visitors,\n             ..Default::default()\n@@ -94,9 +114,63 @@ impl CodeGenerationHoistedStmt {\n }\n \n pub trait VisitorFactory: Send + Sync {\n-    fn create<'a>(&'a self) -> Box<dyn VisitMut + Send + Sync + 'a>;\n+    fn create<'a>(&'a self) -> Box<dyn AstModifier + 'a>;\n+}\n+\n+pub trait PassFactory: Send + Sync {\n+    fn create<'a>(&'a self) -> Box<dyn Pass + Send + Sync + 'a>;\n+}\n+\n+macro_rules! method {\n+    ($name:ident, $T:ty) => {\n+        fn $name(&self, _node: &mut $T) {}\n+    };\n }\n \n+pub trait AstModifier: Send + Sync {\n+    method!(visit_mut_prop, Prop);\n+    method!(visit_mut_simple_assign_target, SimpleAssignTarget);\n+    method!(visit_mut_expr, Expr);\n+    method!(visit_mut_member_expr, MemberExpr);\n+    method!(visit_mut_pat, Pat);\n+    method!(visit_mut_stmt, Stmt);\n+    method!(visit_mut_module_decl, ModuleDecl);\n+    method!(visit_mut_module_item, ModuleItem);\n+    method!(visit_mut_call_expr, CallExpr);\n+    method!(visit_mut_lit, Lit);\n+    method!(visit_mut_str, Str);\n+    method!(visit_mut_block_stmt, BlockStmt);\n+    method!(visit_mut_switch_case, SwitchCase);\n+}\n+\n+pub trait ModifiableAst {\n+    fn modify(&mut self, modifier: &dyn AstModifier);\n+}\n+\n+macro_rules! impl_modify {\n+    ($visit_mut_name:ident, $T:ty) => {\n+        impl ModifiableAst for $T {\n+            fn modify(&mut self, modifier: &dyn AstModifier) {\n+                modifier.$visit_mut_name(self)\n+            }\n+        }\n+    };\n+}\n+\n+impl_modify!(visit_mut_prop, Prop);\n+impl_modify!(visit_mut_simple_assign_target, SimpleAssignTarget);\n+impl_modify!(visit_mut_expr, Expr);\n+impl_modify!(visit_mut_member_expr, MemberExpr);\n+impl_modify!(visit_mut_pat, Pat);\n+impl_modify!(visit_mut_stmt, Stmt);\n+impl_modify!(visit_mut_module_decl, ModuleDecl);\n+impl_modify!(visit_mut_module_item, ModuleItem);\n+impl_modify!(visit_mut_call_expr, CallExpr);\n+impl_modify!(visit_mut_lit, Lit);\n+impl_modify!(visit_mut_str, Str);\n+impl_modify!(visit_mut_block_stmt, BlockStmt);\n+impl_modify!(visit_mut_switch_case, SwitchCase);\n+\n #[derive(PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, ValueDebugFormat, NonLocalValue)]\n pub enum CodeGen {\n     // AMD occurs very rarely and makes the enum much bigger\n@@ -208,24 +282,31 @@ macro_rules! create_visitor {\n         impl<T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> $crate::code_gen::VisitorFactory\n             for Box<Visitor<T>>\n         {\n-            fn create<'a>(&'a self) -> Box<dyn swc_core::ecma::visit::VisitMut + Send + Sync + 'a> {\n+            fn create<'a>(&'a self) -> Box<dyn $crate::code_gen::AstModifier + 'a> {\n                 Box::new(&**self)\n             }\n         }\n \n-        impl<'a, T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> swc_core::ecma::visit::VisitMut\n+        impl<'a, T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> $crate::code_gen::AstModifier\n             for &'a Visitor<T>\n         {\n-            fn $name(&mut self, $arg: &mut swc_core::ecma::ast::$ty) {\n+            fn $name(&self, $arg: &mut swc_core::ecma::ast::$ty) {\n                 (self.$name)($arg);\n             }\n         }\n \n-        (\n-            $ast_path,\n-            Box::new(Box::new(Visitor {\n-                $name: move |$arg: &mut swc_core::ecma::ast::$ty| $b,\n-            })) as Box<dyn $crate::code_gen::VisitorFactory>,\n-        )\n+        {\n+            #[cfg(debug_assertions)]\n+            if $ast_path.is_empty() {\n+                unreachable!(\"if the path is empty, the visitor should be a root visitor\");\n+            }\n+\n+            (\n+                $ast_path,\n+                Box::new(Box::new(Visitor {\n+                    $name: move |$arg: &mut swc_core::ecma::ast::$ty| $b,\n+                })) as Box<dyn $crate::code_gen::VisitorFactory>,\n+            )\n+        }\n     }};\n }"
        },
        {
            "sha": "4c5f6f61845b1e2a8db557a9a9d03dc57be905c6",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=6679022c95bfa5a273a410bc81773f474c6acec9",
            "patch": "@@ -1172,9 +1172,13 @@ fn process_content_with_code_gens(\n         for CodeGenerationHoistedStmt { key, stmt } in code_gen.early_hoisted_stmts.drain(..) {\n             early_hoisted_stmts.insert(key.clone(), stmt);\n         }\n+        for visitor in &code_gen.root_visitors {\n+            root_visitors.push(visitor.create());\n+        }\n+\n         for (path, visitor) in &code_gen.visitors {\n             if path.is_empty() {\n-                root_visitors.push(&**visitor);\n+                unreachable!(\"if the path is empty, the visitor should be a root visitor\");\n             } else {\n                 visitors.push((path, &**visitor));\n             }\n@@ -1188,8 +1192,8 @@ fn process_content_with_code_gens(\n                 &mut Default::default(),\n             );\n         }\n-        for visitor in root_visitors {\n-            program.visit_mut_with(&mut visitor.create());\n+        for pass in root_visitors {\n+            program.mutate(pass);\n         }\n         program.visit_mut_with(\n             &mut swc_core::ecma::transforms::base::hygiene::hygiene_with_config("
        },
        {
            "sha": "e695a89932bc3499e5d9e47961395b37a1eabf58",
            "filename": "turbopack/crates/turbopack-ecmascript/src/path_visitor.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fpath_visitor.rs?ref=6679022c95bfa5a273a410bc81773f474c6acec9",
            "patch": "@@ -4,11 +4,11 @@ use swc_core::{\n     common::pass::AstKindPath,\n     ecma::{\n         ast::*,\n-        visit::{AstParentKind, VisitMut, VisitMutAstPath, VisitMutWith, VisitMutWithAstPath},\n+        visit::{AstParentKind, VisitMutAstPath, VisitMutWithAstPath},\n     },\n };\n \n-use crate::code_gen::VisitorFactory;\n+use crate::code_gen::{ModifiableAst, VisitorFactory};\n \n pub type AstPath = Vec<AstParentKind>;\n \n@@ -79,8 +79,7 @@ impl<'a> ApplyVisitors<'a, '_> {\n     #[inline(never)]\n     fn visit_if_required<N>(&mut self, n: &mut N, ast_path: &mut AstKindPath<AstParentKind>)\n     where\n-        N: for<'aa> VisitMutWith<dyn VisitMut + Send + Sync + 'aa>\n-            + for<'aa, 'bb> VisitMutWithAstPath<ApplyVisitors<'aa, 'bb>>,\n+        N: ModifiableAst + for<'aa, 'bb> VisitMutWithAstPath<ApplyVisitors<'aa, 'bb>>,\n     {\n         let mut index = self.index;\n         let mut current_visitors = self.visitors.as_ref();\n@@ -110,7 +109,7 @@ impl<'a> ApplyVisitors<'a, '_> {\n                         );\n                     }\n                     for (_, visitor) in visitors[..nested_visitors_start].iter() {\n-                        n.visit_mut_with(&mut visitor.create());\n+                        n.modify(&*visitor.create());\n                     }\n                     return;\n                 } else {\n@@ -168,12 +167,13 @@ mod tests {\n             codegen::{Emitter, text_writer::JsWriter},\n             parser::parse_file_as_module,\n             transforms::base::resolver,\n-            visit::{AstParentKind, VisitMut, VisitMutWith, VisitMutWithAstPath, fields::*},\n+            visit::{AstParentKind, VisitMutWith, VisitMutWithAstPath, fields::*},\n         },\n         testing::run_test,\n     };\n \n     use super::{ApplyVisitors, VisitorFactory};\n+    use crate::code_gen::AstModifier;\n \n     fn parse(fm: &SourceFile) -> Module {\n         let mut m = parse_file_as_module(\n@@ -199,13 +199,13 @@ mod tests {\n     }\n \n     impl VisitorFactory for Box<StrReplacer<'_>> {\n-        fn create<'a>(&'a self) -> Box<dyn VisitMut + Send + Sync + 'a> {\n+        fn create<'a>(&'a self) -> Box<dyn AstModifier + 'a> {\n             Box::new(&**self)\n         }\n     }\n \n-    impl VisitMut for &'_ StrReplacer<'_> {\n-        fn visit_mut_str(&mut self, s: &mut Str) {\n+    impl AstModifier for &'_ StrReplacer<'_> {\n+        fn visit_mut_str(&self, s: &mut Str) {\n             s.value = s.value.replace(self.from, self.to).into();\n             s.raw = None;\n         }"
        },
        {
            "sha": "abf158fb3d66363c2c5e6f52e63998f90536d5b1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6679022c95bfa5a273a410bc81773f474c6acec9/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=6679022c95bfa5a273a410bc81773f474c6acec9",
            "patch": "@@ -678,6 +678,7 @@ impl EsmExports {\n         };\n \n         Ok(CodeGeneration::new(\n+            vec![],\n             vec![],\n             [dynamic_stmt\n                 .map(|stmt| CodeGenerationHoistedStmt::new(\"__turbopack_dynamic__\".into(), stmt))]"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 110,
        "deletions": 24
    }
}