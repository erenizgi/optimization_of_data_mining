{
    "author": "huozhi",
    "message": "fix duplicated noindex when server action is triggered (#76847)\n\n### What\n\nWhen client sends and Server Action request with `notFound()` inside,\nnext-server will serve the RSC payload in response but we were also\nserving a fallback `robots=noindex` metadata for 404 requests. This will\nbe a conflict for users custom metadata. The fallback `robots=noindex`\nfor 404 response was for initially for pages rendering request.\n\nHere we skip it for the dynamic RSC to avoid user's metadata being\nde-prioritized due to the fallback `robots=noindex` taking precedence.\n\nWe also add a test that it won't break form action, where when JS is\ndisabled and notFound involked, the new page can still be served with\nfallback noindex\n\nFixes NDX-953",
    "sha": "ee2bd3f00b55dca0c45cd4b9092538942a935f24",
    "files": [
        {
            "sha": "3a5ae892c82d74a7aad7353be86dbbf9b5fabc01",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -427,7 +427,8 @@ function NonIndex({ ctx }: { ctx: AppRenderContext }) {\n   const isInvalidStatusCode =\n     typeof ctx.res.statusCode === 'number' && ctx.res.statusCode > 400\n \n-  if (is404Page || isInvalidStatusCode) {\n+  // Only render noindex for page request, skip for server actions\n+  if (!ctx.isAction && (is404Page || isInvalidStatusCode)) {\n     return <meta name=\"robots\" content=\"noindex\" />\n   }\n   return null"
        },
        {
            "sha": "9e507b43c2ba28106c6dadfc046a2bbac3b86db3",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -359,9 +359,15 @@ describe('app-dir action handling', () => {\n \n     await browser.elementByCss('#nowhere').click()\n \n+    // Until not-found page is resolved\n     await retry(async () => {\n       expect(await browser.elementByCss('h1').text()).toBe('my-not-found')\n     })\n+\n+    // Should have default noindex meta tag\n+    expect(\n+      await browser.elementByCss('meta[name=\"robots\"]').getAttribute('content')\n+    ).toBe('noindex')\n   })\n \n   it('should support uploading files', async () => {"
        },
        {
            "sha": "a26153b81b34a099238625094a395054e4cafc09",
            "filename": "test/e2e/app-dir/metadata-navigation/app/server-action/not-found/action.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Faction.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Faction.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Faction.tsx?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -0,0 +1,7 @@\n+'use server'\n+\n+import { notFound } from 'next/navigation'\n+\n+export async function actionNotFound() {\n+  return notFound()\n+}"
        },
        {
            "sha": "5a34549a3ebc6f31288864050b5535745e82e861",
            "filename": "test/e2e/app-dir/metadata-navigation/app/server-action/not-found/page-client.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage-client.tsx?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+import { actionNotFound } from './action'\n+\n+export default function Page() {\n+  return (\n+    <button\n+      id=\"trigger-not-found\"\n+      onClick={() => {\n+        actionNotFound()\n+      }}\n+    >\n+      trigger not found\n+    </button>\n+  )\n+}"
        },
        {
            "sha": "11b06c98cf6ea6e7f1e8191fb3f599e030402199",
            "filename": "test/e2e/app-dir/metadata-navigation/app/server-action/not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fapp%2Fserver-action%2Fnot-found%2Fpage.tsx?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -0,0 +1,7 @@\n+export { default } from './page-client'\n+\n+export async function generateMetadata() {\n+  return {\n+    robots: 'noindex, nofollow',\n+  }\n+}"
        },
        {
            "sha": "6b3691557602dac52970f61ac3a7d41b05631273",
            "filename": "test/e2e/app-dir/metadata-navigation/metadata-navigation.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ee2bd3f00b55dca0c45cd4b9092538942a935f24/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-navigation%2Fmetadata-navigation.test.ts?ref=ee2bd3f00b55dca0c45cd4b9092538942a935f24",
            "patch": "@@ -5,6 +5,7 @@ import {\n   getTitle,\n   retry,\n } from 'next-test-utils'\n+import { Request } from 'playwright'\n \n describe('app dir - metadata navigation', () => {\n   const { next } = nextTestSetup({\n@@ -108,4 +109,33 @@ describe('app dir - metadata navigation', () => {\n       expect(await browser.elementByCss('title').text()).toBe('Home Layout')\n     })\n   })\n+\n+  describe('server action', () => {\n+    it('should not render fallback noindex metadata if request is initiated from server action', async () => {\n+      const browser = await next.browser('/server-action/not-found')\n+      // collect server action requests\n+      let isActionSent = false\n+      browser.on('request', (req: Request) => {\n+        if (\n+          req.method() === 'POST' &&\n+          req.url().endsWith('/server-action/not-found')\n+        ) {\n+          isActionSent = true\n+        }\n+      })\n+\n+      // trigger not-found action and wait until the server action is performed\n+      await browser.elementByCss('#trigger-not-found').click()\n+      await retry(async () => {\n+        expect(isActionSent).toBe(true)\n+      })\n+\n+      expect(await browser.elementsByCss('meta[name=\"robots\"]')).toHaveLength(1)\n+      expect(\n+        await browser\n+          .elementByCss('meta[name=\"robots\"]')\n+          .getAttribute('content')\n+      ).toBe('noindex, nofollow')\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 68,
        "deletions": 1
    }
}