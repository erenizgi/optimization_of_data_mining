{
    "author": "unstubbable",
    "message": "Ignore pending revalidations during prerendering (#81621)\n\nWhen reading a cache entry, we usually check its tags against the recently revalidated tags, and dismiss it, if it has any of those tags. However, this is only needed during dynamic requests, specifically during the rendering that follows a revalidating server action.\r\n\r\nDuring the prerender validation in dev mode, we should not discard the cache entries based on the pending revalidation. The concurrently running dynamic rendering will handle discarding and recreating those cache entries. During build-time prerendering, there will never be any pending revalidated tags.\r\n\r\nThis fixes a bug where a different value was rendered when revalidating with a server action and then reloading the page afterwards (or triggering another unrelated revalidating server action).",
    "sha": "43b64ccdb53eba5589a36b657aa9935dd2367750",
    "files": [
        {
            "sha": "a739cbfd9aeabf7638e414659cb47905df304daa",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 9,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/43b64ccdb53eba5589a36b657aa9935dd2367750/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43b64ccdb53eba5589a36b657aa9935dd2367750/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=43b64ccdb53eba5589a36b657aa9935dd2367750",
            "patch": "@@ -1004,6 +1004,7 @@ export function cache(\n             shouldDiscardCacheEntry(\n               entry,\n               workStore,\n+              workUnitStore,\n               implicitTags,\n               implicitTagsExpiration\n             )\n@@ -1284,17 +1285,12 @@ function shouldForceRevalidate(\n function shouldDiscardCacheEntry(\n   entry: CacheEntry,\n   workStore: WorkStore,\n+  workUnitStore: WorkUnitStore | undefined,\n   implicitTags: string[],\n   implicitTagsExpiration: number\n ): boolean {\n-  // If the cache entry contains revalidated tags that the cache handler might\n-  // not know about yet, we need to discard it.\n-  if (entry.tags.some((tag) => isRecentlyRevalidatedTag(tag, workStore))) {\n-    return true\n-  }\n-\n   // If the cache entry was created before any of the implicit tags were\n-  // revalidated last, we also need to discard it.\n+  // revalidated last, we need to discard it.\n   if (entry.timestamp <= implicitTagsExpiration) {\n     debug?.(\n       'entry was created at',\n@@ -1306,6 +1302,33 @@ function shouldDiscardCacheEntry(\n     return true\n   }\n \n+  // During prerendering, we ignore recently revalidated tags. In dev mode, we\n+  // can assume that the dynamic dev rendering will have discarded and recreated\n+  // the affected cache entries, and we don't want to discard those again during\n+  // the prerender validation. During build-time prerendering, there will never\n+  // be any pending revalidated tags.\n+  if (workUnitStore) {\n+    switch (workUnitStore.type) {\n+      case 'prerender':\n+        return false\n+      case 'prerender-client':\n+      case 'prerender-ppr':\n+      case 'prerender-legacy':\n+      case 'request':\n+      case 'cache':\n+      case 'unstable-cache':\n+        break\n+      default:\n+        workUnitStore satisfies never\n+    }\n+  }\n+\n+  // If the cache entry contains revalidated tags that the cache handler might\n+  // not know about yet, we need to discard it.\n+  if (entry.tags.some((tag) => isRecentlyRevalidatedTag(tag, workStore))) {\n+    return true\n+  }\n+\n   // Finally, if any of the implicit tags have been revalidated recently, we\n   // also need to discard the cache entry.\n   if (implicitTags.some((tag) => isRecentlyRevalidatedTag(tag, workStore))) {\n@@ -1326,8 +1349,9 @@ function isRecentlyRevalidatedTag(tag: string, workStore: WorkStore): boolean {\n   }\n \n   // It could also have been revalidated by the currently running server action.\n-  // In this case the revalidation might not have been propagated to the cache\n-  // handler yet, so we read it from the pending tags in the work store.\n+  // In this case the revalidation might not have been fully propagated by a\n+  // remote cache handler yet, so we read it from the pending tags in the work\n+  // store.\n   if (pendingRevalidatedTags?.includes(tag)) {\n     debug?.('tag', tag, 'was just revalidated')\n "
        },
        {
            "sha": "cd98b0a876ea34281ba94c341f854c83e974577f",
            "filename": "test/cache-components-tests-manifest.json",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/43b64ccdb53eba5589a36b657aa9935dd2367750/test%2Fcache-components-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/43b64ccdb53eba5589a36b657aa9935dd2367750/test%2Fcache-components-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fcache-components-tests-manifest.json?ref=43b64ccdb53eba5589a36b657aa9935dd2367750",
            "patch": "@@ -27,9 +27,6 @@\n         \"searchparams-reuse-loading should re-use loading from \\\"full\\\" prefetch for param-less URL when navigating to param-full route\"\n       ]\n     },\n-    \"test/e2e/app-dir/use-cache/use-cache.test.ts\": {\n-      \"failed\": [\"use-cache should update after unstable_expireTag correctly\"]\n-    },\n     \"test/production/app-dir/browser-chunks/browser-chunks.test.ts\": {\n       \"failed\": [\n         \"browser-chunks must not bundle any server modules into browser chunks\""
        }
    ],
    "stats": {
        "total": 45,
        "additions": 33,
        "deletions": 12
    }
}