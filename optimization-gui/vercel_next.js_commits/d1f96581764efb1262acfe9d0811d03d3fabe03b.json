{
    "author": "huozhi",
    "message": "[metadata] only serve block streaming metadata for html bots (#80272)",
    "sha": "d1f96581764efb1262acfe9d0811d03d3fabe03b",
    "files": [
        {
            "sha": "a26e60ad85e96b681a688e2acf1870cedf7b437b",
            "filename": "packages/next/src/server/lib/streaming-metadata.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f96581764efb1262acfe9d0811d03d3fabe03b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f96581764efb1262acfe9d0811d03d3fabe03b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstreaming-metadata.ts?ref=d1f96581764efb1262acfe9d0811d03d3fabe03b",
            "patch": "@@ -12,10 +12,11 @@ export function shouldServeStreamingMetadata(\n     htmlLimitedBots || HTML_LIMITED_BOT_UA_RE_STRING,\n     'i'\n   )\n-  return (\n-    // When it's static generation, userAgents are not available - do not serve streaming metadata\n-    !!userAgent && !blockingMetadataUARegex.test(userAgent)\n-  )\n+  // Only block metadata for HTML-limited bots\n+  if (userAgent && blockingMetadataUARegex.test(userAgent)) {\n+    return false\n+  }\n+  return true\n }\n \n // When the request UA is a html-limited bot, we should do a dynamic render."
        },
        {
            "sha": "f49ef9892953f14a9794d292dee98e6c59a39081",
            "filename": "test/integration/next-image-new/app-dir/app/valid-html-w3c/page.js",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f96581764efb1262acfe9d0811d03d3fabe03b/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fvalid-html-w3c%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f96581764efb1262acfe9d0811d03d3fabe03b/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fvalid-html-w3c%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fvalid-html-w3c%2Fpage.js?ref=d1f96581764efb1262acfe9d0811d03d3fabe03b",
            "patch": "@@ -1,15 +1,8 @@\n-import Head from 'next/head'\n import Image from 'next/image'\n \n const Page = () => {\n   return (\n     <div>\n-      <Head>\n-        <title>Title</title>\n-        <meta name=\"description\" content=\"Description...\" />\n-        <link rel=\"icon\" type=\"image/jpeg\" href=\"/test.jpg\" />\n-      </Head>\n-\n       <main>\n         <Image src=\"/test.jpg\" width=\"400\" height=\"400\" alt=\"basic image\" />\n       </main>\n@@ -18,3 +11,11 @@ const Page = () => {\n }\n \n export default Page\n+\n+export const metadata = {\n+  title: 'Title',\n+  description: 'Description...',\n+  icons: {\n+    icon: '/test.jpg',\n+  },\n+}"
        },
        {
            "sha": "3323e520f3882e717cb6b6e79e76bacb4bec5c40",
            "filename": "test/integration/next-image-new/app-dir/test/index.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 19,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f96581764efb1262acfe9d0811d03d3fabe03b/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f96581764efb1262acfe9d0811d03d3fabe03b/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts?ref=d1f96581764efb1262acfe9d0811d03d3fabe03b",
            "patch": "@@ -1568,25 +1568,26 @@ function runTests(mode: 'dev' | 'server') {\n   })\n \n   it('should be valid HTML', async () => {\n-    let browser\n-    try {\n-      browser = await webdriver(appPort, '/valid-html-w3c')\n-      await waitFor(1000)\n-      expect(await browser.hasElementByCssSelector('img')).toBeTruthy()\n-      const url = await browser.url()\n-      const result = (await validateHTML({\n-        url,\n-        format: 'json',\n-        isLocal: true,\n-        validator: 'whatwg',\n-      })) as any\n-      expect(result.isValid).toBe(true)\n-      expect(result.errors).toEqual([])\n-    } finally {\n-      if (browser) {\n-        await browser.close()\n-      }\n-    }\n+    // `html-validator` underlying API (W3C validator or Nu HTML Checker) ignores or overrides custom headers.\n+    // So we need to use a custom User-Agent to avoid streaming metadata.\n+    // Otherwise the HTML will failed with validation which requires title to be rendered under the `head` tag.\n+    const html = await renderViaHTTP(appPort, '/valid-html-w3c', null, {\n+      headers: {\n+        'User-Agent': 'Discordbot',\n+      },\n+    })\n+\n+    const result = (await validateHTML({\n+      data: html,\n+      format: 'json',\n+      isLocal: true,\n+      validator: 'whatwg',\n+    })) as any\n+    expect(result.isValid).toBe(true)\n+    expect(result.errors).toEqual([])\n+\n+    const $ = cheerio.load(html)\n+    expect($('img').length).toBeGreaterThan(0)\n   })\n \n   it('should call callback ref cleanups when unmounting', async () => {"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 33,
        "deletions": 30
    }
}