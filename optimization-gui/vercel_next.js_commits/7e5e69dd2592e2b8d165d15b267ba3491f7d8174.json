{
    "author": "mischnic",
    "message": "Turbopack: deterministic server action order (#76905)\n\n`HashMap` strikes again, causing the server action manifest order to be non-deterministic.\r\n\r\nLess test flakeyness for `app-dir - server-action-period-hash-custom-key should have different manifest if the encryption key from process env is same`",
    "sha": "7e5e69dd2592e2b8d165d15b267ba3491f7d8174",
    "files": [
        {
            "sha": "e649107407928eec8b0536a96d67ce2d6ed43480",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=7e5e69dd2592e2b8d165d15b267ba3491f7d8174",
            "patch": "@@ -213,7 +213,7 @@ impl ServerActionsGraph {\n                     return Ok(Vc::cell(Default::default()));\n                 }\n \n-                let mut result = FxHashMap::default();\n+                let mut result = FxIndexMap::default();\n                 graph.traverse_from_entry(entry, |node| {\n                     if let Some(node_data) = data.get(&node.module) {\n                         result.insert(node.module, *node_data);"
        },
        {
            "sha": "0d780f41ee03758e1dc70aeaaf706e2c5d34501f",
            "filename": "crates/next-api/src/server_actions.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs?ref=7e5e69dd2592e2b8d165d15b267ba3491f7d8174",
            "patch": "@@ -7,7 +7,6 @@ use next_core::{\n     },\n     util::NextRuntime,\n };\n-use rustc_hash::FxHashMap;\n use swc_core::{\n     atoms::Atom,\n     common::comments::Comments,\n@@ -406,7 +405,7 @@ struct OptionActionMap(Option<ResolvedVc<ActionMap>>);\n type LayerAndActions = (ActionLayer, ResolvedVc<ActionMap>);\n /// A mapping of every module module containing Server Actions, mapping to its layer and actions.\n #[turbo_tasks::value(transparent)]\n-pub struct AllModuleActions(FxHashMap<ResolvedVc<Box<dyn Module>>, LayerAndActions>);\n+pub struct AllModuleActions(FxIndexMap<ResolvedVc<Box<dyn Module>>, LayerAndActions>);\n \n #[turbo_tasks::function]\n pub async fn map_server_actions(graph: Vc<SingleModuleGraph>) -> Result<Vc<AllModuleActions>> {"
        },
        {
            "sha": "14e49ad7707f85f3115a9ffb1050b5338adb46e8",
            "filename": "test/production/app-dir/server-action-period-hash/server-action-period-hash-custom-key.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 28,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash-custom-key.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash-custom-key.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash-custom-key.test.ts?ref=7e5e69dd2592e2b8d165d15b267ba3491f7d8174",
            "patch": "@@ -1,24 +1,10 @@\n-import { nextTestSetup } from 'e2e-utils'\n+import { nextTestSetup, type NextInstance } from 'e2e-utils'\n \n-async function getServerActionManifest(next) {\n-  const content = await next.readFile(\n+async function getServerActionManifestNodeKeys(next: NextInstance) {\n+  const manifest = await next.readJSON(\n     '.next/server/server-reference-manifest.json'\n   )\n-  return JSON.parse(content)\n-}\n-\n-function compareServerActionManifestKeys(a, b, equal) {\n-  a = a.node\n-  b = b.node\n-\n-  const keysA = Object.keys(a)\n-  const keysB = Object.keys(b)\n-\n-  if (equal) {\n-    expect(keysA).toEqual(keysB)\n-  } else {\n-    expect(keysA).not.toEqual(keysB)\n-  }\n+  return Object.keys(manifest.node)\n }\n \n describe('app-dir - server-action-period-hash-custom-key', () => {\n@@ -27,32 +13,30 @@ describe('app-dir - server-action-period-hash-custom-key', () => {\n     skipStart: true,\n   })\n \n-  it('should have different manifest if the encryption key from process env is changed', async () => {\n+  it('should have a different manifest if the encryption key from process env is changed', async () => {\n     process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY = 'my-secret-key1'\n     await next.build()\n     delete process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY\n-    const firstManifest = await getServerActionManifest(next)\n+    const firstActionIds = await getServerActionManifestNodeKeys(next)\n \n     process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY = 'my-secret-key2'\n     await next.build()\n     delete process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY\n+    const secondActionIds = await getServerActionManifestNodeKeys(next)\n \n-    const secondManifest = await getServerActionManifest(next)\n-\n-    compareServerActionManifestKeys(firstManifest, secondManifest, false)\n+    expect(firstActionIds).not.toEqual(secondActionIds)\n   })\n \n-  it('should have different manifest if the encryption key from process env is same', async () => {\n+  it('should have the same manifest if the encryption key from process env is same', async () => {\n     process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY = 'my-secret-key'\n     await next.build()\n-    const firstManifest = await getServerActionManifest(next)\n+    const firstActionIds = await getServerActionManifestNodeKeys(next)\n \n     await next.remove('.next') // dismiss cache\n     await next.build() // build with the same secret key\n     delete process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY\n+    const secondActionIds = await getServerActionManifestNodeKeys(next)\n \n-    const secondManifest = await getServerActionManifest(next)\n-\n-    compareServerActionManifestKeys(firstManifest, secondManifest, true)\n+    expect(firstActionIds).toEqual(secondActionIds)\n   })\n })"
        },
        {
            "sha": "9516d8a75edf8150c01fb3975731fd22438064e5",
            "filename": "test/production/app-dir/server-action-period-hash/server-action-period-hash.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 24,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e5e69dd2592e2b8d165d15b267ba3491f7d8174/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fserver-action-period-hash%2Fserver-action-period-hash.test.ts?ref=7e5e69dd2592e2b8d165d15b267ba3491f7d8174",
            "patch": "@@ -1,24 +1,10 @@\n-import { nextTestSetup } from 'e2e-utils'\n+import { nextTestSetup, type NextInstance } from 'e2e-utils'\n \n-async function getServerActionManifest(next) {\n-  const content = await next.readFile(\n+async function getServerActionManifestNodeKeys(next: NextInstance) {\n+  const manifest = await next.readJSON(\n     '.next/server/server-reference-manifest.json'\n   )\n-  return JSON.parse(content)\n-}\n-\n-function compareServerActionManifestKeys(a, b, equal) {\n-  a = a.node\n-  b = b.node\n-\n-  const keysA = Object.keys(a)\n-  const keysB = Object.keys(b)\n-\n-  if (equal) {\n-    expect(keysA).toEqual(keysB)\n-  } else {\n-    expect(keysA).not.toEqual(keysB)\n-  }\n+  return Object.keys(manifest.node)\n }\n \n describe('app-dir - server-action-period-hash', () => {\n@@ -29,23 +15,23 @@ describe('app-dir - server-action-period-hash', () => {\n \n   it('should have same manifest between continuous two builds', async () => {\n     await next.build()\n-    const firstManifest = await getServerActionManifest(next)\n+    const firstActionIds = await getServerActionManifestNodeKeys(next)\n \n     await next.build()\n-    const secondManifest = await getServerActionManifest(next)\n+    const secondActionIds = await getServerActionManifestNodeKeys(next)\n \n-    compareServerActionManifestKeys(firstManifest, secondManifest, true)\n+    expect(firstActionIds).toEqual(secondActionIds)\n   })\n \n   it('should have different manifest between two builds with period hash', async () => {\n     await next.build()\n-    const firstManifest = await getServerActionManifest(next)\n+    const firstActionIds = await getServerActionManifestNodeKeys(next)\n \n     await next.remove('.next') // dismiss cache\n     await next.build()\n \n-    const secondManifest = await getServerActionManifest(next)\n+    const secondActionIds = await getServerActionManifestNodeKeys(next)\n \n-    compareServerActionManifestKeys(firstManifest, secondManifest, false)\n+    expect(firstActionIds).not.toEqual(secondActionIds)\n   })\n })"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 24,
        "deletions": 55
    }
}