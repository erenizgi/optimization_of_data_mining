{
    "author": "eps1lon",
    "message": "[test] Use NEXT_TEST_CI when forking test in CI (#79354)",
    "sha": "100881542a857dd158879cd2a6ce49eaaf923cd4",
    "files": [
        {
            "sha": "15363274eb5d74793c05eb926a4e0f999c27eb70",
            "filename": ".eslintrc.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/.eslintrc.json",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/.eslintrc.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.eslintrc.json?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -48,7 +48,7 @@\n         \"jest/no-export\": \"off\",\n         \"jest/no-standalone-expect\": [\n           \"error\",\n-          { \"additionalTestBlockFunctions\": [\"retry\"] }\n+          { \"additionalTestBlockFunctions\": [\"retry\", \"itCI\", \"itHeaded\"] }\n         ]\n       }\n     },"
        },
        {
            "sha": "20f7cda81b687c143cf3b733155ce7d40b600f1f",
            "filename": "run-tests.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/run-tests.js",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/run-tests.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/run-tests.js?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -480,7 +480,7 @@ ${ENDGROUP}`)\n         // tested when enabled\n         CI: '',\n         // But some tests need to fork based on machine? CI? behavior differences\n-        // Only use read this in tests.\n+        // Only use this in tests.\n         // For implementation forks, use `process.env.CI` instead\n         NEXT_TEST_CI: process.env.CI,\n "
        },
        {
            "sha": "3dad9b1846119fe76c75b31ce71362ca1d99c56a",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -641,7 +641,7 @@ describe('next.rs api', () => {\n     let currentContent = await next.readFile(file)\n     let nextContent = pagesIndexCode('hello world2')\n \n-    const count = process.env.CI ? 300 : 1000\n+    const count = process.env.NEXT_TEST_CI ? 300 : 1000\n     for (let i = 0; i < count; i++) {\n       await next.patchFile(file, nextContent)\n       const content = currentContent"
        },
        {
            "sha": "b06e5b4c5dee162dc07fb1d2012529923e803068",
            "filename": "test/development/experimental-https-server/https-server.generated-key.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -8,11 +8,11 @@ describe('experimental-https-server (generated certificate)', () => {\n     startCommand: `pnpm next ${\n       shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n     } --experimental-https`,\n-    skipStart: !process.env.CI,\n+    skipStart: !process.env.NEXT_TEST_CI,\n   })\n   if (skipped) return\n \n-  if (!process.env.CI) {\n+  if (!process.env.NEXT_TEST_CI) {\n     console.warn('only runs on CI as it requires administrator privileges')\n     it('only runs on CI as it requires administrator privileges', () => {})\n     return"
        },
        {
            "sha": "d06513d5c705f4c68520f6284490977d3d154bbc",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -26,6 +26,8 @@ const browserConfigWithFixedTime = {\n   },\n }\n \n+const itHeaded = process.env.HEADLESS ? it.skip : it\n+\n describe('app dir - prefetching', () => {\n   const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n@@ -91,12 +93,7 @@ describe('app dir - prefetching', () => {\n     )\n   })\n \n-  it('should not suppress prefetches after navigating back', async () => {\n-    if (!process.env.CI && process.env.HEADLESS) {\n-      console.warn('This test can only run in headed mode. Skipping...')\n-      return\n-    }\n-\n+  itHeaded('should not suppress prefetches after navigating back', async () => {\n     // Force headed mode, as bfcache is not available in headless mode.\n     const browser = await next.browser('/', { headless: false })\n "
        },
        {
            "sha": "d27b43fe1faeedcc21d11b7cb6ac0003fbb3ca58",
            "filename": "test/e2e/app-dir/next-image/next-image-https.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext-image-https.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext-image-https.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext-image-https.test.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -1,6 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n \n-describe('app dir - next-image (with https)', () => {\n+// TODO: Test didn't (or maybe) never ran in CI but it should.\n+describe.skip('app dir - next-image (with https)', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n@@ -11,12 +12,6 @@ describe('app dir - next-image (with https)', () => {\n     return\n   }\n \n-  if (!process.env.CI) {\n-    console.warn('only runs on CI as it requires administrator privileges')\n-    it('only runs on CI as it requires administrator privileges', () => {})\n-    return\n-  }\n-\n   it('loads images without any errors', async () => {\n     let failCount = 0\n     const browser = await next.browser('/', {"
        },
        {
            "sha": "4a8f33369109b0183d4c726524cb0bf7e6a1c021",
            "filename": "test/integration/cli/test/index.test.js",
            "status": "modified",
            "additions": 10,
            "deletions": 13,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -6,6 +6,7 @@ import {\n   killApp,\n   launchApp,\n   nextBuild,\n+  retry,\n   runNextCommand,\n   runNextCommandDev,\n } from 'next-test-utils'\n@@ -18,6 +19,8 @@ import stripAnsi from 'strip-ansi'\n const dirBasic = join(__dirname, '../basic')\n const dirDuplicateSass = join(__dirname, '../duplicate-sass')\n \n+const itCI = process.env.NEXT_TEST_CI ? it : it.skip\n+\n const runAndCaptureOutput = async ({ port }) => {\n   let stdout = ''\n   let stderr = ''\n@@ -738,16 +741,8 @@ describe('CLI Usage', () => {\n       }\n     })\n \n-    // only runs on CI as it requires administrator privileges\n-    test('--experimental-https', async () => {\n-      if (!process.env.CI) {\n-        console.warn(\n-          '--experimental-https only runs on CI as it requires administrator privileges'\n-        )\n-\n-        return\n-      }\n-\n+    itCI('--experimental-https', async () => {\n+      // only runs on CI as it requires administrator privileges\n       const port = await findPort()\n       let output = ''\n       const app = await runNextCommandDev(\n@@ -760,9 +755,11 @@ describe('CLI Usage', () => {\n         }\n       )\n       try {\n-        await check(() => output, /Network:\\s*http:\\/\\/\\[::\\]:(\\d+)/)\n-        await check(() => output, /https:\\/\\/localhost:(\\d+)/)\n-        await check(() => output, /Certificates created in/)\n+        await retry(() => {\n+          expect(output).toMatch(/Network:\\s*https:\\/\\//)\n+        })\n+        expect(output).toMatch(/Local:\\s*https:\\/\\/localhost:(\\d+)/)\n+        expect(output).toContain('Certificates created in')\n       } finally {\n         await killApp(app)\n       }"
        },
        {
            "sha": "45d28dde1c905c6e203fe0a3a4910a583d55292a",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -73,13 +73,13 @@ export class NextDevInstance extends NextInstance {\n \n         this.childProcess.stdout!.on('data', (chunk) => {\n           const msg = chunk.toString()\n-          if (!process.env.CI) process.stdout.write(chunk)\n+          process.stdout.write(chunk)\n           this._cliOutput += msg\n           this.emit('stdout', [msg])\n         })\n         this.childProcess.stderr!.on('data', (chunk) => {\n           const msg = chunk.toString()\n-          if (!process.env.CI) process.stderr.write(chunk)\n+          process.stderr.write(chunk)\n           this._cliOutput += msg\n           this.emit('stderr', [msg])\n         })"
        },
        {
            "sha": "0163376a9bb2c0bbb4b2397033665bab9f7ec6ce",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -26,13 +26,13 @@ export class NextStartInstance extends NextInstance {\n   private handleStdio = (childProcess) => {\n     childProcess.stdout.on('data', (chunk) => {\n       const msg = chunk.toString()\n-      if (!process.env.CI) process.stdout.write(chunk)\n+      process.stdout.write(chunk)\n       this._cliOutput += msg\n       this.emit('stdout', [msg])\n     })\n     childProcess.stderr.on('data', (chunk) => {\n       const msg = chunk.toString()\n-      if (!process.env.CI) process.stderr.write(chunk)\n+      process.stderr.write(chunk)\n       this._cliOutput += msg\n       this.emit('stderr', [msg])\n     })"
        },
        {
            "sha": "541c2269fa86d59f195592d54fbda1a322cfe042",
            "filename": "test/production/bfcache-routing/index.test.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 42,
            "changes": 87,
            "blob_url": "https://github.com/vercel/next.js/blob/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fproduction%2Fbfcache-routing%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/100881542a857dd158879cd2a6ce49eaaf923cd4/test%2Fproduction%2Fbfcache-routing%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fbfcache-routing%2Findex.test.ts?ref=100881542a857dd158879cd2a6ce49eaaf923cd4",
            "patch": "@@ -8,6 +8,8 @@ import {\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n \n+const itHeaded = process.env.HEADLESS ? it.skip : it\n+\n describe('bfcache-routing', () => {\n   let port: number\n   let app: Server\n@@ -25,59 +27,60 @@ describe('bfcache-routing', () => {\n     stopApp(app)\n   })\n \n-  it('should not suspend indefinitely when page is restored from bfcache after an mpa navigation', async () => {\n-    // bfcache is not currently supported by CDP, so we need to run this particular test in headed mode\n-    // https://bugs.chromium.org/p/chromium/issues/detail?id=1317959\n-    if (!process.env.CI && process.env.HEADLESS) {\n-      console.warn('This test can only run in headed mode. Skipping...')\n-      return\n-    }\n+  itHeaded(\n+    'should not suspend indefinitely when page is restored from bfcache after an mpa navigation',\n+    async () => {\n+      // bfcache is not currently supported by CDP, so we need to run this particular test in headed mode\n+      // https://bugs.chromium.org/p/chromium/issues/detail?id=1317959\n \n-    const browser = await webdriver(port, '/index.html', { headless: false })\n+      const browser = await webdriver(port, '/index.html', { headless: false })\n \n-    // we overwrite the typical waitUntil: 'load' option here as the event is never being triggered if we hit the bfcache\n-    const bfOptions = { waitUntil: 'commit' as const }\n+      // we overwrite the typical waitUntil: 'load' option here as the event is never being triggered if we hit the bfcache\n+      const bfOptions = { waitUntil: 'commit' as const }\n \n-    await browser.elementByCss('a[href=\"https://example.vercel.sh\"]').click()\n-    await browser.waitForCondition(\n-      'window.location.origin === \"https://example.vercel.sh\"'\n-    )\n+      await browser.elementByCss('a[href=\"https://example.vercel.sh\"]').click()\n+      await browser.waitForCondition(\n+        'window.location.origin === \"https://example.vercel.sh\"'\n+      )\n \n-    await browser.back(bfOptions)\n+      await browser.back(bfOptions)\n \n-    await browser.waitForCondition(\n-      'window.location.origin.includes(\"localhost\")'\n-    )\n+      await browser.waitForCondition(\n+        'window.location.origin.includes(\"localhost\")'\n+      )\n \n-    let html = await browser.eval<string>('document.documentElement.innerHTML')\n+      let html = await browser.eval<string>(\n+        'document.documentElement.innerHTML'\n+      )\n \n-    expect(html).toContain('BFCache Test')\n+      expect(html).toContain('BFCache Test')\n \n-    await browser.eval(`document.querySelector('button').click()`)\n+      await browser.eval(`document.querySelector('button').click()`)\n \n-    // we should still be on the test page\n-    html = await browser.eval<string>('document.documentElement.innerHTML')\n-    expect(html).toContain('BFCache Test')\n+      // we should still be on the test page\n+      html = await browser.eval<string>('document.documentElement.innerHTML')\n+      expect(html).toContain('BFCache Test')\n \n-    await browser.forward(bfOptions)\n-    await browser.back(bfOptions)\n+      await browser.forward(bfOptions)\n+      await browser.back(bfOptions)\n \n-    await browser.waitForCondition(\n-      'window.location.origin.includes(\"localhost\")'\n-    )\n+      await browser.waitForCondition(\n+        'window.location.origin.includes(\"localhost\")'\n+      )\n \n-    // we should be back on the test page with no errors\n-    html = await browser.eval<string>('document.documentElement.innerHTML')\n-    expect(html).toContain('BFCache Test')\n+      // we should be back on the test page with no errors\n+      html = await browser.eval<string>('document.documentElement.innerHTML')\n+      expect(html).toContain('BFCache Test')\n \n-    // After restoring from bfcache, a subsequent mpa navigation to the same URL should work\n-    // We trigger the click via `eval` because when restoring from bfcache, our internal\n-    // 'waitForElementByCss' method doesn't think the element is attached to the DOM.\n-    await browser.eval(\n-      `document.querySelector('a[href=\"https://example.vercel.sh\"]').click()`\n-    )\n-    await browser.waitForCondition(\n-      'window.location.origin === \"https://example.vercel.sh\"'\n-    )\n-  })\n+      // After restoring from bfcache, a subsequent mpa navigation to the same URL should work\n+      // We trigger the click via `eval` because when restoring from bfcache, our internal\n+      // 'waitForElementByCss' method doesn't think the element is attached to the DOM.\n+      await browser.eval(\n+        `document.querySelector('a[href=\"https://example.vercel.sh\"]').click()`\n+      )\n+      await browser.waitForCondition(\n+        'window.location.origin === \"https://example.vercel.sh\"'\n+      )\n+    }\n+  )\n })"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 69,
        "deletions": 77
    }
}