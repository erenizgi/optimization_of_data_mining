{
    "author": "wyattjoh",
    "message": "Add maximum size limit for postponed body parsing (#88175)\n\n### What?\n\nAdds a configurable `experimental.maxPostponedStateSize` limit for PPR\npostponed state body parsing to prevent OOM/DoS attacks.\n\n### Why?\n\nThe postponed state body was read entirely without size limits, creating\na potential denial-of-service vector through unbounded memory\nallocation.\n\n### How?\n\nEnforces a 10 MB default limit (configurable via next.config.js) with\nbyte counting during body parsing. Returns HTTP 413 when exceeded with a\nhelpful error message directing users to increase the limit if needed.\n\n<!-- Closes NEXT- -->\n<!-- Fixes # -->",
    "sha": "45dba91908a77e442b2e05389aeacf6ed95ceb0f",
    "files": [
        {
            "sha": "c7a48e97016a62870edaff25ef5246bfcd73ff09",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -973,5 +973,7 @@\n   \"972\": \"Failed to resolve pattern \\\"%s\\\": %s\",\n   \"973\": \"Server Actions are not enabled for this application. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n   \"974\": \"Failed to find Server Action%s. This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n-  \"975\": \"Failed to find Server Action. This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\"\n+  \"975\": \"Failed to find Server Action. This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n+  \"976\": \"Decompressed resume data cache exceeded %s byte limit\",\n+  \"977\": \"maxPostponedStateSize must be a valid number (bytes) or filesize format string (e.g., \\\"5mb\\\")\"\n }"
        },
        {
            "sha": "544b6f844c4fac538f244b09cceb5ba0a0b7123c",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -56,6 +56,7 @@ import type { CacheControl } from '../../server/lib/cache-control'\n import { ENCODED_TAGS } from '../../server/stream-utils/encoded-tags'\n import { sendRenderResult } from '../../server/send-payload'\n import { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\n+import { parseMaxPostponedStateSize } from '../../shared/lib/size-limit'\n \n // These are injected by the loader afterwards.\n \n@@ -591,6 +592,9 @@ export async function handler(\n               nextConfig.experimental.clientTraceMetadata || ([] as any),\n             clientParamParsingOrigins:\n               nextConfig.experimental.clientParamParsingOrigins,\n+            maxPostponedStateSizeBytes: parseMaxPostponedStateSize(\n+              nextConfig.experimental.maxPostponedStateSize\n+            ),\n           },\n \n           waitUntil: ctx.waitUntil,"
        },
        {
            "sha": "58a9e749897e87fc95078dc1c9c79417cbe434b1",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -26,6 +26,7 @@ import { interopDefault } from '../../lib/interop-default'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { checkIsOnDemandRevalidate } from '../../server/api-utils'\n import { CloseController } from '../../server/web/web-on-close'\n+import { parseMaxPostponedStateSize } from '../../shared/lib/size-limit'\n \n declare const incrementalCacheHandler: any\n // OPTIONAL_IMPORT:incrementalCacheHandler\n@@ -159,6 +160,9 @@ async function requestHandler(\n           nextConfig.experimental.clientTraceMetadata || ([] as any),\n         clientParamParsingOrigins:\n           nextConfig.experimental.clientParamParsingOrigins,\n+        maxPostponedStateSizeBytes: parseMaxPostponedStateSize(\n+          nextConfig.experimental.maxPostponedStateSize\n+        ),\n       },\n \n       incrementalCache: await pageRouteModule.getIncrementalCache("
        },
        {
            "sha": "9495e3121716ff899d94821cf3871d569dd4097a",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -46,6 +46,7 @@ import {\n } from '../shared/lib/constants'\n import loadConfig from '../server/config'\n import type { ExportPathMap } from '../server/config-shared'\n+import { parseMaxPostponedStateSize } from '../server/config-shared'\n import { eventCliSession } from '../telemetry/events'\n import { hasNextSupport } from '../server/ci-info'\n import { Telemetry } from '../telemetry/storage'\n@@ -396,6 +397,9 @@ async function exportAppImpl(\n       dynamicOnHover: nextConfig.experimental.dynamicOnHover ?? false,\n       inlineCss: nextConfig.experimental.inlineCss ?? false,\n       authInterrupts: !!nextConfig.experimental.authInterrupts,\n+      maxPostponedStateSizeBytes: parseMaxPostponedStateSize(\n+        nextConfig.experimental.maxPostponedStateSize\n+      ),\n     },\n     reactMaxHeadersLength: nextConfig.reactMaxHeadersLength,\n     hasReadableErrorStacks:"
        },
        {
            "sha": "1a514b3dac17f4d512a97599c1c759ff0f46ba9a",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -385,7 +385,10 @@ export async function exportPages(\n       process.env.NODE_OPTIONS?.includes('--inspect')\n \n     const renderResumeDataCache = renderResumeDataCachesByPage[page]\n-      ? createRenderResumeDataCache(renderResumeDataCachesByPage[page])\n+      ? createRenderResumeDataCache(\n+          renderResumeDataCachesByPage[page],\n+          renderOpts.experimental.maxPostponedStateSizeBytes\n+        )\n       : undefined\n \n     while (attempt < maxAttempts) {"
        },
        {
            "sha": "dcb92c396871b46802938d52ccde2575675a46d1",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -2371,7 +2371,8 @@ export const renderToHTMLOrFlight: AppPageRender = (\n \n     postponedState = parsePostponedState(\n       renderOpts.postponed,\n-      interpolatedParams\n+      interpolatedParams,\n+      renderOpts.experimental.maxPostponedStateSizeBytes\n     )\n   } else {\n     interpolatedParams = interpolateParallelRouteParams("
        },
        {
            "sha": "3950c53215310935f89a50b48439c2d31d47434f",
            "filename": "packages/next/src/server/app-render/postponed-state.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.test.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -51,7 +51,7 @@ describe('getDynamicHTMLPostponedState', () => {\n       isCacheComponentsEnabled\n     )\n \n-    const parsed = parsePostponedState(state, { slug: '123' })\n+    const parsed = parsePostponedState(state, { slug: '123' }, undefined)\n \n     expect(parsed).toMatchInlineSnapshot(`\n      {\n@@ -109,7 +109,7 @@ describe('getDynamicHTMLPostponedState', () => {\n \n     const value = 'hello'\n     const params = { slug: value }\n-    const parsed = parsePostponedState(state, params)\n+    const parsed = parsePostponedState(state, params, undefined)\n     expect(parsed).toEqual({\n       type: DynamicState.HTML,\n       data: [1, { [value]: value }],\n@@ -137,7 +137,7 @@ describe('parsePostponedState', () => {\n     const params = {\n       slug: Math.random().toString(16).slice(3),\n     }\n-    const parsed = parsePostponedState(state, params)\n+    const parsed = parsePostponedState(state, params, undefined)\n \n     // Ensure that it parsed it correctly.\n     expect(parsed).toEqual({\n@@ -153,7 +153,7 @@ describe('parsePostponedState', () => {\n   it('parses a HTML postponed state without fallback params', () => {\n     const state = `2:{}null`\n     const params = {}\n-    const parsed = parsePostponedState(state, params)\n+    const parsed = parsePostponedState(state, params, undefined)\n \n     // Ensure that it parsed it correctly.\n     expect(parsed).toEqual({\n@@ -165,7 +165,7 @@ describe('parsePostponedState', () => {\n \n   it('parses a data postponed state', () => {\n     const state = '4:nullnull'\n-    const parsed = parsePostponedState(state, {})\n+    const parsed = parsePostponedState(state, {}, undefined)\n \n     // Ensure that it parsed it correctly.\n     expect(parsed).toEqual({"
        },
        {
            "sha": "ffec29a44975efd13402cee9060a463d84e4dc0f",
            "filename": "packages/next/src/server/app-render/postponed-state.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -116,7 +116,8 @@ export async function getDynamicDataPostponedState(\n \n export function parsePostponedState(\n   state: string,\n-  interpolatedParams: Params\n+  interpolatedParams: Params,\n+  maxPostponedStateSizeBytes: number | undefined\n ): PostponedState {\n   try {\n     const postponedStringLengthMatch = state.match(/^([0-9]*):/)?.[1]\n@@ -134,7 +135,10 @@ export function parsePostponedState(\n     )\n \n     const renderResumeDataCache = createRenderResumeDataCache(\n-      state.slice(postponedStringLengthMatch.length + postponedStringLength + 1)\n+      state.slice(\n+        postponedStringLengthMatch.length + postponedStringLength + 1\n+      ),\n+      maxPostponedStateSizeBytes\n     )\n \n     try {"
        },
        {
            "sha": "bdd9f1efaa1592bca1c51603079fbfc41dc42fdd",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -158,6 +158,12 @@ export interface RenderOptsPartial {\n     dynamicOnHover: boolean\n     inlineCss: boolean\n     authInterrupts: boolean\n+\n+    /**\n+     * The maximum size (in bytes) of the postponed state body for PPR resume\n+     * requests. Used to calculate decompression limits (5x this value).\n+     */\n+    maxPostponedStateSizeBytes: number | undefined\n   }\n   postponed?: string\n "
        },
        {
            "sha": "a58c1750ce3d8af8978607185f7f5300a59fda12",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -6,6 +6,10 @@ import type {\n import type { MiddlewareRouteMatch } from '../shared/lib/router/utils/middleware-route-matcher'\n import type { Params } from './request/params'\n import type { NextConfig, NextConfigRuntime } from './config-shared'\n+import {\n+  DEFAULT_MAX_POSTPONED_STATE_SIZE,\n+  parseMaxPostponedStateSize,\n+} from './config-shared'\n import type {\n   NextParsedUrlQuery,\n   NextUrlWithParsedQuery,\n@@ -563,6 +567,9 @@ export default abstract class Server<\n         authInterrupts: !!this.nextConfig.experimental.authInterrupts,\n         cdnCacheControlHeader:\n           this.nextConfig.experimental.cdnCacheControlHeader,\n+        maxPostponedStateSizeBytes: parseMaxPostponedStateSize(\n+          this.nextConfig.experimental.maxPostponedStateSize\n+        ),\n       },\n       onInstrumentationRequestError:\n         this.instrumentationOnRequestError.bind(this),\n@@ -1054,11 +1061,34 @@ export default abstract class Server<\n             req.headers[NEXT_RESUME_HEADER] === '1' &&\n             req.method === 'POST'\n           ) {\n+            // Get the configured max postponed state size.\n+            const maxPostponedStateSize =\n+              this.nextConfig.experimental.maxPostponedStateSize ??\n+              DEFAULT_MAX_POSTPONED_STATE_SIZE\n+            const maxPostponedStateSizeBytes = parseMaxPostponedStateSize(\n+              this.nextConfig.experimental.maxPostponedStateSize\n+            )\n+            if (maxPostponedStateSizeBytes === undefined) {\n+              throw new Error(\n+                'maxPostponedStateSize must be a valid number (bytes) or filesize format string (e.g., \"5mb\")'\n+              )\n+            }\n+\n             // Decode the postponed state from the request body, it will come as\n             // an array of buffers, so collect them and then concat them to form\n             // the string.\n             const body: Array<Buffer> = []\n+            let size = 0\n             for await (const chunk of req.body) {\n+              size += Buffer.byteLength(chunk)\n+              if (size > maxPostponedStateSizeBytes) {\n+                res.statusCode = 413\n+                const errorMessage =\n+                  `Postponed state exceeded ${maxPostponedStateSize} limit. ` +\n+                  `To configure the limit, see: https://nextjs.org/docs/app/api-reference/config/next-config-js/max-postponed-state-size`\n+                res.body(errorMessage).send()\n+                return\n+              }\n               body.push(chunk)\n             }\n             const postponed = Buffer.concat(body).toString('utf8')"
        },
        {
            "sha": "1e066bf047b16d21cc094ba0d99ad3b8b90cd640",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -206,6 +206,7 @@ export const experimentalSchema = {\n       allowedOrigins: z.array(z.string()).optional(),\n     })\n     .optional(),\n+  maxPostponedStateSize: zSizeLimit.optional(),\n   // The original type was Record<string, any>\n   extensionAlias: z.record(z.string(), z.any()).optional(),\n   externalDir: z.boolean().optional(),"
        },
        {
            "sha": "4a5bb64b585c835be62cb62f03df1a7d8c57724d",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -658,6 +658,14 @@ export interface ExperimentalConfig {\n     allowedOrigins?: string[]\n   }\n \n+  /**\n+   * Allows adjusting the maximum size of the postponed state body for PPR\n+   * resume requests. This includes the Resume Data Cache (RDC) which may grow\n+   * large for some applications.\n+   * @default '100 MB'\n+   */\n+  maxPostponedStateSize?: SizeLimit\n+\n   /**\n    * enables the minification of server code.\n    */\n@@ -1686,6 +1694,7 @@ export interface NextConfigRuntime {\n     | 'proxyTimeout'\n     | 'testProxy'\n     | 'runtimeServerDeploymentId'\n+    | 'maxPostponedStateSize'\n   > & {\n     // Pick on @internal fields generates invalid .d.ts files\n     /** @internal */\n@@ -1742,6 +1751,7 @@ export function getNextConfigRuntime(\n         proxyTimeout: ex.proxyTimeout,\n         testProxy: ex.testProxy,\n         runtimeServerDeploymentId: ex.runtimeServerDeploymentId,\n+        maxPostponedStateSize: ex.maxPostponedStateSize,\n \n         trustHostHeader: ex.trustHostHeader,\n         isExperimentalCompile: ex.isExperimentalCompile,\n@@ -1789,3 +1799,9 @@ export function getNextConfigRuntime(\n \n   return runtimeConfig\n }\n+\n+// Re-export from shared lib for backwards compatibility\n+export {\n+  DEFAULT_MAX_POSTPONED_STATE_SIZE,\n+  parseMaxPostponedStateSize,\n+} from '../shared/lib/size-limit'"
        },
        {
            "sha": "2856ed19306fb7d1ec68992864fa110ef9125f24",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -753,10 +753,18 @@ function assignDefaultsAndValidate(\n   if (\n     typeof result.experimental?.serverActions?.bodySizeLimit !== 'undefined'\n   ) {\n-    const value = parseInt(\n-      result.experimental.serverActions?.bodySizeLimit.toString()\n-    )\n-    if (isNaN(value) || value < 1) {\n+    const bytes =\n+      require('next/dist/compiled/bytes') as typeof import('next/dist/compiled/bytes')\n+    const bodySizeLimit = result.experimental.serverActions.bodySizeLimit\n+    let value: number | null\n+\n+    if (typeof bodySizeLimit === 'number') {\n+      value = bodySizeLimit\n+    } else {\n+      value = bytes.parse(bodySizeLimit)\n+    }\n+\n+    if (value === null || isNaN(value) || value < 1) {\n       throw new Error(\n         'Server Actions Size Limit must be a valid number or filesize format larger than 1MB: https://nextjs.org/docs/app/api-reference/next-config-js/serverActions#bodysizelimit'\n       )"
        },
        {
            "sha": "6a3848ad26a1d92132d76d75e553564de42da296",
            "filename": "packages/next/src/server/resume-data-cache/resume-data-cache.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.test.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -125,7 +125,7 @@ describe('stringifyResumeDataCache', () => {\n \n describe('parseResumeDataCache', () => {\n   it('parses an empty cache', () => {\n-    expect(createRenderResumeDataCache('null')).toEqual(\n+    expect(createRenderResumeDataCache('null', undefined)).toEqual(\n       createPrerenderResumeDataCache()\n     )\n   })\n@@ -137,7 +137,7 @@ describe('parseResumeDataCache', () => {\n       isCacheComponentsEnabled\n     )\n \n-    const parsed = createRenderResumeDataCache(serialized)\n+    const parsed = createRenderResumeDataCache(serialized, undefined)\n \n     expect(parsed.cache.size).toBe(isCacheComponentsEnabled ? 1 : 3)\n     expect(parsed.fetch.size).toBe(0)"
        },
        {
            "sha": "ed86bfeae184f619ce5158d22b6dd946e47fe43c",
            "filename": "packages/next/src/server/resume-data-cache/resume-data-cache.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 7,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -164,6 +164,7 @@ export function createPrerenderResumeDataCache(): PrerenderResumeDataCache {\n  * @param renderResumeDataCache - A RenderResumeDataCache instance to be used directly\n  * @param prerenderResumeDataCache - A PrerenderResumeDataCache instance to convert to immutable\n  * @param persistedCache - A serialized cache string to parse\n+ * @param maxPostponedStateSizeBytes - The max compressed size limit in bytes (used to calculate 5x decompression limit)\n  * @returns An immutable RenderResumeDataCache instance\n  */\n export function createRenderResumeDataCache(\n@@ -173,13 +174,15 @@ export function createRenderResumeDataCache(\n   prerenderResumeDataCache: PrerenderResumeDataCache\n ): RenderResumeDataCache\n export function createRenderResumeDataCache(\n-  persistedCache: string\n+  persistedCache: string,\n+  maxPostponedStateSizeBytes: number | undefined\n ): RenderResumeDataCache\n export function createRenderResumeDataCache(\n   resumeDataCacheOrPersistedCache:\n     | RenderResumeDataCache\n     | PrerenderResumeDataCache\n-    | string\n+    | string,\n+  maxPostponedStateSizeBytes?: number | undefined\n ): RenderResumeDataCache {\n   if (process.env.NEXT_RUNTIME === 'edge') {\n     throw new InvariantError(\n@@ -206,11 +209,32 @@ export function createRenderResumeDataCache(\n     // synchronous inflateSync function.\n     const { inflateSync } = require('node:zlib') as typeof import('node:zlib')\n \n-    const json: ResumeStoreSerialized = JSON.parse(\n-      inflateSync(\n-        Buffer.from(resumeDataCacheOrPersistedCache, 'base64')\n-      ).toString('utf-8')\n-    )\n+    // Limit decompressed size to prevent zipbomb attacks. This is 5x the\n+    // configured maxPostponedStateSize, allowing reasonable compression\n+    // ratios while preventing extreme decompression bombs.\n+    // Default is 500MB (5x the default 100MB compressed limit).\n+    const maxDecompressedSize = maxPostponedStateSizeBytes\n+      ? maxPostponedStateSizeBytes * 5\n+      : 500 * 1024 * 1024\n+\n+    let json: ResumeStoreSerialized\n+    try {\n+      json = JSON.parse(\n+        inflateSync(Buffer.from(resumeDataCacheOrPersistedCache, 'base64'), {\n+          maxOutputLength: maxDecompressedSize,\n+        }).toString('utf-8')\n+      )\n+    } catch (err: unknown) {\n+      if (\n+        err instanceof RangeError &&\n+        (err as NodeJS.ErrnoException).code === 'ERR_BUFFER_TOO_LARGE'\n+      ) {\n+        throw new Error(\n+          `Decompressed resume data cache exceeded ${maxDecompressedSize} byte limit`\n+        )\n+      }\n+      throw err\n+    }\n \n     return {\n       cache: parseUseCacheCacheStore(Object.entries(json.store.cache)),"
        },
        {
            "sha": "94b2f695824c2861949d6f54b73aeb400fc2d6fa",
            "filename": "packages/next/src/shared/lib/size-limit.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsize-limit.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsize-limit.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsize-limit.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -0,0 +1,22 @@\n+import type { SizeLimit } from '../../types'\n+\n+export const DEFAULT_MAX_POSTPONED_STATE_SIZE: SizeLimit = '100 MB'\n+\n+function parseSizeLimit(size: SizeLimit): number | undefined {\n+  const bytes = (\n+    require('next/dist/compiled/bytes') as typeof import('next/dist/compiled/bytes')\n+  ).parse(size)\n+  if (bytes === null || isNaN(bytes) || bytes < 1) {\n+    return undefined\n+  }\n+  return bytes\n+}\n+\n+/**\n+ * Parses the maxPostponedStateSize config value, using the default if not provided.\n+ */\n+export function parseMaxPostponedStateSize(\n+  size: SizeLimit | undefined\n+): number | undefined {\n+  return parseSizeLimit(size ?? DEFAULT_MAX_POSTPONED_STATE_SIZE)\n+}"
        },
        {
            "sha": "cd588684b11655ae4e4cf5b3a3e1a941ba4122ba",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/45dba91908a77e442b2e05389aeacf6ed95ceb0f/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45dba91908a77e442b2e05389aeacf6ed95ceb0f/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=45dba91908a77e442b2e05389aeacf6ed95ceb0f",
            "patch": "@@ -1429,6 +1429,7 @@ function extractResumeDataCacheFromPostponedState(\n   const postponedStringLength = parseInt(postponedStringLengthMatch)\n \n   return createRenderResumeDataCache(\n-    state.slice(postponedStringLengthMatch.length + postponedStringLength + 1)\n+    state.slice(postponedStringLengthMatch.length + postponedStringLength + 1),\n+    undefined\n   )\n }"
        }
    ],
    "stats": {
        "total": 178,
        "additions": 154,
        "deletions": 24
    }
}