{
    "author": "mischnic",
    "message": "Turbopack: fix duplicate externals modules (#81306)\n\nDon't attatch the resolve request's affecting sources to the external module itself. This list wasn't part of the module ident and would lead to duplicate modules.",
    "sha": "8b390602489f12d7ad597939fb8851ef357c7b7c",
    "files": [
        {
            "sha": "eb53636c7bbdd98f4d1f4ce21444cd735498cf98",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=8b390602489f12d7ad597939fb8851ef357c7b7c",
            "patch": "@@ -76,7 +76,6 @@ pub enum ModuleResolveResultItem {\n         /// uri, path, reference, etc.\n         name: RcStr,\n         ty: ExternalType,\n-        traced: Option<ResolvedVc<ModuleResolveResult>>,\n     },\n     /// A module could not be created (according to the rules, e.g. no module type as assigned)\n     Unknown(ResolvedVc<Box<dyn Source>>),\n@@ -727,11 +726,7 @@ impl ResolveResult {\n                                         // Should use map_primary_items instead\n                                         bail!(\"map_module doesn't handle traced externals\");\n                                     }\n-                                    ModuleResolveResultItem::External {\n-                                        name,\n-                                        ty,\n-                                        traced: None,\n-                                    }\n+                                    ModuleResolveResultItem::External { name, ty }\n                                 }\n                                 ResolveResultItem::Ignore => ModuleResolveResultItem::Ignore,\n                                 ResolveResultItem::Empty => ModuleResolveResultItem::Empty,"
        },
        {
            "sha": "9062226a6214947c1a774eda4652d59ecd9623e0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 67,
            "deletions": 10,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=8b390602489f12d7ad597939fb8851ef357c7b7c",
            "patch": "@@ -3,15 +3,21 @@ use std::{fmt::Display, io::Write};\n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n-use turbo_tasks_fs::{FileContent, FileSystem, VirtualFileSystem, glob::Glob, rope::RopeBuilder};\n+use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Vc, trace::TraceRawVcs};\n+use turbo_tasks_fs::{\n+    FileContent, FileSystem, FileSystemPath, VirtualFileSystem, glob::Glob, rope::RopeBuilder,\n+};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{AsyncModuleInfo, ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n+    context::AssetContext,\n     ident::{AssetIdent, Layer},\n     module::Module,\n     module_graph::ModuleGraph,\n-    reference::{ModuleReference, ModuleReferences},\n+    raw_module::RawModule,\n+    reference::{ModuleReference, ModuleReferences, TracedModuleReference},\n+    reference_type::ReferenceType,\n+    resolve::parse::Request,\n };\n \n use crate::{\n@@ -49,6 +55,19 @@ pub enum CachedExternalType {\n     Script,\n }\n \n+#[derive(\n+    Clone, Debug, Eq, PartialEq, Serialize, Deserialize, TraceRawVcs, TaskInput, Hash, NonLocalValue,\n+)]\n+/// Whether to add a traced reference to the external module using the given context and resolve\n+/// origin.\n+pub enum CachedExternalTracingMode {\n+    Untraced,\n+    Traced {\n+        externals_context: ResolvedVc<Box<dyn AssetContext>>,\n+        root_origin: FileSystemPath,\n+    },\n+}\n+\n impl Display for CachedExternalType {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n         match self {\n@@ -63,9 +82,9 @@ impl Display for CachedExternalType {\n \n #[turbo_tasks::value]\n pub struct CachedExternalModule {\n-    pub request: RcStr,\n-    pub external_type: CachedExternalType,\n-    pub additional_references: Vec<ResolvedVc<Box<dyn ModuleReference>>>,\n+    request: RcStr,\n+    external_type: CachedExternalType,\n+    tracing_mode: CachedExternalTracingMode,\n }\n \n #[turbo_tasks::value_impl]\n@@ -74,12 +93,12 @@ impl CachedExternalModule {\n     pub fn new(\n         request: RcStr,\n         external_type: CachedExternalType,\n-        additional_references: Vec<ResolvedVc<Box<dyn ModuleReference>>>,\n+        tracing_mode: CachedExternalTracingMode,\n     ) -> Vc<Self> {\n         Self::cell(CachedExternalModule {\n             request,\n             external_type,\n-            additional_references,\n+            tracing_mode,\n         })\n     }\n \n@@ -202,8 +221,46 @@ impl Module for CachedExternalModule {\n     }\n \n     #[turbo_tasks::function]\n-    fn references(&self) -> Result<Vc<ModuleReferences>> {\n-        Ok(Vc::cell(self.additional_references.clone()))\n+    async fn references(&self) -> Result<Vc<ModuleReferences>> {\n+        Ok(match &self.tracing_mode {\n+            CachedExternalTracingMode::Untraced => ModuleReferences::empty(),\n+            CachedExternalTracingMode::Traced {\n+                externals_context,\n+                root_origin,\n+            } => {\n+                let reference_type = match self.external_type {\n+                    CachedExternalType::EcmaScriptViaImport => {\n+                        ReferenceType::EcmaScriptModules(Default::default())\n+                    }\n+                    CachedExternalType::CommonJs | CachedExternalType::EcmaScriptViaRequire => {\n+                        ReferenceType::CommonJs(Default::default())\n+                    }\n+                    _ => ReferenceType::Undefined,\n+                };\n+\n+                let external_result = externals_context\n+                    .resolve_asset(\n+                        root_origin.clone(),\n+                        Request::parse_string(self.request.clone()),\n+                        externals_context\n+                            .resolve_options(root_origin.clone(), reference_type.clone()),\n+                        reference_type,\n+                    )\n+                    .await?;\n+                let references = external_result\n+                    .affecting_sources\n+                    .iter()\n+                    .map(|s| Vc::upcast::<Box<dyn Module>>(RawModule::new(**s)))\n+                    .chain(external_result.primary_modules_raw_iter().map(|rvc| *rvc))\n+                    .map(|s| {\n+                        Vc::upcast::<Box<dyn ModuleReference>>(TracedModuleReference::new(s))\n+                            .to_resolved()\n+                    })\n+                    .try_join()\n+                    .await?;\n+                Vc::cell(references)\n+            }\n+        })\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "0bc9ec57c510d516a82db83de20386175f45068b",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 81,
            "changes": 107,
            "blob_url": "https://github.com/vercel/next.js/blob/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8b390602489f12d7ad597939fb8851ef357c7b7c/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=8b390602489f12d7ad597939fb8851ef357c7b7c",
            "patch": "@@ -26,7 +26,7 @@ use graph::{AggregatedGraph, AggregatedGraphNodeContent, aggregate};\n use module_options::{ModuleOptions, ModuleOptionsContext, ModuleRuleEffect, ModuleType};\n use tracing::{Instrument, field::Empty};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{FxIndexSet, ResolvedVc, ValueToString, Vc};\n+use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::{FileSystemPath, glob::Glob};\n pub use turbopack_core::condition;\n use turbopack_core::{\n@@ -40,7 +40,6 @@ use turbopack_core::{\n     module::Module,\n     output::OutputAsset,\n     raw_module::RawModule,\n-    reference::{ModuleReference, TracedModuleReference},\n     reference_type::{\n         CssReferenceSubType, EcmaScriptModulesReferenceSubType, ImportContext, ImportWithType,\n         InnerAssets, ReferenceType,\n@@ -55,7 +54,9 @@ use turbopack_core::{\n pub use turbopack_css as css;\n pub use turbopack_ecmascript as ecmascript;\n use turbopack_ecmascript::{\n-    references::external_module::{CachedExternalModule, CachedExternalType},\n+    references::external_module::{\n+        CachedExternalModule, CachedExternalTracingMode, CachedExternalType,\n+    },\n     tree_shake::asset::EcmascriptModulePartAsset,\n };\n use turbopack_json::JsonModuleAsset;\n@@ -769,8 +770,6 @@ impl AssetContext for ModuleAssetContext {\n \n         let result = result.await?;\n \n-        let affecting_sources = &result.affecting_sources;\n-\n         let result = result\n             .map_primary_items(|item| {\n                 let reference_type = reference_type.clone();\n@@ -789,89 +788,35 @@ impl AssetContext for ModuleAssetContext {\n                         }\n                         ResolveResultItem::External { name, ty, traced } => {\n                             let replacement = if replace_externals {\n-                                let additional_refs: Vec<Vc<Box<dyn ModuleReference>>> = if let (\n-                                    ExternalTraced::Traced,\n-                                    Some(tracing_root),\n-                                ) = (\n-                                    traced,\n-                                    self.module_options_context()\n+                                let tracing_mode = if traced == ExternalTraced::Traced\n+                                    && let Some(tracing_root) = &self\n+                                        .module_options_context()\n                                         .await?\n                                         .enable_externals_tracing\n-                                        .clone(),\n-                                ) {\n-                                    let externals_context = externals_tracing_module_context(ty);\n-                                    let root_origin = tracing_root.join(\"_\")?;\n-\n-                                    // Normalize reference type, there is no such thing as a\n-                                    // `ReferenceType::EcmaScriptModules(ImportPart(Evaluation))`\n-                                    // for externals (and otherwise, this causes duplicate\n-                                    // CachedExternalModules for both `ImportPart(Evaluation)` and\n-                                    // `ImportPart(Export(\"CacheProvider\"))`)\n-                                    let reference_type = match reference_type {\n-                                        ReferenceType::EcmaScriptModules(_) => {\n-                                            ReferenceType::EcmaScriptModules(Default::default())\n-                                        }\n-                                        ReferenceType::CommonJs(_) => {\n-                                            ReferenceType::CommonJs(Default::default())\n-                                        }\n-                                        ReferenceType::Css(_) => {\n-                                            ReferenceType::Css(Default::default())\n-                                        }\n-                                        ReferenceType::Url(_) => {\n-                                            ReferenceType::Url(Default::default())\n-                                        }\n-                                        _ => ReferenceType::Undefined,\n-                                    };\n-\n-                                    let external_result = externals_context\n-                                        .resolve_asset(\n-                                            root_origin.clone(),\n-                                            Request::parse_string(name.clone()),\n-                                            externals_context.resolve_options(\n-                                                root_origin,\n-                                                reference_type.clone(),\n-                                            ),\n-                                            reference_type,\n-                                        )\n-                                        .await?;\n-\n-                                    let modules = affecting_sources\n-                                        .iter()\n-                                        .chain(external_result.affecting_sources.iter())\n-                                        .map(|s| Vc::upcast::<Box<dyn Module>>(RawModule::new(**s)))\n-                                        .chain(\n-                                            external_result\n-                                                .primary_modules_raw_iter()\n-                                                .map(|rvc| *rvc),\n-                                        )\n-                                        .collect::<FxIndexSet<_>>();\n-\n-                                    modules\n-                                        .into_iter()\n-                                        .map(|s| {\n-                                            Vc::upcast::<Box<dyn ModuleReference>>(\n-                                                TracedModuleReference::new(s),\n-                                            )\n-                                        })\n-                                        .collect()\n+                                {\n+                                    // result.affecting_sources can be ignored for tracing, as this\n+                                    // request will later be resolved relative to tracing_root\n+                                    // anyway.\n+\n+                                    CachedExternalTracingMode::Traced {\n+                                        externals_context: ResolvedVc::upcast(\n+                                            externals_tracing_module_context(ty)\n+                                                .to_resolved()\n+                                                .await?,\n+                                        ),\n+                                        root_origin: tracing_root.join(\"_\")?,\n+                                    }\n                                 } else {\n-                                    vec![]\n+                                    CachedExternalTracingMode::Untraced\n                                 };\n \n-                                replace_external(&name, ty, additional_refs, import_externals)\n-                                    .await?\n+                                replace_external(&name, ty, import_externals, tracing_mode).await?\n                             } else {\n                                 None\n                             };\n \n-                            replacement.unwrap_or_else(|| {\n-                                ModuleResolveResultItem::External {\n-                                    name,\n-                                    ty,\n-                                    // TODO(micshnic) remove that field entirely ?\n-                                    traced: None,\n-                                }\n-                            })\n+                            replacement\n+                                .unwrap_or_else(|| ModuleResolveResultItem::External { name, ty })\n                         }\n                         ResolveResultItem::Ignore => ModuleResolveResultItem::Ignore,\n                         ResolveResultItem::Empty => ModuleResolveResultItem::Empty,\n@@ -1000,8 +945,8 @@ pub async fn emit_asset_into_dir(\n pub async fn replace_external(\n     name: &RcStr,\n     ty: ExternalType,\n-    additional_refs: Vec<Vc<Box<dyn ModuleReference>>>,\n     import_externals: bool,\n+    tracing_mode: CachedExternalTracingMode,\n ) -> Result<Option<ModuleResolveResultItem>> {\n     let external_type = match ty {\n         ExternalType::CommonJs => CachedExternalType::CommonJs,\n@@ -1020,7 +965,7 @@ pub async fn replace_external(\n         }\n     };\n \n-    let module = CachedExternalModule::new(name.clone(), external_type, additional_refs)\n+    let module = CachedExternalModule::new(name.clone(), external_type, tracing_mode)\n         .to_resolved()\n         .await?;\n "
        }
    ],
    "stats": {
        "total": 191,
        "additions": 94,
        "deletions": 97
    }
}