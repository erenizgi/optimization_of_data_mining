{
    "author": "mischnic",
    "message": "Only allow node runtime in proxy (#85139)\n\nThis PR is the initiative of deprecating the edge runtime. Proxy will\ndefault to Node.js runtime, and will not allow runtime config. If the\nusers want to use the edge runtime, they should stay on the Middleware,\nthough we recommend starting the migration.\n\n---------\n\nCo-authored-by: devjiwonchoi <devjiwonchoi@gmail.com>\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "074262baf38e38f894ea1417d84e45d76f73e43c",
    "files": [
        {
            "sha": "cca56b629f96434fec5b384571c05e92881ad005",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -4322,7 +4322,6 @@ dependencies = [\n  \"next-custom-transforms\",\n  \"next-taskless\",\n  \"once_cell\",\n- \"pathdiff\",\n  \"percent-encoding\",\n  \"qstring\",\n  \"react_remove_properties\","
        },
        {
            "sha": "97b2a9438f6b433c0ee9f63b1f5459321d36ce3c",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -6,8 +6,7 @@ use next_core::{\n     middleware::get_middleware_module,\n     next_edge::entry::wrap_edge_entry,\n     next_manifests::{EdgeFunctionDefinition, MiddlewaresManifestV2, ProxyMatcher, Regions},\n-    parse_segment_config_from_source,\n-    segment_config::ParseSegmentMode,\n+    segment_config::NextSegmentConfig,\n     util::{MiddlewareMatcherKind, NextRuntime},\n };\n use tracing::Instrument;\n@@ -49,6 +48,8 @@ pub struct MiddlewareEndpoint {\n     source: ResolvedVc<Box<dyn Source>>,\n     app_dir: Option<FileSystemPath>,\n     ecmascript_client_reference_transition_name: Option<RcStr>,\n+    config: ResolvedVc<NextSegmentConfig>,\n+    runtime: NextRuntime,\n }\n \n #[turbo_tasks::value_impl]\n@@ -60,13 +61,17 @@ impl MiddlewareEndpoint {\n         source: ResolvedVc<Box<dyn Source>>,\n         app_dir: Option<FileSystemPath>,\n         ecmascript_client_reference_transition_name: Option<RcStr>,\n+        config: ResolvedVc<NextSegmentConfig>,\n+        runtime: NextRuntime,\n     ) -> Vc<Self> {\n         Self {\n             project,\n             asset_context,\n             source,\n             app_dir,\n             ecmascript_client_reference_transition_name,\n+            config,\n+            runtime,\n         }\n         .cell()\n     }\n@@ -81,20 +86,20 @@ impl MiddlewareEndpoint {\n             )\n             .module();\n \n+        let userland_path = userland_module.ident().path().await?;\n+        let is_proxy = userland_path.file_stem() == Some(\"proxy\");\n+\n         let module = get_middleware_module(\n             *self.asset_context,\n             self.project.project_path().owned().await?,\n             userland_module,\n+            is_proxy,\n         );\n \n-        let runtime = parse_segment_config_from_source(*self.source, ParseSegmentMode::Base)\n-            .await?\n-            .runtime\n-            .unwrap_or(NextRuntime::Edge);\n-\n-        if matches!(runtime, NextRuntime::NodeJs) {\n+        if matches!(self.runtime, NextRuntime::NodeJs) {\n             return Ok(module);\n         }\n+\n         Ok(wrap_edge_entry(\n             *self.asset_context,\n             self.project.project_path().owned().await?,\n@@ -152,10 +157,7 @@ impl MiddlewareEndpoint {\n     #[turbo_tasks::function]\n     async fn output_assets(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n-\n-        let config =\n-            parse_segment_config_from_source(*self.await?.source, ParseSegmentMode::Base).await?;\n-        let runtime = config.runtime.unwrap_or(NextRuntime::Edge);\n+        let config = this.config.await?;\n \n         let next_config = this.project.next_config();\n         let i18n = next_config.i18n().await?;\n@@ -223,7 +225,7 @@ impl MiddlewareEndpoint {\n             }]\n         };\n \n-        if matches!(runtime, NextRuntime::NodeJs) {\n+        if matches!(this.runtime, NextRuntime::NodeJs) {\n             let chunk = self.node_chunk().to_resolved().await?;\n             let mut output_assets = vec![chunk];\n             if this.project.next_mode().await?.is_production() {"
        },
        {
            "sha": "5258e947d6dde7e8f502f7884f2b85ddcc683f6d",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 23,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -1437,28 +1437,6 @@ impl Project {\n         )))\n     }\n \n-    #[turbo_tasks::function]\n-    async fn middleware_context(self: Vc<Self>) -> Result<Vc<Box<dyn AssetContext>>> {\n-        let edge_module_context = self.edge_middleware_context();\n-\n-        let middleware = self.find_middleware();\n-        let FindContextFileResult::Found(fs_path, _) = &*middleware.await? else {\n-            return Ok(edge_module_context);\n-        };\n-        let source = Vc::upcast(FileSource::new(fs_path.clone()));\n-\n-        let runtime = parse_segment_config_from_source(source, ParseSegmentMode::Base)\n-            .await?\n-            .runtime\n-            .unwrap_or(NextRuntime::Edge);\n-\n-        if matches!(runtime, NextRuntime::NodeJs) {\n-            Ok(self.node_middleware_context())\n-        } else {\n-            Ok(edge_module_context)\n-        }\n-    }\n-\n     #[turbo_tasks::function]\n     async fn find_middleware(self: Vc<Self>) -> Result<Vc<FindContextFileResult>> {\n         Ok(find_context_file(\n@@ -1483,14 +1461,34 @@ impl Project {\n             .as_ref()\n             .map(|_| AppProject::client_transition_name());\n \n-        let middleware_asset_context = self.middleware_context();\n+        let is_proxy = fs_path.file_stem() == Some(\"proxy\");\n+        let config = parse_segment_config_from_source(\n+            source,\n+            if is_proxy {\n+                ParseSegmentMode::Proxy\n+            } else {\n+                ParseSegmentMode::Base\n+            },\n+        );\n+        let runtime = config.await?.runtime.unwrap_or(if is_proxy {\n+            NextRuntime::NodeJs\n+        } else {\n+            NextRuntime::Edge\n+        });\n+\n+        let middleware_asset_context = match runtime {\n+            NextRuntime::NodeJs => self.node_middleware_context(),\n+            NextRuntime::Edge => self.edge_middleware_context(),\n+        };\n \n         Ok(Vc::upcast(MiddlewareEndpoint::new(\n             self,\n             middleware_asset_context,\n             source,\n             app_dir.clone(),\n             ecmascript_client_reference_transition_name,\n+            config,\n+            runtime,\n         )))\n     }\n "
        },
        {
            "sha": "51cd7c290caae8a3107203f5f1ab37c2db1aa85c",
            "filename": "crates/next-core/src/middleware.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -32,12 +32,12 @@ pub async fn get_middleware_module(\n     asset_context: Vc<Box<dyn AssetContext>>,\n     project_root: FileSystemPath,\n     userland_module: ResolvedVc<Box<dyn Module>>,\n+    is_proxy: bool,\n ) -> Result<Vc<Box<dyn Module>>> {\n     const INNER: &str = \"INNER_MIDDLEWARE_MODULE\";\n \n     // Determine if this is a proxy file by checking the module path\n     let userland_path = userland_module.ident().path().await?;\n-    let is_proxy = userland_path.file_stem() == Some(\"proxy\");\n     let (file_type, function_name, page_path) = if is_proxy {\n         (\"Proxy\", \"proxy\", \"/proxy\")\n     } else {\n@@ -91,11 +91,7 @@ pub async fn get_middleware_module(\n     let source = load_next_js_template(\n         \"middleware.js\",\n         project_root,\n-        &[\n-            (\"VAR_USERLAND\", INNER),\n-            (\"VAR_DEFINITION_PAGE\", page_path),\n-            (\"VAR_MODULE_RELATIVE_PATH\", userland_path.path.as_str()),\n-        ],\n+        &[(\"VAR_USERLAND\", INNER), (\"VAR_DEFINITION_PAGE\", page_path)],\n         &[],\n         &[],\n     )"
        },
        {
            "sha": "227012f894a165c5b07374d4f2b8662e773b66a0",
            "filename": "crates/next-core/src/segment_config.rs",
            "status": "modified",
            "additions": 31,
            "deletions": 15,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -289,6 +289,8 @@ pub enum ParseSegmentMode {\n     Base,\n     // Disallows \"use client + generateStatic\" and ignores/warns about `export const config`\n     App,\n+    // Disallows config = { runtime: \"edge\" }\n+    Proxy,\n }\n \n /// Parse the raw source code of a file to get the segment config local to that file.\n@@ -667,21 +669,35 @@ async fn parse_config_value(\n                             .await;\n                         };\n \n-                        config.runtime =\n-                            match serde_json::from_value(Value::String(val.to_string())) {\n-                                Ok(runtime) => Some(runtime),\n-                                Err(err) => {\n-                                    return invalid_config(\n-                                        source,\n-                                        \"config\",\n-                                        span,\n-                                        format!(\"`runtime` has an invalid value: {err}.\").into(),\n-                                        Some(value),\n-                                        IssueSeverity::Error,\n-                                    )\n-                                    .await;\n-                                }\n-                            };\n+                        let runtime = match serde_json::from_value(Value::String(val.to_string())) {\n+                            Ok(runtime) => Some(runtime),\n+                            Err(err) => {\n+                                return invalid_config(\n+                                    source,\n+                                    \"config\",\n+                                    span,\n+                                    format!(\"`runtime` has an invalid value: {err}.\").into(),\n+                                    Some(value),\n+                                    IssueSeverity::Error,\n+                                )\n+                                .await;\n+                            }\n+                        };\n+\n+                        if mode == ParseSegmentMode::Proxy && runtime == Some(NextRuntime::Edge) {\n+                            invalid_config(\n+                                source,\n+                                \"config\",\n+                                span,\n+                                rcstr!(\"Proxy does not support Edge runtime.\"),\n+                                Some(value),\n+                                IssueSeverity::Error,\n+                            )\n+                            .await?;\n+                            continue;\n+                        }\n+\n+                        config.runtime = runtime\n                     }\n                     \"matcher\" => {\n                         config.middleware_matcher ="
        },
        {
            "sha": "fe9759e8d65ee5b24be4dbf22a7e5f8ba19fd98a",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -901,5 +901,6 @@\n   \"900\": \"Both %s file \\\"./%s\\\" and %s file \\\"./%s\\\" are detected. Please use \\\"./%s\\\" only. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n   \"901\": \"Invalid \\\"cacheHandlers\\\" provided, expected an object e.g. { default: '/my-handler.js' }, received %s\",\n   \"902\": \"Invalid handler fields configured for \\\"cacheHandlers\\\":\\\\n%s\",\n-  \"903\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\\\\nThis function is what Next.js runs for every request handled by this %s.\\\\n\\\\nWhy this happens:\\\\n%s- The file exists but doesn't export a function.\\\\n- The export is not a function (e.g., an object or constant).\\\\n- There's a syntax error preventing the export from being recognized.\\\\n\\\\nTo fix it:\\\\n- Ensure this file has either a default or \\\"%s\\\" function export.\\\\n\\\\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\"\n+  \"903\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\\\\nThis function is what Next.js runs for every request handled by this %s.\\\\n\\\\nWhy this happens:\\\\n%s- The file exists but doesn't export a function.\\\\n- The export is not a function (e.g., an object or constant).\\\\n- There's a syntax error preventing the export from being recognized.\\\\n\\\\nTo fix it:\\\\n- Ensure this file has either a default or \\\"%s\\\" function export.\\\\n\\\\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n+  \"904\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\"\n }"
        },
        {
            "sha": "fe1fae37a44602352835a165c1536f897ec7c1fd",
            "filename": "packages/next/src/build/analysis/get-page-static-info.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 25,
            "changes": 90,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -40,6 +40,7 @@ import {\n } from '../segment-config/middleware/middleware-config'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { normalizePagePath } from '../../shared/lib/page-path/normalize-page-path'\n+import { isProxyFile } from '../utils'\n \n const PARSE_PATTERN =\n   /(?<!(_jsx|jsx-))runtime|preferredRegion|getStaticProps|getServerSideProps|generateStaticParams|export const|generateImageMetadata|generateSitemaps|middleware|proxy/\n@@ -305,16 +306,13 @@ function validateMiddlewareProxyExports({\n   ast,\n   page,\n   pageFilePath,\n+  isDev,\n }: {\n   ast: any\n   page: string\n   pageFilePath: string\n+  isDev: boolean\n }): void {\n-  // Only validate in build. In development, it will error at runtime.\n-  if (process.env.NODE_ENV !== 'production') {\n-    return\n-  }\n-\n   // Check if this is middleware/proxy\n   const isMiddleware =\n     page === `/${MIDDLEWARE_FILENAME}` || page === `/src/${MIDDLEWARE_FILENAME}`\n@@ -396,23 +394,33 @@ function validateMiddlewareProxyExports({\n     (isMiddleware && hasMiddlewareExport) ||\n     (isProxy && hasProxyExport)\n \n-  const relativeFilePath = `./${relative(process.cwd(), pageFilePath)}`\n+  const relativePath = relative(process.cwd(), pageFilePath)\n+  const resolvedPath = relativePath.startsWith('.')\n+    ? relativePath\n+    : `./${relativePath}`\n \n   if (!hasValidExport) {\n-    throw new Error(\n-      `The file \"${relativeFilePath}\" must export a function, either as a default export or as a named \"${fileName}\" export.\\n` +\n-        `This function is what Next.js runs for every request handled by this ${fileName === 'proxy' ? 'proxy (previously called middleware)' : 'middleware'}.\\n\\n` +\n-        `Why this happens:\\n` +\n-        (isProxy\n-          ? \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\\n\"\n-          : '') +\n-        `- The file exists but doesn't export a function.\\n` +\n-        `- The export is not a function (e.g., an object or constant).\\n` +\n-        `- There's a syntax error preventing the export from being recognized.\\n\\n` +\n-        `To fix it:\\n` +\n-        `- Ensure this file has either a default or \"${fileName}\" function export.\\n\\n` +\n-        `Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n-    )\n+    const message =\n+      `The file \"${resolvedPath}\" must export a function, either as a default export or as a named \"${fileName}\" export.\\n` +\n+      `This function is what Next.js runs for every request handled by this ${fileName === 'proxy' ? 'proxy (previously called middleware)' : 'middleware'}.\\n\\n` +\n+      `Why this happens:\\n` +\n+      (isProxy\n+        ? \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\\n\"\n+        : '') +\n+      `- The file exists but doesn't export a function.\\n` +\n+      `- The export is not a function (e.g., an object or constant).\\n` +\n+      `- There's a syntax error preventing the export from being recognized.\\n\\n` +\n+      `To fix it:\\n` +\n+      `- Ensure this file has either a default or \"${fileName}\" function export.\\n\\n` +\n+      `Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n+\n+    if (isDev) {\n+      // errorOnce as proxy/middleware runs per request including multiple\n+      // internal _next/ routes and spams logs.\n+      Log.errorOnce(message)\n+    } else {\n+      throw new Error(message)\n+    }\n   }\n }\n \n@@ -593,7 +601,7 @@ function warnAboutUnsupportedValue(\n type GetPageStaticInfoParams = {\n   pageFilePath: string\n   nextConfig: Partial<NextConfig>\n-  isDev?: boolean\n+  isDev: boolean\n   page: string\n   pageType: PAGE_TYPES\n }\n@@ -617,7 +625,12 @@ export async function getAppPageStaticInfo({\n   }\n \n   const ast = await parseModule(pageFilePath, content)\n-  validateMiddlewareProxyExports({ ast, page, pageFilePath })\n+  validateMiddlewareProxyExports({\n+    ast,\n+    page,\n+    pageFilePath,\n+    isDev,\n+  })\n \n   const {\n     generateStaticParams,\n@@ -713,7 +726,12 @@ export async function getPagesPageStaticInfo({\n   }\n \n   const ast = await parseModule(pageFilePath, content)\n-  validateMiddlewareProxyExports({ ast, page, pageFilePath })\n+  validateMiddlewareProxyExports({\n+    ast,\n+    page,\n+    pageFilePath,\n+    isDev,\n+  })\n \n   const { getServerSideProps, getStaticProps, exports } = checkExports(\n     ast,\n@@ -750,13 +768,35 @@ export async function getPagesPageStaticInfo({\n   const config = parsePagesSegmentConfig(exportedConfig, route)\n   const isAnAPIRoute = isAPIRoute(route)\n \n-  const resolvedRuntime = config.runtime ?? config.config?.runtime\n+  let resolvedRuntime = config.runtime ?? config.config?.runtime\n+\n+  if (isProxyFile(page) && resolvedRuntime) {\n+    const relativePath = relative(process.cwd(), pageFilePath)\n+    const resolvedPath = relativePath.startsWith('.')\n+      ? relativePath\n+      : `./${relativePath}`\n+    const message = `Route segment config is not allowed in Proxy file at \"${resolvedPath}\". Proxy always runs on Node.js runtime. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n+\n+    if (isDev) {\n+      // errorOnce as proxy/middleware runs per request including multiple\n+      // internal _next/ routes and spams logs.\n+      Log.errorOnce(message)\n+      resolvedRuntime = SERVER_RUNTIME.nodejs\n+    } else {\n+      throw new Error(message)\n+    }\n+  }\n \n   if (resolvedRuntime === SERVER_RUNTIME.experimentalEdge) {\n     warnAboutExperimentalEdge(isAnAPIRoute ? page! : null)\n   }\n \n-  if (resolvedRuntime === SERVER_RUNTIME.edge && page && !isAnAPIRoute) {\n+  if (\n+    !isProxyFile(page) &&\n+    resolvedRuntime === SERVER_RUNTIME.edge &&\n+    page &&\n+    !isAnAPIRoute\n+  ) {\n     const message = `Page ${page} provided runtime 'edge', the edge runtime for rendering is currently experimental. Use runtime 'experimental-edge' instead.`\n     if (isDev) {\n       Log.error(message)"
        },
        {
            "sha": "7f1f17f53784a1bb46958552d89b92b72e4fbb49",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 16,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -20,8 +20,6 @@ import {\n   APP_DIR_ALIAS,\n   WEBPACK_LAYERS,\n   INSTRUMENTATION_HOOK_FILENAME,\n-  PROXY_FILENAME,\n-  MIDDLEWARE_FILENAME,\n } from '../lib/constants'\n import { isAPIRoute } from '../lib/is-api-route'\n import { isEdgeRuntime } from '../lib/is-edge-runtime'\n@@ -43,6 +41,7 @@ import type { __ApiPreviewProps } from '../server/api-utils'\n import {\n   isMiddlewareFile,\n   isMiddlewareFilename,\n+  isProxyFile,\n   isInstrumentationHookFile,\n   isInstrumentationHookFilename,\n } from './utils'\n@@ -573,7 +572,7 @@ export interface CreateEntrypointsParams {\n   buildId: string\n   config: NextConfigComplete\n   envFiles: LoadedEnvFiles\n-  isDev?: boolean\n+  isDev: boolean\n   pages: MappedPages\n   pagesDir?: string\n   previewMode: __ApiPreviewProps\n@@ -642,6 +641,7 @@ export function getEdgeServerEntry(opts: {\n     return {\n       import: `next-middleware-loader?${stringify(loaderParams)}!`,\n       layer: WEBPACK_LAYERS.middleware,\n+      filename: opts.isDev ? 'middleware.js' : undefined,\n     }\n   }\n \n@@ -764,6 +764,11 @@ export function runDependingOnPageType<T>(params: {\n     return\n   }\n \n+  if (isProxyFile(params.page)) {\n+    params.onServer()\n+    return\n+  }\n+\n   if (isMiddlewareFile(params.page)) {\n     if (params.pageRuntime === 'nodejs') {\n       params.onServer()\n@@ -947,13 +952,7 @@ export async function createEntrypoints(\n                 isDev: false,\n               })\n           } else if (isMiddlewareFile(page)) {\n-            server[\n-              serverBundlePath\n-                // proxy.js still uses middleware.js for bundle path for now.\n-                // TODO: Revisit when we remove middleware.js.\n-                .replace(PROXY_FILENAME, MIDDLEWARE_FILENAME)\n-                .replace('src/', '')\n-            ] = getEdgeServerEntry({\n+            server[serverBundlePath.replace('src/', '')] = getEdgeServerEntry({\n               ...params,\n               rootDir,\n               absolutePagePath: absolutePagePath,\n@@ -1028,12 +1027,7 @@ export async function createEntrypoints(\n                   : undefined,\n               }).import\n             }\n-            const edgeServerBundlePath = isMiddlewareFile(page)\n-              ? serverBundlePath\n-                  .replace(PROXY_FILENAME, MIDDLEWARE_FILENAME)\n-                  .replace('src/', '')\n-              : serverBundlePath\n-            edgeServer[edgeServerBundlePath] = getEdgeServerEntry({\n+            edgeServer[serverBundlePath] = getEdgeServerEntry({\n               ...params,\n               rootDir,\n               absolutePagePath: absolutePagePath,"
        },
        {
            "sha": "260bccb115ff432df705e141d1cc2b5bee7b421d",
            "filename": "packages/next/src/build/get-static-info-including-layouts.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -29,7 +29,7 @@ export async function getStaticInfoIncludingLayouts({\n   pageFilePath: string\n   appDir: string | undefined\n   config: NextConfigComplete\n-  isDev: boolean | undefined\n+  isDev: boolean\n   page: string\n }): Promise<PageStaticInfo> {\n   // TODO: sync types for pages: PAGE_TYPES, ROUTER_TYPE, 'app' | 'pages', etc."
        },
        {
            "sha": "c9e6b1326473f82028af4aa75e33e6055530b4b2",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 13,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -139,6 +139,7 @@ import {\n   isAppBuiltinPage,\n   collectRoutesUsingEdgeRuntime,\n   collectMeta,\n+  isProxyFile,\n } from './utils'\n import type { PageInfo, PageInfos } from './utils'\n import type { FallbackRouteParam, PrerenderedRoute } from './static-paths/types'\n@@ -1214,13 +1215,7 @@ export default async function build(\n \n       for (const rootPath of rootPaths) {\n         const { name: fileBaseName, dir: fileDir } = path.parse(rootPath)\n-        const isAtConventionLevel =\n-          fileDir === '/' ||\n-          fileDir === '/src' ||\n-          // rootPaths are currently relative paths from the root directory.\n-          // Add safety check here for unexpected future changes.\n-          fileDir === dir ||\n-          fileDir === path.join(dir, 'src')\n+        const isAtConventionLevel = fileDir === '/' || fileDir === '/src'\n \n         if (isAtConventionLevel && fileBaseName === MIDDLEWARE_FILENAME) {\n           middlewareFilePath = rootPath\n@@ -2615,30 +2610,33 @@ export default async function build(\n           return serverFilesManifest\n         })\n \n-      const middlewareFile = rootPaths.find(\n-        (p) => p.includes(MIDDLEWARE_FILENAME) || p.includes(PROXY_FILENAME)\n-      )\n+      const middlewareFile = proxyFilePath || middlewareFilePath\n       let hasNodeMiddleware = false\n \n       if (middlewareFile) {\n+        // Is format of `(/src)/(proxy|middleware).<ext>`, so split by\n+        // \".\" and get the first part, regard rest of the extensions\n+        // to match the `page` value format.\n+        const page = middlewareFile.split('.')[0]\n+\n         const staticInfo = await getStaticInfoIncludingLayouts({\n           isInsideAppDir: false,\n           pageFilePath: path.join(dir, middlewareFile),\n           config,\n           appDir,\n           pageExtensions: config.pageExtensions,\n           isDev: false,\n-          page: 'middleware',\n+          page,\n         })\n \n         if (staticInfo.hadUnsupportedValue) {\n           errorFromUnsupportedSegmentConfig()\n         }\n \n-        if (staticInfo.runtime === 'nodejs') {\n+        if (staticInfo.runtime === 'nodejs' || isProxyFile(page)) {\n           hasNodeMiddleware = true\n           functionsConfigManifest.functions['/_middleware'] = {\n-            runtime: staticInfo.runtime,\n+            runtime: 'nodejs',\n             matchers: staticInfo.middleware?.matchers ?? [\n               {\n                 regexp: '^.*$',\n@@ -4154,6 +4152,17 @@ export default async function build(\n         buildTracesSpinner = undefined\n       }\n \n+      if (proxyFilePath && bundler !== Bundler.Turbopack) {\n+        await fs.rename(\n+          path.join(distDir, SERVER_DIRECTORY, 'proxy.js'),\n+          path.join(distDir, SERVER_DIRECTORY, 'middleware.js')\n+        )\n+        await fs.rename(\n+          path.join(distDir, SERVER_DIRECTORY, 'proxy.js.nft.json'),\n+          path.join(distDir, SERVER_DIRECTORY, 'middleware.js.nft.json')\n+        )\n+      }\n+\n       if (isCompileMode) {\n         Log.info(\n           `Build ran with \"compile\" mode, to finalize the build run either \"generate\" or \"generate-env\" mode as well`"
        },
        {
            "sha": "41ca0dc2543818410c9cc2629b310f98f38d465c",
            "filename": "packages/next/src/build/output/log.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Flog.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Flog.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Flog.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -85,3 +85,12 @@ export function warnOnce(...message: any[]) {\n     warn(...message)\n   }\n }\n+\n+const errorOnceCache = new LRUCache<string>(10_000, (value) => value.length)\n+export function errorOnce(...message: any[]) {\n+  const key = message.join(' ')\n+  if (!errorOnceCache.has(key)) {\n+    errorOnceCache.set(key, key)\n+    error(...message)\n+  }\n+}"
        },
        {
            "sha": "599b432b083e8536743a8f21c4f48dedb9f9e788",
            "filename": "packages/next/src/build/templates/middleware.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 23,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -11,33 +11,23 @@ import { isNextRouterError } from '../../client/components/is-next-router-error'\n \n const mod = { ..._mod }\n \n-const page = 'VAR_DEFINITION_PAGE'\n-// Turbopack does not add a `./` prefix to the relative file path, but Webpack does.\n-const relativeFilePath = 'VAR_MODULE_RELATIVE_PATH'\n-// @ts-expect-error `page` will be replaced during build\n+const page: string = 'VAR_DEFINITION_PAGE'\n const isProxy = page === '/proxy' || page === '/src/proxy'\n const handler = (isProxy ? mod.proxy : mod.middleware) || mod.default\n \n-if (typeof handler !== 'function') {\n-  const fileName = isProxy ? 'proxy' : 'middleware'\n-  // Webpack starts the path with \".\" as relative, but Turbopack does not.\n-  const resolvedRelativeFilePath = relativeFilePath.startsWith('.')\n-    ? relativeFilePath\n-    : `./${relativeFilePath}`\n+class ProxyMissingExportError extends Error {\n+  constructor(message: string) {\n+    super(message)\n+    // Stack isn't useful here, remove it considering it spams logs during development.\n+    this.stack = ''\n+  }\n+}\n \n-  throw new Error(\n-    `The file \"${resolvedRelativeFilePath}\" must export a function, either as a default export or as a named \"${fileName}\" export.\\n` +\n-      `This function is what Next.js runs for every request handled by this ${fileName === 'proxy' ? 'proxy (previously called middleware)' : 'middleware'}.\\n\\n` +\n-      `Why this happens:\\n` +\n-      (isProxy\n-        ? \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\\n\"\n-        : '') +\n-      `- The file exists but doesn't export a function.\\n` +\n-      `- The export is not a function (e.g., an object or constant).\\n` +\n-      `- There's a syntax error preventing the export from being recognized.\\n\\n` +\n-      `To fix it:\\n` +\n-      `- Ensure this file has either a default or \"${fileName}\" function export.\\n\\n` +\n-      `Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n+// TODO: This spams logs during development. Find a better way to handle this.\n+// Removing this will spam \"fn is not a function\" logs which is worse.\n+if (typeof handler !== 'function') {\n+  throw new ProxyMissingExportError(\n+    `The ${isProxy ? 'Proxy' : 'Middleware'} file \"${page}\" must export a function named \\`${isProxy ? 'proxy' : 'middleware'}\\` or a default function.`\n   )\n }\n "
        },
        {
            "sha": "01454bb2ffb6148f927b6ba21711ccb2277a8ab8",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -1421,6 +1421,10 @@ export function isMiddlewareFile(file: string) {\n   )\n }\n \n+export function isProxyFile(file: string) {\n+  return file === `/${PROXY_FILENAME}` || file === `/src/${PROXY_FILENAME}`\n+}\n+\n export function isInstrumentationHookFile(file: string) {\n   return (\n     file === `/${INSTRUMENTATION_HOOK_FILENAME}` ||"
        },
        {
            "sha": "9f2066f3a4c29dcce6855d61b243170b0bade753",
            "filename": "packages/next/src/build/webpack/loaders/next-middleware-loader.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -70,8 +70,5 @@ export default async function middlewareLoader(this: any) {\n   return await loadEntrypoint('middleware', {\n     VAR_USERLAND: pagePath,\n     VAR_DEFINITION_PAGE: page,\n-    // Turbopack sets `VAR_USERLAND` to `INNER_MIDDLEWARE_MODULE`, so use\n-    // `VAR_MODULE_RELATIVE_PATH` for error messages.\n-    VAR_MODULE_RELATIVE_PATH: pagePath,\n   })\n }"
        },
        {
            "sha": "d9c027e143cd4da18dcfecc02c17fc6addd97a73",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 13,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -89,6 +89,7 @@ import {\n   processIssues,\n   renderStyledStringToErrorAnsi,\n   type EntryIssuesMap,\n+  type IssuesMap,\n   type TopLevelIssuesMap,\n } from '../../shared/lib/turbopack/utils'\n import { getDevOverlayFontMiddleware } from '../../next-devtools/server/font/get-dev-overlay-font-middleware'\n@@ -1432,28 +1433,36 @@ export async function createHotReloaderTurbopack(\n         case 'end': {\n           sendEnqueuedMessages()\n \n+          function addToErrorsMap(\n+            errorsMap: Map<string, CompilationError>,\n+            issueMap: IssuesMap\n+          ) {\n+            for (const [key, issue] of issueMap) {\n+              if (issue.severity === 'warning') continue\n+              if (errorsMap.has(key)) continue\n+\n+              const message = formatIssue(issue)\n+\n+              errorsMap.set(key, {\n+                message,\n+                details: issue.detail\n+                  ? renderStyledStringToErrorAnsi(issue.detail)\n+                  : undefined,\n+              })\n+            }\n+          }\n+\n           function addErrors(\n             errorsMap: Map<string, CompilationError>,\n             issues: EntryIssuesMap\n           ) {\n             for (const issueMap of issues.values()) {\n-              for (const [key, issue] of issueMap) {\n-                if (issue.severity === 'warning') continue\n-                if (errorsMap.has(key)) continue\n-\n-                const message = formatIssue(issue)\n-\n-                errorsMap.set(key, {\n-                  message,\n-                  details: issue.detail\n-                    ? renderStyledStringToErrorAnsi(issue.detail)\n-                    : undefined,\n-                })\n-              }\n+              addToErrorsMap(errorsMap, issueMap)\n             }\n           }\n \n           const errors = new Map<string, CompilationError>()\n+          addToErrorsMap(errors, currentTopLevelIssues)\n           addErrors(errors, currentEntryIssues)\n \n           for (const client of ["
        },
        {
            "sha": "8616e7326612b86135608755583101398d14e538",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -1574,6 +1574,10 @@ export default class NextNodeServer extends BaseServer<\n           functionsConfig?.functions?.['/_middleware']\n         ) {\n           // if used with top level await, this will be a promise\n+          // Try loading middleware.js first, then proxy.js. Instead\n+          // of mapping proxy to middleware as the entry, just fallback\n+          // to proxy.\n+          // TODO: Remove this once we handle as the single entrypoint.\n           return require(\n             join(\n               /* turbopackIgnore: true */ this.distDir,\n@@ -1736,7 +1740,10 @@ export default class NextNodeServer extends BaseServer<\n \n       try {\n         result = await adapterFn({\n-          handler: middlewareModule.middleware || middlewareModule,\n+          handler:\n+            middlewareModule.proxy ||\n+            middlewareModule.middleware ||\n+            middlewareModule,\n           request: {\n             ...requestData,\n             body: hasRequestBody"
        },
        {
            "sha": "35c19a0f4e0e8cd811add72aa8c9596f63777f72",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -117,7 +117,9 @@ describe('app-dir with proxy', () => {\n       expect(res.headers.get('x-middleware-request-x-from-client3')).toBeNull()\n     })\n \n-    it(`Supports draft mode`, async () => {\n+    // Cannot set draftMode in nodejs runtime\n+    // TODO: Investigate https://github.com/vercel/next.js/pull/85174\n+    it.skip(`Supports draft mode`, async () => {\n       const res = await next.fetch(`${path}?draft=true`)\n       const headers: string = res.headers.get('set-cookie') || ''\n       const bypassCookie = headers"
        },
        {
            "sha": "58ab998be71863a7f9ca302eab9bb20a3d86e0ca",
            "filename": "test/e2e/app-dir/app-middleware-proxy/proxy.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -1,6 +1,6 @@\n import { NextResponse } from 'next/server'\n \n-import { headers as nextHeaders, draftMode } from 'next/headers'\n+import { headers as nextHeaders } from 'next/headers'\n \n /**\n  * @param {import('next/server').NextRequest} request\n@@ -20,9 +20,11 @@ export async function proxy(request) {\n     throw new Error('Expected headers from client to match')\n   }\n \n-  if (request.nextUrl.searchParams.get('draft')) {\n-    ;(await draftMode()).enable()\n-  }\n+  // Cannot set draftMode in nodejs runtime\n+  // TODO: Investigate https://github.com/vercel/next.js/pull/85174\n+  // if (request.nextUrl.searchParams.get('draft')) {\n+  //   ;(await draftMode()).enable()\n+  // }\n \n   const removeHeaders = request.nextUrl.searchParams.get('remove-headers')\n   if (removeHeaders) {"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Flayout.tsx?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fapp%2Fpage.tsx?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fnext.config.js?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "f68f7377ecb757e70914fe84e2c0f47af94414c7",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/proxy-runtime-nodejs.test.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy-runtime-nodejs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy-runtime-nodejs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy-runtime-nodejs.test.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,12 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('proxy-runtime-nodejs', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should use nodejs runtime for proxy by default', async () => {\n+    const browser = await next.browser('/foo')\n+    expect(await browser.elementByCss('p').text()).toBe('hello world')\n+  })\n+})"
        },
        {
            "sha": "dd49dfb801a3d8f10642e8205eabc59431aa72f9",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/proxy.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fproxy.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+// Will not work in edge runtime\n+import { join } from 'path/posix'\n+\n+export function proxy(request: NextRequest) {\n+  if (request.nextUrl.pathname === join('/', 'foo')) {\n+    return NextResponse.redirect(new URL('/', request.url))\n+  }\n+\n+  return NextResponse.next()\n+}"
        },
        {
            "sha": "7370610cce702d8f406de323f2706e039a0b3947",
            "filename": "test/e2e/app-dir/proxy-runtime-nodejs/redirect-path.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fredirect-path.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fredirect-path.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime-nodejs%2Fredirect-path.txt?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1 @@\n+/foo\n\\ No newline at end of file"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/proxy-runtime/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Flayout.tsx?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/proxy-runtime/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fapp%2Fpage.tsx?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/proxy-runtime/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fnext.config.js?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "ca90133c084337dd2258977d83abf7dcd035c8e5",
            "filename": "test/e2e/app-dir/proxy-runtime/proxy-runtime.test.ts",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy-runtime.test.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,46 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import stripAnsi from 'strip-ansi'\n+\n+describe('proxy-runtime', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should error when proxy file has runtime config export', async () => {\n+    let cliOutput: string\n+\n+    if (isNextDev) {\n+      await next.start().catch(() => {})\n+      // Use .catch() because Turbopack errors during compile and exits before runtime.\n+      await next.browser('/').catch(() => {})\n+      cliOutput = next.cliOutput\n+    } else {\n+      cliOutput = (await next.build()).cliOutput\n+    }\n+\n+    // TODO: Investigate why in dev-turbo, the error is shown in the browser console, not CLI output.\n+    if (process.env.IS_TURBOPACK_TEST && !isNextDev) {\n+      expect(stripAnsi(cliOutput)).toContain(`proxy.ts:3:14\n+Next.js can't recognize the exported \\`config\\` field in route. Proxy does not support Edge runtime.\n+  1 | export default function () {}\n+  2 |\n+> 3 | export const config = { runtime: 'edge' }\n+    |              ^^^^^^\n+  4 |\n+\n+The exported configuration object in a source file needs to have a very specific format from which some properties can be statically parsed at compiled-time.`)\n+    } else {\n+      expect(cliOutput).toContain(\n+        `Route segment config is not allowed in Proxy file at \"./proxy.ts\". Proxy always runs on Node.js runtime. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n+      )\n+    }\n+\n+    await next.stop()\n+  })\n+})"
        },
        {
            "sha": "586ed05ca9d43ac14cd3ba418b4aaf31c7eef692",
            "filename": "test/e2e/app-dir/proxy-runtime/proxy.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-runtime%2Fproxy.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -0,0 +1,3 @@\n+export default function () {}\n+\n+export const config = { runtime: 'edge' }"
        },
        {
            "sha": "fcdb0047720ba12c696f6611529d39b81907e533",
            "filename": "test/production/proxy-typescript/app/proxy.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fproduction%2Fproxy-typescript%2Fapp%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Fproduction%2Fproxy-typescript%2Fapp%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fproxy-typescript%2Fapp%2Fproxy.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -1,11 +1,6 @@\n-import { NextProxy, NextResponse, URLPattern, ProxyConfig } from 'next/server'\n+import { NextProxy, NextResponse, ProxyConfig } from 'next/server'\n \n export const proxy: NextProxy = function (request) {\n-  const pattern = new URLPattern({\n-    pathname: '/:path',\n-  })\n-  console.log(pattern.test(request.nextUrl.pathname))\n-\n   if (request.nextUrl.pathname === '/static') {\n     return new NextResponse(null, {\n       headers: {"
        },
        {
            "sha": "df004408407f3d3c031eaed9f0293c29b3e567ed",
            "filename": "test/unit/parse-page-static-info.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Funit%2Fparse-page-static-info.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/074262baf38e38f894ea1417d84e45d76f73e43c/test%2Funit%2Fparse-page-static-info.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fparse-page-static-info.test.ts?ref=074262baf38e38f894ea1417d84e45d76f73e43c",
            "patch": "@@ -16,6 +16,7 @@ describe('parse page static info', () => {\n         pageFilePath: join(fixtureDir, 'page-runtime/nodejs-ssr.js'),\n         nextConfig: createNextConfig(),\n         pageType: PAGE_TYPES.PAGES,\n+        isDev: false,\n       })\n     expect(runtime).toBe('nodejs')\n     expect(getServerSideProps).toBe(true)\n@@ -29,6 +30,7 @@ describe('parse page static info', () => {\n         pageFilePath: join(fixtureDir, 'page-runtime/nodejs.js'),\n         nextConfig: createNextConfig(),\n         pageType: PAGE_TYPES.PAGES,\n+        isDev: false,\n       })\n     expect(runtime).toBe('nodejs')\n     expect(getServerSideProps).toBe(false)\n@@ -41,6 +43,7 @@ describe('parse page static info', () => {\n       pageFilePath: join(fixtureDir, 'page-runtime/edge.js'),\n       nextConfig: createNextConfig(),\n       pageType: PAGE_TYPES.PAGES,\n+      isDev: false,\n     })\n     expect(runtime).toBe('experimental-edge')\n   })\n@@ -51,6 +54,7 @@ describe('parse page static info', () => {\n       pageFilePath: join(fixtureDir, 'page-runtime/static.js'),\n       nextConfig: createNextConfig(),\n       pageType: PAGE_TYPES.PAGES,\n+      isDev: false,\n     })\n     expect(runtime).toBe(undefined)\n   })\n@@ -62,6 +66,7 @@ describe('parse page static info', () => {\n         pageFilePath: join(fixtureDir, 'page-runtime/ssr-variable-gssp.js'),\n         nextConfig: createNextConfig(),\n         pageType: PAGE_TYPES.PAGES,\n+        isDev: false,\n       }\n     )\n     expect(getStaticProps).toBe(false)"
        }
    ],
    "stats": {
        "total": 512,
        "additions": 347,
        "deletions": 165
    }
}