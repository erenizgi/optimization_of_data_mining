{
    "author": "wyattjoh",
    "message": "fix(ppr): ensure fallback route params trigger dynamic resume (#81812)\n\n### What?\n\nThis PR fixes an issue where pages with fallback route params weren't\ntriggering dynamic resume behavior in PPR (Partial Pre-Rendering).\n\n### Why?\n\nWhen fallback route params exist, the RSC (React Server Components) data\nis inherently dynamic because the params are encoded into the flight\nrouter state. Without this fix, pages with fallback route params would\nincorrectly be treated as fully static, leading to incorrect behavior.\n\n### How?\n\n- Added a check in `app-render.tsx` to ensure that pages with fallback\nroute params (`workStore.fallbackRouteParams.size > 0`) always perform a\ndynamic resume after the static prerender\n- Refactored PPR tests to use deterministic sentinel markers (`<\\!--\nPPR_BOUNDARY_SENTINEL -->`) instead of time-based measurements for more\nreliable testing\n- Updated the test utilities to split responses based on the sentinel\nmarker rather than timing delays\n\nThis ensures that:\n1. Pages with fallback route params correctly trigger dynamic behavior\n2. PPR tests are more reliable and deterministic\n3. The boundary between static and dynamic content is clearly marked in\ntest mode\n\nFixes #",
    "sha": "5c7daf5aff50992d4653ed96becd3a7818af51fd",
    "files": [
        {
            "sha": "e04c13e0185f4c2392b6c99015b80e7a96d32de5",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 2,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1075,6 +1075,16 @@ export async function handler(\n       // should also be the case for a resume request because it's completed\n       // as a server render (rather than a static render).\n       if (!didPostpone || minimalMode) {\n+        // If we're in test mode, we should add a sentinel chunk to the response\n+        // that's between the static and dynamic parts so we can compare the\n+        // chunks and add assertions.\n+        if (process.env.__NEXT_TEST_MODE && minimalMode && isRoutePPREnabled) {\n+          // As we're in minimal mode, the static part would have already been\n+          // streamed first. The only part that this streams is the dynamic part\n+          // so we should FIRST stream the sentinel and THEN the dynamic part.\n+          body.unshift(createPPRBoundarySentinel())\n+        }\n+\n         return sendRenderResult({\n           req,\n           res,\n@@ -1093,7 +1103,7 @@ export async function handler(\n       if (isDebugStaticShell || isDebugDynamicAccesses) {\n         // Since we're not resuming the render, we need to at least add the\n         // closing body and html tags to create valid HTML.\n-        body.chain(\n+        body.push(\n           new ReadableStream({\n             start(controller) {\n               controller.enqueue(ENCODED_TAGS.CLOSED.BODY_AND_HTML)\n@@ -1113,11 +1123,18 @@ export async function handler(\n         })\n       }\n \n+      // If we're in test mode, we should add a sentinel chunk to the response\n+      // that's between the static and dynamic parts so we can compare the\n+      // chunks and add assertions.\n+      if (process.env.__NEXT_TEST_MODE) {\n+        body.push(createPPRBoundarySentinel())\n+      }\n+\n       // This request has postponed, so let's create a new transformer that the\n       // dynamic data can pipe to that will attach the dynamic data to the end\n       // of the response.\n       const transformer = new TransformStream<Uint8Array, Uint8Array>()\n-      body.chain(transformer.readable)\n+      body.push(transformer.readable)\n \n       // Perform the render again, but this time, provide the postponed state.\n       // We don't await because we want the result to start streaming now, and\n@@ -1208,3 +1225,20 @@ export async function handler(\n     throw err\n   }\n }\n+\n+// TODO: omit this from production builds, only test builds should include it\n+/**\n+ * Creates a readable stream that emits a PPR boundary sentinel.\n+ *\n+ * @returns A readable stream that emits a PPR boundary sentinel.\n+ */\n+function createPPRBoundarySentinel() {\n+  return new ReadableStream({\n+    start(controller) {\n+      controller.enqueue(\n+        new TextEncoder().encode('<!-- PPR_BOUNDARY_SENTINEL -->')\n+      )\n+      controller.close()\n+    },\n+  })\n+}"
        },
        {
            "sha": "cf1b8524075d82c58c8e918c38650caa7a43c233",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -3491,7 +3491,14 @@ async function prerenderToStream(\n         fallbackRouteParams\n       )\n \n-      if (serverIsDynamic) {\n+      // If there are fallback route params, the RSC data is inherently dynamic\n+      // today because it's encoded into the flight router state. Until we can\n+      // move the fallback route params out of the flight router state, we need\n+      // to always perform a dynamic resume after the static prerender.\n+      const hasFallbackRouteParams =\n+        workStore.fallbackRouteParams && workStore.fallbackRouteParams.size > 0\n+\n+      if (serverIsDynamic || hasFallbackRouteParams) {\n         // Dynamic case\n         // We will always need to perform a \"resume\" render of some kind when this route is accessed\n         // because the RSC data itself is dynamic. We determine if there are any HTML holes or not"
        },
        {
            "sha": "bd592d67651f35f181ad1b18b6e8203eecc24493",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -3586,7 +3586,7 @@ export default abstract class Server<\n       if (isDebugStaticShell || isDebugDynamicAccesses) {\n         // Since we're not resuming the render, we need to at least add the\n         // closing body and html tags to create valid HTML.\n-        body.chain(\n+        body.push(\n           new ReadableStream({\n             start(controller) {\n               controller.enqueue(ENCODED_TAGS.CLOSED.BODY_AND_HTML)\n@@ -3606,7 +3606,7 @@ export default abstract class Server<\n       // dynamic data can pipe to that will attach the dynamic data to the end\n       // of the response.\n       const transformer = new TransformStream<Uint8Array, Uint8Array>()\n-      body.chain(transformer.readable)\n+      body.push(transformer.readable)\n \n       // Perform the render again, but this time, provide the postponed state.\n       // We don't await because we want the result to start streaming now, and"
        },
        {
            "sha": "6ccde0abe0f2079ed34db9f6a283e3768cce4ac9",
            "filename": "packages/next/src/server/render-result.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 16,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -212,35 +212,57 @@ export default class RenderResult<\n   }\n \n   /**\n-   * Chains a new stream to the response. This will convert the response to an\n-   * array of streams if it is not already one and will add the new stream to\n-   * the end. When this response is piped, all of the streams will be piped\n-   * one after the other.\n+   * Coerces the response to an array of streams. This will convert the response\n+   * to an array of streams if it is not already one.\n    *\n-   * @param readable The new stream to chain\n+   * @returns An array of streams\n    */\n-  public chain(readable: ReadableStream<Uint8Array>) {\n+  private coerce(): ReadableStream<Uint8Array>[] {\n     if (this.response === null) {\n       throw new Error('Invariant: response is null. This is a bug in Next.js')\n     }\n \n-    // If the response is not an array of streams already, make it one.\n-    let responses: ReadableStream<Uint8Array>[]\n     if (typeof this.response === 'string') {\n-      responses = [streamFromString(this.response)]\n+      return [streamFromString(this.response)]\n     } else if (Array.isArray(this.response)) {\n-      responses = this.response\n+      return this.response\n     } else if (Buffer.isBuffer(this.response)) {\n-      responses = [streamFromBuffer(this.response)]\n+      return [streamFromBuffer(this.response)]\n     } else {\n-      responses = [this.response]\n+      return [this.response]\n     }\n+  }\n+\n+  /**\n+   * Unshifts a new stream to the response. This will convert the response to an\n+   * array of streams if it is not already one and will add the new stream to\n+   * the start of the array. When this response is piped, all of the streams\n+   * will be piped one after the other.\n+   *\n+   * @param readable The new stream to unshift\n+   */\n+  public unshift(readable: ReadableStream<Uint8Array>): void {\n+    // Coerce the response to an array of streams.\n+    this.response = this.coerce()\n \n-    // Add the new stream to the array.\n-    responses.push(readable)\n+    // Add the new stream to the start of the array.\n+    this.response.unshift(readable)\n+  }\n+\n+  /**\n+   * Chains a new stream to the response. This will convert the response to an\n+   * array of streams if it is not already one and will add the new stream to\n+   * the end. When this response is piped, all of the streams will be piped\n+   * one after the other.\n+   *\n+   * @param readable The new stream to chain\n+   */\n+  public push(readable: ReadableStream<Uint8Array>): void {\n+    // Coerce the response to an array of streams.\n+    this.response = this.coerce()\n \n-    // Update the response.\n-    this.response = responses\n+    // Add the new stream to the end of the array.\n+    this.response.push(readable)\n   }\n \n   /**"
        },
        {
            "sha": "4026bfc009d43972e6c2a57397f57772bd1591da",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/nested/params/[...slug]/page.jsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fparams%2F%5B...slug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fparams%2F%5B...slug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fparams%2F%5B...slug%5D%2Fpage.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,8 +1,8 @@\n-import { setTimeout } from 'timers/promises'\n+// import { setTimeout } from 'timers/promises'\n \n export default async function Page(props) {\n   const params = await props.params\n-  await setTimeout(1000)\n+  // await setTimeout(1000)\n \n   return <div data-slug={params.slug.join('/')}>{params.slug.join('/')}</div>\n }"
        },
        {
            "sha": "eafb9558d23a81449366ac4dae70f67288319735",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/nested/use-params/[...slug]/page.jsx",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-params%2F%5B...slug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-params%2F%5B...slug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-params%2F%5B...slug%5D%2Fpage.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,9 @@\n 'use client'\n \n import { useParams } from 'next/navigation'\n-import { use } from 'react'\n \n export default function Page() {\n   const params = useParams()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={params.slug.join('/')}>{params.slug.join('/')}</div>\n }"
        },
        {
            "sha": "a795abe0e97b20829110785ef9bc92d372e04a98",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/nested/use-pathname/[...slug]/page.jsx",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-pathname%2F%5B...slug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-pathname%2F%5B...slug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-pathname%2F%5B...slug%5D%2Fpage.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,9 @@\n 'use client'\n \n import { usePathname } from 'next/navigation'\n-import { use } from 'react'\n \n export default function Page() {\n   const pathname = usePathname()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={pathname}>{pathname}</div>\n }"
        },
        {
            "sha": "df90bb2e68daf6a28f0a34635eb9b30714f3dfd6",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/nested/use-selected-layout-segment/layout.jsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segment%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segment%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segment%2Flayout.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,10 @@\n 'use client'\n import { useSelectedLayoutSegment } from 'next/navigation'\n-import { Suspense, use } from 'react'\n+import { Suspense } from 'react'\n \n function Dynamic() {\n   const segment = useSelectedLayoutSegment()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={segment}>{segment}</div>\n }\n "
        },
        {
            "sha": "88799d1644b436d75a5c1fa9e27dc181e314422d",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/nested/use-selected-layout-segments/layout.jsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segments%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segments%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fnested%2Fuse-selected-layout-segments%2Flayout.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,10 @@\n 'use client'\n import { useSelectedLayoutSegments } from 'next/navigation'\n-import { Suspense, use } from 'react'\n+import { Suspense } from 'react'\n \n function Dynamic() {\n   const segments = useSelectedLayoutSegments()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={segments.join('/')}>{segments.join('/')}</div>\n }\n "
        },
        {
            "sha": "01adb1e1d5b1676d5fac4edea4907c8ea4e356cf",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/use-params/[slug]/page.jsx",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-params%2F%5Bslug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-params%2F%5Bslug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-params%2F%5Bslug%5D%2Fpage.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,9 @@\n 'use client'\n \n import { useParams } from 'next/navigation'\n-import { use } from 'react'\n \n export default function Page() {\n   const params = useParams()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={params.slug}>{params.slug}</div>\n }"
        },
        {
            "sha": "a795abe0e97b20829110785ef9bc92d372e04a98",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/use-pathname/[slug]/page.jsx",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-pathname%2F%5Bslug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-pathname%2F%5Bslug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-pathname%2F%5Bslug%5D%2Fpage.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,9 @@\n 'use client'\n \n import { usePathname } from 'next/navigation'\n-import { use } from 'react'\n \n export default function Page() {\n   const pathname = usePathname()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={pathname}>{pathname}</div>\n }"
        },
        {
            "sha": "df90bb2e68daf6a28f0a34635eb9b30714f3dfd6",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/use-selected-layout-segment/layout.jsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segment%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segment%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segment%2Flayout.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,10 @@\n 'use client'\n import { useSelectedLayoutSegment } from 'next/navigation'\n-import { Suspense, use } from 'react'\n+import { Suspense } from 'react'\n \n function Dynamic() {\n   const segment = useSelectedLayoutSegment()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={segment}>{segment}</div>\n }\n "
        },
        {
            "sha": "88799d1644b436d75a5c1fa9e27dc181e314422d",
            "filename": "test/e2e/app-dir/ppr-full/app/fallback/use-selected-layout-segments/layout.jsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segments%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segments%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fapp%2Ffallback%2Fuse-selected-layout-segments%2Flayout.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,12 +1,10 @@\n 'use client'\n import { useSelectedLayoutSegments } from 'next/navigation'\n-import { Suspense, use } from 'react'\n+import { Suspense } from 'react'\n \n function Dynamic() {\n   const segments = useSelectedLayoutSegments()\n \n-  use(new Promise((resolve) => setTimeout(resolve, 1000)))\n-\n   return <div data-slug={segments.join('/')}>{segments.join('/')}</div>\n }\n "
        },
        {
            "sha": "cd6c76ff0537109f58cab0eba93ed547bb9ecebe",
            "filename": "test/e2e/app-dir/ppr-full/components/dynamic.jsx",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fcomponents%2Fdynamic.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fcomponents%2Fdynamic.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fcomponents%2Fdynamic.jsx?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,4 +1,4 @@\n-import React, { use } from 'react'\n+import React from 'react'\n import * as next from 'next/headers'\n \n export const Dynamic = ({ pathname, fallback = null, params = null }) => {\n@@ -12,11 +12,6 @@ export const Dynamic = ({ pathname, fallback = null, params = null }) => {\n     messages.push({ name, value: headers.get(name) })\n   }\n \n-  const delay = headers.get('x-delay')\n-  if (delay) {\n-    use(new Promise((resolve) => setTimeout(resolve, parseInt(delay, 10))))\n-  }\n-\n   return (\n     <dl>\n       {pathname && ("
        },
        {
            "sha": "459548ea24586adaf10de65ec9c795073b9336c6",
            "filename": "test/e2e/app-dir/ppr-full/ppr-full.test.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 68,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup, isNextStart } from 'e2e-utils'\n-import { measurePPRTimings } from 'e2e-utils/ppr'\n+import { splitResponseWithPPRSentinel } from 'e2e-utils/ppr'\n import { links } from './components/links'\n import cheerio from 'cheerio'\n import { retry } from 'next-test-utils'\n@@ -179,40 +179,29 @@ describe('ppr-full', () => {\n \n         if (dynamic === true && !isNextDev && !isNextDeploy) {\n           it('should cache the static part', async () => {\n-            const delay = 500\n-\n             const dynamicValue = `${Date.now()}:${Math.random()}`\n \n-            const {\n-              timings: { streamFirstChunk, streamEnd, start },\n-              chunks,\n-            } = await measurePPRTimings(async () => {\n-              const res = await next.fetch(pathname, {\n-                headers: {\n-                  'X-Delay': delay.toString(),\n-                  'X-Test-Input': dynamicValue,\n-                },\n+            const [staticPart, dynamicPart] =\n+              await splitResponseWithPPRSentinel(async () => {\n+                const res = await next.fetch(pathname, {\n+                  headers: {\n+                    'X-Test-Input': dynamicValue,\n+                  },\n+                })\n+                expect(res.status).toBe(200)\n+\n+                return res.body\n               })\n-              expect(res.status).toBe(200)\n \n-              return res.body\n-            }, delay)\n-            if (emptyStaticPart) {\n-              expect(streamFirstChunk - start).toBeGreaterThanOrEqual(delay)\n-            } else {\n-              expect(streamFirstChunk - start).toBeLessThan(delay)\n-            }\n-            expect(streamEnd - start).toBeGreaterThanOrEqual(delay)\n+            // The dynamic part should contain the dynamic input.\n+            expect(dynamicPart).toContain(dynamicValue)\n \n             // The static part should not contain the dynamic input.\n-            expect(chunks.dynamic).toContain(dynamicValue)\n-\n-            // Ensure static part contains what we expect.\n             if (emptyStaticPart) {\n-              expect(chunks.static).toBe('')\n+              expect(staticPart).toBe('')\n             } else {\n-              expect(chunks.static).toContain('Dynamic Loading...')\n-              expect(chunks.static).not.toContain(dynamicValue)\n+              expect(staticPart).toContain('Dynamic Loading...')\n+              expect(staticPart).not.toContain(dynamicValue)\n             }\n           })\n         }\n@@ -315,25 +304,21 @@ describe('ppr-full', () => {\n         'for $pathname',\n         ({ pathname, slug, client }) => {\n           it('should render the fallback HTML immediately', async () => {\n-            const delay = 1000\n-\n-            const {\n-              timings: { streamFirstChunk, start, streamEnd },\n-              chunks,\n-            } = await measurePPRTimings(async () => {\n-              const res = await next.fetch(pathname)\n-              expect(res.status).toBe(200)\n+            const [staticPart, dynamicPart] =\n+              await splitResponseWithPPRSentinel(async () => {\n+                const res = await next.fetch(pathname)\n+                expect(res.status).toBe(200)\n \n-              return res.body\n-            }, delay)\n+                return res.body\n+              })\n \n-            // Expect that the first chunk should be emitted before the delay is\n-            // complete, implying that the fallback shell was sent immediately.\n-            expect(streamFirstChunk - start).toBeLessThan(delay)\n+            // Expect that there is a static part of the response, implying that\n+            // the fallback shell was sent immediately.\n+            expect(staticPart.length).toBeGreaterThan(0)\n \n-            // Expect that the last chunk should be emitted after the delay is\n-            // complete.\n-            expect(streamEnd - start).toBeGreaterThanOrEqual(delay)\n+            // Expect that there is a dynamic part of the response, implying that\n+            // the dynamic part was sent after the static part.\n+            expect(dynamicPart.length).toBeGreaterThan(0)\n \n             if (client) {\n               const browser = await next.browser(pathname)\n@@ -347,19 +332,19 @@ describe('ppr-full', () => {\n               }\n             } else {\n               // The static part should not contain the dynamic parameter.\n-              let $ = cheerio.load(chunks.static)\n+              let $ = cheerio.load(staticPart)\n               let data = $('[data-slug]').text()\n               expect(data).not.toContain(slug)\n               expect($('[data-slug]').closest('[hidden]').length).toBe(0)\n \n               // The dynamic part should contain the dynamic parameter.\n-              $ = cheerio.load(chunks.dynamic)\n+              $ = cheerio.load(dynamicPart)\n               data = $('[data-slug]').text()\n               expect(data).toContain(slug)\n               expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n \n               // The static part should contain the fallback shell.\n-              expect(chunks.static).toContain('data-fallback')\n+              expect(staticPart).toContain('data-fallback')\n             }\n           })\n         }\n@@ -477,18 +462,18 @@ describe('ppr-full', () => {\n   }\n \n   describe('Navigation Signals', () => {\n-    const delay = 500\n-\n     describe.each([\n       {\n         signal: 'notFound()' as const,\n+        statusCode: 404,\n         pathnames: ['/navigation/not-found', '/navigation/not-found/dynamic'],\n       },\n       {\n         signal: 'redirect()' as const,\n+        statusCode: 307,\n         pathnames: ['/navigation/redirect', '/navigation/redirect/dynamic'],\n       },\n-    ])('$signal', ({ signal, pathnames }) => {\n+    ])('$signal', ({ signal, statusCode, pathnames }) => {\n       describe.each(pathnames)('for %s', (pathname) => {\n         it('should have correct headers', async () => {\n           const res = await next.fetch(pathname, {\n@@ -525,27 +510,19 @@ describe('ppr-full', () => {\n \n         if (pathname.endsWith('/dynamic') && !isNextDeploy) {\n           it('should cache the static part', async () => {\n-            const {\n-              timings: { streamFirstChunk, streamEnd, start },\n-            } = await measurePPRTimings(async () => {\n-              const res = await next.fetch(pathname, {\n-                redirect: 'manual',\n-                headers: {\n-                  'X-Delay': delay.toString(),\n-                },\n-              })\n+            const [staticPart, dynamicPart] =\n+              await splitResponseWithPPRSentinel(async () => {\n+                const res = await next.fetch(pathname, {\n+                  redirect: 'manual',\n+                })\n \n-              return res.body\n-            }, delay)\n-            expect(streamFirstChunk - start).toBeLessThan(delay)\n+                expect(res.status).toBe(statusCode)\n \n-            if (isNextDev) {\n-              // This is because the signal should throw and interrupt the\n-              // delay timer.\n-              expect(streamEnd - start).toBeGreaterThanOrEqual(delay)\n-            } else {\n-              expect(streamEnd - start).toBeLessThan(delay)\n-            }\n+                return res.body\n+              })\n+\n+            expect(staticPart.length).toBeGreaterThan(0)\n+            expect(dynamicPart.length).toEqual(0)\n           })\n         }\n       })"
        },
        {
            "sha": "84bb6f598837334b060b6e549d8dee35d7a8021e",
            "filename": "test/lib/e2e-utils/ppr.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 49,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Flib%2Fe2e-utils%2Fppr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c7daf5aff50992d4653ed96becd3a7818af51fd/test%2Flib%2Fe2e-utils%2Fppr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Fppr.ts?ref=5c7daf5aff50992d4653ed96becd3a7818af51fd",
            "patch": "@@ -1,62 +1,42 @@\n-export async function measurePPRTimings(\n-  fn: () => Promise<NodeJS.ReadableStream>,\n-  delay: number\n-) {\n-  const start = Date.now()\n-\n-  // Create the stream so we can measure it.\n+/**\n+ * Measures and separates static and dynamic content in a response stream\n+ * by splitting on PPR boundary sentinel markers.\n+ *\n+ * This function is used in Partial Prerendering (PPR) tests to analyze the output\n+ * of Next.js pages and verify that static and dynamic content are properly separated.\n+ *\n+ * @param fn - A function that returns a Promise resolving to a readable stream\n+ *             containing HTML with PPR boundary markers\n+ * @returns An object containing the separated static and dynamic chunks\n+ *\n+ * @example\n+ * const [staticPart, dynamicPart] = await splitResponseWithPPRSentinel(async () => {\n+ *   return fetch('/some-ppr-page').then(res => res.body)\n+ * })\n+ * console.log(staticPart)  // Content before the boundary\n+ * console.log(dynamicPart) // Content after the boundary\n+ */\n+export async function splitResponseWithPPRSentinel(\n+  fn: () => Promise<NodeJS.ReadableStream>\n+): Promise<[staticPart: string, dynamicPart: string]> {\n   const stream = await fn()\n-\n-  let streamFirstChunk = 0\n-  let streamEnd = 0\n-\n-  const chunks: {\n-    chunk: string\n-    emittedAt: number\n-  }[] = []\n+  const chunks: string[] = []\n \n   await new Promise<void>((resolve, reject) => {\n     stream.on('data', (chunk: Buffer | string) => {\n-      if (!streamFirstChunk) {\n-        streamFirstChunk = Date.now()\n-      }\n-\n       if (typeof chunk !== 'string') {\n-        chunk = chunk.toString()\n+        chunk = chunk.toString('utf8')\n       }\n \n-      chunks.push({ chunk, emittedAt: Date.now() })\n-    })\n-\n-    stream.on('end', () => {\n-      streamEnd = Date.now()\n-      resolve()\n+      chunks.push(chunk)\n     })\n \n+    stream.on('end', resolve)\n     stream.on('error', reject)\n   })\n \n-  return {\n-    // Find all the chunks that arrived before the delay, and split\n-    // it into the static and dynamic parts.\n-    chunks: chunks.reduce<{\n-      static: string\n-      dynamic: string\n-    }>(\n-      (acc, { chunk, emittedAt }) => {\n-        if (emittedAt < start + delay) {\n-          acc.static += chunk\n-        } else {\n-          acc.dynamic += chunk\n-        }\n-        return acc\n-      },\n-      { static: '', dynamic: '' }\n-    ),\n-    timings: {\n-      start,\n-      streamFirstChunk,\n-      streamEnd,\n-    },\n-  }\n+  // Combine all chunks and split on the PPR boundary sentinel\n+  // The sentinel marks the boundary between static and dynamic content\n+  const parts = chunks.join('').split('<!-- PPR_BOUNDARY_SENTINEL -->', 2)\n+  return [parts[0] ?? '', parts[1] ?? '']\n }"
        }
    ],
    "stats": {
        "total": 335,
        "additions": 165,
        "deletions": 170
    }
}