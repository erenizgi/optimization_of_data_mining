{
    "author": "mischnic",
    "message": "Turbopack: NFT debugging (#83094)",
    "sha": "7aaf8ce50e2df076190e9c72384d82e14c41af6f",
    "files": [
        {
            "sha": "7421314d4aec307a0910282b6efeea0ed2d2a75f",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/node.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs?ref=7aaf8ce50e2df076190e9c72384d82e14c41af6f",
            "patch": "@@ -1,5 +1,6 @@\n use anyhow::Result;\n use either::Either;\n+use tracing::Instrument;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n@@ -156,7 +157,17 @@ impl ModuleReference for DirAssetReference {\n     #[turbo_tasks::function]\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n         let parent_path = self.source.ident().path().await?.parent();\n-        Ok(resolve_reference_from_dir(parent_path, *self.path))\n+        let span = tracing::info_span!(\n+            \"resolve DirAssetReference\",\n+            pattern = display(self.path.to_string().await?)\n+        );\n+        async {\n+            resolve_reference_from_dir(parent_path, *self.path)\n+                .resolve()\n+                .await\n+        }\n+        .instrument(span)\n+        .await\n     }\n }\n "
        },
        {
            "sha": "24342cad095d2c67c56c183ea73ca93ddfca6a3c",
            "filename": "turbopack/crates/turbopack-nft/src/main.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs?ref=7aaf8ce50e2df076190e9c72384d82e14c41af6f",
            "patch": "@@ -31,6 +31,9 @@ pub struct Arguments {\n \n     #[clap(long)]\n     pub show_issues: bool,\n+\n+    #[clap(long)]\n+    pub depth: Option<usize>,\n }\n \n #[global_allocator]\n@@ -95,6 +98,7 @@ async fn main_inner(args: Arguments) -> Result<()> {\n             args.entry.into(),\n             args.graph,\n             args.show_issues,\n+            args.depth,\n         )\n         .await?;\n         Ok(Default::default())"
        },
        {
            "sha": "d4fb27880b4c56596ff3948707c33ecf048b5b78",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7aaf8ce50e2df076190e9c72384d82e14c41af6f/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=7aaf8ce50e2df076190e9c72384d82e14c41af6f",
            "patch": "@@ -28,8 +28,9 @@ pub async fn node_file_trace(\n     input: RcStr,\n     graph: bool,\n     show_issues: bool,\n+    max_depth: Option<usize>,\n ) -> Result<()> {\n-    let op = node_file_trace_operation(project_root.clone(), input.clone(), graph);\n+    let op = node_file_trace_operation(project_root.clone(), input.clone(), graph, max_depth);\n     let result = op.resolve_strongly_consistent().await?;\n \n     if show_issues {\n@@ -58,6 +59,7 @@ async fn node_file_trace_operation(\n     project_root: RcStr,\n     input: RcStr,\n     graph: bool,\n+    max_depth: Option<usize>,\n ) -> Result<Vc<Vec<RcStr>>> {\n     let workspace_fs: Vc<Box<dyn FileSystem>> = Vc::upcast(DiskFileSystem::new(\n         rcstr!(\"workspace\"),\n@@ -98,7 +100,7 @@ async fn node_file_trace_operation(\n             ..Default::default()\n         }\n         .cell(),\n-        Layer::new(rcstr!(\"test\")),\n+        Layer::new(rcstr!(\"externals-tracing\")),\n     );\n     let module = module_asset_context\n         .process(Vc::upcast(source), ReferenceType::Undefined)\n@@ -107,7 +109,7 @@ async fn node_file_trace_operation(\n     let asset = TracedAsset::new(module).to_resolved().await?;\n \n     Ok(Vc::cell(if graph {\n-        to_graph(ResolvedVc::upcast(asset)).await?\n+        to_graph(ResolvedVc::upcast(asset), max_depth.unwrap_or(usize::MAX)).await?\n     } else {\n         to_list(ResolvedVc::upcast(asset)).await?\n     }))\n@@ -126,7 +128,7 @@ async fn to_list(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>>\n     Ok(assets)\n }\n \n-async fn to_graph(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>> {\n+async fn to_graph(asset: ResolvedVc<Box<dyn OutputAsset>>, max_depth: usize) -> Result<Vec<RcStr>> {\n     let mut visited = HashSet::new();\n     let mut queue = Vec::new();\n     queue.push((0, asset));\n@@ -139,8 +141,10 @@ async fn to_graph(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>>\n             indent.push_str(\"  \");\n         }\n         if visited.insert(asset) {\n-            for &asset in references.iter().rev() {\n-                queue.push((depth + 1, asset));\n+            if depth < max_depth {\n+                for &asset in references.iter().rev() {\n+                    queue.push((depth + 1, asset));\n+                }\n             }\n             result.push(format!(\"{}{}\", indent, asset.path().to_string().await?).into());\n         } else if references.is_empty() {\n@@ -149,5 +153,8 @@ async fn to_graph(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>>\n             result.push(format!(\"{}{} *...\", indent, asset.path().to_string().await?).into());\n         }\n     }\n+    result.push(\"\".into());\n+    result.push(\"*    : revisited and no references\".into());\n+    result.push(\"*... : revisited and references were already printed\".into());\n     Ok(result)\n }"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 29,
        "deletions": 7
    }
}