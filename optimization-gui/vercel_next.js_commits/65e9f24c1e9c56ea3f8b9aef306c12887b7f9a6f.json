{
    "author": "raunofreiberg",
    "message": "[dev-overlay] Make badge draggable (#78716)",
    "sha": "65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
    "files": [
        {
            "sha": "7303498a69c81a39c5869a8d6602852fd54b641d",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 41,
            "deletions": 23,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
            "patch": "@@ -1,5 +1,5 @@\n import type { CSSProperties, Dispatch, SetStateAction } from 'react'\n-import type { OverlayState } from '../../../../shared'\n+import { STORAGE_KEY_POSITION, type OverlayState } from '../../../../shared'\n \n import { useState, useEffect, useRef, createContext, useContext } from 'react'\n import { Toast } from '../../toast'\n@@ -21,6 +21,7 @@ import {\n   getInitialPosition,\n   type DevToolsScale,\n } from './dev-tools-info/preferences'\n+import { Draggable } from './draggable'\n \n // TODO: add E2E tests to cover different scenarios\n \n@@ -83,6 +84,8 @@ const OVERLAYS = {\n \n export type Overlays = (typeof OVERLAYS)[keyof typeof OVERLAYS]\n \n+const INDICATOR_PADDING = 20\n+\n function DevToolsPopover({\n   routerType,\n   disabled,\n@@ -258,31 +261,38 @@ function DevToolsPopover({\n           '--animate-out-timing-function': MENU_CURVE,\n           boxShadow: 'none',\n           zIndex: 2147483647,\n-          // Reset the toast component's default positions.\n-          bottom: 'initial',\n-          left: 'initial',\n-          [vertical]: '20px',\n-          [horizontal]: '20px',\n+          [vertical]: `${INDICATOR_PADDING}px`,\n+          [horizontal]: `${INDICATOR_PADDING}px`,\n         } as CSSProperties\n       }\n     >\n-      {/* Trigger */}\n-      <NextLogo\n-        ref={triggerRef}\n-        aria-haspopup=\"menu\"\n-        aria-expanded={isMenuOpen}\n-        aria-controls=\"nextjs-dev-tools-menu\"\n-        aria-label={`${isMenuOpen ? 'Close' : 'Open'} Next.js Dev Tools`}\n-        data-nextjs-dev-tools-button\n-        disabled={disabled}\n-        issueCount={issueCount}\n-        onTriggerClick={onTriggerClick}\n-        toggleErrorOverlay={toggleErrorOverlay}\n-        isDevBuilding={useIsDevBuilding()}\n-        isDevRendering={useIsDevRendering()}\n-        isBuildError={isBuildError}\n-        scale={scale}\n-      />\n+      <Draggable\n+        padding={INDICATOR_PADDING}\n+        onDragStart={() => setOpen(null)}\n+        position={position}\n+        setPosition={(p) => {\n+          localStorage.setItem(STORAGE_KEY_POSITION, p)\n+          setPosition(p)\n+        }}\n+      >\n+        {/* Trigger */}\n+        <NextLogo\n+          ref={triggerRef}\n+          aria-haspopup=\"menu\"\n+          aria-expanded={isMenuOpen}\n+          aria-controls=\"nextjs-dev-tools-menu\"\n+          aria-label={`${isMenuOpen ? 'Close' : 'Open'} Next.js Dev Tools`}\n+          data-nextjs-dev-tools-button\n+          disabled={disabled}\n+          issueCount={issueCount}\n+          onTriggerClick={onTriggerClick}\n+          toggleErrorOverlay={toggleErrorOverlay}\n+          isDevBuilding={useIsDevBuilding()}\n+          isDevRendering={useIsDevRendering()}\n+          isBuildError={isBuildError}\n+          scale={scale}\n+        />\n+      </Draggable>\n \n       {/* Route Info */}\n       <RouteInfo\n@@ -612,4 +622,12 @@ export const DEV_TOOLS_INDICATOR_STYLES = `\n       line-height: var(--size-16);\n     }\n   }\n+\n+  .dev-tools-grabbing {\n+    cursor: grabbing;\n+\n+    > * {\n+      pointer-events: none;\n+    }\n+  }\n `"
        },
        {
            "sha": "45b8289f0cfd8100a10892c54af00077cabd3b4c",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/draggable.tsx",
            "status": "added",
            "additions": 278,
            "deletions": 0,
            "changes": 278,
            "blob_url": "https://github.com/vercel/next.js/blob/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx?ref=65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
            "patch": "@@ -0,0 +1,278 @@\n+import { useRef } from 'react'\n+\n+interface Point {\n+  x: number\n+  y: number\n+}\n+\n+type Corners = 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'\n+\n+interface Corner {\n+  corner: Corners\n+  translation: Point\n+}\n+\n+export function Draggable({\n+  children,\n+  padding,\n+  position: currentCorner,\n+  setPosition: setCurrentCorner,\n+  onDragStart,\n+}: {\n+  children: React.ReactElement\n+  position: Corners\n+  padding: number\n+  setPosition: (position: Corners) => void\n+  onDragStart?: () => void\n+}) {\n+  const { ref, animate, ...drag } = useDrag({\n+    threshold: 5,\n+    onDragStart,\n+    onDragEnd,\n+    onAnimationEnd,\n+  })\n+\n+  function onDragEnd(translation: Point, velocity: Point) {\n+    const projectedPosition = {\n+      x: translation.x + project(velocity.x),\n+      y: translation.y + project(velocity.y),\n+    }\n+    const nearestCorner = getNearestCorner(projectedPosition)\n+    animate(nearestCorner)\n+  }\n+\n+  function onAnimationEnd({ corner }: Corner) {\n+    // Unset drag translation\n+    setTimeout(() => {\n+      ref.current?.style.removeProperty('translate')\n+      setCurrentCorner(corner)\n+    })\n+  }\n+\n+  function getNearestCorner({ x, y }: Point): Corner {\n+    const allCorners = getCorners()\n+    const distances = Object.entries(allCorners).map(([key, translation]) => {\n+      const distance = Math.sqrt(\n+        (x - translation.x) ** 2 + (y - translation.y) ** 2\n+      )\n+      return { key, distance }\n+    })\n+    const min = Math.min(...distances.map((d) => d.distance))\n+    const nearest = distances.find((d) => d.distance === min)\n+    if (!nearest) {\n+      // Safety fallback\n+      return { corner: currentCorner, translation: allCorners[currentCorner] }\n+    }\n+    return {\n+      translation: allCorners[nearest.key as Corners],\n+      corner: nearest.key as Corners,\n+    }\n+  }\n+\n+  function getCorners(): Record<Corners, Point> {\n+    const offset = padding * 2\n+    const triggerWidth = ref.current?.offsetWidth || 0\n+    const triggerHeight = ref.current?.offsetHeight || 0\n+\n+    function getAbsolutePosition(corner: Corners) {\n+      const isRight = corner.includes('right')\n+      const isBottom = corner.includes('bottom')\n+\n+      return {\n+        x: isRight ? window.innerWidth - offset - triggerWidth : 0,\n+        y: isBottom ? window.innerHeight - offset - triggerHeight : 0,\n+      }\n+    }\n+\n+    const basePosition = getAbsolutePosition(currentCorner)\n+\n+    // Calculate all corner positions relative to the current corner\n+    return {\n+      'top-left': {\n+        x: 0 - basePosition.x,\n+        y: 0 - basePosition.y,\n+      },\n+      'top-right': {\n+        x: window.innerWidth - offset - triggerWidth - basePosition.x,\n+        y: 0 - basePosition.y,\n+      },\n+      'bottom-left': {\n+        x: 0 - basePosition.x,\n+        y: window.innerHeight - offset - triggerHeight - basePosition.y,\n+      },\n+      'bottom-right': {\n+        x: window.innerWidth - offset - triggerWidth - basePosition.x,\n+        y: window.innerHeight - offset - triggerHeight - basePosition.y,\n+      },\n+    }\n+  }\n+\n+  return (\n+    <div ref={ref} {...drag} style={{ touchAction: 'none' }}>\n+      {children}\n+    </div>\n+  )\n+}\n+\n+interface UseDragOptions {\n+  onDragStart?: () => void\n+  onDrag?: (translation: Point) => void\n+  onDragEnd?: (translation: Point, velocity: Point) => void\n+  onAnimationEnd?: (corner: Corner) => void\n+  threshold: number // Minimum movement before drag starts\n+}\n+\n+interface Velocity {\n+  position: Point\n+  timestamp: number\n+}\n+\n+export function useDrag(options: UseDragOptions) {\n+  const ref = useRef<HTMLDivElement>(null)\n+  const state = useRef<'idle' | 'press' | 'drag' | 'drag-end'>('idle')\n+\n+  const origin = useRef<Point>({ x: 0, y: 0 })\n+  const translation = useRef<Point>({ x: 0, y: 0 })\n+  const lastTimestamp = useRef(0)\n+  const velocities = useRef<Velocity[]>([])\n+\n+  function set(position: Point) {\n+    if (ref.current) {\n+      translation.current = position\n+      ref.current.style.translate = `${position.x}px ${position.y}px`\n+    }\n+  }\n+\n+  function animate(corner: Corner) {\n+    const el = ref.current\n+    if (el === null) return\n+\n+    function listener(e: TransitionEvent) {\n+      if (e.propertyName === 'translate') {\n+        options.onAnimationEnd?.(corner)\n+        translation.current = { x: 0, y: 0 }\n+        el!.style.transition = ''\n+        el!.removeEventListener('transitionend', listener)\n+      }\n+    }\n+\n+    // Generated from https://www.easing.dev/spring\n+    el.style.transition = 'translate 491.22ms var(--timing-bounce)'\n+    el.addEventListener('transitionend', listener)\n+    set(corner.translation)\n+  }\n+\n+  function onClick(e: MouseEvent) {\n+    if (state.current === 'drag-end') {\n+      e.preventDefault()\n+      e.stopPropagation()\n+      state.current = 'idle'\n+      ref.current?.removeEventListener('click', onClick)\n+    }\n+  }\n+\n+  function onPointerDown(e: React.PointerEvent) {\n+    origin.current = { x: e.clientX, y: e.clientY }\n+    state.current = 'press'\n+    window.addEventListener('pointermove', onPointerMove)\n+    window.addEventListener('pointerup', onPointerUp)\n+    ref.current?.addEventListener('click', onClick)\n+  }\n+\n+  function onPointerMove(e: PointerEvent) {\n+    if (state.current === 'press') {\n+      const dx = e.clientX - origin.current.x\n+      const dy = e.clientY - origin.current.y\n+      const distance = Math.sqrt(dx * dx + dy * dy)\n+\n+      if (distance >= options.threshold) {\n+        state.current = 'drag'\n+        ref.current?.setPointerCapture(e.pointerId)\n+        ref.current?.classList.add('dev-tools-grabbing')\n+        options.onDragStart?.()\n+      }\n+    }\n+\n+    if (state.current !== 'drag') return\n+\n+    const currentPosition = { x: e.clientX, y: e.clientY }\n+\n+    const dx = currentPosition.x - origin.current.x\n+    const dy = currentPosition.y - origin.current.y\n+    origin.current = currentPosition\n+\n+    const newTranslation = {\n+      x: translation.current.x + dx,\n+      y: translation.current.y + dy,\n+    }\n+\n+    set(newTranslation)\n+\n+    // Keep a history of recent positions for velocity calculation\n+    // Only store points that are at least 10ms apart to avoid too many samples\n+    const now = Date.now()\n+    const shouldAddToHistory = now - lastTimestamp.current >= 10\n+    if (shouldAddToHistory) {\n+      velocities.current = [\n+        ...velocities.current.slice(-5),\n+        { position: currentPosition, timestamp: now },\n+      ]\n+    }\n+\n+    lastTimestamp.current = now\n+    options.onDrag?.(translation.current)\n+  }\n+\n+  function onPointerUp(e: PointerEvent) {\n+    state.current = state.current === 'drag' ? 'drag-end' : 'idle'\n+\n+    window.removeEventListener('pointermove', onPointerMove)\n+    window.removeEventListener('pointerup', onPointerUp)\n+\n+    const velocity = calculateVelocity(velocities.current)\n+    velocities.current = []\n+\n+    ref.current?.classList.remove('dev-tools-grabbing')\n+    ref.current?.releasePointerCapture(e.pointerId)\n+    options.onDragEnd?.(translation.current, velocity)\n+  }\n+\n+  return {\n+    ref,\n+    onPointerDown,\n+    animate,\n+  }\n+}\n+\n+function calculateVelocity(\n+  history: Array<{ position: Point; timestamp: number }>\n+): Point {\n+  if (history.length < 2) {\n+    return { x: 0, y: 0 }\n+  }\n+\n+  const oldestPoint = history[0]\n+  const latestPoint = history[history.length - 1]\n+\n+  const timeDelta = latestPoint.timestamp - oldestPoint.timestamp\n+\n+  if (timeDelta === 0) {\n+    return { x: 0, y: 0 }\n+  }\n+\n+  // Calculate pixels per millisecond\n+  const velocityX =\n+    (latestPoint.position.x - oldestPoint.position.x) / timeDelta\n+  const velocityY =\n+    (latestPoint.position.y - oldestPoint.position.y) / timeDelta\n+\n+  // Convert to pixels per second for more intuitive values\n+  return {\n+    x: velocityX * 1000,\n+    y: velocityY * 1000,\n+  }\n+}\n+\n+function project(initialVelocity: number, decelerationRate = 0.999) {\n+  return ((initialVelocity / 1000) * decelerationRate) / (1 - decelerationRate)\n+}"
        },
        {
            "sha": "b886214a012fb4dc82ac189da1e7aa28e7bd8183",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/fader/index.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ffader%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ffader%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ffader%2Findex.tsx?ref=65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
            "patch": "@@ -56,5 +56,4 @@ export const FADER_STYLES = `\n       mask-image: linear-gradient(to bottom, var(--color-bg) var(--stop), transparent);\n     }\n   }\n-\n `"
        },
        {
            "sha": "c43dd9159a60af860f2e23f06b45134f5b8c0d2b",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/toast/styles.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ftoast%2Fstyles.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ftoast%2Fstyles.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ftoast%2Fstyles.ts?ref=65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
            "patch": "@@ -1,21 +1,12 @@\n const styles = `\n   .nextjs-toast {\n     position: fixed;\n-    bottom: 16px;\n-    left: 16px;\n     max-width: 420px;\n     z-index: 9000;\n     box-shadow: 0px 16px 32px\n       rgba(0, 0, 0, 0.25);\n   }\n \n-  @media (max-width: 440px) {\n-    .nextjs-toast {\n-      max-width: 90vw;\n-      left: 5vw;\n-    }\n-  }\n-\n   .nextjs-toast-errors-parent {\n     padding: 16px;\n     border-radius: var(--rounded-4xl);"
        },
        {
            "sha": "2e0356e73191bf0d6121ebe8837fd2fc908faaf5",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/styles/base.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fbase.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fbase.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fbase.tsx?ref=65e9f24c1e9c56ea3f8b9aef306c12887b7f9a6f",
            "patch": "@@ -59,6 +59,8 @@ export function Base({ scale = 1 }: { scale?: DevToolsScale }) {\n \n           --timing-swift: cubic-bezier(0.23, 0.88, 0.26, 0.92);\n           --timing-overlay: cubic-bezier(0.175, 0.885, 0.32, 1.1);\n+          /* prettier-ignore */\n+          --timing-bounce: linear(0 0%, 0.005871 1%, 0.022058 2%, 0.046612 3%, 0.077823 4%, 0.114199 5%, 0.154441 6%, 0.197431 7.000000000000001%, 0.242208 8%, 0.287959 9%, 0.333995 10%, 0.379743 11%, 0.424732 12%, 0.46858 13%, 0.510982 14.000000000000002%, 0.551702 15%, 0.590564 16%, 0.627445 17%, 0.662261 18%, 0.694971 19%, 0.725561 20%, 0.754047 21%, 0.780462 22%, 0.804861 23%, 0.82731 24%, 0.847888 25%, 0.866679 26%, 0.883775 27%, 0.899272 28.000000000000004%, 0.913267 28.999999999999996%, 0.925856 30%, 0.937137 31%, 0.947205 32%, 0.956153 33%, 0.96407 34%, 0.971043 35%, 0.977153 36%, 0.982479 37%, 0.987094 38%, 0.991066 39%, 0.994462 40%, 0.997339 41%, 0.999755 42%, 1.001761 43%, 1.003404 44%, 1.004727 45%, 1.00577 46%, 1.006569 47%, 1.007157 48%, 1.007563 49%, 1.007813 50%, 1.007931 51%, 1.007939 52%, 1.007855 53%, 1.007697 54%, 1.007477 55.00000000000001%, 1.00721 56.00000000000001%, 1.006907 56.99999999999999%, 1.006576 57.99999999999999%, 1.006228 59%, 1.005868 60%, 1.005503 61%, 1.005137 62%, 1.004776 63%, 1.004422 64%, 1.004078 65%, 1.003746 66%, 1.003429 67%, 1.003127 68%, 1.00284 69%, 1.002571 70%, 1.002318 71%, 1.002082 72%, 1.001863 73%, 1.00166 74%, 1.001473 75%, 1.001301 76%, 1.001143 77%, 1.001 78%, 1.000869 79%, 1.000752 80%, 1.000645 81%, 1.00055 82%, 1.000464 83%, 1.000388 84%, 1.000321 85%, 1.000261 86%, 1.000209 87%, 1.000163 88%, 1.000123 89%, 1.000088 90%);\n \n           --rounded-none: 0px;\n           --rounded-sm: 2px;"
        }
    ],
    "stats": {
        "total": 354,
        "additions": 321,
        "deletions": 33
    }
}