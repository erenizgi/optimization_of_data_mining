{
    "author": "unstubbable",
    "message": "Improve error message for sync server functions (#81705)\n\nWhen a server action or `'use cache'` function is defined as a\nsynchronous function, the error message now only marks the function name\nfor better clarity. Previously, the entire function body was marked,\nwhich looks fine in small test fixtures, but is pretty messy for larger\nfunctions, both in the terminal as well as in the dev error overlay.\n\nFor anonymous default exports we can't optimize this and are still\nmarking the entire function body, as we don't have a name to refer to.\n\ncloses NAR-165",
    "sha": "08209b9bf46a05d625292b9c0d7150dd61a8c483",
    "files": [
        {
            "sha": "2f89e0f7f08321173f323bc0ef8f1117fe18f84a",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -998,9 +998,14 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n         }\n \n         if let Some(directive) = directive {\n+            let fn_name = self\n+                .fn_decl_ident\n+                .clone()\n+                .or(self.arrow_or_fn_expr_ident.clone());\n+\n             if !f.is_async {\n                 emit_error(ServerActionsErrorKind::InlineSyncFunction {\n-                    span: f.span,\n+                    span: fn_name.as_ref().map_or(f.span, |ident| ident.span),\n                     directive,\n                 });\n \n@@ -1066,9 +1071,7 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                 let new_expr = self.maybe_hoist_and_create_proxy_for_server_action_function(\n                     child_names,\n                     f,\n-                    self.fn_decl_ident\n-                        .clone()\n-                        .or(self.arrow_or_fn_expr_ident.clone()),\n+                    fn_name,\n                 );\n \n                 if self.in_default_export_decl {\n@@ -1170,7 +1173,10 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n         if let Some(directive) = directive {\n             if !a.is_async {\n                 emit_error(ServerActionsErrorKind::InlineSyncFunction {\n-                    span: a.span,\n+                    span: self\n+                        .arrow_or_fn_expr_ident\n+                        .as_ref()\n+                        .map_or(a.span, |ident| ident.span),\n                     directive,\n                 });\n "
        },
        {
            "sha": "1f5cc998b8d277c50d174e7250130f79256a52d3",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/1/output.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F1%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F1%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F1%2Foutput.stderr?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -3,5 +3,5 @@\n    ,-[input.js:3:1]\n  2 | \n  3 | export function foo() {}\n-   :        ^^^^^^^^^^^^^^^^^\n+   :                 ^^^\n    `----"
        },
        {
            "sha": "aa159213afeac2a06f5d7a0d5d2928a8f2e1c6e9",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/14/output.stderr",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F14%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F14%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F14%2Foutput.stderr?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -11,15 +11,15 @@\n    ,-[input.js:4:1]\n  3 | export default function () {}\n  4 | export function foo() {}\n-   :        ^^^^^^^^^^^^^^^^^\n+   :                 ^^^\n  5 | export const bar = () => {}\n    `----\n   x \"use cache\" functions must be async functions.\n   | \n    ,-[input.js:5:1]\n  4 | export function foo() {}\n  5 | export const bar = () => {}\n-   :                    ^^^^^^^^\n+   :              ^^^\n  6 | export const baz = 42\n    `----\n   x Only async functions are allowed to be exported in a \"use cache\" file."
        },
        {
            "sha": "3312ecc4a89c073dc43562698386406a01ee69cb",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/15/input.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Finput.js?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -1,4 +1,4 @@\n-export default function () {\n+export default function Default() {\n   'use cache'\n }\n "
        },
        {
            "sha": "429945f434ae8505fa3d575b37f47aea18c59979",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/15/output.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.js?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -1,3 +1,3 @@\n-export default function() {}\n+export default function Default() {}\n export function foo() {}\n export const bar = ()=>{};"
        },
        {
            "sha": "ec56bae97b228b464cb73523c230455d76d1ccc1",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/15/output.stderr",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F15%2Foutput.stderr?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -1,23 +1,23 @@\n   x \"use cache\" functions must be async functions.\n   | \n    ,-[input.js:1:1]\n- 1 | ,-> export default function () {\n- 2 | |     'use cache'\n- 3 | `-> }\n+ 1 | export default function Default() {\n+   :                         ^^^^^^^\n+ 2 |   'use cache'\n    `----\n   x \"use cache\" functions must be async functions.\n   | \n    ,-[input.js:5:1]\n- 4 |     \n- 5 | ,-> export function foo() {\n- 6 | |     'use cache'\n- 7 | `-> }\n+ 4 | \n+ 5 | export function foo() {\n+   :                 ^^^\n+ 6 |   'use cache'\n    `----\n   x \"use cache\" functions must be async functions.\n   | \n     ,-[input.js:9:1]\n-  8 |     \n-  9 | ,-> export const bar = () => {\n- 10 | |     'use cache'\n- 11 | `-> }\n+  8 | \n+  9 | export const bar = () => {\n+    :              ^^^\n+ 10 |   'use cache'\n     `----"
        },
        {
            "sha": "1a9c4dd939fe6eed59fe4555fd67fd5ed4776b09",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/2/output.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F2%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F2%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F2%2Foutput.stderr?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -3,5 +3,5 @@\n    ,-[input.js:7:1]\n  6 | \n  7 | export function bar() {}\n-   :        ^^^^^^^^^^^^^^^^^\n+   :                 ^^^\n    `----"
        },
        {
            "sha": "d159361ac4974b4239dbc0223e5478876d05933a",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/7/output.stderr",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F7%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/08209b9bf46a05d625292b9c0d7150dd61a8c483/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F7%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F7%2Foutput.stderr?ref=08209b9bf46a05d625292b9c0d7150dd61a8c483",
            "patch": "@@ -1,7 +1,7 @@\n   x Server Actions must be async functions.\n   | \n    ,-[input.js:1:1]\n- 1 | ,-> const foo = () => {\n- 2 | |     'use server'\n- 3 | `-> }\n+ 1 | const foo = () => {\n+   :       ^^^\n+ 2 |   'use server'\n    `----"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 31,
        "deletions": 25
    }
}