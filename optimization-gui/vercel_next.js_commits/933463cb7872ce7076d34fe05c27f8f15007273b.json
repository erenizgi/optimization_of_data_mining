{
    "author": "eps1lon",
    "message": "[test] Move error-overlay-layout to e2e tests (#83372)",
    "sha": "933463cb7872ce7076d34fe05c27f8f15007273b",
    "files": [
        {
            "sha": "e9de2c40920c0880c1fd0de90efb43a24d2e4d5c",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-layout/error-overlay-layout.test.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 127,
            "changes": 127,
            "blob_url": "https://github.com/vercel/next.js/blob/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-layout%2Ferror-overlay-layout.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-layout%2Ferror-overlay-layout.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-layout%2Ferror-overlay-layout.test.tsx?ref=93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c",
            "patch": "@@ -1,127 +0,0 @@\n-/**\n- * @jest-environment jsdom\n- */\n-/* eslint-disable import/no-extraneous-dependencies */\n-import { render, screen, fireEvent, act } from '@testing-library/react'\n-import { ErrorOverlayLayout } from './error-overlay-layout'\n-import '@testing-library/jest-dom'\n-\n-global.ResizeObserver = jest.fn().mockImplementation(() => ({\n-  observe: jest.fn(),\n-  unobserve: jest.fn(),\n-  disconnect: jest.fn(),\n-}))\n-\n-const renderTestComponent = () => {\n-  return render(\n-    <ErrorOverlayLayout\n-      errorType=\"Build Error\"\n-      errorMessage=\"Failed to compile\"\n-      errorCode=\"E001\"\n-      error={new Error('Sample error')}\n-      isBuildError={true}\n-      onClose={() => {}}\n-      rendered={true}\n-      transitionDurationMs={200}\n-      isTurbopack={false}\n-      errorCount={1}\n-      versionInfo={{\n-        installed: '15.0.0',\n-        staleness: 'fresh',\n-      }}\n-      generateErrorInfo={() => ''}\n-    >\n-      Module not found: Cannot find module './missing-module'\n-    </ErrorOverlayLayout>\n-  )\n-}\n-\n-describe('ErrorOverlayLayout Component', () => {\n-  beforeEach(() => {\n-    // Mock fetch\n-    global.fetch = jest.fn(() => {\n-      return Promise.resolve({\n-        ok: true,\n-        headers: new Headers(),\n-        redirected: false,\n-        status: 200,\n-        statusText: 'OK',\n-        type: 'basic',\n-        url: '',\n-        json: () => Promise.resolve({}),\n-        text: () => Promise.resolve(''),\n-        blob: () => Promise.resolve(new Blob()),\n-        arrayBuffer: () => Promise.resolve(new ArrayBuffer(0)),\n-        formData: () => Promise.resolve(new FormData()),\n-        clone: () => new Response(),\n-      } as Response)\n-    }) as jest.Mock\n-  })\n-\n-  test('renders ErrorOverlayLayout with provided props', () => {\n-    renderTestComponent()\n-    expect(screen.getByText('Failed to compile')).toBeInTheDocument()\n-    expect(\n-      screen.getByText(\n-        \"Module not found: Cannot find module './missing-module'\"\n-      )\n-    ).toBeInTheDocument()\n-  })\n-  test('voting buttons have aria-hidden icons', () => {\n-    renderTestComponent()\n-\n-    const helpfulButton = screen.getByRole('button', {\n-      name: 'Mark as helpful',\n-    })\n-    const notHelpfulButton = screen.getByRole('button', {\n-      name: 'Mark as not helpful',\n-    })\n-\n-    expect(helpfulButton.querySelector('svg')).toHaveAttribute(\n-      'aria-hidden',\n-      'true'\n-    )\n-    expect(notHelpfulButton.querySelector('svg')).toHaveAttribute(\n-      'aria-hidden',\n-      'true'\n-    )\n-  })\n-\n-  test('sends feedback when clicking helpful button', async () => {\n-    renderTestComponent()\n-\n-    expect(\n-      screen.queryByText('Thanks for your feedback!')\n-    ).not.toBeInTheDocument()\n-\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Mark as helpful' }))\n-    })\n-\n-    expect(fetch).toHaveBeenCalledWith(\n-      '/__nextjs_error_feedback?errorCode=E001&wasHelpful=true'\n-    )\n-\n-    expect(screen.getByText('Thanks for your feedback!')).toBeInTheDocument()\n-  })\n-\n-  test('sends feedback when clicking not helpful button', async () => {\n-    renderTestComponent()\n-\n-    expect(\n-      screen.queryByText('Thanks for your feedback!')\n-    ).not.toBeInTheDocument()\n-\n-    await act(async () => {\n-      fireEvent.click(\n-        screen.getByRole('button', { name: 'Mark as not helpful' })\n-      )\n-    })\n-\n-    expect(fetch).toHaveBeenCalledWith(\n-      '/__nextjs_error_feedback?errorCode=E001&wasHelpful=false'\n-    )\n-\n-    expect(screen.getByText('Thanks for your feedback!')).toBeInTheDocument()\n-  })\n-})"
        },
        {
            "sha": "1d4eac1591c4bebf04f20466225121c5c7bf952b",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/issue-feedback-button.stories.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.stories.tsx?ref=93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c",
            "patch": "@@ -1,20 +0,0 @@\n-import type { Meta, StoryObj } from '@storybook/react'\n-import { IssueFeedbackButton } from './issue-feedback-button'\n-import { withShadowPortal } from '../../../storybook/with-shadow-portal'\n-\n-const meta: Meta<typeof IssueFeedbackButton> = {\n-  component: IssueFeedbackButton,\n-  parameters: {\n-    layout: 'centered',\n-  },\n-  decorators: [withShadowPortal],\n-}\n-\n-export default meta\n-type Story = StoryObj<typeof IssueFeedbackButton>\n-\n-export const Default: Story = {\n-  args: {\n-    errorCode: 'E001_FAKE',\n-  },\n-}"
        },
        {
            "sha": "fb42f38e6cc999a1acb42de424114d670a6a7fe3",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/issue-feedback-button.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 115,
            "changes": 115,
            "blob_url": "https://github.com/vercel/next.js/blob/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fissue-feedback-button.tsx?ref=93e1a4c71ea471aa10cacaa1a2e3724155f6cd9c",
            "patch": "@@ -1,115 +0,0 @@\n-import { useCallback, useState } from 'react'\n-\n-import { ThumbsDown } from '../../../icons/thumbs/thumbs-down'\n-import { ThumbsUp } from '../../../icons/thumbs/thumbs-up'\n-import { cx } from '../../../utils/cx'\n-import { css } from '../../../utils/css'\n-\n-export function IssueFeedbackButton({ errorCode }: { errorCode: string }) {\n-  const [votedMap, setVotedMap] = useState<Record<string, boolean>>({})\n-  const voted = votedMap[errorCode]\n-  const disabled = process.env.__NEXT_TELEMETRY_DISABLED\n-\n-  const handleFeedback = useCallback(\n-    async (wasHelpful: boolean) => {\n-      // Optimistically set feedback state without loading/error states to keep implementation simple\n-      setVotedMap((prev) => ({\n-        ...prev,\n-        [errorCode]: wasHelpful,\n-      }))\n-\n-      try {\n-        const response = await fetch(\n-          `${process.env.__NEXT_ROUTER_BASEPATH || ''}/__nextjs_error_feedback?${new URLSearchParams(\n-            {\n-              errorCode,\n-              wasHelpful: wasHelpful.toString(),\n-            }\n-          )}`\n-        )\n-\n-        if (!response.ok) {\n-          // Handle non-2xx HTTP responses here if needed\n-          console.error('Failed to record feedback on the server.')\n-        }\n-      } catch (error) {\n-        console.error('Failed to record feedback:', error)\n-      }\n-    },\n-    [errorCode]\n-  )\n-\n-  return (\n-    <div data-nextjs-issue-feedback-button-group>\n-      <button\n-        aria-disabled={disabled ? 'true' : undefined}\n-        aria-label=\"Mark as helpful\"\n-        onClick={disabled ? undefined : () => handleFeedback(true)}\n-        className={cx('feedback-button', voted === true && 'voted')}\n-        title={\n-          disabled\n-            ? 'Feedback disabled due to setting NEXT_TELEMETRY_DISABLED'\n-            : undefined\n-        }\n-        type=\"button\"\n-      >\n-        <ThumbsUp aria-hidden=\"true\" />\n-      </button>\n-      <div data-nextjs-issue-feedback-separator />\n-      <button\n-        aria-disabled={disabled ? 'true' : undefined}\n-        aria-label=\"Mark as not helpful\"\n-        onClick={disabled ? undefined : () => handleFeedback(false)}\n-        className={cx('feedback-button', voted === false && 'voted')}\n-        title={\n-          disabled\n-            ? 'Feedback disabled due to setting NEXT_TELEMETRY_DISABLED'\n-            : undefined\n-        }\n-        type=\"button\"\n-      >\n-        <ThumbsDown\n-          aria-hidden=\"true\"\n-          // Optical alignment\n-          style={{\n-            translate: '1px 1px',\n-          }}\n-        />\n-      </button>\n-    </div>\n-  )\n-}\n-\n-export const ISSUE_FEEDBACK_BUTTON_STYLES = css`\n-  [data-nextjs-issue-feedback-button-group] {\n-    display: flex;\n-    align-items: center;\n-    border: 1px solid var(--color-gray-400);\n-    border-radius: var(--rounded-full);\n-    background: var(--color-background-100);\n-    box-shadow: var(--shadow-small);\n-  }\n-\n-  [data-nextjs-issue-feedback-button-group] button {\n-    height: 100%;\n-    display: flex;\n-    align-items: center;\n-    justify-content: center;\n-  }\n-\n-  [data-nextjs-issue-feedback-button-group] button:first-child {\n-    padding: 4px 3px 4px 5px;\n-    border-radius: var(--rounded-full) 0 0 var(--rounded-full);\n-  }\n-\n-  [data-nextjs-issue-feedback-button-group] button:last-child {\n-    padding: 4px 5px 4px 3px;\n-    border-radius: 0 var(--rounded-full) var(--rounded-full) 0;\n-  }\n-\n-  [data-nextjs-issue-feedback-separator] {\n-    width: 1px;\n-    height: 100%;\n-    background: var(--color-gray-400);\n-  }\n-`"
        },
        {
            "sha": "041e92dfef9e13ee8112bd012cc78e6f9b20a2bd",
            "filename": "packages/next/src/next-devtools/dev-overlay/styles/component-styles.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/933463cb7872ce7076d34fe05c27f8f15007273b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/933463cb7872ce7076d34fe05c27f8f15007273b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstyles%2Fcomponent-styles.tsx?ref=933463cb7872ce7076d34fe05c27f8f15007273b",
            "patch": "@@ -20,7 +20,6 @@ import { DEV_TOOLS_INFO_ROUTE_INFO_STYLES } from '../components/errors/dev-tools\n import { DEV_TOOLS_INFO_USER_PREFERENCES_STYLES } from '../components/errors/dev-tools-indicator/dev-tools-info/user-preferences'\n import { FADER_STYLES } from '../components/fader'\n import { CALL_STACK_STYLES } from '../components/call-stack/call-stack'\n-import { ISSUE_FEEDBACK_BUTTON_STYLES } from '../components/errors/error-overlay-toolbar/issue-feedback-button'\n import { SHORTCUT_RECORDER_STYLES } from '../components/errors/dev-tools-indicator/dev-tools-info/shortcut-recorder'\n \n export function ComponentStyles() {\n@@ -48,7 +47,6 @@ export function ComponentStyles() {\n         ${DEV_TOOLS_INFO_ROUTE_INFO_STYLES}\n         ${DEV_TOOLS_INFO_USER_PREFERENCES_STYLES}\n         ${FADER_STYLES}\n-        ${ISSUE_FEEDBACK_BUTTON_STYLES}\n         ${SHORTCUT_RECORDER_STYLES}\n       `}\n     </style>"
        },
        {
            "sha": "6808ef40fb2e4c7f0db54a1424bfbe3750d9d537",
            "filename": "test/development/error-overlay/index.test.tsx",
            "status": "modified",
            "additions": 53,
            "deletions": 12,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/933463cb7872ce7076d34fe05c27f8f15007273b/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/933463cb7872ce7076d34fe05c27f8f15007273b/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx?ref=933463cb7872ce7076d34fe05c27f8f15007273b",
            "patch": "@@ -4,30 +4,71 @@ import { assertHasRedbox } from 'next-test-utils'\n describe('DevErrorOverlay', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n+    env: {\n+      NEXT_TELEMETRY_DISABLED: '',\n+    },\n   })\n \n   it('can get error code from RSC error thrown by framework', async () => {\n-    await next.render('/known-rsc-error')\n     const browser = await next.browser('/known-rsc-error')\n-    const errorCode = await browser.waitForElementByCss(\n-      '[data-nextjs-error-code]'\n-    )\n+\n+    const errorCode = await browser.elementByCss('[data-nextjs-error-code]')\n     const code = await errorCode.getAttribute('data-nextjs-error-code')\n     expect(code).toBe('E127')\n   })\n \n-  it('can get error code from client side error thrown by framework', async () => {\n-    await next.render('/known-client-error')\n+  it('sends feedback when clicking helpful button', async () => {\n+    const feedbackRequests: string[] = []\n+    const browser = await next.browser('/known-client-error', {\n+      beforePageLoad(page) {\n+        page.route(/__nextjs_error_feedback/, (route) => {\n+          const url = new URL(route.request().url())\n+          feedbackRequests.push(url.pathname + url.search)\n \n-    const browser = await next.browser('/known-client-error')\n+          route.fulfill({ status: 204, body: 'No Content' })\n+        })\n+      },\n+    })\n \n     await browser.elementByCss('button').click() // clicked \"break on client\"\n+    await browser.getByRole('button', { name: 'Mark as helpful' }).click()\n \n-    const errorCode = await browser.waitForElementByCss(\n-      '[data-nextjs-error-code]'\n-    )\n-    const code = await errorCode.getAttribute('data-nextjs-error-code')\n-    expect(code).toBe('E794')\n+    expect(\n+      await browser\n+        .getByRole('region', { name: 'Error feedback' })\n+        .getByRole('status')\n+        .textContent()\n+    ).toEqual('Thanks for your feedback!')\n+    expect(feedbackRequests).toEqual([\n+      '/__nextjs_error_feedback?errorCode=E794&wasHelpful=true',\n+    ])\n+  })\n+\n+  it('sends feedback when clicking not helpful button', async () => {\n+    const feedbackRequests: string[] = []\n+    const browser = await next.browser('/known-client-error', {\n+      beforePageLoad(page) {\n+        page.route(/__nextjs_error_feedback/, (route) => {\n+          const url = new URL(route.request().url())\n+          feedbackRequests.push(url.pathname + url.search)\n+\n+          route.fulfill({ status: 204, body: 'No Content' })\n+        })\n+      },\n+    })\n+\n+    await browser.elementByCss('button').click() // clicked \"break on client\"\n+    await browser.getByRole('button', { name: 'Mark as not helpful' }).click()\n+\n+    expect(\n+      await browser\n+        .getByRole('region', { name: 'Error feedback' })\n+        .getByRole('status')\n+        .textContent()\n+    ).toEqual('Thanks for your feedback!')\n+    expect(feedbackRequests).toEqual([\n+      '/__nextjs_error_feedback?errorCode=E794&wasHelpful=false',\n+    ])\n   })\n \n   it('loads fonts successfully', async () => {"
        },
        {
            "sha": "b9c9d5a314b8e69663d85a42a5f92076c0fbd166",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/933463cb7872ce7076d34fe05c27f8f15007273b/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/933463cb7872ce7076d34fe05c27f8f15007273b/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=933463cb7872ce7076d34fe05c27f8f15007273b",
            "patch": "@@ -592,6 +592,13 @@ export class Playwright<TCurrent = undefined> {\n     })\n   }\n \n+  getByRole(\n+    role: Parameters<(typeof page)['getByRole']>[0],\n+    options?: Parameters<(typeof page)['getByRole']>[1]\n+  ) {\n+    return page.getByRole(role, options)\n+  }\n+\n   locateRedbox(): Locator {\n     return page.locator(\n       'nextjs-portal [aria-labelledby=\"nextjs__container_errors_label\"]'"
        }
    ],
    "stats": {
        "total": 336,
        "additions": 60,
        "deletions": 276
    }
}