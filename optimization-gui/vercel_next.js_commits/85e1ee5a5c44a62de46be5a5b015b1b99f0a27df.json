{
    "author": "timneutkens",
    "message": "Turbopack: Fix 500 handling in edge with pages router (#76155)\n\n## What?\n\nEnsures the pages/500.js is passed to the edge handler template when it\nexists.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "85e1ee5a5c44a62de46be5a5b015b1b99f0a27df",
    "files": [
        {
            "sha": "3a2001d38e6dd32ff4c0041638007478f48d40d9",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=85e1ee5a5c44a62de46be5a5b015b1b99f0a27df",
            "patch": "@@ -105,6 +105,7 @@ impl PagesProject {\n             app: _,\n             document: _,\n             error: _,\n+            error_500: _,\n         } = &*pages_structure.await?;\n         let mut routes = FxIndexMap::default();\n \n@@ -711,7 +712,7 @@ impl PageEndpoint {\n \n     #[turbo_tasks::function]\n     fn source(&self) -> Vc<Box<dyn Source>> {\n-        Vc::upcast(FileSource::new(self.page.project_path()))\n+        Vc::upcast(FileSource::new(self.page.file_path()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "a747d0d51cfb3378fc712967e831ed77f74d0018",
            "filename": "crates/next-core/src/next_pages/page_entry.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 8,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs?ref=85e1ee5a5c44a62de46be5a5b015b1b99f0a27df",
            "patch": "@@ -116,11 +116,13 @@ pub async fn create_page_ssr_entry_module(\n         INNER.into() => ssr_module,\n     };\n \n+    let pages_structure_ref = pages_structure.await?;\n+\n     if reference_type == ReferenceType::Entry(EntryReferenceSubType::Page) {\n         inner_assets.insert(\n             INNER_DOCUMENT.into(),\n             process_global_item(\n-                pages_structure.document(),\n+                *pages_structure_ref.document,\n                 Value::new(reference_type.clone()),\n                 ssr_module_context,\n             )\n@@ -130,7 +132,7 @@ pub async fn create_page_ssr_entry_module(\n         inner_assets.insert(\n             INNER_APP.into(),\n             process_global_item(\n-                pages_structure.app(),\n+                *pages_structure_ref.app,\n                 Value::new(reference_type.clone()),\n                 ssr_module_context,\n             )\n@@ -177,7 +179,7 @@ fn process_global_item(\n     reference_type: Value<ReferenceType>,\n     module_context: Vc<Box<dyn AssetContext>>,\n ) -> Vc<Box<dyn Module>> {\n-    let source = Vc::upcast(FileSource::new(item.project_path()));\n+    let source = Vc::upcast(FileSource::new(item.file_path()));\n     module_context.process(source, reference_type).module()\n }\n \n@@ -197,6 +199,7 @@ async fn wrap_edge_page(\n     const INNER_DOCUMENT: &str = \"INNER_DOCUMENT\";\n     const INNER_APP: &str = \"INNER_APP\";\n     const INNER_ERROR: &str = \"INNER_ERROR\";\n+    const INNER_ERROR_500: &str = \"INNER_500\";\n \n     let next_config_val = &*next_config.await?;\n \n@@ -235,30 +238,41 @@ async fn wrap_edge_page(\n         fxindexmap! {\n             // TODO\n             \"incrementalCacheHandler\" => None,\n-            \"userland500Page\" => None,\n+            \"userland500Page\" => pages_structure.await?.error_500.map(|_| INNER_ERROR_500.into()),\n         },\n     )\n     .await?;\n \n-    let inner_assets = fxindexmap! {\n+    let pages_structure_ref = pages_structure.await?;\n+\n+    let mut inner_assets = fxindexmap! {\n         INNER.into() => entry,\n         INNER_DOCUMENT.into() => process_global_item(\n-            pages_structure.document(),\n+            *pages_structure_ref.document,\n             reference_type.clone(),\n             asset_context,\n         ).to_resolved().await?,\n         INNER_APP.into() => process_global_item(\n-            pages_structure.app(),\n+            *pages_structure_ref.app,\n             reference_type.clone(),\n             asset_context,\n         ).to_resolved().await?,\n         INNER_ERROR.into() => process_global_item(\n-            pages_structure.error(),\n+            *pages_structure_ref.error,\n             reference_type.clone(),\n             asset_context,\n         ).to_resolved().await?,\n     };\n \n+    if let Some(error_500) = pages_structure_ref.error_500 {\n+        inner_assets.insert(\n+            INNER_ERROR_500.into(),\n+            process_global_item(*error_500, reference_type.clone(), asset_context)\n+                .to_resolved()\n+                .await?,\n+        );\n+    }\n+\n     let wrapped = asset_context\n         .process(\n             Vc::upcast(source),"
        },
        {
            "sha": "80938b743bb74b15d538f0033bc1418a0a7e06c8",
            "filename": "crates/next-core/src/pages_structure.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 23,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85e1ee5a5c44a62de46be5a5b015b1b99f0a27df/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs?ref=85e1ee5a5c44a62de46be5a5b015b1b99f0a27df",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{OptionVcExt, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n use turbo_tasks_fs::{\n     DirectoryContent, DirectoryEntry, FileSystemEntryType, FileSystemPath, FileSystemPathOption,\n };\n@@ -45,17 +45,22 @@ impl PagesStructureItem {\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn project_path(&self) -> Result<Vc<FileSystemPath>> {\n+    pub async fn file_path(&self) -> Result<Vc<FileSystemPath>> {\n+        // Check if the file path + extension exists in the filesystem, if so use that. If not fall\n+        // back to the base path.\n         for ext in self.extensions.await?.into_iter() {\n-            let project_path = self.base_path.append(format!(\".{ext}\").into());\n-            let ty = *project_path.get_type().await?;\n+            let file_path: Vc<FileSystemPath> = self.base_path.append(format!(\".{ext}\").into());\n+            let ty = *file_path.get_type().await?;\n             if matches!(ty, FileSystemEntryType::File | FileSystemEntryType::Symlink) {\n-                return Ok(project_path);\n+                return Ok(file_path);\n             }\n         }\n         if let Some(fallback_path) = self.fallback_path {\n             Ok(*fallback_path)\n         } else {\n+            // If the file path that was passed in already has an extension, for example\n+            // `pages/index.js` it won't match the extensions list above because it already had an\n+            // extension and for example `.js.js` obviously won't match\n             Ok(*self.base_path)\n         }\n     }\n@@ -68,28 +73,11 @@ pub struct PagesStructure {\n     pub app: ResolvedVc<PagesStructureItem>,\n     pub document: ResolvedVc<PagesStructureItem>,\n     pub error: ResolvedVc<PagesStructureItem>,\n+    pub error_500: Option<ResolvedVc<PagesStructureItem>>,\n     pub api: Option<ResolvedVc<PagesDirectoryStructure>>,\n     pub pages: Option<ResolvedVc<PagesDirectoryStructure>>,\n }\n \n-#[turbo_tasks::value_impl]\n-impl PagesStructure {\n-    #[turbo_tasks::function]\n-    pub fn app(&self) -> Vc<PagesStructureItem> {\n-        *self.app\n-    }\n-\n-    #[turbo_tasks::function]\n-    pub fn document(&self) -> Vc<PagesStructureItem> {\n-        *self.document\n-    }\n-\n-    #[turbo_tasks::function]\n-    pub fn error(&self) -> Vc<PagesStructureItem> {\n-        *self.error\n-    }\n-}\n-\n #[turbo_tasks::value]\n pub struct PagesDirectoryStructure {\n     pub project_path: ResolvedVc<FileSystemPath>,\n@@ -157,6 +145,7 @@ async fn get_pages_structure_for_root_directory(\n     let page_extensions_raw = &*page_extensions.await?;\n \n     let mut api_directory = None;\n+    let mut error_500_item = None;\n \n     let project_path = project_path.await?;\n     let pages_directory = if let Some(project_path) = &*project_path {\n@@ -179,6 +168,23 @@ async fn get_pages_structure_for_root_directory(\n                         let base_path = project_path.join(basename.into());\n                         match basename {\n                             \"_app\" | \"_document\" | \"_error\" => {}\n+                            \"500\" => {\n+                                let item_next_router_path =\n+                                    next_router_path_for_basename(next_router_path, basename);\n+                                let item_original_path = next_router_path.join(basename.into());\n+                                let item = PagesStructureItem::new(\n+                                    base_path,\n+                                    page_extensions,\n+                                    None,\n+                                    item_next_router_path,\n+                                    item_original_path,\n+                                );\n+\n+                                error_500_item = Some(item);\n+\n+                                items.push((basename, item));\n+                            }\n+\n                             basename => {\n                                 let item_next_router_path =\n                                     next_router_path_for_basename(next_router_path, basename);\n@@ -294,6 +300,7 @@ async fn get_pages_structure_for_root_directory(\n         app: app_item.to_resolved().await?,\n         document: document_item.to_resolved().await?,\n         error: error_item.to_resolved().await?,\n+        error_500: error_500_item.to_resolved().await?,\n         api: api_directory,\n         pages: pages_directory,\n     }"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 54,
        "deletions": 32
    }
}