{
    "author": "bgw",
    "message": "babel-loader: Fix a few issues with config caching (#83973)\n\n- `isReactCompilerRequired` needs to be called in `getCacheCharacteristics`, not in `getFreshConfig` because it depends on the file contents, so we don't want to cache the result of `isReactCompilerRequired`.\n- Moving react compiler detection outside of the cache lets us avoid using the full file path for a cache key (which negates much of the benefit of the cache).\n- `getFreshConfig` shouldn't use the real file path or source map, those should always be injected later.\n- It doesn't look like we were updating `inputSourceMap` on cached config objects (!?!?)",
    "sha": "704c15311a3c2ceae546ac7f35853f2cd30c0d08",
    "files": [
        {
            "sha": "51ddc62033660ec2ce7701ecdaf74fb67a6b11ef",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 90,
            "deletions": 71,
            "changes": 161,
            "blob_url": "https://github.com/vercel/next.js/blob/704c15311a3c2ceae546ac7f35853f2cd30c0d08/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/704c15311a3c2ceae546ac7f35853f2cd30c0d08/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=704c15311a3c2ceae546ac7f35853f2cd30c0d08",
            "patch": "@@ -59,27 +59,26 @@ interface CharacteristicsGermaneToCaching {\n   isPageFile: boolean | undefined\n   isNextDist: boolean\n   hasModuleExports: boolean\n-  fileNameOrExt: string\n+  hasReactCompiler: boolean\n+  fileExt: string\n   configFilePath: string | undefined\n }\n \n const fileExtensionRegex = /\\.([a-z]+)$/\n-function getCacheCharacteristics(\n+async function getCacheCharacteristics(\n   loaderOptions: NextBabelLoaderOptions,\n   source: string,\n   filename: string\n-): CharacteristicsGermaneToCaching {\n-  let isStandalone, isServer, pagesDir, fileNameOrExt\n+): Promise<CharacteristicsGermaneToCaching> {\n+  let isStandalone, isServer, pagesDir\n   switch (loaderOptions.transformMode) {\n     case 'default':\n       isStandalone = false\n       isServer = loaderOptions.isServer\n       pagesDir = loaderOptions.pagesDir\n-      fileNameOrExt = fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n       break\n     case 'standalone':\n       isStandalone = true\n-      fileNameOrExt = filename\n       break\n     default:\n       throw new Error(\n@@ -90,14 +89,29 @@ function getCacheCharacteristics(\n   const isPageFile = pagesDir != null && filename.startsWith(pagesDir)\n   const isNextDist = nextDistPath.test(filename)\n   const hasModuleExports = source.indexOf('module.exports') !== -1\n+  const fileExt = fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n+\n+  // Compute `hasReactCompiler` as part of the cache characteristics / key,\n+  // rather than inside of `getFreshConfig`:\n+  // - `isReactCompilerRequired` depends on the file contents\n+  // - `node_modules` and `reactCompilerExclude` depend on the file path, which\n+  //   isn't part of the cache characteristics\n+  let { reactCompilerPlugins, reactCompilerExclude } = loaderOptions\n+  reactCompilerPlugins ??= []\n+  const hasReactCompiler =\n+    reactCompilerPlugins.length !== 0 &&\n+    !/[/\\\\]node_modules[/\\\\]/.test(filename) &&\n+    !reactCompilerExclude?.(filename) &&\n+    (await isReactCompilerRequired(filename))\n \n   return {\n     isStandalone,\n     isServer,\n     isPageFile,\n     isNextDist,\n     hasModuleExports,\n-    fileNameOrExt,\n+    hasReactCompiler,\n+    fileExt,\n     configFilePath: loaderOptions.configFile,\n   }\n }\n@@ -306,50 +320,31 @@ function checkCustomBabelConfigDeprecation(\n /**\n  * Generate a new, flat Babel config, ready to be handed to Babel-traverse.\n  * This config should have no unresolved overrides, presets, etc.\n+ *\n+ * The config returned by this function is cached, so the function should not\n+ * depend on file-specific configuration or configuration that could change\n+ * across invocations without a process restart.\n  */\n async function getFreshConfig(\n   ctx: NextJsLoaderContext,\n   cacheCharacteristics: CharacteristicsGermaneToCaching,\n   loaderOptions: NextBabelLoaderOptions,\n-  target: string,\n-  filename: string,\n-  inputSourceMap?: SourceMap\n+  target: string\n ): Promise<ResolvedBabelConfig | null> {\n-  const {\n-    transformMode,\n-    configFile,\n-    reactCompilerPlugins,\n-    reactCompilerExclude,\n-  } = loaderOptions\n-\n-  const hasReactCompiler = await (async () => {\n-    if (reactCompilerPlugins && reactCompilerPlugins.length === 0) {\n-      return false\n-    }\n+  const { transformMode } = loaderOptions\n+  const { hasReactCompiler, configFilePath, fileExt } = cacheCharacteristics\n \n-    if (/[/\\\\]node_modules[/\\\\]/.test(filename)) {\n-      return false\n-    }\n-\n-    if (reactCompilerExclude && reactCompilerExclude(filename)) {\n-      return false\n-    }\n-\n-    if (!(await isReactCompilerRequired(filename))) {\n-      return false\n-    }\n-\n-    return true\n-  })()\n-\n-  let customConfig = configFile && getCustomBabelConfig(configFile)\n+  let customConfig = configFilePath && getCustomBabelConfig(configFilePath)\n   if (transformMode === 'standalone' && !customConfig && !hasReactCompiler) {\n     // Optimization: There's nothing useful to do, bail out and skip babel on this file\n     return null\n   }\n \n   checkCustomBabelConfigDeprecation(customConfig)\n \n+  // We can assume that `reactCompilerPlugins` does not change without a process\n+  // restart (it's safe to cache), as it's specified in the `next.config.js`,\n+  // which always causes a full restart of `next dev` if changed.\n   const reactCompilerPluginsIfEnabled = hasReactCompiler\n     ? (loaderOptions.reactCompilerPlugins ?? [])\n     : []\n@@ -365,13 +360,12 @@ async function getFreshConfig(\n   let options: BabelLoaderTransformOptions = {\n     babelrc: false,\n     cloneInputAst: false,\n-    filename,\n-    inputSourceMap,\n \n-    // Ensure that Webpack will get a full absolute path in the sourcemap\n-    // so that it can properly map the module back to its internal cached\n-    // modules.\n-    sourceFileName: filename,\n+    // Use placeholder file info. `updateBabelConfigWithFileDetails` will\n+    // replace this after caching.\n+    filename: `basename.${fileExt}`,\n+    inputSourceMap: undefined,\n+    sourceFileName: `basename.${fileExt}`,\n \n     // Set the default sourcemap behavior based on Webpack's mapping flag,\n     // but allow users to override if they want.\n@@ -476,26 +470,56 @@ function getCacheKey(cacheCharacteristics: CharacteristicsGermaneToCaching) {\n     isPageFile,\n     isNextDist,\n     hasModuleExports,\n-    fileNameOrExt,\n+    hasReactCompiler,\n+    fileExt,\n     configFilePath,\n   } = cacheCharacteristics\n \n   const flags =\n     0 |\n-    (isStandalone ? 0b00001 : 0) |\n-    (isServer ? 0b00010 : 0) |\n-    (isPageFile ? 0b00100 : 0) |\n-    (isNextDist ? 0b01000 : 0) |\n-    (hasModuleExports ? 0b10000 : 0)\n+    (isStandalone ? 0b000001 : 0) |\n+    (isServer ? 0b000010 : 0) |\n+    (isPageFile ? 0b000100 : 0) |\n+    (isNextDist ? 0b001000 : 0) |\n+    (hasModuleExports ? 0b010000 : 0) |\n+    (hasReactCompiler ? 0b100000 : 0)\n \n   // separate strings will null bytes, assuming null bytes are not valid in file\n   // paths\n-  return `${configFilePath || ''}\\x00${fileNameOrExt}\\x00${flags}`\n+  return `${configFilePath || ''}\\x00${fileExt}\\x00${flags}`\n }\n \n const configCache: Map<any, ResolvedBabelConfig | null> = new Map()\n const configFiles: Set<string> = new Set()\n \n+/**\n+ * Applies file-specific values to a potentially-cached configuration object.\n+ */\n+function updateBabelConfigWithFileDetails(\n+  cachedConfig: ResolvedBabelConfig | null | undefined,\n+  loaderOptions: NextBabelLoaderOptions,\n+  filename: string,\n+  inputSourceMap: SourceMap | undefined\n+): ResolvedBabelConfig | null {\n+  if (cachedConfig == null) {\n+    return null\n+  }\n+  return {\n+    ...cachedConfig,\n+    options: {\n+      ...cachedConfig.options,\n+      cwd: loaderOptions.cwd,\n+      root: loaderOptions.cwd,\n+      filename,\n+      inputSourceMap,\n+      // Ensure that Webpack will get a full absolute path in the sourcemap\n+      // so that it can properly map the module back to its internal cached\n+      // modules.\n+      sourceFileName: filename,\n+    },\n+  }\n+}\n+\n export default async function getConfig(\n   ctx: NextJsLoaderContext,\n   {\n@@ -512,7 +536,7 @@ export default async function getConfig(\n     inputSourceMap?: SourceMap | undefined\n   }\n ): Promise<ResolvedBabelConfig | null> {\n-  const cacheCharacteristics = getCacheCharacteristics(\n+  const cacheCharacteristics = await getCacheCharacteristics(\n     loaderOptions,\n     source,\n     filename\n@@ -524,22 +548,14 @@ export default async function getConfig(\n   }\n \n   const cacheKey = getCacheKey(cacheCharacteristics)\n-  if (configCache.has(cacheKey)) {\n-    const cachedConfig = configCache.get(cacheKey)\n-    if (!cachedConfig) {\n-      return null\n-    }\n-\n-    return {\n-      ...cachedConfig,\n-      options: {\n-        ...cachedConfig.options,\n-        cwd: loaderOptions.cwd,\n-        root: loaderOptions.cwd,\n-        filename,\n-        sourceFileName: filename,\n-      },\n-    }\n+  const cachedConfig = configCache.get(cacheKey)\n+  if (cachedConfig !== undefined) {\n+    return updateBabelConfigWithFileDetails(\n+      cachedConfig,\n+      loaderOptions,\n+      filename,\n+      inputSourceMap\n+    )\n   }\n \n   if (loaderOptions.configFile && !configFiles.has(loaderOptions.configFile)) {\n@@ -553,12 +569,15 @@ export default async function getConfig(\n     ctx,\n     cacheCharacteristics,\n     loaderOptions,\n-    target,\n-    filename,\n-    inputSourceMap\n+    target\n   )\n \n   configCache.set(cacheKey, freshConfig)\n \n-  return freshConfig\n+  return updateBabelConfigWithFileDetails(\n+    freshConfig,\n+    loaderOptions,\n+    filename,\n+    inputSourceMap\n+  )\n }"
        }
    ],
    "stats": {
        "total": 161,
        "additions": 90,
        "deletions": 71
    }
}