{
    "author": "ztanner",
    "message": "tests: disable flaky deployment test while investigating upstream (#83705)\n\nThis test has started failing when deployed to hosted environments, but\nit consistently is passing in `next start` tests.\n\nWe could retry the on-demand revalidation and the test will pass, but we\nlose the value in the test.\n\nThis instead temporarily disables it until it can be investigated\nupstream.\n\n[slack\nx-ref](https://vercel.slack.com/archives/C04KC8A53T7/p1757108995256419)",
    "sha": "c03aaee5508f82370db2d6121eae3b4acee75a4e",
    "files": [
        {
            "sha": "353cd678f30962f033c61a74174d72ecd8f7561b",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 15,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=c03aaee5508f82370db2d6121eae3b4acee75a4e",
            "patch": "@@ -2294,7 +2294,11 @@ describe('Prerender', () => {\n       })\n     }\n \n-    if (!isDev) {\n+    // This test is disabled in deployed environments because the initial on-demand revalidate call\n+    // is not actually producing a new response, until it's called for a second time\n+    // Rather than retrying just to fix the test, we need to investigate what might\n+    // be causing this behavior in a deployed environment.\n+    if (!isDev && !isDeploy) {\n       it('should handle on-demand revalidate for fallback: blocking', async () => {\n         const res = await fetchViaHTTP(\n           next.url,\n@@ -2309,21 +2313,19 @@ describe('Prerender', () => {\n         expect(res.headers.get(cacheHeader)).toMatch(/MISS/)\n         expect($('p').text()).toMatch(/Post:.*?test-manual-1/)\n \n-        if (!isDeploy) {\n-          // we use retry here as the cache might still be\n-          // writing to disk even after the above request has finished\n-          await retry(async () => {\n-            const res2 = await fetchViaHTTP(\n-              next.url,\n-              '/blocking-fallback/test-manual-1'\n-            )\n-            const html2 = await res2.text()\n-            const $2 = cheerio.load(html2)\n+        // we use retry here as the cache might still be\n+        // writing to disk even after the above request has finished\n+        await retry(async () => {\n+          const res2 = await fetchViaHTTP(\n+            next.url,\n+            '/blocking-fallback/test-manual-1'\n+          )\n+          const html2 = await res2.text()\n+          const $2 = cheerio.load(html2)\n \n-            expect(res2.headers.get(cacheHeader)).toMatch(/(HIT|STALE)/)\n-            expect(initialTime).toBe($2('#time').text())\n-          })\n-        }\n+          expect(res2.headers.get(cacheHeader)).toMatch(/(HIT|STALE)/)\n+          expect(initialTime).toBe($2('#time').text())\n+        })\n \n         const res3 = await fetchViaHTTP(\n           next.url,\n@@ -2345,6 +2347,7 @@ describe('Prerender', () => {\n           )\n           const html4 = await res4.text()\n           const $4 = cheerio.load(html4)\n+\n           expect($4('#time').text()).not.toBe(initialTime)\n           expect(res4.headers.get(cacheHeader)).toMatch(/(HIT|STALE)/)\n         })"
        },
        {
            "sha": "cc4a6313f6c7ceddf1d0d1a67ebbff7f611aba53",
            "filename": "test/e2e/prerender/pages/api/manual-revalidate.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender%2Fpages%2Fapi%2Fmanual-revalidate.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender%2Fpages%2Fapi%2Fmanual-revalidate.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender%2Fpages%2Fapi%2Fmanual-revalidate.js?ref=c03aaee5508f82370db2d6121eae3b4acee75a4e",
            "patch": "@@ -3,6 +3,7 @@ export default async function handler(req, res) {\n   // make sure to use trusted value for revalidating\n   let revalidated = false\n   try {\n+    console.log('API: Called res.revalidate for ', req.query.pathname)\n     await res.revalidate(req.query.pathname, {\n       unstable_onlyGenerated: !!req.query.onlyGenerated,\n     })"
        },
        {
            "sha": "9a8c0496afdde09d3df18ff6a6a2ca9885962733",
            "filename": "test/e2e/prerender/pages/blocking-fallback/[slug].js",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender%2Fpages%2Fblocking-fallback%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c03aaee5508f82370db2d6121eae3b4acee75a4e/test%2Fe2e%2Fprerender%2Fpages%2Fblocking-fallback%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender%2Fpages%2Fblocking-fallback%2F%5Bslug%5D.js?ref=c03aaee5508f82370db2d6121eae3b4acee75a4e",
            "patch": "@@ -41,16 +41,22 @@ export async function getStaticProps({ params }) {\n \n   console.log(`getStaticProps ${params.slug}`)\n \n-  return {\n+  const result = {\n     props: {\n       params,\n       hello: 'world',\n       post: params.slug,\n       random: Math.random(),\n       time: (await import('perf_hooks')).performance.now(),\n     },\n-    revalidate: 1,\n   }\n+\n+  // Don't add revalidate for test-manual-1 to test pure on-demand revalidation\n+  if (params.slug !== 'test-manual-1') {\n+    result.revalidate = 1\n+  }\n+\n+  return result\n }\n \n export default ({ post, time, params }) => {"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 27,
        "deletions": 17
    }
}