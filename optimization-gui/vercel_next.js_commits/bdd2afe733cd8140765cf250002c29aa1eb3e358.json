{
    "author": "kdy1",
    "message": "perf(turbopack): Decode sourcemap partially (#80177)\n\n### What?\n\nUse the forked version of `sourcemap`. We can improve performance by utilizing https://github.com/kdy1/rust-sourcemap/pull/1\n\n### Why?\n\nIt's much faster. 3% ~ 12% build performance improvement\n\n\n![image](https://github.com/user-attachments/assets/f664fc4c-4ce2-4b2c-ab29-3a860ed24da7)\n\n\n### How?",
    "sha": "bdd2afe733cd8140765cf250002c29aa1eb3e358",
    "files": [
        {
            "sha": "d6b82bbc628ef29805d72a1b7dca675eec0a221c",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/bdd2afe733cd8140765cf250002c29aa1eb3e358/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/bdd2afe733cd8140765cf250002c29aa1eb3e358/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=bdd2afe733cd8140765cf250002c29aa1eb3e358",
            "patch": "@@ -7164,8 +7164,7 @@ dependencies = [\n [[package]]\n name = \"sourcemap\"\n version = \"9.2.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e22afbcb92ce02d23815b9795523c005cb9d3c214f8b7a66318541c240ea7935\"\n+source = \"git+https://github.com/kdy1/rust-sourcemap?branch=main#804d663521d6109b3746d800918d483b97e8e108\"\n dependencies = [\n  \"base64-simd 0.8.0\",\n  \"bitvec\",\n@@ -10097,6 +10096,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"async-trait\",\n+ \"bitvec\",\n  \"codspeed-criterion-compat\",\n  \"data-encoding\",\n  \"either\","
        },
        {
            "sha": "a624962c5f9762eada033a9d090c023b509917b1",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bdd2afe733cd8140765cf250002c29aa1eb3e358/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/bdd2afe733cd8140765cf250002c29aa1eb3e358/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=bdd2afe733cd8140765cf250002c29aa1eb3e358",
            "patch": "@@ -421,3 +421,5 @@ vergen = { version = \"9.0.6\", features = [\"cargo\"] }\n vergen-gitcl = { version = \"1.0.8\", features = [\"cargo\"] }\n webbrowser = \"0.8.7\"\n \n+[patch.crates-io]\n+sourcemap = { git = \"https://github.com/kdy1/rust-sourcemap\", branch = \"main\" }"
        },
        {
            "sha": "4ec914595665d6c322950a01493a5a66c2874d13",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bdd2afe733cd8140765cf250002c29aa1eb3e358/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/bdd2afe733cd8140765cf250002c29aa1eb3e358/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=bdd2afe733cd8140765cf250002c29aa1eb3e358",
            "patch": "@@ -28,7 +28,7 @@ petgraph = { workspace = true }\n regex = { workspace = true }\n rustc-hash = { workspace = true }\n serde = { workspace = true }\n-serde_json = { workspace = true }\n+serde_json = { workspace = true, features = [\"raw_value\"] }\n sourcemap = { workspace = true }\n smallvec = { workspace = true }\n strsim = { workspace = true }\n@@ -71,6 +71,7 @@ swc_core = { workspace = true, features = [\n   \"testing\",\n   \"base\",\n ] }\n+bitvec = \"1.0.1\"\n \n [dev-dependencies]\n criterion = { workspace = true, features = [\"async_tokio\"] }"
        },
        {
            "sha": "573f631c6246debbd9b19a5ea408c6449e493455",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 18,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/bdd2afe733cd8140765cf250002c29aa1eb3e358/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdd2afe733cd8140765cf250002c29aa1eb3e358/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=bdd2afe733cd8140765cf250002c29aa1eb3e358",
            "patch": "@@ -105,18 +105,14 @@ pub fn generate_js_source_map(\n     original_source_map: Option<&Rope>,\n     inline_sources_content: bool,\n ) -> Result<Rope> {\n-    let input_map = if let Some(original_source_map) = original_source_map {\n-        Some(match sourcemap::decode(original_source_map.read())? {\n-            sourcemap::DecodedMap::Regular(source_map) => source_map,\n-            // swc only accepts flattened sourcemaps as input\n-            sourcemap::DecodedMap::Index(source_map_index) => source_map_index.flatten()?,\n-            _ => return Err(sourcemap::Error::IncompatibleSourceMap.into()),\n-        })\n+    let original_source_map = original_source_map.map(|x| x.to_bytes());\n+    let input_map = if let Some(original_source_map) = &original_source_map {\n+        Some(sourcemap::lazy::decode(original_source_map)?.into_source_map()?)\n     } else {\n         None\n     };\n \n-    let map = files_map.build_source_map(\n+    let new_mappings = files_map.build_source_map(\n         &mappings,\n         None,\n         InlineSourcesContentConfig {\n@@ -130,18 +126,29 @@ pub fn generate_js_source_map(\n         },\n     );\n \n-    let mut map = match input_map {\n-        Some(mut input_map) => {\n-            input_map.adjust_mappings(&map);\n-            input_map\n+    match input_map {\n+        Some(mut map) => {\n+            // TODO: Make this more efficient\n+            map.adjust_mappings(new_mappings);\n+\n+            // TODO: Enable this when we have a way to handle the ignore list\n+            // add_default_ignore_list(&mut map);\n+            let map = map.into_raw_sourcemap();\n+            let result = serde_json::to_vec(&map)?;\n+            Ok(Rope::from(result))\n         }\n-        None => map,\n-    };\n-    add_default_ignore_list(&mut map);\n+        None => {\n+            // We don't convert sourcemap::SourceMap into raw_sourcemap::SourceMap because we don't\n+            // need to adjust mappings\n+            let mut map = new_mappings;\n+\n+            add_default_ignore_list(&mut map);\n \n-    let mut result = vec![];\n-    map.to_writer(&mut result)?;\n-    Ok(Rope::from(result))\n+            let mut result = vec![];\n+            map.to_writer(&mut result)?;\n+            Ok(Rope::from(result))\n+        }\n+    }\n }\n \n /// A config to generate a source map which includes the source content of every"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 31,
        "deletions": 21
    }
}