{
    "author": "lukesandberg",
    "message": "[turbopack] Attempt #2 at making rust-analyzer happy with our macros (#83461)\n\nWe are experiencing https://github.com/rust-lang/rust-analyzer/issues/19993 and Rust Analyzer is complaining about our macro gencode.  After some trial and error i determined the issue was our use of the `concat!` and specifically the inclusion of the crate name macro so this works around that.\n\nApparently Rust Analyzers implementation of concat! or maybe token tree parsing can get confused by string literals with `-` characters in them.  Simply avoiding that for rust analyzer is a reasonable short term workaround",
    "sha": "6d34793866be9e06a29c171ee5ce268586f3bd11",
    "files": [
        {
            "sha": "07e3ded11908e1868c2291be5ef274824b700780",
            "filename": "turbopack/crates/turbo-tasks-macros/src/global_name.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6d34793866be9e06a29c171ee5ce268586f3bd11/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fglobal_name.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6d34793866be9e06a29c171ee5ce268586f3bd11/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fglobal_name.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fglobal_name.rs?ref=6d34793866be9e06a29c171ee5ce268586f3bd11",
            "patch": "@@ -5,7 +5,7 @@ use quote::quote;\n ///\n /// The name is prefixed with the current crate name and module path\n pub(crate) fn global_name(local_name: impl quote::ToTokens) -> TokenStream {\n-    let crate_name =\n-        std::env::var(\"CARGO_PKG_NAME\").unwrap_or_else(|_| \"unknown_crate\".to_string());\n-    quote! { concat!(#crate_name, \"@\", module_path!(), \"::\", #local_name)}\n+    quote! {\n+        turbo_tasks::macro_helpers::global_name!(#local_name)\n+    }\n }"
        },
        {
            "sha": "39c522752e34b7d07c7528fdb55f882c1a9e228e",
            "filename": "turbopack/crates/turbo-tasks/src/macro_helpers.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/6d34793866be9e06a29c171ee5ce268586f3bd11/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmacro_helpers.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6d34793866be9e06a29c171ee5ce268586f3bd11/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmacro_helpers.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmacro_helpers.rs?ref=6d34793866be9e06a29c171ee5ce268586f3bd11",
            "patch": "@@ -12,7 +12,7 @@ use crate::{\n     ValueTypeId, Vc, debug::ValueDebugFormatString, task::TaskOutput,\n };\n pub use crate::{\n-    inventory_submit,\n+    global_name, inventory_submit,\n     magic_any::MagicAny,\n     manager::{find_cell_by_type, notify_scheduled_tasks, spawn_detached_for_testing},\n     native_function::{\n@@ -199,3 +199,22 @@ macro_rules! inventory_submit {\n /// Exported so the above macro can reference it.\n #[doc(hidden)]\n pub use inventory::submit as inventory_submit_inner;\n+\n+/// Define a global name for a turbo-tasks value.\n+#[cfg(not(rust_analyzer))] // ignore-rust-analyzer due to https://github.com/rust-lang/rust-analyzer/issues/19993\n+#[macro_export]\n+macro_rules! global_name {\n+    ($($item:tt)*) => {\n+\n+        ::std::concat!(::std::env!(\"CARGO_PKG_NAME\"), \"@\", ::std::module_path!(), \"::\", $($item)*)\n+    }\n+}\n+/// Define a global name for a turbo-tasks value.\n+/// This has a dummy implementation for Rust Analyzer to avoid https://github.com/rust-lang/rust-analyzer/issues/19993\n+#[cfg(rust_analyzer)]\n+#[macro_export]\n+macro_rules! global_name {\n+    ($($item:tt)*) => {\n+        $($item)*\n+    }\n+}"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 23,
        "deletions": 4
    }
}