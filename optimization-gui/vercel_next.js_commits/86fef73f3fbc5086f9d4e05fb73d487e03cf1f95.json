{
    "author": "eps1lon",
    "message": "[dev-overlay] Stop stashing React error details on error instances (#77975)",
    "sha": "86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
    "files": [
        {
            "sha": "d8f0471bd5a3212a4b9ef1be788afe95b18d4577",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -670,5 +670,6 @@\n   \"669\": \"Invariant: --turbopack is set but the build used Webpack\",\n   \"670\": \"Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \\\"next start\\\".\",\n   \"671\": \"Specified images.remotePatterns must have protocol \\\"http\\\" or \\\"https\\\" received \\\"%s\\\".\",\n-  \"672\": \"Expected `telemetry` to be set in globals\"\n+  \"672\": \"Expected `telemetry` to be set in globals\",\n+  \"673\": \"Thrown value was ignored. This is a bug in Next.js.\"\n }"
        },
        {
            "sha": "a6dc58a62b7d3df2710714f668be8109247551da",
            "filename": "packages/next/src/client/components/errors/stitched-error.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 39,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fstitched-error.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -1,48 +1,34 @@\n import React from 'react'\n import isError from '../../../lib/is-error'\n-import { copyNextErrorCode } from '../../../lib/error-telemetry-utils'\n \n-const REACT_ERROR_STACK_BOTTOM_FRAME = 'react-stack-bottom-frame'\n-const REACT_ERROR_STACK_BOTTOM_FRAME_REGEX = new RegExp(\n-  `(at ${REACT_ERROR_STACK_BOTTOM_FRAME} )|(${REACT_ERROR_STACK_BOTTOM_FRAME}\\\\@)`\n-)\n+const ownerStacks = new WeakMap<Error, string | null>()\n+const componentStacks = new WeakMap<Error, string>()\n \n-export function getReactStitchedError<T = unknown>(err: T): Error | T {\n-  const isErrorInstance = isError(err)\n-  const originStack = isErrorInstance ? err.stack || '' : ''\n-  const originMessage = isErrorInstance ? err.message : ''\n-  const stackLines = originStack.split('\\n')\n-  const indexOfSplit = stackLines.findIndex((line) =>\n-    REACT_ERROR_STACK_BOTTOM_FRAME_REGEX.test(line)\n-  )\n-  const isOriginalReactError = indexOfSplit >= 0 // has the react-stack-bottom-frame\n-  let newStack = isOriginalReactError\n-    ? stackLines.slice(0, indexOfSplit).join('\\n')\n-    : originStack\n-\n-  const newError = new Error(originMessage)\n-  // Copy all enumerable properties, e.g. digest\n-  Object.assign(newError, err)\n-  copyNextErrorCode(err, newError)\n-  newError.stack = newStack\n-\n-  // Avoid duplicate overriding stack frames\n-  appendOwnerStack(newError)\n+export function getComponentStack(error: Error): string | undefined {\n+  return componentStacks.get(error)\n+}\n+export function setComponentStack(error: Error, stack: string) {\n+  componentStacks.set(error, stack)\n+}\n \n-  return newError\n+export function getOwnerStack(error: Error): string | null | undefined {\n+  return ownerStacks.get(error)\n+}\n+export function setOwnerStack(error: Error, stack: string | null) {\n+  ownerStacks.set(error, stack)\n }\n \n-function appendOwnerStack(error: Error) {\n-  if (!React.captureOwnerStack) {\n-    return\n-  }\n-  let stack = error.stack || ''\n-  // This module is only bundled in development mode so this is safe.\n-  const ownerStack = React.captureOwnerStack()\n-  // Avoid duplicate overriding stack frames\n-  if (ownerStack && stack.endsWith(ownerStack) === false) {\n-    stack += ownerStack\n-    // Override stack\n-    error.stack = stack\n+export function getReactStitchedError(err: unknown): Error {\n+  const newError = isError(err)\n+    ? err\n+    : // TODO: stringify thrown value\n+      new Error('Thrown value was ignored. This is a bug in Next.js.')\n+\n+  // React 18 and prod does not have `captureOwnerStack`\n+  if ('captureOwnerStack' in React) {\n+    // TODO: Hoist these to callsites to ensure we set the correct Owner Stack.\n+    setOwnerStack(newError, React.captureOwnerStack())\n   }\n+\n+  return newError\n }"
        },
        {
            "sha": "9213b8d899d6598a651a4bb1aa16a1c24d9c3c26",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -40,7 +40,7 @@ import type {\n import { REACT_REFRESH_FULL_RELOAD_FROM_ERROR } from '../shared'\n import type { DebugInfo } from '../types'\n import { useUntrackedPathname } from '../../navigation-untracked'\n-import { getReactStitchedError } from '../../errors/stitched-error'\n+import { getComponentStack, getOwnerStack } from '../../errors/stitched-error'\n import { handleDevBuildIndicatorHmrEvents } from '../../../dev/dev-build-indicator/internal/handle-dev-build-indicator-hmr-events'\n import type { GlobalErrorComponent } from '../../error-boundary'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n@@ -517,28 +517,29 @@ export default function HotReload({\n   const handleOnUnhandledError = useCallback(\n     (error: Error): void => {\n       // Component stack is added to the error in use-error-handler in case there was a hydration error\n-      const componentStackTrace = (error as any)._componentStack\n+      const componentStack = getComponentStack(error)\n+      const ownerStack = getOwnerStack(error)\n \n       dispatch({\n         type: ACTION_UNHANDLED_ERROR,\n         reason: error,\n-        frames: parseStack(error.stack || ''),\n+        frames: parseStack((error.stack || '') + (ownerStack || '')),\n         componentStackFrames:\n-          typeof componentStackTrace === 'string'\n-            ? parseComponentStack(componentStackTrace)\n+          typeof componentStack === 'string'\n+            ? parseComponentStack(componentStack)\n             : undefined,\n       })\n     },\n     [dispatch]\n   )\n \n   const handleOnUnhandledRejection = useCallback(\n-    (reason: Error): void => {\n-      const stitchedError = getReactStitchedError(reason)\n+    (error: Error): void => {\n+      const ownerStack = getOwnerStack(error)\n       dispatch({\n         type: ACTION_UNHANDLED_REJECTION,\n-        reason: stitchedError,\n-        frames: parseStack(stitchedError.stack || ''),\n+        reason: error,\n+        frames: parseStack((error.stack || '') + (ownerStack || '')),\n       })\n     },\n     [dispatch]"
        },
        {
            "sha": "38b64acb514fbae2ddc6a47c2cc78ece1eb062e9",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/client.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -15,6 +15,7 @@ import {\n } from '../shared'\n import type { VersionInfo } from '../../../../server/dev/parse-version-info'\n import { attachHydrationErrorState } from '../../errors/attach-hydration-error-state'\n+import { getComponentStack, getOwnerStack } from '../../errors/stitched-error'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n \n let isRegistered = false\n@@ -27,7 +28,8 @@ function handleError(error: unknown) {\n \n   attachHydrationErrorState(error)\n \n-  const componentStackTrace = (error as any)._componentStack\n+  const componentStackTrace = getComponentStack(error)\n+  const ownerStack = getOwnerStack(error)\n   const componentStackFrames =\n     typeof componentStackTrace === 'string'\n       ? parseComponentStack(componentStackTrace)\n@@ -42,7 +44,7 @@ function handleError(error: unknown) {\n     Bus.emit({\n       type: ACTION_UNHANDLED_ERROR,\n       reason: error,\n-      frames: parseStack(error.stack),\n+      frames: parseStack((error.stack || '') + (ownerStack || '')),\n       componentStackFrames,\n     })\n   }\n@@ -73,11 +75,12 @@ function onUnhandledRejection(ev: PromiseRejectionEvent) {\n     return\n   }\n \n-  const e = reason\n+  const error = reason\n+  const ownerStack = getOwnerStack(error)\n   Bus.emit({\n     type: ACTION_UNHANDLED_REJECTION,\n     reason: reason,\n-    frames: parseStack(e.stack!),\n+    frames: parseStack((error.stack || '') + (ownerStack || '')),\n   })\n }\n "
        },
        {
            "sha": "572216777ea26ce6f46116a1b06029fd036009e7",
            "filename": "packages/next/src/client/components/react-dev-overlay/shared.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 7,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -7,6 +7,7 @@ import type { ComponentStackFrame } from './utils/parse-component-stack'\n import type { DebugInfo } from './types'\n import type { DevIndicatorServerState } from '../../../server/dev/dev-indicator-server-state'\n import type { HMR_ACTION_TYPES } from '../../../server/dev/hot-reloader-types'\n+import { getOwnerStack } from '../errors/stitched-error'\n \n type FastRefreshState =\n   /** No refresh in progress. */\n@@ -101,17 +102,35 @@ export type BusEvent =\n   | DebugInfoAction\n   | DevIndicatorAction\n \n+const REACT_ERROR_STACK_BOTTOM_FRAME_REGEX =\n+  // 1st group: v8\n+  // 2nd group: SpiderMonkey, JavaScriptCore\n+  /\\s+(at react-stack-bottom-frame.*)|(react-stack-bottom-frame@.*)/\n+\n+// React calls user code starting from a special stack frame.\n+// The basic stack will be different if the same error location is hit again\n+// due to StrictMode.\n+// This gets only the stack after React which is unaffected by StrictMode.\n+function getStackIgnoringStrictMode(stack: string | undefined) {\n+  return stack?.split(REACT_ERROR_STACK_BOTTOM_FRAME_REGEX)[0]\n+}\n+\n function pushErrorFilterDuplicates(\n   errors: SupportedErrorEvent[],\n   err: SupportedErrorEvent\n ): SupportedErrorEvent[] {\n-  return [\n-    ...errors.filter((e) => {\n-      // Filter out duplicate errors\n-      return e.event.reason.stack !== err.event.reason.stack\n-    }),\n-    err,\n-  ]\n+  const pendingErrors = errors.filter((e) => {\n+    // Filter out duplicate errors\n+    return (\n+      (e.event.reason.stack !== err.event.reason.stack &&\n+        // TODO: Let ReactDevTools control deduping instead?\n+        getStackIgnoringStrictMode(e.event.reason.stack) !==\n+          getStackIgnoringStrictMode(err.event.reason.stack)) ||\n+      getOwnerStack(e.event.reason) !== getOwnerStack(err.event.reason)\n+    )\n+  })\n+  pendingErrors.push(err)\n+  return pendingErrors\n }\n \n const shouldDisableDevIndicator ="
        },
        {
            "sha": "9918d5574ecb748191a8a8bd1fcb5130f529ff5f",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/parse-stack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fparse-stack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fparse-stack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fparse-stack.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -3,7 +3,7 @@ import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n \n const regexNextStatic = /\\/_next(\\/static\\/.+)/\n \n-export function parseStack(stack: string | undefined): StackFrame[] {\n+export function parseStack(stack: string): StackFrame[] {\n   if (!stack) return []\n \n   // throw away eval information that stacktrace-parser doesn't support"
        },
        {
            "sha": "3b8cb33ca4773ae94f890f5f97e0f8291c3724a8",
            "filename": "packages/next/src/client/react-client-callbacks/error-boundary-callbacks.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -1,7 +1,10 @@\n // This file is only used in app router due to the specific error state handling.\n \n import type { ErrorInfo } from 'react'\n-import { getReactStitchedError } from '../components/errors/stitched-error'\n+import {\n+  getReactStitchedError,\n+  setComponentStack,\n+} from '../components/errors/stitched-error'\n import { handleClientError } from '../components/errors/use-error-handler'\n import { isNextRouterError } from '../components/is-next-router-error'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n@@ -73,7 +76,7 @@ export function onCaughtError(\n     // TODO: change to passing down errorInfo later\n     // In development mode, pass along the component stack to the error\n     if (errorInfo.componentStack) {\n-      ;(stitchedError as any)._componentStack = errorInfo.componentStack\n+      setComponentStack(stitchedError, errorInfo.componentStack)\n     }\n \n     // Log and report the error with location but without modifying the error stack\n@@ -94,7 +97,7 @@ export function onUncaughtError(err: unknown, errorInfo: React.ErrorInfo) {\n     // TODO: change to passing down errorInfo later\n     // In development mode, pass along the component stack to the error\n     if (errorInfo.componentStack) {\n-      ;(stitchedError as any)._componentStack = errorInfo.componentStack\n+      setComponentStack(stitchedError, errorInfo.componentStack)\n     }\n \n     // TODO: Add an adendum to the overlay telling people about custom error boundaries."
        },
        {
            "sha": "0a8765cb05d8128b2c52b5f786cec09a49b4b300",
            "filename": "packages/next/src/client/react-client-callbacks/on-recoverable-error.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -3,7 +3,10 @@\n import type { HydrationOptions } from 'react-dom/client'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n import { reportGlobalError } from './report-global-error'\n-import { getReactStitchedError } from '../components/errors/stitched-error'\n+import {\n+  getReactStitchedError,\n+  setComponentStack,\n+} from '../components/errors/stitched-error'\n import isError from '../../lib/is-error'\n \n export const onRecoverableError: HydrationOptions['onRecoverableError'] = (\n@@ -13,9 +16,8 @@ export const onRecoverableError: HydrationOptions['onRecoverableError'] = (\n   // x-ref: https://github.com/facebook/react/pull/28736\n   const cause = isError(error) && 'cause' in error ? error.cause : error\n   const stitchedError = getReactStitchedError(cause)\n-  // In development mode, pass along the component stack to the error\n   if (process.env.NODE_ENV === 'development' && errorInfo.componentStack) {\n-    ;(stitchedError as any)._componentStack = errorInfo.componentStack\n+    setComponentStack(stitchedError, errorInfo.componentStack)\n   }\n   // Skip certain custom errors which are not expected to be reported on client\n   if (isBailoutToCSRError(cause)) return"
        },
        {
            "sha": "e84bf9845c7839136f83eaaa11fee1f5a287b39d",
            "filename": "packages/next/src/lib/error-telemetry-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Flib%2Ferror-telemetry-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/packages%2Fnext%2Fsrc%2Flib%2Ferror-telemetry-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ferror-telemetry-utils.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -22,21 +22,6 @@ export const createDigestWithErrorCode = (\n   return originalDigest\n }\n \n-/**\n- * Copies the error code from one error to another by setting the __NEXT_ERROR_CODE property.\n- * This allows error codes to be preserved when wrapping or transforming errors.\n- */\n-export const copyNextErrorCode = (source: unknown, target: unknown): void => {\n-  const errorCode = extractNextErrorCode(source)\n-  if (errorCode && typeof target === 'object' && target !== null) {\n-    Object.defineProperty(target, '__NEXT_ERROR_CODE', {\n-      value: errorCode,\n-      enumerable: false,\n-      configurable: true,\n-    })\n-  }\n-}\n-\n export const extractNextErrorCode = (error: unknown): string | undefined => {\n   if (\n     typeof error === 'object' &&"
        },
        {
            "sha": "a2de1768765a8bde593083f51c34f5102e599951",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -949,6 +949,8 @@ describe('ReactRefreshLogBox app', () => {\n     )\n \n     if (isTurbopack) {\n+      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n+      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Error: test\",\n@@ -960,6 +962,9 @@ describe('ReactRefreshLogBox app', () => {\n            |           ^\",\n          \"stack\": [\n            \"{default export} index.js (3:11)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n            \"Page app/page.js (2:1)\",\n          ],\n        }\n@@ -1050,6 +1055,8 @@ describe('ReactRefreshLogBox app', () => {\n     // Render error should \"win\" and show up in fullscreen\n     // TODO(veil): Why Owner Stack location different?\n     if (isTurbopack) {\n+      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n+      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Error: Component error\",\n@@ -1060,6 +1067,9 @@ describe('ReactRefreshLogBox app', () => {\n            |                                            ^\",\n          \"stack\": [\n            \"Index index.js (2:44)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n            \"Page index.js (16:8)\",\n          ],\n        }"
        },
        {
            "sha": "4d9e06ebe9609a5b21f8748566b57ff50073d568",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -261,6 +261,7 @@ describe('Error recovery app', () => {\n     ).toBe('1')\n \n     if (isTurbopack) {\n+      // TODO(veil): Location of Page should be app/page.js\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"description\": \"Error: oops\",\n@@ -280,7 +281,6 @@ describe('Error recovery app', () => {\n        }\n       `)\n     } else {\n-      // TODO(veil): Location of Page should be app/page.js\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"description\": \"Error: oops\",\n@@ -450,6 +450,8 @@ describe('Error recovery app', () => {\n     )\n \n     if (isTurbopack) {\n+      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n+      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Error: oops\",\n@@ -460,6 +462,9 @@ describe('Error recovery app', () => {\n            |         ^\",\n          \"stack\": [\n            \"Child child.js (3:9)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n            \"Index index.js (6:7)\",\n            \"<FIXME-file-protocol>\",\n          ],\n@@ -687,16 +692,21 @@ describe('Error recovery app', () => {\n \n     // We get an error because Foo didn't import React. Fair.\n     if (isTurbopack) {\n+      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n+      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Error: React is not defined\",\n+         \"description\": \"ReferenceError: React is not defined\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n          \"source\": \"Foo.js (3:3) @ Foo\n        > 3 |   return React.createElement('h1', null, 'Foo');\n            |   ^\",\n          \"stack\": [\n            \"Foo Foo.js (3:3)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n            \"FunctionDefault index.js (4:10)\",\n            \"<FIXME-file-protocol>\",\n          ],\n@@ -705,7 +715,7 @@ describe('Error recovery app', () => {\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n-         \"description\": \"Error: React is not defined\",\n+         \"description\": \"ReferenceError: React is not defined\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n          \"source\": \"Foo.js (3:3) @ Foo\n@@ -888,6 +898,9 @@ describe('Error recovery app', () => {\n       `\n     )\n     if (isTurbopack) {\n+      // TODO(veil): Location of Page should be app/page.js\n+      // Set.forEach: https://linear.app/vercel/issue/NDX-554/\n+      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Error: nooo\",\n@@ -898,6 +911,9 @@ describe('Error recovery app', () => {\n            |           ^\",\n          \"stack\": [\n            \"ClassDefault.render index.js (5:11)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n            \"Page index.js (10:16)\",\n          ],\n        }"
        },
        {
            "sha": "2132097b5389a1ccda349ffdab574ff0f7fb9b19",
            "filename": "test/development/app-dir/owner-stack/owner-stack.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 27,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/86fef73f3fbc5086f9d4e05fb73d487e03cf1f95/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts?ref=86fef73f3fbc5086f9d4e05fb73d487e03cf1f95",
            "patch": "@@ -1,19 +1,22 @@\n import { nextTestSetup } from 'e2e-utils'\n import { assertNoRedbox, retry } from 'next-test-utils'\n \n-// Remove the location `()` part in every line of stack trace;\n-// Remove the leading spaces in every line of stack trace;\n-// Remove the trailing spaces in every line of stack trace;\n // These stacks are not sourcemapped and therefore not ignore-listed.\n // Feel free to update internal frames in assertions.\n function normalizeBrowserConsoleStackTrace(trace: unknown) {\n   if (typeof trace !== 'string') {\n     return trace\n   }\n-  return trace\n-    .replace(/\\(.*\\)/g, '')\n-    .replace(/^\\s+/gm, '')\n-    .trim()\n+  return (\n+    trace\n+      // Removes React's internals i.e. incomplete ignore-listing\n+      .split(/at react-stack-bottom-frame.*/m)[0]\n+      // Remove the location `()` part in every line of stack trace;\n+      .replace(/\\(.*\\)/g, '')\n+      // Remove the leading spaces in every line of stack trace;\n+      .replace(/^\\s+/gm, '')\n+      .trim()\n+  )\n }\n \n describe('app-dir - owner-stack', () => {\n@@ -74,8 +77,7 @@ describe('app-dir - owner-stack', () => {\n      \"Error: browser error\n      at useThrowError \n      at useErrorHook \n-     at Page \n-     at ClientPageRoot\"\n+     at Page\"\n     `)\n   })\n \n@@ -108,22 +110,11 @@ describe('app-dir - owner-stack', () => {\n     `)\n \n     expect(normalizeBrowserConsoleStackTrace(errorLog)).toMatchInlineSnapshot(`\n-      \"%o\n-      %s Error: browser error\n-      at useThrowError \n-      at useErrorHook \n-      at Thrower \n-      at react-stack-bottom-frame \n-      at renderWithHooks \n-      at updateFunctionComponent \n-      at beginWork \n-      at runWithFiberInDEV \n-      at performUnitOfWork \n-      at workLoopSync \n-      at renderRootSync \n-      at performWorkOnRoot \n-      at performWorkOnRootViaSchedulerTask \n-      at MessagePort.performWorkUntilDeadline  The above error occurred in the <Thrower> component. It was handled by the <MyErrorBoundary> error boundary.\"\n+     \"%o\n+     %s Error: browser error\n+     at useThrowError \n+     at useErrorHook \n+     at Thrower\"\n     `)\n   })\n \n@@ -158,8 +149,7 @@ describe('app-dir - owner-stack', () => {\n      \"Error: ssr error\n      at useThrowError \n      at useErrorHook \n-     at Page \n-     at ClientPageRoot\"\n+     at Page\"\n     `)\n   })\n "
        }
    ],
    "stats": {
        "total": 240,
        "additions": 128,
        "deletions": 112
    }
}