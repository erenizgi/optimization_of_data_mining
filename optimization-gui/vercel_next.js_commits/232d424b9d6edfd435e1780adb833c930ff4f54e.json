{
    "author": "gnoff",
    "message": "[Cache Components] Do not automatically client render useSearchParams… (#83048)\n\n… when prerendering\n\nuseSearchParams historically always bailed out to client side rendering\nwhen prerendering. The idea was that reading search params shouldn't\ndeopt a page from static so instead it simply omitted prerendering any\nboundary with this hook inside of it. With Cache Components every page\ncan be partially static so there is no huge perf cliff in adding this\nhook to any particular component. Additionally since client components\ncannot make a page be dynamic independently (something in the RSC layer\nmust be) using this on an otherwise fully static page will still just\nresult in the current client-only rendering behavior. But if you use\nuseSearchParams on a page that has dynamic RSC it will now SSR when\nresuming.",
    "sha": "232d424b9d6edfd435e1780adb833c930ff4f54e",
    "files": [
        {
            "sha": "8a043b87a2b7ef45a4591183f68b241eeea950c6",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=232d424b9d6edfd435e1780adb833c930ff4f54e",
            "patch": "@@ -792,5 +792,6 @@\n   \"791\": \"Unexpected match for a pathname \\\"%s\\\" with a param \\\"%s\\\" of type \\\"%s\\\"\",\n   \"792\": \"Unexpected empty path segments match for a pathname \\\"%s\\\" with param \\\"%s\\\" of type \\\"%s\\\"\",\n   \"793\": \"No value found for segment key: \\\"%s\\\"\",\n-  \"794\": \"Invalid <Link> with <a> child. Please remove <a>.\\nLearn more: https://nextjs.org/docs/messages/invalid-new-link-with-extra-anchor\"\n+  \"794\": \"Invalid <Link> with <a> child. Please remove <a>.\\nLearn more: https://nextjs.org/docs/messages/invalid-new-link-with-extra-anchor\",\n+  \"795\": \"\\\\`%s\\\\` was called from a Server Component. Next.js should be preventing %s from being included in server components statically, but did not in this case.\"\n }"
        },
        {
            "sha": "7041bfe67a24a01940de7e34af18c851e6f8a14b",
            "filename": "packages/next/src/client/components/bailout-to-client-rendering.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f205a6a5c09ad80cf2e2cf49c457234df6d84710/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f205a6a5c09ad80cf2e2cf49c457234df6d84710/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts?ref=f205a6a5c09ad80cf2e2cf49c457234df6d84710",
            "patch": "@@ -1,29 +0,0 @@\n-import { BailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n-import { workAsyncStorage } from '../../server/app-render/work-async-storage.external'\n-import { workUnitAsyncStorage } from '../../server/app-render/work-unit-async-storage.external'\n-\n-export function bailoutToClientRendering(reason: string): void | never {\n-  const workStore = workAsyncStorage.getStore()\n-\n-  if (workStore?.forceStatic) return\n-\n-  const workUnitStore = workUnitAsyncStorage.getStore()\n-\n-  if (workUnitStore) {\n-    switch (workUnitStore.type) {\n-      case 'prerender':\n-      case 'prerender-runtime':\n-      case 'prerender-client':\n-      case 'prerender-ppr':\n-      case 'prerender-legacy':\n-        throw new BailoutToCSRError(reason)\n-      case 'request':\n-      case 'cache':\n-      case 'private-cache':\n-      case 'unstable-cache':\n-        break\n-      default:\n-        workUnitStore satisfies never\n-    }\n-  }\n-}"
        },
        {
            "sha": "f4787d2f1ae1c21fb12dda78f00ea86cde11f946",
            "filename": "packages/next/src/client/components/navigation.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts?ref=232d424b9d6edfd435e1780adb833c930ff4f54e",
            "patch": "@@ -23,6 +23,13 @@ const useDynamicRouteParams =\n       ).useDynamicRouteParams\n     : undefined\n \n+const useDynamicSearchParams =\n+  typeof window === 'undefined'\n+    ? (\n+        require('../../server/app-render/dynamic-rendering') as typeof import('../../server/app-render/dynamic-rendering')\n+      ).useDynamicSearchParams\n+    : undefined\n+\n /**\n  * A [Client Component](https://nextjs.org/docs/app/building-your-application/rendering/client-components) hook\n  * that lets you *read* the current URL's search parameters.\n@@ -45,6 +52,8 @@ const useDynamicRouteParams =\n  */\n // Client components API\n export function useSearchParams(): ReadonlyURLSearchParams {\n+  useDynamicSearchParams?.('useSearchParams()')\n+\n   const searchParams = useContext(SearchParamsContext)\n \n   // In the case where this is `null`, the compat types added in\n@@ -60,14 +69,6 @@ export function useSearchParams(): ReadonlyURLSearchParams {\n     return new ReadonlyURLSearchParams(searchParams)\n   }, [searchParams]) as ReadonlyURLSearchParams\n \n-  if (typeof window === 'undefined') {\n-    // AsyncLocalStorage should not be included in the client bundle.\n-    const { bailoutToClientRendering } =\n-      require('./bailout-to-client-rendering') as typeof import('./bailout-to-client-rendering')\n-    // TODO-APP: handle dynamic = 'force-static' here and on the client\n-    bailoutToClientRendering('useSearchParams()')\n-  }\n-\n   return readonlySearchParams\n }\n "
        },
        {
            "sha": "973fa21590ed19c9e74b392c10df36a43f66a8e5",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/232d424b9d6edfd435e1780adb833c930ff4f54e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=232d424b9d6edfd435e1780adb833c930ff4f54e",
            "patch": "@@ -36,6 +36,7 @@ import { DynamicServerError } from '../../client/components/hooks-server-context\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n import {\n   getRuntimeStagePromise,\n+  throwForMissingRequestStore,\n   workUnitAsyncStorage,\n } from './work-unit-async-storage.external'\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n@@ -640,6 +641,55 @@ export function useDynamicRouteParams(expression: string) {\n   }\n }\n \n+export function useDynamicSearchParams(expression: string) {\n+  const workStore = workAsyncStorage.getStore()\n+  const workUnitStore = workUnitAsyncStorage.getStore()\n+\n+  if (!workStore) {\n+    // We assume pages router context and just return\n+    return\n+  }\n+\n+  if (!workUnitStore) {\n+    throwForMissingRequestStore(expression)\n+  }\n+\n+  switch (workUnitStore.type) {\n+    case 'prerender-client': {\n+      React.use(\n+        makeHangingPromise(\n+          workUnitStore.renderSignal,\n+          workStore.route,\n+          expression\n+        )\n+      )\n+      break\n+    }\n+    case 'prerender-legacy':\n+    case 'prerender-ppr': {\n+      if (workStore.forceStatic) {\n+        return\n+      }\n+      throw new BailoutToCSRError(expression)\n+    }\n+    case 'prerender':\n+    case 'prerender-runtime':\n+      throw new InvariantError(\n+        `\\`${expression}\\` was called from a Server Component. Next.js should be preventing ${expression} from being included in server components statically, but did not in this case.`\n+      )\n+    case 'cache':\n+    case 'unstable-cache':\n+    case 'private-cache':\n+      throw new InvariantError(\n+        `\\`${expression}\\` was called inside a cache scope. Next.js should be preventing ${expression} from being included in server components statically, but did not in this case.`\n+      )\n+    case 'request':\n+      return\n+    default:\n+      workUnitStore satisfies never\n+  }\n+}\n+\n const hasSuspenseRegex = /\\n\\s+at Suspense \\(<anonymous>\\)/\n \n // Common implicit body tags that React will treat as body when placed directly in html"
        },
        {
            "sha": "fd06f874a07340066772bb542a68715b4eafde94",
            "filename": "test/e2e/app-dir/missing-suspense-with-csr-bailout/missing-suspense-with-csr-bailout.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/232d424b9d6edfd435e1780adb833c930ff4f54e/test%2Fe2e%2Fapp-dir%2Fmissing-suspense-with-csr-bailout%2Fmissing-suspense-with-csr-bailout.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/232d424b9d6edfd435e1780adb833c930ff4f54e/test%2Fe2e%2Fapp-dir%2Fmissing-suspense-with-csr-bailout%2Fmissing-suspense-with-csr-bailout.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmissing-suspense-with-csr-bailout%2Fmissing-suspense-with-csr-bailout.test.ts?ref=232d424b9d6edfd435e1780adb833c930ff4f54e",
            "patch": "@@ -21,8 +21,13 @@ describe('missing-suspense-with-csr-bailout', () => {\n     await next.clean()\n   })\n \n+  const isCacheComponentsEnabled =\n+    process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n+\n   describe('useSearchParams', () => {\n-    const message = `useSearchParams() should be wrapped in a suspense boundary at page \"/\".`\n+    const message = isCacheComponentsEnabled\n+      ? `Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense`\n+      : `useSearchParams() should be wrapped in a suspense boundary at page \"/\".`\n \n     it('should fail build if useSearchParams is not wrapped in a suspense boundary', async () => {\n       const { exitCode } = await next.build()"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 67,
        "deletions": 39
    }
}