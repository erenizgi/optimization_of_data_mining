{
    "author": "Anas-github-acc",
    "message": "fix patch-next by adding missing script (#81430)\n\nThe `patch-next.cjs` script is failing because two of its dependencies,\n`pack-util` and `build-native`, are missing their CommonJS versions,\nwhich are required for compatibility with the current Node.js\nenvironment. To fix this, i added the transpiled `pack-util.js` and\n`build-native.js` files.\n\n---------\n\nCo-authored-by: graphite-app[bot] <96075541+graphite-app[bot]@users.noreply.github.com>\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>",
    "sha": "d0ea7129747a045450c646cc0e4ea4f84348bd32",
    "files": [
        {
            "sha": "a15bb03debe4ba7a77d02911c7d97848d8e19b0c",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ea7129747a045450c646cc0e4ea4f84348bd32/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ea7129747a045450c646cc0e4ea4f84348bd32/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=d0ea7129747a045450c646cc0e4ea4f84348bd32",
            "patch": "@@ -70,7 +70,7 @@\n     \"prepare\": \"husky\",\n     \"sync-react\": \"node ./scripts/sync-react.js\",\n     \"update-google-fonts\": \"node ./scripts/update-google-fonts.js\",\n-    \"patch-next\": \"node scripts/patch-next.cjs\",\n+    \"patch-next\": \"tsx scripts/patch-next.ts\",\n     \"unpack-next\": \"tsx scripts/unpack-next.ts\",\n     \"swc-build-native\": \"tsx scripts/build-native.ts\",\n     \"swc-build-wasm\": \"tsx scripts/build-wasm.cjs\","
        },
        {
            "sha": "7dd5c432db35e6bd2215bfbcbfe826908a0e0b14",
            "filename": "scripts/pack-next.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ea7129747a045450c646cc0e4ea4f84348bd32/scripts%2Fpack-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ea7129747a045450c646cc0e4ea4f84348bd32/scripts%2Fpack-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpack-next.ts?ref=d0ea7129747a045450c646cc0e4ea4f84348bd32",
            "patch": "@@ -2,6 +2,7 @@\n \n import fs from 'node:fs/promises'\n import yargs from 'yargs'\n+import { hideBin } from 'yargs/helpers'\n import { default as patchPackageJson } from './pack-utils/patch-package-json.js'\n import buildNative from './build-native.js'\n \n@@ -31,7 +32,8 @@ interface CliOptions {\n   _: string[]\n }\n \n-const cliOptions = yargs(process.argv.slice(2))\n+const cliOptions = yargs(hideBin(process.argv))\n+  .scriptName('pack-next')\n   .command('$0')\n   .option('js-build', {\n     type: 'boolean',"
        },
        {
            "sha": "b1cce71e1b1e7fe8a3aefd248b17838ba877bb36",
            "filename": "scripts/patch-next.cjs",
            "status": "removed",
            "additions": 0,
            "deletions": 79,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/e210360bb9d66870f69d35512a3d317cb68147ec/scripts%2Fpatch-next.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/e210360bb9d66870f69d35512a3d317cb68147ec/scripts%2Fpatch-next.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpatch-next.cjs?ref=e210360bb9d66870f69d35512a3d317cb68147ec",
            "patch": "@@ -1,79 +0,0 @@\n-#!/usr/bin/env node\n-\n-const {\n-  NEXT_DIR,\n-  exec,\n-  execFn,\n-  booleanArg,\n-  packageFiles,\n-} = require('./pack-util.cjs')\n-const fs = require('fs')\n-const path = require('path')\n-\n-/** @type {string[]} */\n-const argv = process.argv\n-const args = argv.slice(2)\n-\n-const NEXT_PACKAGES = `${NEXT_DIR}/packages`\n-\n-const noBuild = booleanArg(args, '--no-build')\n-const noNativeBuild = booleanArg(args, '--no-native-build')\n-\n-const PROJECT_DIR = path.resolve(args[0])\n-\n-function realPathIfAny(path) {\n-  try {\n-    return fs.realpathSync(path)\n-  } catch {\n-    return null\n-  }\n-}\n-\n-async function copy(src, dst) {\n-  const realDst = realPathIfAny(dst)\n-  if (!realDst) {\n-    return\n-  }\n-\n-  const files = await packageFiles(src)\n-\n-  for (const file of files) {\n-    fs.cpSync(path.join(src, file), path.join(realDst, file), {\n-      recursive: true,\n-    })\n-  }\n-}\n-\n-async function main() {\n-  if (!noBuild) {\n-    exec('Install Next.js build dependencies', 'pnpm i')\n-    exec('Build Next.js', 'pnpm run build')\n-  }\n-\n-  if (!noNativeBuild) {\n-    process.argv = [...process.argv.slice(0, 2), ...args.slice(1)]\n-\n-    await require('./build-native.cjs')\n-  }\n-\n-  await execFn('Patching next', () =>\n-    copy(`${NEXT_PACKAGES}/next`, `${PROJECT_DIR}/node_modules/next`)\n-  )\n-  await execFn('Patching @next/swc', () =>\n-    copy(`${NEXT_PACKAGES}/next-swc`, `${PROJECT_DIR}/node_modules/@next/swc`)\n-  )\n-  await execFn('Patching @next/mdx', () =>\n-    copy(`${NEXT_PACKAGES}/next-mdx`, `${PROJECT_DIR}/node_modules/@next/mdx`)\n-  )\n-  await execFn('Patching @next/bundle-analyzer', () =>\n-    copy(\n-      `${NEXT_PACKAGES}/next-bundle-analyzer`,\n-      `${PROJECT_DIR}/node_modules/@next/bundle-anlyzer`\n-    )\n-  )\n-}\n-\n-main().catch((e) => {\n-  console.error(e)\n-  process.exit(1)\n-})"
        },
        {
            "sha": "d80c2f5987c0ed13fa347849e34774f850fe13d4",
            "filename": "scripts/patch-next.ts",
            "status": "added",
            "additions": 178,
            "deletions": 0,
            "changes": 178,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ea7129747a045450c646cc0e4ea4f84348bd32/scripts%2Fpatch-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ea7129747a045450c646cc0e4ea4f84348bd32/scripts%2Fpatch-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpatch-next.ts?ref=d0ea7129747a045450c646cc0e4ea4f84348bd32",
            "patch": "@@ -0,0 +1,178 @@\n+// the script must be run with tsx\n+\n+import fs from 'fs'\n+import yargs from 'yargs'\n+import { hideBin } from 'yargs/helpers'\n+import path from 'path'\n+\n+import { NEXT_DIR, exec, execFn, packageFiles } from './pack-util.js'\n+import buildNative from './build-native.js'\n+\n+interface Options {\n+  project: string\n+  build: boolean\n+  noBuild: boolean\n+  buildNative: boolean\n+  noNativeBuild: boolean\n+  verbose: number\n+  _: string[]\n+}\n+\n+// --- Parse command line arguments ---\n+const argv = yargs(hideBin(process.argv))\n+  .scriptName('patch-next')\n+  .usage(\n+    '$0 <project> [..options]',\n+    'Patch Local Next.js packages to the target project directory',\n+    (yargs: any) => {\n+      yargs\n+        .positional('project', {\n+          type: 'string',\n+          describe: ': Target directory of the Next.js Project to patch',\n+          nargs: 1,\n+        })\n+        .example(\n+          '$0 ../my-app --no-build --no-build-native',\n+          'Patch Next.js packages in the \"my-app\" directory'\n+        )\n+        .example(\n+          '$0 ../my-app -- --release',\n+          'Patch using a release-mode native build. `--release` is passed through to the napi CLI'\n+        )\n+    }\n+  )\n+  .option('build', {\n+    type: 'boolean',\n+    default: true,\n+    description: 'Run the Next.js build step (`pnpm i` and `pnpm build`).',\n+  })\n+  .option('build-native', {\n+    alias: 'native-build',\n+    type: 'boolean',\n+    default: true,\n+    description: 'Run the native modules build step.',\n+  })\n+  .option('verbose', {\n+    type: 'number',\n+    choices: [0, 1, 2, 3],\n+    count: true,\n+    alias: 'v',\n+    description: 'Set the verbosity level (-v: WARN, -vv: INFO, -vvv: DEBUG)',\n+  })\n+  .wrap(null)\n+  .help()\n+  .alias('help', 'h')\n+  .demandCommand(1, 'A project directory is required.')\n+  .strictCommands()\n+  .parse()\n+\n+const {\n+  project: projectDir,\n+  build,\n+  buildNative: buildNativeEnabled,\n+  verbose: verboseLevel,\n+  _: buildNativeArgs,\n+} = argv as Options\n+\n+function WARN(...args: any[]) {\n+  verboseLevel >= 1 && console.warn(...args)\n+}\n+function INFO(...args: any[]) {\n+  verboseLevel >= 2 && console.info(...args)\n+}\n+function DEBUG(...args: any[]) {\n+  verboseLevel >= 3 && console.log(...args)\n+}\n+\n+const PROJECT_DIR = path.resolve(projectDir)\n+const NEXT_PACKAGES = path.join(NEXT_DIR, 'packages')\n+\n+function realPathIfAny(path: string): string | null {\n+  try {\n+    return fs.realpathSync(path)\n+  } catch {\n+    return null\n+  }\n+}\n+\n+async function copy(src: string, dst: string): Promise<void> {\n+  const realDst = realPathIfAny(dst)\n+\n+  if (!realDst) {\n+    WARN(`[x] Destination path ${dst} does not exist. Skipping copy.`)\n+    return\n+  }\n+\n+  if (realDst && realDst === src) {\n+    WARN(\n+      `[x] Source and destination paths are the same: ${src}. Skipping copy.`\n+    )\n+    return\n+  }\n+\n+  if (!fs.existsSync(src)) {\n+    WARN(`[x] Source path ${src} does not exist. Skipping copy.`)\n+    return\n+  }\n+\n+  const files = await packageFiles(src)\n+  DEBUG(`[x] Found ${files.length} files to copy from ${src}`)\n+\n+  for (const file of files) {\n+    const srcFile = path.join(src, file)\n+    const dstFile = path.join(realDst, file)\n+\n+    DEBUG(`Copying ${srcFile} to ${dstFile}`)\n+    fs.cpSync(srcFile, dstFile, {\n+      recursive: true,\n+    })\n+  }\n+}\n+\n+// --- Main execution ---\n+async function main(): Promise<void> {\n+  if (!fs.existsSync(PROJECT_DIR)) {\n+    console.error(`Error: Project directory \"${PROJECT_DIR}\" does not exist.`)\n+    process.exit(1)\n+  }\n+\n+  INFO(`[x] Project Directory: ${PROJECT_DIR}`)\n+  INFO(`[x] Next.js Source: ${NEXT_PACKAGES}`)\n+\n+  if (build) {\n+    exec('Install Next.js build dependencies', 'pnpm i')\n+    exec('Build Next.js', 'pnpm run build')\n+  }\n+\n+  if (buildNativeEnabled) {\n+    INFO('Building native modules...')\n+    await buildNative(buildNativeArgs)\n+  }\n+\n+  const packagesToPatch = [\n+    { name: 'next', path: 'next' },\n+    { name: '@next/swc', path: 'next-swc' },\n+    { name: '@next/mdx', path: 'next-mdx' },\n+    { name: '@next/bundle-analyzer', path: 'next-bundle-analyzer' },\n+  ]\n+\n+  INFO(\n+    `[x] Patching packages: ${packagesToPatch.map((pkg) => pkg.name).join(', ')}`\n+  )\n+  for (const pkg of packagesToPatch) {\n+    await execFn(`Patching ${pkg.name}`, () =>\n+      copy(\n+        path.join(NEXT_PACKAGES, pkg.path),\n+        path.join(PROJECT_DIR, 'node_modules', pkg.name)\n+      )\n+    )\n+  }\n+\n+  console.log(`\\n\\x1b[1;4mPatching complete!\\x1b[0m\\n`)\n+}\n+\n+main().catch((e) => {\n+  console.error('An unexpected error occurred:')\n+  console.error(e)\n+  process.exit(1)\n+})"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 182,
        "deletions": 81
    }
}