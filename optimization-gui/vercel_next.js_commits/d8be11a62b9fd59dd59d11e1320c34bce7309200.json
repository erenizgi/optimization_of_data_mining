{
    "author": "devjiwonchoi",
    "message": "[release] use changesets/action for release-candidate (#79039)\n\nBest to be reviewed with \"Hide whitespace\".\n\nThis PR added release candidate handling and used a switch case to\nensure the correct release type was given.\n\n---------\n\nCo-authored-by: Sebastian \"Sebbie\" Silbermann <sebastian.silbermann@vercel.com>\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "d8be11a62b9fd59dd59d11e1320c34bce7309200",
    "files": [
        {
            "sha": "dc5ab1d06614beb7267478a8ddec669f17778d0b",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d8be11a62b9fd59dd59d11e1320c34bce7309200/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/d8be11a62b9fd59dd59d11e1320c34bce7309200/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=d8be11a62b9fd59dd59d11e1320c34bce7309200",
            "patch": "@@ -20,7 +20,7 @@ env:\n   # See https://doc.rust-lang.org/rustc/platform-support/apple-darwin.html#os-version for more details\n   MACOSX_DEPLOYMENT_TARGET: 11.0\n   # This will become \"true\" if the latest commit is\n-  # \"Version Packages\" or \"Version Pacakges (canary)\"\n+  # \"Version Packages\" or \"Version Pacakges \\((canary|rc)\\)\"\n   # set from scripts/check-is-release.js\n   __NEW_RELEASE: 'false'\n \n@@ -50,7 +50,7 @@ jobs:\n         run: |\n           # TODO: Remove the new release check once the new release workflow is fully replaced.\n           RELEASE_CHECK=$(node ./scripts/check-is-release.js 2> /dev/null || :)\n-          if [[ $RELEASE_CHECK =~ ^Version\\ Packages(\\ \\(canary\\))?$ ]];\n+          if [[ $RELEASE_CHECK =~ ^Version\\ Packages(\\ \\((canary|rc)\\))?$ ]];\n           then\n             echo \"__NEW_RELEASE=true\" >> $GITHUB_ENV\n           elif [[ $RELEASE_CHECK = v* ]];"
        },
        {
            "sha": "fe08293a3e8448b2b4363a7f72c66265ecc4cc05",
            "filename": ".github/workflows/trigger_release_new.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d8be11a62b9fd59dd59d11e1320c34bce7309200/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/d8be11a62b9fd59dd59d11e1320c34bce7309200/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftrigger_release_new.yml?ref=d8be11a62b9fd59dd59d11e1320c34bce7309200",
            "patch": "@@ -18,8 +18,7 @@ on:\n         options:\n           - canary\n           - stable\n-          # TODO: Follow up enable the case.\n-          # - release-candidate\n+          - release-candidate\n \n       force:\n         description: Forced Release"
        },
        {
            "sha": "74e39b7915cc592022367f365558be7bdf80d9be",
            "filename": "scripts/check-is-release.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8be11a62b9fd59dd59d11e1320c34bce7309200/scripts%2Fcheck-is-release.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d8be11a62b9fd59dd59d11e1320c34bce7309200/scripts%2Fcheck-is-release.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcheck-is-release.js?ref=d8be11a62b9fd59dd59d11e1320c34bce7309200",
            "patch": "@@ -13,7 +13,7 @@ const checkIsRelease = async () => {\n \n   const versionString = commitMsg.split(' ').pop().trim()\n   const publishMsgRegex = /^v\\d{1,}\\.\\d{1,}\\.\\d{1,}(-\\w{1,}\\.\\d{1,})?$/\n-  const newPublishMsgRegex = /^Version Packages( \\(canary\\))?$/\n+  const newPublishMsgRegex = /^Version Packages( \\((canary|rc)\\))?$/\n \n   if (publishMsgRegex.test(versionString)) {\n     console.log(versionString)"
        },
        {
            "sha": "cc038af03f1e378036857cd224381e9c5c97f095",
            "filename": "scripts/release/version-packages.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 38,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/d8be11a62b9fd59dd59d11e1320c34bce7309200/scripts%2Frelease%2Fversion-packages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8be11a62b9fd59dd59d11e1320c34bce7309200/scripts%2Frelease%2Fversion-packages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Frelease%2Fversion-packages.ts?ref=d8be11a62b9fd59dd59d11e1320c34bce7309200",
            "patch": "@@ -36,53 +36,73 @@ async function versionPackages() {\n     }\n   }\n \n+  // For prereleases, we need to set the \"mode\" on `pre.json`, which\n+  // can be done by running `changeset pre enter <mode>`.\n   const releaseType = process.env.RELEASE_TYPE\n+  switch (releaseType) {\n+    case 'canary': {\n+      // Enter pre mode as \"canary\" tag.\n+      await execa('pnpm', ['changeset', 'pre', 'enter', 'canary'], {\n+        stdio: 'inherit',\n+      })\n \n-  if (releaseType === 'canary') {\n-    // Enter pre mode as \"canary\" tag.\n-    await execa('pnpm', ['changeset', 'pre', 'enter', 'canary'], {\n-      stdio: 'inherit',\n-    })\n+      console.log(\n+        '▲   Preparing to bump the canary version, checking if there are any changesets.'\n+      )\n \n-    console.log(\n-      '▲   Preparing to bump the canary version, checking if there are any changesets.'\n-    )\n+      // Create an empty changeset for `next` to bump the canary version\n+      // even if there are no changesets for `next`.\n+      await execa('pnpm', [\n+        'changeset',\n+        'status',\n+        '--output',\n+        './changeset-status.json',\n+      ])\n \n-    // Create an empty changeset for `next` to bump the canary version\n-    // even if there are no changesets for `next`.\n-    await execa('pnpm', [\n-      'changeset',\n-      'status',\n-      '--output',\n-      './changeset-status.json',\n-    ])\n+      let hasNextChangeset = false\n+      if (existsSync('./changeset-status.json')) {\n+        const changesetStatus: ChangesetStatusJson = JSON.parse(\n+          await readFile('./changeset-status.json', 'utf8')\n+        )\n \n-    let hasNextChangeset = false\n-    if (existsSync('./changeset-status.json')) {\n-      const changesetStatus: ChangesetStatusJson = JSON.parse(\n-        await readFile('./changeset-status.json', 'utf8')\n-      )\n+        console.log('▲   Changeset Status:')\n+        console.log(changesetStatus)\n \n-      console.log('▲   Changeset Status:')\n-      console.log(changesetStatus)\n+        hasNextChangeset =\n+          changesetStatus.releases.find(\n+            (release) => release.name === 'next'\n+          ) !== undefined\n \n-      hasNextChangeset =\n-        changesetStatus.releases.find((release) => release.name === 'next') !==\n-        undefined\n+        await unlink('./changeset-status.json')\n+      }\n \n-      await unlink('./changeset-status.json')\n+      if (!hasNextChangeset) {\n+        console.log(\n+          '▲   No changesets found for `next`, creating an empty changeset.'\n+        )\n+        // TODO: Since this is temporary until we hard-require a changeset, we will\n+        // need to remove this in the future to prevent publishing empty releases.\n+        await writeFile(\n+          join(process.cwd(), '.changeset', `next-canary-${Date.now()}.md`),\n+          `---\\n'next': patch\\n---`\n+        )\n+      }\n+      break\n     }\n-\n-    if (!hasNextChangeset) {\n-      console.log(\n-        '▲   No changesets found for `next`, creating an empty changeset.'\n-      )\n-      // TODO: Since this is temporary until we hard-require a changeset, we will\n-      // need to remove this in the future to prevent publishing empty releases.\n-      await writeFile(\n-        join(process.cwd(), '.changeset', `next-canary-${Date.now()}.md`),\n-        `---\\n'next': patch\\n---`\n-      )\n+    case 'release-candidate': {\n+      // Enter pre mode as \"rc\" tag.\n+      await execa('pnpm', ['changeset', 'pre', 'enter', 'rc'], {\n+        stdio: 'inherit',\n+      })\n+      break\n+    }\n+    case 'stable': {\n+      // No additional steps needed for 'stable' releases since we've already\n+      // exited any pre-release mode. Only need to run `changeset version` after.\n+      break\n+    }\n+    default: {\n+      throw new Error(`Invalid release type: ${releaseType}`)\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 105,
        "additions": 62,
        "deletions": 43
    }
}