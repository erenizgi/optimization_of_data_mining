{
    "author": "conico974",
    "message": "fix: top level await in node middleware (#76012)\n\n### What?\n\nUsing top level await with a node middleware will crash with `adapterFn`\nis not a function\n\n### Why?\n\nWhen using top level await requiring `middleware.js` will return a\npromise that need to be awaited\n\n### How?\n\nAwait the require and changed `getMiddleware` signature\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "d6d459140619cf6c44f508a62f115e8ce4a13146",
    "files": [
        {
            "sha": "426f395fc385cf7b8ddbae7759e175bc726023dd",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d6d459140619cf6c44f508a62f115e8ce4a13146",
            "patch": "@@ -731,7 +731,7 @@ export default abstract class Server<\n \n   private handleNextDataRequest: RouteHandler<ServerRequest, ServerResponse> =\n     async (req, res, parsedUrl) => {\n-      const middleware = this.getMiddleware()\n+      const middleware = await this.getMiddleware()\n       const params = matchNextDataPathname(parsedUrl.pathname)\n \n       // ignore for non-next data URLs\n@@ -3754,7 +3754,7 @@ export default abstract class Server<\n     )\n   }\n \n-  protected abstract getMiddleware(): MiddlewareRoutingItem | undefined\n+  protected abstract getMiddleware(): Promise<MiddlewareRoutingItem | undefined>\n   protected abstract getFallbackErrorComponents(\n     url?: string\n   ): Promise<LoadComponentsReturnType | null>\n@@ -3871,8 +3871,9 @@ export default abstract class Server<\n       return response\n     }\n \n+    const middleware = await this.getMiddleware()\n     if (\n-      this.getMiddleware() &&\n+      middleware &&\n       !!ctx.req.headers['x-nextjs-data'] &&\n       (!res.statusCode || res.statusCode === 200 || res.statusCode === 404)\n     ) {"
        },
        {
            "sha": "371faaf0b37d2a3f679a26acf8362a9df7faa481",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=d6d459140619cf6c44f508a62f115e8ce4a13146",
            "patch": "@@ -615,7 +615,7 @@ export default class DevServer extends Server {\n     return rewrites ?? []\n   }\n \n-  protected getMiddleware() {\n+  protected async getMiddleware() {\n     // We need to populate the match\n     // field as it isn't serializable\n     if (this.middleware?.match === null) {"
        },
        {
            "sha": "f61132fe9a6e2d2ae54af9a768f42441cc2afccb",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=d6d459140619cf6c44f508a62f115e8ce4a13146",
            "patch": "@@ -1343,11 +1343,11 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   /** Returns the middleware routing item if there is one. */\n-  protected getMiddleware(): MiddlewareRoutingItem | undefined {\n+  protected async getMiddleware(): Promise<MiddlewareRoutingItem | undefined> {\n     const manifest = this.getMiddlewareManifest()\n     const middleware = manifest?.middleware?.['/']\n     if (!middleware) {\n-      const middlewareModule = this.loadNodeMiddleware()\n+      const middlewareModule = await this.loadNodeMiddleware()\n \n       if (middlewareModule) {\n         return {\n@@ -1437,7 +1437,7 @@ export default class NextNodeServer extends BaseServer<\n     }\n   }\n \n-  private loadNodeMiddleware() {\n+  private async loadNodeMiddleware() {\n     if (!this.nextConfig.experimental.nodeMiddleware) {\n       return\n     }\n@@ -1448,6 +1448,7 @@ export default class NextNodeServer extends BaseServer<\n         : require(join(this.distDir, 'server', FUNCTIONS_CONFIG_MANIFEST))\n \n       if (this.renderOpts.dev || functionsConfig?.functions?.['/_middleware']) {\n+        // if used with top level await, this will be a promise\n         return require(join(this.distDir, 'server', 'middleware.js'))\n       }\n     } catch (err) {\n@@ -1468,8 +1469,9 @@ export default class NextNodeServer extends BaseServer<\n    */\n   protected async hasMiddleware(pathname: string): Promise<boolean> {\n     const info = this.getEdgeFunctionInfo({ page: pathname, middleware: true })\n+    const nodeMiddleware = await this.loadNodeMiddleware()\n \n-    if (!info && this.loadNodeMiddleware()) {\n+    if (!info && nodeMiddleware) {\n       return true\n     }\n     return Boolean(info && info.paths.length > 0)\n@@ -1543,7 +1545,7 @@ export default class NextNodeServer extends BaseServer<\n       params?: { [key: string]: string | string[] }\n     } = {}\n \n-    const middleware = this.getMiddleware()\n+    const middleware = await this.getMiddleware()\n     if (!middleware) {\n       return { finished: false }\n     }\n@@ -1588,7 +1590,7 @@ export default class NextNodeServer extends BaseServer<\n     // we decide we want to\n     if (!middlewareInfo) {\n       let middlewareModule\n-      middlewareModule = this.loadNodeMiddleware()\n+      middlewareModule = await this.loadNodeMiddleware()\n \n       if (!middlewareModule) {\n         throw new MiddlewareNotFoundError()\n@@ -1666,7 +1668,7 @@ export default class NextNodeServer extends BaseServer<\n       return true\n     }\n \n-    const middleware = this.getMiddleware()\n+    const middleware = await this.getMiddleware()\n     if (!middleware) {\n       return handleFinished()\n     }"
        },
        {
            "sha": "8a5be7e3c2dee211aabd51e192ad1c95a9ba796b",
            "filename": "packages/next/src/server/web-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d6d459140619cf6c44f508a62f115e8ce4a13146/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts?ref=d6d459140619cf6c44f508a62f115e8ce4a13146",
            "patch": "@@ -378,10 +378,10 @@ export default class NextWebServer extends BaseServer<\n     return undefined\n   }\n \n-  protected getMiddleware(): MiddlewareRoutingItem | undefined {\n+  protected getMiddleware(): Promise<MiddlewareRoutingItem | undefined> {\n     // The web server does not need to handle middleware. This is done by the\n     // upstream proxy (edge runtime or node server).\n-    return undefined\n+    return Promise.resolve(undefined)\n   }\n \n   protected getFilesystemPaths() {"
        },
        {
            "sha": "9e318633bcd09d9c971c7e81791490dcc3ba05fb",
            "filename": "test/e2e/middleware-general/app/middleware-node.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d6d459140619cf6c44f508a62f115e8ce4a13146/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d6d459140619cf6c44f508a62f115e8ce4a13146/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js?ref=d6d459140619cf6c44f508a62f115e8ce4a13146",
            "patch": "@@ -7,6 +7,11 @@ export const config = {\n   runtime: 'nodejs',\n }\n \n+// When there is a top level await, requiring middleware.js will return a Promise\n+await new Promise((resolve) => {\n+  setTimeout(resolve, 100)\n+})\n+\n const PATTERNS = []\n \n const params = (url) => {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 21,
        "deletions": 13
    }
}