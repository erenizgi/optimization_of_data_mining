{
    "author": "mischnic",
    "message": "Turbopack: fix glob with empty alternative branch (#82275)\n\nThis came up during NFT where the ignore pattern `'**/node_modules/react{,-dom,-dom-server-turbopack}/**/*.development.js'` wasn't applied.",
    "sha": "db561cb924cbea0f3384e89f251fc443a8aec1ae",
    "files": [
        {
            "sha": "0d463f1aade1ee46f05c32d3764736809f863996",
            "filename": "turbopack/crates/turbo-tasks-fs/src/glob.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/db561cb924cbea0f3384e89f251fc443a8aec1ae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglob.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/db561cb924cbea0f3384e89f251fc443a8aec1ae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglob.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglob.rs?ref=db561cb924cbea0f3384e89f251fc443a8aec1ae",
            "patch": "@@ -193,6 +193,8 @@ mod tests {\n     #[case::alternatives_nested2(\"{a,b/c,d/e/{f,g/h}}\", \"b/c\")]\n     #[case::alternatives_nested3(\"{a,b/c,d/e/{f,g/h}}\", \"d/e/f\")]\n     #[case::alternatives_nested4(\"{a,b/c,d/e/{f,g/h}}\", \"d/e/g/h\")]\n+    #[case::alternatives_empty1(\"react{,-dom}\", \"react\")]\n+    #[case::alternatives_empty2(\"react{,-dom}\", \"react-dom\")]\n     #[case::alternatives_chars(\"[abc]\", \"b\")]\n     fn glob_match(#[case] glob: &str, #[case] path: &str) {\n         let glob = Glob::parse(glob).unwrap();"
        },
        {
            "sha": "32c23a4f3d03dc69449fcf082e4f1a1c59c88054",
            "filename": "turbopack/crates/turbo-tasks-fs/src/globset.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/db561cb924cbea0f3384e89f251fc443a8aec1ae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglobset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/db561cb924cbea0f3384e89f251fc443a8aec1ae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglobset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fglobset.rs?ref=db561cb924cbea0f3384e89f251fc443a8aec1ae",
            "patch": "@@ -253,10 +253,13 @@ impl Tokens {\n \n fn build_alternates(re: &mut String, patterns: &Vec<Tokens>, branch_fn: fn(&[Token], &mut String)) {\n     let mut parts = Vec::with_capacity(patterns.len());\n+    let mut has_empty_part = false;\n     for pat in patterns {\n         let mut altre = String::new();\n         branch_fn(pat, &mut altre);\n-        if !altre.is_empty() {\n+        if altre.is_empty() {\n+            has_empty_part = true;\n+        } else {\n             parts.push(altre);\n         }\n     }\n@@ -265,6 +268,9 @@ fn build_alternates(re: &mut String, patterns: &Vec<Tokens>, branch_fn: fn(&[Tok\n     // resulting alternation '()' would be an error.\n     if !parts.is_empty() {\n         re.push_str(\"(?:\");\n+        if has_empty_part {\n+            re.push('|');\n+        }\n         re.push_str(&parts.join(\"|\"));\n         re.push(')');\n     }"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}