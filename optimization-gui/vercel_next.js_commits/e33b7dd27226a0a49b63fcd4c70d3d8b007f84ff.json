{
    "author": "ijjk",
    "message": "Stabilize back-forward-cache test cases (#78735)\n\nThis attempts to stabilize the back-forward-cache test assertions by\nadding retry to the initial button incrementing as I have a theory this\nwas attempting to click before the event listeners were attached causing\nthe clicks to be missed which makes the successive test cases fail.\n\nx-ref:\nhttps://github.com/vercel/next.js/actions/runs/14766354734/job/41458564789#step:33:481\nx-ref:\nhttps://github.com/vercel/next.js/actions/runs/14766354734/job/41459734942#step:33:191",
    "sha": "e33b7dd27226a0a49b63fcd4c70d3d8b007f84ff",
    "files": [
        {
            "sha": "4d65e57c74fc8bcf80de006fdde11a8548907eb7",
            "filename": "test/e2e/app-dir/back-forward-cache/back-forward-cache.test.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 25,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/e33b7dd27226a0a49b63fcd4c70d3d8b007f84ff/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e33b7dd27226a0a49b63fcd4c70d3d8b007f84ff/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts?ref=e33b7dd27226a0a49b63fcd4c70d3d8b007f84ff",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n describe('back/forward cache', () => {\n   const { next } = nextTestSetup({\n@@ -9,10 +10,17 @@ describe('back/forward cache', () => {\n     const browser = await next.browser('/page/1')\n \n     // Accumulate some state on page 1.\n-    const incrementButton1 = await browser.elementById('increment-button-1')\n+    await retry(async () => {\n+      // we do this inside of retry in case button event handler\n+      // isn't ready yet\n+      await browser.elementById('increment-button-1').click()\n+\n+      const counterDisplay1 = await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1.text()).toBe('Count: 1')\n+    })\n+    await browser.elementById('increment-button-1').click()\n+\n     const counterDisplay1 = await browser.elementById('counter-display-1')\n-    await incrementButton1.click()\n-    await incrementButton1.click()\n     expect(await counterDisplay1.text()).toBe('Count: 2')\n \n     // Navigate to page 2. Accumulate some state here, too.\n@@ -48,10 +56,18 @@ describe('back/forward cache', () => {\n     const browser = await next.browser('/page/1')\n \n     // Accumulate some state on page 1.\n-    const incrementButton1 = await browser.elementById('increment-button-1')\n+    // Accumulate some state on page 1.\n+    await retry(async () => {\n+      // we do this inside of retry in case button event handler\n+      // isn't ready yet\n+      await browser.elementById('increment-button-1').click()\n+\n+      const counterDisplay1 = await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1.text()).toBe('Count: 1')\n+    })\n+    await browser.elementById('increment-button-1').click()\n+\n     const counterDisplay1 = await browser.elementById('counter-display-1')\n-    await incrementButton1.click()\n-    await incrementButton1.click()\n     expect(await counterDisplay1.text()).toBe('Count: 2')\n \n     // Navigate to page 2. Accumulate some state here, too.\n@@ -88,10 +104,17 @@ describe('back/forward cache', () => {\n     const browser = await next.browser('/page/1')\n \n     // Accumulate some state on page 1.\n-    const incrementButton1 = await browser.elementById('increment-button-1')\n+    await retry(async () => {\n+      // we do this inside of retry in case button event handler\n+      // isn't ready yet\n+      await browser.elementById('increment-button-1').click()\n+\n+      const counterDisplay1 = await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1.text()).toBe('Count: 1')\n+    })\n+    await browser.elementById('increment-button-1').click()\n+\n     const counterDisplay1 = await browser.elementById('counter-display-1')\n-    await incrementButton1.click()\n-    await incrementButton1.click()\n     expect(await counterDisplay1.text()).toBe('Count: 2')\n \n     // Navigate to page 2.\n@@ -103,27 +126,38 @@ describe('back/forward cache', () => {\n       'a[href=\"/page/1?param=true\"]'\n     )\n     await linkToPage1WithSearchParam.click()\n-    const counterDisplay1AfterNav =\n-      await browser.elementById('counter-display-1')\n-    const hasSearchParam = await browser.elementById('has-search-param-1')\n-    expect(await counterDisplay1AfterNav.text()).toBe('Count: 2')\n-    expect(await hasSearchParam.text()).toBe('Has search param: yes')\n+\n+    await retry(async () => {\n+      const counterDisplay1AfterNav =\n+        await browser.elementById('counter-display-1')\n+      const hasSearchParam = await browser.elementById('has-search-param-1')\n+      expect(await counterDisplay1AfterNav.text()).toBe('Count: 2')\n+      expect(await hasSearchParam.text()).toBe('Has search param: yes')\n+    })\n   })\n \n   it('bfcache only preserves up to N entries', async () => {\n     // The current limit is hardcoded to 3.\n     const browser = await next.browser('/page/1')\n \n     // Accumulate some state on page 1.\n-    const incrementButton1 = await browser.elementById('increment-button-1')\n+    await retry(async () => {\n+      // we do this inside of retry in case button event handler\n+      // isn't ready yet\n+      await browser.elementById('increment-button-1').click()\n+\n+      const counterDisplay1 = await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1.text()).toBe('Count: 1')\n+    })\n+    await browser.elementById('increment-button-1').click()\n+\n     const counterDisplay1 = await browser.elementById('counter-display-1')\n-    await incrementButton1.click()\n-    await incrementButton1.click()\n     expect(await counterDisplay1.text()).toBe('Count: 2')\n \n     // Navigate to page 2. Accumulate some state here, too.\n     const linkToPage2 = await browser.elementByCss('a[href=\"/page/2\"]')\n     await linkToPage2.click()\n+\n     const incrementButton2 = await browser.elementById('increment-button-2')\n     const counterDisplay2 = await browser.elementById('counter-display-2')\n     await incrementButton2.click()\n@@ -153,22 +187,32 @@ describe('back/forward cache', () => {\n     expect(await counterDisplay2AfterNav.text()).toBe('Count: 9')\n \n     // Navigate back to page 1 to confirm its state is not preserved.\n-    const linkToPage1 = await browser.elementByCss('a[href=\"/page/1\"]')\n-    await linkToPage1.click()\n-    const counterDisplay1AfterNav =\n-      await browser.elementById('counter-display-1')\n-    expect(await counterDisplay1AfterNav.text()).toBe('Count: 0')\n+    await retry(async () => {\n+      const linkToPage1 = await browser.elementByCss('a[href=\"/page/1\"]')\n+      await linkToPage1.click()\n+\n+      const counterDisplay1AfterNav =\n+        await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1AfterNav.text()).toBe('Count: 0')\n+    })\n   })\n \n   it('navigate back and forth repeatedly between the same pages without evicting', async () => {\n     // The current limit is hardcoded to 3.\n     const browser = await next.browser('/page/1')\n \n     // Accumulate some state on page 1.\n-    const incrementButton1 = await browser.elementById('increment-button-1')\n+    await retry(async () => {\n+      // we do this inside of retry in case button event handler\n+      // isn't ready yet\n+      await browser.elementById('increment-button-1').click()\n+\n+      const counterDisplay1 = await browser.elementById('counter-display-1')\n+      expect(await counterDisplay1.text()).toBe('Count: 1')\n+    })\n+    await browser.elementById('increment-button-1').click()\n+\n     const counterDisplay1 = await browser.elementById('counter-display-1')\n-    await incrementButton1.click()\n-    await incrementButton1.click()\n     expect(await counterDisplay1.text()).toBe('Count: 2')\n \n     // Navigate to page 2. Accumulate some state here, too."
        }
    ],
    "stats": {
        "total": 94,
        "additions": 69,
        "deletions": 25
    }
}