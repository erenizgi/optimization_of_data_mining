{
    "author": "timneutkens",
    "message": "Turbopack build: Fix basepath test (#77630)\n\n## What?\n\nMoved the basepath e2e tests into a dedicated directory structure and\nsimplified the test setup:\n\n1. Relocated `basepath-trailing-slash.test.ts` and `basepath.test.ts`\ninto a dedicated `basepath` directory\n2. Simplified the test file setup by using `files: __dirname` instead of\nexplicitly referencing individual directories\n3. Updated the regex patterns in the prefetch test to be more flexible\nwith optional characters, matching the Turbopack pattern.\n4. Updated the test manifest files to reflect the new file paths\n5. Fixed a previously failing test: \"basePath should prefetch pages\ncorrectly in viewport with <Link>\"",
    "sha": "64e4ba70319bae55ae2bd3d06025dda6666f3daf",
    "files": [
        {
            "sha": "616083a9f614bf43e8bcde4f9595c8a9565471cc",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -568,7 +568,7 @@ jobs:\n     with:\n       afterBuild: pnpm playwright install &&\n         BROWSER_NAME=firefox node run-tests.js test/production/pages-dir/production/test/index.test.ts &&\n-        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js -c 1 test/production/pages-dir/production/test/index.test.ts test/e2e/basepath.test.ts &&\n+        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js -c 1 test/production/pages-dir/production/test/index.test.ts test/e2e/basepath/basepath.test.ts &&\n         BROWSER_NAME=safari DEVICE_NAME='iPhone XR' node run-tests.js -c 1 test/production/prerender-prefetch/index.test.ts\n \n       stepName: 'test-firefox-safari'"
        },
        {
            "sha": "78628451856ae08a7ee3b1c252a92e27bba0c70f",
            "filename": "test/deploy-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fdeploy-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fdeploy-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdeploy-tests-manifest.json?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -51,7 +51,7 @@\n       \"test/e2e/app-dir/i18n-hybrid/i18n-hybrid.test.js\",\n       \"test/e2e/app-dir/metadata/metadata.test.ts\",\n       \"test/e2e/app-dir/rsc-basic/rsc-basic.test.ts\",\n-      \"test/e2e/basepath.test.ts\",\n+      \"test/e2e/basepath/basepath.test.ts\",\n       \"test/e2e/postcss-config-cjs/index.test.ts\",\n       \"test/e2e/socket-io/index.test.js\",\n       \"test/e2e/middleware-matcher/index.test.ts\","
        },
        {
            "sha": "078ff69d4d97f47595899ae79d13736fa22b35a4",
            "filename": "test/e2e/basepath/basepath-trailing-slash.test.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fe2e%2Fbasepath%2Fbasepath-trailing-slash.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fe2e%2Fbasepath%2Fbasepath-trailing-slash.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fbasepath-trailing-slash.test.ts?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -1,6 +1,5 @@\n-import { join } from 'path'\n import webdriver from 'next-webdriver'\n-import { createNext, FileRef } from 'e2e-utils'\n+import { createNext } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n import { assertNoRedbox } from 'next-test-utils'\n \n@@ -10,11 +9,7 @@ describe('basePath + trailingSlash', () => {\n \n   beforeAll(async () => {\n     next = await createNext({\n-      files: {\n-        pages: new FileRef(join(__dirname, 'basepath/pages')),\n-        public: new FileRef(join(__dirname, 'basepath/public')),\n-        external: new FileRef(join(__dirname, 'basepath/external')),\n-      },\n+      files: __dirname,\n       nextConfig: {\n         trailingSlash: true,\n         basePath,",
            "previous_filename": "test/e2e/basepath-trailing-slash.test.ts"
        },
        {
            "sha": "7a11163b21695c2748d32bb24404da3f0b742c8c",
            "filename": "test/e2e/basepath/basepath.test.ts",
            "status": "renamed",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -1,9 +1,8 @@\n import url from 'url'\n-import { join } from 'path'\n import assert from 'assert'\n import cheerio from 'cheerio'\n import webdriver from 'next-webdriver'\n-import { createNext, FileRef } from 'e2e-utils'\n+import { createNext } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n import {\n   assertNoRedbox,\n@@ -19,11 +18,7 @@ describe('basePath', () => {\n \n   beforeAll(async () => {\n     next = await createNext({\n-      files: {\n-        pages: new FileRef(join(__dirname, 'basepath/pages')),\n-        public: new FileRef(join(__dirname, 'basepath/public')),\n-        external: new FileRef(join(__dirname, 'basepath/external')),\n-      },\n+      files: __dirname,\n       nextConfig: {\n         basePath,\n         onDemandEntries: {\n@@ -290,13 +285,13 @@ describe('basePath', () => {\n             `[].slice.call(document.querySelectorAll(\"link[rel=prefetch]\")).map((e) => new URL(e.href).pathname)`\n           )\n           expect(prefetches).toContainEqual(\n-            expect.stringMatching(/\\/gsp-[^./]+\\.js/)\n+            expect.stringMatching(/\\/gsp-?([^./]+)?\\.js/)\n           )\n           expect(prefetches).toContainEqual(\n-            expect.stringMatching(/\\/gssp-[^./]+\\.js/)\n+            expect.stringMatching(/\\/gssp-?([^./]+)?\\.js/)\n           )\n           expect(prefetches).toContainEqual(\n-            expect.stringMatching(/\\/other-page-[^./]+\\.js/)\n+            expect.stringMatching(/\\/other-page-?([^./]+)?\\.js/)\n           )\n           return 'yes'\n         }, 'yes')",
            "previous_filename": "test/e2e/basepath.test.ts"
        },
        {
            "sha": "21076c15334f7028b3d58fa6fdc20ffc8e280e5e",
            "filename": "test/rspack-build-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Frspack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Frspack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-build-tests-manifest.json?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -5887,7 +5887,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath.test.ts\": {\n+  \"test/e2e/basepath/basepath.test.ts\": {\n     \"passed\": [\n       \"basePath should 404 for public file without basePath\",\n       \"basePath should 404 when manually adding basePath with <Link>\","
        },
        {
            "sha": "d8a11bca00a0b456ef42b537daa6939db1683868",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -9158,7 +9158,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath.test.ts\": {\n+  \"test/e2e/basepath/basepath.test.ts\": {\n     \"passed\": [\n       \"basePath should 404 for public file without basePath\",\n       \"basePath should 404 when manually adding basePath with <Link>\","
        },
        {
            "sha": "f356aa2eab158cc5d425ceb5210f9e9f5046a469",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -5770,7 +5770,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath-trailing-slash.test.ts\": {\n+  \"test/e2e/basepath/basepath-trailing-slash.test.ts\": {\n     \"passed\": [\n       \"basePath + trailingSlash should allow URL query strings on index without refresh\",\n       \"basePath + trailingSlash should allow URL query strings without refresh\",\n@@ -5781,7 +5781,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath.test.ts\": {\n+  \"test/e2e/basepath/basepath.test.ts\": {\n     \"passed\": [\n       \"basePath should 404 for public file without basePath\",\n       \"basePath should 404 when manually adding basePath with <Link>\",\n@@ -5847,11 +5847,10 @@\n       \"basePath should work with catch-all page\",\n       \"basePath should work with hash links\",\n       \"basePath should work with nested folder with same name as basePath\",\n-      \"basePath should work with normal dynamic page\"\n-    ],\n-    \"failed\": [\n+      \"basePath should work with normal dynamic page\",\n       \"basePath should prefetch pages correctly in viewport with <Link>\"\n     ],\n+    \"failed\": [],\n     \"pending\": [\n       \"basePath should navigate back to a non-basepath 404 that starts with basepath\",\n       \"basePath should navigate to nested index page with getStaticProps\""
        },
        {
            "sha": "de1a7ccd17cf07baba34790a6ae7b0a78a5ca2be",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64e4ba70319bae55ae2bd3d06025dda6666f3daf/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=64e4ba70319bae55ae2bd3d06025dda6666f3daf",
            "patch": "@@ -8999,7 +8999,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath-trailing-slash.test.ts\": {\n+  \"test/e2e/basepath/basepath-trailing-slash.test.ts\": {\n     \"passed\": [\n       \"basePath + trailingSlash should allow URL query strings on index without refresh\",\n       \"basePath + trailingSlash should allow URL query strings without refresh\",\n@@ -9010,7 +9010,7 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/basepath.test.ts\": {\n+  \"test/e2e/basepath/basepath.test.ts\": {\n     \"passed\": [\n       \"basePath should 404 for public file without basePath\",\n       \"basePath should 404 when manually adding basePath with <Link>\","
        }
    ],
    "stats": {
        "total": 45,
        "additions": 17,
        "deletions": 28
    }
}