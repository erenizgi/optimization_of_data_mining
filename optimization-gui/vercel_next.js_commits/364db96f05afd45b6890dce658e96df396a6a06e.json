{
    "author": "styfle",
    "message": "feat(next/image)!: deprecate and warn on `images.domains` config (#84625)\n\nThis was docs deprecated in Next.js 14 so we should begin warning in\nNext.js 16 when `images.domains` config is used.\n\nThis will guide users to providing a strict `images.remotePatterns`\nconfig ensuring only expected images can be optimized.",
    "sha": "364db96f05afd45b6890dce658e96df396a6a06e",
    "files": [
        {
            "sha": "581d1bb58c5635c2c1cc07b511084d3258783cbb",
            "filename": "docs/01-app/03-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/364db96f05afd45b6890dce658e96df396a6a06e/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/364db96f05afd45b6890dce658e96df396a6a06e/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx?ref=364db96f05afd45b6890dce658e96df396a6a06e",
            "patch": "@@ -871,10 +871,12 @@ You can optionally configure `inline` to allow the browser to render the image w\n \n #### `domains`\n \n-> **Warning**: Deprecated since Next.js 14 in favor of strict [`remotePatterns`](#remotepatterns) in order to protect your application from malicious users. Only use `domains` if you own all the content served from the domain.\n+> **Warning**: Deprecated since Next.js 14 in favor of strict [`remotePatterns`](#remotepatterns) in order to protect your application from malicious users.\n \n Similar to [`remotePatterns`](#remotepatterns), the `domains` configuration can be used to provide a list of allowed hostnames for external images. However, the `domains` configuration does not support wildcard pattern matching and it cannot restrict protocol, port, or pathname.\n \n+Since most remote image servers are shared between multiple tenants, it's safer to use `remotePatterns` to ensure only the intended images are optimized.\n+\n Below is an example of the `domains` property in the `next.config.js` file:\n \n ```js filename=\"next.config.js\""
        },
        {
            "sha": "2b010f66a5fd14d0325e6e5a644be25c3c212871",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/364db96f05afd45b6890dce658e96df396a6a06e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/364db96f05afd45b6890dce658e96df396a6a06e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=364db96f05afd45b6890dce658e96df396a6a06e",
            "patch": "@@ -120,6 +120,15 @@ function checkDeprecations(\n     silent\n   )\n \n+  if (userConfig.images?.domains?.length) {\n+    warnOptionHasBeenDeprecated(\n+      userConfig,\n+      'images.domains',\n+      `\\`images.domains\\` is deprecated in favor of \\`images.remotePatterns\\`. Please update ${configFileName} to protect your application from malicious users.`,\n+      silent\n+    )\n+  }\n+\n   // i18n deprecation for App Router\n   if (userConfig.i18n) {\n     const hasAppDir = Boolean(findDir(dir, 'app'))"
        },
        {
            "sha": "cf2ca5a5a2c4d4a29b9a82f2e3ea11f3341a6a0f",
            "filename": "packages/next/src/shared/lib/image-config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/364db96f05afd45b6890dce658e96df396a6a06e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/364db96f05afd45b6890dce658e96df396a6a06e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts?ref=364db96f05afd45b6890dce658e96df396a6a06e",
            "patch": "@@ -133,6 +133,9 @@ export const imageConfigDefault: ImageConfigComplete = {\n   path: '/_next/image',\n   loader: 'default',\n   loaderFile: '',\n+  /**\n+   * @deprecated Use `remotePatterns` instead to protect your application from malicious users.\n+   */\n   domains: [],\n   disableStaticImages: false,\n   minimumCacheTTL: 14400, // 4 hours"
        },
        {
            "sha": "94b158ab7d386376d44a06a951fb68e412d3059f",
            "filename": "test/integration/next-image-new/image-from-node-modules/test/index.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/364db96f05afd45b6890dce658e96df396a6a06e/test%2Fintegration%2Fnext-image-new%2Fimage-from-node-modules%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/364db96f05afd45b6890dce658e96df396a6a06e/test%2Fintegration%2Fnext-image-new%2Fimage-from-node-modules%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fimage-from-node-modules%2Ftest%2Findex.test.ts?ref=364db96f05afd45b6890dce658e96df396a6a06e",
            "patch": "@@ -13,7 +13,7 @@ const appDir = join(__dirname, '../')\n let appPort\n let app\n \n-function runTests() {\n+function runTests(getOutput: () => string) {\n   it('should apply image config for node_modules', async () => {\n     const browser = await webdriver(appPort, '/')\n     const src = await browser\n@@ -26,34 +26,49 @@ function runTests() {\n       .getAttribute('srcset')\n     expect(srcset).toMatch('1234')\n   })\n+\n+  it('should warn when using images.domains config', async () => {\n+    expect(getOutput()).toContain(\n+      '`images.domains` is deprecated in favor of `images.remotePatterns`. Please update next.config.js to protect your application from malicious users.'\n+    )\n+  })\n }\n \n describe('Image Component from node_modules prod mode', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n     'production mode',\n     () => {\n+      let output = ''\n       beforeAll(async () => {\n-        await nextBuild(appDir)\n+        const result = await nextBuild(appDir, [], {\n+          stderr: true,\n+          stdout: true,\n+        })\n+        output = (result.stderr ?? '') + (result.stdout ?? '')\n         appPort = await findPort()\n         app = await nextStart(appDir, appPort)\n       })\n       afterAll(async () => {\n         await killApp(app)\n       })\n \n-      runTests()\n+      runTests(() => output)\n     }\n   )\n })\n \n describe('Image Component from node_modules development mode', () => {\n+  let output = ''\n   beforeAll(async () => {\n     appPort = await findPort()\n-    app = await launchApp(appDir, appPort)\n+    app = await launchApp(appDir, appPort, {\n+      onStderr: (msg) => (output += msg),\n+      onStdout: (msg) => (output += msg),\n+    })\n   })\n   afterAll(async () => {\n     await killApp(app)\n   })\n \n-  runTests()\n+  runTests(() => output)\n })"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 35,
        "deletions": 6
    }
}