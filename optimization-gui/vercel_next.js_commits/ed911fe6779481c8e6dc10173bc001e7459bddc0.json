{
    "author": "sokra",
    "message": "Turbopack: only write merged manifests when they have been changed (#84261)\n\n### What?\n\nAvoid writing manifests on every request. Instead check if they have been changed and only write them when they are different.",
    "sha": "ed911fe6779481c8e6dc10173bc001e7459bddc0",
    "files": [
        {
            "sha": "d2d0153ec169f27a8bd515b15bc83e6d56d17edb",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 193,
            "deletions": 79,
            "changes": 272,
            "blob_url": "https://github.com/vercel/next.js/blob/ed911fe6779481c8e6dc10173bc001e7459bddc0/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ed911fe6779481c8e6dc10173bc001e7459bddc0/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=ed911fe6779481c8e6dc10173bc001e7459bddc0",
            "patch": "@@ -118,28 +118,86 @@ const getManifestPath = (\n   return manifestPath\n }\n \n-function readPartialManifest<T>(\n+function readPartialManifestContent(\n   distDir: string,\n   name: ManifestName,\n   pageName: string,\n   type: 'pages' | 'app' | 'middleware' | 'instrumentation' = 'pages'\n-): T {\n+): string {\n   const page = pageName\n   const manifestPath = getManifestPath(page, distDir, name, type, true)\n-  return JSON.parse(readFileSync(posix.join(manifestPath), 'utf-8')) as T\n+  return readFileSync(posix.join(manifestPath), 'utf-8')\n+}\n+\n+/// Helper class that stores a map of manifests and tracks if they have changed\n+/// since the last time they were written to disk. This is used to avoid\n+/// unnecessary writes to disk.\n+class ManifestsMap<K, V> {\n+  private rawMap = new Map<K, string>()\n+  private map = new Map<K, V>()\n+  private extraInvalidationKey: string | undefined = undefined\n+  private changed = true\n+\n+  set(key: K, value: string) {\n+    if (this.rawMap.get(key) === value) return\n+    this.changed = true\n+    this.rawMap.set(key, value)\n+    this.map.set(key, JSON.parse(value))\n+  }\n+\n+  delete(key: K) {\n+    if (this.map.has(key)) {\n+      this.changed = true\n+      this.rawMap.delete(key)\n+      this.map.delete(key)\n+    }\n+  }\n+\n+  get(key: K) {\n+    return this.map.get(key)\n+  }\n+\n+  takeChanged(extraInvalidationKey?: any) {\n+    let changed = this.changed\n+    if (extraInvalidationKey !== undefined) {\n+      const stringified = JSON.stringify(extraInvalidationKey)\n+      if (this.extraInvalidationKey !== stringified) {\n+        this.extraInvalidationKey = stringified\n+        changed = true\n+      }\n+    }\n+    this.changed = false\n+    return changed\n+  }\n+\n+  values() {\n+    return this.map.values()\n+  }\n }\n \n export class TurbopackManifestLoader {\n-  private actionManifests: Map<EntryKey, ActionManifest> = new Map()\n-  private appPathsManifests: Map<EntryKey, PagesManifest> = new Map()\n-  private buildManifests: Map<EntryKey, BuildManifest> = new Map()\n-  private clientBuildManifests: Map<EntryKey, ClientBuildManifest> = new Map()\n-  private fontManifests: Map<EntryKey, NextFontManifest> = new Map()\n-  private middlewareManifests: Map<EntryKey, TurbopackMiddlewareManifest> =\n-    new Map()\n-  private pagesManifests: Map<string, PagesManifest> = new Map()\n-  private webpackStats: Map<EntryKey, WebpackStats> = new Map()\n+  private actionManifests: ManifestsMap<EntryKey, ActionManifest> =\n+    new ManifestsMap()\n+  private appPathsManifests: ManifestsMap<EntryKey, PagesManifest> =\n+    new ManifestsMap()\n+  private buildManifests: ManifestsMap<EntryKey, BuildManifest> =\n+    new ManifestsMap()\n+  private clientBuildManifests: ManifestsMap<EntryKey, ClientBuildManifest> =\n+    new ManifestsMap()\n+  private fontManifests: ManifestsMap<EntryKey, NextFontManifest> =\n+    new ManifestsMap()\n+  private middlewareManifests: ManifestsMap<\n+    EntryKey,\n+    TurbopackMiddlewareManifest\n+  > = new ManifestsMap()\n+  private pagesManifests: ManifestsMap<string, PagesManifest> =\n+    new ManifestsMap()\n+  private webpackStats: ManifestsMap<EntryKey, WebpackStats> =\n+    new ManifestsMap()\n   private encryptionKey: string\n+  /// interceptionRewrites that have been written to disk\n+  /// This is used to avoid unnecessary writes if the rewrites haven't changed\n+  private cachedInterceptionRewrites: string | undefined = undefined\n \n   private readonly distDir: string\n   private readonly buildId: string\n@@ -172,7 +230,7 @@ export class TurbopackManifestLoader {\n   loadActionManifest(pageName: string): void {\n     this.actionManifests.set(\n       getEntryKey('app', 'server', pageName),\n-      readPartialManifest(\n+      readPartialManifestContent(\n         this.distDir,\n         `${SERVER_REFERENCE_MANIFEST}.json`,\n         pageName,\n@@ -224,6 +282,9 @@ export class TurbopackManifestLoader {\n   }\n \n   private writeActionManifest(): void {\n+    if (!this.actionManifests.takeChanged()) {\n+      return\n+    }\n     const actionManifest = this.mergeActionManifests(\n       this.actionManifests.values()\n     )\n@@ -250,11 +311,19 @@ export class TurbopackManifestLoader {\n   loadAppPathsManifest(pageName: string): void {\n     this.appPathsManifests.set(\n       getEntryKey('app', 'server', pageName),\n-      readPartialManifest(this.distDir, APP_PATHS_MANIFEST, pageName, 'app')\n+      readPartialManifestContent(\n+        this.distDir,\n+        APP_PATHS_MANIFEST,\n+        pageName,\n+        'app'\n+      )\n     )\n   }\n \n   private writeAppPathsManifest(): void {\n+    if (!this.appPathsManifests.takeChanged()) {\n+      return\n+    }\n     const appPathsManifest = this.mergePagesManifests(\n       this.appPathsManifests.values()\n     )\n@@ -271,6 +340,9 @@ export class TurbopackManifestLoader {\n   }\n \n   private writeWebpackStats(): void {\n+    if (!this.webpackStats.takeChanged()) {\n+      return\n+    }\n     const webpackStats = this.mergeWebpackStats(this.webpackStats.values())\n     const path = join(this.distDir, 'server', WEBPACK_STATS)\n     deleteCache(path)\n@@ -280,7 +352,7 @@ export class TurbopackManifestLoader {\n   loadBuildManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.buildManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      readPartialManifest(this.distDir, BUILD_MANIFEST, pageName, type)\n+      readPartialManifestContent(this.distDir, BUILD_MANIFEST, pageName, type)\n     )\n   }\n \n@@ -290,7 +362,7 @@ export class TurbopackManifestLoader {\n   ): void {\n     this.clientBuildManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      readPartialManifest(\n+      readPartialManifestContent(\n         this.distDir,\n         TURBOPACK_CLIENT_BUILD_MANIFEST,\n         pageName,\n@@ -302,7 +374,7 @@ export class TurbopackManifestLoader {\n   loadWebpackStats(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.webpackStats.set(\n       getEntryKey(type, 'client', pageName),\n-      readPartialManifest(this.distDir, WEBPACK_STATS, pageName, type)\n+      readPartialManifestContent(this.distDir, WEBPACK_STATS, pageName, type)\n     )\n   }\n \n@@ -393,12 +465,12 @@ export class TurbopackManifestLoader {\n   }\n \n   private mergeClientBuildManifests(\n-    rewrites: CustomRoutes['rewrites'],\n     manifests: Iterable<ClientBuildManifest>,\n+    rewrites: CustomRoutes['rewrites'],\n     sortedPageKeys: string[]\n   ): ClientBuildManifest {\n     const manifest = {\n-      __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n+      __rewrites: rewrites as any,\n       sortedPages: sortedPageKeys,\n     }\n     for (const m of manifests) {\n@@ -407,8 +479,7 @@ export class TurbopackManifestLoader {\n     return sortObjectByKey(manifest)\n   }\n \n-  private writeBuildManifest(\n-    entrypoints: Entrypoints,\n+  private writeInterceptionRouteRewriteManifest(\n     devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n     productionRewrites: CustomRoutes['rewrites'] | undefined\n   ): void {\n@@ -418,21 +489,46 @@ export class TurbopackManifestLoader {\n       afterFiles: (devRewrites?.afterFiles ?? []).map(processRoute),\n       fallback: (devRewrites?.fallback ?? []).map(processRoute),\n     }\n+\n+    const interceptionRewrites = JSON.stringify(\n+      rewrites.beforeFiles.filter(isInterceptionRouteRewrite)\n+    )\n+\n+    if (this.cachedInterceptionRewrites === interceptionRewrites) {\n+      return\n+    }\n+    this.cachedInterceptionRewrites = interceptionRewrites\n+\n+    const interceptionRewriteManifestPath = join(\n+      this.distDir,\n+      'server',\n+      `${INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`\n+    )\n+    deleteCache(interceptionRewriteManifestPath)\n+\n+    writeFileAtomic(\n+      interceptionRewriteManifestPath,\n+      `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n+        interceptionRewrites\n+      )};`\n+    )\n+  }\n+\n+  private writeBuildManifest(): void {\n+    if (!this.buildManifests.takeChanged()) {\n+      return\n+    }\n     const buildManifest = this.mergeBuildManifests(this.buildManifests.values())\n+\n     const buildManifestPath = join(this.distDir, BUILD_MANIFEST)\n     const middlewareBuildManifestPath = join(\n       this.distDir,\n       'server',\n       `${MIDDLEWARE_BUILD_MANIFEST}.js`\n     )\n-    const interceptionRewriteManifestPath = join(\n-      this.distDir,\n-      'server',\n-      `${INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`\n-    )\n+\n     deleteCache(buildManifestPath)\n     deleteCache(middlewareBuildManifestPath)\n-    deleteCache(interceptionRewriteManifestPath)\n     writeFileAtomic(buildManifestPath, JSON.stringify(buildManifest, null, 2))\n     writeFileAtomic(\n       middlewareBuildManifestPath,\n@@ -441,15 +537,36 @@ export class TurbopackManifestLoader {\n       createEdgeRuntimeManifest(buildManifest)\n     )\n \n-    const interceptionRewrites = JSON.stringify(\n-      rewrites.beforeFiles.filter(isInterceptionRouteRewrite)\n+    // Write fallback build manifest\n+    const fallbackBuildManifest = this.mergeBuildManifests(\n+      [\n+        this.buildManifests.get(getEntryKey('pages', 'server', '_app')),\n+        this.buildManifests.get(getEntryKey('pages', 'server', '_error')),\n+      ].filter(Boolean) as BuildManifest[]\n     )\n-\n+    const fallbackBuildManifestPath = join(\n+      this.distDir,\n+      `fallback-${BUILD_MANIFEST}`\n+    )\n+    deleteCache(fallbackBuildManifestPath)\n     writeFileAtomic(\n-      interceptionRewriteManifestPath,\n-      `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n-        interceptionRewrites\n-      )};`\n+      fallbackBuildManifestPath,\n+      JSON.stringify(fallbackBuildManifest, null, 2)\n+    )\n+  }\n+\n+  private writeClientBuildManifest(\n+    entrypoints: Entrypoints,\n+    devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n+    productionRewrites: CustomRoutes['rewrites'] | undefined\n+  ): void {\n+    const rewrites = normalizeRewritesForBuildManifest(\n+      productionRewrites ?? {\n+        ...devRewrites,\n+        beforeFiles: (devRewrites?.beforeFiles ?? []).map(processRoute),\n+        afterFiles: (devRewrites?.afterFiles ?? []).map(processRoute),\n+        fallback: (devRewrites?.fallback ?? []).map(processRoute),\n+      }\n     )\n \n     const pagesKeys = [...entrypoints.page.keys()]\n@@ -461,9 +578,13 @@ export class TurbopackManifestLoader {\n     }\n \n     const sortedPageKeys = getSortedRoutes(pagesKeys)\n+\n+    if (!this.clientBuildManifests.takeChanged({ rewrites, sortedPageKeys })) {\n+      return\n+    }\n     const clientBuildManifest = this.mergeClientBuildManifests(\n-      rewrites,\n       this.clientBuildManifests.values(),\n+      rewrites,\n       sortedPageKeys\n     )\n     const clientBuildManifestJs = `self.__BUILD_MANIFEST = ${JSON.stringify(\n@@ -481,48 +602,10 @@ export class TurbopackManifestLoader {\n     )\n   }\n \n-  private writeClientMiddlewareManifest(): void {\n-    const middlewareManifest = this.mergeMiddlewareManifests(\n-      this.middlewareManifests.values()\n-    )\n-\n-    const matchers = middlewareManifest?.middleware['/']?.matchers || []\n-\n-    const clientMiddlewareManifestPath = join(\n-      this.distDir,\n-      'static',\n-      this.buildId,\n-      `${TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST}`\n-    )\n-    deleteCache(clientMiddlewareManifestPath)\n-    writeFileAtomic(\n-      clientMiddlewareManifestPath,\n-      JSON.stringify(matchers, null, 2)\n-    )\n-  }\n-\n-  private async writeFallbackBuildManifest(): Promise<void> {\n-    const fallbackBuildManifest = this.mergeBuildManifests(\n-      [\n-        this.buildManifests.get(getEntryKey('pages', 'server', '_app')),\n-        this.buildManifests.get(getEntryKey('pages', 'server', '_error')),\n-      ].filter(Boolean) as BuildManifest[]\n-    )\n-    const fallbackBuildManifestPath = join(\n-      this.distDir,\n-      `fallback-${BUILD_MANIFEST}`\n-    )\n-    deleteCache(fallbackBuildManifestPath)\n-    writeFileAtomic(\n-      fallbackBuildManifestPath,\n-      JSON.stringify(fallbackBuildManifest, null, 2)\n-    )\n-  }\n-\n   loadFontManifest(pageName: string, type: 'app' | 'pages' = 'pages'): void {\n     this.fontManifests.set(\n       getEntryKey(type, 'server', pageName),\n-      readPartialManifest(\n+      readPartialManifestContent(\n         this.distDir,\n         `${NEXT_FONT_MANIFEST}.json`,\n         pageName,\n@@ -553,6 +636,9 @@ export class TurbopackManifestLoader {\n   }\n \n   private async writeNextFontManifest(): Promise<void> {\n+    if (!this.fontManifests.takeChanged()) {\n+      return\n+    }\n     const fontManifest = this.mergeFontManifests(this.fontManifests.values())\n     const json = JSON.stringify(fontManifest, null, 2)\n \n@@ -601,7 +687,12 @@ export class TurbopackManifestLoader {\n         'server',\n         pageName\n       ),\n-      readPartialManifest(this.distDir, MIDDLEWARE_MANIFEST, pageName, type)\n+      readPartialManifestContent(\n+        this.distDir,\n+        MIDDLEWARE_MANIFEST,\n+        pageName,\n+        type\n+      )\n     )\n \n     return true\n@@ -669,10 +760,15 @@ export class TurbopackManifestLoader {\n   }\n \n   private writeMiddlewareManifest(): void {\n+    if (!this.middlewareManifests.takeChanged()) {\n+      return\n+    }\n     const middlewareManifest = this.mergeMiddlewareManifests(\n       this.middlewareManifests.values()\n     )\n \n+    // Server middleware manifest\n+\n     // Normalize regexes as it uses path-to-regexp\n     for (const key in middlewareManifest.middleware) {\n       middlewareManifest.middleware[key].matchers.forEach((matcher) => {\n@@ -696,12 +792,27 @@ export class TurbopackManifestLoader {\n       middlewareManifestPath,\n       JSON.stringify(middlewareManifest, null, 2)\n     )\n+\n+    // Client middleware manifest\n+    const matchers = middlewareManifest?.middleware['/']?.matchers || []\n+\n+    const clientMiddlewareManifestPath = join(\n+      this.distDir,\n+      'static',\n+      this.buildId,\n+      `${TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST}`\n+    )\n+    deleteCache(clientMiddlewareManifestPath)\n+    writeFileAtomic(\n+      clientMiddlewareManifestPath,\n+      JSON.stringify(matchers, null, 2)\n+    )\n   }\n \n   loadPagesManifest(pageName: string): void {\n     this.pagesManifests.set(\n       getEntryKey('pages', 'server', pageName),\n-      readPartialManifest(this.distDir, PAGES_MANIFEST, pageName)\n+      readPartialManifestContent(this.distDir, PAGES_MANIFEST, pageName)\n     )\n   }\n \n@@ -714,6 +825,9 @@ export class TurbopackManifestLoader {\n   }\n \n   private writePagesManifest(): void {\n+    if (!this.pagesManifests.takeChanged()) {\n+      return\n+    }\n     const pagesManifest = this.mergePagesManifests(this.pagesManifests.values())\n     const pagesManifestPath = join(this.distDir, 'server', PAGES_MANIFEST)\n     deleteCache(pagesManifestPath)\n@@ -731,10 +845,10 @@ export class TurbopackManifestLoader {\n   }): void {\n     this.writeActionManifest()\n     this.writeAppPathsManifest()\n-    this.writeBuildManifest(entrypoints, devRewrites, productionRewrites)\n-    this.writeFallbackBuildManifest()\n+    this.writeBuildManifest()\n+    this.writeInterceptionRouteRewriteManifest(devRewrites, productionRewrites)\n+    this.writeClientBuildManifest(entrypoints, devRewrites, productionRewrites)\n     this.writeMiddlewareManifest()\n-    this.writeClientMiddlewareManifest()\n     this.writeNextFontManifest()\n     this.writePagesManifest()\n "
        }
    ],
    "stats": {
        "total": 272,
        "additions": 193,
        "deletions": 79
    }
}