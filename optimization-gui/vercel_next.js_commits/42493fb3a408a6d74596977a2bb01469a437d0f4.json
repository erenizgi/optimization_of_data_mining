{
    "author": "huozhi",
    "message": "dx: avoid next-env.d.ts change in dev (#88103)",
    "sha": "42493fb3a408a6d74596977a2bb01469a437d0f4",
    "files": [
        {
            "sha": "f611008e00c33d6eb4e820ea67397abbf3179fb2",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -20,6 +20,7 @@ import { hrtimeDurationToString } from './duration-to-string'\n function verifyTypeScriptSetup(\n   dir: string,\n   distDir: string,\n+  distDirRoot: string | undefined,\n   typeCheckPreflight: boolean,\n   tsconfigPath: string | undefined,\n   disableStaticImages: boolean,\n@@ -50,6 +51,7 @@ function verifyTypeScriptSetup(\n     .verifyTypeScriptSetup({\n       dir,\n       distDir,\n+      distDirRoot,\n       typeCheckPreflight,\n       tsconfigPath,\n       disableStaticImages,\n@@ -117,6 +119,7 @@ export async function startTypeChecking({\n         verifyTypeScriptSetup(\n           dir,\n           config.distDir,\n+          config.distDirRoot,\n           !ignoreTypeScriptErrors,\n           config.typescript.tsconfigPath,\n           config.images.disableStaticImages,"
        },
        {
            "sha": "8d0b23e28433ec5beed52228913fc441694f5aa5",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -140,6 +140,7 @@ async function runPlaywright(\n     const { version: typeScriptVersion } = await verifyTypeScriptSetup({\n       dir: baseDir,\n       distDir: nextConfig.distDir,\n+      distDirRoot: nextConfig.distDirRoot,\n       typeCheckPreflight: false,\n       tsconfigPath: nextConfig.typescript.tsconfigPath,\n       disableStaticImages: nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "dfb5bf9eb2e79409750627e5433613b37e3c7798",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -57,6 +57,7 @@ const nextTypegen = async (\n   await verifyTypeScriptSetup({\n     dir: baseDir,\n     distDir: nextConfig.distDir,\n+    distDirRoot: nextConfig.distDirRoot,\n     typeCheckPreflight: false,\n     tsconfigPath: nextConfig.typescript.tsconfigPath,\n     disableStaticImages: nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "a3a92ddf40bbfba62d9d0e7faf3751ab1828f3ab",
            "filename": "packages/next/src/lib/typescript/writeAppTypeDeclarations.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -5,12 +5,15 @@ import { promises as fs } from 'fs'\n export async function writeAppTypeDeclarations({\n   baseDir,\n   distDir,\n+  distDirRoot,\n   imageImportsEnabled,\n   hasPagesDir,\n   hasAppDir,\n }: {\n   baseDir: string\n   distDir: string\n+  /** The original distDir before any modifications (e.g., for isolatedDevBuild). Used for stable type imports. */\n+  distDirRoot?: string\n   imageImportsEnabled: boolean\n   hasPagesDir: boolean\n   hasAppDir: boolean\n@@ -57,10 +60,12 @@ export async function writeAppTypeDeclarations({\n     )\n   }\n \n-  const routeTypesPath = path.posix.join(\n-    distDir.replaceAll(path.win32.sep, path.posix.sep),\n-    'types/routes.d.ts'\n+  // Use distDirRoot for stable path that doesn't change between dev/build modes\n+  const stableDistDir = (distDirRoot ?? distDir).replaceAll(\n+    path.win32.sep,\n+    path.posix.sep\n   )\n+  const routeTypesPath = path.posix.join(stableDistDir, 'types/routes.d.ts')\n \n   // Use ESM import instead of triple-slash reference for better ESLint compatibility\n   directives.push(`import \"./${routeTypesPath}\";`)"
        },
        {
            "sha": "0c0c50f2a1f854e59c93beac00547b6f17215892",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -36,6 +36,7 @@ const requiredPackages = [\n export async function verifyTypeScriptSetup({\n   dir,\n   distDir,\n+  distDirRoot,\n   cacheDir,\n   tsconfigPath,\n   typeCheckPreflight,\n@@ -49,6 +50,8 @@ export async function verifyTypeScriptSetup({\n }: {\n   dir: string\n   distDir: string\n+  /** The original distDir before any modifications (e.g., for isolatedDevBuild). */\n+  distDirRoot?: string\n   cacheDir?: string\n   tsconfigPath: string | undefined\n   typeCheckPreflight: boolean\n@@ -143,6 +146,7 @@ export async function verifyTypeScriptSetup({\n     await writeAppTypeDeclarations({\n       baseDir: dir,\n       distDir,\n+      distDirRoot,\n       imageImportsEnabled: !disableStaticImages,\n       hasPagesDir,\n       hasAppDir,"
        },
        {
            "sha": "d1c8cf31931c38c1f2fb8877430eafc4e48d551c",
            "filename": "packages/next/src/server/lib/router-utils/route-types-utils.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -395,3 +395,28 @@ export async function writeValidatorFile(\n       : generateValidatorFile(manifest)\n   )\n }\n+\n+/**\n+ * Writes a proxy routes.d.ts file at the stable path that re-exports from\n+ * the actual dev types location. This allows next-env.d.ts to always reference\n+ * the same stable path regardless of dev/build mode.\n+ *\n+ * @param stableTypesDir - The stable types directory (e.g., .next/types)\n+ * @param devTypesRelativePath - Relative path from stable dir to dev types (e.g., ../dev/types/routes.d.ts)\n+ */\n+export async function writeRouteTypesProxy(\n+  stableTypesDir: string,\n+  devTypesRelativePath: string\n+) {\n+  if (!fs.existsSync(stableTypesDir)) {\n+    await fs.promises.mkdir(stableTypesDir, { recursive: true })\n+  }\n+\n+  const proxyFilePath = path.join(stableTypesDir, 'routes.d.ts')\n+  const proxyContent = `// This file re-exports route types from the dev types location.\n+// This provides a stable import path for next-env.d.ts across dev/build modes.\n+export * from '${devTypesRelativePath}';\n+`\n+\n+  await fs.promises.writeFile(proxyFilePath, proxyContent)\n+}"
        },
        {
            "sha": "753b60bea15a8f41b723b03251064aad57d7a172",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -85,6 +85,7 @@ import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n   writeValidatorFile,\n+  writeRouteTypesProxy,\n } from './route-types-utils'\n import { writeCacheLifeTypes } from './cache-life-type-utils'\n import { isParallelRouteSegment } from '../../../shared/lib/segment'\n@@ -143,6 +144,7 @@ async function verifyTypeScript(opts: SetupOpts) {\n   const verifyResult = await verifyTypeScriptSetup({\n     dir: opts.dir,\n     distDir: opts.nextConfig.distDir,\n+    distDirRoot: opts.nextConfig.distDirRoot,\n     typeCheckPreflight: false,\n     tsconfigPath: opts.nextConfig.typescript.tsconfigPath,\n     disableStaticImages: opts.nextConfig.images.disableStaticImages,\n@@ -266,6 +268,17 @@ async function startWatcher(\n     opts.nextConfig\n   )\n \n+  // When isolatedDevBuild is enabled, write a proxy file at the stable path\n+  // that re-exports from the dev types location\n+  if (opts.nextConfig.experimental.isolatedDevBuild) {\n+    const stableTypesDir = path.join(\n+      opts.dir,\n+      opts.nextConfig.distDirRoot,\n+      'types'\n+    )\n+    await writeRouteTypesProxy(stableTypesDir, '../dev/types/routes.d.ts')\n+  }\n+\n   const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n   const routesManifest: DevRoutesManifest = {\n     version: 3,"
        },
        {
            "sha": "cab96685c25caec4cb11703dcc97a0a2b830b79a",
            "filename": "test/development/app-dir/isolated-dev-build/isolated-dev-build.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -23,4 +23,32 @@ describe('isolated-dev-build', () => {\n       expect(await browser.elementByCss('p').text()).toBe('hello updated world')\n     })\n   })\n+\n+  it('should use stable path in next-env.d.ts that does not change between dev/build', async () => {\n+    const nextEnvContent = await next.readFile('next-env.d.ts')\n+    // Snapshot ensures next-env.d.ts content stays stable\n+    expect(nextEnvContent).toMatchInlineSnapshot(`\n+      \"/// <reference types=\"next\" />\n+      /// <reference types=\"next/image-types/global\" />\n+      import \"./.next/types/routes.d.ts\";\n+\n+      // NOTE: This file should not be edited\n+      // see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n+      \"\n+    `)\n+  })\n+\n+  it('should create proxy routes.d.ts at stable path that re-exports from dev types', async () => {\n+    // The proxy file should re-export from the dev types location\n+    const proxyContent = await next.readFile('.next/types/routes.d.ts')\n+    expect(proxyContent).toMatchInlineSnapshot(`\n+      \"// This file re-exports route types from the dev types location.\n+      // This provides a stable import path for next-env.d.ts across dev/build modes.\n+      export * from '../dev/types/routes.d.ts';\n+      \"\n+    `)\n+\n+    // The actual dev types should exist\n+    expect(await next.hasFile('.next/dev/types/routes.d.ts')).toBe(true)\n+  })\n })"
        },
        {
            "sha": "1a1bf607fce1de824806056665c659c96cbf57a2",
            "filename": "test/integration/custom-server-types/next-env.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -1,6 +1,6 @@\n /// <reference types=\"next\" />\n /// <reference types=\"next/image-types/global\" />\n-import './.next/dev/types/routes.d.ts'\n+import './.next/types/routes.d.ts'\n \n // NOTE: This file should not be edited\n // see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        },
        {
            "sha": "19709046afd624ff9177b3d2c2c31708d50c4a2b",
            "filename": "test/integration/typescript-app-type-declarations/next-env.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42493fb3a408a6d74596977a2bb01469a437d0f4/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts?ref=42493fb3a408a6d74596977a2bb01469a437d0f4",
            "patch": "@@ -1,6 +1,6 @@\n /// <reference types=\"next\" />\n /// <reference types=\"next/image-types/global\" />\n-import \"./.next/dev/types/routes.d.ts\";\n+import \"./.next/types/routes.d.ts\";\n \n // NOTE: This file should not be edited\n // see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        }
    ],
    "stats": {
        "total": 90,
        "additions": 85,
        "deletions": 5
    }
}