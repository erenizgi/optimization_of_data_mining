{
    "author": "eps1lon",
    "message": "[test] Account for React's usage of `eval` in dev (#80857)",
    "sha": "a505b8f255dcef702013bb96918b05ccedd85d81",
    "files": [
        {
            "sha": "b195e00538859e54be60bf8b0d54ff23178bb29d",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 33,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/a505b8f255dcef702013bb96918b05ccedd85d81/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a505b8f255dcef702013bb96918b05ccedd85d81/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=a505b8f255dcef702013bb96918b05ccedd85d81",
            "patch": "@@ -1814,40 +1814,24 @@ describe('app dir - basic', () => {\n       expect($('body').find('script[async]').length).toBe(1)\n     })\n \n-    // Turbopack doesn't use eval by default, so we can check strict CSP.\n-    if (!isNextDev || isTurbopack) {\n-      // This test is here to ensure that we don't accidentally turn CSP off\n-      // for the prod version.\n-      it('should successfully bootstrap even when using CSP', async () => {\n-        // This path has a nonce applied in middleware\n-        const browser = await next.browser('/bootstrap/with-nonce')\n-        const response = await next.fetch('/bootstrap/with-nonce')\n-        // We expect this page to response with CSP headers requiring a nonce for scripts\n-        expect(response.headers.get('content-security-policy')).toContain(\n-          \"script-src 'nonce\"\n-        )\n-        // We expect to find the updated text which demonstrates our app\n-        // was able to bootstrap successfully (scripts run)\n-        expect(\n-          await browser.eval('document.getElementById(\"val\").textContent')\n-        ).toBe('[[updated]]')\n-      })\n-    } else {\n-      it('should fail to bootstrap when using CSP in Dev due to eval', async () => {\n-        const browser = await next.browser('/bootstrap/with-nonce')\n-        // We expect our app to fail to bootstrap due to invalid eval use in Dev.\n-        // We assert the html is in it's SSR'd state.\n-        expect(\n-          await browser.eval('document.getElementById(\"val\").textContent')\n-        ).toBe('initial')\n-\n-        const response = await next.fetch('/bootstrap/with-nonce')\n-        // We expect this page to response with CSP headers requiring a nonce for scripts\n-        expect(response.headers.get('content-security-policy')).toContain(\n-          \"script-src 'nonce\"\n-        )\n+    // This test is here to ensure that we don't accidentally turn CSP off\n+    // for the prod version.\n+    it('should successfully bootstrap even when using CSP', async () => {\n+      // This path has a nonce applied in middleware\n+      const browser = await next.browser('/bootstrap/with-nonce')\n+      const response = await next.fetch('/bootstrap/with-nonce')\n+      // We expect this page to response with CSP headers requiring a nonce for scripts\n+      expect(response.headers.get('content-security-policy')).toEqual(\n+        isNextDev\n+          ? \"script-src 'nonce-my-random-nonce' 'strict-dynamic' 'unsafe-eval';\"\n+          : \"script-src 'nonce-my-random-nonce' 'strict-dynamic';\"\n+      )\n+      // We expect to find the updated text which demonstrates our app\n+      // was able to bootstrap successfully (scripts run)\n+      await retry(async () => {\n+        expect(await browser.elementByCss('#val').text()).toEqual('[[updated]]')\n       })\n-    }\n+    })\n   })\n \n   // this one comes at the end to not change behavior from above"
        },
        {
            "sha": "021d1cdf0f7a0aad3a973d3680760b24baaf9248",
            "filename": "test/e2e/app-dir/app/middleware.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a505b8f255dcef702013bb96918b05ccedd85d81/test%2Fe2e%2Fapp-dir%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a505b8f255dcef702013bb96918b05ccedd85d81/test%2Fe2e%2Fapp-dir%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fmiddleware.js?ref=a505b8f255dcef702013bb96918b05ccedd85d81",
            "patch": "@@ -25,13 +25,13 @@ export async function middleware(request) {\n     return NextResponse.rewrite(new URL('/dashboard', request.url))\n   }\n \n-  // In dev this route will fail to bootstrap because webpack uses eval which is dissallowed by\n-  // this policy. In production this route will work\n   if (request.nextUrl.pathname === '/bootstrap/with-nonce') {\n-    const nonce = crypto.randomUUID()\n+    // In a real app, crypto.randomUUID() would be used to generate a safe nonce.\n+    // React and Webpack use eval() in development mode, so we need to allow it.\n+    const csp = `script-src 'nonce-my-random-nonce' 'strict-dynamic'${process.env.NODE_ENV !== 'production' ? \" 'unsafe-eval'\" : ''};`\n     return NextResponse.next({\n       headers: {\n-        'Content-Security-Policy': `script-src 'nonce-${nonce}' 'strict-dynamic';`,\n+        'Content-Security-Policy': csp,\n       },\n     })\n   }"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 21,
        "deletions": 37
    }
}