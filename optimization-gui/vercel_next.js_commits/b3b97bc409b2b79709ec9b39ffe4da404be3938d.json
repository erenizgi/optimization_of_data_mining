{
    "author": "eps1lon",
    "message": "Allow attaching a debugger when `next dev` is already running (#86083)",
    "sha": "b3b97bc409b2b79709ec9b39ffe4da404be3938d",
    "files": [
        {
            "sha": "91f761796bd777289721db9ee85f6d02dfb9114d",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -924,5 +924,6 @@\n   \"923\": \"%s is being parsed as a normalized route, but it has a route group or parallel route segment.\",\n   \"924\": \"Invalid interception route: %s\",\n   \"925\": \"You cannot define a route with the same specificity as an optional catch-all route (\\\"%s\\\" and \\\"/[[...%s]]\\\").\",\n-  \"926\": \"Optional route parameters are not yet supported (\\\"[%s]\\\") in route \\\"%s\\\".\"\n+  \"926\": \"Optional route parameters are not yet supported (\\\"[%s]\\\") in route \\\"%s\\\".\",\n+  \"927\": \"No debug targets found\"\n }"
        },
        {
            "sha": "3e58241700cccd324493f6ca678a406fe77c7594",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/error-overlay-toolbar.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -23,7 +23,8 @@ export function ErrorOverlayToolbar({\n       <CopyErrorButton error={error} generateErrorInfo={generateErrorInfo} />\n       <DocsLinkButton errorMessage={error.message} />\n       <NodejsInspectorButton\n-        devtoolsFrontendUrl={debugInfo?.devtoolsFrontendUrl}\n+        key={debugInfo?.devtoolsFrontendUrl}\n+        defaultDevtoolsFrontendUrl={debugInfo?.devtoolsFrontendUrl}\n       />\n     </span>\n   )\n@@ -73,6 +74,10 @@ export const styles = `\n     }\n   }\n \n+  .nodejs-inspector-button[data-pending='true'] {\n+    cursor: wait;\n+  }\n+\n   .error-overlay-toolbar-button-icon {\n     color: var(--color-gray-900);\n   }"
        },
        {
            "sha": "f5df62d85f2cefc648d7bc90296d2d92ed97ddf5",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/nodejs-inspector-button.stories.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.stories.tsx?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -15,12 +15,13 @@ type Story = StoryObj<typeof NodejsInspectorButton>\n \n export const WithDevtoolsUrl: Story = {\n   args: {\n-    devtoolsFrontendUrl: 'chrome-devtools://devtools/bundled/inspector.html',\n+    defaultDevtoolsFrontendUrl:\n+      'chrome-devtools://devtools/bundled/inspector.html',\n   },\n }\n \n export const WithoutDevtoolsUrl: Story = {\n   args: {\n-    devtoolsFrontendUrl: undefined,\n+    defaultDevtoolsFrontendUrl: undefined,\n   },\n }"
        },
        {
            "sha": "f6da9fd696ccc5326903e561ce981e65041af194",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/nodejs-inspector-button.tsx",
            "status": "modified",
            "additions": 62,
            "deletions": 33,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Fnodejs-inspector-button.tsx?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -1,21 +1,6 @@\n+import { startTransition, useActionState, useEffect } from 'react'\n import { CopyButton } from '../../copy-button'\n \n-// Inline this helper to avoid widely used across the codebase,\n-// as for this feature the Chrome detector doesn't need to be super accurate.\n-function isChrome() {\n-  if (typeof window === 'undefined') return false\n-  const isChromium = 'chrome' in window && window.chrome\n-  const vendorName = window.navigator.vendor\n-\n-  return (\n-    isChromium !== null &&\n-    isChromium !== undefined &&\n-    vendorName === 'Google Inc.'\n-  )\n-}\n-\n-const isChromeBrowser = isChrome()\n-\n function NodeJsIcon(props: any) {\n   return (\n     <svg\n@@ -248,41 +233,85 @@ function NodeJsDisabledIcon(props: any) {\n   )\n }\n \n-const label =\n-  'Learn more about enabling Node.js inspector for server code with Chrome DevTools'\n-\n export function NodejsInspectorButton({\n-  devtoolsFrontendUrl,\n+  defaultDevtoolsFrontendUrl,\n }: {\n-  devtoolsFrontendUrl: string | undefined\n+  defaultDevtoolsFrontendUrl: string | undefined\n }) {\n-  const content = devtoolsFrontendUrl || ''\n-  const disabled = !content || !isChromeBrowser\n-  if (disabled) {\n+  const [devtoolsFrontendUrlState, attachDebuggerAction, isAttachingDebugger] =\n+    useActionState<\n+      | { status: 'fulfilled'; value: string | undefined }\n+      | { status: 'rejected'; reason: unknown }\n+    >(\n+      async () => {\n+        try {\n+          const response = await fetch('/__nextjs_attach-nodejs-inspector', {\n+            method: 'POST',\n+          })\n+          if (!response.ok) {\n+            throw new Error(\n+              `${response.status} ${response.statusText}: ${await response.text()}`\n+            )\n+          }\n+          const devtoolsFrontendUrl = await response.json()\n+          return {\n+            status: 'fulfilled',\n+            value: devtoolsFrontendUrl,\n+          }\n+        } catch (cause) {\n+          return {\n+            status: 'rejected',\n+            reason: new Error(\n+              'Failed to attach Node.js inspector: ' +\n+                // TODO: Use `cause` property once Redbox supports displaying `cause`\n+                String(cause)\n+            ),\n+          }\n+        }\n+      },\n+      { status: 'fulfilled', value: defaultDevtoolsFrontendUrl }\n+    )\n+\n+  const devtoolsFrontendUrl =\n+    devtoolsFrontendUrlState.status === 'fulfilled'\n+      ? devtoolsFrontendUrlState.value\n+      : undefined\n+\n+  useEffect(() => {\n+    if (devtoolsFrontendUrlState.status === 'rejected') {\n+      console.error(devtoolsFrontendUrlState.reason)\n+    }\n+  }, [devtoolsFrontendUrlState])\n+\n+  const attachDebugger = startTransition.bind(null, attachDebuggerAction)\n+\n+  if (devtoolsFrontendUrl === undefined) {\n     return (\n-      <a\n-        title={label}\n-        aria-label={label}\n+      <button\n         className=\"nodejs-inspector-button\"\n-        href={`https://nextjs.org/docs/app/building-your-application/configuring/debugging#server-side-code`}\n-        target=\"_blank\"\n-        rel=\"noopener noreferrer\"\n+        data-pending={isAttachingDebugger}\n+        onClick={isAttachingDebugger ? undefined : attachDebugger}\n+        title={\n+          devtoolsFrontendUrlState.status === 'rejected'\n+            ? 'Retry attaching Node.js inspector'\n+            : 'Attach Node.js inspector'\n+        }\n       >\n         <NodeJsDisabledIcon\n           className=\"error-overlay-toolbar-button-icon\"\n           width={14}\n           height={14}\n         />\n-      </a>\n+      </button>\n     )\n   }\n   return (\n     <CopyButton\n       data-nextjs-data-runtime-error-copy-devtools-url\n       className=\"nodejs-inspector-button\"\n-      actionLabel={'Copy Chrome DevTools URL'}\n+      actionLabel={'Copy DevTools URL for Chrome'}\n       successLabel=\"Copied\"\n-      content={content}\n+      content={devtoolsFrontendUrl}\n       icon={\n         <NodeJsIcon\n           className=\"error-overlay-toolbar-button-icon\""
        },
        {
            "sha": "1163f02a03c1841464db53ecd02648f3e2e414c7",
            "filename": "packages/next/src/next-devtools/server/attach-nodejs-debugger-middleware.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fattach-nodejs-debugger-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fattach-nodejs-debugger-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fattach-nodejs-debugger-middleware.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -0,0 +1,48 @@\n+import { middlewareResponse } from './middleware-response'\n+import type { ServerResponse, IncomingMessage } from 'http'\n+import * as inspector from 'inspector'\n+\n+export function getAttachNodejsDebuggerMiddleware() {\n+  return async function (\n+    req: IncomingMessage,\n+    res: ServerResponse,\n+    next: () => void\n+  ): Promise<void> {\n+    const { pathname } = new URL(`http://n${req.url}`)\n+\n+    if (pathname !== '/__nextjs_attach-nodejs-inspector') {\n+      return next()\n+    }\n+\n+    try {\n+      const isInspecting = inspector.url() !== undefined\n+      const debugPort = process.debugPort\n+      if (!isInspecting) {\n+        // Node.js will already log that the inspector is listening.\n+        inspector.open(debugPort)\n+      }\n+\n+      const inspectorURLRaw = inspector.url()\n+      if (inspectorURLRaw === undefined) {\n+        // could not open, possibly because already in use.\n+        return middlewareResponse.badRequest(\n+          res,\n+          `Failed to open port \"${debugPort}\". Address may be already in use.`\n+        )\n+      }\n+      const inspectorURL = new URL(inspectorURLRaw)\n+\n+      const debugInfoListResponse = await fetch(\n+        `http://${inspectorURL.host}/json/list`\n+      )\n+      const debugInfoList = await debugInfoListResponse.json()\n+      if (!Array.isArray(debugInfoList) || debugInfoList.length === 0) {\n+        throw new Error('No debug targets found')\n+      }\n+\n+      return middlewareResponse.json(res, debugInfoList[0].devtoolsFrontendUrl)\n+    } catch (error) {\n+      return middlewareResponse.internalServerError(res)\n+    }\n+  }\n+}"
        },
        {
            "sha": "7b1c3be839cde2a45803fa19d702f2c954128155",
            "filename": "packages/next/src/next-devtools/server/middleware-response.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fmiddleware-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fmiddleware-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Fmiddleware-response.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -6,9 +6,14 @@ export const middlewareResponse = {\n     res.statusCode = 204\n     res.end('No Content')\n   },\n-  badRequest(res: ServerResponse) {\n+  badRequest(res: ServerResponse, reason?: string) {\n     res.statusCode = 400\n-    res.end('Bad Request')\n+    if (reason !== undefined) {\n+      res.setHeader('Content-Type', 'text/plain')\n+      res.end(reason)\n+    } else {\n+      res.end()\n+    }\n   },\n   notFound(res: ServerResponse) {\n     res.statusCode = 404"
        },
        {
            "sha": "0daac24ed79228723b2fb063e8b2e2d34485f500",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -107,6 +107,7 @@ import {\n   devToolsConfigMiddleware,\n   getDevToolsConfig,\n } from '../../next-devtools/server/devtools-config-middleware'\n+import { getAttachNodejsDebuggerMiddleware } from '../../next-devtools/server/attach-nodejs-debugger-middleware'\n import {\n   connectReactDebugChannel,\n   connectReactDebugChannelForHtmlRequest,\n@@ -773,6 +774,7 @@ export async function createHotReloaderTurbopack(\n         })\n       },\n     }),\n+    getAttachNodejsDebuggerMiddleware(),\n     ...(nextConfig.experimental.mcpServer\n       ? [\n           getMcpMiddleware({"
        },
        {
            "sha": "4a61dd15768017b42ef66ed07f610181f00f3bac",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -96,6 +96,7 @@ import {\n   devToolsConfigMiddleware,\n   getDevToolsConfig,\n } from '../../next-devtools/server/devtools-config-middleware'\n+import { getAttachNodejsDebuggerMiddleware } from '../../next-devtools/server/attach-nodejs-debugger-middleware'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import {\n   connectReactDebugChannel,\n@@ -1667,6 +1668,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n           })\n         },\n       }),\n+      getAttachNodejsDebuggerMiddleware(),\n       ...(this.config.experimental.mcpServer\n         ? [\n             getMcpMiddleware({"
        },
        {
            "sha": "6959b22708442c0a565108c4c7a9c2e41a27d9ae",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -430,6 +430,7 @@ export default class DevServer extends Server {\n        */\n       if (\n         request.url.includes('/_next/static') ||\n+        request.url.includes('/__nextjs_attach-nodejs-inspector') ||\n         request.url.includes('/__nextjs_original-stack-frame') ||\n         request.url.includes('/__nextjs_source-map') ||\n         request.url.includes('/__nextjs_error_feedback')"
        },
        {
            "sha": "e4d6b204a5156521da3cba585c24fccfe25af716",
            "filename": "test/development/app-dir/devtool-copy-button/devtool-copy-button.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b3b97bc409b2b79709ec9b39ffe4da404be3938d/test%2Fdevelopment%2Fapp-dir%2Fdevtool-copy-button%2Fdevtool-copy-button.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b3b97bc409b2b79709ec9b39ffe4da404be3938d/test%2Fdevelopment%2Fapp-dir%2Fdevtool-copy-button%2Fdevtool-copy-button.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdevtool-copy-button%2Fdevtool-copy-button.test.ts?ref=b3b97bc409b2b79709ec9b39ffe4da404be3938d",
            "patch": "@@ -15,6 +15,6 @@ describe('app-dir - devtool-copy-button', () => {\n       await browser\n         .elementByCss('[data-nextjs-data-runtime-error-copy-devtools-url]')\n         .getAttribute('aria-label')\n-    ).toBe('Copy Chrome DevTools URL')\n+    ).toBe('Copy DevTools URL for Chrome')\n   })\n })"
        }
    ],
    "stats": {
        "total": 174,
        "additions": 134,
        "deletions": 40
    }
}