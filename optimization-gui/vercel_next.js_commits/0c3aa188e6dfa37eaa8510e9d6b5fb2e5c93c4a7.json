{
    "author": "acdlite",
    "message": "Fix: External redirect swallowed by Next.js (#87121)\n\nFix for a regression introduced by\nhttps://github.com/vercel/next.js/pull/86367.\n\nWhen a Server Action performed an external redirect, Next.js was no\nlonger triggering an MPA navigation from directly inside the response\nhandler. It would end up working regardless if the Server Action was\ncalled from a React action, like a form action or useTransition hook,\nbecause the Server Action would rethrow the redirect error and trigger a\n\"late\" redirect during rendering. But if the Server Action was called\nfrom outside of a React scope — onClick, for example — it would do\nnothing.",
    "sha": "0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
    "files": [
        {
            "sha": "fe1533a15db07599a307c19c34cc6e6d946fb26b",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 18,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -60,6 +60,7 @@ import {\n   ActionDidRevalidateStaticAndDynamic,\n   type ActionRevalidationKind,\n } from '../../../../shared/lib/action-revalidation-kind'\n+import { isExternalURL } from '../../app-router-utils'\n \n const createFromFetch =\n   createFromFetchBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromFetch']\n@@ -299,37 +300,48 @@ export function serverActionReducer(\n         }\n       }\n \n+      const pendingPush = redirectType !== RedirectType.replace\n+      state.pushRef.pendingPush = pendingPush\n+      mutable.pendingPush = pendingPush\n+\n       if (redirectLocation !== undefined) {\n         // If the action triggered a redirect, the action promise will be rejected with\n         // a redirect so that it's handled by RedirectBoundary as we won't have a valid\n         // action result to resolve the promise with. This will effectively reset the state of\n         // the component that called the action as the error boundary will remount the tree.\n         // The status code doesn't matter here as the action handler will have already sent\n         // a response with the correct status code.\n-        const redirectHref = createHrefFromUrl(redirectLocation, false)\n         const resolvedRedirectType = redirectType || RedirectType.push\n-        const redirectError = getRedirectError(\n-          hasBasePath(redirectHref)\n-            ? removeBasePath(redirectHref)\n-            : redirectHref,\n-          resolvedRedirectType\n-        )\n-        // We mark the error as handled because we don't want the redirect to be tried later by\n-        // the RedirectBoundary, in case the user goes back and `Activity` triggers the redirect\n-        // again, as it's run within an effect.\n-        // We don't actually need the RedirectBoundary to do a router.push because we already\n-        // have all the necessary RSC data to render the new page within a single roundtrip.\n-        ;(redirectError as any).handled = true\n-        reject(redirectError)\n+\n+        if (isExternalURL(redirectLocation)) {\n+          // External redirect. Triggers an MPA navigation.\n+          const redirectHref = redirectLocation.href\n+          const redirectError = createRedirectErrorForAction(\n+            redirectHref,\n+            resolvedRedirectType\n+          )\n+          reject(redirectError)\n+          return handleExternalUrl(state, mutable, redirectHref, pendingPush)\n+        } else {\n+          // Internal redirect. Triggers an SPA navigation.\n+          const redirectWithBasepath = createHrefFromUrl(\n+            redirectLocation,\n+            false\n+          )\n+          const redirectHref = hasBasePath(redirectWithBasepath)\n+            ? removeBasePath(redirectWithBasepath)\n+            : redirectWithBasepath\n+          const redirectError = createRedirectErrorForAction(\n+            redirectHref,\n+            resolvedRedirectType\n+          )\n+          reject(redirectError)\n+        }\n       } else {\n         // If there's no redirect, resolve the action with the result.\n         resolve(actionResult)\n       }\n \n-      const pendingPush = redirectType !== RedirectType.replace\n-      state.pushRef.pendingPush = pendingPush\n-      mutable.pendingPush = pendingPush\n-\n       // Check if we can bail out without updating any state.\n       if (\n         // Did the action trigger a redirect?\n@@ -451,3 +463,17 @@ export function serverActionReducer(\n     }\n   )\n }\n+\n+function createRedirectErrorForAction(\n+  redirectHref: string,\n+  resolvedRedirectType: RedirectType\n+) {\n+  const redirectError = getRedirectError(redirectHref, resolvedRedirectType)\n+  // We mark the error as handled because we don't want the redirect to be tried later by\n+  // the RedirectBoundary, in case the user goes back and `Activity` triggers the redirect\n+  // again, as it's run within an effect.\n+  // We don't actually need the RedirectBoundary to do a router.push because we already\n+  // have all the necessary RSC data to render the new page within a single roundtrip.\n+  ;(redirectError as any).handled = true\n+  return redirectError\n+}"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/e2e/app-dir/external-redirect/app/client.tsx",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fclient.tsx?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/external-redirect/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Flayout.tsx?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "6a52ee7bf67571e64c1202fc25c7dbf6f80498ba",
            "filename": "test/e2e/app-dir/external-redirect/app/page.tsx",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fapp%2Fpage.tsx?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -0,0 +1,29 @@\n+import { redirect } from 'next/navigation'\n+\n+export default function Page() {\n+  //\n+  return (\n+    <>\n+      <p>\n+        This tests a regression case where an action called outside of a React\n+        transition scope (onClick, in this case) results in a server-side\n+        redirect. Before the fix, the external redirect would get swallowed by\n+        Next.js.\n+      </p>\n+      <p>\n+        Clicking the button should redirect to localhost:9292. (The redirect\n+        doesn't need to actually load; the associated e2e test will intercept\n+        the request.)\n+      </p>\n+      <button\n+        id=\"external-redirect-from-action-on-click\"\n+        onClick={async () => {\n+          'use server'\n+          redirect('http://localhost:9292')\n+        }}\n+      >\n+        External Redirect\n+      </button>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "c6848d479aef8cacef3a5d226cd017eae08edf71",
            "filename": "test/e2e/app-dir/external-redirect/components/link-accordion.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fcomponents%2Flink-accordion.tsx?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -0,0 +1,33 @@\n+'use client'\n+\n+import Link, { type LinkProps } from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({\n+  href,\n+  children,\n+  prefetch,\n+}: {\n+  href: string\n+  children: React.ReactNode\n+  prefetch?: LinkProps['prefetch']\n+}) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href} prefetch={prefetch}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "08c343befa88ec6b8815d5edcda02899a74a6c2d",
            "filename": "test/e2e/app-dir/external-redirect/external-redirect.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fexternal-redirect.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fexternal-redirect.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fexternal-redirect.test.ts?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -0,0 +1,33 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('external-redirect', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('regression: Server Action triggered from onClick redirects to external URL', async () => {\n+    let page\n+    const browser = await next.browser('/', {\n+      async beforePageLoad(p) {\n+        page = p\n+        await page.route('**/*', (route) => {\n+          const req = route.request()\n+          // Intercept the request to the external page and mock the response.\n+          if (req.url().includes('localhost:9292')) {\n+            return route.fulfill({\n+              status: 200,\n+              body: '<!DOCTYPE html><html><body>External page</body></html>',\n+            })\n+          }\n+          return route.continue()\n+        })\n+      },\n+    })\n+    const button = await browser.elementById(\n+      'external-redirect-from-action-on-click'\n+    )\n+    await button.click()\n+    await page.waitForNavigation('http://localhost:9292')\n+    expect(await page.innerHTML('body')).toBe('External page')\n+  })\n+})"
        },
        {
            "sha": "e64bae22d658030ef118a8b53c925258ae17563f",
            "filename": "test/e2e/app-dir/external-redirect/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fexternal-redirect%2Fnext.config.js?ref=0c3aa188e6dfa37eaa8510e9d6b5fb2e5c93c4a7",
            "patch": "@@ -0,0 +1,8 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  cacheComponents: true,\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 158,
        "deletions": 18
    }
}