{
    "author": "wbinnssmith",
    "message": "Turbopack: Make `napi` crate Rust 2024 (#79123)\n\nThis required explicitly wrapping certain calls in `unsafe` blocks.",
    "sha": "02219cc880e0991b2060f1591757d97d9f678f9f",
    "files": [
        {
            "sha": "f835f8d43534b444f609804c6720b21e285d5e89",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -1,5 +1,5 @@\n [package]\n-edition = \"2021\"\n+edition = \"2024\"\n name = \"next-swc-napi\"\n version = \"0.0.0\"\n publish = false"
        },
        {
            "sha": "6d4bd57ffa708e1daf572d0047ec5fff7b3ed027",
            "filename": "crates/napi/src/mdx.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fmdx.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fmdx.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fmdx.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -1,4 +1,4 @@\n-use mdxjs::{compile, Options};\n+use mdxjs::{Options, compile};\n use napi::bindgen_prelude::*;\n \n pub struct MdxCompileTask {"
        },
        {
            "sha": "6d9f2a85e2886522de38b586c081b353d3f67a0a",
            "filename": "crates/napi/src/minify.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fminify.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -30,8 +30,8 @@ use napi::bindgen_prelude::*;\n use rustc_hash::FxHashMap;\n use serde::Deserialize;\n use swc_core::{\n-    base::{config::JsMinifyOptions, try_with_handler, TransformOutput},\n-    common::{errors::ColorConfig, sync::Lrc, FileName, SourceFile, SourceMap, GLOBALS},\n+    base::{TransformOutput, config::JsMinifyOptions, try_with_handler},\n+    common::{FileName, GLOBALS, SourceFile, SourceMap, errors::ColorConfig, sync::Lrc},\n };\n \n use crate::{get_compiler, util::MapErr};"
        },
        {
            "sha": "83961eb77f6b301533b2dc9de38f6b7f65c61d3c",
            "filename": "crates/napi/src/next_api/endpoint.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -1,22 +1,22 @@\n use std::{ops::Deref, sync::Arc};\n \n use anyhow::Result;\n-use napi::{bindgen_prelude::External, JsFunction};\n+use napi::{JsFunction, bindgen_prelude::External};\n use next_api::{\n     operation::OptionEndpoint,\n     paths::ServerPath,\n     route::{\n-        endpoint_client_changed_operation, endpoint_server_changed_operation,\n-        endpoint_write_to_disk_operation, EndpointOutputPaths,\n+        EndpointOutputPaths, endpoint_client_changed_operation, endpoint_server_changed_operation,\n+        endpoint_write_to_disk_operation,\n     },\n };\n use tracing::Instrument;\n use turbo_tasks::{Completion, Effects, OperationVc, ReadRef, Vc};\n use turbopack_core::{diagnostics::PlainDiagnostic, error::PrettyPrintError, issue::PlainIssue};\n \n use super::utils::{\n-    strongly_consistent_catch_collectables, subscribe, NapiDiagnostic, NapiIssue, RootTask,\n-    TurbopackResult, VcArc,\n+    NapiDiagnostic, NapiIssue, RootTask, TurbopackResult, VcArc,\n+    strongly_consistent_catch_collectables, subscribe,\n };\n \n #[napi(object)]"
        },
        {
            "sha": "e01df905e26b07655a83d163b3c4930815c8ccc9",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -1,10 +1,10 @@\n use std::{io::Write, path::PathBuf, sync::Arc, thread, time::Duration};\n \n-use anyhow::{anyhow, bail, Context, Result};\n+use anyhow::{Context, Result, anyhow, bail};\n use napi::{\n-    bindgen_prelude::{within_runtime_if_available, External},\n-    threadsafe_function::{ThreadsafeFunction, ThreadsafeFunctionCallMode},\n     JsFunction, Status,\n+    bindgen_prelude::{External, within_runtime_if_available},\n+    threadsafe_function::{ThreadsafeFunction, ThreadsafeFunctionCallMode},\n };\n use next_api::{\n     entrypoints::Entrypoints,\n@@ -19,31 +19,31 @@ use next_api::{\n     route::Endpoint,\n };\n use next_core::tracing_presets::{\n-    TRACING_NEXT_OVERVIEW_TARGETS, TRACING_NEXT_TARGETS, TRACING_NEXT_TURBOPACK_TARGETS,\n-    TRACING_NEXT_TURBO_TASKS_TARGETS,\n+    TRACING_NEXT_OVERVIEW_TARGETS, TRACING_NEXT_TARGETS, TRACING_NEXT_TURBO_TASKS_TARGETS,\n+    TRACING_NEXT_TURBOPACK_TARGETS,\n };\n use once_cell::sync::Lazy;\n use rand::Rng;\n use tokio::{io::AsyncWriteExt, time::Instant};\n use tracing::Instrument;\n-use tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt, Registry};\n+use tracing_subscriber::{Registry, layer::SubscriberExt, util::SubscriberInitExt};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n-    get_effects, Completion, Effects, FxIndexSet, OperationVc, ReadRef, ResolvedVc,\n-    TransientInstance, TryJoinIterExt, UpdateInfo, Vc,\n+    Completion, Effects, FxIndexSet, OperationVc, ReadRef, ResolvedVc, TransientInstance,\n+    TryJoinIterExt, UpdateInfo, Vc, get_effects,\n };\n use turbo_tasks_fs::{\n-    get_relative_path_to, util::uri_from_file, DiskFileSystem, FileContent, FileSystem,\n-    FileSystemPath,\n+    DiskFileSystem, FileContent, FileSystem, FileSystemPath, get_relative_path_to,\n+    util::uri_from_file,\n };\n use turbopack_core::{\n+    PROJECT_FILESYSTEM_NAME, SOURCE_URL_PROTOCOL,\n     diagnostics::PlainDiagnostic,\n     error::PrettyPrintError,\n     issue::PlainIssue,\n     output::{OutputAsset, OutputAssets},\n     source_map::{OptionSourceMap, OptionStringifiedSourceMap, SourceMap, Token},\n     version::{PartialUpdate, TotalUpdate, Update, VersionState},\n-    PROJECT_FILESYSTEM_NAME, SOURCE_URL_PROTOCOL,\n };\n use turbopack_ecmascript_hmr_protocol::{ClientUpdateInstruction, ResourceIdentifier};\n use turbopack_trace_utils::{\n@@ -57,8 +57,8 @@ use url::Url;\n use super::{\n     endpoint::ExternalEndpoint,\n     utils::{\n-        create_turbo_tasks, get_diagnostics, get_issues, subscribe, NapiDiagnostic, NapiIssue,\n-        NextTurboTasks, RootTask, TurbopackResult, VcArc,\n+        NapiDiagnostic, NapiIssue, NextTurboTasks, RootTask, TurbopackResult, VcArc,\n+        create_turbo_tasks, get_diagnostics, get_issues, subscribe,\n     },\n };\n use crate::{register, util::DhatProfilerGuard};"
        },
        {
            "sha": "36d10530c51cc493127f0eba55952e85efa90b14",
            "filename": "crates/napi/src/next_api/utils.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -1,20 +1,20 @@\n use std::{future::Future, ops::Deref, path::PathBuf, sync::Arc, time::Duration};\n \n-use anyhow::{anyhow, Context, Result};\n+use anyhow::{Context, Result, anyhow};\n use napi::{\n+    JsFunction, JsObject, JsUnknown, NapiRaw, NapiValue, Status,\n     bindgen_prelude::{External, ToNapiValue},\n     threadsafe_function::{ThreadSafeCallContext, ThreadsafeFunction, ThreadsafeFunctionCallMode},\n-    JsFunction, JsObject, JsUnknown, NapiRaw, NapiValue, Status,\n };\n use rustc_hash::FxHashMap;\n use serde::Serialize;\n use turbo_tasks::{\n-    get_effects, task_statistics::TaskStatisticsApi, trace::TraceRawVcs, Effects, OperationVc,\n-    ReadRef, TaskId, TryJoinIterExt, TurboTasks, TurboTasksApi, UpdateInfo, Vc, VcValueType,\n+    Effects, OperationVc, ReadRef, TaskId, TryJoinIterExt, TurboTasks, TurboTasksApi, UpdateInfo,\n+    Vc, VcValueType, get_effects, task_statistics::TaskStatisticsApi, trace::TraceRawVcs,\n };\n use turbo_tasks_backend::{\n-    default_backing_storage, noop_backing_storage, DefaultBackingStorage, GitVersionInfo,\n-    NoopBackingStorage,\n+    DefaultBackingStorage, GitVersionInfo, NoopBackingStorage, default_backing_storage,\n+    noop_backing_storage,\n };\n use turbo_tasks_fs::FileContent;\n use turbopack_core::{\n@@ -428,10 +428,12 @@ impl<T: ToNapiValue> ToNapiValue for TurbopackResult<T> {\n         env: napi::sys::napi_env,\n         val: Self,\n     ) -> napi::Result<napi::sys::napi_value> {\n-        let mut obj = napi::Env::from_raw(env).create_object()?;\n+        let mut obj = unsafe { napi::Env::from_raw(env).create_object()? };\n \n-        let result = T::to_napi_value(env, val.result)?;\n-        let result = JsUnknown::from_raw(env, result)?;\n+        let result = unsafe {\n+            let result = T::to_napi_value(env, val.result)?;\n+            JsUnknown::from_raw(env, result)?\n+        };\n         if matches!(result.get_type()?, napi::ValueType::Object) {\n             // SAFETY: We know that result is an object, so we can cast it to a JsObject\n             let result = unsafe { result.cast::<JsObject>() };\n@@ -445,7 +447,7 @@ impl<T: ToNapiValue> ToNapiValue for TurbopackResult<T> {\n         obj.set_named_property(\"issues\", val.issues)?;\n         obj.set_named_property(\"diagnostics\", val.diagnostics)?;\n \n-        Ok(obj.raw())\n+        Ok(unsafe { obj.raw() })\n     }\n }\n "
        },
        {
            "sha": "4ba37c725814f4d7cd62f18a968c3e49efad13fc",
            "filename": "crates/napi/src/parse.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fparse.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -5,7 +5,7 @@ use napi::bindgen_prelude::*;\n use swc_core::{\n     base::{config::ParseOptions, try_with_handler},\n     common::{\n-        comments::Comments, errors::ColorConfig, FileName, FilePathMapping, SourceMap, GLOBALS,\n+        FileName, FilePathMapping, GLOBALS, SourceMap, comments::Comments, errors::ColorConfig,\n     },\n };\n "
        },
        {
            "sha": "84e82d7e330b8a2a7acf60598a38990c26753d26",
            "filename": "crates/napi/src/react_compiler.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Freact_compiler.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Freact_compiler.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Freact_compiler.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -3,10 +3,10 @@ use std::{path::PathBuf, sync::Arc};\n use napi::bindgen_prelude::*;\n use next_custom_transforms::react_compiler;\n use swc_core::{\n-    common::{SourceMap, GLOBALS},\n+    common::{GLOBALS, SourceMap},\n     ecma::{\n         ast::EsVersion,\n-        parser::{parse_file_as_program, Syntax, TsSyntax},\n+        parser::{Syntax, TsSyntax, parse_file_as_program},\n     },\n };\n "
        },
        {
            "sha": "e464cd208a993a26f91726a4bd3c83d97e63d872",
            "filename": "crates/napi/src/transform.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Ftransform.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Ftransform.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Ftransform.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -29,19 +29,19 @@ DEALINGS IN THE SOFTWARE.\n use std::{\n     cell::RefCell,\n     fs::read_to_string,\n-    panic::{catch_unwind, AssertUnwindSafe},\n+    panic::{AssertUnwindSafe, catch_unwind},\n     rc::Rc,\n };\n \n-use anyhow::{anyhow, bail, Context as _};\n+use anyhow::{Context as _, anyhow, bail};\n use napi::bindgen_prelude::*;\n-use next_custom_transforms::chain_transforms::{custom_before_pass, TransformOptions};\n+use next_custom_transforms::chain_transforms::{TransformOptions, custom_before_pass};\n use once_cell::sync::Lazy;\n use rustc_hash::{FxHashMap, FxHashSet};\n use swc_core::{\n     atoms::Atom,\n-    base::{try_with_handler, Compiler, TransformOutput},\n-    common::{comments::SingleThreadedComments, errors::ColorConfig, FileName, Mark, GLOBALS},\n+    base::{Compiler, TransformOutput, try_with_handler},\n+    common::{FileName, GLOBALS, Mark, comments::SingleThreadedComments, errors::ColorConfig},\n     ecma::ast::noop_pass,\n };\n "
        },
        {
            "sha": "0574beb26f0925881d4d74a1e8f953361884c49a",
            "filename": "crates/napi/src/turbopack.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fturbopack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Fturbopack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fturbopack.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -3,8 +3,8 @@ use std::path::PathBuf;\n use anyhow::Context;\n use napi::bindgen_prelude::*;\n use next_build::{\n-    build_options::{BuildContext, DefineEnv},\n     BuildOptions as NextBuildOptions,\n+    build_options::{BuildContext, DefineEnv},\n };\n use next_core::next_config::{Rewrite, Rewrites, RouteHas};\n \n@@ -159,7 +159,7 @@ pub enum NapiRouteHas {\n \n impl FromNapiValue for NapiRouteHas {\n     unsafe fn from_napi_value(env: sys::napi_env, napi_val: sys::napi_value) -> Result<Self> {\n-        let object = Object::from_napi_value(env, napi_val)?;\n+        let object = unsafe { Object::from_napi_value(env, napi_val)? };\n         let type_ = object.get_named_property::<String>(\"type\")?;\n         Ok(match type_.as_str() {\n             \"header\" => NapiRouteHas::Header {\n@@ -181,7 +181,7 @@ impl FromNapiValue for NapiRouteHas {\n                 return Err(napi::Error::new(\n                     Status::GenericFailure,\n                     format!(\"invalid type for RouteHas: {type_}\"),\n-                ))\n+                ));\n             }\n         })\n     }"
        },
        {
            "sha": "61a7a803aa3ea302d9cdae469040f05418df5969",
            "filename": "crates/napi/src/util.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/02219cc880e0991b2060f1591757d97d9f678f9f/crates%2Fnapi%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Futil.rs?ref=02219cc880e0991b2060f1591757d97d9f678f9f",
            "patch": "@@ -42,7 +42,7 @@ use once_cell::sync::Lazy;\n use owo_colors::OwoColorize;\n use terminal_hyperlink::Hyperlink;\n use tracing_chrome::{ChromeLayerBuilder, FlushGuard};\n-use tracing_subscriber::{filter, prelude::*, util::SubscriberInitExt, Layer};\n+use tracing_subscriber::{Layer, filter, prelude::*, util::SubscriberInitExt};\n use turbopack_core::error::PrettyPrintError;\n \n static LOG_THROTTLE: Mutex<Option<Instant>> = Mutex::new(None);"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 46,
        "deletions": 44
    }
}