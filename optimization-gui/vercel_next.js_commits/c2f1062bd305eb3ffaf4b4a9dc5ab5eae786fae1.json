{
    "author": "eps1lon",
    "message": "[test] Deflake root-optional-revalidate (#85584)",
    "sha": "c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1",
    "files": [
        {
            "sha": "0666b388861d9e1228a9b00214aa2de1ebf96ffd",
            "filename": "test/integration/root-optional-revalidate/pages/[[...slug]].js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1/test%2Fintegration%2Froot-optional-revalidate%2Fpages%2F%5B%5B...slug%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1/test%2Fintegration%2Froot-optional-revalidate%2Fpages%2F%5B%5B...slug%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Froot-optional-revalidate%2Fpages%2F%5B%5B...slug%5D%5D.js?ref=c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1",
            "patch": "@@ -13,7 +13,10 @@ export async function getStaticPaths() {\n   }\n }\n \n-export async function getStaticProps({ params }) {\n+export async function getStaticProps({ params, revalidateReason }) {\n+  console.log(\n+    `getStaticProps({ revalidateReason: ${JSON.stringify(revalidateReason)} })`\n+  )\n   return {\n     props: {\n       params,"
        },
        {
            "sha": "80f504b5daabb993325272b71a031d1f1796bd5b",
            "filename": "test/integration/root-optional-revalidate/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 76,
            "changes": 76,
            "blob_url": "https://github.com/vercel/next.js/blob/73613d9dd2c75894cbe2b76566b7cf96ec241461/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/73613d9dd2c75894cbe2b76566b7cf96ec241461/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.js?ref=73613d9dd2c75894cbe2b76566b7cf96ec241461",
            "patch": "@@ -1,76 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import cheerio from 'cheerio'\n-import {\n-  killApp,\n-  findPort,\n-  nextBuild,\n-  nextStart,\n-  renderViaHTTP,\n-  waitFor,\n-} from 'next-test-utils'\n-\n-const appDir = join(__dirname, '../')\n-let app\n-let appPort\n-\n-const getProps = async (path) => {\n-  const html = await renderViaHTTP(appPort, path)\n-  const $ = cheerio.load(html)\n-  return JSON.parse($('#props').text())\n-}\n-\n-const runTests = () => {\n-  it('should render / correctly', async () => {\n-    const props = await getProps('/')\n-    expect(props.params).toEqual({})\n-\n-    await waitFor(1000)\n-    await getProps('/')\n-\n-    const newProps = await getProps('/')\n-    expect(newProps.params).toEqual({})\n-    expect(props.random).not.toBe(newProps.random)\n-  })\n-\n-  it('should render /a correctly', async () => {\n-    const props = await getProps('/a')\n-    expect(props.params).toEqual({ slug: ['a'] })\n-\n-    await waitFor(1000)\n-    await getProps('/a')\n-\n-    const newProps = await getProps('/a')\n-    expect(newProps.params).toEqual({ slug: ['a'] })\n-    expect(props.random).not.toBe(newProps.random)\n-  })\n-\n-  it('should render /hello/world correctly', async () => {\n-    const props = await getProps('/hello/world')\n-    expect(props.params).toEqual({ slug: ['hello', 'world'] })\n-\n-    await waitFor(1000)\n-    await getProps('/hello/world')\n-\n-    const newProps = await getProps('/hello/world')\n-    expect(newProps.params).toEqual({ slug: ['hello', 'world'] })\n-    expect(props.random).not.toBe(newProps.random)\n-  })\n-}\n-\n-describe('Root Optional Catch-all Revalidate', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      beforeAll(async () => {\n-        await nextBuild(appDir)\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(() => killApp(app))\n-\n-      runTests()\n-    }\n-  )\n-})"
        },
        {
            "sha": "1f26e7ee82c3d5ea0e4d96da295be75ffe8dfbdb",
            "filename": "test/integration/root-optional-revalidate/test/index.test.ts",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Froot-optional-revalidate%2Ftest%2Findex.test.ts?ref=c2f1062bd305eb3ffaf4b4a9dc5ab5eae786fae1",
            "patch": "@@ -0,0 +1,94 @@\n+import type { ChildProcess } from 'child_process'\n+import { join } from 'path'\n+import cheerio from 'cheerio'\n+import {\n+  killApp,\n+  findPort,\n+  nextBuild,\n+  nextStart,\n+  renderViaHTTP,\n+  waitFor,\n+  retry,\n+} from 'next-test-utils'\n+\n+const appDir = join(__dirname, '../')\n+let app: ChildProcess | undefined\n+let appPort: number | undefined\n+\n+const getProps = async (path) => {\n+  const html = await renderViaHTTP(appPort, path)\n+  const $ = cheerio.load(html)\n+  return JSON.parse($('#props').text())\n+}\n+\n+const runTests = () => {\n+  it('should render / correctly', async () => {\n+    const props = await getProps('/')\n+    expect(props.params).toEqual({})\n+\n+    let cliOutput = ''\n+    app.stdout.on('data', (chunk) => (cliOutput += chunk.toString()))\n+    await waitFor(1000)\n+    await getProps('/')\n+    expect(cliOutput).toEqual('getStaticProps({ revalidateReason: \"stale\" })\\n')\n+\n+    // Rendering takes time before the new cache entry is filled\n+    await retry(async () => {\n+      const newProps = await getProps('/')\n+      expect(newProps.params).toEqual({})\n+      expect(props.random).not.toBe(newProps.random)\n+    })\n+  })\n+\n+  it('should render /a correctly', async () => {\n+    const props = await getProps('/a')\n+    expect(props.params).toEqual({ slug: ['a'] })\n+\n+    let cliOutput = ''\n+    app.stdout.on('data', (chunk) => (cliOutput += chunk.toString()))\n+    await waitFor(1000)\n+    await getProps('/a')\n+    expect(cliOutput).toEqual('getStaticProps({ revalidateReason: \"stale\" })\\n')\n+\n+    // Rendering takes time before the new cache entry is filled\n+    await retry(async () => {\n+      const newProps = await getProps('/a')\n+      expect(newProps.params).toEqual({ slug: ['a'] })\n+      expect(props.random).not.toBe(newProps.random)\n+    })\n+  })\n+\n+  it('should render /hello/world correctly', async () => {\n+    const props = await getProps('/hello/world')\n+    expect(props.params).toEqual({ slug: ['hello', 'world'] })\n+\n+    let cliOutput = ''\n+    app.stdout.on('data', (chunk) => (cliOutput += chunk.toString()))\n+    await waitFor(1000)\n+    await getProps('/hello/world')\n+    expect(cliOutput).toEqual('getStaticProps({ revalidateReason: \"stale\" })\\n')\n+\n+    // Rendering takes time before the new cache entry is filled\n+    await retry(async () => {\n+      const newProps = await getProps('/hello/world')\n+      expect(newProps.params).toEqual({ slug: ['hello', 'world'] })\n+      expect(props.random).not.toBe(newProps.random)\n+    })\n+  })\n+}\n+\n+describe('Root Optional Catch-all Revalidate', () => {\n+  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n+    'production mode',\n+    () => {\n+      beforeAll(async () => {\n+        await nextBuild(appDir)\n+        appPort = await findPort()\n+        app = await nextStart(appDir, appPort)\n+      })\n+      afterAll(() => killApp(app))\n+\n+      runTests()\n+    }\n+  )\n+})"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 98,
        "deletions": 77
    }
}