{
    "author": "unstubbable",
    "message": "Use React's debug channel to transport debug info via WebSocket connection (#82748)\n\nIn dev mode, React is sending debug info (owners, stacks, console logs\netc.) from the server to the client so that they can be displayed in dev\ntools. By default, this info is sent as part of the main RSC payload\n(inlined into the HTML, or fetched after interaction). With this PR,\nwe're now transporting the debug info in a separate debug channel. This\nchannel currently consists of a unidirectional stream (writable on the\nserver, readable in the client) that is serialized as binary WebSocket\nmessages, which are sent through the existing WebSocket connection that\nNext.js uses for HMR messages etc.\n\nIn a follow up, we will also implement the return channel (writable in\nthe client, readable on the server). This allows the client to retrieve\ndebug info lazily and on demand during inspection/introspection.\n\nOne benefit of this approach is, that it will allow us to change our\ndynamic validation strategy. We should then be able to tee and cut off\nthe dynamic RSC stream at different points in time (representing the\nstatic prerender, runtime prerender, and dynamic render stages), while\nstill letting the complete debug info stream in through the separate\nchannel. This allows us to show the same dynamic validation error\ndetails as before, while reducing the number of renders needed to\naccomplish that.\n\nFor dogfooding purposes, the feature can be disabled by setting\n`experimental.reactDebugChannel` to `false`, in case of unexpected\nregressions in dev mode.\n\n### An implementation note on the request ID handling\n\nOn the server, at the beginning of the rendering process, we determine a\n`requestId` and an `htmlRequestId`.\n\n1. The `requestId` is a UUID that's newly generated for each incoming\nrequest.\n2. The `htmlRequestId` is one of two things:\n    1. For the HTML request, it's the same as the `requestId`.\n2. For subsequent RSC requests (for navigations or server actions), it's\nthe ID of the HTML document from where the request originates. It is\nsent as the `x-nextjs-html-request-id` request header.\n\nThe HTML request ID is used to identify connected WebSocket clients.\nIt's sent to the browser as the global `__next_r` variable in the script\ntag that also includes the initial RSC instructions. The browser sends\nit back to the server as `id` query param of the WebSocket request. On\nthe server, we store the clients by HTML request ID. When debug chunks\nare sent to the browser, we use the HTML request ID to look up the\ncorrect client. (There's only one client per browser tab/window.)\n\nIn the browser, we create a debug channel for each request, and we store\nthem keyed by request ID. For the HTML request, the request ID from\n`__next_r` is used as key. For the RSC requests, the `requestId` is\nreceived as `x-nextjs-request-id` response header, and used as key. The\nserver sends the current request ID as part of the WebSocket message to\nthe browser, so that the chunks can be enqueued into the correct debug\nchannel.\n\ncloses NAR-310",
    "sha": "0accb03cbedad6db79d1c82c46f006e3cbb37292",
    "files": [
        {
            "sha": "542ec27051b0a70262863eab083e93e26923676c",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -801,5 +801,12 @@\n   \"800\": \"`experimental.rdcForNavigations` is enabled, but `experimental.ppr` is not.\",\n   \"801\": \"> `pages` and `app` directories should be under the same folder\",\n   \"802\": \"Image with src \\\"%s\\\" has both \\\"preload\\\" and \\\"priority\\\" properties. Only \\\"preload\\\" should be used.\",\n-  \"803\": \"Image with src \\\"%s\\\" has both \\\"preload\\\" and \\\"loading='lazy'\\\" properties. Only one should be used.\"\n+  \"803\": \"Image with src \\\"%s\\\" has both \\\"preload\\\" and \\\"loading='lazy'\\\" properties. Only one should be used.\",\n+  \"804\": \"Did not start HotReloaderWebpack.\",\n+  \"805\": \"Request ID is too long for the binary HMR message.\",\n+  \"806\": \"Expected a request ID to be defined for the document via self.__next_r.\",\n+  \"807\": \"Expected a %s response header.\",\n+  \"808\": \"Invalid binary HMR message: insufficient data (expected %s bytes, got %s)\",\n+  \"809\": \"Invalid binary HMR message of type %s\",\n+  \"810\": \"React debug channel stream error\"\n }"
        },
        {
            "sha": "a57de597a64538962d060e81f669095080709838",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -528,6 +528,7 @@ export async function handler(\n           serverActionsManifest,\n           clientReferenceManifest,\n           setIsrStatus: routerServerContext?.setIsrStatus,\n+          setReactDebugChannel: routerServerContext?.setReactDebugChannel,\n \n           dir:\n             process.env.NEXT_RUNTIME === 'nodejs'"
        },
        {
            "sha": "2b1ab5411f3a420d82671d4f9f460b41bb6acf4b",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -53,6 +53,10 @@ type NextFlight = Omit<Array<FlightSegment>, 'push'> & {\n declare global {\n   // If you're working in a browser environment\n   interface Window {\n+    /**\n+     * request ID, dev-only\n+     */\n+    __next_r?: string\n     __next_f: NextFlight\n   }\n }\n@@ -154,9 +158,20 @@ const readable = new ReadableStream({\n   },\n })\n \n+let debugChannel:\n+  | { readable?: ReadableStream; writable?: WritableStream }\n+  | undefined\n+\n+if (process.env.NODE_ENV !== 'production' && typeof window !== 'undefined') {\n+  const { createDebugChannel } =\n+    require('./dev/debug-channel') as typeof import('./dev/debug-channel')\n+\n+  debugChannel = createDebugChannel(undefined)\n+}\n+\n const initialServerResponse = createFromReadableStream<InitialRSCPayload>(\n   readable,\n-  { callServer, findSourceMapURL }\n+  { callServer, findSourceMapURL, debugChannel }\n )\n \n function ServerRoot({"
        },
        {
            "sha": "adaa686cbdd901e2215f5d3d43f40e546c8c0046",
            "filename": "packages/next/src/client/components/app-router-headers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -32,3 +32,5 @@ export const NEXT_REWRITTEN_PATH_HEADER = 'x-nextjs-rewritten-path' as const\n export const NEXT_REWRITTEN_QUERY_HEADER = 'x-nextjs-rewritten-query' as const\n export const NEXT_IS_PRERENDER_HEADER = 'x-nextjs-prerender' as const\n export const NEXT_ACTION_NOT_FOUND_HEADER = 'x-nextjs-action-not-found' as const\n+export const NEXT_REQUEST_ID_HEADER = 'x-nextjs-request-id' as const\n+export const NEXT_HTML_REQUEST_ID_HEADER = 'x-nextjs-html-request-id' as const"
        },
        {
            "sha": "042839b251ed6fd5ac7ccd07b63e24dfbe100d73",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -20,6 +20,7 @@ import {\n   NEXT_HMR_REFRESH_HEADER,\n   NEXT_DID_POSTPONE_HEADER,\n   NEXT_ROUTER_STALE_TIME_HEADER,\n+  NEXT_HTML_REQUEST_ID_HEADER,\n } from '../app-router-headers'\n import { callServer } from '../../app-call-server'\n import { findSourceMapURL } from '../../app-find-source-map-url'\n@@ -36,6 +37,16 @@ import { urlToUrlWithoutFlightMarker } from '../../route-params'\n const createFromReadableStream =\n   createFromReadableStreamBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromReadableStream']\n \n+let createDebugChannel:\n+  | typeof import('../../dev/debug-channel').createDebugChannel\n+  | undefined\n+\n+if (process.env.NODE_ENV !== 'production') {\n+  createDebugChannel = (\n+    require('../../dev/debug-channel') as typeof import('../../dev/debug-channel')\n+  ).createDebugChannel\n+}\n+\n export interface FetchServerResponseOptions {\n   readonly flightRouterState: FlightRouterState\n   readonly nextUrl: string | null\n@@ -62,6 +73,7 @@ export type RequestHeaders = {\n   [NEXT_HMR_REFRESH_HEADER]?: '1'\n   // A header that is only added in test mode to assert on fetch priority\n   'Next-Test-Fetch-Priority'?: RequestInit['priority']\n+  [NEXT_HTML_REQUEST_ID_HEADER]?: string // dev-only\n }\n \n function doMpaNavigation(url: string): FetchServerResponseResult {\n@@ -214,7 +226,8 @@ export async function fetchServerResponse(\n       ? createUnclosingPrefetchStream(res.body)\n       : res.body\n     const response = await (createFromNextReadableStream(\n-      flightStream\n+      flightStream,\n+      res.headers\n     ) as Promise<NavigationFlightResponse>)\n \n     if (getAppBuildId() !== response.b) {\n@@ -283,6 +296,10 @@ export async function createFetch(\n     headers['x-deployment-id'] = process.env.NEXT_DEPLOYMENT_ID\n   }\n \n+  if (process.env.NODE_ENV !== 'production' && self.__next_r) {\n+    headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+  }\n+\n   const fetchOptions: RequestInit = {\n     // Backwards compat for older browsers. `same-origin` is the default in modern browsers.\n     credentials: 'same-origin',\n@@ -383,11 +400,13 @@ export async function createFetch(\n }\n \n export function createFromNextReadableStream(\n-  flightStream: ReadableStream<Uint8Array>\n+  flightStream: ReadableStream<Uint8Array>,\n+  responseHeaders: Headers\n ): Promise<unknown> {\n   return createFromReadableStream(flightStream, {\n     callServer,\n     findSourceMapURL,\n+    debugChannel: createDebugChannel && createDebugChannel(responseHeaders),\n   })\n }\n "
        },
        {
            "sha": "476fb2e1fbebcf1a0850ddf34dea22d0a34f625c",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 22,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -8,6 +8,7 @@ import {\n   ACTION_HEADER,\n   NEXT_ACTION_NOT_FOUND_HEADER,\n   NEXT_IS_PRERENDER_HEADER,\n+  NEXT_HTML_REQUEST_ID_HEADER,\n   NEXT_ROUTER_STATE_TREE_HEADER,\n   NEXT_URL,\n   RSC_CONTENT_TYPE_HEADER,\n@@ -60,6 +61,16 @@ import { revalidateEntireCache } from '../../segment-cache'\n const createFromFetch =\n   createFromFetchBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromFetch']\n \n+let createDebugChannel:\n+  | typeof import('../../../dev/debug-channel').createDebugChannel\n+  | undefined\n+\n+if (process.env.NODE_ENV !== 'production') {\n+  createDebugChannel = (\n+    require('../../../dev/debug-channel') as typeof import('../../../dev/debug-channel')\n+  ).createDebugChannel\n+}\n+\n type FetchServerActionResult = {\n   redirectLocation: URL | undefined\n   redirectType: RedirectType | undefined\n@@ -89,27 +100,27 @@ async function fetchServerAction(\n \n   const body = await encodeReply(usedArgs, { temporaryReferences })\n \n-  const res = await fetch(state.canonicalUrl, {\n-    method: 'POST',\n-    headers: {\n-      Accept: RSC_CONTENT_TYPE_HEADER,\n-      [ACTION_HEADER]: actionId,\n-      [NEXT_ROUTER_STATE_TREE_HEADER]: prepareFlightRouterStateForRequest(\n-        state.tree\n-      ),\n-      ...(process.env.NEXT_DEPLOYMENT_ID\n-        ? {\n-            'x-deployment-id': process.env.NEXT_DEPLOYMENT_ID,\n-          }\n-        : {}),\n-      ...(nextUrl\n-        ? {\n-            [NEXT_URL]: nextUrl,\n-          }\n-        : {}),\n-    },\n-    body,\n-  })\n+  const headers: Record<string, string> = {\n+    Accept: RSC_CONTENT_TYPE_HEADER,\n+    [ACTION_HEADER]: actionId,\n+    [NEXT_ROUTER_STATE_TREE_HEADER]: prepareFlightRouterStateForRequest(\n+      state.tree\n+    ),\n+  }\n+\n+  if (process.env.NEXT_DEPLOYMENT_ID) {\n+    headers['x-deployment-id'] = process.env.NEXT_DEPLOYMENT_ID\n+  }\n+\n+  if (nextUrl) {\n+    headers[NEXT_URL] = nextUrl\n+  }\n+\n+  if (process.env.NODE_ENV !== 'production' && self.__next_r) {\n+    headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+  }\n+\n+  const res = await fetch(state.canonicalUrl, { method: 'POST', headers, body })\n \n   // Handle server actions that the server didn't recognize.\n   const unrecognizedActionHeader = res.headers.get(NEXT_ACTION_NOT_FOUND_HEADER)\n@@ -176,10 +187,16 @@ async function fetchServerAction(\n \n   let actionResult: FetchServerActionResult['actionResult']\n   let actionFlightData: FetchServerActionResult['actionFlightData']\n+\n   if (isRscResponse) {\n     const response: ActionFlightResponse = await createFromFetch(\n       Promise.resolve(res),\n-      { callServer, findSourceMapURL, temporaryReferences }\n+      {\n+        callServer,\n+        findSourceMapURL,\n+        temporaryReferences,\n+        debugChannel: createDebugChannel && createDebugChannel(res.headers),\n+      }\n     )\n \n     // An internal redirect can send an RSC response, but does not have a useful `actionResult`."
        },
        {
            "sha": "073be07163d333969b83fe17942eb6c476de1c35",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -1431,7 +1431,8 @@ export async function fetchRouteOnCacheMiss(\n         }\n       )\n       const serverData = await (createFromNextReadableStream(\n-        prefetchStream\n+        prefetchStream,\n+        response.headers\n       ) as Promise<RootTreePrefetch>)\n       if (serverData.buildId !== getAppBuildId()) {\n         // The server build does not match the client. Treat as a 404. During\n@@ -1482,7 +1483,8 @@ export async function fetchRouteOnCacheMiss(\n         }\n       )\n       const serverData = await (createFromNextReadableStream(\n-        prefetchStream\n+        prefetchStream,\n+        response.headers\n       ) as Promise<NavigationFlightResponse>)\n       if (serverData.b !== getAppBuildId()) {\n         // The server build does not match the client. Treat as a 404. During\n@@ -1627,7 +1629,8 @@ export async function fetchSegmentOnCacheMiss(\n       }\n     )\n     const serverData = await (createFromNextReadableStream(\n-      prefetchStream\n+      prefetchStream,\n+      response.headers\n     ) as Promise<SegmentPrefetch>)\n     if (serverData.buildId !== getAppBuildId()) {\n       // The server build does not match the client. Treat as a 404. During\n@@ -1746,7 +1749,8 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n       }\n     )\n     const serverData = await (createFromNextReadableStream(\n-      prefetchStream\n+      prefetchStream,\n+      response.headers\n     ) as Promise<NavigationFlightResponse>)\n \n     const isResponsePartial ="
        },
        {
            "sha": "a70b842afb7c75075b78bc969fbd8d3e9f65e8b3",
            "filename": "packages/next/src/client/dev/debug-channel.ts",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -0,0 +1,53 @@\n+import { NEXT_REQUEST_ID_HEADER } from '../components/app-router-headers'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n+\n+export interface DebugChannelReadableWriterPair {\n+  readonly readable: ReadableStream<Uint8Array>\n+  readonly writer: WritableStreamDefaultWriter<Uint8Array>\n+}\n+\n+const pairs = new Map<string, DebugChannelReadableWriterPair>()\n+\n+export function getOrCreateDebugChannelReadableWriterPair(\n+  requestId: string\n+): DebugChannelReadableWriterPair {\n+  let pair = pairs.get(requestId)\n+\n+  if (!pair) {\n+    const { readable, writable } = new TransformStream<Uint8Array, Uint8Array>()\n+    pair = { readable, writer: writable.getWriter() }\n+    pairs.set(requestId, pair)\n+    pair.writer.closed.finally(() => pairs.delete(requestId))\n+  }\n+\n+  return pair\n+}\n+\n+export function createDebugChannel(responseHeaders: Headers | undefined): {\n+  writable?: WritableStream\n+  readable?: ReadableStream\n+} {\n+  let requestId: string | undefined\n+\n+  if (responseHeaders) {\n+    requestId = responseHeaders.get(NEXT_REQUEST_ID_HEADER) ?? undefined\n+\n+    if (!requestId) {\n+      throw new InvariantError(\n+        `Expected a ${JSON.stringify(NEXT_REQUEST_ID_HEADER)} response header.`\n+      )\n+    }\n+  } else {\n+    requestId = self.__next_r\n+\n+    if (!requestId) {\n+      throw new InvariantError(\n+        `Expected a request ID to be defined for the document via self.__next_r.`\n+      )\n+    }\n+  }\n+\n+  const { readable } = getOrCreateDebugChannelReadableWriterPair(requestId)\n+\n+  return { readable }\n+}"
        },
        {
            "sha": "bc6cb0b8ad60ba99fb2e253c28ad8c8b5d1f2c12",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -28,6 +28,7 @@ import {\n   type GlobalErrorState,\n } from '../../../components/app-router-instance'\n import { InvariantError } from '../../../../shared/lib/invariant-error'\n+import { getOrCreateDebugChannelReadableWriterPair } from '../../debug-channel'\n \n export interface StaticIndicatorState {\n   pathname: string | null\n@@ -451,6 +452,23 @@ export function processMessage(\n       dispatcher.onDevToolsConfig(message.data)\n       return\n     }\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK: {\n+      const { requestId, chunk } = message\n+      const { writer } = getOrCreateDebugChannelReadableWriterPair(requestId)\n+\n+      if (chunk) {\n+        writer.ready.then(() => writer.write(chunk)).catch(console.error)\n+      } else {\n+        // A null chunk signals that no more chunks will be sent, which allows\n+        // us to close the writer.\n+        // TODO: Revisit this cleanup logic when we integrate the return channel\n+        // that keeps the connection open to be able to lazily retrieve debug\n+        // objects.\n+        writer.ready.then(() => writer.close()).catch(console.error)\n+      }\n+\n+      return\n+    }\n     case HMR_MESSAGE_SENT_TO_BROWSER.MIDDLEWARE_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.CLIENT_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ONLY_CHANGES:"
        },
        {
            "sha": "53186e9ddc4d83827363fddb9ffb1f44e33e7df4",
            "filename": "packages/next/src/client/dev/hot-reloader/app/web-socket.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 4,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -1,7 +1,11 @@\n import { useContext, useEffect } from 'react'\n import { GlobalLayoutRouterContext } from '../../../../shared/lib/app-router-context.shared-runtime'\n import { getSocketUrl } from '../get-socket-url'\n-import type { TurbopackMessageSentToBrowser } from '../../../../server/dev/hot-reloader-types'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type HmrMessageSentToBrowser,\n+  type TurbopackMessageSentToBrowser,\n+} from '../../../../server/dev/hot-reloader-types'\n import { reportInvalidHmrMessage } from '../shared'\n import {\n   performFullReload,\n@@ -18,8 +22,17 @@ export function createWebSocket(\n   assetPrefix: string,\n   staticIndicatorState: StaticIndicatorState\n ) {\n-  const url = getSocketUrl(assetPrefix)\n-  const webSocket = new window.WebSocket(`${url}/_next/webpack-hmr`)\n+  if (!self.__next_r) {\n+    throw new InvariantError(\n+      `Expected a request ID to be defined for the document via self.__next_r.`\n+    )\n+  }\n+\n+  const webSocket = new window.WebSocket(\n+    `${getSocketUrl(assetPrefix)}/_next/webpack-hmr?id=${self.__next_r}`\n+  )\n+\n+  webSocket.binaryType = 'arraybuffer'\n \n   if (isTerminalLoggingEnabled) {\n     webSocket.addEventListener('open', () => {\n@@ -37,7 +50,11 @@ export function createWebSocket(\n \n   webSocket.addEventListener('message', (event) => {\n     try {\n-      const message = JSON.parse(event.data)\n+      const message: HmrMessageSentToBrowser =\n+        event.data instanceof ArrayBuffer\n+          ? parseBinaryMessage(event.data)\n+          : JSON.parse(event.data)\n+\n       processMessage(\n         message,\n         sendMessage,\n@@ -121,3 +138,47 @@ export function useWebSocketPing(webSocket: WebSocket | undefined) {\n     return () => clearInterval(interval)\n   }, [tree, webSocket])\n }\n+\n+const textDecoder = new TextDecoder()\n+\n+function parseBinaryMessage(data: ArrayBuffer): HmrMessageSentToBrowser {\n+  assertByteLength(data, 1)\n+  const view = new DataView(data)\n+  const messageType = view.getUint8(0)\n+\n+  switch (messageType) {\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK: {\n+      assertByteLength(data, 2)\n+      const requestIdLength = view.getUint8(1)\n+      assertByteLength(data, 2 + requestIdLength)\n+\n+      const requestId = textDecoder.decode(\n+        new Uint8Array(data, 2, requestIdLength)\n+      )\n+\n+      const chunk =\n+        data.byteLength > 2 + requestIdLength\n+          ? new Uint8Array(data, 2 + requestIdLength)\n+          : null\n+\n+      return {\n+        type: HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK,\n+        requestId,\n+        chunk,\n+      }\n+    }\n+    default: {\n+      throw new InvariantError(\n+        `Invalid binary HMR message of type ${messageType}`\n+      )\n+    }\n+  }\n+}\n+\n+function assertByteLength(data: ArrayBuffer, expectedLength: number) {\n+  if (data.byteLength < expectedLength) {\n+    throw new InvariantError(\n+      `Invalid binary HMR message: insufficient data (expected ${expectedLength} bytes, got ${data.byteLength})`\n+    )\n+  }\n+}"
        },
        {
            "sha": "648997d62e42dfe056cbc76b913f4b78a1148722",
            "filename": "packages/next/src/client/dev/hot-reloader/pages/hot-reloader-pages.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -385,6 +385,9 @@ function processMessage(message: HmrMessageSentToBrowser) {\n     case HMR_MESSAGE_SENT_TO_BROWSER.DEVTOOLS_CONFIG:\n       dispatcher.onDevToolsConfig(message.data)\n       break\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK:\n+      // Only relevant for app router.\n+      break\n     case HMR_MESSAGE_SENT_TO_BROWSER.MIDDLEWARE_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.CLIENT_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ONLY_CHANGES:"
        },
        {
            "sha": "9a71a1740c6952fb01c4ac0789a32efca99e5beb",
            "filename": "packages/next/src/client/page-bootstrap.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -120,6 +120,7 @@ export function pageBootstrap(assetPrefix: string) {\n         case HMR_MESSAGE_SENT_TO_BROWSER.TURBOPACK_CONNECTED:\n         case HMR_MESSAGE_SENT_TO_BROWSER.ISR_MANIFEST:\n         case HMR_MESSAGE_SENT_TO_BROWSER.DEVTOOLS_CONFIG:\n+        case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK:\n           // Most of these action types are handled in\n           // src/client/dev/hot-reloader/pages/hot-reloader-pages.ts and\n           // src/client/dev/hot-reloader/app/hot-reloader-app.tsx"
        },
        {
            "sha": "378e93785a7588c5b7070fc1b815cae1fdb134ed",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 161,
            "deletions": 29,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -57,6 +57,8 @@ import {\n   NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n   NEXT_HMR_REFRESH_HASH_COOKIE,\n   NEXT_DID_POSTPONE_HEADER,\n+  NEXT_REQUEST_ID_HEADER,\n+  NEXT_HTML_REQUEST_ID_HEADER,\n } from '../../client/components/app-router-headers'\n import { createMetadataContext } from '../../lib/metadata/metadata-context'\n import { createRequestStoreForRender } from '../async-storage/request-store'\n@@ -237,6 +239,7 @@ export type AppRenderContext = {\n   appUsingSizeAdjustment: boolean\n   flightRouterState?: FlightRouterState\n   requestId: string\n+  htmlRequestId: string\n   pagePath: string\n   clientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n   assetPrefix: string\n@@ -283,6 +286,7 @@ interface ParsedRequestHeaders {\n   readonly isRSCRequest: boolean\n   readonly nonce: string | undefined\n   readonly previouslyRevalidatedTags: string[]\n+  readonly htmlRequestId: string | undefined\n }\n \n function parseRequestHeaders(\n@@ -327,6 +331,11 @@ function parseRequestHeaders(\n     options.previewModeId\n   )\n \n+  const htmlRequestId =\n+    typeof headers[NEXT_HTML_REQUEST_ID_HEADER] === 'string'\n+      ? headers[NEXT_HTML_REQUEST_ID_HEADER]\n+      : undefined\n+\n   return {\n     flightRouterState,\n     isPrefetchRequest,\n@@ -337,6 +346,7 @@ function parseRequestHeaders(\n     isDevWarmupRequest,\n     nonce,\n     previouslyRevalidatedTags,\n+    htmlRequestId,\n   }\n }\n \n@@ -554,17 +564,30 @@ async function generateDynamicFlightRenderResult(\n     temporaryReferences?: WeakMap<any, string>\n   }\n ): Promise<RenderResult> {\n-  const renderOpts = ctx.renderOpts\n+  const {\n+    clientReferenceManifest,\n+    componentMod,\n+    htmlRequestId,\n+    renderOpts,\n+    requestId,\n+    workStore,\n+  } = ctx\n+\n+  const {\n+    dev = false,\n+    onInstrumentationRequestError,\n+    setReactDebugChannel,\n+  } = renderOpts\n \n   function onFlightDataRenderError(err: DigestedError) {\n-    return renderOpts.onInstrumentationRequestError?.(\n+    return onInstrumentationRequestError?.(\n       err,\n       req,\n       createErrorContext(ctx, 'react-server-components-payload')\n     )\n   }\n   const onError = createFlightReactServerErrorHandler(\n-    !!renderOpts.dev,\n+    dev,\n     onFlightDataRenderError\n   )\n \n@@ -578,22 +601,29 @@ async function generateDynamicFlightRenderResult(\n     options\n   )\n \n+  const debugChannel = setReactDebugChannel && createDebugChannel()\n+\n+  if (debugChannel) {\n+    setReactDebugChannel(debugChannel.clientSide, htmlRequestId, requestId)\n+  }\n+\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   const flightReadableStream = workUnitAsyncStorage.run(\n     requestStore,\n-    ctx.componentMod.renderToReadableStream,\n+    componentMod.renderToReadableStream,\n     RSCPayload,\n-    ctx.clientReferenceManifest.clientModules,\n+    clientReferenceManifest.clientModules,\n     {\n       onError,\n       temporaryReferences: options?.temporaryReferences,\n       filterStackFrame,\n+      debugChannel: debugChannel?.serverSide,\n     }\n   )\n \n   return new FlightRenderResult(flightReadableStream, {\n-    fetchMetrics: ctx.workStore.fetchMetrics,\n+    fetchMetrics: workStore.fetchMetrics,\n   })\n }\n \n@@ -1332,12 +1362,14 @@ function assertClientReferenceManifest(\n // This component must run in an SSR context. It will render the RSC root component\n function App<T>({\n   reactServerStream,\n+  reactDebugStream,\n   preinitScripts,\n   clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n+  reactDebugStream: ReadableStream<Uint8Array> | undefined\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n@@ -1347,6 +1379,7 @@ function App<T>({\n   const response = React.use(\n     useFlightStream<InitialRSCPayload>(\n       reactServerStream,\n+      reactDebugStream,\n       clientReferenceManifest,\n       nonce\n     )\n@@ -1391,12 +1424,14 @@ function App<T>({\n // consistent for now.\n function ErrorApp<T>({\n   reactServerStream,\n+  reactDebugStream,\n   preinitScripts,\n   clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n+  reactDebugStream: ReadableStream<Uint8Array> | undefined\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n@@ -1406,6 +1441,7 @@ function ErrorApp<T>({\n   const response = React.use(\n     useFlightStream<InitialRSCPayload>(\n       reactServerStream,\n+      reactDebugStream,\n       clientReferenceManifest,\n       nonce\n     )\n@@ -1619,22 +1655,8 @@ async function renderToHTMLOrFlightImpl(\n   query = { ...query }\n   stripInternalQueries(query)\n \n-  const {\n-    flightRouterState,\n-    isPrefetchRequest,\n-    isRuntimePrefetchRequest,\n-    isRSCRequest,\n-    isDevWarmupRequest,\n-    isHmrRefresh,\n-    nonce,\n-  } = parsedRequestHeaders\n-\n   const { isStaticGeneration } = workStore\n \n-  /**\n-   * The metadata items array created in next-app-loader with all relevant information\n-   * that we need to resolve the final metadata.\n-   */\n   let requestId: string\n \n   if (isStaticGeneration) {\n@@ -1649,6 +1671,21 @@ async function renderToHTMLOrFlightImpl(\n     ).nanoid()\n   }\n \n+  if (process.env.NODE_ENV !== 'production') {\n+    res.setHeader(NEXT_REQUEST_ID_HEADER, requestId)\n+  }\n+\n+  const {\n+    flightRouterState,\n+    isPrefetchRequest,\n+    isRuntimePrefetchRequest,\n+    isRSCRequest,\n+    isDevWarmupRequest,\n+    isHmrRefresh,\n+    nonce,\n+    htmlRequestId = requestId,\n+  } = parsedRequestHeaders\n+\n   /**\n    * Dynamic parameters. E.g. when you visit `/dashboard/vercel` which is rendered by `/dashboard/[slug]` the value will be {\"slug\": \"vercel\"}.\n    */\n@@ -1682,6 +1719,7 @@ async function renderToHTMLOrFlightImpl(\n     appUsingSizeAdjustment,\n     flightRouterState,\n     requestId,\n+    htmlRequestId,\n     pagePath,\n     clientReferenceManifest,\n     assetPrefix,\n@@ -2100,7 +2138,8 @@ async function renderToStream(\n   metadata: AppPageRenderResultMetadata,\n   devValidatingFallbackParams: OpaqueFallbackRouteParams | null\n ): Promise<ReadableStream<Uint8Array>> {\n-  const { assetPrefix, nonce, pagePath, renderOpts } = ctx\n+  const { assetPrefix, htmlRequestId, nonce, pagePath, renderOpts, requestId } =\n+    ctx\n \n   const {\n     basePath,\n@@ -2114,6 +2153,7 @@ async function renderToStream(\n     onInstrumentationRequestError,\n     page,\n     reactMaxHeadersLength,\n+    setReactDebugChannel,\n     shouldWaitOnAllReady,\n     subresourceIntegrityManifest,\n     supportsDynamicResponse,\n@@ -2195,6 +2235,7 @@ async function renderToStream(\n   )\n \n   let reactServerResult: null | ReactServerResult = null\n+  let reactDebugStream: ReadableStream<Uint8Array> | undefined\n \n   const setHeader = res.setHeader.bind(res)\n   const appendHeader = res.appendHeader.bind(res)\n@@ -2224,6 +2265,21 @@ async function renderToStream(\n       const [resolveValidation, validationOutlet] = createValidationOutlet()\n       RSCPayload._validation = validationOutlet\n \n+      const debugChannel = setReactDebugChannel && createDebugChannel()\n+\n+      if (debugChannel) {\n+        const [readableSsr, readableBrowser] =\n+          debugChannel.clientSide.readable.tee()\n+\n+        reactDebugStream = readableSsr\n+\n+        setReactDebugChannel(\n+          { readable: readableBrowser },\n+          htmlRequestId,\n+          requestId\n+        )\n+      }\n+\n       const reactServerStream = await workUnitAsyncStorage.run(\n         requestStore,\n         scheduleInSequentialTasks,\n@@ -2237,6 +2293,7 @@ async function renderToStream(\n               environmentName: () =>\n                 requestStore.prerenderPhase === true ? 'Prerender' : 'Server',\n               filterStackFrame,\n+              debugChannel: debugChannel?.serverSide,\n             }\n           )\n         },\n@@ -2266,6 +2323,21 @@ async function renderToStream(\n         res.statusCode === 404\n       )\n \n+      const debugChannel = setReactDebugChannel && createDebugChannel()\n+\n+      if (debugChannel) {\n+        const [readableSsr, readableBrowser] =\n+          debugChannel.clientSide.readable.tee()\n+\n+        reactDebugStream = readableSsr\n+\n+        setReactDebugChannel(\n+          { readable: readableBrowser },\n+          htmlRequestId,\n+          requestId\n+        )\n+      }\n+\n       reactServerResult = new ReactServerResult(\n         workUnitAsyncStorage.run(\n           requestStore,\n@@ -2275,6 +2347,7 @@ async function renderToStream(\n           {\n             filterStackFrame,\n             onError: serverComponentsErrorHandler,\n+            debugChannel: debugChannel?.serverSide,\n           }\n         )\n       )\n@@ -2295,7 +2368,8 @@ async function renderToStream(\n         const inlinedReactServerDataStream = createInlinedDataReadableStream(\n           reactServerResult.tee(),\n           nonce,\n-          formState\n+          formState,\n+          requestId\n         )\n \n         return chainStreams(\n@@ -2315,6 +2389,7 @@ async function renderToStream(\n           resume,\n           <App\n             reactServerStream={reactServerResult.tee()}\n+            reactDebugStream={reactDebugStream}\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -2341,7 +2416,8 @@ async function renderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             reactServerResult.consume(),\n             nonce,\n-            formState\n+            formState,\n+            requestId\n           ),\n           getServerInsertedHTML,\n           getServerInsertedMetadata,\n@@ -2359,6 +2435,7 @@ async function renderToStream(\n       renderToReadableStream,\n       <App\n         reactServerStream={reactServerResult.tee()}\n+        reactDebugStream={reactDebugStream}\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -2409,7 +2486,8 @@ async function renderToStream(\n       inlinedDataStream: createInlinedDataReadableStream(\n         reactServerResult.consume(),\n         nonce,\n-        formState\n+        formState,\n+        requestId\n       ),\n       isStaticGeneration: generateStaticHTML,\n       isBuildTimePrerendering: ctx.workStore.isBuildTimePrerendering === true,\n@@ -2517,6 +2595,7 @@ async function renderToStream(\n           element: (\n             <ErrorApp\n               reactServerStream={errorServerStream}\n+              reactDebugStream={undefined}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n@@ -2557,7 +2636,8 @@ async function renderToStream(\n           // render\n           reactServerResult.consume(),\n           nonce,\n-          formState\n+          formState,\n+          requestId\n         ),\n         isStaticGeneration: generateStaticHTML,\n         isBuildTimePrerendering: ctx.workStore.isBuildTimePrerendering === true,\n@@ -2586,6 +2666,44 @@ async function renderToStream(\n   }\n }\n \n+function createDebugChannel():\n+  | {\n+      serverSide: { readable?: ReadableStream; writable: WritableStream }\n+      clientSide: { readable: ReadableStream; writable?: WritableStream }\n+    }\n+  | undefined {\n+  if (process.env.NODE_ENV === 'production') {\n+    return undefined\n+  }\n+\n+  let readableController: ReadableStreamDefaultController | undefined\n+\n+  const clientSideReadable = new ReadableStream<Uint8Array>({\n+    start(controller) {\n+      readableController = controller\n+    },\n+  })\n+\n+  return {\n+    serverSide: {\n+      writable: new WritableStream<Uint8Array>({\n+        write(chunk) {\n+          readableController?.enqueue(chunk)\n+        },\n+        close() {\n+          readableController?.close()\n+        },\n+        abort(err) {\n+          readableController?.error(err)\n+        },\n+      }),\n+    },\n+    clientSide: {\n+      readable: clientSideReadable,\n+    },\n+  }\n+}\n+\n function createValidationOutlet() {\n   let resolveValidation: (value: React.ReactNode) => void\n   let outlet = new Promise<React.ReactNode>((resolve) => {\n@@ -2860,6 +2978,7 @@ async function spawnDynamicValidationInDev(\n       prerender,\n       <App\n         reactServerStream={initialServerResult.asUnclosingStream()}\n+        reactDebugStream={undefined}\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -3088,6 +3207,7 @@ async function spawnDynamicValidationInDev(\n             prerender,\n             <App\n               reactServerStream={reactServerResult.asUnclosingStream()}\n+              reactDebugStream={undefined}\n               preinitScripts={preinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -3233,6 +3353,7 @@ async function prerenderToStream(\n     nonce,\n     pagePath,\n     renderOpts,\n+    requestId,\n     workStore,\n   } = ctx\n \n@@ -3601,6 +3722,7 @@ async function prerenderToStream(\n           prerender,\n           <App\n             reactServerStream={initialServerResult.asUnclosingStream()}\n+            reactDebugStream={undefined}\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -3834,6 +3956,7 @@ async function prerenderToStream(\n               prerender,\n               <App\n                 reactServerStream={reactServerResult.asUnclosingStream()}\n+                reactDebugStream={undefined}\n                 preinitScripts={preinitScripts}\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -3997,6 +4120,7 @@ async function prerenderToStream(\n           const resumeStream = await resume(\n             <App\n               reactServerStream={foreverStream}\n+              reactDebugStream={undefined}\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -4021,7 +4145,8 @@ async function prerenderToStream(\n             inlinedDataStream: createInlinedDataReadableStream(\n               reactServerResult.consumeAsStream(),\n               nonce,\n-              formState\n+              formState,\n+              requestId\n             ),\n             getServerInsertedHTML,\n             getServerInsertedMetadata,\n@@ -4103,6 +4228,7 @@ async function prerenderToStream(\n           prerender,\n           <App\n             reactServerStream={reactServerResult.asUnclosingStream()}\n+            reactDebugStream={undefined}\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -4243,6 +4369,7 @@ async function prerenderToStream(\n           const resumeStream = await resume(\n             <App\n               reactServerStream={foreverStream}\n+              reactDebugStream={undefined}\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -4267,7 +4394,8 @@ async function prerenderToStream(\n             inlinedDataStream: createInlinedDataReadableStream(\n               reactServerResult.consumeAsStream(),\n               nonce,\n-              formState\n+              formState,\n+              requestId\n             ),\n             getServerInsertedHTML,\n             getServerInsertedMetadata,\n@@ -4326,6 +4454,7 @@ async function prerenderToStream(\n         renderToReadableStream,\n         <App\n           reactServerStream={reactServerResult.asUnclosingStream()}\n+          reactDebugStream={undefined}\n           preinitScripts={preinitScripts}\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -4363,7 +4492,8 @@ async function prerenderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             reactServerResult.consumeAsStream(),\n             nonce,\n-            formState\n+            formState,\n+            requestId\n           ),\n           isStaticGeneration: true,\n           isBuildTimePrerendering:\n@@ -4499,6 +4629,7 @@ async function prerenderToStream(\n           element: (\n             <ErrorApp\n               reactServerStream={errorServerStream}\n+              reactDebugStream={undefined}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n@@ -4540,7 +4671,8 @@ async function prerenderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             flightStream,\n             nonce,\n-            formState\n+            formState,\n+            requestId\n           ),\n           isStaticGeneration: true,\n           isBuildTimePrerendering:"
        },
        {
            "sha": "02fc9b600f10818c2b2204d973d347b88050bf9a",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -94,6 +94,11 @@ export interface RenderOptsPartial {\n   isOnDemandRevalidate?: boolean\n   isPossibleServerAction?: boolean\n   setIsrStatus?: (key: string, value: boolean) => void\n+  setReactDebugChannel?: (\n+    debugChannel: { readable: ReadableStream<Uint8Array> },\n+    htmlRequestId: string,\n+    requestId: string\n+  ) => void\n   isRevalidate?: boolean\n   nextExport?: boolean\n   nextConfigOutput?: 'standalone' | 'export'"
        },
        {
            "sha": "ec5a2811e5d1d2ed43113faf449487f3c5027f6e",
            "filename": "packages/next/src/server/app-render/use-flight-response.tsx",
            "status": "modified",
            "additions": 27,
            "deletions": 21,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -28,8 +28,9 @@ const findSourceMapURL =\n  */\n export function useFlightStream<T>(\n   flightStream: BinaryStreamOf<T>,\n+  debugStream: ReadableStream<Uint8Array> | undefined,\n   clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n-  nonce?: string\n+  nonce: string | undefined\n ): Promise<T> {\n   const response = flightResponses.get(flightStream)\n \n@@ -52,6 +53,7 @@ export function useFlightStream<T>(\n       serverModuleMap: null,\n     },\n     nonce,\n+    debugChannel: debugStream ? { readable: debugStream } : undefined,\n   })\n \n   // Edge pages are never prerendered so they necessarily cannot have a workUnitStore type\n@@ -101,7 +103,8 @@ export function useFlightStream<T>(\n export function createInlinedDataReadableStream(\n   flightStream: ReadableStream<Uint8Array>,\n   nonce: string | undefined,\n-  formState: unknown | null\n+  formState: unknown | null,\n+  requestId: string\n ): ReadableStream<Uint8Array> {\n   const startScriptTag = nonce\n     ? `<script nonce=${JSON.stringify(nonce)}>`\n@@ -114,7 +117,12 @@ export function createInlinedDataReadableStream(\n     type: 'bytes',\n     start(controller) {\n       try {\n-        writeInitialInstructions(controller, startScriptTag, formState)\n+        writeInitialInstructions(\n+          controller,\n+          startScriptTag,\n+          formState,\n+          requestId\n+        )\n       } catch (error) {\n         // during encoding or enqueueing forward the error downstream\n         controller.error(error)\n@@ -158,27 +166,25 @@ export function createInlinedDataReadableStream(\n function writeInitialInstructions(\n   controller: ReadableStreamDefaultController,\n   scriptStart: string,\n-  formState: unknown | null\n+  formState: unknown | null,\n+  requestId: string\n ) {\n+  let scriptContents = `(self.__next_f=self.__next_f||[]).push(${htmlEscapeJsonString(\n+    JSON.stringify([INLINE_FLIGHT_PAYLOAD_BOOTSTRAP])\n+  )})`\n+\n+  if (process.env.NODE_ENV !== 'production') {\n+    // The request ID is only needed in development mode.\n+    scriptContents = `self.__next_r=${JSON.stringify(requestId)};${scriptContents}`\n+  }\n+\n   if (formState != null) {\n-    controller.enqueue(\n-      encoder.encode(\n-        `${scriptStart}(self.__next_f=self.__next_f||[]).push(${htmlEscapeJsonString(\n-          JSON.stringify([INLINE_FLIGHT_PAYLOAD_BOOTSTRAP])\n-        )});self.__next_f.push(${htmlEscapeJsonString(\n-          JSON.stringify([INLINE_FLIGHT_PAYLOAD_FORM_STATE, formState])\n-        )})</script>`\n-      )\n-    )\n-  } else {\n-    controller.enqueue(\n-      encoder.encode(\n-        `${scriptStart}(self.__next_f=self.__next_f||[]).push(${htmlEscapeJsonString(\n-          JSON.stringify([INLINE_FLIGHT_PAYLOAD_BOOTSTRAP])\n-        )})</script>`\n-      )\n-    )\n+    scriptContents += `;self.__next_f.push(${htmlEscapeJsonString(\n+      JSON.stringify([INLINE_FLIGHT_PAYLOAD_FORM_STATE, formState])\n+    )})`\n   }\n+\n+  controller.enqueue(encoder.encode(`${scriptStart}${scriptContents}</script>`))\n }\n \n function writeFlightDataInstruction("
        },
        {
            "sha": "c5bb83ab54beefbe475ae2d1dc27691ea19b5224",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -499,6 +499,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n             })\n             .optional(),\n         ]),\n+        reactDebugChannel: z.boolean().optional(),\n         staticGenerationRetryCount: z.number().int().optional(),\n         staticGenerationMaxConcurrency: z.number().int().optional(),\n         staticGenerationMinPagesPerWorker: z.number().int().optional(),"
        },
        {
            "sha": "ae5b1b498ec57bff4116ae85a82c2ccad3399b18",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -849,6 +849,14 @@ export interface ExperimentalConfig {\n    */\n   reactCompiler?: boolean | ReactCompilerOptions\n \n+  /**\n+   * When enabled, in dev mode, Next.js will send React's debug info through the\n+   * WebSocket connection, instead of including it in the main RSC payload.\n+   *\n+   * @default true\n+   */\n+  reactDebugChannel?: boolean\n+\n   /**\n    * The number of times to retry static generation (per page) before giving up.\n    */\n@@ -1626,6 +1634,7 @@ export const defaultConfig = Object.freeze({\n     },\n     allowDevelopmentBuild: undefined,\n     reactCompiler: undefined,\n+    reactDebugChannel: true,\n     staticGenerationRetryCount: undefined,\n     serverComponentsHmrCache: true,\n     staticGenerationMaxConcurrency: 8,"
        },
        {
            "sha": "ad202df7e62803612241dc9373d052ae129689b6",
            "filename": "packages/next/src/server/dev/debug-channel.ts",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -0,0 +1,75 @@\n+import { createBufferedTransformStream } from '../stream-utils/node-web-streams-helper'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type HmrMessageSentToBrowser,\n+} from './hot-reloader-types'\n+\n+export interface ReactDebugChannelForBrowser {\n+  readonly readable: ReadableStream<Uint8Array>\n+  // Might also get a writable stream as return channel in the future.\n+}\n+\n+const reactDebugChannelsByRequestId = new Map<\n+  string,\n+  ReactDebugChannelForBrowser\n+>()\n+\n+export function connectReactDebugChannel(\n+  requestId: string,\n+  sendToClient: (message: HmrMessageSentToBrowser) => void\n+) {\n+  const debugChannel = reactDebugChannelsByRequestId.get(requestId)\n+\n+  if (!debugChannel) {\n+    return\n+  }\n+\n+  const reader = debugChannel.readable\n+    .pipeThrough(\n+      // We're sending the chunks in batches to reduce overhead in the browser.\n+      createBufferedTransformStream({ maxBufferByteLength: 128 * 1024 })\n+    )\n+    .getReader()\n+\n+  const stop = () => {\n+    sendToClient({\n+      type: HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK,\n+      requestId,\n+      chunk: null,\n+    })\n+\n+    reactDebugChannelsByRequestId.delete(requestId)\n+  }\n+\n+  const onError = (err: unknown) => {\n+    console.error(new Error('React debug channel stream error', { cause: err }))\n+    stop()\n+  }\n+\n+  const progress = (entry: ReadableStreamReadResult<Uint8Array>) => {\n+    if (entry.done) {\n+      stop()\n+    } else {\n+      sendToClient({\n+        type: HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK,\n+        requestId,\n+        chunk: entry.value,\n+      })\n+\n+      reader.read().then(progress, onError)\n+    }\n+  }\n+\n+  reader.read().then(progress, onError)\n+}\n+\n+export function setReactDebugChannel(\n+  requestId: string,\n+  debugChannel: ReactDebugChannelForBrowser\n+) {\n+  reactDebugChannelsByRequestId.set(requestId, debugChannel)\n+}\n+\n+export function deleteReactDebugChannel(requestId: string) {\n+  reactDebugChannelsByRequestId.delete(requestId)\n+}"
        },
        {
            "sha": "d75fe1f1262bc72190f62428001e9354761c3ea7",
            "filename": "packages/next/src/server/dev/hot-middleware.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 36,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -29,6 +29,7 @@ import type { VersionInfo } from './parse-version-info'\n import type { HmrMessageSentToBrowser } from './hot-reloader-types'\n import { HMR_MESSAGE_SENT_TO_BROWSER } from './hot-reloader-types'\n import { devIndicatorServerState } from './dev-indicator-server-state'\n+import { createBinaryHmrMessageData } from './messages'\n \n function isMiddlewareStats(stats: webpack.Stats) {\n   for (const key of stats.compilation.entrypoints.keys()) {\n@@ -68,36 +69,10 @@ function getStatsForSyncEvent(\n   return serverStats.ts > clientStats.ts ? serverStats.stats : clientStats.stats\n }\n \n-class EventStream {\n-  clients: Set<ws>\n-  constructor() {\n-    this.clients = new Set()\n-  }\n-\n-  close() {\n-    for (const wsClient of this.clients) {\n-      // it's okay to not cleanly close these websocket connections, this is dev\n-      wsClient.terminate()\n-    }\n-    this.clients.clear()\n-  }\n-\n-  handler(client: ws) {\n-    this.clients.add(client)\n-    client.addEventListener('close', () => {\n-      this.clients.delete(client)\n-    })\n-  }\n-\n-  publish(message: any) {\n-    for (const wsClient of this.clients) {\n-      wsClient.send(JSON.stringify(message))\n-    }\n-  }\n-}\n-\n export class WebpackHotMiddleware {\n-  eventStream: EventStream\n+  private clients = new Set<ws>()\n+  private clientsByRequestId: Map<string, ws> = new Map()\n+\n   clientLatestStats: { ts: number; stats: webpack.Stats } | null\n   middlewareLatestStats: { ts: number; stats: webpack.Stats } | null\n   serverLatestStats: { ts: number; stats: webpack.Stats } | null\n@@ -112,7 +87,6 @@ export class WebpackHotMiddleware {\n     devtoolsFrontendUrl: string | undefined,\n     devToolsConfig: DevToolsConfig\n   ) {\n-    this.eventStream = new EventStream()\n     this.clientLatestStats = null\n     this.middlewareLatestStats = null\n     this.serverLatestStats = null\n@@ -198,9 +172,22 @@ export class WebpackHotMiddleware {\n    * and we still want to show the client overlay with the error while\n    * the error page should be rendered just fine.\n    */\n-  onHMR = (client: ws) => {\n+  onHMR = (client: ws, requestId: string | null) => {\n     if (this.closed) return\n-    this.eventStream.handler(client)\n+\n+    this.clients.add(client)\n+\n+    if (requestId) {\n+      this.clientsByRequestId.set(requestId, client)\n+    }\n+\n+    client.addEventListener('close', () => {\n+      this.clients.delete(client)\n+\n+      if (requestId) {\n+        this.clientsByRequestId.delete(requestId)\n+      }\n+    })\n \n     const syncStats = getStatsForSyncEvent(\n       this.clientLatestStats,\n@@ -250,15 +237,56 @@ export class WebpackHotMiddleware {\n     })\n   }\n \n+  getClient = (requestId: string): ws | undefined => {\n+    return this.clientsByRequestId.get(requestId)\n+  }\n+\n+  publishToClient = (client: ws, message: HmrMessageSentToBrowser) => {\n+    if (this.closed) {\n+      return\n+    }\n+\n+    const data =\n+      typeof message.type === 'number'\n+        ? createBinaryHmrMessageData(message)\n+        : JSON.stringify(message)\n+\n+    client.send(data)\n+  }\n+\n   publish = (message: HmrMessageSentToBrowser) => {\n-    if (this.closed) return\n-    this.eventStream.publish(message)\n+    if (this.closed) {\n+      return\n+    }\n+\n+    for (const wsClient of this.clients) {\n+      this.publishToClient(wsClient, message)\n+    }\n   }\n+\n   close = () => {\n-    if (this.closed) return\n+    if (this.closed) {\n+      return\n+    }\n+\n     // Can't remove compiler plugins, so we just set a flag and noop if closed\n     // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n     this.closed = true\n-    this.eventStream.close()\n+\n+    for (const wsClient of this.clients) {\n+      // it's okay to not cleanly close these websocket connections, this is dev\n+      wsClient.terminate()\n+    }\n+\n+    this.clients.clear()\n+    this.clientsByRequestId.clear()\n+  }\n+\n+  deleteClient = (client: ws, requestId: string | null) => {\n+    this.clients.delete(client)\n+\n+    if (requestId) {\n+      this.clientsByRequestId.delete(requestId)\n+    }\n   }\n }"
        },
        {
            "sha": "f85cc3748dc0bc86774cec1be1b333299a92d9aa",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 2,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -73,7 +73,10 @@ import {\n   getEntryKey,\n   splitEntryKey,\n } from '../../shared/lib/turbopack/entry-key'\n-import { FAST_REFRESH_RUNTIME_RELOAD } from './messages'\n+import {\n+  createBinaryHmrMessageData,\n+  FAST_REFRESH_RUNTIME_RELOAD,\n+} from './messages'\n import { generateEncryptionKeyBase64 } from '../app-render/encryption-utils-server'\n import { isAppPageRouteDefinition } from '../route-definitions/app-page-route-definition'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n@@ -103,6 +106,11 @@ import {\n   devToolsConfigMiddleware,\n   getDevToolsConfig,\n } from '../../next-devtools/server/devtools-config-middleware'\n+import {\n+  connectReactDebugChannel,\n+  deleteReactDebugChannel,\n+  setReactDebugChannel,\n+} from './debug-channel'\n \n const wsServer = new ws.Server({ noServer: true })\n const isTestMode = !!(\n@@ -411,10 +419,16 @@ export async function createHotReloaderTurbopack(\n   let hmrHash = 0\n \n   const clients = new Set<ws>()\n+  const clientsByRequestId = new Map<string, ws>()\n   const clientStates = new WeakMap<ws, ClientState>()\n \n   function sendToClient(client: ws, message: HmrMessageSentToBrowser) {\n-    client.send(JSON.stringify(message))\n+    const data =\n+      typeof message.type === 'number'\n+        ? createBinaryHmrMessageData(message)\n+        : JSON.stringify(message)\n+\n+    client.send(data)\n   }\n \n   function sendEnqueuedMessages() {\n@@ -747,6 +761,15 @@ export async function createHotReloaderTurbopack(\n         const subscriptions: Map<string, AsyncIterator<any>> = new Map()\n \n         clients.add(client)\n+\n+        const requestId = req.url\n+          ? new URL(req.url, 'http://n').searchParams.get('id')\n+          : null\n+\n+        if (requestId) {\n+          clientsByRequestId.set(requestId, client)\n+        }\n+\n         clientStates.set(client, {\n           clientIssues,\n           messages: new Map(),\n@@ -761,6 +784,11 @@ export async function createHotReloaderTurbopack(\n           }\n           clientStates.delete(client)\n           clients.delete(client)\n+\n+          if (requestId) {\n+            clientsByRequestId.delete(requestId)\n+            deleteReactDebugChannel(requestId)\n+          }\n         })\n \n         client.addEventListener('message', async ({ data }) => {\n@@ -899,17 +927,35 @@ export async function createHotReloaderTurbopack(\n           }\n \n           sendToClient(client, syncMessage)\n+\n+          if (requestId) {\n+            connectReactDebugChannel(requestId, sendToClient.bind(null, client))\n+          }\n         })()\n       })\n     },\n \n     send(action) {\n       const payload = JSON.stringify(action)\n+\n       for (const client of clients) {\n         client.send(payload)\n       }\n     },\n \n+    setReactDebugChannel(debugChannel, htmlRequestId, requestId) {\n+      // Store the debug channel, regardless of whether the client is connected.\n+      setReactDebugChannel(requestId, debugChannel)\n+\n+      // If the client is connected, we can connect the debug channel\n+      // immediately. Otherwise, we'll do that when the client connects.\n+      const client = clientsByRequestId.get(htmlRequestId)\n+\n+      if (client) {\n+        connectReactDebugChannel(requestId, sendToClient.bind(null, client))\n+      }\n+    },\n+\n     setHmrServerError(_error) {\n       // Not implemented yet.\n     },\n@@ -1145,6 +1191,7 @@ export async function createHotReloaderTurbopack(\n         wsClient.terminate()\n       }\n       clients.clear()\n+      clientsByRequestId.clear()\n     },\n   }\n "
        },
        {
            "sha": "49fee781787dcc0e985b31407faaec391690e146",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -9,8 +9,10 @@ import type { VersionInfo } from './parse-version-info'\n import type { DebugInfo } from '../../next-devtools/shared/types'\n import type { DevIndicatorServerState } from './dev-indicator-server-state'\n import type { DevToolsConfig } from '../../next-devtools/dev-overlay/shared'\n+import type { ReactDebugChannelForBrowser } from './debug-channel'\n \n export const enum HMR_MESSAGE_SENT_TO_BROWSER {\n+  // JSON messages:\n   ADDED_PAGE = 'addedPage',\n   REMOVED_PAGE = 'removedPage',\n   RELOAD_PAGE = 'reloadPage',\n@@ -28,6 +30,9 @@ export const enum HMR_MESSAGE_SENT_TO_BROWSER {\n   ISR_MANIFEST = 'isrManifest',\n   DEV_INDICATOR = 'devIndicator',\n   DEVTOOLS_CONFIG = 'devtoolsConfig',\n+\n+  // Binary messages:\n+  REACT_DEBUG_CHUNK = 0,\n }\n \n export interface ServerErrorMessage {\n@@ -129,6 +134,15 @@ export interface DevToolsConfigMessage {\n   data: DevToolsConfig\n }\n \n+export interface ReactDebugChunkMessage {\n+  type: HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK\n+  requestId: string\n+  /**\n+   * A null chunk signals to the browser that no more chunks will be sent.\n+   */\n+  chunk: Uint8Array | null\n+}\n+\n export type HmrMessageSentToBrowser =\n   | TurbopackMessage\n   | TurbopackConnectedMessage\n@@ -146,6 +160,12 @@ export type HmrMessageSentToBrowser =\n   | ServerErrorMessage\n   | AppIsrManifestMessage\n   | DevToolsConfigMessage\n+  | ReactDebugChunkMessage\n+\n+export type BinaryHmrMessageSentToBrowser = Extract<\n+  HmrMessageSentToBrowser,\n+  { type: number }\n+>\n \n export type TurbopackMessageSentToBrowser =\n   | {\n@@ -171,7 +191,12 @@ export interface NextJsHotReloaderInterface {\n   setHmrServerError(error: Error | null): void\n   clearHmrServerError(): void\n   start(): Promise<void>\n-  send(message: HmrMessageSentToBrowser): void\n+  send(action: HmrMessageSentToBrowser): void\n+  setReactDebugChannel(\n+    debugChannel: ReactDebugChannelForBrowser,\n+    htmlRequestId: string,\n+    requestId: string\n+  ): void\n   getCompilationErrors(page: string): Promise<any[]>\n   onHMR(\n     req: IncomingMessage,"
        },
        {
            "sha": "0b17ac8268cb70ebb3aba7a776b2fe5cf90b673e",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -95,6 +95,13 @@ import {\n   devToolsConfigMiddleware,\n   getDevToolsConfig,\n } from '../../next-devtools/server/devtools-config-middleware'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n+import {\n+  connectReactDebugChannel,\n+  deleteReactDebugChannel,\n+  setReactDebugChannel,\n+  type ReactDebugChannelForBrowser,\n+} from './debug-channel'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -438,7 +445,15 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     callback: (client: ws.WebSocket) => void\n   ) {\n     wsServer.handleUpgrade(req, req.socket, head, (client) => {\n-      this.webpackHotMiddleware?.onHMR(client)\n+      const requestId = req.url\n+        ? new URL(req.url, 'http://n').searchParams.get('id')\n+        : null\n+\n+      if (!this.webpackHotMiddleware) {\n+        throw new InvariantError('Did not start HotReloaderWebpack.')\n+      }\n+\n+      this.webpackHotMiddleware.onHMR(client, requestId)\n       this.onDemandEntries?.onHMR(client, () => this.hmrServerError)\n       callback(client)\n \n@@ -605,6 +620,21 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n           // invalid WebSocket message\n         }\n       })\n+\n+      if (requestId) {\n+        connectReactDebugChannel(\n+          requestId,\n+          this.sendToClient.bind(this, client)\n+        )\n+      }\n+\n+      client.on('close', () => {\n+        this.webpackHotMiddleware?.deleteClient(client, requestId)\n+\n+        if (requestId) {\n+          deleteReactDebugChannel(requestId)\n+        }\n+      })\n     })\n   }\n \n@@ -1663,6 +1693,27 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     this.webpackHotMiddleware!.publish(message)\n   }\n \n+  public sendToClient(client: ws, message: HmrMessageSentToBrowser): void {\n+    this.webpackHotMiddleware!.publishToClient(client, message)\n+  }\n+\n+  public setReactDebugChannel(\n+    debugChannel: ReactDebugChannelForBrowser,\n+    htmlRequestId: string,\n+    requestId: string\n+  ): void {\n+    // Store the debug channel, regardless of whether the client is connected.\n+    setReactDebugChannel(requestId, debugChannel)\n+\n+    // If the client is connected, we can connect the debug channel immediately.\n+    // Otherwise, we'll do that when the client connects.\n+    const client = this.webpackHotMiddleware?.getClient(htmlRequestId)\n+\n+    if (client) {\n+      connectReactDebugChannel(requestId, this.sendToClient.bind(this, client))\n+    }\n+  }\n+\n   public async ensurePage({\n     page,\n     clientOnly,"
        },
        {
            "sha": "4eb70bd8145bdec93c499f789b47bdb1a19ff83a",
            "filename": "packages/next/src/server/dev/messages.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmessages.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -1,2 +1,48 @@\n+import { InvariantError } from '../../shared/lib/invariant-error'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type BinaryHmrMessageSentToBrowser,\n+} from './hot-reloader-types'\n+\n export const FAST_REFRESH_RUNTIME_RELOAD =\n   'Fast Refresh had to perform a full reload due to a runtime error.'\n+\n+const textEncoder = new TextEncoder()\n+\n+export function createBinaryHmrMessageData(\n+  message: BinaryHmrMessageSentToBrowser\n+): Uint8Array {\n+  switch (message.type) {\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK: {\n+      const { requestId, chunk } = message\n+      const requestIdBytes = textEncoder.encode(requestId)\n+      const requestIdLength = requestIdBytes.length\n+\n+      if (requestIdLength > 255) {\n+        throw new InvariantError(\n+          'Request ID is too long for the binary HMR message.'\n+        )\n+      }\n+\n+      const chunkLength = chunk ? chunk.length : 0\n+      const totalLength = 2 + requestIdLength + chunkLength\n+      const data = new Uint8Array(totalLength)\n+      const view = new DataView(data.buffer)\n+\n+      view.setUint8(0, HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK)\n+      view.setUint8(1, requestIdLength)\n+      textEncoder.encodeInto(requestId, data.subarray(2, 2 + requestIdLength))\n+\n+      if (chunk) {\n+        data.set(chunk, 2 + requestIdLength)\n+      }\n+\n+      return data\n+    }\n+    default: {\n+      throw new InvariantError(\n+        `Invalid binary HMR message of type ${message.type}`\n+      )\n+    }\n+  }\n+}"
        },
        {
            "sha": "44cd3889963bffaa29b96f763873d4ad34e3a848",
            "filename": "packages/next/src/server/lib/dev-bundler-service.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -5,6 +5,7 @@ import type { WorkerRequestHandler } from './types'\n import { LRUCache } from './lru-cache'\n import { createRequestResponseMocks } from './mock-request'\n import { HMR_MESSAGE_SENT_TO_BROWSER } from '../dev/hot-reloader-types'\n+import type { ReactDebugChannelForBrowser } from '../dev/debug-channel'\n \n /**\n  * The DevBundlerService provides an interface to perform tasks with the\n@@ -106,6 +107,18 @@ export class DevBundlerService {\n     })\n   }\n \n+  public setReactDebugChannel(\n+    debugChannel: ReactDebugChannelForBrowser,\n+    htmlRequestId: string,\n+    requestId: string\n+  ): void {\n+    this.bundler.hotReloader.setReactDebugChannel(\n+      debugChannel,\n+      htmlRequestId,\n+      requestId\n+    )\n+  }\n+\n   public close() {\n     this.bundler.hotReloader.close()\n   }"
        },
        {
            "sha": "1672cbd50360e42082e9e4555d7aad4e204efcb6",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -724,6 +724,9 @@ export async function initialize(opts: {\n       ? handlers.server.logErrorWithOriginalStack.bind(handlers.server)\n       : (err: unknown) => !opts.quiet && Log.error(err),\n     setIsrStatus: devBundlerService?.setIsrStatus.bind(devBundlerService),\n+    setReactDebugChannel: config.experimental.reactDebugChannel\n+      ? devBundlerService?.setReactDebugChannel.bind(devBundlerService)\n+      : undefined,\n   }\n \n   const logError = async ("
        },
        {
            "sha": "568be2acae75fbcc7ed7da6c661a26bc5737db72",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -40,6 +40,11 @@ export type RouterServerContext = Record<\n     logErrorWithOriginalStack?: (err: unknown, type: string) => void\n     // allow setting ISR status in dev\n     setIsrStatus?: (key: string, value: boolean) => void\n+    setReactDebugChannel?: (\n+      debugChannel: { readable: ReadableStream<Uint8Array> },\n+      htmlRequestId: string,\n+      requestId: string\n+    ) => void\n   }\n >\n "
        },
        {
            "sha": "bd2bb1c54c9254e8a223add63a0d743dbd32d3f8",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 28,
            "changes": 76,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -123,40 +123,59 @@ export async function streamToString(\n   return string\n }\n \n-export function createBufferedTransformStream(): TransformStream<\n-  Uint8Array,\n-  Uint8Array\n-> {\n+export type BufferedTransformOptions = {\n+  /**\n+   * Flush synchronously once the buffer reaches this many bytes.\n+   */\n+  readonly maxBufferByteLength?: number\n+}\n+\n+export function createBufferedTransformStream(\n+  options: BufferedTransformOptions = {}\n+): TransformStream<Uint8Array, Uint8Array> {\n+  const { maxBufferByteLength = Infinity } = options\n+\n   let bufferedChunks: Array<Uint8Array> = []\n   let bufferByteLength: number = 0\n   let pending: DetachedPromise<void> | undefined\n \n   const flush = (controller: TransformStreamDefaultController) => {\n-    // If we already have a pending flush, then return early.\n-    if (pending) return\n+    try {\n+      if (bufferedChunks.length === 0) {\n+        return\n+      }\n+\n+      const chunk = new Uint8Array(bufferByteLength)\n+      let copiedBytes = 0\n+\n+      for (let i = 0; i < bufferedChunks.length; i++) {\n+        const bufferedChunk = bufferedChunks[i]\n+        chunk.set(bufferedChunk, copiedBytes)\n+        copiedBytes += bufferedChunk.byteLength\n+      }\n+      // We just wrote all the buffered chunks so we need to reset the bufferedChunks array\n+      // and our bufferByteLength to prepare for the next round of buffered chunks\n+      bufferedChunks.length = 0\n+      bufferByteLength = 0\n+      controller.enqueue(chunk)\n+    } catch {\n+      // If an error occurs while enqueuing, it can't be due to this\n+      // transformer. It's most likely caused by the controller having been\n+      // errored (for example, if the stream was cancelled).\n+    }\n+  }\n+\n+  const scheduleFlush = (controller: TransformStreamDefaultController) => {\n+    if (pending) {\n+      return\n+    }\n \n     const detached = new DetachedPromise<void>()\n     pending = detached\n \n     scheduleImmediate(() => {\n       try {\n-        const chunk = new Uint8Array(bufferByteLength)\n-        let copiedBytes = 0\n-\n-        for (let i = 0; i < bufferedChunks.length; i++) {\n-          const bufferedChunk = bufferedChunks[i]\n-          chunk.set(bufferedChunk, copiedBytes)\n-          copiedBytes += bufferedChunk.byteLength\n-        }\n-        // We just wrote all the buffered chunks so we need to reset the bufferedChunks array\n-        // and our bufferByteLength to prepare for the next round of buffered chunks\n-        bufferedChunks.length = 0\n-        bufferByteLength = 0\n-        controller.enqueue(chunk)\n-      } catch {\n-        // If an error occurs while enqueuing it can't be due to this\n-        // transformers fault. It's likely due to the controller being\n-        // errored due to the stream being cancelled.\n+        flush(controller)\n       } finally {\n         pending = undefined\n         detached.resolve()\n@@ -170,13 +189,14 @@ export function createBufferedTransformStream(): TransformStream<\n       bufferedChunks.push(chunk)\n       bufferByteLength += chunk.byteLength\n \n-      // Flush the buffer to the controller.\n-      flush(controller)\n+      if (bufferByteLength >= maxBufferByteLength) {\n+        flush(controller)\n+      } else {\n+        scheduleFlush(controller)\n+      }\n     },\n     flush() {\n-      if (!pending) return\n-\n-      return pending.promise\n+      return pending?.promise\n     },\n   })\n }"
        },
        {
            "sha": "ad341447e763fd465dbc86615e9335dc0d20ae27",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -104,6 +104,7 @@ declare module 'react-server-dom-webpack/client.browser' {\n     findSourceMapURL: FindSourceMapURLCallback | undefined\n     replayConsoleLogs?: boolean\n     temporaryReferences?: TemporaryReferenceSet\n+    debugChannel?: { readable?: ReadableStream; writable?: WritableStream }\n   }\n \n   export function createFromFetch<T>(\n@@ -156,6 +157,7 @@ declare module 'react-server-dom-webpack/server.edge' {\n       onError?: (error: unknown) => void\n       onPostpone?: (reason: string) => void\n       signal?: AbortSignal\n+      debugChannel?: { readable?: ReadableStream; writable?: WritableStream }\n     }\n   ): ReadableStream<Uint8Array>\n \n@@ -305,6 +307,7 @@ declare module 'react-server-dom-webpack/client.edge' {\n     findSourceMapURL: FindSourceMapURLCallback | undefined\n     replayConsoleLogs?: boolean\n     environmentName?: string\n+    debugChannel?: { readable?: ReadableStream }\n   }\n \n   export type EncodeFormActionCallback = <A>("
        },
        {
            "sha": "aa1828875d961fb37b99b226d09e5127676f9a15",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 265,
            "deletions": 159,
            "changes": 424,
            "blob_url": "https://github.com/vercel/next.js/blob/0accb03cbedad6db79d1c82c46f006e3cbb37292/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0accb03cbedad6db79d1c82c46f006e3cbb37292/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=0accb03cbedad6db79d1c82c46f006e3cbb37292",
            "patch": "@@ -9,6 +9,8 @@ import {\n   retry,\n } from 'next-test-utils'\n \n+const pprEnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n+\n describe('Error overlay for hydration errors in App router', () => {\n   const { next, isTurbopack } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'hydration-errors')),\n@@ -145,16 +147,16 @@ describe('Error overlay for hydration errors in App router', () => {\n                <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                  <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                    <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                     <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={{...}} forbidden={undefined} ...>\n                          <RedirectBoundary>\n                            <RedirectErrorBoundary router={{...}}>\n                              <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n                                <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n                                  <SegmentTrieNode>\n                                  <script>\n                                  <script>\n-                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                 <ClientSegmentRoot Component={function Root} slots={{children:{...}}} params={{}}>\n                                    <Root params={Promise}>\n                                      <html\n        -                               className=\"server-html\"\n@@ -182,14 +184,14 @@ describe('Error overlay for hydration errors in App router', () => {\n                <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                  <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                    <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                     <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={{...}} forbidden={undefined} ...>\n                          <RedirectBoundary>\n                            <RedirectErrorBoundary router={{...}}>\n                              <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n                                <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n                                  <SegmentTrieNode>\n-                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                 <ClientSegmentRoot Component={function Root} slots={{children:{...}}} params={{}}>\n                                    <Root params={Promise}>\n                                      <html\n        -                               className=\"server-html\"\n@@ -751,160 +753,264 @@ describe('Error overlay for hydration errors in App router', () => {\n       )\n     })\n \n-    if (isTurbopack) {\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       [\n-         {\n-           \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n-       >  8 |       <Script\n-            |       ^\",\n-           \"stack\": [\n-             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n-           ],\n-         },\n-         {\n-           \"componentStack\": \"...\n-           <RenderFromTemplateContext>\n-             <ScrollAndFocusHandler segmentPath={[...]}>\n-               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-                   <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={<SegmentViewNode>} ...>\n-                         <RedirectBoundary>\n-                           <RedirectErrorBoundary router={{...}}>\n-                             <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n-                               <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n-                                 <SegmentTrieNode>\n-                                 <script>\n-                                 <script>\n-                                 <Root>\n-                                   <NotFound>\n-                                     <HTTPAccessErrorFallback>\n-                                       <NotFound>\n-                                         <HTTPAccessErrorFallback>\n-                                           <NotFound>\n-                                             <HTTPAccessErrorFallback>\n-                                               <NotFound>\n-                                                 <HTTPAccessErrorFallback>\n-                                                   <NotFound>\n-                                                     <HTTPAccessErrorFallback>\n-       >                                               <html>\n-                                                         <body>\n-                                                         <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n-       >                                                   <script\n-       >                                                     nonce={undefined}\n-       >                                                     dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}\n-       >                                                   >\n-                             ...\n-                 ...\n-           ...\",\n-           \"description\": \"In HTML, <script> cannot be a child of <html>.\n-       This will cause a hydration error.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n-       >  8 |       <Script\n-            |       ^\",\n-           \"stack\": [\n-             \"script <anonymous>\",\n-             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n-           ],\n-         },\n-         {\n-           \"description\": \"<html> cannot contain a nested <script>.\n-       See this log for the ancestor stack trace.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n-       > 6 |     <html>\n-           |     ^\",\n-           \"stack\": [\n-             \"html <anonymous>\",\n-             \"Root app/(script-under-html)/layout.tsx (6:5)\",\n-           ],\n-         },\n-       ]\n-      `)\n+    if (pprEnabled) {\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"componentStack\": \"...\n+             <RenderFromTemplateContext>\n+               <ScrollAndFocusHandler segmentPath={[...]}>\n+                 <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                   <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                     <LoadingBoundary loading={null}>\n+                       <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                         <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={{...}} forbidden={undefined} ...>\n+                           <RedirectBoundary>\n+                             <RedirectErrorBoundary router={{...}}>\n+                               <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                                 <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                   <SegmentTrieNode>\n+                                   <script>\n+                                   <script>\n+         >                         <html>\n+                                     <body>\n+                                     <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+         >                             <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n+                               ...\n+                   ...\n+             ...\",\n+             \"description\": \"In HTML, <script> cannot be a child of <html>.\n+         This will cause a hydration error.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"script <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"<html> cannot contain a nested <script>.\n+         See this log for the ancestor stack trace.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+         > 6 |     <html>\n+             |     ^\",\n+             \"stack\": [\n+               \"html <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (6:5)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      } else {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"componentStack\": \"...\n+             <RenderFromTemplateContext>\n+               <ScrollAndFocusHandler segmentPath={[...]}>\n+                 <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                   <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                     <LoadingBoundary loading={null}>\n+                       <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                         <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={{...}} forbidden={undefined} ...>\n+                           <RedirectBoundary>\n+                             <RedirectErrorBoundary router={{...}}>\n+                               <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                                 <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                   <SegmentTrieNode>\n+         >                         <html>\n+                                     <body>\n+                                     <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+         >                             <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n+                               ...\n+                   ...\n+             ...\",\n+             \"description\": \"In HTML, <script> cannot be a child of <html>.\n+         This will cause a hydration error.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"script <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"<html> cannot contain a nested <script>.\n+         See this log for the ancestor stack trace.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+         > 6 |     <html>\n+             |     ^\",\n+             \"stack\": [\n+               \"html <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (6:5)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      }\n     } else {\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       [\n-         {\n-           \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n-       >  8 |       <Script\n-            |       ^\",\n-           \"stack\": [\n-             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n-           ],\n-         },\n-         {\n-           \"componentStack\": \"...\n-           <RenderFromTemplateContext>\n-             <ScrollAndFocusHandler segmentPath={[...]}>\n-               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-                   <LoadingBoundary loading={null}>\n-                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                       <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={<SegmentViewNode>} ...>\n-                         <RedirectBoundary>\n-                           <RedirectErrorBoundary router={{...}}>\n-                             <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n-                               <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n-                                 <SegmentTrieNode>\n-                                 <Root>\n-                                   <NotFound>\n-                                     <HTTPAccessErrorFallback>\n-                                       <NotFound>\n-                                         <HTTPAccessErrorFallback>\n-                                           <NotFound>\n-                                             <HTTPAccessErrorFallback>\n-                                               <NotFound>\n-                                                 <HTTPAccessErrorFallback>\n-                                                   <NotFound>\n-                                                     <HTTPAccessErrorFallback>\n-       >                                               <html>\n-                                                         <body>\n-                                                         <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n-       >                                                   <script\n-       >                                                     nonce={undefined}\n-       >                                                     dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}\n-       >                                                   >\n-                             ...\n-                 ...\n-           ...\",\n-           \"description\": \"In HTML, <script> cannot be a child of <html>.\n-       This will cause a hydration error.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n-       >  8 |       <Script\n-            |       ^\",\n-           \"stack\": [\n-             \"script <anonymous>\",\n-             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n-           ],\n-         },\n-         {\n-           \"description\": \"<html> cannot contain a nested <script>.\n-       See this log for the ancestor stack trace.\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n-       > 6 |     <html>\n-           |     ^\",\n-           \"stack\": [\n-             \"html <anonymous>\",\n-             \"Root app/(script-under-html)/layout.tsx (6:5)\",\n-           ],\n-         },\n-       ]\n-      `)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"componentStack\": \"...\n+             <RenderFromTemplateContext>\n+               <ScrollAndFocusHandler segmentPath={[...]}>\n+                 <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                   <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                     <LoadingBoundary loading={null}>\n+                       <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                         <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={{...}} forbidden={undefined} ...>\n+                           <RedirectBoundary>\n+                             <RedirectErrorBoundary router={{...}}>\n+                               <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                                 <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                   <SegmentTrieNode>\n+                                   <Root>\n+                                     <script>\n+                                     <script>\n+         >                           <html>\n+                                       <body>\n+                                       <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+         >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n+                               ...\n+                   ...\n+             ...\",\n+             \"description\": \"In HTML, <script> cannot be a child of <html>.\n+         This will cause a hydration error.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"script <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"<html> cannot contain a nested <script>.\n+         See this log for the ancestor stack trace.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+         > 6 |     <html>\n+             |     ^\",\n+             \"stack\": [\n+               \"html <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (6:5)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      } else {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"componentStack\": \"...\n+             <RenderFromTemplateContext>\n+               <ScrollAndFocusHandler segmentPath={[...]}>\n+                 <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                   <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                     <LoadingBoundary loading={null}>\n+                       <HTTPAccessFallbackBoundary notFound={{...}} forbidden={undefined} unauthorized={undefined}>\n+                         <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={{...}} forbidden={undefined} ...>\n+                           <RedirectBoundary>\n+                             <RedirectErrorBoundary router={{...}}>\n+                               <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                                 <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                   <SegmentTrieNode>\n+                                   <Root>\n+         >                           <html>\n+                                       <body>\n+                                       <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+         >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n+                               ...\n+                   ...\n+             ...\",\n+             \"description\": \"In HTML, <script> cannot be a child of <html>.\n+         This will cause a hydration error.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+         >  8 |       <Script\n+              |       ^\",\n+             \"stack\": [\n+               \"script <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (8:7)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"<html> cannot contain a nested <script>.\n+         See this log for the ancestor stack trace.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+         > 6 |     <html>\n+             |     ^\",\n+             \"stack\": [\n+               \"html <anonymous>\",\n+               \"Root app/(script-under-html)/layout.tsx (6:5)\",\n+             ],\n+           },\n+         ]\n+        `)\n+      }\n     }\n   })\n })"
        }
    ],
    "stats": {
        "total": 1398,
        "additions": 1087,
        "deletions": 311
    }
}