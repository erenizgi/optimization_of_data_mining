{
    "author": "ijjk",
    "message": "Replace node:url usage in server-utils (#79094)\n\nThis updates to avoid using `node:url` in the `pages-api` template file\nand our `server-utils` which is used across all templates. The main\nreason is to avoid pulling in `node` polyfill un-necessarily in non-node\nruntimes.\n\nValidated against deploy tests here\nhttps://github.com/vercel/vercel/actions/runs/14977933925/job/42074926257?pr=13324",
    "sha": "66bd9dfbc8e7b8753c905cec957444a52a1604d0",
    "files": [
        {
            "sha": "3990e83e0b0284e7b31e5ec0a5846e46b44fab17",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=66bd9dfbc8e7b8753c905cec957444a52a1604d0",
            "patch": "@@ -4,7 +4,6 @@ import type { PrerenderManifest } from '..'\n import type { DevRoutesManifest } from '../../server/lib/router-utils/setup-dev-bundler'\n import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n \n-import { parse } from 'node:url'\n import { sendError } from '../../server/api-utils'\n import { RouteKind } from '../../server/route-kind'\n import type { Span } from '../../server/lib/trace/tracer'\n@@ -35,6 +34,7 @@ import {\n import { loadManifestFromRelativePath } from '../../server/load-manifest.external'\n import { getHostname } from '../../shared/lib/get-hostname'\n import { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\n+import { parseReqUrl } from '../../lib/url'\n \n // Re-export the handler (should be the default export).\n export default hoist(userland, 'default')\n@@ -109,7 +109,15 @@ export async function handler(\n     }\n   }\n \n-  const parsedUrl = parse(req.url || '/', true)\n+  const parsedUrl = parseReqUrl(req.url || '/')\n+\n+  if (!parsedUrl) {\n+    res.statusCode = 400\n+    res.end('Bad Request')\n+    ctx.waitUntil?.(Promise.resolve())\n+    return\n+  }\n+\n   const pageIsDynamic = isDynamicRoute(srcPage)\n \n   const serverUtils = getUtils({"
        },
        {
            "sha": "ad29dafa3a36620a3fdb9c3880040ba90548c873",
            "filename": "packages/next/src/lib/url.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Flib%2Furl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Flib%2Furl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Furl.ts?ref=66bd9dfbc8e7b8753c905cec957444a52a1604d0",
            "patch": "@@ -1,3 +1,4 @@\n+import type { UrlWithParsedQuery } from 'url'\n import { NEXT_RSC_UNION_QUERY } from '../client/components/app-router-headers'\n \n const DUMMY_ORIGIN = 'http://n'\n@@ -7,13 +8,44 @@ export function isFullStringUrl(url: string) {\n }\n \n export function parseUrl(url: string): URL | undefined {\n-  let parsed = undefined\n+  let parsed: URL | undefined = undefined\n   try {\n     parsed = new URL(url, DUMMY_ORIGIN)\n   } catch {}\n   return parsed\n }\n \n+export function parseReqUrl(url: string): UrlWithParsedQuery | undefined {\n+  const parsedUrl: URL | undefined = parseUrl(url)\n+\n+  if (!parsedUrl) {\n+    return\n+  }\n+\n+  const query: Record<string, string | string[]> = {}\n+\n+  for (const key of parsedUrl.searchParams.keys()) {\n+    const values = parsedUrl.searchParams.getAll(key)\n+    query[key] = values.length > 1 ? values : values[0]\n+  }\n+\n+  const legacyUrl: UrlWithParsedQuery = {\n+    query,\n+    hash: parsedUrl.hash,\n+    search: parsedUrl.search,\n+    path: parsedUrl.pathname,\n+    pathname: parsedUrl.pathname,\n+    href: `${parsedUrl.pathname}${parsedUrl.search}${parsedUrl.hash}`,\n+    host: '',\n+    hostname: '',\n+    auth: '',\n+    protocol: '',\n+    slashes: null,\n+    port: '',\n+  }\n+  return legacyUrl\n+}\n+\n export function stripNextRscUnionQuery(relativeUrl: string): string {\n   const urlInstance = new URL(relativeUrl, DUMMY_ORIGIN)\n   urlInstance.searchParams.delete(NEXT_RSC_UNION_QUERY)"
        },
        {
            "sha": "a8e18a24ba8f641f6fae7cca1761767fb4a6f601",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66bd9dfbc8e7b8753c905cec957444a52a1604d0/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=66bd9dfbc8e7b8753c905cec957444a52a1604d0",
            "patch": "@@ -5,7 +5,6 @@ import type { BaseNextRequest } from './base-http'\n import type { ParsedUrlQuery } from 'querystring'\n import type { UrlWithParsedQuery } from 'url'\n \n-import { format as formatUrl, parse as parseUrl } from 'url'\n import { normalizeLocalePath } from '../shared/lib/i18n/normalize-locale-path'\n import { getPathMatch } from '../shared/lib/router/utils/path-match'\n import { getNamedRouteRegex } from '../shared/lib/router/utils/route-regex'\n@@ -26,6 +25,8 @@ import { normalizeNextQueryParam } from './web/utils'\n import type { IncomingHttpHeaders, IncomingMessage } from 'http'\n import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n+import { parseReqUrl } from '../lib/url'\n+import { formatUrl } from '../shared/lib/router/utils/format-url'\n \n export function normalizeCdnUrl(\n   req: BaseNextRequest | IncomingMessage,\n@@ -34,7 +35,13 @@ export function normalizeCdnUrl(\n ) {\n   // make sure to normalize req.url from CDNs to strip dynamic and rewrite\n   // params from the query which are added during routing\n-  const _parsedUrl = parseUrl(req.url!, true)\n+  const _parsedUrl = parseReqUrl(req.url!)\n+\n+  // we can't normalize if we can't parse\n+  if (!_parsedUrl) {\n+    return req.url\n+  }\n+\n   delete (_parsedUrl as any).search\n \n   for (const key of Object.keys(_parsedUrl.query)) {"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 52,
        "deletions": 5
    }
}