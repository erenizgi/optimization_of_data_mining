{
    "author": "timneutkens",
    "message": "Turbopack: Upgrade image crate (#85084)\n\n## What?\n\nUpgrade the image crate which includes some bugfixes for bmp files.",
    "sha": "a293884745ea0bd930056299e8f10cd05c24d8cd",
    "files": [
        {
            "sha": "0f88c145556e87586432c414b3e5124a9c6a0467",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 59,
            "deletions": 36,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/a293884745ea0bd930056299e8f10cd05c24d8cd/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/a293884745ea0bd930056299e8f10cd05c24d8cd/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=a293884745ea0bd930056299e8f10cd05c24d8cd",
            "patch": "@@ -300,9 +300,9 @@ checksum = \"23b62fc65de8e4e7f52534fb52b0f3ed04746ae267519eef2a83941e8085068b\"\n \n [[package]]\n name = \"arrayvec\"\n-version = \"0.7.4\"\n+version = \"0.7.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"96d30a06541fbafbc7f82ed10c06164cfbd2c401138f6addd8404629c4b16711\"\n+checksum = \"7c02d123df017efcdfbd739ef81735b36c5ba83ec3c59c80a9d7ecc718f92e50\"\n \n [[package]]\n name = \"ascii\"\n@@ -441,7 +441,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"6f6ca6f0c18c02c2fbfc119df551b8aeb8a385f6d5980f1475ba0255f1e97f1e\"\n dependencies = [\n  \"anyhow\",\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"itertools 0.10.5\",\n  \"log\",\n  \"nom 7.1.3\",\n@@ -451,11 +451,11 @@ dependencies = [\n \n [[package]]\n name = \"avif-serialize\"\n-version = \"0.8.1\"\n+version = \"0.8.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"876c75a42f6364451a033496a14c44bffe41f5f4a8236f697391f11024e596d2\"\n+checksum = \"47c8fbc0f831f4519fe8b810b6a7a91410ec83031b8233f730a0480029f6a23f\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n ]\n \n [[package]]\n@@ -685,7 +685,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"3888aaa89e4b2a40fca9848e400f6a658a5a3978de7be858e209cafa8be9a4a0\"\n dependencies = [\n  \"arrayref\",\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"cc\",\n  \"cfg-if\",\n  \"constant_time_eq\",\n@@ -836,6 +836,12 @@ version = \"1.5.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"1fd0f2584146f6f2ef48085050886acf353beff7305ebd1ae69500e27c67f64b\"\n \n+[[package]]\n+name = \"byteorder-lite\"\n+version = \"0.1.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"8f1fe948ff07f4bd06c30984e69f5b4899c516a3ef74f34df92a2df2ab535495\"\n+\n [[package]]\n name = \"bytes\"\n version = \"1.10.1\"\n@@ -2225,9 +2231,9 @@ checksum = \"486f806e73c5707928240ddc295403b1b93c96a02038563881c4a2fd84b81ac4\"\n \n [[package]]\n name = \"fdeflate\"\n-version = \"0.3.0\"\n+version = \"0.3.7\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"d329bdeac514ee06249dabc27877490f17f5d371ec693360768b838e19f3ae10\"\n+checksum = \"1e6853b52649d4ac5c0bd02320cddc5ba956bdb407c4b75a2c6b75bf51500f8c\"\n dependencies = [\n  \"simd-adler32\",\n ]\n@@ -3156,15 +3162,16 @@ dependencies = [\n \n [[package]]\n name = \"image\"\n-version = \"0.25.0\"\n+version = \"0.25.8\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a9b4f005360d32e9325029b38ba47ebd7a56f3316df09249368939562d518645\"\n+checksum = \"529feb3e6769d234375c4cf1ee2ce713682b8e76538cb13f9fc23e1400a591e7\"\n dependencies = [\n  \"bytemuck\",\n- \"byteorder\",\n+ \"byteorder-lite\",\n  \"color_quant\",\n  \"gif\",\n  \"image-webp\",\n+ \"moxcms\",\n  \"num-traits\",\n  \"png\",\n  \"ravif\",\n@@ -3175,19 +3182,19 @@ dependencies = [\n \n [[package]]\n name = \"image-webp\"\n-version = \"0.1.0\"\n+version = \"0.2.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"ba6107a25f04af48ceeb4093eebc9b405ee5a1813a0bab5ecf1805d3eabb3337\"\n+checksum = \"525e9ff3e1a4be2fbea1fdf0e98686a6d98b4d8f937e1bf7402245af1909e8c3\"\n dependencies = [\n- \"byteorder\",\n- \"thiserror 1.0.69\",\n+ \"byteorder-lite\",\n+ \"quick-error\",\n ]\n \n [[package]]\n name = \"imgref\"\n-version = \"1.10.1\"\n+version = \"1.12.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"44feda355f4159a7c757171a77de25daf6411e217b4cabd03bd6650690468126\"\n+checksum = \"e7c5cedc30da3a610cac6b4ba17597bdf7152cf974e8aab3afb3d54455e371c8\"\n \n [[package]]\n name = \"include_dir\"\n@@ -4018,7 +4025,6 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e7810e0be55b428ada41041c41f32c9f1a42817901b4ccf45fa3d4b6561e74c7\"\n dependencies = [\n  \"adler\",\n- \"simd-adler32\",\n ]\n \n [[package]]\n@@ -4028,6 +4034,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"4ffbe83022cedc1d264172192511ae958937694cd57ce297164951b8b3568394\"\n dependencies = [\n  \"adler2\",\n+ \"simd-adler32\",\n ]\n \n [[package]]\n@@ -4111,6 +4118,16 @@ version = \"0.2.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"7843ec2de400bcbc6a6328c958dc38e5359da6e93e72e37bc5246bf1ae776389\"\n \n+[[package]]\n+name = \"moxcms\"\n+version = \"0.7.7\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"c588e11a3082784af229e23e8e4ecf5bcc6fbe4f69101e0421ce8d79da7f0b40\"\n+dependencies = [\n+ \"num-traits\",\n+ \"pxfm\",\n+]\n+\n [[package]]\n name = \"munge\"\n version = \"0.4.5\"\n@@ -4576,7 +4593,7 @@ version = \"0.4.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"a652d9771a63711fd3c3deb670acfbe5c30a4072e664d7a3bf5a9e1056ac72c3\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"itoa\",\n ]\n \n@@ -5137,15 +5154,15 @@ dependencies = [\n \n [[package]]\n name = \"png\"\n-version = \"0.17.8\"\n+version = \"0.18.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"aaeebc51f9e7d2c150d3f3bfeb667f2aa985db5ef1e3d212847bdedb488beeaa\"\n+checksum = \"97baced388464909d42d89643fe4361939af9b7ce7a31ee32a168f832a70f2a0\"\n dependencies = [\n- \"bitflags 1.3.2\",\n+ \"bitflags 2.9.1\",\n  \"crc32fast\",\n  \"fdeflate\",\n  \"flate2\",\n- \"miniz_oxide 0.7.1\",\n+ \"miniz_oxide 0.8.2\",\n ]\n \n [[package]]\n@@ -5433,6 +5450,15 @@ dependencies = [\n  \"unicase\",\n ]\n \n+[[package]]\n+name = \"pxfm\"\n+version = \"0.1.25\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"a3cbdf373972bf78df4d3b518d07003938e2c7d1fb5891e55f9cb6df57009d84\"\n+dependencies = [\n+ \"num-traits\",\n+]\n+\n [[package]]\n name = \"qfilter\"\n version = \"0.2.4\"\n@@ -5630,7 +5656,7 @@ checksum = \"cd87ce80a7665b1cce111f8a16c1f3929f6547ce91ade6addf4ec86a8dda5ce9\"\n dependencies = [\n  \"arbitrary\",\n  \"arg_enum_proc_macro\",\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"av1-grain\",\n  \"bitstream-io\",\n  \"built\",\n@@ -5659,9 +5685,9 @@ dependencies = [\n \n [[package]]\n name = \"ravif\"\n-version = \"0.11.10\"\n+version = \"0.11.20\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a8f0bfd976333248de2078d350bfdf182ff96e168a24d23d2436cef320dd4bdd\"\n+checksum = \"5825c26fddd16ab9f515930d49028a630efec172e903483c94796cfe31893e6b\"\n dependencies = [\n  \"avif-serialize\",\n  \"imgref\",\n@@ -5891,9 +5917,6 @@ name = \"rgb\"\n version = \"0.8.50\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"57397d16646700483b67d2dd6511d79318f9d057fdbd21a4066aeac8b41d310a\"\n-dependencies = [\n- \"bytemuck\",\n-]\n \n [[package]]\n name = \"ring\"\n@@ -6799,7 +6822,7 @@ version = \"0.2.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"f352d5d14be5a1f956d76ae0c8060c3487aaa2a080f10a4b4ff023c7c05a9047\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"static-map-macro\",\n ]\n \n@@ -7414,7 +7437,7 @@ version = \"31.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"c9d0917a1eca37bc184540d64685ce066201b96c9eb2c50f38c69ce296c2c686\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"indexmap 2.9.0\",\n  \"is-macro\",\n  \"rustc-hash 2.1.1\",\n@@ -7602,7 +7625,7 @@ version = \"24.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"dfc7dca92e2239f09d177999b0fae2efe6e68a51eae1d9bae85b2efa78537924\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"bitflags 2.9.1\",\n  \"either\",\n  \"num-bigint\",\n@@ -7668,7 +7691,7 @@ version = \"34.0.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"977ee617c78a4ace62abc8733222f6c3c51c6a9000c074a567b361377f6b756c\"\n dependencies = [\n- \"arrayvec 0.7.4\",\n+ \"arrayvec 0.7.6\",\n  \"bitflags 2.9.1\",\n  \"indexmap 2.9.0\",\n  \"num-bigint\",\n@@ -11758,9 +11781,9 @@ checksum = \"3f423a2c17029964870cfaabb1f13dfab7d092a62a29a89264f4d36990ca414a\"\n \n [[package]]\n name = \"zune-jpeg\"\n-version = \"0.4.11\"\n+version = \"0.4.21\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"ec866b44a2a1fd6133d363f073ca1b179f438f99e7e5bfb1e33f7181facfe448\"\n+checksum = \"29ce2c8a9384ad323cf564b67da86e21d3cfdff87908bc1223ed5c99bc792713\"\n dependencies = [\n  \"zune-core\",\n ]"
        },
        {
            "sha": "af7a802cb1eb3ad2d4a4e4f385cb551e37edd267",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a293884745ea0bd930056299e8f10cd05c24d8cd/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/a293884745ea0bd930056299e8f10cd05c24d8cd/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=a293884745ea0bd930056299e8f10cd05c24d8cd",
            "patch": "@@ -397,7 +397,7 @@ futures = \"0.3.31\"\n futures-util = \"0.3.31\"\n futures-retry = \"0.6.0\"\n hashbrown = \"0.14.5\"\n-image = { version = \"0.25.0\", default-features = false }\n+image = { version = \"0.25.8\", default-features = false }\n indexmap = \"2.7.1\"\n indoc = \"2.0.0\"\n itertools = \"0.10.5\""
        },
        {
            "sha": "52a3615174f73318883c7fbc735a09094a75c1e0",
            "filename": "test/integration/next-image-legacy/default/test/static.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a293884745ea0bd930056299e8f10cd05c24d8cd/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Fstatic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a293884745ea0bd930056299e8f10cd05c24d8cd/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Fstatic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-legacy%2Fdefault%2Ftest%2Fstatic.test.ts?ref=a293884745ea0bd930056299e8f10cd05c24d8cd",
            "patch": "@@ -67,13 +67,18 @@ const runTests = () => {\n   })\n   it('Should add a blur placeholder to statically imported jpg', async () => {\n     const $ = cheerio.load(html)\n+    // The base64 snapshot is not necessarily stable across OSs and Architectures\n     if (process.env.IS_TURBOPACK_TEST) {\n-      expect($('#basic-static').attr('style')).toMatchInlineSnapshot(\n-        `\"position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(\"data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCAAGAAgDAREAAhEBAxEB/9sAQwAKBwcIBwYKCAgICwoKCw4YEA4NDQ4dFRYRGCMfJSQiHyIhJis3LyYpNCkhIjBBMTQ5Oz4+PiUuRElDPEg3PT47/9sAQwEKCwsODQ4cEBAcOygiKDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDyj7Rp39h/Zvscn9oefv8AtPmfLsxjZtx+Oc0Af//Z\")\"`\n+      expect(\n+        replaceDataUrl($('#basic-static').attr('style'))\n+      ).toMatchInlineSnapshot(\n+        `\"position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(\"data:<REPLACED>\")\"`\n       )\n     } else {\n-      expect($('#basic-static').attr('style')).toMatchInlineSnapshot(\n-        `\"position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(\"data:image/jpeg;base64,/9j/2wBDAAoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/2wBDAQoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/wgARCAAGAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAACUg//EABwQAAICAgMAAAAAAAAAAAAAABITERQAAwUVIv/aAAgBAQABPwB3H9YmrsuvN5+VxADn/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAgBAgEBPwB//8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAgBAwEBPwB//9k=\")\"`\n+      expect(\n+        replaceDataUrl($('#basic-static').attr('style'))\n+      ).toMatchInlineSnapshot(\n+        `\"position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;background-size:cover;background-position:0% 0%;filter:blur(20px);background-image:url(\"data:<REPLACED>\")\"`\n       )\n     }\n   })\n@@ -160,3 +165,7 @@ describe('Static Image Component Tests', () => {\n     }\n   )\n })\n+\n+function replaceDataUrl(styles) {\n+  return styles.replace(/url\\(\"data:[^\"]+\"\\)/g, 'url(\"data:<REPLACED>\")')\n+}"
        },
        {
            "sha": "1a4386aee8b3870d5986a9286e7c4a4932cb6abf",
            "filename": "turbopack/crates/turbopack-image/src/process/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a293884745ea0bd930056299e8f10cd05c24d8cd/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a293884745ea0bd930056299e8f10cd05c24d8cd/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs?ref=a293884745ea0bd930056299e8f10cd05c24d8cd",
            "patch": "@@ -143,7 +143,7 @@ fn load_image_internal(\n     bytes: &[u8],\n     extension: &str,\n ) -> Result<(ImageBuffer, Option<ImageFormat>)> {\n-    let reader = image::io::Reader::new(Cursor::new(&bytes));\n+    let reader = image::ImageReader::new(Cursor::new(&bytes));\n     let mut reader = reader\n         .with_guessed_format()\n         .context(\"unable to determine image format from file content\")?;"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 74,
        "deletions": 42
    }
}