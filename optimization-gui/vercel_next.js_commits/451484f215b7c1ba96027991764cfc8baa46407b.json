{
    "author": "huozhi",
    "message": "[mcp] get server action tool (#84382)",
    "sha": "451484f215b7c1ba96027991764cfc8baa46407b",
    "files": [
        {
            "sha": "5f91fe6f4bf3f4c1d21c2d266fa982c4855f7fd7",
            "filename": "packages/next/src/server/mcp/get-or-create-mcp-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -3,6 +3,7 @@ import { registerGetProjectPathTool } from './tools/get-project-path'\n import { registerGetErrorsTool } from './tools/get-errors'\n import { registerGetPageMetadataTool } from './tools/get-page-metadata'\n import { registerGetLogsTool } from './tools/get-logs'\n+import { registerGetActionByIdTool } from './tools/get-server-action-by-id'\n import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n let mcpServer: McpServer | undefined\n@@ -30,6 +31,7 @@ export const getOrCreateMcpServer = (\n     getActiveConnectionCount\n   )\n   registerGetLogsTool(mcpServer, distDir)\n+  registerGetActionByIdTool(mcpServer, distDir)\n \n   return mcpServer\n }"
        },
        {
            "sha": "2a8229daf41f74115e9b21823271cf9b1a22a88f",
            "filename": "packages/next/src/server/mcp/tools/get-server-action-by-id.ts",
            "status": "added",
            "additions": 144,
            "deletions": 0,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,144 @@\n+import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import { z } from 'next/dist/compiled/zod'\n+import { promises as fs } from 'fs'\n+import { join } from 'path'\n+\n+const INLINE_ACTION_PREFIX = '$$RSC_SERVER_ACTION_'\n+\n+interface ActionEntry {\n+  workers?: Record<string, any>\n+  layer?: Record<string, string>\n+  filename: string\n+  exportedName: string\n+}\n+\n+interface ServerReferenceManifest {\n+  node: Record<string, ActionEntry>\n+  edge: Record<string, ActionEntry>\n+  encryptionKey: string\n+}\n+\n+export function registerGetActionByIdTool(server: McpServer, distDir: string) {\n+  server.registerTool(\n+    'get_server_action_by_id',\n+    {\n+      description:\n+        'Locates a Server Action by its ID in the server-reference-manifest.json. Returns the filename and export name for the action.',\n+      inputSchema: {\n+        actionId: z.string(),\n+      },\n+    },\n+    async (request) => {\n+      try {\n+        const { actionId } = request\n+\n+        if (!actionId) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: 'Error: actionId parameter is required',\n+              },\n+            ],\n+          }\n+        }\n+\n+        const manifestPath = join(\n+          distDir,\n+          'server',\n+          'server-reference-manifest.json'\n+        )\n+\n+        let manifestContent: string\n+        try {\n+          manifestContent = await fs.readFile(manifestPath, 'utf-8')\n+        } catch (error) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: `Error: Could not read server-reference-manifest.json at ${manifestPath}.`,\n+              },\n+            ],\n+          }\n+        }\n+\n+        const manifest: ServerReferenceManifest = JSON.parse(manifestContent)\n+\n+        // Search in node entries\n+        if (manifest.node && manifest.node[actionId]) {\n+          const entry = manifest.node[actionId]\n+          const isInlineAction =\n+            entry.exportedName.startsWith(INLINE_ACTION_PREFIX)\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: JSON.stringify(\n+                  {\n+                    actionId,\n+                    runtime: 'node',\n+                    filename: entry.filename,\n+                    functionName: isInlineAction\n+                      ? 'inline server action'\n+                      : entry.exportedName,\n+                    layer: entry.layer,\n+                    workers: entry.workers,\n+                  },\n+                  null,\n+                  2\n+                ),\n+              },\n+            ],\n+          }\n+        }\n+\n+        // Search in edge entries\n+        if (manifest.edge && manifest.edge[actionId]) {\n+          const entry = manifest.edge[actionId]\n+          const isInlineAction =\n+            entry.exportedName.startsWith(INLINE_ACTION_PREFIX)\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: JSON.stringify(\n+                  {\n+                    actionId,\n+                    runtime: 'edge',\n+                    filename: entry.filename,\n+                    functionName: isInlineAction\n+                      ? 'inline server action'\n+                      : entry.exportedName,\n+                    layer: entry.layer,\n+                    workers: entry.workers,\n+                  },\n+                  null,\n+                  2\n+                ),\n+              },\n+            ],\n+          }\n+        }\n+\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: `Error: Action ID \"${actionId}\" not found in server-reference-manifest.json`,\n+            },\n+          ],\n+        }\n+      } catch (error) {\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: `Error: ${error instanceof Error ? error.message : String(error)}`,\n+            },\n+          ],\n+        }\n+      }\n+    }\n+  )\n+}"
        },
        {
            "sha": "463dbe98cf783487f67fbb240b2b910fd06251da",
            "filename": "test/development/mcp-server/fixtures/actions-app/app/actions.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Factions.ts?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,9 @@\n+'use server'\n+\n+export async function myAction() {\n+  return { success: true }\n+}\n+\n+export async function anotherAction() {\n+  return { result: 'done' }\n+}"
        },
        {
            "sha": "ae11498dcbf4bd474514bf3bacd401527b519187",
            "filename": "test/development/mcp-server/fixtures/actions-app/app/inline/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Finline%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Finline%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Finline%2Fpage.tsx?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,14 @@\n+export default function InlinePage() {\n+  async function inlineAction() {\n+    'use server'\n+    return { inline: true, message: 'This is an inline action' }\n+  }\n+\n+  return (\n+    <div>\n+      <form action={inlineAction}>\n+        <button type=\"submit\">Inline Action</button>\n+      </form>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/development/mcp-server/fixtures/actions-app/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Flayout.tsx?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "abc7a7b10f8eacc707a3f112370a6f6d3d633eaa",
            "filename": "test/development/mcp-server/fixtures/actions-app/app/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fapp%2Fpage.tsx?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+import { myAction } from './actions'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <button onClick={() => myAction()}>Click me</button>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "af294f9d05ca22846065e1fe7afc67cfe9020e0e",
            "filename": "test/development/mcp-server/fixtures/actions-app/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Factions-app%2Fnext.config.js?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    mcpServer: true,\n+  },\n+}"
        },
        {
            "sha": "018475e1dc29b8547a42bd124809adc789ccfbee",
            "filename": "test/development/mcp-server/mcp-server-get-server-action-by-id.test.ts",
            "status": "added",
            "additions": 174,
            "deletions": 0,
            "changes": 174,
            "blob_url": "https://github.com/vercel/next.js/blob/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/451484f215b7c1ba96027991764cfc8baa46407b/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts?ref=451484f215b7c1ba96027991764cfc8baa46407b",
            "patch": "@@ -0,0 +1,174 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+import fs from 'fs/promises'\n+\n+describe('mcp-server get_server_action_by_id tool', () => {\n+  const { next } = nextTestSetup({\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'actions-app')),\n+  })\n+\n+  it('should return action details via get_server_action_by_id tool', async () => {\n+    const mcpEndpoint = `${next.url}/_next/mcp`\n+\n+    // Visit the page to trigger action registration\n+    await next.render('/')\n+\n+    // Read the manifest to get a valid action ID\n+    const manifestPath = path.join(\n+      next.testDir,\n+      '.next',\n+      'server',\n+      'server-reference-manifest.json'\n+    )\n+    const manifestContent = await fs.readFile(manifestPath, 'utf-8')\n+    const manifest = JSON.parse(manifestContent)\n+\n+    // Get the first action ID from the manifest\n+    const actionId = Object.keys(manifest.node || {})[0]\n+    expect(actionId).toBeTruthy()\n+\n+    // Call get_server_action_by_id tool\n+    const callToolResponse = await fetch(mcpEndpoint, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id: 'call-tool-1',\n+        method: 'tools/call',\n+        params: {\n+          name: 'get_server_action_by_id',\n+          arguments: {\n+            actionId,\n+          },\n+        },\n+      }),\n+    })\n+\n+    const callToolText = await callToolResponse.text()\n+    const callToolDataMatch = callToolText.match(/data: ({.*})/s)\n+    expect(callToolDataMatch).toBeTruthy()\n+\n+    const callToolResult = JSON.parse(callToolDataMatch![1])\n+    expect(callToolResult.jsonrpc).toBe('2.0')\n+    expect(callToolResult.id).toBe('call-tool-1')\n+\n+    const content = callToolResult.result?.content\n+    expect(content).toBeInstanceOf(Array)\n+    expect(content?.[0]?.type).toBe('text')\n+\n+    const actionDetails = JSON.parse(content?.[0]?.text)\n+\n+    // Verify the action details\n+    expect(actionDetails.actionId).toBe(actionId)\n+    expect(actionDetails.runtime).toBe('node')\n+    expect(actionDetails.filename).toContain('app/actions.ts')\n+    expect(actionDetails.functionName).toBeTruthy()\n+  })\n+\n+  it('should return error for non-existent action ID', async () => {\n+    const mcpEndpoint = `${next.url}/_next/mcp`\n+\n+    // Call get_server_action_by_id tool with non-existent ID\n+    const callToolResponse = await fetch(mcpEndpoint, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id: 'call-tool-2',\n+        method: 'tools/call',\n+        params: {\n+          name: 'get_server_action_by_id',\n+          arguments: {\n+            actionId: 'non-existent-id-12345',\n+          },\n+        },\n+      }),\n+    })\n+\n+    const callToolText = await callToolResponse.text()\n+    const callToolDataMatch = callToolText.match(/data: ({.*})/s)\n+    expect(callToolDataMatch).toBeTruthy()\n+\n+    const callToolResult = JSON.parse(callToolDataMatch![1])\n+    expect(callToolResult.jsonrpc).toBe('2.0')\n+    expect(callToolResult.id).toBe('call-tool-2')\n+\n+    const content = callToolResult.result?.content\n+    expect(content).toBeInstanceOf(Array)\n+    expect(content?.[0]?.type).toBe('text')\n+    expect(content?.[0]?.text).toContain('not found')\n+  })\n+\n+  it('should return inline server action details', async () => {\n+    const mcpEndpoint = `${next.url}/_next/mcp`\n+\n+    // Visit the page to trigger action registration\n+    await next.render('/inline')\n+\n+    // Read the manifest to get inline action ID\n+    const manifestPath = path.join(\n+      next.testDir,\n+      '.next',\n+      'server',\n+      'server-reference-manifest.json'\n+    )\n+    const manifestContent = await fs.readFile(manifestPath, 'utf-8')\n+    const manifest = JSON.parse(manifestContent)\n+\n+    // Find the inline action ID (inline actions defined in server components)\n+    const inlineActionId = Object.keys(manifest.node || {}).find((id) => {\n+      const action = manifest.node[id]\n+      return (\n+        action.filename === 'app/inline/page.tsx' &&\n+        action.exportedName?.startsWith('$$RSC_SERVER_ACTION_')\n+      )\n+    })\n+    expect(inlineActionId).toBeTruthy()\n+\n+    // Call get_server_action_by_id tool for inline action\n+    const callToolResponse = await fetch(mcpEndpoint, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id: 'call-tool-3',\n+        method: 'tools/call',\n+        params: {\n+          name: 'get_server_action_by_id',\n+          arguments: {\n+            actionId: inlineActionId,\n+          },\n+        },\n+      }),\n+    })\n+\n+    const callToolText = await callToolResponse.text()\n+    const callToolDataMatch = callToolText.match(/data: ({.*})/s)\n+    expect(callToolDataMatch).toBeTruthy()\n+\n+    const callToolResult = JSON.parse(callToolDataMatch![1])\n+    expect(callToolResult.jsonrpc).toBe('2.0')\n+    expect(callToolResult.id).toBe('call-tool-3')\n+\n+    const content = callToolResult.result?.content\n+    expect(content).toBeInstanceOf(Array)\n+    expect(content?.[0]?.type).toBe('text')\n+\n+    const actionDetails = JSON.parse(content?.[0]?.text)\n+\n+    // Verify the inline action details\n+    expect(actionDetails.actionId).toBe(inlineActionId)\n+    expect(actionDetails.runtime).toBe('node')\n+    expect(actionDetails.filename).toBeTruthy()\n+    expect(actionDetails.functionName).toBe('inline server action')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 370,
        "additions": 370,
        "deletions": 0
    }
}