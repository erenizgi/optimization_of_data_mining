{
    "author": "eps1lon",
    "message": "Fix unisolated tests (#76018)",
    "sha": "1e86031134fd7357f36ee8db82c5820c895c7c3b",
    "files": [
        {
            "sha": "8d4ff54b82726dee6065951b7b83357d4e343628",
            "filename": "test/lib/create-next-install.js",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1e86031134fd7357f36ee8db82c5820c895c7c3b/test%2Flib%2Fcreate-next-install.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1e86031134fd7357f36ee8db82c5820c895c7c3b/test%2Flib%2Fcreate-next-install.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fcreate-next-install.js?ref=1e86031134fd7357f36ee8db82c5820c895c7c3b",
            "patch": "@@ -154,9 +154,11 @@ async function createNextInstall({\n       )\n \n       if (beforeInstall !== undefined) {\n-        rootSpan.traceChild('beforeInstall').traceAsyncFn(async (span) => {\n-          await beforeInstall(span, installDir)\n-        })\n+        await rootSpan\n+          .traceChild('beforeInstall')\n+          .traceAsyncFn(async (span) => {\n+            await beforeInstall(span, installDir)\n+          })\n       }\n \n       if (installCommand) {"
        },
        {
            "sha": "2615b490d0165241e200957cd48e7444ee6c542d",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 12,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/1e86031134fd7357f36ee8db82c5820c895c7c3b/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1e86031134fd7357f36ee8db82c5820c895c7c3b/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=1e86031134fd7357f36ee8db82c5820c895c7c3b",
            "patch": "@@ -156,6 +156,16 @@ export class NextInstance {\n     }\n   }\n \n+  protected async beforeInstall(parentSpan: Span) {\n+    await parentSpan.traceChild('writeInitialFiles').traceAsyncFn(async () => {\n+      await this.writeInitialFiles()\n+    })\n+\n+    await parentSpan.traceChild('writeOverrideFiles').traceAsyncFn(async () => {\n+      await this.writeOverrideFiles()\n+    })\n+  }\n+\n   protected async createTestDir({\n     skipInstall = false,\n     parentSpan,\n@@ -228,6 +238,8 @@ export class NextInstance {\n               2\n             )\n           )\n+\n+          await this.beforeInstall(parentSpan)\n         } else {\n           if (\n             process.env.NEXT_TEST_STARTER &&\n@@ -239,6 +251,11 @@ export class NextInstance {\n             await fs.cp(process.env.NEXT_TEST_STARTER, this.testDir, {\n               recursive: true,\n             })\n+\n+            require('console').log(\n+              'created next.js install, writing test files'\n+            )\n+            await this.beforeInstall(parentSpan)\n           } else {\n             const { tmpRepoDir } = await createNextInstall({\n               parentSpan: rootSpan,\n@@ -250,22 +267,14 @@ export class NextInstance {\n               keepRepoDir: true,\n               beforeInstall: async (span, installDir) => {\n                 this.testDir = installDir\n-                await span\n-                  .traceChild('writeInitialFiles')\n-                  .traceAsyncFn(async () => {\n-                    await this.writeInitialFiles()\n-                  })\n-\n-                await span\n-                  .traceChild('writeOverrideFiles')\n-                  .traceAsyncFn(async () => {\n-                    await this.writeOverrideFiles()\n-                  })\n+                require('console').log(\n+                  'created next.js install, writing test files'\n+                )\n+                await this.beforeInstall(span)\n               },\n             })\n             this.tmpRepoDir = tmpRepoDir\n           }\n-          require('console').log('created next.js install, writing test files')\n         }\n \n         const testDirFiles = await fs.readdir(this.testDir)"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 26,
        "deletions": 15
    }
}