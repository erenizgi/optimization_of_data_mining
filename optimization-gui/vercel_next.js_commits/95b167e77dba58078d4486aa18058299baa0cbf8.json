{
    "author": "ztanner",
    "message": "[segment cache]: fix interception route handling (#84497)\n\nWith `clientSegmentCache` enabled, if you are already on a route that\nwas intercepted/could have been intercepted, and then you navigated to\nit again, the router would get stuck in a state where it was infinitely\nsuspended on data it would never receive.\n\nWhen no prefetch is available, we assume that the FlightRouterState sent\nby the server contains everything that is needed to describe the\nrendering shape of the page. However this isn't quite true: in\n`walk-tree-with-flight-router-state` (the function that populates\nprefetch responses), we skip sending down the `__DEFAULT__` segment. As\na result, the client would get into a state where it thinks it needs to\nrequest data from the server.\n\nThis updates the code to not special-case `__DEFAULT__` segments. We\nshould separately see how we can restore this optimization to keep those\npayloads as small as possible, but it causes problems with back/forward\nnav that need to be investigated.",
    "sha": "95b167e77dba58078d4486aa18058299baa0cbf8",
    "files": [
        {
            "sha": "8472377e40dd652b6002f6bebecc43c568cf9972",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/95b167e77dba58078d4486aa18058299baa0cbf8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/95b167e77dba58078d4486aa18058299baa0cbf8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=95b167e77dba58078d4486aa18058299baa0cbf8",
            "patch": "@@ -16,10 +16,7 @@ import {\n } from './create-flight-router-state-from-loader-tree'\n import type { AppRenderContext } from './app-render'\n import { hasLoadingComponentInTree } from './has-loading-component-in-tree'\n-import {\n-  DEFAULT_SEGMENT_KEY,\n-  addSearchParamsIfPageSegment,\n-} from '../../shared/lib/segment'\n+import { addSearchParamsIfPageSegment } from '../../shared/lib/segment'\n import { createComponentTree } from './create-component-tree'\n import { getSegmentParam } from './get-segment-param'\n \n@@ -218,6 +215,7 @@ export async function walkTreeWithFlightRouterState({\n       getDynamicParamFromSegment,\n       query\n     )\n+\n     // Create component tree using the slice of the loaderTree\n     const seedData = await createComponentTree(\n       // This ensures flightRouterPath is valid and filters down the tree\n@@ -298,17 +296,6 @@ export async function walkTreeWithFlightRouterState({\n     })\n \n     for (const subPath of subPaths) {\n-      // we don't need to send over default routes in the flight data\n-      // because they are always ignored by the client, unless it's a refetch\n-      if (\n-        subPath[0] === DEFAULT_SEGMENT_KEY &&\n-        flightRouterState &&\n-        !!flightRouterState[1][parallelRouteKey][0] &&\n-        flightRouterState[1][parallelRouteKey][3] !== 'refetch'\n-      ) {\n-        continue\n-      }\n-\n       paths.push([actualSegment, parallelRouteKey, ...subPath])\n     }\n   }"
        },
        {
            "sha": "421b8431475b6c6fbaea60975508f9ccbcdf38e6",
            "filename": "test/client-segment-cache-tests-manifest.json",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/95b167e77dba58078d4486aa18058299baa0cbf8/test%2Fclient-segment-cache-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/95b167e77dba58078d4486aa18058299baa0cbf8/test%2Fclient-segment-cache-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fclient-segment-cache-tests-manifest.json?ref=95b167e77dba58078d4486aa18058299baa0cbf8",
            "patch": "@@ -43,11 +43,6 @@\n         \"app dir - navigation middleware redirect should change browser location when router.refresh() gets a redirect response\"\n       ]\n     },\n-    \"test/e2e/app-dir/parallel-routes-and-interception/parallel-routes-and-interception.test.ts\": {\n-      \"failed\": [\n-        \"parallel-routes-and-interception route intercepting should support intercepting local dynamic sibling routes\"\n-      ]\n-    },\n     \"test/e2e/app-dir/parallel-routes-revalidation/parallel-routes-revalidation.test.ts\": {\n       \"failed\": [\n         \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: false should correctly refresh data for previously intercepted modal and active page slot\","
        }
    ],
    "stats": {
        "total": 22,
        "additions": 2,
        "deletions": 20
    }
}