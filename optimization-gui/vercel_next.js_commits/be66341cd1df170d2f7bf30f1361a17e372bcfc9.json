{
    "author": "timneutkens",
    "message": "Build: Add .next/trace-build with high level trace (#83949)\n\n## What?\n\n- Adds a new file `.next/trace-build` with a high level overview of the\nbuild process. This is an extra file next to `.next/trace`.\n`.next/trace` includes a lower level trace when using webpack.\n`.next/trace-build` is the same between webpack/Turbopack in terms of\nspans emitted (though `run-turbopack` vs `run-webpack` span).\n\nIncluded trace spans are:\n\n```\n  'next-build',\n  'run-turbopack',\n  'run-webpack',\n  'run-typescript',\n  'run-eslint',\n  'static-check',\n  'static-generation',\n  'output-export-full-static-export',\n```\n\n`run-turbopack` is only included when Turbopack is used. `run-webpack`\nwhen webpack is used.\n\n`run-typescript` and `run-eslint` are concurrent.\n\n`output-export-full-static-export` is only included when using `output:\n'export'`.",
    "sha": "be66341cd1df170d2f7bf30f1361a17e372bcfc9",
    "files": [
        {
            "sha": "e0bb942ff51a659301730f88a61163a64eec4a03",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -4098,14 +4098,18 @@ export default async function build(\n       }\n \n       if (config.output === 'export') {\n-        await writeFullyStaticExport(\n-          config,\n-          dir,\n-          enabledDirectories,\n-          configOutDir,\n-          nextBuildSpan,\n-          appDirOnly\n-        )\n+        await nextBuildSpan\n+          .traceChild('output-export-full-static-export')\n+          .traceAsyncFn(async () => {\n+            await writeFullyStaticExport(\n+              config,\n+              dir,\n+              enabledDirectories,\n+              configOutDir,\n+              nextBuildSpan,\n+              appDirOnly\n+            )\n+          })\n       }\n \n       if (config.experimental.adapterPath) {"
        },
        {
            "sha": "8171d73d9b979e15dc925311965857a2a7c62913",
            "filename": "packages/next/src/build/turbopack-build/index.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -52,15 +52,13 @@ export function turbopackBuild(\n   withWorker: boolean\n ): ReturnType<typeof import('./impl').turbopackBuild> {\n   const nextBuildSpan = NextBuildContext.nextBuildSpan!\n-  return nextBuildSpan\n-    .traceChild('run-turbopack-compiler')\n-    .traceAsyncFn(async () => {\n-      if (withWorker) {\n-        return await turbopackBuildWithWorker()\n-      } else {\n-        const build = (require('./impl') as typeof import('./impl'))\n-          .turbopackBuild\n-        return await build()\n-      }\n-    })\n+  return nextBuildSpan.traceChild('run-turbopack').traceAsyncFn(async () => {\n+    if (withWorker) {\n+      return await turbopackBuildWithWorker()\n+    } else {\n+      const build = (require('./impl') as typeof import('./impl'))\n+        .turbopackBuild\n+      return await build()\n+    }\n+  })\n }"
        },
        {
            "sha": "53d21ffc6ca215a1a984840639b552ebc2e3bc5b",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -128,7 +128,7 @@ export async function startTypeChecking({\n \n   try {\n     const [[verifyResult, typeCheckEnd]] = await Promise.all([\n-      nextBuildSpan.traceChild('verify-typescript-setup').traceAsyncFn(() =>\n+      nextBuildSpan.traceChild('run-typescript').traceAsyncFn(() =>\n         verifyTypeScriptSetup(\n           dir,\n           config.distDir,\n@@ -146,7 +146,7 @@ export async function startTypeChecking({\n         })\n       ),\n       shouldLint &&\n-        nextBuildSpan.traceChild('verify-and-lint').traceAsyncFn(async () => {\n+        nextBuildSpan.traceChild('run-eslint').traceAsyncFn(async () => {\n           await verifyAndLint(\n             dir,\n             eslintCacheDir,"
        },
        {
            "sha": "fe242ffc8fab69ae1b93c36b5c71694249273357",
            "filename": "packages/next/src/build/webpack-build/index.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 20,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -128,26 +128,29 @@ export async function webpackBuild(\n   | Awaited<ReturnType<typeof webpackBuildWithWorker>>\n   | Awaited<ReturnType<typeof import('./impl').webpackBuildImpl>>\n > {\n-  if (withWorker) {\n-    debug('using separate compiler workers')\n-    return await webpackBuildWithWorker(compilerNames)\n-  } else {\n-    debug('building all compilers in same process')\n-    const webpackBuildImpl = (require('./impl') as typeof import('./impl'))\n-      .webpackBuildImpl\n-    const curResult = await webpackBuildImpl(null)\n-\n-    // Mirror what happens in webpackBuildWithWorker\n-    if (curResult.telemetryState) {\n-      NextBuildContext.telemetryState = {\n-        ...curResult.telemetryState,\n-        useCacheTracker: mergeUseCacheTrackers(\n-          NextBuildContext.telemetryState?.useCacheTracker,\n-          curResult.telemetryState.useCacheTracker\n-        ),\n+  const nextBuildSpan = NextBuildContext.nextBuildSpan!\n+  return nextBuildSpan.traceChild('run-webpack').traceAsyncFn(async () => {\n+    if (withWorker) {\n+      debug('using separate compiler workers')\n+      return await webpackBuildWithWorker(compilerNames)\n+    } else {\n+      debug('building all compilers in same process')\n+      const webpackBuildImpl = (require('./impl') as typeof import('./impl'))\n+        .webpackBuildImpl\n+      const curResult = await webpackBuildImpl(null)\n+\n+      // Mirror what happens in webpackBuildWithWorker\n+      if (curResult.telemetryState) {\n+        NextBuildContext.telemetryState = {\n+          ...curResult.telemetryState,\n+          useCacheTracker: mergeUseCacheTrackers(\n+            NextBuildContext.telemetryState?.useCacheTracker,\n+            curResult.telemetryState.useCacheTracker\n+          ),\n+        }\n       }\n-    }\n \n-    return curResult\n-  }\n+      return curResult\n+    }\n+  })\n }"
        },
        {
            "sha": "b936def6daf05ff75b3f1c4627e9f10b9ce4a0a9",
            "filename": "packages/next/src/trace/report/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Findex.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -1,6 +1,7 @@\n import type { TraceEvent } from '../types'\n import reportToTelemetry from './to-telemetry'\n import reportToJson from './to-json'\n+import reportToJsonBuild from './to-json-build'\n import type { Reporter } from './types'\n \n class MultiReporter implements Reporter {\n@@ -20,4 +21,8 @@ class MultiReporter implements Reporter {\n }\n \n // JSON is always reported to allow for diagnostics\n-export const reporter = new MultiReporter([reportToJson, reportToTelemetry])\n+export const reporter = new MultiReporter([\n+  reportToJson,\n+  reportToJsonBuild,\n+  reportToTelemetry,\n+])"
        },
        {
            "sha": "7f86261e0c7dd87655b4ccf7314be3b5c10a72d9",
            "filename": "packages/next/src/trace/report/to-json-build.ts",
            "status": "added",
            "additions": 142,
            "deletions": 0,
            "changes": 142,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -0,0 +1,142 @@\n+import { traceGlobals, traceId } from '../shared'\n+import fs from 'fs'\n+import path from 'path'\n+import {\n+  PHASE_DEVELOPMENT_SERVER,\n+  PHASE_PRODUCTION_BUILD,\n+} from '../../shared/lib/constants'\n+import type { TraceEvent } from '../types'\n+import { batcher } from './to-json'\n+\n+let writeStream: RotatingWriteStream\n+let batch: ReturnType<typeof batcher> | undefined\n+\n+const writeStreamOptions = {\n+  flags: 'a',\n+  encoding: 'utf8' as const,\n+}\n+class RotatingWriteStream {\n+  file: string\n+  writeStream!: fs.WriteStream\n+  size: number\n+  sizeLimit: number\n+  private rotatePromise: Promise<void> | undefined\n+  private drainPromise: Promise<void> | undefined\n+  constructor(file: string, sizeLimit: number) {\n+    this.file = file\n+    this.size = 0\n+    this.sizeLimit = sizeLimit\n+    this.createWriteStream()\n+  }\n+  private createWriteStream() {\n+    this.writeStream = fs.createWriteStream(this.file, writeStreamOptions)\n+  }\n+  // Recreate the file\n+  private async rotate() {\n+    await this.end()\n+    try {\n+      fs.unlinkSync(this.file)\n+    } catch (err: any) {\n+      // It's fine if the file does not exist yet\n+      if (err.code !== 'ENOENT') {\n+        throw err\n+      }\n+    }\n+    this.size = 0\n+    this.createWriteStream()\n+    this.rotatePromise = undefined\n+  }\n+  async write(data: string): Promise<void> {\n+    if (this.rotatePromise) await this.rotatePromise\n+\n+    this.size += data.length\n+    if (this.size > this.sizeLimit) {\n+      await (this.rotatePromise = this.rotate())\n+    }\n+\n+    if (!this.writeStream.write(data, 'utf8')) {\n+      if (this.drainPromise === undefined) {\n+        this.drainPromise = new Promise<void>((resolve, _reject) => {\n+          this.writeStream.once('drain', () => {\n+            this.drainPromise = undefined\n+            resolve()\n+          })\n+        })\n+      }\n+      await this.drainPromise\n+    }\n+  }\n+\n+  end(): Promise<void> {\n+    return new Promise((resolve) => {\n+      this.writeStream.end(resolve)\n+    })\n+  }\n+}\n+\n+const allowlistedEvents = new Set([\n+  'next-build',\n+  'run-turbopack',\n+  'run-webpack',\n+  'run-typescript',\n+  'run-eslint',\n+  'static-check',\n+  'static-generation',\n+  'output-export-full-static-export',\n+])\n+\n+function reportToJsonBuild(event: TraceEvent) {\n+  if (!allowlistedEvents.has(event.name)) {\n+    return\n+  }\n+\n+  const distDir = traceGlobals.get('distDir')\n+  const phase = traceGlobals.get('phase')\n+  if (!distDir || !phase) {\n+    return\n+  }\n+\n+  // Only report in production builds\n+  if (phase !== PHASE_PRODUCTION_BUILD) {\n+    return\n+  }\n+\n+  if (!batch) {\n+    batch = batcher(async (events: TraceEvent[]) => {\n+      if (!writeStream) {\n+        await fs.promises.mkdir(distDir, { recursive: true })\n+        const file = path.join(distDir, 'trace-build')\n+        writeStream = new RotatingWriteStream(\n+          file,\n+          // Development is limited to 50MB, production is unlimited\n+          phase === PHASE_DEVELOPMENT_SERVER ? 52428800 : Infinity\n+        )\n+      }\n+      const eventsJson = JSON.stringify(events)\n+      try {\n+        await writeStream.write(eventsJson + '\\n')\n+      } catch (err) {\n+        console.log(err)\n+      }\n+    })\n+  }\n+\n+  batch.report({\n+    ...event,\n+    traceId,\n+  })\n+}\n+\n+export default {\n+  flushAll: (opts?: { end: boolean }) =>\n+    batch\n+      ? batch.flushAll().then(() => {\n+          const phase = traceGlobals.get('phase')\n+          // Only end writeStream when manually flushing in production\n+          if (opts?.end || phase !== PHASE_DEVELOPMENT_SERVER) {\n+            return writeStream.end()\n+          }\n+        })\n+      : undefined,\n+  report: reportToJsonBuild,\n+}"
        },
        {
            "sha": "bcbc09f9a80402028d6e905f2927d8b9ba4e1e93",
            "filename": "packages/next/src/trace/report/to-json.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 17,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -4,20 +4,9 @@ import path from 'path'\n import { PHASE_DEVELOPMENT_SERVER } from '../../shared/lib/constants'\n import type { TraceEvent } from '../types'\n \n-// eslint-disable-next-line @typescript-eslint/no-unused-vars\n-const localEndpoint = {\n-  serviceName: 'nextjs',\n-  ipv4: '127.0.0.1',\n-  port: 9411,\n-}\n-\n-type Event = TraceEvent & {\n-  localEndpoint?: typeof localEndpoint\n-}\n-\n // Batch events as zipkin allows for multiple events to be sent in one go\n-export function batcher(reportEvents: (evts: Event[]) => Promise<void>) {\n-  const events: Event[] = []\n+export function batcher(reportEvents: (evts: TraceEvent[]) => Promise<void>) {\n+  const events: TraceEvent[] = []\n   // Promise queue to ensure events are always sent on flushAll\n   const queue = new Set()\n   return {\n@@ -28,7 +17,7 @@ export function batcher(reportEvents: (evts: Event[]) => Promise<void>) {\n         events.length = 0\n       }\n     },\n-    report: (event: Event) => {\n+    report: (event: TraceEvent) => {\n       events.push(event)\n \n       if (events.length > 100) {\n@@ -108,15 +97,15 @@ class RotatingWriteStream {\n   }\n }\n \n-const reportToLocalHost = (event: TraceEvent) => {\n+function reportToJson(event: TraceEvent) {\n   const distDir = traceGlobals.get('distDir')\n   const phase = traceGlobals.get('phase')\n   if (!distDir || !phase) {\n     return\n   }\n \n   if (!batch) {\n-    batch = batcher(async (events: Event[]) => {\n+    batch = batcher(async (events: TraceEvent[]) => {\n       if (!writeStream) {\n         await fs.promises.mkdir(distDir, { recursive: true })\n         const file = path.join(distDir, 'trace')\n@@ -152,5 +141,5 @@ export default {\n           }\n         })\n       : undefined,\n-  report: reportToLocalHost,\n+  report: reportToJson,\n }"
        },
        {
            "sha": "ddf0ec0d089c0dadea5dc1bbdca118477f17049c",
            "filename": "packages/next/src/trace/trace-uploader.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -28,7 +28,7 @@ const DEV_ALLOWED_EVENTS = new Set([\n const BUILD_ALLOWED_EVENTS = new Set([\n   ...COMMON_ALLOWED_EVENTS,\n   'next-build',\n-  'run-turbopack-compiler',\n+  'run-turbopack',\n   'webpack-compilation',\n   'run-webpack-compiler',\n   'create-entrypoints',\n@@ -50,14 +50,14 @@ const BUILD_ALLOWED_EVENTS = new Set([\n   'node-file-trace-build',\n   'static-generation',\n   'next-export',\n-  'verify-typescript-setup',\n-  'verify-and-lint',\n+  'run-typescript',\n+  'run-eslint',\n ])\n \n const {\n   NEXT_TRACE_UPLOAD_DEBUG,\n   // An external env to allow to upload full trace without picking up the relavant spans.\n-  // This is mainly for the debugging purpose, to allwo manual audit for full trace for the given build.\n+  // This is mainly for the debugging purpose, to allow manual audit for full trace for the given build.\n   // [NOTE] This may fail if build is large and generated trace is excessively large.\n   NEXT_TRACE_UPLOAD_FULL,\n } = process.env"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/trace-build-file/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Flayout.tsx?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/trace-build-file/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fapp%2Fpage.tsx?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/trace-build-file/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Fnext.config.js?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "19fbd770f7f675e5a1f1bc6e6306aaf9eba2405c",
            "filename": "test/e2e/app-dir/trace-build-file/trace-build-file.test.ts",
            "status": "added",
            "additions": 221,
            "deletions": 0,
            "changes": 221,
            "blob_url": "https://github.com/vercel/next.js/blob/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be66341cd1df170d2f7bf30f1361a17e372bcfc9/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts?ref=be66341cd1df170d2f7bf30f1361a17e372bcfc9",
            "patch": "@@ -0,0 +1,221 @@\n+import { nextTestSetup, isNextDev, isNextStart } from 'e2e-utils'\n+import { join } from 'path'\n+import { existsSync, readFileSync } from 'fs'\n+\n+type SpanId = number\n+\n+type TraceEvent = {\n+  traceId?: string\n+  parentId?: SpanId\n+  name: string\n+  id: SpanId\n+  timestamp: number\n+  duration: number\n+  tags?: Object\n+  startTime?: number\n+}\n+\n+interface TraceStructure {\n+  events: TraceEvent[]\n+  eventsByName: Map<string, TraceEvent[]>\n+  eventsById: Map<string, TraceEvent>\n+  rootEvents: TraceEvent[]\n+  orphanedEvents: TraceEvent[]\n+}\n+\n+function parseTraceFile(traceBuildPath: string): TraceStructure {\n+  const traceContent = readFileSync(traceBuildPath, 'utf8')\n+  const traceLines = traceContent\n+    .trim()\n+    .split('\\n')\n+    .filter((line) => line.trim())\n+\n+  const allEvents: TraceEvent[] = []\n+\n+  for (const line of traceLines) {\n+    const events = JSON.parse(line) as TraceEvent[]\n+    allEvents.push(...events)\n+  }\n+\n+  const eventsByName = new Map<string, TraceEvent[]>()\n+  const eventsById = new Map<string, TraceEvent>()\n+  const rootEvents: TraceEvent[] = []\n+  const orphanedEvents: TraceEvent[] = []\n+\n+  // Index all events\n+  for (const event of allEvents) {\n+    if (!eventsByName.has(event.name)) {\n+      eventsByName.set(event.name, [])\n+    }\n+    eventsByName.get(event.name).push(event)\n+    eventsById.set(event.id.toString(), event)\n+  }\n+\n+  // Categorize events as root or orphaned\n+  for (const event of allEvents) {\n+    if (!event.parentId) {\n+      rootEvents.push(event)\n+    } else if (!eventsById.has(event.parentId.toString())) {\n+      orphanedEvents.push(event)\n+    }\n+  }\n+\n+  return {\n+    events: allEvents,\n+    eventsByName,\n+    eventsById,\n+    rootEvents,\n+    orphanedEvents,\n+  }\n+}\n+\n+describe('trace-build-file', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipStart: !isNextDev,\n+    skipDeployment: true,\n+  })\n+\n+  if (isNextStart) {\n+    it('should create .next/trace-build file during production build', async () => {\n+      // Build the app to trigger trace generation\n+      await next.build()\n+\n+      // Check that trace-build file exists\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      expect(existsSync(traceBuildPath)).toBe(true)\n+    })\n+\n+    it('should contain high-level build trace events', async () => {\n+      // Ensure we have a fresh build\n+      await next.build()\n+\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      expect(existsSync(traceBuildPath)).toBe(true)\n+\n+      const traceStructure = parseTraceFile(traceBuildPath)\n+\n+      // Should have events\n+      expect(traceStructure.events.length).toBeGreaterThan(0)\n+\n+      // Should contain the main next-build event\n+      const nextBuildEvents = traceStructure.eventsByName.get('next-build')\n+      expect(nextBuildEvents).toBeDefined()\n+      expect(nextBuildEvents.length).toBe(1)\n+\n+      const nextBuildEvent = nextBuildEvents[0]\n+      expect(nextBuildEvent).toHaveProperty('name', 'next-build')\n+      expect(nextBuildEvent).toHaveProperty('traceId')\n+      expect(nextBuildEvent).toHaveProperty('id')\n+      expect(nextBuildEvent).toHaveProperty('duration')\n+      expect(typeof nextBuildEvent.duration).toBe('number')\n+      expect(typeof nextBuildEvent.traceId).toBe('string')\n+      expect(typeof nextBuildEvent.id).toBe('number')\n+    })\n+\n+    it('should only contain allowlisted events', async () => {\n+      await next.build()\n+\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      const traceStructure = parseTraceFile(traceBuildPath)\n+\n+      const allowlistedEvents = new Set([\n+        'next-build',\n+        'run-turbopack',\n+        'run-webpack',\n+        'run-typescript',\n+        'run-eslint',\n+        'static-check',\n+        'static-generation',\n+        'output-export-full-static-export',\n+      ])\n+\n+      for (const event of traceStructure.events) {\n+        expect(allowlistedEvents.has(event.name)).toBe(true)\n+      }\n+    })\n+\n+    it('should have next-build as root span with proper hierarchy', async () => {\n+      await next.build()\n+\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      const traceStructure = parseTraceFile(traceBuildPath)\n+\n+      // Should have no orphaned events (all events should have valid parent references)\n+      expect(traceStructure.orphanedEvents).toHaveLength(0)\n+\n+      // Should have at one root event\n+      expect(traceStructure.rootEvents.length).toBe(1)\n+\n+      // next-build should be the main root event\n+      const nextBuildEvents = traceStructure.eventsByName.get('next-build')\n+      expect(nextBuildEvents).toBeDefined()\n+      expect(nextBuildEvents.length).toBe(1)\n+\n+      const nextBuildEvent = nextBuildEvents[0]\n+      expect(nextBuildEvent.parentId).toBeUndefined() // Should be root\n+      expect(traceStructure.rootEvents).toContain(nextBuildEvent)\n+\n+      // Other build events should be children of next-build or have valid parent references\n+      const buildEvents = ['run-webpack', 'run-typescript', 'run-eslint']\n+      for (const eventName of buildEvents) {\n+        const events = traceStructure.eventsByName.get(eventName)\n+        if (events && events.length > 0) {\n+          for (const event of events) {\n+            if (event.parentId) {\n+              // Should have a valid parent\n+              expect(\n+                traceStructure.eventsById.has(event.parentId.toString())\n+              ).toBe(true)\n+              const parent = traceStructure.eventsById.get(\n+                event.parentId.toString()\n+              )\n+\n+              // Parent should either be next-build or another valid event\n+              expect(parent).toBeDefined()\n+              expect(parent.traceId).toBe(event.traceId) // Same trace\n+            }\n+          }\n+        }\n+      }\n+    })\n+\n+    it('should have consistent traceId across all events', async () => {\n+      await next.build()\n+\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      const traceStructure = parseTraceFile(traceBuildPath)\n+\n+      expect(traceStructure.events.length).toBeGreaterThan(0)\n+\n+      const firstEvent = traceStructure.events[0]\n+      expect(firstEvent.traceId).toBeDefined()\n+      expect(typeof firstEvent.traceId).toBe('string')\n+      expect(firstEvent.traceId.length).toBeGreaterThan(0)\n+\n+      // All events should have the same traceId\n+      for (const event of traceStructure.events) {\n+        expect(event.traceId).toBe(firstEvent.traceId)\n+      }\n+    })\n+  }\n+\n+  if (isNextDev) {\n+    it('should not create trace-build file in development mode', async () => {\n+      // Make a request to trigger some activity\n+      await next.render('/')\n+\n+      // Check that trace-build file does not exist\n+      const traceBuildPath = join(next.testDir, '.next/trace-build')\n+      expect(existsSync(traceBuildPath)).toBe(false)\n+    })\n+  }\n+\n+  it('should work with basic page rendering', async () => {\n+    if (isNextStart) {\n+      await next.start()\n+    }\n+    const $ = await next.render$('/')\n+    expect($('p').text()).toBe('hello world')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 505,
        "additions": 442,
        "deletions": 63
    }
}