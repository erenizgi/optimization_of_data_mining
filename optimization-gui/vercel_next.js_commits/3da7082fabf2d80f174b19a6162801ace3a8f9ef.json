{
    "author": "ijjk",
    "message": "Match subrequest handling for edge and node (#77474)\n\nThis aligns our subrequest handling between edge and node runtimes as we\ndid not carry over this handling for node and as such we want to remove\nthis from edge as well.",
    "sha": "3da7082fabf2d80f174b19a6162801ace3a8f9ef",
    "files": [
        {
            "sha": "fa15dcb4b12ba9548905469efea5c73b08ad0b73",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=3da7082fabf2d80f174b19a6162801ace3a8f9ef",
            "patch": "@@ -166,12 +166,6 @@ export async function initialize(opts: {\n   renderServer.instance =\n     require('./render-server') as typeof import('./render-server')\n \n-  const randomBytes = new Uint8Array(8)\n-  crypto.getRandomValues(randomBytes)\n-  const middlewareSubrequestId = Buffer.from(randomBytes).toString('hex')\n-  ;(globalThis as any)[Symbol.for('@next/middleware-subrequest-id')] =\n-    middlewareSubrequestId\n-\n   const requestHandlerImpl: WorkerRequestHandler = async (req, res) => {\n     // internal headers should not be honored by the request handler\n     if (!process.env.NEXT_PRIVATE_TEST_HEADERS) {"
        },
        {
            "sha": "09dee95773625d9f6f528b5818df3ed80adce497",
            "filename": "packages/next/src/server/lib/server-ipc/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fserver-ipc%2Futils.ts?ref=3da7082fabf2d80f174b19a6162801ace3a8f9ef",
            "patch": "@@ -57,16 +57,5 @@ export const filterInternalHeaders = (\n     if (INTERNAL_HEADERS.includes(header)) {\n       delete headers[header]\n     }\n-\n-    // If this request didn't origin from this session we filter\n-    // out the \"x-middleware-subrequest\" header so we don't skip\n-    // middleware incorrectly\n-    if (\n-      header === 'x-middleware-subrequest' &&\n-      headers['x-middleware-subrequest-id'] !==\n-        (globalThis as any)[Symbol.for('@next/middleware-subrequest-id')]\n-    ) {\n-      delete headers['x-middleware-subrequest']\n-    }\n   }\n }"
        },
        {
            "sha": "b18b23726d97d3416b26452d740edc254328381d",
            "filename": "packages/next/src/server/web/sandbox/context.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fcontext.ts?ref=3da7082fabf2d80f174b19a6162801ace3a8f9ef",
            "patch": "@@ -362,27 +362,6 @@ Learn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`),\n \n         init.headers = new Headers(init.headers ?? {})\n \n-        // Forward subrequest header from incoming request to outgoing request\n-        const store = requestStore.getStore()\n-        if (\n-          store?.headers.has('x-middleware-subrequest') &&\n-          !init.headers.has('x-middleware-subrequest')\n-        ) {\n-          init.headers.set(\n-            'x-middleware-subrequest',\n-            store.headers.get('x-middleware-subrequest') ?? ''\n-          )\n-        }\n-        init.headers.set(\n-          'x-middleware-subrequest-id',\n-          (globalThis as any)[Symbol.for('@next/middleware-subrequest-id')]\n-        )\n-\n-        const prevs =\n-          init.headers.get(`x-middleware-subrequest`)?.split(':') || []\n-        const value = prevs.concat(options.moduleName).join(':')\n-        init.headers.set('x-middleware-subrequest', value)\n-\n         if (!init.headers.has('user-agent')) {\n           init.headers.set(`user-agent`, `Next.js Middleware`)\n         }"
        },
        {
            "sha": "3e1784bd8468c2eb21a65236903716a58ebde0cb",
            "filename": "packages/next/src/server/web/sandbox/sandbox.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3da7082fabf2d80f174b19a6162801ace3a8f9ef/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts?ref=3da7082fabf2d80f174b19a6162801ace3a8f9ef",
            "patch": "@@ -93,25 +93,6 @@ export async function getRuntimeContext(\n \n export const run = withTaggedErrors(async function runWithTaggedErrors(params) {\n   const runtime = await getRuntimeContext(params)\n-  const subreq = params.request.headers[`x-middleware-subrequest`]\n-  const subrequests = typeof subreq === 'string' ? subreq.split(':') : []\n-\n-  const MAX_RECURSION_DEPTH = 5\n-  const depth = subrequests.reduce(\n-    (acc, curr) => (curr === params.name ? acc + 1 : acc),\n-    0\n-  )\n-\n-  if (depth >= MAX_RECURSION_DEPTH) {\n-    return {\n-      waitUntil: Promise.resolve(),\n-      response: new runtime.context.Response(null, {\n-        headers: {\n-          'x-middleware-next': '1',\n-        },\n-      }),\n-    }\n-  }\n \n   const edgeFunction: (args: {\n     request: RequestData"
        },
        {
            "sha": "eeec56e0fb53ace4100548721a070358d791be4f",
            "filename": "test/e2e/app-dir/app-routes-subrequests/app-routes-subrequests.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp-routes-subrequests.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp-routes-subrequests.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp-routes-subrequests.test.ts?ref=5c5875105af06e17ccad4080a6ace137f14cdabb",
            "patch": "@@ -1,20 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-\n-const bathPath = process.env.BASE_PATH ?? ''\n-\n-describe('app-routes-subrequests', () => {\n-  const { next, skipped } = nextTestSetup({\n-    files: __dirname,\n-    skipDeployment: true,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('shortcuts after 5 subrequests', async () => {\n-    expect(JSON.parse(await next.render(bathPath + '/'))).toEqual({\n-      count: 5,\n-    })\n-  })\n-})"
        },
        {
            "sha": "f083b407ad2cb59e5885d366e25ecd96d9020ed0",
            "filename": "test/e2e/app-dir/app-routes-subrequests/app/route.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fapp%2Froute.ts?ref=5c5875105af06e17ccad4080a6ace137f14cdabb",
            "patch": "@@ -1,11 +0,0 @@\n-import { NextRequest, NextResponse } from 'next/server'\n-\n-export const runtime = 'edge'\n-\n-let count = 0\n-\n-export const GET = async (req: NextRequest) => {\n-  await fetch(req.nextUrl)\n-  count++\n-  return NextResponse.json({ count })\n-}"
        },
        {
            "sha": "d54bad4c24cbeccbb7542cd88c3d43a3f7eb6c6a",
            "filename": "test/e2e/app-dir/app-routes-subrequests/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c5875105af06e17ccad4080a6ace137f14cdabb/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-routes-subrequests%2Fnext.config.js?ref=5c5875105af06e17ccad4080a6ace137f14cdabb",
            "patch": "@@ -1,10 +0,0 @@\n-/**\n- * @type {import('next').NextConfig}\n- */\n-const config = {\n-  typescript: {\n-    ignoreBuildErrors: true,\n-  },\n-}\n-\n-module.exports = config"
        },
        {
            "sha": "00977bbbedc229f350d1545800c57d16beac84bc",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3da7082fabf2d80f174b19a6162801ace3a8f9ef/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3da7082fabf2d80f174b19a6162801ace3a8f9ef/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=3da7082fabf2d80f174b19a6162801ace3a8f9ef",
            "patch": "@@ -144,19 +144,6 @@ describe('Middleware Runtime', () => {\n       }\n     }\n \n-    it('should filter request header properly', async () => {\n-      const res = await next.fetch('/redirect-to-somewhere', {\n-        headers: {\n-          'x-middleware-subrequest':\n-            'middleware:middleware:middleware:middleware:middleware',\n-        },\n-        redirect: 'manual',\n-      })\n-\n-      expect(res.status).toBe(307)\n-      expect(res.headers.get('location')).toContain('/somewhere')\n-    })\n-\n     it('should handle 404 on fallback: false route correctly', async () => {\n       const res = await next.fetch('/ssg-fallback-false/first')\n       expect(res.status).toBe(200)"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 0,
        "deletions": 111
    }
}