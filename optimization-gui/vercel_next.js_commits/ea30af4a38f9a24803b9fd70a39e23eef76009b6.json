{
    "author": "bgw",
    "message": "chore(CI): Run rspack tests in build_and_test.yml (#78757)\n\nThis is mostly a copy-paste of the turbopack tests in `build_and_test.yml`.\n\n- Only runs tests on PRs with the `Rspack` label.\n- Only runs the tests listed as passing in the manifest files. We want to identify regressions, but shouldn't report failures on known broken tests.\n- Don't bother with the code for running tests against React 18. The cost of running those tests is high, and the value is pretty low. Most users should be on React 19.\n- Rspack test failures are not yet blocking. We need to run continuously against canary to have confidence in blocking on this.\n\nCurrent problems (I don't think these are blocking for this PR):\n\n- The manifests are out of date. I'm working on this! The tests aren't blocking though, so it shouldn't be an issue for this PR.\n- If the label is added *after* the PR is created, the rspack tests won't run until you push a new revision of the PR. I discussed this with @ijjk and the solution will likely involve moving these tests into a separate workflow that can subscribe to label changes. I'll experiment with this in a follow-up PR.",
    "sha": "ea30af4a38f9a24803b9fd70a39e23eef76009b6",
    "files": [
        {
            "sha": "c198a2828dbcf157a57ec8cb2551187702ccf3a7",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 123,
            "deletions": 0,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/ea30af4a38f9a24803b9fd70a39e23eef76009b6/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/ea30af4a38f9a24803b9fd70a39e23eef76009b6/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=ea30af4a38f9a24803b9fd70a39e23eef76009b6",
            "patch": "@@ -49,6 +49,11 @@ jobs:\n     outputs:\n       docs-only: ${{ steps.docs-change.outputs.DOCS_ONLY != 'false' }}\n       is-release: ${{ steps.is-release.outputs.IS_RELEASE == 'true' }}\n+      rspack: >-\n+        ${{\n+          github.event_name == 'pull_request' &&\n+          contains(github.event.pull_request.labels.*.name, 'Rspack')\n+        }}\n \n   build-native:\n     name: build-native\n@@ -338,6 +343,124 @@ jobs:\n       stepName: 'test-turbopack-production-integration-${{ matrix.group }}'\n     secrets: inherit\n \n+  test-rspack-dev:\n+    name: test rspack dev\n+    needs: ['optimize-ci', 'changes', 'build-next', 'build-native']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' && needs.changes.outputs.rspack == 'true' }}\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/5, 2/5, 3/5, 4/5, 5/5]\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-dev-tests-manifest.json\"\n+        export NEXT_TEST_MODE=dev\n+\n+        # rspack flags\n+        export NEXT_RSPACK=1\n+        export NEXT_TEST_USE_RSPACK=1\n+\n+        # HACK: Despite the name, this environment variable is only used to gate\n+        # tests, so it's applicable to rspack\n+        export TURBOPACK_DEV=1\n+\n+        node run-tests.js \\\n+          --test-pattern '^(test\\/(development|e2e))/.*\\.test\\.(js|jsx|ts|tsx)$' \\\n+          --timings \\\n+          -g ${{ matrix.group }}\n+      stepName: 'test-rspack-dev-react-${{ matrix.react }}-${{ matrix.group }}'\n+    secrets: inherit\n+\n+  test-rspack-integration:\n+    name: test rspack development integration\n+    needs: ['optimize-ci', 'changes', 'build-next', 'build-native']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' && needs.changes.outputs.rspack == 'true' }}\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      nodeVersion: 18.18.2\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-dev-tests-manifest.json\"\n+\n+        # rspack flags\n+        export NEXT_RSPACK=1\n+        export NEXT_TEST_USE_RSPACK=1\n+\n+        # HACK: Despite the name, this environment variable is only used to gate\n+        # tests, so it's applicable to rspack\n+        export TURBOPACK_DEV=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          --type integration\n+      stepName: 'test-rspack-integration-react-${{ matrix.react }}-${{ matrix.group }}'\n+    secrets: inherit\n+\n+  test-rspack-production:\n+    name: test rspack production\n+    needs: ['optimize-ci', 'changes', 'build-next', 'build-native']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' && needs.changes.outputs.rspack == 'true' }}\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        exclude:\n+          # Excluding React 18 tests unless on `canary` branch until budget is approved.\n+          - react: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'run-react-18-tests') && '18.3.1' }}\n+        group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n+        # Empty value uses default\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      nodeVersion: 18.18.2\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-build-tests-manifest.json\"\n+        export NEXT_TEST_MODE=start\n+\n+        # rspack flags\n+        export NEXT_RSPACK=1\n+        export NEXT_TEST_USE_RSPACK=1\n+\n+        # HACK: Despite the name, this environment variable is only used to gate\n+        # tests, so it's applicable to rspack\n+        export TURBOPACK_BUILD=1\n+\n+        node run-tests.js --timings -g ${{ matrix.group }} --type production\n+      stepName: 'test-rspack-production-react-${{ matrix.react }}-${{ matrix.group }}'\n+    secrets: inherit\n+\n+  test-rspack-production-integration:\n+    name: test rspack production integration\n+    needs: ['optimize-ci', 'changes', 'build-next', 'build-native']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' && needs.changes.outputs.rspack == 'true' }}\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      nodeVersion: 18.18.2\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/rspack-build-tests-manifest.json\"\n+\n+        # rspack flags\n+        export NEXT_RSPACK=1\n+        export NEXT_TEST_USE_RSPACK=1\n+\n+        # HACK: Despite the name, this environment variable is only used to gate\n+        # tests, so it's applicable to rspack\n+        export TURBOPACK_BUILD=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          --type integration\n+      stepName: 'test-rspack-production-integration-${{ matrix.group }}'\n+    secrets: inherit\n+\n   test-next-swc-wasm:\n     name: test next-swc wasm\n     needs: ['optimize-ci', 'changes', 'build-next']"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 123,
        "deletions": 0
    }
}