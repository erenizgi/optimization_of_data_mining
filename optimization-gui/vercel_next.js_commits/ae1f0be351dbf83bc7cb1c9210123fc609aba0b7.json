{
    "author": "eps1lon",
    "message": "[segment-explorer] Signal updates to React (#80316)\n\nWe never actually invoked the listeners attached by React. Updates only worked on soft-navigation because we also re-render the DevOverlayRoot and don't bail out anywhere at the moment.\r\n\r\nJust invoking the listeners is not sufficient after https://github.com/vercel/next.js/pull/79699 since userspace and dev-overlay would read different versions of `listeners`. I ported the segment explorer into the new folder structure. Updates now flow through the `dispatcher` and then invoking the listeners actually works. Though mid term we should move the segment tree into actual React tree to get rid of the sync updates.\r\n\r\nI also noticed that we're missing an implementation for a remove operation which is required to show the correct state during soft navigations.",
    "sha": "ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
    "files": [
        {
            "sha": "e6977686f00b39cb5bc7d4ba60cdde80af3db10b",
            "filename": "packages/next/src/next-devtools/dev-overlay.browser.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -27,6 +27,11 @@ import type { DebugInfo } from './shared/types'\n import { DevOverlay } from './dev-overlay/dev-overlay'\n import type { DevIndicatorServerState } from '../server/dev/dev-indicator-server-state'\n import type { VersionInfo } from '../server/dev/parse-version-info'\n+import {\n+  insertSegmentNode,\n+  removeSegmentNode,\n+  type SegmentNode,\n+} from './dev-overlay/segment-explorer'\n \n export interface Dispatcher {\n   onBuildOk(): void\n@@ -46,6 +51,14 @@ export interface Dispatcher {\n   buildingIndicatorShow(): void\n   renderingIndicatorHide(): void\n   renderingIndicatorShow(): void\n+  segmentExplorerNodeAdd(\n+    nodeType: SegmentNode['type'],\n+    pagePath: SegmentNode['pagePath']\n+  ): void\n+  segmentExplorerNodeRemove(\n+    nodeType: SegmentNode['type'],\n+    pagePath: SegmentNode['pagePath']\n+  ): void\n }\n \n type Dispatch = ReturnType<typeof useErrorOverlayReducer>[1]\n@@ -131,6 +144,24 @@ export const dispatcher: Dispatcher = {\n   renderingIndicatorShow: createQueuable((dispatch: Dispatch) => {\n     dispatch({ type: ACTION_RENDERING_INDICATOR_SHOW })\n   }),\n+  segmentExplorerNodeAdd: createQueuable(\n+    (\n+      _: Dispatch,\n+      nodeType: SegmentNode['type'],\n+      pagePath: SegmentNode['pagePath']\n+    ) => {\n+      insertSegmentNode({ type: nodeType, pagePath })\n+    }\n+  ),\n+  segmentExplorerNodeRemove: createQueuable(\n+    (\n+      _: Dispatch,\n+      nodeType: SegmentNode['type'],\n+      pagePath: SegmentNode['pagePath']\n+    ) => {\n+      removeSegmentNode({ type: nodeType, pagePath })\n+    }\n+  ),\n }\n \n function replayQueuedEvents(dispatch: NonNullable<typeof maybeDispatch>) {"
        },
        {
            "sha": "01c803cde24af4dba52930421bd07c5dd4e027e4",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 21,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -2,24 +2,16 @@ import type { HTMLProps } from 'react'\n import { css } from '../../utils/css'\n import type { DevToolsInfoPropsCore } from '../errors/dev-tools-indicator/dev-tools-info/dev-tools-info'\n import { DevToolsInfo } from '../errors/dev-tools-indicator/dev-tools-info/dev-tools-info'\n-import {\n-  type SegmentNode,\n-  useSegmentTreeClientState,\n-} from '../../../../shared/lib/devtool/app-segment-tree'\n-import type { Trie, TrieNode } from '../../../../shared/lib/devtool/trie'\n-\n-function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n-  if (!tree) {\n-    return null\n-  }\n+import { useSegmentTree, type SegmentTrieNode } from '../../segment-explorer'\n+\n+function PageSegmentTree({ tree }: { tree: SegmentTrieNode }) {\n   return (\n     <div\n       className=\"segment-explorer-content\"\n       data-nextjs-devtool-segment-explorer\n     >\n       <PageSegmentTreeLayerPresentation\n-        tree={tree}\n-        node={tree.getRoot()}\n+        node={tree}\n         level={0}\n         segment=\"\"\n         parentSegment=\"\"\n@@ -29,16 +21,14 @@ function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n }\n \n function PageSegmentTreeLayerPresentation({\n-  tree,\n   segment,\n   parentSegment,\n   node,\n   level,\n }: {\n-  tree: Trie<SegmentNode>\n   segment: string\n   parentSegment: string\n-  node: TrieNode<SegmentNode>\n+  node: SegmentTrieNode\n   level: number\n }) {\n   const pagePath = node.value?.pagePath || ''\n@@ -111,7 +101,6 @@ function PageSegmentTreeLayerPresentation({\n             key={childSegment}\n             segment={childSegment}\n             parentSegment={segment}\n-            tree={tree}\n             node={child}\n             level={hasFileChildren ? level + 1 : level}\n           />\n@@ -124,14 +113,11 @@ function PageSegmentTreeLayerPresentation({\n export function SegmentsExplorer(\n   props: DevToolsInfoPropsCore & HTMLProps<HTMLDivElement>\n ) {\n-  const ctx = useSegmentTreeClientState()\n-  if (!ctx) {\n-    return null\n-  }\n+  const tree = useSegmentTree()\n \n   return (\n     <DevToolsInfo title=\"Segment Explorer\" {...props}>\n-      <PageSegmentTree tree={ctx.tree} />\n+      <PageSegmentTree tree={tree} />\n     </DevToolsInfo>\n   )\n }"
        },
        {
            "sha": "752e501ce37fc5ed7e76cece73ed66fd03906207",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer.test.tsx",
            "status": "added",
            "additions": 204,
            "deletions": 0,
            "changes": 204,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -0,0 +1,204 @@\n+/**\n+ * @jest-environment jsdom\n+ */\n+/* eslint-disable @next/internal/typechecked-require -- Not a prod file */\n+/* eslint-disable import/no-extraneous-dependencies -- Not a prod file */\n+\n+import type * as SegmentExplorer from './segment-explorer'\n+\n+describe('Segment Explorer', () => {\n+  let cleanup: typeof import('@testing-library/react').cleanup\n+  let renderHook: typeof import('@testing-library/react').renderHook\n+  let useSegmentTree: typeof SegmentExplorer.useSegmentTree\n+  let insertSegmentNode: typeof SegmentExplorer.insertSegmentNode\n+  let removeSegmentNode: typeof SegmentExplorer.removeSegmentNode\n+\n+  beforeEach(() => {\n+    jest.resetModules()\n+    jest.clearAllMocks()\n+\n+    const segmentExplorer = require('./segment-explorer')\n+    useSegmentTree = segmentExplorer.useSegmentTree\n+    insertSegmentNode = segmentExplorer.insertSegmentNode\n+    removeSegmentNode = segmentExplorer.removeSegmentNode\n+    const rtl = require('@testing-library/react/pure')\n+    renderHook = rtl.renderHook\n+    cleanup = rtl.cleanup\n+  })\n+\n+  afterEach(() => {\n+    cleanup()\n+  })\n+\n+  test('add complex structure', () => {\n+    insertSegmentNode({ pagePath: '/a/page.js', type: 'page' })\n+    insertSegmentNode({ pagePath: '/a/layout.js', type: 'layout' })\n+    insertSegmentNode({ pagePath: '/layout.js', type: 'layout' })\n+\n+    const { result } = renderHook(useSegmentTree)\n+\n+    expect(result.current).toEqual({\n+      children: {\n+        '': {\n+          children: {\n+            a: {\n+              children: {\n+                'layout.js': {\n+                  children: {},\n+                  value: {\n+                    pagePath: '/a/layout.js',\n+                    type: 'layout',\n+                  },\n+                },\n+                'page.js': {\n+                  children: {},\n+                  value: {\n+                    pagePath: '/a/page.js',\n+                    type: 'page',\n+                  },\n+                },\n+              },\n+              value: undefined,\n+            },\n+            'layout.js': {\n+              children: {},\n+              value: {\n+                pagePath: '/layout.js',\n+                type: 'layout',\n+              },\n+            },\n+          },\n+          value: undefined,\n+        },\n+      },\n+      value: undefined,\n+    })\n+  })\n+\n+  test.failing('remove node in the middle', () => {\n+    insertSegmentNode({ pagePath: '/a/b/@sidebar/page.js', type: 'page' })\n+    insertSegmentNode({ pagePath: '/a/b/page.js', type: 'page' })\n+    insertSegmentNode({ pagePath: '/a/b/layout.js', type: 'layout' })\n+    insertSegmentNode({ pagePath: '/a/layout.js', type: 'layout' })\n+    insertSegmentNode({ pagePath: '/layout.js', type: 'layout' })\n+\n+    const { result } = renderHook(useSegmentTree)\n+\n+    expect(result.current).toEqual({\n+      children: {\n+        '': {\n+          children: {\n+            a: {\n+              children: {\n+                b: {\n+                  children: {\n+                    '@sidebar': {\n+                      children: {\n+                        'page.js': {\n+                          children: {},\n+                          value: {\n+                            pagePath: '/a/b/@sidebar/page.js',\n+                            type: 'page',\n+                          },\n+                        },\n+                      },\n+                      value: undefined,\n+                    },\n+                    'layout.js': {\n+                      children: {},\n+                      value: {\n+                        pagePath: '/a/b/layout.js',\n+                        type: 'layout',\n+                      },\n+                    },\n+                    'page.js': {\n+                      children: {},\n+                      value: {\n+                        pagePath: '/a/b/page.js',\n+                        type: 'page',\n+                      },\n+                    },\n+                  },\n+                  value: undefined,\n+                },\n+                'layout.js': {\n+                  children: {},\n+                  value: {\n+                    pagePath: '/a/layout.js',\n+                    type: 'layout',\n+                  },\n+                },\n+              },\n+              value: undefined,\n+            },\n+            'layout.js': {\n+              children: {},\n+              value: {\n+                pagePath: '/layout.js',\n+                type: 'layout',\n+              },\n+            },\n+          },\n+          value: undefined,\n+        },\n+      },\n+      value: undefined,\n+    })\n+\n+    removeSegmentNode({ pagePath: '/a/b/layout.js', type: 'layout' })\n+\n+    expect(result.current).toEqual({\n+      children: {\n+        '': {\n+          children: {\n+            a: {\n+              children: {\n+                b: {\n+                  children: {\n+                    '@sidebar': {\n+                      children: {\n+                        'page.js': {\n+                          children: {},\n+                          value: {\n+                            pagePath: '/a/b/@sidebar/page.js',\n+                            type: 'page',\n+                          },\n+                        },\n+                      },\n+                      value: undefined,\n+                    },\n+                    'page.js': {\n+                      children: {},\n+                      value: {\n+                        pagePath: '/a/b/page.js',\n+                        type: 'page',\n+                      },\n+                    },\n+                  },\n+                  value: undefined,\n+                },\n+                'layout.js': {\n+                  children: {},\n+                  value: {\n+                    pagePath: '/a/layout.js',\n+                    type: 'layout',\n+                  },\n+                },\n+              },\n+              value: undefined,\n+            },\n+            'layout.js': {\n+              children: {},\n+              value: {\n+                pagePath: '/layout.js',\n+                type: 'layout',\n+              },\n+            },\n+          },\n+          value: undefined,\n+        },\n+      },\n+      value: undefined,\n+    })\n+  })\n+})"
        },
        {
            "sha": "826149b923c8d2b4c282441a9ca34676c5804ea3",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer.ts",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -0,0 +1,124 @@\n+import { useSyncExternalStore } from 'react'\n+\n+/**\n+ * Trie data structure for storing and searching paths\n+ *\n+ * This can be used to store app router paths and search for them efficiently.\n+ * e.g.\n+ *\n+ * [trie root]\n+ *   ├── layout.js\n+ *   ├── page.js\n+ *   ├── blog\n+ *       ├── layout.js\n+ *       ├── page.js\n+ *       ├── [slug]\n+ *          ├── layout.js\n+ *          ├── page.js\n+ **/\n+\n+type TrieNode<Value = string> = {\n+  value: Value | undefined\n+  children: {\n+    [key: string]: TrieNode<Value> | undefined\n+  }\n+}\n+\n+type Trie<Value = string> = {\n+  insert: (value: Value) => void\n+  remove: (value: Value) => void\n+  getRoot: () => TrieNode<Value>\n+}\n+\n+const listeners = new Set<() => void>()\n+const createSegmentTreeStore = (): {\n+  subscribe: (callback: () => void) => () => void\n+  getSnapshot: () => SegmentTrieNode\n+  getServerSnapshot: () => SegmentTrieNode\n+} => {\n+  // return a store that can be used by useSyncExternalStore\n+  return {\n+    subscribe: (callback) => {\n+      listeners.add(callback)\n+      return () => listeners.delete(callback)\n+    },\n+    getSnapshot: () => {\n+      return trie.getRoot()\n+    },\n+    getServerSnapshot: () => {\n+      return trie.getRoot()\n+    },\n+  }\n+}\n+\n+// TODO: Move the Segment Tree into React State\n+const { subscribe, getSnapshot, getServerSnapshot } = createSegmentTreeStore()\n+\n+function createTrie<Value = string>({\n+  getKey = (k) => k as unknown as string,\n+}: {\n+  getKey: (k: Value) => string\n+}): Trie<Value> {\n+  const root: TrieNode<Value> = {\n+    value: undefined,\n+    children: {},\n+  }\n+\n+  function markUpdated() {\n+    for (const listener of listeners) {\n+      listener()\n+    }\n+  }\n+\n+  function insert(value: Value) {\n+    let currentNode = root\n+    const key = getKey(value)\n+    const segments = key.split('/')\n+\n+    for (const segment of segments) {\n+      if (!currentNode.children[segment]) {\n+        currentNode.children[segment] = {\n+          value: undefined,\n+          // Skip value for intermediate nodes\n+          children: {},\n+        }\n+      }\n+      currentNode = currentNode.children[segment]\n+    }\n+\n+    currentNode.value = value\n+\n+    markUpdated()\n+  }\n+\n+  function remove(_: Value) {\n+    // TODO Implement remove functionality\n+\n+    markUpdated()\n+  }\n+\n+  function getRoot(): TrieNode<Value> {\n+    return root\n+  }\n+\n+  return { insert, remove, getRoot }\n+}\n+\n+export type SegmentNode = {\n+  type: string\n+  pagePath: string\n+}\n+\n+export type SegmentTrie = Trie<SegmentNode>\n+export type SegmentTrieNode = TrieNode<SegmentNode>\n+\n+const trie: SegmentTrie = createTrie({\n+  getKey: (item) => item.pagePath,\n+})\n+export const insertSegmentNode = trie.insert\n+export const removeSegmentNode = trie.remove\n+\n+export function useSegmentTree(): SegmentTrieNode {\n+  const state = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)\n+  return state\n+}"
        },
        {
            "sha": "40175a51fce35e2c3a7d208f9fa26d3b1f0208d6",
            "filename": "packages/next/src/next-devtools/userspace/app/segment-explorer.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fsegment-explorer.ts?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -0,0 +1,23 @@\n+'use client'\n+import type { ReactNode } from 'react'\n+import { useEffect } from 'react'\n+import { dispatcher } from 'next/dist/compiled/next-devtools'\n+\n+export function SegmentViewNode({\n+  type,\n+  pagePath,\n+  children,\n+}: {\n+  type: string\n+  pagePath: string\n+  children: ReactNode\n+}) {\n+  useEffect(() => {\n+    dispatcher.segmentExplorerNodeAdd(type, pagePath)\n+    return () => {\n+      dispatcher.segmentExplorerNodeRemove(type, pagePath)\n+    }\n+  }, [type, pagePath])\n+\n+  return children\n+}"
        },
        {
            "sha": "8068564e94efdabd2c76b3a5677afcaef832ef89",
            "filename": "packages/next/src/server/app-render/entry-base.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -45,12 +45,12 @@ import { Postpone } from './rsc/postpone'\n import { taintObjectReference } from './rsc/taint'\n export { collectSegmentData } from './collect-segment-data'\n \n-let SegmentViewNode: typeof import('../../shared/lib/devtool/app-segment-tree').SegmentViewNode =\n+let SegmentViewNode: typeof import('../../next-devtools/userspace/app/segment-explorer').SegmentViewNode =\n   () => null\n if (process.env.NODE_ENV === 'development') {\n-  const appSegmentTree: typeof import('../../shared/lib/devtool/app-segment-tree') =\n-    require('../../shared/lib/devtool/app-segment-tree') as typeof import('../../shared/lib/devtool/app-segment-tree')\n-  SegmentViewNode = appSegmentTree.SegmentViewNode\n+  SegmentViewNode = (\n+    require('../../next-devtools/userspace/app/segment-explorer') as typeof import('../../next-devtools/userspace/app/segment-explorer')\n+  ).SegmentViewNode\n }\n \n // patchFetch makes use of APIs such as `React.unstable_postpone` which are only available"
        },
        {
            "sha": "e8515edcda6b63f1438cd68063327da7b0b4f93b",
            "filename": "packages/next/src/shared/lib/devtool/app-segment-tree.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 101,
            "changes": 101,
            "blob_url": "https://github.com/vercel/next.js/blob/f646f4df2fda7fe0005c93a95c0492e06aac9278/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Fapp-segment-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f646f4df2fda7fe0005c93a95c0492e06aac9278/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Fapp-segment-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Fapp-segment-tree.tsx?ref=f646f4df2fda7fe0005c93a95c0492e06aac9278",
            "patch": "@@ -1,101 +0,0 @@\n-'use client'\n-\n-import { type ReactNode, useEffect, useSyncExternalStore } from 'react'\n-import { createTrie, type Trie } from './trie'\n-\n-export type SegmentNode = {\n-  type: string\n-  pagePath: string\n-}\n-\n-type DevtoolClientState = {\n-  tree?: Trie<SegmentNode>\n-}\n-\n-const DEFAULT_CLIENT_STATE =\n-  typeof window === 'undefined'\n-    ? undefined\n-    : createTrie<SegmentNode>({\n-        getKey: (item) => item.pagePath,\n-      })\n-\n-declare global {\n-  interface Window {\n-    __NEXT_DEVTOOLS_CLIENT_STATE?: DevtoolClientState\n-  }\n-}\n-\n-function getSegmentTreeClientState(): DevtoolClientState {\n-  if (typeof window === 'undefined') {\n-    return {}\n-  }\n-  if (!window.__NEXT_DEVTOOLS_CLIENT_STATE) {\n-    window.__NEXT_DEVTOOLS_CLIENT_STATE = {\n-      // Initial state\n-      tree: DEFAULT_CLIENT_STATE,\n-    }\n-  }\n-  return window.__NEXT_DEVTOOLS_CLIENT_STATE\n-}\n-\n-const listeners = typeof window === 'undefined' ? null : new Set<() => void>()\n-\n-const createSegmentTreeStore = (): {\n-  subscribe: (callback: () => void) => () => void\n-  getSnapshot: () => DevtoolClientState\n-  getServerSnapshot: () => undefined\n-} => {\n-  if (typeof window === 'undefined') {\n-    return {\n-      subscribe: () => () => void 0,\n-      getSnapshot: () => ({}),\n-      getServerSnapshot: () => undefined,\n-    }\n-  }\n-\n-  // return a store that can be used by useSyncExternalStore\n-  return {\n-    subscribe: (callback) => {\n-      listeners?.add(callback)\n-      return () => listeners?.delete(callback)\n-    },\n-    getSnapshot: () => {\n-      return getSegmentTreeClientState()\n-    },\n-    getServerSnapshot: () => {\n-      return undefined\n-    },\n-  }\n-}\n-\n-const { subscribe, getSnapshot, getServerSnapshot } = createSegmentTreeStore()\n-\n-export function SegmentViewNode({\n-  type,\n-  pagePath,\n-  children,\n-}: {\n-  type: string\n-  pagePath: string\n-  children: ReactNode\n-}) {\n-  const clientState = getSegmentTreeClientState()\n-  const tree = clientState.tree\n-\n-  useEffect(() => {\n-    if (!tree) {\n-      return\n-    }\n-    tree.insert({\n-      type,\n-      pagePath,\n-    })\n-  }, [type, pagePath, tree])\n-\n-  return children\n-}\n-\n-export function useSegmentTreeClientState() {\n-  const state = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)\n-  return state\n-}"
        },
        {
            "sha": "700d99df9edeabb87e4f2c17892ffe1905461803",
            "filename": "packages/next/src/shared/lib/devtool/trie.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 63,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/f646f4df2fda7fe0005c93a95c0492e06aac9278/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Ftrie.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f646f4df2fda7fe0005c93a95c0492e06aac9278/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Ftrie.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdevtool%2Ftrie.ts?ref=f646f4df2fda7fe0005c93a95c0492e06aac9278",
            "patch": "@@ -1,63 +0,0 @@\n-/**\n- * Trie data structure for storing and searching paths\n- *\n- * This can be used to store app router paths and search for them efficiently.\n- * e.g.\n- *\n- * [trie root]\n- *   ├── layout.js\n- *   ├── page.js\n- *   ├── blog\n- *       ├── layout.js\n- *       ├── page.js\n- *       ├── [slug]\n- *          ├── layout.js\n- *          ├── page.js\n- **/\n-\n-export type TrieNode<Value = string> = {\n-  value?: Value\n-  children: {\n-    [key: string]: TrieNode<Value> | undefined\n-  }\n-}\n-\n-export type Trie<Value = string> = {\n-  insert: (value: Value) => void\n-  getRoot: () => TrieNode<Value>\n-}\n-\n-export function createTrie<Value = string>({\n-  getKey = (k) => k as unknown as string,\n-}: {\n-  getKey: (k: Value) => string\n-}): Trie<Value> {\n-  const root: TrieNode<Value> = {\n-    value: undefined,\n-    children: {},\n-  }\n-\n-  function insert(value: Value) {\n-    let currentNode = root\n-    const key = getKey(value)\n-    const segments = key.split('/')\n-\n-    for (const segment of segments) {\n-      if (!currentNode.children[segment]) {\n-        currentNode.children[segment] = {\n-          // Skip value for intermediate nodes\n-          children: {},\n-        }\n-      }\n-      currentNode = currentNode.children[segment]\n-    }\n-\n-    currentNode.value = value\n-  }\n-\n-  function getRoot(): TrieNode<Value> {\n-    return root\n-  }\n-\n-  return { insert, getRoot }\n-}"
        },
        {
            "sha": "b2d3970cdc554d5d238ad8b333686eeed954a1e8",
            "filename": "test/development/app-dir/segment-explorer/app/soft-navigation/a/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fa%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fa%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fa%2Fpage.tsx?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -0,0 +1,10 @@\n+import Link from 'next/link'\n+\n+export default function SoftNavigationAPage() {\n+  return (\n+    <>\n+      <p>Page A</p>\n+      <Link href=\"/soft-navigation/b\">Go to Page b</Link>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "2bfa07e5c5079452f5a2945b891d351bda9c4500",
            "filename": "test/development/app-dir/segment-explorer/app/soft-navigation/b/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fb%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fb%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fsoft-navigation%2Fb%2Fpage.tsx?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -0,0 +1,10 @@\n+import Link from 'next/link'\n+\n+export default function SoftNavigationBPage() {\n+  return (\n+    <>\n+      <p>Page B</p>\n+      <Link href=\"/soft-navigation/a\">Go to Page a</Link>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "81b29df78768ea4128fe7a2c93994b55ee524fcb",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ae1f0be351dbf83bc7cb1c9210123fc609aba0b7/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=ae1f0be351dbf83bc7cb1c9210123fc609aba0b7",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { openDevToolsIndicatorPopover } from 'next-test-utils'\n+import { openDevToolsIndicatorPopover, retry } from 'next-test-utils'\n import { Playwright } from 'next-webdriver'\n \n async function getSegmentExplorerContent(browser: Playwright) {\n@@ -46,4 +46,24 @@ describe('segment-explorer', () => {\n      gridpage.tsx\"\n     `)\n   })\n+\n+  it('should cleanup on soft navigation', async () => {\n+    const browser = await next.browser('/soft-navigation/a')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"applayout.tsx\n+     apage.tsx\"\n+    `)\n+\n+    await browser.elementByCss('[href=\"/soft-navigation/b\"]').click()\n+    await retry(async () => {\n+      expect(await browser.elementByCss('body').text()).toContain('Page B')\n+    })\n+\n+    // FIXME: Should no longer contain /soft-navigation/a/page.js\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"applayout.tsx\n+     apage.tsx\n+     bpage.tsx\"\n+    `)\n+  })\n })"
        }
    ],
    "stats": {
        "total": 624,
        "additions": 434,
        "deletions": 190
    }
}