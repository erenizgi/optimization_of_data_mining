{
    "author": "bgub",
    "message": "fix: validation return types of pages API routes (#83069)\n\n## For Contributors\n\n### Fixing a bug\n\n- Updates the (previously incorrect) API route handler type definition\nin the validator\n- Changes the return type from `Promise<Response | void> | Response |\nvoid` to `unknown | Promise<unknown>`\n- Updates the test route example to use the `NextApiHandler` type\n(making sure it works)\n\nFixes #83067",
    "sha": "28802386cac905047600f36b6cca9565c1a7f288",
    "files": [
        {
            "sha": "d251508b3eb67d9be4b5d774048a2ebde193de7e",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/28802386cac905047600f36b6cca9565c1a7f288/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/28802386cac905047600f36b6cca9565c1a7f288/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=28802386cac905047600f36b6cca9565c1a7f288",
            "patch": "@@ -565,7 +565,7 @@ export function generateValidatorFile(\n \n   if (pagesApiRouteValidations) {\n     typeDefinitions += `type ApiRouteConfig = {\n-  default: (req: any, res: any) => Promise<Response | void> | Response | void\n+  default: (req: any, res: any) => ReturnType<NextApiHandler>\n   config?: {\n     api?: {\n       bodyParser?: boolean | { sizeLimit?: string }\n@@ -611,18 +611,25 @@ export function generateValidatorFile(\n     ? \"import type { NextRequest } from 'next/server.js'\\n\"\n     : ''\n \n-  // Only import metadata types if there are App Router pages or layouts that might use them\n-  const metadataImport =\n-    appPageValidations || layoutValidations\n-      ? 'import type { ResolvingMetadata, ResolvingViewport } from \"next/dist/lib/metadata/types/metadata-interface.js\"\\n'\n+  // Conditionally import types from next/types, merged into a single statement\n+  const nextTypes: string[] = []\n+  if (pagesApiRouteValidations) {\n+    nextTypes.push('NextApiHandler')\n+  }\n+  if (appPageValidations || layoutValidations) {\n+    nextTypes.push('ResolvingMetadata', 'ResolvingViewport')\n+  }\n+  const nextTypesImport =\n+    nextTypes.length > 0\n+      ? `import type { ${nextTypes.join(', ')} } from \"next/types.js\"\\n`\n       : ''\n \n   return `// This file is generated automatically by Next.js\n // Do not edit this file manually\n // This file validates that all pages and layouts export the correct types\n \n ${routeImportStatement}\n-${metadataImport}${nextRequestImport}\n+${nextTypesImport}${nextRequestImport}\n ${typeDefinitions}\n ${appPageValidations}\n "
        },
        {
            "sha": "461e0673666605ac525f36547d82b3d1e3e92cb4",
            "filename": "test/e2e/app-dir/typed-routes-validator/pages/api/test-route.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/28802386cac905047600f36b6cca9565c1a7f288/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Fpages%2Fapi%2Ftest-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/28802386cac905047600f36b6cca9565c1a7f288/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Fpages%2Fapi%2Ftest-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Fpages%2Fapi%2Ftest-route.ts?ref=28802386cac905047600f36b6cca9565c1a7f288",
            "patch": "@@ -1,12 +1,11 @@\n-import type { NextApiRequest, NextApiResponse } from 'next/types'\n+import type { NextApiHandler } from 'next/types'\n \n type ResponseData = {\n   message: string\n }\n \n-export default function handler(\n-  req: NextApiRequest,\n-  res: NextApiResponse<ResponseData>\n-) {\n+const handler: NextApiHandler<ResponseData> = (req, res) => {\n   res.status(200).json({ message: 'Hello from Next.js!' })\n }\n+\n+export default handler"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 17,
        "deletions": 11
    }
}