{
    "author": "huozhi",
    "message": "fix edge runtime asset fetch in pages api (#76750)\n\n### What\r\n\r\nWe discoved an issue that fetch new URL with static assets in Pages API on edge runtime were failing. Located the issue was an introduced in #66534 where we changed the layer of Pages API with edge runtime entries into API layer, where it actually should be another separate layer like middleware.\r\n\r\nThe quick fix is using middleware bundle layer for Pages API edge functions, but middleware is server-only layer which Pages API is not yet, since it doesn't bundle everything and picking up the `react-server` condition. So we have to create a new layer `apiEdge` to minimize the behavior changes and also fix the bug.\r\n\r\nThe test suite was disabled due to node-fetch blocker, but we now we can enable it.\r\n\r\nCloses NDX-941\r\nFixes #74385 \r\n[slack-ref](https://vercel.slack.com/archives/C07CGAA2RS6/p1740868643335099)",
    "sha": "6dc85796c257b3632d37d09901cea5b23fe6835b",
    "files": [
        {
            "sha": "f9d615d4e2816e94983af5bb8c999aa6a4769152",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=6dc85796c257b3632d37d09901cea5b23fe6835b",
            "patch": "@@ -424,7 +424,10 @@ export function getEdgeServerEntry(opts: {\n       ).toString('base64'),\n     }\n \n-    return `next-edge-function-loader?${stringify(loaderParams)}!`\n+    return {\n+      import: `next-edge-function-loader?${stringify(loaderParams)}!`,\n+      layer: WEBPACK_LAYERS.apiEdge,\n+    }\n   }\n \n   const loaderParams: EdgeSSRLoaderQuery = {\n@@ -876,7 +879,7 @@ export function finalizeEntrypoint({\n   switch (compilerType) {\n     case COMPILER_NAMES.server: {\n       const layer = isApi\n-        ? WEBPACK_LAYERS.api\n+        ? WEBPACK_LAYERS.apiNode\n         : isInstrumentation\n           ? WEBPACK_LAYERS.instrument\n           : isServerComponent\n@@ -895,7 +898,7 @@ export function finalizeEntrypoint({\n     case COMPILER_NAMES.edgeServer: {\n       return {\n         layer: isApi\n-          ? WEBPACK_LAYERS.api\n+          ? WEBPACK_LAYERS.apiEdge\n           : isMiddlewareFilename(name) || isInstrumentation\n             ? WEBPACK_LAYERS.middleware\n             : name.startsWith('pages/')"
        },
        {
            "sha": "c4d10b3f8e36923ab2d767c23d5af478d2e54402",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=6dc85796c257b3632d37d09901cea5b23fe6835b",
            "patch": "@@ -645,7 +645,7 @@ export default async function getBaseWebpackConfig(\n   const apiRoutesLayerLoaders = useSWCLoader\n     ? getSwcLoader({\n         serverComponents: false,\n-        bundleLayer: WEBPACK_LAYERS.api,\n+        bundleLayer: WEBPACK_LAYERS.apiNode,\n       })\n     : defaultLoaders.babel\n \n@@ -1575,15 +1575,20 @@ export default async function getBaseWebpackConfig(\n           oneOf: [\n             {\n               ...codeCondition,\n-              issuerLayer: WEBPACK_LAYERS.api,\n+              issuerLayer: WEBPACK_LAYERS.apiNode,\n+              use: apiRoutesLayerLoaders,\n+              // In Node.js, switch back to normal URL handling.\n+              // We won't bundle `new URL()` cases in Node.js bundler layer.\n               parser: {\n-                // In Node.js, switch back to normal URL handling.\n-                // In Edge runtime, we should disable parser.url handling in webpack so URLDependency is not added.\n-                // Then there's browser code won't be injected into the edge runtime chunk.\n-                // x-ref: https://github.com/webpack/webpack/blob/d9ce3b1f87e63c809d8a19bbd92257d65922e81f/lib/web/JsonpChunkLoadingRuntimeModule.js#L69\n-                url: !isEdgeServer,\n+                url: true,\n               },\n+            },\n+            {\n+              ...codeCondition,\n+              issuerLayer: WEBPACK_LAYERS.apiEdge,\n               use: apiRoutesLayerLoaders,\n+              // In Edge runtime, we leave the url handling by default.\n+              // The new URL assets will be converted into edge assets through assets loader.\n             },\n             {\n               test: codeCondition.test,"
        },
        {
            "sha": "e6040c77ab137e652829ba543391ff27508b72c3",
            "filename": "packages/next/src/build/webpack/plugins/middleware-plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts?ref=6dc85796c257b3632d37d09901cea5b23fe6835b",
            "patch": "@@ -279,7 +279,7 @@ function buildWebpackError({\n \n function isInMiddlewareLayer(parser: webpack.javascript.JavascriptParser) {\n   const layer = parser.state.module?.layer\n-  return layer === WEBPACK_LAYERS.middleware || layer === WEBPACK_LAYERS.api\n+  return layer === WEBPACK_LAYERS.middleware || layer === WEBPACK_LAYERS.apiEdge\n }\n \n function isNodeJsModule(moduleName: string) {\n@@ -868,7 +868,7 @@ export async function handleWebpackExternalForEdgeRuntime({\n }) {\n   if (\n     (contextInfo.issuerLayer === WEBPACK_LAYERS.middleware ||\n-      contextInfo.issuerLayer === WEBPACK_LAYERS.api) &&\n+      contextInfo.issuerLayer === WEBPACK_LAYERS.apiEdge) &&\n     isNodeJsModule(request) &&\n     !supportedEdgePolyfills.has(request)\n   ) {"
        },
        {
            "sha": "08be4189081874aa8702b39bd98262e17572b6e8",
            "filename": "packages/next/src/lib/constants.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dc85796c257b3632d37d09901cea5b23fe6835b/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts?ref=6dc85796c257b3632d37d09901cea5b23fe6835b",
            "patch": "@@ -118,9 +118,13 @@ const WEBPACK_LAYERS_NAMES = {\n    */\n   actionBrowser: 'action-browser',\n   /**\n-   * The layer for the API routes.\n+   * The Node.js bundle layer for the API routes.\n    */\n-  api: 'api',\n+  apiNode: 'api-node',\n+  /**\n+   * The Edge Lite bundle layer for the API routes.\n+   */\n+  apiEdge: 'api-edge',\n   /**\n    * The layer for the middleware code.\n    */\n@@ -169,7 +173,8 @@ const WEBPACK_LAYERS = {\n     ],\n     neutralTarget: [\n       // pages api\n-      WEBPACK_LAYERS_NAMES.api,\n+      WEBPACK_LAYERS_NAMES.apiNode,\n+      WEBPACK_LAYERS_NAMES.apiEdge,\n     ],\n     clientOnly: [\n       WEBPACK_LAYERS_NAMES.serverSideRendering,"
        },
        {
            "sha": "2053e8f97b1b32298664022ab43822de32e294b6",
            "filename": "test/e2e/edge-compiler-can-import-blob-assets/index.test.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 47,
            "changes": 109,
            "blob_url": "https://github.com/vercel/next.js/blob/6dc85796c257b3632d37d09901cea5b23fe6835b/test%2Fe2e%2Fedge-compiler-can-import-blob-assets%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6dc85796c257b3632d37d09901cea5b23fe6835b/test%2Fe2e%2Fedge-compiler-can-import-blob-assets%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fedge-compiler-can-import-blob-assets%2Findex.test.ts?ref=6dc85796c257b3632d37d09901cea5b23fe6835b",
            "patch": "@@ -1,28 +1,13 @@\n-import { createNext, FileRef } from 'e2e-utils'\n-import { NextInstance } from 'e2e-utils'\n+import { nextTestSetup } from 'e2e-utils'\n import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n import path from 'path'\n import { promises as fs } from 'fs'\n import { readJson } from 'fs-extra'\n \n-// TODO: `node-fetch` hangs on some of these tests in Node.js.\n-// Re-enable when `node-fetch` is dropped.\n-// See: https://github.com/vercel/next.js/pull/55112\n-describe.skip('Edge Compiler can import asset assets', () => {\n-  let next: NextInstance\n-\n-  // TODO: remove after this is supported for deploy\n-  if ((global as any).isNextDeploy) {\n-    it('should skip for deploy for now', () => {})\n-    return\n-  }\n-\n-  beforeAll(async () => {\n-    next = await createNext({\n-      files: new FileRef(path.join(__dirname, './app')),\n-    })\n+describe('Edge Compiler can import asset assets', () => {\n+  const { next, isTurbopack, isNextDeploy } = nextTestSetup({\n+    files: path.join(__dirname, './app'),\n   })\n-  afterAll(() => next.destroy())\n \n   it('allows to fetch a remote URL', async () => {\n     const response = await fetchViaHTTP(next.url, '/api/edge', {\n@@ -66,33 +51,63 @@ describe.skip('Edge Compiler can import asset assets', () => {\n     })\n   })\n \n-  it('extracts all the assets from the bundle', async () => {\n-    const manifestPath = path.join(\n-      next.testDir,\n-      '.next/server/middleware-manifest.json'\n-    )\n-    const manifest = await readJson(manifestPath)\n-    const orderedAssets = manifest.functions['/api/edge'].assets.sort(\n-      (a, z) => {\n-        return String(a.name).localeCompare(z.name)\n-      }\n-    )\n+  // Cannot read the file on deployment\n+  if (!isNextDeploy) {\n+    it('extracts all the assets from the bundle', async () => {\n+      const manifestPath = path.join(\n+        next.testDir,\n+        '.next/server/middleware-manifest.json'\n+      )\n+      const manifest = await readJson(manifestPath)\n+      const orderedAssets = manifest.functions['/api/edge'].assets.sort(\n+        (a, z) => {\n+          return String(a.name).localeCompare(z.name)\n+        }\n+      )\n \n-    expect(orderedAssets).toMatchObject([\n-      {\n-        name: expect.stringMatching(/^text-file\\.[0-9a-f]{16}\\.txt$/),\n-        filePath: expect.stringMatching(\n-          /^server\\/edge-chunks\\/asset_text-file/\n-        ),\n-      },\n-      {\n-        name: expect.stringMatching(/^vercel\\.[0-9a-f]{16}\\.png$/),\n-        filePath: expect.stringMatching(/^server\\/edge-chunks\\/asset_vercel/),\n-      },\n-      {\n-        name: expect.stringMatching(/^world\\.[0-9a-f]{16}\\.json/),\n-        filePath: expect.stringMatching(/^server\\/edge-chunks\\/asset_world/),\n-      },\n-    ])\n-  })\n+      if (isTurbopack) {\n+        expect(orderedAssets).toMatchObject([\n+          {\n+            name: expect.stringMatching(\n+              /server\\/edge\\/assets\\/text-file\\.[0-9a-f]{8}\\.txt$/\n+            ),\n+            filePath: expect.stringMatching(/^server\\/edge\\/assets\\/text-file/),\n+          },\n+          {\n+            name: expect.stringMatching(\n+              /^server\\/edge\\/assets\\/vercel\\.[0-9a-f]{8}\\.png$/\n+            ),\n+            filePath: expect.stringMatching(/^server\\/edge\\/assets\\/vercel/),\n+          },\n+          {\n+            name: expect.stringMatching(\n+              /^server\\/edge\\/assets\\/world\\.[0-9a-f]{8}\\.json/\n+            ),\n+            filePath: expect.stringMatching(/^server\\/edge\\/assets\\/world/),\n+          },\n+        ])\n+      } else {\n+        expect(orderedAssets).toMatchObject([\n+          {\n+            name: expect.stringMatching(/^text-file\\.[0-9a-f]{16}\\.txt$/),\n+            filePath: expect.stringMatching(\n+              /^server\\/edge-chunks\\/asset_text-file/\n+            ),\n+          },\n+          {\n+            name: expect.stringMatching(/^vercel\\.[0-9a-f]{16}\\.png$/),\n+            filePath: expect.stringMatching(\n+              /^server\\/edge-chunks\\/asset_vercel/\n+            ),\n+          },\n+          {\n+            name: expect.stringMatching(/^world\\.[0-9a-f]{16}\\.json/),\n+            filePath: expect.stringMatching(\n+              /^server\\/edge-chunks\\/asset_world/\n+            ),\n+          },\n+        ])\n+      }\n+    })\n+  }\n })"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 90,
        "deletions": 62
    }
}