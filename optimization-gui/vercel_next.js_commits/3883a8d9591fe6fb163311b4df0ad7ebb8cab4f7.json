{
    "author": "mischnic",
    "message": "Turbopack: disable tree shaking for tracing (#85722)\n\nWe had tree shaking enabled for NFT.\nThat is incorrect however, as even unused imports (if you don't use any of the imported bindings, and the file is marked as `sideEffects: false`) are still needed at runtime, since Node.js will execute everything anyway.\n\n- I made the `treeShakingMode: None` explicit now (though that was already the `Default::default` anyway)\n- The real problem was that we still dropped side-effect free `ModulePart::Evaluation` references even when tree shaking was disabled.\n\nCloses #85172\nFixes PACK-5756",
    "sha": "3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
    "files": [
        {
            "sha": "0facb2f8c269ddfb2edd99e8263b568745136593",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/app/layout.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Flayout.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <head></head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b90cdb9a6ac8a33ce5867abb11e83b3beb441ddc",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/app/page.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fapp%2Fpage.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,5 @@\n+import getValue from 'foo'\n+\n+export default function Page() {\n+  return <p>{getValue()}</p>\n+}"
        },
        {
            "sha": "b20b47602d78583a7b84fceaab6df9c2f526d4f5",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/foo/index.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Findex.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,6 @@\n+import value from './value.js'\n+import './side-effect.js'\n+\n+export default function getValue() {\n+  return value\n+}"
        },
        {
            "sha": "8ed9fa027e5345c3ee7698c129a42cc712a62c1d",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/foo/package.json",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fpackage.json?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,6 @@\n+{\n+  \"name\": \"foo\",\n+  \"type\": \"module\",\n+  \"version\": \"0.0.0\",\n+  \"sideEffects\": false\n+}"
        },
        {
            "sha": "128b0932b9edd1f8a8f2b66df8ec468786a7af68",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/foo/side-effect.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fside-effect.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fside-effect.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fside-effect.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1 @@\n+// some noop, should still resolve and not crash though"
        },
        {
            "sha": "fb5230a12964faf08682fd17f42ad8aad2de7437",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/foo/value.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fvalue.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fvalue.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ffoo%2Fvalue.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1 @@\n+export default 123"
        },
        {
            "sha": "842df636765431641c9b3bff7a384958f2d0c0b7",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fnext.config.js?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,8 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  serverExternalPackages: ['foo'],\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "2511e3bc7558fc3f72727730a56cdf486f449e66",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/package.json",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Fpackage.json?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"dependencies\": {\n+    \"foo\": \"file:./foo\"\n+  }\n+}"
        },
        {
            "sha": "c9a462d36c3a0b03a2725445891c6c35c71e3181",
            "filename": "test/production/standalone-mode/tracing-side-effects-false/tracing-side-effects-false.test.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ftracing-side-effects-false.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ftracing-side-effects-false.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing-side-effects-false%2Ftracing-side-effects-false.test.ts?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -0,0 +1,36 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('standalone mode - tracing-side-effects-false', () => {\n+  const dependencies = require('./package.json').dependencies\n+\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    dependencies,\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should trace sideeffect imports even when sideEffects is false', async () => {\n+    let { exitCode } = await next.build()\n+    expect(exitCode).toBe(0)\n+\n+    let trace = await next.readJSON('.next/server/app/page.js.nft.json')\n+\n+    expect(trace.files).toContainEqual(\n+      expect.stringMatching(/node_modules\\/foo\\/index\\.js$/)\n+    )\n+    expect(trace.files).toContainEqual(\n+      expect.stringMatching(/node_modules\\/foo\\/package\\.json$/)\n+    )\n+    expect(trace.files).toContainEqual(\n+      expect.stringMatching(/node_modules\\/foo\\/side-effect\\.js$/)\n+    )\n+    expect(trace.files).toContainEqual(\n+      expect.stringMatching(/node_modules\\/foo\\/value\\.js$/)\n+    )\n+  })\n+})"
        },
        {
            "sha": "60160f950d5acdfac5ee7b6ab2e5e853f8109a5a",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -86,7 +86,11 @@ async fn setup(\n         ResolvedVc::upcast(module_asset_context),\n         EcmascriptInputTransforms::empty().to_resolved().await?,\n         EcmascriptOptions {\n-            tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n+            tree_shaking_mode: if analyze_mode == AnalyzeMode::Tracing {\n+                None\n+            } else {\n+                Some(TreeShakingMode::ReexportsOnly)\n+            },\n             analyze_mode,\n             ..Default::default()\n         }"
        },
        {
            "sha": "4d77e9346f7dc8b9f61053f583f1140098f59462",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -168,8 +168,8 @@ pub enum SpecifiedModuleType {\n )]\n #[serde(rename_all = \"kebab-case\")]\n pub enum TreeShakingMode {\n-    #[default]\n     ModuleFragments,\n+    #[default]\n     ReexportsOnly,\n }\n "
        },
        {
            "sha": "21e84d43142a59268f061990ad4eb730dc44ecf3",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -79,8 +79,10 @@ async fn node_file_trace_operation(\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),\n         // This config should be kept in sync with\n-        // turbopack/crates/turbopack/tests/node-file-trace.rs and\n-        // turbopack/crates/turbopack/src/lib.rs\n+        // turbopack/crates/turbopack-tracing/tests/node-file-trace.rs and\n+        // turbopack/crates/turbopack-tracing/tests/unit.rs and\n+        // turbopack/crates/turbopack/src/lib.rs and\n+        // turbopack/crates/turbopack-nft/src/nft.rs\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n@@ -97,6 +99,9 @@ async fn node_file_trace_operation(\n             // node-file-trace.\n             environment: None,\n             analyze_mode: AnalyzeMode::Tracing,\n+            // Disable tree shaking. Even side-effect-free imports need to be traced, as they will\n+            // execute at runtime.\n+            tree_shaking_mode: None,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "9a66bbd74dfc3a8a112f4a919fb734de9f07a41a",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -361,8 +361,11 @@ async fn node_file_trace_operation(\n         Default::default(),\n         // TODO These test cases should move into the `node-file-trace` crate and use the same\n         // config.\n-        // It's easy to make a mistake here as this should match the config in the binary from\n-        // turbopack/crates/turbopack/src/lib.rs\n+        // This config should be kept in sync with\n+        // turbopack/crates/turbopack-tracing/tests/node-file-trace.rs and\n+        // turbopack/crates/turbopack-tracing/tests/unit.rs and\n+        // turbopack/crates/turbopack/src/lib.rs and\n+        // turbopack/crates/turbopack-nft/src/nft.rs\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n@@ -380,6 +383,9 @@ async fn node_file_trace_operation(\n             // node-file-trace.\n             environment: None,\n             analyze_mode: AnalyzeMode::Tracing,\n+            // Disable tree shaking. Even side-effect-free imports need to be traced, as they will\n+            // execute at runtime.\n+            tree_shaking_mode: None,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "9620a480ce3aae52905a7392f88268e24f0af6a6",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -198,8 +198,11 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n         Default::default(),\n         // TODO These test cases should move into the `node-file-trace` crate and use the same\n         // config.\n-        // It's easy to make a mistake here as this should match the config in the binary from\n-        // turbopack/crates/turbopack/src/lib.rs\n+        // This config should be kept in sync with\n+        // turbopack/crates/turbopack-tracing/tests/node-file-trace.rs and\n+        // turbopack/crates/turbopack-tracing/tests/unit.rs and\n+        // turbopack/crates/turbopack/src/lib.rs and\n+        // turbopack/crates/turbopack-nft/src/nft.rs\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n@@ -216,6 +219,9 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n             // node-file-trace.\n             environment: None,\n             analyze_mode: AnalyzeMode::Tracing,\n+            // Disable tree shaking. Even side-effect-free imports need to be traced, as they will\n+            // execute at runtime.\n+            tree_shaking_mode: None,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "3cfd86d794f56eecdc0e7996a4ce0c38d99253a1",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=3883a8d9591fe6fb163311b4df0ad7ebb8cab4f7",
            "patch": "@@ -166,8 +166,12 @@ async fn apply_module_type(\n             if runtime_code {\n                 ResolvedVc::upcast(module)\n             } else {\n-                if matches!(&part, Some(ModulePart::Evaluation)) {\n-                    // Skip the evaluation part if the module is marked as side effect free.\n+                let options_value = options.await?;\n+                if options_value.tree_shaking_mode.is_some()\n+                    && matches!(&part, Some(ModulePart::Evaluation))\n+                {\n+                    // If we are tree shaking, skip the evaluation part if the module is marked as\n+                    // side effect free.\n                     let side_effect_free_packages = module_asset_context\n                         .side_effect_free_packages()\n                         .resolve()\n@@ -181,7 +185,6 @@ async fn apply_module_type(\n                     }\n                 }\n \n-                let options_value = options.await?;\n                 match options_value.tree_shaking_mode {\n                     Some(TreeShakingMode::ModuleFragments) => {\n                         Vc::upcast(EcmascriptModulePartAsset::select_part(\n@@ -740,9 +743,11 @@ pub async fn externals_tracing_module_context(\n     Ok(ModuleAssetContext::new_without_replace_externals(\n         Default::default(),\n         compile_time_info,\n-        // Keep these options more or less in sync with\n-        // turbopack/crates/turbopack/tests/node-file-trace.rs to ensure that the NFT unit tests\n-        // are actually representative of what Turbopack does.\n+        // This config should be kept in sync with\n+        // turbopack/crates/turbopack-tracing/tests/node-file-trace.rs and\n+        // turbopack/crates/turbopack-tracing/tests/unit.rs and\n+        // turbopack/crates/turbopack/src/lib.rs and\n+        // turbopack/crates/turbopack-nft/src/nft.rs\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n                 enable_typescript_transform: Some(\n@@ -762,6 +767,9 @@ pub async fn externals_tracing_module_context(\n             // node-file-trace.\n             environment: None,\n             analyze_mode: AnalyzeMode::Tracing,\n+            // Disable tree shaking. Even side-effect-free imports need to be traced, as they will\n+            // execute at runtime.\n+            tree_shaking_mode: None,\n             ..Default::default()\n         }\n         .cell(),"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 119,
        "deletions": 14
    }
}