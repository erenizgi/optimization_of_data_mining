{
    "author": "mischnic",
    "message": "Turbopack: trace fs-extra calls (#84246)\n\nThis is supported by https://github.com/vercel/nft/",
    "sha": "5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
    "files": [
        {
            "sha": "2468b3cb71f1fc3fc81090d5fa1735d4e0f14731",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
            "patch": "@@ -1772,6 +1772,10 @@ impl JsValue {\n                         \"fs\",\n                         \"The Node.js fs module: https://nodejs.org/api/fs.html\",\n                     ),\n+                    WellKnownObjectKind::FsExtraModule | WellKnownObjectKind::FsExtraModuleDefault => (\n+                        \"fs-extra\",\n+                        \"The Node.js fs-extra module: https://github.com/jprichardson/node-fs-extra\",\n+                    ),\n                     WellKnownObjectKind::FsModulePromises => (\n                         \"fs/promises\",\n                         \"The Node.js fs module: https://nodejs.org/api/fs.html#promises-api\",\n@@ -3450,6 +3454,8 @@ pub enum WellKnownObjectKind {\n     FsModule,\n     FsModuleDefault,\n     FsModulePromises,\n+    FsExtraModule,\n+    FsExtraModuleDefault,\n     UrlModule,\n     UrlModuleDefault,\n     ChildProcess,"
        },
        {
            "sha": "039b82a25f13c69044cc94ad9786d3d62207ec22",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/well_known.rs",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs?ref=5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
            "patch": "@@ -600,6 +600,9 @@ async fn well_known_object_member(\n         WellKnownObjectKind::FsModule\n         | WellKnownObjectKind::FsModuleDefault\n         | WellKnownObjectKind::FsModulePromises => fs_module_member(kind, prop),\n+        WellKnownObjectKind::FsExtraModule | WellKnownObjectKind::FsExtraModuleDefault => {\n+            fs_extra_module_member(kind, prop)\n+        }\n         WellKnownObjectKind::UrlModule | WellKnownObjectKind::UrlModuleDefault => {\n             url_module_member(kind, prop)\n         }\n@@ -693,6 +696,45 @@ fn fs_module_member(kind: WellKnownObjectKind, prop: JsValue) -> JsValue {\n     )\n }\n \n+fn fs_extra_module_member(kind: WellKnownObjectKind, prop: JsValue) -> JsValue {\n+    if let Some(word) = prop.as_str() {\n+        match (kind, word) {\n+            // regular fs methods\n+            (\n+                ..,\n+                \"realpath\" | \"realpathSync\" | \"stat\" | \"statSync\" | \"existsSync\"\n+                | \"createReadStream\" | \"exists\" | \"open\" | \"openSync\" | \"readFile\" | \"readFileSync\",\n+            ) => {\n+                return JsValue::WellKnownFunction(WellKnownFunctionKind::FsReadMethod(\n+                    word.into(),\n+                ));\n+            }\n+            // fs-extra specific\n+            (\n+                ..,\n+                \"pathExists\" | \"pathExistsSync\" | \"readJson\" | \"readJSON\" | \"readJsonSync\"\n+                | \"readJSONSync\",\n+            ) => {\n+                return JsValue::WellKnownFunction(WellKnownFunctionKind::FsReadMethod(\n+                    word.into(),\n+                ));\n+            }\n+            (WellKnownObjectKind::FsExtraModule, \"default\") => {\n+                return JsValue::WellKnownObject(WellKnownObjectKind::FsExtraModuleDefault);\n+            }\n+            _ => {}\n+        }\n+    }\n+    JsValue::unknown(\n+        JsValue::member(\n+            Box::new(JsValue::WellKnownObject(WellKnownObjectKind::FsExtraModule)),\n+            Box::new(prop),\n+        ),\n+        true,\n+        \"unsupported property on fs-extra module\",\n+    )\n+}\n+\n fn url_module_member(kind: WellKnownObjectKind, prop: JsValue) -> JsValue {\n     match (kind, prop.as_str()) {\n         (.., Some(\"pathToFileURL\")) => {"
        },
        {
            "sha": "a541b260f55a4f27ddc9d4bfcca68245d45cc83e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/utils.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs?ref=5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
            "patch": "@@ -214,6 +214,7 @@ pub fn module_value_to_well_known_object(module_value: &ModuleValue) -> Option<J\n         }\n         \"resolve-from\" => JsValue::WellKnownFunction(WellKnownFunctionKind::NodeResolveFrom),\n         \"@grpc/proto-loader\" => JsValue::WellKnownObject(WellKnownObjectKind::NodeProtobufLoader),\n+        \"fs-extra\" => JsValue::WellKnownObject(WellKnownObjectKind::FsExtraModule),\n         _ => return None,\n     })\n }"
        },
        {
            "sha": "a9acfbc9a379c01439806b56a614a3a9c3752d1c",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace/test/unit/asset-fs-extra/output.js",
            "status": "modified",
            "additions": 39,
            "deletions": 39,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace%2Ftest%2Funit%2Fasset-fs-extra%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace%2Ftest%2Funit%2Fasset-fs-extra%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace%2Ftest%2Funit%2Fasset-fs-extra%2Foutput.js?ref=5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
            "patch": "@@ -1,43 +1,43 @@\n ;[\n-  'node_modules/fs-extra/lib/copy/copy-sync.js',\n-  'node_modules/fs-extra/lib/copy/copy.js',\n-  'node_modules/fs-extra/lib/copy/index.js',\n-  'node_modules/fs-extra/lib/empty/index.js',\n-  'node_modules/fs-extra/lib/ensure/file.js',\n-  'node_modules/fs-extra/lib/ensure/index.js',\n-  'node_modules/fs-extra/lib/ensure/link.js',\n-  'node_modules/fs-extra/lib/ensure/symlink-paths.js',\n-  'node_modules/fs-extra/lib/ensure/symlink-type.js',\n-  'node_modules/fs-extra/lib/ensure/symlink.js',\n-  'node_modules/fs-extra/lib/fs/index.js',\n-  'node_modules/fs-extra/lib/index.js',\n-  'node_modules/fs-extra/lib/json/index.js',\n-  'node_modules/fs-extra/lib/json/jsonfile.js',\n-  'node_modules/fs-extra/lib/json/output-json-sync.js',\n-  'node_modules/fs-extra/lib/json/output-json.js',\n-  'node_modules/fs-extra/lib/mkdirs/index.js',\n-  'node_modules/fs-extra/lib/mkdirs/make-dir.js',\n-  'node_modules/fs-extra/lib/mkdirs/utils.js',\n-  'node_modules/fs-extra/lib/move/index.js',\n-  'node_modules/fs-extra/lib/move/move-sync.js',\n-  'node_modules/fs-extra/lib/move/move.js',\n-  'node_modules/fs-extra/lib/output-file/index.js',\n-  'node_modules/fs-extra/lib/path-exists/index.js',\n-  'node_modules/fs-extra/lib/remove/index.js',\n-  'node_modules/fs-extra/lib/remove/rimraf.js',\n-  'node_modules/fs-extra/lib/util/stat.js',\n-  'node_modules/fs-extra/lib/util/utimes.js',\n-  'node_modules/fs-extra/package.json',\n-  'node_modules/graceful-fs/clone.js',\n-  'node_modules/graceful-fs/graceful-fs.js',\n-  'node_modules/graceful-fs/legacy-streams.js',\n-  'node_modules/graceful-fs/package.json',\n-  'node_modules/graceful-fs/polyfills.js',\n-  'node_modules/jsonfile/index.js',\n-  'node_modules/jsonfile/package.json',\n-  'node_modules/jsonfile/utils.js',\n-  'node_modules/universalify/index.js',\n-  'node_modules/universalify/package.json',\n+  // 'node_modules/fs-extra/lib/copy/copy-sync.js',\n+  // 'node_modules/fs-extra/lib/copy/copy.js',\n+  // 'node_modules/fs-extra/lib/copy/index.js',\n+  // 'node_modules/fs-extra/lib/empty/index.js',\n+  // 'node_modules/fs-extra/lib/ensure/file.js',\n+  // 'node_modules/fs-extra/lib/ensure/index.js',\n+  // 'node_modules/fs-extra/lib/ensure/link.js',\n+  // 'node_modules/fs-extra/lib/ensure/symlink-paths.js',\n+  // 'node_modules/fs-extra/lib/ensure/symlink-type.js',\n+  // 'node_modules/fs-extra/lib/ensure/symlink.js',\n+  // 'node_modules/fs-extra/lib/fs/index.js',\n+  // 'node_modules/fs-extra/lib/index.js',\n+  // 'node_modules/fs-extra/lib/json/index.js',\n+  // 'node_modules/fs-extra/lib/json/jsonfile.js',\n+  // 'node_modules/fs-extra/lib/json/output-json-sync.js',\n+  // 'node_modules/fs-extra/lib/json/output-json.js',\n+  // 'node_modules/fs-extra/lib/mkdirs/index.js',\n+  // 'node_modules/fs-extra/lib/mkdirs/make-dir.js',\n+  // 'node_modules/fs-extra/lib/mkdirs/utils.js',\n+  // 'node_modules/fs-extra/lib/move/index.js',\n+  // 'node_modules/fs-extra/lib/move/move-sync.js',\n+  // 'node_modules/fs-extra/lib/move/move.js',\n+  // 'node_modules/fs-extra/lib/output-file/index.js',\n+  // 'node_modules/fs-extra/lib/path-exists/index.js',\n+  // 'node_modules/fs-extra/lib/remove/index.js',\n+  // 'node_modules/fs-extra/lib/remove/rimraf.js',\n+  // 'node_modules/fs-extra/lib/util/stat.js',\n+  // 'node_modules/fs-extra/lib/util/utimes.js',\n+  // 'node_modules/fs-extra/package.json',\n+  // 'node_modules/graceful-fs/clone.js',\n+  // 'node_modules/graceful-fs/graceful-fs.js',\n+  // 'node_modules/graceful-fs/legacy-streams.js',\n+  // 'node_modules/graceful-fs/package.json',\n+  // 'node_modules/graceful-fs/polyfills.js',\n+  // 'node_modules/jsonfile/index.js',\n+  // 'node_modules/jsonfile/package.json',\n+  // 'node_modules/jsonfile/utils.js',\n+  // 'node_modules/universalify/index.js',\n+  // 'node_modules/universalify/package.json',\n   'package.json',\n   'test/unit/asset-fs-extra/asset1.txt',\n   'test/unit/asset-fs-extra/asset2.json',"
        },
        {
            "sha": "455fe9038f19b637c7b4e7e9d273c1724e35e5bd",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=5ff4a9c520a78cbd8bd4bdd2ca4e4b3cbe6e8b60",
            "patch": "@@ -44,12 +44,13 @@ static ALLOC: turbo_tasks_malloc::TurboMalloc = turbo_tasks_malloc::TurboMalloc;\n // TODO fix failures\n #[rstest]\n #[case::amd_disable(\"amd-disable\")]\n-// #[case::array_emission(\"array-emission\")]\n+#[case::array_emission(\"array-emission\")]\n #[case::array_holes(\"array-holes\")]\n+// Ternary currently becomes Unknown as opposed to Alternatives when the condition isn't static\n // #[case::asset_conditional(\"asset-conditional\")]\n #[case::asset_fs_array_expr(\"asset-fs-array-expr\")]\n #[case::asset_fs_array_expr_node_prefix(\"asset-fs-array-expr-node-prefix\")]\n-// #[case::asset_fs_extra(\"asset-fs-extra\")]\n+#[case::asset_fs_extra(\"asset-fs-extra\")]\n #[case::asset_fs_inline_path_babel(\"asset-fs-inline-path-babel\")]\n #[case::asset_fs_inline_path_enc_es(\"asset-fs-inline-path-enc-es\")]\n #[case::asset_fs_inline_path_enc_es_2(\"asset-fs-inline-path-enc-es-2\")]\n@@ -273,6 +274,8 @@ async fn to_list(assets: Vec<ResolvedVc<Box<dyn OutputAsset>>>) -> Result<Vec<Rc\n }\n \n static TRAILING_COMMA: LazyLock<Regex> = LazyLock::new(|| Regex::new(r\",[\\s\\n]*\\]\").unwrap());\n+static LINE_COMMENTS_COMMA: LazyLock<Regex> =\n+    LazyLock::new(|| Regex::new(r\"(?m)^\\s*//.*$\").unwrap());\n \n fn node_file_trace(input_path: &str) -> Result<()> {\n     let r = &mut {\n@@ -305,8 +308,9 @@ fn node_file_trace(input_path: &str) -> Result<()> {\n \n             let reference = std::fs::read_to_string(reference)?;\n             // crude JS -> JSON conversion\n-            let reference = TRAILING_COMMA\n-                .replace(&reference, \"]\")\n+            let reference = TRAILING_COMMA.replace(&reference, \"]\");\n+            let reference = LINE_COMMENTS_COMMA\n+                .replace_all(&reference, \"\")\n                 .replace(\";\", \"\")\n                 .replace('\\'', \"\\\"\");\n             let reference = serde_json::from_str::<Vec<String>>(&reference)?"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 96,
        "deletions": 43
    }
}