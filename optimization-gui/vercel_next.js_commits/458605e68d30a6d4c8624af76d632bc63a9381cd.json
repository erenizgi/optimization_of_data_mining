{
    "author": "yiminghe",
    "message": "fix: ensure onRequestError is invoked when otel enabled (#83343)\n\nCo-authored-by: Jiachi Liu <inbox@huozhi.im>",
    "sha": "458605e68d30a6d4c8624af76d632bc63a9381cd",
    "files": [
        {
            "sha": "47c3b8823b859b4af63e38642042894825701d27",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -1407,8 +1407,7 @@ export async function handler(\n       )\n     }\n   } catch (err) {\n-    // if we aren't wrapped by base-server handle here\n-    if (!activeSpan && !(err instanceof NoFallbackError)) {\n+    if (!(err instanceof NoFallbackError)) {\n       await routeModule.onRequestError(\n         req,\n         err,"
        },
        {
            "sha": "57cbc4cddaaa8017a3a54a9e6a05fb74f0795a2c",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -466,8 +466,7 @@ export async function handler(\n       )\n     }\n   } catch (err) {\n-    // if we aren't wrapped by base-server handle here\n-    if (!activeSpan && !(err instanceof NoFallbackError)) {\n+    if (!(err instanceof NoFallbackError)) {\n       await routeModule.onRequestError(req, err, {\n         routerKind: 'App Router',\n         routePath: normalizedSrcPage,"
        },
        {
            "sha": "82ba5b004e6a1bfa34a990d07e1e8f7838acce6f",
            "filename": "test/e2e/on-request-error/otel/app/app-route/route.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fapp-route%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fapp-route%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fapp-route%2Froute.js?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export async function GET() {\n+  await connection()\n+  throw new Error('route-node-error')\n+}"
        },
        {
            "sha": "3f7086f24a6632d70815badd23b7faaebbddff22",
            "filename": "test/e2e/on-request-error/otel/app/layout.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Flayout.js?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,11 @@\n+import { Suspense } from 'react'\n+\n+export default function Layout({ children }) {\n+  return (\n+    <html>\n+      <body>\n+        <Suspense>{children}</Suspense>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "bc4bb64cbb5257a38b739d8948bde72e9c015527",
            "filename": "test/e2e/on-request-error/otel/app/server-page/page.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fserver-page%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fserver-page%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fserver-page%2Fpage.js?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  throw new Error('server-page-node-error')\n+}"
        },
        {
            "sha": "62b11b6617cd887af8c50de3cf279e1f153f578f",
            "filename": "test/e2e/on-request-error/otel/app/write-log/route.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fwrite-log%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fwrite-log%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Fapp%2Fwrite-log%2Froute.js?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,40 @@\n+import fs from 'fs'\n+import fsp from 'fs/promises'\n+import path from 'path'\n+\n+const dir = path.join(path.dirname(new URL(import.meta.url).pathname), '../..')\n+const logPath = path.join(dir, 'output-log.json')\n+\n+export async function POST(req) {\n+  let payloadString = ''\n+  const decoder = new TextDecoder()\n+  const reader = req.clone().body.getReader()\n+  while (true) {\n+    const { done, value } = await reader.read()\n+    if (done) {\n+      break\n+    }\n+\n+    payloadString += decoder.decode(value)\n+  }\n+\n+  const payload = JSON.parse(payloadString)\n+\n+  const json = fs.existsSync(logPath)\n+    ? JSON.parse(await fsp.readFile(logPath, 'utf8'))\n+    : {}\n+\n+  if (!json[payload.message]) {\n+    json[payload.message] = {\n+      payload,\n+      count: 1,\n+    }\n+  } else {\n+    json[payload.message].count++\n+  }\n+\n+  await fsp.writeFile(logPath, JSON.stringify(json, null, 2), 'utf8')\n+\n+  console.log(`[instrumentation] write-log:${payload.message}`)\n+  return new Response(null, { status: 204 })\n+}"
        },
        {
            "sha": "7ceeee6f459ee220f209f043116ccc05dd2cc159",
            "filename": "test/e2e/on-request-error/otel/instrumentation.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Finstrumentation.js",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Finstrumentation.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Finstrumentation.js?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,21 @@\n+import { registerOTel } from '@vercel/otel'\n+\n+export const onRequestError = async (err, request, context) => {\n+  await fetch(`http://localhost:${process.env.PORT}/write-log`, {\n+    method: 'POST',\n+    body: JSON.stringify({\n+      message: err.message,\n+      request,\n+      context,\n+    }),\n+    headers: {\n+      'Content-Type': 'application/json',\n+    },\n+  })\n+}\n+\n+export function register() {\n+  registerOTel({\n+    serviceName: 'test',\n+  })\n+}"
        },
        {
            "sha": "102bcd2ae613ba2d27e99ac1031131b0f3586e77",
            "filename": "test/e2e/on-request-error/otel/otel.test.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fotel.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/458605e68d30a6d4c8624af76d632bc63a9381cd/test%2Fe2e%2Fon-request-error%2Fotel%2Fotel.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fon-request-error%2Fotel%2Fotel.test.ts?ref=458605e68d30a6d4c8624af76d632bc63a9381cd",
            "patch": "@@ -0,0 +1,83 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+import { getOutputLogJson } from '../_testing/utils'\n+\n+describe('on-request-error - otel', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    packageJson: {\n+      dependencies: {\n+        '@vercel/otel': '^1.13.0',\n+      },\n+    },\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  const outputLogPath = 'output-log.json'\n+\n+  async function validateErrorRecord({\n+    errorMessage,\n+    url,\n+    renderSource,\n+  }: {\n+    errorMessage: string\n+    url: string\n+    renderSource: string | undefined\n+  }) {\n+    // Assert the instrumentation is called\n+    await retry(async () => {\n+      const recordLogLines = next.cliOutput\n+        .split('\\n')\n+        .filter((log) => log.includes('[instrumentation] write-log'))\n+      expect(recordLogLines).toEqual(\n+        expect.arrayContaining([expect.stringContaining(errorMessage)])\n+      )\n+      // TODO: remove custom duration in case we increase the default.\n+    }, 5000)\n+\n+    const json = await getOutputLogJson(next, outputLogPath)\n+    const record = json[errorMessage]\n+\n+    const { payload } = record\n+    const { request } = payload\n+\n+    expect(request.path).toBe(url)\n+    expect(record).toMatchObject({\n+      count: 1,\n+      payload: {\n+        message: errorMessage,\n+        request: { method: 'GET', headers: { accept: '*/*' } },\n+        ...(renderSource ? { context: { renderSource } } : undefined),\n+      },\n+    })\n+  }\n+\n+  beforeAll(async () => {\n+    await next.patchFile(outputLogPath, '{}')\n+  })\n+\n+  describe('app router', () => {\n+    it('should catch server component page error in node runtime', async () => {\n+      await next.fetch('/server-page')\n+      await validateErrorRecord({\n+        errorMessage: 'server-page-node-error',\n+        url: '/server-page',\n+        renderSource: 'react-server-components',\n+      })\n+    })\n+\n+    it('should catch app routes error in node runtime', async () => {\n+      await next.fetch('/app-route')\n+\n+      await validateErrorRecord({\n+        errorMessage: 'route-node-error',\n+        url: '/app-route',\n+        renderSource: undefined,\n+      })\n+    })\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 169,
        "deletions": 4
    }
}