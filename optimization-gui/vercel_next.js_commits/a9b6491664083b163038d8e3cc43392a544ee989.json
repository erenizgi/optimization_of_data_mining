{
    "author": "mischnic",
    "message": "Unflake required-server-files-ssr-404 (#86515)\n\nmigrate to make it isolated",
    "sha": "a9b6491664083b163038d8e3cc43392a544ee989",
    "files": [
        {
            "sha": "8df1465685f589d2e4707672c7c749f63758d9ab",
            "filename": "test/production/required-server-files-ssr-404/lib/config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Flib%2Fconfig.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Flib%2Fconfig.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Flib%2Fconfig.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/lib/config.js"
        },
        {
            "sha": "31eda49c9ec3922061f6a28cd3b9013547c964be",
            "filename": "test/production/required-server-files-ssr-404/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fnext.config.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/next.config.js"
        },
        {
            "sha": "f78e5cd22ea30641e5931244137e440cc5e2f266",
            "filename": "test/production/required-server-files-ssr-404/pages/404.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F404.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F404.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F404.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/404.js"
        },
        {
            "sha": "9898cbe9722d9ad21937adfc9d0bbc6c22a6a6f5",
            "filename": "test/production/required-server-files-ssr-404/pages/[slug].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F%5Bslug%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/[slug].js"
        },
        {
            "sha": "cad7a555c91334eb23cf2475805766c0eda868be",
            "filename": "test/production/required-server-files-ssr-404/pages/_app.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F_app.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F_app.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2F_app.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/_app.js"
        },
        {
            "sha": "a5395a602d14cf2e5e575b4d2b74d0e4f9e9085e",
            "filename": "test/production/required-server-files-ssr-404/pages/api/optional/[[...rest]].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fapi%2Foptional%2F%5B%5B...rest%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fapi%2Foptional%2F%5B%5B...rest%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fapi%2Foptional%2F%5B%5B...rest%5D%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/api/optional/[[...rest]].js"
        },
        {
            "sha": "c93573368f0e052b82505253f519ff5098f4a59d",
            "filename": "test/production/required-server-files-ssr-404/pages/catch-all/[[...rest]].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fcatch-all%2F%5B%5B...rest%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fcatch-all%2F%5B%5B...rest%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fcatch-all%2F%5B%5B...rest%5D%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/catch-all/[[...rest]].js"
        },
        {
            "sha": "b5a19a314ad080d311ad50bae3f363070aecd36e",
            "filename": "test/production/required-server-files-ssr-404/pages/dynamic/[slug].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fdynamic%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fdynamic%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fdynamic%2F%5Bslug%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/dynamic/[slug].js"
        },
        {
            "sha": "c673c7de83b482410d9a97bafa02889a71ce5fc0",
            "filename": "test/production/required-server-files-ssr-404/pages/errors/gip.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgip.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgip.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgip.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/errors/gip.js"
        },
        {
            "sha": "b696ff821aa7b5027d780feae4abeda8c8777c90",
            "filename": "test/production/required-server-files-ssr-404/pages/errors/gsp/[post].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgsp%2F%5Bpost%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgsp%2F%5Bpost%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgsp%2F%5Bpost%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/errors/gsp/[post].js"
        },
        {
            "sha": "4e1adfa9575fd7aa4517aae57473afdbc5954101",
            "filename": "test/production/required-server-files-ssr-404/pages/errors/gssp.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgssp.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgssp.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ferrors%2Fgssp.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/errors/gssp.js"
        },
        {
            "sha": "518e2e10cafc6bd57042e84fce4a2761d2e0af9b",
            "filename": "test/production/required-server-files-ssr-404/pages/fallback/[slug].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ffallback%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ffallback%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Ffallback%2F%5Bslug%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/fallback/[slug].js"
        },
        {
            "sha": "336a12d7c95b05de30b61618216de424ad39ea07",
            "filename": "test/production/required-server-files-ssr-404/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Findex.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/index.js"
        },
        {
            "sha": "dbe91169f2a77b2e61b367bd7fa536728740054d",
            "filename": "test/production/required-server-files-ssr-404/pages/optional-ssg/[[...rest]].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssg%2F%5B%5B...rest%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssg%2F%5B%5B...rest%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssg%2F%5B%5B...rest%5D%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/optional-ssg/[[...rest]].js"
        },
        {
            "sha": "53a840b79e21d71bab8ca757b4f46d5be4339732",
            "filename": "test/production/required-server-files-ssr-404/pages/optional-ssp/[[...rest]].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssp%2F%5B%5B...rest%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssp%2F%5B%5B...rest%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Foptional-ssp%2F%5B%5B...rest%5D%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/optional-ssp/[[...rest]].js"
        },
        {
            "sha": "52ed2b5d6b81d77ac1a6d7de5b581f905ab42889",
            "filename": "test/production/required-server-files-ssr-404/pages/partial-catch-all/[domain]/[[...rest]].js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fpartial-catch-all%2F%5Bdomain%5D%2F%5B%5B...rest%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fpartial-catch-all%2F%5Bdomain%5D%2F%5B%5B...rest%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Fpages%2Fpartial-catch-all%2F%5Bdomain%5D%2F%5B%5B...rest%5D%5D.js?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "previous_filename": "test/integration/required-server-files-ssr-404/pages/partial-catch-all/[domain]/[[...rest]].js"
        },
        {
            "sha": "0e27bd372e119e263b33f5929d6204a461199479",
            "filename": "test/production/required-server-files-ssr-404/test/index.test.ts",
            "status": "renamed",
            "additions": 33,
            "deletions": 28,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a9b6491664083b163038d8e3cc43392a544ee989/test%2Fproduction%2Frequired-server-files-ssr-404%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Frequired-server-files-ssr-404%2Ftest%2Findex.test.ts?ref=a9b6491664083b163038d8e3cc43392a544ee989",
            "patch": "@@ -4,32 +4,40 @@ import fs from 'fs-extra'\n import { join } from 'path'\n import cheerio from 'cheerio'\n import { nextServer, startApp, waitFor } from 'next-test-utils'\n-import { fetchViaHTTP, nextBuild, renderViaHTTP } from 'next-test-utils'\n-\n-const appDir = join(__dirname, '..')\n-let server\n-let nextApp\n-let appPort\n-let buildId\n-let requiredFilesManifest\n+import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+\n describe('Required Server Files', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n     'production mode',\n     () => {\n+      const { next } = nextTestSetup({\n+        files: join(__dirname, '..'),\n+        env: {\n+          NOW_BUILDER: '1',\n+        },\n+        skipStart: true,\n+      })\n+\n+      let server: Awaited<ReturnType<typeof startApp>>\n+      let appPort: number\n+\n+      let buildId: string\n+      let requiredFilesManifest: any\n+\n+      // This suite unfortunately requires a very bespoke setup to set NEXT_PRIVATE_TEST_HEADERS and\n+      // minimalMode\n       beforeAll(async () => {\n-        await fs.remove(join(appDir, '.next'))\n-        await nextBuild(appDir, undefined, {\n-          env: {\n-            NOW_BUILDER: '1',\n-          },\n-        })\n+        await next.build()\n+        await next.deleteFile('pages')\n+\n+        buildId = (await next.readFile(join('.next/BUILD_ID'))).trim()\n \n-        buildId = await fs.readFile(join(appDir, '.next/BUILD_ID'), 'utf8')\n-        requiredFilesManifest = await fs.readJSON(\n-          join(appDir, '.next/required-server-files.json')\n+        requiredFilesManifest = await next.readJSON(\n+          join('.next/required-server-files.json')\n         )\n \n-        let files = await fs.readdir(join(appDir, '.next'))\n+        let files = await fs.readdir(join(next.testDir, '.next'))\n \n         for (const file of files) {\n           if (\n@@ -40,27 +48,24 @@ describe('Required Server Files', () => {\n             continue\n           }\n           console.log('removing', join('.next', file))\n-          await fs.remove(join(appDir, '.next', file))\n+          await next.deleteFile(join('.next', file))\n         }\n-        await fs.rename(join(appDir, 'pages'), join(appDir, 'pages-bak'))\n \n         process.env.NEXT_PRIVATE_TEST_HEADERS = '1'\n-        nextApp = nextServer({\n+        let nextApp = nextServer({\n           conf: {},\n-          dir: appDir,\n+          dir: next.testDir,\n           quiet: false,\n           minimalMode: true,\n         })\n-\n+        // @ts-expect-error\n         server = await startApp(nextApp)\n+        // @ts-expect-error\n         appPort = server.address().port\n-\n-        console.log(`Listening at ::${appPort}`)\n       })\n       afterAll(async () => {\n         delete process.env.NEXT_PRIVATE_TEST_HEADERS\n         if (server) server.close()\n-        await fs.rename(join(appDir, 'pages-bak'), join(appDir, 'pages'))\n       })\n \n       it('should output required-server-files manifest correctly', async () => {\n@@ -77,10 +82,10 @@ describe('Required Server Files', () => {\n \n         for (const file of requiredFilesManifest.files) {\n           console.log('checking', file)\n-          expect(fs.existsSync(join(appDir, file))).toBe(true)\n+          expect(fs.existsSync(join(next.testDir, file))).toBe(true)\n         }\n \n-        expect(fs.existsSync(join(appDir, '.next/server'))).toBe(true)\n+        expect(fs.existsSync(join(next.testDir, '.next/server'))).toBe(true)\n       })\n \n       it('should render SSR page correctly', async () => {",
            "previous_filename": "test/integration/required-server-files-ssr-404/test/index.test.ts"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 33,
        "deletions": 28
    }
}