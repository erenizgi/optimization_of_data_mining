{
    "author": "lubieowoce",
    "message": "fix hidden errors in router-act (#84603)\n\n`createRouterAct` had a couple places where we create a promise via `new\nPromise(async (resolve) => { ... })` without accounting for the fact\nthat some operations inside can throw, in which case the promise would\nnever resolve. Some tests that use `createRouterAct` like to hang\nmysteriously, and i suspect this might be the reason. This PR changes\nthose places to use an `(async () => { ... })()` IIFE instead.",
    "sha": "15edf7b9865a5ca887d5b9fc4908b7bc121827e8",
    "files": [
        {
            "sha": "fbeb9c3f0075f8d6d55d1128ec7ad6d2595d05da",
            "filename": "test/e2e/app-dir/segment-cache/router-act.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/15edf7b9865a5ca887d5b9fc4908b7bc121827e8/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/15edf7b9865a5ca887d5b9fc4908b7bc121827e8/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts?ref=15edf7b9865a5ca887d5b9fc4908b7bc121827e8",
            "patch": "@@ -159,7 +159,7 @@ export function createRouterAct(\n             // `act` controls the timing of when responses reach the client,\n             // but it should not affect the timing of when requests reach the\n             // server; we pass the request to the server the immediately.\n-            result: new Promise(async (resolve) => {\n+            result: (async () => {\n               const originalResponse = await page.request.fetch(request, {\n                 maxRedirects: 0,\n               })\n@@ -172,13 +172,13 @@ export function createRouterAct(\n               const headers = originalResponse.headers()\n               delete headers['transfer-encoding']\n \n-              resolve({\n+              return {\n                 text: await originalResponse.text(),\n                 body: await originalResponse.body(),\n                 headers,\n                 status: originalResponse.status(),\n-              })\n-            }),\n+              }\n+            })(),\n             didProcess: false,\n           })\n           if (onDidIssueFirstRequest !== null) {\n@@ -417,14 +417,14 @@ ${fulfilled.body}\n                     batch.pendingRequests.add({\n                       url: req.url(),\n                       route: null,\n-                      result: new Promise(async (resolve) => {\n-                        resolve({\n+                      result: (async () => {\n+                        return {\n                           text: await res.text(),\n                           body: await res.body(),\n                           headers: res.headers(),\n                           status: res.status(),\n-                        })\n-                      }),\n+                        }\n+                      })(),\n                       didProcess: false,\n                     })\n                     page.off('response', handleResponse)"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 8,
        "deletions": 8
    }
}