{
    "author": "kdy1",
    "message": "refactor(turbopack): Make `create_visitor` rustfmt-able (#81053)\n\n### What?\n\nMake `create_visitor!` macro work with rustfmt\n\n### Why?\n\nIt's better!\n\n### How?\n\nCloses PACK-4922",
    "sha": "0cfdf50b5ed3964f34b82328baf4bc8270332354",
    "files": [
        {
            "sha": "323f807aec58b635672c8993dbacbd1b0d63396b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/code_gen.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -263,15 +263,15 @@ pub fn path_to(\n /// possible visit methods.\n #[macro_export]\n macro_rules! create_visitor {\n-    (exact $ast_path:expr, $name:ident($arg:ident: &mut $ty:ident) $b:block) => {\n-        $crate::create_visitor!(__ $ast_path.to_vec(), $name($arg: &mut $ty) $b)\n+    (exact, $ast_path:expr, $name:ident, |$arg:ident: &mut $ty:ident| $b:block) => {\n+        $crate::create_visitor!(__ $ast_path.to_vec(), $name, |$arg: &mut $ty| $b)\n     };\n-    ($ast_path:expr, $name:ident($arg:ident: &mut $ty:ident) $b:block) => {\n+    ($ast_path:expr, $name:ident, |$arg:ident: &mut $ty:ident| $b:block) => {\n         $crate::create_visitor!(__ $crate::code_gen::path_to(&$ast_path, |n| {\n             matches!(n, swc_core::ecma::visit::AstParentKind::$ty(_))\n-        }), $name($arg: &mut $ty) $b)\n+        }), $name, |$arg: &mut $ty| $b)\n     };\n-    (__ $ast_path:expr, $name:ident($arg:ident: &mut $ty:ident) $b:block) => {{\n+    (__ $ast_path:expr, $name:ident, |$arg:ident: &mut $ty:ident| $b:block) => {{\n         struct Visitor<T: Fn(&mut swc_core::ecma::ast::$ty) + Send + Sync> {\n             $name: T,\n         }"
        },
        {
            "sha": "14b665233d1af5946c219e16fb673c73875b2c2f",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/amd.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Famd.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -202,11 +202,14 @@ impl AmdDefineWithDependenciesCodeGen {\n \n         let factory_type = self.factory_type;\n \n-        visitors.push(\n-            create_visitor!(exact self.path, visit_mut_call_expr(call_expr: &mut CallExpr) {\n+        visitors.push(create_visitor!(\n+            exact,\n+            self.path,\n+            visit_mut_call_expr,\n+            |call_expr: &mut CallExpr| {\n                 transform_amd_factory(call_expr, &resolved_elements, factory_type)\n-            }),\n-        );\n+            }\n+        ));\n \n         Ok(CodeGeneration::visitors(visitors))\n     }"
        },
        {
            "sha": "1823dd921f54b163d2aa07481d463245b34f4a6b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/cjs.rs",
            "status": "modified",
            "additions": 68,
            "deletions": 53,
            "changes": 121,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fcjs.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -172,29 +172,35 @@ impl CjsRequireAssetReferenceCodeGen {\n         .await?;\n         let mut visitors = Vec::new();\n \n-        visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-            let old_expr = expr.take();\n-            let message = if let Expr::Call(CallExpr { args, ..}) = old_expr {\n-                match args.into_iter().next() {\n-                    Some(ExprOrSpread { spread: None, expr: key_expr }) => {\n-                        *expr = pm.create_require(*key_expr);\n-                        return;\n+        visitors.push(create_visitor!(\n+            self.path,\n+            visit_mut_expr,\n+            |expr: &mut Expr| {\n+                let old_expr = expr.take();\n+                let message = if let Expr::Call(CallExpr { args, .. }) = old_expr {\n+                    match args.into_iter().next() {\n+                        Some(ExprOrSpread {\n+                            spread: None,\n+                            expr: key_expr,\n+                        }) => {\n+                            *expr = pm.create_require(*key_expr);\n+                            return;\n+                        }\n+                        Some(ExprOrSpread {\n+                            spread: Some(_),\n+                            expr: _,\n+                        }) => \"spread operator is not analyse-able in require() expressions.\",\n+                        _ => \"require() expressions require at least 1 argument\",\n                     }\n-                    Some(ExprOrSpread { spread: Some(_), expr: _ }) => {\n-                        \"spread operator is not analyse-able in require() expressions.\"\n-                    }\n-                    _ => {\n-                        \"require() expressions require at least 1 argument\"\n-                    }\n-                }\n-            } else {\n-                \"visitor must be executed on a CallExpr\"\n-            };\n-            *expr = quote!(\n-                \"(() => { throw new Error($message); })()\" as Expr,\n-                message: Expr = Expr::Lit(Lit::Str(message.into()))\n-            );\n-        }));\n+                } else {\n+                    \"visitor must be executed on a CallExpr\"\n+                };\n+                *expr = quote!(\n+                    \"(() => { throw new Error($message); })()\" as Expr,\n+                    message: Expr = Expr::Lit(Lit::Str(message.into()))\n+                );\n+            }\n+        ));\n \n         Ok(CodeGeneration::visitors(visitors))\n     }\n@@ -291,32 +297,37 @@ impl CjsRequireResolveAssetReferenceCodeGen {\n         let mut visitors = Vec::new();\n \n         // Inline the result of the `require.resolve` call as a literal.\n-        visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-            if let Expr::Call(call_expr) = expr {\n-                let args = std::mem::take(&mut call_expr.args);\n-                *expr = match args.into_iter().next() {\n-                    Some(ExprOrSpread { expr, spread: None }) => pm.create_id(*expr),\n-                    other => {\n-                        let message = match other {\n-                            // These are SWC bugs: https://github.com/swc-project/swc/issues/5394\n-                            Some(ExprOrSpread { spread: Some(_), expr: _ }) => {\n-                                \"spread operator is not analyse-able in require() expressions.\"\n-                            }\n-                            _ => {\n-                                \"require() expressions require at least 1 argument\"\n-                            }\n-                        };\n-                        quote!(\n-                            \"(() => { throw new Error($message); })()\" as Expr,\n-                            message: Expr = Expr::Lit(Lit::Str(message.into()))\n-                        )\n-                    },\n-                };\n+        visitors.push(create_visitor!(\n+            self.path,\n+            visit_mut_expr,\n+            |expr: &mut Expr| {\n+                if let Expr::Call(call_expr) = expr {\n+                    let args = std::mem::take(&mut call_expr.args);\n+                    *expr = match args.into_iter().next() {\n+                        Some(ExprOrSpread { expr, spread: None }) => pm.create_id(*expr),\n+                        other => {\n+                            let message = match other {\n+                                // These are SWC bugs: https://github.com/swc-project/swc/issues/5394\n+                                Some(ExprOrSpread {\n+                                    spread: Some(_),\n+                                    expr: _,\n+                                }) => {\n+                                    \"spread operator is not analyse-able in require() expressions.\"\n+                                }\n+                                _ => \"require() expressions require at least 1 argument\",\n+                            };\n+                            quote!(\n+                                \"(() => { throw new Error($message); })()\" as Expr,\n+                                message: Expr = Expr::Lit(Lit::Str(message.into()))\n+                            )\n+                        }\n+                    };\n+                }\n+                // CjsRequireResolveAssetReference will only be used for Expr::Call.\n+                // Due to eventual consistency the path might match something else,\n+                // but we can ignore that as it will be recomputed anyway.\n             }\n-            // CjsRequireResolveAssetReference will only be used for Expr::Call.\n-            // Due to eventual consistency the path might match something else,\n-            // but we can ignore that as it will be recomputed anyway.\n-        }));\n+        ));\n \n         Ok(CodeGeneration::visitors(visitors))\n     }\n@@ -338,13 +349,17 @@ impl CjsRequireCacheAccess {\n     ) -> Result<CodeGeneration> {\n         let mut visitors = Vec::new();\n \n-        visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-            if let Expr::Member(_) = expr {\n-                *expr = TURBOPACK_CACHE.into();\n-            } else {\n-                unreachable!(\"`CjsRequireCacheAccess` is only created from `MemberExpr`\");\n+        visitors.push(create_visitor!(\n+            self.path,\n+            visit_mut_expr,\n+            |expr: &mut Expr| {\n+                if let Expr::Member(_) = expr {\n+                    *expr = TURBOPACK_CACHE.into();\n+                } else {\n+                    unreachable!(\"`CjsRequireCacheAccess` is only created from `MemberExpr`\");\n+                }\n             }\n-        }));\n+        ));\n \n         Ok(CodeGeneration::visitors(visitors))\n     }"
        },
        {
            "sha": "8a16439d706de2763043cec4d1166de5b7ea7c9b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/constant_condition.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_condition.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -36,15 +36,24 @@ impl ConstantConditionCodeGen {\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n         let value = self.value;\n-        let visitors = [\n-            create_visitor!(exact self.path, visit_mut_expr(expr: &mut Expr) {\n+        let visitors = [create_visitor!(\n+            exact,\n+            self.path,\n+            visit_mut_expr,\n+            |expr: &mut Expr| {\n                 *expr = match value {\n-                    ConstantConditionValue::Truthy => quote!(\"(\\\"TURBOPACK compile-time truthy\\\", 1)\" as Expr),\n-                    ConstantConditionValue::Falsy => quote!(\"(\\\"TURBOPACK compile-time falsy\\\", 0)\" as Expr),\n-                    ConstantConditionValue::Nullish => quote!(\"(\\\"TURBOPACK compile-time nullish\\\", null)\" as Expr),\n+                    ConstantConditionValue::Truthy => {\n+                        quote!(\"(\\\"TURBOPACK compile-time truthy\\\", 1)\" as Expr)\n+                    }\n+                    ConstantConditionValue::Falsy => {\n+                        quote!(\"(\\\"TURBOPACK compile-time falsy\\\", 0)\" as Expr)\n+                    }\n+                    ConstantConditionValue::Nullish => {\n+                        quote!(\"(\\\"TURBOPACK compile-time nullish\\\", null)\" as Expr)\n+                    }\n                 };\n-            }),\n-        ]\n+            }\n+        )]\n         .into();\n \n         Ok(CodeGeneration::visitors(visitors))"
        },
        {
            "sha": "55b4e0fad41f6d8df0a57bf091f660047b00baa7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/constant_value.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -41,14 +41,24 @@ impl ConstantValueCodeGen {\n     ) -> Result<CodeGeneration> {\n         let value = self.value.clone();\n \n-        let visitor = create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n+        let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n             *expr = match value {\n-                CompileTimeDefineValue::Bool(true) => quote!(\"(\\\"TURBOPACK compile-time value\\\", true)\" as Expr),\n-                CompileTimeDefineValue::Bool(false) => quote!(\"(\\\"TURBOPACK compile-time value\\\", false)\" as Expr),\n-                CompileTimeDefineValue::String(ref s) => quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = s.to_string().into()),\n-                CompileTimeDefineValue::JSON(ref s) => quote!(\"(\\\"TURBOPACK compile-time value\\\", JSON.parse($e))\" as Expr, e: Expr = s.to_string().into()),\n+                CompileTimeDefineValue::Bool(true) => {\n+                    quote!(\"(\\\"TURBOPACK compile-time value\\\", true)\" as Expr)\n+                }\n+                CompileTimeDefineValue::Bool(false) => {\n+                    quote!(\"(\\\"TURBOPACK compile-time value\\\", false)\" as Expr)\n+                }\n+                CompileTimeDefineValue::String(ref s) => {\n+                    quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = s.to_string().into())\n+                }\n+                CompileTimeDefineValue::JSON(ref s) => {\n+                    quote!(\"(\\\"TURBOPACK compile-time value\\\", JSON.parse($e))\" as Expr, e: Expr = s.to_string().into())\n+                }\n                 // undefined can be re-bound, so use `void 0` to avoid any risks\n-                CompileTimeDefineValue::Undefined => quote!(\"(\\\"TURBOPACK compile-time value\\\", void 0)\" as Expr),\n+                CompileTimeDefineValue::Undefined => {\n+                    quote!(\"(\\\"TURBOPACK compile-time value\\\", void 0)\" as Expr)\n+                }\n             };\n         });\n "
        },
        {
            "sha": "b6afc8e587a851745236c338d215cc46fd5f331d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/dynamic_expression.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fdynamic_expression.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -44,13 +44,21 @@ impl DynamicExpression {\n     ) -> Result<CodeGeneration> {\n         let visitor = match self.ty {\n             DynamicExpressionType::Normal => {\n-                create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-                    *expr = quote!(\"(() => { const e = new Error(\\\"Cannot find module as expression is too dynamic\\\"); e.code = 'MODULE_NOT_FOUND'; throw e; })()\" as Expr);\n+                create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n+                    *expr = quote!(\n+                        \"(() => { const e = new Error(\\\"Cannot find module as expression is too \\\n+                         dynamic\\\"); e.code = 'MODULE_NOT_FOUND'; throw e; })()\"\n+                            as Expr\n+                    );\n                 })\n             }\n             DynamicExpressionType::Promise => {\n-                create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-                    *expr = quote!(\"Promise.resolve().then(() => { const e = new Error(\\\"Cannot find module as expression is too dynamic\\\"); e.code = 'MODULE_NOT_FOUND'; throw e; })\" as Expr);\n+                create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n+                    *expr = quote!(\n+                        \"Promise.resolve().then(() => { const e = new Error(\\\"Cannot find module \\\n+                         as expression is too dynamic\\\"); e.code = 'MODULE_NOT_FOUND'; throw e; })\"\n+                            as Expr\n+                    );\n                 })\n             }\n         };"
        },
        {
            "sha": "2c88853dadd2a1a427412e59a7387949fd9a2bc0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/binding.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 15,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbinding.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -87,31 +87,35 @@ impl EsmBinding {\n                 // normal key-value pairs.\n                 Some(swc_core::ecma::visit::AstParentKind::Prop(PropField::Shorthand)) => {\n                     ast_path.pop();\n-                    visitors.push(\n-                        create_visitor!(exact ast_path, visit_mut_prop(prop: &mut Prop) {\n+                    visitors.push(create_visitor!(\n+                        exact,\n+                        ast_path,\n+                        visit_mut_prop,\n+                        |prop: &mut Prop| {\n                             if let Prop::Shorthand(ident) = prop {\n                                 // TODO: Merge with the above condition when https://rust-lang.github.io/rfcs/2497-if-let-chains.html lands.\n                                 match &imported_ident {\n                                     ImportedIdent::Module(imported_ident) => {\n                                         *prop = Prop::KeyValue(KeyValueProp {\n                                             key: PropName::Ident(ident.clone().into()),\n-                                            value: Box::new(imported_ident.as_expr(ident.span, false))\n+                                            value: Box::new(\n+                                                imported_ident.as_expr(ident.span, false),\n+                                            ),\n                                         });\n                                     }\n                                     ImportedIdent::None => {\n                                         *prop = Prop::KeyValue(KeyValueProp {\n                                             key: PropName::Ident(ident.clone().into()),\n-                                            value:\n-                                            Expr::undefined(ident.span),\n+                                            value: Expr::undefined(ident.span),\n                                         });\n                                     }\n                                     ImportedIdent::Unresolvable => {\n                                         // Do nothing, the reference will insert a throw\n                                     }\n                                 }\n                             }\n-                        }),\n-                    );\n+                        }\n+                    ));\n                     break;\n                 }\n                 // Any other expression can be replaced with the import accessor.\n@@ -125,8 +129,11 @@ impl EsmBinding {\n                             ))\n                         );\n \n-                    visitors.push(\n-                        create_visitor!(exact ast_path, visit_mut_expr(expr: &mut Expr) {\n+                    visitors.push(create_visitor!(\n+                        exact,\n+                        ast_path,\n+                        visit_mut_expr,\n+                        |expr: &mut Expr| {\n                             use swc_core::common::Spanned;\n                             match &imported_ident {\n                                 ImportedIdent::Module(imported_ident) => {\n@@ -139,8 +146,8 @@ impl EsmBinding {\n                                     // Do nothing, the reference will insert a throw\n                                 }\n                             }\n-                        }),\n-                    );\n+                        }\n+                    ));\n                     break;\n                 }\n                 Some(swc_core::ecma::visit::AstParentKind::BindingIdent(\n@@ -156,8 +163,11 @@ impl EsmBinding {\n                     {\n                         ast_path.pop();\n \n-                        visitors.push(\n-                            create_visitor!(exact ast_path, visit_mut_simple_assign_target(l: &mut SimpleAssignTarget) {\n+                        visitors.push(create_visitor!(\n+                            exact,\n+                            ast_path,\n+                            visit_mut_simple_assign_target,\n+                            |l: &mut SimpleAssignTarget| {\n                                 use swc_core::common::Spanned;\n                                 match &imported_ident {\n                                     ImportedIdent::Module(imported_ident) => {\n@@ -176,8 +186,8 @@ impl EsmBinding {\n                                         // Do nothing, the reference will insert a throw\n                                     }\n                                 }\n-                            })\n-                        );\n+                            }\n+                        ));\n                         break;\n                     }\n                 }"
        },
        {
            "sha": "fa48481b461b3fd74042c90b37d1aaa1214ba598",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/dynamic.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fdynamic.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -154,21 +154,23 @@ impl EsmAsyncAssetReferenceCodeGen {\n \n         let import_externals = reference.import_externals;\n \n-        let visitor = create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n+        let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n             let old_expr = expr.take();\n-            let message = if let Expr::Call(CallExpr { args, ..}) = old_expr {\n+            let message = if let Expr::Call(CallExpr { args, .. }) = old_expr {\n                 match args.into_iter().next() {\n-                    Some(ExprOrSpread { spread: None, expr: key_expr }) => {\n+                    Some(ExprOrSpread {\n+                        spread: None,\n+                        expr: key_expr,\n+                    }) => {\n                         *expr = pm.create_import(*key_expr, import_externals);\n                         return;\n                     }\n                     // These are SWC bugs: https://github.com/swc-project/swc/issues/5394\n-                    Some(ExprOrSpread { spread: Some(_), expr: _ }) => {\n-                        \"spread operator is illegal in import() expressions.\"\n-                    }\n-                    _ => {\n-                        \"import() expressions require at least 1 argument\"\n-                    }\n+                    Some(ExprOrSpread {\n+                        spread: Some(_),\n+                        expr: _,\n+                    }) => \"spread operator is illegal in import() expressions.\",\n+                    _ => \"import() expressions require at least 1 argument\",\n                 }\n             } else {\n                 \"visitor must be executed on a CallExpr\"\n@@ -184,7 +186,7 @@ impl EsmAsyncAssetReferenceCodeGen {\n                     expr: error,\n                 }],\n                 span: DUMMY_SP,\n-               ..Default::default()\n+                ..Default::default()\n             });\n         });\n "
        },
        {
            "sha": "29f32ba7d147c66527089b21012c6ebf6a0ddba0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/meta.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmeta.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -101,7 +101,7 @@ impl ImportMetaRef {\n         _module_graph: Vc<ModuleGraph>,\n         _chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<CodeGeneration> {\n-        let visitor = create_visitor!(self.ast_path, visit_mut_expr(expr: &mut Expr) {\n+        let visitor = create_visitor!(self.ast_path, visit_mut_expr, |expr: &mut Expr| {\n             *expr = Expr::Ident(meta_ident());\n         });\n "
        },
        {
            "sha": "6c1a41ce1d399ee3ace4d8b76104289d6c3429f4",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/module_id.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_id.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -93,16 +93,24 @@ impl EsmModuleIdAssetReferenceCodeGen {\n         {\n             let id = asset.chunk_item_id(Vc::upcast(chunking_context)).await?;\n             let id = module_id_to_lit(&id);\n-            visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-                *expr = id.clone()\n-            }));\n+            visitors.push(create_visitor!(\n+                self.path,\n+                visit_mut_expr,\n+                |expr: &mut Expr| {\n+                    *expr = id.clone();\n+                }\n+            ));\n         } else {\n             // If the referenced asset can't be found, replace the expression with null.\n             // This can happen if the referenced asset is an external, or doesn't resolve\n             // to anything.\n-            visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-                *expr = quote!(\"null\" as Expr);\n-            }));\n+            visitors.push(create_visitor!(\n+                self.path,\n+                visit_mut_expr,\n+                |expr: &mut Expr| {\n+                    *expr = quote!(\"null\" as Expr);\n+                }\n+            ));\n         }\n \n         Ok(CodeGeneration::visitors(visitors))"
        },
        {
            "sha": "7482a8c38216f1d36f1741f4dd0fbc78b1adf817",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/module_item.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fmodule_item.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -40,7 +40,7 @@ impl EsmModuleItem {\n         let mut visitors = Vec::new();\n \n         visitors.push(\n-            create_visitor!(self.path, visit_mut_module_item(module_item: &mut ModuleItem) {\n+            create_visitor!(self.path, visit_mut_module_item, |module_item: &mut ModuleItem| {\n                 let item = replace(module_item, ModuleItem::Stmt(quote!(\";\" as Stmt)));\n                 if let ModuleItem::ModuleDecl(module_decl) = item {\n                     match module_decl {"
        },
        {
            "sha": "f11c11dca4e574ee52615acb18fe3c7c8681575d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/url.rs",
            "status": "modified",
            "additions": 55,
            "deletions": 23,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Furl.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -196,7 +196,7 @@ impl UrlAssetReferenceCodeGen {\n                         // item, which exports the static asset path to the linked file.\n                         let id = asset.chunk_item_id(Vc::upcast(chunking_context)).await?;\n \n-                        visitors.push(create_visitor!(self.path, visit_mut_expr(new_expr: &mut Expr) {\n+                        visitors.push(create_visitor!(self.path, visit_mut_expr, |new_expr: &mut Expr| {\n                             let should_rewrite_to_relative = if let Expr::New(NewExpr { args: Some(args), .. }) = new_expr {\n                                 matches!(args.first(), Some(ExprOrSpread { .. }))\n                             } else {\n@@ -215,7 +215,7 @@ impl UrlAssetReferenceCodeGen {\n                     }\n                     ReferencedAsset::External(request, ExternalType::Url) => {\n                         let request = request.to_string();\n-                        visitors.push(create_visitor!(self.path, visit_mut_expr(new_expr: &mut Expr) {\n+                        visitors.push(create_visitor!(self.path, visit_mut_expr, |new_expr: &mut Expr| {\n                             let should_rewrite_to_relative = if let Expr::New(NewExpr { args: Some(args), .. }) = new_expr {\n                                 matches!(args.first(), Some(ExprOrSpread { .. }))\n                             } else {\n@@ -283,38 +283,70 @@ impl UrlAssetReferenceCodeGen {\n                             )\n                         };\n \n-                        visitors.push(create_visitor!(self.path, visit_mut_expr(new_expr: &mut Expr) {\n-                            if let Expr::New(NewExpr { args: Some(args), .. }) = new_expr {\n-                                if let Some(ExprOrSpread { box expr, spread: None }) = args.get_mut(0) {\n-                                    *expr = url_segment_resolver.clone();\n-                                }\n+                        visitors.push(create_visitor!(\n+                            self.path,\n+                            visit_mut_expr,\n+                            |new_expr: &mut Expr| {\n+                                if let Expr::New(NewExpr {\n+                                    args: Some(args), ..\n+                                }) = new_expr\n+                                {\n+                                    if let Some(ExprOrSpread {\n+                                        box expr,\n+                                        spread: None,\n+                                    }) = args.get_mut(0)\n+                                    {\n+                                        *expr = url_segment_resolver.clone();\n+                                    }\n \n-                                if let Some(ExprOrSpread { box expr, spread: None }) = args.get_mut(1) {\n-                                    if let Some(rewrite) = &rewrite_url_base {\n-                                        *expr = rewrite.clone();\n-                                    } else {\n-                                        // If rewrite for the base doesn't exists, means __turbopack_resolve_module_id_path__\n-                                        // should resolve the full path correctly and there shouldn't be a base.\n-                                        args.remove(1);\n+                                    if let Some(ExprOrSpread {\n+                                        box expr,\n+                                        spread: None,\n+                                    }) = args.get_mut(1)\n+                                    {\n+                                        if let Some(rewrite) = &rewrite_url_base {\n+                                            *expr = rewrite.clone();\n+                                        } else {\n+                                            // If rewrite for the base doesn't exists, means\n+                                            // __turbopack_resolve_module_id_path__\n+                                            // should resolve the full path correctly and there\n+                                            // shouldn't be a base.\n+                                            args.remove(1);\n+                                        }\n                                     }\n                                 }\n                             }\n-                        }));\n+                        ));\n                     }\n                     ReferencedAsset::External(request, ExternalType::Url) => {\n                         let request = request.to_string();\n-                        visitors.push(create_visitor!(self.path, visit_mut_expr(new_expr: &mut Expr) {\n-                            if let Expr::New(NewExpr { args: Some(args), .. }) = new_expr {\n-                                if let Some(ExprOrSpread { box expr, spread: None }) = args.get_mut(0) {\n-                                    *expr = request.as_str().into()\n-                                }\n+                        visitors.push(create_visitor!(\n+                            self.path,\n+                            visit_mut_expr,\n+                            |new_expr: &mut Expr| {\n+                                if let Expr::New(NewExpr {\n+                                    args: Some(args), ..\n+                                }) = new_expr\n+                                {\n+                                    if let Some(ExprOrSpread {\n+                                        box expr,\n+                                        spread: None,\n+                                    }) = args.get_mut(0)\n+                                    {\n+                                        *expr = request.as_str().into()\n+                                    }\n \n-                                if let Some(rewrite) = &rewrite_url_base\n-                                    && let Some(ExprOrSpread { box expr, spread: None }) = args.get_mut(1) {\n+                                    if let Some(rewrite) = &rewrite_url_base\n+                                        && let Some(ExprOrSpread {\n+                                            box expr,\n+                                            spread: None,\n+                                        }) = args.get_mut(1)\n+                                    {\n                                         *expr = rewrite.clone();\n                                     }\n+                                }\n                             }\n-                        }));\n+                        ));\n                     }\n                     ReferencedAsset::External(request, ty) => {\n                         bail!("
        },
        {
            "sha": "9c6acae4f71597a3b5ff517dc63051b8ff01a687",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/ident.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fident.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -29,7 +29,7 @@ impl IdentReplacement {\n     ) -> Result<CodeGeneration> {\n         let value = self.value.clone();\n \n-        let visitor = create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n+        let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n             let id = Expr::Ident((&*value).into());\n             *expr = quote!(\"(\\\"TURBOPACK ident replacement\\\", $e)\" as Expr, e: Expr = id);\n         });"
        },
        {
            "sha": "a3b0dae6b0e9c16e80a21d2f17de6ee4488577b0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/member.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmember.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -35,7 +35,7 @@ impl MemberReplacement {\n         let key = self.key.clone();\n         let value = self.value.clone();\n \n-        let visitor = create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n+        let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n             let member = Expr::Member(MemberExpr {\n                 span: DUMMY_SP,\n                 obj: Box::new(Expr::Ident((&*key).into())),"
        },
        {
            "sha": "1adfbd68f28d56123e67b390b260bc301a79f019",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/require_context.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Frequire_context.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -325,16 +325,20 @@ impl RequireContextAssetReferenceCodeGen {\n \n         let mut visitors = Vec::new();\n \n-        visitors.push(create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-            if let Expr::Call(_) = expr {\n-                *expr = quote!(\n-                    \"$turbopack_module_context($turbopack_require($id))\" as Expr,\n-                    turbopack_module_context: Expr = TURBOPACK_MODULE_CONTEXT.into(),\n-                    turbopack_require: Expr = TURBOPACK_REQUIRE.into(),\n-                    id: Expr = module_id_to_lit(&module_id)\n-                );\n+        visitors.push(create_visitor!(\n+            self.path,\n+            visit_mut_expr,\n+            |expr: &mut Expr| {\n+                if let Expr::Call(_) = expr {\n+                    *expr = quote!(\n+                        \"$turbopack_module_context($turbopack_require($id))\" as Expr,\n+                        turbopack_module_context: Expr = TURBOPACK_MODULE_CONTEXT.into(),\n+                        turbopack_require: Expr = TURBOPACK_REQUIRE.into(),\n+                        id: Expr = module_id_to_lit(&module_id)\n+                    );\n+                }\n             }\n-        }));\n+        ));\n \n         Ok(CodeGeneration::visitors(visitors))\n     }"
        },
        {
            "sha": "e19bfb70fde23677ccc6e0bbb8627b3476975eb1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/worker.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cfdf50b5ed3964f34b82328baf4bc8270332354/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fworker.rs?ref=0cfdf50b5ed3964f34b82328baf4bc8270332354",
            "patch": "@@ -145,8 +145,8 @@ impl WorkerAssetReferenceCodeGen {\n             .chunk_item_id_from_ident(loader.ident())\n             .await?;\n \n-        let visitor = create_visitor!(self.path, visit_mut_expr(expr: &mut Expr) {\n-            let message = if let Expr::New(NewExpr { args, ..}) = expr {\n+        let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n+            let message = if let Expr::New(NewExpr { args, .. }) = expr {\n                 if let Some(args) = args {\n                     match args.first_mut() {\n                         Some(ExprOrSpread { spread: None, expr }) => {\n@@ -158,21 +158,21 @@ impl WorkerAssetReferenceCodeGen {\n                             );\n \n                             if let Some(opts) = args.get_mut(1)\n-                                && opts.spread.is_none(){\n-                                    *opts.expr = *quote_expr!(\n-                                        \"{...$opts, type: undefined}\",\n-                                        opts: Expr = (*opts.expr).take()\n-                                    );\n-                                }\n+                                && opts.spread.is_none()\n+                            {\n+                                *opts.expr = *quote_expr!(\n+                                    \"{...$opts, type: undefined}\",\n+                                    opts: Expr = (*opts.expr).take()\n+                                );\n+                            }\n                             return;\n                         }\n                         // These are SWC bugs: https://github.com/swc-project/swc/issues/5394\n-                        Some(ExprOrSpread { spread: Some(_), expr: _ }) => {\n-                            \"spread operator is illegal in new Worker() expressions.\"\n-                        }\n-                        _ => {\n-                            \"new Worker() expressions require at least 1 argument\"\n-                        }\n+                        Some(ExprOrSpread {\n+                            spread: Some(_),\n+                            expr: _,\n+                        }) => \"spread operator is illegal in new Worker() expressions.\",\n+                        _ => \"new Worker() expressions require at least 1 argument\",\n                     }\n                 } else {\n                     \"new Worker() expressions require at least 1 argument\""
        }
    ],
    "stats": {
        "total": 421,
        "additions": 261,
        "deletions": 160
    }
}