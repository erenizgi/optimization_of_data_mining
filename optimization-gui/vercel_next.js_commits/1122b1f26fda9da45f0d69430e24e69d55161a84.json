{
    "author": "xusd320",
    "message": "feat(turbopack): improve compile-time define value to support more data types and expr evaluation (#81042)\n\nCo-authored-by: graphite-app[bot] <96075541+graphite-app[bot]@users.noreply.github.com>",
    "sha": "1122b1f26fda9da45f0d69430e24e69d55161a84",
    "files": [
        {
            "sha": "202c18b5fb450fa23bcc484e2e1312605b47e50a",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{future::Future, sync::LazyLock};\n+use std::{str::FromStr, sync::LazyLock};\n \n use anyhow::{Context, Result, bail};\n use regex::Regex;\n@@ -61,13 +61,10 @@ pub fn defines(define_env: &FxIndexMap<RcStr, Option<RcStr>>) -> CompileTimeDefi\n             )\n             .or_insert_with(|| {\n                 if let Some(v) = v {\n-                    let val = serde_json::from_str(v);\n+                    let val = serde_json::Value::from_str(v);\n                     match val {\n-                        Ok(serde_json::Value::Bool(v)) => CompileTimeDefineValue::Bool(v),\n-                        Ok(serde_json::Value::String(v)) => {\n-                            CompileTimeDefineValue::String(v.into())\n-                        }\n-                        _ => CompileTimeDefineValue::JSON(v.clone()),\n+                        Ok(v) => v.into(),\n+                        _ => CompileTimeDefineValue::Evaluate(v.clone()),\n                     }\n                 } else {\n                     CompileTimeDefineValue::Undefined"
        },
        {
            "sha": "206a9ae2ad57c44bc7f6a39e8285a77a1c41ab94",
            "filename": "turbopack/crates/turbo-rcstr/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-rcstr%2Fsrc%2Flib.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -233,6 +233,12 @@ impl AsRef<[u8]> for RcStr {\n     }\n }\n \n+impl From<RcStr> for BytesStr {\n+    fn from(value: RcStr) -> Self {\n+        Self::from_str_slice(value.as_str())\n+    }\n+}\n+\n impl PartialEq<str> for RcStr {\n     fn eq(&self, other: &str) -> bool {\n         self.as_str() == other"
        },
        {
            "sha": "aadef54f7a43760888d632170559a37f52909749",
            "filename": "turbopack/crates/turbopack-core/src/compile_time_info.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{FxIndexMap, NonLocalValue, ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n+use turbo_tasks::{FxIndexMap, NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n \n use crate::environment::Environment;\n@@ -102,12 +102,16 @@ macro_rules! free_var_references {\n // TODO: replace with just a `serde_json::Value`\n // https://linear.app/vercel/issue/WEB-1641/compiletimedefinevalue-should-just-use-serde-jsonvalue\n #[turbo_tasks::value]\n-#[derive(Debug, Clone, Hash, TaskInput)]\n+#[derive(Debug, Clone, Hash)]\n pub enum CompileTimeDefineValue {\n+    Null,\n     Bool(bool),\n+    Number(RcStr),\n     String(RcStr),\n-    JSON(RcStr),\n+    Array(Vec<CompileTimeDefineValue>),\n+    Object(Vec<(RcStr, CompileTimeDefineValue)>),\n     Undefined,\n+    Evaluate(RcStr),\n }\n \n impl From<bool> for CompileTimeDefineValue {\n@@ -136,7 +140,16 @@ impl From<&str> for CompileTimeDefineValue {\n \n impl From<serde_json::Value> for CompileTimeDefineValue {\n     fn from(value: serde_json::Value) -> Self {\n-        Self::JSON(value.to_string().into())\n+        match value {\n+            serde_json::Value::Null => Self::Null,\n+            serde_json::Value::Bool(b) => Self::Bool(b),\n+            serde_json::Value::Number(n) => Self::Number(n.to_string().into()),\n+            serde_json::Value::String(s) => Self::String(s.into()),\n+            serde_json::Value::Array(a) => Self::Array(a.into_iter().map(|i| i.into()).collect()),\n+            serde_json::Value::Object(m) => {\n+                Self::Object(m.into_iter().map(|(k, v)| (k.into(), v.into())).collect())\n+            }\n+        }\n     }\n }\n "
        },
        {
            "sha": "67868db975a5245d4fe8d81e48e1c6053940d36f",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/analyzer.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -57,7 +57,7 @@ pub fn benchmark(c: &mut Criterion) {\n                 program.visit_mut_with(&mut resolver(unresolved_mark, top_level_mark, false));\n \n                 let eval_context = EvalContext::new(\n-                    &program,\n+                    Some(&program),\n                     unresolved_mark,\n                     top_level_mark,\n                     Default::default(),"
        },
        {
            "sha": "0f81df6958ce223ee37f6f13c37d032fa23e0b54",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/graph.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 3,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -4,10 +4,15 @@ use std::{\n     sync::Arc,\n };\n \n+use anyhow::{Ok, Result};\n use rustc_hash::{FxHashMap, FxHashSet};\n use swc_core::{\n     atoms::Atom,\n-    common::{GLOBALS, Mark, Span, Spanned, SyntaxContext, comments::Comments, pass::AstNodePath},\n+    base::try_with_handler,\n+    common::{\n+        GLOBALS, Mark, SourceMap, Span, Spanned, SyntaxContext, comments::Comments,\n+        pass::AstNodePath, sync::Lrc,\n+    },\n     ecma::{\n         ast::*,\n         atoms::atom,\n@@ -26,6 +31,7 @@ use super::{\n use crate::{\n     SpecifiedModuleType,\n     analyzer::{WellKnownObjectKind, is_unresolved},\n+    references::constant_value::parse_single_expr_lit,\n     utils::{AstPathRange, unparen},\n };\n \n@@ -311,7 +317,7 @@ impl EvalContext {\n     /// webpackIgnore or turbopackIgnore comments, you must pass those in,\n     /// since the AST does not include comments by default.\n     pub fn new(\n-        module: &Program,\n+        module: Option<&Program>,\n         unresolved_mark: Mark,\n         top_level_mark: Mark,\n         force_free_values: Arc<FxHashSet<Id>>,\n@@ -321,7 +327,9 @@ impl EvalContext {\n         Self {\n             unresolved_mark,\n             top_level_mark,\n-            imports: ImportMap::analyze(module, source, comments),\n+            imports: module.map_or(ImportMap::default(), |m| {\n+                ImportMap::analyze(m, source, comments)\n+            }),\n             force_free_values,\n         }\n     }\n@@ -719,6 +727,29 @@ impl EvalContext {\n             _ => JsValue::unknown_empty(true, \"unsupported expression\"),\n         }\n     }\n+\n+    pub fn eval_single_expr_lit(expr_lit: RcStr) -> Result<JsValue> {\n+        let cm = Lrc::new(SourceMap::default());\n+\n+        let js_value = try_with_handler(cm, Default::default(), |_| {\n+            GLOBALS.set(&Default::default(), || {\n+                let expr = parse_single_expr_lit(expr_lit);\n+                let eval_context = EvalContext::new(\n+                    None,\n+                    Mark::new(),\n+                    Mark::new(),\n+                    Default::default(),\n+                    None,\n+                    None,\n+                );\n+\n+                Ok(eval_context.eval(&expr))\n+            })\n+        })\n+        .map_err(|e| e.to_pretty_error())?;\n+\n+        Ok(js_value)\n+    }\n }\n \n enum EarlyReturn {"
        },
        {
            "sha": "487aa17e87cebef3ba4ab85bd66db1d018204fe7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 64,
            "deletions": 26,
            "changes": 90,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -33,7 +33,10 @@ use turbopack_core::compile_time_info::{\n \n use self::imports::ImportAnnotations;\n pub(crate) use self::imports::ImportMap;\n-use crate::{references::require_context::RequireContextMap, utils::StringifyJs};\n+use crate::{\n+    analyzer::graph::EvalContext, references::require_context::RequireContextMap,\n+    utils::StringifyJs,\n+};\n \n pub mod builtin;\n pub mod graph;\n@@ -581,38 +584,73 @@ impl From<ConstantValue> for JsValue {\n     }\n }\n \n-impl From<&CompileTimeDefineValue> for JsValue {\n-    fn from(v: &CompileTimeDefineValue) -> Self {\n-        match v {\n-            CompileTimeDefineValue::String(s) => JsValue::Constant(s.as_str().into()),\n-            CompileTimeDefineValue::Bool(b) => JsValue::Constant((*b).into()),\n-            CompileTimeDefineValue::JSON(_) => {\n-                JsValue::unknown_empty(false, \"compile time injected JSON\")\n+impl TryFrom<&CompileTimeDefineValue> for JsValue {\n+    type Error = anyhow::Error;\n+\n+    fn try_from(value: &CompileTimeDefineValue) -> Result<Self> {\n+        match value {\n+            CompileTimeDefineValue::Null => Ok(JsValue::Constant(ConstantValue::Null)),\n+            CompileTimeDefineValue::Bool(b) => Ok(JsValue::Constant((*b).into())),\n+            CompileTimeDefineValue::Number(n) => Ok(JsValue::Constant(ConstantValue::Num(\n+                ConstantNumber(n.as_str().parse::<f64>()?),\n+            ))),\n+            CompileTimeDefineValue::String(s) => Ok(JsValue::Constant(s.as_str().into())),\n+            CompileTimeDefineValue::Array(a) => {\n+                let mut js_value = JsValue::Array {\n+                    total_nodes: a.len() as u32,\n+                    items: a.iter().map(|i| i.try_into()).collect::<Result<Vec<_>>>()?,\n+                    mutable: false,\n+                };\n+                js_value.update_total_nodes();\n+                Ok(js_value)\n             }\n-            CompileTimeDefineValue::Undefined => JsValue::Constant(ConstantValue::Undefined),\n+            CompileTimeDefineValue::Object(m) => {\n+                let mut js_value = JsValue::Object {\n+                    total_nodes: m.len() as u32,\n+                    parts: m\n+                        .iter()\n+                        .map(|(k, v)| {\n+                            Ok::<ObjectPart, anyhow::Error>(ObjectPart::KeyValue(\n+                                k.clone().into(),\n+                                v.try_into()?,\n+                            ))\n+                        })\n+                        .collect::<Result<Vec<_>>>()?,\n+                    mutable: false,\n+                };\n+                js_value.update_total_nodes();\n+                Ok(js_value)\n+            }\n+            CompileTimeDefineValue::Undefined => Ok(JsValue::Constant(ConstantValue::Undefined)),\n+            CompileTimeDefineValue::Evaluate(s) => EvalContext::eval_single_expr_lit(s.clone()),\n         }\n     }\n }\n \n-impl From<&FreeVarReference> for JsValue {\n-    fn from(v: &FreeVarReference) -> Self {\n-        match v {\n-            FreeVarReference::Value(v) => v.into(),\n+impl TryFrom<&FreeVarReference> for JsValue {\n+    type Error = anyhow::Error;\n+\n+    fn try_from(value: &FreeVarReference) -> Result<Self> {\n+        match value {\n+            FreeVarReference::Value(v) => v.try_into(),\n             FreeVarReference::Ident(_) => {\n-                JsValue::unknown_empty(false, \"compile time injected ident\")\n-            }\n-            FreeVarReference::Member(_, _) => {\n-                JsValue::unknown_empty(false, \"compile time injected member\")\n-            }\n-            FreeVarReference::EcmaScriptModule { .. } => {\n-                JsValue::unknown_empty(false, \"compile time injected free var module\")\n-            }\n-            FreeVarReference::Error(_) => {\n-                JsValue::unknown_empty(false, \"compile time injected free var error\")\n+                Ok(JsValue::unknown_empty(false, \"compile time injected ident\"))\n             }\n+            FreeVarReference::Member(_, _) => Ok(JsValue::unknown_empty(\n+                false,\n+                \"compile time injected member\",\n+            )),\n+            FreeVarReference::EcmaScriptModule { .. } => Ok(JsValue::unknown_empty(\n+                false,\n+                \"compile time injected free var module\",\n+            )),\n+            FreeVarReference::Error(_) => Ok(JsValue::unknown_empty(\n+                false,\n+                \"compile time injected free var error\",\n+            )),\n             FreeVarReference::InputRelative(kind) => {\n                 use turbopack_core::compile_time_info::InputRelativeConstant;\n-                JsValue::unknown_empty(\n+                Ok(JsValue::unknown_empty(\n                     false,\n                     match kind {\n                         InputRelativeConstant::DirName => {\n@@ -622,7 +660,7 @@ impl From<&FreeVarReference> for JsValue {\n                             \"compile time injected free var referencing the file name\"\n                         }\n                     },\n-                )\n+                ))\n             }\n         }\n     }\n@@ -4069,7 +4107,7 @@ mod tests {\n                 m.visit_mut_with(&mut resolver(unresolved_mark, top_level_mark, false));\n \n                 let eval_context = EvalContext::new(\n-                    &m,\n+                    Some(&m),\n                     unresolved_mark,\n                     top_level_mark,\n                     Default::default(),"
        },
        {
            "sha": "fb0c6a15ba27b4b5692e0e1b4fb6723e04507ba2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -497,7 +497,7 @@ async fn parse_file_content(\n             });\n \n             let eval_context = EvalContext::new(\n-                &parsed_program,\n+                Some(&parsed_program),\n                 unresolved_mark,\n                 top_level_mark,\n                 Arc::new(var_with_ts_declare),"
        },
        {
            "sha": "2c589862f4adb688fbc6a3831411ff9b43451ebd",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/constant_value.rs",
            "status": "modified",
            "additions": 75,
            "deletions": 21,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fconstant_value.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -1,7 +1,15 @@\n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n-use swc_core::quote;\n-use turbo_tasks::{NonLocalValue, TaskInput, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n+use swc_core::{\n+    common::{DUMMY_SP, FileName, SourceMap, sync::Lrc},\n+    ecma::{\n+        ast::{ArrayLit, EsVersion, Expr, KeyValueProp, ObjectLit, Prop, PropName, Str},\n+        parser::{Syntax, parse_file_as_expr},\n+    },\n+    quote,\n+};\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{NonLocalValue, Vc, debug::ValueDebugFormat, trace::TraceRawVcs};\n use turbopack_core::{chunk::ChunkingContext, compile_time_info::CompileTimeDefineValue};\n \n use super::AstPath;\n@@ -21,7 +29,6 @@ use crate::{\n     TraceRawVcs,\n     ValueDebugFormat,\n     NonLocalValue,\n-    TaskInput,\n )]\n pub struct ConstantValueCodeGen {\n     value: CompileTimeDefineValue,\n@@ -39,24 +46,8 @@ impl ConstantValueCodeGen {\n         let value = self.value.clone();\n \n         let visitor = create_visitor!(self.path, visit_mut_expr, |expr: &mut Expr| {\n-            *expr = match value {\n-                CompileTimeDefineValue::Bool(true) => {\n-                    quote!(\"(\\\"TURBOPACK compile-time value\\\", true)\" as Expr)\n-                }\n-                CompileTimeDefineValue::Bool(false) => {\n-                    quote!(\"(\\\"TURBOPACK compile-time value\\\", false)\" as Expr)\n-                }\n-                CompileTimeDefineValue::String(ref s) => {\n-                    quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = s.to_string().into())\n-                }\n-                CompileTimeDefineValue::JSON(ref s) => {\n-                    quote!(\"(\\\"TURBOPACK compile-time value\\\", JSON.parse($e))\" as Expr, e: Expr = s.to_string().into())\n-                }\n-                // undefined can be re-bound, so use `void 0` to avoid any risks\n-                CompileTimeDefineValue::Undefined => {\n-                    quote!(\"(\\\"TURBOPACK compile-time value\\\", void 0)\" as Expr)\n-                }\n-            };\n+            // TODO: avoid this clone\n+            *expr = define_env_to_expr((value).clone());\n         });\n \n         Ok(CodeGeneration::visitors(vec![visitor]))\n@@ -68,3 +59,66 @@ impl From<ConstantValueCodeGen> for CodeGen {\n         CodeGen::ConstantValueCodeGen(val)\n     }\n }\n+\n+fn define_env_to_expr(value: CompileTimeDefineValue) -> Expr {\n+    match value {\n+        CompileTimeDefineValue::Null => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", null)\" as Expr)\n+        }\n+        CompileTimeDefineValue::Bool(true) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", true)\" as Expr)\n+        }\n+        CompileTimeDefineValue::Bool(false) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", false)\" as Expr)\n+        }\n+        CompileTimeDefineValue::Number(ref n) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = n.parse::<f64>().unwrap().into())\n+        }\n+        CompileTimeDefineValue::String(ref s) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = s.to_string().into())\n+        }\n+        CompileTimeDefineValue::Array(a) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = Expr::Array(ArrayLit {\n+                span: DUMMY_SP,\n+                elems: a.into_iter().map(|i| Some(define_env_to_expr(i).into())).collect(),\n+            }))\n+        }\n+        CompileTimeDefineValue::Object(m) => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = Expr::Object(ObjectLit {\n+                span: DUMMY_SP,\n+                props: m\n+                    .into_iter()\n+                    .map(|(k, v)| {\n+                        swc_core::ecma::ast::PropOrSpread::Prop(\n+                            Prop::KeyValue(KeyValueProp {\n+                                key: PropName::Str(Str::from(k.as_str())),\n+                                value: define_env_to_expr(v).into(),\n+                            })\n+                            .into(),\n+                        )\n+                    })\n+                    .collect(),\n+            }))\n+        }\n+        CompileTimeDefineValue::Undefined => {\n+            quote!(\"(\\\"TURBOPACK compile-time value\\\", void 0)\" as Expr)\n+        }\n+        CompileTimeDefineValue::Evaluate(ref s) => parse_single_expr_lit(s.clone()),\n+    }\n+}\n+\n+pub(crate) fn parse_single_expr_lit(expr_lit: RcStr) -> Expr {\n+    let cm = Lrc::new(SourceMap::default());\n+    let fm = cm.new_source_file(FileName::Anon.into(), expr_lit.clone());\n+    parse_file_as_expr(\n+        &fm,\n+        Syntax::Es(Default::default()),\n+        EsVersion::latest(),\n+        None,\n+        &mut vec![],\n+    )\n+    .map_or(\n+        quote!(\"(\\\"Failed parsed TURBOPACK compile-time value\\\", $s)\" as Expr, s: Expr = expr_lit.as_str().into()),\n+        |expr| quote!(\"(\\\"TURBOPACK compile-time value\\\", $e)\" as Expr, e: Expr = *expr),\n+    )\n+}"
        },
        {
            "sha": "d3bb40f721f3f3576cd8109a2e3784c871a47464",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -2906,11 +2906,11 @@ async fn value_visitor_inner(\n                 &DefinableNameSegment::TypeOf,\n             )\n         {\n-            return Ok(((&*value.await?).into(), true));\n+            return Ok(((&*value.await?).try_into()?, true));\n         }\n \n         if let Some(value) = v.match_define(&*compile_time_info.defines.individual().await?) {\n-            return Ok(((&*value.await?).into(), true));\n+            return Ok(((&*value.await?).try_into()?, true));\n         }\n     }\n     let value = match v {"
        },
        {
            "sha": "6eeb8ca120f67ea514f9740d9e4a0f77da509717",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -570,7 +570,7 @@ pub(super) async fn split(\n                 .map(|module| {\n                     let program = Program::Module(module);\n                     let eval_context = EvalContext::new(\n-                        &program,\n+                        Some(&program),\n                         eval_context.unresolved_mark,\n                         eval_context.top_level_mark,\n                         eval_context.force_free_values.clone(),\n@@ -695,7 +695,7 @@ pub(crate) async fn part_of_module(\n \n                     let program = Program::Module(module);\n                     let eval_context = EvalContext::new(\n-                        &program,\n+                        Some(&program),\n                         eval_context.unresolved_mark,\n                         eval_context.top_level_mark,\n                         eval_context.force_free_values.clone(),"
        },
        {
            "sha": "4640bdb5be55d618b1e8cacb0e4f5de48285cf8b",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -34,7 +34,7 @@ use turbopack_core::{\n         EvaluatableAssets, MinifyType, availability_info::AvailabilityInfo,\n     },\n     compile_time_defines,\n-    compile_time_info::CompileTimeInfo,\n+    compile_time_info::{CompileTimeDefineValue, CompileTimeInfo, DefinableNameSegment},\n     condition::ContextCondition,\n     context::AssetContext,\n     environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n@@ -296,15 +296,33 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n     .to_resolved()\n     .await?;\n \n-    let defines = compile_time_defines!(\n+    let mut defines = compile_time_defines!(\n         process.turbopack = true,\n         process.env.TURBOPACK = true,\n         process.env.NODE_ENV = \"development\",\n         DEFINED_VALUE = \"value\",\n         DEFINED_TRUE = true,\n+        DEFINED_NULL = json!(null),\n+        DEFINED_INT = json!(1),\n+        DEFINED_FLOAT = json!(0.01),\n+        DEFINED_ARRAY = json!([ false, 0, \"1\", { \"v\": \"v\" }, null ]),\n         A.VERY.LONG.DEFINED.VALUE = json!({ \"test\": true }),\n     );\n \n+    defines.0.insert(\n+        vec![DefinableNameSegment::from(\"DEFINED_EVALUATE\")],\n+        CompileTimeDefineValue::Evaluate(\"1 + 1\".into()),\n+    );\n+\n+    defines.0.insert(\n+        vec![DefinableNameSegment::from(\"DEFINED_EVALUATE_NESTED\")],\n+        CompileTimeDefineValue::Array(vec![\n+            CompileTimeDefineValue::Bool(true),\n+            CompileTimeDefineValue::Undefined,\n+            CompileTimeDefineValue::Evaluate(\"() => 1\".into()),\n+        ]),\n+    );\n+\n     let compile_time_info = CompileTimeInfo::builder(env)\n         .defines(defines.clone().resolved_cell())\n         .free_var_references(free_var_references!(..defines.into_iter()).resolved_cell())"
        },
        {
            "sha": "ffa37ae63444da182d6d3efd3fa68cdfae0a0a3b",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/comptime/define/input/index.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Finput%2Findex.js?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -6,6 +6,30 @@ if (DEFINED_TRUE) {\n   console.log('DEFINED_VALUE')\n }\n \n+if (!DEFINED_NULL) {\n+  console.log('DEFINED_NULL', DEFINED_NULL)\n+}\n+\n+if (DEFINED_INT) {\n+  console.log('DEFINED_INT', DEFINED_INT)\n+}\n+\n+if (DEFINED_FLOAT) {\n+  console.log('DEFINED_FLOAT', DEFINED_FLOAT)\n+}\n+\n+if (DEFINED_ARRAY) {\n+  console.log('DEFINED_ARRAY', DEFINED_ARRAY)\n+}\n+\n+if (DEFINED_EVALUATE) {\n+  console.log('DEFINED_EVALUATE', DEFINED_EVALUATE)\n+}\n+\n+if (DEFINED_EVALUATE_NESTED) {\n+  console.log('DEFINED_EVALUATE_NESTED', DEFINED_EVALUATE_NESTED)\n+}\n+\n if (A.VERY.LONG.DEFINED.VALUE) {\n   console.log('A.VERY.LONG.DEFINED.VALUE')\n }"
        },
        {
            "sha": "0ad94e0f5f5b9fee7fe492647150cec8aa2be08d",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/comptime/define/output/4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js",
            "status": "modified",
            "additions": 35,
            "deletions": 3,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -9,7 +9,37 @@ if (\"TURBOPACK compile-time truthy\", 1) {\n if (\"TURBOPACK compile-time truthy\", 1) {\n     console.log('DEFINED_VALUE');\n }\n-if (\"TURBOPACK compile-time value\", JSON.parse('{\"test\":true}')) {\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_NULL', (\"TURBOPACK compile-time value\", null));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_INT', (\"TURBOPACK compile-time value\", 1));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_FLOAT', (\"TURBOPACK compile-time value\", 0.01));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_ARRAY', (\"TURBOPACK compile-time value\", [\n+        (\"TURBOPACK compile-time value\", false),\n+        (\"TURBOPACK compile-time value\", 0),\n+        (\"TURBOPACK compile-time value\", \"1\"),\n+        (\"TURBOPACK compile-time value\", {\n+            \"v\": (\"TURBOPACK compile-time value\", \"v\")\n+        }),\n+        (\"TURBOPACK compile-time value\", null)\n+    ]));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_EVALUATE', (\"TURBOPACK compile-time value\", 1 + 1));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n+    console.log('DEFINED_EVALUATE_NESTED', (\"TURBOPACK compile-time value\", [\n+        (\"TURBOPACK compile-time value\", true),\n+        (\"TURBOPACK compile-time value\", void 0),\n+        (\"TURBOPACK compile-time value\", ()=>1)\n+    ]));\n+}\n+if (\"TURBOPACK compile-time truthy\", 1) {\n     console.log('A.VERY.LONG.DEFINED.VALUE');\n }\n if (\"TURBOPACK compile-time truthy\", 1) {\n@@ -18,7 +48,9 @@ if (\"TURBOPACK compile-time truthy\", 1) {\n if (\"TURBOPACK compile-time falsy\", 0) //TURBOPACK unreachable\n ;\n var p = process;\n-console.log((\"TURBOPACK compile-time value\", JSON.parse('{\"test\":true}')));\n+console.log((\"TURBOPACK compile-time value\", {\n+    \"test\": (\"TURBOPACK compile-time value\", true)\n+}));\n console.log((\"TURBOPACK compile-time value\", \"value\"));\n console.log((\"TURBOPACK compile-time value\", \"development\"));\n if (\"TURBOPACK compile-time falsy\", 0) //TURBOPACK unreachable\n@@ -31,4 +63,4 @@ console.log((\"TURBOPACK compile-time value\", \"/ROOT/turbopack/crates/turbopack-t\n }}),\n ]);\n \n-//# sourceMappingURL=4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map\n\\ No newline at end of file\n+//# sourceMappingURL=4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map"
        },
        {
            "sha": "f7c30f0405d7239923c034fbc48e54a7531e85af",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/comptime/define/output/4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/1122b1f26fda9da45f0d69430e24e69d55161a84/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcomptime%2Fdefine%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_comptime_define_input_index_4d74c0a3.js.map?ref=1122b1f26fda9da45f0d69430e24e69d55161a84",
            "patch": "@@ -2,5 +2,5 @@\n   \"version\": 3,\n   \"sources\": [],\n   \"sections\": [\n-    {\"offset\": {\"line\": 5, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/comptime/define/input/index.js\"],\"sourcesContent\":[\"if (DEFINED_VALUE) {\\n  console.log('DEFINED_VALUE')\\n}\\n\\nif (DEFINED_TRUE) {\\n  console.log('DEFINED_VALUE')\\n}\\n\\nif (A.VERY.LONG.DEFINED.VALUE) {\\n  console.log('A.VERY.LONG.DEFINED.VALUE')\\n}\\n\\nif (process.env.NODE_ENV) {\\n  console.log('something')\\n}\\n\\nif (process.env.NODE_ENV === 'production') {\\n  console.log('production')\\n}\\n\\nvar p = process\\n\\nconsole.log(A.VERY.LONG.DEFINED.VALUE)\\nconsole.log(DEFINED_VALUE)\\nconsole.log(p.env.NODE_ENV)\\n\\nif (p.env.NODE_ENV === 'production') {\\n  console.log('production')\\n}\\n\\np.env.NODE_ENV == 'production'\\n  ? console.log('production')\\n  : console.log('development')\\n\\n// TODO short-circuit is not implemented yet\\np.env.NODE_ENV != 'production' && console.log('development')\\np.env.NODE_ENV == 'production' && console.log('production')\\n\\nconsole.log(__dirname)\\n\"],\"names\":[],\"mappings\":\"AAAA,wCAAmB;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAkB;IAChB,QAAQ,GAAG,CAAC;AACd;AAEA,iEAA+B;IAC7B,QAAQ,GAAG,CAAC;AACd;AAEA,wCAA0B;IACxB,QAAQ,GAAG,CAAC;AACd;AAEA;;AAIA,IAAI,IAAI;AAER,QAAQ,GAAG;AACX,QAAQ,GAAG;AACX,QAAQ,GAAG;AAEX;;AAIA,sCACI,0BACA,QAAQ,GAAG,CAAC;AAEhB,4CAA4C;AAC5C,mDAAkB,gBAAgB,QAAQ,GAAG,CAAC;AAC9C,mDAAkB,gBAAgB,QAAQ,GAAG,CAAC;AAE9C,QAAQ,GAAG\"}}]\n-}\n\\ No newline at end of file\n+    {\"offset\": {\"line\": 5, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/comptime/define/input/index.js\"],\"sourcesContent\":[\"if (DEFINED_VALUE) {\\n  console.log('DEFINED_VALUE')\\n}\\n\\nif (DEFINED_TRUE) {\\n  console.log('DEFINED_VALUE')\\n}\\n\\nif (!DEFINED_NULL) {\\n  console.log('DEFINED_NULL', DEFINED_NULL)\\n}\\n\\nif (DEFINED_INT) {\\n  console.log('DEFINED_INT', DEFINED_INT)\\n}\\n\\nif (DEFINED_FLOAT) {\\n  console.log('DEFINED_FLOAT', DEFINED_FLOAT)\\n}\\n\\nif (DEFINED_ARRAY) {\\n  console.log('DEFINED_ARRAY', DEFINED_ARRAY)\\n}\\n\\nif (DEFINED_EVALUATE) {\\n  console.log('DEFINED_EVALUATE', DEFINED_EVALUATE)\\n}\\n\\nif (DEFINED_EVALUATE_NESTED) {\\n  console.log('DEFINED_EVALUATE_NESTED', DEFINED_EVALUATE_NESTED)\\n}\\n\\nif (A.VERY.LONG.DEFINED.VALUE) {\\n  console.log('A.VERY.LONG.DEFINED.VALUE')\\n}\\n\\nif (process.env.NODE_ENV) {\\n  console.log('something')\\n}\\n\\nif (process.env.NODE_ENV === 'production') {\\n  console.log('production')\\n}\\n\\nvar p = process\\n\\nconsole.log(A.VERY.LONG.DEFINED.VALUE)\\nconsole.log(DEFINED_VALUE)\\nconsole.log(p.env.NODE_ENV)\\n\\nif (p.env.NODE_ENV === 'production') {\\n  console.log('production')\\n}\\n\\np.env.NODE_ENV == 'production'\\n  ? console.log('production')\\n  : console.log('development')\\n\\n// TODO short-circuit is not implemented yet\\np.env.NODE_ENV != 'production' && console.log('development')\\np.env.NODE_ENV == 'production' && console.log('production')\\n\\nconsole.log(__dirname)\\n\"],\"names\":[],\"mappings\":\"AAAA,wCAAmB;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAkB;IAChB,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAmB;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAiB;IACf,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAmB;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,wCAAmB;IACjB,QAAQ,GAAG,CAAC;;;;;;;;;AACd;AAEA,wCAAsB;IACpB,QAAQ,GAAG,CAAC,qDAzBd,IAAI;AA0BJ;AAEA,wCAA6B;IAC3B,QAAQ,GAAG,CAAC;;;yCA7Bd,IAAM;;AA8BN;AAEA,wCAA+B;IAC7B,QAAQ,GAAG,CAAC;AACd;AAEA,wCAA0B;IACxB,QAAQ,GAAG,CAAC;AACd;AAEA;;AAIA,IAAI,IAAI;AAER,QAAQ,GAAG;;;AACX,QAAQ,GAAG;AACX,QAAQ,GAAG;AAEX;;AAIA,sCACI,0BACA,QAAQ,GAAG,CAAC;AAEhB,4CAA4C;AAC5C,mDAAkB,gBAAgB,QAAQ,GAAG,CAAC;AAC9C,mDAAkB,gBAAgB,QAAQ,GAAG,CAAC;AAE9C,QAAQ,GAAG\"}}]\n+}"
        }
    ],
    "stats": {
        "total": 361,
        "additions": 287,
        "deletions": 74
    }
}