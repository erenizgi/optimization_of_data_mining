{
    "author": "acdlite",
    "message": "Track navigation timestamp on CacheNode (#77251)\n\nAdds a field `navigatedAt` to the CacheNode type. It represents the\ntimestamp of the navigation that last updated the CacheNode's data.\n\nThis will be used to implement the `staleTimes.dynamic` configuration\noption, which allows dynamic data to be stale in the UI up to the given\nthreshold. This first PR adds the field without changing any behavior.\n\nOriginally I was going to call this `requestedAt`, but I have\nintentionally chosen not to distinguish between whether the data was\nfetched from the network or from the prefetch cache. This means that\neven fully static data will respect the `staleTimes.dynamic`\nconfiguration option. In practice, this only matters if the dynamic\nstale time is longer than the static one, although usually static stale\ntimes will be larger anyway.",
    "sha": "5195704e96547673f2ca71f2ba8e2dabc652e76f",
    "files": [
        {
            "sha": "d52c32b5398da69509aca9613e92ce69662cacf6",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -171,9 +171,12 @@ const pendingActionQueue: Promise<AppRouterActionQueue> = new Promise(\n         // and before any components have hydrated.\n         setAppBuildId(initialRSCPayload.b)\n \n+        const initialTimestamp = Date.now()\n+\n         resolve(\n           createMutableActionQueue(\n             createInitialRouterState({\n+              navigatedAt: initialTimestamp,\n               initialFlightData: initialRSCPayload.f,\n               initialCanonicalUrlParts: initialRSCPayload.c,\n               initialParallelRoutes: new Map(),"
        },
        {
            "sha": "d185ee8e8fc6ce9a00a88c0865898291f9a3aba0",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -149,6 +149,7 @@ export function createEmptyCacheNode(): CacheNode {\n     prefetchHead: null,\n     parallelRoutes: new Map(),\n     loading: null,\n+    navigatedAt: -1,\n   }\n }\n "
        },
        {
            "sha": "0294a2678a1f7b2d77e1ee3566b35bf5ac3cf1ae",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -381,6 +381,7 @@ function InnerLayoutRouter({\n       // TODO-APP: remove ''\n       const refetchTree = walkAddRefetch(['', ...segmentPath], fullTree)\n       const includeNextUrl = hasInterceptionRouteInCurrentTree(fullTree)\n+      const navigatedAt = Date.now()\n       cacheNode.lazyData = lazyData = fetchServerResponse(\n         new URL(url, location.origin),\n         {\n@@ -393,6 +394,7 @@ function InnerLayoutRouter({\n             type: ACTION_SERVER_PATCH,\n             previousTree: fullTree,\n             serverResponse,\n+            navigatedAt,\n           })\n         })\n \n@@ -565,6 +567,7 @@ export default function OuterLayoutRouter({\n       prefetchHead: null,\n       parallelRoutes: new Map(),\n       loading: null,\n+      navigatedAt: -1,\n     }\n \n     // Flight data fetch kicked off during render and put into the cache."
        },
        {
            "sha": "6cbc4ecdfa789c2abd0aa02cd50b9ece5aac7b18",
            "filename": "packages/next/src/client/components/router-reducer/aliased-prefetch-navigations.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -24,6 +24,7 @@ import type { Mutable, ReadonlyReducerState } from './router-reducer-types'\n  * more granular segment map and so the router will be able to simply re-use the loading segment for the new navigation.\n  */\n export function handleAliasedPrefetchEntry(\n+  navigatedAt: number,\n   state: ReadonlyReducerState,\n   flightData: string | NormalizedFlightData[],\n   url: URL,\n@@ -85,6 +86,7 @@ export function handleAliasedPrefetchEntry(\n \n       // Construct a new tree and apply the aliased loading state for each parallel route\n       fillNewTreeWithOnlyLoadingSegments(\n+        navigatedAt,\n         newCache,\n         currentCache,\n         treePatch,\n@@ -99,6 +101,7 @@ export function handleAliasedPrefetchEntry(\n \n       // copy the loading state only into the leaf node (the part that changed)\n       fillCacheWithNewSubTreeDataButOnlyLoading(\n+        navigatedAt,\n         newCache,\n         currentCache,\n         normalizedFlightData\n@@ -146,6 +149,7 @@ function hasLoadingComponentInSeedData(seedData: CacheNodeSeedData | null) {\n }\n \n function fillNewTreeWithOnlyLoadingSegments(\n+  navigatedAt: number,\n   newCache: CacheNode,\n   existingCache: CacheNode,\n   routerState: FlightRouterState,\n@@ -180,6 +184,7 @@ function fillNewTreeWithOnlyLoadingSegments(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading,\n+        navigatedAt,\n       }\n     } else {\n       // No data available for this node. This will trigger a lazy fetch\n@@ -192,6 +197,7 @@ function fillNewTreeWithOnlyLoadingSegments(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading: null,\n+        navigatedAt: -1,\n       }\n     }\n \n@@ -203,6 +209,7 @@ function fillNewTreeWithOnlyLoadingSegments(\n     }\n \n     fillNewTreeWithOnlyLoadingSegments(\n+      navigatedAt,\n       newCacheNode,\n       existingCache,\n       parallelRouteState,"
        },
        {
            "sha": "741b02ac62c04e891e39e9ed8a7a6cd5a87450a3",
            "filename": "packages/next/src/client/components/router-reducer/apply-flight-data.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fapply-flight-data.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fapply-flight-data.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fapply-flight-data.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -5,6 +5,7 @@ import type { PrefetchCacheEntry } from './router-reducer-types'\n import type { NormalizedFlightData } from '../../flight-data-helpers'\n \n export function applyFlightData(\n+  navigatedAt: number,\n   existingCache: CacheNode,\n   cache: CacheNode,\n   flightData: NormalizedFlightData,\n@@ -30,6 +31,7 @@ export function applyFlightData(\n     // old behavior â€” no PPR value.\n     cache.prefetchRsc = null\n     fillLazyItemsTillLeafWithHead(\n+      navigatedAt,\n       cache,\n       existingCache,\n       treePatch,\n@@ -47,7 +49,13 @@ export function applyFlightData(\n     cache.parallelRoutes = new Map(existingCache.parallelRoutes)\n     cache.loading = existingCache.loading\n     // Create a copy of the existing cache with the rsc applied.\n-    fillCacheWithNewSubTreeData(cache, existingCache, flightData, prefetchEntry)\n+    fillCacheWithNewSubTreeData(\n+      navigatedAt,\n+      cache,\n+      existingCache,\n+      flightData,\n+      prefetchEntry\n+    )\n   }\n \n   return true"
        },
        {
            "sha": "0233d1c1348f7e3ed4eda377e4a8673ecbdfb9f5",
            "filename": "packages/next/src/client/components/router-reducer/clear-cache-node-data-for-segment-path.test.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -2,6 +2,8 @@ import React from 'react'\n import { clearCacheNodeDataForSegmentPath } from './clear-cache-node-data-for-segment-path'\n import type { CacheNode } from '../../../shared/lib/app-router-context.shared-runtime'\n \n+const navigatedAt = -1\n+\n describe('clearCacheNodeDataForSegmentPath', () => {\n   it('should clear the data property', () => {\n     const pathname = '/dashboard/settings'\n@@ -13,6 +15,7 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n       .flat()\n \n     const cache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -22,6 +25,7 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n       loading: null,\n     }\n     const existingCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: <>Root layout</>,\n       prefetchRsc: null,\n@@ -35,6 +39,7 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -48,6 +53,7 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -74,18 +80,21 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n        \"head\": null,\n        \"lazyData\": null,\n        \"loading\": null,\n+       \"navigatedAt\": -1,\n        \"parallelRoutes\": Map {\n          \"children\" => Map {\n            \"linking\" => {\n              \"head\": null,\n              \"lazyData\": null,\n              \"loading\": null,\n+             \"navigatedAt\": -1,\n              \"parallelRoutes\": Map {\n                \"children\" => Map {\n                  \"\" => {\n                    \"head\": null,\n                    \"lazyData\": null,\n                    \"loading\": null,\n+                   \"navigatedAt\": -1,\n                    \"parallelRoutes\": Map {},\n                    \"prefetchHead\": null,\n                    \"prefetchRsc\": null,\n@@ -105,6 +114,7 @@ describe('clearCacheNodeDataForSegmentPath', () => {\n              \"head\": null,\n              \"lazyData\": null,\n              \"loading\": null,\n+             \"navigatedAt\": -1,\n              \"parallelRoutes\": Map {},\n              \"prefetchHead\": null,\n              \"prefetchRsc\": null,"
        },
        {
            "sha": "a1afa5fb43dfa6175cb88c9935dd9b6ffbfea60b",
            "filename": "packages/next/src/client/components/router-reducer/clear-cache-node-data-for-segment-path.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fclear-cache-node-data-for-segment-path.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -44,6 +44,7 @@ export function clearCacheNodeDataForSegmentPath(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading: null,\n+        navigatedAt: -1,\n       })\n     }\n     return\n@@ -60,6 +61,7 @@ export function clearCacheNodeDataForSegmentPath(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading: null,\n+        navigatedAt: -1,\n       })\n     }\n     return"
        },
        {
            "sha": "2ee85f6813796d37c038f888c8e3593df4623e83",
            "filename": "packages/next/src/client/components/router-reducer/create-initial-router-state.test.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -19,6 +19,8 @@ const getInitialRouterStateTree = (): FlightRouterState => [\n   true,\n ]\n \n+const navigatedAt = Date.now()\n+\n describe('createInitialRouterState', () => {\n   it('should return the correct initial router state', () => {\n     const initialTree = getInitialRouterStateTree()\n@@ -32,6 +34,7 @@ describe('createInitialRouterState', () => {\n     const initialParallelRoutes: CacheNode['parallelRoutes'] = new Map()\n \n     const state = createInitialRouterState({\n+      navigatedAt,\n       initialFlightData: [[initialTree, ['', children, {}, null]]],\n       initialCanonicalUrlParts: initialCanonicalUrl.split('/'),\n       initialParallelRoutes,\n@@ -42,6 +45,7 @@ describe('createInitialRouterState', () => {\n     })\n \n     const state2 = createInitialRouterState({\n+      navigatedAt,\n       initialFlightData: [[initialTree, ['', children, {}, null]]],\n       initialCanonicalUrlParts: initialCanonicalUrl.split('/'),\n       initialParallelRoutes,\n@@ -52,6 +56,7 @@ describe('createInitialRouterState', () => {\n     })\n \n     const expectedCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: children,\n       prefetchRsc: null,\n@@ -65,13 +70,15 @@ describe('createInitialRouterState', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 parallelRoutes: new Map([\n                   [\n                     'children',\n                     new Map([\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: null,\n                           prefetchRsc: null,"
        },
        {
            "sha": "a1f827e9f2a64c55cd480bf522879035ef43bc90",
            "filename": "packages/next/src/client/components/router-reducer/create-initial-router-state.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -10,6 +10,7 @@ import { addRefreshMarkerToActiveParallelSegments } from './refetch-inactive-par\n import { getFlightDataPartsFromPath } from '../../flight-data-helpers'\n \n export interface InitialRouterStateParameters {\n+  navigatedAt: number\n   initialCanonicalUrlParts: string[]\n   initialParallelRoutes: CacheNode['parallelRoutes']\n   initialFlightData: FlightDataPath[]\n@@ -20,6 +21,7 @@ export interface InitialRouterStateParameters {\n }\n \n export function createInitialRouterState({\n+  navigatedAt,\n   initialFlightData,\n   initialCanonicalUrlParts,\n   initialParallelRoutes,\n@@ -52,6 +54,7 @@ export function createInitialRouterState({\n     // The cache gets seeded during the first render. `initialParallelRoutes` ensures the cache from the first render is there during the second render.\n     parallelRoutes: initialParallelRoutes,\n     loading,\n+    navigatedAt,\n   }\n \n   const canonicalUrl =\n@@ -69,6 +72,7 @@ export function createInitialRouterState({\n   // When the cache hasn't been seeded yet we fill the cache with the head.\n   if (initialParallelRoutes === null || initialParallelRoutes.size === 0) {\n     fillLazyItemsTillLeafWithHead(\n+      navigatedAt,\n       cache,\n       undefined,\n       initialTree,"
        },
        {
            "sha": "3a15bbfe187b5d2200a3870a4081a9c7ed2b8d9d",
            "filename": "packages/next/src/client/components/router-reducer/fill-cache-with-new-subtree-data.test.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -20,6 +20,7 @@ const getFlightData = (): NormalizedFlightData[] => {\n describe('fillCacheWithNewSubtreeData', () => {\n   it('should apply rsc and head property', () => {\n     const cache: CacheNode = {\n+      navigatedAt: -1,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -29,6 +30,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n       parallelRoutes: new Map(),\n     }\n     const existingCache: CacheNode = {\n+      navigatedAt: -1,\n       lazyData: null,\n       rsc: <>Root layout</>,\n       prefetchRsc: null,\n@@ -42,6 +44,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n             [\n               'linking',\n               {\n+                navigatedAt: -1,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -55,6 +58,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt: -1,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -83,9 +87,16 @@ describe('fillCacheWithNewSubtreeData', () => {\n     // Mirrors the way router-reducer values are passed in.\n     const normalizedFlightData = flightData[0]\n \n-    fillCacheWithNewSubTreeData(cache, existingCache, normalizedFlightData)\n+    const navigatedAt = -1\n+    fillCacheWithNewSubTreeData(\n+      navigatedAt,\n+      cache,\n+      existingCache,\n+      normalizedFlightData\n+    )\n \n     const expectedCache: CacheNode = {\n+      navigatedAt: -1,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -99,6 +110,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n             [\n               'linking',\n               {\n+                navigatedAt: -1,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -113,6 +125,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt: -1,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -125,6 +138,7 @@ describe('fillCacheWithNewSubtreeData', () => {\n                       [\n                         'about',\n                         {\n+                          navigatedAt: -1,\n                           lazyData: null,\n                           head: null,\n                           prefetchHead: null,"
        },
        {
            "sha": "b540e716fc9d99a4dd37935c7e96ae482e332687",
            "filename": "packages/next/src/client/components/router-reducer/fill-cache-with-new-subtree-data.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-cache-with-new-subtree-data.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -11,6 +11,7 @@ import type { NormalizedFlightData } from '../../flight-data-helpers'\n  * Common logic for filling cache with new sub tree data.\n  */\n function fillCacheHelper(\n+  navigatedAt: number,\n   newCache: CacheNode,\n   existingCache: CacheNode,\n   flightData: NormalizedFlightData,\n@@ -78,6 +79,7 @@ function fillCacheHelper(\n             fillLazyItems && existingChildCacheNode\n               ? new Map(existingChildCacheNode.parallelRoutes)\n               : new Map(),\n+          navigatedAt,\n         }\n \n         if (existingChildCacheNode && fillLazyItems) {\n@@ -89,6 +91,7 @@ function fillCacheHelper(\n         }\n         if (fillLazyItems) {\n           fillLazyItemsTillLeafWithHead(\n+            navigatedAt,\n             childCacheNode,\n             existingChildCacheNode,\n             treePatch,\n@@ -132,19 +135,35 @@ function fillCacheHelper(\n  * Fill cache with rsc based on flightDataPath\n  */\n export function fillCacheWithNewSubTreeData(\n+  navigatedAt: number,\n   newCache: CacheNode,\n   existingCache: CacheNode,\n   flightData: NormalizedFlightData,\n   prefetchEntry?: PrefetchCacheEntry\n ): void {\n-  fillCacheHelper(newCache, existingCache, flightData, prefetchEntry, true)\n+  fillCacheHelper(\n+    navigatedAt,\n+    newCache,\n+    existingCache,\n+    flightData,\n+    prefetchEntry,\n+    true\n+  )\n }\n \n export function fillCacheWithNewSubTreeDataButOnlyLoading(\n+  navigatedAt: number,\n   newCache: CacheNode,\n   existingCache: CacheNode,\n   flightData: NormalizedFlightData,\n   prefetchEntry?: PrefetchCacheEntry\n ): void {\n-  fillCacheHelper(newCache, existingCache, flightData, prefetchEntry, false)\n+  fillCacheHelper(\n+    navigatedAt,\n+    newCache,\n+    existingCache,\n+    flightData,\n+    prefetchEntry,\n+    false\n+  )\n }"
        },
        {
            "sha": "3abc8e9b5f144f34e900cb7f3bf0d6a4164971d2",
            "filename": "packages/next/src/client/components/router-reducer/fill-lazy-items-till-leaf-with-head.test.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -33,9 +33,12 @@ const getFlightData = (): FlightData => {\n   ]\n }\n \n+const navigatedAt = Date.now()\n+\n describe('fillLazyItemsTillLeafWithHead', () => {\n   it('should fill lazy items till leaf with head', () => {\n     const cache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -45,6 +48,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n       loading: null,\n     }\n     const existingCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: <>Root layout</>,\n       prefetchRsc: null,\n@@ -58,6 +62,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -71,6 +76,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -102,6 +108,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n       flightDataPath.slice(-4)\n \n     fillLazyItemsTillLeafWithHead(\n+      navigatedAt,\n       cache,\n       existingCache,\n       treePatch,\n@@ -111,6 +118,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n     )\n \n     const expectedCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -124,6 +132,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: null,\n                 prefetchRsc: null,\n@@ -137,6 +146,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n                       [\n                         'about',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           loading: null,\n                           parallelRoutes: new Map([\n@@ -146,6 +156,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n                                 [\n                                   '',\n                                   {\n+                                    navigatedAt,\n                                     lazyData: null,\n                                     rsc: null,\n                                     prefetchRsc: null,\n@@ -167,6 +178,7 @@ describe('fillLazyItemsTillLeafWithHead', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,"
        },
        {
            "sha": "5369274c2a3a570106b865f07f2fe8454da749b9",
            "filename": "packages/next/src/client/components/router-reducer/fill-lazy-items-till-leaf-with-head.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffill-lazy-items-till-leaf-with-head.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -10,6 +10,7 @@ import {\n } from './router-reducer-types'\n \n export function fillLazyItemsTillLeafWithHead(\n+  navigatedAt: number,\n   newCache: CacheNode,\n   existingCache: CacheNode | undefined,\n   routerState: FlightRouterState,\n@@ -70,6 +71,7 @@ export function fillLazyItemsTillLeafWithHead(\n             prefetchHead: null,\n             loading,\n             parallelRoutes: new Map(existingCacheNode?.parallelRoutes),\n+            navigatedAt,\n           }\n         } else if (hasReusablePrefetch && existingCacheNode) {\n           // No new data was sent from the server, but the existing cache node\n@@ -97,13 +99,15 @@ export function fillLazyItemsTillLeafWithHead(\n             prefetchHead: null,\n             parallelRoutes: new Map(existingCacheNode?.parallelRoutes),\n             loading: null,\n+            navigatedAt,\n           }\n         }\n \n         // Overrides the cache key with the new cache node.\n         parallelRouteCacheNode.set(cacheKey, newCacheNode)\n         // Traverse deeper to apply the head / fill lazy items till the head.\n         fillLazyItemsTillLeafWithHead(\n+          navigatedAt,\n           newCacheNode,\n           existingCacheNode,\n           parallelRouteState,\n@@ -130,6 +134,7 @@ export function fillLazyItemsTillLeafWithHead(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading,\n+        navigatedAt,\n       }\n     } else {\n       // No data available for this node. This will trigger a lazy fetch\n@@ -142,6 +147,7 @@ export function fillLazyItemsTillLeafWithHead(\n         prefetchHead: null,\n         parallelRoutes: new Map(),\n         loading: null,\n+        navigatedAt,\n       }\n     }\n \n@@ -153,6 +159,7 @@ export function fillLazyItemsTillLeafWithHead(\n     }\n \n     fillLazyItemsTillLeafWithHead(\n+      navigatedAt,\n       newCacheNode,\n       undefined,\n       parallelRouteState,"
        },
        {
            "sha": "f55708969480cd1b925a9ea95bf9ad4f2ae7f95f",
            "filename": "packages/next/src/client/components/router-reducer/invalidate-cache-below-flight-segmentpath.test.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-below-flight-segmentpath.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -19,9 +19,12 @@ const getFlightData = (): NormalizedFlightData[] => {\n   ]\n }\n \n+const navigatedAt = Date.now()\n+\n describe('invalidateCacheBelowFlightSegmentPath', () => {\n   it('should invalidate cache below flight segment path', () => {\n     const cache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -31,6 +34,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n       parallelRoutes: new Map(),\n     }\n     const existingCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: <>Root layout</>,\n       prefetchRsc: null,\n@@ -44,6 +48,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -57,6 +62,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -89,7 +95,12 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n     cache.rsc = existingCache.rsc\n     cache.prefetchRsc = existingCache.prefetchRsc\n     // Create a copy of the existing cache with the rsc applied.\n-    fillCacheWithNewSubTreeData(cache, existingCache, normalizedFlightData)\n+    fillCacheWithNewSubTreeData(\n+      navigatedAt,\n+      cache,\n+      existingCache,\n+      normalizedFlightData\n+    )\n \n     // Invalidate the cache below the flight segment path. This should remove the 'about' node.\n     invalidateCacheBelowFlightSegmentPath(\n@@ -99,6 +110,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n     )\n \n     const expectedCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       head: null,\n       prefetchHead: null,\n@@ -110,6 +122,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 head: null,\n                 prefetchHead: null,\n@@ -121,6 +134,7 @@ describe('invalidateCacheBelowFlightSegmentPath', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           loading: null,\n                           parallelRoutes: new Map(),"
        },
        {
            "sha": "42f8bd4039253b829800d7a5175efd7c941a0c26",
            "filename": "packages/next/src/client/components/router-reducer/invalidate-cache-by-router-state.test.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-by-router-state.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-by-router-state.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Finvalidate-cache-by-router-state.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -2,9 +2,12 @@ import { invalidateCacheByRouterState } from './invalidate-cache-by-router-state\n import type { CacheNode } from '../../../shared/lib/app-router-context.shared-runtime'\n import type { FlightRouterState } from '../../../server/app-render/types'\n \n+const navigatedAt = -1\n+\n describe('invalidateCacheByRouterState', () => {\n   it('should invalidate the cache by router state', () => {\n     const cache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -14,6 +17,7 @@ describe('invalidateCacheByRouterState', () => {\n       parallelRoutes: new Map(),\n     }\n     const existingCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: <>Root layout</>,\n       prefetchRsc: null,\n@@ -27,6 +31,7 @@ describe('invalidateCacheByRouterState', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: <>Linking</>,\n                 prefetchRsc: null,\n@@ -40,6 +45,7 @@ describe('invalidateCacheByRouterState', () => {\n                       [\n                         '',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           rsc: <>Page</>,\n                           prefetchRsc: null,\n@@ -82,6 +88,7 @@ describe('invalidateCacheByRouterState', () => {\n     invalidateCacheByRouterState(cache, existingCache, routerState)\n \n     const expectedCache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,"
        },
        {
            "sha": "16d1e7c6bc77079dbc1660002341aeac7dd6140f",
            "filename": "packages/next/src/client/components/router-reducer/ppr-navigations.ts",
            "status": "modified",
            "additions": 115,
            "deletions": 36,
            "changes": 151,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -8,13 +8,15 @@ import type {\n   CacheNode,\n   ChildSegmentMap,\n   HeadData,\n+  LoadingModuleData,\n   ReadyCacheNode,\n } from '../../../shared/lib/app-router-context.shared-runtime'\n import { DEFAULT_SEGMENT_KEY } from '../../../shared/lib/segment'\n import { matchSegment } from '../match-segments'\n import { createRouterCacheKey } from './create-router-cache-key'\n import type { FetchServerResponseResult } from './fetch-server-response'\n import { isNavigatingToNewRootLayout } from './is-navigating-to-new-root-layout'\n+import { DYNAMIC_STALETIME_MS } from './prefetch-cache-utils'\n \n // This is yet another tree type that is used to track pending promises that\n // need to be fulfilled once the dynamic data is received. The terminal nodes of\n@@ -86,6 +88,7 @@ export type Task = SPANavigationTask | MPANavigationTask\n // A return value of `null` means there were no changes, and the previous tree\n // can be reused without initiating a server request.\n export function startPPRNavigation(\n+  navigatedAt: number,\n   oldCacheNode: CacheNode,\n   oldRouterState: FlightRouterState,\n   newRouterState: FlightRouterState,\n@@ -97,6 +100,7 @@ export function startPPRNavigation(\n ): Task | null {\n   const segmentPath: Array<FlightSegmentPath> = []\n   return updateCacheNodeOnNavigation(\n+    navigatedAt,\n     oldCacheNode,\n     oldRouterState,\n     newRouterState,\n@@ -111,6 +115,7 @@ export function startPPRNavigation(\n }\n \n function updateCacheNodeOnNavigation(\n+  navigatedAt: number,\n   oldCacheNode: CacheNode,\n   oldRouterState: FlightRouterState,\n   newRouterState: FlightRouterState,\n@@ -227,8 +232,10 @@ function updateCacheNodeOnNavigation(\n       } else {\n         // There's no currently active segment. Switch to the \"create\" path.\n         taskChild = beginRenderingNewRouteTree(\n+          navigatedAt,\n           oldRouterStateChild,\n           newRouterStateChild,\n+          oldCacheNodeChild,\n           didFindRootLayout,\n           prefetchDataChild !== undefined ? prefetchDataChild : null,\n           prefetchHead,\n@@ -266,8 +273,10 @@ function updateCacheNodeOnNavigation(\n       // cached data. If the page segment is fully static and prefetched, the\n       // request is skipped. (This is also how refresh() works.)\n       taskChild = beginRenderingNewRouteTree(\n+        navigatedAt,\n         oldRouterStateChild,\n         newRouterStateChild,\n+        oldCacheNodeChild,\n         didFindRootLayout,\n         prefetchDataChild !== undefined ? prefetchDataChild : null,\n         prefetchHead,\n@@ -287,6 +296,7 @@ function updateCacheNodeOnNavigation(\n         // This segment exists in both the old and new trees. Recursively update\n         // the children.\n         taskChild = updateCacheNodeOnNavigation(\n+          navigatedAt,\n           oldCacheNodeChild,\n           oldRouterStateChild,\n           newRouterStateChild,\n@@ -302,8 +312,10 @@ function updateCacheNodeOnNavigation(\n         // There's no existing Cache Node for this segment. Switch to the\n         // \"create\" path.\n         taskChild = beginRenderingNewRouteTree(\n+          navigatedAt,\n           oldRouterStateChild,\n           newRouterStateChild,\n+          oldCacheNodeChild,\n           didFindRootLayout,\n           prefetchDataChild !== undefined ? prefetchDataChild : null,\n           prefetchHead,\n@@ -315,8 +327,10 @@ function updateCacheNodeOnNavigation(\n     } else {\n       // This is a new tree. Switch to the \"create\" path.\n       taskChild = beginRenderingNewRouteTree(\n+        navigatedAt,\n         oldRouterStateChild,\n         newRouterStateChild,\n+        oldCacheNodeChild,\n         didFindRootLayout,\n         prefetchDataChild !== undefined ? prefetchDataChild : null,\n         prefetchHead,\n@@ -388,6 +402,8 @@ function updateCacheNodeOnNavigation(\n \n     // Everything is cloned except for the children, which we computed above.\n     parallelRoutes: prefetchParallelRoutes,\n+\n+    navigatedAt,\n   }\n \n   return {\n@@ -408,8 +424,10 @@ function updateCacheNodeOnNavigation(\n }\n \n function beginRenderingNewRouteTree(\n+  navigatedAt: number,\n   oldRouterState: FlightRouterState | void,\n   newRouterState: FlightRouterState,\n+  existingCacheNode: CacheNode | void,\n   didFindRootLayout: boolean,\n   prefetchData: CacheNodeSeedData | null,\n   possiblyPartialPrefetchHead: HeadData | null,\n@@ -446,7 +464,9 @@ function beginRenderingNewRouteTree(\n     }\n   }\n   return createCacheNodeOnNavigation(\n+    navigatedAt,\n     newRouterState,\n+    existingCacheNode,\n     prefetchData,\n     possiblyPartialPrefetchHead,\n     isPrefetchHeadPartial,\n@@ -456,7 +476,9 @@ function beginRenderingNewRouteTree(\n }\n \n function createCacheNodeOnNavigation(\n+  navigatedAt: number,\n   routerState: FlightRouterState,\n+  existingCacheNode: CacheNode | void,\n   prefetchData: CacheNodeSeedData | null,\n   possiblyPartialPrefetchHead: HeadData | null,\n   isPrefetchHeadPartial: boolean,\n@@ -466,55 +488,93 @@ function createCacheNodeOnNavigation(\n   // Same traversal as updateCacheNodeNavigation, but we switch to this path\n   // once we reach the part of the tree that was not in the previous route. We\n   // don't need to diff against the old tree, we just need to create a new one.\n-  if (prefetchData === null) {\n-    // There's no prefetch for this segment. Everything from this point will be\n-    // requested from the server, even if there are static children below it.\n-    // Create a terminal task node that will later be fulfilled by\n-    // server response.\n-    return spawnPendingTask(\n-      routerState,\n-      null,\n-      possiblyPartialPrefetchHead,\n-      isPrefetchHeadPartial,\n-      segmentPath,\n-      scrollableSegmentsResult\n-    )\n-  }\n-\n-  const routerStateChildren = routerState[1]\n-  const isPrefetchRscPartial = prefetchData[4]\n \n   // The head is assigned to every leaf segment delivered by the server. Based\n   // on corresponding logic in fill-lazy-items-till-leaf-with-head.ts\n+  const routerStateChildren = routerState[1]\n   const isLeafSegment = Object.keys(routerStateChildren).length === 0\n \n-  // If prefetch data is available for a segment, and it's fully static (i.e.\n-  // does not contain any dynamic holes), we don't need to request it from\n-  // the server.\n+  // Even we're rendering inside the \"new\" part of the target tree, we may have\n+  // a locally cached segment that we can reuse. This may come from either 1)\n+  // the CacheNode tree, which lives in React state and is populated by previous\n+  // navigations; or 2) the prefetch cache, which is a separate cache that is\n+  // populated by prefetches.\n+  let rsc: React.ReactNode\n+  let loading: LoadingModuleData | Promise<LoadingModuleData>\n+  let head: HeadData | null\n+  let cacheNodeNavigatedAt: number\n   if (\n-    // Check if the segment data is partial\n-    isPrefetchRscPartial ||\n-    // Check if the head is partial (only relevant if this is a leaf segment)\n-    (isPrefetchHeadPartial && isLeafSegment)\n+    existingCacheNode !== undefined &&\n+    // DYNAMIC_STALETIME_MS defaults to 0, but it can be increased using\n+    // the experimental.staleTimes.dynamic config. When set, we'll avoid\n+    // refetching dynamic data if it was fetched within the given threshold.\n+    existingCacheNode.navigatedAt + DYNAMIC_STALETIME_MS > navigatedAt\n   ) {\n-    // We only have partial data from this segment. Like missing segments, we\n-    // must request the full data from the server.\n+    // We have an existing CacheNode for this segment, and it's not stale. We\n+    // should reuse it rather than request a new one.\n+    rsc = existingCacheNode.rsc\n+    loading = existingCacheNode.loading\n+    head = existingCacheNode.head\n+\n+    // Don't update the navigatedAt timestamp, since we're reusing stale data.\n+    cacheNodeNavigatedAt = existingCacheNode.navigatedAt\n+  } else if (prefetchData !== null) {\n+    // There's no existing CacheNode for this segment, but we do have prefetch\n+    // data. If the prefetch data is fully static (i.e. does not contain any\n+    // dynamic holes), we don't need to request it from the server.\n+    rsc = prefetchData[1]\n+    loading = prefetchData[3]\n+    head = isLeafSegment ? possiblyPartialPrefetchHead : null\n+    // Even though we're accessing the data from the prefetch cache, this is\n+    // conceptually a new segment, not a reused one. So we should update the\n+    // navigatedAt timestamp.\n+    cacheNodeNavigatedAt = navigatedAt\n+    const isPrefetchRscPartial = prefetchData[4]\n+    if (\n+      // Check if the segment data is partial\n+      isPrefetchRscPartial ||\n+      // Check if the head is partial (only relevant if this is a leaf segment)\n+      (isPrefetchHeadPartial && isLeafSegment)\n+    ) {\n+      // We only have partial data from this segment. Like missing segments, we\n+      // must request the full data from the server.\n+      return spawnPendingTask(\n+        navigatedAt,\n+        routerState,\n+        prefetchData,\n+        possiblyPartialPrefetchHead,\n+        isPrefetchHeadPartial,\n+        segmentPath,\n+        scrollableSegmentsResult\n+      )\n+    } else {\n+      // The prefetch data is fully static, so we can omit it from the\n+      // navigation request.\n+    }\n+  } else {\n+    // There's no prefetch for this segment. Everything from this point will be\n+    // requested from the server, even if there are static children below it.\n+    // Create a terminal task node that will later be fulfilled by\n+    // server response.\n     return spawnPendingTask(\n+      navigatedAt,\n       routerState,\n-      prefetchData,\n+      null,\n       possiblyPartialPrefetchHead,\n       isPrefetchHeadPartial,\n       segmentPath,\n       scrollableSegmentsResult\n     )\n   }\n \n-  // The prefetched segment is fully static, so we don't need to request a new\n-  // one from the server. Keep traversing down the tree until we reach something\n-  // that requires a dynamic request.\n-  const prefetchDataChildren = prefetchData[2]\n+  // We already have a full segment we can render, so we don't need to request a\n+  // new one from the server. Keep traversing down the tree until we reach\n+  // something that requires a dynamic request.\n+  const prefetchDataChildren = prefetchData !== null ? prefetchData[2] : null\n   const taskChildren = new Map()\n-  const cacheNodeChildren = new Map()\n+  const existingCacheNodeChildren =\n+    existingCacheNode !== undefined ? existingCacheNode.parallelRoutes : null\n+  const cacheNodeChildren = new Map(existingCacheNodeChildren)\n   let dynamicRequestTreeChildren: {\n     [parallelRouteKey: string]: FlightRouterState\n   } = {}\n@@ -535,14 +595,26 @@ function createCacheNodeOnNavigation(\n         prefetchDataChildren !== null\n           ? prefetchDataChildren[parallelRouteKey]\n           : null\n+      const existingSegmentMapChild =\n+        existingCacheNodeChildren !== null\n+          ? existingCacheNodeChildren.get(parallelRouteKey)\n+          : undefined\n       const segmentChild = routerStateChild[0]\n       const segmentPathChild = segmentPath.concat([\n         parallelRouteKey,\n         segmentChild,\n       ])\n       const segmentKeyChild = createRouterCacheKey(segmentChild)\n+\n+      const existingCacheNodeChild =\n+        existingSegmentMapChild !== undefined\n+          ? existingSegmentMapChild.get(segmentKeyChild)\n+          : undefined\n+\n       const taskChild = createCacheNodeOnNavigation(\n+        navigatedAt,\n         routerStateChild,\n+        existingCacheNodeChild,\n         prefetchDataChild,\n         possiblyPartialPrefetchHead,\n         isPrefetchHeadPartial,\n@@ -567,8 +639,6 @@ function createCacheNodeOnNavigation(\n     }\n   }\n \n-  const rsc = prefetchData[1]\n-  const loading = prefetchData[3]\n   return {\n     // Since we're inside a new route tree, unlike the\n     // `updateCacheNodeOnNavigation` path, the router state on the children\n@@ -577,14 +647,15 @@ function createCacheNodeOnNavigation(\n     route: routerState,\n     node: {\n       lazyData: null,\n-      // Since this is a fully static segment, we don't need to use the\n+      // Since this segment is already full, we don't need to use the\n       // `prefetchRsc` field.\n       rsc,\n       prefetchRsc: null,\n-      head: isLeafSegment ? possiblyPartialPrefetchHead : null,\n+      head,\n       prefetchHead: null,\n       loading,\n       parallelRoutes: cacheNodeChildren,\n+      navigatedAt: cacheNodeNavigatedAt,\n     },\n     dynamicRequestTree: needsDynamicRequest\n       ? patchRouterStateWithNewChildren(routerState, dynamicRequestTreeChildren)\n@@ -614,6 +685,7 @@ function patchRouterStateWithNewChildren(\n }\n \n function spawnPendingTask(\n+  navigatedAt: number,\n   routerState: FlightRouterState,\n   prefetchData: CacheNodeSeedData | null,\n   prefetchHead: HeadData | null,\n@@ -636,6 +708,7 @@ function spawnPendingTask(\n \n     // Corresponds to the part of the route that will be rendered on the server.\n     node: createPendingCacheNode(\n+      navigatedAt,\n       routerState,\n       prefetchData,\n       prefetchHead,\n@@ -841,6 +914,7 @@ function finishTaskUsingDynamicDataPayload(\n }\n \n function createPendingCacheNode(\n+  navigatedAt: number,\n   routerState: FlightRouterState,\n   prefetchData: CacheNodeSeedData | null,\n   prefetchHead: HeadData | null,\n@@ -868,6 +942,7 @@ function createPendingCacheNode(\n     const segmentKeyChild = createRouterCacheKey(segmentChild)\n \n     const newCacheNodeChild = createPendingCacheNode(\n+      navigatedAt,\n       routerStateChild,\n       prefetchDataChild === undefined ? null : prefetchDataChild,\n       prefetchHead,\n@@ -913,6 +988,8 @@ function createPendingCacheNode(\n     // response is received from the server.\n     rsc: createDeferredRsc() as React.ReactNode,\n     head: isLeafSegment ? (createDeferredRsc() as React.ReactNode) : null,\n+\n+    navigatedAt,\n   }\n }\n \n@@ -1154,6 +1231,8 @@ export function updateCacheNodeOnPopstateRestoration(\n \n     // These are the cloned children we computed above\n     parallelRoutes: newParallelRoutes,\n+\n+    navigatedAt: oldCacheNode.navigatedAt,\n   }\n }\n "
        },
        {
            "sha": "0d6a16925e1d48847a43c2d7615dfe39c1e2b29d",
            "filename": "packages/next/src/client/components/router-reducer/prefetch-cache-utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -394,7 +394,7 @@ export function prunePrefetchCache(\n \n // These values are set by `define-env-plugin` (based on `nextConfig.experimental.staleTimes`)\n // and default to 5 minutes (static) / 0 seconds (dynamic)\n-const DYNAMIC_STALETIME_MS =\n+export const DYNAMIC_STALETIME_MS =\n   Number(process.env.__NEXT_CLIENT_ROUTER_DYNAMIC_STALETIME) * 1000\n \n export const STATIC_STALETIME_MS ="
        },
        {
            "sha": "a1b0973e9d706612461bcb39b6d3e6b0f41d419d",
            "filename": "packages/next/src/client/components/router-reducer/reducers/find-head-in-cache.test.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.test.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -2,6 +2,8 @@ import type { FlightRouterState } from '../../../../server/app-render/types'\n import type { CacheNode } from '../../../../shared/lib/app-router-context.shared-runtime'\n import { findHeadInCache } from './find-head-in-cache'\n \n+const navigatedAt = -1\n+\n describe('findHeadInCache', () => {\n   it('should find the head', () => {\n     const routerTree: FlightRouterState = [\n@@ -25,6 +27,7 @@ describe('findHeadInCache', () => {\n     ]\n \n     const cache: CacheNode = {\n+      navigatedAt,\n       lazyData: null,\n       rsc: null,\n       prefetchRsc: null,\n@@ -38,6 +41,7 @@ describe('findHeadInCache', () => {\n             [\n               'linking',\n               {\n+                navigatedAt,\n                 lazyData: null,\n                 rsc: null,\n                 prefetchRsc: null,\n@@ -51,6 +55,7 @@ describe('findHeadInCache', () => {\n                       [\n                         'about',\n                         {\n+                          navigatedAt,\n                           lazyData: null,\n                           head: null,\n                           prefetchHead: null,\n@@ -62,6 +67,7 @@ describe('findHeadInCache', () => {\n                                 [\n                                   '',\n                                   {\n+                                    navigatedAt,\n                                     lazyData: null,\n                                     rsc: null,\n                                     prefetchRsc: null,"
        },
        {
            "sha": "6c18ad622732b609523f6b3bff66f6e79387a2fb",
            "filename": "packages/next/src/client/components/router-reducer/reducers/hmr-refresh-reducer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -34,6 +34,7 @@ function hmrRefreshReducerImpl(\n \n   // TODO-APP: verify that `href` is not an external url.\n   // Fetch data from the root of the tree.\n+  const navigatedAt = Date.now()\n   cache.lazyData = fetchServerResponse(new URL(href, origin), {\n     flightRouterState: [state.tree[0], state.tree[1], state.tree[2], 'refetch'],\n     nextUrl: includeNextUrl ? state.nextUrl : null,\n@@ -95,6 +96,7 @@ function hmrRefreshReducerImpl(\n           mutable.canonicalUrl = canonicalUrlOverrideHref\n         }\n         const applied = applyFlightData(\n+          navigatedAt,\n           currentCache,\n           cache,\n           normalizedFlightData"
        },
        {
            "sha": "81ad9eae52c2f2b024089be0837fa1e7ac86d9b8",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -226,16 +226,19 @@ export function navigateReducer(\n \n   return data.then(\n     ({ flightData, canonicalUrl: canonicalUrlOverride, postponed }) => {\n+      const navigatedAt = Date.now()\n+\n       let isFirstRead = false\n       // we only want to mark this once\n       if (!prefetchValues.lastUsedTime) {\n         // important: we should only mark the cache node as dirty after we unsuspend from the call above\n-        prefetchValues.lastUsedTime = Date.now()\n+        prefetchValues.lastUsedTime = navigatedAt\n         isFirstRead = true\n       }\n \n       if (prefetchValues.aliased) {\n         const result = handleAliasedPrefetchEntry(\n+          navigatedAt,\n           state,\n           flightData,\n           url,\n@@ -328,6 +331,7 @@ export function navigateReducer(\n             postponed\n           ) {\n             const task = startPPRNavigation(\n+              navigatedAt,\n               currentCache,\n               currentTree,\n               treePatch,\n@@ -427,9 +431,10 @@ export function navigateReducer(\n               )\n               // since we re-used the stale cache's loading state & refreshed the data,\n               // update the `lastUsedTime` so that it can continue to be re-used for the next 30s\n-              prefetchValues.lastUsedTime = Date.now()\n+              prefetchValues.lastUsedTime = navigatedAt\n             } else {\n               applied = applyFlightData(\n+                navigatedAt,\n                 currentCache,\n                 cache,\n                 normalizedFlightData,"
        },
        {
            "sha": "32383d97ba4e22baf072bd9373b697426eafa348",
            "filename": "packages/next/src/client/components/router-reducer/reducers/refresh-reducer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -48,6 +48,7 @@ export function refreshReducer(\n     nextUrl: includeNextUrl ? state.nextUrl : null,\n   })\n \n+  const navigatedAt = Date.now()\n   return cache.lazyData.then(\n     async ({ flightData, canonicalUrl: canonicalUrlOverride }) => {\n       // Handle case when navigating to page in `pages` from `app`\n@@ -114,6 +115,7 @@ export function refreshReducer(\n           cache.prefetchRsc = null\n           cache.loading = loading\n           fillLazyItemsTillLeafWithHead(\n+            navigatedAt,\n             cache,\n             // Existing cache is not passed in as `router.refresh()` has to invalidate the entire cache.\n             undefined,\n@@ -130,6 +132,7 @@ export function refreshReducer(\n         }\n \n         await refreshInactiveParallelSegments({\n+          navigatedAt,\n           state,\n           updatedTree: newTree,\n           updatedCache: cache,"
        },
        {
            "sha": "aec15423eaa0f88848ef5eeae6e25649fe785ade",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -222,6 +222,8 @@ export function serverActionReducer(\n       ? state.nextUrl\n       : null\n \n+  const navigatedAt = Date.now()\n+\n   return fetchServerAction(state, nextUrl, action).then(\n     async ({\n       actionResult,\n@@ -329,6 +331,7 @@ export function serverActionReducer(\n           cache.prefetchRsc = null\n           cache.loading = cacheNodeSeedData[3]\n           fillLazyItemsTillLeafWithHead(\n+            navigatedAt,\n             cache,\n             // Existing cache is not passed in as server actions have to invalidate the entire cache.\n             undefined,\n@@ -346,6 +349,7 @@ export function serverActionReducer(\n           }\n           if (actionRevalidated) {\n             await refreshInactiveParallelSegments({\n+              navigatedAt,\n               state,\n               updatedTree: newTree,\n               updatedCache: cache,"
        },
        {
            "sha": "a8931b5863a28538100b7c783a15a1e4dbadfd92",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-patch-reducer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -19,6 +19,7 @@ export function serverPatchReducer(\n ): ReducerState {\n   const {\n     serverResponse: { flightData, canonicalUrl: canonicalUrlOverride },\n+    navigatedAt,\n   } = action\n \n   const mutable: Mutable = {}\n@@ -77,7 +78,7 @@ export function serverPatchReducer(\n     }\n \n     const cache: CacheNode = createEmptyCacheNode()\n-    applyFlightData(currentCache, cache, normalizedFlightData)\n+    applyFlightData(navigatedAt, currentCache, cache, normalizedFlightData)\n \n     mutable.patchedTree = newTree\n     mutable.cache = cache"
        },
        {
            "sha": "17c0d4ef8326007d6b32af80fe4ca17228663933",
            "filename": "packages/next/src/client/components/router-reducer/refetch-inactive-parallel-segments.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -6,6 +6,7 @@ import { fetchServerResponse } from './fetch-server-response'\n import { PAGE_SEGMENT_KEY } from '../../../shared/lib/segment'\n \n interface RefreshInactiveParallelSegments {\n+  navigatedAt: number\n   state: AppRouterState\n   updatedTree: FlightRouterState\n   updatedCache: CacheNode\n@@ -36,6 +37,7 @@ export async function refreshInactiveParallelSegments(\n }\n \n async function refreshInactiveParallelSegmentsImpl({\n+  navigatedAt,\n   state,\n   updatedTree,\n   updatedCache,\n@@ -76,7 +78,12 @@ async function refreshInactiveParallelSegmentsImpl({\n           // we only pass the new cache as this function is called after clearing the router cache\n           // and filling in the new page data from the server. Meaning the existing cache is actually the cache that's\n           // just been created & has been written to, but hasn't been \"committed\" yet.\n-          applyFlightData(updatedCache, updatedCache, flightDataPath)\n+          applyFlightData(\n+            navigatedAt,\n+            updatedCache,\n+            updatedCache,\n+            flightDataPath\n+          )\n         }\n       } else {\n         // When flightData is a string, it suggests that the server response should have triggered an MPA navigation\n@@ -90,6 +97,7 @@ async function refreshInactiveParallelSegmentsImpl({\n \n   for (const key in parallelRoutes) {\n     const parallelFetchPromise = refreshInactiveParallelSegmentsImpl({\n+      navigatedAt,\n       state,\n       updatedTree: parallelRoutes[key],\n       updatedCache,"
        },
        {
            "sha": "2183326da66682723ae8a99259ff44dc388712f7",
            "filename": "packages/next/src/client/components/router-reducer/router-reducer-types.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -14,9 +14,11 @@ export const ACTION_HMR_REFRESH = 'hmr-refresh'\n export const ACTION_SERVER_ACTION = 'server-action'\n \n export type RouterChangeByServerResponse = ({\n+  navigatedAt,\n   previousTree,\n   serverResponse,\n }: {\n+  navigatedAt: number\n   previousTree: FlightRouterState\n   serverResponse: FetchServerResponseResult\n }) => void\n@@ -131,6 +133,7 @@ export interface RestoreAction {\n  */\n export interface ServerPatchAction {\n   type: typeof ACTION_SERVER_PATCH\n+  navigatedAt: number\n   serverResponse: FetchServerResponseResult\n   previousTree: FlightRouterState\n }"
        },
        {
            "sha": "7535cd7ecdd1bcf627b0fa4eb681b83c96f49d36",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -123,6 +123,7 @@ export function navigate(\n     const isPrefetchHeadPartial = route.isHeadPartial\n     const newCanonicalUrl = route.canonicalUrl\n     return navigateUsingPrefetchedRouteTree(\n+      now,\n       url,\n       nextUrl,\n       isSamePageNavigation,\n@@ -141,6 +142,7 @@ export function navigate(\n   return {\n     tag: NavigationResultTag.Async,\n     data: navigateDynamicallyWithNoPrefetch(\n+      now,\n       url,\n       nextUrl,\n       isSamePageNavigation,\n@@ -153,6 +155,7 @@ export function navigate(\n }\n \n function navigateUsingPrefetchedRouteTree(\n+  now: number,\n   url: URL,\n   nextUrl: string | null,\n   isSamePageNavigation: boolean,\n@@ -174,6 +177,7 @@ function navigateUsingPrefetchedRouteTree(\n   // so we can share code with the old prefetching implementation.\n   const scrollableSegments: Array<FlightSegmentPath> = []\n   const task = startPPRNavigation(\n+    now,\n     currentCacheNode,\n     currentFlightRouterState,\n     prefetchFlightRouterState,\n@@ -339,6 +343,7 @@ function readRenderSnapshotFromCache(\n }\n \n async function navigateDynamicallyWithNoPrefetch(\n+  now: number,\n   url: URL,\n   nextUrl: string | null,\n   isSamePageNavigation: boolean,\n@@ -398,6 +403,7 @@ async function navigateDynamicallyWithNoPrefetch(\n   // Now we proceed exactly as we would for normal navigation.\n   const scrollableSegments: Array<FlightSegmentPath> = []\n   const task = startPPRNavigation(\n+    now,\n     currentCacheNode,\n     currentFlightRouterState,\n     prefetchFlightRouterState,"
        },
        {
            "sha": "f68b225e24fda5d22933b3ac50dbcb56a8a216e3",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -1058,6 +1058,9 @@ function App<T>({\n   )\n \n   const initialState = createInitialRouterState({\n+    // This is not used during hydration, so we don't have to pass a\n+    // real timestamp.\n+    navigatedAt: -1,\n     initialFlightData: response.f,\n     initialCanonicalUrlParts: response.c,\n     initialParallelRoutes: new Map(),\n@@ -1122,6 +1125,9 @@ function ErrorApp<T>({\n   )\n \n   const initialState = createInitialRouterState({\n+    // This is not used during hydration, so we don't have to pass a\n+    // real timestamp.\n+    navigatedAt: -1,\n     initialFlightData: response.f,\n     initialCanonicalUrlParts: response.c,\n     initialParallelRoutes: new Map(),"
        },
        {
            "sha": "9c2ac9064b2930c23d5c3fe1c2d7c22ceabaea98",
            "filename": "packages/next/src/shared/lib/app-router-context.shared-runtime.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -65,6 +65,13 @@ export type LazyCacheNode = {\n    * Child parallel routes.\n    */\n   parallelRoutes: Map<string, ChildSegmentMap>\n+\n+  /**\n+   * The timestamp of the navigation that last updated the CacheNode's data. If\n+   * a CacheNode is reused from a previous navigation, this value is not\n+   * updated. Used to track the staleness of the data.\n+   */\n+  navigatedAt: number\n }\n \n export type ReadyCacheNode = {\n@@ -105,6 +112,8 @@ export type ReadyCacheNode = {\n   loading: LoadingModuleData | Promise<LoadingModuleData>\n \n   parallelRoutes: Map<string, ChildSegmentMap>\n+\n+  navigatedAt: number\n }\n \n export interface NavigateOptions {"
        },
        {
            "sha": "bc483869639e316e38a3c302f62761d48e30da9e",
            "filename": "test/development/app-dir/error-overlay/error-ignored-frames/error-ignored-frames.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -45,8 +45,8 @@ describe('error-ignored-frames', () => {\n        at processFullStringRow ()\n        at processFullBinaryRow ()\n        at progress ()\n-       at InnerLayoutRouter (../src/client/components/layout-router.tsx (413:5))\n-       at OuterLayoutRouter (../src/client/components/layout-router.tsx (612:19))\"\n+       at InnerLayoutRouter (../src/client/components/layout-router.tsx (415:5))\n+       at OuterLayoutRouter (../src/client/components/layout-router.tsx (615:19))\"\n       `)\n     }\n   })"
        },
        {
            "sha": "fdff330cd562737df0029d928e381a82c2e1bd9b",
            "filename": "test/e2e/app-dir/segment-cache/staleness/app/dynamic/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fdynamic%2Fpage.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -0,0 +1,15 @@\n+import { Suspense } from 'react'\n+import { connection } from 'next/server'\n+\n+async function Content() {\n+  await connection()\n+  return <div id=\"dynamic-content\">Dynamic content</div>\n+}\n+\n+export default function Page() {\n+  return (\n+    <Suspense fallback=\"Loading...\">\n+      <Content />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "f948420858f76c88b9d322058bd3f16c0eba9b3c",
            "filename": "test/e2e/app-dir/segment-cache/staleness/app/page.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fapp%2Fpage.tsx?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -20,6 +20,9 @@ export default function Page() {\n             Page with stale time of 10 minutes\n           </LinkAccordion>\n         </li>\n+        <li>\n+          <LinkAccordion href=\"/dynamic\">Page with dynamic data</LinkAccordion>\n+        </li>\n       </ul>\n     </>\n   )"
        },
        {
            "sha": "6d88eaf9a30caed876bd81e5184b4ea2c33e7dff",
            "filename": "test/e2e/app-dir/segment-cache/staleness/next.config.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fnext.config.js?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -6,6 +6,9 @@ const nextConfig = {\n     ppr: true,\n     dynamicIO: true,\n     clientSegmentCache: true,\n+    staleTimes: {\n+      dynamic: 30,\n+    },\n   },\n }\n "
        },
        {
            "sha": "ad738f0067a71abd424d32b2e9131c846e943e03",
            "filename": "test/e2e/app-dir/segment-cache/staleness/segment-cache-stale-time.test.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5195704e96547673f2ca71f2ba8e2dabc652e76f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts?ref=5195704e96547673f2ca71f2ba8e2dabc652e76f",
            "patch": "@@ -79,4 +79,75 @@ describe('segment cache (staleness)', () => {\n       'no-requests'\n     )\n   })\n+\n+  it('reuses dynamic data up to the staleTimes.dynamic threshold', async () => {\n+    let page: Playwright.Page\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p: Playwright.Page) {\n+        page = p\n+      },\n+    })\n+    const act = createRouterAct(page)\n+\n+    await page.clock.install()\n+\n+    // Navigate to the dynamic page\n+    await act(\n+      async () => {\n+        const toggle = await browser.elementByCss(\n+          'input[data-link-accordion=\"/dynamic\"]'\n+        )\n+        await toggle.click()\n+        const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n+        await link.click()\n+      },\n+      {\n+        includes: 'Dynamic content',\n+      }\n+    )\n+    expect(await browser.elementById('dynamic-content').text()).toBe(\n+      'Dynamic content'\n+    )\n+\n+    await browser.back()\n+\n+    // Fast forward 29 seconds. staleTimes.dynamic is configured as 30s, so if\n+    // we navigate to the same link again, the old data should be reused without\n+    // a new network request.\n+    await page.clock.fastForward(29 * 1000)\n+\n+    await act(async () => {\n+      const toggle = await browser.elementByCss(\n+        'input[data-link-accordion=\"/dynamic\"]'\n+      )\n+      await toggle.click()\n+      const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n+      await link.click()\n+      // The next page is immediately rendered\n+      expect(await browser.elementById('dynamic-content').text()).toBe(\n+        'Dynamic content'\n+      )\n+    }, 'no-requests')\n+\n+    await browser.back()\n+\n+    // Fast forward an additional second. This time, if we navigate to the link\n+    // again, the data is stale, so we issue a new request.\n+    await page.clock.fastForward(1 * 1000)\n+\n+    await act(\n+      async () => {\n+        const toggle = await browser.elementByCss(\n+          'input[data-link-accordion=\"/dynamic\"]'\n+        )\n+        await toggle.click()\n+        const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n+        await link.click()\n+      },\n+      { includes: 'Dynamic content' }\n+    )\n+    expect(await browser.elementById('dynamic-content').text()).toBe(\n+      'Dynamic content'\n+    )\n+  })\n })"
        }
    ],
    "stats": {
        "total": 438,
        "additions": 390,
        "deletions": 48
    }
}