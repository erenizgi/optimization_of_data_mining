{
    "author": "ztanner",
    "message": "[segment cache]: fix trailingSlash handling with output: export (#84465)\n\nWhen `output: export`, `experimental.clientSegmentCache`, and\n`trailingSlash: true` were all enabled, clicking links would update the\nURL but fail to render the page content. The issue was in how segment\ncache URLs were being constructed for static export mode.\n\n\nWhen a URL had a trailing slash (like /another/), the code tried to\nstrip it using `substring(0, -1)`. However, substring() treats negative\nindices as 0, so this became `substring(0, 0)` and returned an empty\nstring. This meant URLs like /another/ would generate segment requests\nto `/__next._tree.txt` instead of `/another/__next._tree.txt`.\n\nI also updated the brittle snapshot-like tests that were in here as well\nsince we output more files with segment cache. I don't think this type\nof test adds that much value but didn't want to change any test\nbehavior.",
    "sha": "047e641442a6043294fecc65b857470e387db0ea",
    "files": [
        {
            "sha": "552bef2cfdaf9318ae157a7ddbc81868288f85f1",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/047e641442a6043294fecc65b857470e387db0ea/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/047e641442a6043294fecc65b857470e387db0ea/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=047e641442a6043294fecc65b857470e387db0ea",
            "patch": "@@ -2203,7 +2203,7 @@ function addSegmentPathToUrlInOutputExportMode(\n     // path. Instead, we append it to the end of the pathname.\n     const staticUrl = new URL(url)\n     const routeDir = staticUrl.pathname.endsWith('/')\n-      ? staticUrl.pathname.substring(0, -1)\n+      ? staticUrl.pathname.slice(0, -1)\n       : staticUrl.pathname\n     const staticExportFilename =\n       convertSegmentPathToStaticExportFilename(segmentPath)"
        },
        {
            "sha": "6eb58cfbcdec7a790adad3a7ab0394974b5ab03c",
            "filename": "test/client-segment-cache-tests-manifest.json",
            "status": "modified",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/047e641442a6043294fecc65b857470e387db0ea/test%2Fclient-segment-cache-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/047e641442a6043294fecc65b857470e387db0ea/test%2Fclient-segment-cache-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fclient-segment-cache-tests-manifest.json?ref=047e641442a6043294fecc65b857470e387db0ea",
            "patch": "@@ -87,30 +87,6 @@\n         \"app dir - form prefetching should prefetch a loading state for the form's target\"\n       ]\n     },\n-    \"test/integration/app-dir-export/test/config.test.ts\": {\n-      \"failed\": [\n-        \"app dir - with output export (next dev / next build) production mode should correctly emit exported assets to config.distDir\"\n-      ]\n-    },\n-    \"test/integration/app-dir-export/test/dynamicapiroute-prod.test.ts\": {\n-      \"failed\": [\n-        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicApiRoute 'error'\",\n-        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicApiRoute 'force-static'\"\n-      ]\n-    },\n-    \"test/integration/app-dir-export/test/dynamicpage-prod.test.ts\": {\n-      \"failed\": [\n-        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage 'error'\",\n-        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage 'force-static'\",\n-        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage undefined\"\n-      ]\n-    },\n-    \"test/integration/app-dir-export/test/trailing-slash-start.test.ts\": {\n-      \"failed\": [\n-        \"app dir - with output export - trailing slash prod production mode should work in prod with trailingSlash 'false'\",\n-        \"app dir - with output export - trailing slash prod production mode should work in prod with trailingSlash 'true'\"\n-      ]\n-    },\n     \"test/production/app-dir/build-output-prerender/build-output-prerender.test.ts\": {\n       \"failed\": [\n         \"build-output-prerender with a next config file with --debug-prerender prints a warning and the customized experimental flags\","
        },
        {
            "sha": "6886211a9e29aaf765891cce8b904600cd287d7f",
            "filename": "test/integration/app-dir-export/test/utils.ts",
            "status": "modified",
            "additions": 206,
            "deletions": 64,
            "changes": 270,
            "blob_url": "https://github.com/vercel/next.js/blob/047e641442a6043294fecc65b857470e387db0ea/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/047e641442a6043294fecc65b857470e387db0ea/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts?ref=047e641442a6043294fecc65b857470e387db0ea",
            "patch": "@@ -28,71 +28,213 @@ export const nextConfig = new File(join(appDir, 'next.config.js'))\n const slugPage = new File(join(appDir, 'app/another/[slug]/page.js'))\n const apiJson = new File(join(appDir, 'app/api/json/route.js'))\n \n-export const expectedWhenTrailingSlashTrue = [\n-  '404.html',\n-  '404/index.html',\n-  // Turbopack and plain next.js have different hash output for the file name\n-  // Turbopack will output favicon in the _next/static/media folder\n-  ...(process.env.IS_TURBOPACK_TEST\n-    ? [expect.stringMatching(/_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/)]\n-    : []),\n-  expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n-  '_next/static/test-build-id/_buildManifest.js',\n-  ...(process.env.IS_TURBOPACK_TEST\n-    ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n-    : []),\n-  '_next/static/test-build-id/_ssgManifest.js',\n-  '_not-found/index.html',\n-  '_not-found/index.txt',\n-  'another/first/index.html',\n-  'another/first/index.txt',\n-  'another/index.html',\n-  'another/index.txt',\n-  'another/second/index.html',\n-  'another/second/index.txt',\n-  'api/json',\n-  'api/txt',\n-  'client/index.html',\n-  'client/index.txt',\n-  'favicon.ico',\n-  'image-import/index.html',\n-  'image-import/index.txt',\n-  'index.html',\n-  'index.txt',\n-  'robots.txt',\n-]\n+export const expectedWhenTrailingSlashTrue = process.env\n+  .__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE\n+  ? [\n+      '404.html',\n+      '404/index.html',\n+      '__next.__PAGE__.txt',\n+      '__next._index.txt',\n+      '__next._tree.txt',\n+      // Turbopack and plain next.js have different hash output for the file name\n+      // Turbopack will output favicon in the _next/static/media folder\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? [\n+            expect.stringMatching(\n+              /_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/\n+            ),\n+          ]\n+        : []),\n+      expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n+      '_next/static/test-build-id/_buildManifest.js',\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n+        : []),\n+      '_next/static/test-build-id/_ssgManifest.js',\n+      '_not-found/__next._index.txt',\n+      '_not-found/__next._not-found.__PAGE__.txt',\n+      '_not-found/__next._not-found.txt',\n+      '_not-found/__next._tree.txt',\n+      '_not-found/index.html',\n+      '_not-found/index.txt',\n+      'another/__next._index.txt',\n+      'another/__next._tree.txt',\n+      'another/__next.another.__PAGE__.txt',\n+      'another/__next.another.txt',\n+      'another/first/__next._index.txt',\n+      'another/first/__next._tree.txt',\n+      'another/first/__next.another.$d$slug.__PAGE__.txt',\n+      'another/first/__next.another.$d$slug.txt',\n+      'another/first/__next.another.txt',\n+      'another/first/index.html',\n+      'another/first/index.txt',\n+      'another/index.html',\n+      'another/index.txt',\n+      'another/second/__next._index.txt',\n+      'another/second/__next._tree.txt',\n+      'another/second/__next.another.$d$slug.__PAGE__.txt',\n+      'another/second/__next.another.$d$slug.txt',\n+      'another/second/__next.another.txt',\n+      'another/second/index.html',\n+      'another/second/index.txt',\n+      'api/json',\n+      'api/txt',\n+      'client/__next._index.txt',\n+      'client/__next._tree.txt',\n+      'client/__next.client.__PAGE__.txt',\n+      'client/__next.client.txt',\n+      'client/index.html',\n+      'client/index.txt',\n+      'favicon.ico',\n+      'image-import/__next._index.txt',\n+      'image-import/__next._tree.txt',\n+      'image-import/__next.image-import.__PAGE__.txt',\n+      'image-import/__next.image-import.txt',\n+      'image-import/index.html',\n+      'image-import/index.txt',\n+      'index.html',\n+      'index.txt',\n+      'robots.txt',\n+    ]\n+  : [\n+      '404.html',\n+      '404/index.html',\n+      // Turbopack and plain next.js have different hash output for the file name\n+      // Turbopack will output favicon in the _next/static/media folder\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? [\n+            expect.stringMatching(\n+              /_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/\n+            ),\n+          ]\n+        : []),\n+      expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n+      '_next/static/test-build-id/_buildManifest.js',\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n+        : []),\n+      '_next/static/test-build-id/_ssgManifest.js',\n+      '_not-found/index.html',\n+      '_not-found/index.txt',\n+      'another/first/index.html',\n+      'another/first/index.txt',\n+      'another/index.html',\n+      'another/index.txt',\n+      'another/second/index.html',\n+      'another/second/index.txt',\n+      'api/json',\n+      'api/txt',\n+      'client/index.html',\n+      'client/index.txt',\n+      'favicon.ico',\n+      'image-import/index.html',\n+      'image-import/index.txt',\n+      'index.html',\n+      'index.txt',\n+      'robots.txt',\n+    ]\n \n-const expectedWhenTrailingSlashFalse = [\n-  '404.html',\n-  // Turbopack will output favicon in the _next/static/media folder\n-  ...(process.env.IS_TURBOPACK_TEST\n-    ? [expect.stringMatching(/_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/)]\n-    : []),\n-  expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n-  '_next/static/test-build-id/_buildManifest.js',\n-  ...(process.env.IS_TURBOPACK_TEST\n-    ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n-    : []),\n-  '_next/static/test-build-id/_ssgManifest.js',\n-  '_not-found.html',\n-  '_not-found.txt',\n-  'another.html',\n-  'another.txt',\n-  'another/first.html',\n-  'another/first.txt',\n-  'another/second.html',\n-  'another/second.txt',\n-  'api/json',\n-  'api/txt',\n-  'client.html',\n-  'client.txt',\n-  'favicon.ico',\n-  'image-import.html',\n-  'image-import.txt',\n-  'index.html',\n-  'index.txt',\n-  'robots.txt',\n-]\n+const expectedWhenTrailingSlashFalse = process.env\n+  .__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE\n+  ? [\n+      '404.html',\n+      '__next.__PAGE__.txt',\n+      '__next._index.txt',\n+      '__next._tree.txt',\n+      // Turbopack will output favicon in the _next/static/media folder\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? [\n+            expect.stringMatching(\n+              /_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/\n+            ),\n+          ]\n+        : []),\n+      expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n+      '_next/static/test-build-id/_buildManifest.js',\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n+        : []),\n+      '_next/static/test-build-id/_ssgManifest.js',\n+      '_not-found.html',\n+      '_not-found.txt',\n+      '_not-found/__next._index.txt',\n+      '_not-found/__next._not-found.__PAGE__.txt',\n+      '_not-found/__next._not-found.txt',\n+      '_not-found/__next._tree.txt',\n+      'another.html',\n+      'another.txt',\n+      'another/__next._index.txt',\n+      'another/__next._tree.txt',\n+      'another/__next.another.__PAGE__.txt',\n+      'another/__next.another.txt',\n+      'another/first.html',\n+      'another/first.txt',\n+      'another/first/__next._index.txt',\n+      'another/first/__next._tree.txt',\n+      'another/first/__next.another.$d$slug.__PAGE__.txt',\n+      'another/first/__next.another.$d$slug.txt',\n+      'another/first/__next.another.txt',\n+      'another/second.html',\n+      'another/second.txt',\n+      'another/second/__next._index.txt',\n+      'another/second/__next._tree.txt',\n+      'another/second/__next.another.$d$slug.__PAGE__.txt',\n+      'another/second/__next.another.$d$slug.txt',\n+      'another/second/__next.another.txt',\n+      'api/json',\n+      'api/txt',\n+      'client.html',\n+      'client.txt',\n+      'client/__next._index.txt',\n+      'client/__next._tree.txt',\n+      'client/__next.client.__PAGE__.txt',\n+      'client/__next.client.txt',\n+      'favicon.ico',\n+      'image-import.html',\n+      'image-import.txt',\n+      'image-import/__next._index.txt',\n+      'image-import/__next._tree.txt',\n+      'image-import/__next.image-import.__PAGE__.txt',\n+      'image-import/__next.image-import.txt',\n+      'index.html',\n+      'index.txt',\n+      'robots.txt',\n+    ]\n+  : [\n+      '404.html',\n+      // Turbopack will output favicon in the _next/static/media folder\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? [\n+            expect.stringMatching(\n+              /_next\\/static\\/media\\/favicon\\.[0-9a-f]+\\.ico/\n+            ),\n+          ]\n+        : []),\n+      expect.stringMatching(/_next\\/static\\/media\\/test\\.[0-9a-f]+\\.png/),\n+      '_next/static/test-build-id/_buildManifest.js',\n+      ...(process.env.IS_TURBOPACK_TEST\n+        ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n+        : []),\n+      '_next/static/test-build-id/_ssgManifest.js',\n+      '_not-found.html',\n+      '_not-found.txt',\n+      'another.html',\n+      'another.txt',\n+      'another/first.html',\n+      'another/first.txt',\n+      'another/second.html',\n+      'another/second.txt',\n+      'api/json',\n+      'api/txt',\n+      'client.html',\n+      'client.txt',\n+      'favicon.ico',\n+      'image-import.html',\n+      'image-import.txt',\n+      'index.html',\n+      'index.txt',\n+      'robots.txt',\n+    ]\n \n export async function getFiles(cwd = exportDir) {\n   const opts = { cwd, nodir: true }"
        }
    ],
    "stats": {
        "total": 296,
        "additions": 207,
        "deletions": 89
    }
}