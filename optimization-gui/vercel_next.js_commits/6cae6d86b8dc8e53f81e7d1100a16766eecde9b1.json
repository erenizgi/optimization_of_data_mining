{
    "author": "icyJoseph",
    "message": "docs: polyfills usage in app router (#80447)\n\nCloses:\nhttps://linear.app/vercel/issue/DOC-4752/docs-polyfills-in-app-router\n\nFixes: https://github.com/vercel/next.js/issues/74730",
    "sha": "6cae6d86b8dc8e53f81e7d1100a16766eecde9b1",
    "files": [
        {
            "sha": "71220570bc6b5c9a66b30bc3f42a9eb6a35447c0",
            "filename": "docs/01-app/03-api-reference/03-file-conventions/instrumentation-client.mdx",
            "status": "modified",
            "additions": 180,
            "deletions": 2,
            "changes": 182,
            "blob_url": "https://github.com/vercel/next.js/blob/6cae6d86b8dc8e53f81e7d1100a16766eecde9b1/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Finstrumentation-client.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/6cae6d86b8dc8e53f81e7d1100a16766eecde9b1/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Finstrumentation-client.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F03-file-conventions%2Finstrumentation-client.mdx?ref=6cae6d86b8dc8e53f81e7d1100a16766eecde9b1",
            "patch": "@@ -3,7 +3,7 @@ title: instrumentation-client.js\n description: Learn how to add client-side instrumentation to track and monitor your Next.js application's frontend performance.\n ---\n \n-The `instrumentation-client.js|ts` file allows you to add monitoring and analytics code that runs before your application's frontend code starts executing. This is useful for setting up performance tracking, error monitoring, or any other client-side observability tools.\n+The `instrumentation-client.js|ts` file allows you to add monitoring, analytics code, and other side-effects that run before your application becomes interactive. This is useful for setting up performance tracking, error monitoring, polyfills, or any other client-side observability tools.\n \n To use it, place the file in the **root** of your application or inside a `src` folder.\n \n@@ -39,7 +39,185 @@ window.addEventListener('error', (event) => {\n })\n ```\n \n-## Version History\n+**Error handling:** Implement try-catch blocks around your instrumentation code to ensure robust monitoring. This prevents individual tracking failures from affecting other instrumentation features.\n+\n+## Router navigation tracking\n+\n+You can export an `onRouterTransitionStart` function to receive notifications when navigation begins:\n+\n+```ts filename=\"instrumentation-client.ts\" switcher\n+performance.mark('app-init')\n+\n+export function onRouterTransitionStart(\n+  url: string,\n+  navigationType: 'push' | 'replace' | 'traverse'\n+) {\n+  console.log(`Navigation started: ${navigationType} to ${url}`)\n+  performance.mark(`nav-start-${Date.now()}`)\n+}\n+```\n+\n+```js filename=\"instrumentation-client.js\" switcher\n+performance.mark('app-init')\n+\n+export function onRouterTransitionStart(url, navigationType) {\n+  console.log(`Navigation started: ${navigationType} to ${url}`)\n+  performance.mark(`nav-start-${Date.now()}`)\n+}\n+```\n+\n+The `onRouterTransitionStart` function receives two parameters:\n+\n+- `url: string` - The URL being navigated to\n+- `navigationType: 'push' | 'replace' | 'traverse'` - The type of navigation\n+\n+## Performance considerations\n+\n+Keep instrumentation code lightweight.\n+\n+Next.js monitors initialization time in development and will log warnings if it takes longer than 16ms, which could impact smooth page loading.\n+\n+## Execution timing\n+\n+The `instrumentation-client.js` file executes at a specific point in the application lifecycle:\n+\n+1. **After** the HTML document is loaded\n+2. **Before** React hydration begins\n+3. **Before** user interactions are possible\n+\n+This timing makes it ideal for setting up error tracking, analytics, and performance monitoring that needs to capture early application lifecycle events.\n+\n+## Examples\n+\n+### Error tracking\n+\n+Initialize error tracking before React starts and add navigation breadcrumbs for better debugging context.\n+\n+```ts filename=\"instrumentation-client.ts\" switcher\n+import Monitor from './lib/monitoring'\n+\n+Monitor.initialize()\n+\n+export function onRouterTransitionStart(url: string) {\n+  Monitor.pushEvent({\n+    message: `Navigation to ${url}`,\n+    category: 'navigation',\n+  })\n+}\n+```\n+\n+```js filename=\"instrumentation-client.js\" switcher\n+import Monitor from './lib/monitoring'\n+\n+Monitor.initialize()\n+\n+export function onRouterTransitionStart(url) {\n+  Monitor.pushEvent({\n+    message: `Navigation to ${url}`,\n+    category: 'navigation',\n+  })\n+}\n+```\n+\n+### Analytics tracking\n+\n+Initialize analytics and track navigation events with detailed metadata for user behavior analysis.\n+\n+```ts filename=\"instrumentation-client.ts\" switcher\n+import { analytics } from './lib/analytics'\n+\n+analytics.init()\n+\n+export function onRouterTransitionStart(url: string, navigationType: string) {\n+  analytics.track('page_navigation', {\n+    url,\n+    type: navigationType,\n+    timestamp: Date.now(),\n+  })\n+}\n+```\n+\n+```js filename=\"instrumentation-client.js\" switcher\n+import { analytics } from './lib/analytics'\n+\n+analytics.init()\n+\n+export function onRouterTransitionStart(url, navigationType) {\n+  analytics.track('page_navigation', {\n+    url,\n+    type: navigationType,\n+    timestamp: Date.now(),\n+  })\n+}\n+```\n+\n+### Performance monitoring\n+\n+Track Time to Interactive and navigation performance using the Performance Observer API and performance marks.\n+\n+```ts filename=\"instrumentation-client.ts\" switcher\n+const startTime = performance.now()\n+\n+const observer = new PerformanceObserver(\n+  (list: PerformanceObserverEntryList) => {\n+    for (const entry of list.getEntries()) {\n+      if (entry instanceof PerformanceNavigationTiming) {\n+        console.log('Time to Interactive:', entry.loadEventEnd - startTime)\n+      }\n+    }\n+  }\n+)\n+\n+observer.observe({ entryTypes: ['navigation'] })\n+\n+export function onRouterTransitionStart(url: string) {\n+  performance.mark(`nav-start-${url}`)\n+}\n+```\n+\n+```js filename=\"instrumentation-client.js\" switcher\n+const startTime = performance.now()\n+\n+const observer = new PerformanceObserver((list) => {\n+  for (const entry of list.getEntries()) {\n+    if (entry instanceof PerformanceNavigationTiming) {\n+      console.log('Time to Interactive:', entry.loadEventEnd - startTime)\n+    }\n+  }\n+})\n+\n+observer.observe({ entryTypes: ['navigation'] })\n+\n+export function onRouterTransitionStart(url) {\n+  performance.mark(`nav-start-${url}`)\n+}\n+```\n+\n+### Polyfills\n+\n+Load polyfills before application code runs. Use static imports for immediate loading and dynamic imports for conditional loading based on feature detection.\n+\n+```ts filename=\"instrumentation-client.ts\" switcher\n+import './lib/polyfills'\n+\n+if (!window.ResizeObserver) {\n+  import('./lib/polyfills/resize-observer').then((mod) => {\n+    window.ResizeObserver = mod.default\n+  })\n+}\n+```\n+\n+```js filename=\"instrumentation-client.js\" switcher\n+import './lib/polyfills'\n+\n+if (!window.ResizeObserver) {\n+  import('./lib/polyfills/resize-observer').then((mod) => {\n+    window.ResizeObserver = mod.default\n+  })\n+}\n+```\n+\n+## Version history\n \n | Version | Changes                             |\n | ------- | ----------------------------------- |"
        },
        {
            "sha": "8051d89683f72d0c07340071a3a2cefad724e891",
            "filename": "docs/03-architecture/supported-browsers.mdx",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/6cae6d86b8dc8e53f81e7d1100a16766eecde9b1/docs%2F03-architecture%2Fsupported-browsers.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/6cae6d86b8dc8e53f81e7d1100a16766eecde9b1/docs%2F03-architecture%2Fsupported-browsers.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F03-architecture%2Fsupported-browsers.mdx?ref=6cae6d86b8dc8e53f81e7d1100a16766eecde9b1",
            "patch": "@@ -43,7 +43,57 @@ In addition, to reduce bundle size, Next.js will only load these polyfills for b\n \n If your own code or any external npm dependencies require features not supported by your target browsers (such as IE 11), you need to add polyfills yourself.\n \n+<PagesOnly>\n In this case, you should add a top-level import for the **specific polyfill** you need in your [Custom `<App>`](/docs/pages/building-your-application/routing/custom-app) or the individual component.\n+</PagesOnly>\n+\n+<AppOnly>\n+ \n+To include polyfills, you can import them into the [`instrumentation-client.js` file](/docs/app/api-reference/file-conventions/instrumentation-client).\n+\n+```ts filename=\"instrumentation-client.ts\"\n+import './polyfills'\n+```\n+\n+</AppOnly>\n+\n+The best approach is to isolate unsupported features to specific UI sections and conditionally load the polyfill if needed.\n+\n+```ts filename=\"hooks/analytics.ts\" switcher\n+import { useCallback } from 'react'\n+\n+export const useAnalytics = () => {\n+  const tracker = useCallback(async (data: unknown) => {\n+    if (!('structuredClone' in globalThis)) {\n+      import('polyfills/structured-clone').then((mod) => {\n+        globalThis.structuredClone = mod.default\n+      })\n+    }\n+\n+    /* Do some work that uses structured clone */\n+  }, [])\n+\n+  return tracker\n+}\n+```\n+\n+```js filename=\"hooks/analytics.js\" switcher\n+import { useCallback } from 'react'\n+\n+export const useAnalytics = () => {\n+  const tracker = useCallback(async (data) => {\n+    if (!('structuredClone' in globalThis)) {\n+      import('polyfills/structured-clone').then((mod) => {\n+        globalThis.structuredClone = mod.default\n+      })\n+    }\n+\n+    /* Do some work that uses structured clone */\n+  }, [])\n+\n+  return tracker\n+}\n+```\n \n ## JavaScript Language Features\n "
        }
    ],
    "stats": {
        "total": 232,
        "additions": 230,
        "deletions": 2
    }
}