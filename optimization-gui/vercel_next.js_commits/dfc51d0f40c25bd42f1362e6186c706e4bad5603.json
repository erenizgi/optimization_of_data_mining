{
    "author": "styfle",
    "message": "fix(next/image): handle `?dpl` for src without protocol (#86836)\n\nFollow up to previous PR based on this comment:\nhttps://github.com/vercel/next.js/pull/86485#discussion_r2589758455\n\nWe want to avoid adding `?dpl` when the deployment is an absolute url\nmissing the protocol which is allowed when `unoptimized=true`.",
    "sha": "dfc51d0f40c25bd42f1362e6186c706e4bad5603",
    "files": [
        {
            "sha": "2aff208f5c561a744b40c2acc8fb613099058a56",
            "filename": "packages/next/src/shared/lib/get-img-props.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dfc51d0f40c25bd42f1362e6186c706e4bad5603/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dfc51d0f40c25bd42f1362e6186c706e4bad5603/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts?ref=dfc51d0f40c25bd42f1362e6186c706e4bad5603",
            "patch": "@@ -232,7 +232,7 @@ function generateImgAttrs({\n }: GenImgAttrsData): GenImgAttrsResult {\n   if (unoptimized) {\n     const deploymentId = getDeploymentId()\n-    if (src.startsWith('/') && deploymentId) {\n+    if (src.startsWith('/') && !src.startsWith('//') && deploymentId) {\n       const sep = src.includes('?') ? '&' : '?'\n       src = `${src}${sep}dpl=${deploymentId}`\n     }"
        },
        {
            "sha": "49baeba36a14e8c3a5ac491e0f98f3842e9201f7",
            "filename": "test/unit/next-image-get-img-props.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/dfc51d0f40c25bd42f1362e6186c706e4bad5603/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dfc51d0f40c25bd42f1362e6186c706e4bad5603/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-image-get-img-props.test.ts?ref=dfc51d0f40c25bd42f1362e6186c706e4bad5603",
            "patch": "@@ -796,4 +796,28 @@ describe('getImageProps()', () => {\n       delete process.env.NEXT_DEPLOYMENT_ID\n     }\n   })\n+  it('should not add query string for unoptimized with no protocol when NEXT_DEPLOYMENT_ID defined', async () => {\n+    try {\n+      process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n+      const { props } = getImageProps({\n+        alt: 'a nice desc',\n+        src: '//example.com/test.png',\n+        unoptimized: true,\n+        width: 100,\n+        height: 200,\n+      })\n+      expect(warningMessages).toStrictEqual([])\n+      expect(Object.entries(props)).toStrictEqual([\n+        ['alt', 'a nice desc'],\n+        ['loading', 'lazy'],\n+        ['width', 100],\n+        ['height', 200],\n+        ['decoding', 'async'],\n+        ['style', { color: 'transparent' }],\n+        ['src', '//example.com/test.png'],\n+      ])\n+    } finally {\n+      delete process.env.NEXT_DEPLOYMENT_ID\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 25,
        "deletions": 1
    }
}