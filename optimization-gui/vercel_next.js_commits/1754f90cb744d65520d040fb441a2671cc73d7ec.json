{
    "author": "mischnic",
    "message": "Turbopack: slightly fewer turbo tasks calls during resolving (#86542)\n\nThe difference is barely measureable though...\r\n```\r\nless tasks:\r\n  Time (mean ± σ):      5.429 s ±  0.099 s    [User: 28.337 s, System: 3.512 s]\r\ncanary:\r\n  Time (mean ± σ):      5.547 s ±  0.082 s    [User: 28.730 s, System: 3.480 s]\r\n```",
    "sha": "1754f90cb744d65520d040fb441a2671cc73d7ec",
    "files": [
        {
            "sha": "d44feafa654b91066c682c8c9b4c1bb232b34641",
            "filename": "crates/next-core/src/next_shared/transforms/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -4,6 +4,8 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::Vc;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::ModuleRule;\n+#[allow(unused_imports)]\n+use turbopack_core::{context::AssetContext, resolve::origin::ResolveOrigin};\n \n use crate::next_config::NextConfig;\n \n@@ -29,6 +31,36 @@ pub async fn get_swc_ecma_transform_plugin_rule(\n     }\n }\n \n+/// A resolve origin without any asset_context, intended for handle_resolve_error\n+#[cfg(feature = \"plugin\")]\n+#[turbo_tasks::value]\n+pub struct DummyResolveOrigin {\n+    origin_path: FileSystemPath,\n+}\n+\n+#[cfg(feature = \"plugin\")]\n+#[turbo_tasks::value_impl]\n+impl DummyResolveOrigin {\n+    #[turbo_tasks::function]\n+    pub fn new(origin_path: FileSystemPath) -> Vc<Self> {\n+        DummyResolveOrigin { origin_path }.cell()\n+    }\n+}\n+\n+#[cfg(feature = \"plugin\")]\n+#[turbo_tasks::value_impl]\n+impl ResolveOrigin for DummyResolveOrigin {\n+    #[turbo_tasks::function]\n+    fn origin_path(&self) -> Vc<FileSystemPath> {\n+        self.origin_path.clone().cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn asset_context(&self) -> Result<Vc<Box<dyn AssetContext>>> {\n+        anyhow::bail!(\"DummyResolveOrigin has no asset context\");\n+    }\n+}\n+\n #[cfg(feature = \"plugin\")]\n pub async fn get_swc_ecma_transform_rule_impl(\n     project_path: FileSystemPath,\n@@ -82,7 +114,7 @@ pub async fn get_swc_ecma_transform_rule_impl(\n                     .as_raw_module_result(),\n                     ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined),\n                     // TODO proper error location\n-                    project_path.clone(),\n+                    Vc::upcast(DummyResolveOrigin::new(project_path.clone())),\n                     request,\n                     resolve_options,\n                     false,"
        },
        {
            "sha": "5e7263b05464c3a2a1c2c9a92b72096e678e6372",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -39,7 +39,7 @@ use turbopack_core::{\n     output::{OutputAsset, OutputAssets, OutputAssetsWithReferenced},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n     resolve::{\n-        origin::{PlainResolveOrigin, ResolveOriginExt},\n+        origin::{PlainResolveOrigin, ResolveOrigin, ResolveOriginExt},\n         parse::Request,\n     },\n };\n@@ -287,7 +287,7 @@ async fn build_internal(\n                 let ty = ReferenceType::Entry(EntryReferenceSubType::Undefined);\n                 let request = request_vc.await?;\n                 origin\n-                    .resolve_asset(request_vc, origin.resolve_options(ty.clone()).await?, ty)\n+                    .resolve_asset(request_vc, origin.resolve_options(ty.clone()), ty)\n                     .await?\n                     .first_module()\n                     .await?"
        },
        {
            "sha": "0db486a38b85870c360f49025006d697a6b57eca",
            "filename": "turbopack/crates/turbopack-cli/src/dev/web_entry_source.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -15,7 +15,7 @@ use turbopack_core::{\n     module_graph::{ModuleGraph, chunk_group_info::ChunkGroupEntry},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n     resolve::{\n-        origin::{PlainResolveOrigin, ResolveOriginExt},\n+        origin::{PlainResolveOrigin, ResolveOrigin, ResolveOriginExt},\n         parse::Request,\n     },\n };\n@@ -139,7 +139,7 @@ pub async fn create_web_entry_source(\n         .map(|request| async move {\n             let ty = ReferenceType::Entry(EntryReferenceSubType::Web);\n             Ok(origin\n-                .resolve_asset(request, origin.resolve_options(ty.clone()).await?, ty)\n+                .resolve_asset(request, origin.resolve_options(ty.clone()), ty)\n                 .await?\n                 .resolve()\n                 .await?"
        },
        {
            "sha": "b284ccc01240ff4c068934b6f0e25c277c87eb77",
            "filename": "turbopack/crates/turbopack-core/src/reference/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -4,8 +4,8 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n-    FxIndexSet, NonLocalValue, ReadRef, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt,\n-    ValueToString, Vc, debug::ValueDebugFormat, trace::TraceRawVcs,\n+    FxIndexSet, NonLocalValue, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, ValueToString, Vc,\n+    debug::ValueDebugFormat, trace::TraceRawVcs,\n };\n \n use crate::{\n@@ -299,7 +299,7 @@ pub async fn primary_referenced_modules(module: Vc<Box<dyn Module>>) -> Result<V\n pub struct ResolvedReference {\n     pub chunking_type: ChunkingType,\n     pub binding_usage: BindingUsage,\n-    pub modules: ReadRef<Modules>,\n+    pub modules: Vec<ResolvedVc<Box<dyn Module>>>,\n }\n \n #[turbo_tasks::value(transparent)]\n@@ -330,9 +330,8 @@ pub async fn primary_chunkable_referenced_modules(\n \n                 let resolved = reference\n                     .resolve_reference()\n-                    .resolve()\n                     .await?\n-                    .primary_modules()\n+                    .primary_modules_ref()\n                     .await?;\n                 let binding_usage = reference.binding_usage().owned().await?;\n "
        },
        {
            "sha": "7b037cc1cc12d18421048861dfae5452eaf9505b",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 21,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -24,7 +24,7 @@ use self::{\n         ConditionValue, ImportMapResult, ResolveInPackage, ResolveIntoPackage, ResolveModules,\n         ResolveModulesOptions, ResolveOptions, resolve_modules_options,\n     },\n-    origin::{ResolveOrigin, ResolveOriginExt},\n+    origin::ResolveOrigin,\n     parse::Request,\n     pattern::Pattern,\n     plugin::BeforeResolvePlugin,\n@@ -260,6 +260,17 @@ impl ModuleResolveResult {\n         })\n     }\n \n+    /// Returns a set (no duplicates) of primary modules in the result.\n+    pub async fn primary_modules_ref(&self) -> Result<Vec<ResolvedVc<Box<dyn Module>>>> {\n+        let mut set = FxIndexSet::default();\n+        for (_, item) in self.primary.iter() {\n+            if let Some(module) = item.as_module().await? {\n+                set.insert(module);\n+            }\n+        }\n+        Ok(set.into_iter().collect())\n+    }\n+\n     pub fn affecting_sources_iter(&self) -> impl Iterator<Item = ResolvedVc<Box<dyn Source>>> + '_ {\n         self.affecting_sources.iter().copied()\n     }\n@@ -1609,18 +1620,19 @@ pub async fn url_resolve(\n     issue_source: Option<IssueSource>,\n     is_optional: bool,\n ) -> Result<Vc<ModuleResolveResult>> {\n-    let resolve_options = origin.resolve_options(reference_type.clone()).await?;\n+    let resolve_options = origin.resolve_options(reference_type.clone());\n     let rel_request = request.as_relative();\n+    let origin_path_parent = origin.origin_path().await?.parent();\n     let rel_result = resolve(\n-        origin.origin_path().await?.parent(),\n+        origin_path_parent.clone(),\n         reference_type.clone(),\n         rel_request,\n         resolve_options,\n     );\n     let result = if *rel_result.is_unresolvable().await? && rel_request.resolve().await? != request\n     {\n         let result = resolve(\n-            origin.origin_path().await?.parent(),\n+            origin_path_parent,\n             reference_type.clone(),\n             request,\n             resolve_options,\n@@ -1645,7 +1657,7 @@ pub async fn url_resolve(\n     handle_resolve_error(\n         result,\n         reference_type,\n-        origin.origin_path().owned().await?,\n+        origin,\n         request,\n         resolve_options,\n         is_optional,\n@@ -3080,21 +3092,18 @@ async fn resolve_package_internal_with_imports_field(\n pub async fn handle_resolve_error(\n     result: Vc<ModuleResolveResult>,\n     reference_type: ReferenceType,\n-    origin_path: FileSystemPath,\n+    origin: Vc<Box<dyn ResolveOrigin>>,\n     request: Vc<Request>,\n     resolve_options: Vc<ResolveOptions>,\n     is_optional: bool,\n     source: Option<IssueSource>,\n ) -> Result<Vc<ModuleResolveResult>> {\n-    async fn is_unresolvable(result: Vc<ModuleResolveResult>) -> Result<bool> {\n-        Ok(*result.resolve().await?.is_unresolvable().await?)\n-    }\n-    Ok(match is_unresolvable(result).await {\n-        Ok(unresolvable) => {\n-            if unresolvable {\n+    Ok(match result.await {\n+        Ok(result_ref) => {\n+            if result_ref.is_unresolvable_ref() {\n                 emit_unresolvable_issue(\n                     is_optional,\n-                    origin_path,\n+                    origin,\n                     reference_type,\n                     request,\n                     resolve_options,\n@@ -3108,7 +3117,7 @@ pub async fn handle_resolve_error(\n         Err(err) => {\n             emit_resolve_error_issue(\n                 is_optional,\n-                origin_path,\n+                origin,\n                 reference_type,\n                 request,\n                 resolve_options,\n@@ -3124,7 +3133,7 @@ pub async fn handle_resolve_error(\n pub async fn handle_resolve_source_error(\n     result: Vc<ResolveResult>,\n     reference_type: ReferenceType,\n-    origin_path: FileSystemPath,\n+    origin: Vc<Box<dyn ResolveOrigin>>,\n     request: Vc<Request>,\n     resolve_options: Vc<ResolveOptions>,\n     is_optional: bool,\n@@ -3138,7 +3147,7 @@ pub async fn handle_resolve_source_error(\n             if unresolvable {\n                 emit_unresolvable_issue(\n                     is_optional,\n-                    origin_path,\n+                    origin,\n                     reference_type,\n                     request,\n                     resolve_options,\n@@ -3152,7 +3161,7 @@ pub async fn handle_resolve_source_error(\n         Err(err) => {\n             emit_resolve_error_issue(\n                 is_optional,\n-                origin_path,\n+                origin,\n                 reference_type,\n                 request,\n                 resolve_options,\n@@ -3167,7 +3176,7 @@ pub async fn handle_resolve_source_error(\n \n async fn emit_resolve_error_issue(\n     is_optional: bool,\n-    origin_path: FileSystemPath,\n+    origin: Vc<Box<dyn ResolveOrigin>>,\n     reference_type: ReferenceType,\n     request: Vc<Request>,\n     resolve_options: Vc<ResolveOptions>,\n@@ -3181,7 +3190,7 @@ async fn emit_resolve_error_issue(\n     };\n     ResolvingIssue {\n         severity,\n-        file_path: origin_path.clone(),\n+        file_path: origin.origin_path().owned().await?,\n         request_type: format!(\"{reference_type} request\"),\n         request: request.to_resolved().await?,\n         resolve_options: resolve_options.to_resolved().await?,\n@@ -3195,7 +3204,7 @@ async fn emit_resolve_error_issue(\n \n async fn emit_unresolvable_issue(\n     is_optional: bool,\n-    origin_path: FileSystemPath,\n+    origin: Vc<Box<dyn ResolveOrigin>>,\n     reference_type: ReferenceType,\n     request: Vc<Request>,\n     resolve_options: Vc<ResolveOptions>,\n@@ -3208,7 +3217,7 @@ async fn emit_unresolvable_issue(\n     };\n     ResolvingIssue {\n         severity,\n-        file_path: origin_path.clone(),\n+        file_path: origin.origin_path().owned().await?,\n         request_type: format!(\"{reference_type} request\"),\n         request: request.to_resolved().await?,\n         resolve_options: resolve_options.to_resolved().await?,"
        },
        {
            "sha": "5b10825582ed996a98747543fa63c200e4430c82",
            "filename": "turbopack/crates/turbopack-core/src/resolve/origin.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 15,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Forigin.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Forigin.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Forigin.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -31,6 +31,17 @@ pub trait ResolveOrigin {\n         let _ = request;\n         Vc::cell(None)\n     }\n+\n+    /// Get the resolve options that apply for this origin.\n+    #[turbo_tasks::function]\n+    async fn resolve_options(\n+        self: Vc<Self>,\n+        reference_type: ReferenceType,\n+    ) -> Result<Vc<ResolveOptions>> {\n+        Ok(self\n+            .asset_context()\n+            .resolve_options(self.origin_path().owned().await?, reference_type))\n+    }\n }\n \n // TODO it would be nice if these methods can be moved to the trait to allow\n@@ -46,12 +57,6 @@ pub trait ResolveOriginExt: Send {\n         reference_type: ReferenceType,\n     ) -> impl Future<Output = Result<Vc<ModuleResolveResult>>> + Send;\n \n-    /// Get the resolve options that apply for this origin.\n-    fn resolve_options(\n-        self: Vc<Self>,\n-        reference_type: ReferenceType,\n-    ) -> impl std::future::Future<Output = Result<Vc<ResolveOptions>>> + Send;\n-\n     /// Adds a transition that is used for resolved assets.\n     fn with_transition(self: ResolvedVc<Self>, transition: RcStr) -> Vc<Box<dyn ResolveOrigin>>;\n }\n@@ -74,15 +79,6 @@ where\n         )\n     }\n \n-    async fn resolve_options(\n-        self: Vc<Self>,\n-        reference_type: ReferenceType,\n-    ) -> Result<Vc<ResolveOptions>> {\n-        Ok(self\n-            .asset_context()\n-            .resolve_options(self.origin_path().owned().await?, reference_type))\n-    }\n-\n     fn with_transition(self: ResolvedVc<Self>, transition: RcStr) -> Vc<Box<dyn ResolveOrigin>> {\n         Vc::upcast(\n             ResolveOriginWithTransition {"
        },
        {
            "sha": "e2b46de657f530e209e18f95727a44fe2c234049",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 28,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -37,7 +37,7 @@ use turbopack_resolve::ecmascript::esm_resolve;\n \n use super::export::{all_known_export_names, is_export_missing};\n use crate::{\n-    ScopeHoistingContext, TreeShakingMode,\n+    EcmascriptModuleAsset, ScopeHoistingContext, TreeShakingMode,\n     analyzer::imports::ImportAnnotations,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::{CodeGeneration, CodeGenerationHoistedStmt},\n@@ -319,6 +319,7 @@ impl EsmAssetReferences {\n #[turbo_tasks::value(shared)]\n #[derive(Hash, Debug)]\n pub struct EsmAssetReference {\n+    pub module: ResolvedVc<EcmascriptModuleAsset>,\n     pub origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     // Request is a string to avoid eagerly parsing into a `Request` VC\n     pub request: RcStr,\n@@ -327,6 +328,7 @@ pub struct EsmAssetReference {\n     pub export_name: Option<ModulePart>,\n     pub import_usage: ImportUsage,\n     pub import_externals: bool,\n+    pub tree_shaking_mode: Option<TreeShakingMode>,\n     pub is_pure_import: bool,\n }\n \n@@ -342,43 +344,51 @@ impl EsmAssetReference {\n \n impl EsmAssetReference {\n     pub fn new(\n+        module: ResolvedVc<EcmascriptModuleAsset>,\n         origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n         request: RcStr,\n         issue_source: IssueSource,\n         annotations: ImportAnnotations,\n         export_name: Option<ModulePart>,\n         import_usage: ImportUsage,\n         import_externals: bool,\n+        tree_shaking_mode: Option<TreeShakingMode>,\n     ) -> Self {\n         EsmAssetReference {\n+            module,\n             origin,\n             request,\n             issue_source,\n             annotations,\n             export_name,\n             import_usage,\n             import_externals,\n+            tree_shaking_mode,\n             is_pure_import: false,\n         }\n     }\n \n     pub fn new_pure(\n+        module: ResolvedVc<EcmascriptModuleAsset>,\n         origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n         request: RcStr,\n         issue_source: IssueSource,\n         annotations: ImportAnnotations,\n         export_name: Option<ModulePart>,\n         import_usage: ImportUsage,\n         import_externals: bool,\n+        tree_shaking_mode: Option<TreeShakingMode>,\n     ) -> Self {\n         EsmAssetReference {\n+            module,\n             origin,\n             request,\n             issue_source,\n             annotations,\n             export_name,\n             import_usage,\n             import_externals,\n+            tree_shaking_mode,\n             is_pure_import: true,\n         }\n     }\n@@ -406,17 +416,15 @@ impl ModuleReference for EsmAssetReference {\n             EcmaScriptModulesReferenceSubType::Import\n         };\n \n-        if let Some(ModulePart::Evaluation) = &self.export_name {\n-            let module: ResolvedVc<crate::EcmascriptModuleAsset> =\n-                ResolvedVc::try_downcast_type(self.origin)\n-                    .expect(\"EsmAssetReference origin should be a EcmascriptModuleAsset\");\n-\n-            let tree_shaking_mode = module.options().await?.tree_shaking_mode;\n+        let request = Request::parse(self.request.clone().into());\n \n-            if let Some(TreeShakingMode::ModuleFragments) = tree_shaking_mode {\n-                let side_effect_free_packages = module.asset_context().side_effect_free_packages();\n+        if let Some(TreeShakingMode::ModuleFragments) = self.tree_shaking_mode {\n+            if let Some(ModulePart::Evaluation) = &self.export_name {\n+                let side_effect_free_packages =\n+                    self.module.asset_context().side_effect_free_packages();\n \n-                if *module\n+                if *self\n+                    .module\n                     .is_marked_as_side_effect_free(side_effect_free_packages)\n                     .await?\n                 {\n@@ -430,29 +438,23 @@ impl ModuleReference for EsmAssetReference {\n                     .cell());\n                 }\n             }\n-        }\n-        let request = Request::parse(self.request.clone().into());\n \n-        if let Request::Module { module, .. } = &*request.await?\n-            && module.is_match(TURBOPACK_PART_IMPORT_SOURCE)\n-        {\n-            if let Some(part) = &self.export_name {\n-                let module: ResolvedVc<crate::EcmascriptModuleAsset> =\n-                    ResolvedVc::try_downcast_type(self.origin)\n-                        .expect(\"EsmAssetReference origin should be a EcmascriptModuleAsset\");\n-\n-                return Ok(*ModuleResolveResult::module(ResolvedVc::upcast(\n-                    EcmascriptModulePartAsset::select_part(*module, part.clone())\n-                        .to_resolved()\n-                        .await?,\n-                )));\n+            if let Request::Module { module, .. } = &*request.await?\n+                && module.is_match(TURBOPACK_PART_IMPORT_SOURCE)\n+            {\n+                if let Some(part) = &self.export_name {\n+                    return Ok(*ModuleResolveResult::module(ResolvedVc::upcast(\n+                        EcmascriptModulePartAsset::select_part(*self.module, part.clone())\n+                            .to_resolved()\n+                            .await?,\n+                    )));\n+                }\n+                bail!(\"export_name is required for part import\")\n             }\n-\n-            bail!(\"export_name is required for part import\")\n         }\n \n         let result = esm_resolve(\n-            self.get_origin().resolve().await?,\n+            self.get_origin(),\n             request,\n             ty,\n             false,"
        },
        {
            "sha": "fdc9095e793eb05089895b5c78ba9ec74c23c820",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -324,7 +324,7 @@ impl Module for CachedExternalModule {\n                         origin\n                             .resolve_asset(\n                                 Request::parse_string(self.request.clone()),\n-                                origin.resolve_options(ReferenceType::Undefined).await?,\n+                                origin.resolve_options(ReferenceType::Undefined),\n                                 ReferenceType::Undefined,\n                             )\n                             .await?"
        },
        {
            "sha": "7f1b6ff256123a847806d11d630222b8ced47723",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -80,7 +80,7 @@ use turbopack_core::{\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n     resolve::{\n         FindContextFileResult, ImportUsage, ModulePart, find_context_file,\n-        origin::{PlainResolveOrigin, ResolveOrigin, ResolveOriginExt},\n+        origin::{PlainResolveOrigin, ResolveOrigin},\n         parse::Request,\n         pattern::Pattern,\n         resolve,\n@@ -459,6 +459,7 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n \n struct AnalysisState<'a> {\n     handler: &'a Handler,\n+    module: ResolvedVc<EcmascriptModuleAsset>,\n     source: ResolvedVc<Box<dyn Source>>,\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     compile_time_info: ResolvedVc<CompileTimeInfo>,\n@@ -796,7 +797,8 @@ async fn analyze_ecmascript_module_internal(\n         for (i, r) in eval_context.imports.references().enumerate() {\n             let mut should_add_evaluation = false;\n             let reference = EsmAssetReference::new(\n-                origin,\n+                module,\n+                ResolvedVc::upcast(module),\n                 RcStr::from(&*r.module_path.to_string_lossy()),\n                 r.issue_source\n                     .unwrap_or_else(|| IssueSource::from_source_only(source)),\n@@ -832,6 +834,7 @@ async fn analyze_ecmascript_module_internal(\n                 },\n                 import_usage.get(&i).cloned().unwrap_or_default(),\n                 import_externals,\n+                options.tree_shaking_mode,\n             )\n             .resolved_cell();\n \n@@ -1056,6 +1059,7 @@ async fn analyze_ecmascript_module_internal(\n \n         let mut analysis_state = AnalysisState {\n             handler: &handler,\n+            module,\n             source,\n             origin,\n             compile_time_info,\n@@ -1477,6 +1481,7 @@ async fn analyze_ecmascript_module_internal(\n                                         export.clone(),\n                                         || {\n                                             EsmAssetReference::new(\n+                                                original_reference.module,\n                                                 original_reference.origin,\n                                                 original_reference.request.clone(),\n                                                 original_reference.issue_source,\n@@ -1488,6 +1493,7 @@ async fn analyze_ecmascript_module_internal(\n                                                 // logic earlier (see TODO above)\n                                                 original_reference.import_usage.clone(),\n                                                 original_reference.import_externals,\n+                                                original_reference.tree_shaking_mode,\n                                             )\n                                             .resolved_cell()\n                                         },\n@@ -2902,6 +2908,7 @@ async fn handle_free_var_reference(\n                     // import again if the variable reference turns out be dead code in some later\n                     // stage of the build, thus mark the import call as /*@__PURE__*/.\n                     Ok(EsmAssetReference::new_pure(\n+                        state.module,\n                         if let Some(lookup_path) = lookup_path {\n                             ResolvedVc::upcast(\n                                 PlainResolveOrigin::new(\n@@ -2929,6 +2936,7 @@ async fn handle_free_var_reference(\n                         },\n                         ImportUsage::SideEffects,\n                         state.import_externals,\n+                        state.tree_shaking_mode,\n                     )\n                     .resolved_cell())\n                 })\n@@ -3906,7 +3914,7 @@ async fn resolve_as_webpack_runtime(\n     transforms: Vc<EcmascriptInputTransforms>,\n ) -> Result<Vc<WebpackRuntime>> {\n     let ty = ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined);\n-    let options = origin.resolve_options(ty.clone()).await?;\n+    let options = origin.resolve_options(ty.clone());\n \n     let options = apply_cjs_specific_options(options);\n "
        },
        {
            "sha": "97217f735824d3f8a53b1ac57a3dcf367d87603d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/typescript/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftypescript%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -10,11 +10,7 @@ use turbopack_core::{\n     raw_module::RawModule,\n     reference::{ModuleReference, ModuleReferences},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n-    resolve::{\n-        ModuleResolveResult,\n-        origin::{ResolveOrigin, ResolveOriginExt},\n-        parse::Request,\n-    },\n+    resolve::{ModuleResolveResult, origin::ResolveOrigin, parse::Request},\n     source::Source,\n };\n // TODO remove this\n@@ -61,8 +57,7 @@ impl Module for TsConfigModuleAsset {\n             self.source,\n             apply_cjs_specific_options(\n                 self.origin\n-                    .resolve_options(ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined))\n-                    .await?,\n+                    .resolve_options(ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined)),\n             ),\n         )\n         .await?;"
        },
        {
            "sha": "af213d90dba31c4c977c0dc6df14ae80e76e7976",
            "filename": "turbopack/crates/turbopack-ecmascript/src/webpack/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fwebpack%2Fmod.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -10,9 +10,7 @@ use turbopack_core::{\n     reference::{ModuleReference, ModuleReferences},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n     resolve::{\n-        ModuleResolveResult, ModuleResolveResultItem,\n-        origin::{ResolveOrigin, ResolveOriginExt},\n-        parse::Request,\n+        ModuleResolveResult, ModuleResolveResultItem, origin::ResolveOrigin, parse::Request,\n         resolve,\n     },\n     source::Source,\n@@ -165,7 +163,7 @@ impl ModuleReference for WebpackRuntimeAssetReference {\n     #[turbo_tasks::function]\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n         let ty = ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined);\n-        let options = self.origin.resolve_options(ty.clone()).await?;\n+        let options = self.origin.resolve_options(ty.clone());\n \n         let options = apply_cjs_specific_options(options);\n "
        },
        {
            "sha": "d9ac715174d446c13e51d4a62d9fb9e5aa416157",
            "filename": "turbopack/crates/turbopack-resolve/src/ecmascript.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -44,7 +44,7 @@ pub fn get_condition_maps(\n \n pub fn apply_esm_specific_options(\n     options: Vc<ResolveOptions>,\n-    reference_type: ReferenceType,\n+    reference_type: &ReferenceType,\n ) -> Vc<ResolveOptions> {\n     let clear_extensions = matches!(\n         reference_type,\n@@ -94,7 +94,7 @@ pub async fn esm_resolve(\n     issue_source: Option<IssueSource>,\n ) -> Result<Vc<ModuleResolveResult>> {\n     let ty = ReferenceType::EcmaScriptModules(ty);\n-    let options = apply_esm_specific_options(origin.resolve_options(ty.clone()).await?, ty.clone())\n+    let options = apply_esm_specific_options(origin.resolve_options(ty.clone()), &ty)\n         .resolve()\n         .await?;\n     specific_resolve(origin, request, options, ty, is_optional, issue_source).await\n@@ -109,7 +109,7 @@ pub async fn cjs_resolve(\n     is_optional: bool,\n ) -> Result<Vc<ModuleResolveResult>> {\n     let ty = ReferenceType::CommonJs(ty);\n-    let options = apply_cjs_specific_options(origin.resolve_options(ty.clone()).await?)\n+    let options = apply_cjs_specific_options(origin.resolve_options(ty.clone()))\n         .resolve()\n         .await?;\n     specific_resolve(origin, request, options, ty, is_optional, issue_source).await\n@@ -124,7 +124,7 @@ pub async fn cjs_resolve_source(\n     is_optional: bool,\n ) -> Result<Vc<ResolveResult>> {\n     let ty = ReferenceType::CommonJs(ty);\n-    let options = apply_cjs_specific_options(origin.resolve_options(ty.clone()).await?)\n+    let options = apply_cjs_specific_options(origin.resolve_options(ty.clone()))\n         .resolve()\n         .await?;\n     let result = resolve(\n@@ -137,7 +137,7 @@ pub async fn cjs_resolve_source(\n     handle_resolve_source_error(\n         result,\n         ty,\n-        origin.origin_path().owned().await?,\n+        *origin,\n         *request,\n         options,\n         is_optional,\n@@ -161,7 +161,7 @@ async fn specific_resolve(\n     handle_resolve_error(\n         result,\n         reference_type,\n-        origin.origin_path().owned().await?,\n+        origin,\n         request,\n         options,\n         is_optional,"
        },
        {
            "sha": "7cad202f34230aeec6639ecf46f9dc1ee00ba7ee",
            "filename": "turbopack/crates/turbopack-resolve/src/typescript.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 12,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1754f90cb744d65520d040fb441a2671cc73d7ec/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs?ref=1754f90cb744d65520d040fb441a2671cc73d7ec",
            "patch": "@@ -21,7 +21,7 @@ use turbopack_core::{\n             ConditionValue, ImportMap, ImportMapping, ResolveIntoPackage, ResolveModules,\n             ResolveOptions,\n         },\n-        origin::{ResolveOrigin, ResolveOriginExt},\n+        origin::ResolveOrigin,\n         parse::Request,\n         pattern::Pattern,\n         resolve,\n@@ -417,7 +417,7 @@ pub async fn type_resolve(\n ) -> Result<Vc<ModuleResolveResult>> {\n     let ty = ReferenceType::TypeScript(TypeScriptReferenceSubType::Undefined);\n     let context_path = origin.origin_path().await?.parent();\n-    let options = origin.resolve_options(ty.clone()).await?;\n+    let options = origin.resolve_options(ty.clone());\n     let options = apply_typescript_types_options(options);\n     let types_request = if let Request::Module {\n         module: m,\n@@ -472,16 +472,7 @@ pub async fn type_resolve(\n             .asset_context()\n             .process_resolve_result(result, ty.clone()),\n     );\n-    handle_resolve_error(\n-        result,\n-        ty,\n-        origin.origin_path().owned().await?,\n-        request,\n-        options,\n-        false,\n-        None,\n-    )\n-    .await\n+    handle_resolve_error(result, ty, origin, request, options, false, None).await\n }\n \n #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 137,
        "deletions": 107
    }
}