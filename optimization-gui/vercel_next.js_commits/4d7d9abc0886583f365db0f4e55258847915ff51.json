{
    "author": "huozhi",
    "message": "[ts-plugin] keep showing the types in the function body (#86273)",
    "sha": "4d7d9abc0886583f365db0f4e55258847915ff51",
    "files": [
        {
            "sha": "17559ea81ab559c744aed4ff9ccb24350c684dc9",
            "filename": "packages/next/src/server/typescript/rules/config.ts",
            "status": "modified",
            "additions": 60,
            "deletions": 6,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fconfig.ts?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -5,6 +5,7 @@ import {\n   isPositionInsideNode,\n   getTs,\n   removeStringQuotes,\n+  getTypeChecker,\n } from '../utils'\n import { NEXT_TS_ERRORS, ALLOWED_EXPORTS } from '../constant'\n import type tsModule from 'typescript/lib/tsserverlibrary'\n@@ -308,9 +309,49 @@ const config = {\n           API_DOCS[entryConfig].link,\n       }\n \n-      if (value && isPositionInsideNode(position, value)) {\n-        // Hovers the value of the config\n-        const isString = ts.isStringLiteral(value)\n+      // When the value is a flexible type (like a function), also compute its\n+      // inferred type so we can surface it alongside the docs. This is useful\n+      // even when the value is considered invalid by the config validation,\n+      // as long as it's not a direct literal export.\n+      let displayParts: tsModule.SymbolDisplayPart[] = []\n+      const typeChecker = getTypeChecker()\n+      const isString = !!value && ts.isStringLiteral(value)\n+      const isFunctionValue =\n+        !!value &&\n+        !isString &&\n+        (ts.isArrowFunction(value) ||\n+          ts.isFunctionExpression(value) ||\n+          ts.isFunctionDeclaration(value))\n+\n+      if (typeChecker && value && isFunctionValue) {\n+        try {\n+          // If we're hovering the config identifier, ask for the type at the\n+          // identifier; otherwise, ask at the value node. This makes sure\n+          // highlighting `generateMetadata` itself also shows the inferred type.\n+          const typeTarget = isPositionInsideNode(position, name) ? name : value\n+          const type = typeChecker.getTypeAtLocation(typeTarget)\n+          if (type) {\n+            const typeString = typeChecker.typeToString(type, typeTarget)\n+            if (typeString) {\n+              displayParts = [\n+                {\n+                  text: typeString,\n+                  kind: 'typeName',\n+                },\n+              ]\n+            }\n+          }\n+        } catch {\n+          // If type checking fails, continue without type info.\n+        }\n+      }\n+\n+      // For non-function values (like literals), hovering the value should show\n+      // option-specific docs. For function-valued configs (e.g. `generateMetadata`),\n+      // we let TypeScript handle hover anywhere in the initializer except for the\n+      // export identifier itself.\n+      if (value && !isFunctionValue && isPositionInsideNode(position, value)) {\n+        // Hovering the value of the config\n         const text = removeStringQuotes(value.getText())\n         const key = isString ? `\"${text}\"` : text\n \n@@ -339,19 +380,32 @@ const config = {\n             ],\n           }\n         } else {\n-          // Wrong value, display the docs link\n+          // Wrong value: still show the docs link, and when available, the\n+          // inferred type for non-literal (i.e. non-direct) exports.\n           overridden = {\n             kind: ts.ScriptElementKind.enumElement,\n             kindModifiers: ts.ScriptElementKindModifier.none,\n             textSpan: {\n               start: value.getStart(),\n               length: value.getWidth(),\n             },\n-            displayParts: [],\n+            displayParts,\n             documentation: [docsLink],\n           }\n         }\n       } else {\n+        // For function-valued configs, if we're hovering anywhere within the\n+        // initializer (including `async`, parameters, or the body) but not on\n+        // the export identifier itself, don't override TypeScript's default\n+        // hover. We only want to override when hovering the config identifier\n+        // (e.g. `generateMetadata`), not arbitrary tokens within the function.\n+        if (\n+          isFunctionValue &&\n+          isPositionInsideNode(position, value) && // hover is somewhere within the function initializer\n+          !isPositionInsideNode(position, name) // ...but not on the export identifier itself\n+        ) {\n+          return\n+        }\n         // Hovers the name of the config\n         overridden = {\n           kind: ts.ScriptElementKind.enumElement,\n@@ -360,7 +414,7 @@ const config = {\n             start: name.getStart(),\n             length: name.getWidth(),\n           },\n-          displayParts: [],\n+          displayParts,\n           documentation: [\n             {\n               kind: 'text',"
        },
        {
            "sha": "b7f22560c3457b59b002cf5eac7b0facd01c8f33",
            "filename": "test/development/typescript-plugin/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fpage.tsx?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -1,11 +1,3 @@\n-import { ClientComponent } from './client'\n-\n-const noop = () => {}\n-\n export default function Page() {\n-  return (\n-    <>\n-      <ClientComponent unknown={noop} unknownAction={noop} />\n-    </>\n-  )\n+  return <>hello world</>\n }"
        },
        {
            "sha": "df8ca996a171f3ff181f02e438bd02de81ee6704",
            "filename": "test/development/typescript-plugin/app/project/[slug]/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Flayout.tsx?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -0,0 +1,9 @@\n+import { Metadata } from 'next'\n+\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return <>{children}</>\n+}\n+\n+export const metadata: Metadata = {\n+  title: 'Project Layout',\n+}"
        },
        {
            "sha": "dfa25aecb5d036eff5cc5f7e94adf7478efe572f",
            "filename": "test/development/typescript-plugin/app/project/[slug]/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ftypescript-plugin%2Fapp%2Fproject%2F%5Bslug%5D%2Fpage.tsx?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function Page(props: PageProps<'/project/[slug]'>) {\n+  const { slug } = await props.params\n+  return <p>project {slug}</p>\n+}\n+\n+export const generateMetadata = async ({\n+  params,\n+}: PageProps<'/project/[slug]'>) => {\n+  const { slug } = await params\n+  return {\n+    title: `Project ${slug}`,\n+  }\n+}"
        },
        {
            "sha": "dfa25aecb5d036eff5cc5f7e94adf7478efe572f",
            "filename": "test/e2e/app-dir/typed-routes/app/(logged-in)/project/[slug]/page.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2F(logged-in)%2Fproject%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2F(logged-in)%2Fproject%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2F(logged-in)%2Fproject%2F%5Bslug%5D%2Fpage.tsx?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -2,3 +2,12 @@ export default async function Page(props: PageProps<'/project/[slug]'>) {\n   const { slug } = await props.params\n   return <p>project {slug}</p>\n }\n+\n+export const generateMetadata = async ({\n+  params,\n+}: PageProps<'/project/[slug]'>) => {\n+  const { slug } = await params\n+  return {\n+    title: `Project ${slug}`,\n+  }\n+}"
        },
        {
            "sha": "ccd256a8fe980b83449a754d522f6e8ca364b5fe",
            "filename": "test/e2e/app-dir/typed-routes/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4d7d9abc0886583f365db0f4e55258847915ff51/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fnext.config.js?ref=4d7d9abc0886583f365db0f4e55258847915ff51",
            "patch": "@@ -8,11 +8,6 @@ const nextConfig = {\n   typedRoutes: true,\n   async redirects() {\n     return [\n-      {\n-        source: '/project/:slug',\n-        destination: '/project/:slug',\n-        permanent: true,\n-      },\n       {\n         source: '/blog/:category/:slug*',\n         destination: '/posts/:category/:slug*',"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 92,
        "deletions": 20
    }
}