{
    "author": "ztanner",
    "message": "[cache components]: prevent expired entries from being served (#84975)\n\nThe `allowStale` value is currently erroneously also allowing expired\nvalues to be served, because it's happening in the `file-system-cache`,\nbefore expiration values are checked.\n\nThis removes the handling all together to prevent the possibility of\nserving data that has been expired (eg via`updateTag`).",
    "sha": "bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
    "files": [
        {
            "sha": "4c985781a1cefeeec24e89f5123100728fa06970",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
            "patch": "@@ -828,10 +828,6 @@ export async function handler(\n             kind: IncrementalCacheKind.APP_PAGE,\n             isRoutePPREnabled: true,\n             isFallback: false,\n-            // CRITICAL: we need to allow stale here as we'll revalidate in the\n-            // background if it's stale. We _want_ to possibly serve a stale\n-            // response here as it'll be consistent with the static render.\n-            allowStale: true,\n           }\n         )\n "
        },
        {
            "sha": "957e63912ee8f9d787f1f8ab3664a134c728e933",
            "filename": "packages/next/src/server/lib/incremental-cache/file-system-cache.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts?ref=bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
            "patch": "@@ -293,16 +293,6 @@ export default class FileSystemCache implements CacheHandler {\n       }\n     }\n \n-    // If enabled, this will return the possibly stale data without validating\n-    // that the tags have expired or not yet been revalidated.\n-    if ('allowStale' in ctx && ctx.allowStale) {\n-      if (FileSystemCache.debug) {\n-        console.log('FileSystemCache: allow stale', ctx.allowStale)\n-      }\n-\n-      return data ?? null\n-    }\n-\n     if (\n       data?.value?.kind === CachedRouteKind.APP_PAGE ||\n       data?.value?.kind === CachedRouteKind.APP_ROUTE ||"
        },
        {
            "sha": "39b999d9ba04766ad1bf5071c22f13ed3cfceca7",
            "filename": "packages/next/src/server/response-cache/types.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts?ref=bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
            "patch": "@@ -228,11 +228,6 @@ export interface GetIncrementalResponseCacheContext {\n    * True if this is a fallback request.\n    */\n   isFallback: boolean\n-\n-  /**\n-   * True if stale data is allowed to be returned.\n-   */\n-  allowStale?: boolean\n }\n \n export interface SetIncrementalFetchCacheContext {"
        },
        {
            "sha": "89f15f52f77cde9c3160ea60d4007c233a6ea5f8",
            "filename": "test/production/app-dir/resume-data-cache/app/revalidate/route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts?ref=bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
            "patch": "@@ -1,6 +1,6 @@\n import { revalidateTag } from 'next/cache'\n \n export function POST() {\n-  revalidateTag('test', 'expireNow')\n+  revalidateTag('test', 'seconds')\n   return new Response(null, { status: 200 })\n }"
        },
        {
            "sha": "93363cc5a0b240c09d1ed21d758ccd370baed123",
            "filename": "test/production/app-dir/resume-data-cache/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js?ref=bdc3d07ce85c84a2fff5d9540ac8e39a541d07f3",
            "patch": "@@ -5,13 +5,6 @@ const nextConfig = {\n   experimental: {\n     cacheComponents: true,\n     clientSegmentCache: true,\n-    cacheLife: {\n-      expireNow: {\n-        stale: 0,\n-        expire: 0,\n-        revalidate: 0,\n-      },\n-    },\n   },\n }\n "
        }
    ],
    "stats": {
        "total": 28,
        "additions": 1,
        "deletions": 27
    }
}