{
    "author": "wbinnssmith",
    "message": "bundle analyzer: prevent flashes and stuck empty canvases on resize (#87289)",
    "sha": "684fb730714baea20d3437f1e64bba6b41328bc6",
    "files": [
        {
            "sha": "146041b8bd1fbe13c5063b7a888be572fffe87d4",
            "filename": "apps/bundle-analyzer/components/treemap-visualizer.tsx",
            "status": "modified",
            "additions": 38,
            "deletions": 28,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/684fb730714baea20d3437f1e64bba6b41328bc6/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/684fb730714baea20d3437f1e64bba6b41328bc6/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Ftreemap-visualizer.tsx?ref=684fb730714baea20d3437f1e64bba6b41328bc6",
            "patch": "@@ -2,7 +2,7 @@\n \n import { darken, lighten, readableColor } from 'polished'\n import type React from 'react'\n-import { useEffect, useMemo, useRef, useState } from 'react'\n+import { useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react'\n import type { AnalyzeData } from '@/lib/analyze-data'\n import {\n   computeTreemapLayoutFromAnalyze,\n@@ -718,13 +718,16 @@ export function TreemapVisualizer({\n   const [hoveredNode, setHoveredNode] = useState<LayoutNode | null>(null)\n   const [shouldDimOthers, setShouldDimOthers] = useState(false)\n   const hoverTimeoutRef = useRef<NodeJS.Timeout | null>(null)\n-  const [cssDimensions, setCssDimensions] = useState({\n-    width: 1200,\n-    height: 800,\n-  })\n-  const [canvasDimensions, setCanvasDimensions] = useState({\n-    width: 1200,\n-    height: 800,\n+  const [dimensions, setDimensions] = useState<{\n+    cssWidth: number\n+    cssHeight: number\n+    canvasWidth: number\n+    canvasHeight: number\n+  }>({\n+    cssWidth: 1200,\n+    cssHeight: 800,\n+    canvasWidth: 1200,\n+    canvasHeight: 800,\n   })\n   const [, _setTheme] = useState<'light' | 'dark'>('light')\n \n@@ -785,15 +788,22 @@ export function TreemapVisualizer({\n     if (!container) return\n \n     const updateSize = () => {\n-      const rect = container.getBoundingClientRect()\n       const dpr = window.devicePixelRatio || 1\n-      setCssDimensions({\n-        width: Math.floor(rect.width),\n-        height: Math.floor(rect.height),\n-      })\n-      setCanvasDimensions({\n-        width: Math.floor(rect.width * dpr),\n-        height: Math.floor(rect.height * dpr),\n+      setDimensions((dimensions) => {\n+        const rect = container.getBoundingClientRect()\n+        if (\n+          dimensions.cssWidth === Math.floor(rect.width) &&\n+          dimensions.cssHeight === Math.floor(rect.height)\n+        ) {\n+          return dimensions\n+        }\n+\n+        return {\n+          cssWidth: Math.floor(rect.width),\n+          cssHeight: Math.floor(rect.height),\n+          canvasWidth: Math.floor(rect.width * dpr),\n+          canvasHeight: Math.floor(rect.height * dpr),\n+        }\n       })\n     }\n \n@@ -813,8 +823,8 @@ export function TreemapVisualizer({\n       {\n         x: 0,\n         y: 12 * focusedAncestorChain.length,\n-        width: cssDimensions.width,\n-        height: cssDimensions.height,\n+        width: dimensions.cssWidth,\n+        height: dimensions.cssHeight,\n       },\n       filterSource,\n       sizeMode\n@@ -826,8 +836,8 @@ export function TreemapVisualizer({\n         focusedLayout,\n         focusedAncestorChain,\n         analyzeData,\n-        cssDimensions.width,\n-        cssDimensions.height,\n+        dimensions.cssWidth,\n+        dimensions.cssHeight,\n         12\n       )\n     }\n@@ -837,13 +847,13 @@ export function TreemapVisualizer({\n     analyzeData,\n     focusedSourceIndex,\n     focusedAncestorChain,\n-    cssDimensions.width,\n-    cssDimensions.height,\n+    dimensions.cssWidth,\n+    dimensions.cssHeight,\n     filterSource,\n     sizeMode,\n   ])\n \n-  useEffect(() => {\n+  useLayoutEffect(() => {\n     const canvas = canvasRef.current\n     if (!canvas) return\n \n@@ -854,7 +864,7 @@ export function TreemapVisualizer({\n     ctx.setTransform(1, 0, 0, 1, 0, 0)\n     ctx.scale(dpr, dpr)\n \n-    ctx.clearRect(0, 0, cssDimensions.width, cssDimensions.height)\n+    ctx.clearRect(0, 0, dimensions.cssWidth, dimensions.cssHeight)\n \n     drawTreemap(\n       ctx,\n@@ -871,8 +881,8 @@ export function TreemapVisualizer({\n     layout,\n     hoveredAncestorChain,\n     selectedAncestorChain,\n-    cssDimensions.width,\n-    cssDimensions.height,\n+    dimensions.cssWidth,\n+    dimensions.cssHeight,\n     isMouseInTreemap,\n     focusedAncestorChain,\n     searchQuery,\n@@ -1005,8 +1015,8 @@ export function TreemapVisualizer({\n     >\n       <canvas\n         ref={canvasRef}\n-        width={canvasDimensions.width}\n-        height={canvasDimensions.height}\n+        width={dimensions.canvasWidth}\n+        height={dimensions.canvasHeight}\n         onMouseMove={handleMouseMove}\n         onMouseLeave={handleMouseLeave}\n         onClick={handleClick}"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 38,
        "deletions": 28
    }
}