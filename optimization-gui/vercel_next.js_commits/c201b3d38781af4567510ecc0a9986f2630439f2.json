{
    "author": "unstubbable",
    "message": "Allow `metadataBase` to be a string URL in addition to `URL` instance (#84297)\n\nAs of #49343, in dev mode only, we accidentally change the `metadataBase` from an `URL` instance to a URL string, when passing it to child layouts or pages via the `parent` argument in `generateMetadata`. This is because we clone the metadata object via `JSON.stringify`/`parse` and then freeze it, to prevent relying on mutating resolved metadata. The replacer/reviver functions we used to clone the metadata didn't properly handle preserving `URL` instances as intended, so they were turned into strings.\r\n\r\nBecause user code already had to handle the case of `metadataBase` potentially being a string at runtime in dev mode, we can just officially reflect that as well in our types, not only for the `ResolvedMetadata` input type, but also for the `Metadata` output type.\r\n\r\nThis also enables `'use cache'` being used in `generateMetadata`, because React currently does not support transporting `URL` instances from one environment to another (e.g. `Server` to `Cache`).\r\n\r\nNote that all other URL properties in `Metadata` and `ResolvedMetadata` already allowed `string`, so this only affects `metadataBase`.\r\n\r\nTo resolve the ambiguity between dev and prod, we're now always transforming all URL instances to strings, before passing the resolved metadata to `generateMetadata`. This is also reflected in the `ResolvedMetadata` type.",
    "sha": "c201b3d38781af4567510ecc0a9986f2630439f2",
    "files": [
        {
            "sha": "6da4b883bac3d570ce2692986b5f7b43d020cf00",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -847,5 +847,6 @@\n   \"846\": \"Route %s used \\\\`cookies()\\\\` inside a function cached with \\\\`unstable_cache()\\\\`. Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \\\\`cookies()\\\\` outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache\",\n   \"847\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`connection()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n   \"848\": \"%sused %s. \\\\`searchParams\\\\` is a Promise and must be unwrapped with \\\\`await\\\\` or \\\\`React.use()\\\\` before accessing its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-  \"849\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`cookies()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\"\n+  \"849\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`cookies()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n+  \"850\": \"metadataBase is not a valid URL: %s\"\n }"
        },
        {
            "sha": "7d1866fdc89bb5f289a9e612e27270c9a062ad4e",
            "filename": "packages/next/src/lib/metadata/clone-metadata.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/2386cb91d23d56afdd21f631824f8ccc8b1c0151/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fclone-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2386cb91d23d56afdd21f631824f8ccc8b1c0151/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fclone-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fclone-metadata.ts?ref=2386cb91d23d56afdd21f631824f8ccc8b1c0151",
            "patch": "@@ -1,28 +0,0 @@\n-import type {\n-  ResolvedMetadata,\n-  ResolvedViewport,\n-} from './types/metadata-interface'\n-\n-const TYPE_URL = '__METADATA_URL'\n-\n-function replacer(_key: string, val: any) {\n-  // clone URL as string but recover it as URL\n-  if (val instanceof URL) {\n-    return { _type: TYPE_URL, value: val.href }\n-  }\n-  return val\n-}\n-\n-function reviver(_key: string, val: any) {\n-  if (typeof val === 'object' && val !== null && val._type === TYPE_URL) {\n-    return new URL(val.value)\n-  }\n-  return val\n-}\n-\n-export function cloneMetadata<T extends ResolvedMetadata | ResolvedViewport>(\n-  metadata: T\n-): T {\n-  const jsonString = JSON.stringify(metadata, replacer)\n-  return JSON.parse(jsonString, reviver)\n-}"
        },
        {
            "sha": "ab0f8c11f9380ac1f7f7d057150f85282cac2aec",
            "filename": "packages/next/src/lib/metadata/generate/basic.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -162,7 +162,7 @@ export function PinterestMeta({\n }: {\n   pinterest: ResolvedMetadata['pinterest']\n }) {\n-  if (!pinterest || !pinterest.richPin) return null\n+  if (!pinterest || pinterest.richPin === undefined) return null\n \n   const { richPin } = pinterest\n "
        },
        {
            "sha": "d14b7a714a19c45d25f691c44d84c0e201b60170",
            "filename": "packages/next/src/lib/metadata/resolve-metadata.ts",
            "status": "modified",
            "additions": 188,
            "deletions": 109,
            "changes": 297,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -5,6 +5,7 @@ import type {\n   ResolvingMetadata,\n   ResolvingViewport,\n   Viewport,\n+  WithStringifiedURLs,\n } from './types/metadata-interface'\n import type { MetadataImageModule } from '../../build/webpack/loaders/metadata/types'\n import type { GetDynamicParamFromSegment } from '../../server/app-render/app-render'\n@@ -56,6 +57,7 @@ import { ResolveMetadataSpan } from '../../server/lib/trace/constants'\n import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n import * as Log from '../../build/output/log'\n import { createServerParamsForMetadata } from '../../server/request/params'\n+import type { MetadataBaseURL } from './resolvers/resolve-url'\n \n type StaticIcons = Pick<ResolvedIcons, 'icon' | 'apple'>\n \n@@ -105,7 +107,36 @@ function isFavicon(icon: IconDescriptor | undefined): boolean {\n   )\n }\n \n+function convertUrlsToStrings<T>(input: T): WithStringifiedURLs<T> {\n+  if (input instanceof URL) {\n+    return input.toString() as unknown as WithStringifiedURLs<T>\n+  } else if (Array.isArray(input)) {\n+    return input.map((item) =>\n+      convertUrlsToStrings(item)\n+    ) as WithStringifiedURLs<T>\n+  } else if (input && typeof input === 'object') {\n+    const result: Record<string, unknown> = {}\n+    for (const [key, value] of Object.entries(input)) {\n+      result[key] = convertUrlsToStrings(value)\n+    }\n+    return result as WithStringifiedURLs<T>\n+  }\n+  return input as WithStringifiedURLs<T>\n+}\n+\n+function normalizeMetadataBase(metadataBase: string | URL | null): URL | null {\n+  if (typeof metadataBase === 'string') {\n+    try {\n+      metadataBase = new URL(metadataBase)\n+    } catch {\n+      throw new Error(`metadataBase is not a valid URL: ${metadataBase}`)\n+    }\n+  }\n+  return metadataBase\n+}\n+\n async function mergeStaticMetadata(\n+  metadataBase: MetadataBaseURL,\n   source: Metadata | null,\n   target: ResolvedMetadata,\n   staticFilesMetadata: StaticMetadata,\n@@ -130,23 +161,23 @@ async function mergeStaticMetadata(\n   if (twitter && !source?.twitter?.hasOwnProperty('images')) {\n     const resolvedTwitter = resolveTwitter(\n       { ...target.twitter, images: twitter } as Twitter,\n-      target.metadataBase,\n+      metadataBase,\n       { ...metadataContext, isStaticMetadataRouteFile: true },\n       titleTemplates.twitter\n     )\n-    target.twitter = resolvedTwitter\n+    target.twitter = convertUrlsToStrings(resolvedTwitter)\n   }\n \n   // file based metadata is specified and current level metadata openGraph.images is not specified\n   if (openGraph && !source?.openGraph?.hasOwnProperty('images')) {\n     const resolvedOpenGraph = await resolveOpenGraph(\n       { ...target.openGraph, images: openGraph } as OpenGraph,\n-      target.metadataBase,\n+      metadataBase,\n       pathname,\n       { ...metadataContext, isStaticMetadataRouteFile: true },\n       titleTemplates.openGraph\n     )\n-    target.openGraph = resolvedOpenGraph\n+    target.openGraph = convertUrlsToStrings(resolvedOpenGraph)\n   }\n   if (manifest) {\n     target.manifest = manifest\n@@ -155,113 +186,137 @@ async function mergeStaticMetadata(\n   return target\n }\n \n-// Merge the source metadata into the resolved target metadata.\n+/**\n+ * Merges the given metadata with the resolved metadata. Returns a new object.\n+ */\n async function mergeMetadata(\n   route: string,\n   pathname: Promise<string>,\n   {\n-    source,\n-    target,\n+    metadata,\n+    resolvedMetadata,\n     staticFilesMetadata,\n     titleTemplates,\n     metadataContext,\n     buildState,\n     leafSegmentStaticIcons,\n   }: {\n-    source: Metadata | null\n-    target: ResolvedMetadata\n+    metadata: Metadata | null\n+    resolvedMetadata: ResolvedMetadata\n     staticFilesMetadata: StaticMetadata\n     titleTemplates: TitleTemplates\n     metadataContext: MetadataContext\n     buildState: BuildState\n     leafSegmentStaticIcons: StaticIcons\n   }\n ): Promise<ResolvedMetadata> {\n-  // If there's override metadata, prefer it otherwise fallback to the default metadata.\n-  const metadataBase =\n-    typeof source?.metadataBase !== 'undefined'\n-      ? source.metadataBase\n-      : target.metadataBase\n-  for (const key_ in source) {\n+  const newResolvedMetadata = structuredClone(resolvedMetadata)\n+\n+  const metadataBase = normalizeMetadataBase(\n+    metadata?.metadataBase !== undefined\n+      ? metadata.metadataBase\n+      : resolvedMetadata.metadataBase\n+  )\n+\n+  for (const key_ in metadata) {\n     const key = key_ as keyof Metadata\n \n     switch (key) {\n       case 'title': {\n-        target.title = resolveTitle(source.title, titleTemplates.title)\n+        newResolvedMetadata.title = resolveTitle(\n+          metadata.title,\n+          titleTemplates.title\n+        )\n         break\n       }\n       case 'alternates': {\n-        target.alternates = await resolveAlternates(\n-          source.alternates,\n-          metadataBase,\n-          pathname,\n-          metadataContext\n+        newResolvedMetadata.alternates = convertUrlsToStrings(\n+          await resolveAlternates(\n+            metadata.alternates,\n+            metadataBase,\n+            pathname,\n+            metadataContext\n+          )\n         )\n         break\n       }\n       case 'openGraph': {\n-        target.openGraph = await resolveOpenGraph(\n-          source.openGraph,\n-          metadataBase,\n-          pathname,\n-          metadataContext,\n-          titleTemplates.openGraph\n+        newResolvedMetadata.openGraph = convertUrlsToStrings(\n+          await resolveOpenGraph(\n+            metadata.openGraph,\n+            metadataBase,\n+            pathname,\n+            metadataContext,\n+            titleTemplates.openGraph\n+          )\n         )\n         break\n       }\n       case 'twitter': {\n-        target.twitter = resolveTwitter(\n-          source.twitter,\n-          metadataBase,\n-          metadataContext,\n-          titleTemplates.twitter\n+        newResolvedMetadata.twitter = convertUrlsToStrings(\n+          resolveTwitter(\n+            metadata.twitter,\n+            metadataBase,\n+            metadataContext,\n+            titleTemplates.twitter\n+          )\n         )\n         break\n       }\n       case 'facebook':\n-        target.facebook = resolveFacebook(source.facebook)\n+        newResolvedMetadata.facebook = resolveFacebook(metadata.facebook)\n         break\n       case 'verification':\n-        target.verification = resolveVerification(source.verification)\n+        newResolvedMetadata.verification = resolveVerification(\n+          metadata.verification\n+        )\n         break\n \n       case 'icons': {\n-        target.icons = resolveIcons(source.icons)\n+        newResolvedMetadata.icons = convertUrlsToStrings(\n+          resolveIcons(metadata.icons)\n+        )\n         break\n       }\n       case 'appleWebApp':\n-        target.appleWebApp = resolveAppleWebApp(source.appleWebApp)\n+        newResolvedMetadata.appleWebApp = resolveAppleWebApp(\n+          metadata.appleWebApp\n+        )\n         break\n       case 'appLinks':\n-        target.appLinks = resolveAppLinks(source.appLinks)\n+        newResolvedMetadata.appLinks = convertUrlsToStrings(\n+          resolveAppLinks(metadata.appLinks)\n+        )\n         break\n       case 'robots': {\n-        target.robots = resolveRobots(source.robots)\n+        newResolvedMetadata.robots = resolveRobots(metadata.robots)\n         break\n       }\n       case 'archives':\n       case 'assets':\n       case 'bookmarks':\n       case 'keywords': {\n-        target[key] = resolveAsArrayOrUndefined(source[key])\n+        newResolvedMetadata[key] = resolveAsArrayOrUndefined(metadata[key])\n         break\n       }\n       case 'authors': {\n-        target[key] = resolveAsArrayOrUndefined(source.authors)\n+        newResolvedMetadata[key] = convertUrlsToStrings(\n+          resolveAsArrayOrUndefined(metadata.authors)\n+        )\n         break\n       }\n       case 'itunes': {\n-        target[key] = await resolveItunes(\n-          source.itunes,\n+        newResolvedMetadata[key] = await resolveItunes(\n+          metadata.itunes,\n           metadataBase,\n           pathname,\n           metadataContext\n         )\n         break\n       }\n       case 'pagination': {\n-        target.pagination = await resolvePagination(\n-          source.pagination,\n+        newResolvedMetadata.pagination = await resolvePagination(\n+          metadata.pagination,\n           metadataBase,\n           pathname,\n           metadataContext\n@@ -270,25 +325,52 @@ async function mergeMetadata(\n       }\n       // directly assign fields that fallback to null\n       case 'abstract':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'applicationName':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'description':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'generator':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'creator':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'publisher':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'category':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'classification':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'referrer':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'formatDetection':\n+        newResolvedMetadata[key] = metadata[key] ?? null\n+        break\n       case 'manifest':\n+        newResolvedMetadata[key] = convertUrlsToStrings(metadata[key]) ?? null\n+        break\n       case 'pinterest':\n-        // @ts-ignore TODO: support inferring\n-        target[key] = source[key] || null\n+        newResolvedMetadata[key] = convertUrlsToStrings(metadata[key]) ?? null\n         break\n       case 'other':\n-        target.other = Object.assign({}, target.other, source.other)\n+        newResolvedMetadata.other = Object.assign(\n+          {},\n+          newResolvedMetadata.other,\n+          metadata.other\n+        )\n         break\n       case 'metadataBase':\n-        target.metadataBase = metadataBase\n+        newResolvedMetadata.metadataBase = metadataBase\n+          ? metadataBase.toString()\n+          : null\n         break\n \n       case 'apple-touch-fullscreen': {\n@@ -306,7 +388,7 @@ async function mergeMetadata(\n       case 'themeColor':\n       case 'colorScheme':\n       case 'viewport':\n-        if (source[key] != null) {\n+        if (metadata[key] != null) {\n           buildState.warnings.add(\n             `Unsupported metadata ${key} is configured in metadata export in ${route}. Please move it to viewport export instead.\\nRead more: https://nextjs.org/docs/app/api-reference/functions/generate-viewport`\n           )\n@@ -317,9 +399,11 @@ async function mergeMetadata(\n       }\n     }\n   }\n+\n   return mergeStaticMetadata(\n-    source,\n-    target,\n+    metadataBase,\n+    metadata,\n+    newResolvedMetadata,\n     staticFilesMetadata,\n     metadataContext,\n     titleTemplates,\n@@ -328,41 +412,51 @@ async function mergeMetadata(\n   )\n }\n \n+/**\n+ * Merges the given viewport with the resolved viewport. Returns a new object.\n+ */\n function mergeViewport({\n-  target,\n-  source,\n+  resolvedViewport,\n+  viewport,\n }: {\n-  target: ResolvedViewport\n-  source: Viewport | null\n-}): void {\n-  if (!source) return\n-  for (const key_ in source) {\n-    const key = key_ as keyof Viewport\n-\n-    switch (key) {\n-      case 'themeColor': {\n-        target.themeColor = resolveThemeColor(source.themeColor)\n-        break\n+  resolvedViewport: ResolvedViewport\n+  viewport: Viewport | null\n+}): ResolvedViewport {\n+  const newResolvedViewport = structuredClone(resolvedViewport)\n+\n+  if (viewport) {\n+    for (const key_ in viewport) {\n+      const key = key_ as keyof Viewport\n+\n+      switch (key) {\n+        case 'themeColor': {\n+          newResolvedViewport.themeColor = resolveThemeColor(\n+            viewport.themeColor\n+          )\n+          break\n+        }\n+        case 'colorScheme':\n+          newResolvedViewport.colorScheme = viewport.colorScheme || null\n+          break\n+        case 'width':\n+        case 'height':\n+        case 'initialScale':\n+        case 'minimumScale':\n+        case 'maximumScale':\n+        case 'userScalable':\n+        case 'viewportFit':\n+        case 'interactiveWidget':\n+          // always override the target with the source\n+          // @ts-ignore viewport properties\n+          newResolvedViewport[key] = viewport[key]\n+          break\n+        default:\n+          key satisfies never\n       }\n-      case 'colorScheme':\n-        target.colorScheme = source.colorScheme || null\n-        break\n-      case 'width':\n-      case 'height':\n-      case 'initialScale':\n-      case 'minimumScale':\n-      case 'maximumScale':\n-      case 'userScalable':\n-      case 'viewportFit':\n-      case 'interactiveWidget':\n-        // always override the target with the source\n-        // @ts-ignore viewport properties\n-        target[key] = source[key]\n-        break\n-      default:\n-        key satisfies never\n     }\n   }\n+\n+  return newResolvedViewport\n }\n \n function getDefinedViewport(\n@@ -821,7 +915,7 @@ function postProcessMetadata(\n     if (Object.keys(autoFillProps).length > 0) {\n       const partialTwitter = resolveTwitter(\n         autoFillProps,\n-        metadata.metadataBase,\n+        normalizeMetadataBase(metadata.metadataBase),\n         metadataContext,\n         titleTemplates.twitter\n       )\n@@ -834,7 +928,7 @@ function postProcessMetadata(\n           ...(!hasTwImages && { images: partialTwitter?.images }),\n         })\n       } else {\n-        metadata.twitter = partialTwitter\n+        metadata.twitter = convertUrlsToStrings(partialTwitter)\n       }\n     }\n   }\n@@ -917,27 +1011,14 @@ function getResult<T extends Metadata | Viewport>(\n   }\n }\n \n-function resolvePendingResult<\n-  ResolvedType extends ResolvedMetadata | ResolvedViewport,\n->(\n-  parentResult: ResolvedType,\n-  resolveParentResult: (value: ResolvedType) => void\n-): void {\n-  // In dev we clone and freeze to prevent relying on mutating resolvedMetadata directly.\n-  // In prod we just pass resolvedMetadata through without any copying.\n+function freezeInDev<T extends object>(obj: T): T {\n   if (process.env.NODE_ENV === 'development') {\n-    // @ts-expect-error -- DeepReadonly<T> is by definition not assignable to T\n-    // Instead, we should only accept DeepReadonly<ResolvedType>\n-    parentResult = (\n+    return (\n       require('../../shared/lib/deep-freeze') as typeof import('../../shared/lib/deep-freeze')\n-    ).deepFreeze(\n-      (\n-        require('./clone-metadata') as typeof import('./clone-metadata')\n-      ).cloneMetadata(parentResult)\n-    )\n+    ).deepFreeze(obj) as T\n   }\n \n-  resolveParentResult(parentResult)\n+  return obj\n }\n \n export async function accumulateMetadata(\n@@ -989,7 +1070,7 @@ export async function accumulateMetadata(\n       // was a resolver\n       pendingMetadata = resolversAndResults[resultIndex++] as Result<Metadata>\n \n-      resolvePendingResult(resolvedMetadata, resolveParentMetadata)\n+      resolveParentMetadata(freezeInDev(resolvedMetadata))\n     }\n     // Otherwise the item was either null or a static export\n \n@@ -1001,8 +1082,8 @@ export async function accumulateMetadata(\n     }\n \n     resolvedMetadata = await mergeMetadata(route, pathname, {\n-      target: resolvedMetadata,\n-      source: metadata,\n+      resolvedMetadata,\n+      metadata,\n       metadataContext,\n       staticFilesMetadata,\n       titleTemplates,\n@@ -1057,7 +1138,7 @@ export async function accumulateMetadata(\n export async function accumulateViewport(\n   viewportItems: ViewportItems\n ): Promise<ResolvedViewport> {\n-  const resolvedViewport: ResolvedViewport = createDefaultViewport()\n+  let resolvedViewport: ResolvedViewport = createDefaultViewport()\n \n   const resolversAndResults = prerenderViewport(viewportItems)\n   let i = 0\n@@ -1073,7 +1154,7 @@ export async function accumulateViewport(\n       // was a resolver\n       pendingViewport = resolversAndResults[i++] as Result<Viewport>\n \n-      resolvePendingResult(resolvedViewport, resolveParentViewport)\n+      resolveParentViewport(freezeInDev(resolvedViewport))\n     }\n     // Otherwise the item was either null or a static export\n \n@@ -1084,11 +1165,9 @@ export async function accumulateViewport(\n       viewport = pendingViewport\n     }\n \n-    mergeViewport({\n-      target: resolvedViewport,\n-      source: viewport,\n-    })\n+    resolvedViewport = mergeViewport({ resolvedViewport, viewport })\n   }\n+\n   return resolvedViewport\n }\n "
        },
        {
            "sha": "d3810df726fdfb7db0f0211e733caf56459dfa1c",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-basics.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 16,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-basics.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-basics.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-basics.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -1,10 +1,7 @@\n-import type {\n-  AlternateLinkDescriptor,\n-  ResolvedAlternateURLs,\n-} from '../types/alternative-urls-types'\n+import type { AlternateLinkDescriptor } from '../types/alternative-urls-types'\n import type {\n   Metadata,\n-  ResolvedMetadata,\n+  ResolvedMetadataWithURLs,\n   Viewport,\n } from '../types/metadata-interface'\n import type { ResolvedVerification } from '../types/metadata-types'\n@@ -14,11 +11,14 @@ import type {\n   MetadataContext,\n } from '../types/resolvers'\n import { resolveAsArrayOrUndefined } from '../generate/utils'\n-import { resolveAbsoluteUrlWithPathname } from './resolve-url'\n+import {\n+  resolveAbsoluteUrlWithPathname,\n+  type MetadataBaseURL,\n+} from './resolve-url'\n \n function resolveAlternateUrl(\n   url: string | URL,\n-  metadataBase: URL | null,\n+  metadataBase: MetadataBaseURL,\n   pathname: string,\n   metadataContext: MetadataContext\n ) {\n@@ -66,7 +66,7 @@ async function resolveUrlValuesOfObject(\n       >\n     | null\n     | undefined,\n-  metadataBase: ResolvedMetadata['metadataBase'],\n+  metadataBase: MetadataBaseURL,\n   pathname: Promise<string>,\n   metadataContext: MetadataContext\n ): Promise<null | Record<string, AlternateLinkDescriptor[]>> {\n@@ -108,7 +108,7 @@ async function resolveUrlValuesOfObject(\n \n async function resolveCanonicalUrl(\n   urlOrDescriptor: string | URL | null | AlternateLinkDescriptor | undefined,\n-  metadataBase: URL | null,\n+  metadataBase: MetadataBaseURL,\n   pathname: Promise<string>,\n   metadataContext: MetadataContext\n ): Promise<null | AlternateLinkDescriptor> {\n@@ -134,7 +134,7 @@ async function resolveCanonicalUrl(\n \n export const resolveAlternates: AsyncFieldResolverExtraArgs<\n   'alternates',\n-  [ResolvedMetadata['metadataBase'], Promise<string>, MetadataContext]\n+  [MetadataBaseURL, Promise<string>, MetadataContext]\n > = async (alternates, metadataBase, pathname, context) => {\n   if (!alternates) return null\n \n@@ -163,14 +163,12 @@ export const resolveAlternates: AsyncFieldResolverExtraArgs<\n     context\n   )\n \n-  const result: ResolvedAlternateURLs = {\n+  return {\n     canonical,\n     languages,\n     media,\n     types,\n   }\n-\n-  return result\n }\n \n const robotsKeys = [\n@@ -271,12 +269,12 @@ export const resolveAppLinks: FieldResolver<'appLinks'> = (appLinks) => {\n     // @ts-ignore // TODO: type infer\n     appLinks[key] = resolveAsArrayOrUndefined(appLinks[key])\n   }\n-  return appLinks as ResolvedMetadata['appLinks']\n+  return appLinks as ResolvedMetadataWithURLs['appLinks']\n }\n \n export const resolveItunes: AsyncFieldResolverExtraArgs<\n   'itunes',\n-  [ResolvedMetadata['metadataBase'], Promise<string>, MetadataContext]\n+  [MetadataBaseURL, Promise<string>, MetadataContext]\n > = async (itunes, metadataBase, pathname, context) => {\n   if (!itunes) return null\n   return {\n@@ -302,7 +300,7 @@ export const resolveFacebook: FieldResolver<'facebook'> = (facebook) => {\n \n export const resolvePagination: AsyncFieldResolverExtraArgs<\n   'pagination',\n-  [ResolvedMetadata['metadataBase'], Promise<string>, MetadataContext]\n+  [MetadataBaseURL, Promise<string>, MetadataContext]\n > = async (pagination, metadataBase, pathname, context) => {\n   return {\n     previous: pagination?.previous"
        },
        {
            "sha": "a27fc4874d75009895a5f03ae35290126c62fb9a",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-icons.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-icons.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-icons.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-icons.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -1,4 +1,4 @@\n-import type { ResolvedMetadata } from '../types/metadata-interface'\n+import type { ResolvedMetadataWithURLs } from '../types/metadata-interface'\n import type { Icon, IconDescriptor } from '../types/metadata-types'\n import type { FieldResolver } from '../types/resolvers'\n import { resolveAsArrayOrUndefined } from '../generate/utils'\n@@ -16,7 +16,7 @@ export const resolveIcons: FieldResolver<'icons'> = (icons) => {\n     return null\n   }\n \n-  const resolved: ResolvedMetadata['icons'] = {\n+  const resolved: ResolvedMetadataWithURLs['icons'] = {\n     icon: [],\n     apple: [],\n   }"
        },
        {
            "sha": "a1aa1132ad7f67c154d417d3ae0a12eaccd59ac3",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-opengraph.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-opengraph.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-opengraph.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-opengraph.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -1,4 +1,4 @@\n-import type { ResolvedMetadata } from '../types/metadata-interface'\n+import type { ResolvedMetadataWithURLs } from '../types/metadata-interface'\n import type {\n   OpenGraphType,\n   OpenGraph,\n@@ -16,13 +16,13 @@ import {\n   isStringOrURL,\n   resolveUrl,\n   resolveAbsoluteUrlWithPathname,\n+  type MetadataBaseURL,\n } from './resolve-url'\n import { resolveTitle } from './resolve-title'\n import { isFullStringUrl } from '../../url'\n import { warnOnce } from '../../../build/output/log'\n \n type FlattenArray<T> = T extends (infer U)[] ? U : T\n-type ResolvedMetadataBase = ResolvedMetadata['metadataBase']\n \n const OgTypeFields = {\n   article: ['authors', 'tags'],\n@@ -42,7 +42,7 @@ const OgTypeFields = {\n \n function resolveAndValidateImage(\n   item: FlattenArray<OpenGraph['images'] | Twitter['images']>,\n-  metadataBase: ResolvedMetadataBase,\n+  metadataBase: MetadataBaseURL,\n   isStaticMetadataRouteFile: boolean | undefined\n ) {\n   if (!item) return undefined\n@@ -109,21 +109,21 @@ function resolveAndValidateImage(\n \n export function resolveImages(\n   images: Twitter['images'],\n-  metadataBase: ResolvedMetadataBase,\n+  metadataBase: MetadataBaseURL,\n   isStaticMetadataRouteFile: boolean\n-): NonNullable<ResolvedMetadata['twitter']>['images']\n+): NonNullable<ResolvedMetadataWithURLs['twitter']>['images']\n export function resolveImages(\n   images: OpenGraph['images'],\n-  metadataBase: ResolvedMetadataBase,\n+  metadataBase: MetadataBaseURL,\n   isStaticMetadataRouteFile: boolean\n-): NonNullable<ResolvedMetadata['openGraph']>['images']\n+): NonNullable<ResolvedMetadataWithURLs['openGraph']>['images']\n export function resolveImages(\n   images: OpenGraph['images'] | Twitter['images'],\n-  metadataBase: ResolvedMetadataBase,\n+  metadataBase: MetadataBaseURL,\n   isStaticMetadataRouteFile: boolean\n ):\n-  | NonNullable<ResolvedMetadata['twitter']>['images']\n-  | NonNullable<ResolvedMetadata['openGraph']>['images'] {\n+  | NonNullable<ResolvedMetadataWithURLs['twitter']>['images']\n+  | NonNullable<ResolvedMetadataWithURLs['openGraph']>['images'] {\n   const resolvedImages = resolveAsArrayOrUndefined(images)\n   if (!resolvedImages) return resolvedImages\n \n@@ -160,7 +160,7 @@ function getFieldsByOgType(ogType: OpenGraphType | undefined) {\n \n export const resolveOpenGraph: AsyncFieldResolverExtraArgs<\n   'openGraph',\n-  [ResolvedMetadataBase, Promise<string>, MetadataContext, string | null]\n+  [MetadataBaseURL, Promise<string>, MetadataContext, string | null]\n > = async (\n   openGraph,\n   metadataBase,\n@@ -216,7 +216,7 @@ const TwitterBasicInfoKeys = [\n \n export const resolveTwitter: FieldResolverExtraArgs<\n   'twitter',\n-  [ResolvedMetadataBase, MetadataContext, string | null]\n+  [MetadataBaseURL, MetadataContext, string | null]\n > = (twitter, metadataBase, metadataContext, titleTemplate) => {\n   if (!twitter) return null\n   let card = 'card' in twitter ? twitter.card : undefined"
        },
        {
            "sha": "8a240a8b87339e9dfacc586b610992be5d1301c0",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -1,6 +1,8 @@\n import path from '../../../shared/lib/isomorphic/path'\n import type { MetadataContext } from '../types/resolvers'\n \n+export type MetadataBaseURL = URL | null\n+\n function isStringOrURL(icon: any): icon is string | URL {\n   return typeof icon === 'string' || icon instanceof URL\n }\n@@ -31,7 +33,7 @@ function getProductionDeploymentUrl(): URL | undefined {\n  * it'll fall back to the Vercel production deployment, and localhost as a last resort.\n  */\n export function getSocialImageMetadataBaseFallback(\n-  metadataBase: URL | null\n+  metadataBase: MetadataBaseURL\n ): URL {\n   const defaultMetadataBase = createLocalMetadataBase()\n   const previewDeploymentUrl = getPreviewDeploymentUrl()\n@@ -52,16 +54,16 @@ export function getSocialImageMetadataBaseFallback(\n   return fallbackMetadataBase\n }\n \n-function resolveUrl(url: null | undefined, metadataBase: URL | null): null\n-function resolveUrl(url: string | URL, metadataBase: URL | null): URL\n+function resolveUrl(url: null | undefined, metadataBase: MetadataBaseURL): null\n+function resolveUrl(url: string | URL, metadataBase: MetadataBaseURL): URL\n function resolveUrl(\n-  url: string | URL | null | undefined,\n-  metadataBase: URL | null\n-): URL | null\n+  url: string | MetadataBaseURL | undefined,\n+  metadataBase: MetadataBaseURL\n+): MetadataBaseURL\n function resolveUrl(\n-  url: string | URL | null | undefined,\n-  metadataBase: URL | null\n-): URL | null {\n+  url: string | MetadataBaseURL | undefined,\n+  metadataBase: MetadataBaseURL\n+): MetadataBaseURL {\n   if (url instanceof URL) return url\n   if (!url) return null\n \n@@ -100,7 +102,7 @@ function isFilePattern(pathname: string): boolean {\n // Resolve `pathname` if `url` is a relative path the compose with `metadataBase`.\n function resolveAbsoluteUrlWithPathname(\n   url: string | URL,\n-  metadataBase: URL | null,\n+  metadataBase: MetadataBaseURL,\n   pathname: string,\n   { trailingSlash }: MetadataContext\n ): string {"
        },
        {
            "sha": "e0754e4d41c3edd50fd5a7b797f555276f9efa8d",
            "filename": "packages/next/src/lib/metadata/types/extra-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fextra-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fextra-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fextra-types.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -112,7 +112,7 @@ export type PinterestRichPin = {\n }\n \n export type ResolvedPinterest = {\n-  richPin?: string\n+  richPin?: string | boolean\n }\n \n // Format Detection"
        },
        {
            "sha": "13ffa6e62a5f5d1cd51d2b23564a9798d8dc0e03",
            "filename": "packages/next/src/lib/metadata/types/metadata-interface.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fmetadata-interface.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fmetadata-interface.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fmetadata-interface.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -95,7 +95,7 @@ interface Metadata extends DeprecatedMetadataFields {\n    * When relative URLs (for Open Graph images, alternates, etc.) are used, they are composed with this base.\n    * If not provided, Next.js will populate a default value based on environment variables.\n    */\n-  metadataBase?: null | URL | undefined\n+  metadataBase?: null | string | URL | undefined\n \n   /**\n    * The document title.\n@@ -564,13 +564,13 @@ interface Metadata extends DeprecatedMetadataFields {\n }\n \n /**\n- * ResolvedMetadata represents the fully processed metadata after defaults are applied\n- * and relative URLs are composed with `metadataBase`.\n+ * ResolvedMetadataWithURLs represents the fully processed metadata after\n+ * defaults are applied and relative URLs are composed with `metadataBase`.\n  */\n-interface ResolvedMetadata extends DeprecatedMetadataFields {\n+interface ResolvedMetadataWithURLs extends DeprecatedMetadataFields {\n   // origin and base path for absolute urls for various metadata links such as\n   // opengraph-image\n-  metadataBase: null | URL\n+  metadataBase: string | null | URL\n \n   // The Document title and template if defined\n   title: null | AbsoluteTemplateString\n@@ -664,6 +664,18 @@ interface ResolvedMetadata extends DeprecatedMetadataFields {\n       } & DeprecatedMetadataFields)\n }\n \n+export type WithStringifiedURLs<T> = T extends URL\n+  ? string\n+  : T extends object\n+    ? { [K in keyof T]: WithStringifiedURLs<T[K]> }\n+    : T\n+\n+/**\n+ * ResolvedMetadata represents the fully processed metadata after defaults are\n+ * applied and relative URLs are composed with `metadataBase`.\n+ */\n+type ResolvedMetadata = WithStringifiedURLs<ResolvedMetadataWithURLs>\n+\n type RobotsFile = {\n   // Apply rules for all\n   rules:\n@@ -783,6 +795,7 @@ interface ResolvedViewport extends ViewportLayout {\n export type {\n   Metadata,\n   ResolvedMetadata,\n+  ResolvedMetadataWithURLs,\n   ResolvingMetadata,\n   MetadataRoute,\n   Viewport,"
        },
        {
            "sha": "fee67aff51f49802fa7ece6158f5f42411bb0922",
            "filename": "packages/next/src/lib/metadata/types/resolvers.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fresolvers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fresolvers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Ftypes%2Fresolvers.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -1,23 +1,23 @@\n-import type { Metadata, ResolvedMetadata } from './metadata-interface'\n+import type { Metadata, ResolvedMetadataWithURLs } from './metadata-interface'\n \n export type FieldResolver<\n   Key extends keyof Data & keyof ResolvedData,\n   Data = Metadata,\n-  ResolvedData = ResolvedMetadata,\n+  ResolvedData = ResolvedMetadataWithURLs,\n > = (T: Data[Key]) => ResolvedData[Key]\n \n export type FieldResolverExtraArgs<\n   Key extends keyof Data & keyof ResolvedData,\n   ExtraArgs extends unknown[] = any[],\n   Data = Metadata,\n-  ResolvedData = ResolvedMetadata,\n+  ResolvedData = ResolvedMetadataWithURLs,\n > = (T: Data[Key], ...args: ExtraArgs) => ResolvedData[Key]\n \n export type AsyncFieldResolverExtraArgs<\n   Key extends keyof Data & keyof ResolvedData,\n   ExtraArgs extends unknown[] = any[],\n   Data = Metadata,\n-  ResolvedData = ResolvedMetadata,\n+  ResolvedData = ResolvedMetadataWithURLs,\n > = (T: Data[Key], ...args: ExtraArgs) => Promise<ResolvedData[Key]>\n \n export type MetadataContext = {"
        },
        {
            "sha": "d154ef9e7fb33d4e36dc06206011f8e5df130301",
            "filename": "test/e2e/app-dir/metadata/app/metadata-base/url-string/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fmetadata-base%2Furl-string%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fmetadata-base%2Furl-string%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fmetadata-base%2Furl-string%2Fpage.tsx?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -0,0 +1,17 @@\n+import { Metadata, ResolvingMetadata } from 'next'\n+\n+export default function Page() {\n+  return null\n+}\n+\n+export async function generateMetadata(\n+  _props,\n+  parent: ResolvingMetadata\n+): Promise<Metadata> {\n+  const parentMetadata = await parent\n+\n+  return {\n+    metadataBase: parentMetadata.metadataBase?.replace('base', 'case'),\n+    alternates: { canonical: '/metadata-base/url-string' },\n+  }\n+}"
        },
        {
            "sha": "5ad8d6212676b9732cd23e2ed88ae937005bb9fd",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c201b3d38781af4567510ecc0a9986f2630439f2/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c201b3d38781af4567510ecc0a9986f2630439f2/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=c201b3d38781af4567510ecc0a9986f2630439f2",
            "patch": "@@ -337,6 +337,14 @@ describe('app dir - metadata', () => {\n         'https://outerspace.com/huozhi.png'\n       )\n     })\n+\n+    it('should handle metadataBase as url string', async () => {\n+      const url$ = await next.render$('/metadata-base/url-string')\n+\n+      expect(url$('link[rel=\"canonical\"]').attr('href')).toBe(\n+        'https://example.com/case/metadata-base/url-string'\n+      )\n+    })\n   })\n \n   describe('opengraph', () => {"
        }
    ],
    "stats": {
        "total": 468,
        "additions": 279,
        "deletions": 189
    }
}