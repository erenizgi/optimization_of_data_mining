{
    "author": "kdy1",
    "message": "fix(turbopack): Fix panic while tree shaking optimization (#77492)\n\n### What?\n\nHandle duplicates in `nodes_to_merge` by checking the existence of a node using graph.\n\n### Why?\n\nBecause the previous code fails on one of the internal apps.\n\n### How?",
    "sha": "87008339eab3f39501ea4ec3b938240f67b5de80",
    "files": [
        {
            "sha": "ac663b261c6a012f7f16e4b140159fb76ed164f5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/optimizations.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/87008339eab3f39501ea4ec3b938240f67b5de80/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Foptimizations.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/87008339eab3f39501ea4ec3b938240f67b5de80/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Foptimizations.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Foptimizations.rs?ref=87008339eab3f39501ea4ec3b938240f67b5de80",
            "patch": "@@ -207,6 +207,12 @@ impl GraphOptimizer<'_> {\n             let mut nodes_to_remove = Vec::new();\n \n             for node in nodes_to_merge {\n+                // Skip if a node no longer exists in the graph. This may happen if `nodes_to_merge`\n+                // contains a duplicate.\n+                if g.node_weight(node).is_none() {\n+                    continue;\n+                }\n+\n                 // Move outgoing edges from node to start\n                 let outgoing_edges: Vec<_> = g\n                     .edges_directed(node, Direction::Outgoing)\n@@ -243,7 +249,7 @@ impl GraphOptimizer<'_> {\n             // Remove merged nodes (in reverse order to preserve indices)\n             nodes_to_remove.sort();\n             for node in nodes_to_remove.into_iter().rev() {\n-                g.remove_node(node);\n+                g.remove_node(node).expect(\"Node should exist\");\n                 did_work = true;\n             }\n         }"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}