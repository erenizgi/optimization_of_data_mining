{
    "author": "unstubbable",
    "message": "Fix on-demand revalidation with `\"use cache\"` in dev mode (#76122)\n\nThis PR is a follow-up to #76100 that enables on-demand revalidation via\nan API route in development mode. This is accomplished by implementing\nthree changes:\n1. We need to forward the user cookies, including the\n`__next_hmr_refresh_hash__` value, which is required to generate the\nsame cache key _during_ the revalidation as _before_ and, more\nimportantly, _after_ the revalidation. Otherwise the revalidated cache\nentries will use a different cache key (without the refresh hash), and\non subsequent page reload, the stale cached data would still be shown\n(using the cache key with refresh hash).\n2. When checking if a `revalidate()` call succeeded, we allow `200`\nresponses in general, and only check the `'x-nextjs-cache'` header for\n`404` response. This matches the historic intent of the feature.\n([x-ref-1](https://github.com/vercel/next.js/pull/36108/files#diff-8d464ed8b3d6ed08deabeaa05180900c38f8943d75368798861d1734103512fcR338-R342),\n[x-ref-2](https://github.com/vercel/next.js/pull/34826/files#diff-8d464ed8b3d6ed08deabeaa05180900c38f8943d75368798861d1734103512fcR318-R324)).\n3. The `isOnDemandRevalidate` status is now also set for non-`isSSG`\npages, based on the `'x-prerender-revalidate'` header. This matches the\nlogic in the incremental cache handler, which enables cache revalidation\nin dev mode when using `unstable_cache`.",
    "sha": "17b09f8230d5a6f52c76b89772bbc9e3862df6be",
    "files": [
        {
            "sha": "220297c65868ca3f3345aa650a586d5fb9c7304c",
            "filename": "packages/next/src/server/api-utils/node/api-resolver.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -43,6 +43,7 @@ type ApiContext = __ApiPreviewProps & {\n   hostname?: string\n   revalidate?: RevalidateFn\n   multiZoneDraftMode?: boolean\n+  dev: boolean\n }\n \n function getMaxContentLength(responseLimit?: ResponseLimit) {\n@@ -271,11 +272,16 @@ async function revalidate(\n   }\n   const allowedRevalidateHeaderKeys = [\n     ...(context.allowedRevalidateHeaderKeys || []),\n-    ...(context.trustHostHeader\n-      ? ['cookie', 'x-vercel-protection-bypass']\n-      : []),\n   ]\n \n+  if (context.trustHostHeader || context.dev) {\n+    allowedRevalidateHeaderKeys.push('cookie')\n+  }\n+\n+  if (context.trustHostHeader) {\n+    allowedRevalidateHeaderKeys.push('x-vercel-protection-bypass')\n+  }\n+\n   for (const key of Object.keys(req.headers)) {\n     if (allowedRevalidateHeaderKeys.includes(key)) {\n       revalidateHeaders[key] = req.headers[key] as string\n@@ -296,6 +302,7 @@ async function revalidate(\n \n       if (\n         cacheHeader?.toUpperCase() !== 'REVALIDATED' &&\n+        res.status !== 200 &&\n         !(res.status === 404 && opts.unstable_onlyGenerated)\n       ) {\n         throw new Error(`Invalid response ${res.status}`)"
        },
        {
            "sha": "0863d92da1401b2d1700486181ee361a63a12682",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -2328,13 +2328,8 @@ export default abstract class Server<\n       stripFlightHeaders(req.headers)\n     }\n \n-    let isOnDemandRevalidate = false\n-    let revalidateOnlyGenerated = false\n-\n-    if (isSSG) {\n-      ;({ isOnDemandRevalidate, revalidateOnlyGenerated } =\n-        checkIsOnDemandRevalidate(req, this.renderOpts.previewProps))\n-    }\n+    let { isOnDemandRevalidate, revalidateOnlyGenerated } =\n+      checkIsOnDemandRevalidate(req, this.renderOpts.previewProps)\n \n     if (isSSG && this.minimalMode && req.headers[MATCHED_PATH_HEADER]) {\n       // the url value is already correct when the matched-path header is set"
        },
        {
            "sha": "dbf5b401471e6a79aa6ba425d66607d04f63bb7d",
            "filename": "packages/next/src/server/lib/dev-bundler-service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -75,6 +75,7 @@ export class DevBundlerService {\n \n     if (\n       mocked.res.getHeader('x-nextjs-cache') !== 'REVALIDATED' &&\n+      mocked.res.statusCode !== 200 &&\n       !(mocked.res.statusCode === 404 && revalidateOpts.unstable_onlyGenerated)\n     ) {\n       throw new Error(`Invalid response ${mocked.res.statusCode}`)"
        },
        {
            "sha": "a26bc92c8972b232f0eda9773129650a00b1dda6",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -1224,6 +1224,7 @@ export default class NextNodeServer extends BaseServer<\n \n     if (\n       mocked.res.getHeader('x-nextjs-cache') !== 'REVALIDATED' &&\n+      mocked.res.statusCode !== 200 &&\n       !(mocked.res.statusCode === 404 && opts.unstable_onlyGenerated)\n     ) {\n       throw new Error(`Invalid response ${mocked.res.statusCode}`)"
        },
        {
            "sha": "6cb3c36071780d875f63839d22e6402395e62c88",
            "filename": "packages/next/src/server/route-modules/pages-api/module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -154,6 +154,7 @@ export class PagesAPIRouteModule extends RouteModule<\n         allowedRevalidateHeaderKeys: context.allowedRevalidateHeaderKeys,\n         hostname: context.hostname,\n         multiZoneDraftMode: context.multiZoneDraftMode,\n+        dev: context.dev,\n       },\n       context.minimalMode,\n       context.dev,"
        },
        {
            "sha": "0826a6ba3aeb857955bc40c5e5771f64ad9e0f3e",
            "filename": "test/e2e/app-dir/use-cache/app/on-demand-revalidate/revalidate-buttons.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -1,20 +1,27 @@\n 'use client'\n \n+import { useTransition } from 'react'\n+\n export function RevalidateButtons({\n   revalidatePath,\n }: {\n   revalidatePath: () => Promise<void>\n }) {\n+  const [isPending, startTransition] = useTransition()\n+\n   return (\n     <form>\n       <button id=\"revalidate-path\" formAction={revalidatePath}>\n         revalidate with revalidatePath()\n       </button>{' '}\n       <button\n         id=\"revalidate-api-route\"\n+        disabled={isPending}\n         formAction={async () => {\n-          await fetch('/api/revalidate?path=/on-demand-revalidate', {\n-            method: 'POST',\n+          startTransition(async () => {\n+            await fetch('/api/revalidate?path=/on-demand-revalidate', {\n+              method: 'POST',\n+            })\n           })\n         }}\n       >"
        },
        {
            "sha": "077e26c0be7788de278197c3aca79459e50d342e",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 18,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -303,31 +303,30 @@ describe('use-cache', () => {\n     })\n   }\n \n-  if (isNextStart) {\n-    // res.revalidate does not work in dev mode\n-    it('should revalidate caches during on-demand revalidation', async () => {\n-      const browser = await next.browser('/on-demand-revalidate')\n-      const initial = await browser.elementById('value').text()\n+  it('should revalidate caches during on-demand revalidation', async () => {\n+    const browser = await next.browser('/on-demand-revalidate')\n+    const initial = await browser.elementById('value').text()\n \n-      // Bust the ISR cache first to populate the \"use cache\" in-memory cache for\n-      // the subsequent on-demand revalidation.\n-      await browser.elementById('revalidate-path').click()\n+    // Bust the ISR cache first to populate the \"use cache\" in-memory cache for\n+    // the subsequent on-demand revalidation.\n+    await browser.elementById('revalidate-path').click()\n \n-      await retry(async () => {\n-        expect(await browser.elementById('value').text()).not.toBe(initial)\n-      })\n+    await retry(async () => {\n+      expect(await browser.elementById('value').text()).not.toBe(initial)\n+    })\n \n-      const value = await browser.elementById('value').text()\n+    const value = await browser.elementById('value').text()\n \n-      await browser.elementById('revalidate-api-route').click()\n-      await browser.waitForIdleNetwork()\n+    await browser.elementById('revalidate-api-route').click()\n+    await browser.waitForElementByCss('#revalidate-api-route:enabled')\n \n-      await retry(async () => {\n-        await browser.refresh()\n-        expect(await browser.elementById('value').text()).not.toBe(value)\n-      })\n+    await retry(async () => {\n+      await browser.refresh()\n+      expect(await browser.elementById('value').text()).not.toBe(value)\n     })\n+  })\n \n+  if (isNextStart) {\n     it('should prerender fully cacheable pages as static HTML', async () => {\n       const prerenderManifest = JSON.parse(\n         await next.readFile('.next/prerender-manifest.json')"
        },
        {
            "sha": "e48c8601df26fc2b55e01a8856a23ce72ed7e5d6",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/17b09f8230d5a6f52c76b89772bbc9e3862df6be/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=17b09f8230d5a6f52c76b89772bbc9e3862df6be",
            "patch": "@@ -1877,7 +1877,6 @@ describe('Prerender', () => {\n         })\n \n         expect(res.status).toBe(200)\n-        expect(await res.json()).toEqual({ revalidated: false })\n         expect(stripAnsi(next.cliOutput)).not.toContain('hasHeader')\n       })\n "
        }
    ],
    "stats": {
        "total": 72,
        "additions": 41,
        "deletions": 31
    }
}