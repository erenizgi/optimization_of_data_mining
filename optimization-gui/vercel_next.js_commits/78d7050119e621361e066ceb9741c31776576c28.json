{
    "author": "bgw",
    "message": "Turbopack: Remove the `lazy-regex` dependency (#82288)\n\nYes, `lazy_regex` makes this code slightly cleaner, and it does have the\nnice side-effect of compile-time checking the regexes but:\n\n- We've got test coverage for all of these regexes.\n- It adds a proc macro, proc macros are detrimental to build\nperformance.\n- It doesn't really clean up the code that much versus the new stdlib\n`LazyLock`.\n- This is the only crate using it.\n\nSo I don't think it's worth it.",
    "sha": "78d7050119e621361e066ceb9741c31776576c28",
    "files": [
        {
            "sha": "ae9c8b8d90ee9a348afe2e2481e69556e6bd2a14",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -3511,29 +3511,6 @@ dependencies = [\n  \"libc\",\n ]\n \n-[[package]]\n-name = \"lazy-regex\"\n-version = \"3.0.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"57451d19ad5e289ff6c3d69c2a2424652995c42b79dafa11e9c4d5508c913c01\"\n-dependencies = [\n- \"lazy-regex-proc_macros\",\n- \"once_cell\",\n- \"regex\",\n-]\n-\n-[[package]]\n-name = \"lazy-regex-proc_macros\"\n-version = \"3.0.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"0f0a1d9139f0ee2e862e08a9c5d0ba0470f2aa21cd1e1aa1b1562f83116c725f\"\n-dependencies = [\n- \"proc-macro2\",\n- \"quote\",\n- \"regex\",\n- \"syn 2.0.104\",\n-]\n-\n [[package]]\n name = \"lazy_static\"\n version = \"1.4.0\"\n@@ -4369,7 +4346,6 @@ dependencies = [\n  \"indexmap 2.9.0\",\n  \"indoc\",\n  \"itertools 0.10.5\",\n- \"lazy-regex\",\n  \"mime_guess\",\n  \"modularize_imports\",\n  \"next-custom-transforms\","
        },
        {
            "sha": "6676b606326b81c2176b9840cff31de2348c2da1",
            "filename": "crates/next-core/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2FCargo.toml?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -16,7 +16,6 @@ anyhow = { workspace = true }\n async-trait = { workspace = true }\n base64 = \"0.21.0\"\n either = { workspace = true }\n-lazy-regex = \"3.0.1\"\n next-custom-transforms = { workspace = true }\n once_cell = { workspace = true }\n qstring = { workspace = true }"
        },
        {
            "sha": "da6d8da917034fd9019c9e7eafbd131d4bd2e45e",
            "filename": "crates/next-core/src/next_app/metadata/mod.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -1,7 +1,8 @@\n-use std::ops::Deref;\n+use std::{ops::Deref, sync::LazyLock};\n \n use anyhow::Result;\n use once_cell::sync::Lazy;\n+use regex::Regex;\n use rustc_hash::FxHashMap;\n use turbo_rcstr::RcStr;\n use turbo_tasks_fs::FileSystemPath;\n@@ -41,11 +42,15 @@ pub struct MetadataFileMatch<'a> {\n }\n \n fn match_numbered_metadata(stem: &str) -> Option<(&str, &str)> {\n-    let (_whole, stem, number) = lazy_regex::regex_captures!(\n-        \"^(icon|apple-icon|opengraph-image|twitter-image)(\\\\d+)$\",\n-        stem\n-    )?;\n-\n+    static NUMBERED_METADATA_RE: LazyLock<Regex> = LazyLock::new(|| {\n+        Regex::new(\"^(icon|apple-icon|opengraph-image|twitter-image)(\\\\d+)$\").unwrap()\n+    });\n+    let captures = NUMBERED_METADATA_RE.captures(stem)?;\n+    // these captures must be defined if `captures` is `Some(...)`.\n+    let (stem, number) = (\n+        captures.get(1).unwrap().as_str(),\n+        captures.get(2).unwrap().as_str(),\n+    );\n     Some((stem, number))\n }\n "
        },
        {
            "sha": "891a79322cdacc8731d9e815d7e55528121bbe61",
            "filename": "crates/next-core/src/next_font/google/mod.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -1,8 +1,9 @@\n-use std::path::Path;\n+use std::{path::Path, sync::LazyLock};\n \n use anyhow::{Context, Result, bail};\n use futures::FutureExt;\n use indoc::formatdoc;\n+use regex::Regex;\n use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n@@ -527,14 +528,19 @@ fn find_font_files_in_css(css: &str, subsets_to_preload: &[RcStr]) -> Vec<FontFi\n     let mut current_subset = \"\";\n \n     for line in css.lines() {\n-        if let Some((_, new_subset)) = lazy_regex::regex_captures!(r#\"/\\* (.+?) \\*/\"#, line) {\n-            current_subset = new_subset;\n+        static COMMENT_RE: LazyLock<Regex> =\n+            LazyLock::new(|| Regex::new(r#\"/\\* (.+?) \\*/\"#).unwrap());\n+        if let Some(new_subset) = COMMENT_RE.captures(line).and_then(|c| c.get(1)) {\n+            current_subset = new_subset.as_str();\n             continue;\n         }\n \n-        let Some((_, font_url)) = lazy_regex::regex_captures!(r#\"src: url\\((.+?)\\)\"#, line) else {\n+        static FONT_URL_RE: LazyLock<Regex> =\n+            LazyLock::new(|| Regex::new(r#\"src: url\\((.+?)\\)\"#).unwrap());\n+        let Some(font_url) = FONT_URL_RE.captures(line).and_then(|c| c.get(1)) else {\n             continue;\n         };\n+        let font_url = font_url.as_str();\n \n         if font_files.iter().any(|file| file.font_url == font_url) {\n             continue;"
        },
        {
            "sha": "02613899ffc05920f2b3230b7e46097ffc2c44f2",
            "filename": "crates/next-core/src/next_font/util.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_font%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_font%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Futil.rs?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -1,4 +1,7 @@\n+use std::sync::LazyLock;\n+\n use anyhow::{Context, Result};\n+use regex::Regex;\n use serde::Deserialize;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::ResolvedVc;\n@@ -78,9 +81,10 @@ pub(crate) async fn can_use_next_font(project_path: FileSystemPath, query: &RcSt\n             .0,\n     )?;\n \n-    let document_re = lazy_regex::regex!(\"^(src/)?_document\\\\.[^/]+$\");\n+    static DOCUMENT_RE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(\"^(src/)?_document\\\\.[^/]+$\").unwrap());\n     let path = project_path.join(&request.path)?;\n-    let can_use = !document_re.is_match(&request.path);\n+    let can_use = !DOCUMENT_RE.is_match(&request.path);\n     if !can_use {\n         NextFontIssue {\n             path: path.clone(),"
        },
        {
            "sha": "64ad475d3d07497b2ae2f8713392990f14b6fcaa",
            "filename": "crates/next-core/src/next_server/resolve.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -1,4 +1,7 @@\n+use std::sync::LazyLock;\n+\n use anyhow::Result;\n+use regex::Regex;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n@@ -93,13 +96,15 @@ impl AfterResolvePlugin for ExternalCjsModulesResolvePlugin {\n         };\n \n         // from https://github.com/vercel/next.js/blob/8d1c619ad650f5d147207f267441caf12acd91d1/packages/next/src/build/handle-externals.ts#L188\n-        let never_external_regex = lazy_regex::regex!(\"^(?:private-next-pages\\\\/|next\\\\/(?:dist\\\\/pages\\\\/|(?:app|cache|document|link|form|head|image|legacy\\\\/image|constants|dynamic|script|navigation|headers|router|compat\\\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)\");\n+        static NEVER_EXTERNAL_RE: LazyLock<Regex> = LazyLock::new(|| {\n+            Regex::new(\"^(?:private-next-pages\\\\/|next\\\\/(?:dist\\\\/pages\\\\/|(?:app|cache|document|link|form|head|image|legacy\\\\/image|constants|dynamic|script|navigation|headers|router|compat\\\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)\").unwrap()\n+        });\n \n         let Pattern::Constant(package_subpath) = package_subpath else {\n             return Ok(ResolveResultOption::none());\n         };\n         let request_str: RcStr = format!(\"{package}{package_subpath}\").into();\n-        if never_external_regex.is_match(&request_str) {\n+        if NEVER_EXTERNAL_RE.is_match(&request_str) {\n             return Ok(ResolveResultOption::none());\n         }\n "
        },
        {
            "sha": "08dbc08e93a7bddc8916553f3ff78a313c40f6eb",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 26,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/78d7050119e621361e066ceb9741c31776576c28/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=78d7050119e621361e066ceb9741c31776576c28",
            "patch": "@@ -1,6 +1,7 @@\n-use std::future::Future;\n+use std::{future::Future, sync::LazyLock};\n \n use anyhow::{Context, Result, bail};\n+use regex::Regex;\n use serde::{Deserialize, Serialize, de::DeserializeOwned};\n use swc_core::{\n     common::{GLOBALS, Spanned, source_map::SmallPos},\n@@ -764,10 +765,11 @@ pub async fn load_next_js_template(\n \n     // Update the relative imports to be absolute. This will update any relative\n     // imports to be relative to the root of the `next` package.\n-    let regex = lazy_regex::regex!(\"(?:from '(\\\\..*)'|import '(\\\\..*)')\");\n+    static IMPORT_PATH_RE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(\"(?:from '(\\\\..*)'|import '(\\\\..*)')\").unwrap());\n \n     let mut count = 0;\n-    let mut content = replace_all(regex, &content, |caps| {\n+    let mut content = replace_all(&IMPORT_PATH_RE, &content, |caps| {\n         let from_request = caps.get(1).map_or(\"\", |c| c.as_str());\n         let import_request = caps.get(2).map_or(\"\", |c| c.as_str());\n \n@@ -832,16 +834,13 @@ pub async fn load_next_js_template(\n     }\n \n     // Check to see if there's any remaining template variables.\n-    let regex = lazy_regex::regex!(\"/VAR_[A-Z_]+\");\n-    let matches = regex\n-        .find_iter(&content)\n-        .map(|m| m.as_str().to_string())\n-        .collect::<Vec<_>>();\n+    static TEMPLATE_VAR_RE: LazyLock<Regex> = LazyLock::new(|| Regex::new(\"VAR_[A-Z_]+\").unwrap());\n+    let mut matches = TEMPLATE_VAR_RE.find_iter(&content).peekable();\n \n-    if !matches.is_empty() {\n+    if matches.peek().is_some() {\n         bail!(\n             \"Invariant: Expected to replace all template variables, found {}\",\n-            matches.join(\", \"),\n+            matches.map(|m| m.as_str()).collect::<Vec<_>>().join(\", \"),\n         )\n     }\n \n@@ -853,7 +852,7 @@ pub async fn load_next_js_template(\n         let difference = replacements\n             .keys()\n             .filter(|k| !replaced.contains(*k))\n-            .cloned()\n+            .copied()\n             .collect::<Vec<_>>();\n \n         bail!(\n@@ -875,16 +874,14 @@ pub async fn load_next_js_template(\n     }\n \n     // Check to see if there's any remaining injections.\n-    let regex = lazy_regex::regex!(\"// INJECT:[A-Za-z0-9_]+\");\n-    let matches = regex\n-        .find_iter(&content)\n-        .map(|m| m.as_str().to_string())\n-        .collect::<Vec<_>>();\n+    static INJECT_RE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(\"// INJECT:[A-Za-z0-9_]+\").unwrap());\n+    let mut matches = INJECT_RE.find_iter(&content).peekable();\n \n-    if !matches.is_empty() {\n+    if matches.peek().is_some() {\n         bail!(\n             \"Invariant: Expected to inject all injections, found {}\",\n-            matches.join(\", \"),\n+            matches.map(|m| m.as_str()).collect::<Vec<_>>().join(\", \"),\n         )\n     }\n \n@@ -896,7 +893,7 @@ pub async fn load_next_js_template(\n         let difference = injections\n             .keys()\n             .filter(|k| !injected.contains(*k))\n-            .cloned()\n+            .copied()\n             .collect::<Vec<_>>();\n \n         bail!(\n@@ -939,16 +936,14 @@ pub async fn load_next_js_template(\n     }\n \n     // Check to see if there's any remaining imports.\n-    let regex = lazy_regex::regex!(\"// OPTIONAL_IMPORT:(\\\\* as )?[A-Za-z0-9_]+\");\n-    let matches = regex\n-        .find_iter(&content)\n-        .map(|m| m.as_str().to_string())\n-        .collect::<Vec<_>>();\n+    static OPTIONAL_IMPORT_RE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(\"// OPTIONAL_IMPORT:(\\\\* as )?[A-Za-z0-9_]+\").unwrap());\n+    let mut matches = OPTIONAL_IMPORT_RE.find_iter(&content).peekable();\n \n-    if !matches.is_empty() {\n+    if matches.peek().is_some() {\n         bail!(\n             \"Invariant: Expected to inject all imports, found {}\",\n-            matches.join(\", \"),\n+            matches.map(|m| m.as_str()).collect::<Vec<_>>().join(\", \"),\n         )\n     }\n "
        }
    ],
    "stats": {
        "total": 120,
        "additions": 55,
        "deletions": 65
    }
}