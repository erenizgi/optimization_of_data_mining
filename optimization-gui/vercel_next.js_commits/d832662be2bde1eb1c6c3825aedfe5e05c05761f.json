{
    "author": "kdy1",
    "message": "fix(turbopack): Call `.minify()` of lightningcss `StyleSheet` (#77313)\n\n### What?\n\nCall `minify()` of `StyleSheet`.\n\n\n### Why?\n\nWe should call it regardless, as it's actually `transform()` with a bad name. See https://github.com/parcel-bundler/lightningcss/issues/935#issuecomment-2739325537\n\n\n### How\n\n - Closes https://github.com/vercel/next.js/issues/75526",
    "sha": "d832662be2bde1eb1c6c3825aedfe5e05c05761f",
    "files": [
        {
            "sha": "acd225bb90a53bf12fdb3eef07576fda69df7095",
            "filename": "test/integration/critical-css/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcritical-css%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcritical-css%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcritical-css%2Ftest%2Findex.test.js?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -39,15 +39,15 @@ function runTests() {\n     expect(html).toMatch(\n       /<link rel=\"stylesheet\" href=\"\\/_next\\/static\\/.*\\.css\" .*>/\n     )\n-    expect(html).toMatch(/body{font-family:SF Pro Text/)\n+    expect(html).toMatch(/body{/)\n   })\n \n   it('should inline critical CSS (dynamic)', async () => {\n     const html = await renderViaHTTP(appPort, '/another')\n     expect(html).toMatch(\n       /<link rel=\"stylesheet\" href=\"\\/_next\\/static\\/.*\\.css\" .*>/\n     )\n-    expect(html).toMatch(/body{font-family:SF Pro Text/)\n+    expect(html).toMatch(/body{/)\n   })\n \n   it('should not inline non-critical css', async () => {"
        },
        {
            "sha": "b78fbf547a583709f96dd5e0bc91bc52346f0d0a",
            "filename": "test/integration/css-minify/test/index.test.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-minify%2Ftest%2Findex.test.js?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -22,11 +22,11 @@ function runTests() {\n     const css = await renderViaHTTP(appPort, href)\n     if (process.env.TURBOPACK) {\n       expect(css).toMatchInlineSnapshot(`\n-        \"/* [project]/test/integration/css-minify/styles/global.css [client] (css) */\n-        .a{--var-1:0;--var-2:0;--var-1:-50%;--var-2:-50%}.b{--var-1:0;--var-2:0;--var-2:-50%}\n+       \"/* [project]/test/integration/css-minify/styles/global.css [client] (css) */\n+       .a{--var-1:-50%;--var-2:-50%}.b{--var-1:0;--var-2:-50%}\n \n-        /*# sourceMappingURL=test_integration_css-minify_styles_global_411632c3.css.map*/\n-        \"\n+       /*# sourceMappingURL=test_integration_css-minify_styles_global_411632c3.css.map*/\n+       \"\n       `)\n     } else {\n       expect(css).toMatchInlineSnapshot("
        },
        {
            "sha": "add3a210d87ce153df9477647ce4d806440a01fd",
            "filename": "test/integration/css-modules/test/index.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -522,7 +522,7 @@ describe('CSS Module Composes Usage (Basic)', () => {\n           expect(\n             cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n           ).toMatchInlineSnapshot(\n-            `\".index-module__QppuLW__className{background:red;color:#ff0}.index-module__QppuLW__subClass{background:#00f;}\"`\n+            `\".index-module__QppuLW__className{color:#ff0;background:red}.index-module__QppuLW__subClass{background:#00f;}\"`\n           )\n         } else {\n           expect("
        },
        {
            "sha": "c532fcb2b6e26c51b17227562ccb3f0fded3c1f4",
            "filename": "test/integration/css/test/basic-global-support.test.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.js?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -534,7 +534,7 @@ module.exports = {\n \n \n \n-             .blue-text{color:orange;font-weight:bolder;background-image:url(../media/light.180573e4.svg)}\n+             .blue-text{color:orange;background-image:url(../media/light.180573e4.svg);font-weight:bolder}\n \n \n              .blue-text{color:#00f}\"\n@@ -547,7 +547,7 @@ module.exports = {\n \n \n \n-             .blue-text{color:orange;font-weight:bolder;background-image:url(../media/light.180573e4.svg)}\n+             .blue-text{color:orange;background-image:url(../media/light.180573e4.svg);font-weight:bolder}\n \n \n              .blue-text{color:#00f}\"\n@@ -611,7 +611,7 @@ describe('CSS URL via `file-loader` and asset prefix (1)', () => {\n            \".red-text{color:red;background-image:url(../media/dark.993bedd3.svg) url(../media/dark2.993bedd3.svg)}\n \n \n-           .blue-text{color:orange;font-weight:bolder;background-image:url(../media/light.180573e4.svg)}\n+           .blue-text{color:orange;background-image:url(../media/light.180573e4.svg);font-weight:bolder}\n \n            .blue-text{color:#00f}\"\n           `)\n@@ -670,7 +670,7 @@ describe('CSS URL via `file-loader` and asset prefix (2)', () => {\n \n \n \n-           .blue-text{color:orange;font-weight:bolder;background-image:url(../media/light.180573e4.svg)}\n+           .blue-text{color:orange;background-image:url(../media/light.180573e4.svg);font-weight:bolder}\n \n \n            .blue-text{color:#00f}\""
        },
        {
            "sha": "7fb90659d6a41e336d228bd658d19e1049bfba41",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -1,6 +1,6 @@\n use std::sync::{Arc, RwLock};\n \n-use anyhow::{bail, Result};\n+use anyhow::{bail, Context, Result};\n use lightningcss::{\n     css_modules::{CssModuleExport, CssModuleExports, Pattern, Segment},\n     stylesheet::{ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n@@ -191,6 +191,8 @@ pub async fn process_css_with_placeholder(\n                 _ => bail!(\"this case should be filtered out while parsing\"),\n             };\n \n+            // We use NoMinify because this is not a final css. We need to replace url references,\n+            // and we do final codegen with proper minification.\n             let (result, _) = stylesheet.to_css(&code, MinifyType::NoMinify, false, false)?;\n \n             let exports = result.exports.map(|exports| {\n@@ -435,6 +437,14 @@ async fn process_content(\n                     }\n                 }\n \n+                // minify() is actually transform, and it performs operations like CSS modules\n+                // handling.\n+                //\n+                //\n+                // See: https://github.com/parcel-bundler/lightningcss/issues/935#issuecomment-2739325537\n+                ss.minify(Default::default())\n+                    .context(\"failed to transform css\")?;\n+\n                 stylesheet_into_static(&ss, without_warnings(config.clone()))\n             }\n             Err(e) => {"
        },
        {
            "sha": "16fd0e94b17cf94de1567e9fb83265aef830e5e0",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/output/4e721_crates_turbopack-tests_tests_snapshot_css_embed-url_input_style_css_b7298ed4._.single.css",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_css_embed-url_input_style_css_b7298ed4._.single.css",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_css_embed-url_input_style_css_b7298ed4._.single.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_css_embed-url_input_style_css_b7298ed4._.single.css?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -1,3 +1,3 @@\n /* [project]/turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/input/style.css [test] (css) */\n-.style{cursor:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png)}\n+.style{cursor:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png)}\n /*# sourceMappingURL=4e721_crates_turbopack-tests_tests_snapshot_css_embed-url_input_style_css_b7298ed4._.single.css.map*/\n\\ No newline at end of file"
        },
        {
            "sha": "f9a614c68b46ee49764b29bb01a59590922cd605",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/output/b1abf_turbopack-tests_tests_snapshot_css_embed-url_input_style_module_css_b7298ed4._.single.css",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_css_embed-url_input_style_module_css_b7298ed4._.single.css",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_css_embed-url_input_style_module_css_b7298ed4._.single.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_css_embed-url_input_style_module_css_b7298ed4._.single.css?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -1,3 +1,3 @@\n /* [project]/turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/input/style.module.css [test] (css) */\n-.style-module__3oVw9q__module-style{cursor:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png)}\n+.style-module__3oVw9q__module-style{cursor:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png)}\n /*# sourceMappingURL=b1abf_turbopack-tests_tests_snapshot_css_embed-url_input_style_module_css_b7298ed4._.single.css.map*/\n\\ No newline at end of file"
        },
        {
            "sha": "8b7bc221c10cf683c932c62d2ec940bd28dab2ff",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/output/turbopack_crates_turbopack-tests_tests_snapshot_css_embed-url_input_14a7ded7._.css",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_css_embed-url_input_14a7ded7._.css",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_css_embed-url_input_14a7ded7._.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcss%2Fembed-url%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_css_embed-url_input_14a7ded7._.css?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -2,9 +2,9 @@\n /* embedded static asset \"/static/image.b151aca5.png\" */\n \n /* [project]/turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/input/style.module.css [test] (css) */\n-.style-module__3oVw9q__module-style{cursor:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png)}\n+.style-module__3oVw9q__module-style{cursor:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png)}\n \n /* [project]/turbopack/crates/turbopack-tests/tests/snapshot/css/embed-url/input/style.css [test] (css) */\n-.style{cursor:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png)}\n+.style{cursor:url(../static/image.b151aca5.png);background-image:url(../static/image.b151aca5.png);list-style-image:url(../static/image.b151aca5.png)}\n \n /*# sourceMappingURL=turbopack_crates_turbopack-tests_tests_snapshot_css_embed-url_input_14a7ded7._.css.map*/\n\\ No newline at end of file"
        },
        {
            "sha": "c8316bc6f31f06cb6c0e4c093afa9501d656c803",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/cssmodules/composes/output/b1abf_turbopack-tests_tests_snapshot_cssmodules_composes_input_index_module_22660277.css",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcssmodules%2Fcomposes%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_cssmodules_composes_input_index_module_22660277.css",
            "raw_url": "https://github.com/vercel/next.js/raw/d832662be2bde1eb1c6c3825aedfe5e05c05761f/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcssmodules%2Fcomposes%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_cssmodules_composes_input_index_module_22660277.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fcssmodules%2Fcomposes%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_cssmodules_composes_input_index_module_22660277.css?ref=d832662be2bde1eb1c6c3825aedfe5e05c05761f",
            "patch": "@@ -1,4 +1,4 @@\n /* [project]/turbopack/crates/turbopack-tests/tests/snapshot/cssmodules/composes/input/index.module.css [test] (css) */\n-.index-module__H6xp9G__className{background:red;color:#ff0}.index-module__H6xp9G__subClass{background:#00f;}\n+.index-module__H6xp9G__className{color:#ff0;background:red}.index-module__H6xp9G__subClass{background:#00f;}\n \n /*# sourceMappingURL=b1abf_turbopack-tests_tests_snapshot_cssmodules_composes_input_index_module_22660277.css.map*/\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 27,
        "deletions": 17
    }
}