{
    "author": "lukesandberg",
    "message": "[turbopack] Make it possible to synchronously access native bindings (#85787)\n\n## Enable synchronous access to native bindings\n\n## What?\nThis PR refactors the SWC bindings loading mechanism to support synchronous access to bindings after they've been loaded. It introduces new functions `installBindings()` and `getBindingsSync()` to properly manage the bindings lifecycle.\n\n`installBindings` is called early by tools that rely on them.\n\nThere were of course  a few complexities:\n\n* webpack loaders need to defensively install bindings to support being run by webpack\n* the hacky `loadNativeSync` method used by `transformSync` remains required due to the jest-transformer API (i didn't see a clear initialization location).\n* the `experimental.useWasmBinary` configuration is broken by design\n   * if the config is `next.config.ts` when we load SWC to transpile it, but that requires the native bindings, so we might load native bindings even when you ask for wasm.  I added a warning message for this case and the workaround is to use the node native transpilation support.\n   * this should probably be a command line flag if it is important\n* we need to lazily load the `swc/index.ts` module since it transitively loads `react` which reads `NODE_ENV` and various next entrypoints might modify that.\n\n## Why?\n\nThis makes it clearer that we are correctly applying the `useWasmBinary` option and can simplify some code paths that now don't need to be `async`.  This will be important in a future PR where i move some parts of issue formatting into rust/wasm.  Having those APIs be async will decrease their usability.",
    "sha": "13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
    "files": [
        {
            "sha": "8492f71e2eb54902c50a0b642196994542ac9c5c",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -903,5 +903,7 @@\n   \"902\": \"Invalid handler fields configured for \\\"cacheHandlers\\\":\\\\n%s\",\n   \"903\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\\\\nThis function is what Next.js runs for every request handled by this %s.\\\\n\\\\nWhy this happens:\\\\n%s- The file exists but doesn't export a function.\\\\n- The export is not a function (e.g., an object or constant).\\\\n- There's a syntax error preventing the export from being recognized.\\\\n\\\\nTo fix it:\\\\n- Ensure this file has either a default or \\\"%s\\\" function export.\\\\n\\\\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n   \"904\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\",\n-  \"905\": \"Page \\\"%s\\\" cannot use \\\\`export const unstable_prefetch = ...\\\\` without enabling \\\\`cacheComponents\\\\`.\"\n+  \"905\": \"Page \\\"%s\\\" cannot use \\\\`export const unstable_prefetch = ...\\\\` without enabling \\\\`cacheComponents\\\\`.\",\n+  \"906\": \"Bindings not loaded yet, but they are being loaded, did you forget to await?\",\n+  \"907\": \"bindings not loaded yet.  Either call `loadBindings` to wait for them to be available or ensure that `installBindings` has already been called.\"\n }"
        },
        {
            "sha": "f62a2b749c9cc0c5059f9cc517526220c86dfdad",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -17,6 +17,7 @@ import {\n } from './util'\n import * as Log from '../../output/log'\n import { isReactCompilerRequired } from '../../swc'\n+import { installBindings } from '../../swc/install-bindings'\n \n /**\n  * An internal (non-exported) type used by babel.\n@@ -570,6 +571,10 @@ export default async function getConfig(\n     inputSourceMap?: SourceMap | undefined\n   }\n ): Promise<ResolvedBabelConfig | null> {\n+  // Install bindings early so they are definitely available to the loader.\n+  // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+  // In turbopack loaders are run in a subprocess so it may or may not be done.\n+  await installBindings()\n   const cacheCharacteristics = await getCacheCharacteristics(\n     loaderOptions,\n     source,"
        },
        {
            "sha": "67f50fdc9e01fcc3be4028ed0796a52a6ed0d252",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -151,6 +151,7 @@ import type { NextError } from '../lib/is-error'\n import { isEdgeRuntime } from '../lib/is-edge-runtime'\n import { recursiveCopy } from '../lib/recursive-copy'\n import { lockfilePatchPromise, teardownTraceSubscriber } from './swc'\n+import { installBindings } from './swc/install-bindings'\n import { getNamedRouteRegex } from '../shared/lib/router/utils/route-regex'\n import { getFilesInDir } from '../lib/get-files-in-dir'\n import { eventSwcPlugins } from '../telemetry/events/swc-plugins'\n@@ -964,6 +965,8 @@ export default async function build(\n       // Reading the config can modify environment variables that influence the bundler selection.\n       bundler = finalizeBundlerFromConfig(bundler)\n       nextBuildSpan.setAttribute('bundler', getBundlerForTelemetry(bundler))\n+      // Install the native bindings early so we can have synchronous access later.\n+      await installBindings(config.experimental?.useWasmBinary)\n \n       process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n       NextBuildContext.config = config"
        },
        {
            "sha": "b8fe0b05f4e011c7790786ab4638b82e53204b9f",
            "filename": "packages/next/src/build/jest/jest.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -5,7 +5,8 @@ import { PHASE_TEST } from '../../shared/lib/constants'\n import loadJsConfig from '../load-jsconfig'\n import * as Log from '../output/log'\n import { findPagesDir } from '../../lib/find-pages-dir'\n-import { loadBindings, lockfilePatchPromise } from '../swc'\n+import { lockfilePatchPromise } from '../swc'\n+import { installBindings } from '../swc/install-bindings'\n import type { JestTransformerConfig } from '../swc/jest-transformer'\n import type { Config } from '@jest/types'\n \n@@ -96,7 +97,7 @@ export default function nextJest(options: { dir?: string } = {}) {\n           : customJestConfig) ?? {}\n \n       // eagerly load swc bindings instead of waiting for transform calls\n-      await loadBindings(nextConfig?.experimental?.useWasmBinary)\n+      await installBindings(nextConfig?.experimental?.useWasmBinary)\n \n       if (lockfilePatchPromise.cur) {\n         await lockfilePatchPromise.cur"
        },
        {
            "sha": "2ec8712b9fe57d5ac12070b6e53e06a30de48b91",
            "filename": "packages/next/src/build/load-entrypoint.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -1,6 +1,6 @@\n import fs from 'fs/promises'\n import path from 'path'\n-import { loadBindings } from './swc'\n+import { getBindingsSync } from './swc'\n \n // NOTE: this should be updated if this loader file is moved.\n const PACKAGE_ROOT = path.normalize(path.join(__dirname, '../..'))\n@@ -39,14 +39,12 @@ export async function loadEntrypoint(\n   injections?: Record<string, string>,\n   imports?: Record<string, string | null>\n ): Promise<string> {\n-  let bindings = await loadBindings()\n-\n   const templatePath = path.resolve(\n     path.join(TEMPLATES_ESM_FOLDER, `${entrypoint}.js`)\n   )\n   let content = await fs.readFile(templatePath)\n \n-  return bindings.expandNextJsTemplate(\n+  return getBindingsSync().expandNextJsTemplate(\n     content,\n     // Ensure that we use unix-style path separators for the import paths\n     path.join(TEMPLATE_SRC_FOLDER, `${entrypoint}.js`).replace(/\\\\/g, '/'),"
        },
        {
            "sha": "08f12ed992a8feab2c207e7d1220ffcb1e57e0d9",
            "filename": "packages/next/src/build/lockfile.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Flockfile.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -1,5 +1,6 @@\n import { bold, cyan } from '../lib/picocolors'\n import * as Log from './output/log'\n+import { getBindingsSync } from './swc'\n \n import type { Binding, Lockfile as NativeLockfile } from './swc/types'\n \n@@ -56,16 +57,11 @@ export class Lockfile {\n    * - If we fail to acquire the lock, we return `undefined`.\n    * - If we're on wasm, this always returns a dummy `Lockfile` object.\n    */\n-  static async tryAcquire(\n+  static tryAcquire(\n     path: string,\n     unlockOnExit: boolean = true\n-  ): Promise<Lockfile | undefined> {\n-    const { loadBindings } = require('./swc') as typeof import('./swc')\n-    // Ideally we could provide a sync version of `tryAcquire`, but\n-    // `loadBindings` is async. We're okay with skipping async-loaded wasm\n-    // bindings and the internal `loadNative` function is synchronous, but it\n-    // lacks some checks that `loadBindings` has.\n-    const bindings = await loadBindings()\n+  ): Lockfile | undefined {\n+    const bindings = getBindingsSync()\n     if (bindings.isWasm) {\n       Log.info(\n         `Skipping creating a lockfile at ${cyan(path)} because we're using WASM bindings`\n@@ -74,7 +70,7 @@ export class Lockfile {\n     } else {\n       let nativeLockfile\n       try {\n-        nativeLockfile = await bindings.lockfileTryAcquire(path)\n+        nativeLockfile = bindings.lockfileTryAcquireSync(path)\n       } catch (e) {\n         // this happens if there's an IO error (e.g. `ENOENT`), which is\n         // different than if we just didn't acquire the lock\n@@ -123,7 +119,7 @@ export class Lockfile {\n     const startMs = Date.now()\n     let lockfile\n     while (Date.now() - startMs < MAX_RETRY_MS) {\n-      lockfile = await Lockfile.tryAcquire(path, unlockOnExit)\n+      lockfile = Lockfile.tryAcquire(path, unlockOnExit)\n       if (lockfile !== undefined) break\n       await new Promise((resolve) => setTimeout(resolve, RETRY_DELAY_MS))\n     }"
        },
        {
            "sha": "bf6614d3a0de0d763f9b9de7e827984bbc8eed80",
            "filename": "packages/next/src/build/next-config-ts/transpile-config.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -177,8 +177,9 @@ async function handleCJS({\n     const nextConfigString = await readFile(nextConfigPath, 'utf8')\n     // lazy require swc since it loads React before even setting NODE_ENV\n     // resulting loading Development React on Production\n-    const { transform } = require('../swc') as typeof import('../swc')\n-    const { code } = await transform(nextConfigString, swcOptions)\n+    const { loadBindings } = require('../swc') as typeof import('../swc')\n+    const bindings = await loadBindings()\n+    const { code } = await bindings.transform(nextConfigString, swcOptions)\n \n     // register require hook only if require exists\n     if (code.includes('require(')) {\n@@ -187,7 +188,21 @@ async function handleCJS({\n     }\n \n     // filename & extension don't matter here\n-    return requireFromString(code, resolve(cwd, 'next.config.compiled.js'))\n+    const config = requireFromString(\n+      code,\n+      resolve(cwd, 'next.config.compiled.js')\n+    )\n+    // At this point we have already loaded the bindings without this configuration setting due to the `transform` call above.\n+    // Possibly we fell back to wasm in which case, it all works out but if not we need to warn\n+    // that the configuration was ignored.\n+    if (config?.experimental?.useWasmBinary && !bindings.isWasm) {\n+      warn(\n+        'Using a next.config.ts file is incompatible with `experimental.useWasmBinary` unless ' +\n+          '`--experimental-next-config-strip-types` is also passed.\\nSetting `useWasmBinary` to `false'\n+      )\n+      config.experimental.useWasmBinary = false\n+    }\n+    return config\n   } catch (error) {\n     throw error\n   } finally {"
        },
        {
            "sha": "f7ed97988e67c58bf6d664829ff67fa76eddcd48",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 54,
            "changes": 102,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -160,21 +160,33 @@ let lastNativeBindingsLoadErrorCode:\n   | 'unsupported_target'\n   | string\n   | undefined = undefined\n-// Used to cache calls to `loadBindings`\n-let pendingBindings: Promise<Binding>\n-// some things call `loadNative` directly instead of `loadBindings`... Cache calls to that\n-// separately.\n-let nativeBindings: Binding\n-// can allow hacky sync access to bindings for loadBindingsSync\n-let wasmBindings: Binding\n+// Used to cache racing calls to `loadBindings`\n+let pendingBindings: Promise<Binding> | undefined\n+// The cached loaded bindings\n+let loadedBindings: Binding | undefined = undefined\n let downloadWasmPromise: any\n let swcTraceFlushGuard: any\n let downloadNativeBindingsPromise: Promise<void> | undefined = undefined\n \n export const lockfilePatchPromise: { cur?: Promise<void> } = {}\n \n+/** Access the native bindings which should already have been loaded via `installBindings.  Throws if they are not available. */\n+export function getBindingsSync(): Binding {\n+  if (!loadedBindings) {\n+    if (pendingBindings) {\n+      throw new Error(\n+        'Bindings not loaded yet, but they are being loaded, did you forget to await?'\n+      )\n+    }\n+    throw new Error(\n+      'bindings not loaded yet.  Either call `loadBindings` to wait for them to be available or ensure that `installBindings` has already been called.'\n+    )\n+  }\n+  return loadedBindings\n+}\n+\n /**\n- * Attempts to load a native or wasm binding.\n+ * Loads the native or wasm binding.\n  *\n  * By default, this first tries to use a native binding, falling back to a wasm binding if that\n  * fails.\n@@ -184,6 +196,9 @@ export const lockfilePatchPromise: { cur?: Promise<void> } = {}\n export async function loadBindings(\n   useWasmBinary: boolean = false\n ): Promise<Binding> {\n+  if (loadedBindings) {\n+    return loadedBindings\n+  }\n   if (pendingBindings) {\n     return pendingBindings\n   }\n@@ -281,7 +296,9 @@ export async function loadBindings(\n \n     logLoadFailure(attempts, true)\n   })\n-  return pendingBindings\n+  loadedBindings = await pendingBindings\n+  pendingBindings = undefined\n+  return loadedBindings\n }\n \n async function tryLoadNativeWithFallback(attempts: Array<string>) {\n@@ -363,12 +380,6 @@ function loadBindingsSync() {\n     attempts = attempts.concat(a)\n   }\n \n-  // HACK: we can leverage the wasm bindings if they are already loaded\n-  // this may introduce race conditions\n-  if (wasmBindings) {\n-    return wasmBindings\n-  }\n-\n   logLoadFailure(attempts)\n   throw new Error('Failed to load bindings', { cause: attempts })\n }\n@@ -1182,7 +1193,7 @@ async function loadWasm(importPath = '') {\n \n   // Note wasm binary does not support async intefaces yet, all async\n   // interface coereces to sync interfaces.\n-  wasmBindings = {\n+  let wasmBindings = {\n     css: {\n       lightning: {\n         transform: function (_options: any) {\n@@ -1312,8 +1323,8 @@ async function loadWasm(importPath = '') {\n  * wasm fallback.\n  */\n function loadNative(importPath?: string) {\n-  if (nativeBindings) {\n-    return nativeBindings\n+  if (loadedBindings) {\n+    return loadedBindings\n   }\n \n   if (process.env.NEXT_TEST_WASM) {\n@@ -1379,7 +1390,7 @@ function loadNative(importPath?: string) {\n   }\n \n   if (bindings) {\n-    nativeBindings = {\n+    loadedBindings = {\n       isWasm: false,\n       transform(src: string, options: any) {\n         const isModule =\n@@ -1518,7 +1529,7 @@ function loadNative(importPath?: string) {\n         return bindings.lockfileUnlockSync(lockfile)\n       },\n     }\n-    return nativeBindings\n+    return loadedBindings\n   }\n \n   throw attempts\n@@ -1539,54 +1550,40 @@ function toBuffer(t: any) {\n   return Buffer.from(JSON.stringify(t))\n }\n \n-export async function isWasm(): Promise<boolean> {\n-  let bindings = await loadBindings()\n-  return bindings.isWasm\n-}\n-\n export async function transform(src: string, options?: any): Promise<any> {\n-  let bindings = await loadBindings()\n+  let bindings = getBindingsSync()\n   return bindings.transform(src, options)\n }\n \n+/** Synchronously transforms the source and loads the native bindings. */\n export function transformSync(src: string, options?: any): any {\n-  let bindings = loadBindingsSync()\n+  const bindings = loadBindingsSync()\n   return bindings.transformSync(src, options)\n }\n \n-export async function minify(\n+export function minify(\n   src: string,\n   options: any\n ): Promise<{ code: string; map: any }> {\n-  let bindings = await loadBindings()\n+  const bindings = getBindingsSync()\n   return bindings.minify(src, options)\n }\n \n-export async function isReactCompilerRequired(\n-  filename: string\n-): Promise<boolean> {\n-  let bindings = await loadBindings()\n+export function isReactCompilerRequired(filename: string): Promise<boolean> {\n+  const bindings = getBindingsSync()\n   return bindings.reactCompiler.isReactCompilerRequired(filename)\n }\n \n export async function parse(src: string, options: any): Promise<any> {\n-  let bindings = await loadBindings()\n-  let parserOptions = getParserOptions(options)\n-  return bindings\n-    .parse(src, parserOptions)\n-    .then((astStr: any) => JSON.parse(astStr))\n+  const bindings = getBindingsSync()\n+  const parserOptions = getParserOptions(options)\n+  const parsed = await bindings.parse(src, parserOptions)\n+  return JSON.parse(parsed)\n }\n \n export function getBinaryMetadata() {\n-  let bindings\n-  try {\n-    bindings = loadNative()\n-  } catch (e) {\n-    // Suppress exceptions, this fn allows to fail to load native bindings\n-  }\n-\n   return {\n-    target: bindings?.getTargetTriple?.(),\n+    target: loadedBindings?.getTargetTriple?.(),\n   }\n }\n \n@@ -1597,8 +1594,8 @@ export function getBinaryMetadata() {\n export function initCustomTraceSubscriber(traceFileName?: string) {\n   if (!swcTraceFlushGuard) {\n     // Wasm binary doesn't support trace emission\n-    let bindings = loadNative()\n-    swcTraceFlushGuard = bindings.initCustomTraceSubscriber?.(traceFileName)\n+    swcTraceFlushGuard =\n+      getBindingsSync().initCustomTraceSubscriber?.(traceFileName)\n   }\n }\n \n@@ -1625,9 +1622,8 @@ function once(fn: () => void): () => void {\n  */\n export const teardownTraceSubscriber = once(() => {\n   try {\n-    let bindings = loadNative()\n     if (swcTraceFlushGuard) {\n-      bindings.teardownTraceSubscriber?.(swcTraceFlushGuard)\n+      getBindingsSync().teardownTraceSubscriber?.(swcTraceFlushGuard)\n     }\n   } catch (e) {\n     // Suppress exceptions, this fn allows to fail to load native bindings\n@@ -1637,14 +1633,12 @@ export const teardownTraceSubscriber = once(() => {\n export async function getModuleNamedExports(\n   resourcePath: string\n ): Promise<string[]> {\n-  const bindings = await loadBindings()\n-  return bindings.rspack.getModuleNamedExports(resourcePath)\n+  return getBindingsSync().rspack.getModuleNamedExports(resourcePath)\n }\n \n export async function warnForEdgeRuntime(\n   source: string,\n   isProduction: boolean\n ): Promise<NapiSourceDiagnostic[]> {\n-  const bindings = await loadBindings()\n-  return bindings.rspack.warnForEdgeRuntime(source, isProduction)\n+  return getBindingsSync().rspack.warnForEdgeRuntime(source, isProduction)\n }"
        },
        {
            "sha": "db66fe8c0adf8c74991f8cc2421e07aeb99c1086",
            "filename": "packages/next/src/build/swc/install-bindings.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Finstall-bindings.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Finstall-bindings.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Finstall-bindings.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -0,0 +1,23 @@\n+/**\n+ * This module provides a way to install SWC bindings without eagerly loading the entire swc/index module.\n+ *\n+ * The swc/index module can transitively load other modules (like webpack-config) that import React,\n+ * and React's entry point checks process.env.NODE_ENV at require time to decide whether to load\n+ * the development or production bundle. By deferring the require of swc/index until this function\n+ * is called, we ensure NODE_ENV is set before React is loaded.\n+ */\n+\n+/**\n+ * Loads and caches the native bindings. This is idempotent and should be called early so bindings\n+ * can be accessed synchronously later.\n+ *\n+ * @param useWasmBinary - Whether to use WASM bindings instead of native bindings\n+ */\n+export async function installBindings(\n+  useWasmBinary: boolean = false\n+): Promise<void> {\n+  // Lazy require to avoid loading swc/index (and transitively webpack-config/React)\n+  // before NODE_ENV is set\n+  const { loadBindings } = require('./index') as typeof import('./index')\n+  await loadBindings(useWasmBinary)\n+}"
        },
        {
            "sha": "029999ff52be23d08360dc0f5970dd9550ab28cc",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -2,7 +2,8 @@ import path from 'path'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n import { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\n import { NextBuildContext } from '../build-context'\n-import { createDefineEnv, loadBindings } from '../swc'\n+import { createDefineEnv, getBindingsSync } from '../swc'\n+import { installBindings } from '../swc/install-bindings'\n import {\n   handleRouteType,\n   rawEntrypointsToEntrypoints,\n@@ -42,7 +43,7 @@ export async function turbopackBuild(): Promise<{\n   const currentNodeJsVersion = process.versions.node\n \n   const startTime = process.hrtime()\n-  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n+  const bindings = getBindingsSync() // our caller should have already loaded these\n   const dev = false\n \n   const supportedBrowsers = getSupportedBrowsers(dir, dev)\n@@ -221,15 +222,14 @@ export async function workerMain(workerData: {\n   Object.assign(NextBuildContext, workerData.buildContext)\n \n   /// load the config because it's not serializable\n-  NextBuildContext.config = await loadConfig(\n+  const config = (NextBuildContext.config = await loadConfig(\n     PHASE_PRODUCTION_BUILD,\n     NextBuildContext.dir!,\n     {\n       debugPrerender: NextBuildContext.debugPrerender,\n       reactProductionProfiling: NextBuildContext.reactProductionProfiling,\n     }\n-  )\n-\n+  ))\n   // Matches handling in build/index.ts\n   // https://github.com/vercel/next.js/blob/84f347fc86f4efc4ec9f13615c215e4b9fb6f8f0/packages/next/src/build/index.ts#L815-L818\n   // Ensures the `config.distDir` option is matched.\n@@ -242,6 +242,8 @@ export async function workerMain(workerData: {\n     distDir: NextBuildContext.config.distDir,\n   })\n   setGlobal('telemetry', telemetry)\n+  // Install bindings early so we can access synchronously later\n+  await installBindings(config.experimental?.useWasmBinary)\n \n   const {\n     shutdownPromise: resultShutdownPromise,"
        },
        {
            "sha": "17c32066f394e6f680034cb13ff028f9ea30a0d6",
            "filename": "packages/next/src/build/webpack-build/impl.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -41,6 +41,7 @@ import type { UnwrapPromise } from '../../lib/coalesced-function'\n import origDebug from 'next/dist/compiled/debug'\n import { Telemetry } from '../../telemetry/storage'\n import { durationToString, hrtimeToSeconds } from '../duration-to-string'\n+import { installBindings } from '../swc/install-bindings'\n \n const debug = origDebug('next:build:webpack-build')\n \n@@ -383,14 +384,15 @@ export async function workerMain(workerData: {\n   resumePluginState(NextBuildContext.pluginState)\n \n   /// load the config because it's not serializable\n-  NextBuildContext.config = await loadConfig(\n+  const config = (NextBuildContext.config = await loadConfig(\n     PHASE_PRODUCTION_BUILD,\n     NextBuildContext.dir!,\n     {\n       debugPrerender: NextBuildContext.debugPrerender,\n       reactProductionProfiling: NextBuildContext.reactProductionProfiling,\n     }\n-  )\n+  ))\n+  await installBindings(config.experimental?.useWasmBinary)\n   NextBuildContext.nextBuildSpan = trace(\n     `worker-main-${workerData.compilerName}`\n   )"
        },
        {
            "sha": "9c6e5b3270f68bdad067b06e2457d7380e848c22",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -61,7 +61,6 @@ import loadJsConfig, {\n   type JsConfig,\n   type ResolvedBaseUrl,\n } from './load-jsconfig'\n-import { loadBindings } from './swc'\n import { SubresourceIntegrityPlugin } from './webpack/plugins/subresource-integrity-plugin'\n import { NextFontManifestPlugin } from './webpack/plugins/next-font-manifest-plugin'\n import { getSupportedBrowsers } from './utils'\n@@ -422,11 +421,6 @@ export default async function getBaseWebpackConfig(\n     loggedSwcDisabled = true\n   }\n \n-  // eagerly load swc bindings instead of waiting for transform calls\n-  if (!babelConfigFile && isClient) {\n-    await loadBindings(config.experimental.useWasmBinary)\n-  }\n-\n   // since `pages` doesn't always bundle by default we need to\n   // auto-include optimizePackageImports in transpilePackages\n   const finalTranspilePackages: string[] = ("
        },
        {
            "sha": "f8d4508a561dcfc36cd78c2c6e9264ba33b92004",
            "filename": "packages/next/src/build/webpack/loaders/lightningcss-loader/src/loader.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Floader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Floader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Floader.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -19,6 +19,8 @@ import {\n } from '../../css-loader/src/utils'\n import { stringifyRequest } from '../../../stringify-request'\n import { ECacheKey } from './interface'\n+import { getBindingsSync } from '../../../../../build/swc'\n+import { installBindings } from '../../../../../build/swc/install-bindings'\n \n const encoder = new TextEncoder()\n \n@@ -266,6 +268,10 @@ export async function LightningCssLoader(\n ): Promise<void> {\n   const done = this.async()\n   const options = this.getOptions()\n+  // Install bindings early so they are definitely available to the loader.\n+  // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+  // In turbopack loaders are run in a subprocess so it may or may not be done.\n+  await installBindings()\n   const { implementation, targets: userTargets, ...opts } = options\n \n   options.modules ??= {}\n@@ -305,12 +311,8 @@ export async function LightningCssLoader(\n       ),\n     })\n   }\n-  const { loadBindings } =\n-    require('../../../../../build/swc') as typeof import('../../../../../build/swc')\n-\n   const transform =\n-    implementation?.transformCss ??\n-    (await loadBindings()).css.lightning.transform\n+    implementation?.transformCss ?? getBindingsSync().css.lightning.transform\n \n   const replacedUrls = new Map<number, string>()\n   const icssReplacedUrls = new Map<number, string>()"
        },
        {
            "sha": "59843ba7183de00521cceff47e1618fafffb0dff",
            "filename": "packages/next/src/build/webpack/loaders/lightningcss-loader/src/minify.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Fminify.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Fminify.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Flightningcss-loader%2Fsrc%2Fminify.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -7,6 +7,7 @@ import { ECacheKey } from './interface'\n import type { Compilation, Compiler } from 'webpack'\n import { getTargets } from './utils'\n import { Buffer } from 'buffer'\n+import { getBindingsSync } from '../../../../../build/swc'\n \n const PLUGIN_NAME = 'lightning-css-minify'\n const CSS_FILE_REG = /\\.css(?:\\?.*)?$/i\n@@ -66,9 +67,7 @@ export class LightningCssMinifyPlugin {\n     } = compilation.compiler\n \n     if (!this.transform) {\n-      const { loadBindings } =\n-        require('../../../../../build/swc') as typeof import('../../../../../build/swc')\n-      this.transform = (await loadBindings()).css.lightning.transform\n+      this.transform = getBindingsSync().css.lightning.transform\n     }\n \n     const sourcemap ="
        },
        {
            "sha": "7f71a94d7b89d97d67071a6f9a9969c4d54cbc47",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -38,7 +38,9 @@ import { PARALLEL_ROUTE_DEFAULT_PATH } from '../../../../client/components/built\n import type { Compilation } from 'webpack'\n import { createAppRouteCode } from './create-app-route-code'\n import { MissingDefaultParallelRouteError } from '../../../../shared/lib/errors/missing-default-parallel-route-error'\n+\n import { normalizePathSep } from '../../../../shared/lib/page-path/normalize-path-sep'\n+import { installBindings } from '../../../swc/install-bindings'\n \n export type AppLoaderOptions = {\n   name: string\n@@ -636,6 +638,11 @@ const filesInDirMapMap: WeakMap<\n   Map<string, Promise<Set<string>>>\n > = new WeakMap()\n const nextAppLoader: AppLoader = async function nextAppLoader() {\n+  // install native bindings early so they are always available.\n+  // When run by webpack, next will have already done this, so this will be fast,\n+  // but if run by turbopack in a subprocess it is required.  In that case we cannot pass the\n+  // `useWasmBinary` flag, but that is ok since turbopack doesn't currently support wasm.\n+  await installBindings()\n   const loaderOptions = this.getOptions()\n   const {\n     name,"
        },
        {
            "sha": "a41db208283759b86b885f1da01e8c6fac388f9c",
            "filename": "packages/next/src/build/webpack/loaders/next-barrel-loader.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-barrel-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-barrel-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-barrel-loader.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -88,6 +88,7 @@ import type webpack from 'webpack'\n \n import path from 'path'\n import { transform } from '../../swc'\n+import { installBindings } from '../../swc/install-bindings'\n \n // This is a in-memory cache for the mapping of barrel exports. This only applies\n // to the packages that we optimize. It will never change (e.g. upgrading packages)\n@@ -251,6 +252,10 @@ const NextBarrelLoader = async function (\n ) {\n   this.async()\n   this.cacheable(true)\n+  // Install bindings early so they are definitely available.\n+  // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+  // In turbopack loaders are run in a subprocess so it may or may not be done.\n+  await installBindings()\n \n   const { names, swcCacheDir } = this.getOptions()\n "
        },
        {
            "sha": "93c03f2c07f21d0b3c51a823c7936fdf824f2368",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-image-loader.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -16,6 +16,7 @@ import { WEBPACK_RESOURCE_QUERIES } from '../../../lib/constants'\n import { normalizePathSep } from '../../../shared/lib/page-path/normalize-path-sep'\n import type { PageExtensions } from '../../page-extensions-type'\n import { getLoaderModuleNamedExports } from './utils'\n+import { installBindings } from '../../swc/install-bindings'\n \n interface Options {\n   segment: string\n@@ -30,6 +31,10 @@ async function nextMetadataImageLoader(\n   this: webpack.LoaderContext<Options>,\n   content: Buffer\n ) {\n+  // Install bindings early so they are definitely available to the loader.\n+  // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+  // In turbopack loaders are run in a subprocess so it may or may not be done.\n+  await installBindings()\n   const options: Options = this.getOptions()\n   const { type, segment, pageExtensions, basePath } = options\n   const { resourcePath, rootContext: context } = this"
        },
        {
            "sha": "0266d5e6138f7229c0307ed0157ff19542baffda",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-route-loader.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -3,6 +3,7 @@ import fs from 'fs'\n import path from 'path'\n import { imageExtMimeTypeMap } from '../../../lib/mime-type'\n import { getLoaderModuleNamedExports } from './utils'\n+import { installBindings } from '../../swc/install-bindings'\n \n function errorOnBadHandler(resourcePath: string) {\n   return `\n@@ -373,6 +374,10 @@ async function getSitemapRouteCode(\n // TODO-METADATA: improve the cache control strategy\n const nextMetadataRouterLoader: webpack.LoaderDefinitionFunction<MetadataRouteLoaderOptions> =\n   async function () {\n+    // Install bindings early so they are definitely available to the loader.\n+    // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+    // In turbopack loaders are run in a subprocess so it may or may not be done.\n+    await installBindings()\n     const { isDynamicRouteExtension, filePath } = this.getOptions()\n     const { name: fileBaseName } = getFilenameAndExtension(filePath)\n     this.addDependency(filePath)"
        },
        {
            "sha": "2ee2f51ed674831226c988be764877dfc75df201",
            "filename": "packages/next/src/build/webpack/loaders/next-swc-loader.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -28,7 +28,8 @@ DEALINGS IN THE SOFTWARE.\n \n import type { NextConfig } from '../../../types'\n import { type WebpackLayerName, WEBPACK_LAYERS } from '../../../lib/constants'\n-import { isWasm, transform } from '../../swc'\n+import { getBindingsSync, transform } from '../../swc'\n+import { installBindings } from '../../swc/install-bindings'\n import { getLoaderSWCOptions } from '../../swc/options'\n import path, { isAbsolute } from 'path'\n import { babelIncludeRegexes } from '../../webpack-config'\n@@ -251,7 +252,7 @@ export function pitch(this: any) {\n       !EXCLUDED_PATHS.test(this.resourcePath) &&\n       this.loaders.length - 1 === this.loaderIndex &&\n       isAbsolute(this.resourcePath) &&\n-      !(await isWasm())\n+      !getBindingsSync().isWasm\n     ) {\n       this.addDependency(this.resourcePath)\n       return loaderTransform.call(this)\n@@ -268,13 +269,18 @@ export default function swcLoader(\n   inputSourceMap: any\n ) {\n   const callback = this.async()\n-  loaderTransform.call(this, inputSource, inputSourceMap).then(\n-    ([transformedSource, outputSourceMap]: any) => {\n-      callback(null, transformedSource, outputSourceMap || inputSourceMap)\n-    },\n-    (err: Error) => {\n-      callback(err)\n-    }\n+  // Install bindings early so they are definitely available to the loader.\n+  // When run by webpack in next this is already done with correct configuration so this is a no-op.\n+  // In turbopack loaders are run in a subprocess so it may or may not be done.\n+  installBindings().then(() =>\n+    loaderTransform.call(this, inputSource, inputSourceMap).then(\n+      ([transformedSource, outputSourceMap]: any) => {\n+        callback(null, transformedSource, outputSourceMap || inputSourceMap)\n+      },\n+      (err: Error) => {\n+        callback(err)\n+      }\n+    )\n   )\n }\n "
        },
        {
            "sha": "632c6a185ed620a124c223a64826b2ce8bf6f976",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -32,6 +32,7 @@ import {\n } from '../server/lib/router-utils/route-types-utils'\n import { writeCacheLifeTypes } from '../server/lib/router-utils/cache-life-type-utils'\n import { createValidFileMatcher } from '../server/lib/find-page-file'\n+import { installBindings } from '../build/swc/install-bindings'\n \n export type NextTypegenOptions = {\n   dir?: string\n@@ -49,6 +50,7 @@ const nextTypegen = async (\n   }\n \n   const nextConfig = await loadConfig(PHASE_PRODUCTION_BUILD, baseDir)\n+  await installBindings(nextConfig.experimental?.useWasmBinary)\n   const distDir = join(baseDir, nextConfig.distDir)\n   const { pagesDir, appDir } = findPagesDir(baseDir)\n "
        },
        {
            "sha": "f624736c7cb42f65cf1da1403ebcccc57d14ad75",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -1671,7 +1671,9 @@ export default async function loadConfig(\n     if (userConfig.experimental?.useLightningcss) {\n       const { loadBindings } =\n         require('../build/swc') as typeof import('../build/swc')\n-      const isLightningSupported = (await loadBindings())?.css?.lightning\n+      const isLightningSupported = (\n+        await loadBindings(userConfig.experimental?.useWasmBinary)\n+      )?.css?.lightning\n \n       if (!isLightningSupported) {\n         curLog.warn("
        },
        {
            "sha": "160d5e1ec759b4acdddd73de2575da64b9fe1e49",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -24,7 +24,7 @@ import type {\n   Project,\n   Entrypoints,\n } from '../../build/swc/types'\n-import { createDefineEnv } from '../../build/swc'\n+import { createDefineEnv, getBindingsSync } from '../../build/swc'\n import * as Log from '../../build/output/log'\n import { BLOCKED_PAGES } from '../../shared/lib/constants'\n import {\n@@ -193,10 +193,7 @@ export async function createHotReloaderTurbopack(\n   const buildId = 'development'\n   const { nextConfig, dir: projectPath } = opts\n \n-  const { loadBindings } =\n-    require('../../build/swc') as typeof import('../../build/swc')\n-\n-  let bindings = await loadBindings()\n+  const bindings = getBindingsSync()\n \n   // For the debugging purpose, check if createNext or equivalent next instance setup in test cases\n   // works correctly. Normally `run-test` hides output so only will be visible when `--debug` flag is used."
        },
        {
            "sha": "af3a3a9edcd6389ec9e2cab752b64060bbc603f4",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -8,6 +8,7 @@ import type { PropagateToWorkersField } from './types'\n import type { NextJsHotReloaderInterface } from '../../dev/hot-reloader-types'\n \n import { createDefineEnv } from '../../../build/swc'\n+import { installBindings } from '../../../build/swc/install-bindings'\n import fs from 'fs'\n import url from 'url'\n import path from 'path'\n@@ -1280,7 +1281,7 @@ export async function setupDevBundler(opts: SetupOpts) {\n   const isSrcDir = path\n     .relative(opts.dir, opts.pagesDir || opts.appDir || '')\n     .startsWith('src')\n-\n+  await installBindings(opts.nextConfig.experimental?.useWasmBinary)\n   const result = await startWatcher({\n     ...opts,\n     isSrcDir,"
        },
        {
            "sha": "527f4067672279cc7b2bb00f2512954d2e9acbd1",
            "filename": "test/unit/next-swc.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/test%2Funit%2Fnext-swc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/test%2Funit%2Fnext-swc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-swc.test.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -1,5 +1,6 @@\n /* eslint-env jest */\n import { transform } from 'next/dist/build/swc'\n+import { installBindings } from 'next/dist/build/swc/install-bindings'\n import path from 'path'\n import fsp from 'fs/promises'\n \n@@ -11,6 +12,9 @@ const swc = async (code) => {\n const trim = (s) => s.join('\\n').trim().replace(/^\\s+/gm, '')\n \n describe('next/swc', () => {\n+  beforeAll(async () => {\n+    await installBindings()\n+  })\n   describe('hook_optimizer', () => {\n     it('should leave alone array destructuring of hooks', async () => {\n       const output = await swc("
        },
        {
            "sha": "73f2f95c659378f1ebe9e0cfa5681f8b07274a78",
            "filename": "test/unit/parse-page-static-info.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/test%2Funit%2Fparse-page-static-info.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce/test%2Funit%2Fparse-page-static-info.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fparse-page-static-info.test.ts?ref=13bf3d97bb3013a49b32f7a1f5c4ebe893b289ce",
            "patch": "@@ -1,4 +1,5 @@\n import { getPagesPageStaticInfo } from 'next/dist/build/analysis/get-page-static-info'\n+import { installBindings } from 'next/dist/build/swc/install-bindings'\n import { PAGE_TYPES } from 'next/dist/lib/page-types'\n import { join } from 'path'\n \n@@ -9,6 +10,9 @@ function createNextConfig() {\n }\n \n describe('parse page static info', () => {\n+  beforeAll(async () => {\n+    await installBindings()\n+  })\n   it('should parse nodejs runtime correctly', async () => {\n     const { runtime, getServerSideProps, getStaticProps } =\n       await getPagesPageStaticInfo({"
        }
    ],
    "stats": {
        "total": 296,
        "additions": 185,
        "deletions": 111
    }
}