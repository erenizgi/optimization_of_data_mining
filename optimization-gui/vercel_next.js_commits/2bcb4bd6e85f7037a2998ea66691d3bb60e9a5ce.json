{
    "author": "unstubbable",
    "message": "Unflake `missing required html tags` test (#83328)\n\n[Flakiness metric](https://app.datadoghq.com/ci/test/runs?query=test_level%3Atest%20env%3Aci%20%40git.repository.id%3Agithub.com%2Fvercel%2Fnext.js%20%40test.service%3Anextjs%20%40test.status%3Afail%20%40test.name%3A%22app-dir%20-%20missing%20required%20html%20tags%20should%20hmr%20when%20you%20fix%20the%20error%22%20%40git.branch%3Acanary&agg_m=count&agg_m_source=base&agg_t=count&citest_explorer_sort=timestamp%2Cdesc&cols=%40test.status%2Ctimestamp%2C%40test.suite%2C%40test.name%2C%40duration%2C%40test.service%2C%40git.branch&currentTab=overview&eventStack=&fromUser=false&index=citest&start=1755509670941&end=1756805670941&paused=false)\r\n\r\nThe test fixture already starts out with a missing tags error. This was not accounted for in the test, and could lead to the initial redbox being detected, instead of the one that appears after the layout was changed and the page was reloaded.",
    "sha": "2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce",
    "files": [
        {
            "sha": "05b83965371e651949f735cabec2db15b03d3b49",
            "filename": "test/development/app-dir/missing-required-html-tags/index.test.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 13,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Fdevelopment%2Fapp-dir%2Fmissing-required-html-tags%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Fdevelopment%2Fapp-dir%2Fmissing-required-html-tags%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fmissing-required-html-tags%2Findex.test.ts?ref=2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce",
            "patch": "@@ -35,18 +35,22 @@ describe('app-dir - missing required html tags', () => {\n     `)\n   })\n \n-  it('should hmr when you fix the error', async () => {\n-    const browser = await next.browser('/')\n-\n-    await next.patchFile('app/layout.js', (code) =>\n-      code.replace('return children', 'return <body>{children}</body>')\n-    )\n+  it('should reload when you fix the error', async () => {\n+    let reloaded = false\n \n-    await assertHasRedbox(browser)\n+    const browser = await next.browser('/', {\n+      beforePageLoad(page) {\n+        page.on('requestfinished', async (request) => {\n+          if (new URL(request.url()).pathname === '/') {\n+            reloaded = true\n+          }\n+        })\n+      },\n+    })\n \n     await expect(browser).toDisplayRedbox(`\n      {\n-       \"description\": \"Missing <html> tags in the root layout.\n+       \"description\": \"Missing <html> and <body> tags in the root layout.\n      Read more at https://nextjs.org/docs/messages/missing-root-layout-tags\",\n        \"environmentLabel\": null,\n        \"label\": \"Runtime Error\",\n@@ -55,13 +59,40 @@ describe('app-dir - missing required html tags', () => {\n      }\n     `)\n \n-    await next.patchFile('app/layout.js', (code) =>\n-      code.replace(\n-        'return <body>{children}</body>',\n-        'return <html><body>{children}</body></html>'\n-      )\n+    reloaded = false\n+\n+    await Promise.all([\n+      next.patchFile('app/layout.js', (code) =>\n+        code.replace('return children', 'return <body>{children}</body>')\n+      ),\n+      retry(() => expect(reloaded).toBe(true), 10_000),\n+    ])\n+\n+    await retry(() =>\n+      expect(browser).toDisplayRedbox(`\n+     {\n+       \"description\": \"Missing <html> tags in the root layout.\n+     Read more at https://nextjs.org/docs/messages/missing-root-layout-tags\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": null,\n+       \"stack\": [],\n+     }\n+    `)\n     )\n \n+    reloaded = false\n+\n+    await Promise.all([\n+      next.patchFile('app/layout.js', (code) =>\n+        code.replace(\n+          'return <body>{children}</body>',\n+          'return <html><body>{children}</body></html>'\n+        )\n+      ),\n+      retry(() => expect(reloaded).toBe(true), 10_000),\n+    ])\n+\n     await assertNoRedbox(browser)\n     expect(await browser.elementByCss('p').text()).toBe('hello world')\n "
        },
        {
            "sha": "594719fd1ec21d7164dbdfa119b30b9d9c59db3a",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce",
            "patch": "@@ -829,7 +829,7 @@\n   \"test/development/app-dir/missing-required-html-tags/index.test.ts\": {\n     \"passed\": [\n       \"app-dir - missing required html tags should display correct error count in dev indicator\",\n-      \"app-dir - missing required html tags should hmr when you fix the error\",\n+      \"app-dir - missing required html tags should reload when you fix the error\",\n       \"app-dir - missing required html tags should show error overlay\"\n     ],\n     \"failed\": [],"
        },
        {
            "sha": "f97e93e183f2d160edcb77756278e9f1067e2c67",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=2bcb4bd6e85f7037a2998ea66691d3bb60e9a5ce",
            "patch": "@@ -2625,7 +2625,7 @@\n   \"test/development/app-dir/missing-required-html-tags/index.test.ts\": {\n     \"passed\": [\n       \"app-dir - missing required html tags should display correct error count in dev indicator\",\n-      \"app-dir - missing required html tags should hmr when you fix the error\",\n+      \"app-dir - missing required html tags should reload when you fix the error\",\n       \"app-dir - missing required html tags should show error overlay\"\n     ],\n     \"failed\": [],"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 46,
        "deletions": 15
    }
}