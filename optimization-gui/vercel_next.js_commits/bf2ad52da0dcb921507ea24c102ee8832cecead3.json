{
    "author": "lukesandberg",
    "message": "Batch ipc info messages to improve performance. (#78522)\n\nBatch the dependency messages sent from our nodejs worker process.\n\nSome large projects using tailwind may report thousands of dependencies which can cause the node process to hang due to memory pressure.  We are addressing the memory pressure issue independently in #78462, but by reducing the number of small packets we can also improve performance.",
    "sha": "bf2ad52da0dcb921507ea24c102ee8832cecead3",
    "files": [
        {
            "sha": "498509492cdcd5aff385623a33e01f6de179e87c",
            "filename": "turbopack/crates/turbopack-node/js/src/ipc/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts?ref=bf2ad52da0dcb921507ea24c102ee8832cecead3",
            "patch": "@@ -95,6 +95,8 @@ function createIpc<TIncoming, TOutgoing>(\n     process.exit(0);\n   });\n \n+  // TODO(lukesandberg): some of the messages being sent are very large and contain lots\n+  //  of redundant information.  Consider adding gzip compression to our stream.\n   function send(message: any): Promise<void> {\n     // Reserve 4 bytes for our length prefix, we will over-write after encoding.\n     const packet = Buffer.from(\"0000\" + JSON.stringify(message), \"utf8\");"
        },
        {
            "sha": "6c6f6581413c887c2834c87d85a5f4de805a7ad0",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/postcss.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 18,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fpostcss.ts?ref=bf2ad52da0dcb921507ea24c102ee8832cecead3",
            "patch": "@@ -87,6 +87,10 @@ export default async function transform(\n   });\n \n   const assets = [];\n+  const filePaths: string[] =[];\n+  const buildFilePaths: string[] = [];\n+  const directories: Array<[string, string]> = [];\n+\n   for (const msg of messages) {\n     switch (msg.type) {\n       case \"asset\":\n@@ -104,36 +108,28 @@ export default async function transform(\n         break;\n       case \"dependency\":\n       case \"missing-dependency\":\n-        ipc.sendInfo({\n-          type: \"fileDependency\",\n-          path: toPath(msg.file),\n-        });\n+        filePaths.push(toPath(msg.file));\n         break;\n       case \"build-dependency\":\n-        ipc.sendInfo({\n-          type: \"buildDependency\",\n-          path: toPath(msg.file),\n-        });\n+        buildFilePaths.push(toPath(msg.file));\n         break;\n       case \"dir-dependency\":\n-        ipc.sendInfo({\n-          type: \"dirDependency\",\n-          path: toPath(msg.dir),\n-          glob: msg.glob,\n-        });\n+        directories.push([toPath(msg.dir), msg.glob]);\n         break;\n       case \"context-dependency\":\n-        ipc.sendInfo({\n-          type: \"dirDependency\",\n-          path: toPath(msg.file),\n-          glob: \"**\",\n-        });\n+        directories.push([toPath(msg.dir), \"**\"]);\n         break;\n       default:\n         // TODO: do we need to do anything here?\n         break;\n     }\n   }\n+  ipc.sendInfo({\n+    type: \"dependencies\",\n+    filePaths,\n+    directories,\n+    buildFilePaths,\n+  });\n   return {\n     css,\n     map: sourceMap ? JSON.stringify(map) : undefined,"
        },
        {
            "sha": "b2d540f900956984cefda50b85880c6bd69ddf07",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/webpack-loaders.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 46,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts?ref=bf2ad52da0dcb921507ea24c102ee8832cecead3",
            "patch": "@@ -19,27 +19,17 @@ import { type StructuredError } from \"src/ipc\";\n \n export type IpcInfoMessage =\n   | {\n-    type: \"fileDependency\";\n-    path: string;\n-  }\n-  | {\n-    type: \"buildDependency\";\n-    path: string;\n-  }\n-  | {\n-    type: \"dirDependency\";\n-    path: string;\n-    glob: string;\n-  }\n-  | {\n-    type: \"envDependency\";\n-    name: string;\n-  }\n+      type: 'dependencies'\n+      envVariables?: string[]\n+      directories?: Array<[string, string]>\n+      filePaths?: string[],\n+      buildFilePaths?: string[],\n+    }\n   | {\n     type: \"emittedError\";\n     severity: \"warning\" | \"error\";\n     error: StructuredError;\n-  }\n+    }\n   | {\n     type: \"log\";\n     time: number;\n@@ -364,7 +354,8 @@ const transform = (\n                   // TODO: do we need to handle this?\n                   break\n               }\n-\n+              // TODO(lukesandberg): should we batch these and flush lazily?\n+              // turbopack just collects these and reports them when finishing the task.\n               ipc.sendInfo({\n                 type: \"log\",\n                 time: Date.now(),\n@@ -469,25 +460,15 @@ const transform = (\n         },\n       },\n       (err, result) => {\n-        for (const envVar of readEnvVars) {\n-          ipc.sendInfo({\n-            type: \"envDependency\",\n-            name: envVar,\n-          });\n-        }\n-        for (const dep of result.contextDependencies) {\n-          ipc.sendInfo({\n-            type: \"dirDependency\",\n-            path: toPath(dep),\n-            glob: \"**\",\n-          });\n-        }\n-        for (const dep of result.fileDependencies) {\n-          ipc.sendInfo({\n-            type: \"fileDependency\",\n-            path: toPath(dep),\n-          });\n-        }\n+        ipc.sendInfo({\n+          type: 'dependencies',\n+          envVariables: Array.from(readEnvVars),\n+          filePaths: result.fileDependencies.map(toPath),\n+          directories: result.contextDependencies.map((dep) => [\n+            toPath(dep),\n+            '**',\n+          ]),\n+        });\n         if (err) return reject(err);\n         if (!result.result) return reject(new Error(\"No result from loaders\"));\n         const [source, map] = result.result;\n@@ -518,17 +499,17 @@ function makeErrorEmitter(\n       error:\n         error instanceof Error\n           ? {\n-            name: error.name,\n-            message: error.message,\n-            stack: error.stack ? parseStackTrace(error.stack) : [],\n-            cause: undefined,\n-          }\n+              name: error.name,\n+              message: error.message,\n+              stack: error.stack ? parseStackTrace(error.stack) : [],\n+              cause: undefined,\n+            }\n           : {\n             name: \"Error\",\n-            message: error,\n-            stack: [],\n-            cause: undefined,\n-          },\n+              message: error,\n+              stack: [],\n+              cause: undefined,\n+            },\n     });\n   };\n }"
        },
        {
            "sha": "7497b1408bd40c328d59a6a5791d607936b01a36",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 66,
            "deletions": 34,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bf2ad52da0dcb921507ea24c102ee8832cecead3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=bf2ad52da0dcb921507ea24c102ee8832cecead3",
            "patch": "@@ -3,6 +3,7 @@ use std::mem::take;\n use anyhow::{bail, Context, Result};\n use async_trait::async_trait;\n use either::Either;\n+use futures::try_join;\n use serde::{Deserialize, Serialize};\n use serde_json::{json, Value as JsonValue};\n use serde_with::serde_as;\n@@ -348,18 +349,18 @@ pub struct LogInfo {\n #[derive(Deserialize, Debug)]\n #[serde(tag = \"type\", rename_all = \"camelCase\")]\n pub enum InfoMessage {\n-    FileDependency {\n-        path: RcStr,\n-    },\n-    BuildDependency {\n-        path: RcStr,\n-    },\n-    DirDependency {\n-        path: RcStr,\n-        glob: RcStr,\n-    },\n-    EnvDependency {\n-        name: RcStr,\n+    // Sent to inform Turbopack about the dependencies of the task.\n+    // All fields are `default` since it is ok for the client to\n+    // simply omit instead of sending empty arrays.\n+    Dependencies {\n+        #[serde(default)]\n+        env_variables: Vec<RcStr>,\n+        #[serde(default)]\n+        file_paths: Vec<RcStr>,\n+        #[serde(default)]\n+        directories: Vec<(RcStr, RcStr)>,\n+        #[serde(default)]\n+        build_file_paths: Vec<RcStr>,\n     },\n     EmittedError {\n         severity: IssueSeverity,\n@@ -472,29 +473,60 @@ impl EvaluateContext for WebpackLoaderContext {\n         pool: &NodeJsPool,\n     ) -> Result<()> {\n         match data {\n-            InfoMessage::FileDependency { path } => {\n-                // TODO We might miss some changes that happened during execution\n-                // Read dependencies to make them a dependencies of this task. This task will\n-                // execute again when they change.\n-                self.cwd.join(path).read().await?;\n-            }\n-            InfoMessage::BuildDependency { path } => {\n-                // TODO We might miss some changes that happened during execution\n-                BuildDependencyIssue {\n-                    context_ident: self.context_ident_for_issue,\n-                    path: self.cwd.join(path).to_resolved().await?,\n+            InfoMessage::Dependencies {\n+                env_variables,\n+                file_paths,\n+                directories,\n+                build_file_paths,\n+            } => {\n+                // Track dependencies of the loader task\n+                // TODO: Because these are reported _after_ the loader actually read the dependency\n+                // there is a race condition where we may miss updates that race\n+                // with the loader execution.\n+\n+                // Track all the subscriptions in parallel, since certain loaders like tailwind\n+                // might add thousands of subscriptions.\n+                let env_subscriptions = env_variables\n+                    .iter()\n+                    .map(|e| self.env.read(e.clone()))\n+                    .try_join();\n+                let file_subscriptions = file_paths\n+                    .iter()\n+                    .map(|p| self.cwd.join(p.clone()).read())\n+                    .try_join();\n+                let directory_subscriptions = directories\n+                    .iter()\n+                    .map(|(dir, glob)| {\n+                        // TODO: there is some redundancy between `dir_dependency` and what\n+                        // `read_glob` does, Introduce a new read_glob\n+                        // option that will track all files the way\n+                        // `dir_dependency` does but in a single traversal.\n+                        dir_dependency(\n+                            self.cwd\n+                                .join(dir.clone())\n+                                .read_glob(Glob::new(glob.clone()), false),\n+                        )\n+                    })\n+                    .try_join();\n+                let build_paths = build_file_paths\n+                    .iter()\n+                    .map(|path| self.cwd.join(path.clone()).to_resolved())\n+                    .try_join();\n+                let (resolved_build_paths, ..) = try_join!(\n+                    build_paths,\n+                    env_subscriptions,\n+                    file_subscriptions,\n+                    directory_subscriptions\n+                )?;\n+\n+                for build_path in resolved_build_paths {\n+                    BuildDependencyIssue {\n+                        context_ident: self.context_ident_for_issue,\n+                        path: build_path,\n+                    }\n+                    .resolved_cell()\n+                    .emit();\n                 }\n-                .resolved_cell()\n-                .emit();\n-            }\n-            InfoMessage::DirDependency { path, glob } => {\n-                // TODO We might miss some changes that happened during execution\n-                // Read dependencies to make them a dependencies of this task. This task will\n-                // execute again when they change.\n-                dir_dependency(self.cwd.join(path).read_glob(Glob::new(glob), false)).await?;\n-            }\n-            InfoMessage::EnvDependency { name } => {\n-                self.env.read(name).await?;\n             }\n             InfoMessage::EmittedError { error, severity } => {\n                 EvaluateEmittedErrorIssue {"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 109,
        "deletions": 98
    }
}