{
    "author": "SyMind",
    "message": "fix(Rspack): resolve HMR unresponsiveness or unexpected full reload & update dev snapshot (#83480)\n\nThis commit addresses the bugs where Hot Module Replacement (HMR) was\nnot functioning correctly in Rspack mode. Component edits would often\nresult in no update or a full page reload instead of a fast,\nstate-preserving refresh.\n\nThis commit implements a new, custom React Refresh plugin and runtime\nspecifically for Rspack, which correctly orchestrates the HMR lifecycle.",
    "sha": "5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
    "files": [
        {
            "sha": "4b1b5b0e708f6bfa5aa8e48619c46bbe9fb50b0e",
            "filename": "package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -124,7 +124,6 @@\n     \"@opentelemetry/api\": \"1.4.1\",\n     \"@picocss/pico\": \"1.5.10\",\n     \"@rspack/core\": \"1.5.0\",\n-    \"@rspack/plugin-react-refresh\": \"1.2.0\",\n     \"@slack/web-api\": \"7.9.1\",\n     \"@swc/cli\": \"0.1.55\",\n     \"@swc/core\": \"1.11.24\","
        },
        {
            "sha": "f00a9b50f25983d87eec9b7f540d72deb59a2fd0",
            "filename": "packages/next-rspack/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext-rspack%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext-rspack%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-rspack%2Fpackage.json?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -7,8 +7,6 @@\n   },\n   \"types\": \"index.d.ts\",\n   \"dependencies\": {\n-    \"@rspack/core\": \"1.5.0\",\n-    \"@rspack/plugin-react-refresh\": \"1.2.0\",\n-    \"react-refresh\": \"0.12.0\"\n+    \"@rspack/core\": \"1.5.0\"\n   }\n }"
        },
        {
            "sha": "2074166b4430e77f19abddded331656be557e791",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -94,7 +94,7 @@ import {\n   NEXT_PROJECT_ROOT,\n   NEXT_PROJECT_ROOT_DIST_CLIENT,\n } from './next-dir-paths'\n-import { getRspackCore, getRspackReactRefresh } from '../shared/lib/get-rspack'\n+import { getRspackCore } from '../shared/lib/get-rspack'\n import { RspackProfilingPlugin } from './webpack/plugins/rspack-profiling-plugin'\n import getWebpackBundler from '../shared/lib/get-webpack-bundler'\n import type { NextBuildContext } from './build-context'\n@@ -178,7 +178,7 @@ const reactRefreshLoaderName =\n \n function getReactRefreshLoader() {\n   return process.env.NEXT_RSPACK\n-    ? getRspackReactRefresh().loader\n+    ? 'builtin:react-refresh-loader'\n     : require.resolve(reactRefreshLoaderName)\n }\n \n@@ -698,7 +698,9 @@ export default async function getBaseWebpackConfig(\n   ]\n \n   const reactRefreshEntry = isRspack\n-    ? getRspackReactRefresh().entry\n+    ? require.resolve(\n+        `next/dist/compiled/@next/react-refresh-utils/dist/rspack-runtime`\n+      )\n     : require.resolve(\n         `next/dist/compiled/@next/react-refresh-utils/dist/runtime`\n       )\n@@ -1990,11 +1992,7 @@ export default async function getBaseWebpackConfig(\n         isClient &&\n         (isRspack\n           ? // eslint-disable-next-line\n-            new (getRspackReactRefresh() as any)({\n-              injectLoader: false,\n-              injectEntry: false,\n-              overlay: false,\n-            })\n+            new (require('next/dist/compiled/@next/react-refresh-utils/dist/ReactRefreshRspackPlugin').default)()\n           : new ReactRefreshWebpackPlugin(webpack)),\n       // Makes sure `Buffer` and `process` are polyfilled in client and flight bundles (same behavior as webpack 4)\n       (isClient || isEdgeServer) &&"
        },
        {
            "sha": "b3602301d3a1c486d47ade53a9b2b0a791ffc32f",
            "filename": "packages/next/src/build/webpack/loaders/next-font-loader/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -35,6 +35,12 @@ export default async function nextFontLoader(this: any) {\n         `${bold('Cannot')} be used within ${cyan('pages/_document.js')}.`\n       )\n       err.name = 'NextFontError'\n+      if (process.env.NEXT_RSPACK) {\n+        // Rspack uses miette for error formatting, which automatically includes stack\n+        // traces in the error message. To avoid showing redundant stack information\n+        // in the final error output, we clear the stack property.\n+        err.stack = undefined\n+      }\n       callback(err)\n       return\n     }"
        },
        {
            "sha": "3c11269f644aa61a7914dbc038e018335a61b2e8",
            "filename": "packages/next/src/build/webpack/loaders/next-invalid-import-error-loader.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-invalid-import-error-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-invalid-import-error-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-invalid-import-error-loader.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -7,11 +7,9 @@ const nextInvalidImportErrorLoader: webpack.LoaderDefinitionFunction<InvalidImpo\n     const { message } = this.getOptions()\n     const error = new Error(message)\n     if (process.env.NEXT_RSPACK) {\n-      /**\n-       * Rspack uses miette for error formatting, which automatically includes stack\n-       * traces in the error message. To avoid showing redundant stack information\n-       * in the final error output, we clear the stack property.\n-       */\n+      // Rspack uses miette for error formatting, which automatically includes stack\n+      // traces in the error message. To avoid showing redundant stack information\n+      // in the final error output, we clear the stack property.\n       error.stack = undefined\n     }\n     throw error"
        },
        {
            "sha": "b1f7a61f711d389ce69ee0888eac28d127ccacc6",
            "filename": "packages/next/src/shared/lib/get-rspack.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -17,31 +17,6 @@ export function getRspackCore() {\n   }\n }\n \n-export function getRspackReactRefresh() {\n-  warnRspack()\n-  try {\n-    const paths = [require.resolve('next-rspack')]\n-    // eslint-disable-next-line import/no-extraneous-dependencies\n-    const plugin = require(\n-      require.resolve('@rspack/plugin-react-refresh', { paths })\n-    )\n-    const entry = require.resolve(\n-      '@rspack/plugin-react-refresh/react-refresh-entry',\n-      { paths }\n-    )\n-    plugin.entry = entry\n-    return plugin\n-  } catch (e) {\n-    if (e instanceof Error && 'code' in e && e.code === 'MODULE_NOT_FOUND') {\n-      throw new Error(\n-        '@rspack/plugin-react-refresh is not available. Please make sure `next-rspack` is correctly installed.'\n-      )\n-    }\n-\n-    throw e\n-  }\n-}\n-\n function warnRspack() {\n   if (process.env.__NEXT_TEST_MODE) {\n     return"
        },
        {
            "sha": "7bad9481f66b9c7766be73f55bb97975b6609917",
            "filename": "packages/react-refresh-utils/ReactRefreshRspackPlugin.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2FReactRefreshRspackPlugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2FReactRefreshRspackPlugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Freact-refresh-utils%2FReactRefreshRspackPlugin.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -0,0 +1,24 @@\n+import type { Compiler } from 'webpack'\n+\n+const PLUGIN_NAME = 'ReactRefreshRspackPlugin'\n+\n+class ReactRefreshRspackPlugin {\n+  static loader = 'builtin:react-refresh-loader'\n+\n+  apply(compiler: Compiler) {\n+    new compiler.webpack.ProvidePlugin({\n+      $ReactRefreshRuntime$: require.resolve('./internal/RspackReactRefresh'),\n+    }).apply(compiler)\n+\n+    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+      compilation.hooks.additionalTreeRuntimeRequirements.tap(\n+        PLUGIN_NAME,\n+        (_, runtimeRequirements) => {\n+          runtimeRequirements.add(compiler.webpack.RuntimeGlobals.moduleCache)\n+        }\n+      )\n+    })\n+  }\n+}\n+\n+export default ReactRefreshRspackPlugin"
        },
        {
            "sha": "050724f2566a1f44415fcd5d203333871d7a6ba4",
            "filename": "packages/react-refresh-utils/internal/RspackReactRefresh.ts",
            "status": "added",
            "additions": 96,
            "deletions": 0,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2Finternal%2FRspackReactRefresh.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2Finternal%2FRspackReactRefresh.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Freact-refresh-utils%2Finternal%2FRspackReactRefresh.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -0,0 +1,96 @@\n+import RefreshHelpers from './helpers'\n+\n+declare const __webpack_require__: {\n+  c: Record<string | number, { exports: unknown | (() => Promise<unknown>) }>\n+}\n+\n+// Extracts exports from a webpack module object.\n+function getModuleExports(moduleId: string) {\n+  if (typeof moduleId === 'undefined') {\n+    // `moduleId` is unavailable, which indicates that this module is not in the cache,\n+    // which means we won't be able to capture any exports,\n+    // and thus they cannot be refreshed safely.\n+    // These are likely runtime or dynamically generated modules.\n+    return {}\n+  }\n+\n+  var maybeModule = __webpack_require__.c[moduleId]\n+  if (typeof maybeModule === 'undefined') {\n+    // `moduleId` is available but the module in cache is unavailable,\n+    // which indicates the module is somehow corrupted (e.g. broken Webpack `module` globals).\n+    // We will warn the user (as this is likely a mistake) and assume they cannot be refreshed.\n+    console.warn(\n+      '[React Refresh] Failed to get exports for module: ' + moduleId + '.'\n+    )\n+    return {}\n+  }\n+\n+  var exportsOrPromise = maybeModule.exports\n+  if (typeof Promise !== 'undefined' && exportsOrPromise instanceof Promise) {\n+    return exportsOrPromise.then(function (exports) {\n+      return exports\n+    })\n+  }\n+  return exportsOrPromise\n+}\n+\n+function executeRuntime(moduleExports, moduleId, webpackHot) {\n+  RefreshHelpers.registerExportsForReactRefresh(moduleExports, moduleId)\n+\n+  if (webpackHot) {\n+    var isHotUpdate = !!webpackHot.data\n+    var prevSignature: unknown[] | null = webpackHot.data?.prevSignature ?? null\n+\n+    if (RefreshHelpers.isReactRefreshBoundary(moduleExports)) {\n+      webpackHot.dispose(\n+        // Save the previous exports signature on update so we can compare the boundary\n+        // signatures. We avoid saving exports themselves since it causes memory leaks (https://github.com/vercel/next.js/pull/53797)\n+        function hotDisposeCallback(data) {\n+          data.prevSignature =\n+            RefreshHelpers.getRefreshBoundarySignature(moduleExports)\n+        }\n+      )\n+      webpackHot.accept()\n+\n+      // This field is set when the previous version of this module was a\n+      // Refresh Boundary, letting us know we need to check for invalidation or\n+      // enqueue an update.\n+      if (prevSignature !== null) {\n+        if (isHotUpdate) {\n+          if (\n+            RefreshHelpers.shouldInvalidateReactRefreshBoundary(\n+              prevSignature,\n+              RefreshHelpers.getRefreshBoundarySignature(moduleExports)\n+            )\n+          ) {\n+            webpackHot.invalidate()\n+          } else {\n+            RefreshHelpers.scheduleUpdate()\n+          }\n+        }\n+      }\n+    } else {\n+      if (isHotUpdate && prevSignature !== null) {\n+        webpackHot.invalidate()\n+      }\n+    }\n+  }\n+}\n+\n+// Port from https://github.com/pmmmwh/react-refresh-webpack-plugin/blob/main/loader/utils/getRefreshModuleRuntime.js#L29\n+export function refresh(moduleId, webpackHot) {\n+  const currentExports = getModuleExports(moduleId)\n+  const fn = (exports) => {\n+    executeRuntime(exports, moduleId, webpackHot)\n+  }\n+  if (typeof Promise !== 'undefined' && currentExports instanceof Promise) {\n+    currentExports.then(fn)\n+  } else {\n+    fn(currentExports)\n+  }\n+}\n+\n+export {\n+  register,\n+  createSignatureFunctionForTransform,\n+} from 'react-refresh/runtime'"
        },
        {
            "sha": "93cef1412911a92d597c5e58d43f46672a7a4a75",
            "filename": "packages/react-refresh-utils/rspack-runtime.ts",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2Frspack-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/packages%2Freact-refresh-utils%2Frspack-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Freact-refresh-utils%2Frspack-runtime.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -0,0 +1,20 @@\n+import RefreshRuntime from 'react-refresh/runtime'\n+import type { RefreshRuntimeGlobals } from './runtime'\n+\n+declare const self: Window & RefreshRuntimeGlobals\n+\n+if (typeof self !== 'undefined') {\n+  var $RefreshInjected$ = '__reactRefreshInjected'\n+\n+  // Only inject the runtime if it hasn't been injected\n+  if (!self[$RefreshInjected$]) {\n+    RefreshRuntime.injectIntoGlobalHook(self)\n+\n+    // Empty implementation to avoid \"ReferenceError: variable is not defined\" in module which didn't pass builtin:react-refresh-loader\n+    self.$RefreshSig$ = () => (type) => type\n+    self.$RefreshReg$ = () => {}\n+\n+    // Mark the runtime as injected to prevent double-injection\n+    self[$RefreshInjected$] = true\n+  }\n+}"
        },
        {
            "sha": "6f608c557e1bfbe728859f517130184d08c05307",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -141,9 +141,6 @@ importers:\n       '@rspack/core':\n         specifier: 1.5.0\n         version: 1.5.0(@swc/helpers@0.5.15)\n-      '@rspack/plugin-react-refresh':\n-        specifier: 1.2.0\n-        version: 1.2.0(react-refresh@0.12.0)(webpack-hot-middleware@2.26.1)\n       '@slack/web-api':\n         specifier: 7.9.1\n         version: 7.9.1\n@@ -1731,12 +1728,6 @@ importers:\n       '@rspack/core':\n         specifier: 1.5.0\n         version: 1.5.0(@swc/helpers@0.5.15)\n-      '@rspack/plugin-react-refresh':\n-        specifier: 1.2.0\n-        version: 1.2.0(react-refresh@0.12.0)(webpack-hot-middleware@2.26.1)\n-      react-refresh:\n-        specifier: 0.12.0\n-        version: 0.12.0\n \n   packages/next-swc:\n     devDependencies:\n@@ -5029,15 +5020,6 @@ packages:\n     resolution: {integrity: sha512-VynGOEsVw2s8TAlLf/uESfrgfrq2+rcXB1muPJYBWbsm1Oa6r5qVQhjA5ggM6z/coYPrsVMgovl3Ff7Q7OCp1w==}\n     engines: {node: '>=16.0.0'}\n \n-  '@rspack/plugin-react-refresh@1.2.0':\n-    resolution: {integrity: sha512-DTsbtggCfsiXE5QQtYMS8rKfEF8GIjwPDbgIT6Kg8BlAjpJY4jT5IisyhfIi7YOT3d5RIvu60iFB6Kr9sSMsnA==}\n-    peerDependencies:\n-      react-refresh: '>=0.10.0 <1.0.0'\n-      webpack-hot-middleware: 2.x\n-    peerDependenciesMeta:\n-      webpack-hot-middleware:\n-        optional: true\n-\n   '@rtsao/scc@1.1.0':\n     resolution: {integrity: sha512-zt6OdqaDoOnJ1ZYsCYGt9YmWzDXl4vQdKTyJev62gFhRGKdx7mcT54V9KIjg+d2wi9EXsPvAPKe7i7WjfVWB8g==}\n \n@@ -8658,9 +8640,6 @@ packages:\n   error-ex@1.3.2:\n     resolution: {integrity: sha512-7dFHNmqeFSEt2ZBsCriorKnn3Z2pj+fd9kmI6QoWw4//DL+icEBfc0U7qJCisqrTsKTjw4fNFy2pW9OqStD84g==}\n \n-  error-stack-parser@2.1.4:\n-    resolution: {integrity: sha512-Sk5V6wVazPhq5MhpO+AUxJn5x7XSXGl1R93Vn7i+zS15KDVxQijejNCrz8340/2bgLBjR9GtEG8ZVKONDjcqGQ==}\n-\n   es-abstract@1.20.2:\n     resolution: {integrity: sha512-XxXQuVNrySBNlEkTYJoDNFe5+s2yIOpzq80sUHEdPdQr0S5nTLz4ZPPPswNIpKseDDUS5yghX1gfLIHQZ1iNuQ==}\n     engines: {node: '>= 0.4'}\n@@ -15213,9 +15192,6 @@ packages:\n   stackback@0.0.2:\n     resolution: {integrity: sha512-1XMJE5fQo1jGH6Y/7ebnwPOBEkIEnT4QF32d5R1+VXdXveM0IBMJt8zfaxX1P3QhVwrYe+576+jkANtSS2mBbw==}\n \n-  stackframe@1.3.4:\n-    resolution: {integrity: sha512-oeVtt7eWQS+Na6F//S4kJ2K2VbRlS9D43mAlMyVpVWovy9o+jfgH8O9agzANzaiLjclA0oYzUXEM4PurhSUChw==}\n-\n   stacktrace-parser@0.1.10:\n     resolution: {integrity: sha512-KJP1OCML99+8fhOHxwwzyWrlUuVX5GQ0ZpJTd1DFXhdkrvg1szxfHhawXUZ3g9TkXORQd4/WG68jMlQZ2p8wlg==}\n     engines: {node: '>=6'}\n@@ -20838,14 +20814,6 @@ snapshots:\n \n   '@rspack/lite-tapable@1.0.1': {}\n \n-  '@rspack/plugin-react-refresh@1.2.0(react-refresh@0.12.0)(webpack-hot-middleware@2.26.1)':\n-    dependencies:\n-      error-stack-parser: 2.1.4\n-      html-entities: 2.6.0\n-      react-refresh: 0.12.0\n-    optionalDependencies:\n-      webpack-hot-middleware: 2.26.1\n-\n   '@rtsao/scc@1.1.0': {}\n \n   '@rushstack/eslint-patch@1.10.4': {}\n@@ -25129,10 +25097,6 @@ snapshots:\n     dependencies:\n       is-arrayish: 0.2.1\n \n-  error-stack-parser@2.1.4:\n-    dependencies:\n-      stackframe: 1.3.4\n-\n   es-abstract@1.20.2:\n     dependencies:\n       call-bind: 1.0.7\n@@ -33815,8 +33779,6 @@ snapshots:\n   stackback@0.0.2:\n     optional: true\n \n-  stackframe@1.3.4: {}\n-\n   stacktrace-parser@0.1.10(patch_hash=x5tdcojc7b5m2b5ojepbcdl36a):\n     dependencies:\n       type-fest: 0.7.1"
        },
        {
            "sha": "a1f1ffdd111aac43c4da4d70d567c51d4cfef9aa",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -104,6 +104,27 @@ describe('ReactRefreshLogBox app', () => {\n          ],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"no\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"index.js (3:7) @ eval\n+       > 3 | throw new Error('no')\n+           |       ^\",\n+         \"stack\": [\n+           \"eval index.js (3:7)\",\n+           \"<FIXME-next-dist-dir>\",\n+           \"<FIXME-next-dist-dir>\",\n+           \"<FIXME-next-dist-dir>\",\n+           \"eval ./app/page.js\",\n+           \"<FIXME-next-dist-dir>\",\n+           \"<FIXME-next-dist-dir>\",\n+           \"<FIXME-next-dist-dir>\",\n+         ],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        ["
        },
        {
            "sha": "89a7167baf5f296ec91203dc60be9a56d8564102",
            "filename": "test/development/acceptance/ReactRefreshLogBox-builtins.test.ts",
            "status": "modified",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-builtins.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-builtins.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-builtins.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -8,6 +8,7 @@ describe('ReactRefreshLogBox', () => {\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n   })\n+  const isRspack = !!process.env.NEXT_RSPACK\n \n   // Module trace is only available with webpack 5\n   test('Node.js builtins', async () => {\n@@ -57,6 +58,25 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module not found: Can't resolve 'dns' in '<FIXME-project-root>/node_modules/my-package'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./node_modules/my-package/index.js\n+         × Module not found: Can't resolve 'dns' in '<FIXME-project-root>/node_modules/my-package'\n+          ╭─[1:12]\n+        1 │ const dns = require('dns')\n+          ·             ──────────────\n+        2 │ module.exports = dns\n+          ╰────\n+       Import trace for requested module:\n+       ./node_modules/my-package/index.js\n+       ./index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -105,6 +125,27 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module not found: Can't resolve 'b' in '<FIXME-project-root>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+         × Module not found: Can't resolve 'b' in '<FIXME-project-root>'\n+          ╭─[2:17]\n+        1 │ import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n+        2 │ import Comp from 'b';\n+          ·                  ───\n+        3 │ export default function Oops() {\n+        4 │     return /*#__PURE__*/ _jsxDEV(\"div\", {\n+          ╰────\n+       Import trace for requested module:\n+       ./index.js\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -153,6 +194,26 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module not found: Can't resolve 'b' in '<FIXME-project-root>/pages'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/index.js\n+         × Module not found: Can't resolve 'b' in '<FIXME-project-root>/pages'\n+          ╭─[2:17]\n+        1 │ import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n+        2 │ import Comp from 'b';\n+          ·                  ───\n+        3 │ export default function Oops() {\n+        4 │     return /*#__PURE__*/ _jsxDEV(\"div\", {\n+          ╰────\n+       Import trace for requested module:\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -208,6 +269,24 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module not found: Can't resolve './non-existent.css' in '<FIXME-project-root>/pages'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/_app.js\n+         × Module not found: Can't resolve './non-existent.css' in '<FIXME-project-root>/pages'\n+          ╭─[2:7]\n+        1 │ import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n+        2 │ import './non-existent.css';\n+          ·        ────────────────────\n+        3 │ export default function App({ Component, pageProps }) {\n+        4 │     return /*#__PURE__*/ _jsxDEV(Component, {\n+          ╰────\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {"
        },
        {
            "sha": "37609171df671a79c39f6201c8ea3e6787cfa3ec",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 136,
            "deletions": 1,
            "changes": 137,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -11,13 +11,13 @@ import path from 'path'\n import { outdent } from 'outdent'\n \n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n-const isRspack = !!process.env.NEXT_RSPACK\n \n describe('ReactRefreshLogBox', () => {\n   const { isTurbopack, next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n   })\n+  const isRspack = !!process.env.NEXT_RSPACK\n \n   test('should strip whitespace correctly with newline', async () => {\n     await using sandbox = await createSandbox(next)\n@@ -174,6 +174,32 @@ describe('ReactRefreshLogBox', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (3:7) @ eval\n+         > 3 | throw new Error('no')\n+             |       ^\",\n+           \"stack\": [\n+             \"eval index.js (3:7)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"eval ./pages/index.js\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n          {\n@@ -331,6 +357,22 @@ describe('ReactRefreshLogBox', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"FunctionDefault.js (1:51) @ FunctionDefault\n+         > 1 | export default function FunctionDefault() { throw new Error('no'); }\n+             |                                                   ^\",\n+           \"stack\": [\n+             \"FunctionDefault FunctionDefault.js (1:51)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n          {\n@@ -417,6 +459,39 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module build failed:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+         × Module build failed:\n+         ╰─▶   × Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+               │    ,-[7:1]\n+               │  4 |       <p>lol</p>\n+               │  5 |     div\n+               │  6 |   )\n+               │  7 | }\n+               │    : ^\n+               │    \\`----\n+               │   x Expected '</', got '<eof>'\n+               │    ,-[7:1]\n+               │  4 |       <p>lol</p>\n+               │  5 |     div\n+               │  6 |   )\n+               │  7 | }\n+               │    \\`----\n+               │\n+               │\n+               │ Caused by:\n+               │     Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -571,6 +646,22 @@ describe('ReactRefreshLogBox', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"Child.js (4:11) @ ClickCount.render\n+         > 4 |     throw new Error()\n+             |           ^\",\n+           \"stack\": [\n+             \"ClickCount.render Child.js (4:11)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n          {\n@@ -643,6 +734,28 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module build failed:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css\n+         × Module build failed:\n+         ╰─▶   × SyntaxError\n+               │\n+               │ (1:1) <FIXME-project-root>/index.module.css Unknown word\n+               │\n+               │ > 1 | .button\n+               │     | ^\n+               │\n+       Import trace for requested module:\n+       ./index.module.css\n+       ./index.js\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n@@ -683,6 +796,28 @@ describe('ReactRefreshLogBox', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module build failed:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css\n+         × Module build failed:\n+         ╰─▶   × CssSyntaxError\n+               │\n+               │ (1:1) Selector \"button\" is not pure (pure selectors must contain at least one local class or id)\n+               │\n+               │ > 1 | button {}\n+               │     | ^\n+               │\n+       Import trace for requested module:\n+       ./index.module.css\n+       ./index.js\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {"
        },
        {
            "sha": "02002b844333ab252e49a2fba7b5d17a9bcc2065",
            "filename": "test/development/acceptance/error-recovery.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -321,6 +321,22 @@ describe('pages/ error recovery', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"oops\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"child.js (3:9) @ Child\n+         > 3 |   throw new Error('oops')\n+             |         ^\",\n+           \"stack\": [\n+             \"Child child.js (3:9)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n          {\n@@ -776,6 +792,22 @@ describe('pages/ error recovery', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"React is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime ReferenceError\",\n+           \"source\": \"Foo.js (3:3) @ Foo\n+         > 3 |   return React.createElement('h1', null, 'Foo');\n+             |   ^\",\n+           \"stack\": [\n+             \"Foo Foo.js (3:3)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n          {"
        },
        {
            "sha": "d136d02fe184b54b4d77d27376b29c95cc0e13fc",
            "filename": "test/development/app-dir/server-component-next-dynamic-ssr-false/server-component-next-dynamic-ssr-false.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fapp-dir%2Fserver-component-next-dynamic-ssr-false%2Fserver-component-next-dynamic-ssr-false.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fapp-dir%2Fserver-component-next-dynamic-ssr-false%2Fserver-component-next-dynamic-ssr-false.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserver-component-next-dynamic-ssr-false%2Fserver-component-next-dynamic-ssr-false.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -35,6 +35,25 @@ describe('app-dir - server-component-next-dynamic-ssr-false', () => {\n \n        \\`ssr: false\\` is not allowed with \\`next/dynamic\\` in Server Components. Please move it into a Client Component.\"\n       `)\n+    } else if (process.env.NEXT_RSPACK) {\n+      expect(redbox.description).toMatchInlineSnapshot(\n+        `\"  × Module build failed:\"`\n+      )\n+      expect(redbox.source).toMatchInlineSnapshot(`\n+       \"./app/page.js\n+         × Module build failed:\n+         ╰─▶   × Error:   x \\`ssr: false\\` is not allowed with \\`next/dynamic\\` in Server Components. Please move it into a Client Component.\n+               │    ,-[3:1]\n+               │  1 | import dynamic from 'next/dynamic'\n+               │  2 |\n+               │  3 | const DynamicClient = dynamic(() => import('./client'), { ssr: false })\n+               │    :                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+               │  4 |\n+               │  5 | export default function Page() {\n+               │  6 |   return <DynamicClient />\n+               │    \\`----\n+               │\"\n+      `)\n     } else {\n       expect(redbox.description).toMatchInlineSnapshot(\n         `\"  x \\`ssr: false\\` is not allowed with \\`next/dynamic\\` in Server Components. Please move it into a Client Component.\"`"
        },
        {
            "sha": "f1a0018010856c0cac81f8daecb1499f80895f1b",
            "filename": "test/development/next-font/font-loader-in-document-error.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fnext-font%2Ffont-loader-in-document-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fnext-font%2Ffont-loader-in-document-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fnext-font%2Ffont-loader-in-document-error.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -26,6 +26,12 @@ describe('font-loader-in-document-error', () => {\n         next/font: error:\n         Cannot be used within _document.js\"\n       `)\n+    } else if (process.env.NEXT_RSPACK) {\n+      expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n+       \"pages/_document.js\n+         × \\`next/font\\` error:\n+         │ Cannot be used within pages/_document.js.\"\n+      `)\n     } else {\n       expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n               \"pages/_document.js"
        },
        {
            "sha": "f42c931e919996ed5a812b5c414447cd6eb18b10",
            "filename": "test/development/pages-dir/client-navigation/index.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -16,6 +16,7 @@ describe('Client Navigation', () => {\n       TEST_STRICT_NEXT_HEAD: String(true),\n     },\n   })\n+  const isRspack = !!process.env.NEXT_RSPACK\n \n   describe('with empty getInitialProps()', () => {\n     it('should render a redbox', async () => {\n@@ -361,6 +362,23 @@ describe('Client Navigation', () => {\n              ],\n            }\n           `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"An Expected error occurred\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/error-in-the-browser-global-scope.js (2:9) @ eval\n+         > 2 |   throw new Error('An Expected error occurred')\n+             |         ^\",\n+           \"stack\": [\n+             \"eval pages/error-in-the-browser-global-scope.js (2:9)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayRedbox(`\n            {"
        },
        {
            "sha": "eb1c7625a4dd3b887c3ec4e2c15dcb6152734116",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 127,
            "deletions": 0,
            "changes": 127,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -1225,6 +1225,34 @@ describe('Cache Components Errors', () => {\n                  },\n                ]\n               `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:25) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                         ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:25)\",\n+                     \"Page app/sync-cookies/page.tsx (11:7)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:66) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             } else {\n               await expect(browser).toDisplayRedbox(`\n                [\n@@ -1379,6 +1407,34 @@ describe('Cache Components Errors', () => {\n                  },\n                ]\n               `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies-runtime\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Server\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:25) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                         ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:25)\",\n+                     \"Page app/sync-cookies-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Server\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:66) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             } else {\n               await expect(browser).toDisplayRedbox(`\n                [\n@@ -1468,6 +1524,21 @@ describe('Cache Components Errors', () => {\n                               ],\n                             }\n                           `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayCollapsedRedbox(`\n+               {\n+                 \"description\": \"Route \"/sync-draft-mode\" used \\`draftMode().isEnabled\\`. \\`draftMode()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                 \"environmentLabel\": \"Prerender\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/sync-draft-mode/page.tsx (23:31) @ DraftModeReadingComponent\n+               > 23 |   const isEnabled = (draftMode() as unknown as UnsafeUnwrappedDraftMode)\n+                    |                               ^\",\n+                 \"stack\": [\n+                   \"DraftModeReadingComponent app/sync-draft-mode/page.tsx (23:31)\",\n+                   \"Page app/sync-draft-mode/page.tsx (13:7)\",\n+                 ],\n+               }\n+              `)\n             } else {\n               await expect(browser).toDisplayCollapsedRedbox(`\n                             {\n@@ -1542,6 +1613,34 @@ describe('Cache Components Errors', () => {\n                               },\n                             ]\n                           `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-headers\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-headers/page.tsx (17:29) @ HeadersReadingComponent\n+               > 17 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                             ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers/page.tsx (17:29)\",\n+                     \"Page app/sync-headers/page.tsx (11:7)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.headers)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-headers/page.tsx (17:70) @ HeadersReadingComponent\n+               > 17 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                                                                      ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers/page.tsx (17:70)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             } else {\n               await expect(browser).toDisplayRedbox(`\n                             [\n@@ -1696,6 +1795,34 @@ describe('Cache Components Errors', () => {\n                  },\n                ]\n               `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-headers-runtime\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Server\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:29) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                             ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:29)\",\n+                     \"Page app/sync-headers-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.headers)(...).get is not a function\",\n+                   \"environmentLabel\": \"Server\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:70) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                                                                      ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:70)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             } else {\n               await expect(browser).toDisplayRedbox(`\n                ["
        },
        {
            "sha": "1f9e21513804b8ea7cc88a9b161ac0e99c86ebf2",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -27,6 +27,7 @@ describe('app-dir - server source maps', () => {\n     // Manually verify that the runtime logs match.\n     skipDeployment: true,\n   })\n+  const isRspack = !!process.env.NEXT_RSPACK\n \n   if (skipped) return\n \n@@ -490,6 +491,28 @@ describe('app-dir - server source maps', () => {\n            ],\n          }\n         `)\n+      } else if (isRspack) {\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"module-evaluation\",\n+           \"environmentLabel\": \"Prerender\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/module-evaluation/module.js (1:22) @ eval\n+         > 1 | export const error = new Error('module-evaluation')\n+             |                      ^\",\n+           \"stack\": [\n+             \"eval app/module-evaluation/module.js (1:22)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"eval about:/Prerender/webpack-internal:///(rsc)/app/module-evaluation/page.js (5:60)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"Function.all <anonymous>\",\n+             \"Function.all <anonymous>\",\n+             \"Page <anonymous>\",\n+           ],\n+         }\n+        `)\n       } else {\n         await expect(browser).toDisplayCollapsedRedbox(`\n          {\n@@ -579,6 +602,45 @@ describe('app-dir - server source maps', () => {\n            },\n          ]\n         `)\n+      } else if (isRspack) {\n+        // 2nd error from runHiddenSetOfSetsInternal hits https://linear.app/vercel/issue/NEXT-4412\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: external\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (5:29) @ Page\n+         > 5 |   runHiddenSetOfSetsExternal('rsc-anonymous-stack-frame-sandwich: external')\n+             |                             ^\",\n+             \"stack\": [\n+               \"Set.forEach <anonymous>\",\n+               \"Set.forEach <anonymous>\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (5:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+           {\n+             \"description\": \"rsc-anonymous-stack-frame-sandwich: internal\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/rsc-anonymous-stack-frame-sandwich/page.js (6:29) @ Page\n+         > 6 |   runHiddenSetOfSetsInternal('rsc-anonymous-stack-frame-sandwich: internal')\n+             |                             ^\",\n+             \"stack\": [\n+               \"eval webpack-internal:/(ssr)/internal-pkg/ignored.ts (18:54)\",\n+               \"eval webpack-internal:/(ssr)/internal-pkg/ignored.ts (12:7)\",\n+               \"Set.forEach <anonymous>\",\n+               \"eval webpack-internal:/(ssr)/internal-pkg/ignored.ts (11:9)\",\n+               \"Set.forEach <anonymous>\",\n+               \"runSetOfSets webpack-internal:/(ssr)/internal-pkg/ignored.ts (10:13)\",\n+               \"runHiddenSetOfSets webpack-internal:/(ssr)/internal-pkg/ignored.ts (18:3)\",\n+               \"Page app/rsc-anonymous-stack-frame-sandwich/page.js (6:29)\",\n+               \"Page <anonymous>\",\n+             ],\n+           },\n+         ]\n+        `)\n       } else {\n         // 2nd error from runHiddenSetOfSetsInternal hits https://linear.app/vercel/issue/NEXT-4412\n         await expect(browser).toDisplayCollapsedRedbox(`"
        },
        {
            "sha": "335377e9a9a53b6b776ab7ae0d32142b19e15efd",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5712c05c5532303d54e3e6ff18aec0384dcc0a7a/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=5712c05c5532303d54e3e6ff18aec0384dcc0a7a",
            "patch": "@@ -7,6 +7,8 @@ const cacheComponentsEnabled =\n \n const pprEnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n \n+const isRspack = !!process.env.NEXT_RSPACK\n+\n describe('build-output-prerender', () => {\n   describe('with a next config file', () => {\n     describe('without --debug-prerender', () => {\n@@ -76,6 +78,15 @@ describe('build-output-prerender', () => {\n                   ✓ ppr (enabled by \\`experimental.cacheComponents\\`)\n                   ✓ rdcForNavigations (enabled by \\`experimental.ppr\\`)\"\n             `)\n+          } else if (isRspack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Rspack)\n+                - Experiments (use with caution):\n+                  ✓ cacheComponents\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.cacheComponents\\`)\n+                  ✓ ppr (enabled by \\`experimental.cacheComponents\\`)\n+                  ✓ rdcForNavigations (enabled by \\`experimental.ppr\\`)\"\n+            `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"▲ Next.js x.y.z (webpack)\n@@ -209,6 +220,19 @@ describe('build-output-prerender', () => {\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n                   ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\"\n             `)\n+          } else if (isRspack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Rspack)\n+                - Experiments (use with caution):\n+                  ✓ cacheComponents\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ✓ ppr (enabled by \\`experimental.cacheComponents\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ rdcForNavigations (enabled by \\`experimental.ppr\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n@@ -316,6 +340,10 @@ describe('build-output-prerender', () => {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n               `\"▲ Next.js x.y.z (Turbopack)\"`\n             )\n+          } else if (isRspack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+              `\"▲ Next.js x.y.z (Rspack)\"`\n+            )\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n               `\"▲ Next.js x.y.z (webpack)\"`\n@@ -408,6 +436,16 @@ describe('build-output-prerender', () => {\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n                   ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\"\n             `)\n+          } else if (isRspack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Rspack)\n+                - Experiments (use with caution):\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production."
        }
    ],
    "stats": {
        "total": 775,
        "additions": 694,
        "deletions": 81
    }
}