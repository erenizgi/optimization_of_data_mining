{
    "author": "wbinnssmith",
    "message": "Gate alternate bundler behind canary only (#76634)\n\nThis restricts rspack to only be used with canary builds, and updates\nthe plugin’s readme to note this, along with its experimental state.\n\nTest Plan: Made a custom build with a `__NEXT_VERSION` of `15.2.0` and\nverified builds failed with the canary-only message.\n\n---------\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
    "files": [
        {
            "sha": "f1d35236733e5cf4654c343f079710782a3db2df",
            "filename": "packages/next-plugin-rspack/README.md",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext-plugin-rspack%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext-plugin-rspack%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-plugin-rspack%2FREADME.md?ref=80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
            "patch": "@@ -1,4 +1,7 @@\n-# @next/plugin-rspack\n+# @next/plugin-rspack (EXPERIMENTAL)\n+\n+> [!WARNING]\n+> This package is currently experimental and actively developed and supported in Next.js’ `canary` branch. To use this, you must be using a published canary build of Next.js.\n \n This plugin allows you to use [Rspack](https://rspack.dev) in place of webpack with Next.js.\n "
        },
        {
            "sha": "d4aae6c26ef9eead8900f33b9b5962c877989736",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
            "patch": "@@ -657,5 +657,6 @@\n   \"656\": \"If providing both the revalidate and expire options, the expire option must be greater than the revalidate option. The expire option indicates how many seconds from the start until it can no longer be used.\",\n   \"657\": \"revalidate must be a number for image-cache\",\n   \"658\": \"Pass `Infinity` instead of `false` if you want to cache on the server forever without checking with the origin.\",\n-  \"659\": \"SSG should not return an image cache value\"\n+  \"659\": \"SSG should not return an image cache value\",\n+  \"660\": \"Rspack support is only available in Next.js canary.\"\n }"
        },
        {
            "sha": "00db7e916d79f618a3df31a1510a5683a16cac18",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 20,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
            "patch": "@@ -29,6 +29,7 @@ import { dset } from '../shared/lib/dset'\n import { normalizeZodErrors } from '../shared/lib/zod'\n import { HTML_LIMITED_BOT_UA_RE_STRING } from '../shared/lib/router/utils/is-bot'\n import { findDir } from '../lib/find-pages-dir'\n+import { CanaryOnlyError, isStableBuild } from '../shared/lib/canary-only'\n \n export { normalizeConfig } from './config-shared'\n export type { DomainLocale, NextConfig } from './config-shared'\n@@ -244,20 +245,18 @@ function assignDefaults(\n     )\n   }\n \n-  if (\n-    !process.env.__NEXT_VERSION?.includes('canary') &&\n-    !process.env.__NEXT_TEST_MODE &&\n-    !process.env.NEXT_PRIVATE_LOCAL_DEV\n-  ) {\n+  if (isStableBuild()) {\n     // Prevents usage of certain experimental features outside of canary\n     if (result.experimental?.ppr) {\n-      throw new CanaryOnlyError('experimental.ppr')\n+      throw new CanaryOnlyError({ feature: 'experimental.ppr' })\n     } else if (result.experimental?.dynamicIO) {\n-      throw new CanaryOnlyError('experimental.dynamicIO')\n+      throw new CanaryOnlyError({ feature: 'experimental.dynamicIO' })\n     } else if (result.experimental?.turbo?.unstablePersistentCaching) {\n-      throw new CanaryOnlyError('experimental.turbo.unstablePersistentCaching')\n+      throw new CanaryOnlyError({\n+        feature: 'experimental.turbo.unstablePersistentCaching',\n+      })\n     } else if (result.experimental?.nodeMiddleware) {\n-      throw new CanaryOnlyError('experimental.nodeMiddleware')\n+      throw new CanaryOnlyError({ feature: 'experimental.nodeMiddleware' })\n     }\n   }\n \n@@ -1370,14 +1369,3 @@ export function getConfiguredExperimentalFeatures(\n   }\n   return configuredExperimentalFeatures\n }\n-\n-class CanaryOnlyError extends Error {\n-  constructor(feature: string) {\n-    super(\n-      `The experimental feature \"${feature}\" can only be enabled when using the latest canary version of Next.js.`\n-    )\n-    // This error is meant to interrupt the server start/build process\n-    // but the stack trace isn't meaningful, as it points to internal code.\n-    this.stack = undefined\n-  }\n-}"
        },
        {
            "sha": "d7f801743ee148865f6c1c18e0f8ec276aadd42d",
            "filename": "packages/next/src/shared/lib/canary-only.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fcanary-only.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fcanary-only.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fcanary-only.ts?ref=80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
            "patch": "@@ -0,0 +1,23 @@\n+export function isStableBuild() {\n+  return (\n+    !process.env.__NEXT_VERSION?.includes('canary') &&\n+    !process.env.__NEXT_TEST_MODE &&\n+    !process.env.NEXT_PRIVATE_LOCAL_DEV\n+  )\n+}\n+\n+export class CanaryOnlyError extends Error {\n+  constructor(arg: { feature: string } | string) {\n+    if (typeof arg === 'object' && 'feature' in arg) {\n+      super(\n+        `The experimental feature \"${arg.feature}\" can only be enabled when using the latest canary version of Next.js.`\n+      )\n+    } else {\n+      super(arg)\n+    }\n+\n+    // This error is meant to interrupt the server start/build process\n+    // but the stack trace isn't meaningful, as it points to internal code.\n+    this.stack = undefined\n+  }\n+}"
        },
        {
            "sha": "d2e57054e3e8ce5cb6808b0075d36c1e036d65a5",
            "filename": "packages/next/src/shared/lib/get-rspack.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80fbbc20a8b0fd1b32bcff972163ff58ed76f410/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts?ref=80fbbc20a8b0fd1b32bcff972163ff58ed76f410",
            "patch": "@@ -1,4 +1,7 @@\n+import { CanaryOnlyError, isStableBuild } from './canary-only'\n+\n export function getRspackCore() {\n+  gateCanary()\n   try {\n     // eslint-disable-next-line import/no-extraneous-dependencies\n     return require('@rspack/core')\n@@ -14,6 +17,7 @@ export function getRspackCore() {\n }\n \n export function getRspackReactRefresh() {\n+  gateCanary()\n   try {\n     // eslint-disable-next-line import/no-extraneous-dependencies\n     return require('@rspack/plugin-react-refresh')\n@@ -27,3 +31,11 @@ export function getRspackReactRefresh() {\n     throw e\n   }\n }\n+\n+function gateCanary() {\n+  if (isStableBuild()) {\n+    throw new CanaryOnlyError(\n+      'Rspack support is only available in Next.js canary.'\n+    )\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 49,
        "deletions": 22
    }
}