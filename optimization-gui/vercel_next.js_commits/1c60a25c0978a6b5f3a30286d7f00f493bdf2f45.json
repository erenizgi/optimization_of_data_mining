{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in app/ error-recovery (#76552)",
    "sha": "1c60a25c0978a6b5f3a30286d7f00f493bdf2f45",
    "files": [
        {
            "sha": "c9095dbbf83e6292972d816bee322de78bca1cf4",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 617,
            "deletions": 111,
            "changes": 728,
            "blob_url": "https://github.com/vercel/next.js/blob/1c60a25c0978a6b5f3a30286d7f00f493bdf2f45/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c60a25c0978a6b5f3a30286d7f00f493bdf2f45/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=1c60a25c0978a6b5f3a30286d7f00f493bdf2f45",
            "patch": "@@ -1,20 +1,19 @@\n /* eslint-env jest */\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import { check, describeVariants as describe } from 'next-test-utils'\n+import { check } from 'next-test-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n-import stripAnsi from 'strip-ansi'\n \n-describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n+describe('Error recovery app', () => {\n   const { next, isTurbopack } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n   })\n \n   test('can recover from a syntax error without losing state', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -41,10 +40,41 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n \n     await session.patch('index.js', `export default () => <div/`)\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toInclude(\n-      'export default () => <div/'\n-    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (1:27)\n+       Parsing ecmascript source code failed\n+       > 1 | export default () => <div/\n+           |                           ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Unexpected eof\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Unexpected eof\n+          ,----\n+        1 | export default () => <div/\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -72,41 +102,140 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n     )\n   })\n \n-  test.each([['client'], ['server']])(\n-    '%s component can recover from syntax error',\n-    async (type: string) => {\n-      await using sandbox = await createSandbox(next, undefined, '/' + type)\n-      const { session } = sandbox\n-      // Add syntax error\n-      await session.patch(\n-        `app/${type}/page.js`,\n-        outdent`\n+  test('server component can recover from syntax error', async () => {\n+    const type = 'server'\n+    await using sandbox = await createSandbox(next, undefined, '/' + type)\n+    const { browser, session } = sandbox\n+    // Add syntax error\n+    await session.patch(\n+      `app/${type}/page.js`,\n+      outdent`\n           export default function Page() {\n             return <p>Hello world</p>\n         `\n-      )\n-      await session.assertHasRedbox()\n+    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/server/page.js (2:27)\n+       Parsing ecmascript source code failed\n+       > 2 |   return <p>Hello world</p>\n+           |                           ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '}', got '<eof>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/server/page.js\n+       Error:   x Expected '}', got '<eof>'\n+          ,-[2:1]\n+        1 | export default function Page() {\n+        2 |   return <p>Hello world</p>\n+          :                           ^\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./app/server/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n-      // Fix syntax error\n-      await session.patch(\n-        `app/${type}/page.js`,\n-        outdent`\n+    // Fix syntax error\n+    await session.patch(\n+      `app/${type}/page.js`,\n+      outdent`\n           export default function Page() {\n             return <p>Hello world 2</p>\n           }\n         `\n-      )\n+    )\n+\n+    await check(\n+      () => session.evaluate(() => document.querySelector('p').textContent),\n+      'Hello world 2'\n+    )\n+  })\n \n-      await check(\n-        () => session.evaluate(() => document.querySelector('p').textContent),\n-        'Hello world 2'\n-      )\n+  test('client component can recover from syntax error', async () => {\n+    const type = 'client'\n+    await using sandbox = await createSandbox(next, undefined, '/' + type)\n+    const { browser, session } = sandbox\n+    // Add syntax error\n+    await session.patch(\n+      `app/${type}/page.js`,\n+      outdent`\n+          export default function Page() {\n+            return <p>Hello world</p>\n+        `\n+    )\n+\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/client/page.js (2:27)\n+       Parsing ecmascript source code failed\n+       > 2 |   return <p>Hello world</p>\n+           |                           ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '}', got '<eof>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/client/page.js\n+       Error:   x Expected '}', got '<eof>'\n+          ,-[2:1]\n+        1 | export default function Page() {\n+        2 |   return <p>Hello world</p>\n+          :                           ^\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./app/client/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     }\n-  )\n+\n+    // Fix syntax error\n+    await session.patch(\n+      `app/${type}/page.js`,\n+      outdent`\n+          export default function Page() {\n+            return <p>Hello world 2</p>\n+          }\n+        `\n+    )\n+\n+    await check(\n+      () => session.evaluate(() => document.querySelector('p').textContent),\n+      'Hello world 2'\n+    )\n+  })\n \n   test('can recover from a event handler error', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -137,19 +266,48 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n       await session.evaluate(() => document.querySelector('p').textContent)\n     ).toBe('1')\n \n-    await session.openRedbox()\n-\n-    expect(await session.getRedboxSource()).toMatchInlineSnapshot(`\n-      \"index.js (7:11) @ Index.useCallback[increment]\n-\n-         5 |   const increment = useCallback(() => {\n-         6 |     setCount(c => c + 1)\n-      >  7 |     throw new Error('oops')\n-           |           ^\n-         8 |   }, [setCount])\n-         9 |   return (\n-        10 |     <main>\"\n-    `)\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: oops\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (7:11) @ Index.useCallback[increment]\n+       >  7 |     throw new Error('oops')\n+            |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[increment] index.js (7:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+           \"button <anonymous> (0:0)\",\n+           \"Index index.js (12:7)\",\n+           \"Page index.js (10:6)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      // TODO(veil): Location of Page should be app/page.js\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: oops\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (7:11) @ Index.useCallback[increment]\n+       >  7 |     throw new Error('oops')\n+            |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[increment] index.js (7:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+           \"button <anonymous> (0:0)\",\n+           \"Index index.js (12:7)\",\n+           \"Page app/page.js (4:10)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -184,24 +342,23 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n     expect(await session.hasErrorToast()).toBe(false)\n   })\n \n-  test.each([['client'], ['server']])(\n-    '%s component can recover from a component error',\n-    async (type: string) => {\n-      await using sandbox = await createSandbox(next, undefined, '/' + type)\n-      const { session, browser } = sandbox\n+  test('server component can recover from a component error', async () => {\n+    const type = 'server'\n+    await using sandbox = await createSandbox(next, undefined, '/' + type)\n+    const { session, browser } = sandbox\n \n-      await session.write(\n-        'child.js',\n-        outdent`\n+    await session.write(\n+      'child.js',\n+      outdent`\n           export default function Child() {\n             return <p>Hello</p>;\n           }\n         `\n-      )\n+    )\n \n-      await session.patch(\n-        'index.js',\n-        outdent`\n+    await session.patch(\n+      'index.js',\n+      outdent`\n           import Child from './child'\n   \n           export default function Index() {\n@@ -212,48 +369,153 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n             )\n           }\n         `\n-      )\n+    )\n \n-      expect(await browser.elementByCss('p').text()).toBe('Hello')\n+    expect(await browser.elementByCss('p').text()).toBe('Hello')\n \n-      await session.patch(\n-        'child.js',\n-        outdent`\n+    await session.patch(\n+      'child.js',\n+      outdent`\n           // hello\n           export default function Child() {\n             throw new Error('oops')\n           }\n         `\n-      )\n+    )\n \n-      await session.assertHasRedbox()\n-      expect(await session.getRedboxSource()).toInclude(\n-        'export default function Child()'\n-      )\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: oops\",\n+       \"environmentLabel\": \"Server\",\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"child.js (3:9) @ Child\n+     > 3 |   throw new Error('oops')\n+         |         ^\",\n+       \"stack\": [\n+         \"Child child.js (3:9)\",\n+         \"Page app/server/page.js (3:10)\",\n+       ],\n+     }\n+    `)\n \n-      // TODO-APP: re-enable when error recovery doesn't reload the page.\n-      /* const didNotReload = */ await session.patch(\n-        'child.js',\n-        outdent`\n+    // TODO-APP: re-enable when error recovery doesn't reload the page.\n+    /* const didNotReload = */ await session.patch(\n+      'child.js',\n+      outdent`\n           export default function Child() {\n             return <p>Hello</p>;\n           }\n         `\n-      )\n-\n-      // TODO-APP: re-enable when error recovery doesn't reload the page.\n-      // expect(didNotReload).toBe(true)\n-      await session.assertNoRedbox()\n-      expect(\n-        await session.evaluate(() => document.querySelector('p').textContent)\n-      ).toBe('Hello')\n+    )\n+\n+    // TODO-APP: re-enable when error recovery doesn't reload the page.\n+    // expect(didNotReload).toBe(true)\n+    await session.assertNoRedbox()\n+    expect(\n+      await session.evaluate(() => document.querySelector('p').textContent)\n+    ).toBe('Hello')\n+  })\n+\n+  test('client component can recover from a component error', async () => {\n+    const type = 'client'\n+    await using sandbox = await createSandbox(next, undefined, '/' + type)\n+    const { session, browser } = sandbox\n+\n+    await session.write(\n+      'child.js',\n+      outdent`\n+          export default function Child() {\n+            return <p>Hello</p>;\n+          }\n+        `\n+    )\n+\n+    await session.patch(\n+      'index.js',\n+      outdent`\n+          import Child from './child'\n+  \n+          export default function Index() {\n+            return (\n+              <main>\n+                <Child />\n+              </main>\n+            )\n+          }\n+        `\n+    )\n+\n+    expect(await browser.elementByCss('p').text()).toBe('Hello')\n+\n+    await session.patch(\n+      'child.js',\n+      outdent`\n+          // hello\n+          export default function Child() {\n+            throw new Error('oops')\n+          }\n+        `\n+    )\n+\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: oops\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"child.js (3:9) @ Child\n+       > 3 |   throw new Error('oops')\n+           |         ^\",\n+         \"stack\": [\n+           \"Child child.js (3:9)\",\n+           \"Index index.js (6:7)\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: oops\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"child.js (3:9) @ Child\n+       > 3 |   throw new Error('oops')\n+           |         ^\",\n+         \"stack\": [\n+           \"Child child.js (3:9)\",\n+           \"Index index.js (6:7)\",\n+           \"Page app/client/page.js (4:10)\",\n+         ],\n+       }\n+      `)\n     }\n-  )\n+\n+    // TODO-APP: re-enable when error recovery doesn't reload the page.\n+    /* const didNotReload = */ await session.patch(\n+      'child.js',\n+      outdent`\n+          export default function Child() {\n+            return <p>Hello</p>;\n+          }\n+        `\n+    )\n+\n+    // TODO-APP: re-enable when error recovery doesn't reload the page.\n+    // expect(didNotReload).toBe(true)\n+    await session.assertNoRedbox()\n+    expect(\n+      await session.evaluate(() => document.querySelector('p').textContent)\n+    ).toBe('Hello')\n+  })\n \n   // https://github.com/pmmmwh/react-refresh-webpack-plugin/pull/3#issuecomment-554150098\n   test('syntax > runtime error', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     // Start here.\n     await session.patch(\n@@ -283,10 +545,20 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n     )\n \n     await new Promise((resolve) => setTimeout(resolve, 1000))\n-    await session.openRedbox()\n-    expect(await session.getRedboxSource()).not.toInclude(\n-      \"Expected '}', got '<eof>'\"\n-    )\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: no 1\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"index.js (5:9) @ eval\n+     > 5 |   throw Error('no ' + i)\n+         |         ^\",\n+       \"stack\": [\n+         \"eval index.js (5:9)\",\n+       ],\n+     }\n+    `)\n \n     // Make a syntax error.\n     await session.patch(\n@@ -303,23 +575,93 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n     )\n \n     await new Promise((resolve) => setTimeout(resolve, 1000))\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toInclude(\n-      \"Expected '}', got '<eof>'\"\n-    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (7:41)\n+       Parsing ecmascript source code failed\n+       > 7 | export default function FunctionNamed() {\n+           |                                         ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '}', got '<eof>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Expected '}', got '<eof>'\n+          ,-[7:1]\n+        4 |   i++\n+        5 |   throw Error('no ' + i)\n+        6 | }, 1000)\n+        7 | export default function FunctionNamed() {\n+          :                                         ^\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // Test that runtime error does not take over:\n     await new Promise((resolve) => setTimeout(resolve, 2000))\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toInclude(\n-      \"Expected '}', got '<eof>'\"\n-    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (7:41)\n+       Parsing ecmascript source code failed\n+       > 7 | export default function FunctionNamed() {\n+           |                                         ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '}', got '<eof>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Expected '}', got '<eof>'\n+          ,-[7:1]\n+        4 |   i++\n+        5 |   throw Error('no ' + i)\n+        6 | }, 1000)\n+        7 | export default function FunctionNamed() {\n+          :                                         ^\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n   })\n \n   // https://github.com/pmmmwh/react-refresh-webpack-plugin/pull/3#issuecomment-554144016\n   test('stuck error', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     // We start here.\n     await session.patch(\n@@ -360,10 +702,41 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n     )\n \n     // We get an error because Foo didn't import React. Fair.\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toInclude(\n-      \"return React.createElement('h1', null, 'Foo');\"\n-    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: React is not defined\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"Foo.js (3:3) @ Foo\n+       > 3 |   return React.createElement('h1', null, 'Foo');\n+           |   ^\",\n+         \"stack\": [\n+           \"Foo Foo.js (3:3)\",\n+           \"FunctionDefault index.js (4:10)\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: React is not defined\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"Foo.js (3:3) @ Foo\n+       > 3 |   return React.createElement('h1', null, 'Foo');\n+           |   ^\",\n+         \"stack\": [\n+           \"Foo Foo.js (3:3)\",\n+           \"FunctionDefault index.js (4:10)\",\n+           \"Page app/page.js (4:10)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     // Let's add that to Foo.\n     await session.patch(\n@@ -383,7 +756,7 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n   // https://github.com/pmmmwh/react-refresh-webpack-plugin/pull/3#issuecomment-554137262\n   test('render error not shown right after syntax error', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     // Starting here:\n     await session.patch(\n@@ -419,7 +792,47 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n         export default ClassDefault;\n       `\n     )\n-    await session.assertHasRedbox()\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (5:5)\n+       Parsing ecmascript source code failed\n+       > 5 |     return <h1>Default Export</h1>;\n+           |     ^^^^^^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '{', got 'return'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Expected '{', got 'return'\n+          ,-[5:1]\n+        2 |\n+        3 | class ClassDefault extends React.Component {\n+        4 |   render()\n+        5 |     return <h1>Default Export</h1>;\n+          :     ^^^^^^\n+        6 |   }\n+        7 | }\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // Now change the code to introduce a runtime error without fixing the syntax error:\n     await session.patch(\n@@ -437,7 +850,48 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n         export default ClassDefault;\n       `\n     )\n-    await session.assertHasRedbox()\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (5:5)\n+       Parsing ecmascript source code failed\n+       > 5 |     throw new Error('nooo');\n+           |     ^^^^^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '{', got 'throw'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Expected '{', got 'throw'\n+          ,-[5:1]\n+        2 |\n+        3 | class ClassDefault extends React.Component {\n+        4 |   render()\n+        5 |     throw new Error('nooo');\n+          :     ^^^^^\n+        6 |     return <h1>Default Export</h1>;\n+        7 |   }\n+        8 | }\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // Now fix the syntax error:\n     await session.patch(\n@@ -455,28 +909,80 @@ describe.each(['default', 'turbo'])('Error recovery app %s', () => {\n         export default ClassDefault;\n       `\n     )\n-    await session.assertHasRedbox()\n-\n-    await expect(session.getRedboxSource()).resolves.toInclude('render() {')\n-\n-    expect(await session.getRedboxSource()).toInclude(\n-      \"throw new Error('nooo');\"\n-    )\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: nooo\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ ClassDefault.render\n+       > 5 |     throw new Error('nooo');\n+           |           ^\",\n+         \"stack\": [\n+           \"ClassDefault.render index.js (5:11)\",\n+           \"Page index.js (10:16)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: nooo\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ ClassDefault.render\n+       > 5 |     throw new Error('nooo');\n+           |           ^\",\n+         \"stack\": [\n+           \"ClassDefault.render index.js (5:11)\",\n+           \"Page app/page.js (4:10)\",\n+         ],\n+       }\n+      `)\n+    }\n   })\n \n   test('displays build error on initial page load', async () => {\n     await using sandbox = await createSandbox(\n       next,\n       new Map([['app/page.js', '{{{']])\n     )\n-    const { session } = sandbox\n-    await session.assertHasRedbox()\n+    const { browser } = sandbox\n \n-    const source = stripAnsi(await session.getRedboxSource(true))\n     if (isTurbopack) {\n-      expect(source).toMatch(/Parsing ecmascript source code failed/)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js (1:3)\n+       Parsing ecmascript source code failed\n+       > 1 | {{{\n+           |   ^\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n-      expect(source).toMatch(/x Expected '}', got '<eof>'/)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expected '}', got '<eof>'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js\n+       Error:   x Expected '}', got '<eof>'\n+          ,----\n+        1 | {{{\n+          :   ^\n+          \\`----\n+       Caused by:\n+           Syntax Error\",\n+         \"stack\": [],\n+       }\n+      `)\n     }\n   })\n })"
        }
    ],
    "stats": {
        "total": 728,
        "additions": 617,
        "deletions": 111
    }
}