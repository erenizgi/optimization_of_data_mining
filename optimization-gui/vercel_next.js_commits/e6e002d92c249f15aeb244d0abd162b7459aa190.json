{
    "author": "lukesandberg",
    "message": "[turbopack] Remove uses of `Value<ClientContextType>` by making `ClientContextType` a TaskInput (#80127)\n\nRefactor ClientContextType to use TaskInput instead of Value wrapper\n\n### Why?\nThe `Value<>` type is confusing and error prone, lets destroy it!\n\nAs discussed over slack, `turbo_tasks::Value` type always implements `is_resolved` as `true` and `is_transient` as `false` which is incorrect and can enable smuggling transient vcs into turbo tasks. \n\n• https://vercel.slack.com/archives/C03EWR7LGEN/p1743456121241529\n• https://vercel.slack.com/archives/C04NGV98TPS/p1743455453764879",
    "sha": "e6e002d92c249f15aeb244d0abd162b7459aa190",
    "files": [
        {
            "sha": "905c04ec762f40fca5f278a9d4ee7324b4068a74",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=e6e002d92c249f15aeb244d0abd162b7459aa190",
            "patch": "@@ -207,7 +207,7 @@ impl AppProject {\n             self.project().project_path(),\n             self.project().execution_context(),\n             self.project().client_compile_time_info().environment(),\n-            Value::new(self.client_ty().owned().await?),\n+            self.client_ty().owned().await?,\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().encryption_key(),\n@@ -219,7 +219,7 @@ impl AppProject {\n     async fn client_resolve_options_context(self: Vc<Self>) -> Result<Vc<ResolveOptionsContext>> {\n         Ok(get_client_resolve_options_context(\n             self.project().project_path(),\n-            Value::new(self.client_ty().owned().await?),\n+            self.client_ty().owned().await?,\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().execution_context(),\n@@ -784,7 +784,7 @@ impl AppProject {\n     async fn client_runtime_entries(self: Vc<Self>) -> Result<Vc<EvaluatableAssets>> {\n         Ok(get_client_runtime_entries(\n             self.project().project_path(),\n-            Value::new(self.client_ty().owned().await?),\n+            self.client_ty().owned().await?,\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().execution_context(),"
        },
        {
            "sha": "c1ef063ae13f0fffee5aedb5771a639258e86a69",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=e6e002d92c249f15aeb244d0abd162b7459aa190",
            "patch": "@@ -336,9 +336,9 @@ impl PagesProject {\n             self.project().project_path(),\n             self.project().execution_context(),\n             self.project().client_compile_time_info().environment(),\n-            Value::new(ClientContextType::Pages {\n+            ClientContextType::Pages {\n                 pages_dir: self.pages_dir().to_resolved().await?,\n-            }),\n+            },\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().encryption_key(),\n@@ -350,9 +350,9 @@ impl PagesProject {\n     async fn client_resolve_options_context(self: Vc<Self>) -> Result<Vc<ResolveOptionsContext>> {\n         Ok(get_client_resolve_options_context(\n             self.project().project_path(),\n-            Value::new(ClientContextType::Pages {\n+            ClientContextType::Pages {\n                 pages_dir: self.pages_dir().to_resolved().await?,\n-            }),\n+            },\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().execution_context(),\n@@ -566,9 +566,9 @@ impl PagesProject {\n     async fn client_runtime_entries(self: Vc<Self>) -> Result<Vc<EvaluatableAssets>> {\n         let client_runtime_entries = get_client_runtime_entries(\n             self.project().project_path(),\n-            Value::new(ClientContextType::Pages {\n+            ClientContextType::Pages {\n                 pages_dir: self.pages_dir().to_resolved().await?,\n-            }),\n+            },\n             self.project().next_mode(),\n             self.project().next_config(),\n             self.project().execution_context(),"
        },
        {
            "sha": "2d16bfec679104a2c2a4ae4c3b3067597994353d",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=e6e002d92c249f15aeb244d0abd162b7459aa190",
            "patch": "@@ -2,7 +2,7 @@ use std::iter::once;\n \n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{FxIndexMap, OptionVcExt, ResolvedVc, Value, Vc};\n+use turbo_tasks::{FxIndexMap, OptionVcExt, ResolvedVc, TaskInput, Value, Vc};\n use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n@@ -139,8 +139,8 @@ pub async fn get_client_compile_time_info(\n     .await\n }\n \n-#[turbo_tasks::value(shared, serialization = \"auto_for_input\")]\n-#[derive(Debug, Copy, Clone, Hash)]\n+#[turbo_tasks::value(shared)]\n+#[derive(Debug, Copy, Clone, Hash, TaskInput)]\n pub enum ClientContextType {\n     Pages {\n         pages_dir: ResolvedVc<FileSystemPath>,\n@@ -155,7 +155,7 @@ pub enum ClientContextType {\n #[turbo_tasks::function]\n pub async fn get_client_resolve_options_context(\n     project_path: ResolvedVc<FileSystemPath>,\n-    ty: Value<ClientContextType>,\n+    ty: ClientContextType,\n     mode: Vc<NextMode>,\n     next_config: Vc<NextConfig>,\n     execution_context: Vc<ExecutionContext>,\n@@ -231,7 +231,7 @@ pub async fn get_client_module_options_context(\n     project_path: ResolvedVc<FileSystemPath>,\n     execution_context: ResolvedVc<ExecutionContext>,\n     env: ResolvedVc<Environment>,\n-    ty: Value<ClientContextType>,\n+    ty: ClientContextType,\n     mode: Vc<NextMode>,\n     next_config: Vc<NextConfig>,\n     encryption_key: ResolvedVc<RcStr>,\n@@ -291,11 +291,9 @@ pub async fn get_client_module_options_context(\n     let target_browsers = env.runtime_versions();\n \n     let mut next_client_rules =\n-        get_next_client_transforms_rules(next_config, ty.into_value(), mode, false, encryption_key)\n-            .await?;\n+        get_next_client_transforms_rules(next_config, ty, mode, false, encryption_key).await?;\n     let foreign_next_client_rules =\n-        get_next_client_transforms_rules(next_config, ty.into_value(), mode, true, encryption_key)\n-            .await?;\n+        get_next_client_transforms_rules(next_config, ty, mode, true, encryption_key).await?;\n     let additional_rules: Vec<ModuleRule> = vec![\n         get_swc_ecma_transform_plugin_rule(next_config, project_path).await?,\n         get_relay_transform_rule(next_config, project_path).await?,\n@@ -500,7 +498,7 @@ pub fn get_client_assets_path(client_root: Vc<FileSystemPath>) -> Vc<FileSystemP\n #[turbo_tasks::function]\n pub async fn get_client_runtime_entries(\n     project_root: Vc<FileSystemPath>,\n-    ty: Value<ClientContextType>,\n+    ty: ClientContextType,\n     mode: Vc<NextMode>,\n     next_config: Vc<NextConfig>,\n     execution_context: Vc<ExecutionContext>,\n@@ -529,7 +527,7 @@ pub async fn get_client_runtime_entries(\n         };\n     }\n \n-    if matches!(*ty, ClientContextType::App { .. },) {\n+    if matches!(ty, ClientContextType::App { .. },) {\n         runtime_entries.push(\n             RuntimeEntry::Request(\n                 Request::parse(Value::new(Pattern::Constant(rcstr!("
        },
        {
            "sha": "3f14393633f22e6e30587d3b71a81e35016c4928",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e6e002d92c249f15aeb244d0abd162b7459aa190/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=e6e002d92c249f15aeb244d0abd162b7459aa190",
            "patch": "@@ -91,7 +91,7 @@ const EDGE_UNSUPPORTED_NODE_INTERNALS: [&str; 44] = [\n #[turbo_tasks::function]\n pub async fn get_next_client_import_map(\n     project_path: ResolvedVc<FileSystemPath>,\n-    ty: Value<ClientContextType>,\n+    ty: ClientContextType,\n     next_config: Vc<NextConfig>,\n     next_mode: Vc<NextMode>,\n     execution_context: Vc<ExecutionContext>,\n@@ -118,7 +118,7 @@ pub async fn get_next_client_import_map(\n     )\n     .await?;\n \n-    match ty.into_value() {\n+    match ty {\n         ClientContextType::Pages { .. } => {}\n         ClientContextType::App { app_dir } => {\n             let react_flavor = if *next_config.enable_ppr().await?\n@@ -236,7 +236,7 @@ pub async fn get_next_client_import_map(\n         },\n     );\n \n-    match ty.into_value() {\n+    match ty {\n         ClientContextType::Pages { .. }\n         | ClientContextType::App { .. }\n         | ClientContextType::Fallback => {\n@@ -259,12 +259,10 @@ pub async fn get_next_client_import_map(\n /// Computes the Next-specific client fallback import map, which provides\n /// polyfills to Node.js externals.\n #[turbo_tasks::function]\n-pub async fn get_next_client_fallback_import_map(\n-    ty: Value<ClientContextType>,\n-) -> Result<Vc<ImportMap>> {\n+pub async fn get_next_client_fallback_import_map(ty: ClientContextType) -> Result<Vc<ImportMap>> {\n     let mut import_map = ImportMap::empty();\n \n-    match ty.into_value() {\n+    match ty {\n         ClientContextType::Pages {\n             pages_dir: context_dir,\n         }"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 23,
        "deletions": 27
    }
}