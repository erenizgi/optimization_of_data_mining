{
    "author": "TrevorBurnham",
    "message": "fix: Include CSP nonce in next/dynamic preload (#81999)\n\nCo-authored-by: Jiachi Liu <inbox@huozhi.im>",
    "sha": "544f52126ed0f16b78044ea16e8e1170f6503179",
    "files": [
        {
            "sha": "f9d2e667ba256fc92fbd7d1802e7cc49815a99ab",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -1982,7 +1982,8 @@ export const renderToHTMLOrFlight: AppPageRender = (\n     previewModeId: renderOpts.previewProps?.previewModeId,\n   })\n \n-  const { isPrefetchRequest, previouslyRevalidatedTags } = parsedRequestHeaders\n+  const { isPrefetchRequest, previouslyRevalidatedTags, nonce } =\n+    parsedRequestHeaders\n \n   let postponedState: PostponedState | null = null\n \n@@ -2018,6 +2019,7 @@ export const renderToHTMLOrFlight: AppPageRender = (\n     isPrefetchRequest,\n     buildId: sharedContext.buildId,\n     previouslyRevalidatedTags,\n+    nonce,\n   })\n \n   return workAsyncStorage.run("
        },
        {
            "sha": "d277bd5609cd6ceced3f685149ca43071a18b8e6",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -97,6 +97,7 @@ export interface WorkStore {\n     Record<string, { files: string[] }>\n   >\n   readonly assetPrefix?: string\n+  readonly nonce?: string\n \n   cacheComponentsEnabled: boolean\n   dev: boolean"
        },
        {
            "sha": "61ea1f1583eefa25e36700fc598446130ac0da9c",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -20,6 +20,7 @@ export type WorkStoreContext = {\n   page: string\n \n   isPrefetchRequest?: boolean\n+  nonce?: string\n   renderOpts: {\n     cacheLifeProfiles?: { [profile: string]: CacheLife }\n     incrementalCache?: IncrementalCache\n@@ -79,6 +80,7 @@ export function createWorkStore({\n   isPrefetchRequest,\n   buildId,\n   previouslyRevalidatedTags,\n+  nonce,\n }: WorkStoreContext): WorkStore {\n   /**\n    * Rules of Static & Dynamic HTML:\n@@ -135,6 +137,7 @@ export function createWorkStore({\n     buildId,\n     reactLoadableManifest: renderOpts?.reactLoadableManifest || {},\n     assetPrefix: renderOpts?.assetPrefix || '',\n+    nonce,\n \n     afterContext: createAfterContext(renderOpts),\n     cacheComponentsEnabled: renderOpts.experimental.cacheComponents,"
        },
        {
            "sha": "632a3bf5fc22673542a2c4a2aa3955cc179bc5fa",
            "filename": "packages/next/src/shared/lib/lazy-dynamic/preload-chunks.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -58,13 +58,15 @@ export function PreloadChunks({\n               href={href}\n               rel=\"stylesheet\"\n               as=\"style\"\n+              nonce={workStore.nonce}\n             />\n           )\n         } else {\n           // If it's script we use ReactDOM.preload to preload the resources\n           preload(href, {\n             as: 'script',\n             fetchPriority: 'low',\n+            nonce: workStore.nonce,\n           })\n           return null\n         }"
        },
        {
            "sha": "3c7e41ebd2a5a4a1c2014511d05ae615683a08cb",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/app/dynamic-component.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fdynamic-component.js",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fdynamic-component.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fdynamic-component.js?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,9 @@\n+'use client'\n+\n+export default function DynamicComponent() {\n+  return (\n+    <div id=\"dynamic-component-loaded\">\n+      Dynamic component loaded successfully\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "18db693a6a09578e07491ffb5089a72bfbe24faa",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/app/layout.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Flayout.js?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,29 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+async function CSPMetatag({ children }) {\n+  const resolvedHeaders = await headers()\n+  const nonce = resolvedHeaders.get('x-nonce') || 'test-nonce'\n+\n+  return (\n+    <meta\n+      httpEquiv=\"Content-Security-Policy\"\n+      content={`default-src 'self'; script-src 'self' 'nonce-${nonce}'; style-src 'self' 'unsafe-inline'`}\n+    />\n+  )\n+}\n+\n+export default async function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <Suspense>\n+        <head>\n+          <CSPMetatag />\n+        </head>\n+        <body>\n+          <div id=\"csp-nonce-test\">{children}</div>\n+        </body>\n+      </Suspense>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "2075acfbddc2d0b3d8d9ab57035ad073445ff054",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/app/page.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fapp%2Fpage.js?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+import dynamic from 'next/dynamic'\n+\n+const DynamicComponent = dynamic(() => import('./dynamic-component'), {\n+  loading: () => <div id=\"loading\">Loading...</div>,\n+})\n+\n+export default function CSPNoncePage() {\n+  return (\n+    <div>\n+      <h1 id=\"page-title\">CSP Nonce Test Page</h1>\n+      <DynamicComponent />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "9ef8271dbef74f202d296ff0857594c9cd2b544d",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/middleware.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fmiddleware.js?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,16 @@\n+import { NextResponse } from 'next/server'\n+\n+export function middleware(request) {\n+  const response = NextResponse.next()\n+  const nonce = 'test-nonce'\n+  response.headers.set('x-nonce', nonce)\n+  response.headers.set(\n+    'Content-Security-Policy',\n+    `default-src 'self'; script-src 'self' 'nonce-${nonce}'; style-src 'self' 'unsafe-inline'`\n+  )\n+  return response\n+}\n+\n+export const config = {\n+  matcher: '/:path*',\n+}"
        },
        {
            "sha": "0e2162f0e4df6725ea82334ace73dc39f02d7e23",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/next-dynamic-csp-nonce.test.ts",
            "status": "added",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext-dynamic-csp-nonce.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext-dynamic-csp-nonce.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext-dynamic-csp-nonce.test.ts?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,61 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('next/dynamic with CSP nonce', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should include nonce attribute on preload links generated by next/dynamic', async () => {\n+    const $ = await next.render$('/')\n+\n+    // Check that preload links have the nonce attribute\n+    const preloadLinks = $('link[rel=\"preload\"]')\n+\n+    const dynamicPreloadLinks = preloadLinks.filter((_, element) => {\n+      const $element = $(element)\n+      const href = $element.attr('href')\n+      return href && href.includes('_next/static/chunks/')\n+    })\n+\n+    // There should be at least one preload link for dynamic chunks\n+    expect(dynamicPreloadLinks.length).toBeGreaterThan(0)\n+\n+    dynamicPreloadLinks.each((_, element) => {\n+      const $element = $(element)\n+      const href = $element.attr('href')\n+\n+      // Only check preload links for dynamic chunks\n+      if (href && href.includes('_next/static/chunks/')) {\n+        expect($element.attr('nonce')).toBe('test-nonce')\n+      }\n+    })\n+  })\n+\n+  it('should not generate CSP violations when using next/dynamic with nonce', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Wait for the dynamic component to load\n+    await browser.waitForElementByCss('#dynamic-component-loaded')\n+\n+    // OPTIMIZATION: Get both text values concurrently\n+    const [pageTitle, componentText] = await Promise.all([\n+      browser.elementByCss('#page-title').then((el) => el.text()),\n+      browser.elementByCss('#dynamic-component-loaded').then((el) => el.text()),\n+    ])\n+\n+    expect(pageTitle).toBe('CSP Nonce Test Page')\n+    expect(componentText).toBe('Dynamic component loaded successfully')\n+\n+    // Check for CSP violations in Chrome (most expensive operation)\n+    if (global.browserName === 'chrome') {\n+      const logs = await browser.log()\n+      const cspViolations = logs.filter(\n+        (log) =>\n+          log.source === 'security' &&\n+          log.message.includes('Content Security Policy')\n+      )\n+\n+      expect(cspViolations).toEqual([])\n+    }\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/next-dynamic-csp-nonce/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/544f52126ed0f16b78044ea16e8e1170f6503179/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-dynamic-csp-nonce%2Fnext.config.js?ref=544f52126ed0f16b78044ea16e8e1170f6503179",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 146,
        "deletions": 1
    }
}