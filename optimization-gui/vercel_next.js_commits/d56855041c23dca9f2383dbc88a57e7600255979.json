{
    "author": "wyattjoh",
    "message": "refactor: encapsulate content type within RenderResult (#81861)\n\n### Problem\nThe PPR boundary sentinel was being incorrectly added to responses due\nto flawed content type logic in `sendRenderResult`. The original\nconditional logic had complex fallbacks that caused the sentinel to be\nadded when it shouldn't be:\n\n```javascript\n// BEFORE: Incorrect logic - sentinel added to wrong response types\nif (\n  process.env.__NEXT_TEST_MODE &&\n  minimalMode &&\n  isRoutePPREnabled &&\n  // ❌ This logic was inverted and unreliable\n  body.contentType !== RSC_CONTENT_TYPE_HEADER &&\n  !isRSCRequest\n) {\n  body.unshift(createPPRBoundarySentinel())\n}\n```\n\nThe problem was that `body.contentType` was inconsistently determined\nthrough external logic in `sendRenderResult`, causing the sentinel to\nappear in responses that shouldn't have it.\n\n### Solution\nBy moving content type into `RenderResult` constructor, the sentinel\nlogic now correctly identifies HTML responses:\n\n```javascript\n// AFTER: Correct logic - sentinel only added to HTML responses\nif (\n  process.env.__NEXT_TEST_MODE &&\n  minimalMode &&\n  isRoutePPREnabled &&\n  body.contentType === HTML_CONTENT_TYPE_HEADER // ✅ Reliable content type check\n) {\n  body.unshift(createPPRBoundarySentinel())\n}\n```\n\n### Key Changes\n- **Fixed sentinel logic**: PPR boundary sentinel now only appears in\nHTML responses where it belongs\n- **Reliable content type**: Content type is determined at RenderResult\ncreation, not through fallback logic\n- **Consistent API**: Removed redundant `type` parameter that was\ncausing the confusion\n\nThis ensures PPR test assertions work correctly by only adding the\nboundary sentinel to the appropriate response types.",
    "sha": "d56855041c23dca9f2383dbc88a57e7600255979",
    "files": [
        {
            "sha": "48922b3e78b1143cce234ccdd7f8ca5ae6978591",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -728,5 +728,8 @@\n   \"727\": \"Route %s couldn't be rendered statically because it used IO that was not cached. See more info here: https://nextjs.org/docs/messages/cache-components\",\n   \"728\": \"CacheSignal cannot be used in the edge runtime, because `cacheComponents` does not support it.\",\n   \"729\": \"\\\\`experimental.ppr\\\\` can not be \\\\`%s\\\\` when \\\\`experimental.cacheComponents\\\\` is \\\\`true\\\\`. PPR is implicitly enabled when Cache Components is enabled.\",\n-  \"730\": \"Dynamic imports should not be instrumented in the edge runtime, because `cacheComponents` doesn't support it\"\n+  \"730\": \"Dynamic imports should not be instrumented in the edge runtime, because `cacheComponents` doesn't support it\",\n+  \"731\": \"chainStreams requires at least one stream\",\n+  \"732\": \"dynamic responses cannot be unchunked. This is a bug in Next.js\",\n+  \"733\": \"null responses cannot be unchunked\"\n }"
        },
        {
            "sha": "f64970b00aca16064b0c2afb9fd0ecf001f01beb",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -44,7 +44,11 @@ import {\n } from '../../server/response-cache'\n import { FallbackMode, parseFallbackField } from '../../lib/fallback'\n import RenderResult from '../../server/render-result'\n-import { CACHE_ONE_YEAR, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\n+import {\n+  CACHE_ONE_YEAR,\n+  HTML_CONTENT_TYPE_HEADER,\n+  NEXT_CACHE_TAGS_HEADER,\n+} from '../../lib/constants'\n import type { CacheControl } from '../../server/lib/cache-control'\n import { ENCODED_TAGS } from '../../server/stream-utils/encoded-tags'\n import { sendRenderResult } from '../../server/send-payload'\n@@ -728,7 +732,7 @@ export async function handler(\n           cacheControl: { revalidate: 1, expire: undefined },\n           value: {\n             kind: CachedRouteKind.PAGES,\n-            html: RenderResult.fromStatic(''),\n+            html: RenderResult.EMPTY,\n             pageData: {},\n             headers: undefined,\n             status: undefined,\n@@ -917,10 +921,12 @@ export async function handler(\n           return sendRenderResult({\n             req,\n             res,\n-            type: 'rsc',\n             generateEtags: nextConfig.generateEtags,\n             poweredByHeader: nextConfig.poweredByHeader,\n-            result: RenderResult.fromStatic(matchedSegment),\n+            result: RenderResult.fromStatic(\n+              matchedSegment,\n+              RSC_CONTENT_TYPE_HEADER\n+            ),\n             cacheControl: cacheEntry.cacheControl,\n           })\n         }\n@@ -935,10 +941,9 @@ export async function handler(\n         return sendRenderResult({\n           req,\n           res,\n-          type: 'rsc',\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n-          result: RenderResult.fromStatic(''),\n+          result: RenderResult.EMPTY,\n           cacheControl: cacheEntry.cacheControl,\n         })\n       }\n@@ -1041,7 +1046,6 @@ export async function handler(\n           return sendRenderResult({\n             req,\n             res,\n-            type: 'rsc',\n             generateEtags: nextConfig.generateEtags,\n             poweredByHeader: nextConfig.poweredByHeader,\n             result: cachedData.html,\n@@ -1061,10 +1065,12 @@ export async function handler(\n         return sendRenderResult({\n           req,\n           res,\n-          type: 'rsc',\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n-          result: RenderResult.fromStatic(cachedData.rscData),\n+          result: RenderResult.fromStatic(\n+            cachedData.rscData,\n+            RSC_CONTENT_TYPE_HEADER\n+          ),\n           cacheControl: cacheEntry.cacheControl,\n         })\n       }\n@@ -1083,10 +1089,7 @@ export async function handler(\n           process.env.__NEXT_TEST_MODE &&\n           minimalMode &&\n           isRoutePPREnabled &&\n-          // If the response body is an RSC content type of the request was for\n-          // an RSC request then we shouldn't add the sentinel.\n-          body.contentType !== RSC_CONTENT_TYPE_HEADER &&\n-          !isRSCRequest\n+          body.contentType === HTML_CONTENT_TYPE_HEADER\n         ) {\n           // As we're in minimal mode, the static part would have already been\n           // streamed first. The only part that this streams is the dynamic part\n@@ -1097,7 +1100,6 @@ export async function handler(\n         return sendRenderResult({\n           req,\n           res,\n-          type: isRSCRequest ? 'rsc' : 'html',\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: body,\n@@ -1124,7 +1126,6 @@ export async function handler(\n         return sendRenderResult({\n           req,\n           res,\n-          type: 'html',\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: body,\n@@ -1180,7 +1181,6 @@ export async function handler(\n       return sendRenderResult({\n         req,\n         res,\n-        type: 'html',\n         generateEtags: nextConfig.generateEtags,\n         poweredByHeader: nextConfig.poweredByHeader,\n         result: body,"
        },
        {
            "sha": "4998fa4fbebcc5589c7d8913d50d2bcc3f3e80cd",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -28,6 +28,7 @@ import type RenderResult from '../../server/render-result'\n import type { RenderResultMetadata } from '../../server/render-result'\n import { getTracer, SpanKind, type Span } from '../../server/lib/trace/tracer'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n+import { HTML_CONTENT_TYPE_HEADER } from '../../lib/constants'\n \n // injected by the loader afterwards.\n declare const nextConfig: NextConfigComplete\n@@ -195,7 +196,7 @@ async function requestHandler(\n     const headers = new Headers()\n \n     // Set content type\n-    const contentType = result.contentType || 'text/html; charset=utf-8'\n+    const contentType = result.contentType || HTML_CONTENT_TYPE_HEADER\n     headers.set('Content-Type', contentType)\n \n     // Add metadata headers"
        },
        {
            "sha": "9fa5320f3b1e1a096ca1753035cce958fa7055a7",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -31,7 +31,11 @@ import {\n } from '../../server/lib/cache-control'\n import { normalizeRepeatedSlashes } from '../../shared/lib/utils'\n import { getRedirectStatus } from '../../lib/redirect-status'\n-import { CACHE_ONE_YEAR } from '../../lib/constants'\n+import {\n+  CACHE_ONE_YEAR,\n+  HTML_CONTENT_TYPE_HEADER,\n+  JSON_CONTENT_TYPE_HEADER,\n+} from '../../lib/constants'\n import { sendRenderResult } from '../../server/send-payload'\n import RenderResult from '../../server/render-result'\n import { toResponseCacheEntry } from '../../server/response-cache/utils'\n@@ -526,7 +530,7 @@ export async function handler(\n               html: new RenderResult(\n                 Buffer.from(previousCacheEntry.value.html),\n                 {\n-                  contentType: 'text/html;utf-8',\n+                  contentType: HTML_CONTENT_TYPE_HEADER,\n                   metadata: {\n                     statusCode: previousCacheEntry.value.status,\n                     headers: previousCacheEntry.value.headers,\n@@ -653,7 +657,7 @@ export async function handler(\n \n       if (result.value.kind === CachedRouteKind.REDIRECT) {\n         if (isNextDataRequest) {\n-          res.setHeader('content-type', 'application/json')\n+          res.setHeader('content-type', JSON_CONTENT_TYPE_HEADER)\n           res.end(JSON.stringify(result.value.props))\n           return\n         } else {\n@@ -732,15 +736,14 @@ export async function handler(\n             ? new RenderResult(\n                 Buffer.from(JSON.stringify(result.value.pageData)),\n                 {\n-                  contentType: 'application/json',\n+                  contentType: JSON_CONTENT_TYPE_HEADER,\n                   metadata: result.value.html.metadata,\n                 }\n               )\n             : result.value.html,\n         generateEtags: nextConfig.generateEtags,\n         poweredByHeader: nextConfig.poweredByHeader,\n         cacheControl: routeModule.isDev ? undefined : cacheControl,\n-        type: isNextDataRequest ? 'json' : 'html',\n       })\n     }\n "
        },
        {
            "sha": "c9ccbf360061e65231573277950a736d1fdce782",
            "filename": "packages/next/src/export/routes/pages.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fpages.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -17,6 +17,7 @@ import type {\n } from '../../server/lib/mock-request'\n import { isInAmpMode } from '../../shared/lib/amp-mode'\n import {\n+  HTML_CONTENT_TYPE_HEADER,\n   NEXT_DATA_SUFFIX,\n   SERVER_PROPS_EXPORT_ERROR,\n } from '../../lib/constants'\n@@ -96,7 +97,10 @@ export async function exportPagesPage(\n   let renderResult: RenderResult | undefined\n \n   if (typeof components.Component === 'string') {\n-    renderResult = RenderResult.fromStatic(components.Component)\n+    renderResult = RenderResult.fromStatic(\n+      components.Component,\n+      HTML_CONTENT_TYPE_HEADER\n+    )\n \n     if (hasOrigQueryValues) {\n       throw new Error("
        },
        {
            "sha": "af670eacbeae5f9e515bda33545a4bc24c511864",
            "filename": "packages/next/src/lib/constants.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -1,5 +1,8 @@\n import type { ServerRuntime } from '../types'\n \n+export const TEXT_PLAIN_CONTENT_TYPE_HEADER = 'text/plain'\n+export const HTML_CONTENT_TYPE_HEADER = 'text/html; charset=utf-8'\n+export const JSON_CONTENT_TYPE_HEADER = 'application/json; charset=utf-8'\n export const NEXT_QUERY_PARAM_PREFIX = 'nxtP'\n export const NEXT_INTERCEPTION_MARKER_PREFIX = 'nxtI'\n "
        },
        {
            "sha": "b2b9562a7f388d6c8c119babaea320819b5e66ae",
            "filename": "packages/next/src/server/api-utils/node/api-resolver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -24,6 +24,7 @@ import {\n } from './../index'\n import { getCookieParser } from './../get-cookie-parser'\n import {\n+  JSON_CONTENT_TYPE_HEADER,\n   PRERENDER_REVALIDATE_HEADER,\n   PRERENDER_REVALIDATE_ONLY_GENERATED_HEADER,\n } from '../../../lib/constants'\n@@ -106,7 +107,7 @@ function sendData(req: NextApiRequest, res: NextApiResponse, body: any): void {\n   }\n \n   if (isJSONLike) {\n-    res.setHeader('Content-Type', 'application/json; charset=utf-8')\n+    res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n   }\n \n   res.setHeader('Content-Length', Buffer.byteLength(stringifiedBody))\n@@ -120,7 +121,7 @@ function sendData(req: NextApiRequest, res: NextApiResponse, body: any): void {\n  */\n function sendJson(res: NextApiResponse, jsonBody: any): void {\n   // Set header to application/json\n-  res.setHeader('Content-Type', 'application/json; charset=utf-8')\n+  res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n \n   // Use send to handle request\n   res.send(JSON.stringify(jsonBody))"
        },
        {
            "sha": "42cf3222bc4d58fb2d1621cb9557140a202d86b9",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -39,6 +39,7 @@ import {\n import { getModifiedCookieValues } from '../web/spec-extension/adapters/request-cookies'\n \n import {\n+  JSON_CONTENT_TYPE_HEADER,\n   NEXT_CACHE_REVALIDATED_TAGS_HEADER,\n   NEXT_CACHE_REVALIDATE_TAG_TOKEN_HEADER,\n } from '../../lib/constants'\n@@ -247,7 +248,7 @@ async function createForwardedActionResponse(\n     console.error(`failed to forward action response`, err)\n   }\n \n-  return RenderResult.fromStatic('{}')\n+  return RenderResult.fromStatic('{}', JSON_CONTENT_TYPE_HEADER)\n }\n \n /**\n@@ -389,7 +390,7 @@ async function createRedirectRenderResult(\n     }\n   }\n \n-  return RenderResult.fromStatic('')\n+  return RenderResult.EMPTY\n }\n \n // Used to compare Host header and Origin header.\n@@ -655,7 +656,7 @@ export async function handleAction({\n     res.statusCode = 404\n     return {\n       type: 'done',\n-      result: RenderResult.fromStatic('Server action not found.'),\n+      result: RenderResult.fromStatic('Server action not found.', 'text/plain'),\n     }\n   }\n \n@@ -1060,7 +1061,7 @@ export async function handleAction({\n       res.setHeader('Location', redirectUrl)\n       return {\n         type: 'done',\n-        result: RenderResult.fromStatic(''),\n+        result: RenderResult.EMPTY,\n       }\n     } else if (isHTTPAccessFallbackError(err)) {\n       res.statusCode = getAccessFallbackHTTPStatus(err)"
        },
        {
            "sha": "031e868b6f2842efb408a6d9a9bf8a96ab36504c",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -173,7 +173,7 @@ import { CacheSignal } from './cache-signal'\n import { getTracedMetadata } from '../lib/trace/utils'\n import { InvariantError } from '../../shared/lib/invariant-error'\n \n-import { INFINITE_CACHE } from '../../lib/constants'\n+import { HTML_CONTENT_TYPE_HEADER, INFINITE_CACHE } from '../../lib/constants'\n import { createComponentStylesAndScripts } from './create-component-styles-and-scripts'\n import { parseLoaderTree } from './parse-loader-tree'\n import {\n@@ -1476,6 +1476,7 @@ async function renderToHTMLOrFlightImpl(\n \n     const options: RenderResultOptions = {\n       metadata,\n+      contentType: HTML_CONTENT_TYPE_HEADER,\n     }\n     // If we have pending revalidates, wait until they are all resolved.\n     if (\n@@ -1624,7 +1625,10 @@ async function renderToHTMLOrFlightImpl(\n             metadata\n           )\n \n-          return new RenderResult(stream, { metadata })\n+          return new RenderResult(stream, {\n+            metadata,\n+            contentType: HTML_CONTENT_TYPE_HEADER,\n+          })\n         } else if (actionRequestResult.type === 'done') {\n           if (actionRequestResult.result) {\n             actionRequestResult.result.assignMetadata(metadata)\n@@ -1638,6 +1642,7 @@ async function renderToHTMLOrFlightImpl(\n \n     const options: RenderResultOptions = {\n       metadata,\n+      contentType: HTML_CONTENT_TYPE_HEADER,\n     }\n \n     const stream = await renderToStreamWithTracing("
        },
        {
            "sha": "5eb701388433bb35a3ff52481b85855137e4ba1d",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 31,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -105,6 +105,7 @@ import {\n   NEXT_URL,\n   NEXT_ROUTER_STATE_TREE_HEADER,\n   NEXT_IS_PRERENDER_HEADER,\n+  RSC_CONTENT_TYPE_HEADER,\n } from '../client/components/app-router-headers'\n import type {\n   MatchOptions,\n@@ -124,6 +125,8 @@ import { sendResponse } from './send-response'\n import { normalizeNextQueryParam } from './web/utils'\n import {\n   CACHE_ONE_YEAR,\n+  HTML_CONTENT_TYPE_HEADER,\n+  JSON_CONTENT_TYPE_HEADER,\n   MATCHED_PATH_HEADER,\n   NEXT_CACHE_TAGS_HEADER,\n   NEXT_RESUME_HEADER,\n@@ -314,7 +317,6 @@ export class WrappedBuildError extends Error {\n }\n \n type ResponsePayload = {\n-  type: 'html' | 'json' | 'rsc'\n   body: RenderResult\n   cacheControl?: CacheControl\n }\n@@ -391,7 +393,6 @@ export default abstract class Server<\n     res: ServerResponse,\n     options: {\n       result: RenderResult\n-      type: 'html' | 'json' | 'rsc'\n       generateEtags: boolean\n       poweredByHeader: boolean\n       cacheControl: CacheControl | undefined\n@@ -1807,7 +1808,7 @@ export default abstract class Server<\n     }\n     const { req, res } = ctx\n     const originalStatus = res.statusCode\n-    const { body, type } = payload\n+    const { body } = payload\n     let { cacheControl } = payload\n     if (!res.sent) {\n       const { generateEtags, poweredByHeader, dev } = this.renderOpts\n@@ -1824,7 +1825,6 @@ export default abstract class Server<\n \n       await this.sendRenderResult(req, res, {\n         result: body,\n-        type,\n         generateEtags,\n         poweredByHeader,\n         cacheControl,\n@@ -2328,9 +2328,10 @@ export default abstract class Server<\n     // handle static page\n     if (typeof components.Component === 'string') {\n       return {\n-        type: 'html',\n-        // TODO: Static pages should be serialized as RenderResult\n-        body: RenderResult.fromStatic(components.Component),\n+        body: RenderResult.fromStatic(\n+          components.Component,\n+          HTML_CONTENT_TYPE_HEADER\n+        ),\n       }\n     }\n \n@@ -3125,7 +3126,7 @@ export default abstract class Server<\n           cacheControl: { revalidate: 1, expire: undefined },\n           value: {\n             kind: CachedRouteKind.PAGES,\n-            html: RenderResult.fromStatic(''),\n+            html: RenderResult.EMPTY,\n             pageData: {},\n             headers: undefined,\n             status: undefined,\n@@ -3361,8 +3362,10 @@ export default abstract class Server<\n       if (matchedSegment !== undefined) {\n         // Cache hit\n         return {\n-          type: 'rsc',\n-          body: RenderResult.fromStatic(matchedSegment),\n+          body: RenderResult.fromStatic(\n+            matchedSegment,\n+            RSC_CONTENT_TYPE_HEADER\n+          ),\n           // TODO: Eventually this should use cache control of the individual\n           // segment, not the whole page.\n           cacheControl: cacheEntry.cacheControl,\n@@ -3377,8 +3380,7 @@ export default abstract class Server<\n       // issued as part of a prefetch.\n       res.statusCode = 204\n       return {\n-        type: 'rsc',\n-        body: RenderResult.fromStatic(''),\n+        body: RenderResult.EMPTY,\n         cacheControl: cacheEntry?.cacheControl,\n       }\n     }\n@@ -3452,10 +3454,9 @@ export default abstract class Server<\n \n       if (isNextDataRequest) {\n         return {\n-          type: 'json',\n           body: RenderResult.fromStatic(\n-            // @TODO: Handle flight data.\n-            JSON.stringify(cachedData.props)\n+            JSON.stringify(cachedData.props),\n+            JSON_CONTENT_TYPE_HEADER\n           ),\n           cacheControl: cacheEntry.cacheControl,\n         }\n@@ -3539,7 +3540,6 @@ export default abstract class Server<\n           }\n \n           return {\n-            type: 'rsc',\n             body: cachedData.html,\n             // Dynamic RSC responses cannot be cached, even if they're\n             // configured with `force-static` because we have no way of\n@@ -3555,8 +3555,10 @@ export default abstract class Server<\n         // As this isn't a prefetch request, we should serve the static flight\n         // data.\n         return {\n-          type: 'rsc',\n-          body: RenderResult.fromStatic(cachedData.rscData),\n+          body: RenderResult.fromStatic(\n+            cachedData.rscData,\n+            RSC_CONTENT_TYPE_HEADER\n+          ),\n           cacheControl: cacheEntry.cacheControl,\n         }\n       }\n@@ -3569,7 +3571,6 @@ export default abstract class Server<\n       // as a server render (rather than a static render).\n       if (!didPostpone || this.minimalMode) {\n         return {\n-          type: 'html',\n           body,\n           cacheControl: cacheEntry.cacheControl,\n         }\n@@ -3592,7 +3593,6 @@ export default abstract class Server<\n         )\n \n         return {\n-          type: 'html',\n           body,\n           cacheControl: { revalidate: 0, expire: undefined },\n         }\n@@ -3637,7 +3637,6 @@ export default abstract class Server<\n         })\n \n       return {\n-        type: 'html',\n         body,\n         // We don't want to cache the response if it has postponed data because\n         // the response being sent to the client it's dynamic parts are streamed\n@@ -3646,13 +3645,14 @@ export default abstract class Server<\n       }\n     } else if (isNextDataRequest) {\n       return {\n-        type: 'json',\n-        body: RenderResult.fromStatic(JSON.stringify(cachedData.pageData)),\n+        body: RenderResult.fromStatic(\n+          JSON.stringify(cachedData.pageData),\n+          JSON_CONTENT_TYPE_HEADER\n+        ),\n         cacheControl: cacheEntry.cacheControl,\n       }\n     } else {\n       return {\n-        type: 'html',\n         body: cachedData.html,\n         cacheControl: cacheEntry.cacheControl,\n       }\n@@ -3887,7 +3887,7 @@ export default abstract class Server<\n         `${locale ? `/${locale}` : ''}${pathname}`\n       )\n       res.statusCode = 200\n-      res.setHeader('content-type', 'application/json')\n+      res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n       res.body('{}')\n       res.send()\n       return null\n@@ -3985,8 +3985,7 @@ export default abstract class Server<\n     // Since favicon.ico is automatically requested by the browser.\n     if (this.renderOpts.dev && ctx.pathname === '/favicon.ico') {\n       return {\n-        type: 'html',\n-        body: RenderResult.fromStatic(''),\n+        body: RenderResult.EMPTY,\n       }\n     }\n     const { res, query } = ctx\n@@ -4079,7 +4078,6 @@ export default abstract class Server<\n         // which is handled in the parent process in development\n         if (this.renderOpts.dev) {\n           return {\n-            type: 'html',\n             // wait for dev-server to restart before refreshing\n             body: RenderResult.fromStatic(\n               `\n@@ -4095,7 +4093,8 @@ export default abstract class Server<\n                   }\n                 }\n                 check()\n-              </script>`\n+              </script>`,\n+              HTML_CONTENT_TYPE_HEADER\n             ),\n           }\n         }\n@@ -4173,8 +4172,7 @@ export default abstract class Server<\n         )\n       }\n       return {\n-        type: 'html',\n-        body: RenderResult.fromStatic('Internal Server Error'),\n+        body: RenderResult.fromStatic('Internal Server Error', 'text/plain'),\n       }\n     }\n   }"
        },
        {
            "sha": "fb2a0c030160316b77e4ad36759b7ab28ee2c02b",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -84,6 +84,7 @@ import {\n import { getDefineEnv } from '../../../build/define-env'\n import { TurbopackInternalError } from '../../../shared/lib/turbopack/internal-error'\n import { normalizePath } from '../../../lib/normalize-path'\n+import { JSON_CONTENT_TYPE_HEADER } from '../../../lib/constants'\n \n export type SetupOpts = {\n   renderServer: LazyRenderServerInstance\n@@ -973,7 +974,7 @@ async function startWatcher(\n \n     if (parsedUrl.pathname?.includes(clientPagesManifestPath)) {\n       res.statusCode = 200\n-      res.setHeader('Content-Type', 'application/json; charset=utf-8')\n+      res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n       res.end(\n         JSON.stringify({\n           pages: prevSortedRoutes.filter(\n@@ -989,7 +990,7 @@ async function startWatcher(\n       parsedUrl.pathname?.includes(devTurbopackMiddlewareManifestPath)\n     ) {\n       res.statusCode = 200\n-      res.setHeader('Content-Type', 'application/json; charset=utf-8')\n+      res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n       res.end(JSON.stringify(serverFields.middleware?.matchers || []))\n       return { finished: true }\n     }"
        },
        {
            "sha": "9c75f350025ea85c30fc139c3745d53edb99d0fa",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -607,7 +607,6 @@ export default class NextNodeServer extends BaseServer<\n     res: NodeNextResponse,\n     options: {\n       result: RenderResult\n-      type: 'html' | 'json' | 'rsc'\n       generateEtags: boolean\n       poweredByHeader: boolean\n       cacheControl: CacheControl | undefined\n@@ -617,7 +616,6 @@ export default class NextNodeServer extends BaseServer<\n       req: req.originalRequest,\n       res: res.originalResponse,\n       result: options.result,\n-      type: options.type,\n       generateEtags: options.generateEtags,\n       poweredByHeader: options.poweredByHeader,\n       cacheControl: options.cacheControl,"
        },
        {
            "sha": "1d441255ca368937fbd68d2d86686eb4cc6d89e1",
            "filename": "packages/next/src/server/render-result.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 16,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -11,8 +11,19 @@ import {\n } from './stream-utils/node-web-streams-helper'\n import { isAbortError, pipeToNodeResponse } from './pipe-readable'\n import type { RenderResumeDataCache } from './resume-data-cache/resume-data-cache'\n-\n-type ContentTypeOption = string | undefined\n+import { InvariantError } from '../shared/lib/invariant-error'\n+import type {\n+  HTML_CONTENT_TYPE_HEADER,\n+  JSON_CONTENT_TYPE_HEADER,\n+  TEXT_PLAIN_CONTENT_TYPE_HEADER,\n+} from '../lib/constants'\n+import type { RSC_CONTENT_TYPE_HEADER } from '../client/components/app-router-headers'\n+\n+type ContentTypeOption =\n+  | typeof RSC_CONTENT_TYPE_HEADER // For App Page RSC responses\n+  | typeof HTML_CONTENT_TYPE_HEADER // For App Page, Pages HTML responses\n+  | typeof JSON_CONTENT_TYPE_HEADER // For API routes, Next.js data requests\n+  | typeof TEXT_PLAIN_CONTENT_TYPE_HEADER // For simplified errors\n \n export type AppPageRenderResultMetadata = {\n   flightData?: Buffer\n@@ -70,7 +81,7 @@ export type RenderResultResponse =\n export type RenderResultOptions<\n   Metadata extends RenderResultMetadata = RenderResultMetadata,\n > = {\n-  contentType?: ContentTypeOption\n+  contentType: ContentTypeOption | null\n   waitUntil?: Promise<unknown>\n   metadata: Metadata\n }\n@@ -82,7 +93,7 @@ export default class RenderResult<\n    * The detected content type for the response. This is used to set the\n    * `Content-Type` header.\n    */\n-  public readonly contentType: ContentTypeOption\n+  public readonly contentType: ContentTypeOption | null\n \n   /**\n    * The metadata for the response. This is used to set the revalidation times\n@@ -98,14 +109,30 @@ export default class RenderResult<\n    */\n   private response: RenderResultResponse\n \n+  /**\n+   * A render result that represents an empty response. This is used to\n+   * represent a response that was not found or was already sent.\n+   */\n+  public static readonly EMPTY = new RenderResult<StaticRenderResultMetadata>(\n+    null,\n+    { metadata: {}, contentType: null }\n+  )\n+\n   /**\n    * Creates a new RenderResult instance from a static response.\n    *\n    * @param value the static response value\n+   * @param contentType the content type of the response\n    * @returns a new RenderResult instance\n    */\n-  public static fromStatic(value: string | Buffer) {\n-    return new RenderResult<StaticRenderResultMetadata>(value, { metadata: {} })\n+  public static fromStatic(\n+    value: string | Buffer,\n+    contentType: ContentTypeOption\n+  ) {\n+    return new RenderResult<StaticRenderResultMetadata>(value, {\n+      metadata: {},\n+      contentType,\n+    })\n   }\n \n   private readonly waitUntil?: Promise<unknown>\n@@ -144,13 +171,13 @@ export default class RenderResult<\n   public toUnchunkedBuffer(stream: true): Promise<Buffer>\n   public toUnchunkedBuffer(stream = false): Promise<Buffer> | Buffer {\n     if (this.response === null) {\n-      throw new Error('Invariant: null responses cannot be unchunked')\n+      throw new InvariantError('null responses cannot be unchunked')\n     }\n \n     if (typeof this.response !== 'string') {\n       if (!stream) {\n-        throw new Error(\n-          'Invariant: dynamic responses cannot be unchunked. This is a bug in Next.js'\n+        throw new InvariantError(\n+          'dynamic responses cannot be unchunked. This is a bug in Next.js'\n         )\n       }\n \n@@ -171,13 +198,13 @@ export default class RenderResult<\n   public toUnchunkedString(stream: true): Promise<string>\n   public toUnchunkedString(stream = false): Promise<string> | string {\n     if (this.response === null) {\n-      throw new Error('Invariant: null responses cannot be unchunked')\n+      throw new InvariantError('null responses cannot be unchunked')\n     }\n \n     if (typeof this.response !== 'string') {\n       if (!stream) {\n-        throw new Error(\n-          'Invariant: dynamic responses cannot be unchunked. This is a bug in Next.js'\n+        throw new InvariantError(\n+          'dynamic responses cannot be unchunked. This is a bug in Next.js'\n         )\n       }\n \n@@ -188,15 +215,21 @@ export default class RenderResult<\n   }\n \n   /**\n-   * Returns the response if it is a stream, or throws an error if it is a\n-   * string.\n+   * Returns a readable stream of the response.\n    */\n   private get readable(): ReadableStream<Uint8Array> {\n     if (this.response === null) {\n-      throw new Error('Invariant: null responses cannot be streamed')\n+      // If the response is null, return an empty stream. This behavior is\n+      // intentional as we're now providing the `RenderResult.EMPTY` value.\n+      return new ReadableStream<Uint8Array>({\n+        start(controller) {\n+          controller.close()\n+        },\n+      })\n     }\n+\n     if (typeof this.response === 'string') {\n-      throw new Error('Invariant: static responses cannot be streamed')\n+      return streamFromString(this.response)\n     }\n \n     if (Buffer.isBuffer(this.response)) {"
        },
        {
            "sha": "bd39f87a12652aad0cf1b9b0e2b895492dfde7b9",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -51,6 +51,8 @@ import {\n   SERVER_PROPS_SSG_CONFLICT,\n   SSG_GET_INITIAL_PROPS_CONFLICT,\n   UNSTABLE_REVALIDATE_RENAME_ERROR,\n+  HTML_CONTENT_TYPE_HEADER,\n+  JSON_CONTENT_TYPE_HEADER,\n } from '../lib/constants'\n import {\n   NEXT_BUILTIN_DOCUMENT,\n@@ -1063,7 +1065,10 @@ export async function renderToHTMLImpl(\n \n     // this must come after revalidate is added to renderResultMeta\n     if (metadata.isNotFound) {\n-      return new RenderResult(null, { metadata })\n+      return new RenderResult(null, {\n+        metadata,\n+        contentType: null,\n+      })\n     }\n   }\n \n@@ -1179,7 +1184,10 @@ export async function renderToHTMLImpl(\n       }\n \n       metadata.isNotFound = true\n-      return new RenderResult(null, { metadata })\n+      return new RenderResult(null, {\n+        metadata,\n+        contentType: null,\n+      })\n     }\n \n     if ('redirect' in data && typeof data.redirect === 'object') {\n@@ -1229,6 +1237,7 @@ export async function renderToHTMLImpl(\n   if ((isNextDataRequest && !isSSG) || metadata.isRedirect) {\n     return new RenderResult(JSON.stringify(props), {\n       metadata,\n+      contentType: JSON_CONTENT_TYPE_HEADER,\n     })\n   }\n \n@@ -1239,7 +1248,7 @@ export async function renderToHTMLImpl(\n   }\n \n   // the response might be finished on the getInitialProps call\n-  if (isResSent(res) && !isSSG) return new RenderResult(null, { metadata })\n+  if (isResSent(res) && !isSSG) return RenderResult.EMPTY\n \n   // we preload the buildManifest for auto-export dynamic pages\n   // to speed up hydrating query values\n@@ -1453,7 +1462,10 @@ export async function renderToHTMLImpl(\n     async () => renderDocument()\n   )\n   if (!documentResult) {\n-    return new RenderResult(null, { metadata })\n+    return new RenderResult(null, {\n+      metadata,\n+      contentType: HTML_CONTENT_TYPE_HEADER,\n+    })\n   }\n \n   const dynamicImportsIds = new Set<string | number>()\n@@ -1608,7 +1620,10 @@ export async function renderToHTMLImpl(\n     hybridAmp,\n   })\n \n-  return new RenderResult(optimizedHtml, { metadata })\n+  return new RenderResult(optimizedHtml, {\n+    metadata,\n+    contentType: HTML_CONTENT_TYPE_HEADER,\n+  })\n }\n \n export type PagesRender = ("
        },
        {
            "sha": "16e2e641a4afa3468316e88e53d5db1ce64382ef",
            "filename": "packages/next/src/server/response-cache/utils.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -9,6 +9,7 @@ import {\n \n import RenderResult from '../render-result'\n import { RouteKind } from '../route-kind'\n+import { HTML_CONTENT_TYPE_HEADER } from '../../lib/constants'\n \n export async function fromResponseCacheEntry(\n   cacheEntry: ResponseCacheEntry\n@@ -51,15 +52,21 @@ export async function toResponseCacheEntry(\n       response.value?.kind === CachedRouteKind.PAGES\n         ? ({\n             kind: CachedRouteKind.PAGES,\n-            html: RenderResult.fromStatic(response.value.html),\n+            html: RenderResult.fromStatic(\n+              response.value.html,\n+              HTML_CONTENT_TYPE_HEADER\n+            ),\n             pageData: response.value.pageData,\n             headers: response.value.headers,\n             status: response.value.status,\n           } satisfies CachedPageValue)\n         : response.value?.kind === CachedRouteKind.APP_PAGE\n           ? ({\n               kind: CachedRouteKind.APP_PAGE,\n-              html: RenderResult.fromStatic(response.value.html),\n+              html: RenderResult.fromStatic(\n+                response.value.html,\n+                HTML_CONTENT_TYPE_HEADER\n+              ),\n               rscData: response.value.rscData,\n               headers: response.value.headers,\n               status: response.value.status,"
        },
        {
            "sha": "731b69b21b663e20749014dbc20b45786f054803",
            "filename": "packages/next/src/server/send-payload.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 15,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fsend-payload.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -6,7 +6,7 @@ import { isResSent } from '../shared/lib/utils'\n import { generateETag } from './lib/etag'\n import fresh from 'next/dist/compiled/fresh'\n import { getCacheControlHeader } from './lib/cache-control'\n-import { RSC_CONTENT_TYPE_HEADER } from '../client/components/app-router-headers'\n+import { HTML_CONTENT_TYPE_HEADER } from '../lib/constants'\n \n export function sendEtagResponse(\n   req: IncomingMessage,\n@@ -36,15 +36,13 @@ export async function sendRenderResult({\n   req,\n   res,\n   result,\n-  type,\n   generateEtags,\n   poweredByHeader,\n   cacheControl,\n }: {\n   req: IncomingMessage\n   res: ServerResponse\n   result: RenderResult\n-  type: 'html' | 'json' | 'rsc'\n   generateEtags: boolean\n   poweredByHeader: boolean\n   cacheControl: CacheControl | undefined\n@@ -53,7 +51,7 @@ export async function sendRenderResult({\n     return\n   }\n \n-  if (poweredByHeader && type === 'html') {\n+  if (poweredByHeader && result.contentType === HTML_CONTENT_TYPE_HEADER) {\n     res.setHeader('X-Powered-By', 'Next.js')\n   }\n \n@@ -72,17 +70,8 @@ export async function sendRenderResult({\n     }\n   }\n \n-  if (!res.getHeader('Content-Type')) {\n-    res.setHeader(\n-      'Content-Type',\n-      result.contentType\n-        ? result.contentType\n-        : type === 'rsc'\n-          ? RSC_CONTENT_TYPE_HEADER\n-          : type === 'json'\n-            ? 'application/json'\n-            : 'text/html; charset=utf-8'\n-    )\n+  if (!res.getHeader('Content-Type') && result.contentType) {\n+    res.setHeader('Content-Type', result.contentType)\n   }\n \n   if (payload) {"
        },
        {
            "sha": "949b8c5e93d919c11fcd886e84920a3e93bb3042",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -10,6 +10,7 @@ import {\n } from './uint8array-helpers'\n import { MISSING_ROOT_TAGS_ERROR } from '../../shared/lib/errors/constants'\n import { insertBuildIdComment } from '../../shared/lib/segment-cache/output-export-prefetch-encoding'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n function voidCatch() {\n   // this catcher is designed to be used with pipeTo where we expect the underlying\n@@ -32,7 +33,7 @@ export function chainStreams<T>(\n   // We could encode this invariant in the arguments but current uses of this function pass\n   // use spread so it would be missed by\n   if (streams.length === 0) {\n-    throw new Error('Invariant: chainStreams requires at least one stream')\n+    throw new InvariantError('chainStreams requires at least one stream')\n   }\n \n   // If we only have 1 stream we fast path it by returning just this stream"
        },
        {
            "sha": "1a7f6ea123888f9b6d87718e0f85c10511a69525",
            "filename": "packages/next/src/server/web-server.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 11,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb-server.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -35,6 +35,7 @@ import { getEdgeInstrumentationModule } from './web/globals'\n import type { ServerOnInstrumentationRequestError } from './app-render/types'\n import { getEdgePreviewProps } from './web/get-edge-preview-props'\n import { NoFallbackError } from '../shared/lib/no-fallback-error.external'\n+import { HTML_CONTENT_TYPE_HEADER } from '../lib/constants'\n \n interface WebServerOptions extends Options {\n   buildId: string\n@@ -258,7 +259,6 @@ export default class NextWebServer extends BaseServer<\n     res: WebNextResponse,\n     options: {\n       result: RenderResult\n-      type: 'html' | 'json'\n       generateEtags: boolean\n       poweredByHeader: boolean\n       cacheControl: CacheControl | undefined\n@@ -268,19 +268,15 @@ export default class NextWebServer extends BaseServer<\n \n     // Add necessary headers.\n     // @TODO: Share the isomorphic logic with server/send-payload.ts.\n-    if (options.poweredByHeader && options.type === 'html') {\n+    if (\n+      options.poweredByHeader &&\n+      options.result.contentType === HTML_CONTENT_TYPE_HEADER\n+    ) {\n       res.setHeader('X-Powered-By', 'Next.js')\n     }\n \n-    if (!res.getHeader('Content-Type')) {\n-      res.setHeader(\n-        'Content-Type',\n-        options.result.contentType\n-          ? options.result.contentType\n-          : options.type === 'json'\n-            ? 'application/json'\n-            : 'text/html; charset=utf-8'\n-      )\n+    if (!res.getHeader('Content-Type') && options.result.contentType) {\n+      res.setHeader('Content-Type', options.result.contentType)\n     }\n \n     let promise: Promise<void> | undefined"
        },
        {
            "sha": "749e1919ff98937ff8b33a25da1c2c50c39a7024",
            "filename": "test/e2e/app-dir/actions-unrecognized/actions-unrecognized.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -155,12 +155,16 @@ describe('unrecognized server actions', () => {\n             // We also don't seem to display the error page correctly,\n             // and the response is inconsistent between nodejs and edge.\n             expect(response.status()).toBe(runtime === 'nodejs' ? 405 : 500)\n-            expect(response.headers()['content-type']).toStartWith('text/html')\n+            expect(response.headers()['content-type']).toStartWith(\n+              runtime === 'nodejs' ? 'text/html' : 'text/plain'\n+            )\n           } else {\n             // FIXME: Currently, an unrecognized id in an MPA action results in a 500.\n             // This is not ideal, and ignores all nested `error.js` files, only showing the topmost one.\n             expect(response.status()).toBe(500)\n-            expect(response.headers()['content-type']).toStartWith('text/html')\n+            expect(response.headers()['content-type']).toStartWith(\n+              runtime === 'nodejs' ? 'text/html' : 'text/plain'\n+            )\n             // In dev, the 500 page doesn't have any SSR'd html, so it won't show anything without JS.\n             if (!isNextDev) {\n               expect(await browser.elementByCss('body').text()).toContain("
        },
        {
            "sha": "ff5d60147c755a9b5daa3e52209ed1a616bbce54",
            "filename": "test/e2e/i18n-data-route/i18n-data-route.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d56855041c23dca9f2383dbc88a57e7600255979/test%2Fe2e%2Fi18n-data-route%2Fi18n-data-route.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d56855041c23dca9f2383dbc88a57e7600255979/test%2Fe2e%2Fi18n-data-route%2Fi18n-data-route.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-data-route%2Fi18n-data-route.test.ts?ref=d56855041c23dca9f2383dbc88a57e7600255979",
            "patch": "@@ -54,7 +54,9 @@ describe('i18n-data-route', () => {\n \n           const res = await next.fetch(url)\n           expect(res.status).toBe(200)\n-          expect(res.headers.get('content-type')).toBe('application/json')\n+          expect(res.headers.get('content-type')).toStartWith(\n+            'application/json'\n+          )\n           const data = await res.json()\n           checkDataRoute(data, page)\n         }\n@@ -80,7 +82,7 @@ describe('i18n-data-route', () => {\n         }\n         const res = await next.fetch(url)\n         expect(res.status).toBe(200)\n-        expect(res.headers.get('content-type')).toBe('application/json')\n+        expect(res.headers.get('content-type')).toStartWith('application/json')\n         const data = await res.json()\n         checkDataRoute(data, page)\n       }"
        }
    ],
    "stats": {
        "total": 307,
        "additions": 186,
        "deletions": 121
    }
}