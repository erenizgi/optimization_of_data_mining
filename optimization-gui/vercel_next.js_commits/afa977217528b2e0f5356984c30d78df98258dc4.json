{
    "author": "mischnic",
    "message": "Turbopack: set env in tracing context (#75254)\n\nPart of PACK-4164\r\n\r\n~~Set `NODE_ENV` in tracing context~~ For that, see https://github.com/vercel/next.js/pull/75254#issuecomment-2627686346\r\nSet `TURBOPACK` in tracing context\r\n\r\nThis get rids of some constant build overhead (because we only analyze one instance of react-dom for NFT now, instead of all of the edge/server/client onces).\r\nOtherwise no measureable perf/memory impact",
    "sha": "afa977217528b2e0f5356984c30d78df98258dc4",
    "files": [
        {
            "sha": "b29e3945b334c1fe40670487b6f0119a9f070c48",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 53,
            "deletions": 3,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/afa977217528b2e0f5356984c30d78df98258dc4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa977217528b2e0f5356984c30d78df98258dc4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=afa977217528b2e0f5356984c30d78df98258dc4",
            "patch": "@@ -8,8 +8,8 @@ use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n     css::chunk::CssChunkType,\n     module_options::{\n-        CssOptionsContext, EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext,\n-        ModuleRule, TypeofWindow, TypescriptTransformOptions,\n+        CssOptionsContext, EcmascriptOptionsContext, ExternalsTracingOptions, JsxTransformOptions,\n+        ModuleOptionsContext, ModuleRule, TypeofWindow, TypescriptTransformOptions,\n     },\n     resolve_options_context::ResolveOptionsContext,\n     transition::Transition,\n@@ -19,6 +19,7 @@ use turbopack_core::{\n         ChunkingConfig, MangleType, MinifyType, SourceMapsType,\n         module_id_strategies::ModuleIdStrategy,\n     },\n+    compile_time_defines,\n     compile_time_info::{CompileTimeDefines, CompileTimeInfo, FreeVarReferences},\n     environment::{\n         Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion, RuntimeVersions,\n@@ -387,6 +388,49 @@ pub async fn get_server_compile_time_info(\n     .await\n }\n \n+#[turbo_tasks::function]\n+pub async fn get_tracing_compile_time_info() -> Result<Vc<CompileTimeInfo>> {\n+    CompileTimeInfo::builder(\n+        Environment::new(ExecutionEnvironment::NodeJsLambda(\n+            NodeJsEnvironment::default().resolved_cell(),\n+        ))\n+        .to_resolved()\n+        .await?,\n+    )\n+    /*\n+    We'd really like to set `process.env.NODE_ENV = \"production\"` here, but with that,\n+    `react/cjs/react.development.js` won't be copied anymore (as expected).\n+    However if you `import` react from native ESM: `import {createContext} from 'react';`, it fails with\n+    ```\n+    import {createContext} from 'react';\n+            ^^^^^^^^^^^^^\n+    SyntaxError: Named export 'createContext' not found. The requested module 'react' is a CommonJS module, which may not support all module.exports as named exports.\n+    CommonJS modules can always be imported via the default export, for example using:\n+    ```\n+    This is because Node's import-cjs-from-esm feature can correctly find all named exports in\n+    ```\n+    // `react/index.js`\n+    if (process.env.NODE_ENV === 'production') {\n+      module.exports = require('./cjs/react.production.js');\n+    } else {\n+      module.exports = require('./cjs/react.development.js');\n+    }\n+    ```\n+    if both files exist (which is what's happening so far).\n+    If `react.development.js` doesn't exist, then it bails with that error message.\n+    Also just removing that second branch works fine, but a `require` to a non-existent file fails.\n+    */\n+    .defines(\n+        compile_time_defines!(\n+            process.env.TURBOPACK = true,\n+            // process.env.NODE_ENV = \"production\",\n+        )\n+        .resolved_cell(),\n+    )\n+    .cell()\n+    .await\n+}\n+\n #[turbo_tasks::function]\n pub async fn get_server_module_options_context(\n     project_path: FileSystemPath,\n@@ -544,7 +588,13 @@ pub async fn get_server_module_options_context(\n         tree_shaking_mode: tree_shaking_mode_for_user_code,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n         enable_externals_tracing: if next_mode.is_production() {\n-            Some(project_path)\n+            Some(\n+                ExternalsTracingOptions {\n+                    tracing_root: project_path,\n+                    compile_time_info: get_tracing_compile_time_info().to_resolved().await?,\n+                }\n+                .resolved_cell(),\n+            )\n         } else {\n             None\n         },"
        },
        {
            "sha": "eebe8672d570a9be025810a0cec67b6962f8c3b3",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 15,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/afa977217528b2e0f5356984c30d78df98258dc4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa977217528b2e0f5356984c30d78df98258dc4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=afa977217528b2e0f5356984c30d78df98258dc4",
            "patch": "@@ -34,7 +34,6 @@ use turbopack_core::{\n     chunk::SourceMapsType,\n     compile_time_info::CompileTimeInfo,\n     context::{AssetContext, ProcessResult},\n-    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n     ident::Layer,\n     issue::{IssueExt, IssueSource, StyledString, module::ModuleIssue},\n     module::Module,\n@@ -643,15 +642,12 @@ async fn process_default_internal(\n }\n \n #[turbo_tasks::function]\n-async fn externals_tracing_module_context(ty: ExternalType) -> Result<Vc<ModuleAssetContext>> {\n-    let env = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-        NodeJsEnvironment::default().resolved_cell(),\n-    ))\n-    .to_resolved()\n-    .await?;\n-\n+async fn externals_tracing_module_context(\n+    ty: ExternalType,\n+    compile_time_info: Vc<CompileTimeInfo>,\n+) -> Result<Vc<ModuleAssetContext>> {\n     let resolve_options = ResolveOptionsContext {\n-        emulate_environment: Some(env),\n+        emulate_environment: Some(compile_time_info.await?.environment),\n         loose_errors: true,\n         custom_conditions: match ty {\n             ExternalType::CommonJs => vec![rcstr!(\"require\")],\n@@ -663,7 +659,7 @@ async fn externals_tracing_module_context(ty: ExternalType) -> Result<Vc<ModuleA\n \n     Ok(ModuleAssetContext::new_without_replace_externals(\n         Default::default(),\n-        CompileTimeInfo::builder(env).cell().await?,\n+        compile_time_info,\n         // Keep these options more or less in sync with\n         // turbopack/crates/turbopack/tests/node-file-trace.rs to ensure that the NFT unit tests\n         // are actually representative of what Turbopack does.\n@@ -784,7 +780,7 @@ impl AssetContext for ModuleAssetContext {\n                         ResolveResultItem::External { name, ty, traced } => {\n                             let replacement = if replace_externals {\n                                 let tracing_mode = if traced == ExternalTraced::Traced\n-                                    && let Some(tracing_root) = &self\n+                                    && let Some(options) = &self\n                                         .module_options_context()\n                                         .await?\n                                         .enable_externals_tracing\n@@ -793,13 +789,17 @@ impl AssetContext for ModuleAssetContext {\n                                     // request will later be resolved relative to tracing_root\n                                     // anyway.\n \n+                                    let options = options.await?;\n                                     CachedExternalTracingMode::Traced {\n                                         externals_context: ResolvedVc::upcast(\n-                                            externals_tracing_module_context(ty)\n-                                                .to_resolved()\n-                                                .await?,\n+                                            externals_tracing_module_context(\n+                                                ty,\n+                                                *options.compile_time_info,\n+                                            )\n+                                            .to_resolved()\n+                                            .await?,\n                                         ),\n-                                        root_origin: tracing_root.join(\"_\")?,\n+                                        root_origin: options.tracing_root.join(\"_\")?,\n                                     }\n                                 } else {\n                                     CachedExternalTracingMode::Untraced"
        },
        {
            "sha": "3f968f2b2a5c048932a67d0b4e91061b6ad0e976",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/afa977217528b2e0f5356984c30d78df98258dc4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa977217528b2e0f5356984c30d78df98258dc4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=afa977217528b2e0f5356984c30d78df98258dc4",
            "patch": "@@ -6,8 +6,8 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{FxIndexMap, NonLocalValue, ResolvedVc, ValueDefault, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n-    chunk::SourceMapsType, condition::ContextCondition, environment::Environment,\n-    resolve::options::ImportMapping,\n+    chunk::SourceMapsType, compile_time_info::CompileTimeInfo, condition::ContextCondition,\n+    environment::Environment, resolve::options::ImportMapping,\n };\n use turbopack_ecmascript::{TreeShakingMode, references::esm::UrlRewriteBehavior};\n pub use turbopack_mdx::MdxTransformOptions;\n@@ -121,7 +121,6 @@ impl ValueDefault for TypescriptTransformOptions {\n     }\n }\n \n-// [TODO]: should enabled_react_refresh belong to this options?\n #[turbo_tasks::value(shared)]\n #[derive(Default, Clone, Debug)]\n pub struct JsxTransformOptions {\n@@ -131,6 +130,14 @@ pub struct JsxTransformOptions {\n     pub runtime: Option<RcStr>,\n }\n \n+#[turbo_tasks::value(shared)]\n+#[derive(Clone, Debug)]\n+pub struct ExternalsTracingOptions {\n+    /// The directory from which the bundled files will require the externals at runtime.\n+    pub tracing_root: FileSystemPath,\n+    pub compile_time_info: ResolvedVc<CompileTimeInfo>,\n+}\n+\n #[turbo_tasks::value(shared)]\n #[derive(Clone, Default)]\n #[serde(default)]\n@@ -152,10 +159,7 @@ pub struct ModuleOptionsContext {\n \n     /// Generate (non-emitted) output assets for static assets and externals, to facilitate\n     /// generating a list of all non-bundled files that will be required at runtime.\n-    ///\n-    /// The filepath is the directory from which the bundled files will require the externals at\n-    /// runtime.\n-    pub enable_externals_tracing: Option<FileSystemPath>,\n+    pub enable_externals_tracing: Option<ResolvedVc<ExternalsTracingOptions>>,\n \n     /// If true, it stores the last successful parse result in state and keeps using it when\n     /// parsing fails. This is useful to keep the module graph structure intact when syntax errors"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 79,
        "deletions": 25
    }
}