{
    "author": "eps1lon",
    "message": "Check for visibility not just existence of Redbox (#75846)",
    "sha": "0466204a541df6bc7b5ad06eb9a32aea02a957dc",
    "files": [
        {
            "sha": "1fcee32e3a4f953276060185b1ed621f0e194404",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0466204a541df6bc7b5ad06eb9a32aea02a957dc/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0466204a541df6bc7b5ad06eb9a32aea02a957dc/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=0466204a541df6bc7b5ad06eb9a32aea02a957dc",
            "patch": "@@ -9,6 +9,7 @@ import {\n   Page,\n   ElementHandle,\n   devices,\n+  Locator,\n } from 'playwright'\n import path from 'path'\n \n@@ -516,4 +517,10 @@ export class Playwright extends BrowserInterface {\n       return page.waitForLoadState('networkidle')\n     })\n   }\n+\n+  locateRedbox(): Locator {\n+    return page.locator(\n+      'nextjs-portal [aria-labelledby=\"nextjs__container_errors_label\"]'\n+    )\n+  }\n }"
        },
        {
            "sha": "110f64959204483b460e48f1854353ea637d57c7",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 56,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/0466204a541df6bc7b5ad06eb9a32aea02a957dc/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0466204a541df6bc7b5ad06eb9a32aea02a957dc/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=0466204a541df6bc7b5ad06eb9a32aea02a957dc",
            "patch": "@@ -27,6 +27,7 @@ import type { SpawnOptions, ChildProcess } from 'child_process'\n import type { RequestInit, Response } from 'node-fetch'\n import type { NextServer } from 'next/dist/server/next'\n import { BrowserInterface } from './browsers/base'\n+import { Playwright } from './browsers/playwright'\n \n import { getTurbopackFlag, shouldRunTurboDevTest } from './turbo'\n import stripAnsi from 'strip-ansi'\n@@ -821,73 +822,48 @@ export async function retry<T>(\n   }\n }\n \n-async function ensureNoSuspendedComponentsInRedBox(browser: BrowserInterface) {\n-  await retry(async () => {\n-    const suspended = await browser.eval(() => {\n-      return Boolean(\n-        [].slice\n-          .call(document.querySelectorAll('nextjs-portal'))\n-          .find((p) =>\n-            p.shadowRoot.querySelector('[data-nextjs-error-suspended]')\n-          )\n-      )\n-    })\n-    expect(suspended).toBe(false)\n-  }, 10000)\n-}\n-\n export async function assertHasRedbox(browser: BrowserInterface) {\n-  try {\n-    await retry(\n-      async () => {\n-        const hasRedbox = await browser.eval(() => {\n-          return Boolean(\n-            [].slice\n-              .call(document.querySelectorAll('nextjs-portal'))\n-              .find((p) =>\n-                p.shadowRoot.querySelector(\n-                  '#nextjs__container_errors_label, #nextjs__container_errors_label'\n-                )\n-              )\n-          )\n-        })\n-        expect(hasRedbox).toBe(true)\n-      },\n-      5000,\n-      200\n-    )\n+  // TODO: Implement for other BrowserInterface implementations\n+  const playwright = browser as Playwright\n \n-    await ensureNoSuspendedComponentsInRedBox(browser)\n+  const redbox = playwright.locateRedbox()\n+  try {\n+    await redbox.waitFor({ timeout: 5000 })\n   } catch (errorCause) {\n-    const error = new Error('Expected Redbox but found none')\n+    const error = new Error('Expected Redbox but found no visible one.')\n+    Error.captureStackTrace(error, assertHasRedbox)\n+    throw error\n+  }\n+\n+  try {\n+    await redbox\n+      .locator('[data-nextjs-error-suspended]')\n+      .waitFor({ state: 'detached', timeout: 10000 })\n+  } catch (cause) {\n+    const error = new Error('Redbox still had suspended content after 10s', {\n+      cause,\n+    })\n     Error.captureStackTrace(error, assertHasRedbox)\n     throw error\n   }\n }\n \n export async function assertNoRedbox(browser: BrowserInterface) {\n+  // TODO: Implement for other BrowserInterface implementations\n+  const playwright = browser as Playwright\n+\n   await waitFor(5000)\n-  const hasRedbox = await browser.eval(() => {\n-    return Boolean(\n-      [].slice\n-        .call(document.querySelectorAll('nextjs-portal'))\n-        .find((p) =>\n-          p.shadowRoot.querySelector(\n-            '#nextjs__container_errors_label, #nextjs__container_errors_label'\n-          )\n-        )\n-    )\n-  })\n+  const redbox = playwright.locateRedbox()\n \n-  if (hasRedbox) {\n+  if (await redbox.isVisible()) {\n     const [redboxHeader, redboxDescription, redboxSource] = await Promise.all([\n       getRedboxHeader(browser).catch(() => '<missing>'),\n       getRedboxDescription(browser).catch(() => '<missing>'),\n       getRedboxSource(browser).catch(() => '<missing>'),\n     ])\n \n     const error = new Error(\n-      'Expected no Redbox but found one\\n' +\n+      'Expected no visible Redbox but found one\\n' +\n         `header: ${redboxHeader}\\n` +\n         `description: ${redboxDescription}\\n` +\n         `source: ${redboxSource}`\n@@ -934,10 +910,21 @@ export async function getToastErrorCount(\n  * Success implies {@link assertHasRedbox}.\n  */\n export async function openRedbox(browser: BrowserInterface): Promise<void> {\n+  // TODO: Implement for other BrowserInterface implementations\n+  const playwright = browser as Playwright\n+  const redbox = playwright.locateRedbox()\n+  if (await redbox.isVisible()) {\n+    const error = new Error(\n+      'Redbox is already open. Use `assertHasRedbox` instead.'\n+    )\n+    Error.captureStackTrace(error, openRedbox)\n+    throw error\n+  }\n+\n   try {\n     await browser.waitForElementByCss('[data-issues]').click()\n   } catch (cause) {\n-    const error = new Error('No Redbox to open.', { cause })\n+    const error = new Error('Redbox did not open.')\n     Error.captureStackTrace(error, openRedbox)\n     throw error\n   }\n@@ -1036,8 +1023,6 @@ export async function getRedboxTotalErrorCount(\n }\n \n export async function getRedboxSource(browser: BrowserInterface) {\n-  await ensureNoSuspendedComponentsInRedBox(browser)\n-\n   return browser.eval(() => {\n     const portal = [].slice\n       .call(document.querySelectorAll('nextjs-portal'))\n@@ -1344,7 +1329,6 @@ export async function getRedboxComponentStack(\n }\n \n export async function hasRedboxCallStack(browser: BrowserInterface) {\n-  await ensureNoSuspendedComponentsInRedBox(browser)\n   return browser.eval(() => {\n     const portal = [].slice\n       .call(document.querySelectorAll('nextjs-portal'))\n@@ -1358,7 +1342,6 @@ export async function hasRedboxCallStack(browser: BrowserInterface) {\n export async function getRedboxCallStack(\n   browser: BrowserInterface\n ): Promise<string | null> {\n-  await ensureNoSuspendedComponentsInRedBox(browser)\n   const callStackFrameElements = await browser.elementsByCss(\n     '[data-nextjs-call-stack-frame]'\n   )\n@@ -1372,7 +1355,6 @@ export async function getRedboxCallStack(\n export async function getRedboxCallStackCollapsed(\n   browser: BrowserInterface\n ): Promise<string> {\n-  await ensureNoSuspendedComponentsInRedBox(browser)\n   const callStackFrameElements = await browser.elementsByCss(\n     '.nextjs-container-errors-body > [data-nextjs-codeframe] > :first-child, ' +\n       '.nextjs-container-errors-body > [data-nextjs-call-stack-frame], ' +\n@@ -1594,7 +1576,6 @@ export const checkLink = (\n ) => checkMeta(browser, rel, content, 'rel', 'link', 'href')\n \n export async function getStackFramesContent(browser) {\n-  await ensureNoSuspendedComponentsInRedBox(browser)\n   const stackFrameElements = await browser.elementsByCss(\n     '[data-nextjs-call-stack-frame]'\n   )"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 44,
        "deletions": 56
    }
}