{
    "author": "devjiwonchoi",
    "message": "[dev-overlay] hide dev indicator for server session or 1 day (#76430)\n\n### Why?\n\nWhen users want to hide the dev indicator, they might be frustrated if\nit reappears every reload. Hence, make a default to hide it for the\ncurrent server session or a day.\n\nCloses NDX-890\n\n---------\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
    "files": [
        {
            "sha": "dbcc199dd45015e5f142bfe6c663fea539e7b5b7",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -15,6 +15,7 @@ import {\n   ACTION_BUILD_ERROR,\n   ACTION_BUILD_OK,\n   ACTION_DEBUG_INFO,\n+  ACTION_DEV_INDICATOR,\n   ACTION_REFRESH,\n   ACTION_STATIC_INDICATOR,\n   ACTION_UNHANDLED_ERROR,\n@@ -48,6 +49,7 @@ import { getReactStitchedError } from '../../errors/stitched-error'\n import { shouldRenderRootLevelErrorOverlay } from '../../../lib/is-error-thrown-while-rendering-rsc'\n import { handleDevBuildIndicatorHmrEvents } from '../../../dev/dev-build-indicator/internal/handle-dev-build-indicator-hmr-events'\n import type { GlobalErrorComponent } from '../../error-boundary'\n+import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n \n export interface Dispatcher {\n   onBuildOk(): void\n@@ -57,6 +59,7 @@ export interface Dispatcher {\n   onBeforeRefresh(): void\n   onRefresh(): void\n   onStaticIndicator(status: boolean): void\n+  onDevIndicator(devIndicator: DevIndicatorServerState): void\n }\n \n let mostRecentCompilationHash: any = null\n@@ -379,6 +382,7 @@ function processMessage(\n       // Is undefined when it's a 'built' event\n       if ('versionInfo' in obj) dispatcher.onVersionInfo(obj.versionInfo)\n       if ('debug' in obj && obj.debug) dispatcher.onDebugInfo(obj.debug)\n+      if ('devIndicator' in obj) dispatcher.onDevIndicator(obj.devIndicator)\n \n       const hasErrors = Boolean(errors && errors.length)\n       // Compilation with errors (e.g. syntax error or missing modules).\n@@ -566,6 +570,12 @@ export default function HotReload({\n       onDebugInfo(debugInfo) {\n         dispatch({ type: ACTION_DEBUG_INFO, debugInfo })\n       },\n+      onDevIndicator(devIndicator) {\n+        dispatch({\n+          type: ACTION_DEV_INDICATOR,\n+          devIndicator,\n+        })\n+      },\n     }\n   }, [dispatch])\n "
        },
        {
            "sha": "e80f796971166ef9292887e5729de4db7546baa3",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/client.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -9,6 +9,7 @@ import {\n   ACTION_BEFORE_REFRESH,\n   ACTION_BUILD_ERROR,\n   ACTION_BUILD_OK,\n+  ACTION_DEV_INDICATOR,\n   ACTION_REFRESH,\n   ACTION_STATIC_INDICATOR,\n   ACTION_UNHANDLED_ERROR,\n@@ -17,6 +18,7 @@ import {\n } from '../shared'\n import type { VersionInfo } from '../../../../server/dev/parse-version-info'\n import { attachHydrationErrorState } from '../../errors/attach-hydration-error-state'\n+import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n \n let isRegistered = false\n let stackTraceLimit: number | undefined = undefined\n@@ -143,5 +145,9 @@ export function onStaticIndicator(isStatic: boolean) {\n   Bus.emit({ type: ACTION_STATIC_INDICATOR, staticIndicator: isStatic })\n }\n \n+export function onDevIndicator(devIndicatorsState: DevIndicatorServerState) {\n+  Bus.emit({ type: ACTION_DEV_INDICATOR, devIndicator: devIndicatorsState })\n+}\n+\n export { getErrorByType } from '../utils/get-error-by-type'\n export { getServerError } from '../utils/node-stack-frames'"
        },
        {
            "sha": "9c7a04579a8c69f02c890c3184670ddcc464d5db",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hot-reloader-client.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -36,6 +36,7 @@ import {\n   onRefresh,\n   onVersionInfo,\n   onStaticIndicator,\n+  onDevIndicator,\n } from './client'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import { addMessageListener, sendMessage } from './websocket'\n@@ -318,6 +319,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n \n       // Is undefined when it's a 'built' event\n       if ('versionInfo' in obj) onVersionInfo(obj.versionInfo)\n+      if ('devIndicator' in obj) onDevIndicator(obj.devIndicator)\n \n       const hasErrors = Boolean(errors && errors.length)\n       if (hasErrors) {"
        },
        {
            "sha": "86168441604f04c0d801354af4c952576b0ef363",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-response.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -6,13 +6,17 @@ export const middlewareResponse = {\n     res.statusCode = 204\n     res.end('No Content')\n   },\n+  badRequest(res: ServerResponse) {\n+    res.statusCode = 400\n+    res.end('Bad Request')\n+  },\n   notFound(res: ServerResponse) {\n     res.statusCode = 404\n     res.end('Not Found')\n   },\n-  badRequest(res: ServerResponse) {\n-    res.statusCode = 400\n-    res.end('Bad Request')\n+  methodNotAllowed(res: ServerResponse) {\n+    res.statusCode = 405\n+    res.end('Method Not Allowed')\n   },\n   internalServerError(res: ServerResponse, error?: unknown) {\n     res.statusCode = 500"
        },
        {
            "sha": "c7da8d51777cccb8c67d64f76373dc2f07cb1faa",
            "filename": "packages/next/src/client/components/react-dev-overlay/shared.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -5,6 +5,7 @@ import type { VersionInfo } from '../../../server/dev/parse-version-info'\n import type { SupportedErrorEvent } from './ui/container/runtime-error/render-error'\n import type { ComponentStackFrame } from './utils/parse-component-stack'\n import type { DebugInfo } from './types'\n+import type { DevIndicatorServerState } from '../../../server/dev/dev-indicator-server-state'\n \n type FastRefreshState =\n   /** No refresh in progress. */\n@@ -35,6 +36,7 @@ export const ACTION_VERSION_INFO = 'version-info'\n export const ACTION_UNHANDLED_ERROR = 'unhandled-error'\n export const ACTION_UNHANDLED_REJECTION = 'unhandled-rejection'\n export const ACTION_DEBUG_INFO = 'debug-info'\n+export const ACTION_DEV_INDICATOR = 'dev-indicator'\n \n interface StaticIndicatorAction {\n   type: typeof ACTION_STATIC_INDICATOR\n@@ -78,6 +80,11 @@ interface VersionInfoAction {\n   versionInfo: VersionInfo\n }\n \n+interface DevIndicatorAction {\n+  type: typeof ACTION_DEV_INDICATOR\n+  devIndicator: DevIndicatorServerState\n+}\n+\n export type BusEvent =\n   | BuildOkAction\n   | BuildErrorAction\n@@ -88,6 +95,7 @@ export type BusEvent =\n   | VersionInfoAction\n   | StaticIndicatorAction\n   | DebugInfoAction\n+  | DevIndicatorAction\n \n function pushErrorFilterDuplicates(\n   errors: SupportedErrorEvent[],\n@@ -102,13 +110,17 @@ function pushErrorFilterDuplicates(\n   ]\n }\n \n+const shouldDisableDevIndicator =\n+  process.env.__NEXT_DEV_INDICATOR?.toString() === 'false'\n+\n export const INITIAL_OVERLAY_STATE: Omit<OverlayState, 'routerType'> = {\n   nextId: 1,\n   buildError: null,\n   errors: [],\n   notFound: false,\n   staticIndicator: false,\n-  disableDevIndicator: process.env.__NEXT_DEV_INDICATOR?.toString() === 'false',\n+  // To prevent flickering, set the initial state to disabled.\n+  disableDevIndicator: true,\n   refreshState: { type: 'idle' },\n   rootLayoutMissingTags: [],\n   versionInfo: { installed: '0.0.0', staleness: 'unknown' },\n@@ -194,6 +206,13 @@ export function useErrorOverlayReducer(routerType: 'pages' | 'app') {\n       case ACTION_VERSION_INFO: {\n         return { ..._state, versionInfo: action.versionInfo }\n       }\n+      case ACTION_DEV_INDICATOR: {\n+        return {\n+          ..._state,\n+          disableDevIndicator:\n+            shouldDisableDevIndicator || !!action.devIndicator.disabledUntil,\n+        }\n+      }\n       default: {\n         return _state\n       }"
        },
        {
            "sha": "8b5153779c943636e54d7cf4835c11d1ee3fd169",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -47,6 +47,9 @@ export function DevToolsIndicator({\n       isStaticRoute={state.staticIndicator}\n       hide={() => {\n         setIsDevToolsIndicatorVisible(false)\n+        fetch('/__nextjs_disable_dev_indicator', {\n+          method: 'POST',\n+        })\n       }}\n       setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n       isTurbopack={!!process.env.TURBOPACK}\n@@ -380,7 +383,7 @@ function DevToolsPopover({\n               <MenuItem\n                 data-hide-dev-tools\n                 title=\"Hide Dev Tools for the current server session or a day.\"\n-                label=\"Hide Dev Tools\"\n+                label=\"Hide for Dev Session\"\n                 value={<StopIcon />}\n                 onClick={hide}\n                 index={isTurbopack ? 2 : 3}"
        },
        {
            "sha": "389a8a892c69c2b3f8e4964e76857c645cf5c2d9",
            "filename": "packages/next/src/server/dev/dev-indicator-middleware.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-middleware.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -0,0 +1,41 @@\n+import type { ServerResponse, IncomingMessage } from 'http'\n+import { middlewareResponse } from '../../client/components/react-dev-overlay/server/middleware-response'\n+import * as Log from '../../build/output/log'\n+import { devIndicatorServerState } from './dev-indicator-server-state'\n+\n+const DISABLE_DEV_INDICATOR_PREFIX = '/__nextjs_disable_dev_indicator'\n+\n+const COOLDOWN_TIME_MS = process.env.__NEXT_DEV_INDICATOR_COOLDOWN_MS\n+  ? parseInt(process.env.__NEXT_DEV_INDICATOR_COOLDOWN_MS)\n+  : // 1 day from now\n+    1000 * 60 * 60 * 24\n+\n+export function getDisableDevIndicatorMiddleware() {\n+  return async function disableDevIndicatorMiddleware(\n+    req: IncomingMessage,\n+    res: ServerResponse,\n+    next: () => void\n+  ): Promise<void> {\n+    try {\n+      const { pathname } = new URL(`http://n${req.url}`)\n+\n+      if (!pathname.startsWith(DISABLE_DEV_INDICATOR_PREFIX)) {\n+        return next()\n+      }\n+\n+      if (req.method !== 'POST') {\n+        return middlewareResponse.methodNotAllowed(res)\n+      }\n+\n+      devIndicatorServerState.disabledUntil = Date.now() + COOLDOWN_TIME_MS\n+\n+      return middlewareResponse.noContent(res)\n+    } catch (err) {\n+      Log.error(\n+        'Failed to disable the dev indicator:',\n+        err instanceof Error ? err.message : err\n+      )\n+      return middlewareResponse.internalServerError(res)\n+    }\n+  }\n+}"
        },
        {
            "sha": "9ff1eb5fd44ee8798b802c57766519f04e1e25f9",
            "filename": "packages/next/src/server/dev/dev-indicator-server-state.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-server-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-server-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdev-indicator-server-state.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -0,0 +1,5 @@\n+export type DevIndicatorServerState = typeof devIndicatorServerState\n+\n+export const devIndicatorServerState = {\n+  disabledUntil: 0,\n+}"
        },
        {
            "sha": "469b3a615d77adaab11b64ae86628165a08a9b8f",
            "filename": "packages/next/src/server/dev/hot-middleware.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -27,6 +27,7 @@ import { isMiddlewareFilename } from '../../build/utils'\n import type { VersionInfo } from './parse-version-info'\n import type { HMR_ACTION_TYPES } from './hot-reloader-types'\n import { HMR_ACTIONS_SENT_TO_BROWSER } from './hot-reloader-types'\n+import { devIndicatorServerState } from './dev-indicator-server-state'\n \n function isMiddlewareStats(stats: webpack.Stats) {\n   for (const key of stats.compilation.entrypoints.keys()) {\n@@ -202,6 +203,10 @@ export class WebpackHotMiddleware {\n       const stats = statsToJson(syncStats)\n       const middlewareStats = statsToJson(this.middlewareLatestStats?.stats)\n \n+      if (devIndicatorServerState.disabledUntil < Date.now()) {\n+        devIndicatorServerState.disabledUntil = 0\n+      }\n+\n       this.publish({\n         action: HMR_ACTIONS_SENT_TO_BROWSER.SYNC,\n         hash: stats.hash!,\n@@ -214,6 +219,7 @@ export class WebpackHotMiddleware {\n         debug: {\n           devtoolsFrontendUrl: this.devtoolsFrontendUrl,\n         },\n+        devIndicator: devIndicatorServerState,\n       })\n     }\n   }"
        },
        {
            "sha": "4b9029c9a6d58c9cd49f9daf4617d86b9f365ab0",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -95,6 +95,8 @@ import {\n   type TopLevelIssuesMap,\n } from '../../shared/lib/turbopack/utils'\n import { getDevOverlayFontMiddleware } from '../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware'\n+import { devIndicatorServerState } from './dev-indicator-server-state'\n+import { getDisableDevIndicatorMiddleware } from './dev-indicator-middleware'\n // import { getSupportedBrowsers } from '../../build/utils'\n \n const wsServer = new ws.Server({ noServer: true })\n@@ -636,6 +638,7 @@ export async function createHotReloaderTurbopack(\n     getSourceMapMiddleware(project),\n     getNextErrorFeedbackMiddleware(opts.telemetry),\n     getDevOverlayFontMiddleware(),\n+    getDisableDevIndicatorMiddleware(),\n   ]\n \n   const versionInfoPromise = getVersionInfo()\n@@ -824,6 +827,10 @@ export async function createHotReloaderTurbopack(\n           }\n         }\n \n+        if (devIndicatorServerState.disabledUntil < Date.now()) {\n+          devIndicatorServerState.disabledUntil = 0\n+        }\n+\n         ;(async function () {\n           const versionInfo = await versionInfoPromise\n \n@@ -836,6 +843,7 @@ export async function createHotReloaderTurbopack(\n             debug: {\n               devtoolsFrontendUrl,\n             },\n+            devIndicator: devIndicatorServerState,\n           }\n \n           sendToClient(client, sync)"
        },
        {
            "sha": "283fbf53304f673a547d84c681ccc295f89a0d36",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -7,6 +7,7 @@ import type { RouteDefinition } from '../route-definitions/route-definition'\n import type { Project, Update as TurbopackUpdate } from '../../build/swc/types'\n import type { VersionInfo } from './parse-version-info'\n import type { DebugInfo } from '../../client/components/react-dev-overlay/types'\n+import type { DevIndicatorServerState } from './dev-indicator-server-state'\n \n export const enum HMR_ACTIONS_SENT_TO_BROWSER {\n   ADDED_PAGE = 'addedPage',\n@@ -24,6 +25,7 @@ export const enum HMR_ACTIONS_SENT_TO_BROWSER {\n   SERVER_ERROR = 'serverError',\n   TURBOPACK_CONNECTED = 'turbopack-connected',\n   ISR_MANIFEST = 'isrManifest',\n+  DEV_INDICATOR = 'devIndicator',\n }\n \n interface ServerErrorAction {\n@@ -55,6 +57,7 @@ export interface SyncAction {\n   versionInfo: VersionInfo\n   updatedModules?: ReadonlyArray<string>\n   debug?: DebugInfo\n+  devIndicator: DevIndicatorServerState\n }\n interface BuiltAction {\n   action: HMR_ACTIONS_SENT_TO_BROWSER.BUILT\n@@ -116,6 +119,11 @@ export interface AppIsrManifestAction {\n   data: Record<string, boolean>\n }\n \n+export interface DevIndicatorAction {\n+  action: HMR_ACTIONS_SENT_TO_BROWSER.DEV_INDICATOR\n+  devIndicator: DevIndicatorServerState\n+}\n+\n export type HMR_ACTION_TYPES =\n   | TurbopackMessageAction\n   | TurbopackConnectedAction\n@@ -132,6 +140,7 @@ export type HMR_ACTION_TYPES =\n   | DevPagesManifestUpdateAction\n   | ServerErrorAction\n   | AppIsrManifestAction\n+  | DevIndicatorAction\n \n export type TurbopackMsgToBrowser =\n   | { type: HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE; data: any }"
        },
        {
            "sha": "25cefba1d35d8cf3e639a3845503e16b1f8ab33f",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -85,6 +85,7 @@ import { FAST_REFRESH_RUNTIME_RELOAD } from './messages'\n import { getNodeDebugType } from '../lib/utils'\n import { getNextErrorFeedbackMiddleware } from '../../client/components/react-dev-overlay/server/get-next-error-feedback-middleware'\n import { getDevOverlayFontMiddleware } from '../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware'\n+import { getDisableDevIndicatorMiddleware } from './dev-indicator-middleware'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -1549,6 +1550,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       }),\n       getNextErrorFeedbackMiddleware(this.telemetry),\n       getDevOverlayFontMiddleware(),\n+      getDisableDevIndicatorMiddleware(),\n     ]\n   }\n "
        },
        {
            "sha": "0571ab1f778c2f42cfeb1ffa2ca50f7a015a2f30",
            "filename": "test/development/app-dir/dev-indicator/hide-button.test.ts",
            "status": "added",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Fhide-button.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Fhide-button.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdev-indicator%2Fhide-button.test.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -0,0 +1,64 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import {\n+  assertHasDevToolsIndicator,\n+  assertNoDevToolsIndicator,\n+  openDevToolsIndicatorPopover,\n+  waitFor,\n+} from 'next-test-utils'\n+\n+const COOLDOWN = 3000\n+\n+describe('dev indicator - Hide DevTools Button', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    env: {\n+      __NEXT_DEV_INDICATOR_COOLDOWN_MS: `${COOLDOWN}`,\n+    },\n+  })\n+\n+  it('should show the dev indicator when the server is manually restarted', async () => {\n+    const browser = await next.browser('/')\n+\n+    await openDevToolsIndicatorPopover(browser)\n+    await browser.elementByCss('[data-hide-dev-tools]').click()\n+\n+    await assertNoDevToolsIndicator(browser)\n+\n+    await next.stop()\n+    await next.start()\n+\n+    const browser2 = await next.browser('/')\n+    await browser2.refresh()\n+    await assertHasDevToolsIndicator(browser2)\n+  })\n+\n+  it('should still hide the dev indicator after reloading the page', async () => {\n+    const browser = await next.browser('/')\n+\n+    await openDevToolsIndicatorPopover(browser)\n+    await browser.elementByCss('[data-hide-dev-tools]').click()\n+\n+    await assertNoDevToolsIndicator(browser)\n+    await browser.refresh()\n+    // Still hidden after reload\n+    await assertNoDevToolsIndicator(browser)\n+  })\n+\n+  it('should show the dev indicator after cooldown period has passed', async () => {\n+    await next.stop()\n+    await next.start()\n+\n+    const browser = await next.browser('/')\n+\n+    await openDevToolsIndicatorPopover(browser)\n+    await browser.elementByCss('[data-hide-dev-tools]').click()\n+\n+    await assertNoDevToolsIndicator(browser)\n+\n+    // Wait for `__NEXT_DEV_INDICATOR_COOLDOWN` to pass.\n+    await waitFor(COOLDOWN)\n+\n+    await browser.refresh()\n+    await assertHasDevToolsIndicator(browser)\n+  })\n+})"
        },
        {
            "sha": "dfd989c5809a8bc773d98e31b6932776eaf76410",
            "filename": "test/development/client-dev-overlay/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -13,6 +13,11 @@ describe('client-dev-overlay', () => {\n       files: {\n         pages: new FileRef(join(__dirname, 'app/pages')),\n       },\n+      env: {\n+        // Disable the cooldown period for the dev indicator so that hiding the indicator in a test doesn't\n+        // impact subsequent tests.\n+        __NEXT_DEV_INDICATOR_COOLDOWN_MS: '0',\n+      },\n     })\n   })\n   beforeEach(async () => {"
        },
        {
            "sha": "d0a19e75d97eb16f806b873c2519f56ec64c3557",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -523,4 +523,8 @@ export class Playwright extends BrowserInterface {\n       'nextjs-portal [aria-labelledby=\"nextjs__container_errors_label\"]'\n     )\n   }\n+\n+  locateDevToolsIndicator(): Locator {\n+    return page.locator('nextjs-portal [data-nextjs-dev-tools-button]')\n+  }\n }"
        },
        {
            "sha": "4d2f0f1b26191e925f097a50e7fcbcad55a3775d",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=1c9e8af8bb0f0ecbb690b1b9fee95f99c761e9d8",
            "patch": "@@ -958,15 +958,50 @@ export async function goToNextErrorView(\n export async function openDevToolsIndicatorPopover(\n   browser: BrowserInterface\n ): Promise<void> {\n+  const devToolsIndicator = await assertHasDevToolsIndicator(browser)\n+\n   try {\n-    await browser.waitForElementByCss('[data-nextjs-dev-tools-button]').click()\n+    await devToolsIndicator.click()\n   } catch (cause) {\n     const error = new Error('No DevTools Indicator to open.', { cause })\n     Error.captureStackTrace(error, openDevToolsIndicatorPopover)\n     throw error\n   }\n }\n \n+export async function assertHasDevToolsIndicator(browser: BrowserInterface) {\n+  // TODO: Implement for other BrowserInterface implementations\n+  const playwright = browser as Playwright\n+\n+  const devToolsIndicator = playwright.locateDevToolsIndicator()\n+  try {\n+    await devToolsIndicator.waitFor({ timeout: 5000 })\n+  } catch (errorCause) {\n+    const error = new Error(\n+      'Expected DevTools Indicator but found no visible one.'\n+    )\n+    Error.captureStackTrace(error, assertHasDevToolsIndicator)\n+    throw error\n+  }\n+\n+  return devToolsIndicator\n+}\n+\n+export async function assertNoDevToolsIndicator(browser: BrowserInterface) {\n+  // TODO: Implement for other BrowserInterface implementations\n+  const playwright = browser as Playwright\n+\n+  const devToolsIndicator = playwright.locateDevToolsIndicator()\n+\n+  if (await devToolsIndicator.isVisible()) {\n+    const error = new Error(\n+      'Expected no visible DevTools Indicator but found one.'\n+    )\n+    Error.captureStackTrace(error, assertNoDevToolsIndicator)\n+    throw error\n+  }\n+}\n+\n export async function getRouteTypeFromDevToolsIndicator(\n   browser: BrowserInterface\n ): Promise<'Static' | 'Dynamic'> {"
        }
    ],
    "stats": {
        "total": 235,
        "additions": 229,
        "deletions": 6
    }
}