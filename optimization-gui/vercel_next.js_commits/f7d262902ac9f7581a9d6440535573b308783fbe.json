{
    "author": "ztanner",
    "message": "fix isDynamicRSC condition when deployed (#85919)\n\nNext.js relies on on the Resume Data Cache to prevent tearing between\nthe statically prefetchable parts of the UI by seeding the resume with\nthe same cache as the revalidation/build. The RDC data is stashed in the\npostponed state which is attached to all of the different outputs that\ncomprise a page (the segments, the HTML, and the dynamic RSC data).\n\nHowever, when deployed to targets like Vercel, the revalidation was\nincorrectly bypassing the cache for the RSC entry, because it thought\nthat it was a resume. This led to a drift in cached values, because the\nrevalidation would cause the main RSC entries RDC data to contain a\ndifferent value than what was used for the segment prefetches & HTML ISR\nentry.\n\nFixes NAR-493\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "f7d262902ac9f7581a9d6440535573b308783fbe",
    "files": [
        {
            "sha": "d8cdaae754265ed677a467c0857c06eb76ad3229",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "patch": "@@ -267,9 +267,16 @@ export async function handler(\n   // If PPR is enabled, and this is a RSC request (but not a prefetch), then\n   // we can use this fact to only generate the flight data for the request\n   // because we can't cache the HTML (as it's also dynamic).\n-  const isDynamicRSCRequest =\n+  let isDynamicRSCRequest =\n     isRoutePPREnabled && isRSCRequest && !isPrefetchRSCRequest\n \n+  // During a PPR revalidation, the RSC request is not dynamic if we do not have the postponed data.\n+  // We only attach the postponed data during a resume. If there's no postponed data, then it must be a revalidation.\n+  // This is to ensure that we don't bypass the cache during a revalidation.\n+  if (isMinimalMode) {\n+    isDynamicRSCRequest = isDynamicRSCRequest && !!minimalPostponed\n+  }\n+\n   // Need to read this before it's stripped by stripFlightHeaders. We don't\n   // need to transfer it to the request meta because it's only read\n   // within this function; the static segment data should have already been"
        },
        {
            "sha": "9dfde1627512b37a73ed3912c0b31e351276e718",
            "filename": "test/e2e/app-dir/resume-data-cache/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Flayout.tsx?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "previous_filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache/app/layout.tsx"
        },
        {
            "sha": "efe4d038cb1d7b09df9c2ca40ad3fc8613318b5f",
            "filename": "test/e2e/app-dir/resume-data-cache/app/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Fpage.tsx?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "previous_filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache/app/page.tsx"
        },
        {
            "sha": "5457a2ec26a21afb667439e036a4c996ecde9f11",
            "filename": "test/e2e/app-dir/resume-data-cache/app/revalidate/route.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fapp%2Frevalidate%2Froute.ts?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "patch": "@@ -1,6 +1,6 @@\n import { revalidateTag } from 'next/cache'\n \n export function POST() {\n-  revalidateTag('test', 'seconds')\n+  revalidateTag('test', 'minutes')\n   return new Response(null, { status: 200 })\n }",
            "previous_filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache/app/revalidate/route.ts"
        },
        {
            "sha": "e64bae22d658030ef118a8b53c925258ae17563f",
            "filename": "test/e2e/app-dir/resume-data-cache/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fnext.config.js?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "previous_filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache/next.config.js"
        },
        {
            "sha": "b497cab00ceafa99b2709a333e5d9727952fb529",
            "filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache.test.ts",
            "status": "renamed",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fresume-data-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f7d262902ac9f7581a9d6440535573b308783fbe/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fresume-data-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresume-data-cache%2Fresume-data-cache.test.ts?ref=f7d262902ac9f7581a9d6440535573b308783fbe",
            "patch": "@@ -3,14 +3,11 @@ import { retry } from 'next-test-utils'\n import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n describe('resume-data-cache', () => {\n-  const { next, isNextDeploy, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    // TODO (rdc-for-navigations): This test is failing as the dynamic response\n-    // is producing a different cached value than the static prefetch.\n-    skipDeployment: true,\n   })\n \n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     it('is skipped', () => {})\n     return\n   }\n@@ -70,18 +67,14 @@ describe('resume-data-cache', () => {\n       // same random number. The first request will get the stale data, but the\n       // second request will get the fresh data as it'll eventually have\n       // revalidated.\n-      // NOTE: this current doesn't work on Next.js Deploy, as the dynamic RSC\n-      // requests are not able to revalidate the page.\n-      if (!isNextDeploy) {\n-        const rsc = await next\n-          .fetch('/', {\n-            headers: {\n-              RSC: '1',\n-            },\n-          })\n-          .then((res) => res.text())\n-        expect(rsc).toContain(first)\n-      }\n+      const rsc = await next\n+        .fetch('/', {\n+          headers: {\n+            RSC: '1',\n+          },\n+        })\n+        .then((res) => res.text())\n+      expect(rsc).toContain(first)\n \n       // We then expect after the background revalidation has been completed,\n       // the dynamic RSC to get the fresh data.\n@@ -113,6 +106,7 @@ describe('resume-data-cache', () => {\n             headers: {\n               RSC: '1',\n               'Next-Router-Prefetch': '1',\n+              'Next-Router-Segment-Prefetch': '/__PAGE__',\n             },\n           })\n           .then((res) => res.text())",
            "previous_filename": "test/e2e/app-dir/resume-data-cache/resume-data-cache/resume-data-cache.test.ts"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 20,
        "deletions": 19
    }
}