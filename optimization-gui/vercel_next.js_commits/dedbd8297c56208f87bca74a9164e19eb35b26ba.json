{
    "author": "acdlite",
    "message": "Fix potential race condition in createRouterAct (#78473)\n\nA few of the tests that use `createRouterAct` occasionally flake in CI.\nI'm not exactly sure why because I'm struggling to reproduce them\nlocally, but my best guess based on some of the logs is that there's a\nrace condition between the IntersectionObserver event that triggers the\nprefetch request, and the async event scheduled by `createRouterAct`\nthat is meant to always run after that.\n\nI had thought `requestAnimationFrame` would be a good way to ensure that\nthe event runs after the IntersectionObserver, but I think that's not\nalways correct and depends on the timing of the paint/layout cycle. So\nI've switched it to `requestIdleCallback` instead since that won't run\nuntil the rest of the event queue is empty.\n\n(A timer would obviously work here, too, but we should avoid using\ntimers except to timeout a failing test, because they slow down CI.)\n\nI've also added better error message to `createRouterAct` in the case\nwhere an unexpected request is initiated. The updated message now\nincludes both the URL and the response body.",
    "sha": "dedbd8297c56208f87bca74a9164e19eb35b26ba",
    "files": [
        {
            "sha": "43b8dd1771287491e9482366b05c55512af5bacc",
            "filename": "test/e2e/app-dir/segment-cache/incremental-opt-in/segment-cache-incremental-opt-in.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/dedbd8297c56208f87bca74a9164e19eb35b26ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dedbd8297c56208f87bca74a9164e19eb35b26ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts?ref=dedbd8297c56208f87bca74a9164e19eb35b26ba",
            "patch": "@@ -159,12 +159,21 @@ describe('segment cache (incremental opt in)', () => {\n         { includes: 'Page content', block: 'reject' },\n       ])\n \n-      await act(async () => {\n-        const checkbox = await browser.elementByCss(\n-          `input[data-link-accordion=\"/ppr-disabled-with-loading-boundary/child\"]`\n-        )\n-        await checkbox.click()\n-      }, 'no-requests')\n+      // When prefetching a different page with the same loading boundary,\n+      // we should not need to fetch the loading boundary again\n+      await act(\n+        async () => {\n+          const checkbox = await browser.elementByCss(\n+            `input[data-link-accordion=\"/ppr-disabled-with-loading-boundary/child\"]`\n+          )\n+          await checkbox.click()\n+        },\n+        // This assertion will fail if more than one request includes the given\n+        // string. Because the string appears in the FlightRouterState for the\n+        // page, it effectively asserts that only one prefetch request is issued\n+        // â€” the one for the route tree.\n+        { includes: 'ppr-disabled-with-loading-boundary' }\n+      )\n \n       // Navigate to the page\n       await act(async () => {"
        },
        {
            "sha": "a89a2bcc69a1690a23ca40aa6eb6004035668d8e",
            "filename": "test/e2e/app-dir/segment-cache/router-act.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/dedbd8297c56208f87bca74a9164e19eb35b26ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dedbd8297c56208f87bca74a9164e19eb35b26ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts?ref=dedbd8297c56208f87bca74a9164e19eb35b26ba",
            "patch": "@@ -223,11 +223,11 @@ export function createRouterAct(\n       // that comes after the scope function, rather than immediately when the\n       // scope function exits.\n       //\n-      // We use requestAnimationFrame to schedule the task because that's\n+      // We use requestIdleCallback to schedule the task because that's\n       // guaranteed to fire after any IntersectionObserver events, which the\n       // router uses to track the visibility of links.\n       await page.evaluate(\n-        () => new Promise<void>((res) => requestAnimationFrame(() => res()))\n+        () => new Promise<void>((res) => requestIdleCallback(() => res()))\n       )\n \n       // Checking whether a request needs to be intercepted is an async\n@@ -254,7 +254,16 @@ export function createRouterAct(\n           } else {\n             item.didProcess = true\n             if (expectedResponses === null) {\n-              error.message = 'Expected no network requests to be initiated.'\n+              error.message = `\n+Expected no network requests to be initiated.\n+\n+URL: ${request.url()}\n+Headers: ${JSON.stringify(fulfilled.headers)}\n+\n+Response:\n+${fulfilled.body}\n+`\n+\n               throw error\n             }\n             if (expectedResponses !== null) {"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 27,
        "deletions": 9
    }
}