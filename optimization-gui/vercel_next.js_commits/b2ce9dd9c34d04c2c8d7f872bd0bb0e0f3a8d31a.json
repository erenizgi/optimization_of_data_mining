{
    "author": "ztanner",
    "message": "tweak middlewareClientMaxBodySize handling (#84712)\n\nThis ensures we captured `middlewareClientMaxBodySize` in the config\nschema and rather than triggering a hard error, it will buffer up to the\nlimit.",
    "sha": "b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
    "files": [
        {
            "sha": "f17717172244e4d8d1e30e8db1e8a9137a0fe3dc",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/middlewareClientMaxBodySize.mdx",
            "status": "added",
            "additions": 118,
            "deletions": 0,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -0,0 +1,118 @@\n+---\n+title: experimental.middlewareClientMaxBodySize\n+description: Configure the maximum request body size when using middleware.\n+version: experimental\n+---\n+\n+When middleware is used, Next.js automatically clones the request body and buffers it in memory to enable multiple reads - both in middleware and the underlying route handler. To prevent excessive memory usage, this configuration option sets a size limit on the buffered body.\n+\n+By default, the maximum body size is **10MB**. If a request body exceeds this limit, the body will only be buffered up to the limit, and a warning will be logged indicating which route exceeded the limit.\n+\n+## Options\n+\n+### String format (recommended)\n+\n+Specify the size using a human-readable string format:\n+\n+```ts filename=\"next.config.ts\" switcher\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    middlewareClientMaxBodySize: '1mb',\n+  },\n+}\n+\n+export default nextConfig\n+```\n+\n+```js filename=\"next.config.js\" switcher\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    middlewareClientMaxBodySize: '1mb',\n+  },\n+}\n+\n+module.exports = nextConfig\n+```\n+\n+Supported units: `b`, `kb`, `mb`, `gb`\n+\n+### Number format\n+\n+Alternatively, specify the size in bytes as a number:\n+\n+```ts filename=\"next.config.ts\" switcher\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    middlewareClientMaxBodySize: 1048576, // 1MB in bytes\n+  },\n+}\n+\n+export default nextConfig\n+```\n+\n+```js filename=\"next.config.js\" switcher\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    middlewareClientMaxBodySize: 1048576, // 1MB in bytes\n+  },\n+}\n+\n+module.exports = nextConfig\n+```\n+\n+## Behavior\n+\n+When a request body exceeds the configured limit:\n+\n+1. Next.js will buffer only the first N bytes (up to the limit)\n+2. A warning will be logged to the console indicating the route that exceeded the limit\n+3. The request will continue processing normally, but only the partial body will be available\n+4. The request will **not** fail or return an error to the client\n+\n+If your application needs to process the full request body, you should either:\n+\n+- Increase the `middlewareClientMaxBodySize` limit\n+- Handle the partial body gracefully in your application logic\n+\n+## Example\n+\n+```ts filename=\"middleware.ts\"\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export async function middleware(request: NextRequest) {\n+  // Next.js automatically buffers the body with the configured size limit\n+  // You can read the body in middleware...\n+  const body = await request.text()\n+\n+  // If the body exceeded the limit, only partial data will be available\n+  console.log('Body size:', body.length)\n+\n+  return NextResponse.next()\n+}\n+```\n+\n+```ts filename=\"app/api/upload/route.ts\"\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export async function POST(request: NextRequest) {\n+  // ...and the body is still available in your route handler\n+  const body = await request.text()\n+\n+  console.log('Body in route handler:', body.length)\n+\n+  return NextResponse.json({ received: body.length })\n+}\n+```\n+\n+## Good to know\n+\n+- This setting only applies when middleware is used in your application\n+- The default limit of 10MB is designed to balance memory usage and typical use cases\n+- The limit applies per-request, not globally across all concurrent requests\n+- For applications handling large file uploads, consider increasing the limit accordingly"
        },
        {
            "sha": "830e4ab56320c7807128c5742b526bde10f2ddfb",
            "filename": "docs/02-pages/04-api-reference/04-config/01-next-config-js/middlewareClientMaxBodySize.mdx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FmiddlewareClientMaxBodySize.mdx?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -0,0 +1,7 @@\n+---\n+title: experimental.middlewareClientMaxBodySize\n+description: Configure the maximum request body size when using middleware.\n+source: app/api-reference/config/next-config-js/middlewareClientMaxBodySize\n+---\n+\n+{/* DO NOT EDIT. The content of this doc is generated from the source above. To edit the content of this page, navigate to the source page in your editor. You can use the `<PagesOnly>Content</PagesOnly>` component to add content that is specific to the Pages Router. Any shared content should not be wrapped in a component. */}"
        },
        {
            "sha": "e6b4804aaf6a7014121e53575a7b781919529109",
            "filename": "packages/next/src/server/body-streams.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fbody-streams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fbody-streams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbody-streams.ts?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -92,11 +92,12 @@ export function getCloneableBody<T extends IncomingMessage>(\n \n         if (bytesRead > bodySizeLimit) {\n           limitExceeded = true\n-          const error = new Error(\n-            `Request body exceeded ${bytes.format(bodySizeLimit)}`\n+          const urlInfo = readable.url ? ` for ${readable.url}` : ''\n+          console.warn(\n+            `Request body exceeded ${bytes.format(bodySizeLimit)}${urlInfo}. Only the first ${bytes.format(bodySizeLimit)} will be available unless configured. See https://nextjs.org/docs/app/api-reference/config/next-config-js/middlewareClientMaxBodySize for more details.`\n           )\n-          p1.destroy(error)\n-          p2.destroy(error)\n+          p1.push(null)\n+          p2.push(null)\n           return\n         }\n "
        },
        {
            "sha": "abfd10aec619fb0728fec8296f720e301e21b2db",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -230,6 +230,7 @@ export const experimentalSchema = {\n   linkNoTouchStart: z.boolean().optional(),\n   manualClientBasePath: z.boolean().optional(),\n   middlewarePrefetch: z.enum(['strict', 'flexible']).optional(),\n+  middlewareClientMaxBodySize: zSizeLimit.optional(),\n   multiZoneDraftMode: z.boolean().optional(),\n   cssChunking: z.union([z.boolean(), z.literal('strict')]).optional(),\n   nextScriptWorkers: z.boolean().optional(),"
        },
        {
            "sha": "97149bfeb36c2b6e905b2509b32b5484f923ff88",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -1498,6 +1498,7 @@ export const defaultConfig = Object.freeze({\n     browserDebugInfoInTerminal: false,\n     lockDistDir: true,\n     isolatedDevBuild: true,\n+    middlewareClientMaxBodySize: 10_485_760, // 10MB\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "ac87608bb83b8dd3575fe039d366d77dd1f443f5",
            "filename": "test/e2e/client-max-body-size/app/api/echo/route.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/test%2Fe2e%2Fclient-max-body-size%2Fapp%2Fapi%2Fecho%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/test%2Fe2e%2Fclient-max-body-size%2Fapp%2Fapi%2Fecho%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fclient-max-body-size%2Fapp%2Fapi%2Fecho%2Froute.ts?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -1,5 +1,15 @@\n import { NextRequest, NextResponse } from 'next/server'\n \n export async function POST(request: NextRequest) {\n-  return new NextResponse('Hello World', { status: 200 })\n+  const body = await request.text()\n+  return new NextResponse(\n+    JSON.stringify({\n+      message: 'Hello World',\n+      bodySize: body.length,\n+    }),\n+    {\n+      status: 200,\n+      headers: { 'Content-Type': 'application/json' },\n+    }\n+  )\n }"
        },
        {
            "sha": "ecf28eff21282622f2ec4fde26a03a2c91025233",
            "filename": "test/e2e/client-max-body-size/index.test.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 22,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/test%2Fe2e%2Fclient-max-body-size%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a/test%2Fe2e%2Fclient-max-body-size%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fclient-max-body-size%2Findex.test.ts?ref=b2ce9dd9c34d04c2c8d7f872bd0bb0e0f3a8d31a",
            "patch": "@@ -11,7 +11,7 @@ describe('client-max-body-size', () => {\n \n     if (skipped) return\n \n-    it('should reject request body over 10MB by default', async () => {\n+    it('should accept request body over 10MB but only buffer up to limit', async () => {\n       const bodySize = 11 * 1024 * 1024 // 11MB\n       const body = 'x'.repeat(bodySize)\n \n@@ -25,8 +25,15 @@ describe('client-max-body-size', () => {\n         }\n       )\n \n-      expect(res.status).toBe(400)\n-      expect(next.cliOutput).toContain('Request body exceeded 10MB')\n+      expect(res.status).toBe(200)\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      // Should only buffer up to 10MB, not the full 11MB\n+      expect(responseBody.bodySize).toBeLessThanOrEqual(10 * 1024 * 1024)\n+      expect(responseBody.bodySize).toBeLessThan(bodySize)\n+      expect(next.cliOutput).toContain(\n+        'Request body exceeded 10MB for /api/echo'\n+      )\n     })\n \n     it('should accept request body at exactly 10MB', async () => {\n@@ -44,8 +51,9 @@ describe('client-max-body-size', () => {\n       )\n \n       expect(res.status).toBe(200)\n-      const responseBody = await res.text()\n-      expect(responseBody).toBe('Hello World')\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      expect(responseBody.bodySize).toBe(bodySize)\n     })\n \n     it('should accept request body under 10MB', async () => {\n@@ -63,8 +71,9 @@ describe('client-max-body-size', () => {\n       )\n \n       expect(res.status).toBe(200)\n-      const responseBody = await res.text()\n-      expect(responseBody).toBe('Hello World')\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      expect(responseBody.bodySize).toBe(bodySize)\n     })\n   })\n \n@@ -81,7 +90,7 @@ describe('client-max-body-size', () => {\n \n     if (skipped) return\n \n-    it('should reject request body over custom 5MB limit', async () => {\n+    it('should accept request body over custom 5MB limit but only buffer up to limit', async () => {\n       const bodySize = 6 * 1024 * 1024 // 6MB\n       const body = 'a'.repeat(bodySize)\n \n@@ -95,8 +104,15 @@ describe('client-max-body-size', () => {\n         }\n       )\n \n-      expect(res.status).toBe(400)\n-      expect(next.cliOutput).toContain('Request body exceeded 5MB')\n+      expect(res.status).toBe(200)\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      // Should only buffer up to 5MB, not the full 6MB\n+      expect(responseBody.bodySize).toBeLessThanOrEqual(5 * 1024 * 1024)\n+      expect(responseBody.bodySize).toBeLessThan(bodySize)\n+      expect(next.cliOutput).toContain(\n+        'Request body exceeded 5MB for /api/echo'\n+      )\n     })\n \n     it('should accept request body under custom 5MB limit', async () => {\n@@ -114,8 +130,9 @@ describe('client-max-body-size', () => {\n       )\n \n       expect(res.status).toBe(200)\n-      const responseBody = await res.text()\n-      expect(responseBody).toBe('Hello World')\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      expect(responseBody.bodySize).toBe(bodySize)\n     })\n   })\n \n@@ -132,7 +149,7 @@ describe('client-max-body-size', () => {\n \n     if (skipped) return\n \n-    it('should reject request body over custom 2MB limit', async () => {\n+    it('should accept request body over custom 2MB limit but only buffer up to limit', async () => {\n       const bodySize = 3 * 1024 * 1024 // 3MB\n       const body = 'c'.repeat(bodySize)\n \n@@ -146,8 +163,15 @@ describe('client-max-body-size', () => {\n         }\n       )\n \n-      expect(res.status).toBe(400)\n-      expect(next.cliOutput).toContain('Request body exceeded 2MB')\n+      expect(res.status).toBe(200)\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      // Should only buffer up to 2MB, not the full 3MB\n+      expect(responseBody.bodySize).toBeLessThanOrEqual(2 * 1024 * 1024)\n+      expect(responseBody.bodySize).toBeLessThan(bodySize)\n+      expect(next.cliOutput).toContain(\n+        'Request body exceeded 2MB for /api/echo'\n+      )\n     })\n \n     it('should accept request body under custom 2MB limit', async () => {\n@@ -165,8 +189,9 @@ describe('client-max-body-size', () => {\n       )\n \n       expect(res.status).toBe(200)\n-      const responseBody = await res.text()\n-      expect(responseBody).toBe('Hello World')\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      expect(responseBody.bodySize).toBe(bodySize)\n     })\n   })\n \n@@ -198,11 +223,12 @@ describe('client-max-body-size', () => {\n       )\n \n       expect(res.status).toBe(200)\n-      const responseBody = await res.text()\n-      expect(responseBody).toBe('Hello World')\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      expect(responseBody.bodySize).toBe(bodySize)\n     })\n \n-    it('should reject request body over custom 50MB limit', async () => {\n+    it('should accept request body over custom 50MB limit but only buffer up to limit', async () => {\n       const bodySize = 51 * 1024 * 1024 // 51MB\n       const body = 'f'.repeat(bodySize)\n \n@@ -216,8 +242,15 @@ describe('client-max-body-size', () => {\n         }\n       )\n \n-      expect(res.status).toBe(400)\n-      expect(next.cliOutput).toContain('Request body exceeded 50MB')\n+      expect(res.status).toBe(200)\n+      const responseBody = await res.json()\n+      expect(responseBody.message).toBe('Hello World')\n+      // Should only buffer up to 50MB, not the full 51MB\n+      expect(responseBody.bodySize).toBeLessThanOrEqual(50 * 1024 * 1024)\n+      expect(responseBody.bodySize).toBeLessThan(bodySize)\n+      expect(next.cliOutput).toContain(\n+        'Request body exceeded 50MB for /api/echo'\n+      )\n     })\n   })\n })"
        }
    ],
    "stats": {
        "total": 225,
        "additions": 198,
        "deletions": 27
    }
}