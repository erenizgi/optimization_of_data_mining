{
    "author": "mischnic",
    "message": "Turbopack: don't treat metadata routes as RSC (#82911)\n\nMetadata routes are just `route.ts`\\-s in diguise.\nTreat them the same regarding the layer (`app-route`) and whether to emit client reference/server actions manifests for them (= don't).\n\nThis fixes a panic:\n\n```\nthread 'tokio-runtime-worker' panicked at crates/next-api/src/dynamic_imports.rs:70:26:\ncalled `Option::unwrap()` on a `None` value\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n```\n\nhttps://vercel.slack.com/archives/C05TH5T3DS8/p1755670936074369",
    "sha": "85ef3638b3f546bb9117e8cd742771388303af0e",
    "files": [
        {
            "sha": "f59e0f38d2808a9c192c19231907e71e913c6f02",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -1134,8 +1134,8 @@ impl AppEndpoint {\n         next_config: Vc<NextConfig>,\n     ) -> Result<Vc<AppEntry>> {\n         Ok(get_app_metadata_route_entry(\n-            self.app_project.rsc_module_context(),\n-            self.app_project.edge_rsc_module_context(),\n+            self.app_project.route_module_context(),\n+            self.app_project.edge_route_module_context(),\n             self.app_project.project().project_path().owned().await?,\n             self.page.clone(),\n             *self.app_project.project().next_mode().await?,\n@@ -1194,11 +1194,7 @@ impl AppEndpoint {\n                 AppEndpointType::Metadata { metadata } => (\n                     false,\n                     false,\n-                    if matches!(metadata, MetadataItem::Dynamic { .. }) {\n-                        EmitManifests::Full\n-                    } else {\n-                        EmitManifests::Minimal\n-                    },\n+                    EmitManifests::Minimal,\n                     matches!(metadata, MetadataItem::Dynamic { .. }),\n                 ),\n             };"
        },
        {
            "sha": "9da3ca75999f9e18abcfae7ba95d05eaab58b516",
            "filename": "test/e2e/app-dir/dynamic/app/api/route.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fapi%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fapi%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fapi%2Froute.js?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -0,0 +1,5 @@\n+import { DynamicComponent } from '../client-reference'\n+\n+export async function GET() {\n+  return new Response('Hello ' + typeof DynamicComponent)\n+}"
        },
        {
            "sha": "f11004f7e106d1260fb92719826e8dddc8c2dcbb",
            "filename": "test/e2e/app-dir/dynamic/app/client-reference.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fclient-reference.js",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fclient-reference.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fclient-reference.js?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+import dynamic from 'next/dynamic'\n+\n+export const DynamicComponent = dynamic(() => import('./dynamic-component'))"
        },
        {
            "sha": "f23de50e36b120f4eb4cdd77d2d95d9039efd29b",
            "filename": "test/e2e/app-dir/dynamic/app/dynamic-component.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fdynamic-component.js",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fdynamic-component.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fdynamic-component.js?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -0,0 +1,7 @@\n+const DynamicImportComponent = () => {\n+  return (\n+    <div id=\"dynamic-component\">This is a dynamically imported component</div>\n+  )\n+}\n+\n+export default DynamicImportComponent"
        },
        {
            "sha": "d3fe8504436fb9667fdf7a9fca72e6f70355d950",
            "filename": "test/e2e/app-dir/dynamic/app/sitemap.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fsitemap.js",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fsitemap.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fapp%2Fsitemap.js?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -0,0 +1,14 @@\n+import { DynamicComponent } from './client-reference'\n+\n+globalThis.foo = DynamicComponent\n+\n+export default function sitemap() {\n+  return [\n+    {\n+      url: 'https://acme.com',\n+      lastModified: new Date(),\n+      changeFrequency: 'yearly',\n+      priority: 1,\n+    },\n+  ]\n+}"
        },
        {
            "sha": "f1bbcfda64b65dd1e756004a72524ba6be12a105",
            "filename": "test/e2e/app-dir/dynamic/dynamic.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fdynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/85ef3638b3f546bb9117e8cd742771388303af0e/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fdynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic%2Fdynamic.test.ts?ref=85ef3638b3f546bb9117e8cd742771388303af0e",
            "patch": "@@ -64,6 +64,16 @@ describe('app dir - next/dynamic', () => {\n     expect($('#dynamic-component').text()).not.toContain('loading')\n   })\n \n+  it('should ignore next/dynamic in routes', async () => {\n+    const response = await next.fetch('/api')\n+    expect(await response.text()).toEqual('Hello function')\n+  })\n+\n+  it('should ignore next/dynamic in sitemap', async () => {\n+    const response = await next.fetch('/sitemap.xml')\n+    expect(await response.text()).toInclude('<changefreq>yearly</changefreq>')\n+  })\n+\n   if (isNextDev) {\n     it('should directly raise error when dynamic component error on server', async () => {\n       const pagePath = 'app/default-loading/dynamic-component.js'"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 44,
        "deletions": 7
    }
}