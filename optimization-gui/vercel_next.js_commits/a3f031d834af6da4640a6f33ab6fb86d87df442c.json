{
    "author": "lubieowoce",
    "message": "fix: rootParams should throw in client when fallbackParams are not present (#81711)\n\n`rootParams` was erroring if used in a `'prerender-client'`, but only if\nwe had `fallbackRouteParams`. this is an edge case, but it is\ntechnically possible to hit if our compiler checks for using\n`rootParams` in client code are bypassed.\n\ni've also had to split `PrerenderStoreModern` into two types instead of\nhaving `type: 'prerender' | 'prerender-client'`. otherwise, typescript\nwould think that the `case 'prerender'` branch wasn't enough to\neliminate `PrerenderStoreModern` even though we already handled the\n`prerender-client` case at the top. this made the `prerenderStore\nsatisfies never` assertion at the bottom fail.\n\nThis is a bit tricky to explain, so i'm including a [TS playground\nrepro](https://www.typescriptlang.org/play/?#code/C4TwDgpgBAysD2AnCAZCBzAhgYxFAvFAN5SiQBcUA5GMsgHYAmEiAtADYY4hUC+AUGWhwkEALLxmiegWKlwESjToQmLKlAA+1Wi1VTW2dgEtVwDQKGwEyWSORosuLddESp9fvwgAPMEmAoADMAV3psYGN4GQBnFgA3FgB5enYQABUAC2N6dAAKGJtFV2QASkpCxBz0Yn4oeqhjIKgCooA6K3wunRU1NiNTenNS2oax0kzEeAB3KHoIWYBRRCnEPKoAOXhAzHZ2GYhGRpkBsypSuoaBMZjp42BsTJbC0Q6FEaJL8agAeh+obCYOI9PR9QwmM5fcZ-KAAPSgAGFMPQqIFGPAJsYYlBMnooJgsDkADRQdIwKAsVbYu7AJ4AA3SCmoACJdAwDKchsyNFi5tsAfAALZgTCITAAI04pAxViorN6Bk4ThAzJc8tBUm5bTpULGMLy4oggJCwOm0EeRoA1ocJphAoagqIAIQXXUNQHA5Qa9SUT7fb7IYAhaRQZkAdQgVFsOXxUEFkhYMjZ+hYzLd9Wu-o90C97JYHC4uCovvT40DwZk4cj0ZkmCgSu4UGTfTT-qgme+zCCmBC7GAJbbNyKUBidqxQVM2PmiUQpb1-1hAH45w0YW11+KQoEyZj6JbsXSXsg6QDkSPInsoIbY-ZxAmQ7jbBBEjJafAQugnmaqIkKSZBTkdo2uK2xPP4MQxMYkrmkCEDYqWHbtvwAhAA)\n\ni'm guessing that `type: 'prerender' | 'prerender-client'` is more\ncomplex than a normal discriminator and TS was getting confused, which\nis why having two separate types solves it.",
    "sha": "a3f031d834af6da4640a6f33ab6fb86d87df442c",
    "files": [
        {
            "sha": "5ffc35c648c1ec2e9a7d7ebf063bb50bcbe9445d",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a3f031d834af6da4640a6f33ab6fb86d87df442c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a3f031d834af6da4640a6f33ab6fb86d87df442c/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=a3f031d834af6da4640a6f33ab6fb86d87df442c",
            "patch": "@@ -78,12 +78,19 @@ export interface RequestStore extends CommonWorkUnitStore {\n  * only needs to happen during the RSC prerender when we are prospectively prerendering\n  * to fill all caches.\n  */\n-export interface PrerenderStoreModern extends CommonWorkUnitStore {\n-  // In the future the prerender-client variant will get it's own type.\n-  // prerender represents the RSC scope of the prerender.\n-  // prerender-client represents the HTML scope of the prerender.\n-  type: 'prerender' | 'prerender-client'\n+export type PrerenderStoreModern =\n+  | PrerenderStoreModernClient\n+  | PrerenderStoreModernServer\n \n+interface PrerenderStoreModernClient extends PrerenderStoreModernCommon {\n+  type: 'prerender-client'\n+}\n+\n+interface PrerenderStoreModernServer extends PrerenderStoreModernCommon {\n+  type: 'prerender'\n+}\n+\n+interface PrerenderStoreModernCommon extends CommonWorkUnitStore {\n   /**\n    * This signal is aborted when the React render is complete. (i.e. it is the same signal passed to react)\n    */"
        },
        {
            "sha": "21d8fdacd3ca0c6d5d294c3654cb246cd20c7f6f",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/a3f031d834af6da4640a6f33ab6fb86d87df442c/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a3f031d834af6da4640a6f33ab6fb86d87df442c/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=a3f031d834af6da4640a6f33ab6fb86d87df442c",
            "patch": "@@ -66,6 +66,19 @@ function createPrerenderRootParams(\n   workStore: WorkStore,\n   prerenderStore: PrerenderStore\n ): Promise<Params> {\n+  switch (prerenderStore.type) {\n+    case 'prerender-client': {\n+      const exportName = '`unstable_rootParams`'\n+      throw new InvariantError(\n+        `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n+      )\n+    }\n+    case 'prerender':\n+    case 'prerender-legacy':\n+    case 'prerender-ppr':\n+    default:\n+  }\n+\n   const fallbackParams = workStore.fallbackRouteParams\n   if (fallbackParams) {\n     let hasSomeFallbackParams = false\n@@ -93,11 +106,6 @@ function createPrerenderRootParams(\n           CachedParams.set(underlyingParams, promise)\n \n           return promise\n-        case 'prerender-client':\n-          const exportName = '`unstable_rootParams`'\n-          throw new InvariantError(\n-            `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n-          )\n         case 'prerender-ppr':\n         case 'prerender-legacy':\n           // We aren't in a dynamicIO prerender but we do have fallback params at this"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 25,
        "deletions": 10
    }
}