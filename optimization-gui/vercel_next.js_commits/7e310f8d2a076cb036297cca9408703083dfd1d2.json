{
    "author": "kdy1",
    "message": "fix(turbopack): Improve error message for PURE selector error (#80068)\n\n### What?\n\nUse CSS string for CSS errors instead of Rust debug representation, and remove `lightningcss` text from the error message.\n\n### Why?\n\nWe don't need them.",
    "sha": "7e310f8d2a076cb036297cca9408703083dfd1d2",
    "files": [
        {
            "sha": "ea49a40df185aeaa5f085a4f2808a0f8b4be39be",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=7e310f8d2a076cb036297cca9408703083dfd1d2",
            "patch": "@@ -464,7 +464,7 @@ describe('ReactRefreshLogBox app', () => {\n          \"label\": \"Build Error\",\n          \"source\": \"./index.module.css\n        Parsing css source code failed\n-       Selector is not pure (pure selectors must contain at least one local class or id), (lightningcss, Selector(button, specificity = 0x1))\n+       Selector \"button\" is not pure. Pure selectors must contain at least one local class or id.\n        Example import traces:\n          #1:\n            ./index.module.css [app-client]"
        },
        {
            "sha": "45b6f9915285d963fdc3dce1530c8969390503de",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=7e310f8d2a076cb036297cca9408703083dfd1d2",
            "patch": "@@ -602,7 +602,7 @@ describe('ReactRefreshLogBox', () => {\n          \"label\": \"Build Error\",\n          \"source\": \"./index.module.css\n        Parsing css source code failed\n-       Selector is not pure (pure selectors must contain at least one local class or id), (lightningcss, Selector(button, specificity = 0x1))\n+       Selector \"button\" is not pure. Pure selectors must contain at least one local class or id.\n        Example import traces:\n          client:\n            ./index.module.css"
        },
        {
            "sha": "2a8bb210d19700c3518432b7401242244b36fbe2",
            "filename": "test/integration/css-features/test/css-modules.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7e310f8d2a076cb036297cca9408703083dfd1d2/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js?ref=7e310f8d2a076cb036297cca9408703083dfd1d2",
            "patch": "@@ -58,9 +58,7 @@ describe('Custom Properties: Fail for global element in CSS Modules', () => {\n         expect(code).not.toBe(0)\n         if (process.env.IS_TURBOPACK_TEST) {\n           expect(stderr).toContain('pages/styles.module.css')\n-          expect(stderr).toContain(\n-            'Selector is not pure (pure selectors must contain at least one local class or id)'\n-          )\n+          expect(stderr).toContain('Selector \"h1\" is not pure')\n         } else {\n           expect(stderr).toContain('Failed to compile')\n           expect(stderr).toContain('pages/styles.module.css')"
        },
        {
            "sha": "562d58a3a91495125612ff8cb7ee77d194fce31d",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/7e310f8d2a076cb036297cca9408703083dfd1d2/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e310f8d2a076cb036297cca9408703083dfd1d2/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=7e310f8d2a076cb036297cca9408703083dfd1d2",
            "patch": "@@ -5,6 +5,7 @@ use lightningcss::{\n     css_modules::{CssModuleExport, CssModuleExports, Pattern, Segment},\n     stylesheet::{ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n     targets::{Features, Targets},\n+    traits::ToCss,\n     values::url::Url,\n     visit_types,\n     visitor::Visit,\n@@ -523,8 +524,11 @@ impl CssError {\n             CssError::CssSelectorInModuleNotPure { selector } => {\n                 ParsingIssue {\n                     file,\n-                    msg: format!(\"{CSS_MODULE_ERROR}, (lightningcss, {selector})\").into(),\n-\n+                    msg: format!(\n+                        \"Selector \\\"{selector}\\\" is not pure. Pure selectors must contain at \\\n+                         least one local class or id.\"\n+                    )\n+                    .into(),\n                     source: None,\n                 }\n                 .resolved_cell()\n@@ -534,9 +538,6 @@ impl CssError {\n     }\n }\n \n-const CSS_MODULE_ERROR: &str =\n-    \"Selector is not pure (pure selectors must contain at least one local class or id)\";\n-\n /// We only visit top-level selectors.\n impl lightningcss::visitor::Visitor<'_> for CssValidator {\n     type Error = ();\n@@ -578,8 +579,14 @@ impl lightningcss::visitor::Visitor<'_> for CssValidator {\n         }\n \n         if is_selector_problematic(selector) {\n+            let selector_string = selector\n+                .to_css_string(PrinterOptions {\n+                    minify: false,\n+                    ..Default::default()\n+                })\n+                .expect(\"selector.to_css_string should not fail\");\n             self.errors.push(CssError::CssSelectorInModuleNotPure {\n-                selector: format!(\"{selector:?}\"),\n+                selector: selector_string,\n             });\n         }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 16,
        "deletions": 11
    }
}