{
    "author": "ztanner",
    "message": "legacyBehavior deprecation error should only trigger once (#77687)\n\nWe added a deprecation warning for `legacyBehavior` on the `Link`\ncomponent but since we show errors in the error overlay, this could lead\nto a lot of noise if many links are using the `legacyBehavior` prop.\n\nThis copies over the `warn-once` utility to `error-once` and uses that\nutility to dedupe.",
    "sha": "74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
    "files": [
        {
            "sha": "f09eac1660cf4978758a717d6ef6cc7b57f04811",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
            "patch": "@@ -20,6 +20,7 @@ import {\n } from '../components/links'\n import { isLocalURL } from '../../shared/lib/router/utils/is-local-url'\n import { dispatchNavigateAction } from '../components/app-router-instance'\n+import { errorOnce } from '../../shared/lib/utils/error-once'\n \n type Url = string | UrlObject\n type RequiredKeys<T> = {\n@@ -684,7 +685,7 @@ export default function LinkComponent(\n \n   if (legacyBehavior) {\n     if (process.env.NODE_ENV === 'development') {\n-      console.error(\n+      errorOnce(\n         '`legacyBehavior` is deprecated and will be removed in a future ' +\n           'release. A codemod is available to upgrade your components:\\n\\n' +\n           'npx @next/codemod@latest new-link .\\n\\n' +"
        },
        {
            "sha": "5c66ec6d2e75931c4841f32c56f6f3625b010300",
            "filename": "packages/next/src/client/link.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx?ref=74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
            "patch": "@@ -18,6 +18,7 @@ import { useIntersection } from './use-intersection'\n import { getDomainLocale } from './get-domain-locale'\n import { addBasePath } from './add-base-path'\n import { useMergedRef } from './use-merged-ref'\n+import { errorOnce } from '../shared/lib/utils/error-once'\n \n type Url = string | UrlObject\n type RequiredKeys<T> = {\n@@ -668,7 +669,7 @@ const Link = React.forwardRef<HTMLAnchorElement, LinkPropsReal>(\n \n     if (legacyBehavior) {\n       if (process.env.NODE_ENV === 'development') {\n-        console.error(\n+        errorOnce(\n           '`legacyBehavior` is deprecated and will be removed in a future ' +\n             'release. A codemod is available to upgrade your components:\\n\\n' +\n             'npx @next/codemod@latest new-link .\\n\\n' +"
        },
        {
            "sha": "c0d00fc78b7d68e322690c0e44acf6dbb18ecb5b",
            "filename": "packages/next/src/shared/lib/utils/error-once.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Ferror-once.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Ferror-once.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Ferror-once.ts?ref=74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
            "patch": "@@ -0,0 +1,12 @@\n+let errorOnce = (_: string) => {}\n+if (process.env.NODE_ENV !== 'production') {\n+  const errors = new Set<string>()\n+  errorOnce = (msg: string) => {\n+    if (!errors.has(msg)) {\n+      console.error(msg)\n+    }\n+    errors.add(msg)\n+  }\n+}\n+\n+export { errorOnce }"
        },
        {
            "sha": "2496316257c34e7fe63a00589cc42390b98ec744",
            "filename": "test/e2e/app-dir/link-component-deprecations/app/page.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Fapp%2Fpage.tsx?ref=74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
            "patch": "@@ -2,8 +2,13 @@ import Link from 'next/link'\n \n export default function HomePage() {\n   return (\n-    <Link legacyBehavior href=\"/target-page\">\n-      <a>Target page</a>\n-    </Link>\n+    <>\n+      <Link legacyBehavior href=\"/target-page\">\n+        <a>Target page</a>\n+      </Link>\n+      <Link legacyBehavior href=\"/target-page?foo=bar\">\n+        <a>Another Target page</a>\n+      </Link>\n+    </>\n   )\n }"
        },
        {
            "sha": "60821ec4750e3a695d8fe145d52b6177faf985a1",
            "filename": "test/e2e/app-dir/link-component-deprecations/link-component-deprecations.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Flink-component-deprecations.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Flink-component-deprecations.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flink-component-deprecations%2Flink-component-deprecations.test.ts?ref=74b2f52cb06ac5ddfe8cbe08a17bafe2d53d4399",
            "patch": "@@ -9,14 +9,14 @@ describe('Link component deprecations', () => {\n     const browser = await next.browser('/')\n     const logs = await browser.log()\n \n-    const didWarn = logs.some(\n+    const errors = logs.filter(\n       (log) =>\n         log.source === 'error' &&\n         log.message.includes(\n           '`legacyBehavior` is deprecated and will be removed in a future release.'\n         )\n     )\n \n-    expect(didWarn).toBe(isNextDev)\n+    expect(errors.length).toBe(isNextDev ? 1 : 0)\n   })\n })"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 26,
        "deletions": 7
    }
}