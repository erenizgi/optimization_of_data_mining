{
    "author": "kevva",
    "message": "fix: make sure body can be read using `nodejs` runtime in middleware (#77553)\n\nThis fixes an issue where the body couldn't be read when running the\nmiddleware with the `nodejs` runtime. When running it in the `edge`\nruntime, `cloneBodyStream()` is ran\n[here](https://github.com/vercel/next.js/blob/ca4a18789d37dbd01ca3c88091d1f86134072dee/packages/next/src/server/web/sandbox/sandbox.ts#L104)\nso we need to do the same for the `nodejs` runtime.\n\nFixes #77551\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "feda5d8dc929700484b11046a2943aea2da7b6eb",
    "files": [
        {
            "sha": "ffe7b72b48e9e1b0d4d4ea126b514905d955b024",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/feda5d8dc929700484b11046a2943aea2da7b6eb/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/feda5d8dc929700484b11046a2943aea2da7b6eb/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=feda5d8dc929700484b11046a2943aea2da7b6eb",
            "patch": "@@ -1605,7 +1605,12 @@ export default class NextNodeServer extends BaseServer<\n \n       result = await adapterFn({\n         handler: middlewareModule.middleware || middlewareModule,\n-        request: requestData,\n+        request: {\n+          ...requestData,\n+          body: !['HEAD', 'GET'].includes(params.request.method)\n+            ? requestData.body?.cloneBodyStream()\n+            : undefined,\n+        },\n         page: 'middleware',\n       })\n     } else {"
        },
        {
            "sha": "69ea2d42fd7ecfb830a02b28f3e3f48f62541b21",
            "filename": "test/e2e/middleware-general/app/middleware-node.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "raw_url": "https://github.com/vercel/next.js/raw/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js?ref=feda5d8dc929700484b11046a2943aea2da7b6eb",
            "patch": "@@ -253,6 +253,10 @@ export async function middleware(request) {\n     throw new Error('test error')\n   }\n \n+  if (url.pathname === '/request-body' && request.method === 'POST') {\n+    return NextResponse.json(await request.json())\n+  }\n+\n   const original = new URL(request.url)\n   return NextResponse.next({\n     headers: {"
        },
        {
            "sha": "65988be101795d80b7d24caecd2b319d9fb042b8",
            "filename": "test/e2e/middleware-general/app/middleware.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js?ref=feda5d8dc929700484b11046a2943aea2da7b6eb",
            "patch": "@@ -252,6 +252,10 @@ export async function middleware(request) {\n     throw new Error('test error')\n   }\n \n+  if (url.pathname === '/request-body' && request.method === 'POST') {\n+    return NextResponse.json(await request.json())\n+  }\n+\n   const original = new URL(request.url)\n   return NextResponse.next({\n     headers: {"
        },
        {
            "sha": "4f1e9e38abe9b876bcc3eac84502edca0b4da355",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/feda5d8dc929700484b11046a2943aea2da7b6eb/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=feda5d8dc929700484b11046a2943aea2da7b6eb",
            "patch": "@@ -824,6 +824,17 @@ describe('Middleware Runtime', () => {\n         }/sha.json?hello=goodbye`,\n       ])\n     })\n+\n+    it(`should read request body`, async () => {\n+      const body = { hello: 'world' }\n+      const res = await fetchViaHTTP(next.url, '/request-body', undefined, {\n+        body: JSON.stringify(body),\n+        headers: { 'content-type': 'application/json' },\n+        method: 'POST',\n+      })\n+\n+      expect(await res.json()).toEqual(body)\n+    })\n   }\n   describe('with i18n', () => {\n     setup({ i18n: true })"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 25,
        "deletions": 1
    }
}