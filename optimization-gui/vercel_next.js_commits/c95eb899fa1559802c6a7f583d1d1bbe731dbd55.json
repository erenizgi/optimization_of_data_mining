{
    "author": "ztanner",
    "message": "test: de-flake client-cache deployment tests (#87412)\n\nThese tests aren't resilient to changes in router behavior after\nextensive refactors. What looks to be happening is a race between the\nprefetch being issued and the click firing:\n1. Cache expires -> refetch prefetch is triggered\n2. Click happens while prefetch is in-flight -> route entry is Pending\n3. Since no fulfilled cache entry exists, `navigate()` falls through to\n`navigateDynamicallyWithNoPrefetch()`\n4. This issues a full dynamic request\n5. The full dynamic response is favored and skips the loading state\n\nThis ensures that we are waiting for network activity to finish before\nnavigating.",
    "sha": "c95eb899fa1559802c6a7f583d1d1bbe731dbd55",
    "files": [
        {
            "sha": "abbb99babca934c4d14539da2e8feb6a6741c9e2",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.defaults.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.defaults.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.defaults.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.defaults.test.ts?ref=c95eb899fa1559802c6a7f583d1d1bbe731dbd55",
            "patch": "@@ -268,6 +268,9 @@ describe('app dir client cache semantics (default semantics)', () => {\n       })\n \n       it('should refetch the full page after 5 mins', async () => {\n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         const randomLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n           .click()\n@@ -285,6 +288,10 @@ describe('app dir client cache semantics (default semantics)', () => {\n           .click()\n           .waitForElementByCss('[href=\"/1?timeout=1000\"]')\n \n+        // Wait for prefetch requests to complete before clicking, otherwise\n+        // clicking during an in-flight prefetch aborts it and skips loading state\n+        await browser.waitForIdleNetwork()\n+\n         const newLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n           .click()"
        },
        {
            "sha": "797cc2dc54f025b0f1198baf7db42280a6c752db",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.experimental.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.experimental.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.experimental.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.experimental.test.ts?ref=c95eb899fa1559802c6a7f583d1d1bbe731dbd55",
            "patch": "@@ -20,6 +20,9 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n       it('should trigger a loading state before fetching the page, followed by fresh data on every subsequent navigation', async () => {\n         const browser = await next.browser('/', browserConfigWithFixedTime)\n \n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         // this test introduces an artificial delay in rendering the requested page, so we verify a loading state is rendered\n         await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n@@ -124,6 +127,9 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n       it('should trigger a loading state before fetching the page, followed by fresh data on every subsequent navigation', async () => {\n         const browser = await next.browser('/', browserConfigWithFixedTime)\n \n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         // this test introduces an artificial delay in rendering the requested page, so we verify a loading state is rendered\n         await browser\n           .elementByCss('[href=\"/2?timeout=1000\"]')\n@@ -176,6 +182,9 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n       it('should trigger a loading state before fetching the page, followed by fresh data on every subsequent navigation', async () => {\n         const browser = await next.browser('/', browserConfigWithFixedTime)\n \n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         // this test introduces an artificial delay in rendering the requested page, so we verify a loading state is rendered\n         await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n@@ -317,15 +326,21 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n       it('should re-use the loading boundary for the custom static override time (3 minutes)', async () => {\n         const browser = await next.browser('/', browserConfigWithFixedTime)\n \n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         const loadingRandomNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n           .click()\n           .waitForElementByCss('#loading')\n           .text()\n \n+        await browser.eval(fastForwardTo, 2 * 60 * 1000) // fast forward 2 minutes\n+\n         await browser.elementByCss('[href=\"/\"]').click()\n \n-        await browser.eval(fastForwardTo, 2 * 60 * 1000) // fast forward 2 minutes\n+        await browser.waitForElementByCss('[href=\"/1?timeout=1000\"]')\n+        await browser.waitForIdleNetwork()\n \n         let newLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n@@ -335,9 +350,13 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n \n         expect(loadingRandomNumber).toBe(newLoadingNumber)\n \n+        await browser.eval(fastForwardTo, 2 * 60 * 1000) // fast forward 2 minutes\n+\n         await browser.elementByCss('[href=\"/\"]').click()\n \n-        await browser.eval(fastForwardTo, 2 * 60 * 1000) // fast forward 2 minutes\n+        // Wait for link to be visible (triggers prefetch), then wait for prefetch to complete\n+        await browser.waitForElementByCss('[href=\"/1?timeout=1000\"]')\n+        await browser.waitForIdleNetwork()\n \n         newLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n@@ -384,6 +403,9 @@ describe('app dir client cache semantics (experimental staleTimes)', () => {\n     it('should trigger a loading state before fetching the page, followed by fresh data on every subsequent navigation', async () => {\n       const browser = await next.browser('/', browserConfigWithFixedTime)\n \n+      // Wait for initial prefetch to complete before clicking\n+      await browser.waitForIdleNetwork()\n+\n       // this test introduces an artificial delay in rendering the requested page, so we verify a loading state is rendered\n       await browser\n         .elementByCss('[href=\"/1?timeout=1000\"]')"
        },
        {
            "sha": "7f8a48288c5368f7528fc469ca02bd1f47436d91",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.original.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c95eb899fa1559802c6a7f583d1d1bbe731dbd55/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts?ref=c95eb899fa1559802c6a7f583d1d1bbe731dbd55",
            "patch": "@@ -360,6 +360,9 @@ describe('app dir client cache semantics (30s/5min)', () => {\n         expect(newNumber).not.toBe(randomNumber)\n       })\n       it('should refetch the full page after 5 mins', async () => {\n+        // Wait for initial prefetch to complete before clicking\n+        await browser.waitForIdleNetwork()\n+\n         const randomLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n           .click()\n@@ -377,6 +380,10 @@ describe('app dir client cache semantics (30s/5min)', () => {\n           .click()\n           .waitForElementByCss('[href=\"/1?timeout=1000\"]')\n \n+        // Wait for prefetch requests to complete before clicking, otherwise\n+        // clicking during an in-flight prefetch aborts it and skips loading state\n+        await browser.waitForIdleNetwork()\n+\n         const newLoadingNumber = await browser\n           .elementByCss('[href=\"/1?timeout=1000\"]')\n           .click()"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 38,
        "deletions": 2
    }
}