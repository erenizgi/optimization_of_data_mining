{
    "author": "kdy1",
    "message": "fix(turbopack): Fix sourcemap path on windows (#78453)\n\n### What?\n\nFix source map path on Windows by fixing the `url_to_file` function.\n\nNote: This PR is based on https://github.com/vercel/next.js/pull/78430 by @JustSuperHuman\n\n### Why?\n\n### How?\n\n - Closes PACK-4217\n - Closes PACK-3924\n - Closes https://github.com/vercel/next.js/issues/72789",
    "sha": "2a5e9882c7f1315de3633dd27fe29f722f9841d6",
    "files": [
        {
            "sha": "c1ba9baa5de799ea6559f9726b4d667d5e1ba152",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2a5e9882c7f1315de3633dd27fe29f722f9841d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2a5e9882c7f1315de3633dd27fe29f722f9841d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=2a5e9882c7f1315de3633dd27fe29f722f9841d6",
            "patch": "@@ -1288,6 +1288,10 @@ impl FileSystemPath {\n     /// None when the joined path would leave the filesystem root.\n     #[turbo_tasks::function]\n     pub async fn try_join(&self, path: RcStr) -> Result<Vc<FileSystemPathOption>> {\n+        // TODO(PACK-3279): Remove this once we do not produce invalid paths at the first place.\n+        #[cfg(target_os = \"windows\")]\n+        let path = path.replace('\\\\', \"/\");\n+\n         if let Some(path) = join_path(&self.path, &path) {\n             Ok(Vc::cell(Some(\n                 Self::new_normalized(*self.fs, path.into())"
        },
        {
            "sha": "3e847395ff4172e3d054638e6567dca434e93925",
            "filename": "turbopack/crates/turbo-tasks-fs/src/util.rs",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/2a5e9882c7f1315de3633dd27fe29f722f9841d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2a5e9882c7f1315de3633dd27fe29f722f9841d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs?ref=2a5e9882c7f1315de3633dd27fe29f722f9841d6",
            "patch": "@@ -138,6 +138,7 @@ pub fn extract_disk_access<T>(value: io::Result<T>, path: &Path) -> Result<Optio\n     }\n }\n \n+#[cfg(not(target_os = \"windows\"))]\n pub async fn uri_from_file(root: Vc<FileSystemPath>, path: Option<&str>) -> Result<String> {\n     let root_fs = root.fs();\n     let root_fs = &*Vc::try_resolve_downcast_type::<DiskFileSystem>(root_fs)\n@@ -162,3 +163,34 @@ pub async fn uri_from_file(root: Vc<FileSystemPath>, path: Option<&str>) -> Resu\n         .join(\"/\")\n     ))\n }\n+\n+#[cfg(target_os = \"windows\")]\n+pub async fn uri_from_file(root: Vc<FileSystemPath>, path: Option<&str>) -> Result<String> {\n+    let root_fs = root.fs();\n+    let root_fs = &*Vc::try_resolve_downcast_type::<DiskFileSystem>(root_fs)\n+        .await?\n+        .context(\"Expected root to have a DiskFileSystem\")?\n+        .await?;\n+\n+    let sys_path = root_fs\n+        .to_sys_path(match path {\n+            Some(path) => root.join(path.into()),\n+            None => root,\n+        })\n+        .await?;\n+\n+    let raw_path = sys_path.to_string_lossy().to_string();\n+    let normalized_path = raw_path.replace('\\\\', \"/\");\n+\n+    let mut segments = normalized_path.split('/');\n+\n+    let first = segments.next().unwrap_or_default(); // e.g., \"C:\"\n+    let encoded_path = std::iter::once(first.to_string()) // keep \"C:\" intact\n+        .chain(segments.map(|s| urlencoding::encode(s).into_owned()))\n+        .collect::<Vec<_>>()\n+        .join(\"/\");\n+\n+    let uri = format!(\"file:///{}\", encoded_path);\n+\n+    Ok(uri)\n+}"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 36,
        "deletions": 0
    }
}