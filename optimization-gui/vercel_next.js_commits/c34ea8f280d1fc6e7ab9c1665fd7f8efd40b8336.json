{
    "author": "huozhi",
    "message": "fix: always use the safe stable stringify (#84909)",
    "sha": "c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
    "files": [
        {
            "sha": "e89785d4ee61ce6b91339ec290cb9c2e5eb52253",
            "filename": "packages/next/src/lib/is-error.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 18,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -1,4 +1,5 @@\n import { isPlainObject } from '../shared/lib/is-plain-object'\n+import safeStringify from 'next/dist/compiled/safe-stable-stringify'\n \n // We allow some additional attached properties for Next.js errors\n export interface NextError extends Error {\n@@ -19,24 +20,6 @@ export default function isError(err: unknown): err is NextError {\n   )\n }\n \n-/**\n- * This is a safe stringify function that handles circular references.\n- */\n-export function safeStringify(obj: any) {\n-  const seen = new WeakSet()\n-\n-  return JSON.stringify(obj, (_key, value) => {\n-    // If value is an object and already seen, replace with \"[Circular]\"\n-    if (typeof value === 'object' && value !== null) {\n-      if (seen.has(value)) {\n-        return '[Circular]'\n-      }\n-      seen.add(value)\n-    }\n-    return value\n-  })\n-}\n-\n export function getProperError(err: unknown): Error {\n   if (isError(err)) {\n     return err"
        },
        {
            "sha": "100e15b49e18555286b107ec2900bf8d59805ac8",
            "filename": "packages/next/src/next-devtools/userspace/app/forward-logs-utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs-utils.ts?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -16,7 +16,7 @@ const maximumBreadth =\n     ? terminalLoggingConfig.edgeLimit\n     : 100\n \n-const stringify = configure({\n+export const safeStringifyWithDepth = configure({\n   maximumDepth,\n   maximumBreadth,\n })\n@@ -80,7 +80,7 @@ export function preLogSerializationClone<T>(\n // only safe if passed safeClone data\n export const logStringify = (data: unknown): string => {\n   try {\n-    const result = stringify(data)\n+    const result = safeStringifyWithDepth(data)\n     return result ?? `\"${UNAVAILABLE_MARKER}\"`\n   } catch {\n     return `\"${UNAVAILABLE_MARKER}\"`"
        },
        {
            "sha": "902f151471d74a10f58495c933cf4625e7a59ff0",
            "filename": "packages/next/src/next-devtools/userspace/app/forward-logs.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fforward-logs.ts?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -12,8 +12,11 @@ import {\n   type LogMethod,\n   patchConsoleMethod,\n } from '../../shared/forward-logs-shared'\n-import { preLogSerializationClone, logStringify } from './forward-logs-utils'\n-import { safeStringify } from '../../../lib/is-error'\n+import {\n+  preLogSerializationClone,\n+  logStringify,\n+  safeStringifyWithDepth,\n+} from './forward-logs-utils'\n \n // Client-side file logger for browser logs\n class ClientFileLogger {\n@@ -46,7 +49,7 @@ class ClientFileLogger {\n           return String(arg)\n         if (arg === null) return 'null'\n         if (arg === undefined) return 'undefined'\n-        return safeStringify(arg)\n+        return safeStringifyWithDepth(arg)\n       })\n       .join(' ')\n "
        },
        {
            "sha": "5f071b64d0f15976b8ca9fceddfdbb33b0329574",
            "filename": "test/development/app-dir/serialize-circular-error/serialize-circular-error.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -19,7 +19,7 @@ describe('serialize-circular-error', () => {\n     `)\n     const output = next.cliOutput\n     expect(output).toContain(\n-      'Error: {\"objA\":{\"other\":{\"a\":\"[Circular]\"}},\"objB\":\"[Circular]\"}'\n+      'Error: {\"objA\":{\"other\":{\"a\":\"[Circular]\"}},\"objB\":{\"a\":{\"other\":\"[Circular]\"}}}'\n     )\n   })\n \n@@ -44,7 +44,7 @@ describe('serialize-circular-error', () => {\n \n     const output = next.cliOutput\n     expect(output).toContain(\n-      'Error: {\"objC\":{\"other\":{\"a\":\"[Circular]\"}},\"objD\":\"[Circular]\"}'\n+      'Error: {\"objC\":{\"other\":{\"a\":\"[Circular]\"}},\"objD\":{\"a\":{\"other\":\"[Circular]\"}}}'\n     )\n   })\n })"
        },
        {
            "sha": "35e4b96a2ddc540251342279df5bf79ae97f1075",
            "filename": "test/development/mcp-server/fixtures/log-file-app/app/client/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Flog-file-app%2Fapp%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Flog-file-app%2Fapp%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Flog-file-app%2Fapp%2Fclient%2Fpage.tsx?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -26,5 +26,7 @@ export default function ClientPage() {\n     console.warn('Client: This is a warning message from client component')\n   }, [])\n \n+  console.error('globalThis', globalThis)\n+\n   return <p>client page with logging</p>\n }"
        },
        {
            "sha": "ea4059634fa243555b1725fdaed93a1bb08cd55e",
            "filename": "test/e2e/app-dir/log-file/log-file.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts?ref=c34ea8f280d1fc6e7ab9c1665fd7f8efd40b8336",
            "patch": "@@ -119,7 +119,7 @@ describe('log-file', () => {\n       await retry(async () => {\n         const newLogContent = getNewLogContent()\n         expect(newLogContent).toMatchInlineSnapshot(`\n-         \"[xx:xx:xx.xxx] Browser LOG     Client: Complex circular object: {\"name\":\"test\",\"data\":{\"nested\":{\"value\":42,\"items\":[1,2,3]},\"parent\":\"[Circular]\"},\"metadata\":{\"name\":\"safe stringify\",\"version\":\"1.0.0\"}}\n+         \"[xx:xx:xx.xxx] Browser LOG     Client: Complex circular object: {\"data\":{\"nested\":{\"items\":[1,2,3],\"value\":42},\"parent\":\"[Circular]\"},\"metadata\":{\"name\":\"safe stringify\",\"version\":\"1.0.0\"},\"name\":\"test\"}\n          [xx:xx:xx.xxx] Browser ERROR   Client: This is an error message from client component\n          [xx:xx:xx.xxx] Browser WARN    Client: This is a warning message from client component\n          \""
        }
    ],
    "stats": {
        "total": 40,
        "additions": 14,
        "deletions": 26
    }
}