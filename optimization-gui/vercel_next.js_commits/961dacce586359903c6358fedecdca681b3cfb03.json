{
    "author": "sokra",
    "message": "Turbopack: remove references from ChunkData (#84076)\n\n### What?\n\nAs preparation to add chunk group referenced assets.",
    "sha": "961dacce586359903c6358fedecdca681b3cfb03",
    "files": [
        {
            "sha": "405ad7dbfff42179d16f5a796d1fcf80d657c48c",
            "filename": "crates/next-core/src/page_loader.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 14,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -174,20 +174,7 @@ impl OutputAsset for PageLoaderAsset {\n \n     #[turbo_tasks::function]\n     async fn references(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n-        let chunks = self.await?.page_chunks.await?;\n-\n-        let mut references = Vec::with_capacity(chunks.len());\n-        for &chunk in chunks.iter() {\n-            references.push(chunk);\n-        }\n-\n-        // We don't need to strip the client relative prefix, because we won't be using\n-        // these reference paths with `__turbopack_load__`.\n-        for chunk_data in &*self.chunks_data(FileSystemPathOption::none()).await? {\n-            references.extend(chunk_data.references().await?.iter().copied());\n-        }\n-\n-        Ok(Vc::cell(references))\n+        Ok(*self.await?.page_chunks)\n     }\n }\n "
        },
        {
            "sha": "1b92262e8dc5e2c4cf852bc11b06b7b793c67c99",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -271,9 +271,7 @@ impl OutputAsset for EcmascriptBrowserEvaluateChunk {\n             references.push(ResolvedVc::upcast(self.source_map().to_resolved().await?));\n         }\n \n-        for chunk_data in &*self.chunks_data().await? {\n-            references.extend(chunk_data.references().await?.iter().copied());\n-        }\n+        references.extend(this.other_chunks.await?.iter().copied());\n \n         Ok(Vc::cell(references))\n     }"
        },
        {
            "sha": "6756c886cd711c8473e78089fe581c31d0255b9e",
            "filename": "turbopack/crates/turbopack-core/src/chunk/data.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 20,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fdata.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -1,5 +1,5 @@\n use anyhow::Result;\n-use turbo_tasks::{ReadRef, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{ReadRef, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbo_tasks_hash::Xxh3Hash64Hasher;\n \n@@ -14,7 +14,6 @@ pub struct ChunkData {\n     pub included: Vec<ReadRef<ModuleId>>,\n     pub excluded: Vec<ReadRef<ModuleId>>,\n     pub module_chunks: Vec<String>,\n-    pub references: ResolvedVc<OutputAssets>,\n }\n \n #[turbo_tasks::value(transparent)]\n@@ -54,9 +53,6 @@ impl ChunkData {\n         for module_chunk in &self.module_chunks {\n             hasher.write_value(module_chunk.as_str());\n         }\n-        for reference in self.references.await?.iter() {\n-            hasher.write_value(reference.path().to_string().await?);\n-        }\n \n         Ok(Vc::cell(hasher.finish()))\n     }\n@@ -83,7 +79,6 @@ impl ChunkData {\n                     included: Vec::new(),\n                     excluded: Vec::new(),\n                     module_chunks: Vec::new(),\n-                    references: OutputAssets::empty().to_resolved().await?,\n                 }\n                 .resolved_cell(),\n             )));\n@@ -108,7 +103,7 @@ impl ChunkData {\n         } else {\n             Vec::new()\n         };\n-        let (module_chunks, module_chunks_references) = if let Some(module_chunks) = module_chunks {\n+        let module_chunks = if let Some(module_chunks) = module_chunks {\n             module_chunks\n                 .await?\n                 .iter()\n@@ -120,16 +115,13 @@ impl ChunkData {\n                         let chunk_path = chunk.path().await?;\n                         Ok(output_root\n                             .get_path_to(&chunk_path)\n-                            .map(|path| (path.to_owned(), chunk)))\n+                            .map(|path| path.to_owned()))\n                     }\n                 })\n-                .try_join()\n+                .try_flat_join()\n                 .await?\n-                .into_iter()\n-                .flatten()\n-                .unzip()\n         } else {\n-            (Vec::new(), Vec::new())\n+            Vec::new()\n         };\n \n         Ok(Vc::cell(Some(\n@@ -138,7 +130,6 @@ impl ChunkData {\n                 included,\n                 excluded,\n                 module_chunks,\n-                references: ResolvedVc::cell(module_chunks_references),\n             }\n             .resolved_cell(),\n         )))\n@@ -161,10 +152,4 @@ impl ChunkData {\n                 .collect(),\n         ))\n     }\n-\n-    /// Returns [`OutputAsset`]s that this chunk data references.\n-    #[turbo_tasks::function]\n-    pub fn references(&self) -> Vc<OutputAssets> {\n-        *self.references\n-    }\n }"
        },
        {
            "sha": "fd41c8fada30d3d7ca6d9e402f23f1126a67d45b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/data.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fdata.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -25,7 +25,6 @@ impl EcmascriptChunkData<'_> {\n             included,\n             excluded,\n             module_chunks,\n-            references: _,\n         } = chunk_data;\n         if included.is_empty() && excluded.is_empty() && module_chunks.is_empty() {\n             return EcmascriptChunkData::Simple(path);"
        },
        {
            "sha": "f55bd2a3295d0b36c0d9dce222dd0b5aa3f9d034",
            "filename": "turbopack/crates/turbopack-ecmascript/src/manifest/chunk_item.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_item.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -77,13 +77,8 @@ impl ChunkItem for ManifestChunkItem {\n     }\n \n     #[turbo_tasks::function]\n-    async fn references(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n-        let mut references = vec![];\n-        for chunk_data in &*self.chunks_data().await? {\n-            references.extend(chunk_data.references().await?.iter());\n-        }\n-\n-        Ok(Vc::cell(references))\n+    async fn references(&self) -> Result<Vc<OutputAssets>> {\n+        Ok(self.manifest.chunks())\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "b7142cf075062d4ae7c49577c98fca63f2826c5b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/manifest/loader_item.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/961dacce586359903c6358fedecdca681b3cfb03/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Floader_item.rs?ref=961dacce586359903c6358fedecdca681b3cfb03",
            "patch": "@@ -93,14 +93,8 @@ impl ChunkItem for ManifestLoaderChunkItem {\n     }\n \n     #[turbo_tasks::function]\n-    async fn references(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n-        let this = self.await?;\n-        let mut references = this.manifest.manifest_chunks().owned().await?;\n-        for chunk_data in &*self.chunks_data().await? {\n-            references.extend(chunk_data.references().await?);\n-        }\n-\n-        Ok(Vc::cell(references))\n+    async fn references(&self) -> Result<Vc<OutputAssets>> {\n+        Ok(self.manifest.manifest_chunks())\n     }\n \n     #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 11,
        "deletions": 53
    }
}