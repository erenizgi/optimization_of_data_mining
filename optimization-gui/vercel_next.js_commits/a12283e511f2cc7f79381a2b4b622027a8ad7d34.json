{
    "author": "mischnic",
    "message": "Turbopack: mode to disable tracing (#83683)\n\nThis means that the default is `TracingMode::Bundling` which has no tracing.\r\n\r\nThis is what you want for most normal bundler use cases, and what we want for our execution contexts for the Node.js loader runners.\r\n\r\nThis should help with #83613",
    "sha": "a12283e511f2cc7f79381a2b4b622027a8ad7d34",
    "files": [
        {
            "sha": "a83e420324308f1ec475d68ae94442a0f555586e",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -28,7 +28,7 @@ use turbopack_core::{\n     module_graph::export_usage::OptionExportUsageInfo,\n     resolve::{parse::Request, pattern::Pattern},\n };\n-use turbopack_ecmascript::{TypeofWindow, chunk::EcmascriptChunkType};\n+use turbopack_ecmascript::{AnalyzeMode, TypeofWindow, chunk::EcmascriptChunkType};\n use turbopack_node::{\n     execution_context::ExecutionContext,\n     transforms::postcss::{PostCssConfigLocation, PostCssTransformOptions},\n@@ -337,6 +337,14 @@ pub async fn get_client_module_options_context(\n         enable_postcss_transform,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n         keep_last_successful_parse: next_mode.is_development(),\n+        analyze_mode: if next_mode.is_development() {\n+            AnalyzeMode::CodeGeneration\n+        } else {\n+            // Technically, this doesn't need to tracing for the client context. But this will\n+            // result in more cache hits for the analysis for modules which are loaded for both ssr\n+            // and client\n+            AnalyzeMode::CodeGenerationAndTracing\n+        },\n         ..Default::default()\n     };\n "
        },
        {
            "sha": "a8bd2758672657ec745bf4ba02ae9222255d4457",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -27,7 +27,7 @@ use turbopack_core::{\n     target::CompileTarget,\n };\n use turbopack_ecmascript::{\n-    TypeofWindow, chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior,\n+    AnalyzeMode, TypeofWindow, chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior,\n };\n use turbopack_ecmascript_plugins::transform::directives::{\n     client::ClientDirectiveTransformer, client_disallowed::ClientDisallowedDirectiveTransformer,\n@@ -592,6 +592,11 @@ pub async fn get_server_module_options_context(\n         },\n         tree_shaking_mode: tree_shaking_mode_for_user_code,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n+        analyze_mode: if next_mode.is_development() {\n+            AnalyzeMode::CodeGeneration\n+        } else {\n+            AnalyzeMode::CodeGenerationAndTracing\n+        },\n         enable_externals_tracing: if next_mode.is_production() {\n             Some(\n                 ExternalsTracingOptions {"
        },
        {
            "sha": "4349f39a39db36cf73f8e1e603fb3cf92b8d1ebc",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/analyzer.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fanalyzer.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -17,11 +17,14 @@ use turbopack_core::{\n     environment::{Environment, ExecutionEnvironment, NodeJsEnvironment, NodeJsVersion},\n     target::CompileTarget,\n };\n-use turbopack_ecmascript::analyzer::{\n-    graph::{EvalContext, VarGraph, VarMeta, create_graph},\n-    imports::ImportAttributes,\n-    linker::link,\n-    test_utils::{early_visitor, visitor},\n+use turbopack_ecmascript::{\n+    AnalyzeMode,\n+    analyzer::{\n+        graph::{EvalContext, VarGraph, VarMeta, create_graph},\n+        imports::ImportAttributes,\n+        linker::link,\n+        test_utils::{early_visitor, visitor},\n+    },\n };\n \n pub fn benchmark(c: &mut Criterion) {\n@@ -62,7 +65,11 @@ pub fn benchmark(c: &mut Criterion) {\n                     None,\n                     None,\n                 );\n-                let var_graph = create_graph(&program, &eval_context, false);\n+                let var_graph = create_graph(\n+                    &program,\n+                    &eval_context,\n+                    AnalyzeMode::CodeGenerationAndTracing,\n+                );\n \n                 let input = BenchInput {\n                     program,\n@@ -88,7 +95,13 @@ struct BenchInput {\n }\n \n fn bench_create_graph(b: &mut Bencher, input: &BenchInput) {\n-    b.iter(|| create_graph(&input.program, &input.eval_context, false));\n+    b.iter(|| {\n+        create_graph(\n+            &input.program,\n+            &input.eval_context,\n+            AnalyzeMode::CodeGenerationAndTracing,\n+        )\n+    });\n }\n \n fn bench_link(b: &mut Bencher, input: &BenchInput) {"
        },
        {
            "sha": "e087ae2e3ea9fc56fa11c60a150fc4a43f3afc3a",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -50,7 +50,7 @@ pub fn benchmark(c: &mut Criterion) {\n             .resolved_cell();\n \n             let mut cases = vec![];\n-            for (file, is_tracing) in [\n+            for (file, analyze_mode) in [\n                 (r#\"packages-bundle.js\"#, false),\n                 (r#\"packages-bundle.js\"#, true),\n                 (r#\"app-page-turbo.runtime.prod.js\"#, false),\n@@ -68,7 +68,11 @@ pub fn benchmark(c: &mut Criterion) {\n                     EcmascriptInputTransforms::empty().to_resolved().await?,\n                     EcmascriptOptions {\n                         tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n-                        is_tracing,\n+                        analyze_mode: if analyze_mode {\n+                            turbopack_ecmascript::AnalyzeMode::Tracing\n+                        } else {\n+                            turbopack_ecmascript::AnalyzeMode::CodeGenerationAndTracing\n+                        },\n                         ..Default::default()\n                     }\n                     .resolved_cell(),\n@@ -80,7 +84,7 @@ pub fn benchmark(c: &mut Criterion) {\n \n                 cases.push((\n                     file.rsplit(\"/\").next().unwrap(),\n-                    if is_tracing { \"tracing\" } else { \"full\" },\n+                    if analyze_mode { \"tracing\" } else { \"full\" },\n                     module,\n                 ));\n             }"
        },
        {
            "sha": "c70870538717378cb345cbdd099b87020af7a01e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/graph.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -29,7 +29,7 @@ use super::{\n     is_unresolved_id,\n };\n use crate::{\n-    SpecifiedModuleType,\n+    AnalyzeMode, SpecifiedModuleType,\n     analyzer::{WellKnownObjectKind, is_unresolved},\n     references::constant_value::parse_single_expr_lit,\n     utils::{AstPathRange, unparen},\n@@ -330,7 +330,11 @@ impl VarGraph {\n \n /// You should use same [Mark] for this function and\n /// [swc_ecma_transforms_base::resolver::resolver_with_mark]\n-pub fn create_graph(m: &Program, eval_context: &EvalContext, is_tracing: bool) -> VarGraph {\n+pub fn create_graph(\n+    m: &Program,\n+    eval_context: &EvalContext,\n+    analyze_mode: AnalyzeMode,\n+) -> VarGraph {\n     let mut graph = VarGraph {\n         values: Default::default(),\n         free_var_ids: Default::default(),\n@@ -339,7 +343,7 @@ pub fn create_graph(m: &Program, eval_context: &EvalContext, is_tracing: bool) -\n \n     m.visit_with_ast_path(\n         &mut Analyzer {\n-            is_tracing,\n+            analyze_mode,\n             data: &mut graph,\n             state: analyzer_state::AnalyzerState::new(),\n             eval_context,\n@@ -860,7 +864,7 @@ pub fn as_parent_path_skip(\n }\n \n struct Analyzer<'a> {\n-    is_tracing: bool,\n+    analyze_mode: AnalyzeMode,\n \n     data: &'a mut VarGraph,\n     state: analyzer_state::AnalyzerState,\n@@ -1467,7 +1471,7 @@ impl Analyzer<'_> {\n         member_expr: &'ast MemberExpr,\n         ast_path: &AstNodePath<AstParentNodeRef<'r>>,\n     ) {\n-        if self.is_tracing {\n+        if !self.analyze_mode.is_code_gen() {\n             return;\n         }\n \n@@ -1501,7 +1505,7 @@ impl Analyzer<'_> {\n                     start_ast_path,\n                 } => {\n                     self.effects = prev_effects;\n-                    if !self.is_tracing {\n+                    if self.analyze_mode.is_code_gen() {\n                         self.effects.push(Effect::Unreachable { start_ast_path });\n                     }\n                     always_returns = true;\n@@ -2229,7 +2233,7 @@ impl VisitAstPath for Analyzer<'_> {\n         }\n \n         // If this identifier is free, produce an effect so we can potentially replace it later.\n-        if !self.is_tracing\n+        if self.analyze_mode.is_code_gen()\n             && let JsValue::FreeVar(var) = self.eval_context.eval_ident(ident)\n         {\n             // TODO(lukesandberg): we should consider filtering effects here, e.g. there is no\n@@ -2267,7 +2271,7 @@ impl VisitAstPath for Analyzer<'_> {\n             return;\n         }\n \n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             // Otherwise 'this' is free\n             self.add_effect(Effect::FreeVar {\n                 var: atom!(\"this\"),\n@@ -2282,7 +2286,7 @@ impl VisitAstPath for Analyzer<'_> {\n         expr: &'ast MetaPropExpr,\n         ast_path: &mut AstNodePath<AstParentNodeRef<'r>>,\n     ) {\n-        if !self.is_tracing && expr.kind == MetaPropKind::ImportMeta {\n+        if self.analyze_mode.is_code_gen() && expr.kind == MetaPropKind::ImportMeta {\n             // MetaPropExpr also covers `new.target`. Only consider `import.meta`\n             // an effect.\n             self.add_effect(Effect::ImportMeta {\n@@ -2533,7 +2537,7 @@ impl VisitAstPath for Analyzer<'_> {\n         n: &'ast UnaryExpr,\n         ast_path: &mut swc_core::ecma::visit::AstNodePath<'r>,\n     ) {\n-        if n.op == UnaryOp::TypeOf && !self.is_tracing {\n+        if n.op == UnaryOp::TypeOf && self.analyze_mode.is_code_gen() {\n             let arg_value = Box::new(self.eval_context.eval(&n.arg));\n \n             self.add_effect(Effect::TypeOf {"
        },
        {
            "sha": "c0678e329412311b08ad02b6de95f88e73758503",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -3813,9 +3813,12 @@ mod tests {\n         graph::{ConditionalKind, Effect, EffectArg, EvalContext, VarGraph, create_graph},\n         linker::link,\n     };\n-    use crate::analyzer::{\n-        graph::{AssignmentScopes, VarMeta},\n-        imports::ImportAttributes,\n+    use crate::{\n+        AnalyzeMode,\n+        analyzer::{\n+            graph::{AssignmentScopes, VarMeta},\n+            imports::ImportAttributes,\n+        },\n     };\n \n     #[fixture(\"tests/analyzer/graph/**/input.js\")]\n@@ -3857,7 +3860,8 @@ mod tests {\n                     None,\n                 );\n \n-                let mut var_graph = create_graph(&m, &eval_context, false);\n+                let mut var_graph =\n+                    create_graph(&m, &eval_context, AnalyzeMode::CodeGenerationAndTracing);\n                 let var_cache = Default::default();\n \n                 let mut named_values = var_graph"
        },
        {
            "sha": "1526daf8ae92d36907cf521bff03544cc7b07f43",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 43,
            "deletions": 1,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -173,6 +173,48 @@ pub enum TreeShakingMode {\n     ReexportsOnly,\n }\n \n+#[derive(\n+    PartialOrd,\n+    Ord,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Debug,\n+    Clone,\n+    Copy,\n+    Default,\n+    Serialize,\n+    Deserialize,\n+    TaskInput,\n+    TraceRawVcs,\n+    NonLocalValue,\n+)]\n+pub enum AnalyzeMode {\n+    /// For bundling only, no tracing of referenced files.\n+    #[default]\n+    CodeGeneration,\n+    /// For bundling and tracing of referenced files.\n+    CodeGenerationAndTracing,\n+    /// For tracing of referenced files only, no bundling (i.e. no codegen).\n+    Tracing,\n+}\n+\n+impl AnalyzeMode {\n+    pub fn is_tracing(self) -> bool {\n+        match self {\n+            AnalyzeMode::Tracing | AnalyzeMode::CodeGenerationAndTracing => true,\n+            AnalyzeMode::CodeGeneration => false,\n+        }\n+    }\n+\n+    pub fn is_code_gen(self) -> bool {\n+        match self {\n+            AnalyzeMode::CodeGeneration | AnalyzeMode::CodeGenerationAndTracing => true,\n+            AnalyzeMode::Tracing => false,\n+        }\n+    }\n+}\n+\n #[turbo_tasks::value(transparent)]\n pub struct OptionTreeShaking(pub Option<TreeShakingMode>);\n \n@@ -222,7 +264,7 @@ pub struct EcmascriptOptions {\n     pub keep_last_successful_parse: bool,\n     /// Whether the modules in this context are never chunked/codegen-ed, but only used for\n     /// tracing.\n-    pub is_tracing: bool,\n+    pub analyze_mode: AnalyzeMode,\n     // TODO this should just be handled via CompileTimeInfo FreeVarReferences, but then it\n     // (currently) wouldn't be possible to have different replacement values in user code vs\n     // node_modules."
        },
        {
            "sha": "229add4f32a805add662de1a67b739150851eb4b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -84,7 +84,7 @@ impl Display for CachedExternalType {\n pub struct CachedExternalModule {\n     request: RcStr,\n     external_type: CachedExternalType,\n-    tracing_mode: CachedExternalTracingMode,\n+    analyze_mode: CachedExternalTracingMode,\n }\n \n #[turbo_tasks::value_impl]\n@@ -93,12 +93,12 @@ impl CachedExternalModule {\n     pub fn new(\n         request: RcStr,\n         external_type: CachedExternalType,\n-        tracing_mode: CachedExternalTracingMode,\n+        analyze_mode: CachedExternalTracingMode,\n     ) -> Vc<Self> {\n         Self::cell(CachedExternalModule {\n             request,\n             external_type,\n-            tracing_mode,\n+            analyze_mode,\n         })\n     }\n \n@@ -226,7 +226,7 @@ impl Module for CachedExternalModule {\n \n     #[turbo_tasks::function]\n     async fn references(&self) -> Result<Vc<ModuleReferences>> {\n-        Ok(match &self.tracing_mode {\n+        Ok(match &self.analyze_mode {\n             CachedExternalTracingMode::Untraced => ModuleReferences::empty(),\n             CachedExternalTracingMode::Traced {\n                 externals_context,"
        },
        {
            "sha": "810ef19b9144445782c8b349171b7d9e4f9fcaa0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 74,
            "deletions": 38,
            "changes": 112,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -128,8 +128,8 @@ use super::{\n };\n pub use crate::references::esm::export::{FollowExportsResult, follow_reexports};\n use crate::{\n-    EcmascriptInputTransforms, EcmascriptModuleAsset, EcmascriptParsable, SpecifiedModuleType,\n-    TreeShakingMode, TypeofWindow,\n+    AnalyzeMode, EcmascriptInputTransforms, EcmascriptModuleAsset, EcmascriptParsable,\n+    SpecifiedModuleType, TreeShakingMode, TypeofWindow,\n     analyzer::{\n         ConstantNumber, ConstantString, JsValueUrlKind, RequireContextValue,\n         builtin::early_replace_builtin,\n@@ -212,7 +212,7 @@ impl AnalyzeEcmascriptModuleResult {\n /// A temporary analysis result builder to pass around, to be turned into an\n /// `Vc<AnalyzeEcmascriptModuleResult>` eventually.\n pub struct AnalyzeEcmascriptModuleResultBuilder {\n-    is_tracing: bool,\n+    analyze_mode: AnalyzeMode,\n \n     references: FxIndexSet<ResolvedVc<Box<dyn ModuleReference>>>,\n \n@@ -234,9 +234,9 @@ pub struct AnalyzeEcmascriptModuleResultBuilder {\n }\n \n impl AnalyzeEcmascriptModuleResultBuilder {\n-    pub fn new(is_tracing: bool) -> Self {\n+    pub fn new(analyze_mode: AnalyzeMode) -> Self {\n         Self {\n-            is_tracing,\n+            analyze_mode,\n             references: Default::default(),\n             esm_references: Default::default(),\n             esm_local_references: Default::default(),\n@@ -290,7 +290,7 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n     where\n         C: Into<CodeGen>,\n     {\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.code_gens.push(code_gen.into())\n         }\n     }\n@@ -510,11 +510,11 @@ pub async fn analyse_ecmascript_module_internal(\n     let options = raw_module.options;\n     let options = options.await?;\n     let import_externals = options.import_externals;\n-    let is_tracing = options.is_tracing;\n+    let analyze_mode = options.analyze_mode;\n \n     let origin = ResolvedVc::upcast::<Box<dyn ResolveOrigin>>(module);\n \n-    let mut analysis = AnalyzeEcmascriptModuleResultBuilder::new(is_tracing);\n+    let mut analysis = AnalyzeEcmascriptModuleResultBuilder::new(analyze_mode);\n     let path = &*origin.origin_path().await?;\n \n     // Is this a typescript file that requires analyzing type references?\n@@ -687,7 +687,7 @@ pub async fn analyse_ecmascript_module_internal(\n     let mut var_graph = {\n         let _span = tracing::info_span!(\"analyze variable values\").entered();\n         set_handler_and_globals(&handler, globals, || {\n-            create_graph(program, eval_context, is_tracing)\n+            create_graph(program, eval_context, analyze_mode)\n         })\n     };\n \n@@ -754,7 +754,7 @@ pub async fn analyse_ecmascript_module_internal(\n                     eval_context,\n                     &import_references,\n                     &mut analysis,\n-                    is_tracing,\n+                    analyze_mode,\n                     &var_graph,\n                 );\n                 // ModuleReferencesVisitor has already called analysis.add_esm_reexport_reference\n@@ -1008,7 +1008,7 @@ pub async fn analyse_ecmascript_module_internal(\n             match effect {\n                 Effect::Unreachable { start_ast_path } => {\n                     debug_assert!(\n-                        !is_tracing,\n+                        analyze_mode.is_code_gen(),\n                         \"unexpected Effect::Unreachable in tracing mode\"\n                     );\n \n@@ -1031,14 +1031,14 @@ pub async fn analyse_ecmascript_module_internal(\n \n                     macro_rules! inactive {\n                         ($block:ident) => {\n-                            if !is_tracing {\n+                            if analyze_mode.is_code_gen() {\n                                 analysis.add_code_gen(Unreachable::new($block.range.clone()));\n                             }\n                         };\n                     }\n                     macro_rules! condition {\n                         ($expr:expr) => {\n-                            if !is_tracing && !condition_has_side_effects {\n+                            if analyze_mode.is_code_gen() && !condition_has_side_effects {\n                                 analysis.add_code_gen(ConstantConditionCodeGen::new(\n                                     $expr,\n                                     condition_ast_path.to_vec().into(),\n@@ -1286,7 +1286,10 @@ pub async fn analyse_ecmascript_module_internal(\n                     ast_path,\n                     span,\n                 } => {\n-                    debug_assert!(!is_tracing, \"unexpected Effect::FreeVar in tracing mode\");\n+                    debug_assert!(\n+                        analyze_mode.is_code_gen(),\n+                        \"unexpected Effect::FreeVar in tracing mode\"\n+                    );\n \n                     // FreeVar(\"require\") might be turbopackIgnore-d\n                     if !analysis_state\n@@ -1314,7 +1317,10 @@ pub async fn analyse_ecmascript_module_internal(\n                     ast_path,\n                     span,\n                 } => {\n-                    debug_assert!(!is_tracing, \"unexpected Effect::Member in tracing mode\");\n+                    debug_assert!(\n+                        analyze_mode.is_code_gen(),\n+                        \"unexpected Effect::Member in tracing mode\"\n+                    );\n \n                     // Intentionally not awaited because `handle_member` reads this only when needed\n                     let obj = analysis_state.link_value(*obj, ImportAttributes::empty_ref());\n@@ -1387,14 +1393,20 @@ pub async fn analyse_ecmascript_module_internal(\n                     ast_path,\n                     span,\n                 } => {\n-                    debug_assert!(!is_tracing, \"unexpected Effect::TypeOf in tracing mode\");\n+                    debug_assert!(\n+                        analyze_mode.is_code_gen(),\n+                        \"unexpected Effect::TypeOf in tracing mode\"\n+                    );\n                     let arg = analysis_state\n                         .link_value(*arg, ImportAttributes::empty_ref())\n                         .await?;\n                     handle_typeof(&ast_path, arg, span, &analysis_state, &mut analysis).await?;\n                 }\n                 Effect::ImportMeta { ast_path, span: _ } => {\n-                    debug_assert!(!is_tracing, \"unexpected Effect::ImportMeta in tracing mode\");\n+                    debug_assert!(\n+                        analyze_mode.is_code_gen(),\n+                        \"unexpected Effect::ImportMeta in tracing mode\"\n+                    );\n                     if analysis_state.first_import_meta {\n                         analysis_state.first_import_meta = false;\n                         analysis.add_code_gen(ImportMetaBinding::new(\n@@ -1916,7 +1928,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n             );\n         }\n \n-        JsValue::WellKnownFunction(WellKnownFunctionKind::FsReadMethod(name)) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::FsReadMethod(name))\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if !args.is_empty() {\n                 let pat = js_value_to_pattern(&args[0]);\n@@ -1948,7 +1962,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n             )\n         }\n \n-        JsValue::WellKnownFunction(WellKnownFunctionKind::PathResolve(..)) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::PathResolve(..))\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let parent_path = origin.origin_path().owned().await?.parent();\n             let args = linked_args(args).await?;\n \n@@ -1988,7 +2004,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n             return Ok(());\n         }\n \n-        JsValue::WellKnownFunction(WellKnownFunctionKind::PathJoin) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::PathJoin)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let context_path = source.ident().path().await?;\n             // ignore path.join in `node-gyp`, it will includes too many files\n             if context_path.path.contains(\"node_modules/node-gyp\") {\n@@ -2025,7 +2043,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n             );\n             return Ok(());\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::ChildProcessSpawnMethod(name)) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::ChildProcessSpawnMethod(name))\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n \n             // Is this specifically `spawn(process.argv[0], ['-e', ...])`?\n@@ -2092,7 +2112,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::ChildProcessFork) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::ChildProcessFork)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if !args.is_empty() {\n                 let first_arg = &args[0];\n@@ -2131,7 +2153,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodePreGypFind) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodePreGypFind)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             use turbopack_resolve::node_native_binding::NodePreGypConfigReference;\n \n             let args = linked_args(args).await?;\n@@ -2173,7 +2197,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeGypBuild) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeGypBuild)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             use turbopack_resolve::node_native_binding::NodeGypBuildReference;\n \n             let args = linked_args(args).await?;\n@@ -2211,7 +2237,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeBindings) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeBindings)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             use turbopack_resolve::node_native_binding::NodeBindingsReference;\n \n             let args = linked_args(args).await?;\n@@ -2237,7 +2265,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeExpressSet) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeExpressSet)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if args.len() == 2\n                 && let Some(s) = args.first().and_then(|arg| arg.as_str())\n@@ -2316,7 +2346,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeStrongGlobalizeSetRootDir) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeStrongGlobalizeSetRootDir)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if let Some(p) = args.first().and_then(|arg| arg.as_str()) {\n                 let abs_pattern = if p.starts_with(\"/ROOT/\") {\n@@ -2358,7 +2390,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeResolveFrom) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeResolveFrom)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if args.len() == 2 && args.get(1).and_then(|arg| arg.as_str()).is_some() {\n                 analysis.add_reference(\n@@ -2382,7 +2416,9 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 ),\n             )\n         }\n-        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeProtobufLoad) => {\n+        JsValue::WellKnownFunction(WellKnownFunctionKind::NodeProtobufLoad)\n+            if analysis.analyze_mode.is_tracing() =>\n+        {\n             let args = linked_args(args).await?;\n             if args.len() == 2\n                 && let Some(JsValue::Object { parts, .. }) = args.get(1)\n@@ -3202,7 +3238,7 @@ impl StaticAnalyser {\n /// A visitor that walks the AST and collects information about the various\n /// references a module makes to other parts of the code.\n struct ModuleReferencesVisitor<'a> {\n-    is_tracing: bool,\n+    analyze_mode: AnalyzeMode,\n     eval_context: &'a EvalContext,\n     old_analyser: StaticAnalyser,\n     import_references: &'a [ResolvedVc<EsmAssetReference>],\n@@ -3219,11 +3255,11 @@ impl<'a> ModuleReferencesVisitor<'a> {\n         eval_context: &'a EvalContext,\n         import_references: &'a [ResolvedVc<EsmAssetReference>],\n         analysis: &'a mut AnalyzeEcmascriptModuleResultBuilder,\n-        is_tracing: bool,\n+        analyze_mode: AnalyzeMode,\n         var_graph: &'a VarGraph,\n     ) -> Self {\n         Self {\n-            is_tracing,\n+            analyze_mode,\n             eval_context,\n             old_analyser: StaticAnalyser::default(),\n             import_references,\n@@ -3303,7 +3339,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n         export: &'ast ExportAll,\n         ast_path: &mut AstNodePath<AstParentNodeRef<'r>>,\n     ) {\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis\n                 .add_code_gen(EsmModuleItem::new(as_parent_path(ast_path).into()));\n         }\n@@ -3391,7 +3427,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n             }\n         }\n \n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis\n                 .add_code_gen(EsmModuleItem::new(as_parent_path(ast_path).into()));\n         }\n@@ -3439,7 +3475,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n                 }\n             }\n         };\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis\n                 .add_code_gen(EsmModuleItem::new(as_parent_path(ast_path).into()));\n         }\n@@ -3459,7 +3495,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n                 Liveness::Constant,\n             ),\n         );\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis\n                 .add_code_gen(EsmModuleItem::new(as_parent_path(ast_path).into()));\n         }\n@@ -3494,7 +3530,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n                 // ignore\n             }\n         }\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis\n                 .add_code_gen(EsmModuleItem::new(as_parent_path(ast_path).into()));\n         }\n@@ -3542,7 +3578,7 @@ impl VisitAstPath for ModuleReferencesVisitor<'_> {\n                 }\n             }\n         }\n-        if !self.is_tracing {\n+        if self.analyze_mode.is_code_gen() {\n             self.analysis.add_code_gen(EsmModuleItem::new(path));\n         }\n     }"
        },
        {
            "sha": "d73a331a4b39b27c07a2a21e1d412fe56ec32165",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -6,6 +6,7 @@ use turbo_tasks::{ResolvedVc, TransientInstance, TryJoinIterExt, ValueToString,\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n     ModuleAssetContext,\n+    ecmascript::AnalyzeMode,\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n         TypescriptTransformOptions,\n@@ -95,7 +96,7 @@ async fn node_file_trace_operation(\n             // Environment is not passed in order to avoid downleveling JS / CSS for\n             // node-file-trace.\n             environment: None,\n-            is_tracing: true,\n+            analyze_mode: AnalyzeMode::Tracing,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "7b295a7abb181b8506a267ea50e732b572e62363",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -20,7 +20,9 @@ use turbo_tasks_fs::{\n use turbo_unix_path::sys_to_unix;\n use turbopack::{\n     ModuleAssetContext,\n-    ecmascript::{EcmascriptInputTransform, TreeShakingMode, chunk::EcmascriptChunkType},\n+    ecmascript::{\n+        AnalyzeMode, EcmascriptInputTransform, TreeShakingMode, chunk::EcmascriptChunkType,\n+    },\n     module_options::{\n         EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext, ModuleRule,\n         ModuleRuleEffect, RuleCondition, TypescriptTransformOptions,\n@@ -356,12 +358,14 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                 ModuleOptionsContext {\n                     environment: Some(env),\n                     tree_shaking_mode: options.tree_shaking_mode,\n+                    analyze_mode: AnalyzeMode::CodeGenerationAndTracing,\n                     ..Default::default()\n                 }\n                 .resolved_cell(),\n             )],\n             module_rules: vec![module_rules],\n             tree_shaking_mode: options.tree_shaking_mode,\n+            analyze_mode: AnalyzeMode::CodeGenerationAndTracing,\n             ..Default::default()\n         }\n         .into(),"
        },
        {
            "sha": "523cff26d55b61503239db7aa785ec4fd1dc3d74",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -33,7 +33,9 @@ use turbo_tasks::{\n use turbo_tasks_backend::TurboTasksBackend;\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n-    ModuleAssetContext, emit_with_completion_operation,\n+    ModuleAssetContext,\n+    ecmascript::AnalyzeMode,\n+    emit_with_completion_operation,\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n         TypescriptTransformOptions,\n@@ -373,7 +375,7 @@ async fn node_file_trace_operation(\n             // Environment is not passed in order to avoid downleveling JS / CSS for\n             // node-file-trace.\n             environment: None,\n-            is_tracing: true,\n+            analyze_mode: AnalyzeMode::Tracing,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "1ce07b5647c86ed5f04dc528eb0deb180c9d17ac",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -15,6 +15,7 @@ use turbo_tasks_backend::TurboTasksBackend;\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n     ModuleAssetContext,\n+    ecmascript::AnalyzeMode,\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n         TypescriptTransformOptions,\n@@ -210,7 +211,7 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n             // Environment is not passed in order to avoid downleveling JS / CSS for\n             // node-file-trace.\n             environment: None,\n-            is_tracing: true,\n+            analyze_mode: AnalyzeMode::Tracing,\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "c20520f906c45d29957be1b284273242c7845f9f",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -56,6 +56,7 @@ use turbopack_core::{\n pub use turbopack_css as css;\n pub use turbopack_ecmascript as ecmascript;\n use turbopack_ecmascript::{\n+    AnalyzeMode,\n     inlined_bytes_module::InlinedBytesJsModule,\n     references::external_module::{\n         CachedExternalModule, CachedExternalTracingMode, CachedExternalType,\n@@ -719,7 +720,7 @@ pub async fn externals_tracing_module_context(\n             // Environment is not passed in order to avoid downleveling JS / CSS for\n             // node-file-trace.\n             environment: None,\n-            is_tracing: true,\n+            analyze_mode: AnalyzeMode::Tracing,\n             ..Default::default()\n         }\n         .cell(),\n@@ -824,7 +825,7 @@ impl AssetContext for ModuleAssetContext {\n                         }\n                         ResolveResultItem::External { name, ty, traced } => {\n                             let replacement = if replace_externals {\n-                                let tracing_mode = if traced == ExternalTraced::Traced\n+                                let analyze_mode = if traced == ExternalTraced::Traced\n                                     && let Some(options) = &self\n                                         .module_options_context()\n                                         .await?\n@@ -850,7 +851,7 @@ impl AssetContext for ModuleAssetContext {\n                                     CachedExternalTracingMode::Untraced\n                                 };\n \n-                                replace_external(&name, ty, import_externals, tracing_mode).await?\n+                                replace_external(&name, ty, import_externals, analyze_mode).await?\n                             } else {\n                                 None\n                             };\n@@ -1003,7 +1004,7 @@ pub async fn replace_external(\n     name: &RcStr,\n     ty: ExternalType,\n     import_externals: bool,\n-    tracing_mode: CachedExternalTracingMode,\n+    analyze_mode: CachedExternalTracingMode,\n ) -> Result<Option<ModuleResolveResultItem>> {\n     let external_type = match ty {\n         ExternalType::CommonJs => CachedExternalType::CommonJs,\n@@ -1022,7 +1023,7 @@ pub async fn replace_external(\n         }\n     };\n \n-    let module = CachedExternalModule::new(name.clone(), external_type, tracing_mode)\n+    let module = CachedExternalModule::new(name.clone(), external_type, analyze_mode)\n         .to_resolved()\n         .await?;\n "
        },
        {
            "sha": "19eb7dda411497566da3eed19972513f254b8a2a",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -227,7 +227,7 @@ impl ModuleOptions {\n             execution_context,\n             tree_shaking_mode,\n             keep_last_successful_parse,\n-            is_tracing,\n+            analyze_mode,\n             ..\n         } = *module_options_context.await?;\n \n@@ -280,7 +280,7 @@ impl ModuleOptions {\n             ignore_dynamic_requests,\n             extract_source_map: matches!(ecmascript_source_maps, SourceMapsType::Full),\n             keep_last_successful_parse,\n-            is_tracing,\n+            analyze_mode,\n             enable_typeof_window_inlining,\n             ..Default::default()\n         };"
        },
        {
            "sha": "2c086adb8abb0367ad70072206cc5fc5d83de154",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a12283e511f2cc7f79381a2b4b622027a8ad7d34/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=a12283e511f2cc7f79381a2b4b622027a8ad7d34",
            "patch": "@@ -9,7 +9,9 @@ use turbopack_core::{\n     chunk::SourceMapsType, compile_time_info::CompileTimeInfo, condition::ContextCondition,\n     environment::Environment, resolve::options::ImportMapping,\n };\n-use turbopack_ecmascript::{TreeShakingMode, TypeofWindow, references::esm::UrlRewriteBehavior};\n+use turbopack_ecmascript::{\n+    AnalyzeMode, TreeShakingMode, TypeofWindow, references::esm::UrlRewriteBehavior,\n+};\n pub use turbopack_mdx::MdxTransformOptions;\n use turbopack_node::{\n     execution_context::ExecutionContext,\n@@ -207,7 +209,7 @@ pub struct ModuleOptionsContext {\n \n     /// Whether the modules in this context are never chunked/codegen-ed, but only used for\n     /// tracing.\n-    pub is_tracing: bool,\n+    pub analyze_mode: AnalyzeMode,\n \n     pub placeholder_for_future_extensions: (),\n }"
        }
    ],
    "stats": {
        "total": 293,
        "additions": 210,
        "deletions": 83
    }
}