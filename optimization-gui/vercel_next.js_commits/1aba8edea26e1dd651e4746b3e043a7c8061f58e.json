{
    "author": "unstubbable",
    "message": "Do not cache fetches with `'no-store'` in `\"use cache\"` during SSG (#80052)",
    "sha": "1aba8edea26e1dd651e4746b3e043a7c8061f58e",
    "files": [
        {
            "sha": "87c9353fccf6b896bd76491aa6a200d907b67dae",
            "filename": ".changeset/pretty-suns-watch.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/.changeset%2Fpretty-suns-watch.md",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/.changeset%2Fpretty-suns-watch.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fpretty-suns-watch.md?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+\"next\": patch\n+---\n+\n+Do not cache fetches with 'no-store' in \"use cache\" during SSG"
        },
        {
            "sha": "c07207635bae8dbbd9c0eb59117338d9ec24e878",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -246,7 +246,8 @@ export function createPatchedFetcher(\n         }\n         // RequestInit doesn't keep extra fields e.g. next so it's\n         // only available if init is used separate\n-        let currentFetchRevalidate = getNextField('revalidate')\n+        const originalFetchRevalidate = getNextField('revalidate')\n+        let currentFetchRevalidate = originalFetchRevalidate\n         const tags: string[] = validateTags(\n           getNextField('tags') || [],\n           `fetch ${input.toString()}`\n@@ -339,11 +340,8 @@ export function createPatchedFetcher(\n         ) {\n           currentFetchRevalidate = false\n         } else if (\n-          // if we are inside of \"use cache\"/\"unstable_cache\"\n-          // we shouldn't set the revalidate to 0 as it's overridden\n-          // by the cache context\n-          workUnitStore?.type !== 'cache' &&\n-          (hasExplicitFetchCacheOptOut || noFetchConfigAndForceDynamic)\n+          hasExplicitFetchCacheOptOut ||\n+          noFetchConfigAndForceDynamic\n         ) {\n           currentFetchRevalidate = 0\n         }\n@@ -531,8 +529,9 @@ export function createPatchedFetcher(\n           }\n \n           // We only want to set the revalidate store's revalidate time if it\n-          // was explicitly set for the fetch call, i.e. currentFetchRevalidate.\n-          if (revalidateStore && currentFetchRevalidate === finalRevalidate) {\n+          // was explicitly set for the fetch call, i.e.\n+          // originalFetchRevalidate.\n+          if (revalidateStore && originalFetchRevalidate === finalRevalidate) {\n             revalidateStore.revalidate = finalRevalidate\n           }\n         }"
        },
        {
            "sha": "419f258d0d9f4bcdc64963db1248a1923e3f742f",
            "filename": "test/e2e/app-dir/use-cache/app/cache-fetch-no-store/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fcache-fetch-no-store%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fcache-fetch-no-store%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fcache-fetch-no-store%2Fpage.tsx?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -3,9 +3,10 @@ import React from 'react'\n async function getData() {\n   'use cache'\n \n-  return fetch('https://next-data-api-endpoint.vercel.app/api/random', {\n-    cache: 'no-store',\n-  }).then((res) => res.text())\n+  return fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random?no-store',\n+    { cache: 'no-store' }\n+  ).then((res) => res.text())\n }\n \n export default async function Page() {"
        },
        {
            "sha": "326e433bdcadec1855f460f54fe02922ef8edd7f",
            "filename": "test/e2e/app-dir/use-cache/incremental-cache-handler.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fincremental-cache-handler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fincremental-cache-handler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fincremental-cache-handler.js?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -0,0 +1,13 @@\n+const {\n+  default: FileSystemCache,\n+} = require('next/dist/server/lib/incremental-cache/file-system-cache')\n+\n+module.exports = class IncrementalCacheHandler extends FileSystemCache {\n+  async set(key, data, ctx) {\n+    if (ctx.fetchCache) {\n+      console.log('cache-handler set fetch cache', ctx.fetchUrl)\n+    }\n+\n+    return super.set(key, data, ctx)\n+  }\n+}"
        },
        {
            "sha": "da890801cdfe640da1b0a8ef2c85601276bf29a0",
            "filename": "test/e2e/app-dir/use-cache/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -16,6 +16,7 @@ const nextConfig = {\n       custom: require.resolve('next/dist/server/lib/cache-handlers/default'),\n     },\n   },\n+  cacheHandler: require.resolve('./incremental-cache-handler'),\n }\n \n module.exports = nextConfig"
        },
        {
            "sha": "36f7693619387aab7b544576fc1b460ba81511f2",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1aba8edea26e1dd651e4746b3e043a7c8061f58e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=1aba8edea26e1dd651e4746b3e043a7c8061f58e",
            "patch": "@@ -637,6 +637,28 @@ describe('use-cache', () => {\n     expect(await browser.elementByCss('#random').text()).toBe(initialValue)\n   })\n \n+  if (isNextStart) {\n+    // TODO: This is an SSG optimization to share fetch responses during SSG\n+    // (see #68546). Decide whether we want to keep this feature in the context\n+    // of \"use cache\". Alternatively, instead of de-opting entirely, we might\n+    // want a similar optimization using a build-specific default \"use cache\"\n+    // cache handler that utilizes the file system, instead of piggybacking on\n+    // the incremental cache handler for inner fetches.\n+    it('should store a fetch response without no-store in the incremental cache handler during build', async () => {\n+      expect(next.cliOutput).toContain(\n+        'cache-handler set fetch cache https://next-data-api-endpoint.vercel.app/api/random'\n+      )\n+    })\n+\n+    // The no-store fetch cache option opts the response out of the SSG\n+    // optimization to share fetch responses within an export worker.\n+    it('should not store a fetch response with no-store in the incremental cache handler during build', async () => {\n+      expect(next.cliOutput).not.toContain(\n+        'cache-handler set fetch cache https://next-data-api-endpoint.vercel.app/api/random?no-store'\n+      )\n+    })\n+  }\n+\n   it('should override fetch with cookies/auth in use cache properly', async () => {\n     const browser = await next.browser('/cache-fetch-auth-header')\n "
        }
    ],
    "stats": {
        "total": 63,
        "additions": 52,
        "deletions": 11
    }
}