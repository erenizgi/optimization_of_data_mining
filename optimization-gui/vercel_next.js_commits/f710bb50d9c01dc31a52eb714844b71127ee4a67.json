{
    "author": "huozhi",
    "message": "[turbopack] set app dir only to true when no pages entries detected (#84144)",
    "sha": "f710bb50d9c01dc31a52eb714844b71127ee4a67",
    "files": [
        {
            "sha": "da12024a7683970801545b81db8e82bfc3a5ffdd",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f710bb50d9c01dc31a52eb714844b71127ee4a67/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f710bb50d9c01dc31a52eb714844b71127ee4a67/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=f710bb50d9c01dc31a52eb714844b71127ee4a67",
            "patch": "@@ -848,12 +848,7 @@ impl Project {\n         let mut endpoints = Vec::new();\n \n         let entrypoints = self.entrypoints().await?;\n-\n-        // Always include these basic pages endpoints regardless of `app_dir_only`. The user's\n-        // page routes themselves are excluded below.\n-        endpoints.push(entrypoints.pages_error_endpoint);\n-        endpoints.push(entrypoints.pages_app_endpoint);\n-        endpoints.push(entrypoints.pages_document_endpoint);\n+        let mut is_pages_entries_added = false;\n \n         if let Some(middleware) = &entrypoints.middleware {\n             endpoints.push(middleware.endpoint);\n@@ -872,11 +867,23 @@ impl Project {\n                 } => {\n                     if !app_dir_only {\n                         endpoints.push(*html_endpoint);\n+                        if !is_pages_entries_added {\n+                            endpoints.push(entrypoints.pages_error_endpoint);\n+                            endpoints.push(entrypoints.pages_app_endpoint);\n+                            endpoints.push(entrypoints.pages_document_endpoint);\n+                            is_pages_entries_added = true;\n+                        }\n                     }\n                 }\n                 Route::PageApi { endpoint } => {\n                     if !app_dir_only {\n                         endpoints.push(*endpoint);\n+                        if !is_pages_entries_added {\n+                            endpoints.push(entrypoints.pages_error_endpoint);\n+                            endpoints.push(entrypoints.pages_app_endpoint);\n+                            endpoints.push(entrypoints.pages_document_endpoint);\n+                            is_pages_entries_added = true;\n+                        }\n                     }\n                 }\n                 Route::AppPage(page_routes) => {"
        },
        {
            "sha": "7c036407cf2676ab8ec1ece3f1cc097e5d3ffbc2",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f710bb50d9c01dc31a52eb714844b71127ee4a67/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f710bb50d9c01dc31a52eb714844b71127ee4a67/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=f710bb50d9c01dc31a52eb714844b71127ee4a67",
            "patch": "@@ -41,7 +41,6 @@ export async function turbopackBuild(): Promise<{\n   const previewProps = NextBuildContext.previewProps!\n   const hasRewrites = NextBuildContext.hasRewrites!\n   const rewrites = NextBuildContext.rewrites!\n-  const appDirOnly = NextBuildContext.appDirOnly!\n   const noMangling = NextBuildContext.noMangling!\n   const currentNodeJsVersion = process.versions.node\n \n@@ -107,9 +106,23 @@ export async function turbopackBuild(): Promise<{\n       '{\"type\": \"commonjs\"}'\n     )\n \n+    let appDirOnly = NextBuildContext.appDirOnly!\n     // eslint-disable-next-line @typescript-eslint/no-unused-vars\n     const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n \n+    const hasPagesEntries = Array.from(entrypoints.routes.values()).some(\n+      (route) => {\n+        if (route.type === 'page' || route.type === 'page-api') {\n+          return true\n+        }\n+        return false\n+      }\n+    )\n+    // If there's no pages entries, then we are in app-dir-only mode\n+    if (!hasPagesEntries) {\n+      appDirOnly = true\n+    }\n+\n     const manifestLoader = new TurbopackManifestLoader({\n       buildId,\n       distDir,"
        },
        {
            "sha": "a4b8c7afb3f6de0dd93d43fc720d1ff15d0e6fbe",
            "filename": "test/production/500-page/app-router-only/app-router-only.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 12,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/f710bb50d9c01dc31a52eb714844b71127ee4a67/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f710bb50d9c01dc31a52eb714844b71127ee4a67/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts?ref=f710bb50d9c01dc31a52eb714844b71127ee4a67",
            "patch": "@@ -3,7 +3,7 @@ import fsp from 'fs/promises'\n import path from 'path'\n \n describe('500-page app-router-only', () => {\n-  const { next, isNextStart, isTurbopack, isNextDeploy } = nextTestSetup({\n+  const { next, isNextStart, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -48,17 +48,9 @@ describe('500-page app-router-only', () => {\n       const pagesDir = path.join(next.testDir, '.next', 'server', 'pages')\n       const files = await fsp.readdir(pagesDir)\n       expect(files).not.toContain('500')\n-      if (isTurbopack) {\n-        // In turbopack, _app, _document, _error are still generated with manifest, but no javascript files.\n-        // The manifest are under the folder, they're still needed for static generation.\n-        expect(files).not.toContain('_app.js')\n-        expect(files).not.toContain('_document.js')\n-        expect(files).not.toContain('_error.js')\n-      } else {\n-        expect(files).not.toContain('_app')\n-        expect(files).not.toContain('_document')\n-        expect(files).not.toContain('_error')\n-      }\n+      expect(files).not.toContain('_app')\n+      expect(files).not.toContain('_document')\n+      expect(files).not.toContain('_error')\n     })\n   }\n })"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 31,
        "deletions": 19
    }
}