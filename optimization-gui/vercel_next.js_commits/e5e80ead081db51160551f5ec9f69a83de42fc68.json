{
    "author": "timneutkens",
    "message": "Build: Share StaticWorker between static check and static generation (#85860)\n\n## What?\n\nShares `static check` and `static generation` workers.\n\nOn hello-world:\n\nBefore:\n\n```\nnext build test/e2e/app-dir/hello-world  7.58s user 1.07s system 332% cpu 2.603 total\n```\n\nAfter:\n\n```\nnext build test/e2e/app-dir/hello-world  7.18s user 0.87s system 308% cpu 2.612 total\n```",
    "sha": "e5e80ead081db51160551f5ec9f69a83de42fc68",
    "files": [
        {
            "sha": "557496c064376dbaeb13222b24ff9be5d50199b3",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 9,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=e5e80ead081db51160551f5ec9f69a83de42fc68",
            "patch": "@@ -872,6 +872,9 @@ async function writeFullyStaticExport(\n   configOutDir: string,\n   nextBuildSpan: Span,\n   appDirOnly: boolean\n+  // TODO: Reusing the worker seems to break finding if it's `.html` or a JS page.\n+  // Because writeFullyStaticExport is called after `exportApp` has been called before\n+  // worker: StaticWorker | undefined\n ): Promise<void> {\n   const exportApp = (require('../export') as typeof import('../export'))\n     .default as typeof import('../export').default\n@@ -888,6 +891,7 @@ async function writeFullyStaticExport(\n       appDirOnly,\n     },\n     nextBuildSpan\n+    // worker\n   )\n }\n \n@@ -927,6 +931,7 @@ export default async function build(\n   let appType: RoutesManifest['appType']\n \n   let loadedConfig: NextConfigComplete | undefined\n+  let staticWorker: StaticWorker\n   try {\n     const nextBuildSpan = trace('next-build', undefined, {\n       buildMode: experimentalBuildMode,\n@@ -1977,7 +1982,7 @@ export default async function build(\n \n       process.env.NEXT_PHASE = PHASE_PRODUCTION_BUILD\n \n-      const worker = createStaticWorker(config, {\n+      staticWorker = createStaticWorker(config, {\n         numberOfWorkers,\n         debuggerPortOffset: -1,\n       })\n@@ -2015,7 +2020,7 @@ export default async function build(\n           nonStaticErrorPageSpan.traceAsyncFn(\n             async () =>\n               hasCustomErrorPage &&\n-              (await worker.hasCustomGetInitialProps({\n+              (await staticWorker.hasCustomGetInitialProps({\n                 page: '/_error',\n                 distDir,\n                 checkingApp: false,\n@@ -2026,7 +2031,7 @@ export default async function build(\n         const errorPageStaticResult = nonStaticErrorPageSpan.traceAsyncFn(\n           async () =>\n             hasCustomErrorPage &&\n-            worker.isPageStatic({\n+            staticWorker.isPageStatic({\n               dir,\n               page: '/_error',\n               distDir,\n@@ -2048,7 +2053,7 @@ export default async function build(\n         const appPageToCheck = '/_app'\n \n         const customAppGetInitialPropsPromise = hasUserPagesRoutes\n-          ? worker.hasCustomGetInitialProps({\n+          ? staticWorker.hasCustomGetInitialProps({\n               page: appPageToCheck,\n               distDir,\n               checkingApp: true,\n@@ -2057,7 +2062,7 @@ export default async function build(\n           : Promise.resolve(false)\n \n         const namedExportsPromise = hasUserPagesRoutes\n-          ? worker.getDefinedNamedExports({\n+          ? staticWorker.getDefinedNamedExports({\n               page: appPageToCheck,\n               distDir,\n               sriEnabled,\n@@ -2237,7 +2242,7 @@ export default async function build(\n                         checkPageSpan.traceChild('is-page-static')\n                       let workerResult = await isPageStaticSpan.traceAsyncFn(\n                         () => {\n-                          return worker.isPageStatic({\n+                          return staticWorker.isPageStatic({\n                             dir,\n                             page,\n                             originalAppPath,\n@@ -3089,7 +3094,8 @@ export default async function build(\n               numWorkers: numberOfWorkers,\n               appDirOnly,\n             },\n-            nextBuildSpan\n+            nextBuildSpan,\n+            staticWorker\n           )\n \n           // If there was no result, there's nothing more to do.\n@@ -4018,8 +4024,12 @@ export default async function build(\n         buildTracesSpinner = createSpinner('Collecting build traces')\n       }\n \n-      // ensure the worker is not left hanging\n-      worker.end()\n+      // When output: export we want to end the worker later as it's still used for writeFullyStaticExport\n+      if (config.output !== 'export') {\n+        // ensure the worker is not left hanging\n+        staticWorker?.end()\n+        staticWorker = undefined! // Reset staticWorker to make sure it does not end in `finally`\n+      }\n \n       const analysisEnd = process.hrtime(analysisBegin)\n       telemetry.record(\n@@ -4194,6 +4204,11 @@ export default async function build(\n       }\n \n       if (config.output === 'export') {\n+        // TODO: When writeFullyStaticExport doesn't fail when staticWorker is passed moved this after writeFullyStaticExport.\n+        // End the worker here when it's output: export.\n+        staticWorker.end()\n+        staticWorker = undefined! // Reset staticWorker to make sure it does not end in `finally`\n+\n         await nextBuildSpan\n           .traceChild('output-export-full-static-export')\n           .traceAsyncFn(async () => {\n@@ -4204,6 +4219,7 @@ export default async function build(\n               configOutDir,\n               nextBuildSpan,\n               appDirOnly\n+              // staticWorker\n             )\n           })\n       }\n@@ -4311,6 +4327,10 @@ export default async function build(\n     }\n     throw e\n   } finally {\n+    // @ts-expect-error Existence of staticWorker is checked here intentionally.\n+    if (staticWorker) {\n+      staticWorker.end()\n+    }\n     // Ensure we wait for lockfile patching if present\n     await lockfilePatchPromise.cur\n "
        },
        {
            "sha": "95945ac2c1a091fda9ff8eff4f41f0305a882fcb",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 11,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=e5e80ead081db51160551f5ec9f69a83de42fc68",
            "patch": "@@ -76,7 +76,8 @@ export class ExportError extends Error {\n async function exportAppImpl(\n   dir: string,\n   options: Readonly<ExportAppOptions>,\n-  span: Span\n+  span: Span,\n+  staticWorker?: StaticWorker\n ): Promise<ExportAppResult | null> {\n   dir = resolve(dir)\n \n@@ -645,13 +646,20 @@ async function exportAppImpl(\n         `Exporting using ${options.numWorkers} worker${options.numWorkers > 1 ? 's' : ''}`\n     )\n \n-    worker = createStaticWorker(nextConfig, {\n-      debuggerPortOffset: getNextBuildDebuggerPortOffset({\n-        kind: 'export-page',\n-      }),\n-      numberOfWorkers: options.numWorkers,\n-      progress,\n-    })\n+    if (staticWorker) {\n+      // TODO: progress shouldn't rely on \"activity\" event sent from `exportPage`.\n+      staticWorker.setOnActivity(progress.run)\n+      staticWorker.setOnActivityAbort(progress.clear)\n+      worker = staticWorker\n+    } else {\n+      worker = createStaticWorker(nextConfig, {\n+        debuggerPortOffset: getNextBuildDebuggerPortOffset({\n+          kind: 'export-page',\n+        }),\n+        numberOfWorkers: options.numWorkers,\n+        progress,\n+      })\n+    }\n \n     results = await exportPagesInBatches(worker, initialPhaseExportPaths)\n \n@@ -913,7 +921,13 @@ async function exportAppImpl(\n     await telemetry.flush()\n   }\n \n-  if (worker) {\n+  // Clean up activity listeners for progress.\n+  if (staticWorker) {\n+    staticWorker.setOnActivity(undefined)\n+    staticWorker.setOnActivityAbort(undefined)\n+  }\n+\n+  if (!staticWorker && worker) {\n     await worker.end()\n   }\n \n@@ -957,11 +971,12 @@ async function collectSegmentPathsImpl(\n export default async function exportApp(\n   dir: string,\n   options: ExportAppOptions,\n-  span: Span\n+  span: Span,\n+  staticWorker?: StaticWorker\n ): Promise<ExportAppResult | null> {\n   const nextExportSpan = span.traceChild('next-export')\n \n   return nextExportSpan.traceAsyncFn(async () => {\n-    return await exportAppImpl(dir, options, nextExportSpan)\n+    return await exportAppImpl(dir, options, nextExportSpan, staticWorker)\n   })\n }"
        },
        {
            "sha": "d926f2078400080ee4cd274b036689f0f2957689",
            "filename": "packages/next/src/export/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts?ref=e5e80ead081db51160551f5ec9f69a83de42fc68",
            "patch": "@@ -12,6 +12,7 @@ import type {\n import type { FetchMetrics } from '../server/base-http'\n import type { RouteMetadata } from './routes/types'\n import type { RenderResumeDataCache } from '../server/resume-data-cache/resume-data-cache'\n+import type { StaticWorker } from '../build'\n \n export type ExportPathEntry = ExportPathMap[keyof ExportPathMap] & {\n   path: string\n@@ -89,6 +90,7 @@ export type WorkerRenderOpts = WorkerRenderOptsPartial &\n   LoadComponentsReturnType\n \n export interface ExportAppOptions {\n+  staticWorker?: StaticWorker\n   outdir: string\n   enabledDirectories: NextEnabledDirectories\n   silent?: boolean"
        },
        {
            "sha": "fe405934ff7d3609ba94f2c4597d717ab9799bb8",
            "filename": "packages/next/src/lib/worker.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 8,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e80ead081db51160551f5ec9f69a83de42fc68/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts?ref=e5e80ead081db51160551f5ec9f69a83de42fc68",
            "patch": "@@ -32,6 +32,9 @@ export function getNextBuildDebuggerPortOffset(_: {\n export class Worker {\n   private _worker: JestWorker | undefined\n \n+  private _onActivity: (() => void) | undefined\n+  private _onActivityAbort: (() => void) | undefined\n+\n   constructor(\n     workerPath: string,\n     options: Omit<FarmOptions, 'forkOptions'> & {\n@@ -65,9 +68,14 @@ export class Worker {\n       logger = console,\n       debuggerPortOffset,\n       isolatedMemory,\n+      onActivity,\n+      onActivityAbort,\n       ...farmOptions\n     } = options\n \n+    this._onActivity = onActivity\n+    this._onActivityAbort = onActivityAbort\n+\n     let restartPromise: Promise<typeof RESTARTED>\n     let resolveRestartPromise: (arg: typeof RESTARTED) => void\n     let activeTasks = 0\n@@ -182,24 +190,24 @@ export class Worker {\n               'type' in data &&\n               data.type === 'activity'\n             ) {\n-              onActivity()\n+              onActivityImpl()\n             }\n           })\n         }\n       }\n \n       let aborted = false\n-      const onActivityAbort = () => {\n+      const onActivityAbortImpl = () => {\n         if (!aborted) {\n-          options.onActivityAbort?.()\n+          this._onActivityAbort?.()\n           aborted = true\n         }\n       }\n \n       // Listen to the worker's stdout and stderr, if there's any thing logged, abort the activity first\n       const abortActivityStreamOnLog = new Transform({\n         transform(_chunk, _encoding, callback) {\n-          onActivityAbort()\n+          onActivityAbortImpl()\n           callback()\n         },\n       })\n@@ -230,9 +238,9 @@ export class Worker {\n \n     let hangingTimer: NodeJS.Timeout | false = false\n \n-    const onActivity = () => {\n+    const onActivityImpl = () => {\n       if (hangingTimer) clearTimeout(hangingTimer)\n-      if (options.onActivity) options.onActivity()\n+      if (this._onActivity) this._onActivity()\n \n       hangingTimer = activeTasks > 0 && setTimeout(onHanging, timeout)\n     }\n@@ -246,7 +254,7 @@ export class Worker {\n             try {\n               let attempts = 0\n               for (;;) {\n-                onActivity()\n+                onActivityImpl()\n                 const result = await Promise.race([\n                   (this._worker as any)[method](...args),\n                   restartPromise,\n@@ -256,13 +264,20 @@ export class Worker {\n               }\n             } finally {\n               activeTasks--\n-              onActivity()\n+              onActivityImpl()\n             }\n           }\n         : (this._worker as any)[method].bind(this._worker)\n     }\n   }\n \n+  setOnActivity(onActivity: (() => void) | undefined): void {\n+    this._onActivity = onActivity\n+  }\n+  setOnActivityAbort(onActivityAbort: (() => void) | undefined): void {\n+    this._onActivityAbort = onActivityAbort\n+  }\n+\n   end(): ReturnType<JestWorker['end']> {\n     const worker = this._worker\n     if (!worker) {"
        },
        {
            "sha": "807e3560294ce7a0c446d56d51cf5d608cf53a0f",
            "filename": "test/e2e/app-dir/refresh/app/refresh/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e80ead081db51160551f5ec9f69a83de42fc68/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e80ead081db51160551f5ec9f69a83de42fc68/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx?ref=e5e80ead081db51160551f5ec9f69a83de42fc68",
            "patch": "@@ -1,6 +1,9 @@\n import { triggerRefresh } from './actions'\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n \n-export default function Page() {\n   const timestamp = performance.now()\n \n   return ("
        }
    ],
    "stats": {
        "total": 113,
        "additions": 84,
        "deletions": 29
    }
}