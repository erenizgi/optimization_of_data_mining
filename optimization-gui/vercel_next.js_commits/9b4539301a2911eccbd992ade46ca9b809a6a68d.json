{
    "author": "lubieowoce",
    "message": "[dynamicIO] cache tracking for import() (#74152)\n\nThis PR introduces some extra tracking which makes us treat\n`import(...)` like a call to a cached function. Thanks to this, `await\nimport(...)` will no longer cause dynamicity errors in `dynamicIO`.\nThe motivation is the same as allowing `fs.readFileSync` -- if something\nis available on the server at prerender time, we don't consider it IO.\n\nFixes #72589\nCloses #75132\n\n### Implementation notes\n\nThe tracking is implemented via an SWC transform\n(`track_dynamic_imports.ts`) that turns `import(...)` into\n`trackDynamicImport(import(...))`.\n\n`trackDynamicImport(promise)` tracks the promise globally, without using\n`workUnitStore.cacheSignal`. The prospective render subscribes to\npending modules using `trackPendingModules(cacheSignal)`, which causes\nthe prospective render to wait for all `import()`s to finish before\nproceeding to the final render. The mechanism is analogous to `'use\ncache'`, but the \"result\" of an `import()` is stored *in the module\ncache* instead; when we invoke the `import()` again in the actual\nprerender, it will resolve at microtask-speed, like we need it to.\n\nThe transform is enabled for all modules that run server-side, both RSC\nand SSR, because the prerender runs both. This also includes route\nhandlers, because we also use a `cacheSignal` when prerendering those.\nNotably, we also instrument `import()` in `node_modules` to account for\nlibraries that do lazy initialization.\n\nI've also had to adjust the prospective client render in PPR mode to\nwait for `cacheSignal.cacheReady()` - otherwise, it wouldn't wait for\n`import()`s to resolve before doing the final client render, which'd\nsubsequently cause a dynamicity error.\n(we didn't need to wait for `cacheSignal` before, because all cached\npromises would've already been awaited in the server prerender)\n\nFinally, we no longer need `warmFlightResponse`, because\n`trackPendingModules` already makes the `cacheSignal` wait for all\nloading chunks to finish, so we don't need to do it ahead of time.",
    "sha": "9b4539301a2911eccbd992ade46ca9b809a6a68d",
    "files": [
        {
            "sha": "838bf3c3768a67cbf25af156785776eaedffbdb0",
            "filename": ".gitignore",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.gitignore?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -28,7 +28,7 @@ pids\n coverage\n \n # test output\n-test/**/out*\n+test/**/out/*\n test/**/next-env.d.ts\n .DS_Store\n /e2e-tests\n@@ -42,7 +42,7 @@ test/traces\n .nvmrc\n \n # examples\n-examples/**/out\n+examples/**/out/*\n examples/**/.env*.local\n \n pr-stats.md"
        },
        {
            "sha": "cb6459fc3003a1102c7956e2dd9662d45d952b14",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -965,6 +965,13 @@ async fn insert_next_shared_aliases(\n             \"next/dist/build/webpack/loaders/next-flight-loader/cache-wrapper\",\n         ),\n     );\n+    import_map.insert_exact_alias(\n+        \"private-next-rsc-track-dynamic-import\",\n+        request_to_import_mapping(\n+            project_path,\n+            \"next/dist/build/webpack/loaders/next-flight-loader/track-dynamic-import\",\n+        ),\n+    );\n \n     insert_turbopack_dev_alias(import_map).await?;\n     insert_package_alias("
        },
        {
            "sha": "4eaf62f3085161563801c66d915846385f96824a",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -12,8 +12,8 @@ use crate::{\n     next_shared::transforms::{\n         get_next_dynamic_transform_rule, get_next_font_transform_rule, get_next_image_rule,\n         get_next_lint_transform_rule, get_next_modularize_imports_rule,\n-        get_next_pages_transforms_rule, get_server_actions_transform_rule,\n-        next_amp_attributes::get_next_amp_attr_rule,\n+        get_next_pages_transforms_rule, get_next_track_dynamic_imports_transform_rule,\n+        get_server_actions_transform_rule, next_amp_attributes::get_next_amp_attr_rule,\n         next_cjs_optimizer::get_next_cjs_optimizer_rule,\n         next_disallow_re_export_all_in_page::get_next_disallow_export_all_in_page_rule,\n         next_edge_node_api_assert::next_edge_node_api_assert,\n@@ -178,6 +178,10 @@ pub async fn get_next_server_transforms_rules(\n         ServerContextType::Middleware { .. } | ServerContextType::Instrumentation { .. } => false,\n     };\n \n+    if is_app_dir && *next_config.enable_dynamic_io().await? {\n+        rules.push(get_next_track_dynamic_imports_transform_rule(mdx_rs));\n+    }\n+\n     if !foreign_code {\n         rules.push(\n             get_next_dynamic_transform_rule(true, is_server_components, is_app_dir, mode, mdx_rs)"
        },
        {
            "sha": "281bd938b67f98b77c07a1c042750496f8dcf515",
            "filename": "crates/next-core/src/next_shared/transforms/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -16,6 +16,7 @@ pub(crate) mod next_pure;\n pub(crate) mod next_react_server_components;\n pub(crate) mod next_shake_exports;\n pub(crate) mod next_strip_page_exports;\n+pub(crate) mod next_track_dynamic_imports;\n pub(crate) mod react_remove_properties;\n pub(crate) mod relay;\n pub(crate) mod remove_console;\n@@ -30,6 +31,7 @@ pub use next_dynamic::get_next_dynamic_transform_rule;\n pub use next_font::get_next_font_transform_rule;\n pub use next_lint::get_next_lint_transform_rule;\n pub use next_strip_page_exports::get_next_pages_transforms_rule;\n+pub use next_track_dynamic_imports::get_next_track_dynamic_imports_transform_rule;\n pub use server_actions::get_server_actions_transform_rule;\n use turbo_tasks::{ReadRef, ResolvedVc, Value};\n use turbo_tasks_fs::FileSystemPath;"
        },
        {
            "sha": "653df152afce86e1f7264b953b2d99a3f7e70926",
            "filename": "crates/next-core/src/next_shared/transforms/next_track_dynamic_imports.rs",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_track_dynamic_imports.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,24 @@\n+use anyhow::Result;\n+use async_trait::async_trait;\n+use next_custom_transforms::transforms::track_dynamic_imports::*;\n+use swc_core::ecma::ast::Program;\n+use turbopack::module_options::ModuleRule;\n+use turbopack_ecmascript::{CustomTransformer, TransformContext};\n+\n+use super::get_ecma_transform_rule;\n+\n+pub fn get_next_track_dynamic_imports_transform_rule(mdx_rs: bool) -> ModuleRule {\n+    get_ecma_transform_rule(Box::new(NextTrackDynamicImports {}), mdx_rs, false)\n+}\n+\n+#[derive(Debug)]\n+struct NextTrackDynamicImports {}\n+\n+#[async_trait]\n+impl CustomTransformer for NextTrackDynamicImports {\n+    #[tracing::instrument(level = tracing::Level::TRACE, name = \"next_track_dynamic_imports\", skip_all)]\n+    async fn transform(&self, program: &mut Program, ctx: &TransformContext<'_>) -> Result<()> {\n+        program.mutate(track_dynamic_imports(ctx.unresolved_mark));\n+        Ok(())\n+    }\n+}"
        },
        {
            "sha": "1f303bcea0ffe605e63e1d8efbe6944d23d16a13",
            "filename": "crates/next-custom-transforms/src/chain_transforms.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -121,6 +121,9 @@ pub struct TransformOptions {\n \n     #[serde(default)]\n     pub css_env: Option<swc_core::ecma::preset_env::Config>,\n+\n+    #[serde(default)]\n+    pub track_dynamic_imports: bool,\n }\n \n pub fn custom_before_pass<'a, C>(\n@@ -333,6 +336,14 @@ where\n                 )),\n                 None => Either::Right(noop_pass()),\n             },\n+            match &opts.track_dynamic_imports {\n+                true => Either::Left(\n+                    crate::transforms::track_dynamic_imports::track_dynamic_imports(\n+                        unresolved_mark,\n+                    ),\n+                ),\n+                false => Either::Right(noop_pass()),\n+            },\n             match &opts.cjs_require_optimizer {\n                 Some(config) => Either::Left(visit_mut_pass(\n                     crate::transforms::cjs_optimizer::cjs_optimizer("
        },
        {
            "sha": "529a59180c13446b08096bd4d4c1d0bdf90fe62c",
            "filename": "crates/next-custom-transforms/src/transforms/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -18,6 +18,7 @@ pub mod react_server_components;\n pub mod server_actions;\n pub mod shake_exports;\n pub mod strip_page_exports;\n+pub mod track_dynamic_imports;\n pub mod warn_for_edge_runtime;\n \n //[TODO] PACK-1564: need to decide reuse vs. turbopack specific"
        },
        {
            "sha": "fc2ba0fb441fb1d92a587bb52e7f5de6fb0edee8",
            "filename": "crates/next-custom-transforms/src/transforms/track_dynamic_imports.rs",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Ftrack_dynamic_imports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Ftrack_dynamic_imports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Ftrack_dynamic_imports.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,124 @@\n+use swc_core::{\n+    common::{source_map::PURE_SP, util::take::Take, Mark, SyntaxContext},\n+    ecma::{\n+        ast::*,\n+        utils::{prepend_stmt, private_ident, quote_ident, quote_str},\n+        visit::{noop_visit_mut_type, visit_mut_pass, VisitMut, VisitMutWith},\n+    },\n+    quote,\n+};\n+\n+pub fn track_dynamic_imports(unresolved_mark: Mark) -> impl VisitMut + Pass {\n+    visit_mut_pass(ImportReplacer::new(unresolved_mark))\n+}\n+\n+struct ImportReplacer {\n+    unresolved_ctxt: SyntaxContext,\n+    has_dynamic_import: bool,\n+    wrapper_function_local_ident: Ident,\n+}\n+\n+impl ImportReplacer {\n+    pub fn new(unresolved_mark: Mark) -> Self {\n+        ImportReplacer {\n+            unresolved_ctxt: SyntaxContext::empty().apply_mark(unresolved_mark),\n+            has_dynamic_import: false,\n+            wrapper_function_local_ident: private_ident!(\"$$trackDynamicImport__\"),\n+        }\n+    }\n+}\n+\n+impl VisitMut for ImportReplacer {\n+    noop_visit_mut_type!();\n+\n+    fn visit_mut_program(&mut self, program: &mut Program) {\n+        program.visit_mut_children_with(self);\n+        // if we wrapped a dynamic import while visiting the children, we need to import the wrapper\n+\n+        if self.has_dynamic_import {\n+            let import_args = MakeNamedImportArgs {\n+                original_ident: quote_ident!(\"trackDynamicImport\").into(),\n+                local_ident: self.wrapper_function_local_ident.clone(),\n+                source: \"private-next-rsc-track-dynamic-import\",\n+                unresolved_ctxt: self.unresolved_ctxt,\n+            };\n+            match program {\n+                Program::Module(module) => {\n+                    prepend_stmt(&mut module.body, make_named_import_esm(import_args));\n+                }\n+                Program::Script(script) => {\n+                    // CJS modules can still use `import()`. for CJS, we have to inject the helper\n+                    // using `require` instead of `import` to avoid accidentally turning them\n+                    // into ESM modules.\n+                    prepend_stmt(&mut script.body, make_named_import_cjs(import_args));\n+                }\n+            }\n+        }\n+    }\n+\n+    fn visit_mut_expr(&mut self, expr: &mut Expr) {\n+        expr.visit_mut_children_with(self);\n+\n+        // before: `import(...)`\n+        // after:  `$$trackDynamicImport__(import(...))`\n+\n+        if let Expr::Call(CallExpr {\n+            callee: Callee::Import(_),\n+            ..\n+        }) = expr\n+        {\n+            self.has_dynamic_import = true;\n+            let replacement_expr = quote!(\n+                \"$wrapper_fn($expr)\" as Expr,\n+                wrapper_fn = self.wrapper_function_local_ident.clone(),\n+                expr: Expr = expr.take()\n+            )\n+            .with_span(PURE_SP);\n+            *expr = replacement_expr\n+        }\n+    }\n+}\n+\n+struct MakeNamedImportArgs<'a> {\n+    original_ident: Ident,\n+    local_ident: Ident,\n+    source: &'a str,\n+    unresolved_ctxt: SyntaxContext,\n+}\n+\n+fn make_named_import_esm(args: MakeNamedImportArgs) -> ModuleItem {\n+    let MakeNamedImportArgs {\n+        original_ident,\n+        local_ident,\n+        source,\n+        ..\n+    } = args;\n+    let mut item = quote!(\n+        \"import { $original_ident as $local_ident } from 'dummy'\" as ModuleItem,\n+        original_ident = original_ident,\n+        local_ident = local_ident,\n+    );\n+    // the import source cannot be parametrized in `quote!()`, so patch it manually\n+    let decl = item.as_mut_module_decl().unwrap().as_mut_import().unwrap();\n+    decl.src = Box::new(source.into());\n+    item\n+}\n+\n+fn make_named_import_cjs(args: MakeNamedImportArgs) -> Stmt {\n+    let MakeNamedImportArgs {\n+        original_ident,\n+        local_ident,\n+        source,\n+        unresolved_ctxt,\n+    } = args;\n+    quote!(\n+        \"const { [$original_name]: $local_ident } = $require($source)\" as Stmt,\n+        original_name: Expr = quote_str!(original_ident.sym).into(),\n+        local_ident = local_ident,\n+        source: Expr = quote_str!(source).into(),\n+        // the builtin `require` is considered an unresolved identifier.\n+        // we have to match that, or it won't be recognized as\n+        // a proper `require()` call.\n+        require = quote_ident!(unresolved_ctxt, \"require\")\n+    )\n+}"
        },
        {
            "sha": "bcca6c667aa81737b09bb5a20a370c92655286a0",
            "filename": "crates/next-custom-transforms/tests/fixture.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -21,6 +21,7 @@ use next_custom_transforms::transforms::{\n     server_actions::{self, server_actions, ServerActionsMode},\n     shake_exports::{shake_exports, Config as ShakeExportsConfig},\n     strip_page_exports::{next_transform_strip_page_exports, ExportFilter},\n+    track_dynamic_imports::track_dynamic_imports,\n     warn_for_edge_runtime::warn_for_edge_runtime,\n };\n use rustc_hash::FxHashSet;\n@@ -930,6 +931,29 @@ fn test_source_maps(input: PathBuf) {\n     );\n }\n \n+#[fixture(\"tests/fixture/track-dynamic-imports/**/input.js\")]\n+fn track_dynamic_imports_fixture(input: PathBuf) {\n+    let output = input.parent().unwrap().join(\"output.js\");\n+    test_fixture(\n+        syntax(),\n+        &|_tr| {\n+            let unresolved_mark = Mark::new();\n+            let top_level_mark = Mark::new();\n+            (\n+                resolver(unresolved_mark, top_level_mark, false),\n+                track_dynamic_imports(unresolved_mark),\n+            )\n+        },\n+        &input,\n+        &output,\n+        FixtureTestConfig {\n+            // auto detect script/module to test CJS handling\n+            module: None,\n+            ..Default::default()\n+        },\n+    );\n+}\n+\n fn lint_to_fold<R>(r: R) -> impl Pass\n where\n     R: Visit,"
        },
        {
            "sha": "f93d860c24e40ac5d664bb51142a6cb9db67d1a6",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/1/input.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Finput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+export default async function Page() {\n+  const { foo } = await import('some-module')\n+  return foo()\n+}"
        },
        {
            "sha": "bcf4d19be33bb9eefa4de4d970d12a10442ea21b",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/1/output.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F1%2Foutput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,5 @@\n+import { trackDynamicImport as $$trackDynamicImport__ } from \"private-next-rsc-track-dynamic-import\";\n+export default async function Page() {\n+    const { foo } = await /*#__PURE__*/ $$trackDynamicImport__(import('some-module'));\n+    return foo();\n+}"
        },
        {
            "sha": "7d0bd4f650227eee29aaccbe5efe98478aeb3424",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/2/input.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Finput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+export default async function Page() {\n+  await import((await import('get-name')).default)\n+  return null\n+}"
        },
        {
            "sha": "20c99119ffd0fd8b1a8e35af5a9e6d3a7dddf56f",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/2/output.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F2%2Foutput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,5 @@\n+import { trackDynamicImport as $$trackDynamicImport__ } from \"private-next-rsc-track-dynamic-import\";\n+export default async function Page() {\n+    await /*#__PURE__*/ $$trackDynamicImport__(import((await /*#__PURE__*/ $$trackDynamicImport__(import('get-name'))).default));\n+    return null;\n+}"
        },
        {
            "sha": "cf5719d3390ff560b2143cb9d430b491b2215052",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/3/input.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Finput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,8 @@\n+export default async function Page() {\n+  const { foo } = await import('some-module')\n+  // name conflict\n+  $$trackDynamicImport__()\n+  return foo()\n+}\n+\n+export function $$trackDynamicImport__() {}"
        },
        {
            "sha": "81f97fbe33fadc0f4f85a6f64c52ba790f64de29",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/3/output.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F3%2Foutput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,9 @@\n+import { trackDynamicImport as $$trackDynamicImport__ } from \"private-next-rsc-track-dynamic-import\";\n+export default async function Page() {\n+    const { foo } = await /*#__PURE__*/ $$trackDynamicImport__(import('some-module'));\n+    // name conflict\n+    $$trackDynamicImport__1();\n+    return foo();\n+}\n+function $$trackDynamicImport__1() {}\n+export { $$trackDynamicImport__1 as $$trackDynamicImport__ };"
        },
        {
            "sha": "8f7c41948fc8376c6ed2b4752e1e7b384830f34f",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/4/input.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Finput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+const promise = import('some-module')\n+\n+export default async function Page() {\n+  const { foo } = await promise\n+  return foo()\n+}"
        },
        {
            "sha": "6bc4be721895e8ac2e218aa241d84e40bca25069",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/4/output.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F4%2Foutput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+import { trackDynamicImport as $$trackDynamicImport__ } from \"private-next-rsc-track-dynamic-import\";\n+const promise = /*#__PURE__*/ $$trackDynamicImport__(import('some-module'));\n+export default async function Page() {\n+    const { foo } = await promise;\n+    return foo();\n+}"
        },
        {
            "sha": "a762d9c472280e6c98acaf02144b14ba7e744106",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/5/input.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Finput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+async function foo() {\n+  const { foo } = await import('some-module')\n+  return foo()\n+}\n+\n+exports.foo = foo"
        },
        {
            "sha": "64811de98f9a37583af9caec8b9c13161f3f9bdc",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/5/output.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2F5%2Foutput.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+const { [\"trackDynamicImport\"]: $$trackDynamicImport__ } = require(\"private-next-rsc-track-dynamic-import\");\n+async function foo() {\n+    const { foo } = await /*#__PURE__*/ $$trackDynamicImport__(import('some-module'));\n+    return foo();\n+}\n+exports.foo = foo;"
        },
        {
            "sha": "20915445a3590db3906b0b52ff8d48f21ff2d28b",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/index.ts",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Findex.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,2 @@\n+/// <reference types=\"./next\" />\n+/// <reference types=\"./modules\" />"
        },
        {
            "sha": "fb65a5a2b6500332807ae9a081b49488813d711b",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/modules.d.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fmodules.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fmodules.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fmodules.d.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,7 @@\n+declare module 'some-module' {\n+  export function foo(): null\n+}\n+declare module 'get-name' {\n+  const name: string\n+  export default name\n+}"
        },
        {
            "sha": "5178b71fb3cb8ed90df9f5bb3fca855266f574f1",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/next.d.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fnext.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fnext.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Fnext.d.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,3 @@\n+declare module 'private-next-rsc-track-dynamic-import' {\n+  export function trackDynamicImport<T>(promise: Promise<T>): Promise<T>\n+}"
        },
        {
            "sha": "5da6bee985c0cc1ddb2084a14c62a2d8b1d5b76b",
            "filename": "crates/next-custom-transforms/tests/fixture/track-dynamic-imports/tsconfig.json",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Ftrack-dynamic-imports%2Ftsconfig.json?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,23 @@\n+{\n+  \"compilerOptions\": {\n+    \"noEmit\": true,\n+    \"rootDir\": \".\",\n+\n+    \"allowJs\": true,\n+    \"checkJs\": true,\n+\n+    \"lib\": [\"ESNext\", \"DOM\"],\n+    \"skipLibCheck\": true,\n+\n+    \"strict\": true,\n+    \"jsx\": \"preserve\",\n+\n+    \"target\": \"ESNext\",\n+    \"esModuleInterop\": true,\n+    \"module\": \"Preserve\",\n+    \"moduleResolution\": \"bundler\",\n+    \"moduleDetection\": \"force\"\n+  },\n+  \"files\": [\"./index.ts\"], // loads ambient declarations for modules used in tests\n+  \"include\": [\"./**/*/input.js\", \"./**/*/output.js\"]\n+}"
        },
        {
            "sha": "0d6e3cd87a841fc1fb407923a8d730f50cd8a1cb",
            "filename": "crates/next-custom-transforms/tests/full.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -82,6 +82,7 @@ fn test(input: &Path, minify: bool) {\n                 prefer_esm: false,\n                 debug_function_name: false,\n                 css_env: None,\n+                track_dynamic_imports: false,\n             };\n \n             let unresolved_mark = Mark::new();"
        },
        {
            "sha": "e5c4e05ad623a21ea34535810d131b364a1d29aa",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -674,5 +674,8 @@\n   \"673\": \"Thrown value was ignored. This is a bug in Next.js.\",\n   \"674\": \"Route \\\"%s\\\" has a \\\\`generateViewport\\\\` that depends on Request data (\\\\`cookies()\\\\`, etc...) or uncached external data (\\\\`fetch(...)\\\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\",\n   \"675\": \"Expected `generateMetadata` not to block the application shell but it did.\",\n-  \"676\": \"Invariant: missing internal router-server-methods this is an internal bug\"\n+  \"676\": \"Invariant: missing internal router-server-methods this is an internal bug\",\n+  \"677\": \"`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform.\",\n+  \"678\": \"CacheSignal got more endRead() calls than beginRead() calls\",\n+  \"679\": \"A CacheSignal cannot subscribe to itself\"\n }"
        },
        {
            "sha": "a5a594a32b6cccf072907a7b93d14bcff9d475fc",
            "filename": "packages/next/src/build/create-compiler-aliases.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -11,6 +11,7 @@ import {\n   RSC_ACTION_ENCRYPTION_ALIAS,\n   RSC_CACHE_WRAPPER_ALIAS,\n   type WebpackLayerName,\n+  RSC_DYNAMIC_IMPORT_WRAPPER_ALIAS,\n } from '../lib/constants'\n import type { NextConfigComplete } from '../server/config-shared'\n import { defaultOverrides } from '../server/require-hook'\n@@ -177,6 +178,8 @@ export function createWebpackAliases({\n \n     [RSC_CACHE_WRAPPER_ALIAS]:\n       'next/dist/build/webpack/loaders/next-flight-loader/cache-wrapper',\n+    [RSC_DYNAMIC_IMPORT_WRAPPER_ALIAS]:\n+      'next/dist/build/webpack/loaders/next-flight-loader/track-dynamic-import',\n \n     ...(isClient || isEdgeServer\n       ? {"
        },
        {
            "sha": "f1fbabc1b9719342564c9b1537a046dea19e9780",
            "filename": "packages/next/src/build/handle-externals.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -189,7 +189,7 @@ export function makeExternalHandler({\n       }\n \n       const notExternalModules =\n-        /^(?:private-next-pages\\/|next\\/(?:dist\\/pages\\/|(?:app|cache|document|link|form|head|image|legacy\\/image|constants|dynamic|script|navigation|headers|router|compat\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)/\n+        /^(?:private-next-pages\\/|next\\/(?:dist\\/pages\\/|(?:app|cache|document|link|form|head|image|legacy\\/image|constants|dynamic|script|navigation|headers|router|compat\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper|private-next-rsc-track-dynamic-import$)/\n       if (notExternalModules.test(request)) {\n         return\n       }"
        },
        {
            "sha": "877ff9a9dce1cadd81c6ec36f1950a45c34db648",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -73,6 +73,7 @@ function getBaseSWCOptions({\n   isDynamicIo,\n   cacheHandlers,\n   useCacheEnabled,\n+  trackDynamicImports,\n }: {\n   filename: string\n   jest?: boolean\n@@ -93,6 +94,7 @@ function getBaseSWCOptions({\n   isDynamicIo?: boolean\n   cacheHandlers?: ExperimentalConfig['cacheHandlers']\n   useCacheEnabled?: boolean\n+  trackDynamicImports?: boolean\n }) {\n   const isReactServerLayer = isWebpackServerOnlyLayer(bundleLayer)\n   const isAppRouterPagesLayer = isWebpackAppPagesLayer(bundleLayer)\n@@ -235,6 +237,7 @@ function getBaseSWCOptions({\n     // On server side of pages router we prefer CJS.\n     preferEsm: esm,\n     lintCodemodComments: true,\n+    trackDynamicImports: trackDynamicImports,\n     debugFunctionName: development,\n \n     ...(supportedBrowsers && supportedBrowsers.length > 0\n@@ -384,6 +387,7 @@ export function getLoaderSWCOptions({\n   esm,\n   cacheHandlers,\n   useCacheEnabled,\n+  trackDynamicImports,\n }: {\n   filename: string\n   development: boolean\n@@ -410,6 +414,7 @@ export function getLoaderSWCOptions({\n   bundleLayer?: WebpackLayerName\n   cacheHandlers: ExperimentalConfig['cacheHandlers']\n   useCacheEnabled?: boolean\n+  trackDynamicImports?: boolean\n }) {\n   let baseOptions: any = getBaseSWCOptions({\n     filename,\n@@ -430,6 +435,7 @@ export function getLoaderSWCOptions({\n     isDynamicIo,\n     cacheHandlers,\n     useCacheEnabled,\n+    trackDynamicImports,\n   })\n   baseOptions.fontLoaders = {\n     fontLoaders: ['next/font/local', 'next/font/google'],"
        },
        {
            "sha": "3f3468038ae9d213ec9a90f2082aa4b635e5bde1",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-loader/track-dynamic-import.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Ftrack-dynamic-import.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Ftrack-dynamic-import.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Ftrack-dynamic-import.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export { trackDynamicImport } from '../../../../server/app-render/module-loading/track-dynamic-import'"
        },
        {
            "sha": "d6b7be7ef492ded2617540ca148e030d45193b77",
            "filename": "packages/next/src/build/webpack/loaders/next-swc-loader.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-swc-loader.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -27,7 +27,7 @@ DEALINGS IN THE SOFTWARE.\n */\n \n import type { NextConfig } from '../../../types'\n-import type { WebpackLayerName } from '../../../lib/constants'\n+import { type WebpackLayerName, WEBPACK_LAYERS } from '../../../lib/constants'\n import { isWasm, transform } from '../../swc'\n import { getLoaderSWCOptions } from '../../swc/options'\n import path, { isAbsolute } from 'path'\n@@ -76,6 +76,11 @@ export interface SWCLoaderOptions {\n // for to force transpiling a `node_module`\n const FORCE_TRANSPILE_CONDITIONS =\n   /next\\/font|next\\/dynamic|use server|use client|use cache/\n+// same as above, but including `import(...)`.\n+// (note the optional whitespace: `import  (...)` is also syntactically valid)\n+const FORCE_TRANSPILE_CONDITIONS_WITH_IMPORT = new RegExp(\n+  String.raw`(?:${FORCE_TRANSPILE_CONDITIONS.source})|import\\s*\\(`\n+)\n \n async function loaderTransform(\n   this: LoaderContext<SWCLoaderOptions> & TelemetryLoaderContext,\n@@ -96,12 +101,18 @@ async function loaderTransform(\n     loaderOptions.transpilePackages || []\n   )\n \n+  const trackDynamicImports = shouldTrackDynamicImports(loaderOptions)\n+\n   if (shouldMaybeExclude) {\n     if (!source) {\n       throw new Error(`Invariant might be excluded but missing source`)\n     }\n \n-    if (!FORCE_TRANSPILE_CONDITIONS.test(source)) {\n+    const forceTranspileConditions = trackDynamicImports\n+      ? FORCE_TRANSPILE_CONDITIONS_WITH_IMPORT\n+      : FORCE_TRANSPILE_CONDITIONS\n+\n+    if (!forceTranspileConditions.test(source)) {\n       return [source, inputSourceMap]\n     }\n   }\n@@ -150,6 +161,7 @@ async function loaderTransform(\n     esm,\n     cacheHandlers: nextConfig.experimental?.cacheHandlers,\n     useCacheEnabled: nextConfig.experimental?.useCache,\n+    trackDynamicImports,\n   })\n \n   const programmaticOptions = {\n@@ -199,6 +211,18 @@ async function loaderTransform(\n   )\n }\n \n+function shouldTrackDynamicImports(loaderOptions: SWCLoaderOptions): boolean {\n+  // we only need to track `import()` 1. in dynamicIO, 2. on the server (RSC and SSR)\n+  // (Note: logic duplicated in crates/next-core/src/next_server/transforms.rs)\n+  const { nextConfig, isServer, bundleLayer } = loaderOptions\n+  return (\n+    !!nextConfig.experimental?.dynamicIO &&\n+    isServer &&\n+    (bundleLayer === WEBPACK_LAYERS.reactServerComponents ||\n+      bundleLayer === WEBPACK_LAYERS.serverSideRendering)\n+  )\n+}\n+\n const EXCLUDED_PATHS =\n   /[\\\\/](cache[\\\\/][^\\\\/]+\\.zip[\\\\/]node_modules|__virtual__)[\\\\/]/g\n "
        },
        {
            "sha": "a5dcbefa7119c44f01946f3bcb66fe4e4ad1b4a0",
            "filename": "packages/next/src/lib/constants.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -56,6 +56,8 @@ export const RSC_MOD_REF_PROXY_ALIAS = 'private-next-rsc-mod-ref-proxy'\n export const RSC_ACTION_VALIDATE_ALIAS = 'private-next-rsc-action-validate'\n export const RSC_ACTION_PROXY_ALIAS = 'private-next-rsc-server-reference'\n export const RSC_CACHE_WRAPPER_ALIAS = 'private-next-rsc-cache-wrapper'\n+export const RSC_DYNAMIC_IMPORT_WRAPPER_ALIAS =\n+  'private-next-rsc-track-dynamic-import'\n export const RSC_ACTION_ENCRYPTION_ALIAS = 'private-next-rsc-action-encryption'\n export const RSC_ACTION_CLIENT_WRAPPER_ALIAS =\n   'private-next-rsc-action-client-wrapper'"
        },
        {
            "sha": "b8ba36c8c92958a5a5fbca3d774ce5a2e681ebd1",
            "filename": "packages/next/src/lib/scheduler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Flib%2Fscheduler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Flib%2Fscheduler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fscheduler.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -7,7 +7,7 @@ export type SchedulerFn<T = void> = (cb: ScheduledFn<T>) => void\n  *\n  * @param cb the function to schedule\n  */\n-export const scheduleOnNextTick = <T = void>(cb: ScheduledFn<T>): void => {\n+export const scheduleOnNextTick = (cb: ScheduledFn<void>) => {\n   // We use Promise.resolve().then() here so that the operation is scheduled at\n   // the end of the promise job queue, we then add it to the next process tick\n   // to ensure it's evaluated afterwards.\n@@ -29,7 +29,7 @@ export const scheduleOnNextTick = <T = void>(cb: ScheduledFn<T>): void => {\n  *\n  * @param cb the function to schedule\n  */\n-export const scheduleImmediate = <T = void>(cb: ScheduledFn<T>): void => {\n+export const scheduleImmediate = (cb: ScheduledFn<void>): void => {\n   if (process.env.NEXT_RUNTIME === 'edge') {\n     setTimeout(cb, 0)\n   } else {"
        },
        {
            "sha": "84cfe043d708f0ce6aca4ded5a5533c0789490af",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 77,
            "deletions": 120,
            "changes": 197,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -192,6 +192,11 @@ import { isUseCacheTimeoutError } from '../use-cache/use-cache-errors'\n import { createServerInsertedMetadata } from './metadata-insertion/create-server-inserted-metadata'\n import { getPreviouslyRevalidatedTags } from '../server-utils'\n import { executeRevalidates } from '../revalidation-utils'\n+import {\n+  trackPendingChunkLoad,\n+  trackPendingImport,\n+  trackPendingModules,\n+} from './module-loading/track-module-loading.external'\n \n export type GetDynamicParamFromSegment = (\n   // [slug] / [[slug]] / [...slug]\n@@ -737,8 +742,10 @@ async function warmupDevRender(\n     }\n   )\n \n-  // Wait for all caches to be finished filling\n+  // Wait for all caches to be finished filling and for async imports to resolve\n+  trackPendingModules(cacheSignal)\n   await cacheSignal.cacheReady()\n+\n   // We unset the cache so any late over-run renders aren't able to write into this cache\n   prerenderStore.prerenderResumeDataCache = null\n   // Abort the render\n@@ -1196,15 +1203,24 @@ async function renderToHTMLOrFlightImpl(\n   // react-server-dom-webpack. This is a hack until we find a better way.\n   if (ComponentMod.__next_app__) {\n     const instrumented = wrapClientComponentLoader(ComponentMod)\n-    // @ts-ignore\n-    globalThis.__next_require__ = instrumented.require\n+\n     // When we are prerendering if there is a cacheSignal for tracking\n-    // cache reads we wrap the loadChunk in this tracking. This allows us\n-    // to treat chunk loading with similar semantics as cache reads to avoid\n-    // async loading chunks from causing a prerender to abort too early.\n+    // cache reads we track calls to `loadChunk` and `require`. This allows us\n+    // to treat chunk/module loading with similar semantics as cache reads to avoid\n+    // module loading from causing a prerender to abort too early.\n+\n+    const __next_require__: typeof instrumented.require = (...args) => {\n+      const exportsOrPromise = instrumented.require(...args)\n+      // requiring an async module returns a promise.\n+      trackPendingImport(exportsOrPromise)\n+      return exportsOrPromise\n+    }\n+    // @ts-expect-error\n+    globalThis.__next_require__ = __next_require__\n+\n     const __next_chunk_load__: typeof instrumented.loadChunk = (...args) => {\n       const loadingChunk = instrumented.loadChunk(...args)\n-      trackChunkLoading(loadingChunk)\n+      trackPendingChunkLoad(loadingChunk)\n       return loadingChunk\n     }\n     // @ts-expect-error\n@@ -2323,19 +2339,13 @@ async function spawnDynamicValidationInDev(\n   const { ServerInsertedMetadataProvider } = createServerInsertedMetadata(nonce)\n \n   if (initialServerStream) {\n-    const [warmupStream, renderStream] = initialServerStream.tee()\n-    initialServerStream = null\n-    // Before we attempt the SSR initial render we need to ensure all client modules\n-    // are already loaded.\n-    await warmFlightResponse(warmupStream, clientReferenceManifest)\n-\n     const prerender = require('react-dom/static.edge')\n       .prerender as (typeof import('react-dom/static.edge'))['prerender']\n     const pendingInitialClientResult = workUnitAsyncStorage.run(\n       initialClientPrerenderStore,\n       prerender,\n       <App\n-        reactServerStream={renderStream}\n+        reactServerStream={initialServerStream}\n         preinitScripts={() => {}}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -2378,7 +2388,10 @@ async function spawnDynamicValidationInDev(\n     })\n   }\n \n+  // Wait for all caches to be finished filling and for async imports to resolve\n+  trackPendingModules(cacheSignal)\n   await cacheSignal.cacheReady()\n+\n   // It is important that we abort the SSR render first to avoid\n   // connection closed errors from having an incomplete RSC stream\n   initialClientController.abort()\n@@ -2815,7 +2828,10 @@ async function prerenderToStream(\n           }\n         )\n \n+        // Wait for all caches to be finished filling and for async imports to resolve\n+        trackPendingModules(cacheSignal)\n         await cacheSignal.cacheReady()\n+\n         initialServerRenderController.abort()\n         initialServerPrerenderController.abort()\n \n@@ -2841,13 +2857,6 @@ async function prerenderToStream(\n         }\n \n         if (initialServerResult) {\n-          // Before we attempt the SSR initial render we need to ensure all client modules\n-          // are already loaded.\n-          await warmFlightResponse(\n-            initialServerResult.asStream(),\n-            clientReferenceManifest\n-          )\n-\n           const initialClientController = new AbortController()\n           const initialClientPrerenderStore: PrerenderStore = {\n             type: 'prerender',\n@@ -2856,7 +2865,7 @@ async function prerenderToStream(\n             implicitTags,\n             renderSignal: initialClientController.signal,\n             controller: initialClientController,\n-            cacheSignal: null,\n+            cacheSignal,\n             dynamicTracking: null,\n             revalidate: INFINITE_CACHE,\n             expire: INFINITE_CACHE,\n@@ -2868,52 +2877,46 @@ async function prerenderToStream(\n \n           const prerender = require('react-dom/static.edge')\n             .prerender as (typeof import('react-dom/static.edge'))['prerender']\n-          await prerenderAndAbortInSequentialTasks(\n-            () =>\n-              workUnitAsyncStorage.run(\n-                initialClientPrerenderStore,\n-                prerender,\n-                <App\n-                  reactServerStream={initialServerResult.asUnclosingStream()}\n-                  preinitScripts={preinitScripts}\n-                  clientReferenceManifest={clientReferenceManifest}\n-                  ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-                  ServerInsertedMetadataProvider={\n-                    ServerInsertedMetadataProvider\n-                  }\n-                  gracefullyDegrade={!!ctx.renderOpts.botType}\n-                  nonce={nonce}\n-                />,\n-                {\n-                  signal: initialClientController.signal,\n-                  onError: (err) => {\n-                    const digest = getDigestForWellKnownError(err)\n+          const pendingInitialClientResult = workUnitAsyncStorage.run(\n+            initialClientPrerenderStore,\n+            prerender,\n+            <App\n+              reactServerStream={initialServerResult.asUnclosingStream()}\n+              preinitScripts={preinitScripts}\n+              clientReferenceManifest={clientReferenceManifest}\n+              ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n+              ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+              gracefullyDegrade={!!ctx.renderOpts.botType}\n+              nonce={nonce}\n+            />,\n+            {\n+              signal: initialClientController.signal,\n+              onError: (err) => {\n+                const digest = getDigestForWellKnownError(err)\n \n-                    if (digest) {\n-                      return digest\n-                    }\n+                if (digest) {\n+                  return digest\n+                }\n \n-                    if (initialClientController.signal.aborted) {\n-                      // These are expected errors that might error the prerender. we ignore them.\n-                    } else if (\n-                      process.env.NEXT_DEBUG_BUILD ||\n-                      process.env.__NEXT_VERBOSE_LOGGING\n-                    ) {\n-                      // We don't normally log these errors because we are going to retry anyway but\n-                      // it can be useful for debugging Next.js itself to get visibility here when needed\n-                      printDebugThrownValueForProspectiveRender(\n-                        err,\n-                        workStore.route\n-                      )\n-                    }\n-                  },\n-                  bootstrapScripts: [bootstrapScript],\n+                if (initialClientController.signal.aborted) {\n+                  // These are expected errors that might error the prerender. we ignore them.\n+                } else if (\n+                  process.env.NEXT_DEBUG_BUILD ||\n+                  process.env.__NEXT_VERBOSE_LOGGING\n+                ) {\n+                  // We don't normally log these errors because we are going to retry anyway but\n+                  // it can be useful for debugging Next.js itself to get visibility here when needed\n+                  printDebugThrownValueForProspectiveRender(\n+                    err,\n+                    workStore.route\n+                  )\n                 }\n-              ),\n-            () => {\n-              initialClientController.abort()\n+              },\n+              bootstrapScripts: [bootstrapScript],\n             }\n-          ).catch((err) => {\n+          )\n+\n+          pendingInitialClientResult.catch((err) => {\n             if (\n               initialServerRenderController.signal.aborted ||\n               isPrerenderInterruptedError(err)\n@@ -2928,6 +2931,12 @@ async function prerenderToStream(\n               printDebugThrownValueForProspectiveRender(err, workStore.route)\n             }\n           })\n+\n+          // This is mostly needed for dynamic `import()`s in client components.\n+          // Promises passed to client were already awaited above (assuming that they came from cached functions)\n+          trackPendingModules(cacheSignal)\n+          await cacheSignal.cacheReady()\n+          initialClientController.abort()\n         }\n \n         let serverIsDynamic = false\n@@ -3351,19 +3360,13 @@ async function prerenderToStream(\n         }\n \n         if (initialServerStream) {\n-          const [warmupStream, renderStream] = initialServerStream.tee()\n-          initialServerStream = null\n-          // Before we attempt the SSR initial render we need to ensure all client modules\n-          // are already loaded.\n-          await warmFlightResponse(warmupStream, clientReferenceManifest)\n-\n           const prerender = require('react-dom/static.edge')\n             .prerender as (typeof import('react-dom/static.edge'))['prerender']\n           const pendingInitialClientResult = workUnitAsyncStorage.run(\n             initialClientPrerenderStore,\n             prerender,\n             <App\n-              reactServerStream={renderStream}\n+              reactServerStream={initialServerStream}\n               preinitScripts={preinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n@@ -3410,7 +3413,10 @@ async function prerenderToStream(\n           })\n         }\n \n+        // Wait for all caches to be finished filling and for async imports to resolve\n+        trackPendingModules(cacheSignal)\n         await cacheSignal.cacheReady()\n+\n         // It is important that we abort the SSR render first to avoid\n         // connection closed errors from having an incomplete RSC stream\n         initialClientController.abort()\n@@ -4169,55 +4175,6 @@ async function prerenderToStream(\n   }\n }\n \n-const loadingChunks: Set<Promise<unknown>> = new Set()\n-const chunkListeners: Array<(x?: unknown) => void> = []\n-\n-function trackChunkLoading(load: Promise<unknown>) {\n-  loadingChunks.add(load)\n-  load.finally(() => {\n-    if (loadingChunks.has(load)) {\n-      loadingChunks.delete(load)\n-      if (loadingChunks.size === 0) {\n-        // We are not currently loading any chunks. We can notify all listeners\n-        for (let i = 0; i < chunkListeners.length; i++) {\n-          chunkListeners[i]()\n-        }\n-        chunkListeners.length = 0\n-      }\n-    }\n-  })\n-}\n-\n-export async function warmFlightResponse(\n-  flightStream: ReadableStream<Uint8Array>,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n-) {\n-  const { createFromReadableStream } =\n-    // eslint-disable-next-line import/no-extraneous-dependencies\n-    require('react-server-dom-webpack/client.edge') as typeof import('react-server-dom-webpack/client.edge')\n-\n-  try {\n-    createFromReadableStream(flightStream, {\n-      serverConsumerManifest: {\n-        moduleLoading: clientReferenceManifest.moduleLoading,\n-        moduleMap: clientReferenceManifest.ssrModuleMapping,\n-        serverModuleMap: null,\n-      },\n-    })\n-  } catch {\n-    // We don't want to handle errors here but we don't want it to\n-    // interrupt the outer flow. We simply ignore it here and expect\n-    // it will bubble up during a render\n-  }\n-\n-  // We'll wait at least one task and then if no chunks have started to load\n-  // we'll we can infer that there are none to load from this flight response\n-  trackChunkLoading(waitAtLeastOneReactRenderTask())\n-  return new Promise((r) => {\n-    chunkListeners.push(r)\n-  })\n-}\n-\n const getGlobalErrorStyles = async (\n   tree: LoaderTree,\n   ctx: AppRenderContext"
        },
        {
            "sha": "e9e8ace36218487fca6989f189a4e245215a8822",
            "filename": "packages/next/src/server/app-render/cache-signal.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 13,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcache-signal.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -5,20 +5,16 @@\n  * and should only be used in codepaths gated with this feature.\n  */\n \n+import { InvariantError } from '../../shared/lib/invariant-error'\n+\n export class CacheSignal {\n-  private count: number\n-  private earlyListeners: Array<() => void>\n-  private listeners: Array<() => void>\n-  private tickPending: boolean\n-  private taskPending: boolean\n-\n-  constructor() {\n-    this.count = 0\n-    this.earlyListeners = []\n-    this.listeners = []\n-    this.tickPending = false\n-    this.taskPending = false\n-  }\n+  private count = 0\n+  private earlyListeners: Array<() => void> = []\n+  private listeners: Array<() => void> = []\n+  private tickPending = false\n+  private taskPending = false\n+\n+  private subscribedSignals: Set<CacheSignal> | null = null\n \n   private noMorePendingCaches() {\n     if (!this.tickPending) {\n@@ -76,9 +72,21 @@ export class CacheSignal {\n \n   beginRead() {\n     this.count++\n+\n+    if (this.subscribedSignals !== null) {\n+      for (const subscriber of this.subscribedSignals) {\n+        subscriber.beginRead()\n+      }\n+    }\n   }\n \n   endRead() {\n+    if (this.count === 0) {\n+      throw new InvariantError(\n+        'CacheSignal got more endRead() calls than beginRead() calls'\n+      )\n+    }\n+\n     // If this is the last read we need to wait a task before we can claim the cache is settled.\n     // The cache read will likely ping a Server Component which can read from the cache again and this\n     // will play out in a microtask so we need to only resolve pending listeners if we're still at 0\n@@ -89,5 +97,46 @@ export class CacheSignal {\n     if (this.count === 0) {\n       this.noMorePendingCaches()\n     }\n+\n+    if (this.subscribedSignals !== null) {\n+      for (const subscriber of this.subscribedSignals) {\n+        subscriber.endRead()\n+      }\n+    }\n+  }\n+\n+  trackRead<T>(promise: Promise<T>) {\n+    this.beginRead()\n+    promise.finally(this.endRead.bind(this))\n+    return promise\n+  }\n+\n+  subscribeToReads(subscriber: CacheSignal): () => void {\n+    if (subscriber === this) {\n+      throw new InvariantError('A CacheSignal cannot subscribe to itself')\n+    }\n+    if (this.subscribedSignals === null) {\n+      this.subscribedSignals = new Set()\n+    }\n+    this.subscribedSignals.add(subscriber)\n+\n+    // we'll notify the subscriber of each endRead() on this signal,\n+    // so we need to give it a corresponding beginRead() for each read we have in flight now.\n+    for (let i = 0; i < this.count; i++) {\n+      subscriber.beginRead()\n+    }\n+\n+    return this.unsubscribeFromReads.bind(this, subscriber)\n+  }\n+\n+  unsubscribeFromReads(subscriber: CacheSignal) {\n+    if (!this.subscribedSignals) {\n+      return\n+    }\n+    this.subscribedSignals.delete(subscriber)\n+\n+    // we don't need to set the set back to `null` if it's empty --\n+    // if other signals are subscribing to this one, it'll likely get more subscriptions later,\n+    // so we'd have to allocate a fresh set again when that happens.\n   }\n }"
        },
        {
            "sha": "3a8a56ea7dcc650d938764473aae5fd05fd8b07c",
            "filename": "packages/next/src/server/app-render/module-loading/track-dynamic-import.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-dynamic-import.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,48 @@\n+import { InvariantError } from '../../../shared/lib/invariant-error'\n+import { isThenable } from '../../../shared/lib/is-thenable'\n+import { trackPendingImport } from './track-module-loading.external'\n+\n+/**\n+ * in DynamicIO, `import(...)` will be transformed into `trackDynamicImport(import(...))`.\n+ * A dynamic import is essentially a cached async function, except it's cached by the module system.\n+ *\n+ * The promises are tracked globally regardless of if the `import()` happens inside a render or outside of it.\n+ * When rendering, we can make the `cacheSignal` wait for all pending promises via `trackPendingModules`.\n+ * */\n+export function trackDynamicImport<TExports extends Record<string, any>>(\n+  modulePromise: Promise<TExports>\n+): Promise<TExports> {\n+  if (!isThenable(modulePromise)) {\n+    // We're expecting `import()` to always return a promise. If it's not, something's very wrong.\n+    throw new InvariantError(\n+      '`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform.'\n+    )\n+  }\n+\n+  // Even if we're inside a prerender and have `workUnitStore.cacheSignal`, we always track the promise globally.\n+  // (i.e. via the global `moduleLoadingSignal` that `trackPendingImport` uses internally).\n+  //\n+  // We do this because the `import()` promise might be cached in userspace:\n+  // (which is quite common for e.g. lazy initialization in libraries)\n+  //\n+  //   let promise;\n+  //   function doDynamicImportOnce() {\n+  //     if (!promise) {\n+  //       promise = import(\"...\");\n+  //       // transformed into:\n+  //       // promise = trackDynamicImport(import(\"...\"));\n+  //     }\n+  //     return promise;\n+  //   }\n+  //\n+  // If multiple prerenders (e.g. multiple pages) depend on `doDynamicImportOnce`,\n+  // we have to wait for the import *in all of them*.\n+  // If we only tracked it using `workUnitStore.cacheSignal.trackRead()`,\n+  // then only the first prerender to call `doDynamicImportOnce` would wait --\n+  // Subsequent prerenders would re-use the existing `promise`,\n+  // and `trackDynamicImport` wouldn't be called again in their scope,\n+  // so their respective CacheSignals wouldn't wait for the promise.\n+  trackPendingImport(modulePromise)\n+\n+  return modulePromise\n+}"
        },
        {
            "sha": "95109c2c225e2310cc107bb4b2c55e09982a15c4",
            "filename": "packages/next/src/server/app-render/module-loading/track-module-loading.external.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.external.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,11 @@\n+// NOTE: this is marked as shared/external because it's stateful\n+// and the state needs to be shared between app-render (which waits for pending imports)\n+// and helpers used in transformed page code (which register pending imports)\n+\n+import {\n+  trackPendingChunkLoad,\n+  trackPendingImport,\n+  trackPendingModules,\n+} from './track-module-loading.instance' with { 'turbopack-transition': 'next-shared' }\n+\n+export { trackPendingChunkLoad, trackPendingImport, trackPendingModules }"
        },
        {
            "sha": "7f95f86dc9f08e3850ba80eb47a436cbe20aab9d",
            "filename": "packages/next/src/server/app-render/module-loading/track-module-loading.instance.ts",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmodule-loading%2Ftrack-module-loading.instance.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,40 @@\n+import { CacheSignal } from '../cache-signal'\n+import { isThenable } from '../../../shared/lib/is-thenable'\n+\n+/** Tracks all in-flight async imports and chunk loads. */\n+const moduleLoadingSignal = new CacheSignal()\n+\n+export function trackPendingChunkLoad(promise: Promise<unknown>) {\n+  moduleLoadingSignal.trackRead(promise)\n+}\n+\n+export function trackPendingImport(exportsOrPromise: unknown) {\n+  // requiring an async module returns a promise.\n+  // if it's sync, there's nothing to track.\n+  if (isThenable(exportsOrPromise)) {\n+    // A client reference proxy might look like a promise, but we can only call `.then()` on it, not e.g. `.finally()`.\n+    // Turn it into a real promise to avoid issues elsewhere.\n+    const promise = Promise.resolve(exportsOrPromise)\n+    moduleLoadingSignal.trackRead(promise)\n+  }\n+}\n+\n+/**\n+ * A top-level dynamic import (or chunk load):\n+ *\n+ *   1. delays a prerender (potentially for a task or longer)\n+ *   2. may reveal more caches that need be filled\n+ *\n+ * So if we see one, we want to extend the duration of `cacheSignal` at least until the import/chunk-load is done.\n+ */\n+export function trackPendingModules(cacheSignal: CacheSignal): void {\n+  // We can't just use `cacheSignal.trackRead(moduleLoadingSignal.cacheReady())`,\n+  // because we might start and finish multiple batches of module loads while waiting for caches,\n+  // and `moduleLoadingSignal.cacheReady()` would resolve after the first batch.\n+  // Instead, we'll keep notifying `cacheSignal` of each import/chunk-load.\n+  const unsubscribe = moduleLoadingSignal.subscribeToReads(cacheSignal)\n+\n+  // Later, when `cacheSignal` is no longer waiting for any caches (or imports that we've notified it of),\n+  // we can unsubscribe it.\n+  cacheSignal.cacheReady().then(unsubscribe)\n+}"
        },
        {
            "sha": "067a3fafe21a09fe7889b97e45e1af20672a911e",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -83,6 +83,7 @@ import {\n import { RedirectStatusCode } from '../../../client/components/redirect-status-code'\n import { INFINITE_CACHE } from '../../../lib/constants'\n import { executeRevalidates } from '../../revalidation-utils'\n+import { trackPendingModules } from '../../app-render/module-loading/track-module-loading.external'\n \n export class WrappedNextRouterError {\n   constructor(\n@@ -439,6 +440,8 @@ export class AppRouteRouteModule extends RouteModule<\n               }\n             )\n           }\n+\n+          trackPendingModules(cacheSignal)\n           await cacheSignal.cacheReady()\n \n           if (prospectiveRenderIsDynamic) {"
        },
        {
            "sha": "85bd27968c5d8577c08b583122adeefbc9e41102",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/async-module/async-messages.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fasync-messages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fasync-messages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fasync-messages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+console.log('[inside-component] async-messages :: imported, sleeping')\n+await new Promise<void>((resolve) => setTimeout(resolve, 500))\n+console.log('[inside-component] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "b7fdd4617c31a574b65a1e4753bfa312dc1d51cd",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/async-module/client.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fclient.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,15 @@\n+'use client'\n+\n+import * as React from 'react'\n+import { once } from '../once'\n+\n+const doImport = once(() => import('./async-messages'))\n+\n+export function Client() {\n+  const messages = React.use(doImport()).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "2f38c374336bc2ba244861b22cc4c257a641d4ea",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/async-module/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fasync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+import * as React from 'react'\n+import { Client } from './client'\n+\n+export default function Page() {\n+  return <Client />\n+}"
        },
        {
            "sha": "5fd2163c4108920c9c01426a329671bc9298061f",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/once.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fonce.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fonce.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fonce.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,10 @@\n+/** Memoize a callback to only invoke it once. */\n+export function once<T>(cb: () => T) {\n+  let cache: null | { value: T } = null\n+  return () => {\n+    if (!cache) {\n+      cache = { value: cb() }\n+    }\n+    return cache.value\n+  }\n+}"
        },
        {
            "sha": "783c930a306e6cdc8d0bdf1f37bc75737986ee26",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/sync-module/client.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fclient.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,14 @@\n+'use client'\n+import * as React from 'react'\n+import { once } from '../once'\n+\n+const doImport = once(() => import('./messages'))\n+\n+export function Client() {\n+  const messages = React.use(doImport()).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/sync-module/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fmessages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "2f38c374336bc2ba244861b22cc4c257a641d4ea",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/client/sync-module/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fclient%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+import * as React from 'react'\n+import { Client } from './client'\n+\n+export default function Page() {\n+  return <Client />\n+}"
        },
        {
            "sha": "85bd27968c5d8577c08b583122adeefbc9e41102",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/route-handler/async-module/async-messages.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Fasync-messages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Fasync-messages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Fasync-messages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+console.log('[inside-component] async-messages :: imported, sleeping')\n+await new Promise<void>((resolve) => setTimeout(resolve, 500))\n+console.log('[inside-component] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "0185c7bccca969693f7119f7ca5caf90ba3670c1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/route-handler/async-module/route.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fasync-module%2Froute.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+export async function GET(_request: Request) {\n+  const messages = (await import('./async-messages')).default\n+  return new Response(messages.title)\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/route-handler/sync-module/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Fmessages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "808c0b50730d7043dd3407c0810bd036933d280f",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/route-handler/sync-module/route.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Froute-handler%2Fsync-module%2Froute.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+export async function GET(_request: Request) {\n+  const messages = (await import('./messages')).default\n+  return new Response(messages.title)\n+}"
        },
        {
            "sha": "85bd27968c5d8577c08b583122adeefbc9e41102",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/async-module/async-messages.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fasync-messages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fasync-messages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fasync-messages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+console.log('[inside-component] async-messages :: imported, sleeping')\n+await new Promise<void>((resolve) => setTimeout(resolve, 500))\n+console.log('[inside-component] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "89e0a3ec6a56f29a96607f074ad5723301c332e1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/async-module/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fasync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,10 @@\n+import * as React from 'react'\n+\n+export default async function Page() {\n+  const messages = (await import('./async-messages')).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "a6d533fc2250515a08402cb7893b99bc508bc4c1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/from-node-modules/cjs/sync-module/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fcjs%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fcjs%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fcjs%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,11 @@\n+import * as React from 'react'\n+import { getMessages } from 'cjs-pkg-with-async-import'\n+\n+export default async function Page() {\n+  const messages = await getMessages()\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "d2cfdf2e8bb194267be95ab3729f7ac5a8926952",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/from-node-modules/esm/async-module/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fasync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fasync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fasync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,11 @@\n+import * as React from 'react'\n+import { getMessagesAsync } from 'esm-pkg-with-async-import'\n+\n+export default async function Page() {\n+  const messages = await getMessagesAsync()\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "2c2149dc2780fb9187604cef72adc2a9cc6af399",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/from-node-modules/esm/sync-module/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Ffrom-node-modules%2Fesm%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,11 @@\n+import * as React from 'react'\n+import { getMessages } from 'esm-pkg-with-async-import'\n+\n+export default async function Page() {\n+  const messages = await getMessages()\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/sync-module/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fmessages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "d0b51f757e7a1d6828a557ce285fd5cc21b8b0e8",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/inside-render/server/sync-module/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Finside-render%2Fserver%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,11 @@\n+import * as React from 'react'\n+\n+export default async function Page() {\n+  const messages = (await import('./messages')).default\n+\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "432635564b70d567cd0d0f3ef31d05922c99fe65",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Flayout.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,9 @@\n+import * as React from 'react'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "1b261c126abaabccf7d2738661e7c6f675d938d1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/async-module/async-messages.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fasync-messages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fasync-messages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fasync-messages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+console.log('[top-level] async-messages :: imported, sleeping')\n+await new Promise<void>((resolve) => setTimeout(resolve, 500))\n+console.log('[top-level] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "7d573fdde4a16b8a15d18e259109c62c12a1cbb6",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/async-module/client.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fclient.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+import * as React from 'react'\n+\n+const modulePromise = import('./async-messages')\n+\n+export function Client() {\n+  const messages = React.use(modulePromise).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "86ee0246fb444b8962e748320ae53224ddfe2224",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/async-module/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fasync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+import * as React from 'react'\n+import { Client } from './client'\n+\n+export default async function Page() {\n+  return <Client />\n+}"
        },
        {
            "sha": "4db2a96c0fcbf704ed4fe3d7b8b1e25e977259f6",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/sync-module/client.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fclient.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+import * as React from 'react'\n+\n+const modulePromise = import('./messages')\n+\n+export function Client() {\n+  const messages = React.use(modulePromise).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/sync-module/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fmessages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "86ee0246fb444b8962e748320ae53224ddfe2224",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/client/sync-module/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fclient%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+import * as React from 'react'\n+import { Client } from './client'\n+\n+export default async function Page() {\n+  return <Client />\n+}"
        },
        {
            "sha": "1b261c126abaabccf7d2738661e7c6f675d938d1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/server/async-module/async-messages.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fasync-messages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fasync-messages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fasync-messages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,4 @@\n+console.log('[top-level] async-messages :: imported, sleeping')\n+await new Promise<void>((resolve) => setTimeout(resolve, 500))\n+console.log('[top-level] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "692c09ebe4c4c4e56911dfc0d9e771bf4d27cdaa",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/server/async-module/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fasync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,12 @@\n+import * as React from 'react'\n+\n+const modulePromise = import('./async-messages')\n+\n+export default async function Page() {\n+  const messages = (await modulePromise).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/server/sync-module/messages.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fmessages.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1 @@\n+export default { title: 'hello' }"
        },
        {
            "sha": "872a43a053405437f32a55e276240d201f69d87f",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/app/outside-of-render/server/sync-module/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fapp%2Foutside-of-render%2Fserver%2Fsync-module%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,12 @@\n+import * as React from 'react'\n+\n+const modulePromise = import('./messages')\n+\n+export default async function Page() {\n+  const messages = (await modulePromise).default\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "10cc99d480a1fe44cb5717bc47d76a9be0029bdb",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnext.config.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n+    dynamicIO: true,\n+    prerenderEarlyExit: false,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "a1b82216ec78aab23b7019ec3630e3baf20481ad",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/cjs-pkg-with-async-import/index.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Findex.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,5 @@\n+// @ts-check\n+exports.getMessages = async function getMessages() {\n+  const { default: messages } = await import('./messages.js')\n+  return messages\n+}"
        },
        {
            "sha": "0e490bf47c22e084d6baaedb3725608892a1b1c0",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/cjs-pkg-with-async-import/messages.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fmessages.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fmessages.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fmessages.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,2 @@\n+// @ts-check\n+module.exports = { title: 'hello' }"
        },
        {
            "sha": "574bc6ace6c3b34d0c77d0aec9b2c71b7569a978",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/cjs-pkg-with-async-import/package.json",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fcjs-pkg-with-async-import%2Fpackage.json?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+{\n+  \"name\": \"cjs-pkg-with-async-import\",\n+  \"version\": \"0.1.0\",\n+  \"type\": \"commonjs\",\n+  \"main\": \"./index.js\"\n+}"
        },
        {
            "sha": "3b57fc734c914a91754e164c24413409dcca5e58",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/esm-pkg-with-async-import/async-messages.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fasync-messages.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fasync-messages.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fasync-messages.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,5 @@\n+// @ts-check\n+console.log('[node_modules] async-messages :: imported, sleeping')\n+await new Promise((resolve) => setTimeout(resolve, 500))\n+console.log('[node_modules] async-messages :: ready')\n+export default { title: 'hello' }"
        },
        {
            "sha": "5a6818eb21ef03e7e40b3a285f77675d74abca13",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/esm-pkg-with-async-import/index.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findex.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,10 @@\n+// @ts-check\n+export async function getMessages() {\n+  const { default: messages } = await import('./messages.js')\n+  return messages\n+}\n+\n+export async function getMessagesAsync() {\n+  const { default: messages } = await import('./indirect-async.js')\n+  return messages\n+}"
        },
        {
            "sha": "105f9eb25f0d20645055b44f19468514c85cfdb1",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/esm-pkg-with-async-import/indirect-async.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findirect-async.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findirect-async.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Findirect-async.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,7 @@\n+// @ts-check\n+console.log('[node_modules] indirect-async :: imported, sleeping')\n+await new Promise((resolve) => setTimeout(resolve, 500))\n+console.log('[node_modules] indirect-async :: importing messages')\n+const { default: messages } = await import('./async-messages.js')\n+console.log('[node_modules] indirect-async :: ready')\n+export default messages"
        },
        {
            "sha": "ece555844ccfdc515827ccb78405872b2bcb2d31",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/esm-pkg-with-async-import/messages.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fmessages.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fmessages.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fmessages.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,2 @@\n+// @ts-check\n+export default { title: 'hello' }"
        },
        {
            "sha": "1152e181318ca3cf50abb53b8e8419d11b715549",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/bundled/node_modules/esm-pkg-with-async-import/package.json",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fbundled%2Fnode_modules%2Fesm-pkg-with-async-import%2Fpackage.json?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"name\": \"esm-pkg-with-async-import\",\n+  \"version\": \"0.1.0\",\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \".\": \"./index.js\"\n+  }\n+}"
        },
        {
            "sha": "23ab8a844228f9ed727b498338ed7d4cb2c5c4fb",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/dynamic-io-dynamic-imports.test.ts",
            "status": "added",
            "additions": 182,
            "deletions": 0,
            "changes": 182,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fdynamic-io-dynamic-imports.test.ts?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,182 @@\n+import * as path from 'path'\n+import { nextTestSetup } from 'e2e-utils'\n+import {\n+  assertNoRedbox,\n+  getRouteTypeFromDevToolsIndicator,\n+  retry,\n+} from 'next-test-utils'\n+\n+describe('async imports in dynamicIO', () => {\n+  const { next, isNextStart, isNextDev } = nextTestSetup({\n+    files: path.join(__dirname, 'bundled'),\n+  })\n+\n+  if (isNextStart) {\n+    it('does not cause any routes to become (partially) dynamic', async () => {\n+      const prerenderManifest = JSON.parse(\n+        await next.readFile('.next/prerender-manifest.json')\n+      )\n+\n+      let prerenderedRoutes = Object.keys(prerenderManifest.routes).sort()\n+\n+      if (process.env.__NEXT_EXPERIMENTAL_PPR === 'true') {\n+        // For the purpose of this test we don't consider an incomplete shell.\n+        prerenderedRoutes = prerenderedRoutes.filter((route) => {\n+          const filename = route.replace(/^\\//, '').replace(/^$/, 'index')\n+          try {\n+            return next\n+              .readFileSync(`.next/server/app/${filename}.html`)\n+              .endsWith('</html>')\n+          } catch (err) {\n+            if ('code' in err && err.code === 'ENOENT') {\n+              // the route was prerendered, but we didn't find a HTML file for it.\n+              // this means it must be a GET route handler, not a page\n+              return true\n+            } else {\n+              throw err\n+            }\n+          }\n+        })\n+      }\n+\n+      expect(prerenderedRoutes).toMatchInlineSnapshot(`\n+       [\n+         \"/inside-render/client/async-module\",\n+         \"/inside-render/client/sync-module\",\n+         \"/inside-render/route-handler/async-module\",\n+         \"/inside-render/route-handler/sync-module\",\n+         \"/inside-render/server/async-module\",\n+         \"/inside-render/server/from-node-modules/cjs/sync-module\",\n+         \"/inside-render/server/from-node-modules/esm/async-module\",\n+         \"/inside-render/server/from-node-modules/esm/sync-module\",\n+         \"/inside-render/server/sync-module\",\n+         \"/outside-of-render/client/async-module\",\n+         \"/outside-of-render/client/sync-module\",\n+         \"/outside-of-render/server/async-module\",\n+         \"/outside-of-render/server/sync-module\",\n+       ]\n+      `)\n+    })\n+  }\n+\n+  const testPage = async (href: string) => {\n+    const browser = await next.browser(href)\n+    expect(await browser.elementByCss('body').text()).toBe('hello')\n+    if (isNextDev) {\n+      await retry(async () => {\n+        // the page should be static\n+        expect(await getRouteTypeFromDevToolsIndicator(browser)).toBe('Static')\n+        // we shouldn't get any errors from `spawnDynamicValidationInDev`\n+        await assertNoRedbox(browser)\n+      })\n+    }\n+  }\n+\n+  describe('inside a server component', () => {\n+    it('import of a sync module', async () => {\n+      await testPage('/inside-render/server/sync-module')\n+    })\n+\n+    it('import of module with top-level-await', async () => {\n+      await testPage('/inside-render/server/async-module')\n+    })\n+\n+    describe('dynamic import in node_modules', () => {\n+      describe('in an ESM package', () => {\n+        it('import of a sync module', async () => {\n+          await testPage(\n+            '/inside-render/server/from-node-modules/esm/sync-module'\n+          )\n+        })\n+\n+        it('import of module with top-level-await', async () => {\n+          await testPage(\n+            '/inside-render/server/from-node-modules/esm/async-module'\n+          )\n+        })\n+      })\n+\n+      describe('in a CJS package', () => {\n+        // CJS can't do top-level-await, so we're only testing sync modules\n+        it('import of a sync module', async () => {\n+          await testPage(\n+            '/inside-render/server/from-node-modules/cjs/sync-module'\n+          )\n+        })\n+      })\n+    })\n+  })\n+\n+  describe('inside a client component', () => {\n+    it('import of a sync module', async () => {\n+      await testPage('/inside-render/client/sync-module')\n+    })\n+\n+    it('import of module with top-level-await', async () => {\n+      await testPage('/inside-render/client/async-module')\n+    })\n+  })\n+\n+  describe('inside a GET route handler', () => {\n+    it('import of a sync module', async () => {\n+      const result = await next\n+        .fetch('/inside-render/route-handler/sync-module')\n+        .then((res) => res.text())\n+      expect(result).toBe('hello')\n+    })\n+\n+    it('import of module with top-level-await', async () => {\n+      const result = await next\n+        .fetch('/inside-render/route-handler/async-module')\n+        .then((res) => res.text())\n+      expect(result).toBe('hello')\n+    })\n+  })\n+\n+  describe('outside of render', () => {\n+    describe('server', () => {\n+      it('import of a sync module', async () => {\n+        await testPage('/outside-of-render/server/sync-module')\n+      })\n+\n+      it('import of module with top-level-await', async () => {\n+        await testPage('/outside-of-render/server/async-module')\n+      })\n+    })\n+\n+    describe('client', () => {\n+      it('import of a sync module', async () => {\n+        await testPage('/outside-of-render/client/sync-module')\n+      })\n+\n+      it('import of module with top-level-await', async () => {\n+        await testPage('/outside-of-render/client/async-module')\n+      })\n+    })\n+  })\n+})\n+\n+describe('async imports in dynamicIO - external packages', () => {\n+  const { next, isNextStart, skipped } = nextTestSetup({\n+    files: path.join(__dirname, 'external'),\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+  if (skipped) return\n+\n+  // This is currently expected to fail because we can only track `import()` in bundled code,\n+  // and packages marked as external aren't bundled.\n+  it('does not instrument import() in external packages', async () => {\n+    const expectedError = `Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.`\n+    if (isNextStart) {\n+      // in prod, we fail during the build\n+      await expect(() => next.start()).rejects.toThrow()\n+      expect(next.cliOutput).toContain(expectedError)\n+    } else {\n+      // in dev, we fail when visiting the page\n+      await next.start()\n+      await next.browser('/')\n+      await retry(() => expect(next.cliOutput).toContain(expectedError))\n+    }\n+  })\n+})"
        },
        {
            "sha": "432635564b70d567cd0d0f3ef31d05922c99fe65",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Flayout.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,9 @@\n+import * as React from 'react'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9d0d954e3f4fef258c4ce7df12b23725cc126ac3",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/app/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fapp%2Fpage.tsx?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,12 @@\n+import * as React from 'react'\n+// NOTE: this is not actually external by default, only in one test where we patch `next.config.js`\n+import { getMessagesAsync } from 'external-esm-pkg-with-async-import'\n+\n+export default async function Page() {\n+  const messages = await getMessagesAsync()\n+  return (\n+    <main>\n+      <p>{messages.title}</p>\n+    </main>\n+  )\n+}"
        },
        {
            "sha": "026621644ec9b0005a2086708990e7615801c276",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnext.config.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n+    dynamicIO: true,\n+  },\n+  serverExternalPackages: ['external-esm-pkg-with-async-import'],\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "0edcc8fb09363735e6ea443c3841791f2c404f13",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/node_modules/external-esm-pkg-with-async-import/async-messages.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fasync-messages.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fasync-messages.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fasync-messages.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,6 @@\n+// @ts-check\n+console.log('[node_modules, external] async-messages :: imported, sleeping')\n+await new Promise((resolve) => setTimeout(resolve, 500))\n+console.log('[node_modules, external] async-messages :: ready')\n+\n+export default { title: 'hello' }"
        },
        {
            "sha": "86955e82d29ae1258fa08901c7ae84118e75fca8",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/node_modules/external-esm-pkg-with-async-import/index.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Findex.js?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,5 @@\n+// @ts-check\n+export async function getMessagesAsync() {\n+  const { default: messages } = await import('./async-messages.js')\n+  return messages\n+}"
        },
        {
            "sha": "2380b0fd14e840c55dc024947c1587e94b098860",
            "filename": "test/e2e/app-dir/dynamic-io-dynamic-imports/external/node_modules/external-esm-pkg-with-async-import/package.json",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9b4539301a2911eccbd992ade46ca9b809a6a68d/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-dynamic-imports%2Fexternal%2Fnode_modules%2Fexternal-esm-pkg-with-async-import%2Fpackage.json?ref=9b4539301a2911eccbd992ade46ca9b809a6a68d",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"name\": \"external-esm-pkg-with-async-import\",\n+  \"version\": \"0.1.0\",\n+  \"type\": \"module\",\n+  \"exports\": {\n+    \".\": \"./index.js\"\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 1225,
        "additions": 1082,
        "deletions": 143
    }
}