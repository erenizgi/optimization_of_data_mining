{
    "author": "unstubbable",
    "message": "Remove `revalidate` property from incremental cache `ctx` for `FETCH` kind (#76500)\n\nThe `revalidate` property of the `ctx` object that is passed into the\nincremental cache by the patched `fetch` as well as `unstable_cache` is\nunused since it was introduced in #43659. It was just added because of\nhow the method signature for `set()` was changed back then.\n\nHowever, for those kinds of cache entries, the `revalidate` context\nproperty is never used, and instead the `revalidate` property of the\npassed-in `data` is used.\n\nTo avoid further confusion (e.g. in [this\nquestion](https://github.com/vercel/next.js/pull/76207#discussion_r1968478141)),\nthis PR improves the method signatures and types of the incremental\ncache so that the different call-site use cases can be clearly\ndiscriminated, and superfluous context properties can be omitted.",
    "sha": "6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
    "files": [
        {
            "sha": "75c0f7e982a1a69a4f53236830d2c7d6bab4795f",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -649,5 +649,7 @@\n   \"648\": \"@rspack/plugin-react-refresh is not available. Please make sure `@next/plugin-rspack` is correctly installed.\",\n   \"649\": \"Cache handlers not initialized\",\n   \"650\": \"experimental.nodeMiddleware\",\n-  \"651\": \"Unexpected module type %s\"\n+  \"651\": \"Unexpected module type %s\",\n+  \"652\": \"Expected cached value for cache key %s not to be a %s kind, got \\\"FETCH\\\" instead.\",\n+  \"653\": \"Expected cached value for cache key %s to be a \\\"FETCH\\\" kind, got %s instead.\"\n }"
        },
        {
            "sha": "568a8b02ce07e6c22ad467f7003beb0977530980",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -19,8 +19,8 @@ import {\n   CachedRouteKind,\n   type CachedImageValue,\n   type IncrementalCacheEntry,\n-  type IncrementalCacheItem,\n   type IncrementalCacheValue,\n+  type IncrementalResponseCacheEntry,\n } from './response-cache'\n import { sendEtagResponse } from './send-payload'\n import { getContentType, getExtension } from './serve-static'\n@@ -390,7 +390,7 @@ export class ImageOptimizerCache {\n     this.nextConfig = nextConfig\n   }\n \n-  async get(cacheKey: string): Promise<IncrementalCacheEntry | null> {\n+  async get(cacheKey: string): Promise<IncrementalResponseCacheEntry | null> {\n     try {\n       const cacheDir = join(this.cacheDir, cacheKey)\n       const files = await promises.readdir(cacheDir)\n@@ -414,7 +414,7 @@ export class ImageOptimizerCache {\n           revalidateAfter:\n             Math.max(maxAge, this.nextConfig.images.minimumCacheTTL) * 1000 +\n             Date.now(),\n-          curRevalidate: maxAge,\n+          revalidate: maxAge,\n           isStale: now > expireAt,\n           isFallback: false,\n         }\n@@ -508,7 +508,7 @@ export function getMaxAge(str: string | null | undefined): number {\n }\n export function getPreviouslyCachedImageOrNull(\n   upstreamImage: ImageUpstream,\n-  previousCacheEntry: IncrementalCacheItem | undefined\n+  previousCacheEntry: IncrementalCacheEntry | null | undefined\n ): CachedImageValue | null {\n   if (\n     previousCacheEntry?.value?.kind === 'IMAGE' &&\n@@ -678,7 +678,7 @@ export async function imageOptimizer(\n   opts: {\n     isDev?: boolean\n     silent?: boolean\n-    previousCacheEntry?: IncrementalCacheItem\n+    previousCacheEntry?: IncrementalResponseCacheEntry | null\n   }\n ): Promise<{\n   buffer: Buffer\n@@ -772,7 +772,7 @@ export async function imageOptimizer(\n     return {\n       buffer: previouslyCachedImage.buffer,\n       contentType,\n-      maxAge: opts?.previousCacheEntry?.curRevalidate || maxAge,\n+      maxAge: opts?.previousCacheEntry?.revalidate || maxAge,\n       etag: previouslyCachedImage.etag,\n       upstreamEtag: previouslyCachedImage.upstreamEtag,\n     }"
        },
        {
            "sha": "8ce98a11f9455701c8fe3c5bb4b2c9031786e81d",
            "filename": "packages/next/src/server/lib/incremental-cache/file-system-cache.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 12,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -5,6 +5,9 @@ import {\n   CachedRouteKind,\n   IncrementalCacheKind,\n   type CachedFetchValue,\n+  type IncrementalCacheValue,\n+  type SetIncrementalFetchCacheContext,\n+  type SetIncrementalResponseCacheContext,\n } from '../../response-cache'\n \n import { LRUCache } from '../lru-cache'\n@@ -106,12 +109,16 @@ export default class FileSystemCache implements CacheHandler {\n \n   public async get(...args: Parameters<CacheHandler['get']>) {\n     const [key, ctx] = args\n-    const { tags, softTags, kind, isRoutePPREnabled, isFallback } = ctx\n+    const { kind } = ctx\n \n     let data = memoryCache?.get(key)\n \n     if (this.debug) {\n-      console.log('get', key, tags, kind, !!data)\n+      if (kind === IncrementalCacheKind.FETCH) {\n+        console.log('get', key, ctx.tags, kind, !!data)\n+      } else {\n+        console.log('get', key, kind, !!data)\n+      }\n     }\n \n     // let's check the disk for seed data\n@@ -157,6 +164,8 @@ export default class FileSystemCache implements CacheHandler {\n         const { mtime } = await this.fs.stat(filePath)\n \n         if (kind === IncrementalCacheKind.FETCH) {\n+          const { tags, fetchIdx, fetchUrl } = ctx\n+\n           if (!this.flushToDisk) return null\n \n           const lastModified = mtime.getTime()\n@@ -177,8 +186,10 @@ export default class FileSystemCache implements CacheHandler {\n                 console.log('tags vs storedTags mismatch', tags, storedTags)\n               }\n               await this.set(key, data.value, {\n+                fetchCache: true,\n                 tags,\n-                isRoutePPREnabled,\n+                fetchIdx,\n+                fetchUrl,\n               })\n             }\n           }\n@@ -226,10 +237,10 @@ export default class FileSystemCache implements CacheHandler {\n           }\n \n           let rscData: Buffer | undefined\n-          if (!isFallback) {\n+          if (!ctx.isFallback) {\n             rscData = await this.fs.readFile(\n               this.getFilePath(\n-                `${key}${isRoutePPREnabled ? RSC_PREFETCH_SUFFIX : RSC_SUFFIX}`,\n+                `${key}${ctx.isRoutePPREnabled ? RSC_PREFETCH_SUFFIX : RSC_SUFFIX}`,\n                 IncrementalCacheKind.APP_PAGE\n               )\n             )\n@@ -251,7 +262,7 @@ export default class FileSystemCache implements CacheHandler {\n           let meta: RouteMetadata | undefined\n           let pageData: string | object = {}\n \n-          if (!isFallback) {\n+          if (!ctx.isFallback) {\n             pageData = JSON.parse(\n               await this.fs.readFile(\n                 this.getFilePath(\n@@ -315,7 +326,10 @@ export default class FileSystemCache implements CacheHandler {\n         }\n       }\n     } else if (data?.value?.kind === CachedRouteKind.FETCH) {\n-      const combinedTags = [...(tags || []), ...(softTags || [])]\n+      const combinedTags =\n+        ctx.kind === IncrementalCacheKind.FETCH\n+          ? [...(ctx.tags || []), ...(ctx.softTags || [])]\n+          : []\n \n       const wasRevalidated = combinedTags.some((tag) => {\n         if (this.revalidatedTags.includes(tag)) {\n@@ -338,9 +352,11 @@ export default class FileSystemCache implements CacheHandler {\n     return data ?? null\n   }\n \n-  public async set(...args: Parameters<CacheHandler['set']>) {\n-    const [key, data, ctx] = args\n-    const { isFallback } = ctx\n+  public async set(\n+    key: string,\n+    data: IncrementalCacheValue | null,\n+    ctx: SetIncrementalFetchCacheContext | SetIncrementalResponseCacheContext\n+  ) {\n     memoryCache?.set(key, {\n       value: data,\n       lastModified: Date.now(),\n@@ -388,7 +404,7 @@ export default class FileSystemCache implements CacheHandler {\n       writer.append(htmlPath, data.html)\n \n       // Fallbacks don't generate a data file.\n-      if (!isFallback) {\n+      if (!ctx.fetchCache && !ctx.isFallback) {\n         writer.append(\n           this.getFilePath(\n             `${key}${\n@@ -441,7 +457,7 @@ export default class FileSystemCache implements CacheHandler {\n         filePath,\n         JSON.stringify({\n           ...data,\n-          tags: ctx.tags,\n+          tags: ctx.fetchCache ? ctx.tags : [],\n         })\n       )\n     }"
        },
        {
            "sha": "e897f3eece7259bb3ef67dcdbfe9bf3f44435bfc",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 52,
            "changes": 115,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -6,6 +6,13 @@ import {\n   type IncrementalCache as IncrementalCacheType,\n   IncrementalCacheKind,\n   CachedRouteKind,\n+  type IncrementalResponseCacheEntry,\n+  type IncrementalFetchCacheEntry,\n+  type GetIncrementalFetchCacheContext,\n+  type GetIncrementalResponseCacheContext,\n+  type CachedFetchValue,\n+  type SetIncrementalFetchCacheContext,\n+  type SetIncrementalResponseCacheContext,\n } from '../../response-cache'\n import type { Revalidate } from '../revalidate'\n import type { DeepReadonly } from '../../../shared/lib/deep-readonly'\n@@ -27,6 +34,7 @@ import {\n   getRenderResumeDataCache,\n } from '../../app-render/work-unit-async-storage.external'\n import { getCacheHandlers } from '../../use-cache/handlers'\n+import { InvariantError } from '../../../shared/lib/invariant-error'\n \n export interface CacheHandlerContext {\n   fs?: CacheFs\n@@ -52,13 +60,16 @@ export class CacheHandler {\n   constructor(_ctx: CacheHandlerContext) {}\n \n   public async get(\n-    ..._args: Parameters<IncrementalCache['get']>\n+    _cacheKey: string,\n+    _ctx: GetIncrementalFetchCacheContext | GetIncrementalResponseCacheContext\n   ): Promise<CacheHandlerValue | null> {\n     return {} as any\n   }\n \n   public async set(\n-    ..._args: Parameters<IncrementalCache['set']>\n+    _cacheKey: string,\n+    _data: IncrementalCacheValue | null,\n+    _ctx: SetIncrementalFetchCacheContext | SetIncrementalResponseCacheContext\n   ): Promise<void> {}\n \n   public async revalidateTag(\n@@ -389,19 +400,17 @@ export class IncrementalCache implements IncrementalCacheType {\n     }\n   }\n \n-  // get data from cache if available\n   async get(\n     cacheKey: string,\n-    ctx: {\n-      kind: IncrementalCacheKind\n-      revalidate?: Revalidate\n-      fetchUrl?: string\n-      fetchIdx?: number\n-      tags?: string[]\n-      softTags?: string[]\n-      isRoutePPREnabled?: boolean\n-      isFallback: boolean | undefined\n-    }\n+    ctx: GetIncrementalFetchCacheContext\n+  ): Promise<IncrementalFetchCacheEntry | null>\n+  async get(\n+    cacheKey: string,\n+    ctx: GetIncrementalResponseCacheContext\n+  ): Promise<IncrementalResponseCacheEntry | null>\n+  async get(\n+    cacheKey: string,\n+    ctx: GetIncrementalFetchCacheContext | GetIncrementalResponseCacheContext\n   ): Promise<IncrementalCacheEntry | null> {\n     // Unlike other caches if we have a resume data cache, we use it even if\n     // testmode would normally disable it or if requestHeaders say 'no-cache'.\n@@ -413,12 +422,7 @@ export class IncrementalCache implements IncrementalCacheType {\n       if (resumeDataCache) {\n         const memoryCacheData = resumeDataCache.fetch.get(cacheKey)\n         if (memoryCacheData?.kind === CachedRouteKind.FETCH) {\n-          return {\n-            isStale: false,\n-            value: memoryCacheData,\n-            revalidateAfter: false,\n-            isFallback: false,\n-          }\n+          return { isStale: false, value: memoryCacheData }\n         }\n       }\n     }\n@@ -434,18 +438,24 @@ export class IncrementalCache implements IncrementalCacheType {\n       return null\n     }\n \n-    const { isFallback } = ctx\n-\n     cacheKey = this._getPathname(\n       cacheKey,\n       ctx.kind === IncrementalCacheKind.FETCH\n     )\n-    let entry: IncrementalCacheEntry | null = null\n-    let revalidate = ctx.revalidate\n \n     const cacheData = await this.cacheHandler?.get(cacheKey, ctx)\n \n-    if (cacheData?.value?.kind === CachedRouteKind.FETCH) {\n+    if (ctx.kind === IncrementalCacheKind.FETCH) {\n+      if (!cacheData) {\n+        return null\n+      }\n+\n+      if (cacheData.value?.kind !== CachedRouteKind.FETCH) {\n+        throw new InvariantError(\n+          `Expected cached value for cache key ${JSON.stringify(cacheKey)} to be a \"FETCH\" kind, got ${JSON.stringify(cacheData.value?.kind)} instead.`\n+        )\n+      }\n+\n       const combinedTags = [...(ctx.tags || []), ...(ctx.softTags || [])]\n       // if a tag was revalidated we don't return stale data\n       if (\n@@ -456,7 +466,7 @@ export class IncrementalCache implements IncrementalCacheType {\n         return null\n       }\n \n-      revalidate = revalidate || cacheData.value.revalidate\n+      const revalidate = ctx.revalidate || cacheData.value.revalidate\n       const age =\n         (performance.timeOrigin +\n           performance.now() -\n@@ -467,19 +477,19 @@ export class IncrementalCache implements IncrementalCacheType {\n       const data = cacheData.value.data\n \n       return {\n-        isStale: isStale,\n-        value: {\n-          kind: CachedRouteKind.FETCH,\n-          data,\n-          revalidate: revalidate,\n-        },\n-        revalidateAfter:\n-          performance.timeOrigin + performance.now() + revalidate * 1000,\n-        isFallback,\n-      } satisfies IncrementalCacheEntry\n+        isStale,\n+        value: { kind: CachedRouteKind.FETCH, data, revalidate },\n+      }\n+    } else if (cacheData?.value?.kind === CachedRouteKind.FETCH) {\n+      throw new InvariantError(\n+        `Expected cached value for cache key ${JSON.stringify(cacheKey)} not to be a ${JSON.stringify(ctx.kind)} kind, got \"FETCH\" instead.`\n+      )\n     }\n \n-    const curRevalidate = this.revalidateTimings.get(toRoute(cacheKey))\n+    let entry: IncrementalResponseCacheEntry | null = null\n+    const { isFallback } = ctx\n+\n+    const revalidate = this.revalidateTimings.get(toRoute(cacheKey))\n \n     let isStale: boolean | -1 | undefined\n     let revalidateAfter: Revalidate\n@@ -491,7 +501,7 @@ export class IncrementalCache implements IncrementalCacheType {\n       revalidateAfter = this.calculateRevalidate(\n         cacheKey,\n         cacheData?.lastModified || performance.timeOrigin + performance.now(),\n-        this.dev ? ctx.kind !== IncrementalCacheKind.FETCH : false,\n+        this.dev ?? false,\n         ctx.isFallback\n       )\n       isStale =\n@@ -504,7 +514,7 @@ export class IncrementalCache implements IncrementalCacheType {\n     if (cacheData) {\n       entry = {\n         isStale,\n-        curRevalidate,\n+        revalidate,\n         revalidateAfter,\n         value: cacheData.value,\n         isFallback,\n@@ -523,29 +533,30 @@ export class IncrementalCache implements IncrementalCacheType {\n       entry = {\n         isStale,\n         value: null,\n-        curRevalidate,\n+        revalidate,\n         revalidateAfter,\n         isFallback,\n       }\n-      this.set(cacheKey, entry.value, ctx)\n+      this.set(cacheKey, entry.value, { ...ctx, revalidate })\n     }\n     return entry\n   }\n \n-  // populate the incremental cache with new data\n+  async set(\n+    pathname: string,\n+    data: CachedFetchValue | null,\n+    ctx: SetIncrementalFetchCacheContext\n+  ): Promise<void>\n+  async set(\n+    pathname: string,\n+    data: Exclude<IncrementalCacheValue, CachedFetchValue> | null,\n+    ctx: SetIncrementalResponseCacheContext\n+  ): Promise<void>\n   async set(\n     pathname: string,\n     data: IncrementalCacheValue | null,\n-    ctx: {\n-      revalidate?: Revalidate\n-      fetchCache?: boolean\n-      fetchUrl?: string\n-      fetchIdx?: number\n-      tags?: string[]\n-      isRoutePPREnabled?: boolean\n-      isFallback?: boolean\n-    }\n-  ) {\n+    ctx: SetIncrementalFetchCacheContext | SetIncrementalResponseCacheContext\n+  ): Promise<void> {\n     // Even if we otherwise disable caching for testMode or if no fetchCache is\n     // configured we still always stash results in the resume data cache if one\n     // exists. This is because this is a transient in memory cache that\n@@ -585,7 +596,7 @@ export class IncrementalCache implements IncrementalCacheType {\n     try {\n       // Set the value for the revalidate seconds so if it changes we can\n       // update the cache with the new value.\n-      if (typeof ctx.revalidate !== 'undefined' && !ctx.fetchCache) {\n+      if (!ctx.fetchCache && typeof ctx.revalidate !== 'undefined') {\n         this.revalidateTimings.set(toRoute(pathname), ctx.revalidate)\n       }\n "
        },
        {
            "sha": "d8543af4f22340716355eb2f40a4d0a8f6adf611",
            "filename": "packages/next/src/server/lib/patch-fetch.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.test.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -86,7 +86,6 @@ describe('createPatchedFetcher', () => {\n           fetchCache: true,\n           fetchIdx: 1,\n           fetchUrl: 'https://example.com/',\n-          revalidate: false,\n           tags: [],\n         }\n       )"
        },
        {
            "sha": "66d193651c9f55cf002a19493d2da56cd834809d",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 17,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -635,8 +635,6 @@ export function createPatchedFetcher(\n                   finalRevalidate >= INFINITE_CACHE\n                     ? CACHE_ONE_YEAR\n                     : finalRevalidate\n-                const externalRevalidate =\n-                  finalRevalidate >= INFINITE_CACHE ? false : finalRevalidate\n \n                 if (workUnitStore && workUnitStore.type === 'prerender') {\n                   // We are prerendering at build time or revalidate time with dynamicIO so we need to\n@@ -660,13 +658,7 @@ export function createPatchedFetcher(\n                       data: fetchedData,\n                       revalidate: normalizedRevalidate,\n                     },\n-                    {\n-                      fetchCache: true,\n-                      revalidate: externalRevalidate,\n-                      fetchUrl,\n-                      fetchIdx,\n-                      tags,\n-                    }\n+                    { fetchCache: true, fetchUrl, fetchIdx, tags }\n                   )\n                   await handleUnlock()\n \n@@ -712,13 +704,7 @@ export function createPatchedFetcher(\n                             data: fetchedData,\n                             revalidate: normalizedRevalidate,\n                           },\n-                          {\n-                            fetchCache: true,\n-                            revalidate: externalRevalidate,\n-                            fetchUrl,\n-                            fetchIdx,\n-                            tags,\n-                          }\n+                          { fetchCache: true, fetchUrl, fetchIdx, tags }\n                         )\n                       }\n                     })\n@@ -771,7 +757,6 @@ export function createPatchedFetcher(\n                   fetchIdx,\n                   tags,\n                   softTags: implicitTags,\n-                  isFallback: false,\n                 })\n \n             if (hasNoExplicitCacheConfig) {"
        },
        {
            "sha": "8e3d10cb264776512ba69247533e975fdf447441",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -77,7 +77,7 @@ import { getCloneableBody } from './body-streams'\n import { checkIsOnDemandRevalidate } from './api-utils'\n import ResponseCache, {\n   CachedRouteKind,\n-  type IncrementalCacheItem,\n+  type IncrementalResponseCacheEntry,\n } from './response-cache'\n import { IncrementalCache } from './lib/incremental-cache'\n import { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\n@@ -665,7 +665,7 @@ export default class NextNodeServer extends BaseServer<\n     req: NodeNextRequest,\n     res: NodeNextResponse,\n     paramsResult: import('./image-optimizer').ImageParamsResult,\n-    previousCacheEntry?: IncrementalCacheItem\n+    previousCacheEntry?: IncrementalResponseCacheEntry | null\n   ): Promise<{\n     buffer: Buffer\n     contentType: string"
        },
        {
            "sha": "d2feba2f2a8923785edc727fdba8405fb97de9d1",
            "filename": "packages/next/src/server/response-cache/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 21,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Findex.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -1,10 +1,9 @@\n-import {\n-  type IncrementalCache,\n-  type ResponseCacheEntry,\n-  type ResponseGenerator,\n-  type IncrementalCacheItem,\n-  type ResponseCacheBase,\n-  CachedRouteKind,\n+import type {\n+  ResponseCacheEntry,\n+  ResponseGenerator,\n+  ResponseCacheBase,\n+  IncrementalResponseCacheEntry,\n+  IncrementalResponseCache,\n } from './types'\n \n import { Batcher } from '../../lib/batcher'\n@@ -21,7 +20,7 @@ export * from './types'\n export default class ResponseCache implements ResponseCacheBase {\n   private readonly batcher = Batcher.create<\n     { key: string; isOnDemandRevalidate: boolean },\n-    IncrementalCacheItem | null,\n+    IncrementalResponseCacheEntry | null,\n     string\n   >({\n     // Ensure on-demand revalidate doesn't block normal requests, it should be\n@@ -36,7 +35,7 @@ export default class ResponseCache implements ResponseCacheBase {\n \n   private previousCacheItem?: {\n     key: string\n-    entry: IncrementalCacheItem | null\n+    entry: IncrementalResponseCacheEntry | null\n     expiresAt: number\n   }\n \n@@ -56,7 +55,7 @@ export default class ResponseCache implements ResponseCacheBase {\n       routeKind: RouteKind\n       isOnDemandRevalidate?: boolean\n       isPrefetch?: boolean\n-      incrementalCache: IncrementalCache\n+      incrementalCache: IncrementalResponseCache\n       isRoutePPREnabled?: boolean\n       isFallback?: boolean\n     }\n@@ -91,7 +90,7 @@ export default class ResponseCache implements ResponseCacheBase {\n         const kind = routeKindToIncrementalCacheKind(context.routeKind)\n \n         let resolved = false\n-        let cachedResponse: IncrementalCacheItem = null\n+        let cachedResponse: IncrementalResponseCacheEntry | null = null\n         try {\n           cachedResponse = !this.minimalMode\n             ? await incrementalCache.get(key, {\n@@ -102,16 +101,7 @@ export default class ResponseCache implements ResponseCacheBase {\n             : null\n \n           if (cachedResponse && !isOnDemandRevalidate) {\n-            if (cachedResponse.value?.kind === CachedRouteKind.FETCH) {\n-              throw new Error(\n-                `invariant: unexpected cachedResponse of kind fetch in response cache`\n-              )\n-            }\n-\n-            resolve({\n-              ...cachedResponse,\n-              revalidate: cachedResponse.curRevalidate,\n-            })\n+            resolve(cachedResponse)\n             resolved = true\n \n             if (!cachedResponse.isStale || context.isPrefetch) {"
        },
        {
            "sha": "a2c8110c4047c75a3edb102e1ac61456460719a1",
            "filename": "packages/next/src/server/response-cache/types.ts",
            "status": "modified",
            "additions": 94,
            "deletions": 47,
            "changes": 141,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -131,16 +131,33 @@ export interface IncrementalCachedPageValue {\n   status: number | undefined\n }\n \n-export type IncrementalCacheEntry = {\n-  curRevalidate?: Revalidate\n-  // milliseconds to revalidate after\n-  revalidateAfter: Revalidate\n-  // -1 here dictates a blocking revalidate should be used\n+export interface IncrementalResponseCacheEntry {\n+  revalidate?: Revalidate\n+  /**\n+   * timestamp in milliseconds to revalidate after\n+   */\n+  revalidateAfter?: Revalidate\n+  /**\n+   * `-1` here dictates a blocking revalidate should be used\n+   */\n   isStale?: boolean | -1\n-  value: IncrementalCacheValue | null\n+  isMiss?: boolean\n   isFallback: boolean | undefined\n+  value: Exclude<IncrementalCacheValue, CachedFetchValue> | null\n+}\n+\n+export interface IncrementalFetchCacheEntry {\n+  /**\n+   * `-1` here dictates a blocking revalidate should be used\n+   */\n+  isStale?: boolean | -1\n+  value: CachedFetchValue\n }\n \n+export type IncrementalCacheEntry =\n+  | IncrementalResponseCacheEntry\n+  | IncrementalFetchCacheEntry\n+\n export type IncrementalCacheValue =\n   | CachedRedirectValue\n   | IncrementalCachedPageValue\n@@ -170,20 +187,10 @@ export type ResponseCacheEntry = {\n  */\n export type ResponseGenerator = (state: {\n   hasResolved: boolean\n-  previousCacheEntry?: IncrementalCacheItem\n+  previousCacheEntry?: IncrementalResponseCacheEntry | null\n   isRevalidating?: boolean\n }) => Promise<ResponseCacheEntry | null>\n \n-export type IncrementalCacheItem = {\n-  revalidateAfter?: number | false\n-  curRevalidate?: number | false\n-  revalidate?: number | false\n-  value: IncrementalCacheValue | null\n-  isStale?: boolean | -1\n-  isMiss?: boolean\n-  isFallback: boolean | undefined\n-} | null\n-\n export const enum IncrementalCacheKind {\n   APP_PAGE = 'APP_PAGE',\n   APP_ROUTE = 'APP_ROUTE',\n@@ -192,38 +199,78 @@ export const enum IncrementalCacheKind {\n   IMAGE = 'IMAGE',\n }\n \n-export interface IncrementalCache {\n-  get: (\n-    key: string,\n-    ctx: {\n-      kind: IncrementalCacheKind\n+export interface GetIncrementalFetchCacheContext {\n+  kind: IncrementalCacheKind.FETCH\n+  revalidate?: Revalidate\n+  fetchUrl?: string\n+  fetchIdx?: number\n+  tags?: string[]\n+  softTags?: string[]\n+}\n \n-      /**\n-       * True if the route is enabled for PPR.\n-       */\n-      isRoutePPREnabled?: boolean\n+export interface GetIncrementalResponseCacheContext {\n+  kind: Exclude<IncrementalCacheKind, IncrementalCacheKind.FETCH>\n+  /**\n+   * True if the route is enabled for PPR.\n+   */\n+  isRoutePPREnabled?: boolean\n \n-      /**\n-       * True if this is a fallback request.\n-       */\n-      isFallback: boolean\n-    }\n-  ) => Promise<IncrementalCacheItem>\n-  set: (\n-    key: string,\n-    data: IncrementalCacheValue | null,\n-    ctx: {\n-      revalidate: Revalidate\n+  /**\n+   * True if this is a fallback request.\n+   */\n+  isFallback: boolean\n+}\n \n-      /**\n-       * True if the route is enabled for PPR.\n-       */\n-      isRoutePPREnabled?: boolean\n+export interface SetIncrementalFetchCacheContext {\n+  fetchCache: true\n+  fetchUrl?: string\n+  fetchIdx?: number\n+  tags?: string[]\n+}\n \n-      /**\n-       * True if this is a fallback request.\n-       */\n-      isFallback: boolean\n-    }\n-  ) => Promise<void>\n+export interface SetIncrementalResponseCacheContext {\n+  fetchCache?: false\n+  revalidate?: Revalidate\n+  /**\n+   * True if the route is enabled for PPR.\n+   */\n+  isRoutePPREnabled?: boolean\n+\n+  /**\n+   * True if this is a fallback request.\n+   */\n+  isFallback?: boolean\n+}\n+\n+export interface IncrementalResponseCache {\n+  get(\n+    cacheKey: string,\n+    ctx: GetIncrementalResponseCacheContext\n+  ): Promise<IncrementalResponseCacheEntry | null>\n+  set(\n+    key: string,\n+    data: Exclude<IncrementalCacheValue, CachedFetchValue> | null,\n+    ctx: SetIncrementalResponseCacheContext\n+  ): Promise<void>\n+}\n+\n+export interface IncrementalCache extends IncrementalResponseCache {\n+  get(\n+    cacheKey: string,\n+    ctx: GetIncrementalFetchCacheContext\n+  ): Promise<IncrementalFetchCacheEntry | null>\n+  get(\n+    cacheKey: string,\n+    ctx: GetIncrementalResponseCacheContext\n+  ): Promise<IncrementalResponseCacheEntry | null>\n+  set(\n+    key: string,\n+    data: CachedFetchValue | null,\n+    ctx: SetIncrementalFetchCacheContext\n+  ): Promise<void>\n+  set(\n+    key: string,\n+    data: Exclude<IncrementalCacheValue, CachedFetchValue> | null,\n+    ctx: SetIncrementalResponseCacheContext\n+  ): Promise<void>\n }"
        },
        {
            "sha": "e43c2abdd839748779d384ba60c16d89dd07c604",
            "filename": "packages/next/src/server/response-cache/utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -3,7 +3,7 @@ import {\n   IncrementalCacheKind,\n   type CachedAppPageValue,\n   type CachedPageValue,\n-  type IncrementalCacheItem,\n+  type IncrementalResponseCacheEntry,\n   type ResponseCacheEntry,\n } from './types'\n \n@@ -12,7 +12,7 @@ import { RouteKind } from '../route-kind'\n \n export async function fromResponseCacheEntry(\n   cacheEntry: ResponseCacheEntry\n-): Promise<IncrementalCacheItem> {\n+): Promise<IncrementalResponseCacheEntry> {\n   return {\n     ...cacheEntry,\n     value:\n@@ -39,16 +39,10 @@ export async function fromResponseCacheEntry(\n }\n \n export async function toResponseCacheEntry(\n-  response: IncrementalCacheItem\n+  response: IncrementalResponseCacheEntry | null\n ): Promise<ResponseCacheEntry | null> {\n   if (!response) return null\n \n-  if (response.value?.kind === CachedRouteKind.FETCH) {\n-    throw new Error(\n-      'Invariant: unexpected cachedResponse of kind fetch in response cache'\n-    )\n-  }\n-\n   return {\n     isMiss: response.isMiss,\n     isStale: response.isStale,\n@@ -79,7 +73,7 @@ export async function toResponseCacheEntry(\n \n export function routeKindToIncrementalCacheKind(\n   routeKind: RouteKind\n-): IncrementalCacheKind {\n+): Exclude<IncrementalCacheKind, IncrementalCacheKind.FETCH> {\n   switch (routeKind) {\n     case RouteKind.PAGES:\n       return IncrementalCacheKind.PAGES"
        },
        {
            "sha": "c9db5451f31c39fa04389b497db5871d5eee55ad",
            "filename": "packages/next/src/server/web/spec-extension/unstable-cache.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -37,13 +37,7 @@ async function cacheNewResult<T>(\n       } satisfies CachedFetchData,\n       revalidate: typeof revalidate !== 'number' ? CACHE_ONE_YEAR : revalidate,\n     },\n-    {\n-      revalidate,\n-      fetchCache: true,\n-      tags,\n-      fetchIdx,\n-      fetchUrl,\n-    }\n+    { fetchCache: true, tags, fetchIdx, fetchUrl }\n   )\n   return\n }\n@@ -208,7 +202,6 @@ export function unstable_cache<T extends Callback>(\n             softTags: implicitTags,\n             fetchIdx,\n             fetchUrl,\n-            isFallback: false,\n           })\n \n           if (cacheEntry && cacheEntry.value) {\n@@ -312,7 +305,6 @@ export function unstable_cache<T extends Callback>(\n             fetchIdx,\n             fetchUrl,\n             softTags: implicitTags,\n-            isFallback: false,\n           })\n \n           if (cacheEntry && cacheEntry.value) {"
        },
        {
            "sha": "c0d8e2230aa1fa3acb7579cc0caf27c73a448ae8",
            "filename": "test/unit/image-optimizer/get-previously-cached-image-or-null.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/test%2Funit%2Fimage-optimizer%2Fget-previously-cached-image-or-null.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/test%2Funit%2Fimage-optimizer%2Fget-previously-cached-image-or-null.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fimage-optimizer%2Fget-previously-cached-image-or-null.test.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -5,7 +5,7 @@ import {\n } from 'next/dist/server/image-optimizer'\n import {\n   CachedRouteKind,\n-  IncrementalCacheItem,\n+  IncrementalCacheEntry,\n } from 'next/dist/server/response-cache/types'\n import { readFile } from 'fs-extra'\n import { join } from 'path'\n@@ -37,7 +37,7 @@ const getPreviousCacheEntry = async (\n ) => {\n   const buffer = await readFile(join(__dirname, filepath))\n   const upstreamEtag = getImageEtag(buffer)\n-  const result: IncrementalCacheItem = {\n+  const result: IncrementalCacheEntry = {\n     ...baseCacheEntry,\n     value: {\n       kind: CachedRouteKind.IMAGE,\n@@ -62,7 +62,7 @@ describe('shouldUsePreviouslyCachedEntry', () => {\n   })\n \n   it('should return null if previous cache entry value is not of kind IMAGE', async () => {\n-    const nonImageCacheEntry: IncrementalCacheItem = {\n+    const nonImageCacheEntry: IncrementalCacheEntry = {\n       ...baseCacheEntry,\n       value: { kind: CachedRouteKind.REDIRECT, props: {} },\n     }"
        },
        {
            "sha": "5ef377d0fa9485e3158023245cb3f58fea7305fd",
            "filename": "test/unit/incremental-cache/file-system-cache.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/test%2Funit%2Fincremental-cache%2Ffile-system-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a1b6336a3062dfdb1b9dddcee6b836da94fd198/test%2Funit%2Fincremental-cache%2Ffile-system-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fincremental-cache%2Ffile-system-cache.test.ts?ref=6a1b6336a3062dfdb1b9dddcee6b836da94fd198",
            "patch": "@@ -79,7 +79,6 @@ describe('FileSystemCache (isrMemory 0)', () => {\n       },\n       {\n         fetchCache: true,\n-        revalidate: 30,\n         fetchUrl: 'http://my-api.local',\n         fetchIdx: 5,\n         tags: ['server-time'],\n@@ -89,7 +88,6 @@ describe('FileSystemCache (isrMemory 0)', () => {\n     const res = await fsCache.get('fetch-cache', {\n       tags: ['server-time'],\n       kind: IncrementalCacheKind.FETCH,\n-      isFallback: undefined,\n     })\n \n     expect(res?.value).toEqual({\n@@ -113,13 +111,12 @@ describe('FileSystemCache (isrMemory 0)', () => {\n         data: { headers: {}, body: '1700056381', status: 200, url: '' },\n         revalidate: 30,\n       },\n-      { revalidate: 30, fetchCache: true, tags: ['server-time2'] }\n+      { fetchCache: true, tags: ['server-time2'] }\n     )\n \n     const res = await fsCache.get('unstable-cache', {\n       tags: ['server-time'],\n       kind: IncrementalCacheKind.FETCH,\n-      isFallback: undefined,\n     })\n \n     expect(res?.value).toEqual({"
        }
    ],
    "stats": {
        "total": 403,
        "additions": 218,
        "deletions": 185
    }
}