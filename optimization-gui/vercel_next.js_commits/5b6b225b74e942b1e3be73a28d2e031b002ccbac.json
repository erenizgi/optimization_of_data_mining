{
    "author": "unstubbable",
    "message": "Remove obsolete update of implicit tags expiration after server action (#77595)\n\nWith the change in #76885, we don't need to update the expiration date of implicit tags anymore at the end of a request to ensure no stale data is used after `revalidatePath` was called in a server action.\r\n\r\nThis PR is covered by the existing tests, e.g. `use-cache should revalidate caches after redirect`.",
    "sha": "5b6b225b74e942b1e3be73a28d2e031b002ccbac",
    "files": [
        {
            "sha": "839610599cf8b97550d2db15596a445b610ca1d0",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=5b6b225b74e942b1e3be73a28d2e031b002ccbac",
            "patch": "@@ -517,9 +517,6 @@ export async function handleAction({\n \n   requestStore.phase = 'action'\n \n-  const resolvePendingRevalidations = async () =>\n-    workUnitAsyncStorage.run(requestStore, () => executeRevalidates(workStore))\n-\n   // When running actions the default is no-store, you can still `cache: 'force-cache'`\n   workStore.fetchCache = 'default-no-store'\n \n@@ -571,7 +568,7 @@ export async function handleAction({\n \n       if (isFetchAction) {\n         res.statusCode = 500\n-        await resolvePendingRevalidations()\n+        await executeRevalidates(workStore)\n \n         const promise = Promise.reject(error)\n         try {\n@@ -926,7 +923,7 @@ export async function handleAction({\n \n       // For form actions, we need to continue rendering the page.\n       if (isFetchAction) {\n-        await resolvePendingRevalidations()\n+        await executeRevalidates(workStore)\n         addRevalidationHeader(res, { workStore, requestStore })\n \n         actionResult = await finalizeAndGenerateFlight(req, ctx, requestStore, {\n@@ -948,7 +945,7 @@ export async function handleAction({\n       const redirectUrl = getURLFromRedirectError(err)\n       const redirectType = getRedirectTypeFromError(err)\n \n-      await resolvePendingRevalidations()\n+      await executeRevalidates(workStore)\n       addRevalidationHeader(res, { workStore, requestStore })\n \n       // if it's a fetch action, we'll set the status code for logging/debugging purposes\n@@ -978,7 +975,7 @@ export async function handleAction({\n     } else if (isHTTPAccessFallbackError(err)) {\n       res.statusCode = getAccessFallbackHTTPStatus(err)\n \n-      await resolvePendingRevalidations()\n+      await executeRevalidates(workStore)\n       addRevalidationHeader(res, { workStore, requestStore })\n \n       if (isFetchAction) {\n@@ -1008,7 +1005,7 @@ export async function handleAction({\n \n     if (isFetchAction) {\n       res.statusCode = 500\n-      await resolvePendingRevalidations()\n+      await executeRevalidates(workStore)\n       const promise = Promise.reject(err)\n       try {\n         // we need to await the promise to trigger the rejection early"
        },
        {
            "sha": "e9969b3416852680fb6263b8b3d12a72d4aec2d4",
            "filename": "packages/next/src/server/lib/implicit-tags.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fimplicit-tags.ts?ref=5b6b225b74e942b1e3be73a28d2e031b002ccbac",
            "patch": "@@ -13,7 +13,7 @@ export interface ImplicitTags {\n    * implicit tags' expiration is stored in the work unit store, and used to\n    * compare with a cache entry's timestamp.\n    */\n-  expiration: number\n+  readonly expiration: number\n }\n \n const getDerivedTags = (pathname: string): string[] => {\n@@ -71,16 +71,6 @@ async function getImplicitTagsExpiration(tags: string[]): Promise<number> {\n   return expiration\n }\n \n-/**\n- * Fetches a new expiration value for the given `implicitTags`, and mutates its\n- * `expiration` property.\n- */\n-export async function updateImplicitTagsExpiration(\n-  implicitTags: ImplicitTags\n-): Promise<void> {\n-  implicitTags.expiration = await getImplicitTagsExpiration(implicitTags.tags)\n-}\n-\n export async function getImplicitTags(\n   page: string,\n   url: {"
        },
        {
            "sha": "acd305ce17b816a843092a8418f9b0fa89cddee7",
            "filename": "packages/next/src/server/revalidation-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b6b225b74e942b1e3be73a28d2e031b002ccbac/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frevalidation-utils.ts?ref=5b6b225b74e942b1e3be73a28d2e031b002ccbac",
            "patch": "@@ -1,6 +1,4 @@\n import type { WorkStore } from './app-render/work-async-storage.external'\n-import { workUnitAsyncStorage } from './app-render/work-unit-async-storage.external'\n-import { updateImplicitTagsExpiration } from './lib/implicit-tags'\n import type { IncrementalCache } from './lib/incremental-cache'\n import { getCacheHandlers } from './use-cache/handlers'\n \n@@ -89,16 +87,6 @@ async function revalidateTags(\n   }\n \n   await Promise.all(promises)\n-\n-  const workUnitStore = workUnitAsyncStorage.getStore()\n-\n-  if (workUnitStore?.implicitTags) {\n-    const tagsSet = new Set(tags)\n-\n-    if (workUnitStore.implicitTags.tags.some((tag) => tagsSet.has(tag))) {\n-      await updateImplicitTagsExpiration(workUnitStore.implicitTags)\n-    }\n-  }\n }\n \n export async function executeRevalidates("
        },
        {
            "sha": "2861df7b3ec7cd8223f96a32529c500591139b93",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/use-cache-custom-handler.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 26,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5b6b225b74e942b1e3be73a28d2e031b002ccbac/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b6b225b74e942b1e3be73a28d2e031b002ccbac/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts?ref=5b6b225b74e942b1e3be73a28d2e031b002ccbac",
            "patch": "@@ -147,7 +147,7 @@ describe('use-cache-custom-handler', () => {\n     })\n   })\n \n-  it('should not call getExpiration again after an action if only explicit tags were revalidated', async () => {\n+  it('should not call getExpiration again after an action', async () => {\n     const browser = await next.browser(`/`)\n \n     await retry(async () => {\n@@ -171,29 +171,4 @@ describe('use-cache-custom-handler', () => {\n       )\n     })\n   })\n-\n-  it('should call getExpiration again after an action if implicit tags were revalidated', async () => {\n-    const browser = await next.browser(`/`)\n-\n-    await retry(async () => {\n-      const cliOutput = next.cliOutput.slice(outputIndex)\n-      expect(cliOutput).toInclude('ModernCustomCacheHandler::getExpiration')\n-    })\n-\n-    outputIndex = next.cliOutput.length\n-\n-    await browser.elementById('revalidate-path').click()\n-\n-    await retry(async () => {\n-      const cliOutput = next.cliOutput.slice(outputIndex)\n-      expect(cliOutput).toIncludeRepeated(\n-        'ModernCustomCacheHandler::expireTags',\n-        1\n-      )\n-      expect(cliOutput).toIncludeRepeated(\n-        'ModernCustomCacheHandler::getExpiration',\n-        2\n-      )\n-    })\n-  })\n })"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 7,
        "deletions": 57
    }
}