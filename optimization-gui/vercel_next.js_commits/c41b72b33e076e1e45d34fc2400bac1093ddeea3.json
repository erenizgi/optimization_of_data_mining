{
    "author": "raunofreiberg",
    "message": "[dev-tools] Fix flashing of disabled state on indicator (#77727)\n\nThis PR adds a better heuristic for detecting whether the dev indicator\nis in a disabled state or not. Right now the only way to disable it is\nwith a `devIndicators: false` in `next.config.js`.\n\nBut the flag is read in async, meaning the surface on load always\nflashes between the two states (the one with the â„¹ icon is the disabled\nstate):\n\n\nhttps://github.com/user-attachments/assets/847615de-9376-431b-855f-50aa6cf4026c\n\nIn this PR, we are deferring rendering the indicator until we can\nreliably know which state it should be in.\n\nAs a bonus, we are also using `state.buildError` to detect whether the\nindicator should be in a build error state. Relying on\n`runtimeErrors.length` as we did previously is not as reliable since we\nalso load the runtime errors in async so they will be empty on first\nrender which does not necessarily indicate a build error.",
    "sha": "c41b72b33e076e1e45d34fc2400bac1093ddeea3",
    "files": [
        {
            "sha": "61afba4867053ea55ae00dbac450539367118c46",
            "filename": "packages/next/src/client/components/react-dev-overlay/shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts?ref=c41b72b33e076e1e45d34fc2400bac1093ddeea3",
            "patch": "@@ -22,6 +22,7 @@ export interface OverlayState {\n   versionInfo: VersionInfo\n   notFound: boolean\n   staticIndicator: boolean\n+  showIndicator: boolean\n   disableDevIndicator: boolean\n   debugInfo: DebugInfo\n   routerType: 'pages' | 'app'\n@@ -122,8 +123,13 @@ export const INITIAL_OVERLAY_STATE: Omit<OverlayState, 'routerType'> = {\n   errors: [],\n   notFound: false,\n   staticIndicator: false,\n-  // To prevent flickering, set the initial state to disabled.\n-  disableDevIndicator: true,\n+  /* \n+    This is set to `true` when we can reliably know\n+    whether the indicator is in disabled state or not.  \n+    Otherwise the surface would flicker because the disabled flag loads from the config.\n+  */\n+  showIndicator: false,\n+  disableDevIndicator: false,\n   refreshState: { type: 'idle' },\n   versionInfo: { installed: '0.0.0', staleness: 'unknown' },\n   debugInfo: { devtoolsFrontendUrl: undefined },\n@@ -209,6 +215,7 @@ export function useErrorOverlayReducer(routerType: 'pages' | 'app') {\n       case ACTION_DEV_INDICATOR: {\n         return {\n           ...state,\n+          showIndicator: true,\n           disableDevIndicator:\n             shouldDisableDevIndicator || !!action.devIndicator.disabledUntil,\n         }"
        },
        {
            "sha": "66f1f3d8315e3edc51166c930676d4fe3de68372",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.stories.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.stories.tsx?ref=c41b72b33e076e1e45d34fc2400bac1093ddeea3",
            "patch": "@@ -51,6 +51,7 @@ const state: OverlayState = {\n   errors: [],\n   refreshState: { type: 'idle' },\n   disableDevIndicator: false,\n+  showIndicator: true,\n   versionInfo: mockVersionInfo,\n   notFound: false,\n   staticIndicator: true,"
        },
        {
            "sha": "d01a0084e53b5b8dfaa1cce639b80eb8ca330936",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/next-logo.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx?ref=c41b72b33e076e1e45d34fc2400bac1093ddeea3",
            "patch": "@@ -25,7 +25,7 @@ export const NextLogo = forwardRef(function NextLogo(\n     isBuildError,\n     onTriggerClick,\n     toggleErrorOverlay,\n-    scale,\n+    scale = 1,\n     ...props\n   }: Props,\n   propRef: React.Ref<HTMLButtonElement>"
        },
        {
            "sha": "27c9de8a9907e2d0f01120c60af7cebdf2c53b42",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/dev-overlay.stories.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx?ref=c41b72b33e076e1e45d34fc2400bac1093ddeea3",
            "patch": "@@ -23,6 +23,7 @@ const state: OverlayState = {\n   routerType: 'app',\n   buildError: null,\n   disableDevIndicator: false,\n+  showIndicator: true,\n   errors: [\n     {\n       id: 1,"
        },
        {
            "sha": "96f2e5628e52eb9934d8a0cc4b7c4a408ddd53d9",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/dev-overlay.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c41b72b33e076e1e45d34fc2400bac1093ddeea3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.tsx?ref=c41b72b33e076e1e45d34fc2400bac1093ddeea3",
            "patch": "@@ -33,17 +33,19 @@ export function DevOverlay({\n \n       <RenderError state={state} isAppDir={true}>\n         {({ runtimeErrors, totalErrorCount }) => {\n-          const isBuildError = runtimeErrors.length === 0\n+          const isBuildError = state.buildError !== null\n           return (\n             <>\n-              <DevToolsIndicator\n-                scale={scale}\n-                setScale={setScale}\n-                state={state}\n-                errorCount={totalErrorCount}\n-                isBuildError={isBuildError}\n-                setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n-              />\n+              {state.showIndicator && (\n+                <DevToolsIndicator\n+                  scale={scale}\n+                  setScale={setScale}\n+                  state={state}\n+                  errorCount={totalErrorCount}\n+                  isBuildError={isBuildError}\n+                  setIsErrorOverlayOpen={setIsErrorOverlayOpen}\n+                />\n+              )}\n \n               <ErrorOverlay\n                 state={state}"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 23,
        "deletions": 12
    }
}