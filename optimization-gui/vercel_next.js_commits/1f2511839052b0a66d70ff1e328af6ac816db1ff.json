{
    "author": "unstubbable",
    "message": "Fix name tracking for closures in server actions transform (#79657)\n\nWhen a server function passes a closure to a method on a closed-over\nvalue (e.g. an array), we must correctly track the value itself so that\nit's included in the bound arguments.\n\nFor example, in this snippet, `list` must be bound to the server action:\n\n```js\nexport function Component({ list }) {\n  return (\n    <form\n      action={async () => {\n        'use server'\n        console.log(list.find((x) => !!x))\n      }}\n    >\n      <button>submit</button>\n    </form>\n  )\n}\n```\n\nThis use case used to work but was accidentally broken by #73189.\n\nfixes #79608\nfixes #77247\ncloses NAR-8",
    "sha": "1f2511839052b0a66d70ff1e328af6ac816db1ff",
    "files": [
        {
            "sha": "5814def9a6b3d69567c8849f651cc2b94613c674",
            "filename": ".changeset/tough-peaches-burn.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1f2511839052b0a66d70ff1e328af6ac816db1ff/.changeset%2Ftough-peaches-burn.md",
            "raw_url": "https://github.com/vercel/next.js/raw/1f2511839052b0a66d70ff1e328af6ac816db1ff/.changeset%2Ftough-peaches-burn.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Ftough-peaches-burn.md?ref=1f2511839052b0a66d70ff1e328af6ac816db1ff",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+\"next\": patch\n+---\n+\n+Fix name tracking for closures in server actions transform"
        },
        {
            "sha": "3fd09d097a0517d23e2397c2b359142fa0fa7e43",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=1f2511839052b0a66d70ff1e328af6ac816db1ff",
            "patch": "@@ -1011,6 +1011,12 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n             self.fn_decl_ident = old_fn_decl_ident;\n         }\n \n+        let mut child_names = take(&mut self.names);\n+\n+        if self.should_track_names {\n+            self.names = [old_names, child_names.clone()].concat();\n+        }\n+\n         if let Some(directive) = directive {\n             if !f.is_async {\n                 emit_error(ServerActionsErrorKind::InlineSyncFunction {\n@@ -1028,12 +1034,6 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                 return;\n             }\n \n-            let mut child_names = take(&mut self.names);\n-\n-            if self.should_track_names {\n-                self.names = [old_names, child_names.clone()].concat();\n-            }\n-\n             if let Directive::UseCache { cache_kind } = directive {\n                 // Collect all the identifiers defined inside the closure and used\n                 // in the cache function. With deduplication.\n@@ -1181,6 +1181,12 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n             self.in_default_export_decl = old_in_default_export_decl;\n         }\n \n+        let mut child_names = take(&mut self.names);\n+\n+        if self.should_track_names {\n+            self.names = [old_names, child_names.clone()].concat();\n+        }\n+\n         if let Some(directive) = directive {\n             if !a.is_async {\n                 emit_error(ServerActionsErrorKind::InlineSyncFunction {\n@@ -1199,12 +1205,6 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                 return;\n             }\n \n-            let mut child_names = take(&mut self.names);\n-\n-            if self.should_track_names {\n-                self.names = [old_names, child_names.clone()].concat();\n-            }\n-\n             // Collect all the identifiers defined inside the closure and used\n             // in the action function. With deduplication.\n             retain_names_from_declared_idents("
        },
        {
            "sha": "14367767c29038df166b9ca31797463eec84650d",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/61/input.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Finput.js?ref=1f2511839052b0a66d70ff1e328af6ac816db1ff",
            "patch": "@@ -0,0 +1,29 @@\n+export function ComponentA({ list, y }) {\n+  return (\n+    <form\n+      action={async () => {\n+        'use server'\n+        console.log(list.find((x) => x === y))\n+      }}\n+    >\n+      <button>submit</button>\n+    </form>\n+  )\n+}\n+\n+export function ComponentB({ list, y }) {\n+  return (\n+    <form\n+      action={async () => {\n+        'use server'\n+        console.log(\n+          list.find(function (x) {\n+            return x === y\n+          })\n+        )\n+      }}\n+    >\n+      <button>submit</button>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "10417e25b2c8574b7b53badd9f333ffaf134236c",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/61/output.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1f2511839052b0a66d70ff1e328af6ac816db1ff/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F61%2Foutput.js?ref=1f2511839052b0a66d70ff1e328af6ac816db1ff",
            "patch": "@@ -0,0 +1,22 @@\n+/* __next_internal_action_entry_do_not_use__ {\"406a88810ecce4a4e8b59d53b8327d7e98bbf251d7\":\"$$RSC_SERVER_ACTION_0\",\"4090b5db271335765a4b0eab01f044b381b5ebd5cd\":\"$$RSC_SERVER_ACTION_1\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n+import { encryptActionBoundArgs, decryptActionBoundArgs } from \"private-next-rsc-action-encryption\";\n+export const $$RSC_SERVER_ACTION_0 = async function action($$ACTION_CLOSURE_BOUND) {\n+    var [$$ACTION_ARG_0, $$ACTION_ARG_1] = await decryptActionBoundArgs(\"406a88810ecce4a4e8b59d53b8327d7e98bbf251d7\", $$ACTION_CLOSURE_BOUND);\n+    console.log($$ACTION_ARG_0.find((x)=>x === $$ACTION_ARG_1));\n+};\n+export function ComponentA({ list, y }) {\n+    return <form action={registerServerReference($$RSC_SERVER_ACTION_0, \"406a88810ecce4a4e8b59d53b8327d7e98bbf251d7\", null).bind(null, encryptActionBoundArgs(\"406a88810ecce4a4e8b59d53b8327d7e98bbf251d7\", list, y))}>\n+      <button>submit</button>\n+    </form>;\n+}\n+export const $$RSC_SERVER_ACTION_1 = async function action($$ACTION_CLOSURE_BOUND) {\n+    var [$$ACTION_ARG_0, $$ACTION_ARG_1] = await decryptActionBoundArgs(\"4090b5db271335765a4b0eab01f044b381b5ebd5cd\", $$ACTION_CLOSURE_BOUND);\n+    console.log($$ACTION_ARG_0.find(function(x) {\n+        return x === $$ACTION_ARG_1;\n+    }));\n+};\n+export function ComponentB({ list, y }) {\n+    return <form action={registerServerReference($$RSC_SERVER_ACTION_1, \"4090b5db271335765a4b0eab01f044b381b5ebd5cd\", null).bind(null, encryptActionBoundArgs(\"4090b5db271335765a4b0eab01f044b381b5ebd5cd\", list, y))}>\n+      <button>submit</button>\n+    </form>;\n+}"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 68,
        "deletions": 12
    }
}