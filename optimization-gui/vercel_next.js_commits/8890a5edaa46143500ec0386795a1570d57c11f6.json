{
    "author": "ztanner",
    "message": "run config deprecation checks only on user-provided configuration (#82613)\n\nThe deprecation warning code is fairly brittle right now since there's a\nmixture of calling things with `userConfig` and `result`. It was assumed\nthat `userConfig` was the actual user-provided configuration, but it\nturns out it's actually the default configuration when a user\nconfiguration isn't specified.\n\nThis moves all the deprecation checks to be before we actually do any\nsort of merging. This restores the intent behind `userConfig` and will\nprevent deprecation warnings from being logged due to defaults.\n\nAlternative to #82593",
    "sha": "8890a5edaa46143500ec0386795a1570d57c11f6",
    "files": [
        {
            "sha": "85a506bcf930480c21e4552965cf303164a2384e",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 91,
            "deletions": 77,
            "changes": 168,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -89,6 +89,84 @@ export function warnOptionHasBeenDeprecated(\n   return hasWarned\n }\n \n+function checkDeprecations(\n+  userConfig: NextConfig,\n+  configFileName: string,\n+  silent: boolean,\n+  dir: string\n+) {\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'amp',\n+    `Built-in amp support is deprecated and the \\`amp\\` configuration option will be removed in Next.js 16.`,\n+    silent\n+  )\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'experimental.amp',\n+    `Built-in amp support is deprecated and the \\`experimental.amp\\` configuration option will be removed in Next.js 16.`,\n+    silent\n+  )\n+\n+  if (userConfig.experimental?.dynamicIO !== undefined) {\n+    warnOptionHasBeenDeprecated(\n+      userConfig,\n+      'experimental.dynamicIO',\n+      `\\`experimental.dynamicIO\\` has been renamed to \\`experimental.cacheComponents\\`. Please update your ${configFileName} file accordingly.`,\n+      silent\n+    )\n+  }\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'experimental.instrumentationHook',\n+    `\\`experimental.instrumentationHook\\` is no longer needed, because \\`instrumentation.js\\` is available by default. You can remove it from ${configFileName}.`,\n+    silent\n+  )\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'experimental.after',\n+    `\\`experimental.after\\` is no longer needed, because \\`after\\` is available by default. You can remove it from ${configFileName}.`,\n+    silent\n+  )\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'devIndicators.appIsrStatus',\n+    `\\`devIndicators.appIsrStatus\\` is deprecated and no longer configurable. Please remove it from ${configFileName}.`,\n+    silent\n+  )\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'devIndicators.buildActivity',\n+    `\\`devIndicators.buildActivity\\` is deprecated and no longer configurable. Please remove it from ${configFileName}.`,\n+    silent\n+  )\n+\n+  warnOptionHasBeenDeprecated(\n+    userConfig,\n+    'devIndicators.buildActivityPosition',\n+    `\\`devIndicators.buildActivityPosition\\` has been renamed to \\`devIndicators.position\\`. Please update your ${configFileName} file accordingly.`,\n+    silent\n+  )\n+\n+  // i18n deprecation for App Router\n+  if (userConfig.i18n) {\n+    const hasAppDir = Boolean(findDir(dir, 'app'))\n+    if (hasAppDir) {\n+      warnOptionHasBeenDeprecated(\n+        userConfig,\n+        'i18n',\n+        `i18n configuration in ${configFileName} is unsupported in App Router.\\nLearn more about internationalization in App Router: https://nextjs.org/docs/app/building-your-application/routing/internationalization`,\n+        silent\n+      )\n+    }\n+  }\n+}\n+\n export function warnOptionHasBeenMovedOutOfExperimental(\n   config: NextConfig,\n   oldExperimentalKey: string,\n@@ -161,35 +239,8 @@ function assignDefaults(\n     delete userConfig.exportTrailingSlash\n   }\n \n-  // There are a good amount of test fixtures that have amp enabled\n-  // that also assert on stderr output being empty, so we're gating the\n-  // warning to be skipped when running in Next.js tests until we fully\n-  // remove the feature.\n-  if (!process.env.__NEXT_TEST_MODE) {\n-    warnOptionHasBeenDeprecated(\n-      userConfig,\n-      'amp',\n-      `Built-in amp support is deprecated and the \\`amp\\` configuration option will be removed in Next.js 16.`,\n-      silent\n-    )\n-\n-    warnOptionHasBeenDeprecated(\n-      userConfig,\n-      'experimental.amp',\n-      `Built-in amp support is deprecated and the \\`experimental.amp\\` configuration option will be removed in Next.js 16.`,\n-      silent\n-    )\n-  }\n-\n-  // Handle deprecation of experimental.dynamicIO and migrate to experimental.cacheComponents\n+  // Handle migration of experimental.dynamicIO to experimental.cacheComponents\n   if (userConfig.experimental?.dynamicIO !== undefined) {\n-    warnOptionHasBeenDeprecated(\n-      userConfig,\n-      'experimental.dynamicIO',\n-      `\\`experimental.dynamicIO\\` has been renamed to \\`experimental.cacheComponents\\`. Please update your ${configFileName} file accordingly.`,\n-      silent\n-    )\n-\n     // If cacheComponents was not explicitly set by the user (i.e., it's still the default value),\n     // use the dynamicIO value. We check against the user config, not the merged result.\n     if (userConfig.experimental?.cacheComponents === undefined) {\n@@ -532,49 +583,17 @@ function assignDefaults(\n     silent\n   )\n \n-  warnOptionHasBeenDeprecated(\n-    result,\n-    'experimental.instrumentationHook',\n-    `\\`experimental.instrumentationHook\\` is no longer needed, because \\`instrumentation.js\\` is available by default. You can remove it from ${configFileName}.`,\n-    silent\n-  )\n-\n-  warnOptionHasBeenDeprecated(\n-    result,\n-    'experimental.after',\n-    `\\`experimental.after\\` is no longer needed, because \\`after\\` is available by default. You can remove it from ${configFileName}.`,\n-    silent\n-  )\n-\n-  warnOptionHasBeenDeprecated(\n-    result,\n-    'devIndicators.appIsrStatus',\n-    `\\`devIndicators.appIsrStatus\\` is deprecated and no longer configurable. Please remove it from ${configFileName}.`,\n-    silent\n-  )\n-\n-  warnOptionHasBeenDeprecated(\n-    result,\n-    'devIndicators.buildActivity',\n-    `\\`devIndicators.buildActivity\\` is deprecated and no longer configurable. Please remove it from ${configFileName}.`,\n-    silent\n-  )\n-\n-  const hasWarnedBuildActivityPosition = warnOptionHasBeenDeprecated(\n-    result,\n-    'devIndicators.buildActivityPosition',\n-    `\\`devIndicators.buildActivityPosition\\` has been renamed to \\`devIndicators.position\\`. Please update your ${configFileName} file accordingly.`,\n-    silent\n-  )\n+  // Handle buildActivityPosition migration (needs to be done after merging with defaults)\n   if (\n-    hasWarnedBuildActivityPosition &&\n     result.devIndicators !== false &&\n     'buildActivityPosition' in result.devIndicators &&\n     result.devIndicators.buildActivityPosition !== result.devIndicators.position\n   ) {\n-    Log.warnOnce(\n-      `The \\`devIndicators\\` option \\`buildActivityPosition\\` (\"${result.devIndicators.buildActivityPosition}\") conflicts with \\`position\\` (\"${result.devIndicators.position}\"). Using \\`buildActivityPosition\\` (\"${result.devIndicators.buildActivityPosition}\") for backward compatibility.`\n-    )\n+    if (!silent) {\n+      Log.warnOnce(\n+        `The \\`devIndicators\\` option \\`buildActivityPosition\\` (\"${result.devIndicators.buildActivityPosition}\") conflicts with \\`position\\` (\"${result.devIndicators.position}\"). Using \\`buildActivityPosition\\` (\"${result.devIndicators.buildActivityPosition}\") for backward compatibility.`\n+      )\n+    }\n     result.devIndicators.position = result.devIndicators.buildActivityPosition\n   }\n \n@@ -743,17 +762,6 @@ function assignDefaults(\n   setHttpClientAndAgentOptions(result || defaultConfig)\n \n   if (result.i18n) {\n-    const hasAppDir = Boolean(findDir(dir, 'app'))\n-\n-    if (hasAppDir) {\n-      warnOptionHasBeenDeprecated(\n-        result,\n-        'i18n',\n-        `i18n configuration in ${configFileName} is unsupported in App Router.\\nLearn more about internationalization in App Router: https://nextjs.org/docs/app/building-your-application/routing/internationalization`,\n-        silent\n-      )\n-    }\n-\n     const { i18n } = result\n     const i18nType = typeof i18n\n \n@@ -1290,6 +1298,9 @@ export default async function loadConfig(\n   const configuredExperimentalFeatures: ConfiguredExperimentalFeature[] = []\n \n   if (customConfig) {\n+    // Check deprecation warnings on the custom config before merging with defaults\n+    checkDeprecations(customConfig as NextConfig, configFileName, silent, dir)\n+\n     const config = await applyModifyConfig(\n       assignDefaults(\n         dir,\n@@ -1401,6 +1412,9 @@ export default async function loadConfig(\n     // Clone a new userConfig each time to avoid mutating the original\n     const userConfig = cloneObject(loadedConfig) as NextConfig\n \n+    // Check deprecation warnings on the actual user config before merging with defaults\n+    checkDeprecations(userConfig, configFileName, silent, dir)\n+\n     // Always validate the config against schema in non minimal mode.\n     // Only validate once in the root Next.js process, not in forked processes.\n     const isRootProcess = typeof process.send !== 'function'"
        },
        {
            "sha": "e120740e59398e4527036f2203e20f229946efa5",
            "filename": "test/e2e/deprecation-warnings/deprecation-warnings.test.ts",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,40 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+\n+describe('deprecation-warnings', () => {\n+  describe('without next.config.js', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'fixtures/no-config'),\n+      skipStart: true,\n+    })\n+\n+    it('should not emit any deprecation warnings when no config file exists', async () => {\n+      await next.start()\n+\n+      const logs = next.cliOutput\n+      expect(logs).not.toContain('deprecated')\n+      expect(logs).not.toContain('has been renamed')\n+      expect(logs).not.toContain('no longer needed')\n+    })\n+  })\n+\n+  describe('with deprecated config options', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'fixtures/with-deprecated-config'),\n+      skipStart: true,\n+    })\n+\n+    it('should emit deprecation warnings for explicitly configured deprecated options', async () => {\n+      await next.start()\n+\n+      const logs = next.cliOutput\n+\n+      // Should warn about amp configuration\n+      expect(logs).toContain('Built-in amp support is deprecated')\n+\n+      // Should warn about experimental.instrumentationHook\n+      expect(logs).toContain('experimental.instrumentationHook')\n+      expect(logs).toContain('no longer needed')\n+    })\n+  })\n+})"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/deprecation-warnings/fixtures/no-config/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Flayout.tsx?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0bd21c5bac776b2207e1e01878c12fde935a2dde",
            "filename": "test/e2e/deprecation-warnings/fixtures/no-config/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fno-config%2Fapp%2Fpage.tsx?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello World</div>\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/deprecation-warnings/fixtures/with-deprecated-config/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Flayout.tsx?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0bd21c5bac776b2207e1e01878c12fde935a2dde",
            "filename": "test/e2e/deprecation-warnings/fixtures/with-deprecated-config/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fapp%2Fpage.tsx?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello World</div>\n+}"
        },
        {
            "sha": "d8d7c62c769add5fef3e67097fee0dc70623777a",
            "filename": "test/e2e/deprecation-warnings/fixtures/with-deprecated-config/next.config.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8890a5edaa46143500ec0386795a1570d57c11f6/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Ffixtures%2Fwith-deprecated-config%2Fnext.config.js?ref=8890a5edaa46143500ec0386795a1570d57c11f6",
            "patch": "@@ -0,0 +1,9 @@\n+module.exports = {\n+  // Explicitly configure deprecated options\n+  amp: {\n+    canonicalBase: 'https://example.com',\n+  },\n+  experimental: {\n+    instrumentationHook: true,\n+  },\n+}"
        }
    ],
    "stats": {
        "total": 245,
        "additions": 168,
        "deletions": 77
    }
}