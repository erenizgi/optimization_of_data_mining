{
    "author": "wyattjoh",
    "message": "Fix parallel routes ignoring generateStaticParams from primary route (#84889)\n\n### What?\n\nFixes a bug where `generateStaticParams` from the primary route was\nbeing ignored when dynamic segments existed in both regular routes\n(`children`) and parallel routes (e.g., `@breadcrumbs`), causing routes\nthat should have been statically generated to return 404 errors.\n\nAlso fixes a related redirect loop issue that occurred when serving 404\npages with RSC request header validation enabled.\n\n### Why?\n\n**Primary Issue: Segment Deduplication**\n\nThe `collectAppPageSegments` function had two code paths for\ndeduplicating segments when the same dynamic parameter (like `[slug]`)\nappeared in both the primary route tree and parallel routes:\n\n1. **Individual segment processing** - Correctly preferred non-parallel\nsegments\n2. **Batch processing at page boundaries** - Blindly overwrote existing\nsegments without preference checking\n\nDue to BFS traversal order, parallel route segments would overwrite the\ncorrect `children` route segments during batch processing. This marked\nparameters as `isParallelRouteSegment: true`, which:\n- Prevented the build system from recognizing them as regular route\nparameters\n- Caused `generateStaticParams` to be ignored during prerendering\n- Resulted in all routes being treated as dynamic-only (404s with\n`dynamicParams = false`)\n\nThis violated the architectural invariant that parallel routes are\n\"secondary\" to the main route hierarchy - the primary route tree should\ndetermine URL structure and static generation behavior.\n\n**Secondary Issue: 404 Page Redirect Loop**\n\nWhen serving a 404 page (NoFallbackError), the experimental RSC request\nheader validation would cause an infinite redirect loop. This happened\nbecause:\n- Headers are already stripped when serving the 404 page\n- The validation comparison would always fail\n- This triggered a redirect, which would hit the same 404, creating a\nloop\n\n### How?\n\n**Segment Preference Fix (`app-segments.ts`):**\n\nApplied consistent segment preference logic to both deduplication code\npaths in `collectAppPageSegments` and `collectFallbackRouteParams`,\nensuring segments from the `children` route are always preferred over\nparallel route segments. This preserves the following guarantees:\n\n1. **URL structure is determined by the primary route tree** - Parallel\nroutes derive their parameters from `children`, not vice versa\n2. **`generateStaticParams` works correctly** - Static generation is\ncontrolled by the primary route's configuration\n3. **Parallel routes remain decorative** - They enhance the page without\naffecting core routing behavior\n\n**Redirect Loop Fix (`base-server.ts`):**\n\nSkip RSC request header validation when serving 404 pages (`!is404Page`\ncondition), preventing the redirect loop caused by already-stripped\nheaders failing the validation check.\n\n**Test Coverage:**\n\nAdded comprehensive e2e test suite covering:\n- Root parameters with `generateStaticParams` and `dynamicParams =\nfalse`\n- Dynamic child routes with and without `generateStaticParams`\n- Parallel route slots with shared dynamic segments\n- Prefetch behavior to ensure no redirect loops during preloading\n\nFixes #\n\nNAR-446",
    "sha": "43c6ccfdd5e804b6e85b307101b50af689c60b59",
    "files": [
        {
            "sha": "35c859e9db6f9de3aef126cddf28f76732d6d17d",
            "filename": "packages/next/src/build/segment-config/app/app-segments.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -128,10 +128,12 @@ async function collectAppPageSegments(routeModule: AppPageRouteModule) {\n \n     // If this is a page segment, we've reached a leaf node\n     if (name === PAGE_SEGMENT_KEY) {\n-      // Add all segments in the current path\n+      // Add all segments in the current path, preferring non-parallel segments\n       updatedSegments.forEach((seg) => {\n         const key = getSegmentKey(seg)\n-        uniqueSegments.set(key, seg)\n+        if (!uniqueSegments.has(key)) {\n+          uniqueSegments.set(key, seg)\n+        }\n       })\n     }\n \n@@ -152,7 +154,7 @@ async function collectAppPageSegments(routeModule: AppPageRouteModule) {\n }\n \n function getSegmentKey(segment: AppSegment) {\n-  return `${segment.name}-${segment.filePath ?? ''}-${segment.paramName ?? ''}`\n+  return `${segment.name}-${segment.filePath ?? ''}-${segment.paramName ?? ''}-${segment.isParallelRouteSegment ? 'pr' : 'np'}`\n }\n \n /**\n@@ -244,7 +246,7 @@ export function collectFallbackRouteParams(\n     // Handle this segment (if it's a dynamic segment param).\n     const segmentParam = getSegmentParam(name)\n     if (segmentParam) {\n-      const key = `${name}-${segmentParam.param}`\n+      const key = `${name}-${segmentParam.param}-${isParallelRouteSegment ? 'pr' : 'np'}`\n       if (!uniqueSegments.has(key)) {\n         uniqueSegments.set(\n           key,"
        },
        {
            "sha": "4b947dd57e20bc3562c90d750eef83c69bc403de",
            "filename": "packages/next/src/build/static-paths/app.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -793,12 +793,29 @@ export async function buildAppStaticPaths({\n   // we're emitting the route for the base route.\n   const parallelFallbackRouteParams: FallbackRouteParam[] = []\n \n+  // First pass: collect all non-parallel route param names.\n+  // This allows us to filter out parallel route params that duplicate non-parallel ones.\n+  const nonParallelParamNames = new Set<string>()\n+  for (const segment of segments) {\n+    if (!segment.paramName || !segment.paramType) continue\n+    if (!segment.isParallelRouteSegment) {\n+      nonParallelParamNames.add(segment.paramName)\n+    }\n+  }\n+\n+  // Second pass: collect segments, ensuring non-parallel route params take precedence.\n   for (const segment of segments) {\n     // If this segment doesn't have a param name then it's not param that we\n     // need to resolve.\n     if (!segment.paramName || !segment.paramType) continue\n \n     if (segment.isParallelRouteSegment) {\n+      // Skip parallel route params that are already defined as non-parallel route params.\n+      // Non-parallel route params take precedence because they appear in the URL pathname.\n+      if (nonParallelParamNames.has(segment.paramName)) {\n+        continue\n+      }\n+\n       // Collect all the parallel route segments that have dynamic params for\n       // second-pass resolution.\n       parallelRouteSegments.push({"
        },
        {
            "sha": "44636a868fe9d6dc7537dd8b2acae959cda18422",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -2015,7 +2015,11 @@ export default abstract class Server<\n     if (\n       !this.minimalMode &&\n       this.nextConfig.experimental.validateRSCRequestHeaders &&\n-      isRSCRequest\n+      isRSCRequest &&\n+      // In the event that we're serving a NoFallbackError, the headers will\n+      // already be stripped so this comparison will always fail, resulting in\n+      // a redirect loop.\n+      !is404Page\n     ) {\n       const headers = req.headers\n "
        },
        {
            "sha": "1c53b2beb9132e965752a612b8d655c6da880a43",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/gsp/@breadcrumbs/default.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fdefault.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fdefault.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,3 @@\n+export default function BreadcrumbsDefault() {\n+  return <div id=\"breadcrumbs-default\">Breadcrumbs: (default)</div>\n+}"
        },
        {
            "sha": "6eb82aaedd8195e1eeaaab74e869b40b3828a1a5",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/gsp/@breadcrumbs/stories/[slug]/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function BreadcrumbsStoryPage({\n+  params,\n+}: {\n+  params: Promise<{ locale: string; slug: string }>\n+}) {\n+  const { locale, slug } = await params\n+  return (\n+    <div id=\"breadcrumbs-story\">\n+      <div id=\"breadcrumbs-locale\">Breadcrumbs Locale: {locale}</div>\n+      <div id=\"breadcrumbs-slug\">Breadcrumbs Story: {slug}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "666e695a94f4f9078daea91911b624c73634a9b3",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/gsp/layout.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Flayout.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,17 @@\n+import type { ReactNode } from 'react'\n+\n+export default function RootLayout({\n+  children,\n+  breadcrumbs,\n+}: {\n+  children: ReactNode\n+  breadcrumbs: ReactNode\n+  params: Promise<{ locale: string }>\n+}) {\n+  return (\n+    <>\n+      <div id=\"breadcrumbs\">{breadcrumbs}</div>\n+      <main id=\"main\">{children}</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "94e6b32fbe668dff5eb454a31eb1ccfc30c48e9a",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/gsp/stories/[slug]/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fgsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,17 @@\n+export default async function StoryPage({\n+  params,\n+}: {\n+  params: Promise<{ locale: string; slug: string }>\n+}) {\n+  const { locale, slug } = await params\n+  return (\n+    <div id=\"story-page\">\n+      <div id=\"story-locale\">Locale: {locale}</div>\n+      <div id=\"story-slug\">Story: {slug}</div>\n+    </div>\n+  )\n+}\n+\n+export async function generateStaticParams() {\n+  return [{ slug: 'static-123' }]\n+}"
        },
        {
            "sha": "8cc2ecec2dda4ee5f418103a668868d70c213ddd",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/layout.client.tsx",
            "status": "added",
            "additions": 143,
            "deletions": 0,
            "changes": 143,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.client.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,143 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+type RouteInfo = {\n+  href: string\n+  status: '200' | '404'\n+}\n+\n+type RouteSection = {\n+  title: string\n+  columns: string[]\n+  routes: RouteInfo[]\n+}\n+\n+const ROUTE_SECTIONS: RouteSection[] = [\n+  {\n+    title: 'Base Routes',\n+    columns: ['Route', 'Expected Status'],\n+    routes: [\n+      { href: '/en', status: '200' },\n+      { href: '/fr', status: '200' },\n+      { href: '/es', status: '404' },\n+    ],\n+  },\n+  {\n+    title: 'Without generateStaticParams',\n+    columns: ['Route', 'Expected Status'],\n+    routes: [\n+      { href: '/en/no-gsp/stories/dynamic-123', status: '200' },\n+      { href: '/fr/no-gsp/stories/dynamic-123', status: '200' },\n+      { href: '/es/no-gsp/stories/dynamic-123', status: '200' },\n+    ],\n+  },\n+  {\n+    title: 'With generateStaticParams',\n+    columns: ['Route', 'Expected Status'],\n+    routes: [\n+      {\n+        href: '/en/gsp/stories/static-123',\n+        status: '200',\n+      },\n+      {\n+        href: '/fr/gsp/stories/static-123',\n+        status: '200',\n+      },\n+      {\n+        href: '/es/gsp/stories/static-123',\n+        status: '404',\n+      },\n+      {\n+        href: '/en/gsp/stories/dynamic-123',\n+        status: '404',\n+      },\n+      {\n+        href: '/fr/gsp/stories/dynamic-123',\n+        status: '404',\n+      },\n+      {\n+        href: '/es/gsp/stories/dynamic-123',\n+        status: '404',\n+      },\n+    ],\n+  },\n+]\n+\n+function NavLink({ href, status }: { href: string; status: '200' | '404' }) {\n+  return (\n+    <Link\n+      href={href}\n+      className={`font-mono text-xs hover:underline ${status === '200' ? 'text-green-700' : 'text-red-700'}`}\n+    >\n+      {href}\n+    </Link>\n+  )\n+}\n+\n+function StatusBadge({ status }: { status: '200' | '404' }) {\n+  return (\n+    <span\n+      className={`inline-block px-1 py-0 rounded text-xs ${status === '200' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}\n+    >\n+      {status}\n+    </span>\n+  )\n+}\n+\n+function RouteTable({ section }: { section: RouteSection }) {\n+  return (\n+    <div>\n+      <h2 className=\"text-sm font-bold mb-1\">{section.title}</h2>\n+      <table className=\"w-full border-collapse border border-gray-300 text-xs\">\n+        <thead>\n+          <tr className=\"bg-gray-100\">\n+            {section.columns.map((column) => (\n+              <th\n+                key={column}\n+                className=\"border border-gray-300 px-2 py-0.5 text-left w-1/2\"\n+              >\n+                {column}\n+              </th>\n+            ))}\n+          </tr>\n+        </thead>\n+        <tbody>\n+          {section.routes.map((route) => (\n+            <tr key={route.href}>\n+              <td className=\"border border-gray-300 px-2 py-0.5\">\n+                <NavLink href={route.href} status={route.status} />\n+              </td>\n+              <td className=\"border border-gray-300 px-2 py-0.5\">\n+                <StatusBadge status={route.status} />\n+              </td>\n+            </tr>\n+          ))}\n+        </tbody>\n+      </table>\n+    </div>\n+  )\n+}\n+\n+export default function Navigation() {\n+  const [revealed, setRevealed] = useState(false)\n+\n+  return (\n+    <>\n+      <input\n+        id=\"reveal\"\n+        type=\"checkbox\"\n+        checked={revealed}\n+        onChange={() => setRevealed(!revealed)}\n+      />\n+      {revealed && (\n+        <nav id=\"nav\" className=\"space-y-2\">\n+          {ROUTE_SECTIONS.map((section) => (\n+            <RouteTable key={section.title} section={section} />\n+          ))}\n+        </nav>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "4b4e91c26cdf8d5d95dae0f46faa7807dfdc671b",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/layout.tsx",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Flayout.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,27 @@\n+import type { ReactNode } from 'react'\n+import Navigation from './layout.client'\n+\n+export function generateStaticParams() {\n+  return [{ locale: 'en' }, { locale: 'fr' }]\n+}\n+\n+export const dynamicParams = false\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: ReactNode\n+  params: Promise<{ locale: string }>\n+}) {\n+  return (\n+    <html>\n+      <head>\n+        <script src=\"https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4\"></script>\n+      </head>\n+      <body className=\"p-2 flex flex-col gap-2 text-sm\">\n+        <Navigation />\n+        {children}\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "1c53b2beb9132e965752a612b8d655c6da880a43",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/no-gsp/@breadcrumbs/default.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fdefault.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fdefault.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,3 @@\n+export default function BreadcrumbsDefault() {\n+  return <div id=\"breadcrumbs-default\">Breadcrumbs: (default)</div>\n+}"
        },
        {
            "sha": "6eb82aaedd8195e1eeaaab74e869b40b3828a1a5",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/no-gsp/@breadcrumbs/stories/[slug]/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2F%40breadcrumbs%2Fstories%2F%5Bslug%5D%2Fpage.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function BreadcrumbsStoryPage({\n+  params,\n+}: {\n+  params: Promise<{ locale: string; slug: string }>\n+}) {\n+  const { locale, slug } = await params\n+  return (\n+    <div id=\"breadcrumbs-story\">\n+      <div id=\"breadcrumbs-locale\">Breadcrumbs Locale: {locale}</div>\n+      <div id=\"breadcrumbs-slug\">Breadcrumbs Story: {slug}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "666e695a94f4f9078daea91911b624c73634a9b3",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/no-gsp/layout.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Flayout.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,17 @@\n+import type { ReactNode } from 'react'\n+\n+export default function RootLayout({\n+  children,\n+  breadcrumbs,\n+}: {\n+  children: ReactNode\n+  breadcrumbs: ReactNode\n+  params: Promise<{ locale: string }>\n+}) {\n+  return (\n+    <>\n+      <div id=\"breadcrumbs\">{breadcrumbs}</div>\n+      <main id=\"main\">{children}</main>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "0d5ab5ba5d4291ec567a2143c2dca4c95b36cbca",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/no-gsp/stories/[slug]/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fno-gsp%2Fstories%2F%5Bslug%5D%2Fpage.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function StoryPage({\n+  params,\n+}: {\n+  params: Promise<{ locale: string; slug: string }>\n+}) {\n+  const { locale, slug } = await params\n+  return (\n+    <div id=\"story-page\">\n+      <div id=\"story-locale\">Locale: {locale}</div>\n+      <div id=\"story-slug\">Story: {slug}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "00d399ab9436cbe5d4f856319a211121a19634ae",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/app/[locale]/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fapp%2F%5Blocale%5D%2Fpage.tsx?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,8 @@\n+export default async function LocalePage({\n+  params,\n+}: {\n+  params: Promise<{ locale: string }>\n+}) {\n+  const { locale } = await params\n+  return <div id=\"locale-page\">Locale: {locale}</div>\n+}"
        },
        {
            "sha": "c74a963787459055c34eeef8e61f1f3e4181e4fd",
            "filename": "test/e2e/app-dir/parallel-routes-root-param-dynamic-child/parallel-routes-root-param-dynamic-child.test.ts",
            "status": "added",
            "additions": 172,
            "deletions": 0,
            "changes": 172,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fparallel-routes-root-param-dynamic-child.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fparallel-routes-root-param-dynamic-child.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-root-param-dynamic-child%2Fparallel-routes-root-param-dynamic-child.test.ts?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -0,0 +1,172 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { createRouterAct } from 'router-act'\n+import { setTimeout } from 'node:timers/promises'\n+\n+describe('parallel-routes-root-param-dynamic-child', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  async function createBrowserActor(url: string, errorPage: boolean = false) {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser(url, {\n+      beforePageLoad(page) {\n+        act = createRouterAct(page, { allowErrorStatusCodes: [404] })\n+      },\n+      // throttling the CPU to rule out flakiness based on how quickly the page loads\n+      cpuThrottleRate: 6,\n+    })\n+\n+    // If we're on the error page, we don't have a nav element to wait for.\n+    if (errorPage) {\n+      return { act, browser }\n+    }\n+\n+    // The page has navigation links that will be automatically prefetched.\n+    // Some routes will 404 (like /es which isn't in generateStaticParams),\n+    // so we allow 404 status codes. Let's reveal the navigation links and let\n+    // the prefetching occur.\n+    await act(\n+      async () => {\n+        await browser.elementByCss('#reveal').click()\n+\n+        // Ensure the navigation is visible\n+        await browser.elementByCss('#nav')\n+\n+        // Wait for 500ms to ensure all links are visible\n+        await setTimeout(500)\n+\n+        // Scroll to bottom to ensure all links enter viewport and trigger prefetches\n+        await browser.eval('window.scrollTo(0, document.body.scrollHeight)')\n+\n+        // Wait for 500ms to ensure all links are visible\n+        await setTimeout(500)\n+      },\n+      // If we're in development, we don't have any prefetching to wait for.\n+      isNextDev ? 'no-requests' : undefined\n+    )\n+\n+    return { act, browser }\n+  }\n+\n+  if (!isNextDev) {\n+    describe('Prefetching', () => {\n+      it('prefetches the 404 pages correctly', async () => {\n+        await createBrowserActor('/en')\n+\n+        // If we got here without errors, the prefetch responses completed successfully\n+        // without problematic redirects (like 307). Those will throw because\n+        // it'll hit the net::ERR_TOO_MANY_REDIRECTS error.\n+      })\n+    })\n+  }\n+\n+  describe('Base Routes', () => {\n+    it.each(['en', 'fr'])(\n+      'should render a 200 for /%s (in generateStaticParams)',\n+      async (locale) => {\n+        const { browser } = await createBrowserActor(`/${locale}`)\n+\n+        expect(await browser.elementByCss('#locale-page').text()).toBe(\n+          `Locale: ${locale}`\n+        )\n+      }\n+    )\n+\n+    it('should render a 404 for /es (not in generateStaticParams)', async () => {\n+      const { browser } = await createBrowserActor('/es', true)\n+\n+      expect(await browser.elementByCss('.next-error-h1').text()).toBe('404')\n+    })\n+  })\n+\n+  describe('Without generateStaticParams (no-gsp)', () => {\n+    it.each(['en', 'fr', 'es'])(\n+      'should render a 200 for /%s/no-gsp/stories/dynamic-123',\n+      async (locale) => {\n+        const { browser, act } = await createBrowserActor('/en')\n+\n+        await act(async () => {\n+          await browser\n+            .elementByCss(`[href=\"/${locale}/no-gsp/stories/dynamic-123\"]`)\n+            .click()\n+        })\n+\n+        expect(await browser.elementByCss('#story-locale').text()).toBe(\n+          `Locale: ${locale}`\n+        )\n+        expect(await browser.elementByCss('#story-slug').text()).toBe(\n+          'Story: dynamic-123'\n+        )\n+      }\n+    )\n+\n+    it('should allow dynamic params even with /es locale', async () => {\n+      // Even though /es is not in the root generateStaticParams,\n+      // no-gsp routes should still work because they don't enforce static params\n+      const { browser } = await createBrowserActor(\n+        '/es/no-gsp/stories/dynamic-123'\n+      )\n+\n+      expect(await browser.elementByCss('#story-locale').text()).toBe(\n+        'Locale: es'\n+      )\n+      expect(await browser.elementByCss('#story-slug').text()).toBe(\n+        'Story: dynamic-123'\n+      )\n+    })\n+  })\n+\n+  describe('With generateStaticParams (gsp)', () => {\n+    describe('Static params (static-123)', () => {\n+      it.each(['en', 'fr'])(\n+        'should render a 200 for /%s/gsp/stories/static-123',\n+        async (locale) => {\n+          const { browser, act } = await createBrowserActor(`/${locale}`)\n+\n+          await act(async () => {\n+            await browser\n+              .elementByCss(`[href=\"/${locale}/gsp/stories/static-123\"]`)\n+              .click()\n+          })\n+\n+          expect(await browser.elementByCss('#story-locale').text()).toBe(\n+            `Locale: ${locale}`\n+          )\n+          expect(await browser.elementByCss('#story-slug').text()).toBe(\n+            'Story: static-123'\n+          )\n+        }\n+      )\n+\n+      it('should render a 404 for /es/gsp/stories/static-123 (locale not in generateStaticParams)', async () => {\n+        const response = await next.fetch('/es/gsp/stories/static-123')\n+        expect(response.status).toBe(404)\n+      })\n+    })\n+\n+    describe('Dynamic params (dynamic-123)', () => {\n+      it.each(['en', 'fr'])(\n+        'should render a 404 for /%s/gsp/stories/dynamic-123 (slug not in generateStaticParams)',\n+        async (locale) => {\n+          const { browser, act } = await createBrowserActor(`/${locale}`)\n+\n+          await act(async () => {\n+            await browser\n+              .elementByCss(`[href=\"/${locale}/gsp/stories/dynamic-123\"]`)\n+              .click()\n+          })\n+\n+          expect(await browser.elementByCss('.next-error-h1').text()).toBe(\n+            '404'\n+          )\n+        }\n+      )\n+\n+      it('should render a 404 for /es/gsp/stories/dynamic-123 (both locale and slug not allowed)', async () => {\n+        const response = await next.fetch('/es/gsp/stories/dynamic-123')\n+        expect(response.status).toBe(404)\n+      })\n+    })\n+  })\n+})"
        },
        {
            "sha": "c4699956df28210684fd34d53e994a20b1c54626",
            "filename": "test/experimental-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fexperimental-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Fexperimental-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fexperimental-tests-manifest.json?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -361,7 +361,8 @@\n       \"test/production/app-dir/unexpected-error/unexpected-error.test.ts\",\n       \"test/production/app-dir/worker-restart/worker-restart.test.ts\",\n       \"test/production/app-dir/resume-data-cache/resume-data-cache.test.ts\",\n-      \"test/production/app-dir/unstable-cache-foreground-revalidate/unstable-cache-foreground-revalidate.test.ts\"\n+      \"test/production/app-dir/unstable-cache-foreground-revalidate/unstable-cache-foreground-revalidate.test.ts\",\n+      \"test/e2e/app-dir/parallel-routes-root-param-dynamic-child/parallel-routes-root-param-dynamic-child.test.ts\"\n     ]\n   }\n }"
        },
        {
            "sha": "a905fe05c58e42f3e36ce019da8c1026d9084cfb",
            "filename": "test/lib/router-act.ts",
            "status": "modified",
            "additions": 69,
            "deletions": 14,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Flib%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/43c6ccfdd5e804b6e85b307101b50af689c60b59/test%2Flib%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Frouter-act.ts?ref=43c6ccfdd5e804b6e85b307101b50af689c60b59",
            "patch": "@@ -57,8 +57,45 @@ type ActConfig =\n   | null\n \n export function createRouterAct(\n-  page: Playwright.Page\n+  page: Playwright.Page,\n+  options?: {\n+    /**\n+     * Status codes that are allowed to be returned by the server. If not\n+     * provided, all error status codes are disallowed (400+).\n+     */\n+    allowErrorStatusCodes?: number[]\n+  }\n ): <T>(scope: () => Promise<T> | T, config?: ActConfig) => Promise<T> {\n+  /**\n+   * Helper function to wait for requestIdleCallback with retry logic.\n+   * Retries up to 3 times if \"Execution context was destroyed\" error occurs.\n+   */\n+  async function waitForIdleCallback(): Promise<void> {\n+    const maxRetries = 3\n+    const retryDelayMs = 100\n+\n+    for (let attempt = 0; attempt < maxRetries; attempt++) {\n+      try {\n+        await page.evaluate(\n+          () => new Promise<void>((res) => requestIdleCallback(() => res()))\n+        )\n+        return\n+      } catch (err) {\n+        const isLastAttempt = attempt === maxRetries - 1\n+        const isExecutionContextError =\n+          err instanceof Error &&\n+          err.message.includes('Execution context was destroyed')\n+\n+        if (isExecutionContextError && !isLastAttempt) {\n+          await new Promise((resolve) => setTimeout(resolve, retryDelayMs))\n+          continue\n+        }\n+\n+        throw err\n+      }\n+    }\n+  }\n+\n   /**\n    * Test utility for requests initiated by the Next.js Router, such as\n    * prefetches and navigations. Calls the given async function then intercepts\n@@ -79,6 +116,8 @@ export function createRouterAct(\n     let expectedResponses: Array<ExpectedResponseConfig> | null\n     let forbiddenResponses: Array<ExpectedResponseConfig> | null = null\n     let shouldBlockAll = false\n+    const allowStatuses = options?.allowErrorStatusCodes ?? null\n+\n     if (config === undefined || config === null) {\n       // Default. Expect at least one request, but don't assert on the response.\n       expectedResponses = []\n@@ -230,7 +269,7 @@ export function createRouterAct(\n     }\n     currentBatch = batch\n     await page.route('**/*', routeHandler)\n-    await page.on('framedetached', hardNavigationHandler)\n+    page.on('framedetached', hardNavigationHandler)\n     try {\n       // Call the user-provided scope function\n       const returnValue = await scope()\n@@ -258,9 +297,7 @@ export function createRouterAct(\n       // We use requestIdleCallback to schedule the task because that's\n       // guaranteed to fire after any IntersectionObserver events, which the\n       // router uses to track the visibility of links.\n-      await page.evaluate(\n-        () => new Promise<void>((res) => requestIdleCallback(() => res()))\n-      )\n+      await waitForIdleCallback()\n \n       // Checking whether a request needs to be intercepted is an async\n       // operation, so we need to wait for all the checks to complete before\n@@ -298,7 +335,11 @@ ${fulfilled.body}\n \n               throw error\n             }\n-            if (fulfilled.status >= 400) {\n+            if (\n+              fulfilled.status >= 400 &&\n+              (allowStatuses === null ||\n+                !allowStatuses.includes(fulfilled.status))\n+            ) {\n               error.message = `\n Received a response with an error status code.\n \n@@ -400,7 +441,11 @@ ${fulfilled.body}\n               })\n               const browserResponse = await request.response()\n               if (browserResponse !== null) {\n-                await browserResponse.finished()\n+                // For error responses (>= 400), the browser may not consume the body\n+                // in the same way, so we skip waiting for finished() to avoid hanging\n+                if (fulfilled.status < 400) {\n+                  await browserResponse.finished()\n+                }\n               }\n             }\n           }\n@@ -417,7 +462,7 @@ ${fulfilled.body}\n             // a strategy to make that work. In the meantime, attempting to\n             // write a test that blocks a redirect will result in an error\n             // (see error above).\n-            await new Promise<void>((resolve) => {\n+            await new Promise<void>((resolve, reject) => {\n               page.once('request', (req) => {\n                 const handleResponse = (res: Playwright.Response) => {\n                   if (res.url() === req.url()) {\n@@ -426,19 +471,31 @@ ${fulfilled.body}\n                       route: null,\n                       result: (async () => {\n                         return {\n-                          text: await res.text(),\n-                          body: await res.body(),\n+                          // For redirects, body may not be available, so catch\n+                          // the error and return an empty string.\n+                          text: await res.text().catch(() => ''),\n+                          body: await res.body().catch(() => Buffer.from('')),\n                           headers: res.headers(),\n                           status: res.status(),\n                         }\n                       })(),\n                       didProcess: false,\n                     })\n                     page.off('response', handleResponse)\n+                    page.off('requestfailed', handleFailure)\n                     resolve()\n                   }\n                 }\n+                const handleFailure = (failedReq: Playwright.Request) => {\n+                  if (failedReq.url() === req.url()) {\n+                    page.off('response', handleResponse)\n+                    page.off('requestfailed', handleFailure)\n+                    error.message = `Request failed: ${failedReq.failure()?.errorText || 'Unknown error'}\\n\\nURL: ${req.url()}`\n+                    reject(error)\n+                  }\n+                }\n                 page.on('response', handleResponse)\n+                page.on('requestfailed', handleFailure)\n               })\n             })\n           }\n@@ -450,9 +507,7 @@ ${fulfilled.body}\n         // network throttled, the next request is issued either directly within\n         // the task of the previous request's completion event, or in the\n         // microtask queue of that event.\n-        await page.evaluate(\n-          () => new Promise<void>((res) => requestIdleCallback(() => res()))\n-        )\n+        await waitForIdleCallback()\n \n         await waitForPendingRequestChecks()\n       }\n@@ -503,7 +558,7 @@ ${fulfilled.body}\n       // Clean up\n       currentBatch = prevBatch\n       await page.unroute('**/*', routeHandler)\n-      await page.off('framedetached', hardNavigationHandler)\n+      page.off('framedetached', hardNavigationHandler)\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 565,
        "additions": 545,
        "deletions": 20
    }
}