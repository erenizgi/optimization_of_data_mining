{
    "author": "ztanner",
    "message": "bugfix: propagate staleTime to seeded prefetch entry (#81263)\n\nIn #71280, we hooked up the server-side `staleTime` header to the\nclient-side prefetch cache. This means that if the server responds with\na staleTime value, the client router will use that rather than the\nprevious heuristic when determining if a prefetch entry can be reused.\n\nHowever, there was missing functionality to set a proper staleTime value\nfor the initially seeded prefetch entry (aka the first page visit). In\nthe case of customizing staleTimes, this meant that navigations back to\nthe original page would defer back to the old stale heuristic, which\nwould differ from subsequent navigations that were properly seeded with\na staleTime.\n\nSeparately, I believe that it's problematic that if the `staleTime`\nheader is present, that we honor that and only set a fresh/stale cache\nstatus, because the newer heuristic doesn't consider the `reusable`\ncache status. This should probably be flagged to the clientSegmentCache\nflag. However, to minimize the changes here, I've only addressed this\nparticular case.",
    "sha": "45a5405de21fe158e93aec6441e3ed70399323dd",
    "files": [
        {
            "sha": "341538860cb14aa33e49dccaa2c4c061bb963c81",
            "filename": "packages/next/src/client/components/router-reducer/create-initial-router-state.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/45a5405de21fe158e93aec6441e3ed70399323dd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45a5405de21fe158e93aec6441e3ed70399323dd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts?ref=45a5405de21fe158e93aec6441e3ed70399323dd",
            "patch": "@@ -4,7 +4,10 @@ import type { FlightDataPath } from '../../../server/app-render/types'\n import { createHrefFromUrl } from './create-href-from-url'\n import { fillLazyItemsTillLeafWithHead } from './fill-lazy-items-till-leaf-with-head'\n import { extractPathFromFlightRouterState } from './compute-changed-path'\n-import { createSeededPrefetchCacheEntry } from './prefetch-cache-utils'\n+import {\n+  createSeededPrefetchCacheEntry,\n+  STATIC_STALETIME_MS,\n+} from './prefetch-cache-utils'\n import { PrefetchKind, type PrefetchCacheEntry } from './router-reducer-types'\n import { addRefreshMarkerToActiveParallelSegments } from './refetch-inactive-parallel-segments'\n import { getFlightDataPartsFromPath } from '../../flight-data-helpers'\n@@ -132,7 +135,13 @@ export function createInitialRouterState({\n         // add a way to split a single Flight stream into static and dynamic\n         // parts. But in the meantime we should at least make this work for\n         // fully static pages.\n-        staleTime: -1,\n+        staleTime:\n+          // In the old router, there was only a single configurable staleTime (experimental.staleTimes)\n+          // As an abundance of caution, this will only set the initial staleTime to the configured value\n+          // if we're not leveraging the segment cache, which has its own prefetching semantics.\n+          prerendered && !process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+            ? STATIC_STALETIME_MS\n+            : -1,\n       },\n       tree: initialState.tree,\n       prefetchCache: initialState.prefetchCache,"
        },
        {
            "sha": "73da5363904e74864fe159b7eaf3066cd8484a92",
            "filename": "packages/next/src/client/components/router-reducer/prefetch-cache-utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/45a5405de21fe158e93aec6441e3ed70399323dd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45a5405de21fe158e93aec6441e3ed70399323dd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fprefetch-cache-utils.ts?ref=45a5405de21fe158e93aec6441e3ed70399323dd",
            "patch": "@@ -291,7 +291,7 @@ export function createSeededPrefetchCacheEntry({\n     kind,\n     prefetchTime: Date.now(),\n     lastUsedTime: Date.now(),\n-    staleTime: -1,\n+    staleTime: data.staleTime,\n     key: prefetchCacheKey,\n     status: PrefetchCacheEntryStatus.fresh,\n     url,"
        },
        {
            "sha": "d6c1282992389b39f09bd78952820d60f82effa8",
            "filename": "test/e2e/app-dir/app-prefetch/app/page.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fpage.js?ref=45a5405de21fe158e93aec6441e3ed70399323dd",
            "patch": "@@ -8,6 +8,9 @@ export default function HomePage() {\n       <Link href=\"/static-page\" id=\"to-static-page\">\n         To Static Page\n       </Link>\n+      <Link href=\"/static-page-no-prefetch\" id=\"to-static-page-no-prefetch\">\n+        To Static Page No Prefetch\n+      </Link>\n       <Link href=\"/dynamic-page\" id=\"to-dynamic-page-no-params\">\n         To Dynamic Page\n       </Link>"
        },
        {
            "sha": "776863bfc87e123f2e95f929d4bfc47ca418e398",
            "filename": "test/e2e/app-dir/app-prefetch/app/static-page-no-prefetch/page.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fstatic-page-no-prefetch%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fstatic-page-no-prefetch%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fapp%2Fstatic-page-no-prefetch%2Fpage.js?ref=45a5405de21fe158e93aec6441e3ed70399323dd",
            "patch": "@@ -0,0 +1,14 @@\n+import Link from 'next/link'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p id=\"static-page-no-prefetch\">Static Page No Prefetch</p>\n+      <p>\n+        <Link href=\"/\" id=\"to-home\">\n+          To home\n+        </Link>\n+      </p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "84d8ca07256bdfbda630ea5db874ae1b9801efa5",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.stale-times.test.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 3,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45a5405de21fe158e93aec6441e3ed70399323dd/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts?ref=45a5405de21fe158e93aec6441e3ed70399323dd",
            "patch": "@@ -8,8 +8,8 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     nextConfig: {\n       experimental: {\n         staleTimes: {\n-          static: 30,\n-          dynamic: 20,\n+          static: 10,\n+          dynamic: 5,\n         },\n       },\n     },\n@@ -86,7 +86,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       .waitForElementByCss('#to-static-page')\n \n     // Wait for the stale time to pass.\n-    await waitFor(30000)\n+    await waitFor(10000)\n     // Click on the link to the static page again\n     await linkToStaticPage.click()\n     // Wait for the static page to load again\n@@ -131,4 +131,37 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     // the initial fetch, 2 sub-page fetches, and a final fetch when reloading the page\n     expect(await browser.elementById('count').text()).toBe('4')\n   })\n+\n+  it('should fetch again when the initially visited static page is visited after the stale time has passed', async () => {\n+    const browser = await next.browser('/404')\n+    let requests: string[] = []\n+\n+    browser.on('request', (req) => {\n+      // only consider requests that have RSC header but not the prefetch header\n+      if (req.headers()['rsc'] && !req.headers()['next-router-prefetch']) {\n+        requests.push(new URL(req.url()).pathname)\n+      }\n+    })\n+\n+    await browser.eval('location.href = \"/static-page-no-prefetch\"')\n+\n+    await browser\n+      .elementByCss('#to-home')\n+      .click()\n+      .waitForElementByCss('#to-static-page')\n+\n+    // Wait for the stale time to pass.\n+    await waitFor(10000)\n+\n+    await browser.elementByCss('#to-static-page-no-prefetch').click()\n+\n+    // Wait for the static page to load again\n+    await browser.waitForElementByCss('#static-page-no-prefetch')\n+\n+    await retry(async () => {\n+      expect(\n+        requests.filter((request) => request === '/static-page-no-prefetch')\n+      ).toHaveLength(1)\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 65,
        "deletions": 6
    }
}