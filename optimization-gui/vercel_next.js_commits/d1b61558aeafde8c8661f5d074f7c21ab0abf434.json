{
    "author": "sokra",
    "message": "Turbopack: shutdown turbo-tasks even when build crashes (#77937)\n\n### What?\n\nWhen a Turbopack build finishes with a crash and throws an error, we still want to make sure to gracefully shutdown turbo tasks. This ensures that cache and trace is written correctly.",
    "sha": "d1b61558aeafde8c8661f5d074f7c21ab0abf434",
    "files": [
        {
            "sha": "8beb28868082b5673577f3b59f75e51db0f9fb1c",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 100,
            "deletions": 93,
            "changes": 193,
            "blob_url": "https://github.com/vercel/next.js/blob/d1b61558aeafde8c8661f5d074f7c21ab0abf434/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d1b61558aeafde8c8661f5d074f7c21ab0abf434/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=d1b61558aeafde8c8661f5d074f7c21ab0abf434",
            "patch": "@@ -87,66 +87,77 @@ export async function turbopackBuild(): Promise<{\n       dependencyTracking: persistentCaching,\n     }\n   )\n-\n-  // Write an empty file in a known location to signal this was built with Turbopack\n-  await fs.writeFile(path.join(distDir, 'turbopack'), '')\n-\n-  await fs.mkdir(path.join(distDir, 'server'), { recursive: true })\n-  await fs.mkdir(path.join(distDir, 'static', buildId), {\n-    recursive: true,\n-  })\n-  await fs.writeFile(\n-    path.join(distDir, 'package.json'),\n-    JSON.stringify(\n-      {\n-        type: 'commonjs',\n-      },\n-      null,\n-      2\n+  try {\n+    // Write an empty file in a known location to signal this was built with Turbopack\n+    await fs.writeFile(path.join(distDir, 'turbopack'), '')\n+\n+    await fs.mkdir(path.join(distDir, 'server'), { recursive: true })\n+    await fs.mkdir(path.join(distDir, 'static', buildId), {\n+      recursive: true,\n+    })\n+    await fs.writeFile(\n+      path.join(distDir, 'package.json'),\n+      JSON.stringify(\n+        {\n+          type: 'commonjs',\n+        },\n+        null,\n+        2\n+      )\n     )\n-  )\n \n-  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n-  const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n+    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n+    const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n \n-  const manifestLoader = new TurbopackManifestLoader({\n-    buildId,\n-    distDir,\n-    encryptionKey,\n-  })\n+    const manifestLoader = new TurbopackManifestLoader({\n+      buildId,\n+      distDir,\n+      encryptionKey,\n+    })\n+\n+    const topLevelErrors = []\n+    const topLevelWarnings = []\n+    for (const issue of entrypoints.issues) {\n+      if (issue.severity === 'error' || issue.severity === 'fatal') {\n+        topLevelErrors.push(formatIssue(issue))\n+      } else if (isRelevantWarning(issue)) {\n+        topLevelWarnings.push(formatIssue(issue))\n+      }\n+    }\n \n-  const topLevelErrors = []\n-  const topLevelWarnings = []\n-  for (const issue of entrypoints.issues) {\n-    if (issue.severity === 'error' || issue.severity === 'fatal') {\n-      topLevelErrors.push(formatIssue(issue))\n-    } else if (isRelevantWarning(issue)) {\n-      topLevelWarnings.push(formatIssue(issue))\n+    if (topLevelWarnings.length > 0) {\n+      console.warn(\n+        `Turbopack build encountered ${\n+          topLevelWarnings.length\n+        } warnings:\\n${topLevelWarnings.join('\\n')}`\n+      )\n     }\n-  }\n \n-  if (topLevelWarnings.length > 0) {\n-    console.warn(\n-      `Turbopack build encountered ${\n-        topLevelWarnings.length\n-      } warnings:\\n${topLevelWarnings.join('\\n')}`\n-    )\n-  }\n+    if (topLevelErrors.length > 0) {\n+      throw new Error(\n+        `Turbopack build failed with ${\n+          topLevelErrors.length\n+        } errors:\\n${topLevelErrors.join('\\n')}`\n+      )\n+    }\n \n-  if (topLevelErrors.length > 0) {\n-    throw new Error(\n-      `Turbopack build failed with ${\n-        topLevelErrors.length\n-      } errors:\\n${topLevelErrors.join('\\n')}`\n-    )\n-  }\n+    const currentEntrypoints = await rawEntrypointsToEntrypoints(entrypoints)\n \n-  const currentEntrypoints = await rawEntrypointsToEntrypoints(entrypoints)\n+    const promises: Promise<any>[] = []\n \n-  const promises: Promise<any>[] = []\n+    if (!appDirOnly) {\n+      for (const [page, route] of currentEntrypoints.page) {\n+        promises.push(\n+          handleRouteType({\n+            page,\n+            route,\n+            manifestLoader,\n+          })\n+        )\n+      }\n+    }\n \n-  if (!appDirOnly) {\n-    for (const [page, route] of currentEntrypoints.page) {\n+    for (const [page, route] of currentEntrypoints.app) {\n       promises.push(\n         handleRouteType({\n           page,\n@@ -155,50 +166,46 @@ export async function turbopackBuild(): Promise<{\n         })\n       )\n     }\n-  }\n \n-  for (const [page, route] of currentEntrypoints.app) {\n-    promises.push(\n-      handleRouteType({\n-        page,\n-        route,\n-        manifestLoader,\n-      })\n-    )\n-  }\n-\n-  await Promise.all(promises)\n-\n-  await Promise.all([\n-    manifestLoader.loadBuildManifest('_app'),\n-    manifestLoader.loadPagesManifest('_app'),\n-    manifestLoader.loadFontManifest('_app'),\n-    manifestLoader.loadPagesManifest('_document'),\n-    manifestLoader.loadBuildManifest('_error'),\n-    manifestLoader.loadPagesManifest('_error'),\n-    manifestLoader.loadFontManifest('_error'),\n-    entrypoints.instrumentation &&\n-      manifestLoader.loadMiddlewareManifest(\n-        'instrumentation',\n-        'instrumentation'\n-      ),\n-    entrypoints.middleware &&\n-      (await manifestLoader.loadMiddlewareManifest('middleware', 'middleware')),\n-  ])\n-\n-  await manifestLoader.writeManifests({\n-    devRewrites: undefined,\n-    productionRewrites: rewrites,\n-    entrypoints: currentEntrypoints,\n-  })\n-\n-  const shutdownPromise = project.shutdown()\n-\n-  const time = process.hrtime(startTime)\n-  return {\n-    duration: time[0] + time[1] / 1e9,\n-    buildTraceContext: undefined,\n-    shutdownPromise,\n+    await Promise.all(promises)\n+\n+    await Promise.all([\n+      manifestLoader.loadBuildManifest('_app'),\n+      manifestLoader.loadPagesManifest('_app'),\n+      manifestLoader.loadFontManifest('_app'),\n+      manifestLoader.loadPagesManifest('_document'),\n+      manifestLoader.loadBuildManifest('_error'),\n+      manifestLoader.loadPagesManifest('_error'),\n+      manifestLoader.loadFontManifest('_error'),\n+      entrypoints.instrumentation &&\n+        manifestLoader.loadMiddlewareManifest(\n+          'instrumentation',\n+          'instrumentation'\n+        ),\n+      entrypoints.middleware &&\n+        (await manifestLoader.loadMiddlewareManifest(\n+          'middleware',\n+          'middleware'\n+        )),\n+    ])\n+\n+    await manifestLoader.writeManifests({\n+      devRewrites: undefined,\n+      productionRewrites: rewrites,\n+      entrypoints: currentEntrypoints,\n+    })\n+\n+    const shutdownPromise = project.shutdown()\n+\n+    const time = process.hrtime(startTime)\n+    return {\n+      duration: time[0] + time[1] / 1e9,\n+      buildTraceContext: undefined,\n+      shutdownPromise,\n+    }\n+  } catch (err) {\n+    await project.shutdown()\n+    throw err\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 193,
        "additions": 100,
        "deletions": 93
    }
}