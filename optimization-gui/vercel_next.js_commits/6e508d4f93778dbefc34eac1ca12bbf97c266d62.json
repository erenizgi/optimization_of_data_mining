{
    "author": "huozhi",
    "message": "[segment explorer] display navigation error boundaries (#80691)",
    "sha": "6e508d4f93778dbefc34eac1ca12bbf97c266d62",
    "files": [
        {
            "sha": "dc8666ed911db0c364bd8dbe230f3b7c6d5b41b5",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -250,4 +250,10 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     background-color: var(--color-blue-300);\n     color: var(--color-blue-800);\n   }\n+  .segment-explorer-file-label--not-found,\n+  .segment-explorer-file-label--forbidden,\n+  .segment-explorer-file-label--unauthorized {\n+    background-color: var(--color-amber-300);\n+    color: var(--color-amber-900);\n+  }\n `"
        },
        {
            "sha": "dd98e2b9bf7d8a06e17a4d66421e2b385ed5d135",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 87,
            "deletions": 29,
            "changes": 116,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -392,6 +392,13 @@ async function createComponentTreeInternal({\n \n   // Resolve the segment param\n   const actualSegment = segmentParam ? segmentParam.treeSegment : segment\n+  const isSegmentViewEnabled =\n+    process.env.NODE_ENV === 'development' &&\n+    ctx.renderOpts.devtoolSegmentExplorer\n+  const dir =\n+    process.env.NEXT_RUNTIME === 'edge'\n+      ? process.env.__NEXT_EDGE_PROJECT_DIR!\n+      : ctx.renderOpts.dir || ''\n \n   // Use the same condition to render metadataOutlet as metadata\n   const metadataOutlet = StreamingMetadataOutlet ? (\n@@ -400,35 +407,30 @@ async function createComponentTreeInternal({\n     <MetadataOutlet ready={getMetadataReady} />\n   )\n \n-  const notFoundElement = NotFound ? (\n-    <>\n-      <NotFound />\n-      {notFoundStyles}\n-    </>\n-  ) : undefined\n-\n-  const forbiddenElement = Forbidden ? (\n-    <>\n-      <Forbidden />\n-      {forbiddenStyles}\n-    </>\n-  ) : undefined\n+  const notFoundElement = await createBoundaryConventionElement({\n+    ctx,\n+    conventionName: 'not-found',\n+    Component: NotFound,\n+    styles: notFoundStyles,\n+    tree,\n+  })\n \n-  const unauthorizedElement = Unauthorized ? (\n-    <>\n-      <Unauthorized />\n-      {unauthorizedStyles}\n-    </>\n-  ) : undefined\n+  const forbiddenElement = await createBoundaryConventionElement({\n+    ctx,\n+    conventionName: 'forbidden',\n+    Component: Forbidden,\n+    styles: forbiddenStyles,\n+    tree,\n+  })\n \n-  const dir =\n-    process.env.NEXT_RUNTIME === 'edge'\n-      ? process.env.__NEXT_EDGE_PROJECT_DIR!\n-      : ctx.renderOpts.dir || ''\n+  const unauthorizedElement = await createBoundaryConventionElement({\n+    ctx,\n+    conventionName: 'unauthorized',\n+    Component: Unauthorized,\n+    styles: unauthorizedStyles,\n+    tree,\n+  })\n \n-  const isSegmentViewEnabled =\n-    process.env.NODE_ENV === 'development' &&\n-    ctx.renderOpts.devtoolSegmentExplorer\n   const nodeName = modType ?? 'page'\n \n   // TODO: Combine this `map` traversal with the loop below that turns the array\n@@ -881,12 +883,12 @@ async function createComponentTreeInternal({\n           <HTTPAccessFallbackBoundary\n             key={cacheNodeKey}\n             notFound={\n-              NotFound ? (\n+              notFoundElement ? (\n                 <>\n                   {layerAssets}\n                   <SegmentComponent params={params}>\n                     {notFoundStyles}\n-                    <NotFound />\n+                    {notFoundElement}\n                   </SegmentComponent>\n                 </>\n               ) : undefined\n@@ -1028,6 +1030,54 @@ function getRootParamsImpl(\n   }\n }\n \n+async function createBoundaryConventionElement({\n+  ctx,\n+  conventionName,\n+  Component,\n+  styles,\n+  tree,\n+}: {\n+  ctx: AppRenderContext\n+  conventionName:\n+    | 'not-found'\n+    | 'error'\n+    | 'loading'\n+    | 'forbidden'\n+    | 'unauthorized'\n+  Component: React.ComponentType<any> | undefined\n+  styles: React.ReactNode | undefined\n+  tree: LoaderTree\n+}) {\n+  const isSegmentViewEnabled =\n+    process.env.NODE_ENV === 'development' &&\n+    ctx.renderOpts.devtoolSegmentExplorer\n+  const dir =\n+    process.env.NEXT_RUNTIME === 'edge'\n+      ? process.env.__NEXT_EDGE_PROJECT_DIR!\n+      : ctx.renderOpts.dir || ''\n+  const { SegmentViewNode } = ctx.componentMod\n+  const element = Component ? (\n+    <>\n+      <Component />\n+      {styles}\n+    </>\n+  ) : undefined\n+\n+  const wrappedElement =\n+    isSegmentViewEnabled && element ? (\n+      <SegmentViewNode\n+        type={conventionName}\n+        pagePath={getConventionPathByType(tree, dir, conventionName)!}\n+      >\n+        {element}\n+      </SegmentViewNode>\n+    ) : (\n+      element\n+    )\n+\n+  return wrappedElement\n+}\n+\n export function normalizeConventionFilePath(\n   projectDir: string,\n   conventionPath: string | undefined\n@@ -1057,7 +1107,15 @@ export function normalizeConventionFilePath(\n function getConventionPathByType(\n   tree: LoaderTree,\n   dir: string,\n-  conventionType: 'layout' | 'template' | 'page'\n+  conventionType:\n+    | 'layout'\n+    | 'template'\n+    | 'page'\n+    | 'not-found'\n+    | 'error'\n+    | 'loading'\n+    | 'forbidden'\n+    | 'unauthorized'\n ) {\n   const modules = tree[2]\n   const conventionPath = modules[conventionType]"
        },
        {
            "sha": "ddefe57f0aea47411e58e3210c732c6e64bdb22a",
            "filename": "test/development/app-dir/segment-explorer/app/boundary/forbidden.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fforbidden.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fforbidden.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fforbidden.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Forbidden() {\n+  return <h2>Custom Forbidden</h2>\n+}"
        },
        {
            "sha": "3075e48b0a7c2488843f98f5724b7476451ebfdc",
            "filename": "test/development/app-dir/segment-explorer/app/boundary/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Flayout.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return (\n+    <div>\n+      <h1>Boundary Layout</h1>\n+      {children}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "2e05eed943ed5c0b359a1378de423e05b49cb692",
            "filename": "test/development/app-dir/segment-explorer/app/boundary/not-found.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fnot-found.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -0,0 +1,3 @@\n+export default function NotFound() {\n+  return <h2>Custom Not Found</h2>\n+}"
        },
        {
            "sha": "1bce7f4b78ebca258df0e773bf241c7631902e80",
            "filename": "test/development/app-dir/segment-explorer/app/boundary/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Fpage.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -0,0 +1,20 @@\n+import { forbidden, notFound, unauthorized } from 'next/navigation'\n+\n+export default async function Page({\n+  searchParams,\n+}: {\n+  searchParams: Promise<{ [key: string]: string }>\n+}) {\n+  const search = await searchParams\n+  switch (search.name) {\n+    case 'not-found':\n+      return notFound()\n+    case 'forbidden':\n+      return forbidden()\n+    case 'unauthorized':\n+      return unauthorized()\n+    default:\n+      break\n+  }\n+  return <p>{'Visit /boundary?name=<boundary>'}</p>\n+}"
        },
        {
            "sha": "bfa7b46ff0cfdaa67730d3207e092c759cd99d02",
            "filename": "test/development/app-dir/segment-explorer/app/boundary/unauthorized.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Funauthorized.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Funauthorized.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fboundary%2Funauthorized.tsx?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Unauthorized() {\n+  return <h2>Custom Unauthorized</h2>\n+}"
        },
        {
            "sha": "6a4b4a634d561b7e8c95c15316e3571b3fa1e40d",
            "filename": "test/development/app-dir/segment-explorer/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fnext.config.js?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -4,6 +4,7 @@\n const nextConfig = {\n   experimental: {\n     devtoolSegmentExplorer: true,\n+    authInterrupts: true,\n   },\n }\n "
        },
        {
            "sha": "16fe97b615c4084660c5504b48327ad848975943",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6e508d4f93778dbefc34eac1ca12bbf97c266d62/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=6e508d4f93778dbefc34eac1ca12bbf97c266d62",
            "patch": "@@ -131,4 +131,33 @@ describe('segment-explorer', () => {\n      global-error.tsx\"\n     `)\n   })\n+\n+  it('should show navigation boundaries of the segment', async () => {\n+    const browser = await next.browser('/boundary?name=not-found')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     boundary/\n+     layout.tsx\n+     not-found.tsx\"\n+    `)\n+\n+    await browser.loadPage(`${next.url}/boundary?name=forbidden`)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     boundary/\n+     layout.tsx\n+     forbidden.tsx\"\n+    `)\n+\n+    await browser.loadPage(`${next.url}/boundary?name=unauthorized`)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     boundary/\n+     layout.tsx\n+     unauthorized.tsx\"\n+    `)\n+  })\n })"
        }
    ],
    "stats": {
        "total": 189,
        "additions": 160,
        "deletions": 29
    }
}