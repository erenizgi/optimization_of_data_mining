{
    "author": "unstubbable",
    "message": "Remove prospective fallback prerenders (#79304)\n\nThe prospective fallback prerenders, which ensured that a fallback shell could be prerendered without errors, were only needed when Dynamic IO was enabled and PPR was disabled. This scenario is no longer supported.",
    "sha": "aaf8a16f5653c15a895c262b21c6c4916d052109",
    "files": [
        {
            "sha": "e629539aef7ad8a05d298b7899c2ccecee635da7",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 52,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -193,7 +193,6 @@ import {\n } from '../server/lib/experimental/ppr'\n import { FallbackMode, fallbackModeToFallbackField } from '../lib/fallback'\n import { RenderingMode } from './rendering-mode'\n-import { getParamKeys } from '../server/request/fallback-params'\n import { InvariantError } from '../shared/lib/invariant-error'\n import { HTML_LIMITED_BOT_UA_RE_STRING } from '../shared/lib/router/utils/is-bot'\n import type { UseCacheTrackerKey } from './webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n@@ -1613,10 +1612,6 @@ export default async function build(\n       const serverPropsPages = new Set<string>()\n       const additionalPaths = new Map<string, PrerenderedRoute[]>()\n       const staticPaths = new Map<string, PrerenderedRoute[]>()\n-      const prospectiveRenders = new Map<\n-        string,\n-        { page: string; originalAppPath: string }\n-      >()\n       const appNormalizedPaths = new Map<string, string>()\n       const fallbackModes = new Map<string, FallbackMode>()\n       const appDefaultConfigs = new Map<string, AppSegmentConfig>()\n@@ -1975,31 +1970,6 @@ export default async function build(\n \n                             staticPaths.set(originalAppPath, [])\n                           }\n-                          // As PPR isn't enabled for this route, if dynamic IO\n-                          // is enabled, and this is a dynamic route, we should\n-                          // complete a prospective render for the route so that\n-                          // we can use the fallback behavior. This lets us\n-                          // check that dynamic pages won't error when they\n-                          // enable PPR.\n-                          else if (config.experimental.dynamicIO && isDynamic) {\n-                            // If there's a page with a more specific render\n-                            // available, then we should skip the prospective\n-                            // render because it'll be done as a part of the\n-                            // that render to validate the dynamic state.\n-                            if (\n-                              // The existence of any prerendered routes when\n-                              // PPR is disabled means that the route has more\n-                              // specific prerendered routes that should be\n-                              // used for the diagnostic render anyways.\n-                              !workerResult.prerenderedRoutes ||\n-                              workerResult.prerenderedRoutes.length === 0\n-                            ) {\n-                              prospectiveRenders.set(originalAppPath, {\n-                                page,\n-                                originalAppPath,\n-                              })\n-                            }\n-                          }\n \n                           if (workerResult.prerenderedRoutes) {\n                             staticPaths.set(\n@@ -2718,28 +2688,6 @@ export default async function build(\n                 })\n               })\n \n-              // If the app does have dynamic IO enabled but does not have PPR\n-              // enabled, then we need to perform a prospective render for all\n-              // the dynamic pages to ensure that they won't error during\n-              // rendering (due to a missing prelude).\n-              for (const {\n-                page,\n-                originalAppPath,\n-              } of prospectiveRenders.values()) {\n-                defaultMap[page] = {\n-                  page: originalAppPath,\n-                  _ssgPath: page,\n-                  _fallbackRouteParams: getParamKeys(page),\n-                  // Prospective renders are only enabled for app pages.\n-                  _isAppDir: true,\n-                  // Prospective renders are only enabled when PPR is disabled.\n-                  _isRoutePPREnabled: false,\n-                  _isProspectiveRender: true,\n-                  // Dynamic IO does not currently support `dynamic === 'error'`.\n-                  _isDynamicError: false,\n-                }\n-              }\n-\n               if (i18n) {\n                 for (const page of [\n                   ...staticPages,"
        },
        {
            "sha": "bfbaaa1a2b7b09613fae681169291a812b29c634",
            "filename": "packages/next/src/export/routes/app-page.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 52,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -30,58 +30,6 @@ import type { RequestLifecycleOpts } from '../../server/base-server'\n import type { AppSharedContext } from '../../server/app-render/app-render'\n import type { MultiFileWriter } from '../../lib/multi-file-writer'\n \n-export async function prospectiveRenderAppPage(\n-  req: MockedRequest,\n-  res: MockedResponse,\n-  page: string,\n-  pathname: string,\n-  query: NextParsedUrlQuery,\n-  fallbackRouteParams: FallbackRouteParams | null,\n-  partialRenderOpts: Omit<RenderOpts, keyof RequestLifecycleOpts>,\n-  sharedContext: AppSharedContext\n-): Promise<undefined> {\n-  const afterRunner = new AfterRunner()\n-\n-  // If the page is `/_not-found`, then we should update the page to be `/404`.\n-  // UNDERSCORE_NOT_FOUND_ROUTE value used here, however we don't want to import it here as it causes constants to be inlined which we don't want here.\n-  if (page === '/_not-found/page') {\n-    pathname = '/404'\n-  }\n-\n-  try {\n-    await lazyRenderAppPage(\n-      new NodeNextRequest(req),\n-      new NodeNextResponse(res),\n-      pathname,\n-      query,\n-      fallbackRouteParams,\n-      {\n-        ...partialRenderOpts,\n-        waitUntil: afterRunner.context.waitUntil,\n-        onClose: afterRunner.context.onClose,\n-        onAfterTaskError: afterRunner.context.onTaskError,\n-      },\n-      undefined,\n-      false,\n-      sharedContext\n-    )\n-\n-    // TODO(after): if we abort a prerender because of an error in an after-callback\n-    // we should probably communicate that better (and not log the error twice)\n-    await afterRunner.executeAfter()\n-  } catch (err) {\n-    if (!isDynamicUsageError(err)) {\n-      throw err\n-    }\n-\n-    // We should fail rendering if a client side rendering bailout\n-    // occurred at the page level.\n-    if (isBailoutToCSRError(err)) {\n-      throw err\n-    }\n-  }\n-}\n-\n /**\n  * Renders & exports a page associated with the /app directory\n  */"
        },
        {
            "sha": "2aa6a4e48459f1b79c4fc2410311f6e0c21cf79f",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 20,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -26,7 +26,7 @@ import { createRequestResponseMocks } from '../server/lib/mock-request'\n import { isAppRouteRoute } from '../lib/is-app-route-route'\n import { hasNextSupport } from '../server/ci-info'\n import { exportAppRoute } from './routes/app-route'\n-import { exportAppPage, prospectiveRenderAppPage } from './routes/app-page'\n+import { exportAppPage } from './routes/app-page'\n import { exportPagesPage } from './routes/pages'\n import { getParams } from './helpers/get-params'\n import { createIncrementalCache } from './helpers/create-incremental-cache'\n@@ -104,10 +104,6 @@ async function exportPageImpl(\n     // the renderOpts.\n     _isRoutePPREnabled: isRoutePPREnabled,\n \n-    // If this is a prospective render, we don't actually want to persist the\n-    // result, we just want to use it to error the build if there's a problem.\n-    _isProspectiveRender: isProspectiveRender = false,\n-\n     // Configure the rendering of the page not to throw if an empty static shell\n     // is generated while rendering using PPR.\n     _doNotThrowOnEmptyStaticShell: doNotThrowOnEmptyStaticShell = false,\n@@ -287,21 +283,6 @@ async function exportPageImpl(\n       buildId: input.buildId,\n     }\n \n-    // If this is a prospective render, don't return any metrics or revalidate\n-    // timings as we aren't persisting this render (it was only to error).\n-    if (isProspectiveRender) {\n-      return prospectiveRenderAppPage(\n-        req,\n-        res,\n-        page,\n-        pathname,\n-        query,\n-        fallbackRouteParams,\n-        renderOpts,\n-        sharedContext\n-      )\n-    }\n-\n     return exportAppPage(\n       req,\n       res,"
        },
        {
            "sha": "cf2e060444674933066ca05ebaced99b15c41a86",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -41,7 +41,6 @@ const zExportMap: zod.ZodType<ExportPathMap> = z.record(\n     _isAppDir: z.boolean().optional(),\n     _isDynamicError: z.boolean().optional(),\n     _isRoutePPREnabled: z.boolean().optional(),\n-    _isProspectiveRender: z.boolean().optional(),\n     _doNotThrowOnEmptyStaticShell: z.boolean().optional(),\n   })\n )"
        },
        {
            "sha": "1d1a8c3cf277d5042c05c114621694ec3cde639d",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -743,16 +743,6 @@ export type ExportPathMap = {\n      */\n     _isRoutePPREnabled?: boolean\n \n-    /**\n-     * When true, it indicates that this page is being rendered in an attempt to\n-     * discover if the page will be safe to generate with PPR. This is only\n-     * enabled when the app has `experimental.dynamicIO` enabled but does not\n-     * have `experimental.ppr` enabled.\n-     *\n-     * @internal\n-     */\n-    _isProspectiveRender?: boolean\n-\n     /**\n      * When true, it indicates that the diagnostic render for this page is\n      * disabled. This is only used when the app has `experimental.ppr` and"
        },
        {
            "sha": "52ebe2c2f7f653d807b8905c00ad97e4e4a93308",
            "filename": "packages/next/src/server/request/fallback-params.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Ffallback-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aaf8a16f5653c15a895c262b21c6c4916d052109/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Ffallback-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Ffallback-params.ts?ref=aaf8a16f5653c15a895c262b21c6c4916d052109",
            "patch": "@@ -3,7 +3,7 @@ import { getRouteRegex } from '../../shared/lib/router/utils/route-regex'\n \n export type FallbackRouteParams = ReadonlyMap<string, string>\n \n-export function getParamKeys(page: string) {\n+function getParamKeys(page: string) {\n   const pattern = getRouteRegex(page)\n   const matcher = getRouteMatcher(pattern)\n "
        },
        {
            "sha": "d9c59ec790450b7276a89ba0bde8b82430546e0a",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.prospective-fallback.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 54,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.prospective-fallback.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.prospective-fallback.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.prospective-fallback.test.ts?ref=0790b78dd2452d5db25456b60ec4859ef9265f4e",
            "patch": "@@ -1,54 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-\n-describe(`Dynamic IO Prospective Fallback`, () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n-    files: __dirname + '/fixtures/prospective-fallback',\n-    skipStart: true,\n-    skipDeployment: true,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  if (isNextDev) {\n-    it('should not error when visiting the page', async () => {\n-      // Start the server, we expect this to succeed.\n-      await next.start()\n-\n-      const res = await next.fetch('/blog/123')\n-      expect(res.status).toBe(200)\n-    })\n-  } else {\n-    it('should error on the build due to a missing suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n-      }\n-\n-      // TODO: Assert on component stack\n-      expect(next.cliOutput).toContain(\n-        'Route \"/blog/[slug]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.'\n-      )\n-    })\n-\n-    it('should not error when we add the missing suspense boundary', async () => {\n-      await next.patchFile(\n-        'app/blog/[slug]/loading.jsx',\n-        `\n-        export default function Loading() {\n-          return <div>Loading...</div>\n-        }\n-      `\n-      )\n-\n-      // We expect this to succeed.\n-      await next.start()\n-\n-      expect(next.cliOutput).not.toContain(\n-        'Route \"/blog/[slug]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.'\n-      )\n-    })\n-  }\n-})"
        },
        {
            "sha": "cc65c1e63b57b69770b3f8c32323c353f9abbf04",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/prospective-fallback/app/blog/[slug]/page.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Fblog%2F%5Bslug%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Fblog%2F%5Bslug%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Fblog%2F%5Bslug%5D%2Fpage.jsx?ref=0790b78dd2452d5db25456b60ec4859ef9265f4e",
            "patch": "@@ -1,4 +0,0 @@\n-export default async function BlogPage({ params }) {\n-  const { slug } = await params\n-  return <div>Blog: {slug}</div>\n-}"
        },
        {
            "sha": "803f17d863c8ad887c14588aab3487e473367b41",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/prospective-fallback/app/layout.jsx",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fapp%2Flayout.jsx?ref=0790b78dd2452d5db25456b60ec4859ef9265f4e",
            "patch": "@@ -1,7 +0,0 @@\n-export default function RootLayout({ children }) {\n-  return (\n-    <html>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "195ad29be3c541271cf3c008a43292270f39b52c",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/prospective-fallback/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0790b78dd2452d5db25456b60ec4859ef9265f4e/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fprospective-fallback%2Fnext.config.js?ref=0790b78dd2452d5db25456b60ec4859ef9265f4e",
            "patch": "@@ -1,6 +0,0 @@\n-module.exports = {\n-  experimental: {\n-    dynamicIO: true,\n-    serverSourceMaps: true,\n-  },\n-}"
        }
    ],
    "stats": {
        "total": 209,
        "additions": 2,
        "deletions": 207
    }
}