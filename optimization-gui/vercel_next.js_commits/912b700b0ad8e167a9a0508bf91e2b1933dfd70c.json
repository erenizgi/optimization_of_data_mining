{
    "author": "wbinnssmith",
    "message": "Add basic profiling plugin for alternative bundler (#76030)\n\nAdds a profiling plugin for Rspack to enable tracing similar to the existing Webpack profiling plugin. Rspack does not implement all of the hooks necessary to re-use the webpack plugin, so this is a basic implementation that starts and stops spans, and makes them available to our loaders.",
    "sha": "912b700b0ad8e167a9a0508bf91e2b1933dfd70c",
    "files": [
        {
            "sha": "c7c8c1612fb76b5c4ff27d099ce404d2bbbcb318",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=912b700b0ad8e167a9a0508bf91e2b1933dfd70c",
            "patch": "@@ -93,6 +93,8 @@ import {\n   NEXT_PROJECT_ROOT_DIST_CLIENT,\n } from './next-dir-paths'\n import { getRspackReactRefresh } from '../shared/lib/get-rspack'\n+import { RspackProfilingPlugin } from './webpack/plugins/rspack-profiling-plugin'\n+\n type ExcludesFalse = <T>(x: T | false) => x is T\n type ClientEntries = {\n   [key: string]: string | string[]\n@@ -1912,7 +1914,9 @@ export default async function getBaseWebpackConfig(\n           appDirEnabled: hasAppDir,\n           clientRouterFilters,\n         }),\n-      !isRspack && new ProfilingPlugin({ runWebpackSpan, rootDir: dir }),\n+      isRspack\n+        ? new RspackProfilingPlugin({ runWebpackSpan })\n+        : new ProfilingPlugin({ runWebpackSpan, rootDir: dir }),\n       new WellKnownErrorsPlugin(),\n       isClient &&\n         new CopyFilePlugin({"
        },
        {
            "sha": "97a79fe5c288bf4990f01b52d536b2b1df642139",
            "filename": "packages/next/src/build/webpack/plugins/build-manifest-plugin.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts?ref=912b700b0ad8e167a9a0508bf91e2b1933dfd70c",
            "patch": "@@ -17,9 +17,12 @@ import type { BuildManifest } from '../../../server/get-page-files'\n import getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\n import { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\n import { getSortedRoutes } from '../../../shared/lib/router/utils'\n-import { spans } from './profiling-plugin'\n+import { spans as webpackSpans } from './profiling-plugin'\n+import { compilationSpans as rspackSpans } from './rspack-profiling-plugin'\n import { Span } from '../../../trace'\n \n+const compilationSpans = process.env.NEXT_RSPACK ? rspackSpans : webpackSpans\n+\n type DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n \n export type ClientBuildManifest = {\n@@ -106,9 +109,9 @@ export function generateClientManifest(\n   compilation?: any\n ): string | undefined {\n   const compilationSpan = compilation\n-    ? spans.get(compilation)\n+    ? compilationSpans.get(compilation)\n     : compiler\n-      ? spans.get(compiler)\n+      ? compilationSpans.get(compiler)\n       : new Span({ name: 'client-manifest' })\n \n   const genClientManifestSpan = compilationSpan?.traceChild(\n@@ -201,11 +204,17 @@ export default class BuildManifestPlugin {\n   }\n \n   createAssets(compiler: any, compilation: any) {\n-    const compilationSpan = spans.get(compilation) || spans.get(compiler)\n-    const createAssetsSpan = compilationSpan?.traceChild(\n+    const compilationSpan =\n+      compilationSpans.get(compilation) ?? compilationSpans.get(compiler)\n+    if (!compilationSpan) {\n+      throw new Error('No span found for compilation')\n+    }\n+\n+    const createAssetsSpan = compilationSpan.traceChild(\n       'NextJsBuildManifest-createassets'\n     )\n-    return createAssetsSpan?.traceFn(() => {\n+\n+    return createAssetsSpan.traceFn(() => {\n       const entrypoints: Map<string, any> = compilation.entrypoints\n       const assetMap: DeepMutable<BuildManifest> = {\n         polyfillFiles: [],\n@@ -345,7 +354,7 @@ export default class BuildManifestPlugin {\n   }\n \n   apply(compiler: webpack.Compiler) {\n-    compiler.hooks.make.tap('NextJsBuildManifest', (compilation) => {\n+    compiler.hooks.make.tap('NextJsBuildManifest', (compilation: any) => {\n       compilation.hooks.processAssets.tap(\n         {\n           name: 'NextJsBuildManifest',"
        },
        {
            "sha": "7a19505814d6ca57f192211a1e6425c68f344052",
            "filename": "packages/next/src/build/webpack/plugins/rspack-profiling-plugin.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-profiling-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/912b700b0ad8e167a9a0508bf91e2b1933dfd70c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-profiling-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-profiling-plugin.ts?ref=912b700b0ad8e167a9a0508bf91e2b1933dfd70c",
            "patch": "@@ -0,0 +1,59 @@\n+// A basic implementation to allow loaders access to loaderContext.currentTraceSpan\n+\n+import type { Span } from '../../../trace'\n+\n+import { getRspackCore } from '../../../shared/lib/get-rspack'\n+\n+const pluginName = 'RspackProfilingPlugin'\n+const moduleSpansByCompilation = new WeakMap()\n+export const compilationSpans: WeakMap<any, Span> = new WeakMap()\n+\n+export class RspackProfilingPlugin {\n+  runWebpackSpan: Span\n+\n+  constructor({ runWebpackSpan }: { runWebpackSpan: Span }) {\n+    this.runWebpackSpan = runWebpackSpan\n+  }\n+\n+  apply(compiler: any) {\n+    compiler.hooks.compilation.tap(\n+      { name: pluginName, stage: -Infinity },\n+      (compilation: any) => {\n+        const rspack = getRspackCore()\n+\n+        moduleSpansByCompilation.set(compilation, new WeakMap())\n+        compilationSpans.set(\n+          compilation,\n+          this.runWebpackSpan.traceChild('compilation-' + compilation.name)\n+        )\n+\n+        const compilationSpan = this.runWebpackSpan.traceChild(\n+          `compilation-${compilation.name}`\n+        )\n+\n+        const moduleHooks = rspack.NormalModule.getCompilationHooks(compilation)\n+        moduleHooks.loader.tap(\n+          pluginName,\n+          (loaderContext: any, module: any) => {\n+            const moduleSpan = moduleSpansByCompilation\n+              .get(compilation)\n+              ?.get(module)\n+            loaderContext.currentTraceSpan = moduleSpan\n+          }\n+        )\n+\n+        compilation.hooks.buildModule.tap(pluginName, (module: any) => {\n+          const span = compilationSpan.traceChild('build-module')\n+          span.setAttribute('name', module.userRequest)\n+          span.setAttribute('layer', module.layer)\n+\n+          moduleSpansByCompilation?.get(compilation)?.set(module, span)\n+        })\n+\n+        compilation.hooks.succeedModule.tap(pluginName, (module: any) => {\n+          moduleSpansByCompilation?.get(compilation)?.get(module)?.stop()\n+        })\n+      }\n+    )\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 80,
        "deletions": 8
    }
}