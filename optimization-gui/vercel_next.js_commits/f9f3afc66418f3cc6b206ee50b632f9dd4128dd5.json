{
    "author": "ztanner",
    "message": "fix: route handlers should validate invalid exports (#83500)\n\nWhen using an unsupported API in a route handler (eg, `export const\ndynamic` with `cacheComponents` enabled), we were not erroring in dev or\nfailing the build. This is because the transform only asserted on pages\n& layouts, and not route handlers.\n\nThis updates the handling to also check route handlers. \n\nFixes NAR-371",
    "sha": "f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
    "files": [
        {
            "sha": "98306014b48ccefb285067a476e55a1e7b757cc9",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -805,10 +805,10 @@ impl ReactServerComponentValidator {\n             return;\n         }\n         static RE: Lazy<Regex> =\n-            Lazy::new(|| Regex::new(r\"[\\\\/](page|layout)\\.(ts|js)x?$\").unwrap());\n-        let is_layout_or_page = RE.is_match(&self.filepath);\n+            Lazy::new(|| Regex::new(r\"[\\\\/](page|layout|route)\\.(ts|js)x?$\").unwrap());\n+        let is_app_entry = RE.is_match(&self.filepath);\n \n-        if is_layout_or_page {\n+        if is_app_entry {\n             let mut possibly_invalid_exports: FxIndexMap<Atom, (InvalidExportKind, Span)> =\n                 FxIndexMap::default();\n "
        },
        {
            "sha": "b1e71f1b5ee5dbefc83c2bfe0d5bc57488eee88b",
            "filename": "test/e2e/app-dir/cache-components-dynamic-imports/bundled/app/not-instrumented/edge-route-handler/messages.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3ef17684e75bfed780f178022a3e9267879c0385/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3ef17684e75bfed780f178022a3e9267879c0385/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Fmessages.ts?ref=3ef17684e75bfed780f178022a3e9267879c0385",
            "patch": "@@ -1 +0,0 @@\n-export default { title: 'hello' }"
        },
        {
            "sha": "c7ca93ac75f4448d9ac28c3e74d02fe06734aee6",
            "filename": "test/e2e/app-dir/cache-components-dynamic-imports/bundled/app/not-instrumented/edge-route-handler/route.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3ef17684e75bfed780f178022a3e9267879c0385/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3ef17684e75bfed780f178022a3e9267879c0385/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fbundled%2Fapp%2Fnot-instrumented%2Fedge-route-handler%2Froute.ts?ref=3ef17684e75bfed780f178022a3e9267879c0385",
            "patch": "@@ -1,9 +0,0 @@\n-export const runtime = 'edge'\n-\n-export async function GET(_request: Request) {\n-  // This import should not be instrumented, because edge routes are never prerendered.\n-  // `trackDynamicImport` will throw if it's used in the edge runtime,\n-  // so it's enough to just do an import() here and see if it succeeds.\n-  const messages = (await import('./messages')).default\n-  return new Response(messages.title)\n-}"
        },
        {
            "sha": "8a0005c0aba442bb80aca688fbbda07d8a1f6319",
            "filename": "test/e2e/app-dir/cache-components-dynamic-imports/cache-components-dynamic-imports.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -161,13 +161,6 @@ describe('async imports in cacheComponents', () => {\n       // indirectly tests the behavior of middleware by rendering a page which the middleware matches\n       await testPage('/not-instrumented/middleware')\n     })\n-\n-    it('edge route handler', async () => {\n-      const result = await next\n-        .fetch('/not-instrumented/edge-route-handler')\n-        .then((res) => res.text())\n-      expect(result).toBe('hello')\n-    })\n   })\n })\n "
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Flayout.tsx?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "af6114a0ef51dbb582e43c44f9c3e7ce4f5fbf50",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/app/route-with-dynamic/route.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-dynamic%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-dynamic%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-dynamic%2Froute.ts?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,5 @@\n+export const dynamic = 'force-static'\n+\n+export async function GET(request: Request) {\n+  return new Response('route GET')\n+}"
        },
        {
            "sha": "e69ecb83f626061ae28090797137b2e823c11d18",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/app/route-with-fetchcache/route.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-fetchcache%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-fetchcache%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-fetchcache%2Froute.ts?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,5 @@\n+export const fetchCache = 'force-cache'\n+\n+export async function GET(request: Request) {\n+  return new Response('route GET with fetchCache')\n+}"
        },
        {
            "sha": "76da65a6e1c4ebcf97066ffb68ca9f3ed2db44b9",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/app/route-with-revalidate/route.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-revalidate%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-revalidate%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fapp%2Froute-with-revalidate%2Froute.ts?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,5 @@\n+export const revalidate = 60\n+\n+export async function GET(request: Request) {\n+  return new Response('route GET with revalidate')\n+}"
        },
        {
            "sha": "4646d941f01dbdcf1b864c5eb08559688760685d",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/cache-components-route-handler-errors.test.ts",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fcache-components-route-handler-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fcache-components-route-handler-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fcache-components-route-handler-errors.test.ts?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,65 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import {\n+  assertHasRedbox,\n+  getRedboxDescription,\n+  getRedboxSource,\n+} from 'next-test-utils'\n+\n+describe('cache-components-route-handler-errors', () => {\n+  const { next, skipped, isNextDev, isTurbopack } = nextTestSetup({\n+    files: __dirname,\n+    skipStart: true,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it(\"should error when route handlers use segment configs that aren't supported by cacheComponents\", async () => {\n+    try {\n+      await next.start()\n+    } catch {\n+      // we expect the build to fail\n+    }\n+\n+    if (isNextDev) {\n+      // Test the first route handler with \"dynamic\" config\n+      const browser = await next.browser('/route-with-dynamic')\n+      await assertHasRedbox(browser)\n+      const redbox = {\n+        description: await getRedboxDescription(browser),\n+        source: await getRedboxSource(browser),\n+      }\n+\n+      if (isTurbopack) {\n+        expect(redbox.description).toMatchInlineSnapshot(\n+          `\"Ecmascript file had an error\"`\n+        )\n+      } else {\n+        expect(redbox.description).toMatchInlineSnapshot(\n+          `\"  x Route segment config \"dynamic\" is not compatible with \\`nextConfig.experimental.cacheComponents\\`. Please remove it.\"`\n+        )\n+      }\n+      expect(redbox.source).toContain(\n+        '\"dynamic\" is not compatible with `nextConfig.experimental.cacheComponents`. Please remove it.'\n+      )\n+    } else {\n+      // In build mode, check for all three errors in the output\n+      expect(next.cliOutput).toContain('./app/route-with-dynamic/route.ts')\n+      expect(next.cliOutput).toContain(\n+        '\"dynamic\" is not compatible with `nextConfig.experimental.cacheComponents`. Please remove it.'\n+      )\n+\n+      expect(next.cliOutput).toContain('./app/route-with-revalidate/route.ts')\n+      expect(next.cliOutput).toContain(\n+        '\"revalidate\" is not compatible with `nextConfig.experimental.cacheComponents`. Please remove it.'\n+      )\n+\n+      expect(next.cliOutput).toContain('./app/route-with-fetchcache/route.ts')\n+      expect(next.cliOutput).toContain(\n+        '\"fetchCache\" is not compatible with `nextConfig.experimental.cacheComponents`. Please remove it.'\n+      )\n+    }\n+  })\n+})"
        },
        {
            "sha": "30a826fdacc568ffb8cd6641fe15330a3c9d618d",
            "filename": "test/e2e/app-dir/cache-components-route-handler-errors/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-route-handler-errors%2Fnext.config.js?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "b51a0334f73b93d21081b9430db7ee8704506950",
            "filename": "test/experimental-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fexperimental-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f9f3afc66418f3cc6b206ee50b632f9dd4128dd5/test%2Fexperimental-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fexperimental-tests-manifest.json?ref=f9f3afc66418f3cc6b206ee50b632f9dd4128dd5",
            "patch": "@@ -140,6 +140,7 @@\n       \"test/e2e/app-dir/app/standalone-gsp.test.ts\",\n       \"test/e2e/app-dir/app/standalone.test.ts\",\n       \"test/e2e/app-dir/app/useReportWebVitals.test.ts\",\n+      \"test/e2e/app-dir/bun-externals/bun-externals.test.ts\",\n       \"test/e2e/app-dir/async-component-preload/async-component-preload.test.ts\",\n       \"test/e2e/app-dir/autoscroll-with-css-modules/index.test.ts\",\n       \"test/e2e/app-dir/back-forward-cache/back-forward-cache.test.ts\",\n@@ -268,6 +269,7 @@\n       \"test/e2e/app-dir/static-shell-debugging/static-shell-debugging.test.ts\",\n       \"test/e2e/app-dir/taint/process-taint.test.ts\",\n       \"test/e2e/app-dir/temporary-references/temporary-references.test.ts\",\n+      \"test/e2e/app-dir/typed-routes-validator/typed-routes-validator.test.ts\",\n       \"test/e2e/app-dir/unauthorized/basic/unauthorized-basic.test.ts\",\n       \"test/e2e/app-dir/unauthorized/default/unauthorized-default.test.ts\",\n       \"test/e2e/app-dir/unstable-rethrow/unstable-rethrow.test.ts\","
        }
    ],
    "stats": {
        "total": 126,
        "additions": 106,
        "deletions": 20
    }
}