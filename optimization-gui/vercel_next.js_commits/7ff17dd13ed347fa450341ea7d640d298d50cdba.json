{
    "author": "timneutkens",
    "message": "trace-build: Add missing spans (#84080)\n\n## What?\n\nFollow-up to #83949\n\nWhile testing the changes I ran Turbopack builds and all time was\ncaptured, but for webpack there was some missing time related to tracing\noutputs (Turbopack does the tracing internally). This PR adds the\nmissing spans to trace-build.",
    "sha": "7ff17dd13ed347fa450341ea7d640d298d50cdba",
    "files": [
        {
            "sha": "81e24ed1754873cb35c679cfbed880deab21b208",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 82,
            "deletions": 63,
            "changes": 145,
            "blob_url": "https://github.com/vercel/next.js/blob/7ff17dd13ed347fa450341ea7d640d298d50cdba/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ff17dd13ed347fa450341ea7d640d298d50cdba/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=7ff17dd13ed347fa450341ea7d640d298d50cdba",
            "patch": "@@ -1734,21 +1734,27 @@ export default async function build(\n                   }\n                 ) as Worker & typeof import('./collect-build-traces')\n \n-                buildTracesPromise = buildTraceWorker\n-                  .collectBuildTraces({\n-                    dir,\n-                    config,\n-                    distDir,\n-                    // Serialize Map as this is sent to the worker.\n-                    edgeRuntimeRoutes: collectRoutesUsingEdgeRuntime(new Map()),\n-                    staticPages: [],\n-                    hasSsrAmpPages: false,\n-                    buildTraceContext,\n-                    outputFileTracingRoot,\n-                  })\n-                  .catch((err) => {\n-                    console.error(err)\n-                    process.exit(1)\n+                buildTracesPromise = nextBuildSpan\n+                  .traceChild('collect-build-traces')\n+                  .traceAsyncFn(() => {\n+                    return buildTraceWorker\n+                      .collectBuildTraces({\n+                        dir,\n+                        config,\n+                        distDir,\n+                        // Serialize Map as this is sent to the worker.\n+                        edgeRuntimeRoutes: collectRoutesUsingEdgeRuntime(\n+                          new Map()\n+                        ),\n+                        staticPages: [],\n+                        hasSsrAmpPages: false,\n+                        buildTraceContext,\n+                        outputFileTracingRoot,\n+                      })\n+                      .catch((err) => {\n+                        console.error(err)\n+                        process.exit(1)\n+                      })\n                   })\n               }\n             })\n@@ -2610,20 +2616,24 @@ export default async function build(\n       await writeFunctionsConfigManifest(distDir, functionsConfigManifest)\n \n       if (!isTurbopack && !isGenerateMode && !buildTracesPromise) {\n-        buildTracesPromise = collectBuildTraces({\n-          dir,\n-          config,\n-          distDir,\n-          edgeRuntimeRoutes: collectRoutesUsingEdgeRuntime(pageInfos),\n-          staticPages: [...staticPages],\n-          nextBuildSpan,\n-          hasSsrAmpPages,\n-          buildTraceContext,\n-          outputFileTracingRoot,\n-        }).catch((err) => {\n-          console.error(err)\n-          process.exit(1)\n-        })\n+        buildTracesPromise = nextBuildSpan\n+          .traceChild('collect-build-traces')\n+          .traceAsyncFn(() => {\n+            return collectBuildTraces({\n+              dir,\n+              config,\n+              distDir,\n+              edgeRuntimeRoutes: collectRoutesUsingEdgeRuntime(pageInfos),\n+              staticPages: [...staticPages],\n+              nextBuildSpan,\n+              hasSsrAmpPages,\n+              buildTraceContext,\n+              outputFileTracingRoot,\n+            }).catch((err) => {\n+              console.error(err)\n+              process.exit(1)\n+            })\n+          })\n       }\n \n       if (serverPropsPages.size > 0 || ssgPages.size > 0) {\n@@ -4083,43 +4093,52 @@ export default async function build(\n           })\n       }\n \n-      if (config.experimental.adapterPath) {\n-        await handleBuildComplete({\n-          dir,\n-          distDir,\n-          config,\n-          staticPages,\n-          nextVersion: process.env.__NEXT_VERSION as string,\n-          tracingRoot: outputFileTracingRoot,\n-          hasNodeMiddleware,\n-          hasInstrumentationHook,\n-          adapterPath: config.experimental.adapterPath,\n-          pageKeys: pageKeys.pages,\n-          appPageKeys: denormalizedAppPages,\n-          routesManifest,\n-          prerenderManifest,\n-          middlewareManifest,\n-          functionsConfigManifest,\n-          hasStatic404: useStaticPages404,\n-          requiredServerFiles: requiredServerFilesManifest.files,\n-        })\n+      const adapterPath = config.experimental.adapterPath\n+      if (adapterPath) {\n+        await nextBuildSpan\n+          .traceChild('adapter-handle-build-complete')\n+          .traceAsyncFn(async () => {\n+            await handleBuildComplete({\n+              dir,\n+              distDir,\n+              config,\n+              staticPages,\n+              nextVersion: process.env.__NEXT_VERSION as string,\n+              tracingRoot: outputFileTracingRoot,\n+              hasNodeMiddleware,\n+              hasInstrumentationHook,\n+              adapterPath,\n+              pageKeys: pageKeys.pages,\n+              appPageKeys: denormalizedAppPages,\n+              routesManifest,\n+              prerenderManifest,\n+              middlewareManifest,\n+              functionsConfigManifest,\n+              hasStatic404: useStaticPages404,\n+              requiredServerFiles: requiredServerFilesManifest.files,\n+            })\n+          })\n       }\n \n       if (config.output === 'standalone') {\n-        await writeStandaloneDirectory(\n-          nextBuildSpan,\n-          distDir,\n-          pageKeys,\n-          denormalizedAppPages,\n-          outputFileTracingRoot,\n-          requiredServerFilesManifest,\n-          middlewareManifest,\n-          hasNodeMiddleware,\n-          hasInstrumentationHook,\n-          staticPages,\n-          loadedEnvFiles,\n-          appDir\n-        )\n+        await nextBuildSpan\n+          .traceChild('output-standalone')\n+          .traceAsyncFn(async () => {\n+            await writeStandaloneDirectory(\n+              nextBuildSpan,\n+              distDir,\n+              pageKeys,\n+              denormalizedAppPages,\n+              outputFileTracingRoot,\n+              requiredServerFilesManifest,\n+              middlewareManifest,\n+              hasNodeMiddleware,\n+              hasInstrumentationHook,\n+              staticPages,\n+              loadedEnvFiles,\n+              appDir\n+            )\n+          })\n       }\n \n       if (postBuildSpinner) postBuildSpinner.stopAndPersist()"
        },
        {
            "sha": "3265affe9d8c41161051bdddde2b49a0defb4229",
            "filename": "packages/next/src/trace/report/to-json-build.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7ff17dd13ed347fa450341ea7d640d298d50cdba/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ff17dd13ed347fa450341ea7d640d298d50cdba/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Freport%2Fto-json-build.ts?ref=7ff17dd13ed347fa450341ea7d640d298d50cdba",
            "patch": "@@ -81,8 +81,12 @@ const allowlistedEvents = new Set([\n   'run-typescript',\n   'run-eslint',\n   'static-check',\n+  'collect-build-traces',\n   'static-generation',\n   'output-export-full-static-export',\n+  'adapter-handle-build-complete',\n+  'output-standalone',\n+  'telemetry-flush',\n ])\n \n function reportToJsonBuild(event: TraceEvent) {"
        },
        {
            "sha": "7ebd023b432cac0e2ee50b615dd3c482f6b89204",
            "filename": "test/e2e/app-dir/trace-build-file/trace-build-file.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 11,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/7ff17dd13ed347fa450341ea7d640d298d50cdba/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ff17dd13ed347fa450341ea7d640d298d50cdba/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftrace-build-file%2Ftrace-build-file.test.ts?ref=7ff17dd13ed347fa450341ea7d640d298d50cdba",
            "patch": "@@ -119,19 +119,48 @@ describe('trace-build-file', () => {\n       const traceBuildPath = join(next.testDir, '.next/trace-build')\n       const traceStructure = parseTraceFile(traceBuildPath)\n \n-      const allowlistedEvents = new Set([\n-        'next-build',\n-        'run-turbopack',\n-        'run-webpack',\n-        'run-typescript',\n-        'run-eslint',\n-        'static-check',\n-        'static-generation',\n-        'output-export-full-static-export',\n-      ])\n+      // const allowlistedEvents = new Set([\n+      //   'next-build',\n+      //   'run-turbopack',\n+      //   'run-webpack',\n+      //   'run-typescript',\n+      //   'run-eslint',\n+      //   'static-check',\n+      //   'static-generation',\n+      //   'output-export-full-static-export',\n+      // ])\n+\n+      const foundEvents = new Set<string>()\n \n       for (const event of traceStructure.events) {\n-        expect(allowlistedEvents.has(event.name)).toBe(true)\n+        foundEvents.add(event.name)\n+      }\n+\n+      if (process.env.IS_TURBOPACK_TEST) {\n+        expect([...foundEvents].sort()).toMatchInlineSnapshot(`\n+                [\n+                  \"next-build\",\n+                  \"run-eslint\",\n+                  \"run-turbopack\",\n+                  \"run-typescript\",\n+                  \"static-check\",\n+                  \"static-generation\",\n+                  \"telemetry-flush\",\n+                ]\n+              `)\n+      } else {\n+        expect([...foundEvents].sort()).toMatchInlineSnapshot(`\n+         [\n+           \"collect-build-traces\",\n+           \"next-build\",\n+           \"run-eslint\",\n+           \"run-typescript\",\n+           \"run-webpack\",\n+           \"static-check\",\n+           \"static-generation\",\n+           \"telemetry-flush\",\n+         ]\n+        `)\n       }\n     })\n "
        }
    ],
    "stats": {
        "total": 200,
        "additions": 126,
        "deletions": 74
    }
}