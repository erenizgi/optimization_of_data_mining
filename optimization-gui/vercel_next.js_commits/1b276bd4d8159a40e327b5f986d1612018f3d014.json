{
    "author": "ztanner",
    "message": "fix: aliased navigations should apply scroll handling (#82900)\n\nWhen routing to the same page with different searchParams w/ a loading\nsegment, we have handling to skip RSC roundtrip and re-use the existing\nRSC data. However, this handling was missing logic that exists in\n`navigate-reducer` which sets the `scrollableSegments`. As a result, the\nrouter would stay at the existing scroll position rather than scrolling\nto the top of the page, as it would in the case of a non-aliased\nnavigation.\n\nFixes NEXT-4679",
    "sha": "1b276bd4d8159a40e327b5f986d1612018f3d014",
    "files": [
        {
            "sha": "ffa92417db896b6d5cf7576c900948fc86daad20",
            "filename": "packages/next/src/client/components/router-reducer/aliased-prefetch-navigations.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/1b276bd4d8159a40e327b5f986d1612018f3d014/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1b276bd4d8159a40e327b5f986d1612018f3d014/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts?ref=1b276bd4d8159a40e327b5f986d1612018f3d014",
            "patch": "@@ -1,10 +1,12 @@\n import type {\n   CacheNodeSeedData,\n   FlightRouterState,\n+  FlightSegmentPath,\n } from '../../../shared/lib/app-router-types'\n import type { CacheNode } from '../../../shared/lib/app-router-types'\n import {\n   addSearchParamsIfPageSegment,\n+  DEFAULT_SEGMENT_KEY,\n   PAGE_SEGMENT_KEY,\n } from '../../../shared/lib/segment'\n import type { NormalizedFlightData } from '../../flight-data-helpers'\n@@ -14,6 +16,7 @@ import { createHrefFromUrl } from './create-href-from-url'\n import { createRouterCacheKey } from './create-router-cache-key'\n import { fillCacheWithNewSubTreeDataButOnlyLoading } from './fill-cache-with-new-subtree-data'\n import { handleMutable } from './handle-mutable'\n+import { generateSegmentsFromPatch } from './reducers/navigate-reducer'\n import type { Mutable, ReadonlyReducerState } from './router-reducer-types'\n \n /**\n@@ -34,6 +37,7 @@ export function handleAliasedPrefetchEntry(\n   let currentCache = state.cache\n   const href = createHrefFromUrl(url)\n   let applied\n+  let scrollableSegments: FlightSegmentPath[] = []\n \n   if (typeof flightData === 'string') {\n     return false\n@@ -115,6 +119,20 @@ export function handleAliasedPrefetchEntry(\n       currentCache = newCache\n       applied = true\n     }\n+\n+    for (const subSegment of generateSegmentsFromPatch(treePatch)) {\n+      const scrollableSegmentPath = [\n+        ...normalizedFlightData.pathToSegment,\n+        ...subSegment,\n+      ]\n+      // Filter out the __DEFAULT__ paths as they shouldn't be scrolled to in this case.\n+      if (\n+        scrollableSegmentPath[scrollableSegmentPath.length - 1] !==\n+        DEFAULT_SEGMENT_KEY\n+      ) {\n+        scrollableSegments.push(scrollableSegmentPath)\n+      }\n+    }\n   }\n \n   if (!applied) {\n@@ -125,6 +143,7 @@ export function handleAliasedPrefetchEntry(\n   mutable.cache = currentCache\n   mutable.canonicalUrl = href\n   mutable.hashFragment = url.hash\n+  mutable.scrollableSegments = scrollableSegments\n \n   return handleMutable(state, mutable)\n }"
        },
        {
            "sha": "39063dbf8925567fe50abb02f25d490d5c0da576",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1b276bd4d8159a40e327b5f986d1612018f3d014/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1b276bd4d8159a40e327b5f986d1612018f3d014/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=1b276bd4d8159a40e327b5f986d1612018f3d014",
            "patch": "@@ -48,7 +48,7 @@ export function handleExternalUrl(\n   return handleMutable(state, mutable)\n }\n \n-function generateSegmentsFromPatch(\n+export function generateSegmentsFromPatch(\n   flightRouterPatch: FlightRouterState\n ): FlightSegmentPath[] {\n   const segments: FlightSegmentPath[] = []"
        },
        {
            "sha": "fef9fe6315f9b74ed5876233338418c62bf331e9",
            "filename": "test/e2e/app-dir/router-autoscroll/app/loading-scroll/page.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/1b276bd4d8159a40e327b5f986d1612018f3d014/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Fapp%2Floading-scroll%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1b276bd4d8159a40e327b5f986d1612018f3d014/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Fapp%2Floading-scroll%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Fapp%2Floading-scroll%2Fpage.tsx?ref=1b276bd4d8159a40e327b5f986d1612018f3d014",
            "patch": "@@ -1,9 +1,16 @@\n+import Link from 'next/link'\n+\n export const dynamic = 'force-dynamic'\n \n-export default async function Page() {\n-  await new Promise((resolve) => setTimeout(resolve, 5000))\n+export default async function Page(props: PageProps<'/loading-scroll'>) {\n+  const search = await props.searchParams\n+  const skipSleep = !!search.skipSleep\n+  if (!skipSleep) {\n+    await new Promise((resolve) => setTimeout(resolve, 5000))\n+  }\n   return (\n     <>\n+      {search.page ? <div id=\"current-page\">{search.page}</div> : null}\n       <div style={{ display: 'none' }}>Content that is hidden.</div>\n       <div id=\"content-that-is-visible\">Content which is not hidden.</div>\n       {\n@@ -12,6 +19,13 @@ export default async function Page() {\n           <div key={i}>{i}</div>\n         ))\n       }\n+      <div id=\"pages\">\n+        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((item) => (\n+          <Link key={item} href={`?page=${item}&skipSleep=1`}>\n+            {item}\n+          </Link>\n+        ))}\n+      </div>\n     </>\n   )\n }"
        },
        {
            "sha": "03379d79da82ed6bd34fa068af1999697c86c3b5",
            "filename": "test/e2e/app-dir/router-autoscroll/router-autoscroll.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/1b276bd4d8159a40e327b5f986d1612018f3d014/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Frouter-autoscroll.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1b276bd4d8159a40e327b5f986d1612018f3d014/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Frouter-autoscroll.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frouter-autoscroll%2Frouter-autoscroll.test.ts?ref=1b276bd4d8159a40e327b5f986d1612018f3d014",
            "patch": "@@ -248,5 +248,31 @@ describe('router autoscrolling on navigation', () => {\n       await browser.waitForElementByCss('#content-that-is-visible')\n       await check(() => browser.eval('window.scrollY'), 0)\n     })\n+\n+    it('should scroll to top when navigating to same page with different search params', async () => {\n+      const browser = await next.browser('/loading-scroll?skipSleep=1')\n+\n+      await retry(async () => {\n+        // scroll to the links at the bottom of the page\n+        await browser.eval(`document.getElementById(\"pages\").scrollIntoView()`)\n+\n+        // grab the current scroll position\n+        const scrollY = await browser.eval(`window.scrollY`)\n+\n+        // sanity check: we should not be scrolled to the top\n+        expect(scrollY).not.toBe(0)\n+      })\n+\n+      // click a link\n+      await browser.elementByCss(\"a[href='?page=2&skipSleep=1']\").click()\n+\n+      // assert the new page id has been committed\n+      expect(await browser.elementById('current-page').text()).toBe('2')\n+\n+      await retry(async () => {\n+        // we should have scrolled to the top\n+        expect(await browser.eval(`window.scrollY`)).toBe(0)\n+      })\n+    })\n   })\n })"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 62,
        "deletions": 3
    }
}