{
    "author": "wyattjoh",
    "message": "[ppr] Narrow condition for fallback shell generation at runtime (#79565)\n\nThis addresses a bug where a fallback shell was generated at runtime\nwhen it was not expected to do so. This was an issue with how the\n`x-now-route-matches` header was parsed and was incorrectly assuming\nthat a falsy header was the same as comparing it to a string. This\ncorrectly only generates the fallback shell if the header is present and\nwas an empty string as was sent by Vercel.\n\nCo-authored-by: Hendrik Liebau <mail@hendrik-liebau.de>",
    "sha": "e0d4df2180111bcb1511fc08d40d4c1b237326dd",
    "files": [
        {
            "sha": "12493bb3b955e5f23efea093d85d425582ebf3c5",
            "filename": ".changeset/giant-bushes-sink.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e0d4df2180111bcb1511fc08d40d4c1b237326dd/.changeset%2Fgiant-bushes-sink.md",
            "raw_url": "https://github.com/vercel/next.js/raw/e0d4df2180111bcb1511fc08d40d4c1b237326dd/.changeset%2Fgiant-bushes-sink.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fgiant-bushes-sink.md?ref=e0d4df2180111bcb1511fc08d40d4c1b237326dd",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'next': patch\n+---\n+\n+Resolved bug where hitting the parameterized path directly would cause a fallback shell generation instead of just rendering the route with the parameterized placeholders."
        },
        {
            "sha": "9f7be56c1c0148f3bdf361dbba5d7fcc3b1673e6",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/e0d4df2180111bcb1511fc08d40d4c1b237326dd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e0d4df2180111bcb1511fc08d40d4c1b237326dd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=e0d4df2180111bcb1511fc08d40d4c1b237326dd",
            "patch": "@@ -1346,19 +1346,24 @@ export default abstract class Server<\n               }\n             }\n \n-            // handle the actual dynamic route name being requested\n+            // If the pathname being requested is the same as the source\n+            // pathname, and we don't have valid params, we want to use the\n+            // default route matches.\n             if (\n               utils.defaultRouteMatches &&\n               normalizedUrlPath === srcPathname &&\n-              !paramsResult.hasValidParams &&\n-              !utils.normalizeDynamicRouteParams({ ...params }, true)\n-                .hasValidParams\n+              !paramsResult.hasValidParams\n             ) {\n               params = utils.defaultRouteMatches\n \n-              // Mark that the default route matches were set on the request\n-              // during routing.\n-              addRequestMeta(req, 'didSetDefaultRouteMatches', true)\n+              // If the route matches header is an empty string, we want to\n+              // render a fallback shell. This is because we know this came from\n+              // a prerender (it has the header) but it's values were filtered\n+              // out (because the allowQuery was empty). If it was undefined\n+              // then we know that the request is hitting the lambda directly.\n+              if (routeMatchesHeader === '') {\n+                addRequestMeta(req, 'renderFallbackShell', true)\n+              }\n             }\n \n             if (params) {\n@@ -3223,8 +3228,7 @@ export default abstract class Server<\n       const fallbackRouteParams =\n         isDynamic &&\n         isRoutePPREnabled &&\n-        (getRequestMeta(req, 'didSetDefaultRouteMatches') ||\n-          isDebugFallbackShell)\n+        (getRequestMeta(req, 'renderFallbackShell') || isDebugFallbackShell)\n           ? getFallbackRouteParams(pathname)\n           : null\n "
        },
        {
            "sha": "9f116ad6dbe2ce759b888a3368dacf859d4ac1fe",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e0d4df2180111bcb1511fc08d40d4c1b237326dd/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e0d4df2180111bcb1511fc08d40d4c1b237326dd/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=e0d4df2180111bcb1511fc08d40d4c1b237326dd",
            "patch": "@@ -153,9 +153,9 @@ export interface RequestMeta {\n   middlewareInvoke?: boolean\n \n   /**\n-   * Whether the default route matches were set on the request during routing.\n+   * Whether the request should render the fallback shell or not.\n    */\n-  didSetDefaultRouteMatches?: boolean\n+  renderFallbackShell?: boolean\n \n   /**\n    * Whether the request is for the custom error page."
        },
        {
            "sha": "cfc4ce7ece8b11ad807a29242145404b17a5a1e3",
            "filename": "test/e2e/app-dir/empty-fallback-shells/empty-fallback-shells.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/e0d4df2180111bcb1511fc08d40d4c1b237326dd/test%2Fe2e%2Fapp-dir%2Fempty-fallback-shells%2Fempty-fallback-shells.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e0d4df2180111bcb1511fc08d40d4c1b237326dd/test%2Fe2e%2Fapp-dir%2Fempty-fallback-shells%2Fempty-fallback-shells.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fempty-fallback-shells%2Fempty-fallback-shells.test.ts?ref=e0d4df2180111bcb1511fc08d40d4c1b237326dd",
            "patch": "@@ -118,6 +118,23 @@ describe('empty-fallback-shells', () => {\n             expect(res.headers.get('x-nextjs-postponed')).not.toBe('1')\n           }\n         })\n+\n+        it('does not render a fallback shell when using a params placeholder', async () => {\n+          // This should trigger a blocking prerender of the route shell.\n+          const res = await next.fetch(\n+            '/with-cached-io/without-suspense/params-in-page/[slug]'\n+          )\n+\n+          expect(res.status).toBe(200)\n+\n+          const html = await res.text()\n+\n+          // This should render the encoded param in the route shell, and not\n+          // interpret the param as a fallback param, and subsequently try to\n+          // render the fallback shell instead, which would fail because of the\n+          // missing parent suspense boundary.\n+          expect(html).toContain('page-%5Bslug%5D')\n+        })\n       })\n \n       describe('and the params accessed in a cached non-page function', () => {"
        },
        {
            "sha": "bf976bf76b0cd870c74585589c0188f8f8e9a376",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-ppr.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e0d4df2180111bcb1511fc08d40d4c1b237326dd/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e0d4df2180111bcb1511fc08d40d4c1b237326dd/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts?ref=e0d4df2180111bcb1511fc08d40d4c1b237326dd",
            "patch": "@@ -355,6 +355,7 @@ describe('required server files app router', () => {\n         'x-matched-path': '/postpone/isr/[slug]',\n         // We don't include the `x-now-route-matches` header because we want to\n         // test that the fallback route params are correctly set.\n+        'x-now-route-matches': '',\n       },\n     })\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 38,
        "deletions": 11
    }
}