{
    "author": "lubieowoce",
    "message": "test: fix more Runtime/Recoverable Error flakiness in HMR (#79371)\n\nFollow-up to #79254, there's one more test flaking with the same issue.\n\nI pulled the label-ignoring logic out into\n\n```ts\nexpect(browser).toDisplayRedbox('...', { label: false })\n```\n\nso that it's easy to find these later when we fix the underlying issue.",
    "sha": "04bfbdab6e299ba049fb98ec96b57986554e8ab4",
    "files": [
        {
            "sha": "1b4596538e757765aa5cea6b2aace501057d13c6",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=04bfbdab6e299ba049fb98ec96b57986554e8ab4",
            "patch": "@@ -1279,19 +1279,24 @@ describe('ReactRefreshLogBox app', () => {\n     )\n     const { session, browser } = sandbox\n \n-    await expect(browser).toDisplayRedbox(`\n+    await expect(browser).toDisplayRedbox(\n+      `\n      {\n        \"description\": \"Server component error\",\n        \"environmentLabel\": \"Server\",\n-       \"label\": \"Runtime Error\",\n+       \"label\": \"<FIXME-excluded-label>\",\n        \"source\": \"app/page.js (2:9) @ Page\n      > 2 |   throw new Error('Server component error')\n          |         ^\",\n        \"stack\": [\n          \"Page app/page.js (2:9)\",\n        ],\n      }\n-    `)\n+    `,\n+\n+      // FIXME: `label` is flaking between \"Runtime Error\" and \"Recoverable Error\"\n+      { label: false }\n+    )\n \n     // Remove error\n     await session.patch(\n@@ -1318,19 +1323,24 @@ describe('ReactRefreshLogBox app', () => {\n       `\n     )\n \n-    await expect(browser).toDisplayRedbox(`\n+    await expect(browser).toDisplayRedbox(\n+      `\n      {\n        \"description\": \"Server component error!\",\n        \"environmentLabel\": \"Server\",\n-       \"label\": \"Runtime Error\",\n+       \"label\": \"<FIXME-excluded-label>\",\n        \"source\": \"app/page.js (2:9) @ Page\n      > 2 |   throw new Error('Server component error!')\n          |         ^\",\n        \"stack\": [\n          \"Page app/page.js (2:9)\",\n        ],\n      }\n-    `)\n+    `,\n+\n+      // FIXME: `label` is flaking between \"Runtime Error\" and \"Recoverable Error\"\n+      { label: false }\n+    )\n   })\n \n   test('Import trace when module not found in layout', async () => {"
        },
        {
            "sha": "85f51821507e9d4a80f30e7df1eca88432ff784c",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 57,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=04bfbdab6e299ba049fb98ec96b57986554e8ab4",
            "patch": "@@ -1,14 +1,7 @@\n /* eslint-env jest */\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  check,\n-  getRedboxCallStack,\n-  getRedboxDescription,\n-  getRedboxEnvironmentLabel,\n-  getRedboxSource,\n-} from 'next-test-utils'\n+import { check } from 'next-test-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n \n@@ -382,55 +375,25 @@ describe('Error recovery app', () => {\n         `\n     )\n \n-    {\n-      // FIXME: `label` is flaking between \"Runtime Error\" and \"Recoverable Error\",\n-      // so we have to snapshot the redbox manually we figure out why\n-\n-      // await expect(browser).toDisplayRedbox(`\n-      //  {\n-      //    \"description\": \"oops\",\n-      //    \"environmentLabel\": \"Server\",\n-      //    \"label\": \"Recoverable Error\",\n-      //    \"source\": \"child.js (3:9) @ Child\n-      //  > 3 |   throw new Error('oops')\n-      //      |         ^\",\n-      //    \"stack\": [\n-      //      \"Child child.js (3:9)\",\n-      //      \"Page app/server/page.js (3:10)\",\n-      //    ],\n-      //  }\n-      // `)\n-\n-      await assertHasRedbox(browser)\n-      const redbox = await Promise.all([\n-        getRedboxDescription(browser),\n-        getRedboxEnvironmentLabel(browser),\n-        getRedboxSource(browser),\n-        getRedboxCallStack(browser),\n-      ]).then(([description, environmentLabel, source, stack]) => ({\n-        description,\n-        environmentLabel,\n-        source,\n-        stack,\n-      }))\n-      expect(redbox).toMatchInlineSnapshot(`\n-      {\n-        \"description\": \"oops\",\n-        \"environmentLabel\": \"Server\",\n-        \"source\": \"child.js (3:9) @ Child\n-\n-        1 | // hello\n-        2 | export default function Child() {\n-      > 3 |   throw new Error('oops')\n-          |         ^\n-        4 | }\",\n-        \"stack\": [\n-          \"Child child.js (3:9)\",\n-          \"Page app/server/page.js (3:10)\",\n-        ],\n-      }\n-      `)\n-    }\n+    await expect(browser).toDisplayRedbox(\n+      `\n+     {\n+       \"description\": \"oops\",\n+       \"environmentLabel\": \"Server\",\n+       \"label\": \"<FIXME-excluded-label>\",\n+       \"source\": \"child.js (3:9) @ Child\n+     > 3 |   throw new Error('oops')\n+         |         ^\",\n+       \"stack\": [\n+         \"Child child.js (3:9)\",\n+         \"Page app/server/page.js (3:10)\",\n+       ],\n+     }\n+    `,\n+\n+      // FIXME: `label` is flaking between \"Runtime Error\" and \"Recoverable Error\"\n+      { label: false }\n+    )\n \n     // TODO-APP: re-enable when error recovery doesn't reload the page.\n     /* const didNotReload = */ await session.patch("
        },
        {
            "sha": "a0f3f1426eceb6a77d838b9f84ec441fc0c182bf",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 11,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04bfbdab6e299ba049fb98ec96b57986554e8ab4/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=04bfbdab6e299ba049fb98ec96b57986554e8ab4",
            "patch": "@@ -37,7 +37,10 @@ declare global {\n        *\n        * @param inlineSnapshot - The snapshot to compare against.\n        */\n-      toDisplayRedbox(inlineSnapshot?: string): Promise<void>\n+      toDisplayRedbox(\n+        inlineSnapshot?: string,\n+        opts?: ErrorSnapshotOptions\n+      ): Promise<void>\n \n       /**\n        * Inline snapshot matcher for a Redbox that's collapsed by default.\n@@ -57,11 +60,18 @@ declare global {\n        *\n        * @param inlineSnapshot - The snapshot to compare against.\n        */\n-      toDisplayCollapsedRedbox(inlineSnapshot?: string): Promise<void>\n+      toDisplayCollapsedRedbox(\n+        inlineSnapshot?: string,\n+        opts?: ErrorSnapshotOptions\n+      ): Promise<void>\n     }\n   }\n }\n \n+interface ErrorSnapshotOptions {\n+  label?: boolean\n+}\n+\n interface ErrorSnapshot {\n   environmentLabel: string | null\n   label: string | null\n@@ -73,11 +83,12 @@ interface ErrorSnapshot {\n \n async function createErrorSnapshot(\n   browser: Playwright,\n-  next: NextInstance | null\n+  next: NextInstance | null,\n+  { label: includeLabel = true }: ErrorSnapshotOptions = {}\n ): Promise<ErrorSnapshot> {\n   const [label, environmentLabel, description, source, stack, componentStack] =\n     await Promise.all([\n-      getRedboxLabel(browser),\n+      includeLabel ? getRedboxLabel(browser) : null,\n       getRedboxEnvironmentLabel(browser),\n       getRedboxDescription(browser),\n       getRedboxSource(browser),\n@@ -155,7 +166,7 @@ async function createErrorSnapshot(\n \n   const snapshot: ErrorSnapshot = {\n     environmentLabel,\n-    label,\n+    label: label ?? '<FIXME-excluded-label>',\n     description:\n       description !== null && next !== null\n         ? description.replace(next.testDir, '<FIXME-project-root>')\n@@ -182,13 +193,14 @@ type RedboxSnapshot = ErrorSnapshot | ErrorSnapshot[]\n \n async function createRedboxSnapshot(\n   browser: Playwright,\n-  next: NextInstance | null\n+  next: NextInstance | null,\n+  opts?: ErrorSnapshotOptions\n ): Promise<RedboxSnapshot> {\n   const errorTally = await getRedboxTotalErrorCount(browser)\n   const errorSnapshots: ErrorSnapshot[] = []\n \n   for (let errorIndex = 0; errorIndex < errorTally; errorIndex++) {\n-    const errorSnapshot = await createErrorSnapshot(browser, next)\n+    const errorSnapshot = await createErrorSnapshot(browser, next, opts)\n     errorSnapshots.push(errorSnapshot)\n \n     if (errorIndex < errorTally - 1) {\n@@ -214,7 +226,8 @@ expect.extend({\n   async toDisplayRedbox(\n     this: MatcherContext,\n     browserOrContext: Playwright | { browser: Playwright; next: NextInstance },\n-    expectedRedboxSnapshot?: string\n+    expectedRedboxSnapshot?: string,\n+    opts?: ErrorSnapshotOptions\n   ) {\n     let browser: Playwright\n     let next: NextInstance | null\n@@ -250,7 +263,7 @@ expect.extend({\n       }\n     }\n \n-    const redbox = await createRedboxSnapshot(browser, next)\n+    const redbox = await createRedboxSnapshot(browser, next, opts)\n \n     // argument length is relevant.\n     // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n@@ -263,7 +276,8 @@ expect.extend({\n   async toDisplayCollapsedRedbox(\n     this: MatcherContext,\n     browserOrContext: Playwright | { browser: Playwright; next: NextInstance },\n-    expectedRedboxSnapshot?: string\n+    expectedRedboxSnapshot?: string,\n+    opts?: ErrorSnapshotOptions\n   ) {\n     let browser: Playwright\n     let next: NextInstance | null\n@@ -306,7 +320,7 @@ expect.extend({\n       }\n     }\n \n-    const redbox = await createRedboxSnapshot(browser, next)\n+    const redbox = await createRedboxSnapshot(browser, next, opts)\n \n     // argument length is relevant.\n     // Jest will update absent snapshots but fail if you specify a snapshot even if undefined."
        }
    ],
    "stats": {
        "total": 135,
        "additions": 61,
        "deletions": 74
    }
}