{
    "author": "timneutkens",
    "message": "Build: Add time to logline of every step (#84602)\n\n## What?\n\nAdd timing to every step of the `next build` process for both Turbopack\nand webpack.\n\nBesides the existing `compiled successfully in` time for\nTurbopack/webpack these now also have timings:\n\n```\n ✓ Linting and checking validity of types in 954ms    \n ✓ Collecting page data in 205ms    \n ✓ Generating static pages (4/4) in 307ms\n ✓ Collecting build traces in 3.3s    \n ✓ Finalizing page optimization in 3.3s \n```",
    "sha": "cb92e8dfbba419c03a9b539b6071c66a508cb922",
    "files": [
        {
            "sha": "5e145605d677800f5528400f88c7d9c9e52947ed",
            "filename": "packages/next/src/build/duration-to-string.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts?ref=cb92e8dfbba419c03a9b539b6071c66a508cb922",
            "patch": "@@ -11,3 +11,12 @@ export function durationToString(compilerDuration: number) {\n   }\n   return durationString\n }\n+\n+export function hrtimeToSeconds(hrtime: [number, number]): number {\n+  // hrtime is a tuple of [seconds, nanoseconds]\n+  return hrtime[0] + hrtime[1] / 1e9\n+}\n+\n+export function hrtimeDurationToString(hrtime: [number, number]): string {\n+  return durationToString(hrtimeToSeconds(hrtime))\n+}"
        },
        {
            "sha": "796f3c506afd17ad31ebb1b9e85631dc7a614304",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=cb92e8dfbba419c03a9b539b6071c66a508cb922",
            "patch": "@@ -209,7 +209,7 @@ import { turbopackBuild } from './turbopack-build'\n import { isPersistentCachingEnabledForBuild } from '../shared/lib/turbopack/utils'\n import { inlineStaticEnv } from '../lib/inline-static-env'\n import { populateStaticEnv } from '../lib/static-env'\n-import { durationToString } from './duration-to-string'\n+import { durationToString, hrtimeDurationToString } from './duration-to-string'\n import { traceGlobals } from '../trace/shared'\n import { extractNextErrorCode } from '../lib/error-telemetry-utils'\n import { runAfterProductionCompile } from './after-production-compile'\n@@ -1846,6 +1846,7 @@ export default async function build(\n         traceMemoryUsage('Finished type checking', nextBuildSpan)\n       }\n \n+      const collectingPageDataStart = process.hrtime()\n       const postCompileSpinner = createSpinner('Collecting page data')\n \n       const buildManifestPath = path.join(distDir, BUILD_MANIFEST)\n@@ -2413,7 +2414,13 @@ export default async function build(\n         return returnValue\n       })\n \n-      if (postCompileSpinner) postCompileSpinner.stopAndPersist()\n+      if (postCompileSpinner) {\n+        const collectingPageDataEnd = process.hrtime(collectingPageDataStart)\n+        postCompileSpinner.setText(\n+          `Collecting page data in ${hrtimeDurationToString(collectingPageDataEnd)}`\n+        )\n+        postCompileSpinner.stopAndPersist()\n+      }\n       traceMemoryUsage('Finished collecting page data', nextBuildSpan)\n \n       if (customAppGetInitialProps) {\n@@ -3890,9 +3897,12 @@ export default async function build(\n           .traceAsyncFn(() => writeManifest(routesManifestPath, routesManifest))\n       }\n \n+      const finalizingPageOptimizationStart = process.hrtime()\n       const postBuildSpinner = createSpinner('Finalizing page optimization')\n       let buildTracesSpinner\n+      let buildTracesStart\n       if (buildTracesPromise) {\n+        buildTracesStart = process.hrtime()\n         buildTracesSpinner = createSpinner('Collecting build traces')\n       }\n \n@@ -4044,6 +4054,12 @@ export default async function build(\n       await buildTracesPromise\n \n       if (buildTracesSpinner) {\n+        if (buildTracesStart) {\n+          const buildTracesEnd = process.hrtime(buildTracesStart)\n+          buildTracesSpinner.setText(\n+            `Collecting build traces in ${hrtimeDurationToString(buildTracesEnd)}`\n+          )\n+        }\n         buildTracesSpinner.stopAndPersist()\n         buildTracesSpinner = undefined\n       }\n@@ -4117,7 +4133,15 @@ export default async function build(\n           })\n       }\n \n-      if (postBuildSpinner) postBuildSpinner.stopAndPersist()\n+      if (postBuildSpinner) {\n+        const finalizingPageOptimizationEnd = process.hrtime(\n+          finalizingPageOptimizationStart\n+        )\n+        postBuildSpinner.setText(\n+          `Finalizing page optimization in ${hrtimeDurationToString(finalizingPageOptimizationEnd)}`\n+        )\n+        postBuildSpinner.stopAndPersist()\n+      }\n       console.log()\n \n       if (debugOutput) {"
        },
        {
            "sha": "273b6e5cc8cd93f477cd7ede12cf3c5bc7d38ebd",
            "filename": "packages/next/src/build/progress.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fprogress.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fprogress.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fprogress.ts?ref=cb92e8dfbba419c03a9b539b6071c66a508cb922",
            "patch": "@@ -1,4 +1,5 @@\n import * as Log from '../build/output/log'\n+import { hrtimeDurationToString } from './duration-to-string'\n import createSpinner from './spinner'\n \n function divideSegments(number: number, segments: number): number[] {\n@@ -15,6 +16,8 @@ function divideSegments(number: number, segments: number): number[] {\n }\n \n export const createProgress = (total: number, label: string) => {\n+  const progressStart = process.hrtime()\n+\n   const segments = divideSegments(total, 4)\n \n   if (total === 0) {\n@@ -74,7 +77,8 @@ export const createProgress = (total: number, label: string) => {\n     } else {\n       progressSpinner?.stop()\n       if (isFinished) {\n-        Log.event(message)\n+        const progressEnd = process.hrtime(progressStart)\n+        Log.event(`${message} in ${hrtimeDurationToString(progressEnd)}`)\n       } else {\n         Log.info(`${message} ${process.stdout.isTTY ? '\\n' : '\\r'}`)\n       }"
        },
        {
            "sha": "54d09df7c7108c1679e872268a4ca80fc8f30bf5",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=cb92e8dfbba419c03a9b539b6071c66a508cb922",
            "patch": "@@ -9,6 +9,7 @@ import { verifyAndLint } from '../lib/verifyAndLint'\n import createSpinner from './spinner'\n import { eventTypeCheckCompleted } from '../telemetry/events'\n import isError from '../lib/is-error'\n+import { hrtimeDurationToString } from './duration-to-string'\n \n /**\n  * typescript will be loaded in \"next/lib/verify-typescript-setup\" and\n@@ -156,7 +157,13 @@ export async function startTypeChecking({\n           )\n         }),\n     ])\n-    typeCheckingAndLintingSpinner?.stopAndPersist()\n+\n+    if (typeCheckingAndLintingSpinner) {\n+      typeCheckingAndLintingSpinner.setText(\n+        `${typeCheckingAndLintingSpinnerPrefixText} in ${hrtimeDurationToString(typeCheckEnd)}`\n+      )\n+      typeCheckingAndLintingSpinner.stopAndPersist()\n+    }\n \n     if (!ignoreTypeScriptErrors && verifyResult) {\n       telemetry.record("
        },
        {
            "sha": "6aee66ab5d80edd2a7614e2c90613faca178515a",
            "filename": "packages/next/src/build/webpack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb92e8dfbba419c03a9b539b6071c66a508cb922/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts?ref=cb92e8dfbba419c03a9b539b6071c66a508cb922",
            "patch": "@@ -40,15 +40,10 @@ import type { UnwrapPromise } from '../../lib/coalesced-function'\n \n import origDebug from 'next/dist/compiled/debug'\n import { Telemetry } from '../../telemetry/storage'\n-import { durationToString } from '../duration-to-string'\n+import { durationToString, hrtimeToSeconds } from '../duration-to-string'\n \n const debug = origDebug('next:build:webpack-build')\n \n-function hrtimeToSeconds(hrtime: [number, number]): number {\n-  // hrtime is a tuple of [seconds, nanoseconds]\n-  return hrtime[0] + hrtime[1] / 1e9\n-}\n-\n type CompilerResult = {\n   errors: webpack.StatsError[]\n   warnings: webpack.StatsError[]"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 50,
        "deletions": 11
    }
}