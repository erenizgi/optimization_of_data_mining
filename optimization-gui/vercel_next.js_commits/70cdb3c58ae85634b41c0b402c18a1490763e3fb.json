{
    "author": "unstubbable",
    "message": "Replace tuples with better suited data structures for server references (#86294)\n\nThis PR introduces the `ServerReferenceExport` struct to replace `(Ident, Atom, Atom)` tuples for tracking exported server references. It also replaces the `Vec<(Atom, Atom)>` `export_actions` with an `FxIndexMap` for `reference_ids_by_export_name`, enabling more efficient lookups in upstack PRs. There are no functional changes.",
    "sha": "70cdb3c58ae85634b41c0b402c18a1490763e3fb",
    "files": [
        {
            "sha": "e232172b1a898eb3824fac8a4dd8a19c01944b66",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 134,
            "deletions": 112,
            "changes": 246,
            "blob_url": "https://github.com/vercel/next.js/blob/70cdb3c58ae85634b41c0b402c18a1490763e3fb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/70cdb3c58ae85634b41c0b402c18a1490763e3fb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=70cdb3c58ae85634b41c0b402c18a1490763e3fb",
            "patch": "@@ -70,6 +70,12 @@ enum ThisStatus {\n     Forbidden { directive: Directive },\n }\n \n+struct ServerReferenceExport {\n+    ident: Ident,\n+    export_name: Atom,\n+    reference_id: Atom,\n+}\n+\n #[derive(Clone, Debug)]\n enum ServerActionsErrorKind {\n     ExportedSyncFunction {\n@@ -130,10 +136,6 @@ enum ServerActionsErrorKind {\n     },\n }\n \n-/// A mapping of hashed action id to the action's exported function name.\n-// Using BTreeMap to ensure the order of the actions is deterministic.\n-pub type ActionsMap = BTreeMap<Atom, Atom>;\n-\n #[tracing::instrument(level = tracing::Level::TRACE, skip_all)]\n pub fn server_actions<C: Comments>(\n     file_name: &FileName,\n@@ -169,8 +171,6 @@ pub fn server_actions<C: Comments>(\n         names: Default::default(),\n         declared_idents: Default::default(),\n \n-        exported_idents: Default::default(),\n-\n         // This flag allows us to rewrite `function foo() {}` to `const foo = createProxy(...)`.\n         rewrite_fn_decl_to_proxy_decl: None,\n         rewrite_default_fn_expr_to_proxy_expr: None,\n@@ -179,7 +179,8 @@ pub fn server_actions<C: Comments>(\n         annotations: Default::default(),\n         extra_items: Default::default(),\n         hoisted_extra_items: Default::default(),\n-        export_actions: Default::default(),\n+        reference_ids_by_export_name: Default::default(),\n+        server_reference_exports: Default::default(),\n \n         private_ctxt: SyntaxContext::empty().apply_mark(Mark::new()),\n \n@@ -190,18 +191,22 @@ pub fn server_actions<C: Comments>(\n     })\n }\n \n-/// Serializes the Server Actions into a magic comment prefixed by\n+/// Serializes the Server References into a magic comment prefixed by\n /// `__next_internal_action_entry_do_not_use__`.\n-fn generate_server_actions_comment(\n-    actions: &ActionsMap,\n+fn generate_server_references_comment(\n+    export_names_ordered_by_reference_id: &BTreeMap<&Atom, &Atom>,\n     entry_path_query: Option<(&str, &str)>,\n ) -> String {\n     format!(\n         \" __next_internal_action_entry_do_not_use__ {} \",\n         if let Some(entry_path_query) = entry_path_query {\n-            serde_json::to_string(&(actions, entry_path_query.0, entry_path_query.1))\n+            serde_json::to_string(&(\n+                export_names_ordered_by_reference_id,\n+                entry_path_query.0,\n+                entry_path_query.1,\n+            ))\n         } else {\n-            serde_json::to_string(&actions)\n+            serde_json::to_string(&export_names_ordered_by_reference_id)\n         }\n         .unwrap()\n     )\n@@ -239,16 +244,15 @@ struct ServerActions<C: Comments> {\n     rewrite_default_fn_expr_to_proxy_expr: Option<Box<Expr>>,\n     rewrite_expr_to_proxy_expr: Option<Box<Expr>>,\n \n-    exported_idents: Vec<(\n-        /* ident */ Ident,\n-        /* name */ Atom,\n-        /* id */ Atom,\n-    )>,\n-\n     annotations: Vec<Stmt>,\n     extra_items: Vec<ModuleItem>,\n     hoisted_extra_items: Vec<ModuleItem>,\n-    export_actions: Vec<(/* name */ Atom, /* id */ Atom)>,\n+\n+    /// A map of all server references (inline + exported): export_name -> reference_id\n+    reference_ids_by_export_name: FxIndexMap<Atom, Atom>,\n+\n+    /// A list of server references for originally exported server functions only.\n+    server_reference_exports: Vec<ServerReferenceExport>,\n \n     private_ctxt: SyntaxContext,\n \n@@ -460,8 +464,8 @@ impl<C: Comments> ServerActions<C> {\n         let action_id = self.generate_server_reference_id(&action_name, false, Some(&new_params));\n \n         self.has_action = true;\n-        self.export_actions\n-            .push((action_name.clone(), action_id.clone()));\n+        self.reference_ids_by_export_name\n+            .insert(action_name.clone(), action_id.clone());\n \n         if let BlockStmtOrExpr::BlockStmt(block) = &mut *arrow.body {\n             block.visit_mut_with(&mut ClosureReplacer {\n@@ -612,8 +616,8 @@ impl<C: Comments> ServerActions<C> {\n         let action_id = self.generate_server_reference_id(&action_name, false, Some(&new_params));\n \n         self.has_action = true;\n-        self.export_actions\n-            .push((action_name.clone(), action_id.clone()));\n+        self.reference_ids_by_export_name\n+            .insert(action_name.clone(), action_id.clone());\n \n         function.body.visit_mut_with(&mut ClosureReplacer {\n             used_ids: &ids_from_closure,\n@@ -742,8 +746,8 @@ impl<C: Comments> ServerActions<C> {\n         let reference_id = self.generate_server_reference_id(&export_name, true, Some(&new_params));\n \n         self.has_cache = true;\n-        self.export_actions\n-            .push((export_name.clone(), reference_id.clone()));\n+        self.reference_ids_by_export_name\n+            .insert(export_name.clone(), reference_id.clone());\n \n         if let BlockStmtOrExpr::BlockStmt(block) = &mut *arrow.body {\n             block.visit_mut_with(&mut ClosureReplacer {\n@@ -826,8 +830,8 @@ impl<C: Comments> ServerActions<C> {\n         let reference_id = self.generate_server_reference_id(&cache_name, true, Some(&new_params));\n \n         self.has_cache = true;\n-        self.export_actions\n-            .push((cache_name.clone(), reference_id.clone()));\n+        self.reference_ids_by_export_name\n+            .insert(cache_name.clone(), reference_id.clone());\n \n         function.body.visit_mut_with(&mut ClosureReplacer {\n             used_ids: &ids_from_closure,\n@@ -1419,7 +1423,7 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                 let (is_action_fn, is_cache_fn) =\n                                     has_body_directive(&f.function.body);\n \n-                                let ref_id = if is_action_fn {\n+                                let is_cache = if is_action_fn {\n                                     false\n                                 } else if is_cache_fn {\n                                     true\n@@ -1433,15 +1437,15 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                 // TODO(shu): This is a workaround. We should have a better way\n                                 // to skip self-annotated exports here.\n                                 if !(is_cache_fn && self.config.is_react_server_layer) {\n-                                    self.exported_idents.push((\n-                                        f.ident.clone(),\n-                                        f.ident.sym.clone(),\n-                                        self.generate_server_reference_id(\n+                                    self.server_reference_exports.push(ServerReferenceExport {\n+                                        ident: f.ident.clone(),\n+                                        export_name: f.ident.sym.clone(),\n+                                        reference_id: self.generate_server_reference_id(\n                                             f.ident.sym.as_ref(),\n-                                            ref_id,\n+                                            is_cache,\n                                             Some(&f.function.params),\n                                         ),\n-                                    ));\n+                                    });\n                                 }\n                             }\n                             Decl::Var(var) => {\n@@ -1450,15 +1454,15 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                 collect_idents_in_var_decls(&var.decls, &mut idents);\n \n                                 for ident in &idents {\n-                                    self.exported_idents.push((\n-                                        ident.clone(),\n-                                        ident.sym.clone(),\n-                                        self.generate_server_reference_id(\n+                                    self.server_reference_exports.push(ServerReferenceExport {\n+                                        ident: ident.clone(),\n+                                        export_name: ident.sym.clone(),\n+                                        reference_id: self.generate_server_reference_id(\n                                             ident.sym.as_ref(),\n                                             in_cache_file,\n                                             None,\n                                         ),\n-                                    ));\n+                                    });\n                                 }\n \n                                 for decl in &mut var.decls {\n@@ -1505,40 +1509,49 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                                 }) = export_name\n                                                 {\n                                                     // export { foo as bar }\n-                                                    self.exported_idents.push((\n-                                                        ident.clone(),\n-                                                        sym.clone(),\n-                                                        self.generate_server_reference_id(\n-                                                            sym.as_ref(),\n-                                                            in_cache_file,\n-                                                            None,\n-                                                        ),\n-                                                    ));\n+                                                    self.server_reference_exports.push(\n+                                                        ServerReferenceExport {\n+                                                            ident: ident.clone(),\n+                                                            export_name: sym.clone(),\n+                                                            reference_id: self\n+                                                                .generate_server_reference_id(\n+                                                                    sym.as_ref(),\n+                                                                    in_cache_file,\n+                                                                    None,\n+                                                                ),\n+                                                        },\n+                                                    );\n                                                 } else if let ModuleExportName::Str(str) =\n                                                     export_name\n                                                 {\n                                                     // export { foo as \"bar\" }\n-                                                    self.exported_idents.push((\n-                                                        ident.clone(),\n-                                                        str.value.clone(),\n-                                                        self.generate_server_reference_id(\n-                                                            str.value.as_ref(),\n-                                                            in_cache_file,\n-                                                            None,\n-                                                        ),\n-                                                    ));\n+                                                    self.server_reference_exports.push(\n+                                                        ServerReferenceExport {\n+                                                            ident: ident.clone(),\n+                                                            export_name: str.value.clone(),\n+                                                            reference_id: self\n+                                                                .generate_server_reference_id(\n+                                                                    str.value.as_ref(),\n+                                                                    in_cache_file,\n+                                                                    None,\n+                                                                ),\n+                                                        },\n+                                                    );\n                                                 }\n                                             } else {\n                                                 // export { foo }\n-                                                self.exported_idents.push((\n-                                                    ident.clone(),\n-                                                    ident.sym.clone(),\n-                                                    self.generate_server_reference_id(\n-                                                        ident.sym.as_ref(),\n-                                                        in_cache_file,\n-                                                        None,\n-                                                    ),\n-                                                ));\n+                                                self.server_reference_exports.push(\n+                                                    ServerReferenceExport {\n+                                                        ident: ident.clone(),\n+                                                        export_name: ident.sym.clone(),\n+                                                        reference_id: self\n+                                                            .generate_server_reference_id(\n+                                                                ident.sym.as_ref(),\n+                                                                in_cache_file,\n+                                                                None,\n+                                                            ),\n+                                                    },\n+                                                );\n                                             }\n                                         }\n                                     } else {\n@@ -1577,11 +1590,11 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n \n                                 if let Some(ident) = &f.ident {\n                                     // export default function foo() {}\n-                                    self.exported_idents.push((\n-                                        ident.clone(),\n-                                        atom!(\"default\"),\n-                                        ref_id,\n-                                    ));\n+                                    self.server_reference_exports.push(ServerReferenceExport {\n+                                        ident: ident.clone(),\n+                                        export_name: atom!(\"default\"),\n+                                        reference_id: ref_id,\n+                                    });\n                                 } else {\n                                     // export default function() {}\n                                     // Use the span from the function expression\n@@ -1595,11 +1608,11 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n \n                                     f.ident = Some(new_ident.clone());\n \n-                                    self.exported_idents.push((\n-                                        new_ident.clone(),\n-                                        atom!(\"default\"),\n-                                        ref_id,\n-                                    ));\n+                                    self.server_reference_exports.push(ServerReferenceExport {\n+                                        ident: new_ident.clone(),\n+                                        export_name: atom!(\"default\"),\n+                                        reference_id: ref_id,\n+                                    });\n \n                                     assign_name_to_ident(\n                                         &new_ident,\n@@ -1651,10 +1664,10 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                         self.private_ctxt,\n                                     );\n \n-                                    self.exported_idents.push((\n-                                        new_ident.clone(),\n-                                        atom!(\"default\"),\n-                                        self.generate_server_reference_id(\n+                                    self.server_reference_exports.push(ServerReferenceExport {\n+                                        ident: new_ident.clone(),\n+                                        export_name: atom!(\"default\"),\n+                                        reference_id: self.generate_server_reference_id(\n                                             \"default\",\n                                             is_cache,\n                                             Some(\n@@ -1665,7 +1678,7 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                                     .collect(),\n                                             ),\n                                         ),\n-                                    ));\n+                                    });\n \n                                     create_var_declarator(&new_ident, &mut self.extra_items);\n                                     assign_name_to_ident(\n@@ -1680,15 +1693,15 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                             }\n                             Expr::Ident(ident) => {\n                                 // export default foo\n-                                self.exported_idents.push((\n-                                    ident.clone(),\n-                                    atom!(\"default\"),\n-                                    self.generate_server_reference_id(\n+                                self.server_reference_exports.push(ServerReferenceExport {\n+                                    ident: ident.clone(),\n+                                    export_name: atom!(\"default\"),\n+                                    reference_id: self.generate_server_reference_id(\n                                         \"default\",\n                                         in_cache_file,\n                                         None,\n                                     ),\n-                                ));\n+                                });\n                             }\n                             Expr::Call(call) => {\n                                 // export default fn()\n@@ -1698,15 +1711,15 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                 let new_ident =\n                                     Ident::new(self.gen_action_ident(), span, self.private_ctxt);\n \n-                                self.exported_idents.push((\n-                                    new_ident.clone(),\n-                                    atom!(\"default\"),\n-                                    self.generate_server_reference_id(\n+                                self.server_reference_exports.push(ServerReferenceExport {\n+                                    ident: new_ident.clone(),\n+                                    export_name: atom!(\"default\"),\n+                                    reference_id: self.generate_server_reference_id(\n                                         \"default\",\n                                         in_cache_file,\n                                         None,\n                                     ),\n-                                ));\n+                                });\n \n                                 create_var_declarator(&new_ident, &mut self.extra_items);\n                                 assign_name_to_ident(&new_ident, \"default\", &mut self.extra_items);\n@@ -1763,27 +1776,19 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n             }\n         }\n \n-        let mut actions = self.export_actions.take();\n-\n         if in_action_file || in_cache_file && !self.config.is_react_server_layer {\n-            actions.extend(\n-                self.exported_idents\n+            self.reference_ids_by_export_name.extend(\n+                self.server_reference_exports\n                     .iter()\n-                    .map(|e| (e.1.clone(), e.2.clone())),\n+                    .map(|e| (e.export_name.clone(), e.reference_id.clone())),\n             );\n \n-            if !actions.is_empty() {\n+            if !self.reference_ids_by_export_name.is_empty() {\n                 self.has_action |= in_action_file;\n                 self.has_cache |= in_cache_file;\n             }\n         };\n \n-        // Make it a hashmap of id -> name.\n-        let actions = actions\n-            .into_iter()\n-            .map(|a| (a.1, a.0))\n-            .collect::<ActionsMap>();\n-\n         // If it's compiled in the client layer, each export field needs to be\n         // wrapped by a reference creation call.\n         let create_ref_ident = private_ident!(\"createServerReference\");\n@@ -1836,7 +1841,12 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n \n         // If it's a \"use server\" or a \"use cache\" file, all exports need to be annotated.\n         if should_track_exports {\n-            for (ident, export_name, ref_id) in self.exported_idents.iter() {\n+            for ServerReferenceExport {\n+                ident,\n+                export_name,\n+                reference_id: ref_id,\n+            } in &self.server_reference_exports\n+            {\n                 if !self.config.is_react_server_layer {\n                     if export_name == \"default\" {\n                         let export_expr = ModuleItem::ModuleDecl(ModuleDecl::ExportDefaultExpr(\n@@ -1943,7 +1953,7 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                 new.append(&mut self.extra_items);\n \n                 // For \"use cache\" files, there's no need to do extra annotations.\n-                if !in_cache_file && !self.exported_idents.is_empty() {\n+                if !in_cache_file && !self.server_reference_exports.is_empty() {\n                     let ensure_ident = private_ident!(\"ensureServerEntryExports\");\n                     new.push(ModuleItem::ModuleDecl(ModuleDecl::Import(ImportDecl {\n                         span: DUMMY_SP,\n@@ -1972,9 +1982,9 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                 expr: Box::new(Expr::Array(ArrayLit {\n                                     span: DUMMY_SP,\n                                     elems: self\n-                                        .exported_idents\n+                                        .server_reference_exports\n                                         .iter()\n-                                        .map(|(ident, _, _)| {\n+                                        .map(|ServerReferenceExport { ident, .. }| {\n                                             Some(ExprOrSpread {\n                                                 spread: None,\n                                                 expr: Box::new(Expr::Ident(ident.clone())),\n@@ -2096,15 +2106,23 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n         }\n \n         if self.has_action || self.has_cache {\n+            // Flip the map and convert it to a BTreeMap for deterministic\n+            // ordering in the server references comment.\n+            let export_names_ordered_by_reference_id = self\n+                .reference_ids_by_export_name\n+                .iter()\n+                .map(|(export_name, reference_id)| (reference_id, export_name))\n+                .collect::<BTreeMap<_, _>>();\n+\n             if self.config.is_react_server_layer {\n                 // Prepend a special comment to the top of the file.\n                 self.comments.add_leading(\n                     self.start_pos,\n                     Comment {\n                         span: DUMMY_SP,\n                         kind: CommentKind::Block,\n-                        text: generate_server_actions_comment(\n-                            &actions,\n+                        text: generate_server_references_comment(\n+                            &export_names_ordered_by_reference_id,\n                             match self.mode {\n                                 ServerActionsMode::Webpack => None,\n                                 ServerActionsMode::Turbopack => Some((\"\", \"\")),\n@@ -2121,7 +2139,11 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                             Comment {\n                                 span: DUMMY_SP,\n                                 kind: CommentKind::Block,\n-                                text: generate_server_actions_comment(&actions, None).into(),\n+                                text: generate_server_references_comment(\n+                                    &export_names_ordered_by_reference_id,\n+                                    None,\n+                                )\n+                                .into(),\n                             },\n                         );\n                         new.push(client_layer_import.unwrap());\n@@ -2165,8 +2187,8 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                                             Comment {\n                                                 span: DUMMY_SP,\n                                                 kind: CommentKind::Block,\n-                                                text: generate_server_actions_comment(\n-                                                    &std::iter::once((ref_id, export)).collect(),\n+                                                text: generate_server_references_comment(\n+                                                    &std::iter::once((&ref_id, &export)).collect(),\n                                                     Some((\n                                                         &self.file_name,\n                                                         self.file_query.as_ref().map_or(\"\", |v| v),"
        }
    ],
    "stats": {
        "total": 246,
        "additions": 134,
        "deletions": 112
    }
}