{
    "author": "mischnic",
    "message": "Turbopack: cleanup Effect::MemberCall (#83021)",
    "sha": "f205a6a5c09ad80cf2e2cf49c457234df6d84710",
    "files": [
        {
            "sha": "b76c85bc5deeecb59305c60d8d10925bd0f1a076",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=f205a6a5c09ad80cf2e2cf49c457234df6d84710",
            "patch": "@@ -1810,7 +1810,19 @@ impl JsValue {\n             }\n             JsValue::WellKnownFunction(func) => {\n                 let (name, explainer) = match func {\n-                   WellKnownFunctionKind::ObjectAssign => (\n+                    WellKnownFunctionKind::ArrayFilter => (\n+                      \"Array.prototype.filter\".to_string(),\n+                      \"The standard Array.prototype.filter method: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\"\n+                    ),\n+                    WellKnownFunctionKind::ArrayForEach => (\n+                      \"Array.prototype.forEach\".to_string(),\n+                      \"The standard Array.prototype.forEach method: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach\"\n+                    ),\n+                    WellKnownFunctionKind::ArrayMap => (\n+                      \"Array.prototype.map\".to_string(),\n+                      \"The standard Array.prototype.map method: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map\"\n+                    ),\n+                    WellKnownFunctionKind::ObjectAssign => (\n                         \"Object.assign\".to_string(),\n                         \"Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\",\n                     ),\n@@ -3533,6 +3545,9 @@ impl Hash for RequireContextValue {\n /// A list of well-known functions that have special meaning in the analysis.\n #[derive(Debug, Clone, Hash, PartialEq, Eq)]\n pub enum WellKnownFunctionKind {\n+    ArrayFilter,\n+    ArrayForEach,\n+    ArrayMap,\n     ObjectAssign,\n     PathJoin,\n     PathDirname,"
        },
        {
            "sha": "9120b184cf3ddca933e737cbbd7a1ff8a5eded17",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/well_known.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs?ref=f205a6a5c09ad80cf2e2cf49c457234df6d84710",
            "patch": "@@ -43,6 +43,21 @@ pub async fn replace_well_known(\n         JsValue::Member(_, box JsValue::WellKnownFunction(kind), box prop) => {\n             well_known_function_member(kind, prop)\n         }\n+        JsValue::Member(_, box JsValue::Array { .. }, box ref prop) => match prop.as_str() {\n+            Some(\"filter\") => (\n+                JsValue::WellKnownFunction(WellKnownFunctionKind::ArrayFilter),\n+                true,\n+            ),\n+            Some(\"forEach\") => (\n+                JsValue::WellKnownFunction(WellKnownFunctionKind::ArrayForEach),\n+                true,\n+            ),\n+            Some(\"map\") => (\n+                JsValue::WellKnownFunction(WellKnownFunctionKind::ArrayMap),\n+                true,\n+            ),\n+            _ => (value, false),\n+        },\n         _ => (value, false),\n     })\n }"
        },
        {
            "sha": "4b8513d90745b3416bb7b5fbfb41b063df16a671",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 19,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f205a6a5c09ad80cf2e2cf49c457234df6d84710/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=f205a6a5c09ad80cf2e2cf49c457234df6d84710",
            "patch": "@@ -1218,7 +1218,6 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n                         &ast_path,\n                         span,\n                         func,\n-                        JsValue::unknown_empty(false, \"no this provided\"),\n                         args,\n                         &analysis_state,\n                         &add_effects,\n@@ -1242,21 +1241,31 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n                     {\n                         continue;\n                     }\n-                    let mut obj = analysis_state\n-                        .link_value(*obj, ImportAttributes::empty_ref())\n-                        .await?;\n-                    let prop = analysis_state\n-                        .link_value(*prop, ImportAttributes::empty_ref())\n+\n+                    let func = analysis_state\n+                        .link_value(\n+                            JsValue::member(obj.clone(), prop),\n+                            eval_context.imports.get_attributes(span),\n+                        )\n                         .await?;\n \n                     if !new\n+                        && matches!(\n+                            func,\n+                            JsValue::WellKnownFunction(\n+                                WellKnownFunctionKind::ArrayFilter\n+                                    | WellKnownFunctionKind::ArrayForEach\n+                                    | WellKnownFunctionKind::ArrayMap\n+                            )\n+                        )\n+                        && let [EffectArg::Closure(value, block)] = &mut args[..]\n                         && let JsValue::Array {\n                             items: ref mut values,\n                             mutable,\n                             ..\n-                        } = obj\n-                        && matches!(prop.as_str(), Some(\"map\" | \"forEach\" | \"filter\"))\n-                        && let [EffectArg::Closure(value, block)] = &mut args[..]\n+                        } = analysis_state\n+                            .link_value(*obj, eval_context.imports.get_attributes(span))\n+                            .await?\n                     {\n                         *value = analysis_state\n                             .link_value(take(value), ImportAttributes::empty_ref())\n@@ -1281,18 +1290,10 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n                         }\n                     }\n \n-                    let func = analysis_state\n-                        .link_value(\n-                            JsValue::member(Box::new(obj.clone()), Box::new(prop)),\n-                            eval_context.imports.get_attributes(span),\n-                        )\n-                        .await?;\n-\n                     handle_call(\n                         &ast_path,\n                         span,\n                         func,\n-                        obj,\n                         args,\n                         &analysis_state,\n                         &add_effects,\n@@ -1564,7 +1565,6 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n     ast_path: &[AstParentKind],\n     span: Span,\n     func: JsValue,\n-    this: JsValue,\n     args: Vec<EffectArg>,\n     state: &AnalysisState<'_>,\n     add_effects: &G,\n@@ -1706,7 +1706,6 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                     ast_path,\n                     span,\n                     alt,\n-                    this.clone(),\n                     args.clone(),\n                     state,\n                     add_effects,"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 49,
        "deletions": 20
    }
}