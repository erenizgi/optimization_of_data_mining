{
    "author": "bgw",
    "message": "fix(experimental.lockDistDir): Acquire the lock in dev earlier (#85116)\n\nApparently I grabbed the lock too late, which led to the second process still managing the `distDir` before exiting... https://vercel.slack.com/archives/C03EWR7LGEN/p1760910025067089\n\nThis moves the acquisition earlier for dev, and extends the e2e test to cover this.\n\n[Screen Recording 2025-10-20 at 10.42.49â€¯AM.webm <span class=\"graphite__hidden\">(uploaded via Graphite)</span> <img class=\"graphite__hidden\" src=\"https://app.graphite.dev/user-attachments/thumbnails/68785bda-1dd5-437a-bf16-54de2d54a49c.webm\" />](https://app.graphite.dev/user-attachments/video/68785bda-1dd5-437a-bf16-54de2d54a49c.webm)",
    "sha": "167608775cbd0ac089c29ec68d538e7f214f2bed",
    "files": [
        {
            "sha": "4fd620bb4741461119b2a1bc62ef3c3a2974eac2",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -121,6 +121,7 @@ import { handlePageMetadataResponse } from '../mcp/tools/get-page-metadata'\n import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n import { getFileLogger } from './browser-logs/file-logger'\n import type { ServerCacheStatus } from '../../next-devtools/dev-overlay/cache-indicator'\n+import type { Lockfile } from '../../build/lockfile'\n \n const wsServer = new ws.Server({ noServer: true })\n const isTestMode = !!(\n@@ -182,7 +183,8 @@ export async function createHotReloaderTurbopack(\n   opts: SetupOpts & { isSrcDir: boolean },\n   serverFields: ServerFields,\n   distDir: string,\n-  resetFetch: () => void\n+  resetFetch: () => void,\n+  lockfile: Lockfile | undefined\n ): Promise<NextJsHotReloaderInterface> {\n   const dev = true\n   const buildId = 'development'\n@@ -288,6 +290,7 @@ export async function createHotReloaderTurbopack(\n   opts.onDevServerCleanup?.(async () => {\n     setBundlerFindSourceMapImplementation(() => undefined)\n     await project.onExit()\n+    await lockfile?.unlock()\n   })\n   const entrypointsSubscription = project.entrypointsSubscribe()\n "
        },
        {
            "sha": "df34512af5119f724a91de6e369c9a89fc9cf6af",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -111,6 +111,7 @@ import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n import { getFileLogger } from './browser-logs/file-logger'\n import type { ServerCacheStatus } from '../../next-devtools/dev-overlay/cache-indicator'\n+import type { Lockfile } from '../../build/lockfile'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -246,6 +247,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n   private appDir?: string\n   private telemetry: Telemetry\n   private resetFetch: () => void\n+  private lockfile: Lockfile | undefined\n   private versionInfo: VersionInfo = {\n     staleness: 'unknown',\n     installed: '0.0.0',\n@@ -276,6 +278,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       appDir,\n       telemetry,\n       resetFetch,\n+      lockfile,\n+      onDevServerCleanup,\n     }: {\n       config: NextConfigComplete\n       isSrcDir: boolean\n@@ -288,6 +292,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       appDir?: string\n       telemetry: Telemetry\n       resetFetch: () => void\n+      lockfile: Lockfile | undefined\n+      onDevServerCleanup: ((listener: () => Promise<void>) => void) | undefined\n     }\n   ) {\n     this.hasAppRouterEntrypoints = false\n@@ -306,6 +312,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     this.serverPrevDocumentHash = null\n     this.telemetry = telemetry\n     this.resetFetch = resetFetch\n+    this.lockfile = lockfile\n \n     this.config = config\n     this.previewProps = previewProps\n@@ -322,6 +329,10 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     const mcpServerEnabled = !!config.experimental.mcpServer\n     const fileLogger = getFileLogger()\n     fileLogger.initialize(this.distDir, mcpServerEnabled)\n+\n+    onDevServerCleanup?.(async () => {\n+      await lockfile?.unlock()\n+    })\n   }\n \n   public async run("
        },
        {
            "sha": "6c9f02a6121a67910e42721d7a75bdce171ebf88",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -87,6 +87,7 @@ import {\n } from './route-types-utils'\n import { isParallelRouteSegment } from '../../../shared/lib/segment'\n import { ensureLeadingSlash } from '../../../shared/lib/page-path/ensure-leading-slash'\n+import { Lockfile } from '../../../build/lockfile'\n \n export type SetupOpts = {\n   renderServer: LazyRenderServerInstance\n@@ -175,6 +176,15 @@ async function startWatcher(\n   setGlobal('distDir', distDir)\n   setGlobal('phase', PHASE_DEVELOPMENT_SERVER)\n \n+  let lockfile\n+  if (opts.nextConfig.experimental.lockDistDir) {\n+    fs.mkdirSync(distDir, { recursive: true })\n+    lockfile = await Lockfile.acquireWithRetriesOrExit(\n+      path.join(distDir, 'lock'),\n+      'next dev'\n+    )\n+  }\n+\n   const validFileMatcher = createValidFileMatcher(\n     nextConfig.pageExtensions,\n     appDir\n@@ -196,7 +206,8 @@ async function startWatcher(\n           opts,\n           serverFields,\n           distDir,\n-          resetFetch\n+          resetFetch,\n+          lockfile\n         )\n       })()\n     : await (async () => {\n@@ -218,6 +229,8 @@ async function startWatcher(\n           rewrites: opts.fsChecker.rewrites,\n           previewProps: opts.fsChecker.prerenderManifest.preview,\n           resetFetch,\n+          lockfile,\n+          onDevServerCleanup: opts.onDevServerCleanup,\n         })\n       })()\n "
        },
        {
            "sha": "f2cb853b212fd6bff20ded7610d587fb000d8335",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 22,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -15,7 +15,6 @@ import type { default as NextNodeServer } from './next-server'\n import * as log from '../build/output/log'\n import loadConfig from './config'\n import path from 'node:path'\n-import { mkdirSync } from 'node:fs'\n import { NON_STANDARD_NODE_ENV } from '../lib/constants'\n import {\n   PHASE_DEVELOPMENT_SERVER,\n@@ -32,7 +31,6 @@ import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n } from './lib/router-utils/router-server-context'\n-import { Lockfile } from '../build/lockfile'\n \n let ServerImpl: typeof NextNodeServer\n \n@@ -131,7 +129,6 @@ export class NextServer implements NextWrapperServer {\n   private reqHandler?: NodeRequestHandler\n   private reqHandlerPromise?: Promise<NodeRequestHandler>\n   private preparedAssetPrefix?: string\n-  private lockfile?: Lockfile\n \n   public options: NextServerOptions\n \n@@ -261,9 +258,6 @@ export class NextServer implements NextWrapperServer {\n     if (this.server) {\n       await this.server.close()\n     }\n-    if (this.lockfile !== undefined) {\n-      await this.lockfile.unlock()\n-    }\n   }\n \n   private async createServer(\n@@ -323,22 +317,7 @@ export class NextServer implements NextWrapperServer {\n   private async getServer() {\n     if (!this.serverPromise) {\n       this.serverPromise = this[SYMBOL_LOAD_CONFIG]().then(async (conf) => {\n-        if (this.options.dev) {\n-          if (conf.experimental.lockDistDir) {\n-            const dir = path.resolve(\n-              /* turbopackIgnore: true */ this.options.dir || '.'\n-            )\n-            const distDir = path.join(\n-              /* turbopackIgnore: true */ dir,\n-              conf.distDir\n-            )\n-            mkdirSync(distDir, { recursive: true })\n-            this.lockfile = await Lockfile.acquireWithRetriesOrExit(\n-              path.join(/* turbopackIgnore: true */ distDir, 'lock'),\n-              'next dev'\n-            )\n-          }\n-        } else {\n+        if (!this.options.dev) {\n           if (conf.output === 'standalone') {\n             if (!process.env.__NEXT_PRIVATE_STANDALONE_CONFIG) {\n               log.warn("
        },
        {
            "sha": "bd97cb6cbf6654e75ceb9de98e3658571fa1fa1c",
            "filename": "test/development/lockfile/lockfile.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Flockfile%2Flockfile.test.ts?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -26,5 +26,9 @@ describe('lockfile', () => {\n     )\n     expect(stripAnsi(stdout + stderr)).toContain('Unable to acquire lock')\n     expect(exitCode).toBe(1)\n+\n+    // make sure the other instance of `next dev` didn't mess anything up\n+    browser.refresh()\n+    expect(await browser.elementByCss('p').text()).toBe('Page')\n   })\n })"
        },
        {
            "sha": "4d20bfae15a9defe70d3276a1a65991801b927d1",
            "filename": "test/integration/dynamic-optional-routing/test/index.test.js",
            "status": "modified",
            "additions": 17,
            "deletions": 12,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/167608775cbd0ac089c29ec68d538e7f214f2bed/test%2Fintegration%2Fdynamic-optional-routing%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/167608775cbd0ac089c29ec68d538e7f214f2bed/test%2Fintegration%2Fdynamic-optional-routing%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fdynamic-optional-routing%2Ftest%2Findex.test.js?ref=167608775cbd0ac089c29ec68d538e7f214f2bed",
            "patch": "@@ -240,21 +240,26 @@ describe('Dynamic Optional Routing', () => {\n   ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n     'development mode',\n     () => {\n-      beforeAll(async () => {\n-        appPort = await findPort()\n-        app = await launchApp(appDir, appPort)\n+      describe('rendering', () => {\n+        beforeAll(async () => {\n+          appPort = await findPort()\n+          app = await launchApp(appDir, appPort)\n+        })\n+        afterAll(() => killApp(app))\n+        runTests()\n       })\n-      afterAll(() => killApp(app))\n \n-      runTests()\n-\n-      runInvalidPagesTests(async (appDir) => {\n-        stderr = ''\n-        await launchApp(appDir, await findPort(), {\n-          onStderr: (msg) => {\n-            stderr += msg\n-          },\n+      describe('invalid pages', () => {\n+        runInvalidPagesTests(async (appDir) => {\n+          stderr = ''\n+          appPort = await findPort()\n+          app = await launchApp(appDir, appPort, {\n+            onStderr: (msg) => {\n+              stderr += msg\n+            },\n+          })\n         })\n+        afterEach(() => killApp(app))\n       })\n     }\n   )"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 51,
        "deletions": 36
    }
}