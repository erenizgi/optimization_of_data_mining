{
    "author": "ztanner",
    "message": "omit searchParam data from FlightRouterState before transport (#80734)\n\nCertain types of data gets stashed in the client-side\n`FlightRouterState`, such as the \"refresh\" marker alongside a URL that\nthe client can callback to when it needs to revalidate segments that\nwere \"activated\" on previously visited URLs. Additionally, query\nparameter data gets encoded in the `__PAGE__` segment key, but isn't\nactually needed by the server: `__PAGE__` segments would always be the\nleaf, so it wouldn't cause any unexpected behavior in the diffing logic.\n\nWith large query params, this can lead to large amount of data needing\nto be sent to the server, only for it to not actually be used. There's a\nlarger refactor around the server/client transport being handled in the\n`experimental.clientSegmentCache` flag, so this is a stop-gap until that\nbehavior is stabilized.\n\nCloses NEXT-4521",
    "sha": "058f4c121f727c12fd21d72478158c75c8595537",
    "files": [
        {
            "sha": "424d59db31cd616c35faa3224253b4f967729928",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=058f4c121f727c12fd21d72478158c75c8595537",
            "patch": "@@ -33,6 +33,7 @@ import { findSourceMapURL } from '../../app-find-source-map-url'\n import { PrefetchKind } from './router-reducer-types'\n import {\n   normalizeFlightData,\n+  prepareFlightRouterStateForRequest,\n   type NormalizedFlightData,\n } from '../../flight-data-helpers'\n import { getAppBuildId } from '../../app-build-id'\n@@ -126,8 +127,9 @@ export async function fetchServerResponse(\n     // Enable flight response\n     [RSC_HEADER]: '1',\n     // Provide the current router state\n-    [NEXT_ROUTER_STATE_TREE_HEADER]: encodeURIComponent(\n-      JSON.stringify(flightRouterState)\n+    [NEXT_ROUTER_STATE_TREE_HEADER]: prepareFlightRouterStateForRequest(\n+      flightRouterState,\n+      options.isHmrRefresh\n     ),\n   }\n "
        },
        {
            "sha": "aaae9acb7587cedf376fa4bcae652b34b004644f",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=058f4c121f727c12fd21d72478158c75c8595537",
            "patch": "@@ -45,6 +45,7 @@ import { handleSegmentMismatch } from '../handle-segment-mismatch'\n import { refreshInactiveParallelSegments } from '../refetch-inactive-parallel-segments'\n import {\n   normalizeFlightData,\n+  prepareFlightRouterStateForRequest,\n   type NormalizedFlightData,\n } from '../../../flight-data-helpers'\n import { getRedirectError } from '../../redirect'\n@@ -92,8 +93,8 @@ async function fetchServerAction(\n     headers: {\n       Accept: RSC_CONTENT_TYPE_HEADER,\n       [ACTION_HEADER]: actionId,\n-      [NEXT_ROUTER_STATE_TREE_HEADER]: encodeURIComponent(\n-        JSON.stringify(state.tree)\n+      [NEXT_ROUTER_STATE_TREE_HEADER]: prepareFlightRouterStateForRequest(\n+        state.tree\n       ),\n       ...(process.env.NEXT_DEPLOYMENT_ID\n         ? {"
        },
        {
            "sha": "b01d2292f2c5c72d3aa22867c7641832e88d714e",
            "filename": "packages/next/src/client/flight-data-helpers.test.ts",
            "status": "added",
            "additions": 317,
            "deletions": 0,
            "changes": 317,
            "blob_url": "https://github.com/vercel/next.js/blob/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.test.ts?ref=058f4c121f727c12fd21d72478158c75c8595537",
            "patch": "@@ -0,0 +1,317 @@\n+import { prepareFlightRouterStateForRequest } from './flight-data-helpers'\n+import type { FlightRouterState } from '../server/app-render/types'\n+import { HasLoadingBoundary } from '../server/app-render/types'\n+\n+describe('prepareFlightRouterStateForRequest', () => {\n+  describe('HMR refresh handling', () => {\n+    it('should preserve complete state for HMR refresh requests', () => {\n+      const flightRouterState: FlightRouterState = [\n+        '__PAGE__?{\"sensitive\":\"data\"}',\n+        {},\n+        '/some/url',\n+        'refresh',\n+        true,\n+        1,\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState, true)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded).toEqual(flightRouterState)\n+    })\n+  })\n+\n+  describe('__PAGE__ segment handling', () => {\n+    it('should strip search params from __PAGE__ segments', () => {\n+      const flightRouterState: FlightRouterState = [\n+        '__PAGE__?{\"param\":\"value\",\"foo\":\"bar\"}',\n+        {},\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[0]).toBe('__PAGE__')\n+    })\n+\n+    it('should preserve non-page segments', () => {\n+      const flightRouterState: FlightRouterState = ['regular-segment', {}]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[0]).toBe('regular-segment')\n+    })\n+\n+    it('should preserve dynamic segments', () => {\n+      const dynamicSegment: [string, string, 'd'] = ['slug', 'test-value', 'd']\n+      const flightRouterState: FlightRouterState = [dynamicSegment, {}]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[0]).toEqual(dynamicSegment)\n+    })\n+  })\n+\n+  describe('URL stripping', () => {\n+    it('should always set URL (index 2) to null', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        '/sensitive/url/path',\n+        null,\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[2]).toBeNull()\n+    })\n+  })\n+\n+  describe('refresh marker handling', () => {\n+    it('should preserve \"refetch\" marker', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        '/url',\n+        'refetch',\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[3]).toBe('refetch')\n+    })\n+\n+    it('should preserve \"inside-shared-layout\" marker', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        '/url',\n+        'inside-shared-layout',\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[3]).toBe('inside-shared-layout')\n+    })\n+\n+    it('should strip \"refresh\" marker (client-only)', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        '/url',\n+        'refresh',\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[3]).toBeNull()\n+    })\n+\n+    it('should strip null refresh marker', () => {\n+      const flightRouterState: FlightRouterState = ['segment', {}, '/url', null]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[3]).toBeNull()\n+    })\n+  })\n+\n+  describe('optional fields preservation', () => {\n+    it('should preserve isRootLayout when true', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        null,\n+        null,\n+        true,\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[4]).toBe(true)\n+    })\n+\n+    it('should preserve isRootLayout when false', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        null,\n+        null,\n+        false,\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[4]).toBe(false)\n+    })\n+\n+    it('should preserve hasLoadingBoundary', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'segment',\n+        {},\n+        null,\n+        null,\n+        undefined,\n+        1, // HasLoadingBoundary value\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[5]).toBe(1)\n+    })\n+\n+    it('should handle minimal FlightRouterState (only segment and parallelRoutes)', () => {\n+      const flightRouterState: FlightRouterState = ['segment', {}]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded).toEqual([\n+        'segment',\n+        {},\n+        null, // URL\n+        null, // refresh marker\n+      ])\n+    })\n+  })\n+\n+  describe('recursive processing of parallel routes', () => {\n+    it('should recursively process nested parallel routes', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'parent',\n+        {\n+          children: [\n+            '__PAGE__?{\"nested\":\"param\"}',\n+            {},\n+            '/nested/url',\n+            'refresh',\n+          ],\n+          modal: ['modal-segment', {}, '/modal/url', 'refetch'],\n+        },\n+        '/parent/url',\n+        'inside-shared-layout',\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded).toEqual([\n+        'parent',\n+        {\n+          children: [\n+            '__PAGE__', // search params stripped\n+            {},\n+            null, // URL stripped\n+            null, // 'refresh' marker stripped\n+          ],\n+          modal: [\n+            'modal-segment',\n+            {},\n+            null, // URL stripped\n+            'refetch', // server marker preserved\n+          ],\n+        },\n+        null, // URL stripped\n+        'inside-shared-layout', // server marker preserved\n+      ])\n+    })\n+\n+    it('should handle deeply nested parallel routes', () => {\n+      const flightRouterState: FlightRouterState = [\n+        'root',\n+        {\n+          children: [\n+            'level1',\n+            {\n+              children: [\n+                '__PAGE__?{\"deep\":\"nesting\"}',\n+                {},\n+                '/deep/url',\n+                'refetch',\n+              ],\n+            },\n+          ],\n+        },\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(flightRouterState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      expect(decoded[1].children[1].children[0]).toBe('__PAGE__')\n+      expect(decoded[1].children[1].children[2]).toBeNull()\n+      expect(decoded[1].children[1].children[3]).toBe('refetch')\n+    })\n+  })\n+\n+  describe('real-world scenarios', () => {\n+    it('should handle complex FlightRouterState with all features', () => {\n+      const complexState: FlightRouterState = [\n+        '__PAGE__?{\"userId\":\"123\"}',\n+        {\n+          children: [\n+            'dashboard',\n+            {\n+              modal: [\n+                '__PAGE__?{\"modalParam\":\"data\"}',\n+                {},\n+                '/modal/path',\n+                'refresh',\n+                false,\n+                HasLoadingBoundary.SegmentHasLoadingBoundary,\n+              ],\n+            },\n+            '/dashboard/url',\n+            'refetch',\n+            true,\n+            1,\n+          ],\n+          sidebar: [['slug', 'user-123', 'd'], {}, '/sidebar/url', null],\n+        },\n+        '/main/url',\n+        'inside-shared-layout',\n+        true,\n+        1,\n+      ]\n+\n+      const result = prepareFlightRouterStateForRequest(complexState)\n+      const decoded = JSON.parse(decodeURIComponent(result))\n+\n+      // Root level checks\n+      expect(decoded[0]).toBe('__PAGE__') // search params stripped\n+      expect(decoded[2]).toBeNull() // URL stripped\n+      expect(decoded[3]).toBe('inside-shared-layout') // server marker preserved\n+      expect(decoded[4]).toBe(true) // isRootLayout preserved\n+      expect(decoded[5]).toBe(1) // hasLoadingBoundary preserved\n+\n+      // Children route checks\n+      const childrenRoute = decoded[1].children\n+      expect(childrenRoute[2]).toBeNull() // URL stripped\n+      expect(childrenRoute[3]).toBe('refetch') // server marker preserved\n+      expect(childrenRoute[4]).toBe(true) // isRootLayout preserved\n+\n+      // Modal route checks\n+      const modalRoute = childrenRoute[1].modal\n+      expect(modalRoute[0]).toBe('__PAGE__') // search params stripped\n+      expect(modalRoute[2]).toBeNull() // URL stripped\n+      expect(modalRoute[3]).toBeNull() // 'refresh' marker stripped\n+      expect(modalRoute[4]).toBe(false) // isRootLayout preserved\n+      expect(modalRoute[5]).toBe(HasLoadingBoundary.SegmentHasLoadingBoundary) // hasLoadingBoundary preserved\n+\n+      // Sidebar route (dynamic segment) checks\n+      const sidebarRoute = decoded[1].sidebar\n+      expect(sidebarRoute[0]).toEqual(['slug', 'user-123', 'd']) // dynamic segment preserved\n+      expect(sidebarRoute[2]).toBeNull() // URL stripped\n+      expect(sidebarRoute[3]).toBeNull() // null marker remains null\n+    })\n+  })\n+})"
        },
        {
            "sha": "7ea616d23d58686d5ba226f288d8f9d758f2eb84",
            "filename": "packages/next/src/client/flight-data-helpers.ts",
            "status": "modified",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/058f4c121f727c12fd21d72478158c75c8595537/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fflight-data-helpers.ts?ref=058f4c121f727c12fd21d72478158c75c8595537",
            "patch": "@@ -7,6 +7,7 @@ import type {\n   Segment,\n } from '../server/app-render/types'\n import type { HeadData } from '../shared/lib/app-router-context.shared-runtime'\n+import { PAGE_SEGMENT_KEY } from '../shared/lib/segment'\n \n export type NormalizedFlightData = {\n   /**\n@@ -76,3 +77,95 @@ export function normalizeFlightData(\n \n   return flightData.map(getFlightDataPartsFromPath)\n }\n+\n+/**\n+ * This function is used to prepare the flight router state for the request.\n+ * It removes markers that are not needed by the server, and are purely used\n+ * for stashing state on the client.\n+ * @param flightRouterState - The flight router state to prepare.\n+ * @param isHmrRefresh - Whether this is an HMR refresh request.\n+ * @returns The prepared flight router state.\n+ */\n+export function prepareFlightRouterStateForRequest(\n+  flightRouterState: FlightRouterState,\n+  isHmrRefresh?: boolean\n+): string {\n+  // HMR requests need the complete, unmodified state for proper functionality\n+  if (isHmrRefresh) {\n+    return encodeURIComponent(JSON.stringify(flightRouterState))\n+  }\n+\n+  return encodeURIComponent(\n+    JSON.stringify(stripClientOnlyDataFromFlightRouterState(flightRouterState))\n+  )\n+}\n+\n+/**\n+ * Recursively strips client-only data from FlightRouterState while preserving\n+ * server-needed information for proper rendering decisions.\n+ */\n+function stripClientOnlyDataFromFlightRouterState(\n+  flightRouterState: FlightRouterState\n+): FlightRouterState {\n+  const [\n+    segment,\n+    parallelRoutes,\n+    _url, // Intentionally unused - URLs are client-only\n+    refreshMarker,\n+    isRootLayout,\n+    hasLoadingBoundary,\n+  ] = flightRouterState\n+\n+  // __PAGE__ segments are always fetched from the server, so there's\n+  // no need to send them up\n+  const cleanedSegment = stripSearchParamsFromPageSegment(segment)\n+\n+  // Recursively process parallel routes\n+  const cleanedParallelRoutes: { [key: string]: FlightRouterState } = {}\n+  for (const [key, childState] of Object.entries(parallelRoutes)) {\n+    cleanedParallelRoutes[key] =\n+      stripClientOnlyDataFromFlightRouterState(childState)\n+  }\n+\n+  const result: FlightRouterState = [\n+    cleanedSegment,\n+    cleanedParallelRoutes,\n+    null, // URLs omitted - server reconstructs paths from segments\n+    shouldPreserveRefreshMarker(refreshMarker) ? refreshMarker : null,\n+  ]\n+\n+  // Append optional fields if present\n+  if (isRootLayout !== undefined) {\n+    result[4] = isRootLayout\n+  }\n+  if (hasLoadingBoundary !== undefined) {\n+    result[5] = hasLoadingBoundary\n+  }\n+\n+  return result\n+}\n+\n+/**\n+ * Strips search parameters from __PAGE__ segments to prevent sensitive\n+ * client-side data from being sent to the server.\n+ */\n+function stripSearchParamsFromPageSegment(segment: Segment): Segment {\n+  if (\n+    typeof segment === 'string' &&\n+    segment.startsWith(PAGE_SEGMENT_KEY + '?')\n+  ) {\n+    return PAGE_SEGMENT_KEY\n+  }\n+  return segment\n+}\n+\n+/**\n+ * Determines whether the refresh marker should be sent to the server\n+ * Client-only markers like 'refresh' are stripped, while server-needed markers\n+ * like 'refetch' and 'inside-shared-layout' are preserved.\n+ */\n+function shouldPreserveRefreshMarker(\n+  refreshMarker: FlightRouterState[3]\n+): boolean {\n+  return Boolean(refreshMarker && refreshMarker !== 'refresh')\n+}"
        }
    ],
    "stats": {
        "total": 421,
        "additions": 417,
        "deletions": 4
    }
}