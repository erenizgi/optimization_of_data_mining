{
    "author": "gnoff",
    "message": "Allow silencing unhandled rejection filter warnings and improve debugging (#84572)\n\nThe original debug logs were added to help validate the filter worked\ncorrectly in real applications. They leak implementation details which\nis more permissive than ideal. One reason to keep these around however\nis if you end up seeing the filter being removed you might want to\nunderstand what code is actually doing the removal. The debug mode now\nallows you to receive stacks so you can pinpoint what is manipulating\nthe listeners.\n\nAdditionally if you are ok with whatever is leading to these warnings\nyou might want to quiet them. This introduces a silent mode\n\nAdditionally this removes any warnings except for the one about\nuninstalling the filter because doing so is so likely to be a bad idea\nthat we must highlight it if it is happening.",
    "sha": "c0cd530ad8699b433a52c1459ef4d6c06de286ee",
    "files": [
        {
            "sha": "b8714accf6ddd87c40915cc2c68424698bd541da",
            "filename": "packages/next/src/server/node-environment-extensions/unhandled-rejection.test.ts",
            "status": "modified",
            "additions": 128,
            "deletions": 19,
            "changes": 147,
            "blob_url": "https://github.com/vercel/next.js/blob/c0cd530ad8699b433a52c1459ef4d6c06de286ee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0cd530ad8699b433a52c1459ef4d6c06de286ee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.test.ts?ref=c0cd530ad8699b433a52c1459ef4d6c06de286ee",
            "patch": "@@ -61,7 +61,7 @@ type WorkerResult = {\n   stderr: string\n   uhr: Array<UHRReport>\n   count: Array<CountReport>\n-  errorLog: Array<ErrorLogReport>\n+  errorLog: Array<string>\n   data: Record<string, unknown>\n   messages: Array<ReportableResult>\n }\n@@ -104,7 +104,7 @@ export function runWorkerCode(fn: Function): Promise<WorkerResult> {\n     const messages: Array<ReportableResult> = []\n     const uhr: Array<UHRReport> = []\n     const count: Array<CountReport> = []\n-    const errorLog: Array<ErrorLogReport> = []\n+    const errorLog: Array<string> = []\n     const data = {} as Record<string, unknown>\n     let stderr = ''\n \n@@ -166,7 +166,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should not install filter when disabled', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'disabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'disabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         reportResult({\n@@ -185,7 +185,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should install filter rejections when environment variable is enabled', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         reportResult({\n@@ -204,7 +204,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should install filter rejections when environment variable is enabled in debug mode', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'debug'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'debug'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         reportResult({\n@@ -220,12 +220,121 @@ describe('unhandled-rejection filter', () => {\n         expect.arrayContaining([expect.objectContaining({ count: 1 })])\n       )\n     })\n+\n+    it('should warn once when you uninstall the filter with removeListener', async () => {\n+      async function testForWorker() {\n+        const originalWarn = console.warn\n+        console.warn = (...args: Array<any>) => {\n+          reportResult({ type: 'error-log', message: args.join(' ') })\n+          originalWarn(...args)\n+        }\n+\n+        require('next/dist/server/node-environment-extensions/unhandled-rejection')\n+\n+        const filterListener = process.listeners('unhandledRejection')[0]\n+        process.removeListener('unhandledRejection', filterListener)\n+        process.removeListener('unhandledRejection', filterListener)\n+        process.removeAllListeners()\n+      }\n+\n+      const { errorLog, exitCode } = await runWorkerCode(testForWorker)\n+      expect(exitCode).toBe(0)\n+      expect(errorLog).toMatchInlineSnapshot(`\n+       [\n+         \"[Next.js Unhandled Rejection Filter]: Uninstalling filter because \\`process.removeListener('unhandledRejection', listener)\\` was called with the filter listener. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+       You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+       You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.\",\n+       ]\n+      `)\n+    })\n+\n+    it('should warn once when you uninstall the filter with off', async () => {\n+      async function testForWorker() {\n+        const originalWarn = console.warn\n+        console.warn = (...args: Array<any>) => {\n+          reportResult({ type: 'error-log', message: args.join(' ') })\n+          originalWarn(...args)\n+        }\n+\n+        require('next/dist/server/node-environment-extensions/unhandled-rejection')\n+\n+        const filterListener = process.listeners('unhandledRejection')[0]\n+        process.off('unhandledRejection', filterListener)\n+        process.off('unhandledRejection', filterListener)\n+        process.removeAllListeners()\n+      }\n+\n+      const { errorLog, exitCode } = await runWorkerCode(testForWorker)\n+      expect(exitCode).toBe(0)\n+      expect(errorLog).toMatchInlineSnapshot(`\n+       [\n+         \"[Next.js Unhandled Rejection Filter]: Uninstalling filter because \\`process.removeListener('unhandledRejection', listener)\\` was called with the filter listener. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+       You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+       You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.\",\n+       ]\n+      `)\n+    })\n+\n+    it('should warn once when you uninstall the filter with removeAllListeners', async () => {\n+      async function testForWorker() {\n+        const originalWarn = console.warn\n+        console.warn = (...args: Array<any>) => {\n+          reportResult({ type: 'error-log', message: args.join(' ') })\n+          originalWarn(...args)\n+        }\n+\n+        require('next/dist/server/node-environment-extensions/unhandled-rejection')\n+\n+        const filterListener = process.listeners('unhandledRejection')[0]\n+        process.removeAllListeners()\n+        process.off('unhandledRejection', filterListener)\n+        process.removeListener('unhandledRejection', filterListener)\n+      }\n+\n+      const { errorLog, exitCode } = await runWorkerCode(testForWorker)\n+      expect(exitCode).toBe(0)\n+      expect(errorLog).toMatchInlineSnapshot(`\n+       [\n+         \"[Next.js Unhandled Rejection Filter]: Uninstalling filter because \\`process.removeAllListeners()\\` was called. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+       You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+       You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.\",\n+       ]\n+      `)\n+    })\n+\n+    it('does not warn when environment variable is set to silent mode', async () => {\n+      async function testForWorker() {\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'silent'\n+        const originalWarn = console.warn\n+        console.warn = (...args: Array<any>) => {\n+          reportResult({ type: 'error-log', message: args.join(' ') })\n+          originalWarn(...args)\n+        }\n+\n+        require('next/dist/server/node-environment-extensions/unhandled-rejection')\n+\n+        const filterListener = process.listeners('unhandledRejection')[0]\n+        process.removeAllListeners()\n+        process.off('unhandledRejection', filterListener)\n+        process.removeListener('unhandledRejection', filterListener)\n+      }\n+\n+      const { errorLog, exitCode } = await runWorkerCode(testForWorker)\n+      expect(exitCode).toBe(0)\n+      expect(errorLog).toMatchInlineSnapshot(`[]`)\n+    })\n   })\n \n   describe('filtering functionality', () => {\n     it('should suppress rejections from aborted prerender contexts', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = '1'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = '1'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -293,7 +402,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should suppress rejections from aborted prerender-client contexts', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = '1'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = '1'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -361,7 +470,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should suppress rejections from aborted prerender-runtime contexts', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = '1'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = '1'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -429,7 +538,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should pass through rejections from non-aborted prerender contexts', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = '1'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = '1'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -472,7 +581,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should call console.error when no handlers are present', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = '1'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = '1'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         console.error = (...args: Array<any>) => {\n@@ -493,7 +602,7 @@ describe('unhandled-rejection filter', () => {\n   describe('process method interception', () => {\n     it('should handle process.once listeners correctly', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         let callCount = 0\n@@ -528,7 +637,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should handle process.removeListener correctly', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const handler1 = (reason: unknown) => {\n@@ -598,7 +707,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should uninstall filter when removeAllListeners() is called without arguments', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -660,7 +769,7 @@ describe('unhandled-rejection filter', () => {\n \n     it('should not uninstall filter when removeAllListeners(\"unhandledRejection\") is called', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -719,7 +828,7 @@ describe('unhandled-rejection filter', () => {\n       // an event is emitted will be invoked regardless of whether there are mutations to the listeners\n       // during event handling.\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const onceHandler = (reason: unknown) => {\n@@ -825,7 +934,7 @@ describe('unhandled-rejection filter', () => {\n         const originalToStrings = originalMethods.map((m) => m.toString())\n         const originalNames = originalMethods.map((m) => m.name)\n \n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const patchedMethods = [\n@@ -885,7 +994,7 @@ describe('unhandled-rejection filter', () => {\n   describe('error handling in handlers', () => {\n     it('should handle errors thrown by user handlers gracefully', async () => {\n       async function testForWorker() {\n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -929,7 +1038,7 @@ describe('unhandled-rejection filter', () => {\n           reportResult({ type: 'uhr', reason: `existing: ${String(reason)}` })\n         })\n \n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         const {\n@@ -971,7 +1080,7 @@ describe('unhandled-rejection filter', () => {\n           reportResult({ type: 'uhr', reason: `existing: ${String(reason)}` })\n         })\n \n-        process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER = 'enabled'\n+        process.env.NEXT_UNHANDLED_REJECTION_FILTER = 'enabled'\n         require('next/dist/server/node-environment-extensions/unhandled-rejection')\n \n         process.removeAllListeners('unhandledRejection')"
        },
        {
            "sha": "1a36dd545a1625f1d306541a63cea2bf631e5efa",
            "filename": "packages/next/src/server/node-environment-extensions/unhandled-rejection.tsx",
            "status": "modified",
            "additions": 177,
            "deletions": 81,
            "changes": 258,
            "blob_url": "https://github.com/vercel/next.js/blob/c0cd530ad8699b433a52c1459ef4d6c06de286ee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c0cd530ad8699b433a52c1459ef4d6c06de286ee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx?ref=c0cd530ad8699b433a52c1459ef4d6c06de286ee",
            "patch": "@@ -24,20 +24,24 @@ import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.exte\n const MODE:\n   | 'enabled'\n   | 'debug'\n+  | 'silent'\n   | 'true'\n   | 'false'\n   | '1'\n   | '0'\n   | ''\n   | string\n-  | undefined = process.env.NEXT_USE_UNHANDLED_REJECTION_FILTER\n+  | undefined = process.env.NEXT_UNHANDLED_REJECTION_FILTER\n \n let ENABLE_UHR_FILTER = true\n-let DEBUG_UHR_FILTER = false\n+let UHR_FILTER_LOG_LEVEL: 'debug' | 'warn' | 'silent' = 'warn'\n \n switch (MODE) {\n+  case 'silent':\n+    UHR_FILTER_LOG_LEVEL = 'silent'\n+    break\n   case 'debug':\n-    DEBUG_UHR_FILTER = true\n+    UHR_FILTER_LOG_LEVEL = 'debug'\n     break\n   case 'false':\n   case 'disabled':\n@@ -53,14 +57,58 @@ switch (MODE) {\n   default:\n     if (typeof MODE === 'string') {\n       console.error(\n-        `NEXT_USE_UNHANDLED_REJECTION_FILTER has an unrecognized value: ${JSON.stringify(MODE)}. Use \"enabled\", \"disabled\", or \"debug\" or omit the environment variable altogether`\n+        `NEXT_UNHANDLED_REJECTION_FILTER has an unrecognized value: ${JSON.stringify(MODE)}. Use \"enabled\", \"disabled\", \"silent\", or \"debug\", or omit the environment variable altogether`\n       )\n     }\n }\n \n-const debug = DEBUG_UHR_FILTER\n-  ? (...args: any[]) =>\n-      console.log('[UNHANDLED REJECTION DEBUG]', ...args, new Error().stack)\n+let debug: typeof console.debug | undefined\n+let debugWithTrace: typeof console.debug | undefined\n+let warn: typeof console.warn | undefined\n+let warnWithTrace: typeof console.warn | undefined\n+\n+switch (UHR_FILTER_LOG_LEVEL) {\n+  case 'debug':\n+    debug = (message: string) =>\n+      console.log('[Next.js Unhandled Rejection Filter]: ' + message)\n+    debugWithTrace = (message: string) => {\n+      console.log(new DebugWithStack(message))\n+    }\n+  // Intentional fallthrough\n+  case 'warn':\n+    warn = (message: string) => {\n+      console.warn('[Next.js Unhandled Rejection Filter]: ' + message)\n+    }\n+    warnWithTrace = (message: string) => {\n+      console.warn(new WarnWithStack(message))\n+    }\n+    break\n+  case 'silent':\n+  default:\n+}\n+\n+class DebugWithStack extends Error {\n+  constructor(message: string) {\n+    super(message)\n+    this.name = '[Next.js Unhandled Rejection Filter]'\n+  }\n+}\n+\n+class WarnWithStack extends Error {\n+  constructor(message: string) {\n+    super(message)\n+    this.name = '[Next.js Unhandled Rejection Filter]'\n+  }\n+}\n+\n+let didWarnUninstalled = false\n+const warnUninstalledOnce = warn\n+  ? function warnUninstalledOnce(...args: any[]) {\n+      if (!didWarnUninstalled) {\n+        didWarnUninstalled = true\n+        warn(...args)\n+      }\n+    }\n   : undefined\n \n type ListenerMetadata = {\n@@ -98,9 +146,6 @@ type UnderlyingMethod =\n   | typeof originalProcessRemoveAllListeners\n   | typeof originalProcessListeners\n \n-let didWarnPrepend = false\n-let didWarnRemoveAll = false\n-\n // Some of these base methods call others and we don't want them to call the patched version so we\n // need a way to synchronously disable the patch temporarily.\n let bypassPatch = false\n@@ -140,6 +185,8 @@ function patchWithoutReentrancy<T extends UnderlyingMethod>(\n   return patched\n }\n \n+const MACGUFFIN_EVENT = 'Next.UnhandledRejectionFilter.MacguffinEvent'\n+\n /**\n  * Installs a filtering unhandled rejection handler that intelligently suppresses\n  * rejections from aborted prerender contexts.\n@@ -148,14 +195,13 @@ function patchWithoutReentrancy<T extends UnderlyingMethod>(\n  */\n function installUnhandledRejectionFilter(): void {\n   if (filterInstalled) {\n-    debug?.('unexpected second install')\n+    warnWithTrace?.(\n+      'Unexpected subsequent filter installation. This is a bug in Next.js'\n+    )\n     return\n   }\n \n-  debug?.(\n-    'installUnhandledRejectionFilter',\n-    process.listeners('unhandledRejection').map((l) => l.toString())\n-  )\n+  debug?.('Installing Filter')\n \n   // Capture existing handlers\n   underlyingListeners = Array.from(process.listeners('unhandledRejection'))\n@@ -186,7 +232,20 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessAddListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.addListener', listener.toString())\n+        debugWithTrace?.(\n+          `Appending 'unhandledRejection' listener with name \\`${listener.name}\\`.`\n+        )\n+        // We add the listener to a dummy event in case it throws. We don't catch it intentionally\n+        try {\n+          originalProcessAddListener.call(\n+            process,\n+            MACGUFFIN_EVENT as any,\n+            listener\n+          )\n+        } finally {\n+          // We clean up the added event\n+          originalProcessRemoveAllListeners.call(process, MACGUFFIN_EVENT)\n+        }\n         // Add new handlers to our internal queue instead of the process\n         underlyingListeners.push(listener as NodeJS.UnhandledRejectionListener)\n         listenerMetadata.push({ listener, once: false })\n@@ -202,20 +261,35 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessRemoveListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.removeListener', listener.toString())\n         // Check if they're trying to remove our filtering handler\n         if (listener === filteringUnhandledRejectionHandler) {\n+          warnUninstalledOnce?.(\n+            `Uninstalling filter because \\`process.removeListener('unhandledRejection', listener)\\` was called with the filter listener. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.`\n+          )\n           uninstallUnhandledRejectionFilter()\n           return process\n         }\n \n+        debugWithTrace?.(\n+          `Removing 'unhandledRejection' listener with name \\`${listener.name}\\`.`\n+        )\n+        // We remove the listener on a dummy event in case it throws. We don't catch it intentionally\n+        originalProcessRemoveListener.call(\n+          process,\n+          MACGUFFIN_EVENT as any,\n+          listener\n+        )\n         const index = underlyingListeners.lastIndexOf(listener)\n         if (index > -1) {\n-          debug?.('process.removeListener match found', index)\n+          debug?.(`listener found index ${index} and removed.`)\n           underlyingListeners.splice(index, 1)\n           listenerMetadata.splice(index, 1)\n         } else {\n-          debug?.('process.removeListener match not found', index)\n+          debug?.(`listener not found.`)\n         }\n         return process\n       }\n@@ -233,7 +307,16 @@ function installUnhandledRejectionFilter(): void {\n       listener: (...args: any[]) => void\n     ) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.on', listener.toString())\n+        debugWithTrace?.(\n+          `Appending 'unhandledRejection' listener with name \\`${listener.name}\\`.`\n+        )\n+        // We add the listener to a dummy event in case it throws. We don't catch it intentionally\n+        try {\n+          originalProcessOn.call(process, MACGUFFIN_EVENT as any, listener)\n+        } finally {\n+          // We clean up the added event\n+          originalProcessRemoveAllListeners.call(process, MACGUFFIN_EVENT)\n+        }\n         // Add new handlers to our internal queue instead of the process\n         underlyingListeners.push(listener as NodeJS.UnhandledRejectionListener)\n         listenerMetadata.push({ listener, once: false })\n@@ -253,20 +336,31 @@ function installUnhandledRejectionFilter(): void {\n       listener: (...args: any[]) => void\n     ) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.off', listener.toString())\n         // Check if they're trying to remove our filtering handler\n         if (listener === filteringUnhandledRejectionHandler) {\n+          warnUninstalledOnce?.(\n+            `Uninstalling filter because \\`process.off('unhandledRejection', listener)\\` was called with the filter listener. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.`\n+          )\n           uninstallUnhandledRejectionFilter()\n           return process\n         }\n \n+        debugWithTrace?.(\n+          `Removing 'unhandledRejection' listener with name \\`${listener.name}\\`.`\n+        )\n+        // We remove the listener on a dummy event in case it throws. We don't catch it intentionally\n+        originalProcessOff.call(process, MACGUFFIN_EVENT as any, listener)\n         const index = underlyingListeners.lastIndexOf(listener)\n         if (index > -1) {\n-          debug?.('process.off match found', index)\n+          debug?.(`listener found index ${index} and removed.`)\n           underlyingListeners.splice(index, 1)\n           listenerMetadata.splice(index, 1)\n         } else {\n-          debug?.('process.off match not found', index)\n+          debug?.(`listener not found.`)\n         }\n         return process\n       }\n@@ -280,14 +374,21 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessPrependListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.prependListener', listener.toString())\n-        if (didWarnPrepend === false) {\n-          didWarnPrepend = true\n-          console.warn(\n-            'Warning: `prependListener(\"unhandledRejection\")` called, but Next.js maintains the first listener ' +\n-              'which filters out unnecessary events from aborted prerenders. Your handler will be second.'\n+        debugWithTrace?.(\n+          `(Prepending) Inserting 'unhandledRejection' listener with name \\`${listener.name}\\` immediately following the Next.js 'unhandledRejection' filter listener.`\n+        )\n+        // We add the listener to a dummy event in case it throws. We don't catch it intentionally\n+        try {\n+          originalProcessPrependListener.call(\n+            process,\n+            MACGUFFIN_EVENT as any,\n+            listener\n           )\n+        } finally {\n+          // We clean up the added event\n+          originalProcessRemoveAllListeners.call(process, MACGUFFIN_EVENT)\n         }\n+\n         // Add new handlers to the beginning of our internal queue\n         underlyingListeners.unshift(\n           listener as NodeJS.UnhandledRejectionListener\n@@ -310,7 +411,16 @@ function installUnhandledRejectionFilter(): void {\n     listener: (...args: any[]) => void\n   ) {\n     if (event === 'unhandledRejection') {\n-      debug?.('process.once', listener.toString())\n+      debugWithTrace?.(\n+        `Appending 'unhandledRejection' once-listener with name \\`${listener.name}\\`.`\n+      )\n+      // We add the listener to a dummy event in case it throws. We don't catch it intentionally\n+      try {\n+        originalProcessOnce.call(process, MACGUFFIN_EVENT as any, listener)\n+      } finally {\n+        // We clean up the added event\n+        originalProcessRemoveAllListeners.call(process, MACGUFFIN_EVENT)\n+      }\n       underlyingListeners.push(listener as NodeJS.UnhandledRejectionListener)\n       listenerMetadata.push({\n         listener: listener as NodeJS.UnhandledRejectionListener,\n@@ -327,14 +437,21 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessPrependOnceListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n-        debug?.('process.prependOnceListener', listener.toString())\n-        if (didWarnPrepend === false) {\n-          didWarnPrepend = true\n-          console.warn(\n-            'Warning: `prependOnceListener(\"unhandledRejection\")` called, but Next.js maintains the first listener ' +\n-              'which filters out unnecessary events from aborted prerenders. Your handler will be second.'\n+        debugWithTrace?.(\n+          `(Prepending) Inserting 'unhandledRejection' once-listener with name \\`${listener.name}\\` immediately following the Next.js 'unhandledRejection' filter listener.`\n+        )\n+        // We add the listener to a dummy event in case it throws. We don't catch it intentionally\n+        try {\n+          originalProcessPrependOnceListener.call(\n+            process,\n+            MACGUFFIN_EVENT as any,\n+            listener\n           )\n+        } finally {\n+          // We clean up the added event\n+          originalProcessRemoveAllListeners.call(process, MACGUFFIN_EVENT)\n         }\n+\n         // Add to the beginning of our internal queue\n         underlyingListeners.unshift(\n           listener as NodeJS.UnhandledRejectionListener\n@@ -359,19 +476,20 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessRemoveAllListeners,\n     function (event?: string | symbol) {\n       if (event === 'unhandledRejection') {\n-        debug?.(\n-          'process.removeAllListeners',\n-          underlyingListeners.map((l) => l.toString())\n+        // TODO add warning for this case once we stop importing this in test scopes automatically. Currently\n+        // we pull this file in whenever build/utils.tsx is imported which is not the right layering.\n+        // The extensions should be loaded from entrypoints like build/index or next-server\n+        //         warnRemoveAllOnce?.(\n+        //           `\\`process.removeAllListeners('unhandledRejection')\\` was called. Next.js maintains the first 'unhandledRejection' listener to filter out unnecessary rejection warnings caused by aborting prerenders early. It is not recommended that you uninstall this behavior, but if you want to you must you can acquire the listener with \\`process.listeners('unhandledRejection')[0]\\` and remove it with \\`process.removeListener('unhandledRejection', listener)\\`.\n+\n+        // You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+        // You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.`\n+        //         )\n+        debugWithTrace?.(\n+          `Removing all 'unhandledRejection' listeners except for the Next.js filter.`\n         )\n-        if (didWarnRemoveAll === false) {\n-          didWarnRemoveAll = true\n-          console.warn(\n-            'Warning: `removeAllListeners(\"unhandledRejection\")` called. Next.js maintains an `unhandledRejection` listener ' +\n-              'to filter out unnecessary rejection warnings caused by aborting prerenders early. It is not recommended that you ' +\n-              'uninstall this behavior, but if you want to you must call `process.removeListener(\"unhandledRejection\", listener)`. ' +\n-              'You can acquire the listener from `process.listeners(\"unhandledRejection\")[0]`.'\n-          )\n-        }\n+\n         underlyingListeners.length = 0\n         listenerMetadata.length = 0\n         return process\n@@ -383,9 +501,12 @@ function installUnhandledRejectionFilter(): void {\n       }\n \n       // If no event specified (removeAllListeners()), uninstall our patch completely\n-      console.warn(\n-        'Warning: `removeAllListeners()` called - uninstalling Next.js unhandled rejection filter. ' +\n-          'You will observe `unhandledRejection` logs from prerendering which are not problematic.'\n+      warnUninstalledOnce?.(\n+        `Uninstalling filter because \\`process.removeAllListeners()\\` was called. Uninstalling this filter is not recommended and will cause you to observe 'unhandledRejection' events related to intentionally aborted prerenders.\n+\n+You can silence warnings related to this behavior by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=silent\\` environment variable.\n+\n+You can debug event listener operations by running Next.js with \\`NEXT_UNHANDLED_REJECTION_FILTER=debug\\` environment variable.`\n       )\n       uninstallUnhandledRejectionFilter()\n       return originalProcessRemoveAllListeners.call(process)\n@@ -397,31 +518,14 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessListeners,\n     function (event: string | symbol) {\n       if (event === 'unhandledRejection') {\n-        debug?.(\n-          'process.listeners',\n-          [filteringUnhandledRejectionHandler, ...underlyingListeners].map(\n-            (l) => l.toString()\n-          )\n-        )\n+        debugWithTrace?.(`Retrieving all 'unhandledRejection' listeners.`)\n         return [filteringUnhandledRejectionHandler, ...underlyingListeners]\n       }\n       return originalProcessListeners.call(process, event as any)\n     } as typeof process.listeners\n   )\n \n   filterInstalled = true\n-\n-  debug?.(\n-    'after install actual listeners',\n-    originalProcessListeners\n-      .call(process, 'unhandledRejection' as any)\n-      .map((l) => l.toString())\n-  )\n-\n-  debug?.(\n-    'after install listeners',\n-    process.listeners('unhandledRejection').map((l) => l.toString())\n-  )\n }\n \n /**\n@@ -431,16 +535,13 @@ function installUnhandledRejectionFilter(): void {\n  */\n function uninstallUnhandledRejectionFilter(): void {\n   if (!filterInstalled) {\n-    debug?.('unexpected second uninstall')\n+    warnWithTrace?.(\n+      'Unexpected subsequent filter uninstallation. This is a bug in Next.js'\n+    )\n     return\n   }\n \n-  debug?.(\n-    'uninstallUnhandledRejectionFilter',\n-    [filteringUnhandledRejectionHandler, ...underlyingListeners].map((l) =>\n-      l.toString()\n-    )\n-  )\n+  debug?.('Uninstalling Filter')\n \n   // Restore original process methods\n   process.on = originalProcessOn\n@@ -472,11 +573,6 @@ function uninstallUnhandledRejectionFilter(): void {\n   filterInstalled = false\n   underlyingListeners.length = 0\n   listenerMetadata.length = 0\n-\n-  debug?.(\n-    'after uninstall',\n-    process.listeners('unhandledRejection').map((l) => l.toString())\n-  )\n }\n \n /**"
        },
        {
            "sha": "60befcba76255377a22e4ff9a4f52fbd67d53657",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-console-patch.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0cd530ad8699b433a52c1459ef4d6c06de286ee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0cd530ad8699b433a52c1459ef4d6c06de286ee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts?ref=c0cd530ad8699b433a52c1459ef4d6c06de286ee",
            "patch": "@@ -7,7 +7,6 @@ describe('Cache Components Errors', () => {\n     skipDeployment: true,\n     skipStart: !isNextDev,\n     env: {\n-      NEXT_USE_UNHANDLED_REJECTION_FILTER: 'enabled',\n       NODE_OPTIONS: '--require ./patch-console.js',\n     },\n   })"
        },
        {
            "sha": "0751ed9a2aca3843d8065562efbf2fa9cb5474a5",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c0cd530ad8699b433a52c1459ef4d6c06de286ee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0cd530ad8699b433a52c1459ef4d6c06de286ee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=c0cd530ad8699b433a52c1459ef4d6c06de286ee",
            "patch": "@@ -7,9 +7,6 @@ describe('Cache Components Errors', () => {\n     files: __dirname + '/fixtures/default',\n     skipStart: !isNextDev,\n     skipDeployment: true,\n-    env: {\n-      NEXT_USE_UNHANDLED_REJECTION_FILTER: 'enabled',\n-    },\n   })\n   const isRspack = !!process.env.NEXT_RSPACK\n "
        }
    ],
    "stats": {
        "total": 409,
        "additions": 305,
        "deletions": 104
    }
}