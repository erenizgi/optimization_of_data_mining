{
    "author": "gnoff",
    "message": "Track fallback params on workUnitStore (#82003)\n\nfallbackParams are current tracked on the work store but the work store\ncan conceptually be scoped around more than one logical render. A\npractical example of this is where we want to dynamically render a page\nin dev with all params but validate a prerender in dev simultaneously\nwith some fallback params. This change only moves the param tracking\nlocation in preparation for this future use.",
    "sha": "27e2e749f8db25473ffc4392a365ffe3001ed530",
    "files": [
        {
            "sha": "5200ee04a1f16fb3fa2d24c36112cbc36bc462b6",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -755,5 +755,6 @@\n   \"754\": \"%s cannot be used outside of a request context.\",\n   \"755\": \"Route must be a string\",\n   \"756\": \"Route %s not found\",\n-  \"757\": \"Unknown styled string type: %s\"\n+  \"757\": \"Unknown styled string type: %s\",\n+  \"758\": \"Missing workStore in useDynamicRouteParams\"\n }"
        },
        {
            "sha": "d11ba4ac8ac01de07bd29b1ac0ea244df02433f3",
            "filename": "packages/next/src/build/static-paths/app.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fstatic-paths%2Fapp.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -687,9 +687,6 @@ export async function buildAppStaticPaths({\n \n   const store = createWorkStore({\n     page,\n-    // We're discovering the parameters here, so we don't have any unknown\n-    // ones.\n-    fallbackRouteParams: null,\n     renderOpts: {\n       incrementalCache,\n       cacheLifeProfiles,"
        },
        {
            "sha": "335f6e92e8e94c5b7df3244851e9e6251cc494a7",
            "filename": "packages/next/src/client/components/navigation-untracked.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-untracked.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-untracked.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-untracked.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -7,19 +7,32 @@ import { PathnameContext } from '../../shared/lib/hooks-client-context.shared-ru\n  *\n  * @returns true if there are any unknown route parameters, false otherwise\n  */\n-function hasFallbackRouteParams() {\n+function hasFallbackRouteParams(): boolean {\n   if (typeof window === 'undefined') {\n     // AsyncLocalStorage should not be included in the client bundle.\n-    const { workAsyncStorage } =\n-      require('../../server/app-render/work-async-storage.external') as typeof import('../../server/app-render/work-async-storage.external')\n+    const { workUnitAsyncStorage } =\n+      require('../../server/app-render/work-unit-async-storage.external') as typeof import('../../server/app-render/work-unit-async-storage.external')\n \n-    const workStore = workAsyncStorage.getStore()\n-    if (!workStore) return false\n+    const workUnitStore = workUnitAsyncStorage.getStore()\n+    if (!workUnitStore) return false\n \n-    const { fallbackRouteParams } = workStore\n-    if (!fallbackRouteParams || fallbackRouteParams.size === 0) return false\n+    switch (workUnitStore.type) {\n+      case 'prerender':\n+      case 'prerender-client':\n+      case 'prerender-ppr':\n+        const fallbackParams = workUnitStore.fallbackRouteParams\n+        return fallbackParams ? fallbackParams.size > 0 : false\n+      case 'prerender-legacy':\n+      case 'request':\n+      case 'cache':\n+      case 'private-cache':\n+      case 'unstable-cache':\n+        break\n+      default:\n+        workUnitStore satisfies never\n+    }\n \n-    return true\n+    return false\n   }\n \n   return false"
        },
        {
            "sha": "cfddda3288cb09c8485a15e33598fe459757ef99",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 24,
            "deletions": 8,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -732,6 +732,10 @@ async function warmupDevRender(\n     renderResumeDataCache: null,\n     hmrRefreshHash: req.cookies[NEXT_HMR_REFRESH_HASH_COOKIE],\n     captureOwnerStack: ComponentMod.captureOwnerStack,\n+    // warmup is a dev only feature and no fallback params are used in the\n+    // primary render which is static. We only use a prerender store here to\n+    // allow the warmup to halt on Request data APIs and fetches.\n+    fallbackRouteParams: null,\n   }\n \n   const rscPayload = await workUnitAsyncStorage.run(\n@@ -1192,7 +1196,8 @@ async function renderToHTMLOrFlightImpl(\n   requestEndedState: { ended?: boolean },\n   postponedState: PostponedState | null,\n   serverComponentsHmrCache: ServerComponentsHmrCache | undefined,\n-  sharedContext: AppSharedContext\n+  sharedContext: AppSharedContext,\n+  fallbackRouteParams: FallbackRouteParams | null\n ) {\n   const isNotFoundPath = pagePath === '/404'\n   if (isNotFoundPath) {\n@@ -1356,7 +1361,7 @@ async function renderToHTMLOrFlightImpl(\n     nonce,\n   } = parsedRequestHeaders\n \n-  const { isStaticGeneration, fallbackRouteParams } = workStore\n+  const { isStaticGeneration } = workStore\n \n   /**\n    * The metadata items array created in next-app-loader with all relevant information\n@@ -1440,7 +1445,8 @@ async function renderToHTMLOrFlightImpl(\n       res,\n       ctx,\n       metadata,\n-      loaderTree\n+      loaderTree,\n+      fallbackRouteParams\n     )\n \n     // If we're debugging partial prerendering, print all the dynamic API accesses\n@@ -1756,7 +1762,6 @@ export const renderToHTMLOrFlight: AppPageRender = (\n \n   const workStore = createWorkStore({\n     page: renderOpts.routeModule.definition.page,\n-    fallbackRouteParams,\n     renderOpts,\n     requestEndedState,\n     // @TODO move to workUnitStore of type Request\n@@ -1781,7 +1786,8 @@ export const renderToHTMLOrFlight: AppPageRender = (\n     requestEndedState,\n     postponedState,\n     serverComponentsHmrCache,\n-    sharedContext\n+    sharedContext,\n+    fallbackRouteParams\n   )\n }\n \n@@ -2363,6 +2369,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n+    fallbackRouteParams: null,\n     implicitTags,\n     renderSignal: initialServerRenderController.signal,\n     controller: initialServerPrerenderController,\n@@ -2494,6 +2501,7 @@ async function spawnDynamicValidationInDev(\n       type: 'prerender-client',\n       phase: 'render',\n       rootParams,\n+      fallbackRouteParams: null,\n       implicitTags,\n       renderSignal: initialClientRenderController.signal,\n       controller: initialClientPrerenderController,\n@@ -2602,6 +2610,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n+    fallbackRouteParams: null,\n     implicitTags,\n     renderSignal: finalServerRenderController.signal,\n     controller: finalServerReactController,\n@@ -2689,6 +2698,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender-client',\n     phase: 'render',\n     rootParams,\n+    fallbackRouteParams: null,\n     implicitTags,\n     renderSignal: finalClientRenderController.signal,\n     controller: finalClientReactController,\n@@ -2851,7 +2861,8 @@ async function prerenderToStream(\n   res: BaseNextResponse,\n   ctx: AppRenderContext,\n   metadata: AppPageRenderResultMetadata,\n-  tree: LoaderTree\n+  tree: LoaderTree,\n+  fallbackRouteParams: FallbackRouteParams | null\n ): Promise<PrerenderToStreamResult> {\n   // When prerendering formState is always null. We still include it\n   // because some shared APIs expect a formState value and this is slightly\n@@ -2889,7 +2900,6 @@ async function prerenderToStream(\n   assertClientReferenceManifest(clientReferenceManifest)\n \n   const rootParams = getRootParams(tree, getDynamicParamFromSegment)\n-  const fallbackRouteParams = workStore.fallbackRouteParams\n \n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n@@ -3057,6 +3067,7 @@ async function prerenderToStream(\n         type: 'prerender',\n         phase: 'render',\n         rootParams,\n+        fallbackRouteParams,\n         implicitTags,\n         renderSignal: initialServerRenderController.signal,\n         controller: initialServerPrerenderController,\n@@ -3181,6 +3192,7 @@ async function prerenderToStream(\n           type: 'prerender-client',\n           phase: 'render',\n           rootParams,\n+          fallbackRouteParams,\n           implicitTags,\n           renderSignal: initialClientRenderController.signal,\n           controller: initialClientPrerenderController,\n@@ -3289,6 +3301,7 @@ async function prerenderToStream(\n         type: 'prerender',\n         phase: 'render',\n         rootParams,\n+        fallbackRouteParams,\n         implicitTags,\n         renderSignal: finalServerRenderController.signal,\n         controller: finalServerReactController,\n@@ -3381,6 +3394,7 @@ async function prerenderToStream(\n         type: 'prerender-client',\n         phase: 'render',\n         rootParams,\n+        fallbackRouteParams,\n         implicitTags,\n         renderSignal: finalClientRenderController.signal,\n         controller: finalClientReactController,\n@@ -3506,7 +3520,7 @@ async function prerenderToStream(\n       // move the fallback route params out of the flight router state, we need\n       // to always perform a dynamic resume after the static prerender.\n       const hasFallbackRouteParams =\n-        workStore.fallbackRouteParams && workStore.fallbackRouteParams.size > 0\n+        fallbackRouteParams && fallbackRouteParams.size > 0\n \n       if (serverIsDynamic || hasFallbackRouteParams) {\n         // Dynamic case\n@@ -3624,6 +3638,7 @@ async function prerenderToStream(\n         type: 'prerender-ppr',\n         phase: 'render',\n         rootParams,\n+        fallbackRouteParams,\n         implicitTags,\n         dynamicTracking,\n         revalidate: INFINITE_CACHE,\n@@ -3658,6 +3673,7 @@ async function prerenderToStream(\n         type: 'prerender-ppr',\n         phase: 'render',\n         rootParams,\n+        fallbackRouteParams,\n         implicitTags,\n         dynamicTracking,\n         revalidate: INFINITE_CACHE,"
        },
        {
            "sha": "9e1ca07f214ea36203cc8eefdd7ad0161f2e0cac",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -752,10 +752,8 @@ async function createComponentTreeInternal(\n     let pageElement: React.ReactNode\n     if (isClientComponent) {\n       if (isStaticGeneration) {\n-        const promiseOfParams = createPrerenderParamsForClientSegment(\n-          currentParams,\n-          workStore\n-        )\n+        const promiseOfParams =\n+          createPrerenderParamsForClientSegment(currentParams)\n         const promiseOfSearchParams =\n           createPrerenderSearchParamsForClientPage(workStore)\n         pageElement = (\n@@ -851,10 +849,8 @@ async function createComponentTreeInternal(\n       let clientSegment: React.ReactNode\n \n       if (isStaticGeneration) {\n-        const promiseOfParams = createPrerenderParamsForClientSegment(\n-          currentParams,\n-          workStore\n-        )\n+        const promiseOfParams =\n+          createPrerenderParamsForClientSegment(currentParams)\n \n         clientSegment = (\n           <ClientSegmentRoot"
        },
        {
            "sha": "adc033297c9ca57e8bafad056000c7a449b619bd",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 33,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -568,49 +568,48 @@ export function annotateDynamicAccess(\n }\n \n export function useDynamicRouteParams(expression: string) {\n-  const workStore = workAsyncStorage.getStore()\n-\n-  if (\n-    workStore &&\n-    workStore.isStaticGeneration &&\n-    workStore.fallbackRouteParams &&\n-    workStore.fallbackRouteParams.size > 0\n-  ) {\n-    // There are fallback route params, we should track these as dynamic\n-    // accesses.\n-    const workUnitStore = workUnitAsyncStorage.getStore()\n-    if (workUnitStore) {\n-      switch (workUnitStore.type) {\n-        case 'prerender':\n-        case 'prerender-client':\n+  const workUnitStore = workUnitAsyncStorage.getStore()\n+  if (workUnitStore) {\n+    switch (workUnitStore.type) {\n+      case 'prerender-client':\n+      case 'prerender': {\n+        const fallbackParams = workUnitStore.fallbackRouteParams\n+        if (fallbackParams && fallbackParams.size > 0) {\n           // We are in a prerender with cacheComponents semantics. We are going to\n           // hang here and never resolve. This will cause the currently\n           // rendering component to effectively be a dynamic hole.\n           React.use(makeHangingPromise(workUnitStore.renderSignal, expression))\n-          break\n-        case 'prerender-ppr':\n+        }\n+        break\n+      }\n+      case 'prerender-ppr': {\n+        const fallbackParams = workUnitStore.fallbackRouteParams\n+        if (fallbackParams && fallbackParams.size > 0) {\n+          const workStore = workAsyncStorage.getStore()\n+          if (!workStore) {\n+            throw new InvariantError(\n+              'Missing workStore in useDynamicRouteParams'\n+            )\n+          }\n           return postponeWithTracking(\n             workStore.route,\n             expression,\n             workUnitStore.dynamicTracking\n           )\n-        case 'prerender-legacy':\n-          return throwToInterruptStaticGeneration(\n-            expression,\n-            workStore,\n-            workUnitStore\n-          )\n-        case 'cache':\n-        case 'private-cache':\n-          throw new InvariantError(\n-            `\\`${expression}\\` was called inside a cache scope. Next.js should be preventing ${expression} from being included in server components statically, but did not in this case.`\n-          )\n-        case 'request':\n-        case 'unstable-cache':\n-          break\n-        default:\n-          workUnitStore satisfies never\n+        }\n+        break\n       }\n+      case 'cache':\n+      case 'private-cache':\n+        throw new InvariantError(\n+          `\\`${expression}\\` was called inside a cache scope. Next.js should be preventing ${expression} from being included in server components statically, but did not in this case.`\n+        )\n+      case 'prerender-legacy':\n+      case 'request':\n+      case 'unstable-cache':\n+        break\n+      default:\n+        workUnitStore satisfies never\n     }\n   }\n }"
        },
        {
            "sha": "50c3723e0e5d5c29090033b66761c39b7b8f3e01",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -1,7 +1,6 @@\n import type { AsyncLocalStorage } from 'async_hooks'\n import type { IncrementalCache } from '../lib/incremental-cache'\n import type { FetchMetrics } from '../base-http'\n-import type { FallbackRouteParams } from '../request/fallback-params'\n import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import type { AppSegmentConfig } from '../../build/segment-config/app/app-segment-config'\n import type { AfterContext } from '../after/after-context'\n@@ -25,12 +24,6 @@ export interface WorkStore {\n    */\n   readonly route: string\n \n-  /**\n-   * The set of unknown route parameters. Accessing these will be tracked as\n-   * a dynamic access.\n-   */\n-  readonly fallbackRouteParams: FallbackRouteParams | null\n-\n   readonly incrementalCache?: IncrementalCache\n   readonly cacheLifeProfiles?: { [profile: string]: CacheLife }\n "
        },
        {
            "sha": "321750f5dd29e5bb57f64500f15d72227cf28377",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -5,6 +5,7 @@ import type { ReadonlyHeaders } from '../web/spec-extension/adapters/headers'\n import type { ReadonlyRequestCookies } from '../web/spec-extension/adapters/request-cookies'\n import type { CacheSignal } from './cache-signal'\n import type { DynamicTrackingState } from './dynamic-rendering'\n+import type { FallbackRouteParams } from '../request/fallback-params'\n \n // Share the instance module in the next-shared layer\n import { workUnitAsyncStorageInstance } from './work-unit-async-storage-instance' with { 'turbopack-transition': 'next-shared' }\n@@ -138,6 +139,12 @@ interface PrerenderStoreModernCommon\n \n   readonly rootParams: Params\n \n+  /**\n+   * The set of unknown route parameters. Accessing these will be tracked as\n+   * a dynamic access.\n+   */\n+  readonly fallbackRouteParams: FallbackRouteParams | null\n+\n   /**\n    * When true, the page is prerendered as a fallback shell, while allowing any\n    * dynamic accesses to result in an empty shell. This is the case when there\n@@ -179,6 +186,12 @@ export interface PrerenderStorePPR\n   readonly rootParams: Params\n   readonly dynamicTracking: null | DynamicTrackingState\n \n+  /**\n+   * The set of unknown route parameters. Accessing these will be tracked as\n+   * a dynamic access.\n+   */\n+  readonly fallbackRouteParams: FallbackRouteParams | null\n+\n   /**\n    * The resume data cache for this prerender.\n    */"
        },
        {
            "sha": "3b0d3fbe9266aa4c1fe9ac5d0e52608b559763da",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -3,7 +3,6 @@ import type { IncrementalCache } from '../lib/incremental-cache'\n import type { RenderOpts } from '../app-render/types'\n import type { FetchMetric } from '../base-http'\n import type { RequestLifecycleOpts } from '../base-server'\n-import type { FallbackRouteParams } from '../request/fallback-params'\n import type { AppSegmentConfig } from '../../build/segment-config/app/app-segment-config'\n import type { CacheLife } from '../use-cache/cache-life'\n \n@@ -20,11 +19,6 @@ export type WorkStoreContext = {\n    */\n   page: string\n \n-  /**\n-   * The route parameters that are currently unknown.\n-   */\n-  fallbackRouteParams: FallbackRouteParams | null\n-\n   requestEndedState?: { ended?: boolean }\n   isPrefetchRequest?: boolean\n   renderOpts: {\n@@ -82,7 +76,6 @@ export type WorkStoreContext = {\n \n export function createWorkStore({\n   page,\n-  fallbackRouteParams,\n   renderOpts,\n   requestEndedState,\n   isPrefetchRequest,\n@@ -115,7 +108,6 @@ export function createWorkStore({\n   const store: WorkStore = {\n     isStaticGeneration,\n     page,\n-    fallbackRouteParams,\n     route: normalizeAppPath(page),\n     incrementalCache:\n       // we fallback to a global incremental cache for edge-runtime locally"
        },
        {
            "sha": "c4e97d072d4da085c4a6ae96def61104ae0b8685",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 30,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -143,15 +143,14 @@ export function createServerParamsForServerSegment(\n }\n \n export function createPrerenderParamsForClientSegment(\n-  underlyingParams: Params,\n-  workStore: WorkStore\n+  underlyingParams: Params\n ): Promise<Params> {\n   const workUnitStore = workUnitAsyncStorage.getStore()\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n       case 'prerender-client':\n-        const fallbackParams = workStore.fallbackRouteParams\n+        const fallbackParams = workUnitStore.fallbackRouteParams\n         if (fallbackParams) {\n           for (let key in underlyingParams) {\n             if (fallbackParams.has(key)) {\n@@ -189,39 +188,50 @@ function createPrerenderParams(\n   workStore: WorkStore,\n   prerenderStore: PrerenderStore\n ): Promise<Params> {\n-  const fallbackParams = workStore.fallbackRouteParams\n-  if (fallbackParams) {\n-    let hasSomeFallbackParams = false\n-    for (const key in underlyingParams) {\n-      if (fallbackParams.has(key)) {\n-        hasSomeFallbackParams = true\n-        break\n+  switch (prerenderStore.type) {\n+    case 'prerender':\n+    case 'prerender-client': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams) {\n+        for (const key in underlyingParams) {\n+          if (fallbackParams.has(key)) {\n+            // This params object has one or more fallback params, so we need\n+            // to consider the awaiting of this params object \"dynamic\". Since\n+            // we are in cacheComponents mode we encode this as a promise that never\n+            // resolves.\n+            return makeHangingParams(underlyingParams, prerenderStore)\n+          }\n+        }\n       }\n+      break\n     }\n-\n-    if (hasSomeFallbackParams) {\n-      // params need to be treated as dynamic because we have at least one fallback param\n-      switch (prerenderStore.type) {\n-        case 'prerender':\n-        case 'prerender-client':\n-          // We are in a cacheComponents prerender\n-          return makeHangingParams(underlyingParams, prerenderStore)\n-        case 'prerender-ppr':\n-        case 'prerender-legacy':\n-          return makeErroringExoticParams(\n-            underlyingParams,\n-            fallbackParams,\n-            workStore,\n-            prerenderStore\n-          )\n-        default:\n-          prerenderStore satisfies never\n+    case 'prerender-ppr': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams) {\n+        for (const key in underlyingParams) {\n+          if (fallbackParams.has(key)) {\n+            return makeErroringExoticParams(\n+              underlyingParams,\n+              fallbackParams,\n+              workStore,\n+              prerenderStore\n+            )\n+          }\n+        }\n       }\n+      break\n     }\n+    case 'prerender-legacy':\n+      break\n+    default:\n+      prerenderStore satisfies never\n   }\n \n-  // We don't have any fallback params so we have an entirely static safe params object\n-  return makeUntrackedExoticParams(underlyingParams)\n+  if (process.env.__NEXT_CACHE_COMPONENTS) {\n+    return makeUntrackedParams(underlyingParams)\n+  } else {\n+    return makeUntrackedExoticParams(underlyingParams)\n+  }\n }\n \n function createRenderParams("
        },
        {
            "sha": "15ea7656e32e6e125f2660cde698e4a450504ac4",
            "filename": "packages/next/src/server/request/pathname.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -49,25 +49,32 @@ function createPrerenderPathname(\n   workStore: WorkStore,\n   prerenderStore: PrerenderStore\n ): Promise<string> {\n-  const fallbackParams = workStore.fallbackRouteParams\n-  if (fallbackParams && fallbackParams.size > 0) {\n-    switch (prerenderStore.type) {\n-      case 'prerender':\n+  switch (prerenderStore.type) {\n+    case 'prerender-client':\n+      throw new InvariantError(\n+        'createPrerenderPathname was called inside a client component scope.'\n+      )\n+    case 'prerender': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams && fallbackParams.size > 0) {\n         return makeHangingPromise<string>(\n           prerenderStore.renderSignal,\n           '`pathname`'\n         )\n-      case 'prerender-client':\n-        throw new InvariantError(\n-          'createPrerenderPathname was called inside a client component scope.'\n-        )\n-      case 'prerender-ppr':\n+      }\n+      break\n+    }\n+    case 'prerender-ppr': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams && fallbackParams.size > 0) {\n         return makeErroringPathname(workStore, prerenderStore.dynamicTracking)\n-      case 'prerender-legacy':\n-        return makeErroringPathname(workStore, null)\n-      default:\n-        prerenderStore satisfies never\n+      }\n+      break\n     }\n+    case 'prerender-legacy':\n+      break\n+    default:\n+      prerenderStore satisfies never\n   }\n \n   // We don't have any fallback params so we have an entirely static safe params object"
        },
        {
            "sha": "9a083c56b3657823da03cfdeabffe68a9922f6fc",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 42,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -74,54 +74,50 @@ function createPrerenderRootParams(\n         `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n       )\n     }\n-    case 'prerender':\n-    case 'prerender-legacy':\n-    case 'prerender-ppr':\n-    default:\n-  }\n+    case 'prerender': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams) {\n+        for (const key in underlyingParams) {\n+          if (fallbackParams.has(key)) {\n+            const cachedParams = CachedParams.get(underlyingParams)\n+            if (cachedParams) {\n+              return cachedParams\n+            }\n+\n+            const promise = makeHangingPromise<Params>(\n+              prerenderStore.renderSignal,\n+              '`unstable_rootParams`'\n+            )\n+            CachedParams.set(underlyingParams, promise)\n \n-  const fallbackParams = workStore.fallbackRouteParams\n-  if (fallbackParams) {\n-    let hasSomeFallbackParams = false\n-    for (const key in underlyingParams) {\n-      if (fallbackParams.has(key)) {\n-        hasSomeFallbackParams = true\n-        break\n+            return promise\n+          }\n+        }\n       }\n+      break\n     }\n-\n-    if (hasSomeFallbackParams) {\n-      // params need to be treated as dynamic because we have at least one fallback param\n-      switch (prerenderStore.type) {\n-        case 'prerender':\n-          // We are in a cacheComponents prerender\n-          const cachedParams = CachedParams.get(underlyingParams)\n-          if (cachedParams) {\n-            return cachedParams\n+    case 'prerender-ppr': {\n+      const fallbackParams = prerenderStore.fallbackRouteParams\n+      if (fallbackParams) {\n+        for (const key in underlyingParams) {\n+          if (fallbackParams.has(key)) {\n+            // We have fallback params at this level so we need to make an erroring\n+            // params object which will postpone if you access the fallback params\n+            return makeErroringRootParams(\n+              underlyingParams,\n+              fallbackParams,\n+              workStore,\n+              prerenderStore\n+            )\n           }\n-\n-          const promise = makeHangingPromise<Params>(\n-            prerenderStore.renderSignal,\n-            '`unstable_rootParams`'\n-          )\n-          CachedParams.set(underlyingParams, promise)\n-\n-          return promise\n-        case 'prerender-ppr':\n-        case 'prerender-legacy':\n-          // We aren't in a cacheComponents prerender but we do have fallback params at this\n-          // level so we need to make an erroring params object which will postpone\n-          // if you access the fallback params\n-          return makeErroringRootParams(\n-            underlyingParams,\n-            fallbackParams,\n-            workStore,\n-            prerenderStore\n-          )\n-        default:\n-          prerenderStore satisfies never\n+        }\n       }\n+      break\n     }\n+    case 'prerender-legacy':\n+      break\n+    default:\n+      prerenderStore satisfies never\n   }\n \n   // We don't have any fallback params so we have an entirely static safe params object"
        },
        {
            "sha": "1183b8d444fc0b1f32872ad559e2b36cefdc9df9",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -387,6 +387,7 @@ export class AppRouteRouteModule extends RouteModule<\n               // This replicates prior behavior where rootParams is empty in routes\n               // TODO we need to make this have the proper rootParams for this route\n               rootParams: {},\n+              fallbackRouteParams: null,\n               implicitTags,\n               renderSignal: prospectiveController.signal,\n               controller: prospectiveController,\n@@ -481,6 +482,7 @@ export class AppRouteRouteModule extends RouteModule<\n             type: 'prerender',\n             phase: 'action',\n             rootParams: {},\n+            fallbackRouteParams: null,\n             implicitTags,\n             renderSignal: finalController.signal,\n             controller: finalController,\n@@ -667,8 +669,6 @@ export class AppRouteRouteModule extends RouteModule<\n \n     // Get the context for the static generation.\n     const staticGenerationContext: WorkStoreContext = {\n-      // App Routes don't support unknown route params.\n-      fallbackRouteParams: null,\n       page: this.definition.page,\n       renderOpts: context.renderOpts,\n       buildId: context.sharedContext.buildId,"
        },
        {
            "sha": "735cfb804c018cd3f3c1af6c640778b6f879d379",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -281,7 +281,6 @@ export async function adapter(\n \n             const workStore = createWorkStore({\n               page,\n-              fallbackRouteParams,\n               renderOpts: {\n                 cacheLifeProfiles:\n                   params.request.nextConfig?.experimental?.cacheLife,"
        },
        {
            "sha": "038a852c0af70ee39fdcd27b0b620864838298f8",
            "filename": "test/e2e/app-dir/segment-cache/mpa-navigations/app/(group2)/[rootParam]/(groupA)/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/27e2e749f8db25473ffc4392a365ffe3001ed530/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fapp%2F(group2)%2F%5BrootParam%5D%2F(groupA)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/27e2e749f8db25473ffc4392a365ffe3001ed530/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fapp%2F(group2)%2F%5BrootParam%5D%2F(groupA)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fapp%2F(group2)%2F%5BrootParam%5D%2F(groupA)%2Fpage.tsx?ref=27e2e749f8db25473ffc4392a365ffe3001ed530",
            "patch": "@@ -4,8 +4,10 @@ export function generateStaticParams() {\n   return [{ rootParam: 'foo' }, { rootParam: 'bar' }]\n }\n \n-export default async function Page({ params }) {\n-  const { rootParam } = params\n+export default async function Page(props: {\n+  params: Promise<{ rootParam: string }>\n+}) {\n+  const { rootParam } = await props.params\n   const otherRootParam = rootParam === 'foo' ? 'bar' : 'foo'\n   return (\n     <>"
        }
    ],
    "stats": {
        "total": 366,
        "additions": 200,
        "deletions": 166
    }
}