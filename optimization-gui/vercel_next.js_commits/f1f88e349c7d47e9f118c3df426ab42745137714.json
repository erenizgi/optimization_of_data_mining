{
    "author": "ijjk",
    "message": "Apply normalizers for init URL used for handlers (#80694)\n\nThis applies our normalizers to the `initURL` we pass to the handlers\ninterface as currently it is created before our existing normalizing\ntakes place which causes us to fail to generate the correct cache keys\nfor ISR paths. This specifically breaks our de-duping for client segment\ncache as it relies on the cache key being consistent across all segment\npaths being requested during a revalidation.\n\nIn the future we will have to hoist the URL normalizing anyways so this\nleaves it as is until then.\n\nThis also adds a regression test for the cache key not being normalized\ncausing extra render passes for client segment cache entries when it\nshouldn't have.",
    "sha": "f1f88e349c7d47e9f118c3df426ab42745137714",
    "files": [
        {
            "sha": "1ce467e0b029531ca3fabb1d4048b41aa052dbfc",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f1f88e349c7d47e9f118c3df426ab42745137714/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1f88e349c7d47e9f118c3df426ab42745137714/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=f1f88e349c7d47e9f118c3df426ab42745137714",
            "patch": "@@ -2637,7 +2637,18 @@ export default abstract class Server<\n             const parsedInitUrl = parseUrl(\n               getRequestMeta(req, 'initURL') || req.url\n             )\n-            request.url = `${parsedInitUrl.pathname?.replace(/(\\.prefetch\\.rsc|\\.rsc)$/, '')}${parsedInitUrl.search || ''}`\n+            let initPathname = parsedInitUrl.pathname || '/'\n+\n+            for (const normalizer of [\n+              this.normalizers.segmentPrefetchRSC,\n+              this.normalizers.prefetchRSC,\n+              this.normalizers.rsc,\n+            ]) {\n+              if (normalizer?.match(initPathname)) {\n+                initPathname = normalizer.normalize(initPathname)\n+              }\n+            }\n+            request.url = `${initPathname}${parsedInitUrl.search || ''}`\n \n             // propagate the request context for dev\n             setRequestMeta(request, getRequestMeta(req))"
        },
        {
            "sha": "009e62a873cf5fde02a8bd7d698c912e20932f87",
            "filename": "test/production/standalone-mode/required-server-files/app/isr/[slug]/page.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f1f88e349c7d47e9f118c3df426ab42745137714/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fisr%2F%5Bslug%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1f88e349c7d47e9f118c3df426ab42745137714/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fisr%2F%5Bslug%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Fapp%2Fisr%2F%5Bslug%5D%2Fpage.js?ref=f1f88e349c7d47e9f118c3df426ab42745137714",
            "patch": "@@ -5,6 +5,8 @@ export function generateStaticParams() {\n }\n \n export default async function Page({ params }) {\n+  console.log('rendering /isr/[slug]')\n+\n   const data = await fetch(\n     'https://next-data-api-endpoint.vercel.app/api/random',\n     {"
        },
        {
            "sha": "07f6636fdd73c575bb037cafefb47b3efb70e78e",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-ppr.test.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/f1f88e349c7d47e9f118c3df426ab42745137714/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1f88e349c7d47e9f118c3df426ab42745137714/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts?ref=f1f88e349c7d47e9f118c3df426ab42745137714",
            "patch": "@@ -19,6 +19,7 @@ describe('required server files app router', () => {\n   let appPort: number | string\n   let delayedPostpone\n   let rewritePostpone\n+  let cliOutput = ''\n \n   const setupNext = async ({\n     nextEnv,\n@@ -101,6 +102,12 @@ describe('required server files app router', () => {\n       undefined,\n       {\n         cwd: next.testDir,\n+        onStderr(data) {\n+          cliOutput += data\n+        },\n+        onStdout(data) {\n+          cliOutput += data\n+        },\n       }\n     )\n   }\n@@ -118,6 +125,38 @@ describe('required server files app router', () => {\n     expect(next.cliOutput).not.toContain('ERR_INVALID_URL')\n   })\n \n+  // this enables client segment cache in CI\n+  if (process.env.__NEXT_EXPERIMENTAL_PPR) {\n+    it('should de-dupe client segment tree revalidate requests', async () => {\n+      const { segmentPaths } = await next.readJSON(\n+        'standalone/.next/server/app/isr/first.meta'\n+      )\n+      const outputIdx = cliOutput.length\n+\n+      for (const segmentPath of segmentPaths) {\n+        const outputSegmentPath =\n+          join('/isr/[slug].segments', segmentPath) + '.segment.rsc'\n+\n+        require('console').error('requesting', outputSegmentPath)\n+\n+        const res = await fetchViaHTTP(appPort, outputSegmentPath, undefined, {\n+          headers: {\n+            'x-matched-path': '/isr/[slug].segments/_tree.segment.rsc',\n+            'x-now-route-matches': 'slug=first&1=first',\n+          },\n+        })\n+\n+        expect(res.status).toBe(200)\n+        expect(res.headers.get('content-type')).toBe('text/x-component')\n+      }\n+\n+      expect(\n+        cliOutput.substring(outputIdx).match(/rendering \\/isr\\/\\[slug\\]/g)\n+          .length\n+      ).toBe(1)\n+    })\n+  }\n+\n   it('should properly stream resume with Next-Resume', async () => {\n     const res = await fetchViaHTTP(appPort, '/delayed', undefined, {\n       headers: {"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 53,
        "deletions": 1
    }
}