{
    "author": "ztanner",
    "message": "fix isCsrfOriginAllowed handling for localhost (#77594)\n\n`isCsrfOriginAllowed` assumes that the origin has a TLD. This means that\nwhen evaluating `foo.localhost` against `*.localhost`, it's immediately\nmarked as an invalid origin, as it triggers the logic that returns false\nwhen wildcards are used below the domain level. This fixes that logic to\naccount for localhost which won't have a TLD.\n\nx-ref:\nhttps://github.com/vercel/next.js/pull/77395#issuecomment-2757252420",
    "sha": "09d942353d6787fe0aa4a4821bdf23df679150f4",
    "files": [
        {
            "sha": "d6eeb48d8af4e55dee208bcd94a2ace988d5e5f1",
            "filename": "packages/next/src/server/app-render/csrf-protection.test.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/09d942353d6787fe0aa4a4821bdf23df679150f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/09d942353d6787fe0aa4a4821bdf23df679150f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.test.ts?ref=09d942353d6787fe0aa4a4821bdf23df679150f4",
            "patch": "@@ -14,6 +14,39 @@ describe('isCsrfOriginAllowed', () => {\n     )\n   })\n \n+  it(\"should correctly handle origins that don't have a TLD (eg for localhost)\", () => {\n+    // Single level wildcard\n+    expect(isCsrfOriginAllowed('subdomain.localhost', ['*.localhost'])).toBe(\n+      true\n+    )\n+    expect(isCsrfOriginAllowed('localhost', ['*.localhost'])).toBe(false)\n+\n+    // Multi-level wildcard\n+    expect(isCsrfOriginAllowed('subdomain.localhost', ['**.localhost'])).toBe(\n+      true\n+    )\n+    expect(isCsrfOriginAllowed('a.b.localhost', ['**.localhost'])).toBe(true)\n+    expect(isCsrfOriginAllowed('localhost', ['**.localhost'])).toBe(false)\n+\n+    // Exact match\n+    expect(isCsrfOriginAllowed('localhost', ['localhost'])).toBe(true)\n+    expect(isCsrfOriginAllowed('subdomain.localhost', ['localhost'])).toBe(\n+      false\n+    )\n+\n+    // Multiple patterns\n+    expect(\n+      isCsrfOriginAllowed('subdomain.localhost', ['localhost', '*.localhost'])\n+    ).toBe(true)\n+    expect(\n+      isCsrfOriginAllowed('a.b.localhost', [\n+        'localhost',\n+        '*.localhost',\n+        '**.localhost',\n+      ])\n+    ).toBe(true)\n+  })\n+\n   it('should return false when allowedOrigins contains originDomain with non-matching pattern', () => {\n     expect(isCsrfOriginAllowed('asdf.vercel.com', ['*.vercel.app'])).toBe(false)\n     expect(isCsrfOriginAllowed('asdf.jkl.vercel.com', ['*.vercel.com'])).toBe(\n@@ -39,4 +72,9 @@ describe('isCsrfOriginAllowed', () => {\n   it('should return false when allowedOrigins is empty string', () => {\n     expect(isCsrfOriginAllowed('vercel.com', [''])).toBe(false)\n   })\n+\n+  it('wildcards are only supported below the domain level', () => {\n+    expect(isCsrfOriginAllowed('vercel.com', ['*'])).toBe(false)\n+    expect(isCsrfOriginAllowed('vercel.com', ['**'])).toBe(false)\n+  })\n })"
        },
        {
            "sha": "fc835ba721350c2f7aa689143ff27acfc87664f3",
            "filename": "packages/next/src/server/app-render/csrf-protection.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 19,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/09d942353d6787fe0aa4a4821bdf23df679150f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/09d942353d6787fe0aa4a4821bdf23df679150f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcsrf-protection.ts?ref=09d942353d6787fe0aa4a4821bdf23df679150f4",
            "patch": "@@ -17,25 +17,13 @@ function matchWildcardDomain(domain: string, pattern: string) {\n     return false\n   }\n \n-  let depth = 0\n-  while (patternParts.length && depth++ < 2) {\n-    const patternPart = patternParts.pop()\n-    const domainPart = domainParts.pop()\n-\n-    switch (patternPart) {\n-      case '':\n-      case '*':\n-      case '**': {\n-        // invalid pattern. pattern segments must be non empty\n-        // Additionally wildcards are only supported below the domain level\n-        return false\n-      }\n-      default: {\n-        if (domainPart !== patternPart) {\n-          return false\n-        }\n-      }\n-    }\n+  // Prevent wildcards from matching entire domains (e.g. '**' or '*.com')\n+  // This ensures wildcards can only match subdomains, not the main domain\n+  if (\n+    patternParts.length === 1 &&\n+    (patternParts[0] === '*' || patternParts[0] === '**')\n+  ) {\n+    return false\n   }\n \n   while (patternParts.length) {"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 45,
        "deletions": 19
    }
}