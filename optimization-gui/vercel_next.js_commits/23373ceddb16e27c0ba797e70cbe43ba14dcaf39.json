{
    "author": "huozhi",
    "message": "[dev-overlay] highlight errored code line for runtime errors (#77078)\n\n### What\n\nIn the runtime error code frame display, since there's usually a errored\nline we highlighted, we want to highlight the certain that line to give\nthe better visibility.\n\nWe already know each token in the highlighted code frame but it lacks of\nthe concept of \"line\". I now parse the code frame leading tokens and\ngroup them into lines, in order to apply the certain class name or\nattributes to that line for styling purpose.\n\nThis PR wraps each line of code in a `div`, it will have 1 - 2 new\nattributes.\n\n* If it's a source code line, which is not just highlight mark like `^`,\nit will have `data-nextjs-codeframe-line=\"<line number>\"`\n* if it's the line that errored in stack frame, it will have\n`data-nextjs-codeframe-line--errored=\"true\"`\n\nAnd we apply the red background styling to the highlighted lines\n\n\n| After | Before |\n|:---|:--- |\n|\n![image](https://github.com/user-attachments/assets/45cc1bb5-f8e0-4448-8678-9133d4f11e00)\n|\n![image](https://github.com/user-attachments/assets/364c03e6-07a7-4259-b558-1ffbf0c37605)\n|\n\n\nCloses NDX-975\n\n---------\n\nCo-authored-by: rauno <freiberggg@gmail.com>",
    "sha": "23373ceddb16e27c0ba797e70cbe43ba14dcaf39",
    "files": [
        {
            "sha": "30faf7a20716ccbdefb32108192426d0e1698b8f",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/code-frame.tsx",
            "status": "modified",
            "additions": 72,
            "deletions": 61,
            "changes": 133,
            "blob_url": "https://github.com/vercel/next.js/blob/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx?ref=23373ceddb16e27c0ba797e70cbe43ba14dcaf39",
            "patch": "@@ -1,55 +1,27 @@\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n-\n-import Anser from 'next/dist/compiled/anser'\n-import stripAnsi from 'next/dist/compiled/strip-ansi'\n-\n import { useMemo } from 'react'\n import { HotlinkedText } from '../hot-linked-text'\n import { getFrameSource } from '../../../utils/stack-frame'\n import { useOpenInEditor } from '../../utils/use-open-in-editor'\n import { ExternalIcon } from '../../icons/external'\n import { FileIcon } from '../../icons/file'\n+import {\n+  formatCodeFrame,\n+  groupCodeFrameLines,\n+  parseLineNumberFromCodeFrameLine,\n+} from './parse-code-frame'\n \n export type CodeFrameProps = { stackFrame: StackFrame; codeFrame: string }\n \n export function CodeFrame({ stackFrame, codeFrame }: CodeFrameProps) {\n-  // Strip leading spaces out of the code frame:\n-  const formattedFrame = useMemo<string>(() => {\n-    const lines = codeFrame.split(/\\r?\\n/g)\n-\n-    // Find the minimum length of leading spaces after `|` in the code frame\n-    const miniLeadingSpacesLength = lines\n-      .map((line) =>\n-        /^>? +\\d+ +\\| [ ]+/.exec(stripAnsi(line)) === null\n-          ? null\n-          : /^>? +\\d+ +\\| ( *)/.exec(stripAnsi(line))\n-      )\n-      .filter(Boolean)\n-      .map((v) => v!.pop()!)\n-      .reduce((c, n) => (isNaN(c) ? n.length : Math.min(c, n.length)), NaN)\n-\n-    // When the minimum length of leading spaces is greater than 1, remove them\n-    // from the code frame to help the indentation looks better when there's a lot leading spaces.\n-    if (miniLeadingSpacesLength > 1) {\n-      return lines\n-        .map((line, a) =>\n-          ~(a = line.indexOf('|'))\n-            ? line.substring(0, a) +\n-              line.substring(a).replace(`^\\\\ {${miniLeadingSpacesLength}}`, '')\n-            : line\n-        )\n-        .join('\\n')\n-    }\n-    return lines.join('\\n')\n-  }, [codeFrame])\n-\n-  const decoded = useMemo(() => {\n-    return Anser.ansiToJson(formattedFrame, {\n-      json: true,\n-      use_classes: true,\n-      remove_empty: true,\n-    })\n-  }, [formattedFrame])\n+  const formattedFrame = useMemo<string>(\n+    () => formatCodeFrame(codeFrame),\n+    [codeFrame]\n+  )\n+  const decodedLines = useMemo(\n+    () => groupCodeFrameLines(formattedFrame),\n+    [formattedFrame]\n+  )\n \n   const open = useOpenInEditor({\n     file: stackFrame.file,\n@@ -88,31 +60,50 @@ export function CodeFrame({ stackFrame, codeFrame }: CodeFrameProps) {\n         </p>\n       </div>\n       <pre className=\"code-frame-pre\">\n-        {decoded.map((entry, index) => (\n-          <span\n-            key={`frame-${index}`}\n-            style={{\n-              color: entry.fg ? `var(--color-${entry.fg})` : undefined,\n-              ...(entry.decoration === 'bold'\n-                ? // TODO(jiwon): This used to be 800, but the symbols like `─┬─` are\n-                  // having longer width than expected on Geist Mono font-weight\n-                  // above 600, hence a temporary fix is to use 500 for bold.\n-                  { fontWeight: 500 }\n-                : entry.decoration === 'italic'\n-                  ? { fontStyle: 'italic' }\n-                  : undefined),\n-            }}\n-          >\n-            {entry.content}\n-          </span>\n-        ))}\n+        {decodedLines.map((line, lineIndex) => {\n+          const { lineNumber, isErroredLine } =\n+            parseLineNumberFromCodeFrameLine(line, stackFrame)\n+\n+          const lineNumberProps: Record<string, string | boolean> = {}\n+          if (lineNumber) {\n+            lineNumberProps['data-nextjs-codeframe-line'] = lineNumber\n+          }\n+          if (isErroredLine) {\n+            lineNumberProps['data-nextjs-codeframe-line--errored'] = true\n+          }\n+\n+          return (\n+            <div key={`line-${lineIndex}`} {...lineNumberProps}>\n+              {line.map((entry, entryIndex) => (\n+                <span\n+                  key={`frame-${entryIndex}`}\n+                  style={{\n+                    color: entry.fg ? `var(--color-${entry.fg})` : undefined,\n+                    ...(entry.decoration === 'bold'\n+                      ? // TODO(jiwon): This used to be 800, but the symbols like `─┬─` are\n+                        // having longer width than expected on Geist Mono font-weight\n+                        // above 600, hence a temporary fix is to use 500 for bold.\n+                        { fontWeight: 500 }\n+                      : entry.decoration === 'italic'\n+                        ? { fontStyle: 'italic' }\n+                        : undefined),\n+                  }}\n+                >\n+                  {entry.content}\n+                </span>\n+              ))}\n+            </div>\n+          )\n+        })}\n       </pre>\n     </div>\n   )\n }\n \n export const CODE_FRAME_STYLES = `\n   [data-nextjs-codeframe] {\n+    --code-frame-padding: 12px;\n+    --code-frame-line-height: var(--size-16);\n     background-color: var(--color-background-200);\n     overflow: hidden;\n     color: var(--color-gray-1000);\n@@ -121,7 +112,7 @@ export const CODE_FRAME_STYLES = `\n     border-radius: 8px;\n     font-family: var(--font-stack-monospace);\n     font-size: var(--size-12);\n-    line-height: var(--size-16);\n+    line-height: var(--code-frame-line-height);\n     margin: 8px 0;\n \n     svg {\n@@ -132,7 +123,7 @@ export const CODE_FRAME_STYLES = `\n \n   .code-frame-link,\n   .code-frame-pre {\n-    padding: 12px;\n+    padding: var(--code-frame-padding);\n   }\n \n   .code-frame-link svg {\n@@ -183,6 +174,26 @@ export const CODE_FRAME_STYLES = `\n     font-family: var(--font-stack-monospace);\n   }\n \n+  [data-nextjs-codeframe-line][data-nextjs-codeframe-line--errored=\"true\"] {\n+    position: relative;\n+\n+    > span { \n+      position: relative;\n+      z-index: 1;\n+    }\n+\n+    &::after {\n+      content: \"\";\n+      width: calc(100% + var(--code-frame-padding) * 2);\n+      height: var(--code-frame-line-height);\n+      left: calc(-1 * var(--code-frame-padding));\n+      background: var(--color-red-200);\n+      box-shadow: 2px 0 0 0 var(--color-red-900) inset;\n+      position: absolute;\n+    }\n+  }\n+\n+\n   [data-nextjs-codeframe] > * {\n     margin: 0;\n   }"
        },
        {
            "sha": "24ab22d8ebe2233bd6e6dfafd2df43d9454a50b6",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/parse-code-frame.test.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts?ref=23373ceddb16e27c0ba797e70cbe43ba14dcaf39",
            "patch": "@@ -0,0 +1,52 @@\n+import {\n+  formatCodeFrame,\n+  groupCodeFrameLines,\n+  parseLineNumberFromCodeFrameLine,\n+} from './parse-code-frame'\n+\n+describe('parse line numbers', () => {\n+  it('parse line numbers from code frame', () => {\n+    const input = {\n+      stackFrame: {\n+        file: 'app/page.tsx',\n+        lineNumber: 2,\n+        column: 9,\n+        methodName: 'Page',\n+        arguments: [],\n+        ignored: false,\n+      },\n+      //   1 | export default function Page() {\n+      // > 2 |   throw new Error('test error')\n+      //     |         ^\n+      //   3 |   return <p>hello world</p>\n+      //   4 | }\n+      codeFrame:\n+        \"\\u001b[0m \\u001b[90m 1 |\\u001b[39m \\u001b[36mexport\\u001b[39m \\u001b[36mdefault\\u001b[39m \\u001b[36mfunction\\u001b[39m \\u001b[33mPage\\u001b[39m() {\\u001b[0m\\n\\u001b[0m\\u001b[31m\\u001b[1m>\\u001b[22m\\u001b[39m\\u001b[90m 2 |\\u001b[39m   \\u001b[36mthrow\\u001b[39m \\u001b[36mnew\\u001b[39m \\u001b[33mError\\u001b[39m(\\u001b[32m'test error'\\u001b[39m)\\u001b[0m\\n\\u001b[0m \\u001b[90m   |\\u001b[39m         \\u001b[31m\\u001b[1m^\\u001b[22m\\u001b[39m\\u001b[0m\\n\\u001b[0m \\u001b[90m 3 |\\u001b[39m   \\u001b[36mreturn\\u001b[39m \\u001b[33m<\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39mhello world\\u001b[33m<\\u001b[39m\\u001b[33m/\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39m\\u001b[0m\\n\\u001b[0m \\u001b[90m 4 |\\u001b[39m }\\u001b[0m\\n\\u001b[0m \\u001b[90m 5 |\\u001b[39m\\u001b[0m\",\n+    }\n+\n+    const formattedFrame = formatCodeFrame(input.codeFrame)\n+    const decodedLines = groupCodeFrameLines(formattedFrame)\n+\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[0], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '1',\n+      isErroredLine: false,\n+    })\n+\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[1], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '2',\n+      isErroredLine: true,\n+    })\n+\n+    // Line of ^ marker\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[2], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '',\n+      isErroredLine: false,\n+    })\n+  })\n+})"
        },
        {
            "sha": "bd12628a7fb0d7d7d6956bebfe5c613772d57cd0",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/parse-code-frame.ts",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts?ref=23373ceddb16e27c0ba797e70cbe43ba14dcaf39",
            "patch": "@@ -0,0 +1,81 @@\n+import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n+import Anser, { type AnserJsonEntry } from 'next/dist/compiled/anser'\n+import stripAnsi from 'next/dist/compiled/strip-ansi'\n+\n+// Strip leading spaces out of the code frame\n+export function formatCodeFrame(codeFrame: string) {\n+  const lines = codeFrame.split(/\\r?\\n/g)\n+\n+  // Find the minimum length of leading spaces after `|` in the code frame\n+  const miniLeadingSpacesLength = lines\n+    .map((line) =>\n+      /^>? +\\d+ +\\| [ ]+/.exec(stripAnsi(line)) === null\n+        ? null\n+        : /^>? +\\d+ +\\| ( *)/.exec(stripAnsi(line))\n+    )\n+    .filter(Boolean)\n+    .map((v) => v!.pop()!)\n+    .reduce((c, n) => (isNaN(c) ? n.length : Math.min(c, n.length)), NaN)\n+\n+  // When the minimum length of leading spaces is greater than 1, remove them\n+  // from the code frame to help the indentation looks better when there's a lot leading spaces.\n+  if (miniLeadingSpacesLength > 1) {\n+    return lines\n+      .map((line, a) =>\n+        ~(a = line.indexOf('|'))\n+          ? line.substring(0, a) +\n+            line.substring(a).replace(`^\\\\ {${miniLeadingSpacesLength}}`, '')\n+          : line\n+      )\n+      .join('\\n')\n+  }\n+  return lines.join('\\n')\n+}\n+\n+export function groupCodeFrameLines(formattedFrame: string) {\n+  // Map the decoded lines to a format that can be rendered\n+  const decoded = Anser.ansiToJson(formattedFrame, {\n+    json: true,\n+    use_classes: true,\n+    remove_empty: true,\n+  })\n+  const lines: (typeof decoded)[] = []\n+\n+  let line: typeof decoded = []\n+  for (const token of decoded) {\n+    if (token.content === '\\n') {\n+      lines.push(line)\n+      line = []\n+    } else {\n+      line.push(token)\n+    }\n+  }\n+  if (line.length > 0) {\n+    lines.push(line)\n+  }\n+\n+  return lines\n+}\n+\n+export function parseLineNumberFromCodeFrameLine(\n+  line: AnserJsonEntry[],\n+  stackFrame: StackFrame\n+) {\n+  let lineNumberToken: AnserJsonEntry | undefined\n+  let lineNumber: string | undefined\n+  // parse line number from line first 2 tokens\n+  // e.g. ` > 1 | const foo = 'bar'` => `1`, first token is `1 |`\n+  // e.g. `  2 | const foo = 'bar'` => `2`. first 2 tokens are ' ' and ' 2 |'\n+  // console.log('line', line)\n+  if (line[0]?.content === '>' || line[0]?.content === ' ') {\n+    lineNumberToken = line[1]\n+    lineNumber = lineNumberToken?.content?.replace('|', '')?.trim()\n+  }\n+\n+  // When the line number is possibly undefined, it can be just the non-source code line\n+  // e.g. the ^ sign can also take a line, we skip rendering line number for it\n+  return {\n+    lineNumber,\n+    isErroredLine: lineNumber === stackFrame.lineNumber?.toString(),\n+  }\n+}"
        },
        {
            "sha": "f7aab71b89dcfb536ec2d9111cf3e2b8cdf8d706",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/container/runtime-error/component-stack-pseudo-html.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Fcomponent-stack-pseudo-html.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/23373ceddb16e27c0ba797e70cbe43ba14dcaf39/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Fcomponent-stack-pseudo-html.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Fcomponent-stack-pseudo-html.tsx?ref=23373ceddb16e27c0ba797e70cbe43ba14dcaf39",
            "patch": "@@ -20,6 +20,7 @@ export const PSEUDO_HTML_DIFF_STYLES = `\n   }\n   [data-nextjs-container-errors-pseudo-html--diff='error'] {\n     background: var(--color-amber-100);\n+    box-shadow: 2px 0 0 0 var(--color-amber-900) inset;\n     font-weight: bold;\n   }\n   [data-nextjs-container-errors-pseudo-html-collapse-button] {"
        }
    ],
    "stats": {
        "total": 267,
        "additions": 206,
        "deletions": 61
    }
}