{
    "author": "mischnic",
    "message": "Turbopack: refactor entry_chunk_group API (#76478)\n\nJust accept a list of entries, as opposed to one entry and some more entries",
    "sha": "265aba55ef048537ca5d69702b12c1231ec2d3b3",
    "files": [
        {
            "sha": "a5ba8f81555f0c482ee0115a99c050c94a192683",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -1,4 +1,4 @@\n-use anyhow::{Context, Result};\n+use anyhow::{bail, Context, Result};\n use next_core::{\n     all_assets_from_entries,\n     app_segment_config::NextSegmentConfig,\n@@ -1662,7 +1662,12 @@ impl AppEndpoint {\n             NextRuntime::NodeJs => {\n                 let mut evaluatable_assets = this.app_project.rsc_runtime_entries().owned().await?;\n \n+                let Some(rsc_entry) = ResolvedVc::try_downcast(app_entry.rsc_entry) else {\n+                    bail!(\"rsc_entry must be evaluatable\");\n+                };\n+\n                 evaluatable_assets.push(server_action_manifest_loader);\n+                evaluatable_assets.push(rsc_entry);\n \n                 async {\n                     let mut current_chunks = OutputAssets::empty();\n@@ -1754,7 +1759,6 @@ impl AppEndpoint {\n                                     )\n                                     .into(),\n                                 ),\n-                                *app_entry.rsc_entry,\n                                 Vc::cell(evaluatable_assets),\n                                 module_graph,\n                                 current_chunks,"
        },
        {
            "sha": "04243dc2ccb0c9fa2d9a540462db884ccd7718bc",
            "filename": "crates/next-api/src/instrumentation.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -168,7 +168,6 @@ impl InstrumentationEndpoint {\n                 this.project\n                     .node_root()\n                     .join(\"server/instrumentation.js\".into()),\n-                *module,\n                 get_server_runtime_entries(\n                     Value::new(ServerContextType::Instrumentation {\n                         app_dir: this.app_dir,\n@@ -177,7 +176,8 @@ impl InstrumentationEndpoint {\n                     }),\n                     this.project.next_mode(),\n                 )\n-                .resolve_entries(*this.asset_context),\n+                .resolve_entries(*this.asset_context)\n+                .with_entry(*module),\n                 module_graph,\n                 OutputAssets::empty(),\n                 Value::new(AvailabilityInfo::Root),"
        },
        {
            "sha": "0971f3a3be53370fea43a4891d6baf6b7a4ce42f",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -161,7 +161,6 @@ impl MiddlewareEndpoint {\n         let EntryChunkGroupResult { asset: chunk, .. } = *chunking_context\n             .entry_chunk_group(\n                 this.project.node_root().join(\"server/middleware.js\".into()),\n-                *module,\n                 get_server_runtime_entries(\n                     Value::new(ServerContextType::Middleware {\n                         app_dir: this.app_dir,\n@@ -170,7 +169,8 @@ impl MiddlewareEndpoint {\n                     }),\n                     this.project.next_mode(),\n                 )\n-                .resolve_entries(*this.asset_context),\n+                .resolve_entries(*this.asset_context)\n+                .with_entry(*module),\n                 module_graph,\n                 OutputAssets::empty(),\n                 Value::new(AvailabilityInfo::Root),"
        },
        {
            "sha": "08422eef70e08cbae23d1aab01a461c7daf86212",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -957,12 +957,12 @@ impl PageEndpoint {\n                 DynamicImportedChunks::default().resolved_cell()\n             };\n \n+            let ssr_module_evaluatable = ResolvedVc::try_sidecast(ssr_module)\n+                .context(\"could not process page loader entry module\")?;\n             let is_edge = matches!(runtime, NextRuntime::Edge);\n             if is_edge {\n                 let mut evaluatable_assets = edge_runtime_entries.owned().await?;\n-                let evaluatable = ResolvedVc::try_sidecast(ssr_module)\n-                    .context(\"could not process page loader entry module\")?;\n-                evaluatable_assets.push(evaluatable);\n+                evaluatable_assets.push(ssr_module_evaluatable);\n \n                 let edge_files = edge_chunking_context\n                     .evaluated_chunk_group_assets(\n@@ -992,8 +992,7 @@ impl PageEndpoint {\n                 } = *chunking_context\n                     .entry_chunk_group(\n                         ssr_entry_chunk_path,\n-                        *ssr_module,\n-                        runtime_entries,\n+                        runtime_entries.with_entry(*ssr_module_evaluatable),\n                         module_graph,\n                         OutputAssets::empty(),\n                         Value::new(AvailabilityInfo::Root),"
        },
        {
            "sha": "5339468faf5e827dd67f12e6454a35471594142d",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -553,7 +553,6 @@ impl ChunkingContext for BrowserChunkingContext {\n     fn entry_chunk_group(\n         self: Vc<Self>,\n         _path: Vc<FileSystemPath>,\n-        _module: Vc<Box<dyn Module>>,\n         _evaluatable_assets: Vc<EvaluatableAssets>,\n         _module_graph: Vc<ModuleGraph>,\n         _extra_chunks: Vc<OutputAssets>,"
        },
        {
            "sha": "11c2dcef9e773fe458757b12b7f691c585f5a307",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -423,7 +423,6 @@ async fn build_internal(\n                                                 .into(),\n                                         )\n                                         .with_extension(\"entry.js\".into()),\n-                                    *ResolvedVc::upcast(ecmascript),\n                                     EvaluatableAssets::one(*ResolvedVc::upcast(ecmascript)),\n                                     module_graph,\n                                     OutputAssets::empty(),"
        },
        {
            "sha": "b3df69d591b65baf027d5e432b9f1237ae356908",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 20,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -200,11 +200,10 @@ pub trait ChunkingContext {\n     /// Generates an output chunk that:\n     /// * loads the given extra_chunks in addition to the generated chunks; and\n     /// * evaluates the given assets; and\n-    /// * exports the result of evaluating the given module as a CommonJS default export.\n+    /// * exports the result of evaluating the last module as a CommonJS default export.\n     fn entry_chunk_group(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n         evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n@@ -256,7 +255,6 @@ pub trait ChunkingContextExt {\n     fn entry_chunk_group_asset(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n         evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n@@ -268,21 +266,19 @@ pub trait ChunkingContextExt {\n     fn root_entry_chunk_group(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n+        evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n     ) -> Vc<EntryChunkGroupResult>\n     where\n         Self: Send;\n \n     fn root_entry_chunk_group_asset(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n+        evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n     ) -> Vc<Box<dyn OutputAsset>>\n     where\n         Self: Send;\n@@ -341,16 +337,14 @@ impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingConte\n     fn entry_chunk_group_asset(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n         evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<Box<dyn OutputAsset>> {\n         entry_chunk_group_asset(\n-            path,\n             Vc::upcast(self),\n-            module,\n+            path,\n             evaluatable_assets,\n             module_graph,\n             extra_chunks,\n@@ -361,14 +355,12 @@ impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingConte\n     fn root_entry_chunk_group(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n+        evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n     ) -> Vc<EntryChunkGroupResult> {\n         self.entry_chunk_group(\n             path,\n-            module,\n             evaluatable_assets,\n             module_graph,\n             extra_chunks,\n@@ -379,15 +371,13 @@ impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingConte\n     fn root_entry_chunk_group_asset(\n         self: Vc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: Vc<Box<dyn Module>>,\n+        evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n     ) -> Vc<Box<dyn OutputAsset>> {\n         entry_chunk_group_asset(\n-            path,\n             Vc::upcast(self),\n-            module,\n+            path,\n             evaluatable_assets,\n             module_graph,\n             extra_chunks,\n@@ -441,9 +431,8 @@ async fn evaluated_chunk_group_assets(\n \n #[turbo_tasks::function]\n async fn entry_chunk_group_asset(\n-    path: Vc<FileSystemPath>,\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n-    module: Vc<Box<dyn Module>>,\n+    path: Vc<FileSystemPath>,\n     evaluatable_assets: Vc<EvaluatableAssets>,\n     module_graph: Vc<ModuleGraph>,\n     extra_chunks: Vc<OutputAssets>,\n@@ -452,7 +441,6 @@ async fn entry_chunk_group_asset(\n     Ok(*chunking_context\n         .entry_chunk_group(\n             path,\n-            module,\n             evaluatable_assets,\n             module_graph,\n             extra_chunks,"
        },
        {
            "sha": "9158297619b4ca63a5014741d781276288f4ceaf",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/chunk_group_info.rs",
            "status": "modified",
            "additions": 72,
            "deletions": 3,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -14,7 +14,7 @@ use tracing::Instrument;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n     debug::ValueDebugFormat, trace::TraceRawVcs, FxIndexMap, FxIndexSet, NonLocalValue, ResolvedVc,\n-    TaskInput, TryJoinIterExt, Vc,\n+    TaskInput, TryJoinIterExt, ValueToString, Vc,\n };\n \n use crate::{\n@@ -93,11 +93,20 @@ pub struct ChunkGroupInfo {\n #[turbo_tasks::value_impl]\n impl ChunkGroupInfo {\n     #[turbo_tasks::function]\n-    pub fn get_index_of(&self, chunk_group: ChunkGroup) -> Result<Vc<usize>> {\n+    pub async fn get_index_of(&self, chunk_group: ChunkGroup) -> Result<Vc<usize>> {\n         if let Some(idx) = self.chunk_groups.get_index_of(&chunk_group) {\n             Ok(Vc::cell(idx))\n         } else {\n-            bail!(\"Couldn't find chunk group index\");\n+            bail!(\n+                \"Couldn't find chunk group index for {} in {}\",\n+                chunk_group.debug_str(self).await?,\n+                self.chunk_groups\n+                    .iter()\n+                    .map(|c| c.debug_str(self))\n+                    .try_join()\n+                    .await?\n+                    .join(\", \")\n+            );\n         }\n     }\n }\n@@ -140,6 +149,66 @@ impl ChunkGroup {\n             | ChunkGroup::SharedMerged { entries, .. } => Either::Right(entries.iter().copied()),\n         }\n     }\n+\n+    pub async fn debug_str(&self, chunk_group_info: &ChunkGroupInfo) -> Result<String> {\n+        Ok(match self {\n+            ChunkGroup::Entry { entries, ty } => format!(\n+                \"ChunkGroup::Entry({:?}, {:?})\",\n+                ty,\n+                entries\n+                    .iter()\n+                    .map(|m| m.ident().to_string())\n+                    .try_join()\n+                    .await?\n+            ),\n+            ChunkGroup::Async(entry) => {\n+                format!(\"ChunkGroup::Async({:?})\", entry.ident().to_string().await?)\n+            }\n+            ChunkGroup::Isolated(entry) => {\n+                format!(\n+                    \"ChunkGroup::Isolated({:?})\",\n+                    entry.ident().to_string().await?\n+                )\n+            }\n+            ChunkGroup::Shared(entry) => {\n+                format!(\"ChunkGroup::Shared({:?})\", entry.ident().to_string().await?)\n+            }\n+            ChunkGroup::IsolatedMerged {\n+                parent,\n+                merge_tag,\n+                entries,\n+            } => {\n+                format!(\n+                    \"ChunkGroup::IsolatedMerged({}, {}, {:?})\",\n+                    Box::pin(chunk_group_info.chunk_groups[*parent].debug_str(chunk_group_info))\n+                        .await?,\n+                    merge_tag,\n+                    entries\n+                        .iter()\n+                        .map(|m| m.ident().to_string())\n+                        .try_join()\n+                        .await?\n+                )\n+            }\n+            ChunkGroup::SharedMerged {\n+                parent,\n+                merge_tag,\n+                entries,\n+            } => {\n+                format!(\n+                    \"ChunkGroup::SharedMerged({}, {}, {:?})\",\n+                    Box::pin(chunk_group_info.chunk_groups[*parent].debug_str(chunk_group_info))\n+                        .await?,\n+                    merge_tag,\n+                    entries\n+                        .iter()\n+                        .map(|m| m.ident().to_string())\n+                        .try_join()\n+                        .await?\n+                )\n+            }\n+        })\n+    }\n }\n \n #[derive(Debug, Clone, PartialEq, Eq, Hash)]"
        },
        {
            "sha": "c317818d0d3cbfece29491f994a3c255bd7e12cb",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -825,16 +825,6 @@ macro_rules! get_node_idx {\n }\n pub(crate) use get_node_idx;\n \n-// pub struct AllNodesIterator {\n-//     inner: Vec<ReadRef<SingleModuleGraph>>,\n-// }\n-// impl<'a> Iterator for &'a AllNodesIterator {\n-//     type Item = &'a SingleModuleGraphModuleNode;\n-//     fn next(&mut self) -> Option<Self::Item> {\n-//         self.inner.iter().flat_map(|g| g.iter_nodes()).next()\n-//     }\n-// }\n-\n impl ModuleGraph {\n     pub async fn get_graphs(&self) -> Result<Vec<ReadRef<SingleModuleGraph>>> {\n         self.graphs.iter().try_join().await\n@@ -865,12 +855,6 @@ impl ModuleGraph {\n         Ok(idx)\n     }\n \n-    // Iterate over all nodes in the graph\n-    // pub async fn iter_nodes(&self) -> Result<AllNodesIterator> {\n-    // let graphs = self.get_graphs().await?;\n-    // Ok(AllNodesIterator { inner: graphs })\n-    // }\n-\n     /// Traverses all reachable edges exactly once and calls the visitor with the edge source and\n     /// target.\n     ///"
        },
        {
            "sha": "dfe9005adcd543b84f7ec7354205511201f9cf73",
            "filename": "turbopack/crates/turbopack-node/src/evaluate.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -129,7 +129,9 @@ async fn emit_evaluate_pool_assets_operation(\n                 \"RUNTIME\".into() => runtime_asset\n             }))),\n         )\n-        .module();\n+        .module()\n+        .to_resolved()\n+        .await?;\n \n     let runtime_entries = {\n         let globals_module = asset_context\n@@ -157,18 +159,18 @@ async fn emit_evaluate_pool_assets_operation(\n     };\n \n     let module_graph = ModuleGraph::from_modules(Vc::cell(vec![(\n-        iter::once(entry_module.to_resolved().await?)\n+        iter::once(entry_module)\n             .chain(runtime_entries.iter().copied().map(ResolvedVc::upcast))\n             .collect(),\n         ChunkGroupType::Entry,\n     )]));\n \n     let bootstrap = chunking_context.root_entry_chunk_group_asset(\n         entrypoint,\n-        entry_module,\n+        Vc::<EvaluatableAssets>::cell(runtime_entries)\n+            .with_entry(*ResolvedVc::try_downcast(entry_module).unwrap()),\n         module_graph,\n         OutputAssets::empty(),\n-        Vc::<EvaluatableAssets>::cell(runtime_entries),\n     );\n \n     let output_root = chunking_context.output_root().to_resolved().await?;"
        },
        {
            "sha": "cb9a77b60da986aa676d6dfd66b377eed6bb9435",
            "filename": "turbopack/crates/turbopack-node/src/lib.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -18,7 +18,9 @@ use turbo_tasks_fs::{to_sys_path, File, FileSystemPath};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     changed::content_changed,\n-    chunk::{ChunkGroupType, ChunkingContext, ChunkingContextExt, EvaluatableAssets},\n+    chunk::{\n+        ChunkGroupType, ChunkingContext, ChunkingContextExt, EvaluatableAsset, EvaluatableAssets,\n+    },\n     module::Module,\n     module_graph::ModuleGraph,\n     output::{OutputAsset, OutputAssets, OutputAssetsSet},\n@@ -104,7 +106,7 @@ async fn internal_assets_for_source_mapping(\n /// subgraph\n #[turbo_tasks::function]\n pub async fn external_asset_entrypoints(\n-    module: Vc<Box<dyn Module>>,\n+    module: Vc<Box<dyn EvaluatableAsset>>,\n     runtime_entries: Vc<EvaluatableAssets>,\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n     intermediate_output_path: ResolvedVc<FileSystemPath>,\n@@ -250,18 +252,26 @@ pub async fn get_renderer_pool_operation(\n \n /// Converts a module graph into node.js executable assets\n #[turbo_tasks::function]\n-pub fn get_intermediate_asset(\n+pub async fn get_intermediate_asset(\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n-    main_entry: Vc<Box<dyn Module>>,\n+    main_entry: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     other_entries: Vc<EvaluatableAssets>,\n-) -> Vc<Box<dyn OutputAsset>> {\n-    Vc::upcast(chunking_context.root_entry_chunk_group_asset(\n+) -> Result<Vc<Box<dyn OutputAsset>>> {\n+    Ok(Vc::upcast(chunking_context.root_entry_chunk_group_asset(\n         chunking_context.chunk_path(main_entry.ident(), \".js\".into()),\n-        main_entry,\n-        ModuleGraph::from_module(main_entry, ChunkGroupType::Entry),\n+        other_entries.with_entry(*main_entry),\n+        ModuleGraph::from_modules(Vc::cell(vec![(\n+                other_entries\n+                    .await?\n+                    .into_iter()\n+                    .copied()\n+                    .chain(std::iter::once(main_entry))\n+                    .map(ResolvedVc::upcast)\n+                    .collect(),\n+                ChunkGroupType::Entry,\n+            )])),\n         OutputAssets::empty(),\n-        other_entries,\n-    ))\n+    )))\n }\n \n #[derive(Clone, Debug)]"
        },
        {
            "sha": "654e590640872f1b6a89d61080b01cb1a0ec03e1",
            "filename": "turbopack/crates/turbopack-node/src/node_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fnode_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fnode_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fnode_entry.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -1,16 +1,13 @@\n use anyhow::Result;\n use turbo_tasks::{ResolvedVc, Value, Vc};\n use turbo_tasks_fs::FileSystemPath;\n-use turbopack_core::{\n-    chunk::{ChunkingContext, EvaluatableAssets},\n-    module::Module,\n-};\n+use turbopack_core::chunk::{ChunkingContext, EvaluatableAsset, EvaluatableAssets};\n use turbopack_dev_server::source::ContentSourceData;\n \n #[turbo_tasks::value(shared)]\n pub struct NodeRenderingEntry {\n     pub runtime_entries: ResolvedVc<EvaluatableAssets>,\n-    pub module: ResolvedVc<Box<dyn Module>>,\n+    pub module: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     pub chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     pub intermediate_output_path: ResolvedVc<FileSystemPath>,\n     pub output_root: ResolvedVc<FileSystemPath>,"
        },
        {
            "sha": "ad9fb36cf8831b51ffd938c198a690b9c4227e0b",
            "filename": "turbopack/crates/turbopack-node/src/render/node_api_source.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Fnode_api_source.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Fnode_api_source.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Fnode_api_source.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -132,7 +132,7 @@ impl GetContentSourceContent for NodeApiContentSource {\n             self.cwd,\n             self.env,\n             self.server_root.join(path.clone()).to_resolved().await?,\n-            entry.module,\n+            ResolvedVc::upcast(entry.module),\n             entry.runtime_entries,\n             entry.chunking_context,\n             entry.intermediate_output_path,"
        },
        {
            "sha": "e7a35d1af886c517ba2f702f31f0c7efa46293cd",
            "filename": "turbopack/crates/turbopack-node/src/render/render_proxy.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -15,7 +15,7 @@ use turbo_tasks_bytes::{Bytes, Stream};\n use turbo_tasks_env::ProcessEnv;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n-    chunk::{ChunkingContext, EvaluatableAssets},\n+    chunk::{ChunkingContext, EvaluatableAsset, EvaluatableAssets},\n     error::PrettyPrintError,\n     issue::{IssueExt, StyledString},\n     module::Module,\n@@ -37,7 +37,7 @@ pub async fn render_proxy_operation(\n     cwd: ResolvedVc<FileSystemPath>,\n     env: ResolvedVc<Box<dyn ProcessEnv>>,\n     path: ResolvedVc<FileSystemPath>,\n-    module: ResolvedVc<Box<dyn Module>>,\n+    module: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     runtime_entries: ResolvedVc<EvaluatableAssets>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     intermediate_output_path: ResolvedVc<FileSystemPath>,\n@@ -154,7 +154,7 @@ struct RenderStreamOptions {\n     cwd: ResolvedVc<FileSystemPath>,\n     env: ResolvedVc<Box<dyn ProcessEnv>>,\n     path: ResolvedVc<FileSystemPath>,\n-    module: ResolvedVc<Box<dyn Module>>,\n+    module: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     runtime_entries: ResolvedVc<EvaluatableAssets>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     intermediate_output_path: ResolvedVc<FileSystemPath>,"
        },
        {
            "sha": "d45dce6e58350c6c0c126cb22d9c38fb15af4d1e",
            "filename": "turbopack/crates/turbopack-node/src/render/render_static.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -15,7 +15,7 @@ use turbo_tasks_env::ProcessEnv;\n use turbo_tasks_fs::{File, FileSystemPath};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n-    chunk::{ChunkingContext, EvaluatableAssets},\n+    chunk::{ChunkingContext, EvaluatableAsset, EvaluatableAssets},\n     error::PrettyPrintError,\n     issue::{IssueExt, StyledString},\n     module::Module,\n@@ -77,7 +77,7 @@ pub async fn render_static_operation(\n     cwd: ResolvedVc<FileSystemPath>,\n     env: ResolvedVc<Box<dyn ProcessEnv>>,\n     path: ResolvedVc<FileSystemPath>,\n-    module: ResolvedVc<Box<dyn Module>>,\n+    module: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     runtime_entries: ResolvedVc<EvaluatableAssets>,\n     fallback_page: ResolvedVc<DevHtmlAsset>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n@@ -204,7 +204,7 @@ struct RenderStreamOptions {\n     cwd: ResolvedVc<FileSystemPath>,\n     env: ResolvedVc<Box<dyn ProcessEnv>>,\n     path: ResolvedVc<FileSystemPath>,\n-    module: ResolvedVc<Box<dyn Module>>,\n+    module: ResolvedVc<Box<dyn EvaluatableAsset>>,\n     runtime_entries: ResolvedVc<EvaluatableAssets>,\n     fallback_page: ResolvedVc<DevHtmlAsset>,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,"
        },
        {
            "sha": "9890f9f423fe4305dea8fe4827490b9f132cbd0d",
            "filename": "turbopack/crates/turbopack-node/src/render/rendered_source.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frendered_source.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frendered_source.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frendered_source.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -190,7 +190,7 @@ impl GetContentSourceContent for NodeRenderContentSource {\n             self.cwd,\n             self.env,\n             self.server_root.join(path.clone()).to_resolved().await?,\n-            entry.module,\n+            ResolvedVc::upcast(entry.module),\n             entry.runtime_entries,\n             self.fallback_page,\n             entry.chunking_context,"
        },
        {
            "sha": "27e5e802dfd954edad2dbca314a533167387cc3b",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -1,5 +1,3 @@\n-use std::iter::once;\n-\n use anyhow::{bail, Context, Result};\n use rustc_hash::FxHashMap;\n use tracing::Instrument;\n@@ -376,31 +374,27 @@ impl ChunkingContext for NodeJsChunkingContext {\n         .await\n     }\n \n-    /// Generates an output chunk that:\n-    /// * evaluates the given assets; and\n-    /// * exports the result of evaluating the given module as a CommonJS default export.\n     #[turbo_tasks::function]\n     pub async fn entry_chunk_group(\n         self: ResolvedVc<Self>,\n         path: Vc<FileSystemPath>,\n-        module: ResolvedVc<Box<dyn Module>>,\n         evaluatable_assets: Vc<EvaluatableAssets>,\n         module_graph: Vc<ModuleGraph>,\n         extra_chunks: Vc<OutputAssets>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Result<Vc<EntryChunkGroupResult>> {\n         let availability_info = availability_info.into_value();\n \n+        let evaluatable_assets_ref = evaluatable_assets.await?;\n+        let entries = evaluatable_assets_ref\n+            .iter()\n+            .map(|&asset| ResolvedVc::upcast::<Box<dyn Module>>(asset));\n+\n         let MakeChunkGroupResult {\n             chunks,\n             availability_info,\n         } = make_chunk_group(\n-            once(module).chain(\n-                evaluatable_assets\n-                    .await?\n-                    .iter()\n-                    .map(|&asset| ResolvedVc::upcast(asset)),\n-            ),\n+            entries,\n             module_graph,\n             ResolvedVc::upcast(self),\n             availability_info,\n@@ -420,7 +414,7 @@ impl ChunkingContext for NodeJsChunkingContext {\n             )\n             .collect();\n \n-        let Some(module) = ResolvedVc::try_downcast(module) else {\n+        let Some(module) = ResolvedVc::try_sidecast(*evaluatable_assets_ref.last().unwrap()) else {\n             bail!(\"module must be placeable in an ecmascript chunk\");\n         };\n "
        },
        {
            "sha": "5e3cb89de15901add307c293de6df346d17e6a93",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/265aba55ef048537ca5d69702b12c1231ec2d3b3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=265aba55ef048537ca5d69702b12c1231ec2d3b3",
            "patch": "@@ -431,7 +431,6 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                                         .into(),\n                                 )\n                                 .with_extension(\"entry.js\".into()),\n-                            entry_module,\n                             evaluatable_assets,\n                             module_graph,\n                             OutputAssets::empty(),"
        }
    ],
    "stats": {
        "total": 230,
        "additions": 137,
        "deletions": 93
    }
}