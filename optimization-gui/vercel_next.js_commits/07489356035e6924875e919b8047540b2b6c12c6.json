{
    "author": "mischnic",
    "message": "Turbopack: proper error message for swcPlugins (#77990)\n\nShow a redbox when specifying a non-existent plugin instead of crashing Turbopack\r\n\r\nThe error location could be better, but we don't actually know the line/column here\r\n\r\n![Bildschirmfoto 2025-04-10 um 08 56 39](https://github.com/user-attachments/assets/c816704d-b5c6-48bc-8471-92082abe5614)",
    "sha": "07489356035e6924875e919b8047540b2b6c12c6",
    "files": [
        {
            "sha": "6aa0ec2cb076cbb8dcd08df511a1a6b3bdaefebf",
            "filename": "crates/next-core/src/next_shared/transforms/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/07489356035e6924875e919b8047540b2b6c12c6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/07489356035e6924875e919b8047540b2b6c12c6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs?ref=07489356035e6924875e919b8047540b2b6c12c6",
            "patch": "@@ -35,8 +35,8 @@ pub async fn get_swc_ecma_transform_rule_impl(\n     plugin_configs: &[(RcStr, serde_json::Value)],\n     enable_mdx_rs: bool,\n ) -> Result<Option<ModuleRule>> {\n-    use anyhow::{bail, Context};\n-    use turbo_tasks::{TryJoinIterExt, Value};\n+    use anyhow::bail;\n+    use turbo_tasks::{TryFlatJoinIterExt, Value};\n     use turbo_tasks_fs::FileContent;\n     use turbopack::{resolve_options, resolve_options_context::ResolveOptionsContext};\n     use turbopack_core::{\n@@ -78,30 +78,34 @@ pub async fn get_swc_ecma_transform_rule_impl(\n                 )\n                 .as_raw_module_result(),\n                 Value::new(ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined)),\n+                // TODO proper error location\n                 *project_path,\n                 request,\n                 resolve_options,\n                 false,\n+                // TODO proper error location\n                 None,\n             )\n             .await?;\n-            let plugin_module = plugin_wasm_module_resolve_result\n-                .first_module()\n-                .await?\n-                .context(\"Expected to find module\")?;\n \n-            let content = &*plugin_module.content().file_content().await?;\n+            let Some(plugin_module) = &*plugin_wasm_module_resolve_result.first_module().await?\n+            else {\n+                // Ignore unresolveable plugin modules, handle_resolve_error has already emitted an\n+                // issue.\n+                return Ok(None);\n+            };\n \n+            let content = &*plugin_module.content().file_content().await?;\n             let FileContent::Content(file) = content else {\n                 bail!(\"Expected file content for plugin module\");\n             };\n \n-            Ok((\n+            Ok(Some((\n                 SwcPluginModule::new(name, file.content().to_bytes()?.to_vec()).resolved_cell(),\n                 config.clone(),\n-            ))\n+            )))\n         })\n-        .try_join()\n+        .try_flat_join()\n         .await?;\n \n     Ok(Some(get_ecma_transform_rule("
        },
        {
            "sha": "9342eed18c78f273c94bb6022d57f91f5aaa90d0",
            "filename": "test/e2e/swc-plugins/app/layout.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswc-plugins%2Fapp%2Flayout.js?ref=07489356035e6924875e919b8047540b2b6c12c6",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function RootLayout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "e5e30cce60408971b8976b9286156de8bf032d22",
            "filename": "test/e2e/swc-plugins/app/page.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswc-plugins%2Fapp%2Fpage.js?ref=07489356035e6924875e919b8047540b2b6c12c6",
            "patch": "@@ -0,0 +1,5 @@\n+import React from 'react'\n+\n+export default function Page({ children }) {\n+  return <div data-custom-attribute>Hello World</div>\n+}"
        },
        {
            "sha": "8c5c70af08ebed0587adca5abc92ba720cc84bfa",
            "filename": "test/e2e/swc-plugins/index.test.ts",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswc-plugins%2Findex.test.ts?ref=07489356035e6924875e919b8047540b2b6c12c6",
            "patch": "@@ -0,0 +1,58 @@\n+import { nextTestSetup, isNextDev } from 'e2e-utils'\n+\n+describe('swcPlugins', () => {\n+  describe('supports swcPlugins', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+      dependencies: {\n+        '@swc/plugin-react-remove-properties': '7.0.2',\n+      },\n+    })\n+    if (skipped) return\n+\n+    it('basic case', async () => {\n+      const html = await next.render('/')\n+      expect(html).toContain('Hello World')\n+      expect(html).not.toContain('data-custom-attribute')\n+    })\n+  })\n+  ;(isNextDev ? describe : describe.skip)('invalid plugin name', () => {\n+    const { next, skipped, isTurbopack } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+      overrideFiles: {\n+        'next.config.js': `\n+module.exports = {\n+  experimental: {\n+    swcPlugins: [['@swc/plugin-nonexistent', {}]],\n+  },\n+}`,\n+      },\n+    })\n+    if (skipped) return\n+\n+    it('shows a redbox in dev', async () => {\n+      const browser = await next.browser('/')\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"Module not found: Can't resolve '@swc/plugin-nonexistent'\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./\n+         Module not found: Can't resolve '@swc/plugin-nonexistent'\n+         https://nextjs.org/docs/messages/module-not-found\",\n+           \"stack\": [],\n+         }\n+        `)\n+      } else {\n+        // TODO missing proper error with Webpack\n+        await expect(browser).toDisplayRedbox(\n+          `\"Expected Redbox but found no visible one.\"`\n+        )\n+      }\n+    })\n+  })\n+})"
        },
        {
            "sha": "3acbf16005e7a2dec4fc33970fd1419a5fd69a66",
            "filename": "test/e2e/swc-plugins/next.config.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07489356035e6924875e919b8047540b2b6c12c6/test%2Fe2e%2Fswc-plugins%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswc-plugins%2Fnext.config.js?ref=07489356035e6924875e919b8047540b2b6c12c6",
            "patch": "@@ -0,0 +1,13 @@\n+/** @type {import('next').NextConfig} */\n+module.exports = {\n+  experimental: {\n+    swcPlugins: [\n+      [\n+        '@swc/plugin-react-remove-properties',\n+        {\n+          properties: ['^data-custom-attribute$'],\n+        },\n+      ],\n+    ],\n+  },\n+}"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 99,
        "deletions": 10
    }
}