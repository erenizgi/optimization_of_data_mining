{
    "author": "Han5991",
    "message": "Fix before interactive incorrectly render css (#81146)\n\nFixing a bug\n\n  - Related issues linked using fixes #81130\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n  What?\n\nThis PR fixes a bug where Next.js Script components with\nstrategy=\"beforeInteractive\" incorrectly render classname attribute\ninstead of the HTML standard class attribute.\n\n  Why?\n\nThe beforeInteractive script strategy in App Router bypassed the\nexisting setAttributesFromProps utility function that properly maps\nReact prop names to DOM attribute names. This caused className props to\nbe directly set as classname attributes in the HTML, which is\nnon-standard and breaks CSS styling.\n\n  Before (broken):\n```\n  <script classname=\"example-class\" id=\"example\">...</script>\n```\n  After (fixed):\n```\n  <script class=\"example-class\" id=\"example\">...</script>\n```\n  How?\n\n1. Identified the root cause: In\n/packages/next/src/client/app-bootstrap.ts, the loadScriptsInSequence\nfunction manually set attributes using a simple loop that didn't handle\nDOM attribute name mapping.\n  2. Applied the fix:\n    - Imported the existing setAttributesFromProps utility function\n- Replaced the manual attribute setting loop with the proper utility\nfunction call\n    - This ensures className → class mapping works correctly\n3. Added comprehensive tests: Created e2e tests in\n/test/e2e/app-dir/script-before-interactive/ that verify:\n    - Single scripts render with correct class attribute\n    - Multiple scripts work correctly\n    - Script execution remains unaffected\n    - Scripts are properly placed in document head\n\n  Code changes:\n```\n  // Before (buggy)\n  if (props) {\n    for (const key in props) {\n      if (key !== 'children') {\n        el.setAttribute(key, props[key])  // ❌ className becomes classname\n      }\n    }\n  }\n```\n  // After (fixed)  \n```\n  if (props) {\n    setAttributesFromProps(el, props)  // ✅ className becomes class\n  }\n```\n  Fixes #81130\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "c432d07a595b5edbd6d2ce6c50a065e7115e1622",
    "files": [
        {
            "sha": "1811f9fa115ca16aeb7799fa8e3b62d2d3ddbf32",
            "filename": "packages/next/src/client/app-bootstrap.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -5,6 +5,8 @@\n  * - next/script with `beforeInteractive` strategy\n  */\n \n+import { setAttributesFromProps } from './set-attributes-from-props'\n+\n const version = process.env.__NEXT_VERSION\n \n window.next = {\n@@ -27,11 +29,7 @@ function loadScriptsInSequence(\n           const el = document.createElement('script')\n \n           if (props) {\n-            for (const key in props) {\n-              if (key !== 'children') {\n-                el.setAttribute(key, props[key])\n-              }\n-            }\n+            setAttributesFromProps(el, props)\n           }\n \n           if (src) {"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/script-before-interactive/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Flayout.tsx?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b7d081ca9c9ea2b655c674e5985b01cac21967bf",
            "filename": "test/e2e/app-dir/script-before-interactive/app/multiple/page.tsx",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fmultiple%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fmultiple%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fmultiple%2Fpage.tsx?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -0,0 +1,34 @@\n+import Script from 'next/script'\n+\n+export default function MultiplePage() {\n+  return (\n+    <div>\n+      <h1>Multiple beforeInteractive Scripts Test</h1>\n+      <Script\n+        id=\"first-script\"\n+        strategy=\"beforeInteractive\"\n+        className=\"first-script\"\n+        dangerouslySetInnerHTML={{\n+          __html: `\n+            console.log('First beforeInteractive script executed');\n+            window.firstScriptExecuted = true;\n+          `,\n+        }}\n+      />\n+      <Script\n+        id=\"second-script\"\n+        strategy=\"beforeInteractive\"\n+        className=\"second-script\"\n+        dangerouslySetInnerHTML={{\n+          __html: `\n+            console.log('Second beforeInteractive script executed');\n+            window.secondScriptExecuted = true;\n+          `,\n+        }}\n+      />\n+      <p>\n+        This page tests multiple beforeInteractive scripts with CSS classes.\n+      </p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f155719f8bb680b31bcd66cc9fc9d4556503be4c",
            "filename": "test/e2e/app-dir/script-before-interactive/app/page.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fapp%2Fpage.tsx?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -0,0 +1,23 @@\n+import Script from 'next/script'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Script beforeInteractive Test</h1>\n+      <Script\n+        id=\"example-script\"\n+        strategy=\"beforeInteractive\"\n+        className=\"example-class\"\n+        dangerouslySetInnerHTML={{\n+          __html: `\n+            console.log('beforeInteractive script executed');\n+            window.beforeInteractiveExecuted = true;\n+          `,\n+        }}\n+      />\n+      <p>\n+        This page tests the beforeInteractive script strategy with CSS classes.\n+      </p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "767719fc4fba59345ae29e29159c9aff270f5819",
            "filename": "test/e2e/app-dir/script-before-interactive/next.config.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fnext.config.js?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -0,0 +1,4 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "fdab98c38c336c84fd2dc33941db2a26e6d7fcb9",
            "filename": "test/e2e/app-dir/script-before-interactive/script-before-interactive.test.ts",
            "status": "added",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fscript-before-interactive.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c432d07a595b5edbd6d2ce6c50a065e7115e1622/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fscript-before-interactive.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscript-before-interactive%2Fscript-before-interactive.test.ts?ref=c432d07a595b5edbd6d2ce6c50a065e7115e1622",
            "patch": "@@ -0,0 +1,61 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Script component with beforeInteractive strategy CSS class rendering', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render script tag with correct class attribute instead of classname', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Wait for the page to fully load\n+    await browser.waitForElementByCss('#example-script')\n+\n+    // Get the HTML content to check the actual rendered attributes\n+    const html = await browser.eval(() => document.documentElement.innerHTML)\n+\n+    // Check that the script tag has 'class' attribute, not 'classname'\n+    expect(html).toContain('class=\"example-class\"')\n+    expect(html).not.toContain('classname=\"example-class\"')\n+\n+    // Also verify the script element directly\n+    const scriptElement = await browser.elementByCss('#example-script')\n+    const className = await scriptElement.getAttribute('class')\n+\n+    expect(className).toBe('example-class')\n+  })\n+\n+  it('should execute beforeInteractive script correctly', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Check that the script executed by looking for its side effects\n+    const hasExecuted = await browser.eval(() => {\n+      return (window as any).beforeInteractiveExecuted === true\n+    })\n+\n+    expect(hasExecuted).toBe(true)\n+  })\n+\n+  it('should render script in document head with beforeInteractive strategy', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Check that the script is in the head section\n+    const scriptInHead = await browser.eval(() => {\n+      return document.head.querySelector('#example-script') !== null\n+    })\n+\n+    expect(scriptInHead).toBe(true)\n+  })\n+\n+  it('should render multiple beforeInteractive scripts with correct class attributes', async () => {\n+    const browser = await next.browser('/multiple')\n+\n+    const html = await browser.eval(() => document.documentElement.innerHTML)\n+\n+    // Check that both scripts have correct class attributes\n+    expect(html).toContain('class=\"first-script\"')\n+    expect(html).toContain('class=\"second-script\"')\n+    expect(html).not.toContain('classname=\"first-script\"')\n+    expect(html).not.toContain('classname=\"second-script\"')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 141,
        "additions": 136,
        "deletions": 5
    }
}