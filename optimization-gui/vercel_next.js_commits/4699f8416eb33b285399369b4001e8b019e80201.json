{
    "author": "eps1lon",
    "message": "[test] Add dedicated test for error when client functions are called from server components (#81930)\n\nWe have a more specific one for `use cache`. This is the counterpart for the default environment.",
    "sha": "4699f8416eb33b285399369b4001e8b019e80201",
    "files": [
        {
            "sha": "190ed5ae1234fe314545fabeb716433ea53764a8",
            "filename": "test/development/app-dir/source-mapping/app/server-client/client.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fclient.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fclient.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fclient.js?ref=4699f8416eb33b285399369b4001e8b019e80201",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function useClient() {\n+  return 'client function'\n+}"
        },
        {
            "sha": "3da17bce5b86f47004502b2679518c7503739ab2",
            "filename": "test/development/app-dir/source-mapping/app/server-client/page.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fapp%2Fserver-client%2Fpage.js?ref=4699f8416eb33b285399369b4001e8b019e80201",
            "patch": "@@ -0,0 +1,15 @@\n+import { Suspense } from 'react'\n+import { useClient } from './client'\n+\n+function Component() {\n+  useClient()\n+\n+  return <p>Hello, Dave</p>\n+}\n+export default function Page() {\n+  return (\n+    <Suspense>\n+      <Component />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "df263a641c06c882b0a30878b2155af24927bf04",
            "filename": "test/development/app-dir/source-mapping/source-mapping.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 1,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4699f8416eb33b285399369b4001e8b019e80201/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts?ref=4699f8416eb33b285399369b4001e8b019e80201",
            "patch": "@@ -1,8 +1,11 @@\n import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n \n+const isCacheComponentsEnabled =\n+  process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n+\n describe('source-mapping', () => {\n-  const { next } = nextTestSetup({\n+  const { isTurbopack, next } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -165,4 +168,41 @@ describe('source-mapping', () => {\n       )\n     })\n   })\n+\n+  it('should show an error when client functions are called from server components', async () => {\n+    const browser = await next.browser('/server-client')\n+\n+    // TODO(veil): Top stack should be ignore-listed\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+         \"environmentLabel\": \"${isCacheComponentsEnabled ? 'Prerender' : 'Server'}\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/server-client/client.js/proxy.mjs (3:24) @ <anonymous>\n+       > 3 |     function() { throw new Error(\"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n+           |                        ^\",\n+         \"stack\": [\n+           \"<anonymous> app/server-client/client.js/proxy.mjs (3:24)\",\n+           \"Component app/server-client/page.js (5:12)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+         \"environmentLabel\": \"${isCacheComponentsEnabled ? 'Prerender' : 'Server'}\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/server-client/page.js (5:12) @ Component\n+       > 5 |   useClient()\n+           |            ^\",\n+         \"stack\": [\n+           \"<FIXME-file-protocol>\",\n+           \"Component app/server-client/page.js (5:12)\",\n+         ],\n+       }\n+      `)\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 61,
        "deletions": 1
    }
}