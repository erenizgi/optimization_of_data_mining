{
    "author": "acdlite",
    "message": "[Segment Cache] Add \"client-only\" option (#77655)\n\nWe're currently working through some issues surfaced by the new\nper-segment routes introduced by the Segment Cache experiment. Testing\nof this feature in production has been blocked while we figure that out.\n\nHowever, aside from per-segment prefetching, there are a bunch of\nclient-only changes and improvements to the Segment Cache implementation\nthat we can test in the meantime.\n\nSo, I've added a \"client-only\" option the `clientSegmentCache` flag.\nWhen enabled, Next.js will not generate per-segment prefetch responses,\nbut the client will switch to the new prefetching implementation. This\nincludes:\n\n- De-duping of shared layouts across prefetch requests.\n- More resilience to race conditions.\n- Prefetch cancellation on Link viewport exit.\n- Re-prefetching stale data after revalidateTag/revalidatePath.\n\netc.\n\nIt's essentially a complete rewrite of the client-side prefetching\nimplementation. Given the scope of the change, it may contain subtle\nregressions that I haven't yet discovered. That's why it's so urgent for\nme to start testing this in real apps.\n\nI initially hesitated to implement the \"client-only\" option because 1)\nthere are already so many combinations of flags and forked\nimplementations to juggle, and I didn't want to add another one, and 2)\nI thought it would take less time to fix the deployment issues that are\nblocking the wider rollout.\n\nBut it turned out to be less net new complexity than I anticipated,\ngiven that I already had to support `ppr: \"incremental\"`, which works in\na largely similar way.",
    "sha": "713caf60704c70889006cd07897a10d2a7a537a5",
    "files": [
        {
            "sha": "3050e5eaa78d2e80fcb469d05610f1a11806dc34",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 12,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -1028,6 +1028,7 @@ export async function fetchRouteOnCacheMiss(\n \n       writeDynamicTreeResponseIntoCache(\n         Date.now(),\n+        task,\n         response,\n         serverData,\n         entry,\n@@ -1246,6 +1247,10 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n       prefetchStream\n     ) as Promise<NavigationFlightResponse>)\n \n+    // Since we did not set the prefetch header, the response from the server\n+    // will never contain dynamic holes.\n+    const isResponsePartial = false\n+\n     // Aside from writing the data into the cache, this function also returns\n     // the entries that were fulfilled, so we can streamingly update their sizes\n     // in the LRU as more data comes in.\n@@ -1254,6 +1259,7 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n       task,\n       response,\n       serverData,\n+      isResponsePartial,\n       route,\n       spawnedEntries\n     )\n@@ -1269,6 +1275,7 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n \n function writeDynamicTreeResponseIntoCache(\n   now: number,\n+  task: PrefetchTask,\n   response: Response,\n   serverData: NavigationFlightResponse,\n   entry: PendingRouteCacheEntry,\n@@ -1311,16 +1318,43 @@ function writeDynamicTreeResponseIntoCache(\n     staleTimeHeaderSeconds !== null\n       ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n       : STATIC_STALETIME_MS\n-  fulfillRouteCacheEntry(\n+\n+  // If the response contains dynamic holes, then we must conservatively assume\n+  // that any individual segment might contain dynamic holes, and also the\n+  // head. If it did not contain dynamic holes, then we can assume every segment\n+  // and the head is completely static.\n+  const isResponsePartial =\n+    response.headers.get(NEXT_DID_POSTPONE_HEADER) === '1'\n+\n+  const fulfilledEntry = fulfillRouteCacheEntry(\n     entry,\n     convertRootFlightRouterStateToRouteTree(flightRouterState),\n     flightData.head,\n-    flightData.isHeadPartial,\n+    isResponsePartial,\n     now + staleTimeMs,\n     couldBeIntercepted,\n     canonicalUrl,\n     routeIsPPREnabled\n   )\n+\n+  // If the server sent segment data as part of the response, we should write\n+  // it into the cache to prevent a second, redundant prefetch request.\n+  //\n+  // TODO: When `clientSegmentCache` is enabled, the server does not include\n+  // segment data when responding to a route tree prefetch request. However,\n+  // when `clientSegmentCache` is set to \"client-only\", and PPR is enabled (or\n+  // the page is fully static), the normal check is bypassed and the server\n+  // responds with the full page. This is a temporary situation until we can\n+  // remove the \"client-only\" option. Then, we can delete this function call.\n+  writeDynamicRenderResponseIntoCache(\n+    now,\n+    task,\n+    response,\n+    serverData,\n+    isResponsePartial,\n+    fulfilledEntry,\n+    null\n+  )\n }\n \n function rejectSegmentEntriesIfStillPending(\n@@ -1343,16 +1377,19 @@ function writeDynamicRenderResponseIntoCache(\n   task: PrefetchTask,\n   response: Response,\n   serverData: NavigationFlightResponse,\n+  isResponsePartial: boolean,\n   route: FulfilledRouteCacheEntry,\n-  spawnedEntries: Map<string, PendingSegmentCacheEntry>\n+  spawnedEntries: Map<string, PendingSegmentCacheEntry> | null\n ): Array<FulfilledSegmentCacheEntry> | null {\n   if (serverData.b !== getAppBuildId()) {\n     // The server build does not match the client. Treat as a 404. During\n     // an actual navigation, the router will trigger an MPA navigation.\n     // TODO: Consider moving the build ID to a response header so we can check\n     // it before decoding the response, and so there's one way of checking\n     // across all response types.\n-    rejectSegmentEntriesIfStillPending(spawnedEntries, now + 10 * 1000)\n+    if (spawnedEntries !== null) {\n+      rejectSegmentEntriesIfStillPending(spawnedEntries, now + 10 * 1000)\n+    }\n     return null\n   }\n   const flightDatas = normalizeFlightData(serverData.f)\n@@ -1395,6 +1432,7 @@ function writeDynamicRenderResponseIntoCache(\n         route,\n         now + staleTimeMs,\n         seedData,\n+        isResponsePartial,\n         segmentKey,\n         spawnedEntries\n       )\n@@ -1408,11 +1446,14 @@ function writeDynamicRenderResponseIntoCache(\n   // segments we're marking as rejected here. We should mark on the segment\n   // somehow that the reason for the rejection is because of a non-PPR prefetch.\n   // That way a per-segment prefetch knows to disregard the rejection.\n-  const fulfilledEntries = rejectSegmentEntriesIfStillPending(\n-    spawnedEntries,\n-    now + 10 * 1000\n-  )\n-  return fulfilledEntries\n+  if (spawnedEntries !== null) {\n+    const fulfilledEntries = rejectSegmentEntriesIfStillPending(\n+      spawnedEntries,\n+      now + 10 * 1000\n+    )\n+    return fulfilledEntries\n+  }\n+  return null\n }\n \n function writeSeedDataIntoCache(\n@@ -1421,8 +1462,9 @@ function writeSeedDataIntoCache(\n   route: FulfilledRouteCacheEntry,\n   staleAt: number,\n   seedData: CacheNodeSeedData,\n+  isResponsePartial: boolean,\n   key: string,\n-  entriesOwnedByCurrentTask: Map<string, PendingSegmentCacheEntry>\n+  entriesOwnedByCurrentTask: Map<string, PendingSegmentCacheEntry> | null\n ) {\n   // This function is used to write the result of a dynamic server request\n   // (CacheNodeSeedData) into the prefetch cache. It's used in cases where we\n@@ -1431,12 +1473,15 @@ function writeSeedDataIntoCache(\n   // dynamic data into being static) and when prefetching a PPR-disabled route\n   const rsc = seedData[1]\n   const loading = seedData[3]\n-  const isPartial = rsc === null\n+  const isPartial = rsc === null || isResponsePartial\n \n   // We should only write into cache entries that are owned by us. Or create\n   // a new one and write into that. We must never write over an entry that was\n   // created by a different task, because that causes data races.\n-  const ownedEntry = entriesOwnedByCurrentTask.get(key)\n+  const ownedEntry =\n+    entriesOwnedByCurrentTask !== null\n+      ? entriesOwnedByCurrentTask.get(key)\n+      : undefined\n   if (ownedEntry !== undefined) {\n     fulfillSegmentCacheEntry(ownedEntry, rsc, loading, staleAt, isPartial)\n   } else {\n@@ -1481,6 +1526,7 @@ function writeSeedDataIntoCache(\n           route,\n           staleAt,\n           childSeedData,\n+          isResponsePartial,\n           encodeChildSegmentKey(\n             key,\n             parallelRouteKey,"
        },
        {
            "sha": "9b3d9aa7aeb909877007361b77aad87cf53e0958",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -391,7 +391,10 @@ async function exportAppImpl(\n       clientTraceMetadata: nextConfig.experimental.clientTraceMetadata,\n       expireTime: nextConfig.expireTime,\n       dynamicIO: nextConfig.experimental.dynamicIO ?? false,\n-      clientSegmentCache: nextConfig.experimental.clientSegmentCache ?? false,\n+      clientSegmentCache:\n+        nextConfig.experimental.clientSegmentCache === 'client-only'\n+          ? 'client-only'\n+          : Boolean(nextConfig.experimental.clientSegmentCache),\n       inlineCss: nextConfig.experimental.inlineCss ?? false,\n       authInterrupts: !!nextConfig.experimental.authInterrupts,\n     },"
        },
        {
            "sha": "49963c2ebfd948b204f49526048feed6b7ccb42b",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -4212,7 +4212,17 @@ async function collectSegmentData(\n   // decomposed into a separate stream per segment.\n \n   const clientReferenceManifest = renderOpts.clientReferenceManifest\n-  if (!clientReferenceManifest || !renderOpts.experimental.clientSegmentCache) {\n+  if (\n+    !clientReferenceManifest ||\n+    // Do not generate per-segment data unless the experimental Segment Cache\n+    // flag is enabled.\n+    //\n+    // We also skip generating segment data if flag is set to \"client-only\",\n+    // rather than true. (The \"client-only\" option only affects the behavior of\n+    // the client-side implementation; per-segment prefetches are intentionally\n+    // disabled in that configuration).\n+    renderOpts.experimental.clientSegmentCache !== true\n+  ) {\n     return\n   }\n "
        },
        {
            "sha": "7f6e30fe1e29cce0579893ba83f20ec8405c2a54",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -213,7 +213,7 @@ export interface RenderOptsPartial {\n     expireTime: number | undefined\n     clientTraceMetadata: string[] | undefined\n     dynamicIO: boolean\n-    clientSegmentCache: boolean\n+    clientSegmentCache: boolean | 'client-only'\n     inlineCss: boolean\n     authInterrupts: boolean\n   }"
        },
        {
            "sha": "aef493353d078bb5682d4733fc7e8e2eb53f621b",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -605,7 +605,9 @@ export default abstract class Server<\n         clientTraceMetadata: this.nextConfig.experimental.clientTraceMetadata,\n         dynamicIO: this.nextConfig.experimental.dynamicIO ?? false,\n         clientSegmentCache:\n-          this.nextConfig.experimental.clientSegmentCache ?? false,\n+          this.nextConfig.experimental.clientSegmentCache === 'client-only'\n+            ? 'client-only'\n+            : Boolean(this.nextConfig.experimental.clientSegmentCache),\n         inlineCss: this.nextConfig.experimental.inlineCss ?? false,\n         authInterrupts: !!this.nextConfig.experimental.authInterrupts,\n       },"
        },
        {
            "sha": "85d747b7e49020b3c54ee3a371a098bc1e2f97c8",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -299,7 +299,9 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         memoryBasedWorkersCount: z.boolean().optional(),\n         craCompat: z.boolean().optional(),\n         caseSensitiveRoutes: z.boolean().optional(),\n-        clientSegmentCache: z.boolean().optional(),\n+        clientSegmentCache: z\n+          .union([z.boolean(), z.literal('client-only')])\n+          .optional(),\n         disableOptimizedLoading: z.boolean().optional(),\n         disablePostcssPresetEnv: z.boolean().optional(),\n         dynamicIO: z.boolean().optional(),"
        },
        {
            "sha": "83248b7056ba24dbd240daafaaffe4e0b161e4e6",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -269,7 +269,7 @@ export interface ExperimentalConfig {\n   prerenderEarlyExit?: boolean\n   linkNoTouchStart?: boolean\n   caseSensitiveRoutes?: boolean\n-  clientSegmentCache?: boolean\n+  clientSegmentCache?: boolean | 'client-only'\n   appDocumentPreloading?: boolean\n   preloadEntriesOnStart?: boolean\n   /** @default true */"
        },
        {
            "sha": "73c731c3c94a587e8260a21dd07f84286a46cbcd",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/dynamic-with-ppr/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Floading.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <div>Loading dynamic content...</div>\n+}"
        },
        {
            "sha": "e662d1fbe3b4407c9139c810a52cb600802478e3",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/dynamic-with-ppr/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-with-ppr%2Fpage.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,8 @@\n+import { connection } from 'next/server'\n+\n+export const experimental_ppr = true\n+\n+export default async function DynamicPage() {\n+  await connection()\n+  return <div id=\"dynamic-content\">Dynamic Content</div>\n+}"
        },
        {
            "sha": "73c731c3c94a587e8260a21dd07f84286a46cbcd",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/dynamic-without-ppr/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Floading.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <div>Loading dynamic content...</div>\n+}"
        },
        {
            "sha": "8752988e11a825795afb0d89e98b7a2417212496",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/dynamic-without-ppr/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fdynamic-without-ppr%2Fpage.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function DynamicPage() {\n+  await connection()\n+  return <div id=\"dynamic-content\">Dynamic Content</div>\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Flayout.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "fc5d921d5d732e66783248cdd4a68f85d8597ceb",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/page.tsx",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fpage.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,35 @@\n+import { LinkAccordion } from '../components/link-accordion'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>\n+        <code>clientSegmentCache: 'client-only'</code>\n+      </h1>\n+      <p>\n+        This page demonstrates the behavior when the experimental Segment Cache\n+        flag is set to <code>'client-only'</code> instead of <code>true</code>.\n+        The new prefetching implementation is enabled on the client, but the\n+        server will not generate any per-segment prefetching. This is useful\n+        because the client implementation has many other improvements that are\n+        unrelated to per-segment prefetching, like improved scheduling and\n+        dynamic request deduping.\n+      </p>\n+      <ul>\n+        <li>\n+          <LinkAccordion href=\"/static\">Static page</LinkAccordion>\n+        </li>\n+        <li>\n+          <LinkAccordion href=\"/dynamic-with-ppr\">\n+            Dynamic page (with PPR enabled)\n+          </LinkAccordion>\n+        </li>\n+        <li>\n+          <LinkAccordion href=\"/dynamic-without-ppr\">\n+            Dynamic page (without PPR enabled)\n+          </LinkAccordion>\n+        </li>\n+      </ul>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "0a4f3cea8c64f1cc8434e98a5e3dc473ae864ca9",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/app/static/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fstatic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fstatic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fapp%2Fstatic%2Fpage.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,3 @@\n+export default function StaticPage() {\n+  return <div id=\"static-content\">Static Content</div>\n+}"
        },
        {
            "sha": "6ee934d026507e17a1bacbac0f36ad6105d5ab6c",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/client-only-opt-in.test.ts",
            "status": "added",
            "additions": 130,
            "deletions": 0,
            "changes": 130,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,130 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import type * as Playwright from 'playwright'\n+import { createRouterAct } from '../router-act'\n+\n+describe('segment cache prefetch scheduling', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+  if (isNextDev || skipped) {\n+    test('prefetching is disabled', () => {})\n+    return\n+  }\n+\n+  it('prefetches a static page in a single request', async () => {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p: Playwright.Page) {\n+        act = createRouterAct(p)\n+      },\n+    })\n+\n+    // Because per-segment prefetching is not enabled in this app, the attempt\n+    // to prefetch the route tree will return not just the tree but the data for\n+    // the entire page. Although this prevents us from deduping shared layouts,\n+    // we should seed the cache with the extra data to avoid a second request\n+    // for the data.\n+    const linkVisibilityToggle = await browser.elementByCss(\n+      'input[data-link-accordion=\"/static\"]'\n+    )\n+    await act(\n+      async () => {\n+        await linkVisibilityToggle.click()\n+      },\n+      {\n+        // This assertion will fail if this string appears in multiple requests.\n+        includes: 'Static Content',\n+      }\n+    )\n+\n+    // When navigating to the prefetched static page, no additional requests\n+    // are issued.\n+    const link = await browser.elementByCss('a[href=\"/static\"]')\n+    await act(async () => {\n+      await link.click()\n+      const staticContent = await browser.elementById('static-content')\n+      expect(await staticContent.innerHTML()).toBe('Static Content')\n+    }, 'no-requests')\n+  })\n+\n+  it('prefetches a dynamic page (with PPR enabled)', async () => {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p: Playwright.Page) {\n+        act = createRouterAct(p)\n+      },\n+    })\n+\n+    const linkVisibilityToggle = await browser.elementByCss(\n+      'input[data-link-accordion=\"/dynamic-with-ppr\"]'\n+    )\n+    await act(async () => {\n+      await linkVisibilityToggle.click()\n+    }, [\n+      // This assertion will fail if this string appears in multiple requests.\n+      {\n+        includes: 'Loading dynamic content...',\n+      },\n+      // Does not include the dynamic content\n+      {\n+        block: 'reject',\n+        includes: 'Dynamic Content',\n+      },\n+    ])\n+\n+    // When navigating to the prefetched dynamic page, an additional request\n+    // is issued to fetch the dynamic content.\n+    const link = await browser.elementByCss('a[href=\"/dynamic-with-ppr\"]')\n+    await act(\n+      async () => {\n+        await link.click()\n+      },\n+      {\n+        includes: 'Dynamic Content',\n+      }\n+    )\n+    const dynamicContent = await browser.elementById('dynamic-content')\n+    expect(await dynamicContent.innerHTML()).toBe('Dynamic Content')\n+  })\n+\n+  it('prefetches a dynamic page (without PPR enabled)', async () => {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p: Playwright.Page) {\n+        act = createRouterAct(p)\n+      },\n+    })\n+\n+    const linkVisibilityToggle = await browser.elementByCss(\n+      'input[data-link-accordion=\"/dynamic-without-ppr\"]'\n+    )\n+    await act(async () => {\n+      await linkVisibilityToggle.click()\n+    }, [\n+      // This assertion will fail if this string appears in multiple requests.\n+      {\n+        includes: 'Loading dynamic content...',\n+      },\n+      // Does not include the dynamic content\n+      {\n+        block: 'reject',\n+        includes: 'Dynamic Content',\n+      },\n+    ])\n+\n+    // When navigating to the prefetched dynamic page, an additional request\n+    // is issued to fetch the dynamic content.\n+    const link = await browser.elementByCss('a[href=\"/dynamic-without-ppr\"]')\n+    await act(\n+      async () => {\n+        await link.click()\n+      },\n+      {\n+        includes: 'Dynamic Content',\n+      }\n+    )\n+    const dynamicContent = await browser.elementById('dynamic-content')\n+    expect(await dynamicContent.innerHTML()).toBe('Dynamic Content')\n+  })\n+})"
        },
        {
            "sha": "c735a55918b5489458940dcdd29daa6f2ec50315",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/components/link-accordion.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fcomponents%2Flink-accordion.tsx?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,33 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({\n+  href,\n+  children,\n+  prefetch,\n+}: {\n+  href: string\n+  children: React.ReactNode\n+  prefetch?: boolean\n+}) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href} prefetch={prefetch}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "64a383e0b691edffd58d6031679a3b61ee48e3ae",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/713caf60704c70889006cd07897a10d2a7a537a5/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fnext.config.js?ref=713caf60704c70889006cd07897a10d2a7a537a5",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: 'incremental',\n+    dynamicIO: true,\n+    clientSegmentCache: 'client-only',\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 343,
        "additions": 325,
        "deletions": 18
    }
}