{
    "author": "padmaia",
    "message": "chore(Next.js sync): open draft PRs immediately (#82424)\n\nBefore:\nCron runs would open a Draft PR if they happened to run before\ndeployment tests finished. Once deployment tests completed, the system\nwould either open a PR and immediately close it (if tests failed) or\nopen it as ready for review (if tests passed).\n\nAfter:\nBoth cron runs and new releases will open Draft PRs. Once deployment\ntests run and pass, these PRs will be marked as ready for review. If\ntests fail, the PRs remain as drafts.\n\nRelated PRS:\nhttps://github.com/vercel/v0/pull/12992\nhttps://github.com/vercel/front/pull/50036",
    "sha": "30a7204c3a4e0f0bbba18a9e5bcce0f4ca4738d9",
    "files": [
        {
            "sha": "d5b72f25a9c7ead7e2acbee2f8ce27477ef79cd1",
            "filename": ".github/workflows/test_e2e_deploy_release.yml",
            "status": "modified",
            "additions": 98,
            "deletions": 40,
            "changes": 138,
            "blob_url": "https://github.com/vercel/next.js/blob/30a7204c3a4e0f0bbba18a9e5bcce0f4ca4738d9/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/30a7204c3a4e0f0bbba18a9e5bcce0f4ca4738d9/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml?ref=30a7204c3a4e0f0bbba18a9e5bcce0f4ca4738d9",
            "patch": "@@ -32,6 +32,8 @@ jobs:\n   setup:\n     runs-on: ubuntu-latest\n     if: github.repository_owner == 'vercel'\n+    outputs:\n+      next-version: ${{ steps.version.outputs.value }}\n     steps:\n       - name: Setup Node.js\n         uses: actions/setup-node@v4\n@@ -49,14 +51,27 @@ jobs:\n         with:\n           fetch-depth: 25\n \n+      - id: nextPackageInfo\n+        name: Get `next` package info\n+        run: |\n+          cd packages/next \n+          {\n+            echo 'value<<EOF'\n+            cat package.json\n+            echo EOF\n+          } >> \"$GITHUB_OUTPUT\"\n+      - id: version\n+        name: Extract `next` version\n+        run: echo 'value=${{ fromJson(steps.nextPackageInfo.outputs.value).version }}' >> \"$GITHUB_OUTPUT\"\n+\n       - name: Setup test project\n         run: |\n           pnpm install\n           pnpm run build\n           node scripts/run-e2e-test-project-reset.mjs\n \n   test-deploy:\n-    name: test deploy\n+    name: Run Deploy Tests\n     needs: setup\n     uses: ./.github/workflows/build_reusable.yml\n     secrets: inherit\n@@ -77,7 +92,7 @@ jobs:\n     if: ${{ always() }}\n \n     runs-on: ubuntu-latest\n-    name: report test results to datadog\n+    name: Report test results to datadog\n     steps:\n       - name: Download test report artifacts\n         id: download-test-reports\n@@ -93,9 +108,79 @@ jobs:\n             DD_ENV=ci npx @datadog/datadog-ci@2.23.1 junit upload --tags test.type:deploy --service nextjs ./test/test-junit-report\n           fi\n \n-  sync-repositories:\n-    needs: test-deploy\n-    if: ${{ always() && github.repository_owner == 'vercel' && github.event_name == 'release' }}\n+  create-draft-prs:\n+    name: Immediately open draft prs\n+    needs: setup\n+    if: ${{ github.repository_owner == 'vercel' && github.event_name == 'release' }}\n+    runs-on: ubuntu-latest\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        include:\n+          - repo: front\n+            workflow_id: cron-update-next.yml\n+          - repo: v0\n+            workflow_id: update-next.yml\n+    steps:\n+      - name: Check token\n+        run: gh auth status\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GH_UPDATE_NEXT_WORKFLOW_TRIGGER }}\n+      - uses: actions/github-script@v7\n+        name: Check if target workflow is enabled\n+        id: check-workflow-enabled\n+        with:\n+          retries: 3\n+          retry-exempt-status-codes: 400,401,403,404,422\n+          github-token: ${{ secrets.GH_UPDATE_NEXT_WORKFLOW_TRIGGER }}\n+          result-encoding: string\n+          script: |\n+            const response = await github.request(\n+              \"GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}\",\n+              {\n+                owner: \"vercel\",\n+                repo: \"${{ matrix.repo }}\",\n+                workflow_id: \"${{ matrix.workflow_id }}\",\n+              }\n+            );\n+\n+            const isEnabled = response.data.state === 'active';\n+            console.info(`Target workflow state: ${response.data.state}`);\n+            console.info(`Target workflow enabled: ${isEnabled}`);\n+\n+            return isEnabled ? 'true' : 'false';\n+      - uses: actions/github-script@v7\n+        name: Create draft PR for vercel/${{ matrix.repo }}\n+        id: create-draft-pr\n+        if: steps.check-workflow-enabled.outputs.result == 'true'\n+        with:\n+          retries: 3\n+          retry-exempt-status-codes: 400,401,404\n+          github-token: ${{ secrets.GH_UPDATE_NEXT_WORKFLOW_TRIGGER }}\n+          result-encoding: string\n+          script: |\n+            const inputs = {\n+              version: \"${{ needs.setup.outputs.next-version }}\"\n+            };\n+\n+            await github.request(\n+              \"POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches\",\n+              {\n+                owner: \"vercel\",\n+                repo: \"${{ matrix.repo }}\",\n+                workflow_id: \"${{ matrix.workflow_id }}\",\n+                ref: \"main\",\n+                inputs: inputs,\n+              }\n+            );\n+\n+            console.info(`Draft PR creation triggered for ${{ matrix.repo }}`);\n+            console.info(`Workflow will create draft PR by default`);\n+\n+  update-prs:\n+    name: Update prs as ready for review\n+    needs: [test-deploy, create-draft-prs]\n+    if: ${{ needs.test-deploy.result == 'success' && github.repository_owner == 'vercel' && github.event_name == 'release' }}\n     runs-on: ubuntu-latest\n     strategy:\n       fail-fast: false\n@@ -108,22 +193,6 @@ jobs:\n             workflow_id: update-next.yml\n             workflow_url: https://github.com/vercel/v0/actions/workflows/update-next.yml?query=event%3Aworkflow_dispatch\n     steps:\n-      - uses: actions/checkout@v4\n-      - id: nextPackageInfo\n-        name: Get `next` package info\n-        run: |\n-          cd packages/next \n-          {\n-            echo 'value<<EOF'\n-            cat package.json\n-            echo EOF\n-          } >> \"$GITHUB_OUTPUT\"\n-      - id: version\n-        name: Extract `next` version\n-        run: echo 'value=${{ fromJson(steps.nextPackageInfo.outputs.value).version }}' >> \"$GITHUB_OUTPUT\"\n-      - id: test-result\n-        name: Set test result variable\n-        run: echo 'immediately-close=${{ needs.test-deploy.result != 'success' && 'true' || 'false' }}' >> \"$GITHUB_OUTPUT\"\n       - name: Check token\n         run: gh auth status\n         env:\n@@ -157,8 +226,8 @@ jobs:\n               return 'false';\n             }\n       - uses: actions/github-script@v7\n-        name: Trigger vercel/${{ matrix.repo }} sync\n-        id: trigger-sync\n+        name: Mark PR ready for review in vercel/${{ matrix.repo }}\n+        id: mark-pr-ready\n         if: steps.check-workflow-enabled.outputs.result == 'true'\n         with:\n           retries: 3\n@@ -169,15 +238,12 @@ jobs:\n           # Note `workflow_id` and `inputs` are contract between vercel/${{ matrix.repo }},\n           # if these need to be changed both side should be updated accordingly.\n           script: |\n-            const immediatelyClose = '${{ steps.test-result.outputs.immediately-close }}';\n             const inputs = {\n-              version: \"${{ steps.version.outputs.value }}\",\n+              version: \"${{ needs.setup.outputs.next-version }}\",\n+              'make-ready-for-review': 'true',\n+              force: 'true'\n             };\n \n-            if (immediatelyClose === 'true') {\n-              inputs['immediately-close'] = 'true';\n-            }\n-\n             await github.request(\n               \"POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches\",\n               {\n@@ -188,16 +254,8 @@ jobs:\n                 inputs: inputs,\n               }\n             );\n-            // Ideally we'd include a URL to this specific sync.\n-            // However, creating a workflow_dispatch event does not produce an ID: https://github.com/orgs/community/discussions/9752\n-            console.info(\n-              \"Sync started in ${{ matrix.workflow_url }}\"\n-            );\n+\n+            console.info(\"Tests passed - PR will be marked ready for review\");\n             console.info(\n-              \"This may not start a new sync if one is already in progress. Check the logs of the workflow run.\"\n+              \"PR ready-for-review triggered in ${{ matrix.workflow_url }}\"\n             );\n-            if (immediatelyClose === 'true') {\n-              console.info(\n-                \"Sync triggered with immediately-close=true due to test failure.\"\n-              );\n-            }"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 98,
        "deletions": 40
    }
}