{
    "author": "gaojude",
    "message": "(feat) support client-side instrumentation (#76916)",
    "sha": "7de4c0728ba8c09d27e1d681026e9e868361f773",
    "files": [
        {
            "sha": "62c3897ec18766899c0208ef1cf7488982a42d9b",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -244,6 +244,7 @@ pub async fn get_next_client_import_map(\n     }\n \n     insert_turbopack_dev_alias(&mut import_map).await?;\n+    insert_instrumentation_client_alias(&mut import_map, project_path).await?;\n \n     Ok(import_map.cell())\n }\n@@ -1143,6 +1144,26 @@ async fn insert_turbopack_dev_alias(import_map: &mut ImportMap) -> Result<()> {\n     Ok(())\n }\n \n+/// Handles instrumentation-client.ts bundling logic\n+async fn insert_instrumentation_client_alias(\n+    import_map: &mut ImportMap,\n+    project_path: ResolvedVc<FileSystemPath>,\n+) -> Result<()> {\n+    insert_alias_to_alternatives(\n+        import_map,\n+        \"private-next-instrumentation-client\",\n+        vec![\n+            request_to_import_mapping(project_path, \"./src/instrumentation-client\"),\n+            request_to_import_mapping(project_path, \"./src/instrumentation-client.ts\"),\n+            request_to_import_mapping(project_path, \"./instrumentation-client\"),\n+            request_to_import_mapping(project_path, \"./instrumentation-client.ts\"),\n+            ImportMapping::Ignore.resolved_cell(),\n+        ],\n+    );\n+\n+    Ok(())\n+}\n+\n /// Creates a direct import mapping to the result of resolving a request\n /// in a context.\n fn request_to_import_mapping("
        },
        {
            "sha": "38205e6bd4a7b7b68cbed7df611039efa8055584",
            "filename": "packages/next/src/build/create-compiler-aliases.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -139,6 +139,19 @@ export function createWebpackAliases({\n     ...(pagesDir ? { [PAGES_DIR_ALIAS]: pagesDir } : {}),\n     ...(appDir ? { [APP_DIR_ALIAS]: appDir } : {}),\n     [ROOT_DIR_ALIAS]: dir,\n+    ...(isClient\n+      ? {\n+          'private-next-instrumentation-client': [\n+            path.join(dir, 'src', 'instrumentation-client'),\n+            path.join(dir, 'instrumentation-client'),\n+            'private-next-empty-module',\n+          ],\n+\n+          // disable typechecker, webpack5 allows aliases to be set to false to create a no-op module\n+          'private-next-empty-module': false as any,\n+        }\n+      : {}),\n+\n     [DOT_NEXT_ALIAS]: distDir,\n     ...(isClient || isEdgeServer ? getOptimizedModuleAliases() : {}),\n     ...(reactProductionProfiling ? getReactProfilingInProduction() : {}),"
        },
        {
            "sha": "0030b927e3c990be45294914bb6d353893dd6853",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -240,6 +240,9 @@ export function getDefineEnv({\n     'process.env.__NEXT_TELEMETRY_DISABLED': Boolean(\n       process.env.NEXT_TELEMETRY_DISABLED\n     ),\n+    'process.env.__NEXT_EXPERIMENTAL_CLIENT_INSTRUMENTATION_HOOK': Boolean(\n+      config.experimental.clientInstrumentationHook\n+    ),\n     ...(isNodeOrEdgeCompilation\n       ? {\n           // Fix bad-actors in the npm ecosystem (e.g. `node-formidable`)"
        },
        {
            "sha": "e608b7dd08daf32e8b382885314660b5402de451",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -225,6 +225,7 @@ function Root({ children }: React.PropsWithChildren<{}>) {\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n     React.useEffect(() => {\n       window.__NEXT_HYDRATED = true\n+      window.__NEXT_HYDRATED_AT = performance.now()\n       window.__NEXT_HYDRATED_CB?.()\n     }, [])\n   }"
        },
        {
            "sha": "20077690a62644d92f71c2d363a0213f60e9e79e",
            "filename": "packages/next/src/client/app-next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,6 +1,7 @@\n // TODO-APP: hydration warning\n \n import './app-webpack'\n+import '../lib/require-instrumentation-client'\n import { appBootstrap } from './app-bootstrap'\n import { initializeDevBuildIndicatorForAppRouter } from './dev/dev-build-indicator/initialize-for-app-router'\n "
        },
        {
            "sha": "503b839dcaf91cbfbb29d1f21baebabb6b9cf5fe",
            "filename": "packages/next/src/client/app-next-turbopack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,5 +1,6 @@\n // TODO-APP: hydration warning\n \n+import '../lib/require-instrumentation-client'\n import { appBootstrap } from './app-bootstrap'\n \n window.next.version += '-turbo'"
        },
        {
            "sha": "0cac6dccba64a245f98b231527833a49c69bbc10",
            "filename": "packages/next/src/client/app-next.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,6 +1,7 @@\n // This import must go first because it needs to patch webpack chunk loading\n // before React patches chunk loading.\n import './app-webpack'\n+import '../lib/require-instrumentation-client'\n import { appBootstrap } from './app-bootstrap'\n \n appBootstrap(() => {"
        },
        {
            "sha": "09663b82118c39a20334dfc8a013417cffd4ac60",
            "filename": "packages/next/src/client/index.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Findex.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -55,6 +55,7 @@ declare global {\n   interface Window {\n     /* test fns */\n     __NEXT_HYDRATED?: boolean\n+    __NEXT_HYDRATED_AT?: number\n     __NEXT_HYDRATED_CB?: () => void\n \n     /* prod */\n@@ -612,6 +613,7 @@ function Root({\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n     React.useEffect(() => {\n       window.__NEXT_HYDRATED = true\n+      window.__NEXT_HYDRATED_AT = performance.now()\n \n       if (window.__NEXT_HYDRATED_CB) {\n         window.__NEXT_HYDRATED_CB()"
        },
        {
            "sha": "74fc400ea3cb17275574dc8f128046b32310c2bf",
            "filename": "packages/next/src/client/next-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fnext-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fnext-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fnext-turbopack.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,6 +1,8 @@\n // A client-side entry point for Turbopack builds. Includes logic to load chunks,\n // but does not include development-time features like hot module reloading.\n \n+import '../lib/require-instrumentation-client'\n+\n // TODO: Remove use of `any` type.\n import { initialize, version, router, emitter, hydrate } from './'\n // TODO: This seems necessary, but is a module in the `dev` directory."
        },
        {
            "sha": "5b38049bf0c497537df703dcce5d4a4d0b19a391",
            "filename": "packages/next/src/client/next.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fnext.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,4 +1,6 @@\n import './webpack'\n+import '../lib/require-instrumentation-client'\n+\n import { initialize, hydrate, version, router, emitter } from './'\n \n declare global {"
        },
        {
            "sha": "e13a9ed3412950849f1e3439e9dd9fa3049751bd",
            "filename": "packages/next/src/client/page-bootstrap.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -1,3 +1,4 @@\n+import '../lib/require-instrumentation-client'\n import { hydrate, router } from './'\n import initOnDemandEntries from './dev/on-demand-entries-client'\n import { devBuildIndicator } from './dev/dev-build-indicator/internal/dev-build-indicator'"
        },
        {
            "sha": "b8e5eec5896fe760a0b88eccce02da048515bc24",
            "filename": "packages/next/src/lib/require-instrumentation-client.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * This module imports the client instrumentation hook from the project root.\n+ *\n+ * The `private-next-instrumentation-client` module is automatically aliased to\n+ * the `instrumentation-client.ts` file in the project root by webpack or turbopack.\n+ */\n+\n+if (process.env.__NEXT_EXPERIMENTAL_CLIENT_INSTRUMENTATION_HOOK) {\n+  require('private-next-instrumentation-client')\n+}"
        },
        {
            "sha": "27d46162d6fd89b074986b865a22502d91770bdd",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -455,6 +455,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n             buildTimeThresholdMs: z.number().int(),\n           })\n           .optional(),\n+        clientInstrumentationHook: z.boolean().optional(),\n       })\n       .optional(),\n     exportPathMap: z"
        },
        {
            "sha": "91920133420fd230898291f8f100ecaeb1f63e58",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -601,6 +601,15 @@ export interface ExperimentalConfig {\n      */\n     buildTimeThresholdMs: number\n   }\n+\n+  /**\n+   * Enables the client instrumentation hook.\n+   * Loads the instrumentation-client.ts file from the project root\n+   * and executes it on the client side before hydration.\n+   *\n+   * Note: Use with caution as this can negatively impact page loading performance.\n+   */\n+  clientInstrumentationHook?: boolean\n }\n \n export type ExportPathMap = {"
        },
        {
            "sha": "0669ae221cb449b7544b102c3de88f196e43a0fe",
            "filename": "test/e2e/instrumentation-client-hook/app-router/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "fb3b479d05870722917cc44ec624d7e6bdc25c50",
            "filename": "test/e2e/instrumentation-client-hook/app-router/app/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return <h1>App</h1>\n+}"
        },
        {
            "sha": "3497fb5e0a7212eea6d00dd1b4973335182eda99",
            "filename": "test/e2e/instrumentation-client-hook/app-router/instrumentation-client.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1 @@\n+;(window as any).__INSTRUMENTATION_CLIENT_EXECUTED_AT = performance.now()"
        },
        {
            "sha": "810aff4255c66e95fc6a54797a847b68c5e24927",
            "filename": "test/e2e/instrumentation-client-hook/app-router/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fnext.config.js?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    clientInstrumentationHook: true,\n+  },\n+}"
        },
        {
            "sha": "810aff4255c66e95fc6a54797a847b68c5e24927",
            "filename": "test/e2e/instrumentation-client-hook/app-with-src/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fnext.config.js?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    clientInstrumentationHook: true,\n+  },\n+}"
        },
        {
            "sha": "0669ae221cb449b7544b102c3de88f196e43a0fe",
            "filename": "test/e2e/instrumentation-client-hook/app-with-src/src/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Flayout.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,9 @@\n+import React from 'react'\n+\n+export default function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3663687fd9fb67db2888419284fc925b75d5e1f1",
            "filename": "test/e2e/instrumentation-client-hook/app-with-src/src/app/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Fapp%2Fpage.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return <h1>App with src folder</h1>\n+}"
        },
        {
            "sha": "3497fb5e0a7212eea6d00dd1b4973335182eda99",
            "filename": "test/e2e/instrumentation-client-hook/app-with-src/src/instrumentation-client.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-with-src%2Fsrc%2Finstrumentation-client.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1 @@\n+;(window as any).__INSTRUMENTATION_CLIENT_EXECUTED_AT = performance.now()"
        },
        {
            "sha": "8f076f3e1fe854dbd5d5a5c6a5bbbe314686792a",
            "filename": "test/e2e/instrumentation-client-hook/instrumentation-client-hook.test.ts",
            "status": "added",
            "additions": 95,
            "deletions": 0,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,95 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+import path from 'path'\n+\n+describe('Instrumentation Client Hook', () => {\n+  const testCases = [\n+    {\n+      name: 'With src folder',\n+      appDir: 'app-with-src',\n+    },\n+    {\n+      name: 'App Router',\n+      appDir: 'app-router',\n+    },\n+    {\n+      name: 'Pages Router',\n+      appDir: 'pages-router',\n+    },\n+  ]\n+\n+  testCases.forEach(({ name, appDir }) => {\n+    describe(name, () => {\n+      const { next } = nextTestSetup({\n+        files: path.join(__dirname, appDir),\n+      })\n+\n+      it(`should execute instrumentation-client from ${name.toLowerCase()} before hydration`, async () => {\n+        const browser = await next.browser('/')\n+\n+        const instrumentationTime = await browser.eval(\n+          `window.__INSTRUMENTATION_CLIENT_EXECUTED_AT`\n+        )\n+        const hydrationTime = await browser.eval(`window.__NEXT_HYDRATED_AT`)\n+\n+        expect(instrumentationTime).toBeDefined()\n+        expect(hydrationTime).toBeDefined()\n+        expect(instrumentationTime).toBeLessThan(hydrationTime)\n+      })\n+    })\n+  })\n+\n+  describe('HMR in development mode', () => {\n+    const { next, isNextDev } = nextTestSetup({\n+      files: path.join(__dirname, 'app-router'),\n+    })\n+\n+    if (isNextDev) {\n+      it('should reload instrumentation-client when modified', async () => {\n+        const browser = await next.browser('/')\n+        const initialTime = await browser.eval(\n+          `window.__INSTRUMENTATION_CLIENT_EXECUTED_AT`\n+        )\n+        expect(initialTime).toBeDefined()\n+\n+        // Modify the instrumentation-client.ts file\n+        const instrumentationPath = 'instrumentation-client.ts'\n+\n+        const originalContent = await next.readFile(instrumentationPath)\n+\n+        await next.patchFile(\n+          instrumentationPath,\n+          `\n+          window.__INSTRUMENTATION_CLIENT_EXECUTED_AT = Date.now();\n+          window.__INSTRUMENTATION_CLIENT_UPDATED = true;\n+          `\n+        )\n+\n+        await retry(async () => {\n+          // Check if the updated instrumentation client was executed\n+          const updatedFlag = await browser.eval(\n+            `window.__INSTRUMENTATION_CLIENT_UPDATED`\n+          )\n+          expect(updatedFlag).toBe(true)\n+\n+          // Verify new execution time\n+          const newTime = await browser.eval(\n+            `window.__INSTRUMENTATION_CLIENT_EXECUTED_AT`\n+          )\n+          expect(newTime).toBeDefined()\n+          expect(newTime).toBeGreaterThan(initialTime)\n+        })\n+\n+        // Restore the original file\n+        await next.patchFile(instrumentationPath, originalContent)\n+      })\n+    } else {\n+      // Add a dummy test when not in dev mode\n+      it('skips tests in non-dev mode', () => {\n+        console.log(\n+          'Skipping instrumentation-client-hook tests in non-dev mode'\n+        )\n+      })\n+    }\n+  })\n+})"
        },
        {
            "sha": "3497fb5e0a7212eea6d00dd1b4973335182eda99",
            "filename": "test/e2e/instrumentation-client-hook/pages-router/instrumentation-client.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Finstrumentation-client.ts?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1 @@\n+;(window as any).__INSTRUMENTATION_CLIENT_EXECUTED_AT = performance.now()"
        },
        {
            "sha": "810aff4255c66e95fc6a54797a847b68c5e24927",
            "filename": "test/e2e/instrumentation-client-hook/pages-router/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fnext.config.js?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    clientInstrumentationHook: true,\n+  },\n+}"
        },
        {
            "sha": "22349f22fb722626233e37435756253131e9c301",
            "filename": "test/e2e/instrumentation-client-hook/pages-router/pages/index.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7de4c0728ba8c09d27e1d681026e9e868361f773/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fpages-router%2Fpages%2Findex.tsx?ref=7de4c0728ba8c09d27e1d681026e9e868361f773",
            "patch": "@@ -0,0 +1,5 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return <h1>Pages Router</h1>\n+}"
        }
    ],
    "stats": {
        "total": 214,
        "additions": 214,
        "deletions": 0
    }
}