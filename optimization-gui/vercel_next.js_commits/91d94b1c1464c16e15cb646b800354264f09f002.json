{
    "author": "kdy1",
    "message": "fix(turbopack): Fix the span of a magic comment (#76939)\n\n### What?\n\nFix the span of the turbopack tree shaking magic comment.\n\n### Why?\n\nPreviously it was printed on strange position.\n\n### How?\n\nCloses NAR-91\n\nCloses PACK-4087",
    "sha": "91d94b1c1464c16e15cb646b800354264f09f002",
    "files": [
        {
            "sha": "169835ebdc43cf2533401410c18d3e59feec02fc",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 30,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=91d94b1c1464c16e15cb646b800354264f09f002",
            "patch": "@@ -438,19 +438,15 @@ impl<C: Comments> ServerActions<C> {\n             .push((action_name.clone(), action_id.clone()));\n \n         let register_action_expr = bind_args_to_ref_expr(\n-            annotate_ident_as_server_reference(\n-                action_ident.clone(),\n-                action_id.clone(),\n-                arrow.span,\n-                &self.comments,\n-            ),\n+            annotate_ident_as_server_reference(action_ident.clone(), action_id.clone(), arrow.span),\n             ids_from_closure\n                 .iter()\n                 .cloned()\n                 .map(|id| Some(id.as_arg()))\n                 .collect(),\n             action_id.clone(),\n         );\n+        add_turbopack_disable_export_merging_comment(action_ident.span, &self.comments);\n \n         if let BlockStmtOrExpr::BlockStmt(block) = &mut *arrow.body {\n             block.visit_mut_with(&mut ClosureReplacer {\n@@ -573,7 +569,11 @@ impl<C: Comments> ServerActions<C> {\n         new_params.append(&mut function.params);\n \n         let action_name: Atom = self.gen_action_ident();\n-        let action_ident = Ident::new(action_name.clone(), function.span, self.private_ctxt);\n+        let mut action_ident = Ident::new(action_name.clone(), function.span, self.private_ctxt);\n+        if action_ident.span.lo == self.start_pos {\n+            action_ident.span = Span::dummy_with_cmt();\n+        }\n+\n         let action_id = self.generate_server_reference_id(&action_name, false, Some(&new_params));\n \n         self.has_action = true;\n@@ -585,7 +585,6 @@ impl<C: Comments> ServerActions<C> {\n                 action_ident.clone(),\n                 action_id.clone(),\n                 function.span,\n-                &self.comments,\n             ),\n             ids_from_closure\n                 .iter()\n@@ -594,6 +593,7 @@ impl<C: Comments> ServerActions<C> {\n                 .collect(),\n             action_id.clone(),\n         );\n+        add_turbopack_disable_export_merging_comment(action_ident.span, &self.comments);\n \n         function.body.visit_mut_with(&mut ClosureReplacer {\n             used_ids: &ids_from_closure,\n@@ -694,7 +694,7 @@ impl<C: Comments> ServerActions<C> {\n         }\n \n         let cache_name: Atom = self.gen_cache_ident();\n-        let cache_ident = private_ident!(cache_name.clone());\n+        let cache_ident = private_ident!(Span::dummy_with_cmt(), cache_name.clone());\n         let export_name: Atom = cache_name;\n \n         let reference_id = self.generate_server_reference_id(&export_name, true, Some(&new_params));\n@@ -769,8 +769,8 @@ impl<C: Comments> ServerActions<C> {\n             cache_ident.clone(),\n             reference_id.clone(),\n             arrow.span,\n-            &self.comments,\n         );\n+        add_turbopack_disable_export_merging_comment(cache_ident.span, &self.comments);\n \n         // If there're any bound args from the closure, we need to hoist the\n         // register action expression to the top-level, and return the bind\n@@ -829,7 +829,7 @@ impl<C: Comments> ServerActions<C> {\n         }\n \n         let cache_name: Atom = self.gen_cache_ident();\n-        let cache_ident = private_ident!(cache_name.clone());\n+        let cache_ident = private_ident!(Span::dummy_with_cmt(), cache_name.clone());\n \n         let reference_id = self.generate_server_reference_id(&cache_name, true, Some(&new_params));\n \n@@ -841,8 +841,8 @@ impl<C: Comments> ServerActions<C> {\n             cache_ident.clone(),\n             reference_id.clone(),\n             function.span,\n-            &self.comments,\n         );\n+        add_turbopack_disable_export_merging_comment(cache_ident.span, &self.comments);\n \n         function.body.visit_mut_with(&mut ClosureReplacer {\n             used_ids: &ids_from_closure,\n@@ -1941,9 +1941,9 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                             ident.clone(),\n                             ref_id.clone(),\n                             ident.span,\n-                            &self.comments,\n                         )),\n                     }));\n+                    add_turbopack_disable_export_merging_comment(ident.span, &self.comments);\n                 }\n             }\n \n@@ -2328,23 +2328,7 @@ fn assign_arrow_expr(ident: &Ident, expr: Expr) -> Expr {\n     }\n }\n \n-fn annotate_ident_as_server_reference(\n-    ident: Ident,\n-    action_id: Atom,\n-    original_span: Span,\n-    comments: &dyn Comments,\n-) -> Expr {\n-    if !original_span.lo.is_dummy() {\n-        comments.add_leading(\n-            original_span.lo,\n-            Comment {\n-                kind: CommentKind::Block,\n-                span: original_span,\n-                text: \"#__TURBOPACK_DISABLE_EXPORT_MERGING__\".into(),\n-            },\n-        );\n-    }\n-\n+fn annotate_ident_as_server_reference(ident: Ident, action_id: Atom, original_span: Span) -> Expr {\n     // registerServerReference(reference, id, null)\n     Expr::Call(CallExpr {\n         span: original_span,\n@@ -2367,6 +2351,17 @@ fn annotate_ident_as_server_reference(\n     })\n }\n \n+fn add_turbopack_disable_export_merging_comment(span: Span, comments: &dyn Comments) {\n+    comments.add_leading(\n+        span.lo,\n+        Comment {\n+            kind: CommentKind::Block,\n+            span: DUMMY_SP,\n+            text: \"#__TURBOPACK_DISABLE_EXPORT_MERGING__\".into(),\n+        },\n+    );\n+}\n+\n fn bind_args_to_ref_expr(expr: Expr, bound: Vec<Option<ExprOrSpread>>, action_id: Atom) -> Expr {\n     if bound.is_empty() {\n         expr"
        },
        {
            "sha": "0b0c9f262a9de5571e80aee89c86956487d82faf",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/27/output.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F27%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F27%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F27%2Foutput.js?ref=91d94b1c1464c16e15cb646b800354264f09f002",
            "patch": "@@ -1,9 +1,9 @@\n // Rules here:\n // 1. Each exported function should still be exported, but as a reference `registerServerReference(...)`.\n // 2. Actual action functions should be renamed to `$$ACTION_...` and got exported.\n-/*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ /* __next_internal_action_entry_do_not_use__ {\"001c36b06e398c97abe5d5d7ae8c672bfddf4e1b91\":\"$$RSC_SERVER_ACTION_2\",\"006a88810ecce4a4e8b59d53b8327d7e98bbf251d7\":\"$$RSC_SERVER_ACTION_0\",\"0090b5db271335765a4b0eab01f044b381b5ebd5cd\":\"$$RSC_SERVER_ACTION_1\",\"009ed0cc47abc4e1c64320cf42b74ae60b58c40f00\":\"$$RSC_SERVER_ACTION_3\",\"00a9b2939c1f39073a6bed227fd20233064c8b7869\":\"$$RSC_SERVER_ACTION_4\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n+/* __next_internal_action_entry_do_not_use__ {\"001c36b06e398c97abe5d5d7ae8c672bfddf4e1b91\":\"$$RSC_SERVER_ACTION_2\",\"006a88810ecce4a4e8b59d53b8327d7e98bbf251d7\":\"$$RSC_SERVER_ACTION_0\",\"0090b5db271335765a4b0eab01f044b381b5ebd5cd\":\"$$RSC_SERVER_ACTION_1\",\"009ed0cc47abc4e1c64320cf42b74ae60b58c40f00\":\"$$RSC_SERVER_ACTION_3\",\"00a9b2939c1f39073a6bed227fd20233064c8b7869\":\"$$RSC_SERVER_ACTION_4\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n import { encryptActionBoundArgs, decryptActionBoundArgs } from \"private-next-rsc-action-encryption\";\n-export const $$RSC_SERVER_ACTION_0 = async function foo() {\n+export const /*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ $$RSC_SERVER_ACTION_0 = async function foo() {\n     console.log(1);\n };\n var foo = registerServerReference($$RSC_SERVER_ACTION_0, \"006a88810ecce4a4e8b59d53b8327d7e98bbf251d7\", null);"
        },
        {
            "sha": "1c243a36e0e9c12ca7b8d4368003052fd18d8e3e",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/46/output.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F46%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F46%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F46%2Foutput.js?ref=91d94b1c1464c16e15cb646b800354264f09f002",
            "patch": "@@ -1,9 +1,9 @@\n // This is for testing the \"information byte\" of Server Action / Cache IDs.\n // Should be 1 110000 0, which is \"e0\" in hex.\n-/*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ /* __next_internal_action_entry_do_not_use__ {\"6090b5db271335765a4b0eab01f044b381b5ebd5cd\":\"$$RSC_SERVER_ACTION_1\",\"7c9ed0cc47abc4e1c64320cf42b74ae60b58c40f00\":\"$$RSC_SERVER_ACTION_3\",\"7ea9b2939c1f39073a6bed227fd20233064c8b7869\":\"$$RSC_SERVER_ACTION_4\",\"e03128060c414d59f8552e4788b846c0d2b7f74743\":\"$$RSC_SERVER_CACHE_0\",\"ff471a5eb0be1c31686dd4ba938a80328b80b1615d\":\"$$RSC_SERVER_CACHE_5\",\"ff69348c79fce073bae2f70f139565a2fda1c74c74\":\"$$RSC_SERVER_CACHE_2\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n+/* __next_internal_action_entry_do_not_use__ {\"6090b5db271335765a4b0eab01f044b381b5ebd5cd\":\"$$RSC_SERVER_ACTION_1\",\"7c9ed0cc47abc4e1c64320cf42b74ae60b58c40f00\":\"$$RSC_SERVER_ACTION_3\",\"7ea9b2939c1f39073a6bed227fd20233064c8b7869\":\"$$RSC_SERVER_ACTION_4\",\"e03128060c414d59f8552e4788b846c0d2b7f74743\":\"$$RSC_SERVER_CACHE_0\",\"ff471a5eb0be1c31686dd4ba938a80328b80b1615d\":\"$$RSC_SERVER_CACHE_5\",\"ff69348c79fce073bae2f70f139565a2fda1c74c74\":\"$$RSC_SERVER_CACHE_2\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n import { encryptActionBoundArgs, decryptActionBoundArgs } from \"private-next-rsc-action-encryption\";\n import { cache as $$cache__ } from \"private-next-rsc-cache-wrapper\";\n-export var $$RSC_SERVER_CACHE_0 = $$cache__(\"default\", \"e03128060c414d59f8552e4788b846c0d2b7f74743\", 0, async function f1(a, b) {\n+export var /*#__TURBOPACK_DISABLE_EXPORT_MERGING__*/ $$RSC_SERVER_CACHE_0 = $$cache__(\"default\", \"e03128060c414d59f8552e4788b846c0d2b7f74743\", 0, async function f1(a, b) {\n     return [\n         a,\n         b"
        },
        {
            "sha": "6b4af9c731604d30649036bbe61b5e6b4183b38c",
            "filename": "crates/next-custom-transforms/tests/fixture/source-maps/server-graph/use-cache/1/output.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fsource-maps%2Fserver-graph%2Fuse-cache%2F1%2Foutput.map",
            "raw_url": "https://github.com/vercel/next.js/raw/91d94b1c1464c16e15cb646b800354264f09f002/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fsource-maps%2Fserver-graph%2Fuse-cache%2F1%2Foutput.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fsource-maps%2Fserver-graph%2Fuse-cache%2F1%2Foutput.map?ref=91d94b1c1464c16e15cb646b800354264f09f002",
            "patch": "@@ -1 +1 @@\n-{\"version\":3,\"sources\":[\"input.js\"],\"sourcesContent\":[\"'use cache'\\n\\nconst foo = async () => {\\n  'use cache'\\n}\\n\\nexport async function bar() {\\n  return foo()\\n}\\n\"],\"names\":[],\"mappings\":\";;;WAEY,uCACC,GADD,+GAEZ;;;;;AAFA,MAAM,MAAM;WAIL,uCACO,GADP,6FAAA,eAAe;IACpB,OAAO;AACT;;;;;AAFA,WAAsB,MAAf\"}\n+{\"version\":3,\"sources\":[\"input.js\"],\"sourcesContent\":[\"'use cache'\\n\\nconst foo = async () => {\\n  'use cache'\\n}\\n\\nexport async function bar() {\\n  return foo()\\n}\\n\"],\"names\":[],\"mappings\":\";;;WAEY,yJAEZ;;;;;AAFA,MAAM,MAAM;WAIL,uIAAA,eAAe;IACpB,OAAO;AACT;;;;;AAFA,WAAsB,MAAf\"}"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 30,
        "deletions": 35
    }
}