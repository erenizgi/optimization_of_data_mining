{
    "author": "sokra",
    "message": "Turbopack: lower level drop collectibles (#84895)\n\n### What?\n\nalso implement drop_collectibles on the CollectiblesSource to avoid an allocation",
    "sha": "d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
    "files": [
        {
            "sha": "4552073d799cb1ddd8646ad255bbe617f809382f",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -842,7 +842,7 @@ pub async fn get_global_information_for_endpoint(\n         get_global_information_for_endpoint_inner_operation(module_graph, is_single_page);\n     let result_vc = if !is_single_page {\n         let result_vc = result_op.resolve_strongly_consistent().await?;\n-        let _issues = result_op.take_collectibles::<Box<dyn Issue>>();\n+        result_op.drop_collectibles::<Box<dyn Issue>>();\n         *result_vc\n     } else {\n         result_op.connect()"
        },
        {
            "sha": "4056a1cf7e7f2c0b74f734d9a0783cb24f649f62",
            "filename": "crates/next-api/src/operation.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Foperation.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -37,7 +37,7 @@ async fn entrypoints_without_collectibles_operation(\n     entrypoints: OperationVc<Entrypoints>,\n ) -> Result<Vc<Entrypoints>> {\n     let _ = entrypoints.resolve_strongly_consistent().await?;\n-    let _ = entrypoints.take_collectibles::<Box<dyn Diagnostic>>();\n+    entrypoints.drop_collectibles::<Box<dyn Diagnostic>>();\n     entrypoints.drop_issues();\n     let _ = get_effects(entrypoints).await?;\n     Ok(entrypoints.connect())"
        },
        {
            "sha": "20a61ea63d3e614398c76789da157ada3eb9a618",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/collectibles.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fcollectibles.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fcollectibles.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fcollectibles.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -164,7 +164,7 @@ async fn my_collecting_function() -> Result<Vc<Thing>> {\n     let result_op = my_transitive_emitting_function(rcstr!(\"\"), rcstr!(\"\"));\n     let result_vc = result_op.connect();\n     result_vc.await?;\n-    result_op.take_collectibles::<Box<dyn ValueToString>>();\n+    result_op.drop_collectibles::<Box<dyn ValueToString>>();\n     Ok(result_vc)\n }\n "
        },
        {
            "sha": "4ad917f845945d26f0164e794fd1913c0a18203d",
            "filename": "turbopack/crates/turbo-tasks/src/collectibles.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcollectibles.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcollectibles.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcollectibles.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -4,6 +4,7 @@ use crate::{ResolvedVc, VcValueTrait};\n \n /// Implemented on `OperationVc` and `RawVc`.\n pub trait CollectiblesSource {\n+    fn drop_collectibles<T: VcValueTrait>(self);\n     fn take_collectibles<T: VcValueTrait>(self) -> AutoSet<ResolvedVc<T>>;\n     fn peek_collectibles<T: VcValueTrait>(self) -> AutoSet<ResolvedVc<T>>;\n }"
        },
        {
            "sha": "7a995445b32aa44c0a615f240feb94cd0e3d4cf8",
            "filename": "turbopack/crates/turbo-tasks/src/raw_vc.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -316,6 +316,18 @@ impl CollectiblesSource for RawVc {\n             .filter_map(|(raw, count)| (count > 0).then_some(raw.try_into().unwrap()))\n             .collect()\n     }\n+\n+    fn drop_collectibles<T: VcValueTrait + ?Sized>(self) {\n+        let RawVc::TaskOutput(task_id) = self else {\n+            panic!(\n+                \"<RawVc as CollectiblesSource>::drop_collectibles() must only be called on a \\\n+                 RawVc::TaskOutput\"\n+            );\n+        };\n+        let tt = turbo_tasks();\n+        let map = tt.read_task_collectibles(task_id, T::get_trait_type_id());\n+        tt.unemit_collectibles(T::get_trait_type_id(), &map);\n+    }\n }\n \n pub struct ReadRawVcFuture {"
        },
        {
            "sha": "f423f798278c4c676f05107b6322186d123c758b",
            "filename": "turbopack/crates/turbo-tasks/src/vc/operation.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Foperation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Foperation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Foperation.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -236,6 +236,10 @@ impl<T> CollectiblesSource for OperationVc<T>\n where\n     T: ?Sized,\n {\n+    fn drop_collectibles<Vt: VcValueTrait>(self) {\n+        self.node.node.drop_collectibles::<Vt>();\n+    }\n+\n     fn take_collectibles<Vt: VcValueTrait>(self) -> AutoSet<ResolvedVc<Vt>> {\n         self.node.node.take_collectibles()\n     }"
        },
        {
            "sha": "e536356899e4d07bebe9d0106a12519ee3bd1ba6",
            "filename": "turbopack/crates/turbopack-core/src/issue/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -840,7 +840,7 @@ where\n     }\n \n     fn drop_issues(self) {\n-        let _ = self.take_collectibles::<Box<dyn Issue>>();\n+        self.drop_collectibles::<Box<dyn Issue>>();\n     }\n }\n "
        },
        {
            "sha": "48f454a3f25a193380fc2962e69e476b2504b6dc",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d0ffcfcb3774731d1baef017c0c329ef2d1d6c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=d0ffcfcb3774731d1baef017c0c329ef2d1d6c89",
            "patch": "@@ -1093,7 +1093,7 @@ impl ModuleGraph {\n         async move {\n             let result_op = compute_async_module_info(self.to_resolved().await?);\n             let result_vc = result_op.resolve_strongly_consistent().await?;\n-            let _issues = result_op.take_collectibles::<Box<dyn Issue>>();\n+            result_op.drop_collectibles::<Box<dyn Issue>>();\n             anyhow::Ok(*result_vc)\n         }\n         .instrument(tracing::info_span!(\"compute async module info\"))"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 22,
        "deletions": 5
    }
}