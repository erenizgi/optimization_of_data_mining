{
    "author": "acdlite",
    "message": "Skip request if \"full\" prefetch is already pending (#86405)\n\nIf a navigation happens while a prefetch for a segment is still pending,\nwe intentionally don't wait for the prefetch to complete before sending\na navigation request, because we don't know yet whether the prefetch\nresponse will be complete or partial. So, we immediately send a new\nnavigation request for the data, even at the risk of some duplication,\nin order to avoid a waterfall.\n\nHowever, there is one case where it's safe to assume the prefetch\nresponse will be complete â€” when the prefetch is initiated via `<Link\nprefetch={true}>` (or, equivalently, the \"full\" option supported by\nrouter.prefetch()). In this case, the client explicitly instructs the\nserver not to omit any dynamic or runtime data. Therefore, it's OK to\nskip over it during the navigation request.",
    "sha": "bfa538723604fc0eb667f82fc041b2a366f408ba",
    "files": [
        {
            "sha": "bfee5ce19f756c55ae4ea43e889bbeb614eeba96",
            "filename": "packages/next/src/client/components/segment-cache/cache.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fcache.ts?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -241,7 +241,7 @@ export type PendingSegmentCacheEntry = SegmentCacheEntryShared & {\n   status: EntryStatus.Pending\n   rsc: null\n   loading: null\n-  isPartial: true\n+  isPartial: boolean\n   promise: null | PromiseWithResolvers<FulfilledSegmentCacheEntry | null>\n }\n \n@@ -847,6 +847,14 @@ export function upgradeToPendingSegment(\n   const pendingEntry: PendingSegmentCacheEntry = emptyEntry as any\n   pendingEntry.status = EntryStatus.Pending\n   pendingEntry.fetchStrategy = fetchStrategy\n+\n+  if (fetchStrategy === FetchStrategy.Full) {\n+    // We can assume the response will contain the full segment data. Set this\n+    // to false so we know it's OK to omit this segment from any navigation\n+    // requests that may happen while the data is still pending.\n+    pendingEntry.isPartial = false\n+  }\n+\n   // Set the version here, since this is right before the request is initiated.\n   // The next time the global cache version is incremented, the entry will\n   // effectively be evicted. This happens before initiating the request, rather"
        },
        {
            "sha": "c941d2badcf3f3d725c5b0eaa5f5d4765880ce08",
            "filename": "packages/next/src/client/components/segment-cache/navigation.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache%2Fnavigation.ts?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -444,10 +444,17 @@ function readRenderSnapshotFromCache(\n         loading = promiseForFulfilledEntry.then((entry) =>\n           entry !== null ? entry.loading : null\n         )\n-        // Since we don't know yet whether the segment is partial or fully\n-        // static, we must assume it's partial; we can't skip the\n-        // dynamic request.\n-        isPartial = true\n+        // Because the request is still pending, we typically don't know yet\n+        // whether the response will be partial. We shouldn't skip this segment\n+        // during the dynamic navigation request. Otherwise, we might need to\n+        // do yet another request to fill in the remaining data, creating\n+        // a waterfall.\n+        //\n+        // The one exception is if this segment is being fetched with via\n+        // prefetch={true} (i.e. the \"force stale\" or \"full\" strategy). If so,\n+        // we can assume the response will be full. This field is set to `false`\n+        // for such segments.\n+        isPartial = segmentEntry.isPartial\n         break\n       }\n       case EntryStatus.Empty:\n@@ -508,7 +515,7 @@ function readHeadSnapshotFromCache(\n         rsc = promiseForFulfilledEntry.then((entry) =>\n           entry !== null ? entry.rsc : null\n         )\n-        isPartial = true\n+        isPartial = segmentEntry.isPartial\n         break\n       }\n       case EntryStatus.Empty:"
        },
        {
            "sha": "990c798b5213d44f472d2ba930a03fc3ecca1084",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/app/dynamic/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fdynamic%2Fpage.tsx?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,15 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+async function PageContent() {\n+  await connection()\n+  return <div id=\"dynamic-page-content\">Dynamic page content</div>\n+}\n+\n+export default async function Page() {\n+  return (\n+    <Suspense fallback={<div>Loading...</div>}>\n+      <PageContent />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Flayout.tsx?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7fdcafe0eec2d35de2262c8d40fd9effee0a7acc",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/app/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fapp%2Fpage.tsx?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,9 @@\n+import { LinkAccordion } from '../components/link-accordion'\n+\n+export default function Page() {\n+  return (\n+    <LinkAccordion href=\"/dynamic\" prefetch={true}>\n+      Dynamic page\n+    </LinkAccordion>\n+  )\n+}"
        },
        {
            "sha": "c6848d479aef8cacef3a5d226cd017eae08edf71",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/components/link-accordion.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fcomponents%2Flink-accordion.tsx?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,33 @@\n+'use client'\n+\n+import Link, { type LinkProps } from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({\n+  href,\n+  children,\n+  prefetch,\n+}: {\n+  href: string\n+  children: React.ReactNode\n+  prefetch?: LinkProps['prefetch']\n+}) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href} prefetch={prefetch}>\n+          {children}\n+        </Link>\n+      ) : (\n+        <>{children} (link is hidden)</>\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "447516b69f5fd493d990247cd4567b385c0eddc9",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/force-stale.test.ts",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fforce-stale.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fforce-stale.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fforce-stale.test.ts?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,57 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import type * as Playwright from 'playwright'\n+import { createRouterAct } from 'router-act'\n+\n+describe('force stale', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+  if (isNextDev) {\n+    test('prefetching is disabled in dev', () => {})\n+    return\n+  }\n+\n+  it(\n+    'during a navigation, don\\'t request segments that have a pending \"full\" ' +\n+      'prefetch already in progress',\n+    async () => {\n+      let act: ReturnType<typeof createRouterAct>\n+      const browser = await next.browser('/', {\n+        beforePageLoad(p: Playwright.Page) {\n+          act = createRouterAct(p)\n+        },\n+      })\n+\n+      await act(\n+        async () => {\n+          // Reveal a link to a dynamic page. The Link has prefetch={true}, so the\n+          // full page data is prefetched, including dynamic content.\n+          const toggleLinkVisibility = await browser.elementByCss(\n+            'input[data-link-accordion=\"/dynamic\"]'\n+          )\n+          await act(async () => await toggleLinkVisibility.click(), {\n+            includes: 'Dynamic page content',\n+            // Block the data from loading into the client so we can test what\n+            // happens if we request the same segment again during a navigation.\n+            block: true,\n+          })\n+\n+          // Initiate a navigation to the dynamic page. Even though the dynamic\n+          // content from the prefetch hasn't loaded yet, the router should not\n+          // request the same segment again, because it knows the data it\n+          // receives from the prefetch will be complete. This assumption is\n+          // _only_ correct for \"full\" prefetches, because we explicitly instruct\n+          // the server not to omit any dynamic or runtime data.\n+          const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n+          await link.click()\n+        },\n+        // There should have been no additional requests upon navigation\n+        'no-requests'\n+      )\n+\n+      // The data succesfully streams in.\n+      const content = await browser.elementById('dynamic-page-content')\n+      expect(await content.text()).toBe('Dynamic page content')\n+    }\n+  )\n+})"
        },
        {
            "sha": "e64bae22d658030ef118a8b53c925258ae17563f",
            "filename": "test/e2e/app-dir/segment-cache/force-stale/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fforce-stale%2Fnext.config.js?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -0,0 +1,8 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  cacheComponents: true,\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "204890c917c90c7c33bf4d876519fa0275e13763",
            "filename": "test/lib/router-act.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Flib%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bfa538723604fc0eb667f82fc041b2a366f408ba/test%2Flib%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Frouter-act.ts?ref=bfa538723604fc0eb667f82fc041b2a366f408ba",
            "patch": "@@ -77,7 +77,29 @@ export function createRouterAct(\n     for (let attempt = 0; attempt < maxRetries; attempt++) {\n       try {\n         await page.evaluate(\n-          () => new Promise<void>((res) => requestIdleCallback(() => res()))\n+          () =>\n+            new Promise<void>((res) =>\n+              requestIdleCallback(() => res(), {\n+                // Add a timeout option to prevents the callback from being\n+                // backgrounded indefinitely. Not sure why this happens but\n+                // without it, the callback will never fire.\n+                //\n+                // Note that this does not delay the callback from firing.\n+                // It should still fire pretty much \"immediately\". It's just a\n+                // safeguard in case the idle callback queue is not fired within\n+                // a reasonable amount of time. It really shouldn't\n+                // be necessary.\n+                //\n+                // TODO: I'm getting increasingly frustrated by how flaky\n+                // Playwright's APIs are. At this point I'm convinced we should\n+                // rewrite the whole router-act module to an equivalent\n+                // implementation that runs directly in the browser, by\n+                // injecting a script into the page. Since we only use it for\n+                // our own contrived e2e test apps, we can just import the\n+                // script into each test app that needs it.\n+                timeout: 100,\n+              })\n+            )\n         )\n         return\n       } catch (err) {"
        }
    ],
    "stats": {
        "total": 184,
        "additions": 177,
        "deletions": 7
    }
}