{
    "author": "kdy1",
    "message": "Revert \"Fix false-positive `\"use cache\"` misplacement error\" (#79160)\n\nReverts vercel/next.js#79151\n\nIt caused a regression like this\n```\nexport type Foo =\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nOnly async functions are allowed to be exported in a \"use server\" file.\n```",
    "sha": "de89c8cd0126fa237f21d42ca2eec2a8025a3260",
    "files": [
        {
            "sha": "1b9cdf1f549d4d9d6879abd8170e081ac13ea345",
            "filename": "crates/next-core/src/next_shared/transforms/server_actions.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/de89c8cd0126fa237f21d42ca2eec2a8025a3260/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/de89c8cd0126fa237f21d42ca2eec2a8025a3260/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs?ref=de89c8cd0126fa237f21d42ca2eec2a8025a3260",
            "patch": "@@ -40,8 +40,8 @@ pub async fn get_server_actions_transform_rule(\n     Ok(ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![transformer]),\n-            append: ResolvedVc::cell(vec![]),\n+            prepend: ResolvedVc::cell(vec![]),\n+            append: ResolvedVc::cell(vec![transformer]),\n         }],\n     ))\n }"
        },
        {
            "sha": "4d3d72499d1ff068ff570ee5c786ed9e90d1a0e2",
            "filename": "test/development/app-dir/use-cache-errors/app/client-module.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,5 +0,0 @@\n-'use client'\n-\n-export function useStuff() {\n-  return 'stuff'\n-}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/development/app-dir/use-cache-errors/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,8 +0,0 @@\n-import { ReactNode } from 'react'\n-export default function Root({ children }: { children: ReactNode }) {\n-  return (\n-    <html>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "9cec2cbff9b2f3f953d43633891b68bb3455ca40",
            "filename": "test/development/app-dir/use-cache-errors/app/module-with-use-cache.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,17 +0,0 @@\n-'use cache'\n-\n-// This file simulates adding a \"use cache\" directive to a client module that's\n-// mistaken as a server module. It does not have itself a \"use client\"\n-// directive, but is imported by a client module with a \"use client\" directive,\n-// while also importing another client module with a \"use client\" directive.\n-// Adding the \"use cache\" directive here, effectively forces the module to be a\n-// server module, which then results in an error when trying to call the client\n-// function.\n-\n-import { useStuff } from './client-module'\n-\n-export async function useCachedStuff() {\n-  // Intentional misusage (using hooks in async functions).\n-  // eslint-disable-next-line react-hooks/rules-of-hooks\n-  return useStuff()\n-}"
        },
        {
            "sha": "fff7bc3cbc841d480c2228251e9d75a6aa37258b",
            "filename": "test/development/app-dir/use-cache-errors/app/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 23,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,23 +0,0 @@\n-'use client'\n-\n-import { useActionState } from 'react'\n-import { useCachedStuff } from './module-with-use-cache'\n-\n-function OtherClientComponent({\n-  getCachedStuff,\n-}: {\n-  getCachedStuff: () => Promise<string>\n-}) {\n-  const [result, formAction] = useActionState(getCachedStuff, null)\n-\n-  return (\n-    <form action={formAction}>\n-      <button id=\"action-button\">Submit</button>\n-      <p>{result}</p>\n-    </form>\n-  )\n-}\n-\n-export default function Page() {\n-  return <OtherClientComponent getCachedStuff={useCachedStuff} />\n-}"
        },
        {
            "sha": "b236fa0c14150c1afe9b69ecaaf0176a12c249ac",
            "filename": "test/development/app-dir/use-cache-errors/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,10 +0,0 @@\n-/**\n- * @type {import('next').NextConfig}\n- */\n-const nextConfig = {\n-  experimental: {\n-    useCache: true,\n-  },\n-}\n-\n-module.exports = nextConfig"
        },
        {
            "sha": "7c513f3f72347f792a0117523d0bb319aee7ee42",
            "filename": "test/development/app-dir/use-cache-errors/use-cache-errors.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 56,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,56 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { assertNoRedbox } from '../../../lib/next-test-utils'\n-\n-describe('use-cache-errors', () => {\n-  const { next, isTurbopack } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  it('should not show a false-positive compiler error about a misplaced \"use cache\" directive', async () => {\n-    // This is a regression test to ensure that an injected React Refresh\n-    // statement (`var _s = __turbopack_context__.k.signature`) does not\n-    // interfere with our \"use cache\" directive misplacement detection.\n-    const browser = await next.browser('/')\n-    await assertNoRedbox(browser)\n-  })\n-\n-  it('should show a runtime error when calling the incorrectly used cache function', async () => {\n-    const browser = await next.browser('/')\n-    await browser.elementById('action-button').click()\n-\n-    if (isTurbopack) {\n-      // TODO(veil): The wrong stack frame is used for the source snippet.\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n-         \"environmentLabel\": \"Cache\",\n-         \"label\": \"Runtime Error\",\n-         \"source\": \"app/page.tsx (22:10) @ Page\n-       > 22 |   return <OtherClientComponent getCachedStuff={useCachedStuff} />\n-            |          ^\",\n-         \"stack\": [\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n-           \"Page app/page.tsx (22:10)\",\n-         ],\n-       }\n-      `)\n-    } else {\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n-         \"environmentLabel\": \"Cache\",\n-         \"label\": \"Runtime Error\",\n-         \"source\": \"app/module-with-use-cache.ts (16:18) @ useCachedStuff\n-       > 16 |   return useStuff()\n-            |                  ^\",\n-         \"stack\": [\n-           \"<FIXME-file-protocol>\",\n-           \"useCachedStuff app/module-with-use-cache.ts (16:18)\",\n-           \"Page app/page.tsx (22:10)\",\n-         ],\n-       }\n-      `)\n-    }\n-  })\n-})"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 2,
        "deletions": 121
    }
}