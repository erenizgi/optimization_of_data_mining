{
    "author": "ijjk",
    "message": "Fix validateTurboNextConfig running for next start (#86886)\n\nThis fixes `validateTurboNextConfig` running during `next start` which\nwas caught due to the wrong `phase` being provided to `workflows` config\nwrapper.\n\nWe shouldn't run extra validation during `next start` as this needs to\nboot as fast as possible and would have already been validated during\n`next build` or `next dev`.",
    "sha": "3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9",
    "files": [
        {
            "sha": "2f8d70ab4ea56f716f3c9f192cc6b7a99c3ad8a7",
            "filename": "packages/next/src/build/turbopack-analyze/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts?ref=3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9",
            "patch": "@@ -8,6 +8,7 @@ import { getSupportedBrowsers } from '../utils'\n import { normalizePath } from '../../lib/normalize-path'\n import type { NextConfigComplete } from '../../server/config-shared'\n import type { __ApiPreviewProps } from '../../server/api-utils'\n+import { PHASE_PRODUCTION_BUILD } from '../../api/constants'\n \n export type AnalyzeContext = {\n   config: NextConfigComplete\n@@ -25,7 +26,7 @@ export async function turbopackAnalyze(\n }> {\n   await validateTurboNextConfig({\n     dir: analyzeContext.dir,\n-    isDev: false,\n+    configPhase: PHASE_PRODUCTION_BUILD,\n   })\n \n   const { config, dir, distDir, noMangling } = analyzeContext"
        },
        {
            "sha": "ad8eea8858e3377d8f812df9245792a1adb26e6a",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9",
            "patch": "@@ -28,7 +28,7 @@ export async function turbopackBuild(): Promise<{\n }> {\n   await validateTurboNextConfig({\n     dir: NextBuildContext.dir!,\n-    isDev: false,\n+    configPhase: PHASE_PRODUCTION_BUILD,\n   })\n \n   const config = NextBuildContext.config!"
        },
        {
            "sha": "cfc26d10cbe3a1d3113a046db3822a20333712ab",
            "filename": "packages/next/src/lib/turbopack-warning.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts?ref=3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9",
            "patch": "@@ -1,10 +1,6 @@\n import type { NextConfigComplete } from '../server/config-shared'\n import loadConfig from '../server/config'\n import * as Log from '../build/output/log'\n-import {\n-  PHASE_DEVELOPMENT_SERVER,\n-  PHASE_PRODUCTION_BUILD,\n-} from '../shared/lib/constants'\n \n const unsupportedTurbopackNextConfigOptions = [\n   // Left to be implemented (priority)\n@@ -45,10 +41,10 @@ const unsupportedTurbopackNextConfigOptions = [\n /**  */\n export async function validateTurboNextConfig({\n   dir,\n-  isDev,\n+  configPhase,\n }: {\n   dir: string\n-  isDev?: boolean\n+  configPhase: Parameters<typeof loadConfig>[0]\n }) {\n   const { defaultConfig } =\n     require('../server/config-shared') as typeof import('../server/config-shared')\n@@ -65,16 +61,15 @@ export async function validateTurboNextConfig({\n   const unsupportedConfig: string[] = []\n   let rawNextConfig: NextConfigComplete = {} as NextConfigComplete\n \n-  const phase = isDev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD\n   try {\n     rawNextConfig = interopDefault(\n-      await loadConfig(phase, dir, {\n+      await loadConfig(configPhase, dir, {\n         rawConfig: true,\n       })\n     )\n \n     if (typeof rawNextConfig === 'function') {\n-      rawNextConfig = (rawNextConfig as any)(phase, {\n+      rawNextConfig = (rawNextConfig as any)(configPhase, {\n         defaultConfig,\n       })\n     }"
        },
        {
            "sha": "e7a80bb55b862877ced8e720d3f40430c4b6c004",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=3c2fc61bdb8e55eb8671b4152921b336bdf9ceb9",
            "patch": "@@ -25,7 +25,10 @@ import setupDebug from 'next/dist/compiled/debug'\n import { RESTART_EXIT_CODE } from './utils'\n import { formatHostname } from './format-hostname'\n import { initialize } from './router-server'\n-import { CONFIG_FILES } from '../../shared/lib/constants'\n+import {\n+  CONFIG_FILES,\n+  PHASE_DEVELOPMENT_SERVER,\n+} from '../../shared/lib/constants'\n import { getStartServerInfo, logStartInfo } from './app-info-log'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n import { type Span, trace, flushAllTraces } from '../../trace'\n@@ -473,10 +476,10 @@ export async function startServer(\n \n         Log.event(`Ready in ${formatDurationText}`)\n \n-        if (process.env.TURBOPACK) {\n+        if (process.env.TURBOPACK && isDev) {\n           await validateTurboNextConfig({\n             dir: serverOptions.dir,\n-            isDev: serverOptions.isDev,\n+            configPhase: PHASE_DEVELOPMENT_SERVER,\n           })\n         }\n       } catch (err) {"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 13,
        "deletions": 14
    }
}