{
    "author": "timneutkens",
    "message": "Turbopack build: Move Turbopack marker to SERVER_FILES_MANIFEST (#77711)\n\n### What?\n\nAs recommended by @ijjk.\n\nReplaces the `IS_TURBOPACK_BUILD_FILE` marker with a `turbopack` boolean\nproperty in the required server files manifest.\n\nWould like a review of this because it does mean we have to ship the\nrequire server files manifest into the standalone output which seemingly\ndid not happen before. If we'd want to avoid that the current approach\nof writing a small file is better.\n\n\n### How?\n\n- Added a `turbopack` boolean property to the\n`RequiredServerFilesManifest` interface\n- Removed the `IS_TURBOPACK_BUILD_FILE` constant and related file\noperations\n- Updated the server to check the manifest property instead of looking\nfor the marker file\n- Updated tests to verify the manifest property instead of the marker\nfile",
    "sha": "1bdc9721f1f9daadc1723f9712589776af933b0c",
    "files": [
        {
            "sha": "bc5f5939f859cbd066598c3bc89ffdb84e38a320",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=1bdc9721f1f9daadc1723f9712589776af933b0c",
            "patch": "@@ -81,7 +81,6 @@ import {\n   UNDERSCORE_NOT_FOUND_ROUTE,\n   DYNAMIC_CSS_MANIFEST,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n-  IS_TURBOPACK_BUILD_FILE,\n } from '../shared/lib/constants'\n import {\n   getSortedRoutes,\n@@ -1453,7 +1452,6 @@ export default async function build(\n       let shutdownPromise = Promise.resolve()\n       if (!isGenerateMode) {\n         if (turboNextBuild) {\n-          await writeFileUtf8(path.join(distDir, IS_TURBOPACK_BUILD_FILE), '')\n           const {\n             duration: compilerDuration,\n             shutdownPromise: p,\n@@ -2279,6 +2277,7 @@ export default async function build(\n \n                 // @ts-expect-error internal field TODO: fix this, should use a separate mechanism to pass the info.\n                 isExperimentalCompile: isCompileMode,\n+                isTurbopackBuild: turboNextBuild,\n               },\n             },\n             appDir: dir,\n@@ -2334,7 +2333,6 @@ export default async function build(\n                   ]\n                 : []),\n               BUILD_ID_FILE,\n-              turboNextBuild ? IS_TURBOPACK_BUILD_FILE : null,\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.js'),\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.json'),\n               ...instrumentationHookEntryFiles,"
        },
        {
            "sha": "3838afc4277c21b4e3bf101e133b0fd3332fc7b6",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=1bdc9721f1f9daadc1723f9712589776af933b0c",
            "patch": "@@ -42,7 +42,6 @@ import {\n   PHASE_PRODUCTION_BUILD,\n   UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   FUNCTIONS_CONFIG_MANIFEST,\n-  IS_TURBOPACK_BUILD_FILE,\n } from '../shared/lib/constants'\n import { findDir } from '../lib/find-pages-dir'\n import { NodeNextRequest, NodeNextResponse } from './base-http/node'\n@@ -193,9 +192,9 @@ export default class NextNodeServer extends BaseServer<\n     this.isDev = isDev\n     this.sriEnabled = Boolean(options.conf.experimental?.sri?.algorithm)\n \n-    const isTurbopackBuild = this.isTurbopackBuild()\n-\n-    if (!isDev) {\n+    // @ts-expect-error internal field not publicly exposed\n+    const isTurbopackBuild = this.nextConfig.experimental?.isTurbopackBuild\n+    if (!isDev && typeof isTurbopackBuild !== 'undefined') {\n       if (process.env.TURBOPACK && !isTurbopackBuild) {\n         throw new Error(\n           `Invariant: --turbopack is set but the build used Webpack`\n@@ -526,11 +525,6 @@ export default class NextNodeServer extends BaseServer<\n     }\n   }\n \n-  private isTurbopackBuild(): boolean {\n-    const isTurbopackBuildFile = join(this.distDir, IS_TURBOPACK_BUILD_FILE)\n-    return fs.existsSync(isTurbopackBuildFile)\n-  }\n-\n   protected getEnabledDirectories(dev: boolean): NextEnabledDirectories {\n     const dir = dev ? this.dir : this.serverDistDir\n "
        },
        {
            "sha": "62df59fa569ad709e7dba9fa35db0d063e45ac2c",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=1bdc9721f1f9daadc1723f9712589776af933b0c",
            "patch": "@@ -231,15 +231,18 @@ export class NextServer implements NextWrapperServer {\n     )\n \n     // check serialized build config when available\n-    if (process.env.NODE_ENV === 'production') {\n+    if (!this.options.dev) {\n       try {\n         const serializedConfig = require(\n-          path.join(dir, '.next', SERVER_FILES_MANIFEST)\n+          path.join(dir, config.distDir, SERVER_FILES_MANIFEST)\n         ).config\n \n         // @ts-expect-error internal field\n         config.experimental.isExperimentalCompile =\n           serializedConfig.experimental.isExperimentalCompile\n+        // @ts-expect-error internal field\n+        config.experimental.isTurbopackBuild =\n+          serializedConfig.experimental.isTurbopackBuild\n       } catch (_) {\n         // if distDir is customized we don't know until we\n         // load the config so fallback to loading the config"
        },
        {
            "sha": "82f1b064100c1c80f8a87d9002441b90ef8a3619",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bdc9721f1f9daadc1723f9712589776af933b0c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=1bdc9721f1f9daadc1723f9712589776af933b0c",
            "patch": "@@ -56,7 +56,6 @@ export const CONFIG_FILES = [\n   'next.config.ts',\n ]\n export const BUILD_ID_FILE = 'BUILD_ID'\n-export const IS_TURBOPACK_BUILD_FILE = 'IS_TURBOPACK_BUILD'\n export const BLOCKED_PAGES = ['/_document', '/_app', '/_error']\n export const CLIENT_PUBLIC_FILES_PATH = 'public'\n export const CLIENT_STATIC_FILES_PATH = 'static'"
        },
        {
            "sha": "9c5f2654984264f581f7ca73d80d4a84b3457cb6",
            "filename": "test/production/app-dir/turbopack-build-marker/turbopack-build-marker.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1bdc9721f1f9daadc1723f9712589776af933b0c/test%2Fproduction%2Fapp-dir%2Fturbopack-build-marker%2Fturbopack-build-marker.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1bdc9721f1f9daadc1723f9712589776af933b0c/test%2Fproduction%2Fapp-dir%2Fturbopack-build-marker%2Fturbopack-build-marker.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fturbopack-build-marker%2Fturbopack-build-marker.test.ts?ref=1bdc9721f1f9daadc1723f9712589776af933b0c",
            "patch": "@@ -5,8 +5,11 @@ describe('turbopack-build-marker', () => {\n   })\n \n   it('should have Turbopack build marker', async () => {\n-    expect(await next.hasFile('.next/IS_TURBOPACK_BUILD')).toBe(\n-      !!process.env.TURBOPACK\n+    const requiredServerFilesManifest = await next.readJSON(\n+      '.next/required-server-files.json'\n     )\n+    expect(\n+      requiredServerFilesManifest.config.experimental.isTurbopackBuild\n+    ).toBe(!!process.env.TURBOPACK)\n   })\n })"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 14,
        "deletions": 17
    }
}