{
    "author": "eps1lon",
    "message": "[build-sourcemaps] Sourcemap errors during prerender if `experimental.enablePrerenderSourceMaps` is enabled (#79109)",
    "sha": "854992f4d7ca576390c231c1ab97643b37dc44f6",
    "files": [
        {
            "sha": "babf8d42cd1998cee9b992ca63b4e0dd9f07dd04",
            "filename": ".changeset/swift-socks-find.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/.changeset%2Fswift-socks-find.md",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/.changeset%2Fswift-socks-find.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fswift-socks-find.md?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'next': patch\n+---\n+\n+Sourcemap errors during prerender if `experimental.enablePrerenderSourceMaps` is enabled"
        },
        {
            "sha": "8e73e892b2e4f3457b8da972bbdd23c19e5b95b2",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -757,6 +757,7 @@ export function createStaticWorker(\n       progress?.clear()\n     },\n     debuggerPortOffset,\n+    enableSourceMaps: config.experimental.enablePrerenderSourceMaps,\n     // remove --max-old-space-size flag as it can cause memory issues.\n     isolatedMemory: true,\n     enableWorkerThreads: config.experimental.workerThreads,"
        },
        {
            "sha": "c86784fb951c6ba857a8e5240d8127937c3f143e",
            "filename": "packages/next/src/lib/worker.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -43,6 +43,7 @@ export class Worker {\n        * `-1` if not inspectable\n        */\n       debuggerPortOffset: number\n+      enableSourceMaps?: boolean\n       /**\n        * True if `--max-old-space-size` should not be forwarded to the worker.\n        */\n@@ -57,6 +58,7 @@ export class Worker {\n     }\n   ) {\n     let {\n+      enableSourceMaps,\n       timeout,\n       onRestart,\n       logger = console,\n@@ -91,6 +93,10 @@ export class Worker {\n       }\n     }\n \n+    if (enableSourceMaps) {\n+      nodeOptions['enable-source-maps'] = true\n+    }\n+\n     if (isolatedMemory) {\n       delete nodeOptions['max-old-space-size']\n       delete nodeOptions['max_old_space_size']"
        },
        {
            "sha": "1ee2338f447a4ff25b4a7d825cad14a4b0afb526",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -463,6 +463,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         optimizeServerReact: z.boolean().optional(),\n         clientTraceMetadata: z.array(z.string()).optional(),\n         serverMinification: z.boolean().optional(),\n+        enablePrerenderSourceMaps: z.boolean().optional(),\n         serverSourceMaps: z.boolean().optional(),\n         useWasmBinary: z.boolean().optional(),\n         useLightningcss: z.boolean().optional(),"
        },
        {
            "sha": "06967882d35f2f748ac1161b74cbec4ef29d832a",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -559,6 +559,12 @@ export interface ExperimentalConfig {\n    */\n   serverMinification?: boolean\n \n+  /**\n+   * Enables source maps while generating static pages.\n+   * Helps with errors during the prerender phase in `next build`.\n+   */\n+  enablePrerenderSourceMaps?: boolean\n+\n   /**\n    * Enables source maps generation for the server production bundle.\n    */\n@@ -1299,6 +1305,7 @@ export const defaultConfig = {\n     appNavFailHandling: false,\n     prerenderEarlyExit: true,\n     serverMinification: true,\n+    enablePrerenderSourceMaps: false,\n     serverSourceMaps: false,\n     linkNoTouchStart: false,\n     caseSensitiveRoutes: false,"
        },
        {
            "sha": "bc29b4b429fae819ec6cc7f692d6e96716bdb2a2",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -5,6 +5,7 @@ const nextConfig = {\n   experimental: {\n     cpus: 1,\n     dynamicIO: true,\n+    enablePrerenderSourceMaps: true,\n     serverSourceMaps: true,\n   },\n   serverExternalPackages: ['external-pkg'],"
        },
        {
            "sha": "9e036b0292efd856782886f7cebfea142000dd3f",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/edge/next.config.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fedge%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fedge%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fedge%2Fnext.config.js?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -3,6 +3,8 @@\n  */\n const nextConfig = {\n   experimental: {\n+    cpus: 1,\n+    enablePrerenderSourceMaps: true,\n     serverSourceMaps: true,\n   },\n }"
        },
        {
            "sha": "61ec4cc12223adaddf702382705a6a5eab0ffdb4",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps-edge.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps-edge.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps-edge.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps-edge.test.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -42,7 +42,8 @@ describe('app-dir - server source maps edge runtime', () => {\n           '\\n}'\n       )\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      // Edge runtime pages are not prerendered during `next build`.\n+      // `next start` is not sourcemapped on purpose.\n     }\n   })\n \n@@ -71,7 +72,8 @@ describe('app-dir - server source maps edge runtime', () => {\n       )\n       expect(cliOutput).toMatch(/digest: '\\d+'/)\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      // Edge runtime pages are not prerendered during `next build`.\n+      // `next start` is not sourcemapped on purpose.\n     }\n   })\n \n@@ -99,7 +101,8 @@ describe('app-dir - server source maps edge runtime', () => {\n       )\n       expect(cliOutput).toMatch(/digest: '\\d+'/)\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      // Edge runtime pages are not prerendered during `next build`.\n+      // `next start` is not sourcemapped on purpose.\n     }\n   })\n })"
        },
        {
            "sha": "96dfabfa29d5eefa1c15fb05941c8d127498632b",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 93,
            "deletions": 18,
            "changes": 111,
            "blob_url": "https://github.com/vercel/next.js/blob/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/854992f4d7ca576390c231c1ab97643b37dc44f6/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=854992f4d7ca576390c231c1ab97643b37dc44f6",
            "patch": "@@ -25,10 +25,10 @@ describe('app-dir - server source maps', () => {\n   if (skipped) return\n \n   it('logged errors have a sourcemapped stack with a codeframe', async () => {\n-    const outputIndex = next.cliOutput.length\n-    await next.render('/rsc-error-log')\n-\n     if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      await next.render('/rsc-error-log')\n+\n       await retry(() => {\n         expect(next.cliOutput.slice(outputIndex)).toContain(\n           'Error: rsc-error-log'\n@@ -48,15 +48,28 @@ describe('app-dir - server source maps', () => {\n           '\\n'\n       )\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      if (isTurbopack) {\n+        // TODO(veil): Sourcemap names\n+        // TODO(veil): relative paths\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '(turbopack:///[project]/app/rsc-error-log/page.js:4:16)'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '' +\n+            \"\\n> 4 |   const error = new Error('rsc-error-log')\" +\n+            '\\n    |                ^'\n+        )\n+      } else {\n+        // TODO(veil): line/column numbers are flaky in Webpack\n+      }\n     }\n   })\n \n   it('logged errors have a sourcemapped `cause`', async () => {\n-    const outputIndex = next.cliOutput.length\n-    await next.render('/rsc-error-log-cause')\n-\n     if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      await next.render('/rsc-error-log-cause')\n+\n       await retry(() => {\n         expect(next.cliOutput.slice(outputIndex)).toContain(\n           'Error: rsc-error-log-cause'\n@@ -84,15 +97,36 @@ describe('app-dir - server source maps', () => {\n           '\\n'\n       )\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      if (isTurbopack) {\n+        // TODO(veil): Sourcemap names\n+        // TODO(veil): relative paths\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '(turbopack:///[project]/app/rsc-error-log-cause/page.js:2:16)'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '(turbopack:///[project]/app/rsc-error-log-cause/page.js:7:16)'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '' +\n+            \"\\n> 2 |   const error = new Error('rsc-error-log-cause', { cause })\" +\n+            '\\n    |                ^'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '' +\n+            \"\\n  >  7 |   const error = new Error('Boom')\" +\n+            '\\n       |                ^'\n+        )\n+      } else {\n+        // TODO(veil): line/column numbers are flaky in Webpack\n+      }\n     }\n   })\n \n   it('stack frames are ignore-listed in ssr', async () => {\n-    const outputIndex = next.cliOutput.length\n-    const browser = await next.browser('/ssr-error-log-ignore-listed')\n-\n     if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      const browser = await next.browser('/ssr-error-log-ignore-listed')\n+\n       await retry(() => {\n         expect(next.cliOutput.slice(outputIndex)).toContain(\n           'Error: ssr-error-log-ignore-listed'\n@@ -189,7 +223,19 @@ describe('app-dir - server source maps', () => {\n         `)\n       }\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      if (isTurbopack) {\n+        // TODO(veil): Sourcemapping line off\n+        // TODO(veil): Sourcemap names\n+        // TODO(veil): relative paths\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '(turbopack:///[project]/app/ssr-error-log-ignore-listed/page.js:24:2)'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '\\n> 24 |   })\\n     |  ^'\n+        )\n+      } else {\n+        // TODO(veil): line/column numbers are flaky in Webpack\n+      }\n     }\n   })\n \n@@ -242,15 +288,28 @@ describe('app-dir - server source maps', () => {\n               '\\n'\n       )\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      if (isTurbopack) {\n+        // TODO(veil): Sourcemap names\n+        // TODO(veil): relative paths\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          'at <unknown> (turbopack:///[project]/app/rsc-error-log-ignore-listed/page.js:8:16)'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '' +\n+            \"\\n>  8 |   const error = new Error('rsc-error-log-ignore-listed')\" +\n+            '\\n     |                ^'\n+        )\n+      } else {\n+        // TODO(veil): line/column numbers are flaky in Webpack\n+      }\n     }\n   })\n \n   it('thrown SSR errors', async () => {\n-    const outputIndex = next.cliOutput.length\n-    const browser = await next.browser('/ssr-throw')\n-\n     if (isNextDev) {\n+      const outputIndex = next.cliOutput.length\n+      const browser = await next.browser('/ssr-throw')\n+\n       await retry(() => {\n         expect(next.cliOutput.slice(outputIndex)).toContain('Error: ssr-throw')\n       })\n@@ -287,7 +346,7 @@ describe('app-dir - server source maps', () => {\n        }\n       `)\n     } else {\n-      // TODO: Test `next build` with `--enable-source-maps`.\n+      // SSR errors are not logged because React retries them during hydration.\n     }\n   })\n \n@@ -356,7 +415,23 @@ describe('app-dir - server source maps', () => {\n         ).toEqual(3)\n       }\n     } else {\n-      // TODO: test `next start` with `--enable-source-maps`\n+      if (isTurbopack) {\n+        // Expect the invalid sourcemap warning only once per render.\n+        expect(\n+          normalizeCliOutput(next.cliOutput).split('Invalid source map.')\n+            .length - 1\n+        ).toEqual(\n+          // >= 20\n+          // behavior in Node.js 20+ is intended\n+          process.versions.node.startsWith('18') ? 0 : 2\n+        )\n+      } else {\n+        // Webpack is silent about invalid sourcemaps for next build.\n+        expect(\n+          normalizeCliOutput(next.cliOutput).split('Invalid source map.')\n+            .length - 1\n+        ).toEqual(0)\n+      }\n     }\n   })\n })"
        }
    ],
    "stats": {
        "total": 143,
        "additions": 122,
        "deletions": 21
    }
}