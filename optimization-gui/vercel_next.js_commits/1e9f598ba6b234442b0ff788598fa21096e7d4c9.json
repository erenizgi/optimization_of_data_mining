{
    "author": "huozhi",
    "message": "[segment explorer] refactor boundary trigger with ui primitives (#81147)",
    "sha": "1e9f598ba6b234442b0ff788598fa21096e7d4c9",
    "files": [
        {
            "sha": "182f4ef0f86210adea9dcecb291b9b84d7b7d1c1",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-indicator/devtools-indicator.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fdevtools-indicator.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -52,7 +52,6 @@ export function DevToolsIndicator({\n           '--animate-out-duration-ms': `${MENU_DURATION_MS}ms`,\n           '--animate-out-timing-function': MENU_CURVE,\n           boxShadow: 'none',\n-          zIndex: 2147483647,\n           [vertical]: `${INDICATOR_PADDING}px`,\n           [horizontal]: `${INDICATOR_PADDING}px`,\n           visibility:"
        },
        {
            "sha": "ef621deb27f7c7521270d390ba37f54a409dc8b5",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -271,7 +271,6 @@ function DevToolsPopover({\n           '--animate-out-duration-ms': `${MENU_DURATION_MS}ms`,\n           '--animate-out-timing-function': MENU_CURVE,\n           boxShadow: 'none',\n-          zIndex: 2147483647,\n           [vertical]: `${INDICATOR_PADDING}px`,\n           [horizontal]: `${INDICATOR_PADDING}px`,\n         } as CSSProperties"
        },
        {
            "sha": "31380461eecb7d1436b4eda5e63a361b6af41391",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/dev-tools-info.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -97,7 +97,7 @@ export const DEV_TOOLS_INFO_STYLES = `\n     border-radius: var(--rounded-xl);\n     position: absolute;\n     font-family: var(--font-stack-sans);\n-    z-index: 1000;\n+    z-index: 3;\n     overflow: hidden;\n     opacity: 0;\n     outline: 0;"
        },
        {
            "sha": "05e54597e58ce21a17b3814b41d1ff2243ea1a9f",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/segments-explorer.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fsegments-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fsegments-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fsegments-explorer.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -22,6 +22,6 @@ export function SegmentsExplorer({\n \n export const SEGMENTS_EXPLORER_STYLES = `\n   [data-nextjs-segments-explorer] {\n-    margin: -12px -8px;\n+    margin: -16px;\n   }\n `"
        },
        {
            "sha": "dda31466b32ad176a5db5bc8191e1a2190103afb",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-boundary-trigger.tsx",
            "status": "modified",
            "additions": 75,
            "deletions": 138,
            "changes": 213,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -1,10 +1,5 @@\n-import {\n-  useCallback,\n-  useState,\n-  useRef,\n-  useLayoutEffect,\n-  useEffect,\n-} from 'react'\n+import { useCallback, useState, useRef } from 'react'\n+import { Menu } from '@base-ui-components/react/menu'\n import type { SegmentNodeState } from '../../../userspace/app/segment-explorer-node'\n \n export function SegmentBoundaryTrigger({\n@@ -14,81 +9,12 @@ export function SegmentBoundaryTrigger({\n   onSelectBoundary: SegmentNodeState['setBoundaryType']\n   offset: number\n }) {\n-  const [isOpen, setIsOpen] = useState(false)\n-  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, right: 0 })\n-  const triggerRef = useRef<HTMLButtonElement>(null)\n-  const rootRef = useRef<HTMLDivElement>(null)\n   const [shadowRoot] = useState<ShadowRoot>(() => {\n     const ownerDocument = document\n     const portalNode = ownerDocument.querySelector('nextjs-portal')!\n     return portalNode.shadowRoot! as ShadowRoot\n   })\n-\n-  const updateDropdownPosition = useCallback(() => {\n-    if (triggerRef.current) {\n-      const rect = triggerRef.current.getBoundingClientRect()\n-      setDropdownPosition({\n-        top: rect.bottom + offset,\n-        right: window.innerWidth - rect.right,\n-      })\n-    }\n-  }, [offset])\n-\n-  useLayoutEffect(() => {\n-    if (isOpen) {\n-      updateDropdownPosition()\n-    }\n-  }, [isOpen, updateDropdownPosition])\n-\n-  const handleClickOutside = useCallback(\n-    (e: Event) => {\n-      const target = e.target as HTMLElement\n-      if (!target || !isOpen) return\n-      if (\n-        target.closest(\n-          '[data-nextjs-dev-overlay-segment-boundary-dropdown-backdrop]'\n-        ) ||\n-        target.closest(\n-          '[data-nextjs-dev-overlay-segment-boundary-trigger-button]'\n-        )\n-      ) {\n-        return\n-      }\n-      setIsOpen(false)\n-    },\n-    [isOpen]\n-  )\n-\n-  // click outside of the trigger button or dropdown menu, in shadow root\n-  useEffect(() => {\n-    shadowRoot.addEventListener('click', handleClickOutside)\n-    return () => {\n-      shadowRoot.removeEventListener('click', handleClickOutside)\n-    }\n-  }, [handleClickOutside, isOpen, shadowRoot])\n-\n-  // close itself when unfocus: click outside of shadow root or clicking other triggers\n-  const handleFocusOut = useCallback((e: Event) => {\n-    const triggerRootNode = rootRef.current\n-    if (\n-      e.target instanceof HTMLElement &&\n-      triggerRootNode &&\n-      !triggerRootNode.contains(e.target)\n-    ) {\n-      setIsOpen(false)\n-    }\n-  }, [])\n-  useEffect(() => {\n-    shadowRoot.addEventListener('focusout', handleFocusOut)\n-    return () => {\n-      shadowRoot.removeEventListener('focusout', handleFocusOut)\n-    }\n-  }, [handleFocusOut, shadowRoot])\n-\n-  const handleToggleMenu = useCallback(() => {\n-    setIsOpen((prev) => !prev)\n-    updateDropdownPosition()\n-  }, [updateDropdownPosition])\n+  const shadowRootRef = useRef<ShadowRoot>(shadowRoot)\n \n   const triggerOptions = [\n     { label: 'Trigger Loading', value: 'loading', icon: <LoadingIcon /> },\n@@ -102,63 +28,72 @@ export function SegmentBoundaryTrigger({\n     icon: <ResetIcon />,\n   }\n \n-  const handleSelect = (value: string) => {\n-    if (value === 'not-found') {\n-      onSelectBoundary('not-found')\n-    } else if (value === 'loading') {\n-      onSelectBoundary('loading')\n-    } else if (value === 'error') {\n-      onSelectBoundary('error')\n-    } else if (value === 'reset') {\n-      onSelectBoundary(null)\n-    }\n-    setIsOpen(false)\n-  }\n+  const handleSelect = useCallback(\n+    (value: string) => {\n+      switch (value) {\n+        case 'not-found':\n+        case 'loading':\n+        case 'error':\n+          onSelectBoundary(value)\n+          break\n+        case 'reset':\n+          onSelectBoundary(null)\n+          break\n+        default:\n+          break\n+      }\n+    },\n+    [onSelectBoundary]\n+  )\n \n   return (\n-    <div className=\"segment-boundary-trigger\" ref={rootRef}>\n-      <button\n-        ref={triggerRef}\n-        className=\"segment-boundary-trigger-button\"\n-        data-nextjs-dev-overlay-segment-boundary-trigger-button\n-        onClick={handleToggleMenu}\n-        type=\"button\"\n-      >\n-        <DropdownIcon />\n-      </button>\n-      {isOpen && (\n-        <div\n-          className=\"segment-boundary-dropdown-backdrop\"\n-          data-nextjs-dev-overlay-segment-boundary-dropdown-backdrop\n-          style={{\n-            top: dropdownPosition.top - offset, // Extend upward to cover the gap\n-            right: dropdownPosition.right,\n-            paddingTop: offset, // Visual spacing while backdrop covers the gap\n-          }}\n-        >\n-          <div className=\"segment-boundary-dropdown\">\n-            {triggerOptions.map((option) => (\n-              <div\n-                key={option.value}\n+    <div className=\"segment-boundary-trigger\">\n+      <Menu.Root delay={0}>\n+        <Menu.Trigger\n+          className=\"segment-boundary-trigger-button\"\n+          data-nextjs-dev-overlay-segment-boundary-trigger-button\n+          render={(triggerProps) => (\n+            <button {...triggerProps} type=\"button\">\n+              <DropdownIcon />\n+            </button>\n+          )}\n+        />\n+\n+        {/* @ts-expect-error remove this expect-error once shadowRoot is supported as container */}\n+        <Menu.Portal container={shadowRootRef}>\n+          <Menu.Positioner\n+            className=\"segment-boundary-dropdown-positioner\"\n+            side=\"bottom\"\n+            align=\"center\"\n+            sideOffset={offset}\n+            arrowPadding={8}\n+          >\n+            <Menu.Popup className=\"segment-boundary-dropdown\">\n+              {triggerOptions.map((option) => (\n+                <Menu.Item\n+                  key={option.value}\n+                  className=\"segment-boundary-dropdown-item\"\n+                  onClick={() => handleSelect(option.value)}\n+                >\n+                  {option.icon}\n+                  {option.label}\n+                </Menu.Item>\n+              ))}\n+\n+              <div className=\"segment-boundary-dropdown-divider\" />\n+\n+              <Menu.Item\n+                key={resetOption.value}\n                 className=\"segment-boundary-dropdown-item\"\n-                onClick={() => handleSelect(option.value)}\n+                onClick={() => handleSelect(resetOption.value)}\n               >\n-                {option.icon}\n-                {option.label}\n-              </div>\n-            ))}\n-            <div className=\"segment-boundary-dropdown-divider\" />\n-            <div\n-              key={resetOption.value}\n-              className=\"segment-boundary-dropdown-item\"\n-              onClick={() => handleSelect(resetOption.value)}\n-            >\n-              {resetOption.icon}\n-              {resetOption.label}\n-            </div>\n-          </div>\n-        </div>\n-      )}\n+                {resetOption.icon}\n+                {resetOption.label}\n+              </Menu.Item>\n+            </Menu.Popup>\n+          </Menu.Positioner>\n+        </Menu.Portal>\n+      </Menu.Root>\n     </div>\n   )\n }\n@@ -284,8 +219,6 @@ function ResetIcon() {\n \n export const styles = `\n   .segment-boundary-trigger {\n-    position: relative;\n-    display: inline-flex;\n     margin-left: auto;\n     gap: 8px;\n   }\n@@ -299,23 +232,19 @@ export const styles = `\n     font-weight: 500;\n     color: var(--color-gray-1000);\n     border-radius: 6px;\n-  }\n-  .segment-boundary-trigger-button--reset {\n     background: transparent;\n     border: none;\n   }\n+\n   .segment-boundary-trigger-button svg {\n     width: 20px;\n     height: 20px;\n   }\n+\n   .segment-boundary-trigger-button:hover {\n     background: var(--color-gray-400);\n     color: var(--color-gray-1000);\n   }\n-  .segment-boundary-dropdown-backdrop {\n-    position: fixed;\n-    z-index: 3;\n-  }\n \n   .segment-boundary-dropdown {\n     padding: 8px;\n@@ -326,6 +255,10 @@ export const styles = `\n     min-width: 120px;\n   }\n \n+  .segment-boundary-dropdown-positioner {\n+    z-index: 2147483648;\n+  }\n+\n   .segment-boundary-dropdown-item {\n     display: flex;\n     align-items: center;\n@@ -335,6 +268,10 @@ export const styles = `\n     border-radius: 6px;\n     color: var(--color-gray-1000);\n     cursor: pointer;\n+    min-width: 220px;\n+    border: none;\n+    background: none;\n+    width: 100%;\n   }\n \n   .segment-boundary-dropdown-item svg {"
        },
        {
            "sha": "2e52cf7218a78701ea87113911b0efe9d2822fd1",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -205,14 +205,12 @@ function PageSegmentTreeLayerPresentation({\n                 </span>\n               )}\n               {/* TODO: only show triggers in dev panel remove this once the new panel UI is stable */}\n-              {process.env.__NEXT_DEVTOOL_NEW_PANEL_UI &&\n-                pageChild &&\n-                pageChild.value && (\n-                  <SegmentBoundaryTrigger\n-                    offset={6}\n-                    onSelectBoundary={pageChild.value.setBoundaryType}\n-                  />\n-                )}\n+              {pageChild && pageChild.value && (\n+                <SegmentBoundaryTrigger\n+                  offset={6}\n+                  onSelectBoundary={pageChild.value.setBoundaryType}\n+                />\n+              )}\n             </div>\n           </div>\n         </div>"
        },
        {
            "sha": "025cecfbf781cb1213499e06f1833c0dc793402b",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/toast/styles.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftoast%2Fstyles.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftoast%2Fstyles.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftoast%2Fstyles.ts?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -1,8 +1,8 @@\n const styles = `\n   .nextjs-toast {\n     position: fixed;\n+    z-index: 2147483647;\n     max-width: 420px;\n-    z-index: 9000;\n     box-shadow: 0px 16px 32px\n       rgba(0, 0, 0, 0.25);\n   }"
        },
        {
            "sha": "9b842b5b380ddd243ad8d59707318083755e259e",
            "filename": "test/development/app-dir/segment-explorer/app/parallel-routes/layout.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1e9f598ba6b234442b0ff788598fa21096e7d4c9/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/1e9f598ba6b234442b0ff788598fa21096e7d4c9/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2Fparallel-routes%2Flayout.tsx?ref=1e9f598ba6b234442b0ff788598fa21096e7d4c9",
            "patch": "@@ -1,10 +1,15 @@\n export default function Layout({ children, bar, foo }) {\n   return (\n-    <div>\n+    <main\n+      style={{\n+        backgroundColor: '#fff',\n+        zIndex: 300,\n+      }}\n+    >\n       <h1>Parallel Routes Layout</h1>\n       <div id=\"nested-children\">{children}</div>\n       <div id=\"foo-slot\">{foo}</div>\n       <div id=\"bar-slot\">{bar}</div>\n-    </div>\n+    </main>\n   )\n }"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 91,
        "deletions": 153
    }
}