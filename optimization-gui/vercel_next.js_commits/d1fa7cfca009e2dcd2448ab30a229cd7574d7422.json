{
    "author": "kdy1",
    "message": "refactor(turbopack): Do not use `Result` for `Rope#read` (#80004)\n\n### What?\r\n\r\nUse `Cow<'_, [u8]>` instead of `Result<Cow<'_, [u8]>>`. \r\n\r\n### Why?\r\n\r\n`RopeReader` never fails.",
    "sha": "d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
    "files": [
        {
            "sha": "992b32471622ce667a2c046eed9672821067304a",
            "filename": "crates/next-core/src/next_app/metadata/image.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -29,7 +29,7 @@ async fn hash_file_content(path: Vc<FileSystemPath>) -> Result<u64> {\n \n     Ok(match &*original_file_content {\n         FileContent::Content(content) => {\n-            let content = content.content().to_bytes()?;\n+            let content = content.content().to_bytes();\n             hash_xxh3_hash64(&*content)\n         }\n         FileContent::NotFound => {"
        },
        {
            "sha": "64187b6163b6950a8989a36cbf71f16dbc9725e4",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -117,7 +117,7 @@ async fn get_base64_file_content(path: Vc<FileSystemPath>) -> Result<String> {\n \n     Ok(match &*original_file_content {\n         FileContent::Content(content) => {\n-            let content = content.content().to_bytes()?;\n+            let content = content.content().to_bytes();\n             Base64Display::new(&content, &STANDARD).to_string()\n         }\n         FileContent::NotFound => {"
        },
        {
            "sha": "72d962927570ab0a077abc42ce567aa7e8f889ac",
            "filename": "crates/next-core/src/next_font/local/font_fallback.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Ffont_fallback.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Ffont_fallback.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Ffont_fallback.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -108,7 +108,7 @@ async fn get_font_adjustment(\n         FileContent::Content(file) => file.content(),\n     };\n \n-    let font_file_binary = font_file_rope.to_bytes()?;\n+    let font_file_binary = font_file_rope.to_bytes();\n     let scope = allsorts::binary::read::ReadScope::new(&font_file_binary);\n     let mut font = Font::new(scope.read::<FontData>()?.table_provider(0)?)?.context(format!(\n         \"Unable to read font metrics from font file at {}\","
        },
        {
            "sha": "1ba80bd8a85aa7a8f368f2d248475e12fc7fcd74",
            "filename": "crates/next-core/src/next_shared/transforms/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -101,7 +101,7 @@ pub async fn get_swc_ecma_transform_rule_impl(\n             };\n \n             Ok(Some((\n-                SwcPluginModule::new(name, file.content().to_bytes()?.to_vec()).resolved_cell(),\n+                SwcPluginModule::new(name, file.content().to_bytes().to_vec()).resolved_cell(),\n                 config.clone(),\n             )))\n         })"
        },
        {
            "sha": "09583a15bffcd3d58271b6fd6f0fefba6709fbb8",
            "filename": "turbopack/crates/turbo-tasks-fs/src/rope.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -114,7 +114,7 @@ impl Rope {\n     }\n \n     /// Returns a slice of all bytes\n-    pub fn to_bytes(&self) -> Result<Cow<'_, [u8]>> {\n+    pub fn to_bytes(&self) -> Cow<'_, [u8]> {\n         self.data.to_bytes(self.length)\n     }\n }\n@@ -362,8 +362,7 @@ impl Serialize for Rope {\n     /// deserialization won't deduplicate and share the Arcs (being the only\n     /// possible owner of a individual \"shared\" data doesn't make sense).\n     fn serialize<S: Serializer>(&self, serializer: S) -> Result<S::Ok, S::Error> {\n-        use serde::ser::Error;\n-        let bytes = self.to_bytes().map_err(Error::custom)?;\n+        let bytes = self.to_bytes();\n         match bytes {\n             Cow::Borrowed(b) => serde_bytes::Bytes::new(b).serialize(serializer),\n             Cow::Owned(b) => ByteBuf::from(b).serialize(serializer),\n@@ -523,16 +522,17 @@ impl InnerRope {\n     }\n \n     /// Returns a slice of all bytes.\n-    fn to_bytes(&self, len: usize) -> Result<Cow<'_, [u8]>> {\n+    fn to_bytes(&self, len: usize) -> Cow<'_, [u8]> {\n         match &self[..] {\n-            [] => Ok(Cow::Borrowed(EMPTY_BUF)),\n+            [] => Cow::Borrowed(EMPTY_BUF),\n             [Shared(inner)] => inner.to_bytes(len),\n-            [Local(bytes)] => Ok(Cow::Borrowed(bytes)),\n+            [Local(bytes)] => Cow::Borrowed(bytes),\n             _ => {\n                 let mut read = RopeReader::new(self, 0);\n                 let mut buf = Vec::with_capacity(len);\n-                read.read_to_end(&mut buf)?;\n-                Ok(Cow::Owned(buf))\n+                read.read_to_end(&mut buf)\n+                    .expect(\"rope reader should not fail\");\n+                buf.into()\n             }\n         }\n     }\n@@ -1045,7 +1045,7 @@ mod test {\n     #[test]\n     fn test_to_bytes() -> Result<()> {\n         let rope = Rope::from(\"abc\");\n-        assert_eq!(rope.to_bytes()?, Cow::Borrowed::<[u8]>(&[0x61, 0x62, 0x63]));\n+        assert_eq!(rope.to_bytes(), Cow::Borrowed::<[u8]>(&[0x61, 0x62, 0x63]));\n         Ok(())\n     }\n }"
        },
        {
            "sha": "48a7b45f5dedad1d5b6e87b24acdc85c1bc62e2b",
            "filename": "turbopack/crates/turbopack-image/src/process/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-image%2Fsrc%2Fprocess%2Fmod.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -347,7 +347,7 @@ pub async fn get_meta_data(\n     let FileContent::Content(content) = &*content.await? else {\n         bail!(\"Input image not found\");\n     };\n-    let bytes = content.content().to_bytes()?;\n+    let bytes = content.content().to_bytes();\n     let path_resolved = ident.path().to_resolved().await?;\n     let path = path_resolved.await?;\n     let extension = path.extension_ref();\n@@ -430,7 +430,7 @@ pub async fn optimize(\n     let FileContent::Content(content) = &*content.await? else {\n         return Ok(FileContent::NotFound.cell());\n     };\n-    let bytes = content.content().to_bytes()?;\n+    let bytes = content.content().to_bytes();\n     let path = ident.path().to_resolved().await?;\n \n     let Some((image, format)) = load_image(path, &bytes, ident.path().await?.extension_ref())"
        },
        {
            "sha": "31dece53d5f54ffd154a03e68140cc609e21c239",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -230,7 +230,7 @@ impl WebpackLoadersProcessedAsset {\n                 \"binary\".to_string(),\n                 JsonValue::from(\n                     base64::engine::general_purpose::STANDARD\n-                        .encode(file_content.content().to_bytes().unwrap()),\n+                        .encode(file_content.content().to_bytes()),\n                 ),\n             )))),\n         };"
        },
        {
            "sha": "cca2e4f23debf8983a194df3c4fa5d15fcdf600b",
            "filename": "turbopack/crates/turbopack-wasm/src/analysis.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fanalysis.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fanalysis.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fanalysis.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -29,7 +29,7 @@ pub(crate) async fn analyze(source: Vc<WebAssemblySource>) -> Result<Vc<WebAssem\n         return Ok(analysis.cell());\n     };\n \n-    let mut bytes = &*file.content().to_bytes()?;\n+    let mut bytes = &*file.content().to_bytes();\n \n     let mut parser = Parser::new(0);\n     loop {"
        },
        {
            "sha": "6bc2ccedb02a35235a4bc310aa8d393e981144b7",
            "filename": "turbopack/crates/turbopack-wasm/src/source.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fsource.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1fa7cfca009e2dcd2448ab30a229cd7574d7422/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fsource.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fsource.rs?ref=d1fa7cfca009e2dcd2448ab30a229cd7574d7422",
            "patch": "@@ -76,7 +76,7 @@ impl Asset for WebAssemblySource {\n             return Ok(AssetContent::file(FileContent::NotFound.cell()));\n         };\n \n-        let bytes = file.content().to_bytes()?;\n+        let bytes = file.content().to_bytes();\n         let parsed = wat::parse_bytes(&bytes)?;\n \n         Ok(AssetContent::file(File::from(&*parsed).into()))"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 18,
        "deletions": 18
    }
}