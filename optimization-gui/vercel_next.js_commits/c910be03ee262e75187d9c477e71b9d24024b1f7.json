{
    "author": "unstubbable",
    "message": "Use snapshots to verify error stack traces for dynamic validation errors (#80946)\n\nFor now, this is just documenting the current state of affairs with regards to how we print dynamic validation errors during prerendering.\r\n\r\nPreviously, the tests were run with and without `experimental.serverMinification`. Now, we're running them with and without the `--debug-prerender` CLI flag instead.\r\n\r\nIn follow-ups, we will add assertions for `next dev`, and also improve the errors for `next build`.\r\n\r\n> [!NOTE]  \r\n> This PR is best reviewed with hidden whitespace changes.",
    "sha": "c910be03ee262e75187d9c477e71b9d24024b1f7",
    "files": [
        {
            "sha": "77c6e0b9a2017c877876f1f50b8958a7fe18f70b",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.platform-dynamic.test.ts",
            "status": "modified",
            "additions": 99,
            "deletions": 74,
            "changes": 173,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,94 +1,119 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { getPrerenderOutput } from './utils'\n \n-import { createExpectError } from './utils'\n+describe.each([\n+  { inDebugMode: true, name: 'With --prerender-debug' },\n+  { inDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  describe('Sync Dynamic - With Fallback - Math.random()', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-random-with-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-function runTests(options: { withMinification: boolean }) {\n-  const { withMinification } = options\n-  describe(`Dynamic IO Errors - ${withMinification ? 'With Minification' : 'Without Minification'}`, () => {\n-    describe('Sync Dynamic - With Fallback - Math.random()', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-random-with-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should not error the build when calling Math.random() if all dynamic access is inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should not error the build when calling Math.random() if all dynamic access is inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('[data-fallback]').length).toBe(2)\n+    })\n+  })\n \n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('[data-fallback]').length).toBe(2)\n-      })\n+  describe('Sync Dynamic - Without Fallback - Math.random()', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-random-without-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Sync Dynamic - Without Fallback - Math.random()', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-random-without-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if Math.random() happens before some component outside a Suspense boundary is complete', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if Math.random() happens before some component outside a Suspense boundary is complete', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at RandomReadingComponent (turbopack:///[project]/app/page.tsx:35:22)\n+             33 |     use(new Promise((r) => process.nextTick(r)))\n+             34 |   }\n+           > 35 |   const random = Math.random()\n+                |                      ^\n+             36 |   return (\n+             37 |     <div>\n+             38 |       <span id=\"rand\">{random}</span>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at RandomReadingComponent (webpack:///app/page.tsx:35:22)\n+             33 |     use(new Promise((r) => process.nextTick(r)))\n+             34 |   }\n+           > 35 |   const random = Math.random()\n+                |                      ^\n+             36 |   return (\n+             37 |     <div>\n+             38 |       <span id=\"rand\">{random}</span>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n-        expectError(\n-          'Error: Route \"/\" used `Math.random()` outside of `\"use cache\"` and without explicitly calling `await connection()` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-        expectError('exiting the build.')\n-      })\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n   })\n-}\n-\n-runTests({ withMinification: true })\n-runTests({ withMinification: false })\n+})"
        },
        {
            "sha": "0617c194711e9ba2d0ad839e406a29a6c1f4caf5",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-attribution.test.ts",
            "status": "modified",
            "additions": 298,
            "deletions": 146,
            "changes": 444,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,183 +1,335 @@\n import { nextTestSetup } from 'e2e-utils'\n import { assertNoErrorToast } from 'next-test-utils'\n+import { getPrerenderOutput } from './utils'\n \n-import { createExpectError } from './utils'\n-\n-function runTests(options: { withMinification: boolean }) {\n-  const { withMinification } = options\n-  describe(`Dynamic IO Errors - ${withMinification ? 'With Minification' : 'Without Minification'}`, () => {\n-    describe('Error Attribution with Sync IO - Guarded RSC with guarded Client sync IO', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files:\n-          __dirname +\n-          '/fixtures/sync-attribution/guarded-async-guarded-clientsync',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+describe.each([\n+  { inDebugMode: true, name: 'With --prerender-debug' },\n+  { inDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  describe('Error Attribution with Sync IO - Guarded RSC with guarded Client sync IO', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files:\n+        __dirname +\n+        '/fixtures/sync-attribution/guarded-async-guarded-clientsync',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (skipped) {\n-        return\n-      }\n+    if (skipped) {\n+      return\n+    }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n+    if (isNextDev) {\n+      it('does not show a validation error in the dev overlay', async () => {\n+        await next.start()\n+        const browser = await next.browser('/')\n+        await assertNoErrorToast(browser)\n+      })\n+    } else {\n+      it('should not error the build sync IO is used inside a Suspense Boundary in a client Component and nothing else is dynamic', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail')\n         }\n+        expect(next.cliOutput).toContain('◐ / ')\n       })\n+    }\n+  })\n \n-      if (isNextDev) {\n-        it('does not show a validation error in the dev overlay', async () => {\n-          await next.start()\n-          const browser = await next.browser('/')\n-          await assertNoErrorToast(browser)\n-        })\n-      } else {\n-        it('should not error the build sync IO is used inside a Suspense Boundary in a client Component and nothing else is dynamic', async () => {\n-          try {\n-            await next.start()\n-          } catch {\n-            throw new Error('expected build not to fail')\n-          }\n-          expect(next.cliOutput).toContain('◐ / ')\n-        })\n-      }\n+  describe('Error Attribution with Sync IO - Guarded RSC with unguarded Client sync IO', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files:\n+        __dirname +\n+        '/fixtures/sync-attribution/guarded-async-unguarded-clientsync',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n-    describe('Error Attribution with Sync IO - Guarded RSC with unguarded Client sync IO', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files:\n-          __dirname +\n-          '/fixtures/sync-attribution/guarded-async-unguarded-clientsync',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n \n-      if (skipped) {\n-        return\n-      }\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build with a reason related to sync IO access', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build with a reason related to sync IO access', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n+             3 | export function SyncIO() {\n+             4 |   // This is a sync IO access that should not cause an error\n+           > 5 |   const data = new Date().toISOString()\n+               |               ^\n+             6 |\n+             7 |   return (\n+             8 |     <main>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at SyncIO (webpack:///app/client.tsx:5:15)\n+             3 | export function SyncIO() {\n+             4 |   // This is a sync IO access that should not cause an error\n+           > 5 |   const data = new Date().toISOString()\n+               |               ^\n+             6 |\n+             7 |   return (\n+             8 |     <main>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n-        expectError(\n-          'Error: Route \"/\" used `new Date()` inside a Client Component without a Suspense boundary above it.'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n-    describe('Error Attribution with Sync IO - Unguarded RSC with guarded Client sync IO', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files:\n-          __dirname +\n-          '/fixtures/sync-attribution/unguarded-async-guarded-clientsync',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+  })\n \n-      if (skipped) {\n-        return\n-      }\n+  describe('Error Attribution with Sync IO - Unguarded RSC with guarded Client sync IO', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files:\n+        __dirname +\n+        '/fixtures/sync-attribution/unguarded-async-guarded-clientsync',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n+\n+    it('should error the build with a reason related dynamic data', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build with a reason related dynamic data', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at section (<anonymous>)\n+               at main (<anonymous>)\n+               at RenderFromTemplateContext (<anonymous>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<anonymous>)\n+               at main (<anonymous>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<anonymous>)\n+               at l (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at section (<anonymous>)\n+               at main (<anonymous>)\n+               at InnerLayoutRouter (webpack://<next-src>)\n+               at RedirectErrorBoundary (webpack://<next-src>)\n+               at RedirectBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+               at LoadingBoundary (webpack://<next-src>)\n+               at ErrorBoundary (webpack://<next-src>)\n+               at InnerScrollAndFocusHandler (webpack://<next-src>)\n+               at ScrollAndFocusHandler (webpack://<next-src>)\n+               at RenderFromTemplateContext (<anonymous>)\n+               at OuterLayoutRouter (webpack://<next-src>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+             332 |  */\n+             333 | function InnerLayoutRouter({\n+           > 334 |   tree,\n+                 |  ^\n+             335 |   segmentPath,\n+             336 |   cacheNode,\n+             337 |   url,\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n-        expectError(\n-          'Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<anonymous>)\n+               at main (<anonymous>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<anonymous>)\n+               at l (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n-    describe('Error Attribution with Sync IO - unguarded RSC with unguarded Client sync IO', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files:\n-          __dirname +\n-          '/fixtures/sync-attribution/unguarded-async-unguarded-clientsync',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+  })\n \n-      if (skipped) {\n-        return\n-      }\n+  describe('Error Attribution with Sync IO - unguarded RSC with unguarded Client sync IO', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files:\n+        __dirname +\n+        '/fixtures/sync-attribution/unguarded-async-unguarded-clientsync',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n+\n+    it('should error the build with a reason related to sync IO access', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build with a reason related to sync IO access', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n+             3 | export function SyncIO() {\n+             4 |   // This is a sync IO access that should not cause an error\n+           > 5 |   const data = new Date().toISOString()\n+               |               ^\n+             6 |\n+             7 |   return (\n+             8 |     <main>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at SyncIO (webpack:///app/client.tsx:5:15)\n+             3 | export function SyncIO() {\n+             4 |   // This is a sync IO access that should not cause an error\n+           > 5 |   const data = new Date().toISOString()\n+               |               ^\n+             6 |\n+             7 |   return (\n+             8 |     <main>\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n-        expectError(\n-          'Error: Route \"/\" used `new Date()` inside a Client Component without a Suspense boundary above it.'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at a (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n   })\n-}\n-\n-runTests({ withMinification: true })\n-runTests({ withMinification: false })\n+})"
        },
        {
            "sha": "f4028a1608a70d678cfa0a8e9d84d5f8923b9360",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-dynamic.test.ts",
            "status": "modified",
            "additions": 359,
            "deletions": 207,
            "changes": 566,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,258 +1,410 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { getPrerenderOutput } from './utils'\n+\n+describe.each([\n+  { inDebugMode: true, name: 'With --prerender-debug' },\n+  { inDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  describe('Sync Dynamic - With Fallback - client searchParams', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-client-search-with-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-import { createExpectError } from './utils'\n-\n-function runTests(options: { withMinification: boolean }) {\n-  const { withMinification } = options\n-  describe(`Dynamic IO Errors - ${withMinification ? 'With Minification' : 'Without Minification'}`, () => {\n-    describe('Sync Dynamic - With Fallback - client searchParams', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-client-search-with-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('[data-fallback]').length).toBe(2)\n+    })\n+  })\n \n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('[data-fallback]').length).toBe(2)\n-      })\n+  describe('Sync Dynamic - Without Fallback - client searchParams', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-client-search-without-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Sync Dynamic - Without Fallback - client searchParams', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-client-search-without-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at LongRunningComponent (<anonymous>)\n+               at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n+               at Page (turbopack:///[project]/app/page.tsx:19:60)\n+               at RenderFromTemplateContext (<anonymous>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+              5 | }\n+              6 |\n+           >  7 | export function IndirectionTwo({ children }) {\n+                |                                 ^\n+              8 |   return children\n+              9 | }\n+             10 |\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<anonymous>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at l (<next-dist-dir>)\n+               at m (<next-dist-dir>)\n+               at n (<anonymous>)\n+               at o (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n-\n-        // TODO we need to figure out a way to improve this error message. This is the rare case where the sync IO is escaping out of it's parent Suspense because something is rendering too slowly in the root. At the moment we don't have a way of discriminating between this and something like Request data access in the server.\n-        // expectError('Route \"/\" used `searchParams.foo`')\n-        expectError(\n-          'Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-        expectError('exiting the build.')\n-      })\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at LongRunningComponent (<anonymous>)\n+               at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n+               at Page (webpack:///app/page.tsx:19:60)\n+               at ClientPageRoot (webpack://<next-src>)\n+               at InnerLayoutRouter (webpack://<next-src>)\n+               at RedirectErrorBoundary (webpack://<next-src>)\n+               at RedirectBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+               at LoadingBoundary (webpack://<next-src>)\n+               at ErrorBoundary (webpack://<next-src>)\n+               at InnerScrollAndFocusHandler (webpack://<next-src>)\n+               at ScrollAndFocusHandler (webpack://<next-src>)\n+               at RenderFromTemplateContext (<anonymous>)\n+               at OuterLayoutRouter (webpack://<next-src>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+              5 | }\n+              6 |\n+           >  7 | export function IndirectionTwo({ children }) {\n+                |                                 ^\n+              8 |   return children\n+              9 | }\n+             10 |\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<anonymous>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at l (<next-dist-dir>)\n+               at m (<next-dist-dir>)\n+               at n (<anonymous>)\n+               at o (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n+  })\n \n-    describe('Sync Dynamic - With Fallback - server searchParams', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-server-search-with-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+  describe('Sync Dynamic - With Fallback - server searchParams', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-server-search-with-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (skipped) {\n-        return\n-      }\n+    if (skipped) {\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n+    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n+      }\n \n-      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('[data-fallback]').length).toBe(2)\n+    })\n+  })\n \n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('[data-fallback]').length).toBe(2)\n-      })\n+  describe('Sync Dynamic - Without Fallback - server searchParams', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-server-search-without-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Sync Dynamic - Without Fallback - server searchParams', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-server-search-without-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at SearchParamsReadingComponent (turbopack:///[project]/app/page.tsx:40:4)\n+             38 |   const fooParams = (\n+             39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+           > 40 |   ).foo\n+                |    ^\n+             41 |   return (\n+             42 |     <div>\n+             43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at SearchParamsReadingComponent (webpack:///app/page.tsx:40:4)\n+             38 |   const fooParams = (\n+             39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+           > 40 |   ).foo\n+                |    ^\n+             41 |   return (\n+             42 |     <div>\n+             43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      }\n+    })\n+  })\n \n-        expectError('Route \"/\" used `searchParams.foo`')\n-        expectError('Error occurred prerendering page \"/\"')\n-        expectError('exiting the build.')\n-      })\n+  describe('Sync Dynamic - With Fallback - cookies', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-cookies-with-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Sync Dynamic - With Fallback - cookies', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-cookies-with-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('[data-fallback]').length).toBe(2)\n+    })\n+  })\n \n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('[data-fallback]').length).toBe(2)\n-      })\n+  describe('Sync Dynamic - Without Fallback - cookies', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/sync-cookies-without-fallback',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Sync Dynamic - Without Fallback - cookies', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/sync-cookies-without-fallback',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at CookiesReadingComponent (turbopack:///[project]/app/page.tsx:32:66)\n+             30 | async function CookiesReadingComponent() {\n+             31 |   await new Promise((r) => process.nextTick(r))\n+           > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                |                                                                  ^\n+             33 |   return <div>this component read the \\`token\\` cookie synchronously</div>\n+             34 | }\n+             35 |\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n-\n-        expectError('Route \"/\" used `cookies().get(\\'token\\')`')\n-        expectError('Error occurred prerendering page \"/\"')\n-        expectError('exiting the build.')\n-      })\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at createCookiesAccessError (webpack://<next-src>)\n+               at Promise.get (webpack://<next-src>)\n+               at CookiesReadingComponent (webpack:///app/page.tsx:32:66)\n+             579 | ) {\n+             580 |   const prefix = route ? \\`Route \"\\${route}\" \\` : 'This route '\n+           > 581 |   return new Error(\n+                 |         ^\n+             582 |     \\`\\${prefix}used \\${expression}. \\` +\n+             583 |       \\`\\\\\\`cookies()\\\\\\` should be awaited before using its value. \\` +\n+             584 |       \\`Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\\`\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n   })\n-}\n-\n-runTests({ withMinification: true })\n-runTests({ withMinification: false })\n+})"
        },
        {
            "sha": "c26a4ce4b61ec72ef1a8ee647d315e827bf12d60",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 580,
            "deletions": 320,
            "changes": 900,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,394 +1,654 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { getPrerenderOutput } from './utils'\n+\n+describe.each([\n+  { inDebugMode: true, name: 'With --prerender-debug' },\n+  { inDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  describe('Dynamic Metadata - Static Route', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-metadata-static-route',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-import { createExpectError } from './utils'\n-\n-function runTests(options: { withMinification: boolean }) {\n-  const isTurbopack = !!process.env.IS_TURBOPACK_TEST\n-  const { withMinification } = options\n-  describe(`Dynamic IO Errors - ${withMinification ? 'With Minification' : 'Without Minification'}`, () => {\n-    describe('Dynamic Metadata - Static Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-metadata-static-route',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      // This test used to assert the opposite but now that metadata is streaming during prerenders\n-      // we don't have to error the build when it is dynamic\n-      it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n-\n-        expectError(\n-          'Route \"/\" has a `generateMetadata` that depends on Request data (`cookies()`, etc...) or uncached external data (`fetch(...)`, etc...) when the rest of the route does not'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(\n+            getPrerenderOutput(next.cliOutput, { isMinified: !inDebugMode })\n+          ).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n-    describe('Dynamic Metadata - Error Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-metadata-error-route',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+  })\n \n-      if (skipped) {\n-        return\n-      }\n+  describe('Dynamic Metadata - Error Route', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-metadata-error-route',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n+\n+    // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n+    it('should error the build for the correct reason when there is a dynamic IO violation alongside dynamic metadata', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n-      it('should error the build for the correct reason when there is a dynamic IO violation alongside dynamic metadata', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at InnerLayoutRouter (webpack://<next-src>)\n+               at RedirectErrorBoundary (webpack://<next-src>)\n+               at RedirectBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+               at LoadingBoundary (webpack://<next-src>)\n+               at ErrorBoundary (webpack://<next-src>)\n+               at InnerScrollAndFocusHandler (webpack://<next-src>)\n+               at ScrollAndFocusHandler (webpack://<next-src>)\n+               at RenderFromTemplateContext (webpack://<next-src>)\n+               at OuterLayoutRouter (webpack://<next-src>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+             332 |  */\n+             333 | function InnerLayoutRouter({\n+           > 334 |   tree,\n+                 |  ^\n+             335 |   segmentPath,\n+             336 |   cacheNode,\n+             337 |   url,\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      }\n+    })\n+  })\n \n-        expectError(\n-          'Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+  describe('Dynamic Metadata - Static Route With Suspense', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-metadata-static-with-suspense',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n-    describe('Dynamic Metadata - Static Route With Suspense', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-metadata-static-with-suspense',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n \n-      if (skipped) {\n-        return\n-      }\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      // This test used to assert the opposite but now that metadata is streaming during prerenders\n-      // we don't have to error the build when it is dynamic\n-      it('should not error the build if generateMetadata is dynamic', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      }\n+    })\n+  })\n \n-        expectError(\n-          'Route \"/\" has a `generateMetadata` that depends on Request data (`cookies()`, etc...) or uncached external data (`fetch(...)`, etc...) when the rest of the route does not'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+  describe('Dynamic Metadata - Dynamic Route', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-metadata-dynamic-route',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Dynamic Metadata - Dynamic Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-metadata-dynamic-route',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('#dynamic').text()).toBe('Dynamic')\n+      expect($('[data-fallback]').length).toBe(1)\n+    })\n+  })\n \n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('#dynamic').text()).toBe('Dynamic')\n-        expect($('[data-fallback]').length).toBe(1)\n-      })\n+  describe('Dynamic Viewport - Static Route', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-viewport-static-route',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Dynamic Viewport - Static Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-viewport-static-route',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if generateViewport is dynamic', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if generateViewport is dynamic', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n+    })\n+  })\n \n-        expectError(\n-          'Route \"/\" has a `generateViewport` that depends on Request data (`cookies()`, etc...) or uncached external data (`fetch(...)`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+  describe('Dynamic Viewport - Dynamic Route', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-viewport-dynamic-route',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Dynamic Viewport - Dynamic Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-viewport-dynamic-route',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if generateViewport is dynamic even if there are other uses of dynamic on the page', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if generateViewport is dynamic even if there are other uses of dynamic on the page', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n-\n-        expectError(\n-          'Route \"/\" has a `generateViewport` that depends on Request data (`cookies()`, etc...) or uncached external data (`fetch(...)`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-      })\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n+  })\n \n-    describe('Static Route', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/static',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n-\n-      if (skipped) {\n-        return\n-      }\n+  describe('Static Route', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/static',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n+\n+    it('should not error the build when all routes are static', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n+        throw new Error('expected build not to fail for fully static project')\n       }\n+    })\n+  })\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should not error the build when all routes are static', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n-          throw new Error('expected build not to fail for fully static project')\n-        }\n-      })\n+  describe('Dynamic Root', () => {\n+    const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-root',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n-    describe('Dynamic Root', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-root',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n+    if (skipped) {\n+      return\n+    }\n \n-      if (skipped) {\n-        return\n-      }\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n+      const output = getPrerenderOutput(next.cliOutput, {\n+        isMinified: !inDebugMode,\n       })\n \n-      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          // we expect the build to fail\n+      if (isTurbopack) {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+              5 | }\n+              6 |\n+           >  7 | export function IndirectionTwo({ children }) {\n+                |                                 ^\n+              8 |   return children\n+              9 | }\n+             10 |\n+           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at l (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at m (<next-dist-dir>)\n+               at n (<next-dist-dir>)\n+               at o (<next-dist-dir>)\n+               at p (<next-dist-dir>)\n+               at q (<next-dist-dir>)\n+               at r (<next-dist-dir>)\n+               at s (<next-dist-dir>)\n+               at t (<next-dist-dir>)\n+               at u (<next-dist-dir>)\n+               at v (<next-dist-dir>)\n+               at w (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n         }\n-        const expectError = createExpectError(next.cliOutput)\n-\n-        expectError(\n-          'Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.',\n-          // Turbopack doesn't support disabling minification yet\n-          withMinification || isTurbopack ? undefined : 'IndirectionTwo'\n-        )\n-        expectError(\n-          'Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it.',\n-          // Turbopack doesn't support disabling minification yet\n-          withMinification || isTurbopack ? undefined : 'IndirectionThree'\n-        )\n-        expectError('Error occurred prerendering page \"/\"')\n-        expectError('exiting the build.')\n-      })\n+      } else {\n+        if (inDebugMode) {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n+               at InnerLayoutRouter (webpack://<next-src>)\n+               at RedirectErrorBoundary (webpack://<next-src>)\n+               at RedirectBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+               at LoadingBoundary (webpack://<next-src>)\n+               at ErrorBoundary (webpack://<next-src>)\n+               at InnerScrollAndFocusHandler (webpack://<next-src>)\n+               at ScrollAndFocusHandler (webpack://<next-src>)\n+               at RenderFromTemplateContext (webpack://<next-src>)\n+               at OuterLayoutRouter (webpack://<next-src>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+              5 | }\n+              6 |\n+           >  7 | export function IndirectionTwo({ children }) {\n+                |                                 ^\n+              8 |   return children\n+              9 | }\n+             10 |\n+           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at InnerLayoutRouter (webpack://<next-src>)\n+               at RedirectErrorBoundary (webpack://<next-src>)\n+               at RedirectBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+               at LoadingBoundary (webpack://<next-src>)\n+               at ErrorBoundary (webpack://<next-src>)\n+               at InnerScrollAndFocusHandler (webpack://<next-src>)\n+               at ScrollAndFocusHandler (webpack://<next-src>)\n+               at RenderFromTemplateContext (webpack://<next-src>)\n+               at OuterLayoutRouter (webpack://<next-src>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+             332 |  */\n+             333 | function InnerLayoutRouter({\n+           > 334 |   tree,\n+                 |  ^\n+             335 |   segmentPath,\n+             336 |   cacheNode,\n+             337 |   url,\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/page: /\"\n+          `)\n+        } else {\n+          expect(output).toMatchInlineSnapshot(`\n+           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at a (<next-dist-dir>)\n+               at b (<next-dist-dir>)\n+               at c (<next-dist-dir>)\n+               at d (<next-dist-dir>)\n+               at e (<next-dist-dir>)\n+               at f (<next-dist-dir>)\n+               at g (<next-dist-dir>)\n+               at h (<next-dist-dir>)\n+               at i (<next-dist-dir>)\n+               at j (<next-dist-dir>)\n+               at k (<next-dist-dir>)\n+               at l (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+               at m (<next-dist-dir>)\n+               at n (<next-dist-dir>)\n+               at o (<next-dist-dir>)\n+               at p (<next-dist-dir>)\n+               at q (<next-dist-dir>)\n+               at r (<next-dist-dir>)\n+               at s (<next-dist-dir>)\n+               at t (<next-dist-dir>)\n+               at u (<next-dist-dir>)\n+               at v (<next-dist-dir>)\n+               at w (<next-dist-dir>)\n+               at main (<anonymous>)\n+               at body (<anonymous>)\n+               at html (<anonymous>)\n+           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /page: /, exiting the build.\"\n+          `)\n+        }\n+      }\n     })\n+  })\n \n-    describe('Dynamic Boundary', () => {\n-      const { next, isNextDev, skipped } = nextTestSetup({\n-        files: __dirname + '/fixtures/dynamic-boundary',\n-        skipStart: true,\n-        skipDeployment: true,\n-      })\n-\n-      if (skipped) {\n-        return\n-      }\n+  describe('Dynamic Boundary', () => {\n+    const { next, isNextDev, skipped } = nextTestSetup({\n+      files: __dirname + '/fixtures/dynamic-boundary',\n+      skipStart: true,\n+      skipDeployment: true,\n+      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+    })\n \n-      if (isNextDev) {\n-        it('does not run in dev', () => {})\n-        return\n+    if (skipped) {\n+      return\n+    }\n+\n+    if (isNextDev) {\n+      it('does not run in dev', () => {})\n+      return\n+    }\n+\n+    it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n+      try {\n+        await next.start()\n+      } catch {\n+        throw new Error('expected build not to fail for fully static project')\n+        // we expect the build to fail\n       }\n \n-      beforeEach(async () => {\n-        if (!withMinification) {\n-          await next.patchFile('next.config.js', (content) =>\n-            content.replace(\n-              'serverMinification: true,',\n-              'serverMinification: false,'\n-            )\n-          )\n-        }\n-      })\n-\n-      it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n-        try {\n-          await next.start()\n-        } catch {\n-          throw new Error('expected build not to fail for fully static project')\n-          // we expect the build to fail\n-        }\n-\n-        expect(next.cliOutput).toContain('◐ / ')\n-        const $ = await next.render$('/')\n-        expect($('[data-fallback]').length).toBe(2)\n-      })\n+      expect(next.cliOutput).toContain('◐ / ')\n+      const $ = await next.render$('/')\n+      expect($('[data-fallback]').length).toBe(2)\n     })\n   })\n-}\n-\n-runTests({ withMinification: true })\n-runTests({ withMinification: false })\n+})"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-boundary/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-boundary%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-boundary%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-boundary%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-dynamic-route/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-dynamic-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-dynamic-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-dynamic-route%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-error-route/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-static-route/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-route%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-static-with-suspense/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-with-suspense%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-with-suspense%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-static-with-suspense%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "cbc157f0443eca92239998e30bc764aca87a02bb",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-root/app/indirection.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Findirection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Findirection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Findirection.tsx?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -7,7 +7,3 @@ export function IndirectionOne({ children }) {\n export function IndirectionTwo({ children }) {\n   return children\n }\n-\n-export function IndirectionThree({ children }) {\n-  return children\n-}"
        },
        {
            "sha": "3272082eca88d09189c6658cc712f7893ef366d1",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-root/app/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fapp%2Fpage.tsx?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,6 +1,6 @@\n import { Suspense } from 'react'\n \n-import { IndirectionOne, IndirectionTwo, IndirectionThree } from './indirection'\n+import { IndirectionOne, IndirectionTwo } from './indirection'\n \n export default async function Page() {\n   return (\n@@ -24,12 +24,10 @@ export default async function Page() {\n           <FetchingComponent nonce=\"d\" />\n         </Suspense>\n       </IndirectionTwo>\n-      <IndirectionThree>\n-        <FetchingComponent nonce=\"e\" />\n-        <Suspense fallback=\"loading...\">\n-          <FetchingComponent nonce=\"f\" />\n-        </Suspense>\n-      </IndirectionThree>\n+      <FetchingComponent nonce=\"e\" />\n+      <Suspense fallback=\"loading...\">\n+        <FetchingComponent nonce=\"f\" />\n+      </Suspense>\n     </>\n   )\n }"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-root/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-root%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: false,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-viewport-dynamic-route/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-dynamic-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-dynamic-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-dynamic-route%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-viewport-static-route/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-static-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-static-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-viewport-static-route%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/lazy-module-init/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Flazy-module-init%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Flazy-module-init%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Flazy-module-init%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: false,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/static/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fstatic%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fstatic%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fstatic%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-attribution/guarded-async-guarded-clientsync/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-guarded-clientsync%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-guarded-clientsync%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-guarded-clientsync%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-attribution/guarded-async-unguarded-clientsync/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-unguarded-clientsync%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-unguarded-clientsync%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Fguarded-async-unguarded-clientsync%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-attribution/unguarded-async-guarded-clientsync/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-guarded-clientsync%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-guarded-clientsync%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-guarded-clientsync%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-attribution/unguarded-async-unguarded-clientsync/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-unguarded-clientsync%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-unguarded-clientsync%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-attribution%2Funguarded-async-unguarded-clientsync%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-client-search-with-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-with-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-client-search-without-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-client-search-without-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-cookies-with-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-with-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-cookies-without-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-cookies-without-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-random-with-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-with-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-random-without-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-server-search-with-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-with-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-server-search-without-fallback/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-server-search-without-fallback%2Fnext.config.js?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -4,7 +4,6 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n-    serverMinification: true,\n   },\n }\n "
        },
        {
            "sha": "ae55ff8df3065f73e64ffac67d8bfca9ab761ebc",
            "filename": "test/e2e/app-dir/dynamic-io-errors/utils.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 31,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c910be03ee262e75187d9c477e71b9d24024b1f7/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts?ref=c910be03ee262e75187d9c477e71b9d24024b1f7",
            "patch": "@@ -1,35 +1,52 @@\n-const stackStart = /\\s+at /\n-\n-export function createExpectError(cliOutput: string) {\n-  let cliIndex = 0\n-  return function expectError(\n-    containing: string,\n-    withStackContaining?: string\n-  ): void {\n-    const initialCliIndex = cliIndex\n-    let lines = cliOutput.slice(cliIndex).split('\\n')\n-\n-    let i = 0\n-    while (i < lines.length) {\n-      let line = lines[i++] + '\\n'\n-      cliIndex += line.length\n-      if (line.includes(containing)) {\n-        if (typeof withStackContaining !== 'string') {\n-          return\n-        } else {\n-          while (i < lines.length) {\n-            let stackLine = lines[i++] + '\\n'\n-            if (!stackStart.test(stackLine)) {\n-              expect(stackLine).toContain(withStackContaining)\n-            }\n-            if (stackLine.includes(withStackContaining)) {\n-              return\n-            }\n-          }\n-        }\n-      }\n+// Used to deterministically stub out minified local names in stack traces.\n+const abc = 'abcdefghijklmnopqrstuvwxyz'\n+const hostElementsUsedInFixtures = ['html', 'body', 'main', 'div']\n+\n+export function getPrerenderOutput(\n+  cliOutput: string,\n+  { isMinified }: { isMinified: boolean }\n+): string {\n+  const lines: string[] = []\n+  let foundPrerenderingLine = false\n+  let i = 0\n+\n+  const replaceNextDistStackFrame = () =>\n+    `at ${abc[i++ % abc.length]} (<next-dist-dir>)`\n+\n+  const replaceAnonymousStackFrame = (_m, name) => {\n+    const deterministicName = hostElementsUsedInFixtures.includes(name)\n+      ? name\n+      : abc[i++ % abc.length]\n+\n+    return `at ${deterministicName} (<anonymous>)`\n+  }\n+\n+  for (const line of cliOutput.split('\\n')) {\n+    if (line.includes('Collecting page data')) {\n+      foundPrerenderingLine = true\n+      continue\n+    }\n+\n+    if (line.includes('Next.js build worker exited')) {\n+      break\n     }\n \n-    expect(cliOutput.slice(initialCliIndex)).toContain(containing)\n+    if (foundPrerenderingLine && !line.includes('Generating static pages')) {\n+      lines.push(\n+        isMinified\n+          ? line\n+              .replace(/at [\\w.]+ \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n+              .replace(\n+                /at ([\\w.]+) \\(<anonymous>\\)/,\n+                replaceAnonymousStackFrame\n+              )\n+          : line.replace(\n+              /at ([\\w.]+) \\((webpack:\\/\\/)\\/src[^)]+\\)/,\n+              `at $1 ($2<next-src>)`\n+            )\n+      )\n+    }\n   }\n+\n+  return lines.join('\\n').trim()\n }"
        }
    ],
    "stats": {
        "total": 2200,
        "additions": 1389,
        "deletions": 811
    }
}