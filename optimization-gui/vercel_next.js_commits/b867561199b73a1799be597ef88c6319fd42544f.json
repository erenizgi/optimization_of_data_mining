{
    "author": "wyattjoh",
    "message": "fix: handle incremental PPR with client segment cache (#78387)\n\nThis pull request introduces changes to enhance the handling of prefetch\nsegment data routes in the Next.js build process and adds new test cases\nto validate these updates. Key changes include the addition of a new\n`buildInversePrefetchSegmentDataRoute` utility, modifications to the\nroute generation logic, and the introduction of experimental features\nlike `clientSegmentCache`. This addresses a bug where conflicting routes\nwhile incremental PPR was enabled that matched routes incorrectly, for\nexample:\n\n```\n/~/monitoring <- PPR disabled\n/[teamSlug]/monitoring <- PPR enabled\n```\n\nWould previously cause client segment requests for `/~/monitoring` to\nmatch `/[teamSlug]/monitoring`. This addresses it by adding early\nrewrites to handle this case. This will be removed in future versions\nwhen incremental PPR is deprecated.\n\n### Enhancements to prefetch segment data routes:\n\n* Added a new utility, `buildInversePrefetchSegmentDataRoute`, to\nsupport inverted prefetch segment data routes, which rewrite from\nsegment paths back to prefetch RSC routes. This is particularly useful\nfor handling dynamic routes without conflicts when partial prerendering\nis disabled\n(`packages/next/src/server/lib/router-utils/build-prefetch-segment-data-route.ts`).\n* Updated the `PrefetchSegmentDataRoute` type to include `routeKeys` for\nbetter route matching and added logic for generating these keys\n(`packages/next/src/server/lib/router-utils/build-prefetch-segment-data-route.ts`).\n[[1]](diffhunk://#diff-35b900720f7fd8bc8995f5dad9880b2ffafba0638ec6c949efc9ba34b0acc9cbR15)\n[[2]](diffhunk://#diff-35b900720f7fd8bc8995f5dad9880b2ffafba0638ec6c949efc9ba34b0acc9cbL27-R29)\n* Modified the build process to utilize\n`buildInversePrefetchSegmentDataRoute` for dynamic routes with undefined\nsegment paths when `clientSegmentCache` is enabled\n(`packages/next/src/build/index.ts`).\n\n### Codebase improvements:\n\n* Added `originalAppPath` to the `PageInfo` interface to track the\noriginal path of app pages and routes, improving route handling logic\n(`packages/next/src/build/utils.ts`).\n* Simplified the logic for appending prefetch segment data routes by\ndirectly pushing the result of `buildPrefetchSegmentDataRoute` instead\nof using intermediate variables (`packages/next/src/build/index.ts`).\n\n### Testing and experimental features:\n\n* Added comprehensive unit tests for\n`buildInversePrefetchSegmentDataRoute` to ensure correct behavior and\ncompatibility with existing route utilities\n(`packages/next/src/server/lib/router-utils/build-prefetch-segment-data-route.test.ts`).\n* Introduced a new E2E test suite for validating conflicting routes and\nprefetching behavior under the experimental `clientSegmentCache` feature\n(`test/e2e/app-dir/segment-cache/conflicting-routes`).\n* Enabled experimental features like `clientSegmentCache` and `ppr`\n(partial prerendering) in the test configuration to validate their\nintegration\n(`test/e2e/app-dir/segment-cache/conflicting-routes/next.config.js`).\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as s\nmoothly as possible we request that you follow the checklist sections\nbelow.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "b867561199b73a1799be597ef88c6319fd42544f",
    "files": [
        {
            "sha": "6fc63cf3bd46861aa8fa0909773407aa7f54eaad",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 4,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -202,6 +202,7 @@ import { InvariantError } from '../shared/lib/invariant-error'\n import { HTML_LIMITED_BOT_UA_RE_STRING } from '../shared/lib/router/utils/is-bot'\n import type { UseCacheTrackerKey } from './webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n import {\n+  buildInversePrefetchSegmentDataRoute,\n   buildPrefetchSegmentDataRoute,\n   type PrefetchSegmentDataRoute,\n } from '../server/lib/router-utils/build-prefetch-segment-data-route'\n@@ -2175,6 +2176,7 @@ export default async function build(\n                 }\n \n                 pageInfos.set(page, {\n+                  originalAppPath,\n                   size,\n                   totalSize,\n                   isStatic,\n@@ -3074,11 +3076,9 @@ export default async function build(\n \n                   dynamicRoute.prefetchSegmentDataRoutes ??= []\n                   for (const segmentPath of metadata.segmentPaths) {\n-                    const result = buildPrefetchSegmentDataRoute(\n-                      route.pathname,\n-                      segmentPath\n+                    dynamicRoute.prefetchSegmentDataRoutes.push(\n+                      buildPrefetchSegmentDataRoute(route.pathname, segmentPath)\n                     )\n-                    dynamicRoute.prefetchSegmentDataRoutes.push(result)\n                   }\n                 }\n \n@@ -3497,6 +3497,47 @@ export default async function build(\n           // remove temporary export folder\n           await fs.rm(outdir, { recursive: true, force: true })\n           await writeManifest(pagesManifestPath, pagesManifest)\n+\n+          if (config.experimental.clientSegmentCache) {\n+            for (const dynamicRoute of routesManifest.dynamicRoutes) {\n+              // We only want to handle pages that are using the app router. We\n+              // need this path in order to determine if it's an app route or an\n+              // app page.\n+              const originalAppPath = pageInfos.get(\n+                dynamicRoute.page\n+              )?.originalAppPath\n+              if (!originalAppPath) {\n+                continue\n+              }\n+\n+              // We only want to handle app pages, not app routes.\n+              if (isAppRouteRoute(originalAppPath)) {\n+                continue\n+              }\n+\n+              // We don't need to add the prefetch segment data routes if it was\n+              // added due to a page that was already generated. This would have\n+              // happened if the page was static or partially static.\n+              if (dynamicRoute.prefetchSegmentDataRoutes) {\n+                continue\n+              }\n+\n+              // If the segment paths aren't defined, we need to insert a\n+              // reverse routing rule so that there isn't any conflicts\n+              // with other dynamic routes for the prefetch segment\n+              // routes. This is only an issue for pages that do not have\n+              // partial prerendering enabled.\n+              dynamicRoute.prefetchSegmentDataRoutes = [\n+                buildInversePrefetchSegmentDataRoute(\n+                  dynamicRoute.page,\n+                  // We use the special segment path of `/_tree` because it's\n+                  // the first one sent by the client router so it's the only\n+                  // one we need to rewrite to the regular prefetch RSC route.\n+                  '/_tree'\n+                ),\n+              ]\n+            }\n+          }\n         })\n \n         // We need to write the manifest with rewrites after build as it might"
        },
        {
            "sha": "bc03383ebbf18705cf463291a3b49799afe4f900",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -338,6 +338,7 @@ const filterAndSortList = (\n }\n \n export interface PageInfo {\n+  originalAppPath: string | undefined\n   isHybridAmp?: boolean\n   size: number\n   totalSize: number"
        },
        {
            "sha": "1772a856a1c9348033f0a3597c14018619a78640",
            "filename": "packages/next/src/server/lib/router-utils/build-prefetch-segment-data-route.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.test.ts?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -1,4 +1,7 @@\n-import { buildPrefetchSegmentDataRoute } from './build-prefetch-segment-data-route'\n+import {\n+  buildInversePrefetchSegmentDataRoute,\n+  buildPrefetchSegmentDataRoute,\n+} from './build-prefetch-segment-data-route'\n \n describe('buildPrefetchSegmentDataRoute', () => {\n   it('should build a prefetch segment data route', () => {\n@@ -10,8 +13,30 @@ describe('buildPrefetchSegmentDataRoute', () => {\n     expect(route).toMatchInlineSnapshot(`\n      {\n        \"destination\": \"/blog/[...slug].segments/$c$slug$[slug]/__PAGE__.segment.rsc\",\n+       \"routeKeys\": {\n+         \"nxtPslug\": \"nxtPslug\",\n+       },\n        \"source\": \"^/blog/(?<nxtPslug>.+?)\\\\.segments/\\\\$c\\\\$slug\\\\$\\\\k<nxtPslug>/__PAGE__\\\\.segment\\\\.rsc$\",\n      }\n     `)\n   })\n })\n+\n+describe('buildInversePrefetchSegmentDataRoute', () => {\n+  it('should build an inverted prefetch segment data route', () => {\n+    const route = buildInversePrefetchSegmentDataRoute(\n+      '/blog/[...slug]',\n+      '/_tree'\n+    )\n+\n+    expect(route).toMatchInlineSnapshot(`\n+     {\n+       \"destination\": \"/blog/[...slug].prefetch.rsc\",\n+       \"routeKeys\": {\n+         \"nxtPslug\": \"nxtPslug\",\n+       },\n+       \"source\": \"^/blog/(?<nxtPslug>.+?)\\\\.segments/_tree\\\\.segment\\\\.rsc$\",\n+     }\n+    `)\n+  })\n+})"
        },
        {
            "sha": "ecabb3ef632ca7fa45e1fe137d2f7b9a77f5d2ff",
            "filename": "packages/next/src/server/lib/router-utils/build-prefetch-segment-data-route.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 1,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fbuild-prefetch-segment-data-route.ts?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -2,6 +2,7 @@ import path from '../../../shared/lib/isomorphic/path'\n import { normalizePagePath } from '../../../shared/lib/page-path/normalize-page-path'\n import { getNamedRouteRegex } from '../../../shared/lib/router/utils/route-regex'\n import {\n+  RSC_PREFETCH_SUFFIX,\n   RSC_SEGMENT_SUFFIX,\n   RSC_SEGMENTS_DIR_SUFFIX,\n } from '../../../lib/constants'\n@@ -11,6 +12,7 @@ export const SEGMENT_PATH_KEY = 'nextSegmentPath'\n export type PrefetchSegmentDataRoute = {\n   source: string\n   destination: string\n+  routeKeys: { [key: string]: string }\n }\n \n export function buildPrefetchSegmentDataRoute(\n@@ -24,7 +26,7 @@ export function buildPrefetchSegmentDataRoute(\n     `${segmentPath}${RSC_SEGMENT_SUFFIX}`\n   )\n \n-  const { namedRegex } = getNamedRouteRegex(destination, {\n+  const { namedRegex, routeKeys } = getNamedRouteRegex(destination, {\n     prefixRouteKeys: true,\n     includePrefix: true,\n     includeSuffix: true,\n@@ -35,5 +37,43 @@ export function buildPrefetchSegmentDataRoute(\n   return {\n     destination,\n     source: namedRegex,\n+    routeKeys,\n+  }\n+}\n+\n+/**\n+ * Builds a prefetch segment data route that is inverted. This means that it's\n+ * supposed to rewrite from the previous segment paths route back to the\n+ * prefetch RSC route.\n+ *\n+ * @param page - The page to build the route for.\n+ * @param segmentPath - The segment path to build the route for.\n+ * @returns The prefetch segment data route.\n+ */\n+export function buildInversePrefetchSegmentDataRoute(\n+  page: string,\n+  segmentPath: string\n+): PrefetchSegmentDataRoute {\n+  const pagePath = normalizePagePath(page)\n+\n+  const source = path.posix.join(\n+    `${pagePath}${RSC_SEGMENTS_DIR_SUFFIX}`,\n+    `${segmentPath}${RSC_SEGMENT_SUFFIX}`\n+  )\n+\n+  const { namedRegex, routeKeys } = getNamedRouteRegex(source, {\n+    prefixRouteKeys: true,\n+    includePrefix: true,\n+    includeSuffix: true,\n+    excludeOptionalTrailingSlash: true,\n+    backreferenceDuplicateKeys: true,\n+  })\n+\n+  const destination = path.posix.join(`${pagePath}${RSC_PREFETCH_SUFFIX}`)\n+\n+  return {\n+    source: namedRegex,\n+    destination,\n+    routeKeys,\n   }\n }"
        },
        {
            "sha": "bf6b50df6d8e003a1639ae7409c9d4f527e0556a",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/[lang]/[teamSlug]/[projectSlug]/monitoring/page.jsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%5BprojectSlug%5D%2Fmonitoring%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%5BprojectSlug%5D%2Fmonitoring%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%5BprojectSlug%5D%2Fmonitoring%2Fpage.jsx?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,9 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return <div>/[lang]/[teamSlug]/[projectSlug]/monitoring</div>\n+}\n+\n+export const experimental_ppr = true"
        },
        {
            "sha": "73113af38908547203bd3a40394bd9304491c293",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/[lang]/[teamSlug]/~/monitoring/page.jsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%7E%2Fmonitoring%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%7E%2Fmonitoring%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2F%5BteamSlug%5D%2F%7E%2Fmonitoring%2Fpage.jsx?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,7 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return <div>/[lang]/[teamSlug]/~/monitoring</div>\n+}"
        },
        {
            "sha": "088b825e33cadc85abddfe411b90a181a062c135",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/[lang]/layout.jsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Flayout.jsx?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({ children, params }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}\n+\n+export function generateStaticParams() {\n+  return ['en', 'fr'].map((lang) => ({ lang }))\n+}"
        },
        {
            "sha": "09367d77b06ee48c87f6f30825475eea8b44aaf5",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/[lang]/loading.jsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Floading.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Floading.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Floading.jsx?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <div>Loading...</div>\n+}"
        },
        {
            "sha": "a281b7a197c362f5c5ebc01909c476d9fdbcad85",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/[lang]/page.jsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2F%5Blang%5D%2Fpage.jsx?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,9 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <Link href=\"/es/~/monitoring\">Monitoring</Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f8148edbb77908bb3cdcd6fd2fee448fabac8c2d",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,33 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('conflicting routes', () => {\n+  const { next, isNextDev, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+  })\n+  if (isNextDev) {\n+    test('prefetching is disabled', () => {})\n+    return\n+  }\n+\n+  it.each([\n+    '/en/vercel/~/monitoring',\n+    '/fr/vercel/~/monitoring',\n+    '/es/vercel/~/monitoring',\n+  ])('%s matches the right route', async (path) => {\n+    const res = await next.fetch(path, {\n+      headers: {\n+        RSC: '1',\n+        'Next-Router-Prefetch': '1',\n+        'Next-Router-Segment-Prefetch': '/_tree',\n+      },\n+    })\n+\n+    expect(res.status).toBe(200)\n+\n+    if (isNextDeploy) {\n+      expect(res.headers.get('x-matched-path')).toBe(\n+        '/[lang]/[teamSlug]/~/monitoring.prefetch.rsc'\n+      )\n+    }\n+  })\n+})"
        },
        {
            "sha": "1fb210a73ee9e6f11234061e02479b5ad42f5da8",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b867561199b73a1799be597ef88c6319fd42544f/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fnext.config.js?ref=b867561199b73a1799be597ef88c6319fd42544f",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: 'incremental',\n+    clientSegmentCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 202,
        "additions": 196,
        "deletions": 6
    }
}