{
    "author": "ijjk",
    "message": "Do not modify parsedUrl collecting params (#82907)\n\nThis updates to not modify the parsed URL values when collecting rewrite\nparams inside of the `RouteModule`. This avoids invalid double rewrite\ncases one at the CDN layer and once again when collecting rewrite params\ninside the function.\n\nIn the future we should have a de-opt to skip the in function rewrite\nparam parsing when a user has properly configured their CDN to handle\ntheir rewrites and pass them down to the function.\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C04M81FAWE6/p1755806771519109?thread_ts=1755668503.049659&cid=C04M81FAWE6)",
    "sha": "29aacbf88a97b0329d34f8d5e615f3b5e6767c1a",
    "files": [
        {
            "sha": "942ef20f042562db502f50851666f97504132f00",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/29aacbf88a97b0329d34f8d5e615f3b5e6767c1a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/29aacbf88a97b0329d34f8d5e615f3b5e6767c1a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=29aacbf88a97b0329d34f8d5e615f3b5e6767c1a",
            "patch": "@@ -116,6 +116,7 @@ export const getHandler = ({\n       routerServerContext,\n       nextConfig,\n       resolvedPathname,\n+      encodedResolvedPathname,\n     } = prepareResult\n \n     const isExperimentalCompile =\n@@ -197,8 +198,8 @@ export const getHandler = ({\n \n       const resolvedUrl = formatUrl({\n         pathname: nextConfig.trailingSlash\n-          ? parsedUrl.pathname\n-          : removeTrailingSlash(parsedUrl.pathname || '/'),\n+          ? `${encodedResolvedPathname}${!encodedResolvedPathname.endsWith('/') && parsedUrl.pathname?.endsWith('/') ? '/' : ''}`\n+          : removeTrailingSlash(encodedResolvedPathname || '/'),\n         // make sure to only add query values from original URL\n         query: hasStaticProps ? {} : originalQuery,\n       })"
        },
        {
            "sha": "acc19ef418355b267b2468bb74194874cd64df11",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/29aacbf88a97b0329d34f8d5e615f3b5e6767c1a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/29aacbf88a97b0329d34f8d5e615f3b5e6767c1a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=29aacbf88a97b0329d34f8d5e615f3b5e6767c1a",
            "patch": "@@ -508,6 +508,7 @@ export abstract class RouteModule<\n         pageIsDynamic: boolean\n         isDraftMode: boolean\n         resolvedPathname: string\n+        encodedResolvedPathname: string\n         isNextDataRequest: boolean\n         buildManifest: DeepReadonly<BuildManifest>\n         fallbackBuildManifest: DeepReadonly<BuildManifest>\n@@ -624,9 +625,13 @@ export abstract class RouteModule<\n     const locale =\n       getRequestMeta(req, 'locale') || detectedLocale || defaultLocale\n \n+    // we apply rewrites against cloned URL so that we don't\n+    // modify the original with the rewrite destination\n+    const clonedParsedUrl = structuredClone(parsedUrl)\n     const rewriteParamKeys = Object.keys(\n-      serverUtils.handleRewrites(req, parsedUrl)\n+      serverUtils.handleRewrites(req, clonedParsedUrl)\n     )\n+    Object.assign(parsedUrl.query, clonedParsedUrl.query)\n \n     // after processing rewrites we want to remove locale\n     // from parsedUrl pathname\n@@ -635,6 +640,11 @@ export abstract class RouteModule<\n         parsedUrl.pathname || '/',\n         i18n.locales\n       ).pathname\n+\n+      clonedParsedUrl.pathname = normalizeLocalePath(\n+        clonedParsedUrl.pathname || '/',\n+        i18n.locales\n+      ).pathname\n     }\n \n     let params: Record<string, undefined | string | string[]> | undefined =\n@@ -643,7 +653,9 @@ export abstract class RouteModule<\n     // attempt parsing from pathname\n     if (!params && serverUtils.dynamicRouteMatcher) {\n       const paramsMatch = serverUtils.dynamicRouteMatcher(\n-        normalizeDataPath(localeResult?.pathname || parsedUrl.pathname || '/')\n+        normalizeDataPath(\n+          clonedParsedUrl?.pathname || parsedUrl.pathname || '/'\n+        )\n       )\n       const paramsResult = serverUtils.normalizeDynamicRouteParams(\n         paramsMatch || {},\n@@ -809,6 +821,10 @@ export abstract class RouteModule<\n     if (resolvedPathname === '/index') {\n       resolvedPathname = '/'\n     }\n+    const encodedResolvedPathname = resolvedPathname\n+\n+    // we decode for cache key/manifest usage encoded is\n+    // for URL building\n     try {\n       resolvedPathname = decodePathParams(resolvedPathname)\n     } catch (_) {}\n@@ -829,6 +845,7 @@ export abstract class RouteModule<\n       previewData,\n       pageIsDynamic,\n       resolvedPathname,\n+      encodedResolvedPathname,\n       isOnDemandRevalidate,\n       revalidateOnlyGenerated,\n       ...manifests,"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 22,
        "deletions": 4
    }
}