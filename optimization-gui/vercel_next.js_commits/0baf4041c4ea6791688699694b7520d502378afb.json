{
    "author": "kdy1",
    "message": "perf(turbopack): Do not allocate vectors if we are not going to use it (#80504)\n\n### What?\n\nAvoid allocations when we are not going to use it\n\n\n### Why?\n\n\n\nI think static tools can technically analyze all of these kinds of needless allocations, but I'm not sure, so I'll try to find them by hand.",
    "sha": "0baf4041c4ea6791688699694b7520d502378afb",
    "files": [
        {
            "sha": "9dc22d3b6f0b34f395a0f66307dc5a0c651120b4",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/0baf4041c4ea6791688699694b7520d502378afb/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0baf4041c4ea6791688699694b7520d502378afb/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=0baf4041c4ea6791688699694b7520d502378afb",
            "patch": "@@ -855,26 +855,31 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n                 return (None, None);\n             }\n             let len = inner.len();\n-            let mut meta = Vec::with_capacity(len);\n-            let mut data = Vec::with_capacity(len);\n+\n+            let meta_restored = inner.state().meta_restored();\n+            let data_restored = inner.state().data_restored();\n+\n+            let mut meta = meta_restored.then(|| Vec::with_capacity(len));\n+            let mut data = data_restored.then(|| Vec::with_capacity(len));\n             for (key, value) in inner.iter_all() {\n                 if key.is_persistent() && value.is_persistent() {\n                     match key.category() {\n                         TaskDataCategory::Meta => {\n-                            meta.push(CachedDataItem::from_key_and_value_ref(key, value))\n+                            if let Some(meta) = &mut meta {\n+                                meta.push(CachedDataItem::from_key_and_value_ref(key, value))\n+                            }\n                         }\n                         TaskDataCategory::Data => {\n-                            data.push(CachedDataItem::from_key_and_value_ref(key, value))\n+                            if let Some(data) = &mut data {\n+                                data.push(CachedDataItem::from_key_and_value_ref(key, value))\n+                            }\n                         }\n                         _ => {}\n                     }\n                 }\n             }\n \n-            (\n-                inner.state().meta_restored().then_some(meta),\n-                inner.state().data_restored().then_some(data),\n-            )\n+            (meta, data)\n         };\n         let process = |task_id: TaskId, (meta, data): (Option<Vec<_>>, Option<Vec<_>>)| {\n             ("
        }
    ],
    "stats": {
        "total": 21,
        "additions": 13,
        "deletions": 8
    }
}