{
    "author": "devjiwonchoi",
    "message": "[dev-tools] add restart dev server button to error overlay (#80060)\n\n### Why?\n\nWhen the user reloads on a specific error, and that error persists, we\nshow the restart server button as an option. This is because some errors\nare recoverable by restarting the server and rebuilding the app.\n\n\nhttps://github.com/user-attachments/assets/4e65d26c-8344-47b8-a6b9-1151008c271c\n\nWhen Turbopack persistent cache is enabled, it will also clear the\nbundler cache. This improves DX by replacing the need to run `rm -rf\n.next` manually.\n\n\nhttps://github.com/user-attachments/assets/e3f08176-5e9e-41fc-a8ce-9e731a45a6f2\n\nCloses NEXT-4477\n\n---------\n\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>\nCo-authored-by: Sebastian \"Sebbie\" Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "3b3d5eeea4efdade5740940c9ef82d8481b296ff",
    "files": [
        {
            "sha": "9e5d5f2e5e51f9bfa78011e5704529fc10e78ce8",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=3b3d5eeea4efdade5740940c9ef82d8481b296ff",
            "patch": "@@ -286,6 +286,8 @@ export function getDefineEnv({\n       : {}),\n     'process.env.__NEXT_DEVTOOL_SEGMENT_EXPLORER':\n       config.experimental.devtoolSegmentExplorer ?? false,\n+    'process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE':\n+      config.experimental.turbopackPersistentCaching ?? false,\n   }\n \n   const userDefines = config.compiler?.define ?? {}"
        },
        {
            "sha": "a6df3bb4ac1cc766f2e63b10ce338c73ca114fd4",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/error-overlay-toolbar/error-overlay-toolbar.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx?ref=3b3d5eeea4efdade5740940c9ef82d8481b296ff",
            "patch": "@@ -2,6 +2,7 @@ import type { DebugInfo } from '../../../../types'\n import { NodejsInspectorButton } from './nodejs-inspector-button'\n import { CopyStackTraceButton } from './copy-stack-trace-button'\n import { DocsLinkButton } from './docs-link-button'\n+import { RestartServerButton } from './restart-server-button'\n \n type ErrorOverlayToolbarProps = {\n   error: Error\n@@ -14,6 +15,7 @@ export function ErrorOverlayToolbar({\n }: ErrorOverlayToolbarProps) {\n   return (\n     <span className=\"error-overlay-toolbar\">\n+      <RestartServerButton error={error} />\n       <CopyStackTraceButton error={error} />\n       <DocsLinkButton errorMessage={error.message} />\n       <NodejsInspectorButton"
        },
        {
            "sha": "0993e194363e168a44dfc56996ce2774c9249e7e",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/error-overlay-toolbar/restart-server-button.tsx",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx?ref=3b3d5eeea4efdade5740940c9ef82d8481b296ff",
            "patch": "@@ -0,0 +1,79 @@\n+import { useState, useEffect } from 'react'\n+import { RefreshClockWise } from '../../../icons/refresh-clock-wise'\n+\n+/**\n+ * When the user reloads on a specific error and that error persists, we show\n+ * the restart server button as an option. This is because some errors are\n+ * recoverable by restarting the server and rebuilding the app.\n+ *\n+ * When Turbopack persistent cache is enabled, it will also clear the bundler\n+ * cache. This improves DX by replacing the need to run `rm -rf .next` manually.\n+ */\n+export function RestartServerButton({ error }: { error: Error }) {\n+  const [showButton, setShowButton] = useState(false)\n+\n+  useEffect(() => {\n+    const ERROR_KEY = `__next_error_overlay:${window.location.pathname}:${error.message}`\n+\n+    setShowButton(sessionStorage.getItem(ERROR_KEY) === '1')\n+\n+    // When the user tries to reload, set the error key to the session storage.\n+    const handleBeforeUnload = () => {\n+      sessionStorage.setItem(ERROR_KEY, '1')\n+    }\n+    window.addEventListener('beforeunload', handleBeforeUnload)\n+    return () => {\n+      window.removeEventListener('beforeunload', handleBeforeUnload)\n+    }\n+  }, [error.message])\n+\n+  if (!showButton) {\n+    return null\n+  }\n+\n+  function handleClick() {\n+    let endpoint = '/__nextjs_restart_dev'\n+\n+    if (process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE) {\n+      endpoint = '/__nextjs_restart_dev?invalidatePersistentCache'\n+    }\n+\n+    // TODO: Use Client Action for transition indicator when DevTools is isolated.\n+    fetch(endpoint, {\n+      method: 'POST',\n+    }).then(() => {\n+      // TODO: poll server status and reload when the server is back up.\n+      // https://github.com/vercel/next.js/pull/80005\n+    })\n+  }\n+\n+  return (\n+    <button className=\"restart-dev-server-button\" onClick={handleClick}>\n+      <RefreshClockWise width={14} height={14} />\n+      Restart Dev Server\n+    </button>\n+  )\n+}\n+\n+export const RESTART_SERVER_BUTTON_STYLES = `\n+  .restart-dev-server-button {\n+    -webkit-font-smoothing: antialiased;\n+    display: flex;\n+    justify-content: center;\n+    align-items: center;\n+    gap: 4px;\n+\n+    height: var(--size-26);\n+    padding: 6px 8px 6px 6px;\n+    background: var(--color-amber-100);\n+    background-clip: padding-box;\n+    border: 1px solid var(--color-gray-alpha-400);\n+    box-shadow: var(--shadow-small);\n+    border-radius: var(--rounded-full);\n+\n+    color: var(--color-amber-900);\n+    font-size: var(--size-12);\n+    font-weight: 500;\n+    line-height: var(--size-16);\n+  }\n+`"
        },
        {
            "sha": "f9526dec8c983a1204105a396a877b7a9ba273ce",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/icons/refresh-clock-wise.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Ficons%2Frefresh-clock-wise.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Ficons%2Frefresh-clock-wise.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Ficons%2Frefresh-clock-wise.tsx?ref=3b3d5eeea4efdade5740940c9ef82d8481b296ff",
            "patch": "@@ -0,0 +1,10 @@\n+export function RefreshClockWise(props: React.SVGProps<SVGSVGElement>) {\n+  return (\n+    <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"currentColor\" {...props}>\n+      <path\n+        d=\"M4.30969 8.37891H2.38782C2.9805 10.3647 4.82188 11.8124 7.00012 11.8125C8.81977 11.8124 10.4043 10.8024 11.2228 9.30957L11.5382 8.73438L12.6896 9.36523L12.3741 9.94043L12.1681 10.2891C11.0815 11.993 9.17324 13.1249 7.00012 13.125C4.42207 13.1249 2.21747 11.5322 1.3136 9.27734V11.375H0.00109863V7.72266L0.0147705 7.58984C0.0760304 7.29089 0.340278 7.06641 0.657349 7.06641H4.30969V8.37891ZM7.00012 0.875C9.57685 0.875118 11.7819 2.46569 12.6866 4.71875V2.625H13.9991V6.27734C13.9991 6.63974 13.7053 6.93354 13.3429 6.93359H9.68958V5.62109H11.6115C11.0186 3.6356 9.17813 2.18763 7.00012 2.1875C5.17131 2.18757 3.57959 3.20771 2.76477 4.71289L2.45227 5.29004L1.29797 4.66504L1.61047 4.08789C2.64547 2.17605 4.67052 0.875068 7.00012 0.875Z\"\n+        fill=\"#A35200\"\n+      />\n+    </svg>\n+  )\n+}"
        },
        {
            "sha": "38951b4956599e1120e23c750e76da16c0cfbcd2",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/styles/component-styles.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fcomponent-styles.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b3d5eeea4efdade5740940c9ef82d8481b296ff/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fcomponent-styles.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fstyles%2Fcomponent-styles.tsx?ref=3b3d5eeea4efdade5740940c9ef82d8481b296ff",
            "patch": "@@ -23,6 +23,7 @@ import { DEV_TOOLS_INFO_ROUTE_INFO_STYLES } from '../components/errors/dev-tools\n import { DEV_TOOLS_INFO_USER_PREFERENCES_STYLES } from '../components/errors/dev-tools-indicator/dev-tools-info/user-preferences'\n import { DEV_TOOLS_INFO_RENDER_FILES_STYLES } from '../components/overview/segment-explorer'\n import { FADER_STYLES } from '../components/fader'\n+import { RESTART_SERVER_BUTTON_STYLES } from '../components/errors/error-overlay-toolbar/restart-server-button'\n \n export function ComponentStyles() {\n   return (\n@@ -45,6 +46,7 @@ export function ComponentStyles() {\n         ${containerErrorStyles}\n         ${containerRuntimeErrorStyles}\n         ${versionStaleness}\n+        ${RESTART_SERVER_BUTTON_STYLES}\n         ${DEV_TOOLS_INDICATOR_STYLES}\n         ${DEV_TOOLS_INFO_STYLES}\n         ${DEV_TOOLS_INFO_TURBOPACK_INFO_STYLES}"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 95,
        "deletions": 0
    }
}