{
    "author": "unstubbable",
    "message": "Unhook WebSocket (#82931)\n\nCurrently, the WebSocket that's used for `next dev` is created in a React hook inside of the `HotReload` component, which is (transitively) rendered by the `ServerRoot` component, but only after the initial RSC response is processed, at least partially.\r\n\r\nThis creates a problem when integrating React's debug channel, because the root model of the RSC payload will be blocked until the associated debug info has been received through the debug channel. Since we will be using the existing WebSocket connection for the debug channel, we need to establish it before the `ServerRoot` component is rendered to avoid a deadlock.\r\n\r\nThe next-devtools dispatcher does queue events before React has provided the `dispatch` function in `DevOverlayRoot`. So creating the WebSocket outside of rendering is already supported in that regard.\r\n\r\ncloses NAR-323",
    "sha": "d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
    "files": [
        {
            "sha": "d264cdc04eb0cc6056f619d34cde9891c89c721d",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -780,5 +780,9 @@\n   \"779\": \"Route %s used \\\"searchParams\\\" inside \\\"use cache\\\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \\\"searchParams\\\" outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n   \"780\": \"Invariant: failed to find parent dynamic route for notFound route %s\",\n   \"781\": \"No LRU node to remove\",\n-  \"782\": \"Failed to find the root directory of the project. This is a bug in Next.js.\"\n+  \"782\": \"Failed to find the root directory of the project. This is a bug in Next.js.\",\n+  \"783\": \"Expected document.currentScript to be a <script> element. Received %s instead.\",\n+  \"784\": \"Expected document.currentScript src to contain '/_next/'. Received %s instead.\",\n+  \"785\": \"Expected webSocket to be defined in dev mode.\",\n+  \"786\": \"Expected staticIndicatorState to be defined in dev mode.\"\n }"
        },
        {
            "sha": "8261c4b5fd016214763cd8eb45472cb55f357540",
            "filename": "packages/next/src/client/app-bootstrap.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-bootstrap.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -5,6 +5,7 @@\n  * - next/script with `beforeInteractive` strategy\n  */\n \n+import { getAssetPrefix } from './asset-prefix'\n import { setAttributesFromProps } from './set-attributes-from-props'\n \n const version = process.env.__NEXT_VERSION\n@@ -54,7 +55,9 @@ function loadScriptsInSequence(\n     })\n }\n \n-export function appBootstrap(hydrate: () => void) {\n+export function appBootstrap(hydrate: (assetPrefix: string) => void) {\n+  const assetPrefix = getAssetPrefix()\n+\n   loadScriptsInSequence((self as any).__next_s, () => {\n     // If the static shell is being debugged, skip hydration if the\n     // `__nextppronly` query is present. This is only enabled when the\n@@ -73,6 +76,6 @@ export function appBootstrap(hydrate: () => void) {\n       }\n     }\n \n-    hydrate()\n+    hydrate(assetPrefix)\n   })\n }"
        },
        {
            "sha": "87daad696b9998b3972e6ff092df53e46bb0e88f",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 25,
            "deletions": 3,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -21,6 +21,7 @@ import type { InitialRSCPayload } from '../shared/lib/app-router-types'\n import { createInitialRouterState } from './components/router-reducer/create-initial-router-state'\n import { MissingSlotContext } from '../shared/lib/app-router-context.shared-runtime'\n import { setAppBuildId } from './app-build-id'\n+import type { StaticIndicatorState } from './dev/hot-reloader/app/hot-reloader-app'\n \n /// <reference types=\"react-dom/experimental\" />\n \n@@ -160,8 +161,12 @@ const initialServerResponse = createFromReadableStream<InitialRSCPayload>(\n \n function ServerRoot({\n   pendingActionQueue,\n+  webSocket,\n+  staticIndicatorState,\n }: {\n   pendingActionQueue: Promise<AppRouterActionQueue>\n+  webSocket: WebSocket | undefined\n+  staticIndicatorState: StaticIndicatorState | undefined\n }): React.ReactNode {\n   const initialRSCPayload = use(initialServerResponse)\n   const actionQueue = use<AppRouterActionQueue>(pendingActionQueue)\n@@ -170,7 +175,8 @@ function ServerRoot({\n     <AppRouter\n       actionQueue={actionQueue}\n       globalErrorState={initialRSCPayload.G}\n-      assetPrefix={initialRSCPayload.p}\n+      webSocket={webSocket}\n+      staticIndicatorState={staticIndicatorState}\n     />\n   )\n \n@@ -225,8 +231,20 @@ export type ClientInstrumentationHooks = {\n }\n \n export function hydrate(\n-  instrumentationHooks: ClientInstrumentationHooks | null\n+  instrumentationHooks: ClientInstrumentationHooks | null,\n+  assetPrefix: string\n ) {\n+  let staticIndicatorState: StaticIndicatorState | undefined\n+  let webSocket: WebSocket | undefined\n+\n+  if (process.env.NODE_ENV !== 'production') {\n+    const { createWebSocket } =\n+      require('./dev/hot-reloader/app/web-socket') as typeof import('./dev/hot-reloader/app/web-socket')\n+\n+    staticIndicatorState = { pathname: null, appIsrManifest: {} }\n+    webSocket = createWebSocket(assetPrefix, staticIndicatorState)\n+  }\n+\n   // React overrides `.then` and doesn't return a new promise chain,\n   // so we wrap the action queue in a promise to ensure that its value\n   // is defined when the promise resolves.\n@@ -266,7 +284,11 @@ export function hydrate(\n     <StrictModeIfEnabled>\n       <HeadManagerContext.Provider value={{ appDir: true }}>\n         <Root>\n-          <ServerRoot pendingActionQueue={pendingActionQueue} />\n+          <ServerRoot\n+            pendingActionQueue={pendingActionQueue}\n+            webSocket={webSocket}\n+            staticIndicatorState={staticIndicatorState}\n+          />\n         </Root>\n       </HeadManagerContext.Provider>\n     </StrictModeIfEnabled>"
        },
        {
            "sha": "9263f88ac53e7c82285cecd3af5f91fe89d4197d",
            "filename": "packages/next/src/client/app-next-dev.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -10,10 +10,10 @@ import { isRecoverableError } from './react-client-callbacks/on-recoverable-erro\n // eslint-disable-next-line @next/internal/typechecked-require\n const instrumentationHooks = require('../lib/require-instrumentation-client')\n \n-appBootstrap(() => {\n+appBootstrap((assetPrefix) => {\n   const { hydrate } = require('./app-index') as typeof import('./app-index')\n   try {\n-    hydrate(instrumentationHooks)\n+    hydrate(instrumentationHooks, assetPrefix)\n   } finally {\n     renderAppDevOverlay(getOwnerStack, isRecoverableError)\n   }"
        },
        {
            "sha": "098739c58edaace55dcacdf795b080f5b929e62b",
            "filename": "packages/next/src/client/app-next-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -7,10 +7,10 @@ window.next.turbopack = true\n // eslint-disable-next-line @next/internal/typechecked-require\n const instrumentationHooks = require('../lib/require-instrumentation-client')\n \n-appBootstrap(() => {\n+appBootstrap((assetPrefix) => {\n   const { hydrate } = require('./app-index') as typeof import('./app-index')\n   try {\n-    hydrate(instrumentationHooks)\n+    hydrate(instrumentationHooks, assetPrefix)\n   } finally {\n     if (process.env.NODE_ENV !== 'production') {\n       const { getOwnerStack } ="
        },
        {
            "sha": "7747df02c14911b2caa25ad4909c73b9ca090921",
            "filename": "packages/next/src/client/app-next.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -7,12 +7,12 @@ const instrumentationHooks =\n   // eslint-disable-next-line @next/internal/typechecked-require -- not a module\n   require('../lib/require-instrumentation-client')\n \n-appBootstrap(() => {\n+appBootstrap((assetPrefix) => {\n   const { hydrate } = require('./app-index') as typeof import('./app-index')\n   // Include app-router and layout-router in the main chunk\n   // eslint-disable-next-line @next/internal/typechecked-require -- Why not relative imports?\n   require('next/dist/client/components/app-router')\n   // eslint-disable-next-line @next/internal/typechecked-require -- Why not relative imports?\n   require('next/dist/client/components/layout-router')\n-  hydrate(instrumentationHooks)\n+  hydrate(instrumentationHooks, assetPrefix)\n })"
        },
        {
            "sha": "bc5d551f8a859a31b37e9adaa55dee601c3ea760",
            "filename": "packages/next/src/client/asset-prefix.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fasset-prefix.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fasset-prefix.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fasset-prefix.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -0,0 +1,22 @@\n+import { InvariantError } from '../shared/lib/invariant-error'\n+\n+export function getAssetPrefix() {\n+  const currentScript = document.currentScript\n+\n+  if (!(currentScript instanceof HTMLScriptElement)) {\n+    throw new InvariantError(\n+      `Expected document.currentScript to be a <script> element. Received ${currentScript} instead.`\n+    )\n+  }\n+\n+  const { pathname } = new URL(currentScript.src)\n+  const nextIndex = pathname.indexOf('/_next/')\n+\n+  if (nextIndex === -1) {\n+    throw new InvariantError(\n+      `Expected document.currentScript src to contain '/_next/'. Received ${currentScript.src} instead.`\n+    )\n+  }\n+\n+  return pathname.slice(0, nextIndex)\n+}"
        },
        {
            "sha": "8925cb8876af7a20b501cb11e74a1c452eb3715a",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -47,6 +47,7 @@ import { pingVisibleLinks } from './links'\n import RootErrorBoundary from './errors/root-error-boundary'\n import DefaultGlobalError from './builtin/global-error'\n import { RootLayoutBoundary } from '../../lib/framework/boundary-components'\n+import type { StaticIndicatorState } from '../dev/hot-reloader/app/hot-reloader-app'\n \n const globalMutable: {\n   pendingMpaPath?: string\n@@ -196,12 +197,14 @@ function Head({\n  */\n function Router({\n   actionQueue,\n-  assetPrefix,\n   globalError,\n+  webSocket,\n+  staticIndicatorState,\n }: {\n   actionQueue: AppRouterActionQueue\n-  assetPrefix: string\n   globalError: GlobalErrorState\n+  webSocket: WebSocket | undefined\n+  staticIndicatorState: StaticIndicatorState | undefined\n }) {\n   const state = useActionQueue(actionQueue)\n   const { canonicalUrl } = state\n@@ -524,7 +527,11 @@ function Router({\n       ).default\n \n     content = (\n-      <HotReloader assetPrefix={assetPrefix} globalError={globalError}>\n+      <HotReloader\n+        globalError={globalError}\n+        webSocket={webSocket}\n+        staticIndicatorState={staticIndicatorState}\n+      >\n         {content}\n       </HotReloader>\n     )\n@@ -570,19 +577,22 @@ function Router({\n export default function AppRouter({\n   actionQueue,\n   globalErrorState,\n-  assetPrefix,\n+  webSocket,\n+  staticIndicatorState,\n }: {\n   actionQueue: AppRouterActionQueue\n   globalErrorState: GlobalErrorState\n-  assetPrefix: string\n+  webSocket?: WebSocket\n+  staticIndicatorState?: StaticIndicatorState\n }) {\n   useNavFailureHandler()\n \n   const router = (\n     <Router\n       actionQueue={actionQueue}\n-      assetPrefix={assetPrefix}\n       globalError={globalErrorState}\n+      webSocket={webSocket}\n+      staticIndicatorState={staticIndicatorState}\n     />\n   )\n "
        },
        {
            "sha": "cf7700f625297e88341fe21bff27f2e48011f2a9",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 49,
            "deletions": 98,
            "changes": 147,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -1,26 +1,19 @@\n /// <reference types=\"webpack/module.d.ts\" />\n \n import type { ReactNode } from 'react'\n-import { useEffect, startTransition, useRef } from 'react'\n+import { useEffect, startTransition } from 'react'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import formatWebpackMessages from '../../../../shared/lib/format-webpack-messages'\n-import { useRouter } from '../../../components/navigation'\n import {\n   REACT_REFRESH_FULL_RELOAD,\n   REACT_REFRESH_FULL_RELOAD_FROM_ERROR,\n-  reportInvalidHmrMessage,\n } from '../shared'\n import { dispatcher } from 'next/dist/compiled/next-devtools'\n import { ReplaySsrOnlyErrors } from '../../../../next-devtools/userspace/app/errors/replay-ssr-only-errors'\n import { AppDevOverlayErrorBoundary } from '../../../../next-devtools/userspace/app/app-dev-overlay-error-boundary'\n import { useErrorHandler } from '../../../../next-devtools/userspace/app/errors/use-error-handler'\n import { RuntimeErrorHandler } from '../../runtime-error-handler'\n-import {\n-  useSendMessage,\n-  useTurbopack,\n-  useWebSocket,\n-  useWebSocketPing,\n-} from './web-socket'\n+import { useWebSocketPing } from './web-socket'\n import { HMR_ACTIONS_SENT_TO_BROWSER } from '../../../../server/dev/hot-reloader-types'\n import type {\n   HMR_ACTION_TYPES,\n@@ -30,8 +23,16 @@ import { useUntrackedPathname } from '../../../components/navigation-untracked'\n import reportHmrLatency from '../../report-hmr-latency'\n import { TurbopackHmr } from '../turbopack-hot-reloader-common'\n import { NEXT_HMR_REFRESH_HASH_COOKIE } from '../../../components/app-router-headers'\n-import type { GlobalErrorState } from '../../../components/app-router-instance'\n-import { useForwardConsoleLog } from '../../../../next-devtools/userspace/app/errors/use-forward-console-log'\n+import {\n+  publicAppRouterInstance,\n+  type GlobalErrorState,\n+} from '../../../components/app-router-instance'\n+import { InvariantError } from '../../../../shared/lib/invariant-error'\n+\n+export interface StaticIndicatorState {\n+  pathname: string | null\n+  appIsrManifest: Record<string, true>\n+}\n \n let mostRecentCompilationHash: any = null\n let __nextDevClientId = Math.round(Math.random() * 100 + Date.now())\n@@ -95,7 +96,10 @@ function afterApplyUpdates(fn: any) {\n   }\n }\n \n-function performFullReload(err: any, sendMessage: any) {\n+export function performFullReload(\n+  err: any,\n+  sendMessage: (data: string) => void\n+) {\n   const stackTrace =\n     err &&\n     ((err.stack && err.stack.split('\\n').slice(0, 5).join('\\n')) ||\n@@ -192,13 +196,11 @@ function tryApplyUpdatesWebpack(sendMessage: (message: string) => void) {\n }\n \n /** Handles messages from the server for the App Router. */\n-function processMessage(\n+export function processMessage(\n   obj: HMR_ACTION_TYPES,\n   sendMessage: (message: string) => void,\n   processTurbopackMessage: (msg: TurbopackMsgToBrowser) => void,\n-  router: ReturnType<typeof useRouter>,\n-  appIsrManifestRef: ReturnType<typeof useRef>,\n-  pathnameRef: ReturnType<typeof useRef>\n+  staticIndicatorState: StaticIndicatorState\n ) {\n   if (!('action' in obj)) {\n     return\n@@ -251,18 +253,19 @@ function processMessage(\n   switch (obj.action) {\n     case HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST: {\n       if (process.env.__NEXT_DEV_INDICATOR) {\n-        if (appIsrManifestRef) {\n-          appIsrManifestRef.current = obj.data\n-\n-          // handle initial status on receiving manifest\n-          // navigation is handled in useEffect for pathname changes\n-          // as we'll receive the updated manifest before usePathname\n-          // triggers for new value\n-          if ((pathnameRef.current as string) in obj.data) {\n-            dispatcher.onStaticIndicator(true)\n-          } else {\n-            dispatcher.onStaticIndicator(false)\n-          }\n+        staticIndicatorState.appIsrManifest = obj.data\n+\n+        // handle initial status on receiving manifest\n+        // navigation is handled in useEffect for pathname changes\n+        // as we'll receive the updated manifest before usePathname\n+        // triggers for new value\n+        if (\n+          staticIndicatorState.pathname &&\n+          staticIndicatorState.pathname in obj.data\n+        ) {\n+          dispatcher.onStaticIndicator(true)\n+        } else {\n+          dispatcher.onStaticIndicator(false)\n         }\n       }\n       break\n@@ -401,7 +404,7 @@ function processMessage(\n       }\n \n       startTransition(() => {\n-        router.hmrRefresh()\n+        publicAppRouterInstance.hmrRefresh()\n         dispatcher.onRefresh()\n       })\n \n@@ -430,7 +433,7 @@ function processMessage(\n     case HMR_ACTIONS_SENT_TO_BROWSER.REMOVED_PAGE: {\n       turbopackHmr?.onPageAddRemove()\n       // TODO-APP: potentially only refresh if the currently viewed page was added/removed.\n-      return router.hmrRefresh()\n+      return publicAppRouterInstance.hmrRefresh()\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ERROR: {\n       const { errorJSON } = obj\n@@ -456,96 +459,44 @@ function processMessage(\n }\n \n export default function HotReload({\n-  assetPrefix,\n   children,\n   globalError,\n+  webSocket,\n+  staticIndicatorState,\n }: {\n-  assetPrefix: string\n   children: ReactNode\n   globalError: GlobalErrorState\n+  webSocket: WebSocket | undefined\n+  staticIndicatorState: StaticIndicatorState | undefined\n }) {\n   useErrorHandler(dispatcher.onUnhandledError, dispatcher.onUnhandledRejection)\n-\n-  const webSocketRef = useWebSocket(assetPrefix)\n-\n-  useWebSocketPing(webSocketRef)\n-  const sendMessage = useSendMessage(webSocketRef)\n-  useForwardConsoleLog(webSocketRef)\n-  const processTurbopackMessage = useTurbopack(sendMessage, (err) =>\n-    performFullReload(err, sendMessage)\n-  )\n-\n-  const router = useRouter()\n+  useWebSocketPing(webSocket)\n \n   // We don't want access of the pathname for the dev tools to trigger a dynamic\n   // access (as the dev overlay will never be present in production).\n   const pathname = useUntrackedPathname()\n-  const appIsrManifestRef = useRef<Record<string, false | number>>({})\n-  const pathnameRef = useRef(pathname)\n \n   if (process.env.__NEXT_DEV_INDICATOR) {\n     // this conditional is only for dead-code elimination which\n     // isn't a runtime conditional only build-time so ignore hooks rule\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n     useEffect(() => {\n-      pathnameRef.current = pathname\n-\n-      const appIsrManifest = appIsrManifestRef.current\n-\n-      if (appIsrManifest) {\n-        if (pathname && pathname in appIsrManifest) {\n-          try {\n-            dispatcher.onStaticIndicator(true)\n-          } catch (reason) {\n-            let message = ''\n-\n-            if (reason instanceof DOMException) {\n-              // Most likely a SecurityError, because of an unavailable localStorage\n-              message = reason.stack ?? reason.message\n-            } else if (reason instanceof Error) {\n-              message = 'Error: ' + reason.message + '\\n' + (reason.stack ?? '')\n-            } else {\n-              message = 'Unexpected Exception: ' + reason\n-            }\n-\n-            console.warn('[HMR] ' + message)\n-          }\n-        } else {\n-          dispatcher.onStaticIndicator(false)\n-        }\n+      if (!staticIndicatorState) {\n+        throw new InvariantError(\n+          'Expected staticIndicatorState to be defined in dev mode.'\n+        )\n       }\n-    }, [pathname])\n-  }\n \n-  useEffect(() => {\n-    const websocket = webSocketRef.current\n-    if (!websocket) return\n+      staticIndicatorState.pathname = pathname\n \n-    const handler = (event: MessageEvent<any>) => {\n-      try {\n-        const obj = JSON.parse(event.data)\n-        processMessage(\n-          obj,\n-          sendMessage,\n-          processTurbopackMessage,\n-          router,\n-          appIsrManifestRef,\n-          pathnameRef\n-        )\n-      } catch (err: unknown) {\n-        reportInvalidHmrMessage(event, err)\n+      if (pathname && pathname in staticIndicatorState.appIsrManifest) {\n+        dispatcher.onStaticIndicator(true)\n+      } else {\n+        dispatcher.onStaticIndicator(false)\n       }\n-    }\n+    }, [pathname, staticIndicatorState])\n+  }\n \n-    websocket.addEventListener('message', handler)\n-    return () => websocket.removeEventListener('message', handler)\n-  }, [\n-    sendMessage,\n-    router,\n-    webSocketRef,\n-    processTurbopackMessage,\n-    appIsrManifestRef,\n-  ])\n   return (\n     <AppDevOverlayErrorBoundary globalError={globalError}>\n       <ReplaySsrOnlyErrors onBlockingError={dispatcher.openErrorOverlay} />"
        },
        {
            "sha": "36c3aa024beb8f4b39a2335a94e4c695ab2dc769",
            "filename": "packages/next/src/client/dev/hot-reloader/app/web-socket.ts",
            "status": "modified",
            "additions": 86,
            "deletions": 80,
            "changes": 166,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fweb-socket.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -1,101 +1,105 @@\n-import { useCallback, useContext, useEffect, useRef } from 'react'\n+import { useContext, useEffect } from 'react'\n import { GlobalLayoutRouterContext } from '../../../../shared/lib/app-router-context.shared-runtime'\n import { getSocketUrl } from '../get-socket-url'\n import type { TurbopackMsgToBrowser } from '../../../../server/dev/hot-reloader-types'\n+import { reportInvalidHmrMessage } from '../shared'\n+import {\n+  performFullReload,\n+  processMessage,\n+  type StaticIndicatorState,\n+} from './hot-reloader-app'\n+import {\n+  isTerminalLoggingEnabled,\n+  logQueue,\n+} from '../../../../next-devtools/userspace/app/forward-logs'\n+import { InvariantError } from '../../../../shared/lib/invariant-error'\n \n-export function useWebSocket(assetPrefix: string) {\n-  const webSocketRef = useRef<WebSocket>(undefined)\n+export function createWebSocket(\n+  assetPrefix: string,\n+  staticIndicatorState: StaticIndicatorState\n+) {\n+  const url = getSocketUrl(assetPrefix)\n+  const webSocket = new window.WebSocket(`${url}/_next/webpack-hmr`)\n \n-  useEffect(() => {\n-    if (webSocketRef.current) {\n-      return\n+  if (isTerminalLoggingEnabled) {\n+    webSocket.addEventListener('open', () => {\n+      logQueue.onSocketReady(webSocket)\n+    })\n+  }\n+\n+  const sendMessage = (data: string) => {\n+    if (webSocket.readyState === webSocket.OPEN) {\n+      webSocket.send(data)\n     }\n+  }\n \n-    const url = getSocketUrl(assetPrefix)\n+  const processTurbopackMessage = createProcessTurbopackMessage(sendMessage)\n \n-    webSocketRef.current = new window.WebSocket(`${url}/_next/webpack-hmr`)\n-  }, [assetPrefix])\n+  webSocket.addEventListener('message', (event) => {\n+    try {\n+      const obj = JSON.parse(event.data)\n+      processMessage(\n+        obj,\n+        sendMessage,\n+        processTurbopackMessage,\n+        staticIndicatorState\n+      )\n+    } catch (err: unknown) {\n+      reportInvalidHmrMessage(event, err)\n+    }\n+  })\n \n-  return webSocketRef\n+  return webSocket\n }\n \n-export function useSendMessage(webSocketRef: ReturnType<typeof useWebSocket>) {\n-  const sendMessage = useCallback(\n-    (data: string) => {\n-      const socket = webSocketRef.current\n-      if (!socket || socket.readyState !== socket.OPEN) {\n-        return\n-      }\n-      return socket.send(data)\n-    },\n-    [webSocketRef]\n-  )\n-  return sendMessage\n-}\n+export function createProcessTurbopackMessage(\n+  sendMessage: (data: string) => void\n+): (msg: TurbopackMsgToBrowser) => void {\n+  if (!process.env.TURBOPACK) {\n+    return () => {}\n+  }\n \n-export function useTurbopack(\n-  sendMessage: ReturnType<typeof useSendMessage>,\n-  onUpdateError: (err: unknown) => void\n-) {\n-  const turbopackState = useRef<{\n-    init: boolean\n-    queue: Array<TurbopackMsgToBrowser> | undefined\n-    callback: ((msg: TurbopackMsgToBrowser) => void) | undefined\n-  }>({\n-    init: false,\n-    // Until the dynamic import resolves, queue any turbopack messages which will be replayed.\n-    queue: [],\n-    callback: undefined,\n-  })\n+  let queue: TurbopackMsgToBrowser[] = []\n+  let callback: ((msg: TurbopackMsgToBrowser) => void) | undefined\n \n-  const processTurbopackMessage = useCallback((msg: TurbopackMsgToBrowser) => {\n-    const { callback, queue } = turbopackState.current\n+  const processTurbopackMessage = (msg: TurbopackMsgToBrowser) => {\n     if (callback) {\n       callback(msg)\n     } else {\n-      queue!.push(msg)\n+      queue.push(msg)\n     }\n-  }, [])\n+  }\n \n-  useEffect(() => {\n-    const { current: initCurrent } = turbopackState\n-    // TODO(WEB-1589): only install if `process.turbopack` set.\n-    if (initCurrent.init) {\n-      return\n-    }\n-    initCurrent.init = true\n-\n-    import(\n-      // @ts-expect-error requires \"moduleResolution\": \"node16\" in tsconfig.json and not .ts extension\n-      '@vercel/turbopack-ecmascript-runtime/browser/dev/hmr-client/hmr-client.ts'\n-    ).then(({ connect }) => {\n-      const { current } = turbopackState\n-      connect({\n-        addMessageListener(cb: (msg: TurbopackMsgToBrowser) => void) {\n-          current.callback = cb\n-\n-          // Replay all Turbopack messages before we were able to establish the HMR client.\n-          for (const msg of current.queue!) {\n-            cb(msg)\n-          }\n-          current.queue = undefined\n-        },\n-        sendMessage,\n-        onUpdateError,\n-      })\n+  import(\n+    // @ts-expect-error requires \"moduleResolution\": \"node16\" in tsconfig.json and not .ts extension\n+    '@vercel/turbopack-ecmascript-runtime/browser/dev/hmr-client/hmr-client.ts'\n+  ).then(({ connect }) => {\n+    connect({\n+      addMessageListener(cb: (msg: TurbopackMsgToBrowser) => void) {\n+        callback = cb\n+\n+        // Replay all Turbopack messages before we were able to establish the HMR client.\n+        for (const msg of queue) {\n+          cb(msg)\n+        }\n+        queue.length = 0\n+      },\n+      sendMessage,\n+      onUpdateError: (err: unknown) => performFullReload(err, sendMessage),\n     })\n-  }, [sendMessage, onUpdateError])\n+  })\n \n   return processTurbopackMessage\n }\n \n-export function useWebSocketPing(\n-  webSocketRef: ReturnType<typeof useWebSocket>\n-) {\n-  const sendMessage = useSendMessage(webSocketRef)\n+export function useWebSocketPing(webSocket: WebSocket | undefined) {\n   const { tree } = useContext(GlobalLayoutRouterContext)\n \n   useEffect(() => {\n+    if (!webSocket) {\n+      throw new InvariantError('Expected webSocket to be defined in dev mode.')\n+    }\n+\n     // Never send pings when using Turbopack as it's not used.\n     // Pings were originally used to keep track of active routes in on-demand-entries with webpack.\n     if (process.env.TURBOPACK) {\n@@ -104,14 +108,16 @@ export function useWebSocketPing(\n \n     // Taken from on-demand-entries-client.js\n     const interval = setInterval(() => {\n-      sendMessage(\n-        JSON.stringify({\n-          event: 'ping',\n-          tree,\n-          appDirRoute: true,\n-        })\n-      )\n+      if (webSocket.readyState === webSocket.OPEN) {\n+        webSocket.send(\n+          JSON.stringify({\n+            event: 'ping',\n+            tree,\n+            appDirRoute: true,\n+          })\n+        )\n+      }\n     }, 2500)\n     return () => clearInterval(interval)\n-  }, [tree, sendMessage])\n+  }, [tree, webSocket])\n }"
        },
        {
            "sha": "6d842c9f4d305e8170661523f6a3b0b904866215",
            "filename": "packages/next/src/next-devtools/userspace/app/errors/use-forward-console-log.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 26,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/94f422e480ac20de0abb9f1b860ca5f8a62c90e4/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fuse-forward-console-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f422e480ac20de0abb9f1b860ca5f8a62c90e4/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fuse-forward-console-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fuse-forward-console-log.ts?ref=94f422e480ac20de0abb9f1b860ca5f8a62c90e4",
            "patch": "@@ -1,26 +0,0 @@\n-import { useEffect } from 'react'\n-import { isTerminalLoggingEnabled, logQueue } from '../forward-logs'\n-import type { useWebSocket } from '../../../../client/dev/hot-reloader/app/web-socket'\n-\n-export const useForwardConsoleLog = (\n-  socketRef: ReturnType<typeof useWebSocket>\n-) => {\n-  useEffect(() => {\n-    if (!isTerminalLoggingEnabled) {\n-      return\n-    }\n-    const socket = socketRef.current\n-    if (!socket) {\n-      return\n-    }\n-\n-    const onOpen = () => {\n-      logQueue.onSocketReady(socket)\n-    }\n-    socket.addEventListener('open', onOpen)\n-\n-    return () => {\n-      socket.removeEventListener('open', onOpen)\n-    }\n-  }, [socketRef])\n-}"
        },
        {
            "sha": "d07e26e82d1a5b09092112b75d6ab4a778abeb0a",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -1171,7 +1171,6 @@ async function getRSCPayload(\n     // See the comment above the `Preloads` component (below) for why this is part of the payload\n     P: <Preloads preloadCallbacks={preloadCallbacks} />,\n     b: ctx.sharedContext.buildId,\n-    p: ctx.assetPrefix,\n     c: prepareInitialCanonicalUrl(url),\n     i: !!couldBeIntercepted,\n     f: [\n@@ -1293,7 +1292,6 @@ async function getErrorRSCPayload(\n \n   return {\n     b: ctx.sharedContext.buildId,\n-    p: ctx.assetPrefix,\n     c: prepareInitialCanonicalUrl(url),\n     m: undefined,\n     i: false,\n@@ -1372,11 +1370,7 @@ function App<T>({\n       }}\n     >\n       <ServerInsertedHTMLProvider>\n-        <AppRouter\n-          actionQueue={actionQueue}\n-          globalErrorState={response.G}\n-          assetPrefix={response.p}\n-        />\n+        <AppRouter actionQueue={actionQueue} globalErrorState={response.G} />\n       </ServerInsertedHTMLProvider>\n     </HeadManagerContext.Provider>\n   )\n@@ -1426,11 +1420,7 @@ function ErrorApp<T>({\n \n   return (\n     <ServerInsertedHTMLProvider>\n-      <AppRouter\n-        actionQueue={actionQueue}\n-        globalErrorState={response.G}\n-        assetPrefix={response.p}\n-      />\n+      <AppRouter actionQueue={actionQueue} globalErrorState={response.G} />\n     </ServerInsertedHTMLProvider>\n   )\n }\n@@ -1542,7 +1532,7 @@ async function renderToHTMLOrFlightImpl(\n   if (process.env.NODE_ENV === 'development') {\n     // reset isr status at start of request\n     const { pathname } = new URL(req.url || '/', 'http://n')\n-    renderOpts.setIsrStatus?.(pathname, null)\n+    renderOpts.setIsrStatus?.(pathname, false)\n   }\n \n   if ("
        },
        {
            "sha": "eeed2e205d2e34c63f2ffb01b7e5a5669d3e1ebb",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -93,7 +93,7 @@ export interface RenderOptsPartial {\n   }\n   isOnDemandRevalidate?: boolean\n   isPossibleServerAction?: boolean\n-  setIsrStatus?: (key: string, value: boolean | null) => void\n+  setIsrStatus?: (key: string, value: boolean) => void\n   isRevalidate?: boolean\n   nextExport?: boolean\n   nextConfigOutput?: 'standalone' | 'export'"
        },
        {
            "sha": "0b7cf6d7b7421265fdbe9ace37b1edc58d73243f",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -119,7 +119,7 @@ export interface TurbopackConnectedAction {\n \n export interface AppIsrManifestAction {\n   action: HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST\n-  data: Record<string, boolean>\n+  data: Record<string, true>\n }\n \n export interface DevToolsConfigAction {"
        },
        {
            "sha": "0067e50e822a933c4540da2799ad7da305a73d63",
            "filename": "packages/next/src/server/lib/dev-bundler-service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -11,7 +11,7 @@ import { HMR_ACTIONS_SENT_TO_BROWSER } from '../dev/hot-reloader-types'\n  * bundler while in development.\n  */\n export class DevBundlerService {\n-  public appIsrManifestInner: InstanceType<typeof LRUCache<boolean>>\n+  public appIsrManifestInner: InstanceType<typeof LRUCache<true>>\n \n   constructor(\n     private readonly bundler: DevBundler,\n@@ -85,7 +85,7 @@ export class DevBundlerService {\n   }\n \n   public get appIsrManifest() {\n-    const serializableManifest: Record<string, boolean> = {}\n+    const serializableManifest: Record<string, true> = {}\n \n     for (const [key, value] of this.appIsrManifestInner) {\n       serializableManifest[key] = value\n@@ -94,8 +94,8 @@ export class DevBundlerService {\n     return serializableManifest\n   }\n \n-  public setIsrStatus(key: string, value: boolean | null) {\n-    if (value === null) {\n+  public setIsrStatus(key: string, value: boolean) {\n+    if (value === false) {\n       this.appIsrManifestInner.remove(key)\n     } else {\n       this.appIsrManifestInner.set(key, value)"
        },
        {
            "sha": "bed8f901770240f60a43dae0c0ccbf2fa06f0bbf",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -39,7 +39,7 @@ export type RouterServerContext = Record<\n     // allow dev server to log with original stack\n     logErrorWithOriginalStack?: (err: unknown, type: string) => void\n     // allow setting ISR status in dev\n-    setIsrStatus?: (key: string, value: boolean | null) => void\n+    setIsrStatus?: (key: string, value: boolean) => void\n   }\n >\n "
        },
        {
            "sha": "6d9df62d3bf9760254bb9fcea0f6473f58be61bb",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -265,7 +265,7 @@ export type RenderOptsPartial = {\n   assetQueryString?: string\n   resolvedUrl?: string\n   resolvedAsPath?: string\n-  setIsrStatus?: (key: string, value: boolean | null) => void\n+  setIsrStatus?: (key: string, value: boolean) => void\n   clientReferenceManifest?: DeepReadonly<ClientReferenceManifest>\n   nextFontManifest?: DeepReadonly<NextFontManifest>\n   distDir?: string\n@@ -662,7 +662,7 @@ export async function renderToHTMLImpl(\n     }\n \n     if (renderOpts?.setIsrStatus) {\n-      renderOpts.setIsrStatus(asPath, isSSG || isAutoExport ? true : null)\n+      renderOpts.setIsrStatus(asPath, isSSG || isAutoExport)\n     }\n   }\n "
        },
        {
            "sha": "bf78f87c38521484df0d24cf9bd27422d22c943b",
            "filename": "packages/next/src/shared/lib/app-router-types.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -258,8 +258,6 @@ export type ActionResult = Promise<any>\n export type InitialRSCPayload = {\n   /** buildId */\n   b: string\n-  /** assetPrefix */\n-  p: string\n   /** initialCanonicalUrlParts */\n   c: string[]\n   /** couldBeIntercepted */"
        },
        {
            "sha": "8b78ef15ff8b42c5e689eacd3f447cfc497d5b5d",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8d3b2e07e51d0962c9e82adb61c638b3d903d58/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=d8d3b2e07e51d0962c9e82adb61c638b3d903d58",
            "patch": "@@ -214,7 +214,7 @@ describe('Error overlay for hydration errors in App router', () => {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <HotReload assetPrefix=\"\" globalError={[...]}>\n+           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n              <AppDevOverlayErrorBoundary globalError={[...]}>\n                <ReplaySsrOnlyErrors>\n                <DevRootHTTPAccessFallbackBoundary>\n@@ -251,7 +251,7 @@ describe('Error overlay for hydration errors in App router', () => {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <HotReload assetPrefix=\"\" globalError={[...]}>\n+           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n              <AppDevOverlayErrorBoundary globalError={[...]}>\n                <ReplaySsrOnlyErrors>\n                <DevRootHTTPAccessFallbackBoundary>\n@@ -1092,7 +1092,7 @@ describe('Error overlay for hydration errors in App router', () => {\n          },\n          {\n            \"componentStack\": \"...\n-           <HotReload assetPrefix=\"\" globalError={[...]}>\n+           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n              <AppDevOverlayErrorBoundary globalError={[...]}>\n                <ReplaySsrOnlyErrors>\n                <DevRootHTTPAccessFallbackBoundary>\n@@ -1155,7 +1155,7 @@ describe('Error overlay for hydration errors in App router', () => {\n          },\n          {\n            \"componentStack\": \"...\n-           <HotReload assetPrefix=\"\" globalError={[...]}>\n+           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n              <AppDevOverlayErrorBoundary globalError={[...]}>\n                <ReplaySsrOnlyErrors>\n                <DevRootHTTPAccessFallbackBoundary>"
        }
    ],
    "stats": {
        "total": 480,
        "additions": 230,
        "deletions": 250
    }
}