{
    "author": "eps1lon",
    "message": "[app] Send errors not handled by explicit error boundaries through `reportError` (#76101)",
    "sha": "871ca31e60bd31ad2fabfb014aa614089384adca",
    "files": [
        {
            "sha": "f3179106714ab473b0428e13ce0b5fcc6daef8ae",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -244,11 +244,11 @@ function Root({ children }: React.PropsWithChildren<{}>) {\n   return children\n }\n \n-const reactRootOptions = {\n+const reactRootOptions: ReactDOMClient.RootOptions = {\n   onRecoverableError,\n   onCaughtError,\n   onUncaughtError,\n-} satisfies ReactDOMClient.RootOptions\n+}\n \n export function hydrate() {\n   const reactEl = ("
        },
        {
            "sha": "d40ec7b0585ced9e8c06460ba0eddb9d4b51e895",
            "filename": "packages/next/src/client/components/globals/intercept-console-error.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobals%2Fintercept-console-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobals%2Fintercept-console-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobals%2Fintercept-console-error.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -3,7 +3,7 @@ import { isNextRouterError } from '../is-next-router-error'\n import { handleClientError } from '../errors/use-error-handler'\n import { parseConsoleArgs } from '../../lib/console'\n \n-export const originConsoleError = window.console.error\n+export const originConsoleError = globalThis.console.error\n \n // Patch console.error to collect information about hydration errors\n export function patchConsoleError() {"
        },
        {
            "sha": "553fc611b71515aaf350d33a08be8beb58a4d659",
            "filename": "packages/next/src/client/react-client-callbacks/error-boundary-callbacks.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 24,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -1,22 +1,41 @@\n // This file is only used in app router due to the specific error state handling.\n \n-import type { HydrationOptions } from 'react-dom/client'\n+import type { ErrorInfo } from 'react'\n import { getReactStitchedError } from '../components/errors/stitched-error'\n import { handleClientError } from '../components/errors/use-error-handler'\n import { isNextRouterError } from '../components/is-next-router-error'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n import { reportGlobalError } from './report-global-error'\n import { originConsoleError } from '../components/globals/intercept-console-error'\n+import { AppDevOverlayErrorBoundary } from '../components/react-dev-overlay/app/app-dev-overlay-error-boundary'\n+import {\n+  ErrorBoundaryHandler,\n+  GlobalError as DefaultErrorBoundary,\n+} from '../components/error-boundary'\n+\n+export function onCaughtError(\n+  err: unknown,\n+  errorInfo: ErrorInfo & { errorBoundary?: React.Component }\n+) {\n+  const errorBoundaryComponent = errorInfo.errorBoundary?.constructor\n+\n+  const isImplicitErrorBoundary =\n+    (process.env.NODE_ENV !== 'production' &&\n+      errorBoundaryComponent === AppDevOverlayErrorBoundary) ||\n+    (errorBoundaryComponent === ErrorBoundaryHandler &&\n+      (errorInfo.errorBoundary! as InstanceType<typeof ErrorBoundaryHandler>)\n+        .props.errorComponent === DefaultErrorBoundary)\n+  if (isImplicitErrorBoundary) {\n+    // We don't consider errors caught unless they're caught by an explicit error\n+    // boundary. The built-in ones are considered implicit.\n+    // This mimics how the same app would behave without Next.js.\n+    return onUncaughtError(err, errorInfo)\n+  }\n \n-export const onCaughtError: HydrationOptions['onCaughtError'] = (\n-  err,\n-  errorInfo\n-) => {\n   // Skip certain custom errors which are not expected to be reported on client\n   if (isBailoutToCSRError(err) || isNextRouterError(err)) return\n \n   if (process.env.NODE_ENV !== 'production') {\n-    const errorBoundaryComponent = errorInfo?.errorBoundary?.constructor\n     const errorBoundaryName =\n       // read react component displayName\n       (errorBoundaryComponent as any)?.displayName ||\n@@ -57,35 +76,19 @@ export const onCaughtError: HydrationOptions['onCaughtError'] = (\n   }\n }\n \n-export const onUncaughtError: HydrationOptions['onUncaughtError'] = (\n-  err,\n-  errorInfo\n-) => {\n+export function onUncaughtError(err: unknown, errorInfo: React.ErrorInfo) {\n   // Skip certain custom errors which are not expected to be reported on client\n   if (isBailoutToCSRError(err) || isNextRouterError(err)) return\n \n   if (process.env.NODE_ENV !== 'production') {\n-    const componentThatErroredFrame = errorInfo?.componentStack?.split('\\n')[1]\n-\n-    // Match chrome or safari stack trace\n-    const matches =\n-      componentThatErroredFrame?.match(/\\s+at (\\w+)\\s+|(\\w+)@/) ?? []\n-    const componentThatErroredName = matches[1] || matches[2] || 'Unknown'\n-\n-    // Create error location with errored component and error boundary, to match the behavior of default React onCaughtError handler.\n-    const errorLocation = componentThatErroredName\n-      ? `The above error occurred in the <${componentThatErroredName}> component.`\n-      : `The above error occurred in one of your components.`\n-\n     const stitchedError = getReactStitchedError(err)\n     // TODO: change to passing down errorInfo later\n     // In development mode, pass along the component stack to the error\n     if (errorInfo.componentStack) {\n       ;(stitchedError as any)._componentStack = errorInfo.componentStack\n     }\n \n-    // Log and report the error with location but without modifying the error stack\n-    originConsoleError('%o\\n\\n%s', err, errorLocation)\n+    // TODO: Add an adendum to the overlay telling people about custom error boundaries.\n     reportGlobalError(stitchedError)\n   } else {\n     reportGlobalError(err)"
        },
        {
            "sha": "e0ef6c10466e88aabfefd59ebfe96e28531ed08f",
            "filename": "packages/next/src/client/react-client-callbacks/report-global-error.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Freport-global-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Freport-global-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Freport-global-error.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -4,5 +4,6 @@ export const reportGlobalError =\n       // emulating an uncaught JavaScript error.\n       reportError\n     : (error: unknown) => {\n-        window.console.error(error)\n+        // TODO: Dispatch error event\n+        globalThis.console.error(error)\n       }"
        },
        {
            "sha": "2f5c37e28080534200da365931582385fb92f244",
            "filename": "test/development/app-dir/owner-stack/owner-stack.test.ts",
            "status": "modified",
            "additions": 123,
            "deletions": 142,
            "changes": 265,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fowner-stack%2Fowner-stack.test.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -1,112 +1,83 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  openRedbox,\n-  getRedboxDescription,\n-  hasRedboxCallStack,\n-} from 'next-test-utils'\n-\n-// TODO: parse the location and assert them in the future\n+import { assertNoRedbox, retry } from 'next-test-utils'\n+\n // Remove the location `()` part in every line of stack trace;\n // Remove the leading spaces in every line of stack trace;\n // Remove the trailing spaces in every line of stack trace;\n-function normalizeStackTrace(trace: string) {\n+// These stacks are not sourcemapped and therefore not ignore-listed.\n+// Feel free to update internal frames in assertions.\n+function normalizeBrowserConsoleStackTrace(trace: unknown) {\n+  if (typeof trace !== 'string') {\n+    return trace\n+  }\n   return trace\n     .replace(/\\(.*\\)/g, '')\n     .replace(/^\\s+/gm, '')\n     .trim()\n }\n \n-async function getStackFramesContent(browser) {\n-  await hasRedboxCallStack(browser)\n-  const stackFrameElements = await browser.elementsByCss(\n-    '[data-nextjs-call-stack-frame]'\n-  )\n-  const stackFramesContent = (\n-    await Promise.all(\n-      stackFrameElements.map(async (frame) => {\n-        const functionNameEl = await frame.$('[data-nextjs-frame-expanded]')\n-        const sourceEl = await frame.$('[data-has-source]')\n-        const functionName = functionNameEl\n-          ? await functionNameEl.innerText()\n-          : ''\n-        const source = sourceEl ? await sourceEl.innerText() : ''\n-\n-        if (!functionName) {\n-          return ''\n-        }\n-        return `at ${functionName} (${source})`\n-      })\n-    )\n-  )\n-    .filter(Boolean)\n-    .join('\\n')\n-\n-  return stackFramesContent\n-}\n-\n describe('app-dir - owner-stack', () => {\n-  const { next } = nextTestSetup({\n+  const { isTurbopack, next } = nextTestSetup({\n     files: __dirname,\n   })\n \n   it('should log stitched error for browser uncaught errors', async () => {\n-    const browser = await next.browser('/browser/uncaught')\n-\n-    await assertHasRedbox(browser)\n+    let errorStack: string | undefined\n+    const browser = await next.browser('/browser/uncaught', {\n+      beforePageLoad: (page) => {\n+        page.on('pageerror', (error: unknown) => {\n+          errorStack = (error as any).stack\n+        })\n+      },\n+    })\n+\n+    if (!isTurbopack) {\n+      // Wait for Redbox to settle.\n+      // TODO: Don't reload when landing on a faulty page.\n+      // The issue may be that we receive an HMR update at all on landing.\n+      // This is flaky. Sometimes we miss that the reload happened.\n+      await retry(\n+        async () => {\n+          const logs = await browser.log()\n+          expect(logs).toEqual(\n+            expect.arrayContaining([\n+              expect.objectContaining({\n+                message:\n+                  '[Fast Refresh] performing full reload because your application had an unrecoverable error',\n+              }),\n+            ])\n+          )\n+        },\n+        1000,\n+        200\n+      ).catch(() => {})\n+    }\n \n-    const stackFramesContent = await getStackFramesContent(browser)\n-    expect(stackFramesContent).toMatchInlineSnapshot(`\n-     \"at useThrowError (app/browser/uncaught/page.js (5:11))\n-     at useErrorHook (app/browser/uncaught/page.js (10:3))\n-     at Page (app/browser/uncaught/page.js (14:3))\"\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: browser error\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/browser/uncaught/page.js (5:11) @ useThrowError\n+     > 5 |     throw new Error('browser error')\n+         |           ^\",\n+       \"stack\": [\n+         \"useThrowError app/browser/uncaught/page.js (5:11)\",\n+         \"useErrorHook app/browser/uncaught/page.js (10:3)\",\n+         \"Page app/browser/uncaught/page.js (14:3)\",\n+       ],\n+     }\n     `)\n \n-    const logs = await browser.log()\n-    const errorLog = logs.find((log) => {\n-      return log.message.includes('Error: browser error')\n-    }).message\n-\n-    if (process.env.TURBOPACK) {\n-      expect(normalizeStackTrace(errorLog)).toMatchInlineSnapshot(`\n-          \"%o\n-          %s Error: browser error\n-          at useThrowError \n-          at useErrorHook \n-          at Page \n-          at react-stack-bottom-frame \n-          at renderWithHooks \n-          at updateFunctionComponent \n-          at beginWork \n-          at runWithFiberInDEV \n-          at performUnitOfWork \n-          at workLoopSync \n-          at renderRootSync \n-          at performWorkOnRoot \n-          at performWorkOnRootViaSchedulerTask \n-          at MessagePort.performWorkUntilDeadline  The above error occurred in the <Page> component. It was handled by the <AppDevOverlayErrorBoundary> error boundary.\"\n-        `)\n-    } else {\n-      expect(normalizeStackTrace(errorLog)).toMatchInlineSnapshot(`\n-          \"%o\n-          %s Error: browser error\n-          at useThrowError \n-          at useErrorHook \n-          at Page \n-          at react-stack-bottom-frame \n-          at renderWithHooks \n-          at updateFunctionComponent \n-          at beginWork \n-          at runWithFiberInDEV \n-          at performUnitOfWork \n-          at workLoopSync \n-          at renderRootSync \n-          at performWorkOnRoot \n-          at performWorkOnRootViaSchedulerTask \n-          at MessagePort.performWorkUntilDeadline  The above error occurred in the <Page> component. It was handled by the <AppDevOverlayErrorBoundary> error boundary.\"\n-      `)\n-    }\n+    expect(normalizeBrowserConsoleStackTrace(errorStack))\n+      .toMatchInlineSnapshot(`\n+     \"Error: browser error\n+     at useThrowError \n+     at useErrorHook \n+     at Page \n+     at ClientPageRoot\"\n+    `)\n   })\n \n   it('should log stitched error for browser caught errors', async () => {\n@@ -119,19 +90,26 @@ describe('app-dir - owner-stack', () => {\n       return log.message.includes('Error: browser error')\n     }).message\n \n-    await openRedbox(browser)\n-\n-    const stackFramesContent = await getStackFramesContent(browser)\n-\n-    expect(stackFramesContent).toMatchInlineSnapshot(`\n-     \"at useThrowError (app/browser/caught/page.js (34:11))\n-     at useErrorHook (app/browser/caught/page.js (39:3))\n-     at Thrower (app/browser/caught/page.js (29:3))\n-     at Inner (app/browser/caught/page.js (23:7))\n-     at Page (app/browser/caught/page.js (43:10))\"\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: browser error\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/browser/caught/page.js (34:11) @ useThrowError\n+     > 34 |     throw new Error('browser error')\n+          |           ^\",\n+       \"stack\": [\n+         \"useThrowError app/browser/caught/page.js (34:11)\",\n+         \"useErrorHook app/browser/caught/page.js (39:3)\",\n+         \"Thrower app/browser/caught/page.js (29:3)\",\n+         \"Inner app/browser/caught/page.js (23:7)\",\n+         \"Page app/browser/caught/page.js (43:10)\",\n+       ],\n+     }\n     `)\n \n-    expect(normalizeStackTrace(errorLog)).toMatchInlineSnapshot(`\n+    expect(normalizeBrowserConsoleStackTrace(errorLog)).toMatchInlineSnapshot(`\n       \"%o\n       %s Error: browser error\n       at useThrowError \n@@ -152,52 +130,55 @@ describe('app-dir - owner-stack', () => {\n   })\n \n   it('should log stitched error for SSR errors', async () => {\n-    const browser = await next.browser('/ssr')\n-\n-    await assertHasRedbox(browser)\n-\n-    const stackFramesContent = await getStackFramesContent(browser)\n-    expect(stackFramesContent).toMatchInlineSnapshot(`\n-     \"at useThrowError (app/ssr/page.js (4:9))\n-     at useErrorHook (app/ssr/page.js (8:3))\n-     at Page (app/ssr/page.js (12:3))\"\n+    let errorStack: string | undefined\n+    const browser = await next.browser('/ssr', {\n+      beforePageLoad: (page) => {\n+        page.on('pageerror', (error: unknown) => {\n+          errorStack = (error as any).stack\n+        })\n+      },\n+    })\n+\n+    // TODO(veil): Should only display one error.\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 2,\n+       \"description\": \"Error: ssr error\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/ssr/page.js (4:9) @ useThrowError\n+     > 4 |   throw new Error('ssr error')\n+         |         ^\",\n+       \"stack\": [\n+         \"useThrowError app/ssr/page.js (4:9)\",\n+         \"useErrorHook app/ssr/page.js (8:3)\",\n+         \"Page app/ssr/page.js (12:3)\",\n+       ],\n+     }\n     `)\n \n-    const logs = await browser.log()\n-    const errorLog = logs.find((log) => {\n-      return log.message.includes('Error: ssr error')\n-    }).message\n-\n-    expect(normalizeStackTrace(errorLog)).toMatchInlineSnapshot(`\n-       \"%o\n-       %s Error: ssr error\n-       at useThrowError \n-       at useErrorHook \n-       at Page \n-       at react-stack-bottom-frame \n-       at renderWithHooks \n-       at updateFunctionComponent \n-       at beginWork \n-       at runWithFiberInDEV \n-       at performUnitOfWork \n-       at workLoopSync \n-       at renderRootSync \n-       at performWorkOnRoot \n-       at performWorkOnRootViaSchedulerTask \n-       at MessagePort.performWorkUntilDeadline  The above error occurred in the <Page> component. It was handled by the <AppDevOverlayErrorBoundary> error boundary.\"\n-      `)\n+    expect(normalizeBrowserConsoleStackTrace(errorStack))\n+      .toMatchInlineSnapshot(`\n+     \"Error: ssr error\n+     at useThrowError \n+     at useErrorHook \n+     at Page \n+     at ClientPageRoot\"\n+    `)\n   })\n \n   it('should capture unhandled promise rejections', async () => {\n     const browser = await next.browser('/browser/reject-promise')\n \n-    await openRedbox(browser)\n-\n-    const description = await getRedboxDescription(browser)\n-    expect(description).toMatchInlineSnapshot(`\"string in rejected promise\"`)\n-\n-    // Promise rejection has no owner stack\n-    const stackFramesContent = await getStackFramesContent(browser)\n-    expect(stackFramesContent).toMatchInlineSnapshot(`\"\"`)\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"string in rejected promise\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n+       \"source\": null,\n+       \"stack\": [],\n+     }\n+    `)\n   })\n })"
        },
        {
            "sha": "ef968c68116d3d470d0c50018e2dc9626a4cf0dd",
            "filename": "test/development/pages-dir/client-navigation/index.test.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 23,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Findex.test.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -1,22 +1,14 @@\n /* eslint-env jest */\n \n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  fetchViaHTTP,\n-  getRedboxSource,\n-  getRedboxHeader,\n-  waitFor,\n-  check,\n-} from 'next-test-utils'\n+import { assertNoRedbox, fetchViaHTTP, waitFor, check } from 'next-test-utils'\n import webdriver, { BrowserInterface } from 'next-webdriver'\n import path from 'path'\n import { nextTestSetup } from 'e2e-utils'\n \n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n describe('Client Navigation', () => {\n-  const { next } = nextTestSetup({\n+  const { isTurbopack, next } = nextTestSetup({\n     files: path.join(__dirname, 'fixture'),\n     env: {\n       TEST_STRICT_NEXT_HEAD: String(true),\n@@ -281,10 +273,16 @@ describe('Client Navigation', () => {\n           },\n         })\n         await browser.elementByCss('#empty-props').click()\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch(\n-          /should resolve to an object\\. But found \"null\" instead\\./\n-        )\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: \"EmptyInitialPropsPage.getInitialProps()\" should resolve to an object. But found \"null\" instead.\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Unhandled Runtime Error\",\n+           \"source\": null,\n+           \"stack\": [],\n+         }\n+        `)\n         expect(pageErrors).toEqual([\n           expect.objectContaining({\n             message:\n@@ -1393,11 +1391,20 @@ describe('Client Navigation', () => {\n             })\n           },\n         })\n-        await assertHasRedbox(browser)\n-        const text = await getRedboxSource(browser)\n-        expect(text).toMatch(/An Expected error occurred/)\n-        expect(text).toMatch(/pages[\\\\/]error-inside-browser-page\\.js \\(5:13\\)/)\n-\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: An Expected error occurred\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Unhandled Runtime Error\",\n+           \"source\": \"pages/error-inside-browser-page.js (5:13) @ ErrorInRenderPage.render\n+         > 5 |       throw new Error('An Expected error occurred')\n+             |             ^\",\n+           \"stack\": [\n+             \"ErrorInRenderPage.render pages/error-inside-browser-page.js (5:13)\",\n+           ],\n+         }\n+        `)\n         expect(pageErrors).toEqual(\n           isReact18\n             ? [\n@@ -1437,10 +1444,42 @@ describe('Client Navigation', () => {\n             },\n           }\n         )\n-        await assertHasRedbox(browser)\n-        const text = await getRedboxSource(browser)\n-        expect(text).toMatch(/An Expected error occurred/)\n-        expect(text).toMatch(/error-in-the-browser-global-scope\\.js \\(2:9\\)/)\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayRedbox(`\n+           {\n+             \"count\": 1,\n+             \"description\": \"Error: An Expected error occurred\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Unhandled Runtime Error\",\n+             \"source\": \"pages/error-in-the-browser-global-scope.js (2:9) @ [project]/pages/error-in-the-browser-global-scope.js [client] (ecmascript)\n+           > 2 |   throw new Error('An Expected error occurred')\n+               |         ^\",\n+             \"stack\": [\n+               \"[project]/pages/error-in-the-browser-global-scope.js [client] (ecmascript) pages/error-in-the-browser-global-scope.js (2:9)\",\n+             ],\n+           }\n+          `)\n+        } else {\n+          await expect(browser).toDisplayRedbox(`\n+           {\n+             \"count\": 1,\n+             \"description\": \"Error: An Expected error occurred\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Unhandled Runtime Error\",\n+             \"source\": \"pages/error-in-the-browser-global-scope.js (2:9) @ eval\n+           > 2 |   throw new Error('An Expected error occurred')\n+               |         ^\",\n+             \"stack\": [\n+               \"eval pages/error-in-the-browser-global-scope.js (2:9)\",\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+               \"<FIXME-file-protocol>\",\n+             ],\n+           }\n+          `)\n+        }\n         expect(pageErrors).toEqual([\n           expect.objectContaining({ message: 'An Expected error occurred' }),\n         ])"
        },
        {
            "sha": "5163503d1296ed333fbecb203f965ebf0d429bbc",
            "filename": "test/e2e/app-dir/errors/index.test.ts",
            "status": "modified",
            "additions": 54,
            "deletions": 16,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { assertHasRedbox, getRedboxHeader, retry } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n describe('app-dir - errors', () => {\n@@ -174,8 +174,20 @@ describe('app-dir - errors', () => {\n       await browser.elementByCss('#error-trigger-button').click()\n \n       if (isNextDev) {\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch(/this is a test/)\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: this is a test\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Unhandled Runtime Error\",\n+           \"source\": \"app/global-error-boundary/client/page.js (8:11) @ Page\n+         >  8 |     throw new Error('this is a test')\n+              |           ^\",\n+           \"stack\": [\n+             \"Page app/global-error-boundary/client/page.js (8:11)\",\n+           ],\n+         }\n+        `)\n       } else {\n         expect(\n           await browser.waitForElementByCss('body').elementByCss('h2').text()\n@@ -184,8 +196,11 @@ describe('app-dir - errors', () => {\n         )\n       }\n \n-      // FIXME(veil): Should contain thrown error.\n-      expect(pageErrors).toEqual([])\n+      expect(pageErrors).toEqual([\n+        expect.objectContaining({\n+          message: 'this is a test',\n+        }),\n+      ])\n     })\n \n     it('should display error digest for error in server component with default error boundary', async () => {\n@@ -199,8 +214,20 @@ describe('app-dir - errors', () => {\n       })\n \n       if (isNextDev) {\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch(/custom server error/)\n+        await expect(browser).toDisplayRedbox(`\n+          {\n+            \"count\": 1,\n+            \"description\": \"Error: custom server error\",\n+            \"environmentLabel\": \"Server\",\n+            \"label\": \"Unhandled Runtime Error\",\n+            \"source\": \"app/global-error-boundary/server/page.js (2:9) @ Page\n+          > 2 |   throw Error('custom server error')\n+              |         ^\",\n+            \"stack\": [\n+              \"Page app/global-error-boundary/server/page.js (2:9)\",\n+            ],\n+          }\n+        `)\n       } else {\n         expect(\n           await browser.waitForElementByCss('body').elementByCss('h2').text()\n@@ -212,8 +239,15 @@ describe('app-dir - errors', () => {\n         ).toMatch(/Digest: \\w+/)\n       }\n \n-      // FIXME(veil): Should contain thrown error.\n-      expect(pageErrors).toEqual([])\n+      expect(pageErrors).toEqual([\n+        expect.objectContaining({\n+          message: isNextDev\n+            ? 'custom server error'\n+            : 'An error occurred in the Server Components render. ' +\n+              'The specific message is omitted in production builds to avoid leaking sensitive details. ' +\n+              'A digest property is included on this error instance which may provide additional details about the nature of the error.',\n+        }),\n+      ])\n     })\n \n     // production tests\n@@ -244,13 +278,17 @@ describe('app-dir - errors', () => {\n       })\n \n       it('should hydrate empty shell to handle server-side rendering errors', async () => {\n-        const browser = await next.browser('/ssr-error-client-component')\n-        const logs = await browser.log()\n-        const errors = logs\n-          .filter((x) => x.source === 'error')\n-          .map((x) => x.message)\n-          .join('\\n')\n-        expect(errors).toInclude('Error during SSR')\n+        const pageErrors: unknown[] = []\n+        await next.browser('/ssr-error-client-component', {\n+          beforePageLoad: (page) => {\n+            page.on('pageerror', (error: unknown) => {\n+              pageErrors.push(error)\n+            })\n+          },\n+        })\n+        expect(pageErrors).toEqual([\n+          expect.objectContaining({ message: 'Error during SSR' }),\n+        ])\n       })\n \n       it('should log the original RSC error trace in production', async () => {"
        },
        {
            "sha": "5a43c869d2b1312bf96f4231483a80f1216a41df",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/871ca31e60bd31ad2fabfb014aa614089384adca/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=871ca31e60bd31ad2fabfb014aa614089384adca",
            "patch": "@@ -30,6 +30,7 @@ declare global {\n        * Unintented content in the snapshot should be reported to the Next.js DX team.\n        * `<FIXME-internal-frame>` in the snapshot would be unintended.\n        * `<FIXME-project-root>` in the snapshot would be unintended.\n+       * `<FIXME-file-protocol>` in the snapshot would be unintended.\n        * Any node_modules in the snapshot would be unintended.\n        * Differences in the snapshot between Turbopack and Webpack would be unintended.\n        *\n@@ -48,6 +49,7 @@ declare global {\n        * Unintented content in the snapshot should be reported to the Next.js DX team.\n        * `<FIXME-internal-frame>` in the snapshot would be unintended.\n        * `<FIXME-project-root>` in the snapshot would be unintended.\n+       * `<FIXME-file-protocol>` in the snapshot would be unintended.\n        * Any node_modules in the snapshot would be unintended.\n        * Differences in the snapshot between Turbopack and Webpack would be unintended.\n        *"
        }
    ],
    "stats": {
        "total": 482,
        "additions": 273,
        "deletions": 209
    }
}