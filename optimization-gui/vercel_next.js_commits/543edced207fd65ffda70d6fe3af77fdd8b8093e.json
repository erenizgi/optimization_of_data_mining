{
    "author": "lukesandberg",
    "message": "[turbopack] Move global names onto the NativeFunction object (#81143)\n\n### What?\n\nInstead of a global `&'static NativeFunction`->`&'static str` map, just put the names onto the `NativeFunction` struct and delete the global map.\n\n### Why?\n\nUsing a RwLock means every read requires a `fetch_add` to update the reader count, so if lookups are performed on multiple threads we can expect contention on the RwLock reader count.\n\nUsing a OnceLock instead just means we need to perform a consistent read which shouldn't trigger cross processor cache traffic.\n\nI don't know that this is a problem, and if it is it would only show up during PC serialization.",
    "sha": "543edced207fd65ffda70d6fe3af77fdd8b8093e",
    "files": [
        {
            "sha": "ee9bdb30af4633270eabc4da56048861202e46f5",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -213,7 +213,7 @@ mod ser {\n                 unreachable!();\n             };\n             let mut state = serializer.serialize_seq(Some(2))?;\n-            state.serialize_element(&registry::get_function_global_name(native_fn))?;\n+            state.serialize_element(native_fn.global_name())?;\n             let arg = *arg;\n             let arg = native_fn.arg_meta.as_serialize(arg);\n             state.serialize_element(arg)?;"
        },
        {
            "sha": "6b6a08097a4e789c21feed1b45741e241464dec2",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -1,4 +1,5 @@\n-use std::{fmt::Debug, hash::Hash, pin::Pin};\n+use core::panic;\n+use std::{fmt::Debug, hash::Hash, pin::Pin, sync::OnceLock};\n \n use anyhow::Result;\n use futures::Future;\n@@ -159,6 +160,8 @@ pub struct NativeFunction {\n     /// The functor that creates a functor from inputs. The inner functor\n     /// handles the task execution.\n     pub(crate) implementation: Box<dyn TaskFn + Send + Sync + 'static>,\n+\n+    global_name: OnceLock<&'static str>,\n }\n \n impl Debug for NativeFunction {\n@@ -184,6 +187,7 @@ impl NativeFunction {\n             function_meta,\n             arg_meta: ArgMeta::new::<Inputs>(),\n             implementation: Box::new(implementation.into_task_fn()),\n+            global_name: Default::default(),\n         }\n     }\n \n@@ -206,6 +210,7 @@ impl NativeFunction {\n                 ArgMeta::new::<Inputs>()\n             },\n             implementation: Box::new(implementation.into_task_fn()),\n+            global_name: Default::default(),\n         }\n     }\n \n@@ -229,6 +234,7 @@ impl NativeFunction {\n                 ArgMeta::new::<Inputs>()\n             },\n             implementation: Box::new(implementation.into_task_fn_with_this()),\n+            global_name: Default::default(),\n         }\n     }\n \n@@ -263,7 +269,20 @@ impl NativeFunction {\n         tracing::trace_span!(\"turbo_tasks::resolve_call\", name = self.name, flags = flags)\n     }\n \n+    /// Returns the global name for this object\n+    pub fn global_name(&self) -> &'static str {\n+        self.global_name\n+            .get()\n+            .expect(\"cannot call `global_name` unless `register` has already been called\")\n+    }\n+\n     pub fn register(&'static self, global_name: &'static str) {\n+        match self.global_name.set(global_name) {\n+            Ok(_) => {}\n+            Err(prev) => {\n+                panic!(\"function {global_name} registered twice, previously with {prev}\");\n+            }\n+        }\n         register_function(global_name, self);\n     }\n }"
        },
        {
            "sha": "0760ff36e135041c82e649cae7012b5a87bf33b4",
            "filename": "turbopack/crates/turbo-tasks/src/registry.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -14,8 +14,6 @@ use crate::{\n \n static NAME_TO_FUNCTION: Lazy<RwLock<FxHashMap<&'static str, &'static NativeFunction>>> =\n     Lazy::new(RwLock::default);\n-static FUNCTION_TO_NAME: Lazy<RwLock<FxHashMap<&'static NativeFunction, &'static str>>> =\n-    Lazy::new(RwLock::default);\n \n static VALUE_TYPE_ID_FACTORY: IdFactory<ValueTypeId> = IdFactory::new_const(\n     ValueTypeId::MIN.to_non_zero_u64(),\n@@ -78,8 +76,6 @@ where\n \n /// Registers a function so it is available for persistence\n pub fn register_function(global_name: &'static str, func: &'static NativeFunction) {\n-    let prev = FUNCTION_TO_NAME.write().unwrap().insert(func, global_name);\n-    debug_assert!(prev.is_none(), \"function {global_name} registered twice?\");\n     let prev = NAME_TO_FUNCTION.write().unwrap().insert(global_name, func);\n     debug_assert!(\n         prev.is_none(),\n@@ -91,10 +87,6 @@ pub fn get_function_by_global_name(global_name: &str) -> &'static NativeFunction\n     NAME_TO_FUNCTION.read().unwrap().get(global_name).unwrap()\n }\n \n-pub fn get_function_global_name(func: &'static NativeFunction) -> &'static str {\n-    FUNCTION_TO_NAME.read().unwrap().get(&func).unwrap()\n-}\n-\n pub fn register_value_type(\n     global_name: &'static str,\n     ty: &'static ValueType,"
        },
        {
            "sha": "7cb9985410a66955df1eb7db2eb24015100dbed0",
            "filename": "turbopack/crates/turbo-tasks/src/task_statistics.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -2,7 +2,7 @@ use std::sync::{Arc, OnceLock};\n \n use serde::{Serialize, Serializer, ser::SerializeMap};\n \n-use crate::{FxDashMap, macro_helpers::NativeFunction, registry};\n+use crate::{FxDashMap, macro_helpers::NativeFunction};\n \n /// An API for optionally enabling, updating, and reading aggregated statistics.\n #[derive(Default)]\n@@ -73,8 +73,7 @@ impl Serialize for TaskStatistics {\n     {\n         let mut map = serializer.serialize_map(Some(self.inner.len()))?;\n         for entry in &self.inner {\n-            let key = registry::get_function_global_name(entry.key());\n-            map.serialize_entry(key, entry.value())?;\n+            map.serialize_entry(entry.key().global_name(), entry.value())?;\n         }\n         map.end()\n     }"
        },
        {
            "sha": "4c2123be9540ba3ccc7f6f85d7f3979ac6abf408",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -57,11 +57,6 @@ use crate::{\n     },\n };\n \n-pub fn register() {\n-    turbopack::register();\n-    include!(concat!(env!(\"OUT_DIR\"), \"/register.rs\"));\n-}\n-\n type Backend = TurboTasksBackend<NoopBackingStorage>;\n \n pub struct TurbopackBuildBuilder {"
        },
        {
            "sha": "7065cdeb9106cc0cf3be412cdc0d6c754d3dc9ea",
            "filename": "turbopack/crates/turbopack-cli/src/dev/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/543edced207fd65ffda70d6fe3af77fdd8b8093e/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fmod.rs?ref=543edced207fd65ffda70d6fe3af77fdd8b8093e",
            "patch": "@@ -349,18 +349,13 @@ async fn source(\n     )))\n }\n \n-pub fn register() {\n-    turbopack::register();\n-    include!(concat!(env!(\"OUT_DIR\"), \"/register.rs\"));\n-}\n-\n /// Start a devserver with the given args.\n pub async fn start_server(args: &DevArguments) -> Result<()> {\n     let start = Instant::now();\n \n     #[cfg(feature = \"tokio_console\")]\n     console_subscriber::init();\n-    register();\n+    crate::register();\n \n     let NormalizedDirs {\n         project_dir,"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 24,
        "deletions": 24
    }
}