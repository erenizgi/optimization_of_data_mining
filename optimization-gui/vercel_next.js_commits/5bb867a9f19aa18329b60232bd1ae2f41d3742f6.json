{
    "author": "lubieowoce",
    "message": "fix: next/root-params erroring when rerendering after action (#82326)\n\nWhen implementing the check that disallows using `next/root-params` in\nserver actions, i forgot that when a page is rerendered after an action,\nthe render is still wrapped with an `actionAsyncStorage` with\n`actionStore.isAction === true`. The fix is to also check that we're in\nthe `'action'` phase, i.e. we haven't switched to rendering yet.\n\nCloses #82302",
    "sha": "5bb867a9f19aa18329b60232bd1ae2f41d3742f6",
    "files": [
        {
            "sha": "0be08c6e6ea6652a16494b7a651f2b17361c1451",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=5bb867a9f19aa18329b60232bd1ae2f41d3742f6",
            "patch": "@@ -771,5 +771,6 @@\n   \"770\": \"createParamsFromClient should not be called in a runtime prerender.\",\n   \"771\": \"\\\\`%s\\\\` was called during a runtime prerender. Next.js should be preventing %s from being included in server components statically, but did not in this case.\",\n   \"772\": \"FetchStrategy.PPRRuntime should never be used when `experimental.clientSegmentCache` is disabled\",\n-  \"773\": \"Missing workStore in createPrerenderParamsForClientSegment\"\n+  \"773\": \"Missing workStore in createPrerenderParamsForClientSegment\",\n+  \"774\": \"Route %s used %s outside of a Server Component. This is not allowed.\"\n }"
        },
        {
            "sha": "9bb919a714dd449cc20e8a7687bf61778830dd1a",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=5bb867a9f19aa18329b60232bd1ae2f41d3742f6",
            "patch": "@@ -203,6 +203,13 @@ export function getRootParam(paramName: string): Promise<ParamValue> {\n     throw new InvariantError(`Missing workStore in ${apiName}`)\n   }\n \n+  const workUnitStore = workUnitAsyncStorage.getStore()\n+  if (!workUnitStore) {\n+    throw new Error(\n+      `Route ${workStore.route} used ${apiName} outside of a Server Component. This is not allowed.`\n+    )\n+  }\n+\n   const actionStore = actionAsyncStorage.getStore()\n   if (actionStore) {\n     if (actionStore.isAppRoute) {\n@@ -211,23 +218,17 @@ export function getRootParam(paramName: string): Promise<ParamValue> {\n         `Route ${workStore.route} used ${apiName} inside a Route Handler. Support for this API in Route Handlers is planned for a future version of Next.js.`\n       )\n     }\n-    if (actionStore.isAction) {\n+    if (actionStore.isAction && workUnitStore.phase === 'action') {\n       // Actions are not fundamentally tied to a route (even if they're always submitted from some page),\n       // so root params would be inconsistent if an action is called from multiple roots.\n+      // Make sure we check if the phase is \"action\" - we should not error in the rerender\n+      // after an action revalidates or updates cookies (which will still have `actionStore.isAction === true`)\n       throw new Error(\n         `${apiName} was used inside a Server Action. This is not supported. Functions from 'next/root-params' can only be called in the context of a route.`\n       )\n     }\n   }\n \n-  const workUnitStore = workUnitAsyncStorage.getStore()\n-\n-  if (!workUnitStore) {\n-    throw new Error(\n-      `Route ${workStore.route} used ${apiName} in Pages Router. This API is only available within App Router.`\n-    )\n-  }\n-\n   switch (workUnitStore.type) {\n     case 'unstable-cache':\n     case 'cache': {"
        },
        {
            "sha": "af65f6ed8a4055b12d03d5fd897e215bc492ce27",
            "filename": "test/e2e/app-dir/app-root-params-getters/fixtures/simple/app/[lang]/[locale]/rerender-after-server-action/page.tsx",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fsimple%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frerender-after-server-action%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fsimple%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frerender-after-server-action%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fsimple%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Frerender-after-server-action%2Fpage.tsx?ref=5bb867a9f19aa18329b60232bd1ae2f41d3742f6",
            "patch": "@@ -0,0 +1,37 @@\n+import { lang, locale } from 'next/root-params'\n+import { connection } from 'next/server'\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+export default async function Page() {\n+  const currentLang = await lang()\n+  const currentLocale = await locale()\n+  return (\n+    <main>\n+      <div>\n+        Root params are{' '}\n+        <span id=\"root-params\">\n+          {currentLang} {currentLocale}\n+        </span>\n+      </div>\n+      <Suspense fallback=\"Loading...\">\n+        <Timestamp />\n+      </Suspense>\n+      <form\n+        action={async () => {\n+          'use server'\n+          // rerender the page and return it alongside the action result\n+          const cookieStore = await cookies()\n+          cookieStore.set('my-cookie', Date.now() + '')\n+        }}\n+      >\n+        <button type=\"submit\">Submit form</button>\n+      </form>\n+    </main>\n+  )\n+}\n+\n+async function Timestamp() {\n+  await connection()\n+  return <div id=\"timestamp\">{Date.now()}</div>\n+}"
        },
        {
            "sha": "2c9d11374714dd412a739d9af27dc9a2b715716a",
            "filename": "test/e2e/app-dir/app-root-params-getters/simple.test.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 2,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fsimple.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5bb867a9f19aa18329b60232bd1ae2f41d3742f6/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fsimple.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fsimple.test.ts?ref=5bb867a9f19aa18329b60232bd1ae2f41d3742f6",
            "patch": "@@ -6,6 +6,23 @@ import { outdent } from 'outdent'\n import { createRequestTracker } from '../../../lib/e2e-utils/request-tracker'\n \n describe('app-root-param-getters - simple', () => {\n+  let currentCliOutputIndex = 0\n+  beforeEach(() => {\n+    resetCliOutput()\n+  })\n+\n+  const getCliOutput = () => {\n+    if (next.cliOutput.length < currentCliOutputIndex) {\n+      // cliOutput shrank since we started the test, so something (like a `sandbox`) reset the logs\n+      currentCliOutputIndex = 0\n+    }\n+    return next.cliOutput.slice(currentCliOutputIndex)\n+  }\n+\n+  const resetCliOutput = () => {\n+    currentCliOutputIndex = next.cliOutput.length\n+  }\n+\n   const { next, isNextDev, isTurbopack, isNextDeploy } = nextTestSetup({\n     files: join(__dirname, 'fixtures', 'simple'),\n   })\n@@ -109,12 +126,55 @@ describe('app-root-param-getters - simple', () => {\n     )\n     expect(response.status()).toBe(500)\n     if (!isNextDeploy) {\n-      expect(next.cliOutput).toInclude(\n+      expect(getCliOutput()).toInclude(\n         \"`import('next/root-params').lang()` was used inside a Server Action. This is not supported. Functions from 'next/root-params' can only be called in the context of a route.\"\n       )\n     }\n   })\n \n+  it('should not error when rerendering the page after a server action', async () => {\n+    const params = { lang: 'en', locale: 'us' }\n+    const browser = await next.browser(\n+      `/${params.lang}/${params.locale}/rerender-after-server-action`\n+    )\n+    expect(await browser.elementById('root-params').text()).toBe(\n+      `${params.lang} ${params.locale}`\n+    )\n+    const initialDate = await browser.elementById('timestamp')\n+\n+    // Run a server action and rerender the page\n+    const tracker = createRequestTracker(browser)\n+    const [, response] = await tracker.captureResponse(\n+      async () => {\n+        await browser.elementByCss('button[type=\"submit\"]').click()\n+      },\n+      {\n+        request: {\n+          method: 'POST',\n+          pathname: `/${params.lang}/${params.locale}/rerender-after-server-action`,\n+        },\n+      }\n+    )\n+    // We're using lang() outside of an action, so we should see no errors\n+    expect(response.status()).toBe(200)\n+    if (!isNextDeploy) {\n+      expect(getCliOutput()).not.toInclude(\n+        \"`import('next/root-params').lang()` was used inside a Server Action. This is not supported. Functions from 'next/root-params' can only be called in the context of a route.\"\n+      )\n+    }\n+\n+    await retry(async () => {\n+      // The page should've been rerendered because of the cookie update\n+      const updatedDate = await browser.elementById('timestamp')\n+      expect(initialDate).not.toEqual(updatedDate)\n+    })\n+\n+    // It should still display correct root params\n+    expect(await browser.elementById('root-params').text()).toBe(\n+      `${params.lang} ${params.locale}`\n+    )\n+  })\n+\n   // TODO(root-params): add support for route handlers\n   it('should error when used in a route handler (until we implement it)', async () => {\n     const params = { lang: 'en', locale: 'us' }\n@@ -123,7 +183,7 @@ describe('app-root-param-getters - simple', () => {\n     )\n     expect(response.status).toBe(500)\n     if (!isNextDeploy) {\n-      expect(next.cliOutput).toInclude(\n+      expect(getCliOutput()).toInclude(\n         \"Route /[lang]/[locale]/route-handler used `import('next/root-params').lang()` inside a Route Handler. Support for this API in Route Handlers is planned for a future version of Next.js.\"\n       )\n     }"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 111,
        "deletions": 12
    }
}