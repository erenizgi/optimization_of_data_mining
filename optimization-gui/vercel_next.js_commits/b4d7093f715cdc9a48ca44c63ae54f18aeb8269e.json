{
    "author": "ztanner",
    "message": "unify allowed origin detection handling (#77053)\n\nThis unifies the CSRF origin detection to mirror what we do for server\naction origins, which supports things like wildcard matches (below the\ndomain level)\n\nFixes #76999",
    "sha": "b4d7093f715cdc9a48ca44c63ae54f18aeb8269e",
    "files": [
        {
            "sha": "680fc1ec2fbb0eca1d8f53b57d9f3b24f403f64a",
            "filename": "docs/01-app/04-api-reference/05-config/01-next-config-js/allowedDevOrigins.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b4d7093f715cdc9a48ca44c63ae54f18aeb8269e/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/b4d7093f715cdc9a48ca44c63ae54f18aeb8269e/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx?ref=b4d7093f715cdc9a48ca44c63ae54f18aeb8269e",
            "patch": "@@ -11,7 +11,7 @@ To configure a Next.js application to allow requests from origins other than the\n \n ```js filename=\"next.config.js\"\n module.exports = {\n-  allowedDevOrigins: ['local-origin.dev'],\n+  allowedDevOrigins: ['local-origin.dev', '*.local-origin.dev'],\n }\n ```\n "
        },
        {
            "sha": "4287d290afbab2d2ee6a789d6712e522c41af72e",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b4d7093f715cdc9a48ca44c63ae54f18aeb8269e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b4d7093f715cdc9a48ca44c63ae54f18aeb8269e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=b4d7093f715cdc9a48ca44c63ae54f18aeb8269e",
            "patch": "@@ -3,6 +3,7 @@ import type { IncomingMessage, ServerResponse } from 'webpack-dev-server'\n import { parseUrl } from '../../../lib/url'\n import net from 'net'\n import { warnOnce } from '../../../build/output/log'\n+import { isCsrfOriginAllowed } from '../../app-render/csrf-protection'\n \n export const blockCrossSite = (\n   req: IncomingMessage,\n@@ -25,7 +26,7 @@ export const blockCrossSite = (\n     }\n     res.end('Unauthorized')\n     warnOnce(\n-      `Blocked cross-origin request to /_next/*. To allow this, configure \"allowedDevOrigins\" in next.config\\nRead more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins`\n+      `Blocked cross-origin request to /_next/*. Cross-site requests are blocked in \"no-cors\" mode.`\n     )\n     return true\n   }\n@@ -46,9 +47,7 @@ export const blockCrossSite = (\n         // allow requests if direct IP and matching port and\n         // allow if any of the allowed origins match\n         !(isIpRequest && isMatchingPort) &&\n-        !allowedOrigins.some(\n-          (allowedOrigin) => allowedOrigin === originLowerCase\n-        )\n+        !isCsrfOriginAllowed(originLowerCase, allowedOrigins)\n       ) {\n         if ('statusCode' in res) {\n           res.statusCode = 403"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 4,
        "deletions": 5
    }
}