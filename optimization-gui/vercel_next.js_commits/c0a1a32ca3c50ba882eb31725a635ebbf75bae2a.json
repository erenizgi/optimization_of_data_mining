{
    "author": "mischnic",
    "message": "Turbopack: support `import ... with {type: \"bytes\"}` (#83896)\n\n- [x] The big question is: do we\r\n\t- put this behind a flag (`nextConfig.experimental.importTypeBytes`?)\r\n\t- ~~put this behind a non-standard `type: \"turbopack-bytes\"` (currently implemented)~~\r\n\t- ~~just ship it?~~\r\n\t- the only \"problem\" is that type: \"bytes\" is now silently ignored if the flag is not enabled\r\n- [x] [Furthermore, `Uint8Array.fromBase64` isn't that widely supported](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array/fromBase64#browser_compatibility). So emitting that always is questionable from a browser support standpoint.\r\n\r\nThis is the output in the test:\r\n```js\r\nmodule.exports = [\r\n  \"[project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/type-bytes/input/data.bin (static bytes in ecmascript)\",\r\n  (ctx) => {\r\n    ctx.v(Uint8Array.fromBase64(\"dGhpcyBpcyBzb21lIGRhdGEK\"));\r\n  },\r\n\r\n  \"[project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/type-bytes/input/index.js [test] (ecmascript)\",\r\n  (ctx) => {\r\n    \"use strict\";\r\n    var bytes = ctx.i(\r\n      \"[project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/type-bytes/input/data.bin (static bytes in ecmascript)\"\r\n    );\r\n    it(\"import type:bytes should work\", () => {\r\n      expect(bytes[\"default\"]).toBeInstanceOf(Uint8Array);\r\n      expect(new TextDecoder().decode(bytes[\"default\"])).toBe(\r\n        \"this is some data\\n\"\r\n      );\r\n    });\r\n  },\r\n];\r\n\r\n```",
    "sha": "c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
    "files": [
        {
            "sha": "7ae5681dcf99973bd7b0fa6fe92f19e544b29a87",
            "filename": "crates/next-core/src/next_client/transforms.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -9,10 +9,11 @@ use crate::{\n     next_client::context::ClientContextType,\n     next_config::NextConfig,\n     next_shared::transforms::{\n-        debug_fn_name::get_debug_fn_name_rule, get_next_dynamic_transform_rule,\n-        get_next_font_transform_rule, get_next_image_rule, get_next_lint_transform_rule,\n-        get_next_modularize_imports_rule, get_next_pages_transforms_rule,\n-        get_server_actions_transform_rule, next_cjs_optimizer::get_next_cjs_optimizer_rule,\n+        debug_fn_name::get_debug_fn_name_rule, get_import_type_bytes_rule,\n+        get_next_dynamic_transform_rule, get_next_font_transform_rule, get_next_image_rule,\n+        get_next_lint_transform_rule, get_next_modularize_imports_rule,\n+        get_next_pages_transforms_rule, get_server_actions_transform_rule,\n+        next_cjs_optimizer::get_next_cjs_optimizer_rule,\n         next_disallow_re_export_all_in_page::get_next_disallow_export_all_in_page_rule,\n         next_pure::get_next_pure_rule, server_actions::ActionsTransform,\n     },\n@@ -94,5 +95,9 @@ pub async fn get_next_client_transforms_rules(\n         rules.push(get_next_image_rule().await?);\n     }\n \n+    if *next_config.turbopack_import_type_bytes().await? {\n+        rules.push(get_import_type_bytes_rule());\n+    }\n+\n     Ok(rules)\n }"
        },
        {
            "sha": "bedd6327234c65159feb86a0b379aa64574acfde",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -874,6 +874,7 @@ pub struct ExperimentalConfig {\n     turbopack_source_maps: Option<bool>,\n     turbopack_tree_shaking: Option<bool>,\n     turbopack_scope_hoisting: Option<bool>,\n+    turbopack_import_type_bytes: Option<bool>,\n     turbopack_use_system_tls_certs: Option<bool>,\n     /// Disable automatic configuration of the sass loader.\n     #[serde(default)]\n@@ -1809,6 +1810,15 @@ impl NextConfig {\n         }))\n     }\n \n+    #[turbo_tasks::function]\n+    pub async fn turbopack_import_type_bytes(&self) -> Vc<bool> {\n+        Vc::cell(\n+            self.experimental\n+                .turbopack_import_type_bytes\n+                .unwrap_or(false),\n+        )\n+    }\n+\n     #[turbo_tasks::function]\n     pub async fn client_source_maps(&self, mode: Vc<NextMode>) -> Result<Vc<bool>> {\n         let source_maps = self.experimental.turbopack_source_maps;"
        },
        {
            "sha": "ca746c2bc33b0c87cd3b0f4f2c14ec03df648c34",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -12,8 +12,8 @@ use crate::{\n     next_config::NextConfig,\n     next_server::context::ServerContextType,\n     next_shared::transforms::{\n-        get_next_dynamic_transform_rule, get_next_font_transform_rule, get_next_image_rule,\n-        get_next_lint_transform_rule, get_next_modularize_imports_rule,\n+        get_import_type_bytes_rule, get_next_dynamic_transform_rule, get_next_font_transform_rule,\n+        get_next_image_rule, get_next_lint_transform_rule, get_next_modularize_imports_rule,\n         get_next_pages_transforms_rule, get_next_track_dynamic_imports_transform_rule,\n         get_server_actions_transform_rule, next_cjs_optimizer::get_next_cjs_optimizer_rule,\n         next_disallow_re_export_all_in_page::get_next_disallow_export_all_in_page_rule,\n@@ -209,6 +209,10 @@ pub async fn get_next_server_transforms_rules(\n         }\n     }\n \n+    if *next_config.turbopack_import_type_bytes().await? {\n+        rules.push(get_import_type_bytes_rule());\n+    }\n+\n     Ok(rules)\n }\n "
        },
        {
            "sha": "62f661e2a50806de1ccaed550a3c08f3bb06d01a",
            "filename": "crates/next-core/src/next_shared/transforms/mod.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -32,7 +32,9 @@ pub use server_actions::get_server_actions_transform_rule;\n use turbo_tasks::ResolvedVc;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::{ModuleRule, ModuleRuleEffect, ModuleType, RuleCondition};\n-use turbopack_core::reference_type::{ReferenceType, UrlReferenceSubType};\n+use turbopack_core::reference_type::{\n+    EcmaScriptModulesReferenceSubType, ImportWithType, ReferenceType, UrlReferenceSubType,\n+};\n use turbopack_ecmascript::{CustomTransformer, EcmascriptInputTransform};\n \n use crate::next_image::{StructuredImageModuleType, module::BlurPlaceholderMode};\n@@ -123,6 +125,16 @@ pub(crate) fn module_rule_match_pages_page_file(\n     ])\n }\n \n+pub(crate) fn get_import_type_bytes_rule() -> ModuleRule {\n+    // Move this into turbopack once the feature is standardized\n+    ModuleRule::new(\n+        RuleCondition::ReferenceType(ReferenceType::EcmaScriptModules(\n+            EcmaScriptModulesReferenceSubType::ImportWithType(ImportWithType::Bytes),\n+        )),\n+        vec![ModuleRuleEffect::ModuleType(ModuleType::InlinedBytesJs)],\n+    )\n+}\n+\n pub(crate) enum EcmascriptTransformStage {\n     Preprocess,\n     Main,"
        },
        {
            "sha": "3459d3fcba47e065c5b29ab250eab280b6a7132a",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -473,6 +473,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         turbopackTreeShaking: z.boolean().optional(),\n         turbopackRemoveUnusedExports: z.boolean().optional(),\n         turbopackScopeHoisting: z.boolean().optional(),\n+        turbopackImportTypeBytes: z.boolean().optional(),\n         turbopackUseSystemTlsCerts: z.boolean().optional(),\n         turbopackUseBuiltinBabel: z.boolean().optional(),\n         turbopackUseBuiltinSass: z.boolean().optional(),"
        },
        {
            "sha": "59ccc2249c89eb7a0d4f6d2e734ae4dce3bc29bf",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -438,6 +438,11 @@ export interface ExperimentalConfig {\n    */\n   turbopackMinify?: boolean\n \n+  /**\n+   * Enable support for `with {type: \"module\"}` for ESM imports.\n+   */\n+  turbopackImportTypeBytes?: boolean\n+\n   /**\n    * Enable scope hoisting. Defaults to true in build mode. Always disabled in development mode.\n    */"
        },
        {
            "sha": "4a4d2f77b63288adf2ba8caa51c2ecfd683722c6",
            "filename": "test/e2e/turbopack-import-type-bytes/app/api/data.bin",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Fdata.bin",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Fdata.bin",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Fdata.bin?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -0,0 +1 @@\n+this is some data"
        },
        {
            "sha": "ca2e00a16f8de59fa2aa2e40d7ceeeaa8fc444b2",
            "filename": "test/e2e/turbopack-import-type-bytes/app/api/route.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-import-type-bytes%2Fapp%2Fapi%2Froute.js?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -0,0 +1,12 @@\n+import bytes from './data.bin' with { type: 'bytes' }\n+\n+export async function GET(_req) {\n+  return Response.json(\n+    {\n+      instanceofUint8Array: bytes instanceof Uint8Array,\n+      length: bytes.length,\n+      content: new TextDecoder().decode(bytes),\n+    },\n+    { status: 200 }\n+  )\n+}"
        },
        {
            "sha": "d4834b454e4c02d0d7304e376fdfae77ba2d26c3",
            "filename": "test/e2e/turbopack-import-type-bytes/index.test.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-import-type-bytes%2Findex.test.ts?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -0,0 +1,25 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+// Not supported by Webpack\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'turbopack-import-type-bytes',\n+  () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('support import type: bytes', async () => {\n+      const response = JSON.parse(await next.render('/api'))\n+      expect(response).toEqual({\n+        instanceofUint8Array: true,\n+        length: 18,\n+        content: 'this is some data\\n',\n+      })\n+    })\n+  }\n+)"
        },
        {
            "sha": "4ea164531f93da5d1afcd41750a46895120b9195",
            "filename": "test/e2e/turbopack-import-type-bytes/next.config.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-import-type-bytes%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-import-type-bytes%2Fnext.config.ts?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -0,0 +1,5 @@\n+export default {\n+  experimental: {\n+    turbopackImportTypeBytes: true,\n+  },\n+}"
        },
        {
            "sha": "9eae254ef6f3f03d866d8f054b6c2cc1e18d2d12",
            "filename": "test/e2e/turbopack-loader-config/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-loader-config%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/test%2Fe2e%2Fturbopack-loader-config%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fturbopack-loader-config%2Findex.test.ts?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -1,13 +1,17 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('turbopack-loader-config', () => {\n-  const { next, isTurbopack, isNextDev } = nextTestSetup({\n+  const { next, isTurbopack, isNextDev, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n     // we can't set `nextConfig` inline because it contains regexes that fail to serialize, it needs\n     // to be set in a separate module (`next.config.ts`)\n   })\n \n+  if (skipped) {\n+    return\n+  }\n+\n   if (!isTurbopack) {\n     it('should only run the test in turbopack', () => {})\n     return"
        },
        {
            "sha": "bef4ceab833a85ff205a2894027632d5401d1414",
            "filename": "turbopack/crates/turbopack-core/src/reference_type.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -62,6 +62,7 @@ pub enum CommonJsReferenceSubType {\n )]\n pub enum ImportWithType {\n     Json,\n+    Bytes,\n }\n \n #[derive("
        },
        {
            "sha": "18b1c9b9c347a4f6f0a841ffd874c6a48e823211",
            "filename": "turbopack/crates/turbopack-ecmascript/src/inlined_bytes_module.rs",
            "status": "added",
            "additions": 152,
            "deletions": 0,
            "changes": 152,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Finlined_bytes_module.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -0,0 +1,152 @@\n+use std::io::{Read, Write};\n+\n+use anyhow::{Result, bail};\n+use turbo_rcstr::rcstr;\n+use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n+use turbo_tasks_fs::{FileContent, glob::Glob, rope::RopeBuilder};\n+use turbopack_core::{\n+    asset::{Asset, AssetContent},\n+    chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n+    ident::AssetIdent,\n+    module::Module,\n+    module_graph::ModuleGraph,\n+    source::Source,\n+};\n+\n+use crate::{\n+    chunk::{\n+        EcmascriptChunkItem, EcmascriptChunkItemContent, EcmascriptChunkPlaceable,\n+        EcmascriptChunkType, EcmascriptExports,\n+    },\n+    runtime_functions::TURBOPACK_EXPORT_VALUE,\n+    utils::StringifyJs,\n+};\n+\n+#[turbo_tasks::value]\n+pub struct InlinedBytesJsModule {\n+    source: ResolvedVc<Box<dyn Source>>,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl InlinedBytesJsModule {\n+    #[turbo_tasks::function]\n+    pub fn new(source: ResolvedVc<Box<dyn Source>>) -> Vc<Self> {\n+        Self::cell(InlinedBytesJsModule { source })\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Module for InlinedBytesJsModule {\n+    #[turbo_tasks::function]\n+    fn ident(&self) -> Vc<AssetIdent> {\n+        self.source\n+            .ident()\n+            .with_modifier(rcstr!(\"static bytes in ecmascript\"))\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Asset for InlinedBytesJsModule {\n+    #[turbo_tasks::function]\n+    fn content(&self) -> Vc<AssetContent> {\n+        self.source.content()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ChunkableModule for InlinedBytesJsModule {\n+    #[turbo_tasks::function]\n+    fn as_chunk_item(\n+        self: ResolvedVc<Self>,\n+        _module_graph: Vc<ModuleGraph>,\n+        chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n+    ) -> Vc<Box<dyn turbopack_core::chunk::ChunkItem>> {\n+        Vc::upcast(InlinedBytesJsChunkItem::cell(InlinedBytesJsChunkItem {\n+            module: self,\n+            chunking_context,\n+        }))\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl EcmascriptChunkPlaceable for InlinedBytesJsModule {\n+    #[turbo_tasks::function]\n+    fn get_exports(&self) -> Vc<EcmascriptExports> {\n+        EcmascriptExports::Value.cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn is_marked_as_side_effect_free(&self, _side_effect_free_packages: Vc<Glob>) -> Vc<bool> {\n+        Vc::cell(true)\n+    }\n+}\n+\n+#[turbo_tasks::value]\n+struct InlinedBytesJsChunkItem {\n+    module: ResolvedVc<InlinedBytesJsModule>,\n+    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ChunkItem for InlinedBytesJsChunkItem {\n+    #[turbo_tasks::function]\n+    fn asset_ident(&self) -> Vc<AssetIdent> {\n+        self.module.ident()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn chunking_context(&self) -> Vc<Box<dyn ChunkingContext>> {\n+        *self.chunking_context\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn ty(&self) -> Result<Vc<Box<dyn ChunkType>>> {\n+        Ok(Vc::upcast(\n+            Vc::<EcmascriptChunkType>::default().resolve().await?,\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn module(&self) -> Vc<Box<dyn Module>> {\n+        Vc::upcast(*self.module)\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl EcmascriptChunkItem for InlinedBytesJsChunkItem {\n+    #[turbo_tasks::function]\n+    async fn content(&self) -> Result<Vc<EcmascriptChunkItemContent>> {\n+        let content = self.module.content().file_content().await?;\n+        match &*content {\n+            FileContent::Content(data) => {\n+                let mut inner_code = RopeBuilder::default();\n+                inner_code += \"\n+var decode = Uint8Array.fromBase64 || function Uint8Array_fromBase64(base64) {\n+  var binaryString = atob(base64);\n+  var buffer = new Uint8Array(binaryString.length);\n+  for (var i = 0; i < binaryString.length; i++) {\n+    buffer[i] = binaryString.charCodeAt(i)\n+  }\n+  return buffer\n+};\\n\";\n+\n+                let encoded = data_encoding::BASE64_NOPAD\n+                    .encode(&data.read().bytes().collect::<std::io::Result<Vec<u8>>>()?);\n+                write!(\n+                    inner_code,\n+                    \"{TURBOPACK_EXPORT_VALUE}(decode({}));\",\n+                    StringifyJs(&encoded)\n+                )?;\n+\n+                Ok(EcmascriptChunkItemContent {\n+                    inner_code: inner_code.build(),\n+                    ..Default::default()\n+                }\n+                .into())\n+            }\n+            FileContent::NotFound => {\n+                bail!(\"File not found: {}\", self.module.ident().to_string().await?);\n+            }\n+        }\n+    }\n+}"
        },
        {
            "sha": "5809bcdd29d333ed5c0da34986ff4d971f656f39",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -14,6 +14,7 @@ pub mod async_chunk;\n pub mod chunk;\n pub mod code_gen;\n mod errors;\n+pub mod inlined_bytes_module;\n pub mod magic_identifier;\n pub mod manifest;\n mod merged_module;"
        },
        {
            "sha": "d3db93ae030926e597f7329d9413c9843a24d966",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -391,6 +391,8 @@ impl ModuleReference for EsmAssetReference {\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n         let ty = if matches!(self.annotations.module_type(), Some(\"json\")) {\n             EcmaScriptModulesReferenceSubType::ImportWithType(ImportWithType::Json)\n+        } else if matches!(self.annotations.module_type(), Some(\"bytes\")) {\n+            EcmaScriptModulesReferenceSubType::ImportWithType(ImportWithType::Bytes)\n         } else if let Some(part) = &self.export_name {\n             EcmaScriptModulesReferenceSubType::ImportPart(part.clone())\n         } else {"
        },
        {
            "sha": "6e772a9851d807d82e0469b1c046a4b5fd536dc8",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -56,6 +56,7 @@ use turbopack_core::{\n pub use turbopack_css as css;\n pub use turbopack_ecmascript as ecmascript;\n use turbopack_ecmascript::{\n+    inlined_bytes_module::InlinedBytesJsModule,\n     references::external_module::{\n         CachedExternalModule, CachedExternalTracingMode, CachedExternalType,\n     },\n@@ -264,6 +265,9 @@ async fn apply_module_type(\n         ModuleType::StaticUrlCss => {\n             ResolvedVc::upcast(StaticUrlCssModule::new(*source).to_resolved().await?)\n         }\n+        ModuleType::InlinedBytesJs => {\n+            ResolvedVc::upcast(InlinedBytesJsModule::new(*source).to_resolved().await?)\n+        }\n         ModuleType::WebAssembly { source_ty } => ResolvedVc::upcast(\n             WebAssemblyModuleAsset::new(\n                 WebAssemblySource::new(*source, *source_ty),\n@@ -518,6 +522,8 @@ async fn process_default_internal(\n \n             match ty {\n                 ImportWithType::Json => Some(ModuleType::Json),\n+                // Reenable this once `import {type: \"bytes\"}` is stabilized\n+                ImportWithType::Bytes => None,\n             }\n         }\n         _ => None,"
        },
        {
            "sha": "99c90d6d7a06f8e7a8feaa25a94df416769f7aa0",
            "filename": "turbopack/crates/turbopack/src/module_options/module_rule.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c0a1a32ca3c50ba882eb31725a635ebbf75bae2a/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs?ref=c0a1a32ca3c50ba882eb31725a635ebbf75bae2a",
            "patch": "@@ -130,6 +130,7 @@ pub enum ModuleType {\n     },\n     StaticUrlJs,\n     StaticUrlCss,\n+    InlinedBytesJs,\n     WebAssembly {\n         source_ty: WebAssemblySourceType,\n     },"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 255,
        "deletions": 8
    }
}