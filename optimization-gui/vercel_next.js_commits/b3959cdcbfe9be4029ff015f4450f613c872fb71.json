{
    "author": "bgw",
    "message": "test: Fix and update recursive-delete benchmarks (#84875)\n\nPR created with claude code, with some manual review.\n\n- Update benchmark scripts to work, given my recent code changes\n- Include a native nodejs benchmark\n- Use rimraf's `manual` implementation (tries to use node's native version)\n- Tried to clean up the code a bit\n- Use a trap to always clean up\n- Use getopt and add an `--iterations` option\n- `set -euo pipefail` to avoid swallowing errors\n\nExample output:\n\n```\npnpm bench\n\n> bench-recursive-delete@ bench /home/bgw.linux/next.js/bench/recursive-delete\n> bash run.sh\n\n-----------\nrimraf (async) 1\n62.443657\nrimraf (async) 2\n52.953482\nrimraf (async) 3\n52.029235\nrimraf (async) 4\n50.709822\nrimraf (async) 5\n54.204893\n-----------\nrimraf (sync) 1\n35.034669\nrimraf (sync) 2\n35.663417\nrimraf (sync) 3\n46.360754\nrimraf (sync) 4\n36.859329\nrimraf (sync) 5\n34.368796\n-----------\nrecursive delete 1\n37.851534\nrecursive delete 2\n35.98904\nrecursive delete 3\n36.620913\nrecursive delete 4\n38.059992\nrecursive delete 5\n43.880346\n-----------\nnodejs rm (promises) 1\n71.301125\nnodejs rm (promises) 2\n89.78331\nnodejs rm (promises) 3\n68.073553\nnodejs rm (promises) 4\n70.787543\nnodejs rm (promises) 5\n73.727616\n-----------\nnodejs rm (callback) 1\n92.698258\nnodejs rm (callback) 2\n73.043993\nnodejs rm (callback) 3\n70.869584\nnodejs rm (callback) 4\n69.196757\nnodejs rm (callback) 5\n75.715526\n-----------\nnodejs rm (sync) 1\n41.71002\nnodejs rm (sync) 2\n41.742395\nnodejs rm (sync) 3\n38.894571\nnodejs rm (sync) 4\n41.326271\nnodejs rm (sync) 5\n48.152122\n```",
    "sha": "b3959cdcbfe9be4029ff015f4450f613c872fb71",
    "files": [
        {
            "sha": "fef339d4288442b3b50e0db6ca7fd3ce65ec559f",
            "filename": "bench/recursive-delete/README.md",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2FREADME.md?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -0,0 +1,7 @@\n+# Recursive Delete Benchmark\n+\n+```bash\n+pnpm bench\n+```\n+\n+Run `pnpm bench --help` for options."
        },
        {
            "sha": "a0d949a8d7b23fac809713b4b8b3af88bf7a04f5",
            "filename": "bench/recursive-delete/nodejs-rm.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Fnodejs-rm.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Fnodejs-rm.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Fnodejs-rm.js?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -0,0 +1,27 @@\n+import { rm as rmPromises } from 'fs/promises'\n+import { rm as rmCallback, rmSync } from 'fs'\n+import { promisify } from 'util'\n+\n+const rmCallbackPromise = promisify(rmCallback)\n+\n+const targetDir = process.argv[2]\n+const method = process.argv[3] // 'promises', 'callback', or 'sync'\n+\n+async function test() {\n+  const time = process.hrtime()\n+\n+  if (method === 'promises') {\n+    await rmPromises(targetDir, { recursive: true, force: true })\n+  } else if (method === 'callback') {\n+    await rmCallbackPromise(targetDir, { recursive: true, force: true })\n+  } else if (method === 'sync') {\n+    rmSync(targetDir, { recursive: true, force: true })\n+  }\n+\n+  const hrtime = process.hrtime(time)\n+  const nanoseconds = hrtime[0] * 1e9 + hrtime[1]\n+  const milliseconds = nanoseconds / 1e6\n+  console.log(milliseconds)\n+}\n+\n+test()"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "bench/recursive-delete/output.txt",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Foutput.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Foutput.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Foutput.txt?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71"
        },
        {
            "sha": "68e20c110a5f70433a18a1dce986140dc5dafe0e",
            "filename": "bench/recursive-delete/package.json",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Fpackage.json?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -0,0 +1,12 @@\n+{\n+  \"name\": \"bench-recursive-delete\",\n+  \"type\": \"module\",\n+  \"scripts\": {\n+    \"bench\": \"bash run.sh\"\n+  },\n+  \"devDependencies\": {\n+    \"fuzzponent\": \"workspace:*\",\n+    \"next\": \"workspace:*\",\n+    \"rimraf\": \"6.0.1\"\n+  }\n+}"
        },
        {
            "sha": "2720b8f89fc4402c9eba98c26dfc014a5160d0f0",
            "filename": "bench/recursive-delete/recursive-delete.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frecursive-delete.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frecursive-delete.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Frecursive-delete.js?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -1,10 +1,10 @@\n-import { join } from 'path'\n-import { recursiveDelete } from 'next/dist/lib/recursive-delete'\n-const resolveDataDir = join(__dirname, `fixtures-${process.argv[2]}`)\n+import { recursiveDeleteSyncWithAsyncRetries } from 'next/dist/lib/recursive-delete.js'\n+\n+const targetDir = process.argv[2]\n \n async function test() {\n   const time = process.hrtime()\n-  await recursiveDelete(resolveDataDir)\n+  await recursiveDeleteSyncWithAsyncRetries(targetDir)\n \n   const hrtime = process.hrtime(time)\n   const nanoseconds = hrtime[0] * 1e9 + hrtime[1]"
        },
        {
            "sha": "4a17c04ccd36a21657e5f754a0f856407ee80de7",
            "filename": "bench/recursive-delete/rimraf.js",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frimraf.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frimraf.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Frimraf.js?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -1,13 +1,16 @@\n-import { join } from 'path'\n-import { promisify } from 'util'\n-import rimrafMod from 'rimraf'\n+import { manual, manualSync } from 'rimraf'\n \n-const rimraf = promisify(rimrafMod)\n-const resolveDataDir = join(__dirname, `fixtures-${process.argv[2]}`, '**/*')\n+const targetDir = process.argv[2]\n+const method = process.argv[3]\n \n async function test() {\n   const time = process.hrtime()\n-  await rimraf(resolveDataDir)\n+\n+  if (method === 'sync') {\n+    manualSync(targetDir)\n+  } else {\n+    await manual(targetDir)\n+  }\n \n   const hrtime = process.hrtime(time)\n   const nanoseconds = hrtime[0] * 1e9 + hrtime[1]"
        },
        {
            "sha": "170e1f3b894fd5a6344b06bd169586e0a6ffe0fb",
            "filename": "bench/recursive-delete/run.sh",
            "status": "modified",
            "additions": 63,
            "deletions": 69,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frun.sh",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/bench%2Frecursive-delete%2Frun.sh",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/bench%2Frecursive-delete%2Frun.sh?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -1,69 +1,63 @@\n-# Uses https://github.com/divmain/fuzzponent\n-mkdir fixtures-1\n-cd fixtures-1\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"rimraf 1\"\n-node rimraf.js 1\n-\n-mkdir fixtures-2\n-cd fixtures-2\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"rimraf 2\"\n-node rimraf.js 2\n-\n-mkdir fixtures-3\n-cd fixtures-3\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"rimraf 3\"\n-node rimraf.js 3\n-\n-mkdir fixtures-4\n-cd fixtures-4\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"rimraf 4\"\n-node rimraf.js 4\n-\n-mkdir fixtures-5\n-cd fixtures-5\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"rimraf 5\"\n-node rimraf.js 5\n-\n-echo \"-----------\"\n-\n-cd fixtures-1\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"recursive delete 1\"\n-node recursive-delete.js 1\n-\n-cd fixtures-2\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"recursive delete 2\"\n-node recursive-delete.js 2\n-\n-cd fixtures-3\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"recursive delete 3\"\n-node recursive-delete.js 3\n-\n-cd fixtures-4\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"recursive delete 4\"\n-node recursive-delete.js 4\n-\n-cd fixtures-5\n-fuzzponent -d 2 -s 20 > output.txt\n-cd ..\n-echo \"recursive delete 5\"\n-node recursive-delete.js 5\n-\n-rm -r fixtures-1 fixtures-2 fixtures-3 fixtures-4 fixtures-5\n\\ No newline at end of file\n+#!/usr/bin/env bash\n+set -euo pipefail\n+\n+ITERATIONS=5\n+\n+show_help() {\n+  echo \"Usage: $(basename \"$0\") [-i|--iterations N] [-h|--help]\"\n+  exit \"${1:-0}\"\n+}\n+\n+if ! OPTS=$(getopt -o i:h --long iterations:,help -n \"$(basename \"$0\")\" -- \"$@\"); then\n+  show_help 1\n+fi\n+eval set -- \"$OPTS\"\n+\n+while true; do\n+  case \"$1\" in\n+    -i|--iterations)\n+      ITERATIONS=\"$2\"\n+      shift 2\n+      ;;\n+    -h|--help)\n+      show_help\n+      ;;\n+    *)\n+      break\n+      ;;\n+  esac\n+done\n+\n+cleanup() {\n+  for i in $(seq 1 \"$ITERATIONS\"); do\n+    rm -rf \"fixtures-$i\"\n+  done\n+}\n+\n+trap cleanup EXIT\n+cleanup\n+\n+run_benchmark() {\n+  local name=$1\n+  local script=$2\n+  shift 2\n+\n+  echo \"-----------\"\n+  for i in $(seq 1 \"$ITERATIONS\"); do\n+    local fixture=\"fixtures-$i\"\n+    mkdir \"$fixture\"\n+    cd \"fixtures-$i\"\n+    fuzzponent -d 2 -s 20\n+    cd ..\n+    echo \"$name $i\"\n+    node \"$script\" \"$fixture\" \"$@\"\n+    if [[ -d \"$fixture\" ]]; then rmdir \"$fixture\"; fi\n+  done\n+}\n+\n+run_benchmark \"rimraf (async)\" \"rimraf.js\" \"async\"\n+run_benchmark \"rimraf (sync)\" \"rimraf.js\" \"sync\"\n+run_benchmark \"recursive delete\" \"recursive-delete.js\"\n+run_benchmark \"nodejs rm (promises)\" \"nodejs-rm.js\" \"promises\"\n+run_benchmark \"nodejs rm (callback)\" \"nodejs-rm.js\" \"callback\"\n+run_benchmark \"nodejs rm (sync)\" \"nodejs-rm.js\" \"sync\""
        },
        {
            "sha": "85e713671de470c21141a6059d8079f87c2094fb",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/b3959cdcbfe9be4029ff015f4450f613c872fb71/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/b3959cdcbfe9be4029ff015f4450f613c872fb71/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=b3959cdcbfe9be4029ff015f4450f613c872fb71",
            "patch": "@@ -794,6 +794,18 @@ importers:\n         specifier: workspace:*\n         version: link:../../packages/next\n \n+  bench/recursive-delete:\n+    devDependencies:\n+      fuzzponent:\n+        specifier: workspace:*\n+        version: link:../fuzzponent\n+      next:\n+        specifier: workspace:*\n+        version: link:../../packages/next\n+      rimraf:\n+        specifier: 6.0.1\n+        version: 6.0.1\n+\n   bench/rendering:\n     dependencies:\n       fs-extra:\n@@ -12222,10 +12234,6 @@ packages:\n   lru-cache@10.4.3:\n     resolution: {integrity: sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==}\n \n-  lru-cache@11.1.0:\n-    resolution: {integrity: sha512-QIXZUBJUx+2zHUdQujWejBkcD9+cs94tLn0+YL8UrCh+D5sCXZ4c7LaEH48pNwRY3MLDgqUFyhlCyjJPf1WP0A==}\n-    engines: {node: 20 || >=22}\n-\n   lru-cache@11.2.1:\n     resolution: {integrity: sha512-r8LA6i4LP4EeWOhqBaZZjDWwehd1xUJPCJd9Sv300H0ZmcUER4+JPh7bqqZeqs1o5pgtgvXm+d9UGrB5zZGDiQ==}\n     engines: {node: 20 || >=22}\n@@ -30683,8 +30691,6 @@ snapshots:\n \n   lru-cache@10.4.3: {}\n \n-  lru-cache@11.1.0: {}\n-\n   lru-cache@11.2.1: {}\n \n   lru-cache@4.1.5:\n@@ -32938,7 +32944,7 @@ snapshots:\n \n   path-scurry@2.0.0:\n     dependencies:\n-      lru-cache: 11.1.0\n+      lru-cache: 11.2.1\n       minipass: 7.1.2\n \n   path-to-regexp@0.1.12: {}"
        }
    ],
    "stats": {
        "total": 221,
        "additions": 135,
        "deletions": 86
    }
}