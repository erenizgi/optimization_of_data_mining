{
    "author": "gaojude",
    "message": "clean up useReducer code re dev indicator (#77354)\n\nFollow-up to https://github.com/vercel/next.js/pull/76976\n\nSince we want to make explicit mode check from outside, we can now\nremove the implicitly checked one from inside.",
    "sha": "5b9d66a9b872ad28336988b768af34852a85e9e3",
    "files": [
        {
            "sha": "3102d061049560a24157bb92bdb922e2149c5c04",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator-internal.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5576edd3124277be568734d5d26923e9d75e520a/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator-internal.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5576edd3124277be568734d5d26923e9d75e520a/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator-internal.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator-internal.tsx?ref=5576edd3124277be568734d5d26923e9d75e520a",
            "patch": "@@ -1,16 +0,0 @@\n-import { useEffect, useTransition } from 'react'\n-import { devRenderIndicator } from './dev-render-indicator'\n-\n-export const useSyncDevRenderIndicatorInternal = () => {\n-  const [isPending, startTransition] = useTransition()\n-\n-  useEffect(() => {\n-    if (isPending) {\n-      devRenderIndicator.show()\n-    } else {\n-      devRenderIndicator.hide()\n-    }\n-  }, [isPending])\n-\n-  return startTransition\n-}"
        },
        {
            "sha": "354bdf93f076e30c313965dcc29f83ca3a2ccef3",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 15,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/5b9d66a9b872ad28336988b768af34852a85e9e3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5b9d66a9b872ad28336988b768af34852a85e9e3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fdev-indicator%2Fuse-sync-dev-render-indicator.tsx?ref=5b9d66a9b872ad28336988b768af34852a85e9e3",
            "patch": "@@ -1,20 +1,16 @@\n-const NOOP = (fn: () => void) => fn()\n+import { useEffect, useTransition } from 'react'\n+import { devRenderIndicator } from './dev-render-indicator'\n \n-/**\n- * Returns a transition function that can be used to wrap router actions.\n- * This allows us to tap into the transition state of the router as an\n- * approximation of React render time.\n- */\n export const useSyncDevRenderIndicator = () => {\n-  let syncDevRenderIndicator = NOOP\n+  const [isPending, startTransition] = useTransition()\n \n-  if (process.env.NODE_ENV === 'development') {\n-    const { useSyncDevRenderIndicatorInternal } =\n-      require('./use-sync-dev-render-indicator-internal') as typeof import('./use-sync-dev-render-indicator-internal')\n+  useEffect(() => {\n+    if (isPending) {\n+      devRenderIndicator.show()\n+    } else {\n+      devRenderIndicator.hide()\n+    }\n+  }, [isPending])\n \n-    // eslint-disable-next-line react-hooks/rules-of-hooks\n-    syncDevRenderIndicator = useSyncDevRenderIndicatorInternal()\n-  }\n-\n-  return syncDevRenderIndicator\n+  return startTransition\n }"
        },
        {
            "sha": "672f30d6a3cb2258229d4b5bf92f2a215cb14b11",
            "filename": "packages/next/src/client/components/use-reducer.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 21,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/5b9d66a9b872ad28336988b768af34852a85e9e3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b9d66a9b872ad28336988b768af34852a85e9e3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-reducer.ts?ref=5b9d66a9b872ad28336988b768af34852a85e9e3",
            "patch": "@@ -17,36 +17,38 @@ export function useUnwrapState(state: ReducerState): AppRouterState {\n \n   return state\n }\n-\n export function useReducer(\n   actionQueue: AppRouterActionQueue\n ): [ReducerState, Dispatch<ReducerActions>] {\n   const [state, setState] = React.useState<ReducerState>(actionQueue.state)\n-  const actionDispatch = (action: ReducerActions) => {\n-    actionQueue.dispatch(action, setState)\n-  }\n \n-  let syncDevRenderIndicator\n+  const syncDevRenderIndicatorInDevelopment =\n+    useSyncDevRenderIndicatorInDevelopment()\n+\n+  const dispatch = useCallback(\n+    (action: ReducerActions) => {\n+      syncDevRenderIndicatorInDevelopment(() =>\n+        actionQueue.dispatch(action, setState)\n+      )\n+    },\n+    [actionQueue, syncDevRenderIndicatorInDevelopment]\n+  )\n+\n+  return [state, dispatch]\n+}\n+\n+const PASS_THROUGH = (fn: () => void) => fn()\n+\n+const useSyncDevRenderIndicatorInDevelopment = () => {\n   if (process.env.NODE_ENV !== 'production') {\n     const useSyncDevRenderIndicator =\n       require('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator')\n         .useSyncDevRenderIndicator as typeof import('./react-dev-overlay/utils/dev-indicator/use-sync-dev-render-indicator').useSyncDevRenderIndicator\n+\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n-    syncDevRenderIndicator = useSyncDevRenderIndicator()\n+    const syncDevRenderIndicator = useSyncDevRenderIndicator()\n+    return syncDevRenderIndicator\n+  } else {\n+    return PASS_THROUGH\n   }\n-\n-  const dispatchCallback =\n-    process.env.NODE_ENV !== 'production'\n-      ? (action: ReducerActions) => {\n-          syncDevRenderIndicator!(() => actionDispatch(action))\n-        }\n-      : actionDispatch\n-\n-  const dispatch = useCallback(dispatchCallback, [\n-    actionQueue,\n-    dispatchCallback,\n-    syncDevRenderIndicator,\n-  ])\n-\n-  return [state, dispatch]\n }"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 34,
        "deletions": 52
    }
}