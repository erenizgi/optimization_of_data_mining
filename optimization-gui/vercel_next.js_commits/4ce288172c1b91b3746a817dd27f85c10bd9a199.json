{
    "author": "sokra",
    "message": "Turbopack: persist and compare errors and panics (#77935)\n\n### What?\n\nAllow errors and panics to be serialized and store them in the task output.\n\nCompare errors when setting them to avoid unnecessary invalidations when tasks error again.",
    "sha": "4ce288172c1b91b3746a817dd27f85c10bd9a199",
    "files": [
        {
            "sha": "8fd817b0a0007a5bf24e4a62c29d0629cb29bc32",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 28,
            "deletions": 26,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -564,36 +564,38 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n \n         if let Some(output) = get!(task, Output) {\n             let result = match output {\n-                OutputValue::Cell(cell) => Some(Ok(Ok(RawVc::TaskCell(cell.task, cell.cell)))),\n-                OutputValue::Output(task) => Some(Ok(Ok(RawVc::TaskOutput(*task)))),\n-                OutputValue::Error => get!(task, Error).map(|error| Err(error.clone().into())),\n+                OutputValue::Cell(cell) => Ok(Ok(RawVc::TaskCell(cell.task, cell.cell))),\n+                OutputValue::Output(task) => Ok(Ok(RawVc::TaskOutput(*task))),\n+                OutputValue::Error(error) => {\n+                    let err: anyhow::Error = error.clone().into();\n+                    Err(err.context(format!(\n+                        \"Execution of {} failed\",\n+                        ctx.get_task_description(task_id)\n+                    )))\n+                }\n             };\n-            if let Some(result) = result {\n-                if self.should_track_dependencies() {\n-                    if let Some(reader) = reader {\n-                        let _ = task.add(CachedDataItem::OutputDependent {\n-                            task: reader,\n+            if self.should_track_dependencies() {\n+                if let Some(reader) = reader {\n+                    let _ = task.add(CachedDataItem::OutputDependent {\n+                        task: reader,\n+                        value: (),\n+                    });\n+                    drop(task);\n+\n+                    let mut reader_task = ctx.task(reader, TaskDataCategory::Data);\n+                    if reader_task\n+                        .remove(&CachedDataItemKey::OutdatedOutputDependency { target: task_id })\n+                        .is_none()\n+                    {\n+                        let _ = reader_task.add(CachedDataItem::OutputDependency {\n+                            target: task_id,\n                             value: (),\n                         });\n-                        drop(task);\n-\n-                        let mut reader_task = ctx.task(reader, TaskDataCategory::Data);\n-                        if reader_task\n-                            .remove(&CachedDataItemKey::OutdatedOutputDependency {\n-                                target: task_id,\n-                            })\n-                            .is_none()\n-                        {\n-                            let _ = reader_task.add(CachedDataItem::OutputDependency {\n-                                target: task_id,\n-                                value: (),\n-                            });\n-                        }\n                     }\n                 }\n-\n-                return result;\n             }\n+\n+            return result;\n         }\n \n         let reader_desc = reader.map(|r| self.get_task_desc_fn(r));\n@@ -1454,7 +1456,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n     fn task_execution_result(\n         &self,\n         task_id: TaskId,\n-        result: Result<RawVc, Arc<TurboTasksExecutionError>>,\n+        result: Result<RawVc, TurboTasksExecutionError>,\n         turbo_tasks: &dyn TurboTasksBackendApi<TurboTasksBackend<B>>,\n     ) {\n         operation::UpdateOutputOperation::run(task_id, result, self.execute_context(turbo_tasks));\n@@ -2564,7 +2566,7 @@ impl<B: BackingStorage> Backend for TurboTasksBackend<B> {\n     fn task_execution_result(\n         &self,\n         task_id: TaskId,\n-        result: Result<RawVc, Arc<TurboTasksExecutionError>>,\n+        result: Result<RawVc, TurboTasksExecutionError>,\n         turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n     ) {\n         self.0.task_execution_result(task_id, result, turbo_tasks);"
        },
        {
            "sha": "f0b57044581fdebf9e56f109d49353a855cb49e6",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/update_output.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -1,8 +1,8 @@\n-use std::{mem::take, sync::Arc};\n+use std::mem::take;\n \n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n-use turbo_tasks::{RawVc, TaskId, backend::TurboTasksExecutionError, util::SharedError};\n+use turbo_tasks::{RawVc, TaskId, backend::TurboTasksExecutionError};\n \n #[cfg(feature = \"trace_task_dirty\")]\n use crate::backend::operation::invalidate::TaskDirtyCause;\n@@ -44,7 +44,7 @@ pub enum UpdateOutputOperation {\n impl UpdateOutputOperation {\n     pub fn run(\n         task_id: TaskId,\n-        output: Result<RawVc, Arc<TurboTasksExecutionError>>,\n+        output: Result<RawVc, TurboTasksExecutionError>,\n         mut ctx: impl ExecuteContext,\n     ) {\n         let mut task = ctx.task(task_id, TaskDataCategory::All);\n@@ -66,7 +66,6 @@ impl UpdateOutputOperation {\n             Default::default()\n         };\n \n-        let old_error = task.remove(&CachedDataItemKey::Error {});\n         let current_output = get!(task, Output);\n         let output_value = match output {\n             Ok(RawVc::TaskOutput(output_task_id)) => {\n@@ -96,13 +95,12 @@ impl UpdateOutputOperation {\n                 panic!(\"Non-local tasks must not return a local Vc\");\n             }\n             Err(err) => {\n-                task.insert(CachedDataItem::Error {\n-                    value: SharedError::new(anyhow::Error::new(err).context(format!(\n-                        \"Execution of {} failed\",\n-                        ctx.get_task_description(task_id)\n-                    ))),\n-                });\n-                OutputValue::Error\n+                if let Some(OutputValue::Error(old_error)) = current_output {\n+                    if old_error == &err {\n+                        return;\n+                    }\n+                }\n+                OutputValue::Error(err)\n             }\n         };\n         let old_content = task.insert(CachedDataItem::Output {\n@@ -129,7 +127,6 @@ impl UpdateOutputOperation {\n \n         drop(task);\n         drop(old_content);\n-        drop(old_error);\n \n         UpdateOutputOperation::MakeDependentTasksDirty {\n             #[cfg(feature = \"trace_task_dirty\")]"
        },
        {
            "sha": "c4034363c71800b77f5b643d0984856db39a9b17",
            "filename": "turbopack/crates/turbo-tasks-backend/src/data.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 16,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -4,9 +4,9 @@ use rustc_hash::FxHashSet;\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{\n     CellId, KeyValuePair, SessionId, TaskId, TraitTypeId, TypedSharedReference, ValueTypeId,\n+    backend::TurboTasksExecutionError,\n     event::{Event, EventListener},\n     registry,\n-    util::SharedError,\n };\n \n use crate::{\n@@ -52,18 +52,18 @@ pub struct CollectiblesRef {\n     pub collectible_type: TraitTypeId,\n }\n \n-#[derive(Debug, Copy, Clone, PartialEq, Eq, Serialize, Deserialize)]\n+#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]\n pub enum OutputValue {\n     Cell(CellRef),\n     Output(TaskId),\n-    Error,\n+    Error(TurboTasksExecutionError),\n }\n impl OutputValue {\n     fn is_transient(&self) -> bool {\n         match self {\n             OutputValue::Cell(cell) => cell.task.is_transient(),\n             OutputValue::Output(task) => task.is_transient(),\n-            OutputValue::Error => false,\n+            OutputValue::Error(_) => false,\n         }\n     }\n }\n@@ -482,12 +482,6 @@ pub enum CachedDataItem {\n         target: CollectiblesRef,\n         value: (),\n     },\n-\n-    // Transient Error State\n-    #[serde(skip)]\n-    Error {\n-        value: SharedError,\n-    },\n }\n \n impl CachedDataItem {\n@@ -523,7 +517,6 @@ impl CachedDataItem {\n             CachedDataItem::OutdatedOutputDependency { .. } => false,\n             CachedDataItem::OutdatedCellDependency { .. } => false,\n             CachedDataItem::OutdatedCollectiblesDependency { .. } => false,\n-            CachedDataItem::Error { .. } => false,\n         }\n     }\n \n@@ -578,7 +571,6 @@ impl CachedDataItem {\n             | Self::OutdatedCollectiblesDependency { .. }\n             | Self::InProgressCell { .. }\n             | Self::InProgress { .. }\n-            | Self::Error { .. }\n             | Self::Activeness { .. } => TaskDataCategory::All,\n         }\n     }\n@@ -621,7 +613,6 @@ impl CachedDataItemKey {\n             CachedDataItemKey::OutdatedOutputDependency { .. } => false,\n             CachedDataItemKey::OutdatedCellDependency { .. } => false,\n             CachedDataItemKey::OutdatedCollectiblesDependency { .. } => false,\n-            CachedDataItemKey::Error { .. } => false,\n         }\n     }\n \n@@ -660,7 +651,6 @@ impl CachedDataItemType {\n             | Self::OutdatedCollectiblesDependency { .. }\n             | Self::InProgressCell { .. }\n             | Self::InProgress { .. }\n-            | Self::Error { .. }\n             | Self::Activeness { .. } => TaskDataCategory::All,\n         }\n     }\n@@ -693,8 +683,7 @@ impl CachedDataItemType {\n             | Self::OutdatedCollectible\n             | Self::OutdatedOutputDependency\n             | Self::OutdatedCellDependency\n-            | Self::OutdatedCollectiblesDependency\n-            | Self::Error => false,\n+            | Self::OutdatedCollectiblesDependency => false,\n         }\n     }\n }"
        },
        {
            "sha": "cbcaf5e66c9bf353227d568269b473dd7e00b795",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/panics.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fpanics.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fpanics.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fpanics.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -1,7 +1,7 @@\n use core::panic;\n use std::{\n     panic::{set_hook, take_hook},\n-    sync::{Arc, LazyLock},\n+    sync::LazyLock,\n };\n \n use anyhow::Result;\n@@ -28,11 +28,11 @@ async fn test_panics_include_location() {\n     let error = result.unwrap_err();\n     let root_cause = error.root_cause();\n \n-    let Some(panic) = root_cause.downcast_ref::<Arc<TurboTasksExecutionError>>() else {\n+    let Some(panic) = root_cause.downcast_ref::<TurboTasksExecutionError>() else {\n         panic!(\"Expected a TurboTasksExecutionError\");\n     };\n \n-    let TurboTasksExecutionError::Panic(panic) = &**panic else {\n+    let TurboTasksExecutionError::Panic(panic) = panic else {\n         panic!(\"Expected a TurboTasksExecutionError::Panic\");\n     };\n "
        },
        {
            "sha": "4d570ba4fccc5ce6349daf3d959eca29e644872a",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 57,
            "deletions": 33,
            "changes": 90,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -1,4 +1,5 @@\n use std::{\n+    borrow::Cow,\n     error::Error,\n     fmt::{self, Debug, Display},\n     future::Future,\n@@ -11,7 +12,9 @@ use std::{\n use anyhow::{Result, anyhow};\n use auto_hash_map::AutoMap;\n use rustc_hash::FxHasher;\n+use serde::{Deserialize, Serialize};\n use tracing::Span;\n+use turbo_rcstr::RcStr;\n \n pub use crate::id::BackendJobId;\n use crate::{\n@@ -400,10 +403,10 @@ impl TryFrom<CellContent> for SharedReference {\n pub type TaskCollectiblesMap = AutoMap<RawVc, i32, BuildHasherDefault<FxHasher>, 1>;\n \n // Structurally and functionally similar to Cow<&'static, str> but explicitly notes the importance\n-// of non-static strings potentially containing PII.\n-#[derive(Clone, Debug)]\n+// of non-static strings potentially containing PII (Personal Identifiable Information).\n+#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]\n pub enum TurboTasksExecutionErrorMessage {\n-    PIISafe(&'static str),\n+    PIISafe(Cow<'static, str>),\n     NonPIISafe(String),\n }\n \n@@ -416,21 +419,43 @@ impl Display for TurboTasksExecutionErrorMessage {\n     }\n }\n \n-#[derive(Clone, Debug)]\n+#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n+pub struct TurboTasksError {\n+    pub message: TurboTasksExecutionErrorMessage,\n+    pub source: Option<TurboTasksExecutionError>,\n+}\n+\n+#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n+pub struct TurboTaskContextError {\n+    pub task: RcStr,\n+    pub source: Option<TurboTasksExecutionError>,\n+}\n+\n+#[derive(Clone, Debug, Serialize, Deserialize, PartialEq, Eq)]\n pub enum TurboTasksExecutionError {\n     Panic(Arc<TurboTasksPanic>),\n-    Error {\n-        message: TurboTasksExecutionErrorMessage,\n-        source: Option<Arc<TurboTasksExecutionError>>,\n-    },\n+    Error(Arc<TurboTasksError>),\n+    TaskContext(Arc<TurboTaskContextError>),\n+}\n+\n+impl TurboTasksExecutionError {\n+    pub fn task_context(&self, task: impl Display) -> Self {\n+        TurboTasksExecutionError::TaskContext(Arc::new(TurboTaskContextError {\n+            task: RcStr::from(task.to_string()),\n+            source: Some(self.clone()),\n+        }))\n+    }\n }\n \n impl Error for TurboTasksExecutionError {\n     fn source(&self) -> Option<&(dyn Error + 'static)> {\n         match self {\n             TurboTasksExecutionError::Panic(_panic) => None,\n-            TurboTasksExecutionError::Error { source, .. } => {\n-                source.as_ref().map(|s| s as &dyn Error)\n+            TurboTasksExecutionError::Error(error) => {\n+                error.source.as_ref().map(|s| s as &dyn Error)\n+            }\n+            TurboTasksExecutionError::TaskContext(context_error) => {\n+                context_error.source.as_ref().map(|s| s as &dyn Error)\n             }\n         }\n     }\n@@ -440,36 +465,35 @@ impl Display for TurboTasksExecutionError {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n         match self {\n             TurboTasksExecutionError::Panic(panic) => write!(f, \"{}\", &panic),\n-            TurboTasksExecutionError::Error { message, .. } => {\n-                write!(f, \"{message}\")\n+            TurboTasksExecutionError::Error(error) => {\n+                write!(f, \"{}\", error.message)\n+            }\n+            TurboTasksExecutionError::TaskContext(context_error) => {\n+                write!(f, \"Execution of {} failed\", context_error.task)\n             }\n         }\n     }\n }\n \n-impl From<anyhow::Error> for TurboTasksExecutionError {\n-    fn from(err: anyhow::Error) -> Self {\n-        let mut current: &dyn std::error::Error = err.as_ref();\n-        let mut message = current.to_string();\n-        let mut source_exec_error = None;\n-\n-        // Flatten non-TurboTasksExecutionErrors in the error chain into a single message.\n-        // Once a TurboTasksExecutionError is found, use that as the source.\n-        while let Some(current_source) = current.source() {\n-            if let Some(turbo_error) =\n-                current_source.downcast_ref::<Arc<TurboTasksExecutionError>>()\n-            {\n-                source_exec_error = Some(turbo_error.clone());\n-                break;\n-            }\n-            message.push_str(&format!(\"\\n{current_source}\"));\n-            current = current_source;\n+impl<'l> From<&'l (dyn std::error::Error + 'static)> for TurboTasksExecutionError {\n+    fn from(err: &'l (dyn std::error::Error + 'static)) -> Self {\n+        if let Some(err) = err.downcast_ref::<TurboTasksExecutionError>() {\n+            return err.clone();\n         }\n+        let message = err.to_string();\n+        let source = err.source().map(|source| source.into());\n \n-        TurboTasksExecutionError::Error {\n+        TurboTasksExecutionError::Error(Arc::new(TurboTasksError {\n             message: TurboTasksExecutionErrorMessage::NonPIISafe(message),\n-            source: source_exec_error,\n-        }\n+            source,\n+        }))\n+    }\n+}\n+\n+impl From<anyhow::Error> for TurboTasksExecutionError {\n+    fn from(err: anyhow::Error) -> Self {\n+        let current: &(dyn std::error::Error + 'static) = err.as_ref();\n+        current.into()\n     }\n }\n \n@@ -535,7 +559,7 @@ pub trait Backend: Sync + Send {\n     fn task_execution_result(\n         &self,\n         task_id: TaskId,\n-        result: Result<RawVc, Arc<TurboTasksExecutionError>>,\n+        result: Result<RawVc, TurboTasksExecutionError>,\n         turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n     );\n "
        },
        {
            "sha": "cde866bf17d7a2e90a6cbf1665be6bd582021c06",
            "filename": "turbopack/crates/turbo-tasks/src/capture_future.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcapture_future.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcapture_future.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcapture_future.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -1,4 +1,5 @@\n use std::{\n+    borrow::Cow,\n     cell::RefCell,\n     fmt::Display,\n     future::Future,\n@@ -10,6 +11,7 @@ use std::{\n \n use anyhow::Result;\n use pin_project_lite::pin_project;\n+use serde::{Deserialize, Serialize};\n use turbo_tasks_malloc::{AllocationInfo, TurboMalloc};\n \n use crate::{LAST_ERROR_LOCATION, backend::TurboTasksExecutionErrorMessage};\n@@ -69,7 +71,7 @@ pub fn add_allocation_info(alloc_info: AllocationInfo) {\n     });\n }\n \n-#[derive(Debug, Clone)]\n+#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n pub struct TurboTasksPanic {\n     pub message: TurboTasksExecutionErrorMessage,\n     pub location: Option<String>,\n@@ -101,7 +103,7 @@ impl<T, F: Future<Output = T>> Future for CaptureFuture<T, F> {\n         let result =\n             panic::catch_unwind(panic::AssertUnwindSafe(|| this.future.poll(cx))).map_err(|err| {\n                 let message = match err.downcast_ref::<&'static str>() {\n-                    Some(s) => TurboTasksExecutionErrorMessage::PIISafe(s),\n+                    Some(s) => TurboTasksExecutionErrorMessage::PIISafe(Cow::Borrowed(s)),\n                     None => match err.downcast_ref::<String>() {\n                         Some(s) => TurboTasksExecutionErrorMessage::NonPIISafe(s.clone()),\n                         None => {"
        },
        {
            "sha": "5a5c2387701501d3dde915f8225f8680170be622",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 18,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -43,7 +43,7 @@ use crate::{\n     task_statistics::TaskStatisticsApi,\n     trace::TraceRawVcs,\n     trait_helpers::get_trait_method,\n-    util::{IdFactory, SharedError, StaticOrArc},\n+    util::{IdFactory, StaticOrArc},\n     vc::ReadVcFuture,\n };\n \n@@ -711,10 +711,8 @@ impl<B: Backend + 'static> TurboTasks<B> {\n \n                         let result = match result {\n                             Ok(Ok(raw_vc)) => Ok(raw_vc),\n-                            Ok(Err(err)) => Err(Arc::new(err.into())),\n-                            Err(err) => {\n-                                Err(Arc::new(TurboTasksExecutionError::Panic(Arc::new(err))))\n-                            }\n+                            Ok(Err(err)) => Err(err.into()),\n+                            Err(err) => Err(TurboTasksExecutionError::Panic(Arc::new(err))),\n                         };\n \n                         this.backend.task_execution_result(task_id, result, &*this);\n@@ -807,24 +805,14 @@ impl<B: Backend + 'static> TurboTasks<B> {\n \n                 let result = match result {\n                     Ok(Ok(raw_vc)) => Ok(raw_vc),\n-                    Ok(Err(err)) => Err(Arc::new(err.into())),\n-                    Err(err) => Err(Arc::new(TurboTasksExecutionError::Panic(Arc::new(err)))),\n+                    Ok(Err(err)) => Err(err.into()),\n+                    Err(err) => Err(TurboTasksExecutionError::Panic(Arc::new(err))),\n                 };\n \n                 let local_task = LocalTask::Done {\n                     output: match result {\n                         Ok(raw_vc) => OutputContent::Link(raw_vc),\n-                        Err(err) => match &*err {\n-                            TurboTasksExecutionError::Error { .. } => {\n-                                OutputContent::Error(SharedError::new(\n-                                    anyhow::Error::new(err)\n-                                        .context(format!(\"Execution of {ty} failed\")),\n-                                ))\n-                            }\n-                            TurboTasksExecutionError::Panic(err) => {\n-                                OutputContent::Panic(err.clone())\n-                            }\n-                        },\n+                        Err(err) => OutputContent::Error(err.task_context(ty)),\n                     },\n                 };\n "
        },
        {
            "sha": "962480aa8aaa064f5fd6965e34032d20d090274b",
            "filename": "turbopack/crates/turbo-tasks/src/output.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Foutput.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Foutput.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Foutput.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -1,26 +1,21 @@\n-use std::{\n-    fmt::{self, Display},\n-    sync::Arc,\n-};\n+use std::fmt::{self, Display};\n \n use anyhow::anyhow;\n \n-use crate::{RawVc, TurboTasksPanic, util::SharedError};\n+use crate::{RawVc, backend::TurboTasksExecutionError};\n \n /// A helper type representing the output of a resolved task.\n #[derive(Clone, Debug)]\n pub enum OutputContent {\n     Link(RawVc),\n-    Error(SharedError),\n-    Panic(Arc<TurboTasksPanic>),\n+    Error(TurboTasksExecutionError),\n }\n \n impl OutputContent {\n     pub fn as_read_result(&self) -> anyhow::Result<RawVc> {\n         match &self {\n             Self::Error(err) => Err(anyhow!(err.clone())),\n             Self::Link(raw_vc) => Ok(*raw_vc),\n-            Self::Panic(err) => Err(anyhow!(err.clone())),\n         }\n     }\n }\n@@ -30,7 +25,6 @@ impl Display for OutputContent {\n         match self {\n             Self::Link(raw_vc) => write!(f, \"link {raw_vc:?}\"),\n             Self::Error(err) => write!(f, \"error {err}\"),\n-            Self::Panic(err) => write!(f, \"panic {err}\"),\n         }\n     }\n }"
        },
        {
            "sha": "6b7c0721c399c4b8295c6392fa6d4d91c86120a1",
            "filename": "turbopack/crates/turbo-tasks/src/util.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ce288172c1b91b3746a817dd27f85c10bd9a199/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Futil.rs?ref=4ce288172c1b91b3746a817dd27f85c10bd9a199",
            "patch": "@@ -34,6 +34,13 @@ impl SharedError {\n     }\n }\n \n+impl AsRef<dyn StdError> for SharedError {\n+    fn as_ref(&self) -> &(dyn StdError + 'static) {\n+        let err: &anyhow::Error = &self.inner;\n+        err.as_ref()\n+    }\n+}\n+\n impl StdError for SharedError {\n     fn source(&self) -> Option<&(dyn std::error::Error + 'static)> {\n         self.inner.source()"
        }
    ],
    "stats": {
        "total": 241,
        "additions": 122,
        "deletions": 119
    }
}