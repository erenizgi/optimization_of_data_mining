{
    "author": "wbinnssmith",
    "message": "Alternate bundler: use equivalent native plugins for built-in plugins (#77355)\n\nWhile we wonâ€™t use native plugins for equivalents of Next.js specific\nplugins, we should use these for equivalents of built-in plugins like\n`ProvidePlugin`, `IgnorePlugin`, and `EntryPlugin`. Otherwise, Rspack\nbehaves unexpectedly.\n\nTest Plan: Successfully build `@formbricks/web`",
    "sha": "317c12975c7160ee9f93408b18e412cd5d27b095",
    "files": [
        {
            "sha": "681416862bfaa392898a27df4fd6bdb7d3ae24ed",
            "filename": "packages/next/src/build/compiler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fcompiler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcompiler.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -1,5 +1,6 @@\n-import { webpack } from 'next/dist/compiled/webpack/webpack'\n+import type { webpack } from 'next/dist/compiled/webpack/webpack'\n import type { Span } from '../trace'\n+import getWebpackBundler from '../shared/lib/get-webpack-bundler'\n \n export type CompilerResult = {\n   errors: webpack.StatsError[]\n@@ -51,7 +52,8 @@ export function runCompiler(\n   ]\n > {\n   return new Promise((resolve, reject) => {\n-    const compiler = webpack(config)\n+    const compiler = getWebpackBundler()(config)\n+\n     // Ensure we use the previous inputFileSystem\n     if (inputFileSystem) {\n       compiler.inputFileSystem = inputFileSystem"
        },
        {
            "sha": "3d439f1d8bb0d63e0b2a93dec230a5a740abdbb5",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -95,6 +95,7 @@ import {\n } from './next-dir-paths'\n import { getRspackCore, getRspackReactRefresh } from '../shared/lib/get-rspack'\n import { RspackProfilingPlugin } from './webpack/plugins/rspack-profiling-plugin'\n+import getWebpackBundler from '../shared/lib/get-webpack-bundler'\n \n type ExcludesFalse = <T>(x: T | false) => x is T\n type ClientEntries = {\n@@ -341,6 +342,7 @@ export default async function getBaseWebpackConfig(\n     fetchCacheKeyPrefix?: string\n   }\n ): Promise<webpack.Configuration> {\n+  const bundler = getWebpackBundler()\n   const isClient = compilerType === COMPILER_NAMES.client\n   const isEdgeServer = compilerType === COMPILER_NAMES.edgeServer\n   const isNodeServer = compilerType === COMPILER_NAMES.server\n@@ -1870,7 +1872,7 @@ export default async function getBaseWebpackConfig(\n     },\n     plugins: [\n       isNodeServer &&\n-        new webpack.NormalModuleReplacementPlugin(\n+        new bundler.NormalModuleReplacementPlugin(\n           /\\.\\/(.+)\\.shared-runtime$/,\n           function (resource) {\n             const moduleName = path.basename(\n@@ -1902,7 +1904,7 @@ export default async function getBaseWebpackConfig(\n           : new ReactRefreshWebpackPlugin(webpack)),\n       // Makes sure `Buffer` and `process` are polyfilled in client and flight bundles (same behavior as webpack 4)\n       (isClient || isEdgeServer) &&\n-        new webpack.ProvidePlugin({\n+        new bundler.ProvidePlugin({\n           // Buffer is used by getInlineScriptSource\n           Buffer: [require.resolve('buffer'), 'Buffer'],\n           // Avoid process being overridden when in web run time\n@@ -1952,7 +1954,7 @@ export default async function getBaseWebpackConfig(\n       // solution that requires the user to opt into importing specific locales.\n       // https://github.com/jmblog/how-to-optimize-momentjs-with-webpack\n       config.excludeDefaultMomentLocales &&\n-        new webpack.IgnorePlugin({\n+        new bundler.IgnorePlugin({\n           resourceRegExp: /^\\.\\/locale$/,\n           contextRegExp: /moment$/,\n         }),\n@@ -1969,14 +1971,14 @@ export default async function getBaseWebpackConfig(\n             ]\n \n             if (isClient || isEdgeServer) {\n-              devPlugins.push(new webpack.HotModuleReplacementPlugin())\n+              devPlugins.push(new bundler.HotModuleReplacementPlugin())\n             }\n \n             return devPlugins\n           })()\n         : []),\n       !dev &&\n-        new webpack.IgnorePlugin({\n+        new bundler.IgnorePlugin({\n           resourceRegExp: /react-is/,\n           contextRegExp: /next[\\\\/]dist[\\\\/]/,\n         }),"
        },
        {
            "sha": "416a4972467dc532ea361f3bb5e21ffb784172a0",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -3,13 +3,13 @@ import type {\n   NextConfigComplete,\n } from '../../../server/config-shared'\n import type { MiddlewareMatcher } from '../../analysis/get-page-static-info'\n-import { webpack } from 'next/dist/compiled/webpack/webpack'\n import { needsExperimentalReact } from '../../../lib/needs-experimental-react'\n import { checkIsAppPPREnabled } from '../../../server/lib/experimental/ppr'\n import {\n   getNextConfigEnv,\n   getNextPublicEnvironmentVariables,\n } from '../../../lib/static-env'\n+import getWebpackBundler from '../../../shared/lib/get-webpack-bundler'\n \n type BloomFilter = ReturnType<\n   import('../../../shared/lib/bloom-filter').BloomFilter['export']\n@@ -293,5 +293,5 @@ export function getDefineEnv({\n }\n \n export function getDefineEnvPlugin(options: DefineEnvPluginOptions) {\n-  return new webpack.DefinePlugin(getDefineEnv(options))\n+  return new (getWebpackBundler().DefinePlugin)(getDefineEnv(options))\n }"
        },
        {
            "sha": "24e53380fa99f5fd7f0b72f86633795883cd5531",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -49,6 +49,7 @@ import {\n } from '../../../lib/metadata/is-metadata-route'\n import type { MetadataRouteLoaderOptions } from '../loaders/next-metadata-route-loader'\n import type { FlightActionEntryLoaderActions } from '../loaders/next-flight-action-entry-loader'\n+import getWebpackBundler from '../../../shared/lib/get-webpack-bundler'\n \n interface Options {\n   dev: boolean\n@@ -784,6 +785,7 @@ export class FlightClientEntryPlugin {\n     addRSCEntryPromise: Promise<void>,\n     ssrDep: ReturnType<typeof webpack.EntryPlugin.createDependency>,\n   ] {\n+    const bundler = getWebpackBundler()\n     let shouldInvalidate = false\n \n     const modules = Object.keys(clientImports)\n@@ -853,12 +855,12 @@ export class FlightClientEntryPlugin {\n       pluginState.injectedClientEntries[bundlePath] = clientBrowserLoader\n     }\n \n-    const clientComponentSSREntryDep = webpack.EntryPlugin.createDependency(\n+    const clientComponentSSREntryDep = bundler.EntryPlugin.createDependency(\n       clientServerLoader,\n       { name: bundlePath }\n     )\n \n-    const clientComponentRSCEntryDep = webpack.EntryPlugin.createDependency(\n+    const clientComponentRSCEntryDep = bundler.EntryPlugin.createDependency(\n       clientServerLoader,\n       { name: bundlePath }\n     )\n@@ -897,6 +899,7 @@ export class FlightClientEntryPlugin {\n     createdActionIds: Set<string>\n     fromClient?: boolean\n   }) {\n+    const bundler = getWebpackBundler()\n     const actionsArray = Array.from(actions.entries())\n     for (const [, actionsFromModule] of actions) {\n       for (const { id } of actionsFromModule) {\n@@ -939,7 +942,7 @@ export class FlightClientEntryPlugin {\n     }\n \n     // Inject the entry to the server compiler\n-    const actionEntryDep = webpack.EntryPlugin.createDependency(actionLoader, {\n+    const actionEntryDep = bundler.EntryPlugin.createDependency(actionLoader, {\n       name: bundlePath,\n     })\n "
        },
        {
            "sha": "066a3f113f773fdcdadf6752a4414af1eb293752",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -6,7 +6,7 @@ import type { IncomingMessage, ServerResponse } from 'http'\n import type { UrlObject } from 'url'\n import type { RouteDefinition } from '../route-definitions/route-definition'\n \n-import { webpack, StringXor } from 'next/dist/compiled/webpack/webpack'\n+import { type webpack, StringXor } from 'next/dist/compiled/webpack/webpack'\n import {\n   getOverlayMiddleware,\n   getSourceMapMiddleware,\n@@ -86,6 +86,7 @@ import { getNodeDebugType } from '../lib/utils'\n import { getNextErrorFeedbackMiddleware } from '../../client/components/react-dev-overlay/server/get-next-error-feedback-middleware'\n import { getDevOverlayFontMiddleware } from '../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware'\n import { getDisableDevIndicatorMiddleware } from './dev-indicator-middleware'\n+import getWebpackBundler from '../../shared/lib/get-webpack-bundler'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -735,7 +736,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       ).client,\n       ...info,\n     })\n-    const fallbackCompiler = webpack(fallbackConfig)\n+\n+    const fallbackCompiler = getWebpackBundler()(fallbackConfig)\n \n     this.fallbackWatcher = await new Promise((resolve) => {\n       let bootedFallbackCompiler = false\n@@ -1136,7 +1138,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     // @ts-ignore webpack 5\n     this.activeWebpackConfigs.parallelism = 1\n \n-    this.multiCompiler = webpack(\n+    this.multiCompiler = getWebpackBundler()(\n       this.activeWebpackConfigs\n     ) as unknown as webpack.MultiCompiler\n "
        },
        {
            "sha": "3a9b0eb905edfb6774e2e0a0dc12e6a0d99efab6",
            "filename": "packages/next/src/shared/lib/get-webpack-bundler.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-webpack-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/317c12975c7160ee9f93408b18e412cd5d27b095/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-webpack-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-webpack-bundler.ts?ref=317c12975c7160ee9f93408b18e412cd5d27b095",
            "patch": "@@ -0,0 +1,12 @@\n+import { webpack } from 'next/dist/compiled/webpack/webpack'\n+import { getRspackCore } from './get-rspack'\n+\n+/**\n+ * Depending on if Rspack is active or not, returns the appropriate set of\n+ * webpack-compatible api.\n+ *\n+ * @returns webpack bundler\n+ */\n+export default function getWebpackBundler(): typeof webpack {\n+  return process.env.NEXT_RSPACK ? getRspackCore() : webpack\n+}"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 36,
        "deletions": 15
    }
}