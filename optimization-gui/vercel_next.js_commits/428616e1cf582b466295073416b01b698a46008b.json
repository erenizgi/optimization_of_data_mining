{
    "author": "sokra",
    "message": "Turbopack: refactor side effects optimization (#82466)\n\n### What?\n\nRefactors the side effects optimization.\n\n* Gets rid of the `<module evaluation>` and the `<exports>` module.\n* Only two modules: `<local>` and the facade.\n* The local module has all the evaluation side effects and local exports.\n* The facade reexports the local module and all reexports of the module.\n* `require()` and `import *` will resolve to the facade module\n* `import \"...\"` will resolve to the locals\n* `import { x } from \"...\"` will follow reexports and finally imports from a locals module",
    "sha": "428616e1cf582b466295073416b01b698a46008b",
    "files": [
        {
            "sha": "f38ad5a905aba884ad727d8d7f7107baa4928e08",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -2430,7 +2430,7 @@ describe('Cache Components Errors', () => {\n                     |                                      ^\",\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"{module evaluation} .next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js (server actions loader) (1:1)\",\n                    \"<FIXME-file-protocol>\",\n                    \"<FIXME-next-dist-dir>\",\n                  ],\n@@ -2487,8 +2487,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js (server actions loader):1:1)\n                      at a (<next-dist-dir>)\n-                     at b (<next-dist-dir>)\n                    19 | }\n                    20 |\n                  > 21 | const getCachedData = unstable_cache(async () => {\n@@ -2506,6 +2506,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at a (<next-dist-dir>)\n                    19 | }\n                    20 |\n@@ -2574,7 +2575,7 @@ describe('Cache Components Errors', () => {\n                     | ^\",\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"{module evaluation} .next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader) (1:1)\",\n                    \"<FIXME-file-protocol>\",\n                    \"<FIXME-next-dist-dir>\",\n                  ],\n@@ -2632,8 +2633,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader):1:1)\n                      at a (<next-dist-dir>)\n-                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2643,8 +2644,8 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at c (<next-dist-dir>)\n-                     at d (<next-dist-dir>)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader):1:1)\n+                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2662,7 +2663,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:16)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at a (<next-dist-dir>)\n                    13 | }\n                    14 |\n@@ -2673,7 +2674,7 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:16)\n+                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at b (<next-dist-dir>)\n                    13 | }\n                    14 |"
        },
        {
            "sha": "3d9119f82fb0f5736fab9134d6929084a05b9ea5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/placeable.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -230,7 +230,7 @@ pub enum EcmascriptExports {\n #[turbo_tasks::value_impl]\n impl EcmascriptExports {\n     #[turbo_tasks::function]\n-    pub async fn needs_facade(&self) -> Result<Vc<bool>> {\n+    pub async fn split_locals_and_reexports(&self) -> Result<Vc<bool>> {\n         Ok(match self {\n             EcmascriptExports::EsmExports(exports) => {\n                 let exports = exports.await?;"
        },
        {
            "sha": "bb958cf7f286d36eaeb1f322c5704d8e153d96d3",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -850,8 +850,8 @@ pub struct EcmascriptModuleContentOptions {\n     specified_module_type: SpecifiedModuleType,\n     chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n     references: ResolvedVc<ModuleReferences>,\n-    esm_references: ResolvedVc<EsmAssetReferences>,\n     part_references: Vec<ResolvedVc<EcmascriptModulePartReference>>,\n+    esm_references: ResolvedVc<EsmAssetReferences>,\n     code_generation: ResolvedVc<CodeGens>,\n     async_module: ResolvedVc<OptionAsyncModule>,\n     generate_source_map: bool,\n@@ -872,8 +872,8 @@ impl EcmascriptModuleContentOptions {\n             module,\n             chunking_context,\n             references,\n-            esm_references,\n             part_references,\n+            esm_references,\n             code_generation,\n             async_module,\n             exports,\n@@ -912,14 +912,14 @@ impl EcmascriptModuleContentOptions {\n                 },\n             ];\n \n-            let esm_code_gens = esm_references\n-                .await?\n+            let part_code_gens = part_references\n                 .iter()\n                 .map(|r| r.code_generation(**chunking_context, scope_hoisting_context))\n                 .try_join()\n                 .await?;\n \n-            let part_code_gens = part_references\n+            let esm_code_gens = esm_references\n+                .await?\n                 .iter()\n                 .map(|r| r.code_generation(**chunking_context, scope_hoisting_context))\n                 .try_join()\n@@ -933,9 +933,9 @@ impl EcmascriptModuleContentOptions {\n                 .await?;\n \n             anyhow::Ok(\n-                esm_code_gens\n+                part_code_gens\n                     .into_iter()\n-                    .chain(part_code_gens.into_iter())\n+                    .chain(esm_code_gens.into_iter())\n                     .chain(additional_code_gens.into_iter().flatten())\n                     .chain(code_gens.into_iter())\n                     .collect(),"
        },
        {
            "sha": "288e76e53751db25adc3f9cae5227590663d5a6b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 25,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -141,17 +141,8 @@ pub async fn follow_reexports(\n     side_effect_free_packages: Vc<Glob>,\n     ignore_side_effect_of_entry: bool,\n ) -> Result<Vc<FollowExportsResult>> {\n-    if !ignore_side_effect_of_entry\n-        && !*module\n-            .is_marked_as_side_effect_free(side_effect_free_packages)\n-            .await?\n-    {\n-        return Ok(FollowExportsResult::cell(FollowExportsResult {\n-            module,\n-            export_name: Some(export_name),\n-            ty: FoundExportType::SideEffects,\n-        }));\n-    }\n+    let mut ignore_side_effects = ignore_side_effect_of_entry;\n+\n     let mut module = module;\n     let mut export_name = export_name;\n     loop {\n@@ -164,12 +155,26 @@ pub async fn follow_reexports(\n             }));\n         };\n \n+        if !ignore_side_effects\n+            && !*module\n+                .is_marked_as_side_effect_free(side_effect_free_packages)\n+                .await?\n+        {\n+            // TODO It's unfortunate that we have to use the whole module here.\n+            // This is often the Facade module, which includes all reexports.\n+            // Often we could use Locals + the followed reexports instead.\n+            return Ok(FollowExportsResult::cell(FollowExportsResult {\n+                module,\n+                export_name: Some(export_name),\n+                ty: FoundExportType::SideEffects,\n+            }));\n+        }\n+        ignore_side_effects = false;\n+\n         // Try to find the export in the local exports\n         let exports_ref = exports.await?;\n         if let Some(export) = exports_ref.exports.get(&export_name) {\n-            match handle_declared_export(module, export_name, export, side_effect_free_packages)\n-                .await?\n-            {\n+            match handle_declared_export(module, export_name, export).await? {\n                 ControlFlow::Continue((m, n)) => {\n                     module = m.to_resolved().await?;\n                     export_name = n;\n@@ -222,23 +227,12 @@ async fn handle_declared_export(\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     export_name: RcStr,\n     export: &EsmExport,\n-    side_effect_free_packages: Vc<Glob>,\n ) -> Result<ControlFlow<FollowExportsResult, (Vc<Box<dyn EcmascriptChunkPlaceable>>, RcStr)>> {\n     match export {\n         EsmExport::ImportedBinding(reference, name, _) => {\n             if let ReferencedAsset::Some(module) =\n                 *ReferencedAsset::from_resolve_result(reference.resolve_reference()).await?\n             {\n-                if !*module\n-                    .is_marked_as_side_effect_free(side_effect_free_packages)\n-                    .await?\n-                {\n-                    return Ok(ControlFlow::Break(FollowExportsResult {\n-                        module,\n-                        export_name: Some(name.clone()),\n-                        ty: FoundExportType::SideEffects,\n-                    }));\n-                }\n                 return Ok(ControlFlow::Continue((*module, name.clone())));\n             }\n         }\n@@ -286,6 +280,7 @@ async fn find_export_from_reexports(\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     export_name: RcStr,\n ) -> Result<Vc<FindExportFromReexportsResult>> {\n+    // TODO why do we need a special case for this?\n     if let Some(module) =\n         Vc::try_resolve_downcast_type::<EcmascriptModulePartAsset>(*module).await?\n         && matches!(module.await?.part, ModulePart::Exports)"
        },
        {
            "sha": "c5115fe9e7fd1ece3e14b90866c8f01f2338792f",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -171,7 +171,6 @@ pub struct AnalyzeEcmascriptModuleResult {\n     pub esm_references: ResolvedVc<EsmAssetReferences>,\n     pub esm_local_references: ResolvedVc<EsmAssetReferences>,\n     pub esm_reexport_references: ResolvedVc<EsmAssetReferences>,\n-    pub esm_evaluation_references: ResolvedVc<EsmAssetReferences>,\n \n     pub code_generation: ResolvedVc<CodeGens>,\n     pub exports: ResolvedVc<EcmascriptExports>,\n@@ -217,7 +216,6 @@ pub struct AnalyzeEcmascriptModuleResultBuilder {\n     esm_references: FxHashSet<usize>,\n     esm_local_references: FxHashSet<usize>,\n     esm_reexport_references: FxHashSet<usize>,\n-    esm_evaluation_references: FxHashSet<usize>,\n \n     esm_references_free_var: FxIndexMap<RcStr, ResolvedVc<EsmAssetReference>>,\n     // Ad-hoc created import references that are resolved `import * as x from ...; x.foo` accesses\n@@ -239,7 +237,6 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n             esm_references: Default::default(),\n             esm_local_references: Default::default(),\n             esm_reexport_references: Default::default(),\n-            esm_evaluation_references: Default::default(),\n             esm_references_rewritten: Default::default(),\n             esm_references_free_var: Default::default(),\n             code_gens: Default::default(),\n@@ -282,7 +279,6 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n     pub fn add_esm_evaluation_reference(&mut self, idx: usize) {\n         self.esm_references.insert(idx);\n         self.esm_local_references.insert(idx);\n-        self.esm_evaluation_references.insert(idx);\n     }\n \n     /// Adds a codegen to the analysis result.\n@@ -369,8 +365,6 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n         });\n         let mut esm_reexport_references = track_reexport_references\n             .then(|| Vec::with_capacity(self.esm_reexport_references.len()));\n-        let mut esm_evaluation_references = track_reexport_references\n-            .then(|| Vec::with_capacity(self.esm_evaluation_references.len()));\n         for (i, reference) in import_references.iter().enumerate() {\n             if self.esm_references.contains(&i) {\n                 esm_references.push(*reference);\n@@ -392,11 +386,6 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n                         .flat_map(|m| m.values().copied()),\n                 );\n             }\n-            if let Some(esm_evaluation_references) = &mut esm_evaluation_references\n-                && self.esm_evaluation_references.contains(&i)\n-            {\n-                esm_evaluation_references.push(*reference);\n-            }\n             if let Some(esm_reexport_references) = &mut esm_reexport_references\n                 && self.esm_reexport_references.contains(&i)\n             {\n@@ -415,9 +404,6 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n                 esm_reexport_references: ResolvedVc::cell(\n                     esm_reexport_references.unwrap_or_default(),\n                 ),\n-                esm_evaluation_references: ResolvedVc::cell(\n-                    esm_evaluation_references.unwrap_or_default(),\n-                ),\n                 code_generation: ResolvedVc::cell(self.code_gens),\n                 exports: self.exports.resolved_cell(),\n                 async_module: self.async_module,"
        },
        {
            "sha": "010e553b78597cc2b5721bd48b57dd173f9dd4e7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 102,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -1,7 +1,6 @@\n use std::collections::BTreeMap;\n \n use anyhow::{Result, bail};\n-use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::{File, FileContent, glob::Glob};\n use turbopack_core::{\n@@ -37,6 +36,9 @@ use crate::{\n #[turbo_tasks::value]\n pub struct EcmascriptModuleFacadeModule {\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+    /// The part of the module that this facade represents.\n+    /// ModulePart::Facade | ModulePart::RenamedExport |\n+    /// ModulePart::RenamedNamespace\n     part: ModulePart,\n }\n \n@@ -47,6 +49,15 @@ impl EcmascriptModuleFacadeModule {\n         module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n         part: ModulePart,\n     ) -> Vc<Self> {\n+        debug_assert!(\n+            matches!(\n+                part,\n+                ModulePart::Facade\n+                    | ModulePart::RenamedExport { .. }\n+                    | ModulePart::RenamedNamespace { .. }\n+            ),\n+            \"{part:?} is unexpected for EcmascriptModuleFacadeModule\"\n+        );\n         EcmascriptModuleFacadeModule { module, part }.cell()\n     }\n \n@@ -73,46 +84,23 @@ impl EcmascriptModuleFacadeModule {\n     pub async fn specific_references(\n         &self,\n     ) -> Result<(\n-        ResolvedVc<EsmAssetReferences>,\n         Vec<ResolvedVc<EcmascriptModulePartReference>>,\n+        ResolvedVc<EsmAssetReferences>,\n     )> {\n         Ok(match &self.part {\n-            ModulePart::Evaluation => {\n-                let Some(module) =\n-                    ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(self.module)\n-                else {\n-                    bail!(\n-                        \"Expected EcmascriptModuleAsset for a EcmascriptModuleFacadeModule with \\\n-                         ModulePart::Evaluation\"\n-                    );\n-                };\n-                let result = module.analyze().await?;\n-                (\n-                    result.esm_evaluation_references,\n-                    vec![\n-                        EcmascriptModulePartReference::new_part(\n-                            *self.module,\n-                            ModulePart::locals(),\n-                            ExportUsage::evaluation(),\n-                        )\n-                        .to_resolved()\n-                        .await?,\n-                    ],\n-                )\n-            }\n-            ModulePart::Exports => {\n+            ModulePart::Facade => {\n                 let Some(module) =\n                     ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(self.module)\n                 else {\n                     bail!(\n                         \"Expected EcmascriptModuleAsset for a EcmascriptModuleFacadeModule with \\\n-                         ModulePart::Exports\"\n+                         ModulePart::Facade\"\n                     );\n                 };\n                 let result = module.analyze().await?;\n                 (\n-                    result.esm_reexport_references,\n                     vec![\n+                        // TODO skip if side effect free and no local exports\n                         EcmascriptModulePartReference::new_part(\n                             *self.module,\n                             ModulePart::locals(),\n@@ -121,29 +109,10 @@ impl EcmascriptModuleFacadeModule {\n                         .to_resolved()\n                         .await?,\n                     ],\n+                    result.esm_reexport_references,\n                 )\n             }\n-            ModulePart::Facade => (\n-                EsmAssetReferences::empty().to_resolved().await?,\n-                vec![\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::evaluation(),\n-                        ExportUsage::evaluation(),\n-                    )\n-                    .to_resolved()\n-                    .await?,\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::exports(),\n-                        ExportUsage::all(),\n-                    )\n-                    .to_resolved()\n-                    .await?,\n-                ],\n-            ),\n             ModulePart::RenamedNamespace { .. } => (\n-                EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n                     EcmascriptModulePartReference::new_normal(\n                         *self.module,\n@@ -153,11 +122,11 @@ impl EcmascriptModuleFacadeModule {\n                     .to_resolved()\n                     .await?,\n                 ],\n+                EsmAssetReferences::empty().to_resolved().await?,\n             ),\n             ModulePart::RenamedExport {\n                 original_export, ..\n             } => (\n-                EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n                     EcmascriptModulePartReference::new_normal(\n                         *self.module,\n@@ -167,6 +136,7 @@ impl EcmascriptModuleFacadeModule {\n                     .to_resolved()\n                     .await?,\n                 ],\n+                EsmAssetReferences::empty().to_resolved().await?,\n             ),\n             _ => {\n                 bail!(\"Unexpected ModulePart for EcmascriptModuleFacadeModule\");\n@@ -184,12 +154,11 @@ impl Module for EcmascriptModuleFacadeModule {\n \n     #[turbo_tasks::function]\n     async fn references(self: Vc<Self>) -> Result<Vc<ModuleReferences>> {\n-        let (esm_references, part_references) = self.await?.specific_references().await?;\n-        let references = esm_references\n-            .await?\n+        let (part_references, esm_references) = self.await?.specific_references().await?;\n+        let references = part_references\n             .iter()\n             .map(|r| ResolvedVc::upcast(*r))\n-            .chain(part_references.iter().map(|r| ResolvedVc::upcast(*r)))\n+            .chain(esm_references.await?.iter().map(|r| ResolvedVc::upcast(*r)))\n             .collect();\n         Ok(Vc::cell(references))\n     }\n@@ -239,16 +208,16 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n-        let (esm_references, part_references) = self.await?.specific_references().await?;\n+        let (part_references, esm_references) = self.await?.specific_references().await?;\n \n         Ok(EcmascriptModuleContentOptions {\n             parsed: ParseResult::empty().to_resolved().await?,\n             module: ResolvedVc::upcast(self),\n             specified_module_type: SpecifiedModuleType::EcmaScript,\n             chunking_context,\n             references: self.references().to_resolved().await?,\n-            esm_references,\n             part_references,\n+            esm_references,\n             code_generation: CodeGens::empty().to_resolved().await?,\n             async_module: ResolvedVc::cell(Some(self.async_module().to_resolved().await?)),\n             // The facade module cannot generate source maps, because the inserted references\n@@ -271,7 +240,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n         let mut star_exports = Vec::new();\n \n         match &self.part {\n-            ModulePart::Exports => {\n+            ModulePart::Facade => {\n                 let EcmascriptExports::EsmExports(esm_exports) = *self.module.get_exports().await?\n                 else {\n                     bail!(\n@@ -290,7 +259,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                         EcmascriptModulePartReference::new_part(\n                                             *self.module,\n                                             ModulePart::locals(),\n-                                            ExportUsage::all(),\n+                                            ExportUsage::named(name.clone()),\n                                         )\n                                         .to_resolved()\n                                         .await?,\n@@ -320,44 +289,6 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                 }\n                 star_exports.extend(esm_exports.star_exports.iter().copied());\n             }\n-            ModulePart::Facade => {\n-                // Reexport everything from the reexports module\n-                // (including default export if any)\n-                let EcmascriptExports::EsmExports(esm_exports) = *self.module.get_exports().await?\n-                else {\n-                    bail!(\n-                        \"EcmascriptModuleFacadeModule must only be used on modules with EsmExports\"\n-                    );\n-                };\n-                let esm_exports = esm_exports.await?;\n-                if esm_exports.exports.keys().any(|name| name == \"default\") {\n-                    exports.insert(\n-                        rcstr!(\"default\"),\n-                        EsmExport::ImportedBinding(\n-                            ResolvedVc::upcast(\n-                                EcmascriptModulePartReference::new_part(\n-                                    *self.module,\n-                                    ModulePart::exports(),\n-                                    ExportUsage::all(),\n-                                )\n-                                .to_resolved()\n-                                .await?,\n-                            ),\n-                            rcstr!(\"default\"),\n-                            false,\n-                        ),\n-                    );\n-                }\n-                star_exports.push(ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::exports(),\n-                        ExportUsage::all(),\n-                    )\n-                    .to_resolved()\n-                    .await?,\n-                ));\n-            }\n             ModulePart::RenamedExport {\n                 original_export,\n                 export,\n@@ -393,9 +324,6 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     )),\n                 );\n             }\n-            ModulePart::Evaluation => {\n-                // no exports\n-            }\n             _ => bail!(\"Unexpected ModulePart for EcmascriptModuleFacadeModule\"),\n         }\n \n@@ -413,12 +341,12 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n         side_effect_free_packages: Vc<Glob>,\n     ) -> Result<Vc<bool>> {\n         Ok(match self.part {\n-            ModulePart::Evaluation | ModulePart::Facade => self\n+            ModulePart::Facade => self\n                 .module\n                 .is_marked_as_side_effect_free(side_effect_free_packages),\n-            ModulePart::Exports\n-            | ModulePart::RenamedExport { .. }\n-            | ModulePart::RenamedNamespace { .. } => Vc::cell(true),\n+            ModulePart::RenamedExport { .. } | ModulePart::RenamedNamespace { .. } => {\n+                Vc::cell(true)\n+            }\n             _ => bail!(\"Unexpected ModulePart for EcmascriptModuleFacadeModule\"),\n         })\n     }"
        },
        {
            "sha": "925db52a62410cd24aaabe0ab18d4db3360f6308",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -54,6 +54,13 @@ impl EcmascriptModulePartReference {\n         part: ModulePart,\n         export_usage: ResolvedVc<ExportUsage>,\n     ) -> Vc<Self> {\n+        debug_assert!(matches!(\n+            part,\n+            ModulePart::Locals\n+                | ModulePart::Facade\n+                | ModulePart::RenamedExport { .. }\n+                | ModulePart::RenamedNamespace { .. }\n+        ));\n         EcmascriptModulePartReference {\n             module,\n             part,\n@@ -104,14 +111,12 @@ impl ModuleReference for EcmascriptModulePartReference {\n                         };\n                         Vc::upcast::<Box<dyn Module>>(EcmascriptModuleLocalsModule::new(*module))\n                     }\n-                    ModulePart::Exports\n-                    | ModulePart::Evaluation\n-                    | ModulePart::Facade\n+                    ModulePart::Facade\n                     | ModulePart::RenamedExport { .. }\n                     | ModulePart::RenamedNamespace { .. } => Vc::upcast(\n                         EcmascriptModuleFacadeModule::new(*self.module, self.part.clone()),\n                     ),\n-                    ModulePart::Export(..) | ModulePart::Internal(..) => {\n+                    _ => {\n                         bail!(\n                             \"Unexpected ModulePart \\\"{}\\\" for EcmascriptModulePartReference\",\n                             self.part"
        },
        {
            "sha": "bb7c887279115483746fcc1ecc61f13bd829dcab",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export/issues/__l_Export __c_Abc__ doesn't exist in target modul-a98bef.txt",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Fissues%2F__l_Export%20__c_Abc__%20doesn't%20exist%20in%20target%20modul-a98bef.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Fissues%2F__l_Export%20__c_Abc__%20doesn't%20exist%20in%20target%20modul-a98bef.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Fissues%2F__l_Export%20__c_Abc__%20doesn't%20exist%20in%20target%20modul-a98bef.txt?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -8,7 +8,7 @@ error - [bindings] /turbopack/crates/turbopack-tests/tests/execution/turbopack/e\n        4 | import * as X from './module'\n        5 | \n   \n-  The export Abc was not found in module [project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export/input/invalid-export/module.js [test] (ecmascript) <exports>.\n+  The export Abc was not found in module [project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export/input/invalid-export/module.js [test] (ecmascript).\n   \n   Did you mean to import Abd?\n   ",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export/issues/__l_Export __c_Abc__ doesn't exist in target modul-2cf4be.txt"
        },
        {
            "sha": "0fe9792747cf09947aaa610b4fdf0bb8163bcf10",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/side-effects-optimization/cycle-order/input/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fside-effects-optimization%2Fcycle-order%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fside-effects-optimization%2Fcycle-order%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fside-effects-optimization%2Fcycle-order%2Finput%2Findex.js?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -2,10 +2,5 @@ import { something } from './main'\n \n it('correct order', () => {\n   expect(something).toBe('inner')\n-  expect(globalThis.order).toEqual([\n-    // TODO Order should be 'inner throws', 'module'\n-    'module',\n-    'inner no-throws',\n-    'main',\n-  ])\n+  expect(globalThis.order).toEqual(['inner throws', 'module', 'main'])\n })"
        },
        {
            "sha": "27c70c892eb1fc6de2a34dcab84c19ba5c2f11a7",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/webpack/scope-hoisting/circular-root-export/options.json",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f8c78e0d31dc5c74efe65f7335da6eca6d632af/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fwebpack%2Fscope-hoisting%2Fcircular-root-export%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8f8c78e0d31dc5c74efe65f7335da6eca6d632af/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fwebpack%2Fscope-hoisting%2Fcircular-root-export%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fwebpack%2Fscope-hoisting%2Fcircular-root-export%2Foptions.json?ref=8f8c78e0d31dc5c74efe65f7335da6eca6d632af",
            "patch": "@@ -1,3 +0,0 @@\n-{\n-  \"treeShakingMode\": null\n-}"
        },
        {
            "sha": "c15d7ec00382d3604310ddb8b53cbdb90d9e1942",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/457d9_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js.map",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F457d9_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F457d9_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F457d9_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js.map?ref=428616e1cf582b466295073416b01b698a46008b",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/457d9_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_ed1bdf14.js.map"
        },
        {
            "sha": "4e82b2f0acc4f83164a68d24b94e0bb35db50bff",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js",
            "status": "renamed",
            "additions": 2,
            "deletions": 11,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -1,9 +1,8 @@\n-(globalThis.TURBOPACK || (globalThis.TURBOPACK = [])).push([\"output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_6ca4cc64._.js\",\n+(globalThis.TURBOPACK || (globalThis.TURBOPACK = [])).push([\"output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js\",\n \"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/index.js [test] (ecmascript)\", ((__turbopack_context__) => {\n \"use strict\";\n \n __turbopack_context__.s([]);\n-var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js [test] (ecmascript) <module evaluation>\");\n var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js [test] (ecmascript) <locals>\");\n ;\n (0, __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__$3c$locals$3e$__[\"local\"])();\n@@ -39,14 +38,6 @@ function localUnused() {\n }\n ;\n }),\n-\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js [test] (ecmascript) <module evaluation>\", ((__turbopack_context__) => {\n-\"use strict\";\n-\n-__turbopack_context__.s([]);\n-var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$unused$2e$js__$5b$test$5d$__$28$ecmascript$29$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused.js [test] (ecmascript)\");\n-var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$unused$2d$star$2e$js__$5b$test$5d$__$28$ecmascript$29$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused-star.js [test] (ecmascript)\");\n-var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$reexport$2d$with$2d$locals$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js [test] (ecmascript) <locals>\");\n-}),\n ]);\n \n-//# sourceMappingURL=4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_6ca4cc64._.js.map\n\\ No newline at end of file\n+//# sourceMappingURL=4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js.map\n\\ No newline at end of file",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_6ca4cc64._.js"
        },
        {
            "sha": "7c1ac3eb31331dcf1b45400acd7a32c4f4bfdb52",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js.map",
            "status": "renamed",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js.map?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -2,8 +2,8 @@\n   \"version\": 3,\n   \"sources\": [],\n   \"sections\": [\n-    {\"offset\": {\"line\": 4, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/index.js\"],\"sourcesContent\":[\"import { local } from 'lib'\\n\\nlocal()\\n\"],\"names\":[],\"mappings\":\";AAAA;AAAA;;AAEA,IAAA,yRAAK\"}},\n-    {\"offset\": {\"line\": 13, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused.js\"],\"sourcesContent\":[\"export function unusedStar() {}\\n\"],\"names\":[],\"mappings\":\";AAAO,SAAS,cAAc\",\"ignoreList\":[0]}},\n-    {\"offset\": {\"line\": 19, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused-star.js\"],\"sourcesContent\":[\"export function unused() {}\\n\"],\"names\":[],\"mappings\":\";AAAO,SAAS,UAAU\",\"ignoreList\":[0]}},\n-    {\"offset\": {\"line\": 25, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js\"],\"sourcesContent\":[\"export { unused } from './unused.js'\\nexport * from './unused-star.js'\\n\\nfunction local() {\\n  console.log('This is a local function')\\n}\\nfunction localUnused() {\\n  console.log('This is a local unused function')\\n}\\n\\nexport { local, localUnused }\\n\"],\"names\":[],\"mappings\":\";;;;AAAA;AACA;;;AAEA,SAAS;IACP,QAAQ,GAAG,CAAC;AACd;AACA,SAAS;IACP,QAAQ,GAAG,CAAC;AACd\",\"ignoreList\":[0]}}]\n+    {\"offset\": {\"line\": 4, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/index.js\"],\"sourcesContent\":[\"import { local } from 'lib'\\n\\nlocal()\\n\"],\"names\":[],\"mappings\":\";AAAA;;AAEA,IAAA,yRAAK\"}},\n+    {\"offset\": {\"line\": 12, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused.js\"],\"sourcesContent\":[\"export function unusedStar() {}\\n\"],\"names\":[],\"mappings\":\";AAAO,SAAS,cAAc\",\"ignoreList\":[0]}},\n+    {\"offset\": {\"line\": 18, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/unused-star.js\"],\"sourcesContent\":[\"export function unused() {}\\n\"],\"names\":[],\"mappings\":\";AAAO,SAAS,UAAU\",\"ignoreList\":[0]}},\n+    {\"offset\": {\"line\": 24, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/node_modules/lib/index.js\"],\"sourcesContent\":[\"export { unused } from './unused.js'\\nexport * from './unused-star.js'\\n\\nfunction local() {\\n  console.log('This is a local function')\\n}\\nfunction localUnused() {\\n  console.log('This is a local unused function')\\n}\\n\\nexport { local, localUnused }\\n\"],\"names\":[],\"mappings\":\";;;;AAAA;AACA;;;AAEA,SAAS;IACP,QAAQ,GAAG,CAAC;AACd;AACA,SAAS;IACP,QAAQ,GAAG,CAAC;AACd\",\"ignoreList\":[0]}}]\n }\n\\ No newline at end of file",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_6ca4cc64._.js.map"
        },
        {
            "sha": "6522032c7133d015ebebd29323f913784b71a9fd",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js",
            "status": "renamed",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Freexport-with-locals%2Foutput%2F85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -1,5 +1,5 @@\n (globalThis.TURBOPACK || (globalThis.TURBOPACK = [])).push([\n-    \"output/85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_ed1bdf14.js\",\n-    {\"otherChunks\":[\"output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_6ca4cc64._.js\"],\"runtimeModuleIds\":[\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/index.js [test] (ecmascript)\"]}\n+    \"output/85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_619a7955.js\",\n+    {\"otherChunks\":[\"output/4c35f_tests_snapshot_intermediate-tree-shake_reexport-with-locals_input_e256c7f2._.js\"],\"runtimeModuleIds\":[\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/input/index.js [test] (ecmascript)\"]}\n ]);\n // Dummy runtime\n\\ No newline at end of file",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/reexport-with-locals/output/85e3f_snapshot_intermediate-tree-shake_reexport-with-locals_input_index_ed1bdf14.js"
        },
        {
            "sha": "f5cc389700c98872fdc761760f3707d8d3a17223",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/428616e1cf582b466295073416b01b698a46008b/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=428616e1cf582b466295073416b01b698a46008b",
            "patch": "@@ -55,6 +55,7 @@ use turbopack_ecmascript::{\n     references::external_module::{\n         CachedExternalModule, CachedExternalTracingMode, CachedExternalType,\n     },\n+    side_effect_optimization::locals::module::EcmascriptModuleLocalsModule,\n     tree_shake::asset::EcmascriptModulePartAsset,\n };\n use turbopack_json::JsonModuleAsset;\n@@ -176,11 +177,8 @@ async fn apply_module_type(\n                         if let Some(part) = part {\n                             match part {\n                                 ModulePart::Evaluation => {\n-                                    if *module.get_exports().needs_facade().await? {\n-                                        Vc::upcast(EcmascriptModuleFacadeModule::new(\n-                                            Vc::upcast(*module),\n-                                            part,\n-                                        ))\n+                                    if *module.get_exports().split_locals_and_reexports().await? {\n+                                        Vc::upcast(EcmascriptModuleLocalsModule::new(*module))\n                                     } else {\n                                         Vc::upcast(*module)\n                                     }\n@@ -191,12 +189,12 @@ async fn apply_module_type(\n                                         .resolve()\n                                         .await?;\n \n-                                    if *module.get_exports().needs_facade().await? {\n+                                    if *module.get_exports().split_locals_and_reexports().await? {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(\n                                                 EcmascriptModuleFacadeModule::new(\n                                                     Vc::upcast(*module),\n-                                                    ModulePart::exports(),\n+                                                    ModulePart::facade(),\n                                                 )\n                                                 .resolve()\n                                                 .await?,\n@@ -218,7 +216,7 @@ async fn apply_module_type(\n                                     part\n                                 ),\n                             }\n-                        } else if *module.get_exports().needs_facade().await? {\n+                        } else if *module.get_exports().split_locals_and_reexports().await? {\n                             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                 Vc::upcast(*module),\n                                 ModulePart::facade(),\n@@ -287,7 +285,7 @@ async fn apply_reexport_tree_shaking(\n             module: final_module,\n             export_name: new_export,\n             ..\n-        } = &*follow_reexports(module, export.clone(), side_effect_free_packages, false).await?;\n+        } = &*follow_reexports(module, export.clone(), side_effect_free_packages, true).await?;\n         let module = if let Some(new_export) = new_export {\n             if *new_export == *export {\n                 Vc::upcast(**final_module)"
        }
    ],
    "stats": {
        "total": 290,
        "additions": 93,
        "deletions": 197
    }
}