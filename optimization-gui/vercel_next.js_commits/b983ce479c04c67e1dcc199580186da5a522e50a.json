{
    "author": "eps1lon",
    "message": "[strict-route-types] Typecheck pages router routes in absence of App Router (#87628)",
    "sha": "b983ce479c04c67e1dcc199580186da5a522e50a",
    "files": [
        {
            "sha": "e276a5c2f2b87d01ad06c8f683a2b9b0c1d6569c",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -20,6 +20,7 @@ import { hrtimeDurationToString } from './duration-to-string'\n function verifyTypeScriptSetup(\n   dir: string,\n   distDir: string,\n+  strictRouteTypes: boolean,\n   typeCheckPreflight: boolean,\n   tsconfigPath: string | undefined,\n   disableStaticImages: boolean,\n@@ -50,6 +51,7 @@ function verifyTypeScriptSetup(\n     .verifyTypeScriptSetup({\n       dir,\n       distDir,\n+      strictRouteTypes,\n       typeCheckPreflight,\n       tsconfigPath,\n       disableStaticImages,\n@@ -117,6 +119,7 @@ export async function startTypeChecking({\n         verifyTypeScriptSetup(\n           dir,\n           config.distDir,\n+          Boolean(config.experimental.strictRouteTypes),\n           !ignoreTypeScriptErrors,\n           config.typescript.tsconfigPath,\n           config.images.disableStaticImages,"
        },
        {
            "sha": "2046788bfc0ca3f2d0d7261cdce6090ef15a057a",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -140,6 +140,7 @@ async function runPlaywright(\n     const { version: typeScriptVersion } = await verifyTypeScriptSetup({\n       dir: baseDir,\n       distDir: nextConfig.distDir,\n+      strictRouteTypes: Boolean(nextConfig.experimental.strictRouteTypes),\n       typeCheckPreflight: false,\n       tsconfigPath: nextConfig.typescript.tsconfigPath,\n       disableStaticImages: nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "14d07ac566d108458b012605afbb05baa0e79e8d",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -54,9 +54,12 @@ const nextTypegen = async (\n   const distDir = join(baseDir, nextConfig.distDir)\n   const { pagesDir, appDir } = findPagesDir(baseDir)\n \n+  const strictRouteTypes = Boolean(nextConfig.experimental.strictRouteTypes)\n+\n   await verifyTypeScriptSetup({\n     dir: baseDir,\n     distDir: nextConfig.distDir,\n+    strictRouteTypes,\n     typeCheckPreflight: false,\n     tsconfigPath: nextConfig.typescript.tsconfigPath,\n     disableStaticImages: nextConfig.images.disableStaticImages,\n@@ -172,7 +175,7 @@ const nextTypegen = async (\n   await writeValidatorFile(\n     routeTypesManifest,\n     validatorFilePath,\n-    Boolean(nextConfig.experimental.strictRouteTypes)\n+    strictRouteTypes\n   )\n \n   // Generate cache-life types if cacheLife config exists"
        },
        {
            "sha": "8088f0e5ab79ffde19868f6767881369a278f1b6",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -16,6 +16,7 @@ describe('writeConfigurationDefaults()', () => {\n   let isFirstTimeSetup: boolean\n   let hasPagesDir: boolean\n   let isolatedDevBuild = true\n+  let experimentalStrictRouteTypes = true\n \n   beforeEach(async () => {\n     consoleLogSpy = jest.spyOn(console, 'log').mockImplementation()\n@@ -47,7 +48,8 @@ describe('writeConfigurationDefaults()', () => {\n         hasAppDir,\n         distDir,\n         hasPagesDir,\n-        isolatedDevBuild\n+        isolatedDevBuild,\n+        experimentalStrictRouteTypes\n       )\n \n       const tsConfig = JSON.parse(\n@@ -137,7 +139,8 @@ describe('writeConfigurationDefaults()', () => {\n         hasAppDir,\n         distDir,\n         hasPagesDir,\n-        isolatedDevBuild\n+        isolatedDevBuild,\n+        experimentalStrictRouteTypes\n       )\n \n       expect(stripAnsi(consoleLogSpy.mock.calls.flat().join('\\n'))).not.toMatch(\n@@ -170,7 +173,8 @@ describe('writeConfigurationDefaults()', () => {\n             hasAppDir,\n             distDir,\n             hasPagesDir,\n-            isolatedDevBuild\n+            isolatedDevBuild,\n+            experimentalStrictRouteTypes\n           )\n         ).resolves.not.toThrow()\n "
        },
        {
            "sha": "fb6a739af1451cd4e2517aa3eb103cc94543f2a3",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -190,7 +190,8 @@ export async function writeConfigurationDefaults(\n   hasAppDir: boolean,\n   distDir: string,\n   hasPagesDir: boolean,\n-  isolatedDevBuild: boolean | undefined\n+  isolatedDevBuild: boolean | undefined,\n+  strictRouteTypes: boolean\n ): Promise<void> {\n   if (isFirstTimeSetup) {\n     writeFileSync(tsConfigPath, '{}' + os.EOL)\n@@ -276,27 +277,27 @@ export async function writeConfigurationDefaults(\n \n   // Get type definition glob patterns using shared utility to ensure consistency\n   // with other TypeScript infrastructure (e.g., runTypeCheck.ts)\n-  const nextAppTypes = getTypeDefinitionGlobPatterns(\n+  const nextTypes = getTypeDefinitionGlobPatterns(\n     distDir,\n     resolvedIsolatedDevBuild\n   )\n \n   if (!('include' in userTsConfig)) {\n-    userTsConfig.include = hasAppDir\n-      ? ['next-env.d.ts', ...nextAppTypes, '**/*.mts', '**/*.ts', '**/*.tsx']\n-      : ['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n+    const defaultInclude =\n+      hasAppDir || strictRouteTypes\n+        ? ['next-env.d.ts', ...nextTypes, '**/*.mts', '**/*.ts', '**/*.tsx']\n+        : ['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n+\n+    userTsConfig.include = defaultInclude\n     suggestedActions.push(\n       cyan('include') +\n-        ' was set to ' +\n-        bold(\n-          hasAppDir\n-            ? `['next-env.d.ts', ${nextAppTypes.map((type) => `'${type}'`).join(', ')}, '**/*.mts', '**/*.ts', '**/*.tsx']`\n-            : `['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']`\n-        )\n+        ' was set to [' +\n+        bold(defaultInclude.map((type) => `'${type}'`).join(', ')) +\n+        ']'\n     )\n-  } else if (hasAppDir) {\n+  } else if (hasAppDir || strictRouteTypes) {\n     const missingFromResolved = []\n-    for (const type of nextAppTypes) {\n+    for (const type of nextTypes) {\n       if (!userTsConfig.include.includes(type)) {\n         missingFromResolved.push(type)\n       }"
        },
        {
            "sha": "903bd4b6ec9643f8871ab1d862b0abd36e4311e6",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -37,6 +37,7 @@ export async function verifyTypeScriptSetup({\n   dir,\n   distDir,\n   cacheDir,\n+  strictRouteTypes,\n   tsconfigPath,\n   typeCheckPreflight,\n   disableStaticImages,\n@@ -50,6 +51,7 @@ export async function verifyTypeScriptSetup({\n   dir: string\n   distDir: string\n   cacheDir?: string\n+  strictRouteTypes: boolean\n   tsconfigPath: string | undefined\n   typeCheckPreflight: boolean\n   disableStaticImages: boolean\n@@ -136,7 +138,8 @@ export async function verifyTypeScriptSetup({\n       hasAppDir,\n       distDir,\n       hasPagesDir,\n-      isolatedDevBuild\n+      isolatedDevBuild,\n+      strictRouteTypes\n     )\n     // Write out the necessary `next-env.d.ts` file to correctly register\n     // Next.js' types:"
        },
        {
            "sha": "bdfef056fb2e7d7779b3622cb8aaf97f52c75c6b",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -143,6 +143,7 @@ async function verifyTypeScript(opts: SetupOpts) {\n   const verifyResult = await verifyTypeScriptSetup({\n     dir: opts.dir,\n     distDir: opts.nextConfig.distDir,\n+    strictRouteTypes: Boolean(opts.nextConfig.experimental.strictRouteTypes),\n     typeCheckPreflight: false,\n     tsconfigPath: opts.nextConfig.typescript.tsconfigPath,\n     disableStaticImages: opts.nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "cf155665f24aefa3c38de84c635a78d6531abb98",
            "filename": "test/e2e/tsconfig-module-preserve/index.test.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 30,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/b983ce479c04c67e1dcc199580186da5a522e50a/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b983ce479c04c67e1dcc199580186da5a522e50a/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts?ref=b983ce479c04c67e1dcc199580186da5a522e50a",
            "patch": "@@ -2,6 +2,9 @@ import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n+const strictRouteTypes =\n+  process.env.__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES === 'true'\n+\n describe('tsconfig module: preserve', () => {\n   const { next, skipped } = nextTestSetup({\n     files: {\n@@ -37,35 +40,70 @@ describe('tsconfig module: preserve', () => {\n     expect(output).not.toContain('esModuleInterop')\n     expect(output).not.toContain('resolveJsonModule')\n \n-    expect(await next.readFile('tsconfig.json')).toMatchInlineSnapshot(`\n-      \"{\n-        \"compilerOptions\": {\n-          \"module\": \"preserve\",\n-          \"target\": \"ES2017\",\n-          \"lib\": [\n-            \"dom\",\n-            \"dom.iterable\",\n-            \"esnext\"\n-          ],\n-          \"allowJs\": true,\n-          \"skipLibCheck\": true,\n-          \"strict\": false,\n-          \"noEmit\": true,\n-          \"incremental\": true,\n-          \"isolatedModules\": true,\n-          \"jsx\": \"react-jsx\"\n-        },\n-        \"include\": [\n-          \"next-env.d.ts\",\n-          \"**/*.mts\",\n-          \"**/*.ts\",\n-          \"**/*.tsx\"\n-        ],\n-        \"exclude\": [\n-          \"node_modules\"\n-        ]\n-      }\n-      \"\n-    `)\n+    if (strictRouteTypes) {\n+      expect(await next.readFile('tsconfig.json')).toMatchInlineSnapshot(`\n+       \"{\n+         \"compilerOptions\": {\n+           \"module\": \"preserve\",\n+           \"target\": \"ES2017\",\n+           \"lib\": [\n+             \"dom\",\n+             \"dom.iterable\",\n+             \"esnext\"\n+           ],\n+           \"allowJs\": true,\n+           \"skipLibCheck\": true,\n+           \"strict\": false,\n+           \"noEmit\": true,\n+           \"incremental\": true,\n+           \"isolatedModules\": true,\n+           \"jsx\": \"react-jsx\"\n+         },\n+         \"include\": [\n+           \"next-env.d.ts\",\n+           \".next/types/**/*.ts\",\n+           \".next/dev/types/**/*.ts\",\n+           \"**/*.mts\",\n+           \"**/*.ts\",\n+           \"**/*.tsx\"\n+         ],\n+         \"exclude\": [\n+           \"node_modules\"\n+         ]\n+       }\n+       \"\n+      `)\n+    } else {\n+      expect(await next.readFile('tsconfig.json')).toMatchInlineSnapshot(`\n+       \"{\n+         \"compilerOptions\": {\n+           \"module\": \"preserve\",\n+           \"target\": \"ES2017\",\n+           \"lib\": [\n+             \"dom\",\n+             \"dom.iterable\",\n+             \"esnext\"\n+           ],\n+           \"allowJs\": true,\n+           \"skipLibCheck\": true,\n+           \"strict\": false,\n+           \"noEmit\": true,\n+           \"incremental\": true,\n+           \"isolatedModules\": true,\n+           \"jsx\": \"react-jsx\"\n+         },\n+         \"include\": [\n+           \"next-env.d.ts\",\n+           \"**/*.mts\",\n+           \"**/*.ts\",\n+           \"**/*.tsx\"\n+         ],\n+         \"exclude\": [\n+           \"node_modules\"\n+         ]\n+       }\n+       \"\n+      `)\n+    }\n   })\n })"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 102,
        "deletions": 48
    }
}