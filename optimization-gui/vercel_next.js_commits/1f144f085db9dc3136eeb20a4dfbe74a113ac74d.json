{
    "author": "shuding",
    "message": "Fix Turbopack local font `font-family` declaration (#85913)\n\nThis fixes #85912, as the logic of injecting the `font-family` property\nshould be mirrored from the Webpack implementation.",
    "sha": "1f144f085db9dc3136eeb20a4dfbe74a113ac74d",
    "files": [
        {
            "sha": "80e845bc0ea3a422d2a48df99be1bf1b15599c4e",
            "filename": "crates/next-core/src/next_font/local/stylesheet.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs?ref=1f144f085db9dc3136eeb20a4dfbe74a113ac74d",
            "patch": "@@ -62,11 +62,17 @@ pub(super) async fn build_font_face_definitions(\n         };\n         let query_str = qstring::QString::from(serde_json::to_string(&query)?.as_str());\n \n+        // Check if `font-family` is explicitly defined in `declarations`\n+        let has_custom_font_family = options.declarations.as_ref().is_some_and(|declarations| {\n+            declarations\n+                .iter()\n+                .any(|declaration| declaration.prop == \"font-family\")\n+        });\n+\n         definitions.push_str(&formatdoc!(\n             r#\"\n                 @font-face {{\n-                    {}\n-                    font-family: '{}';\n+                    {}{}\n                     src: url('@vercel/turbopack-next/internal/font/local/font?{}') format('{}');\n                     font-display: {};\n                     {}{}\n@@ -79,20 +85,24 @@ pub(super) async fn build_font_face_definitions(\n                     .map(|declaration| format!(\"{}: {};\", declaration.prop, declaration.value))\n                     .join(\"\\n\")\n             ),\n-            scoped_font_family,\n+            if has_custom_font_family {\n+                \"\".to_owned()\n+            } else {\n+                format!(\"\\nfont-family: '{}';\", scoped_font_family)\n+            },\n             query_str,\n             ext_to_format(&font.ext)?,\n             options.display,\n             &font\n                 .weight\n                 .as_ref()\n                 .or(options.default_weight.as_ref())\n-                .map_or_else(|| \"\".to_owned(), |w| format!(\"font-weight: {w};\")),\n+                .map_or_else(|| \"\".to_owned(), |w| format!(\"\\nfont-weight: {w};\")),\n             &font\n                 .style\n                 .as_ref()\n                 .or(options.default_style.as_ref())\n-                .map_or_else(|| \"\".to_owned(), |s| format!(\"font-style: {s};\")),\n+                .map_or_else(|| \"\".to_owned(), |s| format!(\"\\nfont-style: {s};\")),\n         ));\n     }\n "
        },
        {
            "sha": "d0808cc2bb32c8836e75cebb71abbc160432b04f",
            "filename": "test/e2e/next-font/app/pages/with-local-fonts.js",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js?ref=1f144f085db9dc3136eeb20a4dfbe74a113ac74d",
            "patch": "@@ -13,6 +13,15 @@ const myFont2 = localFont({\n   preload: false,\n   variable: '--my-font',\n })\n+const myFont1Override = localFont({\n+  src: '../fonts/my-font.woff2',\n+  declarations: [\n+    {\n+      prop: 'font-family',\n+      value: 'foobar',\n+    },\n+  ],\n+})\n \n const roboto = localFont({\n   preload: false,\n@@ -134,6 +143,9 @@ export default function WithFonts() {\n       <div id=\"second-local-font\" className={myFont2.className}>\n         {JSON.stringify(myFont2)}\n       </div>\n+      <div id=\"first-local-font-override\" className={myFont1Override.className}>\n+        {JSON.stringify(myFont1Override)}\n+      </div>\n       <div id=\"roboto-local-font\" className={roboto.className}>\n         {JSON.stringify(roboto)}\n       </div>"
        },
        {
            "sha": "670f1c1c0f5aa0c8fe92ca3740abf1eff13bad39",
            "filename": "test/e2e/next-font/index.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f144f085db9dc3136eeb20a4dfbe74a113ac74d/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Findex.test.ts?ref=1f144f085db9dc3136eeb20a4dfbe74a113ac74d",
            "patch": "@@ -650,20 +650,25 @@ describe('next/font', () => {\n       // Get all stylesheets\n       const stylesheets = await browser.eval(`\n         Array.from(document.styleSheets)\n-          .map(sheet => {\n+          .flatMap(sheet => {\n             try {\n               return Array.from(sheet.cssRules || sheet.rules || [])\n                 .map(rule => rule.cssText)\n-                .join('\\\\n')\n             } catch (e) {\n               return ''\n             }\n           })\n-          .join('\\\\n')\n       `)\n \n       // Check that the custom declaration is included in the CSS\n-      expect(stylesheets).toContain('ascent-override: 90%')\n+      expect(stylesheets).toContainEqual(\n+        expect.stringContaining('ascent-override: 90%;')\n+      )\n+\n+      // Check that the custom declaration is included in the CSS and overrides the default family\n+      expect(stylesheets).toContainEqual(\n+        expect.stringContaining('font-family: foobar;')\n+      )\n     })\n   })\n })"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 36,
        "deletions": 9
    }
}