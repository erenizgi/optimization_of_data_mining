{
    "author": "ijjk",
    "message": "Update test new tests for deploy mode (#78737)\n\nThis updates our workflow for testing new tests against deploy mode to\nallow running against forks as we don't want to introduce flakey tests\nin this mode even if opened from forks.",
    "sha": "6665d5e2f103c644e6cc0602456fb82fab5312d6",
    "files": [
        {
            "sha": "a8b84b7fee7ce68c5bea5d1203e001ee8363cefa",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6665d5e2f103c644e6cc0602456fb82fab5312d6/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/6665d5e2f103c644e6cc0602456fb82fab5312d6/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=6665d5e2f103c644e6cc0602456fb82fab5312d6",
            "patch": "@@ -3,8 +3,9 @@ name: build-and-deploy\n \n on:\n   push:\n-    # TODO: Run only on canary pushes but PR syncs.\n-    # Requires checking if CI is approved\n+  # we need the preview tarball for deploy tests\n+  pull_request:\n+    types: [opened, synchronize]\n   workflow_dispatch:\n \n env:\n@@ -516,7 +517,7 @@ jobs:\n           path: crates/wasm\n \n       - name: Create tarballs\n-        run: node scripts/create-preview-tarballs.js \"${{ github.sha }}\" \"${{ runner.temp }}/preview-tarballs\"\n+        run: GH_PR_NUMBER=${{ github.event.pull_request && github.event.pull_request.number || '' }} node scripts/create-preview-tarballs.js \"${{ github.sha }}\" \"${{ runner.temp }}/preview-tarballs\"\n \n       - name: Upload tarballs\n         uses: actions/upload-artifact@v4"
        },
        {
            "sha": "5c32810279af18dfe9c396a044b3167ec93f91f5",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6665d5e2f103c644e6cc0602456fb82fab5312d6/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/6665d5e2f103c644e6cc0602456fb82fab5312d6/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=6665d5e2f103c644e6cc0602456fb82fab5312d6",
            "patch": "@@ -477,7 +477,7 @@ jobs:\n     name: Test new tests when deployed\n     needs:\n       ['optimize-ci', 'test-prod', 'test-new-tests-dev', 'test-new-tests-start']\n-    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' && !github.event.pull_request.head.repo.fork }}\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' }}\n \n     strategy:\n       fail-fast: false\n@@ -488,7 +488,7 @@ jobs:\n     with:\n       afterBuild: |\n         export NEXT_E2E_TEST_TIMEOUT=240000\n-\n+        export GH_PR_NUMBER=${{ github.event.pull_request && github.event.pull_request.number || '' }}\n         node scripts/test-new-tests.mjs \\\n           --mode deploy \\\n           --group ${{ matrix.group }}"
        },
        {
            "sha": "47b3d016c68bf1d23674f48189ad8b5a78d3464b",
            "filename": "scripts/create-preview-tarballs.js",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/6665d5e2f103c644e6cc0602456fb82fab5312d6/scripts%2Fcreate-preview-tarballs.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6665d5e2f103c644e6cc0602456fb82fab5312d6/scripts%2Fcreate-preview-tarballs.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcreate-preview-tarballs.js?ref=6665d5e2f103c644e6cc0602456fb82fab5312d6",
            "patch": "@@ -82,7 +82,7 @@ async function main() {\n         }\n       )\n       // tarball name is printed as the last line of npm-pack\n-      const tarballName = stdout.trim().split('\\n').pop()\n+      const tarballName = stdout.trim().split('\\n').pop() || ''\n       console.info(`Created tarball ${path.join(packDestination, tarballName)}`)\n \n       nextSwcPackageNames.add(manifest.name)\n@@ -97,16 +97,21 @@ async function main() {\n   ])\n   const packages = JSON.parse(lernaListJson.stdout)\n   const packagesByVersion = new Map()\n+  const PR_NUMBER = process.env.GH_PR_NUMBER\n+  const basePackageUrl = PR_NUMBER\n+    ? `https://vercel-packages.vercel.app/next/prs/${PR_NUMBER}/`\n+    : `https://vercel-packages.vercel.app/next/commits/${commitSha}/`\n+\n   for (const packageInfo of packages) {\n     packagesByVersion.set(\n       packageInfo.name,\n-      `https://vercel-packages.vercel.app/next/commits/${commitSha}/${packageInfo.name}`\n+      `${basePackageUrl}${packageInfo.name}`\n     )\n   }\n   for (const nextSwcPackageName of nextSwcPackageNames) {\n     packagesByVersion.set(\n       nextSwcPackageName,\n-      `https://vercel-packages.vercel.app/next/commits/${commitSha}/${nextSwcPackageName}`\n+      `${basePackageUrl}${nextSwcPackageName}`\n     )\n   }\n \n@@ -164,7 +169,7 @@ async function main() {\n       }\n     )\n     // tarball name is printed as the last line of npm-pack\n-    const tarballName = stdout.trim().split('\\n').pop()\n+    const tarballName = stdout.trim().split('\\n').pop() || ''\n     console.info(`Created tarball ${path.join(packDestination, tarballName)}`)\n   }\n "
        },
        {
            "sha": "673be5a3944e8cd43e6f648ecdf7cc29da822385",
            "filename": "scripts/test-new-tests.mjs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6665d5e2f103c644e6cc0602456fb82fab5312d6/scripts%2Ftest-new-tests.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/6665d5e2f103c644e6cc0602456fb82fab5312d6/scripts%2Ftest-new-tests.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Ftest-new-tests.mjs?ref=6665d5e2f103c644e6cc0602456fb82fab5312d6",
            "patch": "@@ -79,13 +79,15 @@ async function main() {\n   }\n \n   const RUN_TESTS_ARGS = ['run-tests.js', '-c', '1', '--retries', '0']\n-\n+  const PR_NUMBER = process.env.GH_PR_NUMBER\n   // Only override the test version for deploy tests, as they need to run against\n   // the artifacts for the pull request. Otherwise, we don't need to specify this property,\n   // as tests will run against the local version of Next.js\n   const nextTestVersion =\n     testMode === 'deploy'\n-      ? `https://vercel-packages.vercel.app/next/commits/${commitSha}/next`\n+      ? PR_NUMBER\n+        ? `https://vercel-packages.vercel.app/next/prs/${PR_NUMBER}/next`\n+        : `https://vercel-packages.vercel.app/next/commits/${commitSha}/next`\n       : undefined\n \n   if (nextTestVersion) {"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 19,
        "deletions": 11
    }
}