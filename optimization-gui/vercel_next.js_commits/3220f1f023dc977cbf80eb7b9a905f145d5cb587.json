{
    "author": "wyattjoh",
    "message": "fix: use the match result after matching using the matched path header (#77994)\n\nWhen rendering the page on Vercel, we send the `x-matched-path` header\nto indicate which route should be rendered. Sometimes, like in the case\nof a middleware rewrite, we will rewrite a path to a statically\ngenerated one. This results in a `x-matched-path` header being equal to\nthe generated page and not the route with the dynamic path params in it.\n\nThis ensures that if we get such a path that we match against that we do\nsave the result of the path matching as they are valid parameters.\n\nThis also fixes a related bug associated with route denormalization\nwhich must occur before the routes i18n is parsed.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->\n\nFixes #77789\n\n---------\n\nCo-authored-by: Jiwon Choi <devjiwonchoi@gmail.com>",
    "sha": "3220f1f023dc977cbf80eb7b9a905f145d5cb587",
    "files": [
        {
            "sha": "2940d4e30feb0b59cf5fe8a5794593522f065909",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 9,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -1131,6 +1131,8 @@ export default abstract class Server<\n           matchedPath = this.normalize(matchedPath)\n           const normalizedUrlPath = this.stripNextDataPath(urlPathname)\n \n+          matchedPath = denormalizePagePath(matchedPath)\n+\n           // Perform locale detection and normalization.\n           const localeAnalysisResult = this.i18nProvider?.analyze(matchedPath, {\n             defaultLocale,\n@@ -1151,11 +1153,15 @@ export default abstract class Server<\n             }\n           }\n \n-          // TODO: check if this is needed any more?\n-          matchedPath = denormalizePagePath(matchedPath)\n-\n           let srcPathname = matchedPath\n           let pageIsDynamic = isDynamicRoute(srcPathname)\n+          let paramsResult: {\n+            params: ParsedUrlQuery | false\n+            hasValidParams: boolean\n+          } = {\n+            params: false,\n+            hasValidParams: false,\n+          }\n \n           if (!pageIsDynamic) {\n             const match = await this.matchers.match(srcPathname, {\n@@ -1165,8 +1171,15 @@ export default abstract class Server<\n             // Update the source pathname to the matched page's pathname.\n             if (match) {\n               srcPathname = match.definition.pathname\n-              // The page is dynamic if the params are defined.\n-              pageIsDynamic = typeof match.params !== 'undefined'\n+\n+              // The page is dynamic if the params are defined. We know at this\n+              // stage that the matched path is not a static page if the params\n+              // were parsed from the matched path header.\n+              if (typeof match.params !== 'undefined') {\n+                pageIsDynamic = true\n+                paramsResult.params = match.params\n+                paramsResult.hasValidParams = true\n+              }\n             }\n           }\n \n@@ -1236,10 +1249,14 @@ export default abstract class Server<\n           if (pageIsDynamic) {\n             let params: ParsedUrlQuery | false = {}\n \n-            let paramsResult = utils.normalizeDynamicRouteParams(\n-              queryParams,\n-              false\n-            )\n+            // If we don't already have valid params, try to parse them from\n+            // the query params.\n+            if (!paramsResult.hasValidParams) {\n+              paramsResult = utils.normalizeDynamicRouteParams(\n+                queryParams,\n+                false\n+              )\n+            }\n \n             // for prerendered ISR paths we attempt parsing the route\n             // params from the URL directly as route-matches may not"
        },
        {
            "sha": "8ed2439d837c4715e5d5b4526f8d1f15c4f967c6",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/app/[locale]/[...rest]/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2F%5B...rest%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2F%5B...rest%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2F%5B...rest%5D%2Fpage.tsx?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,17 @@\n+import { type Params, expectedParams } from '../../../expected'\n+\n+export default async function CatchAll({\n+  params,\n+}: {\n+  params: Promise<Params>\n+}) {\n+  const received = await params\n+\n+  return <p>{JSON.stringify(received)}</p>\n+}\n+\n+export async function generateStaticParams(): Promise<Params[]> {\n+  return [expectedParams]\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "33d03756335ee2363bada3225a0a7d72c7a640bc",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/app/[locale]/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2F%5Blocale%5D%2Fpage.tsx?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,5 @@\n+import Link from 'next/link'\n+\n+export default function Home() {\n+  return <Link href=\"/1/2\">Go to /1/2</Link>\n+}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fapp%2Flayout.tsx?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "37ae1d80cd3d1928ada87fdb880a390a3c086a21",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/expected.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fexpected.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fexpected.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fexpected.ts?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,9 @@\n+export type Params = {\n+  locale: string\n+  rest: string[]\n+}\n+\n+export const expectedParams: Params = {\n+  locale: 'en',\n+  rest: ['1', '2'],\n+}"
        },
        {
            "sha": "d6cac831af0fb73ebcf0287fee25624f8e98edba",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/middleware.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fmiddleware.ts?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,21 @@\n+import type { NextRequest } from 'next/server'\n+import { NextResponse } from 'next/server'\n+\n+export function middleware(request: NextRequest) {\n+  return NextResponse.rewrite(\n+    new URL('/en' + request.nextUrl.pathname, request.url)\n+  )\n+}\n+\n+export const config = {\n+  matcher: [\n+    /*\n+     * Match all request paths except for the ones starting with:\n+     * - api (API routes)\n+     * - _next/static (static files)\n+     * - _next/image (image optimization files)\n+     * - favicon.ico, sitemap.xml, robots.txt (metadata files)\n+     */\n+    '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',\n+  ],\n+}"
        },
        {
            "sha": "016ac8833b57fe46d032dcd15c1b751138a86b05",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fnext.config.js?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "4c583bbdf32c6570f8c9afa226e1aa3376adabcf",
            "filename": "test/e2e/app-dir/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params/ppr-middleware-rewrite-force-dynamic-ssg-dynamic-params.test.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3220f1f023dc977cbf80eb7b9a905f145d5cb587/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params%2Fppr-middleware-rewrite-force-dynamic-ssg-dynamic-params.test.ts?ref=3220f1f023dc977cbf80eb7b9a905f145d5cb587",
            "patch": "@@ -0,0 +1,26 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { expectedParams as expected } from './expected'\n+\n+describe('ppr-middleware-rewrite-force-dynamic-generate-static-params', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  const expectedParams = JSON.stringify(expected)\n+\n+  it('should have correct dynamic params', async () => {\n+    // should be rewritten with /en\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('a').text()).toBe('Go to /1/2')\n+\n+    // navigate to /1/2\n+    await browser.elementByCss('a').click()\n+\n+    // should be rewritten with /en/1/2 with correct params\n+    expect(await browser.elementByCss('p').text()).toBe(expectedParams)\n+\n+    // reloading the page should have the same params\n+    await browser.refresh()\n+    expect(await browser.elementByCss('p').text()).toBe(expectedParams)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 122,
        "deletions": 9
    }
}