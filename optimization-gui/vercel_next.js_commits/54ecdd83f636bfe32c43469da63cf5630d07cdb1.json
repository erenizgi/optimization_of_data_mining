{
    "author": "devjiwonchoi",
    "message": "[dev] Fix Middleware and Proxy file conflict (#84965)\n\nSince the conflict check looked only at the file name ðŸ’€, when there's a\n`proxy` or `middleware` file inside the app, it also detected a\nconflict:\n\n```\nUnhandled Rejection: Error: Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.\n```\n\nCI:\nhttps://github.com/vercel/next.js/actions/runs/18568804746/job/52937138783?pr=84965#step:34:326\n\nTherefore, check for the actual file path of the middleware/proxy file.",
    "sha": "54ecdd83f636bfe32c43469da63cf5630d07cdb1",
    "files": [
        {
            "sha": "52dc7a8f7abaa5ed5723b6da7d095c7092f8cf5a",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 19,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/54ecdd83f636bfe32c43469da63cf5630d07cdb1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/54ecdd83f636bfe32c43469da63cf5630d07cdb1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=54ecdd83f636bfe32c43469da63cf5630d07cdb1",
            "patch": "@@ -393,34 +393,38 @@ async function startWatcher(\n \n       let hasMiddlewareFile = false\n       let hasProxyFile = false\n+\n       for (const fileName of sortedKnownFiles) {\n-        const { name } = path.parse(fileName)\n-        if (name === MIDDLEWARE_FILENAME) {\n+        if (\n+          !files.includes(fileName) &&\n+          !directories.some((d) => fileName.startsWith(d))\n+        ) {\n+          continue\n+        }\n+\n+        const { name: fileBaseName, dir: fileDir } = path.parse(fileName)\n+\n+        const isAtConventionLevel =\n+          fileDir === dir || fileDir === path.join(dir, 'src')\n+\n+        if (isAtConventionLevel && fileBaseName === MIDDLEWARE_FILENAME) {\n           hasMiddlewareFile = true\n         }\n-        if (name === PROXY_FILENAME) {\n+        if (isAtConventionLevel && fileBaseName === PROXY_FILENAME) {\n           hasProxyFile = true\n         }\n-      }\n \n-      if (hasMiddlewareFile) {\n-        if (hasProxyFile) {\n-          throw new Error(\n-            `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+        if (hasMiddlewareFile) {\n+          if (hasProxyFile) {\n+            throw new Error(\n+              `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+            )\n+          }\n+          Log.warnOnce(\n+            `The \"${MIDDLEWARE_FILENAME}\" file convention is deprecated. Please use \"${PROXY_FILENAME}\" instead.`\n           )\n         }\n-        Log.warnOnce(\n-          `The \"${MIDDLEWARE_FILENAME}\" file convention is deprecated. Please use \"${PROXY_FILENAME}\" instead.`\n-        )\n-      }\n \n-      for (const fileName of sortedKnownFiles) {\n-        if (\n-          !files.includes(fileName) &&\n-          !directories.some((d) => fileName.startsWith(d))\n-        ) {\n-          continue\n-        }\n         const meta = knownFiles.get(fileName)\n \n         const watchTime = fileWatchTimes.get(fileName)"
        },
        {
            "sha": "43cc4a28069cc0ef42a76c066f9f36f3f453463b",
            "filename": "test/e2e/app-dir/app-middleware/app/middleware.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/54ecdd83f636bfe32c43469da63cf5630d07cdb1/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/54ecdd83f636bfe32c43469da63cf5630d07cdb1/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fmiddleware.js?ref=54ecdd83f636bfe32c43469da63cf5630d07cdb1",
            "patch": "@@ -0,0 +1 @@\n+// noop, this file should not picked up as Middleware file and throw error."
        },
        {
            "sha": "c2610a401c6d04cd2928659b9ad3f94bdedbbb5a",
            "filename": "test/e2e/app-dir/app-middleware/app/proxy.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/54ecdd83f636bfe32c43469da63cf5630d07cdb1/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fproxy.js",
            "raw_url": "https://github.com/vercel/next.js/raw/54ecdd83f636bfe32c43469da63cf5630d07cdb1/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fproxy.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp%2Fproxy.js?ref=54ecdd83f636bfe32c43469da63cf5630d07cdb1",
            "patch": "@@ -0,0 +1 @@\n+// noop, this file should not picked up as Proxy file and throw error."
        }
    ],
    "stats": {
        "total": 44,
        "additions": 25,
        "deletions": 19
    }
}