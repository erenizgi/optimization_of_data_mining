{
    "author": "unstubbable",
    "message": "Revert \"Partial Fallback Prerendering Route Shells (#69282)\" (#79258)",
    "sha": "238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
    "files": [
        {
            "sha": "be26d836251ddafe342b3a3ef794dbf32e6b47bc",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 47,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -168,7 +168,6 @@ import { RouteKind } from './route-kind'\n import type { RouteModule } from './route-modules/route-module'\n import { FallbackMode, parseFallbackField } from '../lib/fallback'\n import { toResponseCacheEntry } from './response-cache/utils'\n-import { scheduleOnNextTick } from '../lib/scheduler'\n import { SegmentPrefixRSCPathnameNormalizer } from './normalizers/request/segment-prefix-rsc'\n import {\n   shouldServeStreamingMetadata,\n@@ -2674,7 +2673,6 @@ export default abstract class Server<\n                   headers,\n                 },\n                 cacheControl: { revalidate, expire },\n-                isFallback: false,\n               }\n \n               return cacheEntry\n@@ -2881,7 +2879,6 @@ export default abstract class Server<\n         return {\n           value: null,\n           cacheControl,\n-          isFallback: false,\n         } satisfies ResponseCacheEntry\n       }\n \n@@ -2893,7 +2890,6 @@ export default abstract class Server<\n             props: metadata.pageData ?? metadata.flightData,\n           } satisfies CachedRedirectValue,\n           cacheControl,\n-          isFallback: false,\n         } satisfies ResponseCacheEntry\n       }\n \n@@ -2915,7 +2911,6 @@ export default abstract class Server<\n             segmentData: metadata.segmentData,\n           } satisfies CachedAppPageValue,\n           cacheControl,\n-          isFallback: !!fallbackRouteParams,\n         } satisfies ResponseCacheEntry\n       }\n \n@@ -2928,7 +2923,6 @@ export default abstract class Server<\n           status: isAppPath ? res.statusCode : undefined,\n         } satisfies CachedPageValue,\n         cacheControl,\n-        isFallback: pagesFallback,\n       }\n     }\n \n@@ -3155,7 +3149,6 @@ export default abstract class Server<\n       ) {\n         return {\n           cacheControl: { revalidate: 1, expire: undefined },\n-          isFallback: false,\n           value: {\n             kind: CachedRouteKind.PAGES,\n             html: RenderResult.fromStatic(''),\n@@ -3220,46 +3213,6 @@ export default abstract class Server<\n       return null\n     }\n \n-    // If we're not in minimal mode and the cache entry that was returned was a\n-    // app page fallback, then we need to kick off the dynamic shell generation.\n-    if (\n-      ssgCacheKey &&\n-      !this.minimalMode &&\n-      isRoutePPREnabled &&\n-      cacheEntry.value?.kind === CachedRouteKind.APP_PAGE &&\n-      cacheEntry.isFallback &&\n-      !isOnDemandRevalidate &&\n-      // When we're debugging the fallback shell, we don't want to regenerate\n-      // the route shell.\n-      !isDebugFallbackShell &&\n-      process.env.DISABLE_ROUTE_SHELL_GENERATION !== 'true'\n-    ) {\n-      scheduleOnNextTick(async () => {\n-        try {\n-          await this.responseCache.get(\n-            ssgCacheKey,\n-            () =>\n-              doRender({\n-                // We're an on-demand request, so we don't need to pass in the\n-                // fallbackRouteParams.\n-                fallbackRouteParams: null,\n-                pagesFallback: undefined,\n-                postponed: undefined,\n-              }),\n-            {\n-              routeKind: RouteKind.APP_PAGE,\n-              incrementalCache,\n-              isOnDemandRevalidate: true,\n-              isPrefetch: false,\n-              isRoutePPREnabled: true,\n-            }\n-          )\n-        } catch (err) {\n-          console.error('Error occurred while rendering dynamic shell', err)\n-        }\n-      })\n-    }\n-\n     const didPostpone =\n       cacheEntry.value?.kind === CachedRouteKind.APP_PAGE &&\n       typeof cacheEntry.value.postponed === 'string'"
        },
        {
            "sha": "44e37e447f1d175d8af9b7bc6ce0279755e8b197",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -418,7 +418,6 @@ export class ImageOptimizerCache {\n             Date.now(),\n           cacheControl: { revalidate: maxAge, expire: undefined },\n           isStale: now > expireAt,\n-          isFallback: false,\n         }\n       }\n     } catch (_) {"
        },
        {
            "sha": "2709ac45b7f8e7fef9707fb02324c98f8d20c2d2",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -477,7 +477,6 @@ export class IncrementalCache implements IncrementalCacheType {\n     }\n \n     let entry: IncrementalResponseCacheEntry | null = null\n-    const { isFallback } = ctx\n     const cacheControl = this.cacheControls.get(toRoute(cacheKey))\n \n     let isStale: boolean | -1 | undefined\n@@ -506,7 +505,6 @@ export class IncrementalCache implements IncrementalCacheType {\n         cacheControl,\n         revalidateAfter,\n         value: cacheData.value,\n-        isFallback,\n       }\n     }\n \n@@ -524,7 +522,6 @@ export class IncrementalCache implements IncrementalCacheType {\n         value: null,\n         cacheControl,\n         revalidateAfter,\n-        isFallback,\n       }\n       this.set(cacheKey, entry.value, { ...ctx, cacheControl })\n     }"
        },
        {
            "sha": "7dea0ab349efbeffca316825810d2eb28df3bda8",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -1049,7 +1049,6 @@ export default class NextNodeServer extends BaseServer<\n                 extension: getExtension(contentType) as string,\n                 upstreamEtag,\n               },\n-              isFallback: false,\n               cacheControl: { revalidate: maxAge, expire: undefined },\n             }\n           },"
        },
        {
            "sha": "08a0d5ee2351963b7b504f03d90a278e06bba987",
            "filename": "packages/next/src/server/response-cache/types.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Ftypes.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -142,7 +142,6 @@ export interface IncrementalResponseCacheEntry {\n    */\n   isStale?: boolean | -1\n   isMiss?: boolean\n-  isFallback: boolean | undefined\n   value: Exclude<IncrementalCacheValue, CachedFetchValue> | null\n }\n \n@@ -178,7 +177,6 @@ export type ResponseCacheEntry = {\n   value: ResponseCacheValue | null\n   isStale?: boolean | -1\n   isMiss?: boolean\n-  isFallback: boolean | undefined\n }\n \n /**"
        },
        {
            "sha": "5d965cf3ee182da249ca0c6d5d2274ca7e6e0b17",
            "filename": "packages/next/src/server/response-cache/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresponse-cache%2Futils.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -47,7 +47,6 @@ export async function toResponseCacheEntry(\n     isMiss: response.isMiss,\n     isStale: response.isStale,\n     cacheControl: response.cacheControl,\n-    isFallback: response.isFallback,\n     value:\n       response.value?.kind === CachedRouteKind.PAGES\n         ? ({"
        },
        {
            "sha": "29c280392acf747400dc5840cf23c42259e6f927",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 25,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -2818,9 +2818,7 @@ describe('app-dir static/dynamic handling', () => {\n     for (let i = 0; i < 5; i++) {\n       const res = await next.fetch('/articles/non-existent')\n \n-      // Only the first request should be a 200 while using PPR. When the route\n-      // shell is generated, the status code will switch to 404.\n-      if (process.env.__NEXT_EXPERIMENTAL_PPR && !isNextDev && i === 0) {\n+      if (process.env.__NEXT_EXPERIMENTAL_PPR && !isNextDev) {\n         expect(res.status).toBe(200)\n       } else {\n         expect(res.status).toBe(404)\n@@ -3789,34 +3787,20 @@ describe('app-dir static/dynamic handling', () => {\n       expect(res.status).toBe(200)\n \n       const html = await res.text()\n-      let $ = cheerio.load(html)\n+      const $ = cheerio.load(html)\n \n       expect(JSON.parse($('#params').text())).toEqual({ slug: 'random' })\n       expect(JSON.parse($('#headers').text())).toEqual([])\n       expect(JSON.parse($('#cookies').text())).toEqual([])\n \n+      const firstTime = $('#now').text()\n+\n       if (!(global as any).isNextDev) {\n-        if (process.env.__NEXT_EXPERIMENTAL_PPR) {\n-          // When PPR is enabled, we first encounter the fallback shell. We do\n-          // expect though that the page does not change after the dynamic shell\n-          // has been finalized.\n-          await retry(async () => {\n-            $ = await next.render$('/force-static/random')\n-\n-            const first = $('#now').text()\n-\n-            $ = await next.render$('/force-static/random')\n-\n-            // The page should not change after the dynamic shell has been\n-            // finalized.\n-            expect($('#now').text()).toBe(first)\n-          })\n-        } else {\n-          const first = $('#now').text()\n-\n-          $ = await next.render$('/force-static/random')\n-          expect($('#now').text()).toBe(first)\n-        }\n+        const res2 = await next.fetch('/force-static/random')\n+        expect(res2.status).toBe(200)\n+\n+        const $2 = cheerio.load(await res2.text())\n+        expect(firstTime).toBe($2('#now').text())\n       }\n     })\n   }"
        },
        {
            "sha": "21b4657a3807275a0fa0fe04f7df594b18360885",
            "filename": "test/e2e/app-dir/next-after-app-deploy/app/timestamp/key/[key]/page.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fnext-after-app-deploy%2Fapp%2Ftimestamp%2Fkey%2F%5Bkey%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fnext-after-app-deploy%2Fapp%2Ftimestamp%2Fkey%2F%5Bkey%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-after-app-deploy%2Fapp%2Ftimestamp%2Fkey%2F%5Bkey%5D%2Fpage.js?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -5,7 +5,11 @@ export const revalidate = 3600 // arbitrarily long, just so that it doesn't happ\n export const dynamicParams = true\n \n export async function generateStaticParams() {\n-  return []\n+  return ['nodejs', 'edge'].flatMap((runtime) =>\n+    ['dynamic-page', 'middleware', 'route', 'server-action'].map((page) => ({\n+      key: `/${runtime}/${page}`,\n+    }))\n+  )\n }\n \n export default async function Page({ params }) {"
        },
        {
            "sha": "86e4a770c28f2cc844ae8b9efcd7903b432edc85",
            "filename": "test/e2e/app-dir/ppr-full/ppr-full.test.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 154,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -353,176 +353,58 @@ describe('ppr-full', () => {\n           expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n         })\n \n-        if (isNextDeploy) {\n-          it('should render the fallback shell every time', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/dynamic/params/on-second-visit-${random}`\n-\n-            let $ = await next.render$(pathname)\n-            expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n-            expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n-\n-            for (let i = 0; i < 10; i++) {\n-              $ = await next.render$(pathname)\n-              expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n-              expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n-            }\n-          })\n-\n-          it('should render the fallback shell even if the page is static', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/params/on-second-visit-${random}`\n-\n-            // Expect that the slug had to be resumed.\n-            let $ = await next.render$(pathname)\n-            expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n-\n-            for (let i = 0; i < 10; i++) {\n-              $ = await next.render$(pathname)\n-              expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n-            }\n-          })\n-\n-          it('will not revalidate the fallback shell', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/dynamic/params/revalidate-${random}`\n-\n-            let $ = await next.render$(pathname)\n-            const fallbackID = $('[data-layout]').data('layout') as string\n+        it('should render the fallback shell every time', async () => {\n+          const random = Math.random().toString(16).slice(2)\n+          const pathname = `/fallback/dynamic/params/on-second-visit-${random}`\n \n-            // Now let's revalidate the page.\n-            await next.fetch(\n-              `/api/revalidate?pathname=${encodeURIComponent(pathname)}`\n-            )\n+          let $ = await next.render$(pathname)\n+          expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n+          expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n \n-            // We expect to get the fallback shell again.\n+          for (let i = 0; i < 10; i++) {\n             $ = await next.render$(pathname)\n-            expect($('[data-layout]').data('layout')).toBe(fallbackID)\n-\n-            // Let's wait for the page to be revalidated.\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              const newDynamicID = $('[data-layout]').data('layout') as string\n-              expect(newDynamicID).toBe(fallbackID)\n-            })\n-          })\n-        } else {\n-          it('should render the route shell on the second visit', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/dynamic/params/on-second-visit-${random}`\n-\n-            let $ = await next.render$(pathname)\n             expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n             expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n+          }\n+        })\n \n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              expect($('[data-slug]').closest('[hidden]').length).toBe(0)\n-              expect($('[data-agent]').closest('[hidden]').length).toBe(1)\n-            })\n-          })\n-\n-          it('should render the dynamic shell as static if the page is static', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/params/on-second-visit-${random}`\n-\n-            // Expect that the slug had to be resumed.\n-            let $ = await next.render$(pathname)\n-            expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n-\n-            // The slug didn't have to be resumed, and it should all be static.\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              expect($('[data-slug]').closest('[hidden]').length).toBe(0)\n-\n-              const {\n-                timings: { streamFirstChunk, start, streamEnd },\n-                chunks,\n-              } = await measurePPRTimings(async () => {\n-                const res = await next.fetch(pathname)\n-                expect(res.status).toBe(200)\n-                expect(res.headers.get('x-nextjs-cache')).toBe('HIT')\n-\n-                return res.body\n-              }, 1000)\n-\n-              expect(chunks.dynamic).toBe('')\n-              expect(streamFirstChunk - start).toBeLessThan(500)\n-              expect(streamEnd - start).toBeLessThan(500)\n-            })\n-          })\n-\n-          it('will only revalidate the page', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/dynamic/params/revalidate-${random}`\n-\n-            let $ = await next.render$(pathname)\n-            const fallbackID = $('[data-layout]').data('layout') as string\n-\n-            let dynamicID: string\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              dynamicID = $('[data-layout]').data('layout') as string\n-\n-              // These should be different,\n-              expect(dynamicID).not.toBe(fallbackID)\n-            })\n+        it('should render the fallback shell even if the page is static', async () => {\n+          const random = Math.random().toString(16).slice(2)\n+          const pathname = `/fallback/params/on-second-visit-${random}`\n \n-            // Now let's revalidate the page.\n-            await next.fetch(\n-              `/api/revalidate?pathname=${encodeURIComponent(pathname)}`\n-            )\n+          // Expect that the slug had to be resumed.\n+          let $ = await next.render$(pathname)\n+          expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n \n-            // We expect to get the fallback shell again.\n+          for (let i = 0; i < 10; i++) {\n             $ = await next.render$(pathname)\n-            expect($('[data-layout]').data('layout')).toBe(fallbackID)\n-\n-            // Let's wait for the page to be revalidated.\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              const newDynamicID = $('[data-layout]').data('layout') as string\n-              expect(newDynamicID).not.toBe(dynamicID)\n-            })\n-          })\n-\n-          it('will revalidate the page and fallback shell', async () => {\n-            const random = Math.random().toString(16).slice(2)\n-            const pathname = `/fallback/dynamic/params/revalidate-${random}`\n+            expect($('[data-slug]').closest('[hidden]').length).toBe(1)\n+          }\n+        })\n \n-            let $ = await next.render$(pathname)\n-            const fallbackID = $('[data-layout]').data('layout') as string\n+        it('will not revalidate the fallback shell', async () => {\n+          const random = Math.random().toString(16).slice(2)\n+          const pathname = `/fallback/dynamic/params/revalidate-${random}`\n \n-            let dynamicID: string\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              dynamicID = $('[data-layout]').data('layout') as string\n+          let $ = await next.render$(pathname)\n+          const fallbackID = $('[data-layout]').data('layout') as string\n \n-              // These should be different,\n-              expect(dynamicID).not.toBe(fallbackID)\n-            })\n+          // Now let's revalidate the page.\n+          await next.fetch(\n+            `/api/revalidate?pathname=${encodeURIComponent(pathname)}`\n+          )\n \n-            // Now let's revalidate the page.\n-            await next.fetch(\n-              `/api/revalidate?pathname=${encodeURIComponent(pathname)}`\n-            )\n+          // We expect to get the fallback shell again.\n+          $ = await next.render$(pathname)\n+          expect($('[data-layout]').data('layout')).toBe(fallbackID)\n \n-            // We expect to get the fallback shell.\n+          // Let's wait for the page to be revalidated.\n+          await retry(async () => {\n             $ = await next.render$(pathname)\n-\n-            // When deployed to Vercel, it will serve a stale version of the dynamic shell\n-            // Whereas with `next start` it will serve the fallback shell\n-            expect($('[data-layout]').data('layout')).toBe(fallbackID)\n-\n-            // Let's wait for the page to be revalidated.\n-            let revalidatedDynamicID: string\n-            await retry(async () => {\n-              $ = await next.render$(pathname)\n-              revalidatedDynamicID = $('[data-layout]').data('layout') as string\n-              expect(revalidatedDynamicID).not.toBe(dynamicID)\n-              expect(revalidatedDynamicID).not.toBe(fallbackID)\n-            })\n+            const newDynamicID = $('[data-layout]').data('layout') as string\n+            expect(newDynamicID).toBe(fallbackID)\n           })\n-        }\n+        })\n \n         /**\n          * This test is really here to just to force the the suite to have the expected route"
        },
        {
            "sha": "386e52b81eed59574dbd67f477782c26104f9b25",
            "filename": "test/e2e/app-dir/ppr-incremental/ppr-incremental.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fppr-incremental%2Fppr-incremental.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/238a8ac8e3e1d9aee253ece78ed7d47b04e22549/test%2Fe2e%2Fapp-dir%2Fppr-incremental%2Fppr-incremental.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-incremental%2Fppr-incremental.test.ts?ref=238a8ac8e3e1d9aee253ece78ed7d47b04e22549",
            "patch": "@@ -144,7 +144,7 @@ describe('ppr-incremental', () => {\n           it.each(pathnames)('%s', async (pathname) => {\n             const $ = await next.render$(pathname)\n             expect($('#dynamic')).toHaveLength(1)\n-            expect($('#dynamic').closest('[hidden]')).toHaveLength(0)\n+            expect($('#dynamic').parent('[hidden]')).toHaveLength(0)\n           })\n         })\n       }\n@@ -196,7 +196,7 @@ describe('ppr-incremental', () => {\n           it.each(pathnames)('%s', async (pathname) => {\n             const $ = await next.render$(pathname)\n             expect($('#dynamic')).toHaveLength(1)\n-            expect($('#dynamic').closest('[hidden]')).toHaveLength(1)\n+            expect($('#dynamic').parent('[hidden]')).toHaveLength(1)\n           })\n         })\n       }"
        }
    ],
    "stats": {
        "total": 289,
        "additions": 52,
        "deletions": 237
    }
}