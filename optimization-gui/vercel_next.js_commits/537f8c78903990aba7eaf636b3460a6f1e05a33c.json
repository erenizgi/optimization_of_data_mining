{
    "author": "devjiwonchoi",
    "message": "Log `Compiled proxy in ...` (#84746)\n\nWhen using `proxy`, the `Compiled X in ...` message in Turbopack had\nhardcoded `middleware`. Therefore, modify to display `proxy` if using a\nproxy. Also, Webpack displayed with a leading slash `/proxy`, which\ncould be misinterpreted as a route, so I removed the leading slash.",
    "sha": "537f8c78903990aba7eaf636b3460a6f1e05a33c",
    "files": [
        {
            "sha": "6ed3e9e9ffe3299efa6fb72fac887622daba519c",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -752,6 +752,7 @@ impl NapiRoute {\n #[napi(object)]\n pub struct NapiMiddleware {\n     pub endpoint: External<ExternalEndpoint>,\n+    pub is_proxy: bool,\n }\n \n impl NapiMiddleware {\n@@ -764,6 +765,7 @@ impl NapiMiddleware {\n                 turbopack_ctx.clone(),\n                 value.endpoint,\n             ))),\n+            is_proxy: value.is_proxy,\n         })\n     }\n }"
        },
        {
            "sha": "3ab3ee2ae26705477e2bcae7b40051bca675ba85",
            "filename": "crates/next-api/src/operation.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Foperation.rs?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -55,8 +55,9 @@ impl EntrypointsOperation {\n                 .iter()\n                 .map(|(k, v)| (k.clone(), pick_route(entrypoints, k.clone(), v)))\n                 .collect(),\n-            middleware: e.middleware.as_ref().map(|_| MiddlewareOperation {\n+            middleware: e.middleware.as_ref().map(|m| MiddlewareOperation {\n                 endpoint: pick_endpoint(entrypoints, EndpointSelector::Middleware),\n+                is_proxy: m.is_proxy,\n             }),\n             instrumentation: e\n                 .instrumentation\n@@ -212,6 +213,7 @@ pub struct InstrumentationOperation {\n #[derive(Serialize, Deserialize, TraceRawVcs, PartialEq, Eq, ValueDebugFormat, NonLocalValue)]\n pub struct MiddlewareOperation {\n     pub endpoint: OperationVc<OptionEndpoint>,\n+    pub is_proxy: bool,\n }\n \n #[turbo_tasks::value(shared)]"
        },
        {
            "sha": "67250477318fcc448e510d690ab6c5021400e360",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -255,6 +255,7 @@ pub struct DefineEnv {\n #[derive(Serialize, Deserialize, TraceRawVcs, PartialEq, Eq, ValueDebugFormat, NonLocalValue)]\n pub struct Middleware {\n     pub endpoint: ResolvedVc<Box<dyn Endpoint>>,\n+    pub is_proxy: bool,\n }\n \n #[derive(Serialize, Deserialize, TraceRawVcs, PartialEq, Eq, ValueDebugFormat, NonLocalValue)]\n@@ -1269,9 +1270,11 @@ impl Project {\n         let pages_error_endpoint = self.pages_project().error_endpoint().to_resolved().await?;\n \n         let middleware = self.find_middleware();\n-        let middleware = if let FindContextFileResult::Found(..) = *middleware.await? {\n+        let middleware = if let FindContextFileResult::Found(fs_path, _) = &*middleware.await? {\n+            let is_proxy = fs_path.file_stem() == Some(\"proxy\");\n             Some(Middleware {\n                 endpoint: self.middleware_endpoint().to_resolved().await?,\n+                is_proxy,\n             })\n         } else {\n             None"
        },
        {
            "sha": "04dec2d6ce9ded56f649f06c2b33d596dd341e30",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -279,6 +279,7 @@ export interface NapiRoute {\n }\n export interface NapiMiddleware {\n   endpoint: ExternalObject<ExternalEndpoint>\n+  isProxy: boolean\n }\n export interface NapiInstrumentation {\n   nodeJs: ExternalObject<ExternalEndpoint>"
        },
        {
            "sha": "3c99e3b32272a9c8748bedcf4087f25ac8ff70fb",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -486,8 +486,7 @@ function bindingToApi(\n \n   type NapiMiddleware = {\n     endpoint: NapiEndpoint\n-    runtime: 'nodejs' | 'edge'\n-    matcher?: string[]\n+    isProxy: boolean\n   }\n \n   type NapiInstrumentation = {\n@@ -1054,8 +1053,7 @@ function bindingToApi(\n     }\n     const napiMiddlewareToMiddleware = (middleware: NapiMiddleware) => ({\n       endpoint: new EndpointImpl(middleware.endpoint),\n-      runtime: middleware.runtime,\n-      matcher: middleware.matcher,\n+      isProxy: middleware.isProxy,\n     })\n     const middleware = entrypoints.middleware\n       ? napiMiddlewareToMiddleware(entrypoints.middleware)"
        },
        {
            "sha": "e45392cdb68bf37dc9776106c584632f1b2a839e",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -144,6 +144,7 @@ export type TurbopackResult<T = {}> = T & {\n \n export interface Middleware {\n   endpoint: Endpoint\n+  isProxy: boolean\n }\n \n export interface Instrumentation {"
        },
        {
            "sha": "b84fae13fcb9f3def23723eaf511ddec4edf3d45",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -886,7 +886,11 @@ export function onDemandEntryHandler({\n \n       if (hasNewEntry) {\n         const routePage = isApp ? route.page : normalizeAppPath(route.page)\n-        reportTrigger(routePage, url)\n+        // If proxy file, remove the leading slash from \"/proxy\" to \"proxy\".\n+        reportTrigger(\n+          isMiddlewareFile(routePage) ? routePage.slice(1) : routePage,\n+          url\n+        )\n       }\n \n       if (entriesThatShouldBeInvalidated.length > 0) {"
        },
        {
            "sha": "c70cf8041e5a95bc5c074ce0c1b41be2d5b941df",
            "filename": "packages/next/src/server/dev/turbopack-utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -35,6 +35,7 @@ import {\n   type EntryIssuesMap,\n   type TopLevelIssuesMap,\n } from '../../shared/lib/turbopack/utils'\n+import { MIDDLEWARE_FILENAME, PROXY_FILENAME } from '../../lib/constants'\n \n const onceErrorSet = new Set()\n /**\n@@ -712,10 +713,13 @@ export async function handleEntrypoints({\n     const key = getEntryKey('root', 'server', 'middleware')\n \n     const endpoint = middleware.endpoint\n+    const triggerName = middleware.isProxy\n+      ? PROXY_FILENAME\n+      : MIDDLEWARE_FILENAME\n \n     async function processMiddleware() {\n       const finishBuilding = dev.hooks.startBuilding(\n-        'middleware',\n+        triggerName,\n         undefined,\n         true\n       )\n@@ -744,7 +748,7 @@ export async function handleEntrypoints({\n         endpoint,\n         async () => {\n           const finishBuilding = dev.hooks.startBuilding(\n-            'middleware',\n+            triggerName,\n             undefined,\n             true\n           )"
        },
        {
            "sha": "cb873079005915fafff3823fcbf91b2d40bba644",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -5,10 +5,17 @@ import { nextTestSetup } from 'e2e-utils'\n import type { Response } from 'node-fetch'\n \n describe('app-dir with proxy', () => {\n-  const { next, isNextDeploy } = nextTestSetup({\n+  const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n   })\n \n+  if (isNextDev) {\n+    it('should log Compiled proxy in', async () => {\n+      await next.browser('/')\n+      expect(next.cliOutput).toContain('Compiled proxy in')\n+    })\n+  }\n+\n   it('should filter correctly after proxy rewrite', async () => {\n     const browser = await next.browser('/start')\n "
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpage.js?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/app/page.tsx"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/proxy-with-middleware/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/app/layout.tsx"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/proxy-with-middleware/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "adf5b7f421208a6ca37811aa17b68124af312b58",
            "filename": "test/e2e/app-dir/proxy-with-middleware/middleware.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/middleware.ts"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/proxy-with-middleware/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/next.config.js"
        },
        {
            "sha": "53032a028ccc14e8d3eeac6c61d9bbc2e38dcd93",
            "filename": "test/e2e/app-dir/proxy-with-middleware/proxy-with-middleware.test.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "patch": "@@ -13,7 +13,7 @@ describe('proxy-with-middleware', () => {\n \n   it('should error when both middleware and proxy files are detected', async () => {\n     if (isNextDev) {\n-      await next.start()\n+      await next.start().catch(() => {})\n       expect(next.cliOutput).toContain(\n         'Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.'\n       )",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/proxy-with-middleware.test.ts"
        },
        {
            "sha": "26c43637fecde47f0d8a56aacfb82a92ba500951",
            "filename": "test/e2e/app-dir/proxy-with-middleware/proxy.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/537f8c78903990aba7eaf636b3460a6f1e05a33c/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts?ref=537f8c78903990aba7eaf636b3460a6f1e05a33c",
            "previous_filename": "test/production/app-dir/proxy-with-middleware/proxy.ts"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 36,
        "deletions": 11
    }
}