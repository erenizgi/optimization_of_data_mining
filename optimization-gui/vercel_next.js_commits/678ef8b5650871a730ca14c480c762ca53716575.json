{
    "author": "kdy1",
    "message": "perf(turbopack): Remove needless alloc for AQMF (#80468)\n\n### What?\n\nTrivial `Cow` optimization for AQMF data\n\n### Why?\n\nWe can avoid calling `to_vec()` on this data, and according to the profiling result, compression was a memory hog.",
    "sha": "678ef8b5650871a730ca14c480c762ca53716575",
    "files": [
        {
            "sha": "805f1c8844aa9496bcf6ffda36db1da6b8157837",
            "filename": "turbopack/crates/turbo-persistence/src/db.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs?ref=678ef8b5650871a730ca14c480c762ca53716575",
            "patch": "@@ -1,5 +1,6 @@\n use std::{\n     any::{Any, TypeId},\n+    borrow::Cow,\n     collections::HashSet,\n     fs::{self, File, OpenOptions, ReadDir},\n     io::{BufWriter, Write},\n@@ -1050,7 +1051,7 @@ impl TurboPersistence {\n                     let index_in_meta = ssts_with_ranges[index].index_in_meta;\n                     let meta_file = &meta_files[meta_index];\n                     let entry = meta_file.entry(index_in_meta);\n-                    let aqmf = entry.raw_aqmf(meta_file.aqmf_data()).to_vec();\n+                    let aqmf = Cow::Borrowed(entry.raw_aqmf(meta_file.aqmf_data()));\n                     let meta = StaticSortedFileBuilderMeta {\n                         min_hash: entry.min_hash(),\n                         max_hash: entry.max_hash(),"
        },
        {
            "sha": "fbaccf32d11d7e493f372b678e526813ce0ece01",
            "filename": "turbopack/crates/turbo-persistence/src/meta_file_builder.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fmeta_file_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fmeta_file_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fmeta_file_builder.rs?ref=678ef8b5650871a730ca14c480c762ca53716575",
            "patch": "@@ -9,15 +9,15 @@ use byteorder::{BE, WriteBytesExt};\n \n use crate::static_sorted_file_builder::StaticSortedFileBuilderMeta;\n \n-pub struct MetaFileBuilder {\n+pub struct MetaFileBuilder<'a> {\n     family: u32,\n     /// Entries in the meta file, tuples of (sequence_number, StaticSortedFileBuilderMetaResult)\n-    entries: Vec<(u32, StaticSortedFileBuilderMeta)>,\n+    entries: Vec<(u32, StaticSortedFileBuilderMeta<'a>)>,\n     /// Obsolete SST files, represented by their sequence numbers\n     obsolete_sst_files: Vec<u32>,\n }\n \n-impl MetaFileBuilder {\n+impl<'a> MetaFileBuilder<'a> {\n     pub fn new(family: u32) -> Self {\n         Self {\n             family,\n@@ -26,7 +26,7 @@ impl MetaFileBuilder {\n         }\n     }\n \n-    pub fn add(&mut self, sequence_number: u32, sst: StaticSortedFileBuilderMeta) {\n+    pub fn add(&mut self, sequence_number: u32, sst: StaticSortedFileBuilderMeta<'a>) {\n         self.entries.push((sequence_number, sst));\n     }\n "
        },
        {
            "sha": "1d160f565ee8340382fee3843578128472ed4c4f",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file_builder.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs?ref=678ef8b5650871a730ca14c480c762ca53716575",
            "patch": "@@ -1,4 +1,5 @@\n use std::{\n+    borrow::Cow,\n     cmp::min,\n     fs::File,\n     io::{self, BufWriter, Seek, Write},\n@@ -72,13 +73,13 @@ pub enum EntryValue<'l> {\n }\n \n #[derive(Debug, Clone)]\n-pub struct StaticSortedFileBuilderMeta {\n+pub struct StaticSortedFileBuilderMeta<'a> {\n     /// The minimum hash of the keys in the SST file\n     pub min_hash: u64,\n     /// The maximum hash of the keys in the SST file\n     pub max_hash: u64,\n     /// The AQMF data\n-    pub aqmf: Vec<u8>,\n+    pub aqmf: Cow<'a, [u8]>,\n     /// The key compression dictionary\n     pub key_compression_dictionary_length: u16,\n     /// The value compression dictionary\n@@ -92,8 +93,8 @@ pub struct StaticSortedFileBuilderMeta {\n }\n \n #[derive(Debug, Default)]\n-pub struct StaticSortedFileBuilder {\n-    aqmf: Vec<u8>,\n+pub struct StaticSortedFileBuilder<'a> {\n+    aqmf: Cow<'a, [u8]>,\n     key_compression_dictionary: Vec<u8>,\n     value_compression_dictionary: Vec<u8>,\n     blocks: Vec<(u32, Vec<u8>)>,\n@@ -102,7 +103,7 @@ pub struct StaticSortedFileBuilder {\n     entries: u64,\n }\n \n-impl StaticSortedFileBuilder {\n+impl<'a> StaticSortedFileBuilder<'a> {\n     pub fn new<E: Entry>(\n         entries: &[E],\n         total_key_size: usize,\n@@ -136,7 +137,7 @@ impl StaticSortedFileBuilder {\n         for entry in entries {\n             debug_assert!(filter.contains_fingerprint(entry.key_hash()));\n         }\n-        self.aqmf = pot::to_vec(&filter).expect(\"AQMF serialization failed\");\n+        self.aqmf = Cow::Owned(pot::to_vec(&filter).expect(\"AQMF serialization failed\"));\n     }\n \n     /// Computes compression dictionaries from keys and values of all entries\n@@ -389,7 +390,7 @@ impl StaticSortedFileBuilder {\n \n     /// Writes the SST file.\n     #[tracing::instrument(level = \"trace\", skip_all)]\n-    pub fn write(self, file: &Path) -> io::Result<(StaticSortedFileBuilderMeta, File)> {\n+    pub fn write(self, file: &Path) -> io::Result<(StaticSortedFileBuilderMeta<'a>, File)> {\n         let mut file = BufWriter::new(File::create(file)?);\n         // Write the key compression dictionary\n         file.write_all(&self.key_compression_dictionary)?;"
        },
        {
            "sha": "49b4cf7e7ba908a607acdb1aaecc6cd6966f6121",
            "filename": "turbopack/crates/turbo-persistence/src/write_batch.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/678ef8b5650871a730ca14c480c762ca53716575/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs?ref=678ef8b5650871a730ca14c480c762ca53716575",
            "patch": "@@ -78,7 +78,7 @@ pub struct WriteBatch<K: StoreKey + Send, const FAMILIES: usize> {\n     /// Collectors in use. The thread local collectors flush into these when they are full.\n     collectors: [Mutex<GlobalCollectorState<K>>; FAMILIES],\n     /// Meta file builders for each family.\n-    meta_collectors: [Mutex<Vec<(u32, StaticSortedFileBuilderMeta)>>; FAMILIES],\n+    meta_collectors: [Mutex<Vec<(u32, StaticSortedFileBuilderMeta<'static>)>>; FAMILIES],\n     /// The list of new SST files that have been created.\n     /// Tuple of (sequence number, file).\n     new_sst_files: Mutex<Vec<(u32, File)>>,"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 15,
        "deletions": 13
    }
}