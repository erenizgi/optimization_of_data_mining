{
    "author": "delbaoliveira",
    "message": "Guide: Update `Optimizing Package Bundling` to include new Bundle Analyzer (#87246)\n\nThis PR adds instructions on how to run and navigate the new turbopack\nbundle analyzer to the existing [Optimizing package bundling guide\n](https://nextjs.org/docs/app/guides/package-bundling).\nTodo: \n- [x] Embed video\n- [x] Add image for import chain\n\n---------\n\nCo-authored-by: Luke Sandberg <lukesandberg@users.noreply.github.com>\nCo-authored-by: graphite-app[bot] <96075541+graphite-app[bot]@users.noreply.github.com>\nCo-authored-by: Joseph <joseph.chamochumbi@vercel.com>\nCo-authored-by: Rich Haines <hello@richardhaines.dev>\nCo-authored-by: vercel[bot] <35613825+vercel[bot]@users.noreply.github.com>",
    "sha": "bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
    "files": [
        {
            "sha": "984fc5225d954f11ca5be334feefb430fcf1a9cd",
            "filename": "docs/01-app/01-getting-started/04-linking-and-navigating.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F01-getting-started%2F04-linking-and-navigating.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F01-getting-started%2F04-linking-and-navigating.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F01-getting-started%2F04-linking-and-navigating.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -328,7 +328,7 @@ function HoverPrefetchLink({ href, children }) {\n \n React mitigates this with Selective Hydration and you can further improve this by:\n \n-- Using the [`@next/bundle-analyzer`](/docs/app/guides/package-bundling#analyzing-javascript-bundles) plugin to identify and reduce bundle size by removing large dependencies.\n+- Using the [`@next/bundle-analyzer`](/docs/app/guides/package-bundling#nextbundle-analyzer-for-webpack) plugin to identify and reduce bundle size by removing large dependencies.\n - Moving logic from the client to the server where possible. See the [Server and Client Components](/docs/app/getting-started/server-and-client-components) docs for guidance.\n \n ## Examples"
        },
        {
            "sha": "4e78ba7f6ff721665a57d297a41a3b5b4484a079",
            "filename": "docs/01-app/02-guides/package-bundling.mdx",
            "status": "modified",
            "additions": 175,
            "deletions": 34,
            "changes": 209,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F02-guides%2Fpackage-bundling.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F02-guides%2Fpackage-bundling.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fpackage-bundling.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -1,20 +1,84 @@\n ---\n-title: How to optimize package bundling\n+title: Optimizing package bundling\n nav_title: Package Bundling\n-description: Learn how to optimize your application's server and client bundles.\n+description: Learn how to analyze and optimize your application's server and client bundles with the Next.js Bundle Analyzer for Turbopack, and the `@next/bundle-analyzer` plugin for Webpack.\n related:\n   description: Learn more about optimizing your application for production.\n   links:\n     - app/guides/production-checklist\n ---\n \n-Bundling external packages can significantly improve the performance of your application. <AppOnly>By default, packages imported inside Server Components and Route Handlers are automatically bundled by Next.js. This page will guide you through how to analyze and further optimize package bundling.</AppOnly> <PagesOnly>By default, packages imported into your application are not bundled. This can impact performance or might not work if external packages are not pre-bundled, for example, if imported from a monorepo or `node_modules`. This page will guide you through how to analyze and configure package bundling.</PagesOnly>\n+Bundling is the process of combining your application code and its dependencies into optimized output files for the client and server. Smaller bundles load faster, reduce JavaScript execution time, improve [Core Web Vitals](https://web.dev/articles/vitals), and lower server cold start times.\n \n-## Analyzing JavaScript bundles\n+Next.js automatically optimizes bundles by code splitting, tree-shaking, and other techniques. However, there are some cases where you may need to optimize your bundles manually.\n \n-[`@next/bundle-analyzer`](https://www.npmjs.com/package/@next/bundle-analyzer) is a plugin for Next.js that helps you manage the size of your application bundles. It generates a visual report of the size of each package and their dependencies. You can use the information to remove large dependencies, split, or [lazy-load](/docs/app/guides/lazy-loading) your code.\n+There are two tools for analyzing your application's bundles:\n \n-### Installation\n+- [Next.js Bundle Analyzer for Turbopack (experimental)](#nextjs-bundle-analyzer-experimental)\n+- [`@next/bundle-analyzer` plugin for Webpack](#nextbundle-analyzer-for-webpack)\n+\n+This guide will walk you through how to use each tool and how to [optimize large bundles](#optimizing-large-bundles).\n+\n+## Next.js Bundle Analyzer (Experimental)\n+\n+> Available in v16.1 and later. You can share feedback in the [dedicated GitHub discussion](https://github.com/vercel/next.js/discussions/86731) and view the demo at [turbopack-bundle-analyzer-demo.vercel.sh](https://turbopack-bundle-analyzer-demo.vercel.sh/).\n+\n+The Next.js Bundle Analyzer is integrated with Turbopack's module graph. You can inspect server and client modules with precise import tracing, making it easier to find large dependencies. Open the interactive Bundle Analyzer demo to explore the module graph.\n+\n+### Step 1: Run the Turbopack Bundle Analyzer\n+\n+To get started, run the following command and open up the interactive view in your browser.\n+\n+```bash filename=\"Terminal\"\n+npx next experimental-analyze\n+```\n+\n+### Step 2: Filter and inspect modules\n+\n+Within the UI, you can filter by route, environment (client or server), and type (JavaScript, CSS, JSON), or search by file:\n+\n+<Video\n+  caption=\"Next.js bundle analyzer UI walkthrough\"\n+  src=\"/videos/bundle-analyzer.mp4\"\n+  width={1708}\n+  height={1080}\n+/>\n+\n+### Step 3: Trace modules with import chains\n+\n+The treemap shows each module as a rectangle. Where the size of the module is represented by the area of the rectangle.\n+\n+Click a module to see its size, inspect its full import chain and see exactly where itâ€™s used in your application:\n+\n+<Image\n+  caption=\"Next.js Bundle Analyzer import chain view\"\n+  srcLight=\"/docs/light/bundle-analyzer.png\"\n+  srcDark=\"/docs/dark/bundle-analyzer.png\"\n+  width={1600}\n+  height={874}\n+/>\n+\n+### Step 4: Write output to disk for sharing or diffing\n+\n+If you want to share the analysis with teammates or compare bundle sizes before/after optimizations, you can skip the interactive view and save the analysis as a static file with the `--output` flag:\n+\n+```bash filename=\"Terminal\"\n+npx next experimental-analyze --output\n+```\n+\n+This command writes the output to `.next/diagnostics/analyze`. You can copy this directory elsewhere to compare results:\n+\n+```bash filename=\"Terminal\"\n+cp -r .next/diagnostics/analyze ./analyze-before-refactor\n+```\n+\n+> More options are available for the Bundle Analyzer, see Next.js CLI reference docs for the full list.\n+\n+## `@next/bundle-analyzer` for Webpack\n+\n+The [`@next/bundle-analyzer`](https://www.npmjs.com/package/@next/bundle-analyzer) is a plugin that helps you manage the size of your application bundles. It generates a visual report of the size of each package and their dependencies. You can use the information to remove large dependencies, split, or [lazy-load](/docs/app/guides/lazy-loading) your code.\n+\n+### Step 1: Installation\n \n Install the plugin by running the following command:\n \n@@ -39,7 +103,7 @@ const withBundleAnalyzer = require('@next/bundle-analyzer')({\n module.exports = withBundleAnalyzer(nextConfig)\n ```\n \n-### Generating a report\n+### Step 2: Generating a report\n \n Run the following command to analyze your bundles:\n \n@@ -51,13 +115,15 @@ ANALYZE=true yarn build\n ANALYZE=true pnpm build\n ```\n \n-The report will open three new tabs in your browser, which you can inspect. Periodically evaluating your application's bundles can help you maintain application performance over time.\n+The report will open three new tabs in your browser, which you can inspect.\n+\n+## Optimizing large bundles\n \n-## Optimizing package imports\n+Once you've identified a large module, the solution will depend on your use case. Below are common causes and how to fix them:\n \n-Some packages, such as icon libraries, can export hundreds of modules, which can cause performance issues in development and production.\n+### Packages with many exports\n \n-You can optimize how these packages are imported by adding the [`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports) option to your `next.config.js`. This option will only load the modules you _actually_ use, while still giving you the convenience of writing import statements with many named exports.\n+If you're using a package that exports hundreds of modules (such as icon and utility libraries), you can optimize how those imports are resolved using the [`optimizePackageImports`](/docs/app/api-reference/config/next-config-js/optimizePackageImports) option in your `next.config.js` file. This option will only load the modules you _actually_ use, while still giving you the convenience of writing import statements with many named exports.\n \n ```js filename=\"next.config.js\"\n /** @type {import('next').NextConfig} */\n@@ -70,69 +136,144 @@ const nextConfig = {\n module.exports = nextConfig\n ```\n \n-Next.js also optimizes some libraries automatically, thus they do not need to be included in the optimizePackageImports list. See the [full list](/docs/app/api-reference/config/next-config-js/optimizePackageImports).\n+> **Good to know:** Next.js also optimizes some libraries automatically, thus they do not need to be included in the `optimizePackageImports` list. See the [full list](/docs/app/api-reference/config/next-config-js/optimizePackageImports) of supported packages.\n+\n+### Heavy client workloads\n+\n+A common cause of large client bundles is doing expensive rendering work in Client Components. This often happens with libraries that exist only to transform data into UI, such as syntax highlighting, chart rendering, or markdown parsing.\n+\n+If that work does not require browser APIs or user interaction, it can be run in a Server Component.\n+\n+In this example, a prism based highlighter runs in a Client Component. Even though the final output is just a `<code>` block, the entire highlighting library is bundled into the client JavaScript bundle:\n+\n+```tsx filename=\"app/blog/[slug]/page.tsx\"\n+'use client'\n+\n+import Highlight from 'prism-react-renderer'\n+import theme from 'prism-react-renderer/themes/github'\n+\n+export default function Page() {\n+  const code = `export function hello() {\n+    console.log(\"hi\")\n+  }`\n+\n+  return (\n+    <article>\n+      <h1>Blog Post Title</h1>\n+\n+      {/* The prism package and its tokenization logic are shipped to the client */}\n+      <Highlight code={code} language=\"tsx\" theme={theme}>\n+        {({ className, style, tokens, getLineProps, getTokenProps }) => (\n+          <pre className={className} style={style}>\n+            <code>\n+              {tokens.map((line, i) => (\n+                <div key={i} {...getLineProps({ line })}>\n+                  {line.map((token, key) => (\n+                    <span key={key} {...getTokenProps({ token })} />\n+                  ))}\n+                </div>\n+              ))}\n+            </code>\n+          </pre>\n+        )}\n+      </Highlight>\n+    </article>\n+  )\n+}\n+```\n \n-<PagesOnly>\n+This increases bundle size because the client must download and execute the highlighting library, even though the result is static HTML.\n \n-## Bundling specific packages\n+Instead, move the highlighting logic to a Server Component and render the final HTML on the server. The client will only receive the rendered markup.\n \n-To bundle specific packages, you can use the [`transpilePackages`](/docs/app/api-reference/config/next-config-js/transpilePackages) option in your `next.config.js`. This option is useful for bundling external packages that are not pre-bundled, for example, in a monorepo or imported from `node_modules`.\n+```tsx filename=\"app/blog/[slug]/page.tsx\"\n+import { codeToHtml } from 'shiki'\n+\n+export default async function Page() {\n+  const code = `export function hello() {\n+    console.log(\"hi\")\n+  }`\n+\n+  // The Shiki package runs on the server and is never bundled for the client.\n+  const highlightedHtml = await codeToHtml(code, {\n+    lang: 'tsx',\n+    theme: 'github-dark',\n+  })\n+\n+  return (\n+    <article>\n+      <h1>Blog Post Title</h1>\n+\n+      {/* Client receives plain markup */}\n+      <pre>\n+        <code dangerouslySetInnerHTML={{ __html: highlightedHtml }} />\n+      </pre>\n+    </article>\n+  )\n+}\n+```\n+\n+<AppOnly>\n+\n+### Opting specific packages out of bundling\n+\n+Packages imported inside Server Components and Route Handlers are automatically bundled by Next.js.\n+\n+You can opt specific packages out of bundling using the [`serverExternalPackages`](/docs/app/api-reference/config/next-config-js/serverExternalPackages) option in your `next.config.js`.\n \n ```js filename=\"next.config.js\"\n /** @type {import('next').NextConfig} */\n const nextConfig = {\n-  transpilePackages: ['package-name'],\n+  serverExternalPackages: ['package-name'],\n }\n \n module.exports = nextConfig\n ```\n \n-## Bundling all packages\n+</AppOnly>\n+\n+<PagesOnly>\n+\n+### External packages that aren't pre-bundled\n \n-To automatically bundle all packages (default behavior in the App Router), you can use the [`bundlePagesRouterDependencies`](/docs/pages/api-reference/config/next-config-js/bundlePagesRouterDependencies) option in your `next.config.js`.\n+By default, packages imported into your application are not bundled. This can impact performance if external packages are not pre-bundled, for example, if imported from a monorepo or `node_modules`.\n+\n+To bundle specific packages, you can use the [`transpilePackages`](/docs/app/api-reference/config/next-config-js/transpilePackages) option in your `next.config.js`.\n \n ```js filename=\"next.config.js\"\n /** @type {import('next').NextConfig} */\n const nextConfig = {\n-  bundlePagesRouterDependencies: true,\n+  transpilePackages: ['package-name'],\n }\n \n module.exports = nextConfig\n ```\n \n-## Opting specific packages out of bundling\n-\n-If you have the [`bundlePagesRouterDependencies`](/docs/pages/api-reference/config/next-config-js/bundlePagesRouterDependencies) option enabled, you can opt specific packages out of automatic bundling using the [`serverExternalPackages`](/docs/pages/api-reference/config/next-config-js/serverExternalPackages) option in your `next.config.js`:\n+To automatically bundle all packages, you can use the [`bundlePagesRouterDependencies`](/docs/pages/api-reference/config/next-config-js/bundlePagesRouterDependencies) option in your `next.config.js`.\n \n ```js filename=\"next.config.js\"\n /** @type {import('next').NextConfig} */\n const nextConfig = {\n-  // Automatically bundle external packages in the Pages Router:\n   bundlePagesRouterDependencies: true,\n-  // Opt specific packages out of bundling for both App and Pages Router:\n-  serverExternalPackages: ['package-name'],\n }\n \n module.exports = nextConfig\n ```\n \n-</PagesOnly>\n+### Opting specific packages out of bundling\n \n-<AppOnly>\n-\n-## Opting specific packages out of bundling\n-\n-Since packages imported inside Server Components and Route Handlers are automatically bundled by Next.js, you can opt specific packages out of bundling using the [`serverExternalPackages`](/docs/app/api-reference/config/next-config-js/serverExternalPackages) option in your `next.config.js`.\n+If you identify packages that shouldn't be in the bundle, you can opt specific packages out of automatic bundling using the [`serverExternalPackages`](/docs/pages/api-reference/config/next-config-js/serverExternalPackages) option in your `next.config.js`:\n \n ```js filename=\"next.config.js\"\n /** @type {import('next').NextConfig} */\n const nextConfig = {\n+  // Automatically bundle external packages:\n+  bundlePagesRouterDependencies: true,\n+  // Opt specific packages out of bundling:\n   serverExternalPackages: ['package-name'],\n }\n \n module.exports = nextConfig\n ```\n \n-Next.js includes a list of popular packages that currently are working on compatibility and automatically opt-ed out. See the [full list](/docs/app/api-reference/config/next-config-js/serverExternalPackages).\n-\n-</AppOnly>\n+</PagesOnly>"
        },
        {
            "sha": "7ecdcc1b194675644f3315311e827265de1ab0ca",
            "filename": "docs/01-app/02-guides/production-checklist.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F02-guides%2Fproduction-checklist.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F02-guides%2Fproduction-checklist.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fproduction-checklist.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -142,7 +142,7 @@ Before going to production, you can run `next build` to build your application l\n \n ### Analyzing bundles\n \n-Use the [`@next/bundle-analyzer` plugin](/docs/app/guides/package-bundling#analyzing-javascript-bundles) to analyze the size of your JavaScript bundles and identify large modules and dependencies that might be impacting your application's performance.\n+Use the [`@next/bundle-analyzer` plugin](/docs/app/guides/package-bundling#nextbundle-analyzer-for-webpack) to analyze the size of your JavaScript bundles and identify large modules and dependencies that might be impacting your application's performance.\n \n Additionally, the following tools can help you understand the impact of adding new dependencies to your application:\n "
        },
        {
            "sha": "5e208bbdb28901ca352c47f9317cc37a28ff0ea2",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/optimizePackageImports.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FoptimizePackageImports.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FoptimizePackageImports.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FoptimizePackageImports.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -1,6 +1,7 @@\n ---\n title: optimizePackageImports\n description: API Reference for optimizePackageImports Next.js Config Option\n+version: experimental\n ---\n \n {/* The content of this doc is shared between the app and pages router. You can use the `<PagesOnly>Content</PagesOnly>` component to add content that is specific to the Pages Router. Any shared content should not be wrapped in a component. */}"
        },
        {
            "sha": "71c4a8c44a27f8514774cbd0cfa319a1079211a4",
            "filename": "docs/01-app/03-api-reference/06-cli/next.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -215,7 +215,7 @@ By default, the command starts a local server after analysis completes, allowing\n - View the full import chain showing why a module is included\n - Trace imports across server-to-client component boundaries and dynamic imports\n \n-See [Package Bundling](/docs/app/guides/package-bundling) for optimization strategies.\n+See [Package Bundling](/docs/app/guides/package-bundling#optimizing-large-bundles) for optimization strategies.\n \n To write the analysis output to disk without starting the server, use the `--output` flag. The output is written to `.next/diagnostics/analyze` and contains static files that can be copied elsewhere or shared with others:\n "
        },
        {
            "sha": "079d3c73ffcd3e4a538472a40cfe9a2aba135e8e",
            "filename": "docs/02-pages/04-api-reference/04-config/01-next-config-js/optimizePackageImports.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FoptimizePackageImports.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FoptimizePackageImports.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FoptimizePackageImports.mdx?ref=bfeedb070a87afc0de8eeca8ee5c9b1f71d41bd8",
            "patch": "@@ -2,6 +2,7 @@\n title: optimizePackageImports\n description: API Reference for optimizePackageImports Next.js Config Option\n source: app/api-reference/config/next-config-js/optimizePackageImports\n+version: experimental\n ---\n \n {/* DO NOT EDIT. The content of this doc is generated from the source above. To edit the content of this page, navigate to the source page in your editor. You can use the `<PagesOnly>Content</PagesOnly>` component to add content that is specific to the Pages Router. Any shared content should not be wrapped in a component. */}"
        }
    ],
    "stats": {
        "total": 217,
        "additions": 180,
        "deletions": 37
    }
}