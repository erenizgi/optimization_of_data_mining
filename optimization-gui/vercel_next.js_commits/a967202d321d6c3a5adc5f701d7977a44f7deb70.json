{
    "author": "mischnic",
    "message": "Fix CSS Data URL test on Turbopack (#77970)",
    "sha": "a967202d321d6c3a5adc5f701d7977a44f7deb70",
    "files": [
        {
            "sha": "45a7fb99fe5d6b51dc761b30a476cfa7a9db78d1",
            "filename": "test/integration/css/test/css-modules.test.js",
            "status": "modified",
            "additions": 21,
            "deletions": 15,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/a967202d321d6c3a5adc5f701d7977a44f7deb70/test%2Fintegration%2Fcss%2Ftest%2Fcss-modules.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a967202d321d6c3a5adc5f701d7977a44f7deb70/test%2Fintegration%2Fcss%2Ftest%2Fcss-modules.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fcss-modules.test.js?ref=a967202d321d6c3a5adc5f701d7977a44f7deb70",
            "patch": "@@ -1,6 +1,6 @@\n /* eslint-env jest */\n import cheerio from 'cheerio'\n-import { readdir, readFile, remove } from 'fs-extra'\n+import { readFile, remove } from 'fs-extra'\n import {\n   check,\n   File,\n@@ -14,6 +14,7 @@ import {\n } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n+import nodeFs from 'fs'\n \n const fixturesDir = join(__dirname, '../..', 'css-fixtures')\n \n@@ -145,24 +146,25 @@ describe('should handle unresolved files gracefully', () => {\n       })\n \n       it('should have correct file references in CSS output', async () => {\n-        const cssFiles = await readdir(join(workDir, '.next/static/css'))\n+        const cssFolder = join(workDir, '.next', 'static')\n+        const cssFiles = nodeFs\n+          .readdirSync(cssFolder, {\n+            recursive: true,\n+            encoding: 'utf8',\n+          })\n+          .filter((f) => f.endsWith('.css'))\n \n-        for (const file of cssFiles) {\n-          if (file.endsWith('.css.map')) continue\n+        expect(cssFiles).not.toBeEmpty()\n \n-          const content = await readFile(\n-            join(workDir, '.next/static/css', file),\n-            'utf8'\n-          )\n-          console.log(file, content)\n+        for (const file of cssFiles) {\n+          const content = await readFile(join(cssFolder, file), 'utf8')\n \n           // if it is the combined global CSS file there are double the expected\n           // results\n           const howMany =\n             content.includes('p{') || content.includes('p,') ? 2 : 1\n \n           expect(content.match(/\\(\\/vercel\\.svg/g).length).toBe(howMany)\n-          // expect(content.match(/\\(vercel\\.svg/g).length).toBe(howMany)\n           expect(content.match(/\\(\\/_next\\/static\\/media/g).length).toBe(1)\n           expect(content.match(/\\(https:\\/\\//g).length).toBe(howMany)\n         }\n@@ -184,14 +186,18 @@ describe('Data URLs', () => {\n       })\n \n       it('should have emitted expected files', async () => {\n-        const cssFolder = join(workDir, '.next/static/css')\n-        const files = await readdir(cssFolder)\n-        const cssFiles = files.filter((f) => /\\.css$/.test(f))\n+        const cssFolder = join(workDir, '.next', 'static')\n+        const cssFiles = nodeFs\n+          .readdirSync(cssFolder, {\n+            recursive: true,\n+            encoding: 'utf8',\n+          })\n+          .filter((f) => f.endsWith('.css'))\n \n         expect(cssFiles.length).toBe(1)\n         const cssContent = await readFile(join(cssFolder, cssFiles[0]), 'utf8')\n-        expect(cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()).toMatch(\n-          /background:url\\(\"data:[^\"]+\"\\)/\n+        expect(cssContent.replace(/\\/\\*.*?\\*\\/n/g, '').trim()).toMatch(\n+          /background:url\\(\"?data:[^\"]+\"?\\)/\n         )\n       })\n     }"
        },
        {
            "sha": "bc7f934ebe8a46c297df67a1fb01242afc33f97f",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a967202d321d6c3a5adc5f701d7977a44f7deb70/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a967202d321d6c3a5adc5f701d7977a44f7deb70/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=a967202d321d6c3a5adc5f701d7977a44f7deb70",
            "patch": "@@ -9713,6 +9713,7 @@\n   \"test/integration/css/test/css-modules.test.js\": {\n     \"passed\": [\n       \"Data URLs production mode should compile successfully\",\n+      \"Data URLs production mode should have emitted expected files\",\n       \"Ordering with Global CSS and Modules (dev) useLightnincsss(false) should have the correct color (css ordering)\",\n       \"Ordering with Global CSS and Modules (dev) useLightnincsss(false) should have the correct color (css ordering) during hot reloads\",\n       \"Ordering with Global CSS and Modules (dev) useLightnincsss(false) should not execute scripts in any order\",\n@@ -9726,7 +9727,6 @@\n       \"should handle unresolved files gracefully production mode should build correctly\"\n     ],\n     \"failed\": [\n-      \"Data URLs production mode should have emitted expected files\",\n       \"should handle unresolved files gracefully production mode should have correct file references in CSS output\"\n     ],\n     \"pending\": ["
        }
    ],
    "stats": {
        "total": 38,
        "additions": 22,
        "deletions": 16
    }
}