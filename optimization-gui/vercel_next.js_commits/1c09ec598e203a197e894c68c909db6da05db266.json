{
    "author": "devjiwonchoi",
    "message": "[ts-next-plugin] clean up unused proxy (#78539)\n\nCleaned up a leftover unused proxy following up on\nhttps://github.com/vercel/next.js/pull/78237.\n\nBesides being unused, there was an issue reported from a large\nrepository. The repository was a monorepo, and the apps' modules were\nshared with each other. The user received an error:\n\n```\n[trace] <semantic> Response received: definitionAndBoundSpan (951). Request took 0 ms. Success: false .\nMessage: Error processing request. Cannot read properties of undefined (reading 'updateFromProject')\nTypeError: Cannot read properties of undefined (reading 'updateFromProject')\n    at synchronizeHostData (...)\n    at Object.getProgram (...)\n    at getSource (...)\n    at getEntryInfo (...)\n    at proxy.getDefinitionAndBoundSpan\n```\n\nThe issue begins when `getDefinitionAndBoundSpan` is triggered—typically\nvia `Cmd + Click` or even hovering(!) to view definitions, imports, or\nmodule references. In our case, since the repository contains multiple\napps, each enabling the plugin, navigating across apps using `Cmd +\nClick` caused `getDefinitionAndBoundSpan` to fire across multiple plugin\ninstances.\n\nThe root cause is that when `getDefinitionAndBoundSpan` is triggered, it\ncalls `synchronizeHostData()` and checks whether it is to update the\nproject by checking the `host.updateFromProject` exists. However, the\nLanguage Service Host is somehow `undefined` (assuming memory is\noverloaded due to initiating multiple plugins), so we received the error\nabove.\n\nx-ref:\nhttps://github.com/microsoft/TypeScript/blob/11e79327598db412a161616849041487673fadab/src/services/services.ts#L1692-L1693\n\nIf we clean up this `getDefinitionAndBoundSpan` proxy, the error above\nwill be gone, but `synchronizeHostData` is called pretty much every time\non language service requests, including `getSemanticDiagnostics` we are\nstill proxying — a potential issue we can't control that could happen\nfor complicated repositories like the above.\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C03S8ED1DKM/p1744231020199229)",
    "sha": "1c09ec598e203a197e894c68c909db6da05db266",
    "files": [
        {
            "sha": "8a9b1874be6b57970618f7a9e222dd23da6b3cf2",
            "filename": "packages/next/src/server/typescript/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1c09ec598e203a197e894c68c909db6da05db266/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c09ec598e203a197e894c68c909db6da05db266/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts?ref=1c09ec598e203a197e894c68c909db6da05db266",
            "patch": "@@ -343,15 +343,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n       return prior\n     }\n \n-    // Get definition and link for specific node\n-    proxy.getDefinitionAndBoundSpan = (fileName: string, position: number) => {\n-      const entryInfo = getEntryInfo(fileName)\n-      if (isAppEntryFile(fileName) && !entryInfo.client) {\n-      }\n-\n-      return info.languageService.getDefinitionAndBoundSpan(fileName, position)\n-    }\n-\n     return proxy\n   }\n "
        }
    ],
    "stats": {
        "total": 9,
        "additions": 0,
        "deletions": 9
    }
}