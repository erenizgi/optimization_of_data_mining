{
    "author": "ijjk",
    "message": "Use metadata for cache entry status code (#79512)\n\nThis avoids relying on the `res.statusCode` for generating a cache entry\nduring a background revalidate as it shouldn't be coupled to the current\nresponse.\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C08TP4DCGAG/p1747936529140749)",
    "sha": "ed2db11e4788337736d3001f1de718e0473c6299",
    "files": [
        {
            "sha": "11cb932a842f1b8426d8ec061ef03ac03378fc85",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=ed2db11e4788337736d3001f1de718e0473c6299",
            "patch": "@@ -23,7 +23,9 @@ import {\n   isRedirectError,\n   type RedirectType,\n } from '../../client/components/redirect-error'\n-import RenderResult from '../render-result'\n+import RenderResult, {\n+  type AppPageRenderResultMetadata,\n+} from '../render-result'\n import type { WorkStore } from '../app-render/work-async-storage.external'\n import { FlightRenderResult } from './flight-render-result'\n import {\n@@ -454,6 +456,7 @@ export async function handleAction({\n   requestStore,\n   serverActions,\n   ctx,\n+  metadata,\n }: {\n   req: BaseNextRequest\n   res: BaseNextResponse\n@@ -464,6 +467,7 @@ export async function handleAction({\n   requestStore: RequestStore\n   serverActions?: ServerActionsConfig\n   ctx: AppRenderContext\n+  metadata: AppPageRenderResultMetadata\n }): Promise<\n   | undefined\n   | {\n@@ -552,6 +556,7 @@ export async function handleAction({\n \n       if (isFetchAction) {\n         res.statusCode = 500\n+        metadata.statusCode = 500\n \n         const promise = Promise.reject(error)\n         try {\n@@ -950,6 +955,7 @@ export async function handleAction({\n       // if it's a fetch action, we'll set the status code for logging/debugging purposes\n       // but we won't set a Location header, as the redirect will be handled by the client router\n       res.statusCode = RedirectStatusCode.SeeOther\n+      metadata.statusCode = RedirectStatusCode.SeeOther\n \n       if (isFetchAction) {\n         return {\n@@ -973,6 +979,7 @@ export async function handleAction({\n       }\n     } else if (isHTTPAccessFallbackError(err)) {\n       res.statusCode = getAccessFallbackHTTPStatus(err)\n+      metadata.statusCode = res.statusCode\n \n       if (isFetchAction) {\n         const promise = Promise.reject(err)\n@@ -1004,6 +1011,7 @@ export async function handleAction({\n       // so that we can respond with a 413 to requests that break the body size limit\n       // (but if we do that, we also need to make sure that whatever handles the non-fetch error path below does the same)\n       res.statusCode = 500\n+      metadata.statusCode = 500\n       const promise = Promise.reject(err)\n       try {\n         // we need to await the promise to trigger the rejection early"
        },
        {
            "sha": "ba8add067f4657e3c9025b26fe958c62dd10d94c",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ed2db11e4788337736d3001f1de718e0473c6299",
            "patch": "@@ -1287,7 +1287,9 @@ async function renderToHTMLOrFlightImpl(\n     })\n   }\n \n-  const metadata: AppPageRenderResultMetadata = {}\n+  const metadata: AppPageRenderResultMetadata = {\n+    statusCode: isNotFoundPath ? 404 : undefined,\n+  }\n \n   const appUsingSizeAdjustment = !!nextFontManifest?.appUsingSizeAdjust\n \n@@ -1569,20 +1571,23 @@ async function renderToHTMLOrFlightImpl(\n         requestStore,\n         serverActions,\n         ctx,\n+        metadata,\n       })\n \n       if (actionRequestResult) {\n         if (actionRequestResult.type === 'not-found') {\n           const notFoundLoaderTree = createNotFoundLoaderTree(loaderTree)\n           res.statusCode = 404\n+          metadata.statusCode = 404\n           const stream = await renderToStreamWithTracing(\n             requestStore,\n             req,\n             res,\n             ctx,\n             notFoundLoaderTree,\n             formState,\n-            postponedState\n+            postponedState,\n+            metadata\n           )\n \n           return new RenderResult(stream, { metadata })\n@@ -1608,7 +1613,8 @@ async function renderToHTMLOrFlightImpl(\n       ctx,\n       loaderTree,\n       formState,\n-      postponedState\n+      postponedState,\n+      metadata\n     )\n \n     if (workStore.invalidDynamicUsageError) {\n@@ -1743,7 +1749,8 @@ async function renderToStream(\n   ctx: AppRenderContext,\n   tree: LoaderTree,\n   formState: any,\n-  postponedState: PostponedState | null\n+  postponedState: PostponedState | null,\n+  metadata: AppPageRenderResultMetadata\n ): Promise<ReadableStream<Uint8Array>> {\n   const { assetPrefix, nonce, pagePath, renderOpts } = ctx\n \n@@ -2093,10 +2100,12 @@ async function renderToStream(\n \n     if (isHTTPAccessFallbackError(err)) {\n       res.statusCode = getAccessFallbackHTTPStatus(err)\n+      metadata.statusCode = res.statusCode\n       errorType = getAccessFallbackErrorTypeByStatus(res.statusCode)\n     } else if (isRedirectError(err)) {\n       errorType = 'redirect'\n       res.statusCode = getRedirectStatusCodeFromError(err)\n+      metadata.statusCode = res.statusCode\n \n       const redirectUrl = addPathPrefix(getURLFromRedirectError(err), basePath)\n \n@@ -2110,6 +2119,7 @@ async function renderToStream(\n       setHeader('location', redirectUrl)\n     } else if (!shouldBailoutToCSR) {\n       res.statusCode = 500\n+      metadata.statusCode = res.statusCode\n     }\n \n     const [errorPreinitScripts, errorBootstrapScript] = getRequiredScripts(\n@@ -3726,16 +3736,19 @@ async function prerenderToStream(\n \n     if (isHTTPAccessFallbackError(err)) {\n       res.statusCode = getAccessFallbackHTTPStatus(err)\n+      metadata.statusCode = res.statusCode\n       errorType = getAccessFallbackErrorTypeByStatus(res.statusCode)\n     } else if (isRedirectError(err)) {\n       errorType = 'redirect'\n       res.statusCode = getRedirectStatusCodeFromError(err)\n+      metadata.statusCode = res.statusCode\n \n       const redirectUrl = addPathPrefix(getURLFromRedirectError(err), basePath)\n \n       setHeader('location', redirectUrl)\n     } else if (!shouldBailoutToCSR) {\n       res.statusCode = 500\n+      metadata.statusCode = res.statusCode\n     }\n \n     const [errorPreinitScripts, errorBootstrapScript] = getRequiredScripts("
        },
        {
            "sha": "01fdabb072ec33e1eb052d57f6b501e9f9e1bced",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=ed2db11e4788337736d3001f1de718e0473c6299",
            "patch": "@@ -2960,7 +2960,7 @@ export default abstract class Server<\n             headers,\n             rscData: metadata.flightData,\n             postponed: metadata.postponed,\n-            status: res.statusCode,\n+            status: metadata.statusCode,\n             segmentData: metadata.segmentData,\n           } satisfies CachedAppPageValue,\n           cacheControl,"
        },
        {
            "sha": "e91b25a6a21191912677f9278f8bf1cc54ace7df",
            "filename": "packages/next/src/server/render-result.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ed2db11e4788337736d3001f1de718e0473c6299/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts?ref=ed2db11e4788337736d3001f1de718e0473c6299",
            "patch": "@@ -31,6 +31,7 @@ export type AppPageRenderResultMetadata = {\n    * The headers to set on the response that were added by the render.\n    */\n   headers?: OutgoingHttpHeaders\n+  statusCode?: number\n   fetchTags?: string\n   fetchMetrics?: FetchMetrics\n "
        }
    ],
    "stats": {
        "total": 34,
        "additions": 28,
        "deletions": 6
    }
}