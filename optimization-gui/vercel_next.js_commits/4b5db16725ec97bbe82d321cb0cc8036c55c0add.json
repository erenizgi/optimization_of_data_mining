{
    "author": "timneutkens",
    "message": "Turbopack Build: docs for unsupported composes handling (#80238)\n\n## What?\n\nAdds additional documentation about `.css` (not `.module.css`) files\nbeing imported from a `.module.css` (CSS Module) using `composes` or\n`@import` and updates the tests to reflect the specific case not being\nsupported.",
    "sha": "4b5db16725ec97bbe82d321cb0cc8036c55c0add",
    "files": [
        {
            "sha": "5aafcd4cd3b940feb718dc171e55b697fa5bb6f5",
            "filename": "docs/01-app/05-api-reference/08-turbopack.mdx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4b5db16725ec97bbe82d321cb0cc8036c55c0add/docs%2F01-app%2F05-api-reference%2F08-turbopack.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/4b5db16725ec97bbe82d321cb0cc8036c55c0add/docs%2F01-app%2F05-api-reference%2F08-turbopack.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F05-api-reference%2F08-turbopack.mdx?ref=4b5db16725ec97bbe82d321cb0cc8036c55c0add",
            "patch": "@@ -99,6 +99,8 @@ Some features are not yet implemented or not planned:\n   - Standalone `:local` and `:global` pseudo-classes (only the function variant `:global(...)` is supported).\n   - The `@value` rule (superseded by CSS variables).\n   - `:import` and `:export` ICSS rules.\n+  - `composes` in `.module.css` composing a `.css` file. In webpack this would treat the `.css` file as a CSS Module, with Turbopack the `.css` file will always be global. This means that if you want to use `composes` in a CSS Module, you need to change the `.css` file to a `.module.css` file.\n+  - `@import` in CSS Modules importing `.css` as a CSS Module. In webpack this would treat the `.css` file as a CSS Module, with Turbopack the `.css` file will always be global. This means that if you want to use `@import` in a CSS Module, you need to change the `.css` file to a `.module.css` file.\n - **`webpack()` configuration** in `next.config.js`\n   Turbopack replaces webpack, so `webpack()` configs are not recognized. Use the [`turbopack` config](/docs/app/api-reference/config/next-config-js/turbopack) instead.\n - **AMP**"
        },
        {
            "sha": "c9829a1145e26661fd16c9c5024cc5481a2a3d38",
            "filename": "test/integration/css-features/test/css-modules.test.js",
            "status": "modified",
            "additions": 24,
            "deletions": 20,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-features%2Ftest%2Fcss-modules.test.js?ref=4b5db16725ec97bbe82d321cb0cc8036c55c0add",
            "patch": "@@ -120,29 +120,33 @@ describe('CSS Modules: Import Global CSS', () => {\n     }\n   )\n })\n+// Disabled with Turbopack because importing `.css` files in `.module.css` is handled as `.css` file not `.module.css` file\n+;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n+  'CSS Modules: Importing Invalid Global CSS',\n+  () => {\n+    ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n+      'production mode',\n+      () => {\n+        const appDir = join(fixturesDir, 'module-import-global-invalid')\n \n-describe('CSS Modules: Importing Invalid Global CSS', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      const appDir = join(fixturesDir, 'module-import-global-invalid')\n-\n-      beforeAll(async () => {\n-        await remove(join(appDir, '.next'))\n-      })\n+        beforeAll(async () => {\n+          await remove(join(appDir, '.next'))\n+        })\n \n-      it('should fail to build', async () => {\n-        const { code, stderr } = await nextBuild(appDir, [], {\n-          stderr: true,\n+        // eslint-disable-next-line jest/no-identical-title\n+        it('should fail to build', async () => {\n+          const { code, stderr } = await nextBuild(appDir, [], {\n+            stderr: true,\n+          })\n+          expect(code).not.toBe(0)\n+          expect(stderr).toContain('Failed to compile')\n+          expect(stderr).toContain('pages/styles.css')\n+          expect(stderr).toContain('Selector \"a\" is not pure')\n         })\n-        expect(code).not.toBe(0)\n-        expect(stderr).toContain('Failed to compile')\n-        expect(stderr).toContain('pages/styles.css')\n-        expect(stderr).toContain('Selector \"a\" is not pure')\n-      })\n-    }\n-  )\n-})\n+      }\n+    )\n+  }\n+)\n \n // Turbopack uses LightningCSS which doesn't support `@value`.\n ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)("
        },
        {
            "sha": "aa58a78a8b1e4c11e9e70ab7a8cc837b6507587b",
            "filename": "test/integration/css-modules/test/index.test.js",
            "status": "modified",
            "additions": 118,
            "deletions": 109,
            "changes": 227,
            "blob_url": "https://github.com/vercel/next.js/blob/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js?ref=4b5db16725ec97bbe82d321cb0cc8036c55c0add",
            "patch": "@@ -412,71 +412,77 @@ describe('Valid CSS Module Usage from within node_modules', () => {\n   )\n })\n \n-describe('Valid Nested CSS Module Usage from within node_modules', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      const appDir = join(fixturesDir, 'nm-module-nested')\n-\n-      let appPort\n-      let app\n-      beforeAll(async () => {\n-        await remove(join(appDir, '.next'))\n-        const { code, stdout } = await nextBuild(appDir, [], {\n-          stdout: true,\n+// Disabled with Turbopack because `composes` from `.css` files in `.module.css` files is not supported.\n+;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n+  'Valid Nested CSS Module Usage from within node_modules',\n+  () => {\n+    ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n+      'production mode',\n+      () => {\n+        const appDir = join(fixturesDir, 'nm-module-nested')\n+\n+        let appPort\n+        let app\n+        beforeAll(async () => {\n+          await remove(join(appDir, '.next'))\n+          const { code, stdout } = await nextBuild(appDir, [], {\n+            stdout: true,\n+          })\n+\n+          if (code !== 0) {\n+            console.error(stdout)\n+            throw new Error('Build failed')\n+          }\n+\n+          appPort = await findPort()\n+          app = await nextStart(appDir, appPort)\n+        })\n+        afterAll(async () => {\n+          await killApp(app)\n         })\n \n-        if (code !== 0) {\n-          console.error(stdout)\n-          throw new Error('Build failed')\n-        }\n-\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(async () => {\n-        await killApp(app)\n-      })\n-\n-      it(`should've prerendered with relevant data`, async () => {\n-        const content = await renderViaHTTP(appPort, '/')\n-        const $ = cheerio.load(content)\n-\n-        const cssPreload = $('#nm-div')\n-        expect(cssPreload.text()).toMatchInlineSnapshot(\n-          `\"{\"message\":\"Why hello there\"} {\"subClass\":\"example_subClass__m6Tyy other_className__OA8dV\"}\"`\n-        )\n-      })\n+        // eslint-disable-next-line jest/no-identical-title\n+        it(`should've prerendered with relevant data`, async () => {\n+          const content = await renderViaHTTP(appPort, '/')\n+          const $ = cheerio.load(content)\n \n-      it(`should've emitted a single CSS file`, async () => {\n-        const content = await renderViaHTTP(appPort, '/')\n-        const $ = cheerio.load(content)\n+          const cssPreload = $('#nm-div')\n+          expect(cssPreload.text()).toMatchInlineSnapshot(\n+            `\"{\"message\":\"Why hello there\"} {\"subClass\":\"example_subClass__m6Tyy other_className__OA8dV\"}\"`\n+          )\n+        })\n \n-        const cssSheet = $('link[rel=\"stylesheet\"]')\n-        expect(cssSheet.length).toBe(1)\n-        const stylesheet = cssSheet.attr('href')\n+        // eslint-disable-next-line jest/no-identical-title\n+        it(`should've emitted a single CSS file`, async () => {\n+          const content = await renderViaHTTP(appPort, '/')\n+          const $ = cheerio.load(content)\n \n-        const cssContent = await fetchViaHTTP(appPort, stylesheet).then((res) =>\n-          res.text()\n-        )\n+          const cssSheet = $('link[rel=\"stylesheet\"]')\n+          expect(cssSheet.length).toBe(1)\n+          const stylesheet = cssSheet.attr('href')\n \n-        if (process.env.IS_TURBOPACK_TEST) {\n-          expect(\n-            cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n-          ).toMatchInlineSnapshot(\n-            `\".other2_other2__dYPgz{color:red}.other3_other3__7hgUE{color:violet}.other_className__OA8dV{background:red;color:#ff0}.example_subClass__m6Tyy{background:blue}\"`\n-          )\n-        } else {\n-          expect(\n-            cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n-          ).toMatchInlineSnapshot(\n-            `\".other2_other2__dYPgz{color:red}.other3_other3__7hgUE{color:violet}.other_className__OA8dV{background:red;color:yellow}.example_subClass__m6Tyy{background:blue}\"`\n+          const cssContent = await fetchViaHTTP(appPort, stylesheet).then(\n+            (res) => res.text()\n           )\n-        }\n-      })\n-    }\n-  )\n-})\n+\n+          if (process.env.IS_TURBOPACK_TEST) {\n+            expect(\n+              cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n+            ).toMatchInlineSnapshot(\n+              `\".other2_other2__dYPgz{color:red}.other3_other3__7hgUE{color:violet}.other_className__OA8dV{background:red;color:#ff0}.example_subClass__m6Tyy{background:blue}\"`\n+            )\n+          } else {\n+            expect(\n+              cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n+            ).toMatchInlineSnapshot(\n+              `\".other2_other2__dYPgz{color:red}.other3_other3__7hgUE{color:violet}.other_className__OA8dV{background:red;color:yellow}.example_subClass__m6Tyy{background:blue}\"`\n+            )\n+          }\n+        })\n+      }\n+    )\n+  }\n+)\n \n describe('CSS Module Composes Usage (Basic)', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n@@ -535,62 +541,65 @@ describe('CSS Module Composes Usage (Basic)', () => {\n     }\n   )\n })\n-\n-describe('CSS Module Composes Usage (External)', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      // This is a very bad feature. Do not use it.\n-      const appDir = join(fixturesDir, 'composes-external')\n-\n-      let appPort\n-      let app\n-      beforeAll(async () => {\n-        await remove(join(appDir, '.next'))\n-        console.log({ appDir })\n-        const { code, stdout } = await nextBuild(appDir, [], {\n-          stdout: true,\n+;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n+  'CSS Module Composes Usage (External)',\n+  () => {\n+    ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n+      'production mode',\n+      () => {\n+        // This is a very bad feature. Do not use it.\n+        const appDir = join(fixturesDir, 'composes-external')\n+\n+        let appPort\n+        let app\n+        beforeAll(async () => {\n+          await remove(join(appDir, '.next'))\n+          console.log({ appDir })\n+          const { code, stdout } = await nextBuild(appDir, [], {\n+            stdout: true,\n+          })\n+          if (code !== 0) {\n+            console.error(stdout)\n+            throw new Error('Build failed')\n+          }\n+          appPort = await findPort()\n+          app = await nextStart(appDir, appPort)\n+        })\n+        afterAll(async () => {\n+          await killApp(app)\n         })\n-        if (code !== 0) {\n-          console.error(stdout)\n-          throw new Error('Build failed')\n-        }\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-      })\n-      afterAll(async () => {\n-        await killApp(app)\n-      })\n-\n-      it(`should've emitted a single CSS file`, async () => {\n-        const content = await renderViaHTTP(appPort, '/')\n-        const $ = cheerio.load(content)\n \n-        const cssSheet = $('link[rel=\"stylesheet\"]')\n-        expect(cssSheet.length).toBe(1)\n-        const stylesheet = cssSheet.attr('href')\n+        // eslint-disable-next-line jest/no-identical-title\n+        it(`should've emitted a single CSS file`, async () => {\n+          const content = await renderViaHTTP(appPort, '/')\n+          const $ = cheerio.load(content)\n \n-        const cssContent = await fetchViaHTTP(appPort, stylesheet).then((res) =>\n-          res.text()\n-        )\n+          const cssSheet = $('link[rel=\"stylesheet\"]')\n+          expect(cssSheet.length).toBe(1)\n+          const stylesheet = cssSheet.attr('href')\n \n-        if (process.env.IS_TURBOPACK_TEST) {\n-          expect(\n-            cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n-          ).toMatchInlineSnapshot(\n-            `\".other_className__eZV4M{background:red;color:#ff0}.index_subClass__eDzaW{background:blue}\"`\n+          const cssContent = await fetchViaHTTP(appPort, stylesheet).then(\n+            (res) => res.text()\n           )\n-        } else {\n-          expect(\n-            cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n-          ).toMatchInlineSnapshot(\n-            `\".other_className__eZV4M{background:red;color:yellow}.index_subClass__eDzaW{background:blue}\"`\n-          )\n-        }\n-      })\n-    }\n-  )\n-})\n+\n+          if (process.env.IS_TURBOPACK_TEST) {\n+            expect(\n+              cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n+            ).toMatchInlineSnapshot(\n+              `\".other_className__eZV4M{background:red;color:#ff0}.index_subClass__eDzaW{background:blue}\"`\n+            )\n+          } else {\n+            expect(\n+              cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n+            ).toMatchInlineSnapshot(\n+              `\".other_className__eZV4M{background:red;color:yellow}.index_subClass__eDzaW{background:blue}\"`\n+            )\n+          }\n+        })\n+      }\n+    )\n+  }\n+)\n \n describe('Dynamic Route CSS Module Usage', () => {\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)("
        },
        {
            "sha": "42aa973aa2580d9f6e5b14e8ea8425ac67ebd240",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/4b5db16725ec97bbe82d321cb0cc8036c55c0add/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=4b5db16725ec97bbe82d321cb0cc8036c55c0add",
            "patch": "@@ -10304,13 +10304,12 @@\n       \"Valid CSS Module Usage from within node_modules production mode should've prerendered with relevant data\",\n       \"cssmodules-pure-no-check usage should apply styles correctly\",\n       \"cssmodules-pure-no-check usage should have compiled successfully\",\n-      \"cssmodules-pure-no-check usage should've emitted a CSS file\"\n-    ],\n-    \"failed\": [\n+      \"cssmodules-pure-no-check usage should've emitted a CSS file\",\n       \"CSS Module Composes Usage (External) production mode should've emitted a single CSS file\",\n       \"Valid Nested CSS Module Usage from within node_modules production mode should've emitted a single CSS file\",\n       \"Valid Nested CSS Module Usage from within node_modules production mode should've prerendered with relevant data\"\n     ],\n+    \"failed\": [],\n     \"pending\": [\n       \"Invalid CSS Module Usage in node_modules production mode should fail to build\",\n       \"Invalid Global CSS Module Usage in node_modules production mode should fail to build\""
        }
    ],
    "stats": {
        "total": 278,
        "additions": 146,
        "deletions": 132
    }
}