{
    "author": "eps1lon",
    "message": "[next-upgrade] Add `next upgrade` (#86120)",
    "sha": "158797836305daf387e373e657a69ca45af48c70",
    "files": [
        {
            "sha": "222b8cb57bb16c9c8856175b9366b8267404e0d4",
            "filename": "docs/01-app/01-getting-started/18-upgrading.mdx",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/docs%2F01-app%2F01-getting-started%2F18-upgrading.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/docs%2F01-app%2F01-getting-started%2F18-upgrading.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F01-getting-started%2F18-upgrading.mdx?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -12,10 +12,16 @@ related:\n \n ## Latest version\n \n-To update to the latest version of Next.js, you can use the `upgrade` codemod:\n+To update to the latest version of Next.js, you can use the `upgrade` command:\n \n ```bash filename=\"Terminal\"\n-npx @next/codemod@latest upgrade latest\n+next upgrade\n+```\n+\n+Next.js 15 and earlier do not support the `upgrade` command and need to use a separate package instead:\n+\n+```bash filename=\"Terminal\"\n+npx @next/codemod@canary upgrade latest\n ```\n \n If you prefer to upgrade manually, install the latest Next.js and React versions:"
        },
        {
            "sha": "e83c9ba9e2bc25787f796ee0ddf02e8b506ece3c",
            "filename": "docs/01-app/03-api-reference/06-cli/next.mdx",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -34,6 +34,7 @@ The following commands are available:\n | [`info`](#next-info-options)           | Prints relevant details about the current system which can be used to report Next.js bugs.                    |\n | [`telemetry`](#next-telemetry-options) | Allows you to enable or disable Next.js' completely anonymous telemetry collection.                           |\n | [`typegen`](#next-typegen-options)     | Generates TypeScript definitions for routes, pages, layouts, and route handlers without running a full build. |\n+| [`upgrade`](#next-upgrade-options)     | Upgrades your Next.js application to the latest version.                                                      |\n \n > **Good to know**: Running `next` without a command is an alias for `next dev`.\n \n@@ -186,6 +187,19 @@ To ensure `next-env.d.ts` is present before type-checking run `next typegen`. Th\n \n > **Good to know**: `next typegen` loads your Next.js config (`next.config.js`, `next.config.mjs`, or `next.config.ts`) using the production build phase. Ensure any required environment variables and dependencies are available so the config can load correctly.\n \n+## `next upgrade` options\n+\n+`next upgrade` upgrades your Next.js application to the latest version.\n+\n+The following options are available for the `next upgrade` command:\n+\n+| Option                  | Description                                                                                                                                        |\n+| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |\n+| `-h, --help`            | Show all available options.                                                                                                                        |\n+| `[directory]`           | A directory with the Next.js application to upgrade. If not provided, the current directory will be used.                                          |\n+| `--revision <revision>` | Specify a Next.js version or tag to upgrade to (e.g., `latest`, `canary`, `15.0.0`). Defaults to the release channel you have currently installed. |\n+| `--verbose`             | Show verbose output during the upgrade process.                                                                                                    |\n+\n ## Examples\n \n ### Debugging prerender errors"
        },
        {
            "sha": "e679f3b27452f65f4e08b53e5f08983722f47a15",
            "filename": "packages/next-codemod/bin/next-codemod.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -58,6 +58,8 @@ program\n   .description(\n     'Upgrade Next.js apps to desired versions with a single command.'\n   )\n+  // The CLI interface must be backwards compatible at all times so that older\n+  // versions of Next.js can still run the codemod successfully.\n   .argument(\n     '[revision]',\n     'Specify the target Next.js version using an NPM dist tag (e.g. \"latest\", \"canary\", \"rc\", \"beta\") or an exact version number (e.g. \"15.0.0\").',"
        },
        {
            "sha": "8bca5c5ef0e8ea6765ebc024cdb68fce3e6e055f",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -411,6 +411,36 @@ program\n   )\n   .usage('[directory] [options]')\n \n+const nextVersion = process.env.__NEXT_VERSION || 'unknown'\n+program\n+  .command('upgrade')\n+  .description(\n+    'Upgrade Next.js apps to desired versions with a single command.'\n+  )\n+  .argument(\n+    '[directory]',\n+    `A Next.js project directory to upgrade. ${italic(\n+      'If no directory is provided, the current directory will be used.'\n+    )}`\n+  )\n+  .usage('[directory] [options]')\n+  .option(\n+    '--revision <revision>',\n+    'Specify the target Next.js version using an NPM dist tag (e.g. \"latest\", \"canary\", \"rc\", \"beta\") or an exact version number (e.g. \"15.0.0\").',\n+    nextVersion.includes('-canary.')\n+      ? 'canary'\n+      : nextVersion.includes('-rc.')\n+        ? 'rc'\n+        : nextVersion.includes('-beta.')\n+          ? 'beta'\n+          : 'latest'\n+  )\n+  .option('--verbose', 'Verbose output', false)\n+  .action(async (directory, options) => {\n+    const mod = await import('../cli/next-upgrade.js')\n+    mod.spawnNextUpgrade(directory, options)\n+  })\n+\n program\n   .command('experimental-test')\n   .description("
        },
        {
            "sha": "2c71e8a630e6395dadb5a178bd675f1915e2f9b1",
            "filename": "packages/next/src/cli/next-upgrade.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Fcli%2Fnext-upgrade.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Fcli%2Fnext-upgrade.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-upgrade.ts?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -0,0 +1,41 @@\n+import { spawn } from 'child_process'\n+import { getProjectDir } from '../lib/get-project-dir'\n+import { getNpxCommand } from '../lib/helpers/get-npx-command'\n+\n+interface NextUpgradeOptions {\n+  revision: string\n+  verbose: boolean\n+}\n+\n+export function spawnNextUpgrade(\n+  directory: string | undefined,\n+  options: NextUpgradeOptions\n+) {\n+  const baseDir = getProjectDir(directory)\n+  const [upgradeProcessCommand, ...upgradeProcessDefaultArgs] =\n+    getNpxCommand(baseDir).split(' ')\n+\n+  const upgradeProcessCommandArgs = [\n+    ...upgradeProcessDefaultArgs,\n+    // Needs to be bleeding edge (canary) to pick up latest codemods.\n+    '@next/codemod@canary',\n+    'upgrade',\n+    options.revision,\n+  ]\n+  if (options.verbose) {\n+    upgradeProcessCommandArgs.push('--verbose')\n+  }\n+\n+  const upgradeProcess = spawn(\n+    upgradeProcessCommand,\n+    upgradeProcessCommandArgs,\n+    {\n+      stdio: 'inherit',\n+      cwd: baseDir,\n+    }\n+  )\n+\n+  upgradeProcess.on('close', (code) => {\n+    process.exitCode = code ?? 0\n+  })\n+}"
        },
        {
            "sha": "402b486a7b0a5e1241a11530949ff3bfff26bfdb",
            "filename": "packages/next/src/lib/helpers/get-npx-command.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Flib%2Fhelpers%2Fget-npx-command.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/158797836305daf387e373e657a69ca45af48c70/packages%2Fnext%2Fsrc%2Flib%2Fhelpers%2Fget-npx-command.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fhelpers%2Fget-npx-command.ts?ref=158797836305daf387e373e657a69ca45af48c70",
            "patch": "@@ -3,13 +3,13 @@ import { getPkgManager } from './get-pkg-manager'\n \n export function getNpxCommand(baseDir: string) {\n   const pkgManager = getPkgManager(baseDir)\n-  let command = 'npx'\n+  let command = 'npx --yes'\n   if (pkgManager === 'pnpm') {\n-    command = 'pnpm dlx'\n+    command = 'pnpm --silent dlx'\n   } else if (pkgManager === 'yarn') {\n     try {\n       execSync('yarn dlx --help', { stdio: 'ignore' })\n-      command = 'yarn dlx'\n+      command = 'yarn --quiet dlx'\n     } catch {}\n   }\n "
        }
    ],
    "stats": {
        "total": 103,
        "additions": 98,
        "deletions": 5
    }
}