{
    "author": "wbinnssmith",
    "message": "Webpack: abstract away getting compilation spans (#76579)\n\nCurrently many of our plugins import a singleton mapping of webpack compilation objects to their corresponding tracing span. \n\nThis change abstracts that away into a function called `getCompilationSpan`, and allows us to use the corresponding mapping in the rspack case. \n\nPreviously, any plugin that used these would fail with rspack when the compilation object wouldnâ€™t be found. This was the case when running `next build` with rspack.\n\nTest Plan: Install and run `next build` with the rspack plugin in a test app.",
    "sha": "d75dbd32ba1be024e7992ac0825494bb7e2b787e",
    "files": [
        {
            "sha": "0df3c173b692966b94d2b3b2138ebb80d3da7005",
            "filename": "packages/next/src/build/webpack/plugins/build-manifest-plugin.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts?ref=d75dbd32ba1be024e7992ac0825494bb7e2b787e",
            "patch": "@@ -17,11 +17,8 @@ import type { BuildManifest } from '../../../server/get-page-files'\n import getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\n import { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\n import { getSortedRoutes } from '../../../shared/lib/router/utils'\n-import { spans as webpackSpans } from './profiling-plugin'\n-import { compilationSpans as rspackSpans } from './rspack-profiling-plugin'\n import { Span } from '../../../trace'\n-\n-const compilationSpans = process.env.NEXT_RSPACK ? rspackSpans : webpackSpans\n+import { getCompilationSpan } from '../utils'\n \n type DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n \n@@ -109,9 +106,9 @@ export function generateClientManifest(\n   compilation?: any\n ): string | undefined {\n   const compilationSpan = compilation\n-    ? compilationSpans.get(compilation)\n+    ? getCompilationSpan(compilation)\n     : compiler\n-      ? compilationSpans.get(compiler)\n+      ? getCompilationSpan(compiler)\n       : new Span({ name: 'client-manifest' })\n \n   const genClientManifestSpan = compilationSpan?.traceChild(\n@@ -205,7 +202,7 @@ export default class BuildManifestPlugin {\n \n   createAssets(compiler: any, compilation: any) {\n     const compilationSpan =\n-      compilationSpans.get(compilation) ?? compilationSpans.get(compiler)\n+      getCompilationSpan(compilation) ?? getCompilationSpan(compiler)\n     if (!compilationSpan) {\n       throw new Error('No span found for compilation')\n     }"
        },
        {
            "sha": "5f73cecca06580ac15578d458639a7c228aee469",
            "filename": "packages/next/src/build/webpack/plugins/css-minimizer-plugin.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts?ref=d75dbd32ba1be024e7992ac0825494bb7e2b787e",
            "patch": "@@ -3,7 +3,7 @@ import postcssScss from 'next/dist/compiled/postcss-scss'\n import postcss from 'postcss'\n import type { Parser } from 'postcss'\n import { webpack, sources } from 'next/dist/compiled/webpack/webpack'\n-import { spans } from './profiling-plugin'\n+import { getCompilationSpan } from '../utils'\n \n // https://github.com/NMFR/optimize-css-assets-webpack-plugin/blob/0a410a9bf28c7b0e81a3470a13748e68ca2f50aa/src/index.js#L20\n const CSS_REGEX = /\\.css(\\?.*)?$/i\n@@ -64,7 +64,8 @@ export class CssMinimizerPlugin {\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE,\n         },\n         async (assets: any) => {\n-          const compilationSpan = spans.get(compilation) || spans.get(compiler)\n+          const compilationSpan =\n+            getCompilationSpan(compilation) || getCompilationSpan(compiler)\n           const cssMinimizerSpan = compilationSpan!.traceChild(\n             'css-minimizer-plugin'\n           )"
        },
        {
            "sha": "0ada6ad88b770991d177702f49f6394d220f5900",
            "filename": "packages/next/src/build/webpack/plugins/minify-webpack-plugin/src/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts?ref=d75dbd32ba1be024e7992ac0825494bb7e2b787e",
            "patch": "@@ -7,7 +7,7 @@ import {\n   type Compilation,\n } from 'next/dist/compiled/webpack/webpack'\n import pLimit from 'next/dist/compiled/p-limit'\n-import { spans } from '../../profiling-plugin'\n+import { getCompilationSpan } from '../../../utils'\n \n function buildError(error: any, file: string) {\n   if (error.line) {\n@@ -48,7 +48,8 @@ export class MinifyPlugin {\n     }\n   ) {\n     const mangle = !this.options.noMangling\n-    const compilationSpan = spans.get(compilation)! || spans.get(compiler)\n+    const compilationSpan =\n+      getCompilationSpan(compilation)! || getCompilationSpan(compiler)\n \n     const MinifierSpan = compilationSpan.traceChild(\n       'minify-webpack-plugin-optimize'"
        },
        {
            "sha": "8b77c2c95658d8c84d35a41d5492900f278ccbc4",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=d75dbd32ba1be024e7992ac0825494bb7e2b787e",
            "patch": "@@ -1,6 +1,5 @@\n import nodePath from 'path'\n import type { Span } from '../../../trace'\n-import { spans } from './profiling-plugin'\n import isError from '../../../lib/is-error'\n import { nodeFileTrace } from 'next/dist/compiled/@vercel/nft'\n import type { NodeFileTraceReasons } from 'next/dist/compiled/@vercel/nft'\n@@ -20,6 +19,7 @@ import { getModuleBuildInfo } from '../loaders/get-module-build-info'\n import { getPageFilePath } from '../../entries'\n import { resolveExternal } from '../../handle-externals'\n import { isStaticMetadataRoute } from '../../../lib/metadata/is-metadata-route'\n+import { getCompilationSpan } from '../utils'\n \n const PLUGIN_NAME = 'TraceEntryPointsPlugin'\n export const TRACE_IGNORES = [\n@@ -576,6 +576,12 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n \n   apply(compiler: webpack.Compiler) {\n     compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+      const compilationSpan =\n+        getCompilationSpan(compilation) || getCompilationSpan(compiler)!\n+      const traceEntrypointsPluginSpan = compilationSpan.traceChild(\n+        'next-trace-entrypoint-plugin'\n+      )\n+\n       compilation.hooks.processAssets.tapAsync(\n         {\n           name: PLUGIN_NAME,\n@@ -633,10 +639,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n         }\n       }\n \n-      const compilationSpan = spans.get(compilation) || spans.get(compiler)!\n-      const traceEntrypointsPluginSpan = compilationSpan.traceChild(\n-        'next-trace-entrypoint-plugin'\n-      )\n       traceEntrypointsPluginSpan.traceFn(() => {\n         compilation.hooks.processAssets.tapAsync(\n           {"
        },
        {
            "sha": "2fc6283e512b089e4841aee4a20b01d8ccfe5be2",
            "filename": "packages/next/src/build/webpack/utils.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d75dbd32ba1be024e7992ac0825494bb7e2b787e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts?ref=d75dbd32ba1be024e7992ac0825494bb7e2b787e",
            "patch": "@@ -5,9 +5,13 @@ import type {\n   NormalModule,\n   Module,\n   ModuleGraph,\n+  Compiler,\n } from 'webpack'\n import type { ModuleGraphConnection } from 'webpack'\n import { getAppLoader } from '../entries'\n+import { spans as webpackCompilationSpans } from './plugins/profiling-plugin'\n+import { compilationSpans as rspackCompilationSpans } from './plugins/rspack-profiling-plugin'\n+import type { Span } from '../../trace'\n \n export function traverseModules(\n   compilation: Compilation,\n@@ -114,3 +118,13 @@ export function getModuleReferencesInOrder(\n   connections.sort((a, b) => a.index - b.index)\n   return connections.map((c) => c.connection)\n }\n+\n+export function getCompilationSpan(\n+  compilation: Compiler | Compilation\n+): Span | undefined {\n+  const compilationSpans = process.env.NEXT_RSPACK\n+    ? rspackCompilationSpans\n+    : webpackCompilationSpans\n+\n+  return compilationSpans.get(compilation)\n+}"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 31,
        "deletions": 16
    }
}