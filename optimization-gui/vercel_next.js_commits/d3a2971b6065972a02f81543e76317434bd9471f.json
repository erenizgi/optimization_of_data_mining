{
    "author": "mischnic",
    "message": "Turbopack: fix graph layout segment optimization (#77094)\n\nThe modules in the last layout segment (`server_component_entries`) were visited twice: as part of the last iteration of the for loop (which doesn't propagate its `visited_modules` because it's not a layout), and then again with `rsc_entry`.\r\n\r\nWe already do the right thing in another place:\r\nhttps://github.com/vercel/next.js/blob/f42739d114695702922dab4c08d6c8223daafceb/crates/next-api/src/app.rs#L1740-L1748\r\n\r\nBefore:\r\n![Bildschirmfoto 2025-03-17 um 11 39 41](https://github.com/user-attachments/assets/62adad85-043c-47f4-8c70-a8f5779e34a9)\r\n\r\nAfter:\r\n![Bildschirmfoto 2025-03-17 um 11 43 14](https://github.com/user-attachments/assets/62642bcf-8946-4bcd-ba16-cdd711cac383)",
    "sha": "d3a2971b6065972a02f81543e76317434bd9471f",
    "files": [
        {
            "sha": "966ce24d59d6dc287603c874f708c450e5f4a78e",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d3a2971b6065972a02f81543e76317434bd9471f/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d3a2971b6065972a02f81543e76317434bd9471f/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=d3a2971b6065972a02f81543e76317434bd9471f",
            "patch": "@@ -855,7 +855,13 @@ impl AppProject {\n                     graphs.push(graph);\n                     let mut visited_modules = VisitedModules::from_graph(graph);\n \n-                    for module in server_component_entries.iter() {\n+                    // Skip the last server component, which is the page itself, because that one\n+                    // won't have it's visited modules added, and will be visited in the next step\n+                    // as part of rsc_entry\n+                    for module in server_component_entries\n+                        .iter()\n+                        .take(server_component_entries.len().saturating_sub(1))\n+                    {\n                         let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                             // This should really be ChunkGroupEntry::Shared(module.await?.module),\n                             // but that breaks everything for some reason."
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}