{
    "author": "ijjk",
    "message": "Revert \"Fix tracing of server actions imported by client components (#78968) (#82161)\n\nIt seems these additional fs operations/transforms on client components\nwhile tracing dependencies is causing a big perf hit which is not worth\nthe edge case of catching fs dependencies in server actions from client\ncomponents.\n\nA workaround is available without our automatic tracing via\n`outputFileTracingIncludes` so this reverts the tracing to alleviate the\nperf concern.\n\nWe will be able to handle cases like this without the perf consequence\nwith turbopack going forward.\n\nThis reverts commit af0473b7f43bbabe0b327ec65348bf85610a1153.\n\nCloses: https://github.com/vercel/next.js/issues/81902",
    "sha": "14be7505c61dc9c1631dc0b1da2d444b15ca5e82",
    "files": [
        {
            "sha": "06acd2a193cfa2a58e9ea65507b8398ba0375d12",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/14be7505c61dc9c1631dc0b1da2d444b15ca5e82/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/14be7505c61dc9c1631dc0b1da2d444b15ca5e82/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=14be7505c61dc9c1631dc0b1da2d444b15ca5e82",
            "patch": "@@ -2036,7 +2036,6 @@ export default async function getBaseWebpackConfig(\n             appDirEnabled: hasAppDir,\n             traceIgnores: [],\n             compilerType,\n-            swcLoaderConfig: swcDefaultLoader,\n           }\n         ),\n       // Moment.js is an extremely popular library that bundles large locale files"
        },
        {
            "sha": "e29c9c3489809bcd4c9c38f6acead51a4e924050",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 75,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/14be7505c61dc9c1631dc0b1da2d444b15ca5e82/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/14be7505c61dc9c1631dc0b1da2d444b15ca5e82/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=14be7505c61dc9c1631dc0b1da2d444b15ca5e82",
            "patch": "@@ -18,10 +18,8 @@ import picomatch from 'next/dist/compiled/picomatch'\n import { getModuleBuildInfo } from '../loaders/get-module-build-info'\n import { getPageFilePath } from '../../entries'\n import { resolveExternal } from '../../handle-externals'\n-import swcLoader, { type SWCLoaderOptions } from '../loaders/next-swc-loader'\n import { isMetadataRouteFile } from '../../../lib/metadata/is-metadata-route'\n import { getCompilationSpan } from '../utils'\n-import { isClientComponentEntryModule } from '../loaders/utils'\n \n const PLUGIN_NAME = 'TraceEntryPointsPlugin'\n export const TRACE_IGNORES = [\n@@ -139,10 +137,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n   private traceIgnores: string[]\n   private esmExternals?: NextConfigComplete['experimental']['esmExternals']\n   private compilerType: CompilerNameValues\n-  private swcLoaderConfig: {\n-    loader: string\n-    options: Partial<SWCLoaderOptions>\n-  }\n \n   constructor({\n     rootDir,\n@@ -153,7 +147,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n     traceIgnores,\n     esmExternals,\n     outputFileTracingRoot,\n-    swcLoaderConfig,\n   }: {\n     rootDir: string\n     compilerType: CompilerNameValues\n@@ -163,7 +156,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n     traceIgnores?: string[]\n     outputFileTracingRoot?: string\n     esmExternals?: NextConfigComplete['experimental']['esmExternals']\n-    swcLoaderConfig: TraceEntryPointsPlugin['swcLoaderConfig']\n   }) {\n     this.rootDir = rootDir\n     this.appDir = appDir\n@@ -174,7 +166,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n     this.traceIgnores = traceIgnores || []\n     this.tracingRoot = outputFileTracingRoot || rootDir\n     this.compilerType = compilerType\n-    this.swcLoaderConfig = swcLoaderConfig\n   }\n \n   // Here we output all traced assets and webpack chunks to a\n@@ -409,18 +400,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n                 }\n               })\n \n-            const readOriginalSource = (path: string) => {\n-              return new Promise<string | Buffer>((resolve) => {\n-                compilation.inputFileSystem.readFile(path, (err, result) => {\n-                  if (err) {\n-                    // we can't throw here as that crashes build un-necessarily\n-                    return resolve('')\n-                  }\n-                  resolve(result || '')\n-                })\n-              })\n-            }\n-\n             const readFile = async (\n               path: string\n             ): Promise<Buffer | string | null> => {\n@@ -429,60 +408,6 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n               // map the transpiled source when available to avoid\n               // parse errors in node-file-trace\n               let source: Buffer | string = mod?.originalSource?.()?.buffer()\n-\n-              try {\n-                // fallback to reading raw source file, this may fail\n-                // due to unsupported syntax but best effort attempt\n-                let usingOriginalSource = false\n-                if (!source || isClientComponentEntryModule(mod)) {\n-                  source = await readOriginalSource(path)\n-                  usingOriginalSource = true\n-                }\n-                const sourceString = source.toString()\n-\n-                // If this is a client component we need to trace the\n-                // original transpiled source not the client proxy which is\n-                // applied before this plugin is run due to the\n-                // client-module-loader\n-                if (\n-                  usingOriginalSource &&\n-                  // don't attempt transpiling CSS or image imports\n-                  path.match(/\\.(tsx|ts|js|cjs|mjs|jsx)$/)\n-                ) {\n-                  let transformResolve: (result: string) => void\n-                  let transformReject: (error: unknown) => void\n-                  const transformPromise = new Promise<string>(\n-                    (resolve, reject) => {\n-                      transformResolve = resolve\n-                      transformReject = reject\n-                    }\n-                  )\n-\n-                  // TODO: should we apply all loaders except the\n-                  // client-module-loader?\n-                  swcLoader.apply(\n-                    {\n-                      resourcePath: path,\n-                      getOptions: () => {\n-                        return this.swcLoaderConfig.options\n-                      },\n-                      async: () => {\n-                        return (err: unknown, result: string) => {\n-                          if (err) {\n-                            return transformReject(err)\n-                          }\n-                          return transformResolve(result)\n-                        }\n-                      },\n-                    },\n-                    [sourceString, undefined]\n-                  )\n-                  source = await transformPromise\n-                }\n-              } catch {\n-                /* non-fatal */\n-              }\n-\n               return source || ''\n             }\n "
        },
        {
            "sha": "942f648a58a1c99511ac623947e449c8f409f9f2",
            "filename": "test/production/app-dir/action-tracing/action-tracing.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Faction-tracing.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Faction-tracing.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Faction-tracing.test.ts?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1,19 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import path from 'path'\n-\n-describe('action-tracing', () => {\n-  const { next, skipped } = nextTestSetup({\n-    files: __dirname,\n-    skipDeployment: true,\n-  })\n-  if (skipped) return\n-\n-  it('should trace server action imported by client correctly', async () => {\n-    const traceData = (await next.readJSON(\n-      path.join('.next', 'server', 'app', 'page.js.nft.json')\n-    )) as {\n-      files: string[]\n-    }\n-    expect(traceData.files.some((file) => file.includes('data.txt'))).toBe(true)\n-  })\n-})"
        },
        {
            "sha": "219a2f7774afb98502a68889bc753cc49ea209e9",
            "filename": "test/production/app-dir/action-tracing/app/action.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Faction.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Faction.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Faction.ts?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1,14 +0,0 @@\n-'use server'\n-\n-try {\n-  if (process.env.NEXT_RUNTIME !== 'edge') {\n-    require('fs').readFileSync(\n-      require('path').join(process.cwd(), 'data.txt'),\n-      'utf8'\n-    )\n-  }\n-} catch {}\n-\n-export async function action() {\n-  return 'action'\n-}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/action-tracing/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Flayout.tsx?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1,8 +0,0 @@\n-import { ReactNode } from 'react'\n-export default function Root({ children }: { children: ReactNode }) {\n-  return (\n-    <html>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "031e63d8bf0a582adec759ffd66c7ac591f144e2",
            "filename": "test/production/app-dir/action-tracing/app/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fapp%2Fpage.tsx?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1,15 +0,0 @@\n-'use client'\n-\n-import { action } from './action'\n-\n-export default function Page() {\n-  return (\n-    <button\n-      onClick={() => {\n-        action()\n-      }}\n-    >\n-      click\n-    </button>\n-  )\n-}"
        },
        {
            "sha": "6320cd248dd8aeaab759d5871f8781b5c0505172",
            "filename": "test/production/app-dir/action-tracing/data.txt",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fdata.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fdata.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fdata.txt?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1 +0,0 @@\n-data\n\\ No newline at end of file"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/action-tracing/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/541902e380dbe79cfa3fa16b0faf31e1df02dc3c/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Faction-tracing%2Fnext.config.js?ref=541902e380dbe79cfa3fa16b0faf31e1df02dc3c",
            "patch": "@@ -1,6 +0,0 @@\n-/**\n- * @type {import('next').NextConfig}\n- */\n-const nextConfig = {}\n-\n-module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 0,
        "deletions": 139
    }
}