{
    "author": "ztanner",
    "message": "fix: server actions should fetch from the router canonicalUrl (#80690)\n\nA test related to navigation + server action handling was frequently\nflaking in CI\n([x-ref](https://github.com/vercel/next.js/actions/runs/15746992788/job/44386768835#step:34:2634)).\nWhen simulating a 20x browser slowdown, it's fairly easy to reproduce\nthe failure case as well.\n\nThe failure occurs due to a race where the router will invoke the server\naction against the page the user was on _before_ the navigation, but\n_after_ the navigation action has been processed. As a result, the RSC\npayload associated with the target page gets replaced by the RSC payload\nreturned from the server action. There exists a window of time where\n`window.location.pathname` is still referring to the previous URL while\n`routerState.canonicalUrl` would have been updated to the new page.\n\nThis revealed two things:\n- The behavior being tested here only tests the expected behavior some\nof the time: when it failed, it meant the action wasn't actually\nforwarded (not currently addressed by this PR)\n- The router state should be the source of truth when determining the\nURL to fetch from",
    "sha": "fc9939938d96fb7221ff25954e62218e0cd83ddc",
    "files": [
        {
            "sha": "265051113047e27049e52999a8ae243951de7b90",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fc9939938d96fb7221ff25954e62218e0cd83ddc/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc9939938d96fb7221ff25954e62218e0cd83ddc/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=fc9939938d96fb7221ff25954e62218e0cd83ddc",
            "patch": "@@ -87,7 +87,7 @@ async function fetchServerAction(\n \n   const body = await encodeReply(usedArgs, { temporaryReferences })\n \n-  const res = await fetch('', {\n+  const res = await fetch(state.canonicalUrl, {\n     method: 'POST',\n     headers: {\n       Accept: RSC_CONTENT_TYPE_HEADER,"
        },
        {
            "sha": "747e288e6f9e6d6745927d4daeb84a06f2318825",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fc9939938d96fb7221ff25954e62218e0cd83ddc/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc9939938d96fb7221ff25954e62218e0cd83ddc/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=fc9939938d96fb7221ff25954e62218e0cd83ddc",
            "patch": "@@ -898,13 +898,6 @@ describe('app-dir action handling', () => {\n         .elementByCss(`[href='/delayed-action/${runtime}/other']`)\n         .click()\n \n-      // wait for url to change\n-      await retry(async () => {\n-        expect(await browser.url()).toBe(\n-          `${next.url}/delayed-action/${runtime}/other`\n-        )\n-      })\n-\n       await browser.waitForElementByCss('#other-page')\n \n       await retry(async () => {"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 1,
        "deletions": 8
    }
}