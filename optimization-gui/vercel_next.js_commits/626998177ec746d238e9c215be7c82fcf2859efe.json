{
    "author": "mischnic",
    "message": "Turbopack: fix exposed modules in scope hoisting (#81073)\n\nCloses PACK-4943\r\nCloses https://github.com/vercel/next.js/issues/80998\r\n\r\nIf we have to split up a merged group because multiple chunks have different execution order, we need to make sure that the references that cross merged groups because of this actually work at runtime (i.e. the referenced modules need to expose themselves in the runtime module registry).\r\n\r\nOpen for ideas on how to optimize this computation. It's the usual question of HashSet vs iterating a list multiple times.\r\n\r\nThe core problem is: we need to expose all modules that appear in `intra_group_references` as values with a key that is in a different list (i.e. key and value musn't both be in `after`, `common`, or `before`)",
    "sha": "626998177ec746d238e9c215be7c82fcf2859efe",
    "files": [
        {
            "sha": "02dd383a4d167c8506c725f7b2d1255bc7bf7de1",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/merged_modules.rs",
            "status": "modified",
            "additions": 47,
            "deletions": 24,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmerged_modules.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmerged_modules.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmerged_modules.rs?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -436,30 +436,53 @@ pub async fn compute_merged_modules(module_graph: Vc<ModuleGraph>) -> Result<Vc<\n                 list.truncate(common_occurrence.entry);\n                 let before_list = &*list;\n \n-                // For all previously merged references that exist from \"after\" to \"common\"/\"before\"\n-                // and from \"common\" to \"before\", mark the referenced modules as exposed.\n-                for m in &common_list {\n-                    let m = ResolvedVc::upcast(*m);\n-                    if let Some(refs) = intra_group_references.get(&m) {\n-                        exposed_modules_imported.extend(\n-                            before_list\n-                                .iter()\n-                                .map(|n| ResolvedVc::upcast(*n))\n-                                .filter(|n| refs.contains(n)),\n-                        );\n-                    }\n-                }\n-                for m in &after_list {\n-                    let m = ResolvedVc::upcast(*m);\n-                    if let Some(refs) = intra_group_references.get(&m) {\n-                        exposed_modules_imported.extend(\n-                            before_list\n-                                .iter()\n-                                .chain(common_list.iter())\n-                                .map(|n| ResolvedVc::upcast(*n))\n-                                .filter(|n| refs.contains(n)),\n-                        );\n-                    }\n+                // For all previously merged references (intra_group_references) that now cross\n+                // \"before\", \"common\" and \"after\", mark the referenced modules as\n+                // exposed.\n+                // Note that due to circular dependencies, there can be\n+                // references that go against execution order (e.g. from \"before\" to\n+                // \"common\").\n+                {\n+                    let before_list =\n+                        FxHashSet::from_iter(before_list.iter().map(|m| ResolvedVc::upcast(*m)));\n+                    let common_list =\n+                        FxHashSet::from_iter(common_list.iter().map(|m| ResolvedVc::upcast(*m)));\n+                    let after_list =\n+                        FxHashSet::from_iter(after_list.iter().map(|m| ResolvedVc::upcast(*m)));\n+\n+                    let references_from_before = before_list\n+                        .iter()\n+                        .filter_map(|m| intra_group_references.get(m))\n+                        .flatten()\n+                        .copied()\n+                        .filter(|m| common_list.contains(m) || after_list.contains(m))\n+                        .collect::<FxHashSet<_>>();\n+                    let references_from_common = common_list\n+                        .iter()\n+                        .filter_map(|m| intra_group_references.get(m))\n+                        .flatten()\n+                        .filter(|m| before_list.contains(m) || after_list.contains(m))\n+                        .collect::<FxHashSet<_>>();\n+                    let references_from_after = after_list\n+                        .iter()\n+                        .filter_map(|m| intra_group_references.get(m))\n+                        .flatten()\n+                        .copied()\n+                        .filter(|m| before_list.contains(m) || common_list.contains(m))\n+                        .collect::<FxHashSet<_>>();\n+\n+                    let modules_to_expose = before_list\n+                        .iter()\n+                        .chain(common_list.iter())\n+                        .chain(after_list.iter())\n+                        .copied()\n+                        .filter(|m| {\n+                            references_from_before.contains(m)\n+                                || references_from_common.contains(m)\n+                                || references_from_after.contains(m)\n+                        });\n+\n+                    exposed_modules_imported.extend(modules_to_expose);\n                 }\n \n                 // The occurences for the \"before\" list (`list`) are still valid, need to update the"
        },
        {
            "sha": "ce04a579285ce15de26ec191f74f557ca517fc3b",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/auth1.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth1.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth1.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth1.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,2 @@\n+import { parseExpression } from './src/parser.js'\n+console.log(parseExpression)"
        },
        {
            "sha": "d8b6cf1ca3c06872966282466ac92a463c8f65b2",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/auth2.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth2.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth2.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fauth2.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,4 @@\n+import { freeze } from './src/utils.js'\n+console.log(freeze)\n+import { parseExpression } from './src/parser.js'\n+console.log(parseExpression)"
        },
        {
            "sha": "7251bba877191c1be750e50ab85c85ab226d848d",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/index.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Findex.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,4 @@\n+it('should work', async () => {\n+  await import('./auth1.js')\n+  await import('./auth2.js')\n+})"
        },
        {
            "sha": "798b83c94e1349e242b42124e7140c5f173e87af",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/src/builder.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fbuilder.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fbuilder.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fbuilder.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,7 @@\n+import { parseSelectAll } from './select.js'\n+console.log(parseSelectAll)\n+\n+import { freeze } from './utils.js'\n+console.log(freeze)\n+\n+export function expressionBuilder() {}"
        },
        {
            "sha": "b9f33f1b350e9101fdd92da5b4e200b6e4536843",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/src/parser.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fparser.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fparser.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fparser.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,4 @@\n+import { expressionBuilder } from './builder.js'\n+console.log(expressionBuilder)\n+\n+export function parseExpression() {}"
        },
        {
            "sha": "81afb6f75b335b1b3baaa7d561d5b716ad7dcd74",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/src/select.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fselect.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fselect.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Fselect.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,4 @@\n+import { expressionBuilder } from './builder.js'\n+console.log(expressionBuilder)\n+\n+export function parseSelectAll() {}"
        },
        {
            "sha": "955d838560ededaede87af85c265a85edc609920",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/input/src/utils.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Futils.js",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Futils.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Finput%2Fsrc%2Futils.js?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1 @@\n+export function freeze() {}"
        },
        {
            "sha": "9437f5a817160555acfa2e28572d12038ba4c143",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/circular-import/options.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/626998177ec746d238e9c215be7c82fcf2859efe/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Fcircular-import%2Foptions.json?ref=626998177ec746d238e9c215be7c82fcf2859efe",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"scopeHoisting\": true\n+}"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 76,
        "deletions": 24
    }
}