{
    "author": "unstubbable",
    "message": "Fix potential race condition with request ID in dev mode (#84532)\n\nIn development mode, the request ID needs to be available before the\nbootstrap script executes and triggers hydration. Previously, the\nrequest ID was set inline with the flight data stream in a script tag\nthat was inserted after the bootstrap script, which could lead to a race\ncondition where `self.__next_r` was accessed before it was defined.\n\nWith this PR, we're moving the request ID initialization to\n`bootstrapScriptContent`, which is inserted as a script tag by React\nimmediately before the bootstrap script. This ensures that the request\nID is always defined when the bootstrap script runs.\n\nI wasn't actually able to reproduce the issue, so I also couldn't add a\ntest for it. But we did receive reports from users that this was\nhappening, which is plausible given the previous script order.",
    "sha": "953b4c513990b4149faa27d687449ee72c68684f",
    "files": [
        {
            "sha": "9b38a848b5bf10456a3361f10851f8f8a4da9897",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/953b4c513990b4149faa27d687449ee72c68684f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/953b4c513990b4149faa27d687449ee72c68684f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=953b4c513990b4149faa27d687449ee72c68684f",
            "patch": "@@ -2206,6 +2206,13 @@ async function renderToStream(\n     page\n   )\n \n+  // In development mode, set the request ID as a global variable, before the\n+  // bootstrap script is executed, which depends on it during hydration.\n+  const bootstrapScriptContent =\n+    process.env.NODE_ENV !== 'production'\n+      ? `self.__next_r=${JSON.stringify(requestId)}`\n+      : undefined\n+\n   const reactServerErrorsByDigest: Map<string, DigestedError> = new Map()\n   const silenceLogger = false\n   function onHTMLRenderRSCError(err: DigestedError) {\n@@ -2377,8 +2384,7 @@ async function renderToStream(\n         const inlinedReactServerDataStream = createInlinedDataReadableStream(\n           reactServerResult.tee(),\n           nonce,\n-          formState,\n-          requestId\n+          formState\n         )\n \n         return chainStreams(\n@@ -2425,8 +2431,7 @@ async function renderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             reactServerResult.consume(),\n             nonce,\n-            formState,\n-            requestId\n+            formState\n           ),\n           getServerInsertedHTML,\n           getServerInsertedMetadata,\n@@ -2459,6 +2464,7 @@ async function renderToStream(\n           })\n         },\n         maxHeadersLength: reactMaxHeadersLength,\n+        bootstrapScriptContent,\n         bootstrapScripts: [bootstrapScript],\n         formState,\n       }\n@@ -2495,8 +2501,7 @@ async function renderToStream(\n       inlinedDataStream: createInlinedDataReadableStream(\n         reactServerResult.consume(),\n         nonce,\n-        formState,\n-        requestId\n+        formState\n       ),\n       isStaticGeneration: generateStaticHTML,\n       isBuildTimePrerendering: ctx.workStore.isBuildTimePrerendering === true,\n@@ -2613,6 +2618,7 @@ async function renderToStream(\n           ),\n           streamOptions: {\n             nonce,\n+            bootstrapScriptContent,\n             // Include hydration scripts in the HTML\n             bootstrapScripts: [errorBootstrapScript],\n             formState,\n@@ -2645,8 +2651,7 @@ async function renderToStream(\n           // render\n           reactServerResult.consume(),\n           nonce,\n-          formState,\n-          requestId\n+          formState\n         ),\n         isStaticGeneration: generateStaticHTML,\n         isBuildTimePrerendering: ctx.workStore.isBuildTimePrerendering === true,\n@@ -3362,7 +3367,6 @@ async function prerenderToStream(\n     nonce,\n     pagePath,\n     renderOpts,\n-    requestId,\n     workStore,\n   } = ctx\n \n@@ -4154,8 +4158,7 @@ async function prerenderToStream(\n             inlinedDataStream: createInlinedDataReadableStream(\n               reactServerResult.consumeAsStream(),\n               nonce,\n-              formState,\n-              requestId\n+              formState\n             ),\n             getServerInsertedHTML,\n             getServerInsertedMetadata,\n@@ -4403,8 +4406,7 @@ async function prerenderToStream(\n             inlinedDataStream: createInlinedDataReadableStream(\n               reactServerResult.consumeAsStream(),\n               nonce,\n-              formState,\n-              requestId\n+              formState\n             ),\n             getServerInsertedHTML,\n             getServerInsertedMetadata,\n@@ -4501,8 +4503,7 @@ async function prerenderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             reactServerResult.consumeAsStream(),\n             nonce,\n-            formState,\n-            requestId\n+            formState\n           ),\n           isStaticGeneration: true,\n           isBuildTimePrerendering:\n@@ -4680,8 +4681,7 @@ async function prerenderToStream(\n           inlinedDataStream: createInlinedDataReadableStream(\n             flightStream,\n             nonce,\n-            formState,\n-            requestId\n+            formState\n           ),\n           isStaticGeneration: true,\n           isBuildTimePrerendering:"
        },
        {
            "sha": "e5f2be0712e3cff11fc2a42a4c6d6095e4a0e3d8",
            "filename": "packages/next/src/server/app-render/use-flight-response.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 15,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/953b4c513990b4149faa27d687449ee72c68684f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/953b4c513990b4149faa27d687449ee72c68684f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx?ref=953b4c513990b4149faa27d687449ee72c68684f",
            "patch": "@@ -103,8 +103,7 @@ export function useFlightStream<T>(\n export function createInlinedDataReadableStream(\n   flightStream: ReadableStream<Uint8Array>,\n   nonce: string | undefined,\n-  formState: unknown | null,\n-  requestId: string\n+  formState: unknown | null\n ): ReadableStream<Uint8Array> {\n   const startScriptTag = nonce\n     ? `<script nonce=${JSON.stringify(nonce)}>`\n@@ -117,12 +116,7 @@ export function createInlinedDataReadableStream(\n     type: 'bytes',\n     start(controller) {\n       try {\n-        writeInitialInstructions(\n-          controller,\n-          startScriptTag,\n-          formState,\n-          requestId\n-        )\n+        writeInitialInstructions(controller, startScriptTag, formState)\n       } catch (error) {\n         // during encoding or enqueueing forward the error downstream\n         controller.error(error)\n@@ -166,18 +160,12 @@ export function createInlinedDataReadableStream(\n function writeInitialInstructions(\n   controller: ReadableStreamDefaultController,\n   scriptStart: string,\n-  formState: unknown | null,\n-  requestId: string\n+  formState: unknown | null\n ) {\n   let scriptContents = `(self.__next_f=self.__next_f||[]).push(${htmlEscapeJsonString(\n     JSON.stringify([INLINE_FLIGHT_PAYLOAD_BOOTSTRAP])\n   )})`\n \n-  if (process.env.NODE_ENV !== 'production') {\n-    // The request ID is only needed in development mode.\n-    scriptContents = `self.__next_r=${JSON.stringify(requestId)};${scriptContents}`\n-  }\n-\n   if (formState != null) {\n     scriptContents += `;self.__next_f.push(${htmlEscapeJsonString(\n       JSON.stringify([INLINE_FLIGHT_PAYLOAD_FORM_STATE, formState])"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 20,
        "deletions": 32
    }
}