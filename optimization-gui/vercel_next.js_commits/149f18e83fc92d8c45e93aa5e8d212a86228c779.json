{
    "author": "ztanner",
    "message": "enable experimental.routerBfCache behind cacheComponents (#84923)\n\nThis removes the `routerBfCache` and enables it automatically when\n`cacheComponents` is enabled. This leverages `React.Activity` on layout\nsegments to support restoring previously visited UI segments while\npreserving state.",
    "sha": "149f18e83fc92d8c45e93aa5e8d212a86228c779",
    "files": [
        {
            "sha": "e9219506ec863a4e425a44da86b8f33726b353fa",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -856,8 +856,6 @@ pub struct ExperimentalConfig {\n     /// directory.\n     ppr: Option<ExperimentalPartialPrerendering>,\n     taint: Option<bool>,\n-    #[serde(rename = \"routerBFCache\")]\n-    router_bfcache: Option<bool>,\n     proxy_timeout: Option<f64>,\n     /// enables the minification of server code.\n     server_minification: Option<bool>,"
        },
        {
            "sha": "3b6bdc555ea809f88a714ed431a69e087182298f",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -205,9 +205,6 @@ export function getDefineEnv({\n     'process.env.__NEXT_DYNAMIC_ON_HOVER': Boolean(\n       config.experimental.dynamicOnHover\n     ),\n-    'process.env.__NEXT_ROUTER_BF_CACHE': Boolean(\n-      config.experimental.routerBFCache\n-    ),\n     'process.env.__NEXT_OPTIMISTIC_CLIENT_CACHE':\n       config.experimental.optimisticClientCache ?? true,\n     'process.env.__NEXT_MIDDLEWARE_PREFETCH':"
        },
        {
            "sha": "97acb4e0ada63702b1711e9d44a4db106a0dc5a2",
            "filename": "packages/next/src/client/components/bfcache.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbfcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbfcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbfcache.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -2,7 +2,7 @@ import type { FlightRouterState } from '../../shared/lib/app-router-types'\n import { useState } from 'react'\n \n // When the flag is disabled, only track the currently active tree\n-const MAX_BF_CACHE_ENTRIES = process.env.__NEXT_ROUTER_BF_CACHE ? 3 : 1\n+const MAX_BF_CACHE_ENTRIES = process.env.__NEXT_CACHE_COMPONENTS ? 3 : 1\n \n export type RouterBFCacheEntry = {\n   tree: FlightRouterState"
        },
        {
            "sha": "188a9994746bfcb87652e6da9189eb985338976b",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -757,7 +757,7 @@ export default function OuterLayoutRouter({\n       )\n     }\n \n-    if (process.env.__NEXT_ROUTER_BF_CACHE) {\n+    if (process.env.__NEXT_CACHE_COMPONENTS) {\n       const boundaryName = getBoundaryNameForSuspenseDevTools(tree)\n       child = (\n         <Activity"
        },
        {
            "sha": "4084a49cd35f37fe51af4bebfc484dc07ad380f0",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -423,6 +423,11 @@ export function serverActionReducer(\n             redirectType || RedirectType.push\n           )\n         )\n+\n+        // TODO: Investigate why this is needed with Activity.\n+        if (process.env.__NEXT_CACHE_COMPONENTS) {\n+          return state\n+        }\n       } else {\n         resolve(actionResult)\n       }"
        },
        {
            "sha": "27df1e14a490111292922d9cde9b580c6efa0396",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -249,7 +249,6 @@ export const experimentalSchema = {\n   rootParams: z.boolean().optional(),\n   isolatedDevBuild: z.boolean().optional(),\n   mcpServer: z.boolean().optional(),\n-  routerBFCache: z.boolean().optional(),\n   removeUncaughtErrorAndRejectionListeners: z.boolean().optional(),\n   validateRSCRequestHeaders: z.boolean().optional(),\n   scrollRestoration: z.boolean().optional(),"
        },
        {
            "sha": "95bf23fbfcd73f1d223267a57d652a297c8a3642",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -591,11 +591,6 @@ export interface ExperimentalConfig {\n    */\n   taint?: boolean\n \n-  /**\n-   * Enables the Back/Forward Cache for the router.\n-   */\n-  routerBFCache?: boolean\n-\n   /**\n    * Uninstalls all \"unhandledRejection\" and \"uncaughtException\" listeners from\n    * the global process so that we can override the behavior, which in some\n@@ -1517,7 +1512,6 @@ export const defaultConfig = Object.freeze({\n     webpackMemoryOptimizations: false,\n     optimizeServerReact: true,\n     viewTransition: false,\n-    routerBFCache: false,\n     removeUncaughtErrorAndRejectionListeners: false,\n     validateRSCRequestHeaders: !!(\n       process.env.__NEXT_TEST_MODE || !isStableBuild()"
        },
        {
            "sha": "f95749d56d60c785be6f66f5c1ec9f0cbda5932a",
            "filename": "test/e2e/app-dir/app-basepath/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -140,7 +140,8 @@ describe('app dir - basepath', () => {\n       // This verifies the redirect & server response happens in a single roundtrip,\n       // if the redirect resource was static. In development, these responses are always\n       // dynamically generated, so we only expect a single request for build/deploy.\n-      if (!isNextDev) {\n+      // TODO(client-segment-cache): re-enable when this optimization is added back\n+      if (!isNextDev && !process.env.__NEXT_CACHE_COMPONENTS) {\n         expect(requests).toHaveLength(1)\n         expect(responses).toHaveLength(1)\n       }"
        },
        {
            "sha": "3000765cf3f6dbd5476ae9b76b3078fd49690301",
            "filename": "test/e2e/app-dir/back-forward-cache/app/page/[n]/page.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage%2F%5Bn%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage%2F%5Bn%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage%2F%5Bn%5D%2Fpage.tsx?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -18,3 +18,7 @@ export default async function Page({\n     </>\n   )\n }\n+\n+export function generateStaticParams() {\n+  return [{ n: '1' }, { n: '2' }]\n+}"
        },
        {
            "sha": "e64bae22d658030ef118a8b53c925258ae17563f",
            "filename": "test/e2e/app-dir/back-forward-cache/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -2,9 +2,7 @@\n  * @type {import('next').NextConfig}\n  */\n const nextConfig = {\n-  experimental: {\n-    routerBFCache: true,\n-  },\n+  cacheComponents: true,\n }\n \n module.exports = nextConfig"
        },
        {
            "sha": "0068bab395bfb1488c7069c10c57e463b1e8c255",
            "filename": "test/e2e/app-dir/parallel-routes-css/parallel-routes-css.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fparallel-routes-css%2Fparallel-routes-css.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fparallel-routes-css%2Fparallel-routes-css.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-css%2Fparallel-routes-css.test.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -34,8 +34,11 @@ describe('parallel-routes-catchall-css', () => {\n     // the slot's background color should be red\n     expect(await getSlotBackgroundColor(browser)).toBe('rgb(255, 0, 0)')\n \n-    // there should no longer be a main element\n-    expect(await browser.hasElementByCssSelector('#main')).toBeFalsy()\n+    // the main element should either not exist or not be visible\n+    const mainDisplay = await browser.eval(\n+      `document.querySelector('#main') ? window.getComputedStyle(document.querySelector('#main')).display : null`\n+    )\n+    expect(mainDisplay === null || mainDisplay === 'none').toBe(true)\n \n     // the slot background should still be red on a fresh load\n     await browser.refresh()"
        },
        {
            "sha": "f442e59a3ff3d8acb35121eca23040efe77be512",
            "filename": "test/e2e/app-dir/resuming-head-runtime-search-param/app/layout.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -5,7 +5,9 @@ export default function RootLayout({\n }) {\n   return (\n     <html lang=\"en\">\n-      <body>{children}</body>\n+      <body>\n+        <div>{children}</div>\n+      </body>\n     </html>\n   )\n }"
        },
        {
            "sha": "1dd27118ff885e76525d060870558718cf174c94",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/prefetch-runtime.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 41,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { waitFor } from 'next-test-utils'\n import type * as Playwright from 'playwright'\n import { createRouterAct } from 'router-act'\n \n@@ -116,14 +117,6 @@ describe('runtime prefetching', () => {\n \n       await browser.back()\n \n-      // Reveal the link to the second page again. It should not be prefetched again\n-      await act(async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/${prefix}/dynamic-params/456\"]`\n-        )\n-        await linkToggle.click()\n-      }, 'no-requests')\n-\n       // Navigate to the other page\n       await act(async () => {\n         await act(\n@@ -233,14 +226,6 @@ describe('runtime prefetching', () => {\n       if (!isNextDeploy) {\n         await browser.back()\n \n-        // Reveal the link to the second page again. It should not be prefetched again\n-        await act(async () => {\n-          const linkToggle = await browser.elementByCss(\n-            `input[data-link-accordion=\"/with-root-param/de/${prefix}/root-params\"]`\n-          )\n-          await linkToggle.click()\n-        }, 'no-requests')\n-\n         // Navigate to the other page\n         await act(async () => {\n           await act(\n@@ -348,14 +333,6 @@ describe('runtime prefetching', () => {\n \n       await browser.back()\n \n-      // Reveal the link to the second page again. It should not be prefetched again\n-      await act(async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/${prefix}/search-params?searchParam=456\"]`\n-        )\n-        await linkToggle.click()\n-      }, 'no-requests')\n-\n       // Navigate to the other page\n       await act(\n         async () => {\n@@ -495,23 +472,8 @@ describe('runtime prefetching', () => {\n       // Go back to the previous page\n       await browser.back()\n \n-      // Reveal the link again to trigger a runtime prefetch for the new value of the cookie\n-      await act(async () => {\n-        const linkToggle = await browser.elementByCss(\n-          `input[data-link-accordion=\"/${prefix}/cookies\"]`\n-        )\n-        await linkToggle.click()\n-      }, [\n-        // Should allow reading dynamic params\n-        {\n-          includes: 'Cookie: updatedValue',\n-        },\n-        // Should not prefetch the dynamic content\n-        {\n-          includes: 'Dynamic content',\n-          block: 'reject',\n-        },\n-      ])\n+      // wait a tick before navigating\n+      await waitFor(500)\n \n       // Navigate to the page\n       await act(async () => {"
        },
        {
            "sha": "7106a3cff93d2a3f8601873ba4e68a45a618b005",
            "filename": "test/e2e/app-dir/segment-cache/staleness/segment-cache-stale-time.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/149f18e83fc92d8c45e93aa5e8d212a86228c779/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts?ref=149f18e83fc92d8c45e93aa5e8d212a86228c779",
            "patch": "@@ -187,10 +187,6 @@ describe('segment cache (staleness)', () => {\n     await page.clock.setFixedTime(startDate + 29 * 1000)\n \n     await act(async () => {\n-      const toggle = await browser.elementByCss(\n-        'input[data-link-accordion=\"/dynamic\"]'\n-      )\n-      await toggle.click()\n       const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n       await link.click()\n       // The next page is immediately rendered\n@@ -207,10 +203,6 @@ describe('segment cache (staleness)', () => {\n \n     await act(\n       async () => {\n-        const toggle = await browser.elementByCss(\n-          'input[data-link-accordion=\"/dynamic\"]'\n-        )\n-        await toggle.click()\n         const link = await browser.elementByCss('a[href=\"/dynamic\"]')\n         await link.click()\n       },"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 25,
        "deletions": 70
    }
}