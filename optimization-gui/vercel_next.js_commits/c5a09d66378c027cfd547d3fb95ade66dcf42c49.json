{
    "author": "eps1lon",
    "message": "Add `toDisplayRedbox` and `toDisplayCollapsedRedbox ` snapshot matcher (#73621)",
    "sha": "c5a09d66378c027cfd547d3fb95ade66dcf42c49",
    "files": [
        {
            "sha": "7067b199e40ff705ccc053f41caba226cb7b12dd",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -162,6 +162,7 @@\n     \"eslint-v8\": \"npm:eslint@^8.57.0\",\n     \"event-stream\": \"4.0.1\",\n     \"execa\": \"2.0.3\",\n+    \"expect\": \"29.7.0\",\n     \"expect-type\": \"0.14.2\",\n     \"express\": \"4.17.0\",\n     \"faker\": \"5.5.3\",\n@@ -185,6 +186,7 @@\n     \"jest-environment-jsdom\": \"29.7.0\",\n     \"jest-extended\": \"4.0.2\",\n     \"jest-junit\": \"16.0.0\",\n+    \"jest-snapshot\": \"30.0.0-alpha.6\",\n     \"json5\": \"2.2.3\",\n     \"kleur\": \"^4.1.0\",\n     \"ky\": \"0.19.1\","
        },
        {
            "sha": "02aa1e44e235a512ab7edd571d09820a1a949853",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -303,6 +303,9 @@ importers:\n       execa:\n         specifier: 2.0.3\n         version: 2.0.3\n+      expect:\n+        specifier: 29.7.0\n+        version: 29.7.0\n       expect-type:\n         specifier: 0.14.2\n         version: 0.14.2\n@@ -372,6 +375,9 @@ importers:\n       jest-junit:\n         specifier: 16.0.0\n         version: 16.0.0\n+      jest-snapshot:\n+        specifier: 30.0.0-alpha.6\n+        version: 30.0.0-alpha.6\n       json5:\n         specifier: 2.2.3\n         version: 2.2.3\n@@ -21925,7 +21931,7 @@ snapshots:\n \n   '@types/jest@29.5.5':\n     dependencies:\n-      expect: 29.5.0\n+      expect: 29.7.0\n       pretty-format: 29.5.0\n \n   '@types/jscodeshift@0.11.0':"
        },
        {
            "sha": "0a26e963d0beee1827b55fcf98bf523b38e3b40c",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 23,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -10,7 +10,8 @@ import {\n import path from 'path'\n import { outdent } from 'outdent'\n \n-describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', () => {\n+describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n+  const isTurbopack = mode === 'turbo'\n   const { next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n@@ -789,23 +790,40 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', () => {\n         ],\n       ])\n     )\n-\n-    const { session, browser } = sandbox\n-\n-    await session.assertHasRedbox()\n-\n-    const stack = await getStackFramesContent(browser)\n-    if (process.env.TURBOPACK) {\n-      expect(stack).toMatchInlineSnapshot(`\n-       \"at <unknown> (pages/index.js (3:11))\n-       at Array.map ()\n-       at Page (pages/index.js (2:13))\"\n+    const { browser } = sandbox\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: anonymous error!\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"pages/index.js (3:11) @ <unknown>\n+       > 3 |     throw new Error(\"anonymous error!\");\n+           |           ^\",\n+         \"stack\": [\n+           \"<unknown> pages/index.js (3:11)\",\n+           \"Array.map <anonymous> (0:0)\",\n+           \"Page pages/index.js (2:13)\",\n+         ],\n+       }\n       `)\n     } else {\n-      expect(stack).toMatchInlineSnapshot(`\n-       \"at eval (pages/index.js (3:11))\n-       at Array.map ()\n-       at Page (pages/index.js (2:13))\"\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: anonymous error!\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"pages/index.js (3:11) @ eval\n+       > 3 |     throw new Error(\"anonymous error!\");\n+           |           ^\",\n+         \"stack\": [\n+           \"eval pages/index.js (3:11)\",\n+           \"Array.map <anonymous> (0:0)\",\n+           \"Page pages/index.js (2:13)\",\n+         ],\n+       }\n       `)\n     }\n   })\n@@ -831,13 +849,22 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', () => {\n       ])\n     )\n \n-    const { session, browser } = sandbox\n-    await session.assertHasRedbox()\n-\n-    const stack = await getStackFramesContent(browser)\n-    expect(stack).toMatchInlineSnapshot(`\n-     \"at createURL (pages/index.js (4:3))\n-     at getServerSideProps (pages/index.js (8:3))\"\n+    const { browser } = sandbox\n+\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"TypeError: Invalid URL\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"pages/index.js (4:3) @ createURL\n+     > 4 |   new URL(\"/\", \"invalid\")\n+         |   ^\",\n+       \"stack\": [\n+         \"createURL pages/index.js (4:3)\",\n+         \"getServerSideProps pages/index.js (8:3)\",\n+       ],\n+     }\n     `)\n \n     await toggleCollapseCallStackFrames(browser)"
        },
        {
            "sha": "f69ce386c2a31f92eb76cf2e52a42aeb9b3887c3",
            "filename": "test/development/app-dir/capture-console-error-owner-stack/capture-console-error-owner-stack.test.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 146,
            "changes": 213,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Fapp-dir%2Fcapture-console-error-owner-stack%2Fcapture-console-error-owner-stack.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Fapp-dir%2Fcapture-console-error-owner-stack%2Fcapture-console-error-owner-stack.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fcapture-console-error-owner-stack%2Fcapture-console-error-owner-stack.test.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -1,33 +1,8 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  getRedboxCallStack,\n-  getRedboxDescription,\n-  getRedboxTitle,\n-  getRedboxSource,\n-  getRedboxTotalErrorCount,\n-  openRedbox,\n-  hasRedboxCallStack,\n-  assertNoRedbox,\n-  assertNoConsoleErrors,\n-} from 'next-test-utils'\n-\n-async function getRedboxResult(browser: any) {\n-  const title = await getRedboxTitle(browser)\n-  const description = await getRedboxDescription(browser)\n-  const callStacks = (await hasRedboxCallStack(browser))\n-    ? await getRedboxCallStack(browser)\n-    : ''\n-  const count = await getRedboxTotalErrorCount(browser)\n-  const source = await getRedboxSource(browser)\n-  const result = {\n-    title,\n-    count,\n-    source,\n-    description,\n-    callStacks,\n-  }\n-  return result\n-}\n+import { assertNoRedbox, assertNoConsoleErrors } from 'next-test-utils'\n+\n+const isNewOverlay = process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY !== 'false'\n+\n describe('app-dir - capture-console-error-owner-stack', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n@@ -37,189 +12,135 @@ describe('app-dir - capture-console-error-owner-stack', () => {\n     const browser = await next.browser('/browser/event')\n     await browser.elementByCss('button').click()\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-\n-    expect(result).toMatchInlineSnapshot(`\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n-       \"callStacks\": \"onClick\n-     app/browser/event/page.js (7:17)\n-     button\n-     <anonymous> (0:0)\n-     Page\n-     app/browser/event/page.js (5:5)\",\n        \"count\": 1,\n        \"description\": \"trigger an console <error>\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n        \"source\": \"app/browser/event/page.js (7:17) @ onClick\n-\n-        5 |     <button\n-        6 |       onClick={() => {\n      >  7 |         console.error('trigger an console <%s>', 'error')\n-          |                 ^\n-        8 |       }}\n-        9 |     >\n-       10 |       click to error\",\n-       \"title\": \"Console Error\",\n+          |                 ^\",\n+       \"stack\": [\n+         \"onClick app/browser/event/page.js (7:17)\",\n+         \"button <anonymous> (0:0)\",\n+         \"Page app/browser/event/page.js (5:5)\",\n+       ],\n      }\n     `)\n   })\n \n   it('should capture browser console error in render and dedupe if necessary', async () => {\n     const browser = await next.browser('/browser/render')\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-    expect(result).toMatchInlineSnapshot(`\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n-       \"callStacks\": \"Page\n-     app/browser/render/page.js (4:11)\",\n        \"count\": 1,\n        \"description\": \"trigger an console.error in render\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n        \"source\": \"app/browser/render/page.js (4:11) @ Page\n-\n-       2 |\n-       3 | export default function Page() {\n      > 4 |   console.error('trigger an console.error in render')\n-         |           ^\n-       5 |   return <p>render</p>\n-       6 | }\n-       7 |\",\n-       \"title\": \"Console Error\",\n+         |           ^\",\n+       \"stack\": [\n+         \"Page app/browser/render/page.js (4:11)\",\n+       ],\n      }\n     `)\n   })\n \n   it('should capture browser console error in render and dedupe when multi same errors logged', async () => {\n     const browser = await next.browser('/browser/render')\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-    expect(result).toMatchInlineSnapshot(`\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n-       \"callStacks\": \"Page\n-     app/browser/render/page.js (4:11)\",\n        \"count\": 1,\n        \"description\": \"trigger an console.error in render\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n        \"source\": \"app/browser/render/page.js (4:11) @ Page\n-\n-       2 |\n-       3 | export default function Page() {\n      > 4 |   console.error('trigger an console.error in render')\n-         |           ^\n-       5 |   return <p>render</p>\n-       6 | }\n-       7 |\",\n-       \"title\": \"Console Error\",\n+         |           ^\",\n+       \"stack\": [\n+         \"Page app/browser/render/page.js (4:11)\",\n+       ],\n      }\n     `)\n   })\n \n   it('should capture server replay string error from console error', async () => {\n     const browser = await next.browser('/ssr')\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-    expect(result).toMatchInlineSnapshot(`\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n-       \"callStacks\": \"Page\n-     app/ssr/page.js (4:11)\",\n        \"count\": 1,\n        \"description\": \"ssr console error:client\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n        \"source\": \"app/ssr/page.js (4:11) @ Page\n-\n-       2 |\n-       3 | export default function Page() {\n      > 4 |   console.error(\n-         |           ^\n-       5 |     'ssr console error:' + (typeof window === 'undefined' ? 'server' : 'client')\n-       6 |   )\n-       7 |   return <p>ssr</p>\",\n-       \"title\": \"Console Error\",\n+         |           ^\",\n+       \"stack\": [\n+         \"Page app/ssr/page.js (4:11)\",\n+       ],\n      }\n     `)\n   })\n \n   it('should capture server replay error instance from console error', async () => {\n     const browser = await next.browser('/ssr-error-instance')\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-\n-    expect(result).toMatchInlineSnapshot(`\n+    await expect(browser).toDisplayCollapsedRedbox(`\n      {\n-       \"callStacks\": \"Page\n-     app/ssr-error-instance/page.js (4:17)\",\n        \"count\": 1,\n        \"description\": \"Error: page error\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n        \"source\": \"app/ssr-error-instance/page.js (4:17) @ Page\n-\n-       2 |\n-       3 | export default function Page() {\n      > 4 |   console.error(new Error('page error'))\n-         |                 ^\n-       5 |   return <p>ssr</p>\n-       6 | }\n-       7 |\",\n-       \"title\": \"Console Error\",\n+         |                 ^\",\n+       \"stack\": [\n+         \"Page app/ssr-error-instance/page.js (4:17)\",\n+       ],\n      }\n     `)\n   })\n \n   it('should be able to capture rsc logged error', async () => {\n     const browser = await next.browser('/rsc')\n \n-    await openRedbox(browser)\n-\n-    const result = await getRedboxResult(browser)\n-\n-    if (process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY === 'true') {\n-      expect(result).toMatchInlineSnapshot(`\n-         {\n-           \"callStacks\": \"Page\n-         app/rsc/page.js (2:17)\n-         JSON.parse\n-         <anonymous> (0:0)\n-         Page\n-         <anonymous> (0:0)\",\n-           \"count\": 1,\n-           \"description\": \"Error: boom\",\n-           \"source\": \"app/rsc/page.js (2:17) @ Page\n-\n-           1 | export default function Page() {\n-         > 2 |   console.error(new Error('boom'))\n-             |                 ^\n-           3 |   return <p>rsc</p>\n-           4 | }\n-           5 |\",\n-           \"title\": \"Console Error\n-         Server\",\n-         }\n-        `)\n+    if (isNewOverlay) {\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: boom\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/rsc/page.js (2:17) @ Page\n+       > 2 |   console.error(new Error('boom'))\n+           |                 ^\",\n+         \"stack\": [\n+           \"Page app/rsc/page.js (2:17)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"Page <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     } else {\n-      expect(result).toMatchInlineSnapshot(`\n+      await expect(browser).toDisplayCollapsedRedbox(`\n        {\n-         \"callStacks\": \"Page\n-       app/rsc/page.js (2:17)\n-       JSON.parse\n-       <anonymous> (0:0)\n-       Page\n-       <anonymous> (0:0)\",\n          \"count\": 1,\n          \"description\": \"[ Server ] Error: boom\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n          \"source\": \"app/rsc/page.js (2:17) @ Page\n-\n-         1 | export default function Page() {\n        > 2 |   console.error(new Error('boom'))\n-           |                 ^\n-         3 |   return <p>rsc</p>\n-         4 | }\n-         5 |\",\n-         \"title\": \"Console Error\",\n+           |                 ^\",\n+         \"stack\": [\n+           \"Page app/rsc/page.js (2:17)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"Page <anonymous> (0:0)\",\n+         ],\n        }\n       `)\n     }"
        },
        {
            "sha": "c649ae1069048bfb41470f8b56b9f515d3e0cf05",
            "filename": "test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts",
            "status": "modified",
            "additions": 158,
            "deletions": 59,
            "changes": 217,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -1,16 +1,6 @@\n import stripAnsi from 'strip-ansi'\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  getRedboxCallStack,\n-  getRedboxDescription,\n-  hasErrorToast,\n-  retry,\n-  openRedbox,\n-  getRedboxSource,\n-  toggleCollapseCallStackFrames,\n-} from 'next-test-utils'\n+import { assertNoRedbox, hasErrorToast, retry } from 'next-test-utils'\n import { createSandbox } from 'development-sandbox'\n import { outdent } from 'outdent'\n \n@@ -20,21 +10,45 @@ describe('Dynamic IO Dev Errors', () => {\n   })\n \n   const isNewOverlay =\n-    process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY === 'true'\n+    process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY !== 'false'\n \n   it('should show a red box error on the SSR render', async () => {\n     const browser = await next.browser('/error')\n \n-    await openRedbox(browser)\n-\n     if (isNewOverlay) {\n-      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-        `\"Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/error/page.tsx (2:23) @ Page\n+       > 2 |   const random = Math.random()\n+           |                       ^\",\n+         \"stack\": [\n+           \"Page app/error/page.tsx (2:23)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     } else {\n-      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-        `\"[ Server ] Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"[ Server ] Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/error/page.tsx (2:23) @ Page\n+       > 2 |   const random = Math.random()\n+           |                       ^\",\n+         \"stack\": [\n+           \"Page app/error/page.tsx (2:23)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     }\n   })\n \n@@ -47,15 +61,40 @@ describe('Dynamic IO Dev Errors', () => {\n \n     await browser.elementByCss(\"[href='/error']\").click()\n \n-    await openRedbox(browser)\n     if (isNewOverlay) {\n-      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-        `\"Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/error/page.tsx (2:23) @ Page\n+       > 2 |   const random = Math.random()\n+           |                       ^\",\n+         \"stack\": [\n+           \"Page app/error/page.tsx (2:23)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     } else {\n-      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-        `\"[ Server ] Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"[ Server ] Error: Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/error/page.tsx (2:23) @ Page\n+       > 2 |   const random = Math.random()\n+           |                       ^\",\n+         \"stack\": [\n+           \"Page app/error/page.tsx (2:23)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     }\n   })\n \n@@ -65,7 +104,7 @@ describe('Dynamic IO Dev Errors', () => {\n     expect(res.status).toBe(500)\n \n     await retry(() => {\n-      const cliOutput = next.cliOutput.slice(cliOutputLength)\n+      const cliOutput = stripAnsi(next.cliOutput.slice(cliOutputLength))\n       expect(cliOutput).toContain('GET /top-level-error 500')\n     })\n \n@@ -79,7 +118,11 @@ describe('Dynamic IO Dev Errors', () => {\n     const outputIndex = next.cliOutput.length\n     const browser = await next.browser('/no-accessed-data')\n \n-    await openRedbox(browser)\n+    await retry(() => {\n+      expect(next.cliOutput.slice(outputIndex)).toContain(\n+        'Error: Route \"/no-accessed-data\"'\n+      )\n+    })\n \n     expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n       `\\nError: Route \"/no-accessed-data\": ` +\n@@ -98,27 +141,45 @@ describe('Dynamic IO Dev Errors', () => {\n             '\\n    at InnerLayoutRouter (..')\n     )\n \n-    const description = await getRedboxDescription(browser)\n-\n     if (isNewOverlay) {\n-      expect(description).toMatchInlineSnapshot(\n-        `\"Error: Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Console Error\",\n+         \"source\": undefined,\n+         \"stack\": [\n+           \"Page [Server] <anonymous> (2:1)\",\n+           \"main <anonymous> (2:1)\",\n+           \"body <anonymous> (2:1)\",\n+           \"html <anonymous> (2:1)\",\n+           \"Root [Server] <anonymous> (2:1)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     } else {\n-      expect(description).toMatchInlineSnapshot(\n-        `\"[ Server ] Error: Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\"`\n-      )\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"[ Server ] Error: Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": undefined,\n+         \"stack\": [\n+           \"Page [Server] <anonymous> (2:1)\",\n+           \"main <anonymous> (2:1)\",\n+           \"body <anonymous> (2:1)\",\n+           \"html <anonymous> (2:1)\",\n+           \"Root [Server] <anonymous> (2:1)\",\n+           \"JSON.parse <anonymous> (0:0)\",\n+           \"<unknown> <anonymous> (0:0)\",\n+         ],\n+       }\n+      `)\n     }\n-\n-    // Expand the stack frames, since the first frame `Page [Server] <anonymous>` is treated as ignored.\n-    // TODO: Remove the filter of anonymous frames when we have a better way to handle them.\n-    await toggleCollapseCallStackFrames(browser)\n-    const stack = await getRedboxCallStack(browser)\n-    // TODO: use snapshot testing for stack\n-    // FIXME: avoid `next` code to be mapped to source code and filter them out even when sourcemap is enabled.\n-    expect(stack).toContain('Page [Server]')\n-    expect(stack).toContain('Root [Server]')\n-    expect(stack).toContain('<anonymous> (2:1)')\n   })\n \n   it('should clear segment errors after correcting them', async () => {\n@@ -139,17 +200,57 @@ describe('Dynamic IO Dev Errors', () => {\n       ])\n     )\n     const { browser, session } = sandbox\n-    await assertHasRedbox(browser)\n-    const redbox = {\n-      description: await getRedboxDescription(browser),\n-      source: await getRedboxSource(browser),\n+    if (isTurbopack) {\n+      if (isNewOverlay) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Failed to compile\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./app/page.tsx (1:14)\n+         Ecmascript file had an error\n+         > 1 | export const revalidate = 10\n+             |              ^^^^^^^^^^\",\n+           \"stack\": [],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Failed to compile\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./app/page.tsx:1:14\n+         Ecmascript file had an error\n+         > 1 | export const revalidate = 10\n+             |              ^^^^^^^^^^\",\n+           \"stack\": [],\n+         }\n+        `)\n+      }\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Failed to compile\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.tsx\n+       Error:   x Route segment config \"revalidate\" is not compatible with \\`nextConfig.experimental.dynamicIO\\`. Please remove it.\n+          ,-[1:1]\n+        1 | export const revalidate = 10\n+          :              ^^^^^^^^^^\n+        2 | export default function Page() {\n+        3 |   return (\n+        4 |     <div>Hello World</div>\n+          \\`----\",\n+         \"stack\": [],\n+       }\n+      `)\n     }\n \n-    expect(redbox.description).toMatchInlineSnapshot(`\"Failed to compile\"`)\n-    expect(redbox.source).toContain(\n-      '\"revalidate\" is not compatible with `nextConfig.experimental.dynamicIO`. Please remove it.'\n-    )\n-\n     await session.patch(\n       'app/page.tsx',\n       outdent`\n@@ -161,8 +262,6 @@ describe('Dynamic IO Dev Errors', () => {\n     `\n     )\n \n-    await retry(async () => {\n-      assertNoRedbox(browser)\n-    })\n+    await assertNoRedbox(browser)\n   })\n })"
        },
        {
            "sha": "36fa9762606462aa62ff8c1861af5dc8f0851c29",
            "filename": "test/e2e/app-dir/non-root-project-monorepo/non-root-project-monorepo.test.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 69,
            "changes": 108,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -82,11 +82,15 @@ describe('non-root-project-monorepo', () => {\n \n   if (isNextDev) {\n     describe('source-maps', () => {\n-      function normalizeStackTrace(stack: string): string {\n+      function normalizeStackTrace(stack: string[] | null): string | null {\n+        if (stack === null) {\n+          return null\n+        }\n         const isolatedPath = /file:\\/\\/.*\\/next-install-[^/]+\\//g\n         const nonIsolatedPath =\n           /file:\\/\\/.*\\/test\\/e2e\\/app-dir\\/non-root-project-monorepo\\//g\n         return stack\n+          .join('\\n')\n           .replaceAll(nonIsolatedPath, 'file://<full-path>/')\n           .replaceAll(isolatedPath, 'file://<full-path>/')\n       }\n@@ -111,14 +115,10 @@ describe('non-root-project-monorepo', () => {\n               '/apps_web_XXXXXX._.js '\n             )\n           ).toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-rsc] (ecmascript)\n-           app/separate-file.ts (1:7)\n-           innerArrowFunction\n-           app/source-maps-rsc/page.tsx (13:28)\n-           innerFunction\n-           app/source-maps-rsc/page.tsx (10:3)\n-           Page\n-           app/source-maps-rsc/page.tsx (4:5)\"\n+           \"[project]/apps/web/app/separate-file.ts [app-rsc] (ecmascript) app/separate-file.ts (1:7)\n+           innerArrowFunction app/source-maps-rsc/page.tsx (13:28)\n+           innerFunction app/source-maps-rsc/page.tsx (10:3)\n+           Page app/source-maps-rsc/page.tsx (4:5)\"\n           `)\n         } else {\n           // TODO the function name is incorrect\n@@ -133,18 +133,12 @@ describe('non-root-project-monorepo', () => {\n           // TODO(veil): https://linear.app/vercel/issue/NDX-677\n           expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n             .toMatchInlineSnapshot(`\n-           \"eval\n-           app/separate-file.ts (1:11)\n-           <unknown>\n-           rsc)/./app/separate-file.ts (rsc://React/Server/file://<full-path>/apps/web/.next/server/app/source-maps-rsc/page.js?3 (63:1)\n-           __webpack_require__\n-           rsc:/Server/file://<full-path>/apps/web/.next/server/webpack-runtime.js (33:42)\n-           innerArrowFunction\n-           app/source-maps-rsc/page.tsx (14:3)\n-           innerFunction\n-           app/source-maps-rsc/page.tsx (10:3)\n-           Page\n-           app/source-maps-rsc/page.tsx (4:5)\"\n+           \"eval app/separate-file.ts (1:11)\n+           <unknown> rsc)/./app/separate-file.ts (rsc://React/Server/file://<full-path>/apps/web/.next/server/app/source-maps-rsc/page.js?3 (63:1)\n+           __webpack_require__ rsc:/Server/file://<full-path>/apps/web/.next/server/webpack-runtime.js (33:42)\n+           innerArrowFunction app/source-maps-rsc/page.tsx (14:3)\n+           innerFunction app/source-maps-rsc/page.tsx (10:3)\n+           Page app/source-maps-rsc/page.tsx (4:5)\"\n           `)\n         }\n         await browser.close()\n@@ -165,14 +159,10 @@ describe('non-root-project-monorepo', () => {\n           `)\n           expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n             .toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript)\n-           app/separate-file.ts (1:7)\n-           innerArrowFunction\n-           app/source-maps-ssr/page.tsx (15:28)\n-           innerFunction\n-           app/source-maps-ssr/page.tsx (12:3)\n-           Page\n-           app/source-maps-ssr/page.tsx (6:5)\"\n+           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\n+           innerArrowFunction app/source-maps-ssr/page.tsx (15:28)\n+           innerFunction app/source-maps-ssr/page.tsx (12:3)\n+           Page app/source-maps-ssr/page.tsx (6:5)\"\n           `)\n         } else {\n           // TODO the function name should be hidden\n@@ -186,22 +176,14 @@ describe('non-root-project-monorepo', () => {\n           // TODO webpack runtime code shouldn't be included in stack trace\n           expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n             .toMatchInlineSnapshot(`\n-           \"eval\n-           app/separate-file.ts (1:7)\n-           ./app/separate-file.ts\n-           file://<full-path>/apps/web/.next/static/chunks/app/source-maps-ssr/page.js (49:1)\n-           options.factory\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (700:31)\n-           __webpack_require__\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (37:33)\n-           fn\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (357:21)\n-           innerArrowFunction\n-           app/source-maps-ssr/page.tsx (16:3)\n-           innerFunction\n-           app/source-maps-ssr/page.tsx (12:3)\n-           Page\n-           app/source-maps-ssr/page.tsx (6:5)\"\n+           \"eval app/separate-file.ts (1:7)\n+           ./app/separate-file.ts file://<full-path>/apps/web/.next/static/chunks/app/source-maps-ssr/page.js (49:1)\n+           options.factory file://<full-path>/apps/web/.next/static/chunks/webpack.js (700:31)\n+           __webpack_require__ file://<full-path>/apps/web/.next/static/chunks/webpack.js (37:33)\n+           fn file://<full-path>/apps/web/.next/static/chunks/webpack.js (357:21)\n+           innerArrowFunction app/source-maps-ssr/page.tsx (16:3)\n+           innerFunction app/source-maps-ssr/page.tsx (12:3)\n+           Page app/source-maps-ssr/page.tsx (6:5)\"\n           `)\n         }\n         await browser.close()\n@@ -222,14 +204,10 @@ describe('non-root-project-monorepo', () => {\n           `)\n           expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n             .toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript)\n-           app/separate-file.ts (1:7)\n-           innerArrowFunction\n-           app/source-maps-client/page.tsx (16:28)\n-           innerFunction\n-           app/source-maps-client/page.tsx (13:3)\n-           effectCallback\n-           app/source-maps-client/page.tsx (7:5)\"\n+           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\n+           innerArrowFunction app/source-maps-client/page.tsx (16:28)\n+           innerFunction app/source-maps-client/page.tsx (13:3)\n+           effectCallback app/source-maps-client/page.tsx (7:5)\"\n           `)\n         } else {\n           // TODO the function name should be hidden\n@@ -243,22 +221,14 @@ describe('non-root-project-monorepo', () => {\n           // TODO webpack runtime code shouldn't be included in stack trace\n           expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n             .toMatchInlineSnapshot(`\n-           \"eval\n-           app/separate-file.ts (1:7)\n-           ./app/separate-file.ts\n-           file://<full-path>/apps/web/.next/static/chunks/app/source-maps-client/page.js (49:1)\n-           options.factory\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (712:31)\n-           __webpack_require__\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (37:33)\n-           fn\n-           file://<full-path>/apps/web/.next/static/chunks/webpack.js (369:21)\n-           innerArrowFunction\n-           app/source-maps-client/page.tsx (17:3)\n-           innerFunction\n-           app/source-maps-client/page.tsx (13:3)\n-           effectCallback\n-           app/source-maps-client/page.tsx (7:5)\"\n+           \"eval app/separate-file.ts (1:7)\n+           ./app/separate-file.ts file://<full-path>/apps/web/.next/static/chunks/app/source-maps-client/page.js (49:1)\n+           options.factory file://<full-path>/apps/web/.next/static/chunks/webpack.js (712:31)\n+           __webpack_require__ file://<full-path>/apps/web/.next/static/chunks/webpack.js (37:33)\n+           fn file://<full-path>/apps/web/.next/static/chunks/webpack.js (369:21)\n+           innerArrowFunction app/source-maps-client/page.tsx (17:3)\n+           innerFunction app/source-maps-client/page.tsx (13:3)\n+           effectCallback app/source-maps-client/page.tsx (7:5)\"\n           `)\n         }\n         await browser.close()"
        },
        {
            "sha": "8e3b308fc2fdc95cdd1b94512b566f8122e2a866",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -193,7 +193,7 @@ describe('app-dir - server source maps', () => {\n \n   it('thrown SSR errors', async () => {\n     const outputIndex = next.cliOutput.length\n-    await next.render('/ssr-throw')\n+    const browser = await next.browser('/ssr-throw')\n \n     if (isNextDev) {\n       await retry(() => {\n@@ -215,6 +215,23 @@ describe('app-dir - server source maps', () => {\n           \"\\n  digest: '\"\n       )\n       expect(cliOutput).toMatch(/digest: '\\d+'/)\n+\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 2,\n+         \"description\": \"Error: Boom\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"app/ssr-throw/Thrower.js (4:9) @ throwError\n+       > 4 |   throw new Error('Boom')\n+           |         ^\",\n+         \"stack\": [\n+           \"throwError app/ssr-throw/Thrower.js (4:9)\",\n+           \"Thrower app/ssr-throw/Thrower.js (8:3)\",\n+           \"Page app/ssr-throw/page.js (6:10)\",\n+         ],\n+       }\n+      `)\n     } else {\n       // TODO: Test `next build` with `--enable-source-maps`.\n     }"
        },
        {
            "sha": "3ddb92599751db1a2608a9a5e0bedfaa2bcbf651",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "added",
            "additions": 211,
            "deletions": 0,
            "changes": 211,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -0,0 +1,211 @@\n+import type { MatcherContext } from 'expect'\n+import { toMatchInlineSnapshot } from 'jest-snapshot'\n+import {\n+  assertHasRedbox,\n+  getRedboxCallStack,\n+  getRedboxDescription,\n+  getRedboxEnvironmentLabel,\n+  getRedboxSource,\n+  getRedboxLabel,\n+  getRedboxTotalErrorCount,\n+  openRedbox,\n+} from './next-test-utils'\n+import type { BrowserInterface } from './browsers/base'\n+\n+declare global {\n+  namespace jest {\n+    // eslint-disable-next-line @typescript-eslint/no-unused-vars -- module augmentation needs to match generic params even if unused\n+    interface Matchers<R> {\n+      /**\n+       * Inline snapshot matcher for a Redbox that's popped up by default.\n+       * When a Redbox is hidden at first and requires manual display by clicking the toast,\n+       * use {@link toDisplayCollapsedRedbox} instead.\n+       *\n+       * Unintented content in the snapshot should be reported to the Next.js DX team.\n+       * <FIXME-internal-frame> in the snapshot would be unintended.\n+       * Any node_modules in the snapshot would be unintended.\n+       * Differences in the snapshot between Turbopack and Webpack would be unintended.\n+       *\n+       * @param inlineSnapshot - The snapshot to compare against.\n+       */\n+      toDisplayRedbox(inlineSnapshot?: string): Promise<void>\n+\n+      /**\n+       * Inline snapshot matcher for a Redbox that's collapsed by default.\n+       * When a Redbox is immediately displayed,\n+       * use {@link toDisplayRedbox} instead.\n+       *\n+       * Unintented content in the snapshot should be reported to the Next.js DX team.\n+       * <FIXME-internal-frame> in the snapshot would be unintended.\n+       * Any node_modules in the snapshot would be unintended.\n+       * Differences in the snapshot between Turbopack and Webpack would be unintended.\n+       *\n+       * @param inlineSnapshot - The snapshot to compare against.\n+       */\n+      toDisplayCollapsedRedbox(inlineSnapshot?: string): Promise<void>\n+    }\n+  }\n+}\n+\n+interface RedboxSnapshot {\n+  environmentLabel: string\n+  label: string\n+  description: string\n+  source: string\n+  stack: string[]\n+  count: number\n+}\n+\n+async function createRedboxSnapshot(\n+  browser: BrowserInterface\n+): Promise<RedboxSnapshot> {\n+  const [label, environmentLabel, description, source, stack, count] =\n+    await Promise.all([\n+      getRedboxLabel(browser),\n+      getRedboxEnvironmentLabel(browser),\n+      getRedboxDescription(browser),\n+      getRedboxSource(browser),\n+      getRedboxCallStack(browser),\n+      getRedboxTotalErrorCount(browser),\n+    ])\n+\n+  // We don't need to test the codeframe logic everywhere.\n+  // Here we focus on the cursor position of the top most frame\n+  // From\n+  //\n+  // pages/index.js (3:11) @ eval\n+  //\n+  //   1 | export default function Page() {\n+  //   2 |   [1, 2, 3].map(() => {\n+  // > 3 |     throw new Error(\"anonymous error!\");\n+  //     |           ^\n+  //   4 |   })\n+  //   5 | }\n+  //\n+  // to\n+  //\n+  // pages/index.js (3:11) @ Page\n+  // > 3 |     throw new Error(\"anonymous error!\");\n+  //     |           ^\n+  let focusedSource = source\n+  if (source !== null) {\n+    focusedSource = ''\n+    const sourceFrameLines = source.split('\\n')\n+    for (let i = 0; i < sourceFrameLines.length; i++) {\n+      const sourceFrameLine = sourceFrameLines[i]\n+      if (sourceFrameLine === '') {\n+        continue\n+      }\n+\n+      if (sourceFrameLine.startsWith('>')) {\n+        // This is where the cursor will point\n+        // Include the cursor and nothing below since it's just surrounding code.\n+        focusedSource += '\\n' + sourceFrameLine\n+        focusedSource += '\\n' + sourceFrameLines[i + 1]\n+        break\n+      }\n+      const isCodeFrameLine = /^ {2}\\s*\\d+ \\|/.test(sourceFrameLine)\n+      if (!isCodeFrameLine) {\n+        focusedSource += '\\n' + sourceFrameLine\n+      }\n+    }\n+  }\n+\n+  return {\n+    environmentLabel,\n+    label,\n+    description,\n+    source: focusedSource?.trim(),\n+    stack,\n+    // TODO(newDevOverlay): Always return `count`. Normalizing currently to avoid assertion forks.\n+    count: label === 'Build Error' && count === -1 ? 1 : count,\n+  }\n+}\n+\n+expect.extend({\n+  async toDisplayRedbox(\n+    this: MatcherContext,\n+    browser: BrowserInterface,\n+    expectedRedboxSnapshot?: string\n+  ) {\n+    // Otherwise jest uses the async stack trace which makes it impossible to know the actual callsite of `toMatchSpeechInlineSnapshot`.\n+    // @ts-expect-error -- Not readonly\n+    this.error = new Error()\n+    // Abort test on first mismatch.\n+    // Subsequent actions will be based on an incorrect state otherwise and almost always fail as well.\n+    // TODO: Actually, we may want to proceed. Kinda nice to also do more assertions later.\n+    this.dontThrow = () => {}\n+\n+    try {\n+      await assertHasRedbox(browser)\n+    } catch (cause) {\n+      // argument length is relevant.\n+      // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n+      if (expectedRedboxSnapshot === undefined) {\n+        return toMatchInlineSnapshot.call(this, String(cause.message))\n+      } else {\n+        return toMatchInlineSnapshot.call(\n+          this,\n+          String(cause.message),\n+          expectedRedboxSnapshot\n+        )\n+      }\n+    }\n+\n+    const redbox = await createRedboxSnapshot(browser)\n+\n+    // argument length is relevant.\n+    // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n+    if (expectedRedboxSnapshot === undefined) {\n+      return toMatchInlineSnapshot.call(this, redbox)\n+    } else {\n+      return toMatchInlineSnapshot.call(this, redbox, expectedRedboxSnapshot)\n+    }\n+  },\n+  async toDisplayCollapsedRedbox(\n+    this: MatcherContext,\n+    browser: BrowserInterface,\n+    expectedRedboxSnapshot?: string\n+  ) {\n+    // Otherwise jest uses the async stack trace which makes it impossible to know the actual callsite of `toMatchSpeechInlineSnapshot`.\n+    // @ts-expect-error -- Not readonly\n+    this.error = new Error()\n+    // Abort test on first mismatch.\n+    // Subsequent actions will be based on an incorrect state otherwise and almost always fail as well.\n+    // TODO: Actually, we may want to proceed. Kinda nice to also do more assertions later.\n+    this.dontThrow = () => {}\n+\n+    try {\n+      await openRedbox(browser)\n+    } catch (cause) {\n+      // argument length is relevant.\n+      // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n+      if (expectedRedboxSnapshot === undefined) {\n+        return toMatchInlineSnapshot.call(\n+          this,\n+          String(cause.message)\n+            // Should switch to `toDisplayRedbox` not `assertHasRedbox`\n+            .replace('assertHasRedbox', 'toDisplayRedbox')\n+        )\n+      } else {\n+        return toMatchInlineSnapshot.call(\n+          this,\n+          String(cause.message)\n+            // Should switch to `toDisplayRedbox` not `assertHasRedbox`\n+            .replace('assertHasRedbox', 'toDisplayRedbox'),\n+          expectedRedboxSnapshot\n+        )\n+      }\n+    }\n+\n+    const redbox = await createRedboxSnapshot(browser)\n+\n+    // argument length is relevant.\n+    // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n+    if (expectedRedboxSnapshot === undefined) {\n+      return toMatchInlineSnapshot.call(this, redbox)\n+    } else {\n+      return toMatchInlineSnapshot.call(this, redbox, expectedRedboxSnapshot)\n+    }\n+  },\n+})"
        },
        {
            "sha": "dd2427b80e2f0d04dab37ed93d61a5a8069bd578",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 80,
            "deletions": 11,
            "changes": 91,
            "blob_url": "https://github.com/vercel/next.js/blob/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5a09d66378c027cfd547d3fb95ade66dcf42c49/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=c5a09d66378c027cfd547d3fb95ade66dcf42c49",
            "patch": "@@ -31,6 +31,9 @@ import { Playwright } from './browsers/playwright'\n \n import { getTurbopackFlag, shouldRunTurboDevTest } from './turbo'\n import stripAnsi from 'strip-ansi'\n+// TODO: Create dedicated Jest environment that sets up these matchers\n+// Edge Runtime unit tests fail with \"EvalError: Code generation from strings disallowed for this context\" if these matchers are imported in those tests.\n+import './add-redbox-matchers'\n \n export { shouldRunTurboDevTest }\n \n@@ -1022,7 +1025,9 @@ export async function getRedboxTotalErrorCount(\n   return parseInt(text || '-1')\n }\n \n-export async function getRedboxSource(browser: BrowserInterface) {\n+export function getRedboxSource(\n+  browser: BrowserInterface\n+): Promise<string | undefined> {\n   return browser.eval(() => {\n     const portal = [].slice\n       .call(document.querySelectorAll('nextjs-portal'))\n@@ -1037,7 +1042,9 @@ export async function getRedboxSource(browser: BrowserInterface) {\n   })\n }\n \n-export function getRedboxTitle(browser: BrowserInterface) {\n+export function getRedboxTitle(\n+  browser: BrowserInterface\n+): Promise<string | null> {\n   return browser.eval(() => {\n     const portal = [].slice\n       .call(document.querySelectorAll('nextjs-portal'))\n@@ -1049,7 +1056,38 @@ export function getRedboxTitle(browser: BrowserInterface) {\n   })\n }\n \n-export function getRedboxDescription(browser: BrowserInterface) {\n+export function getRedboxLabel(\n+  browser: BrowserInterface\n+): Promise<string | null> {\n+  return browser.eval(() => {\n+    const portal = [].slice\n+      .call(document.querySelectorAll('nextjs-portal'))\n+      .find((p) => p.shadowRoot.querySelector('[data-nextjs-dialog-header]'))\n+    const root = portal.shadowRoot\n+    return (\n+      root.querySelector('#nextjs__container_errors_label')?.innerText ?? null\n+    )\n+  })\n+}\n+\n+export function getRedboxEnvironmentLabel(\n+  browser: BrowserInterface\n+): Promise<string | null> {\n+  return browser.eval(() => {\n+    const portal = [].slice\n+      .call(document.querySelectorAll('nextjs-portal'))\n+      .find((p) => p.shadowRoot.querySelector('[data-nextjs-dialog-header]'))\n+    const root = portal.shadowRoot\n+    return (\n+      root.querySelector('[data-nextjs-environment-name-label]')?.innerText ??\n+      null\n+    )\n+  })\n+}\n+\n+export function getRedboxDescription(\n+  browser: BrowserInterface\n+): Promise<string> {\n   return browser.eval(() => {\n     const portal = [].slice\n       .call(document.querySelectorAll('nextjs-portal'))\n@@ -1341,15 +1379,46 @@ export async function hasRedboxCallStack(browser: BrowserInterface) {\n \n export async function getRedboxCallStack(\n   browser: BrowserInterface\n-): Promise<string | null> {\n-  const callStackFrameElements = await browser.elementsByCss(\n-    '[data-nextjs-call-stack-frame]'\n-  )\n-  const callStackFrameTexts = await Promise.all(\n-    callStackFrameElements.map((f) => f.innerText())\n-  )\n+): Promise<string[] | null> {\n+  return browser.eval(() => {\n+    const portal = [].slice\n+      .call(document.querySelectorAll('nextjs-portal'))\n+      .find((p) => p.shadowRoot.querySelector('[data-nextjs-call-stack-frame]'))\n+    const root = portal?.shadowRoot\n+    const frameElements = root?.querySelectorAll(\n+      '[data-nextjs-call-stack-frame]'\n+    )\n \n-  return callStackFrameTexts.join('\\n').trim()\n+    const stack: string[] = []\n+    if (frameElements !== undefined) {\n+      let foundInternalFrame = false\n+      for (const frameElement of frameElements) {\n+        // `innerText` will be \"${methodName}\\n${location}\".\n+        // Ideally `innerText` would be \"${methodName} ${location}\"\n+        // so that c&p automatically does the right thing.\n+        const frame = frameElement.innerText.replace('\\n', ' ')\n+\n+        // Feel free to adjust this heuristic if it accidentally hides too much.\n+        const isInternalFrame =\n+          // likely https://linear.app/vercel/issue/NDX-464\n+          // location starts with `./dist` e.g. \"NotFoundBoundary ./dist/esm/[...]\"\n+          / .\\/dist\\//.test(frame)\n+\n+        if (isInternalFrame) {\n+          // We only add one of these frames.\n+          // If we'd add all of them, the stack would change during refactorings which is annoying.\n+          if (!foundInternalFrame) {\n+            stack.push('<FIXME-internal-frame>')\n+          }\n+          foundInternalFrame = true\n+        } else {\n+          stack.push(frame)\n+        }\n+      }\n+    }\n+\n+    return stack\n+  })\n }\n \n export async function getRedboxCallStackCollapsed("
        }
    ],
    "stats": {
        "total": 942,
        "additions": 632,
        "deletions": 310
    }
}