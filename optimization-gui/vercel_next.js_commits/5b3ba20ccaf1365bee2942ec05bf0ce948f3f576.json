{
    "author": "eps1lon",
    "message": "[build-sourcemaps] Allow inspecting prerender worker (#79098)\n\nIf `--inspect` or `--inspect-brk` is specified, prerender will no longer time out since that's most likely not wanted (e.g. you'd always get timeouts if you set breakpoints).\r\n\r\nInspecting prerender workers is best done with `experimental.cpus: 1`.\r\nOnly the first prerender worker can be inspected since we can't set `NODE_OPTIONS` based off of the worker index.\r\n\r\nThis PR also sets up infra for inspecting arbitrary workers. Their debug port would need to be coordinated within `getNextBuildDebuggerPortOffset`. This doesn't work if worker creation is shared between `next build` and `next dev` which I haven't checked if that's the case.",
    "sha": "5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
    "files": [
        {
            "sha": "614e512d78a512fa44515f86eca1c8a4fddf887f",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 19,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -194,10 +194,6 @@ import {\n import { FallbackMode, fallbackModeToFallbackField } from '../lib/fallback'\n import { RenderingMode } from './rendering-mode'\n import { getParamKeys } from '../server/request/fallback-params'\n-import {\n-  formatNodeOptions,\n-  getParsedNodeOptionsWithoutInspect,\n-} from '../server/lib/utils'\n import { InvariantError } from '../shared/lib/invariant-error'\n import { HTML_LIMITED_BOT_UA_RE_STRING } from '../shared/lib/router/utils/is-bot'\n import type { UseCacheTrackerKey } from './webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n@@ -743,17 +739,15 @@ const staticWorkerExposedMethods = [\n type StaticWorker = typeof import('./worker') & Worker\n export function createStaticWorker(\n   config: NextConfigComplete,\n-  progress?: {\n-    run: () => void\n-    clear: () => void\n+  options: {\n+    debuggerPortOffset: number\n+    progress?: {\n+      run: () => void\n+      clear: () => void\n+    }\n   }\n ): StaticWorker {\n-  // Get the node options without inspect and also remove the\n-  // --max-old-space-size flag as it can cause memory issues.\n-  const nodeOptions = getParsedNodeOptionsWithoutInspect()\n-  delete nodeOptions['max-old-space-size']\n-  delete nodeOptions['max_old_space_size']\n-\n+  const { debuggerPortOffset, progress } = options\n   return new Worker(staticWorkerPath, {\n     logger: Log,\n     numWorkers: getNumberOfWorkers(config),\n@@ -763,11 +757,9 @@ export function createStaticWorker(\n     onActivityAbort: () => {\n       progress?.clear()\n     },\n-    forkOptions: {\n-      env: {\n-        NODE_OPTIONS: formatNodeOptions(nodeOptions),\n-      },\n-    },\n+    debuggerPortOffset,\n+    // remove --max-old-space-size flag as it can cause memory issues.\n+    isolatedMemory: true,\n     enableWorkerThreads: config.experimental.workerThreads,\n     exposedMethods: staticWorkerExposedMethods,\n   }) as StaticWorker\n@@ -1496,6 +1488,8 @@ export default async function build(\n                 const buildTraceWorker = new Worker(\n                   require.resolve('./collect-build-traces'),\n                   {\n+                    debuggerPortOffset: -1,\n+                    isolatedMemory: false,\n                     numWorkers: 1,\n                     exposedMethods: ['collectBuildTraces'],\n                   }\n@@ -1652,7 +1646,7 @@ export default async function build(\n \n       process.env.NEXT_PHASE = PHASE_PRODUCTION_BUILD\n \n-      const worker = createStaticWorker(config)\n+      const worker = createStaticWorker(config, { debuggerPortOffset: -1 })\n \n       const analysisBegin = process.hrtime()\n       const staticCheckSpan = nextBuildSpan.traceChild('static-check')"
        },
        {
            "sha": "e1c9080143c58d2ddc069b185ccd5d456c6442e6",
            "filename": "packages/next/src/build/turbopack-build/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,23 +1,19 @@\n import path from 'path'\n-import {\n-  formatNodeOptions,\n-  getParsedNodeOptionsWithoutInspect,\n-} from '../../server/lib/utils'\n+\n import { Worker } from '../../lib/worker'\n import { NextBuildContext } from '../build-context'\n \n async function turbopackBuildWithWorker() {\n-  const nodeOptions = getParsedNodeOptionsWithoutInspect()\n-\n   try {\n     const worker = new Worker(path.join(__dirname, 'impl.js'), {\n       exposedMethods: ['workerMain', 'waitForShutdown'],\n+      debuggerPortOffset: -1,\n+      isolatedMemory: false,\n       numWorkers: 1,\n       maxRetries: 0,\n       forkOptions: {\n         env: {\n           NEXT_PRIVATE_BUILD_WORKER: '1',\n-          NODE_OPTIONS: formatNodeOptions(nodeOptions),\n         },\n       },\n     }) as Worker & typeof import('./impl')"
        },
        {
            "sha": "6f1ff966cf5375f86c5aec11cf062f70fb2790c3",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -34,6 +34,8 @@ function verifyTypeScriptSetup(\n     require.resolve('../lib/verify-typescript-setup'),\n     {\n       exposedMethods: ['verifyTypeScriptSetup'],\n+      debuggerPortOffset: -1,\n+      isolatedMemory: false,\n       numWorkers: 1,\n       enableWorkerThreads,\n       maxRetries: 0,"
        },
        {
            "sha": "a9a0a64764590682ce305a616ab7957d71d6a044",
            "filename": "packages/next/src/build/webpack-build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -6,10 +6,6 @@ import { Worker } from '../../lib/worker'\n import origDebug from 'next/dist/compiled/debug'\n import path from 'path'\n import { exportTraceState, recordTraceEvents } from '../../trace'\n-import {\n-  formatNodeOptions,\n-  getParsedNodeOptionsWithoutInspect,\n-} from '../../server/lib/utils'\n import { mergeUseCacheTrackers } from '../webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n import { durationToString } from '../duration-to-string'\n \n@@ -48,17 +44,16 @@ async function webpackBuildWithWorker(\n     buildTraceContext: {} as BuildTraceContext,\n   }\n \n-  const nodeOptions = getParsedNodeOptionsWithoutInspect()\n-\n   for (const compilerName of compilerNames) {\n     const worker = new Worker(path.join(__dirname, 'impl.js'), {\n       exposedMethods: ['workerMain'],\n+      debuggerPortOffset: -1,\n+      isolatedMemory: false,\n       numWorkers: 1,\n       maxRetries: 0,\n       forkOptions: {\n         env: {\n           NEXT_PRIVATE_BUILD_WORKER: '1',\n-          NODE_OPTIONS: formatNodeOptions(nodeOptions),\n         },\n       },\n     }) as Worker & typeof import('./impl')"
        },
        {
            "sha": "b5f3daee1c165febe61f7f3da5984b0ef84dcc82",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -63,6 +63,7 @@ import { isInterceptionRouteRewrite } from '../lib/generate-interception-routes-\n import type { ActionManifest } from '../build/webpack/plugins/flight-client-entry-plugin'\n import { extractInfoFromServerReferenceId } from '../shared/lib/server-reference-info'\n import { convertSegmentPathToStaticExportFilename } from '../shared/lib/segment-cache/segment-value-encoding'\n+import { getNextBuildDebuggerPortOffset } from '../lib/worker'\n \n export class ExportError extends Error {\n   code = 'NEXT_EXPORT_ERROR'\n@@ -581,7 +582,10 @@ async function exportAppImpl(\n     options.statusMessage || 'Exporting'\n   )\n \n-  const worker = createStaticWorker(nextConfig, progress)\n+  const worker = createStaticWorker(nextConfig, {\n+    debuggerPortOffset: getNextBuildDebuggerPortOffset({ kind: 'export-page' }),\n+    progress,\n+  })\n \n   const results = (\n     await Promise.all("
        },
        {
            "sha": "7ef928b90104ec6c6ab3d82aa5b7aa0a15cbb1d3",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -401,6 +401,10 @@ export async function exportPages(\n     let attempt = 0\n     let result\n \n+    const hasDebuggerAttached =\n+      // Also tests for `inspect-brk`\n+      process.env.NODE_OPTIONS?.includes('--inspect')\n+\n     while (attempt < maxAttempts) {\n       try {\n         result = await Promise.race<ExportPageResult | undefined>([\n@@ -427,12 +431,15 @@ export async function exportPages(\n             sriEnabled: Boolean(nextConfig.experimental.sri?.algorithm),\n             buildId: input.buildId,\n           }),\n-          // If exporting the page takes longer than the timeout, reject the promise.\n-          new Promise((_, reject) => {\n-            setTimeout(() => {\n-              reject(new TimeoutError())\n-            }, nextConfig.staticPageGenerationTimeout * 1000)\n-          }),\n+          hasDebuggerAttached\n+            ? // With a debugger attached, exporting can take infinitely if we paused script execution.\n+              new Promise(() => {})\n+            : // If exporting the page takes longer than the timeout, reject the promise.\n+              new Promise((_, reject) => {\n+                setTimeout(() => {\n+                  reject(new TimeoutError())\n+                }, nextConfig.staticPageGenerationTimeout * 1000)\n+              }),\n         ])\n \n         // If there was an error in the export, throw it immediately. In the catch block, we might retry the export,"
        },
        {
            "sha": "7f263d331a180ef52c90f9c6156de4d9e57a2567",
            "filename": "packages/next/src/lib/verifyAndLint.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Flib%2FverifyAndLint.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Flib%2FverifyAndLint.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2FverifyAndLint.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -24,6 +24,8 @@ export async function verifyAndLint(\n   try {\n     lintWorkers = new Worker(require.resolve('./eslint/runLintCheck'), {\n       exposedMethods: ['runLintCheck'],\n+      debuggerPortOffset: -1,\n+      isolatedMemory: false,\n       numWorkers: 1,\n       enableWorkerThreads,\n       maxRetries: 0,"
        },
        {
            "sha": "75bd73eb94b5980b19a185ac5059431089db8351",
            "filename": "packages/next/src/lib/worker.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 1,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -1,6 +1,13 @@\n import type { ChildProcess } from 'child_process'\n import { Worker as JestWorker } from 'next/dist/compiled/jest-worker'\n import { Transform } from 'stream'\n+import {\n+  formatDebugAddress,\n+  formatNodeOptions,\n+  getNodeDebugType,\n+  getParsedDebugAddress,\n+  getParsedNodeOptionsWithoutInspect,\n+} from '../server/lib/utils'\n \n type FarmOptions = NonNullable<ConstructorParameters<typeof JestWorker>[1]>\n \n@@ -14,6 +21,13 @@ const cleanupWorkers = (worker: JestWorker) => {\n   }\n }\n \n+export function getNextBuildDebuggerPortOffset(_: {\n+  kind: 'export-page'\n+}): number {\n+  // 0: export worker\n+  return 0\n+}\n+\n export class Worker {\n   private _worker: JestWorker | undefined\n \n@@ -25,6 +39,14 @@ export class Worker {\n             env?: Partial<NodeJS.ProcessEnv> | undefined\n           })\n         | undefined\n+      /**\n+       * `-1` if not inspectable\n+       */\n+      debuggerPortOffset: number\n+      /**\n+       * True if `--max-old-space-size` should not be forwarded to the worker.\n+       */\n+      isolatedMemory: boolean\n       timeout?: number\n       onActivity?: () => void\n       onActivityAbort?: () => void\n@@ -34,7 +56,14 @@ export class Worker {\n       enableWorkerThreads?: boolean\n     }\n   ) {\n-    let { timeout, onRestart, logger = console, ...farmOptions } = options\n+    let {\n+      timeout,\n+      onRestart,\n+      logger = console,\n+      debuggerPortOffset,\n+      isolatedMemory,\n+      ...farmOptions\n+    } = options\n \n     let restartPromise: Promise<typeof RESTARTED>\n     let resolveRestartPromise: (arg: typeof RESTARTED) => void\n@@ -47,6 +76,26 @@ export class Worker {\n       this.close()\n     })\n \n+    const nodeOptions = getParsedNodeOptionsWithoutInspect()\n+\n+    if (debuggerPortOffset !== -1) {\n+      const nodeDebugType = getNodeDebugType()\n+      if (nodeDebugType) {\n+        const address = getParsedDebugAddress()\n+        address.port =\n+          address.port +\n+          // current process runs on `address.port`\n+          1 +\n+          debuggerPortOffset\n+        nodeOptions[nodeDebugType] = formatDebugAddress(address)\n+      }\n+    }\n+\n+    if (isolatedMemory) {\n+      delete nodeOptions['max-old-space-size']\n+      delete nodeOptions['max_old_space_size']\n+    }\n+\n     const createWorker = () => {\n       this._worker = new JestWorker(workerPath, {\n         ...farmOptions,\n@@ -56,6 +105,7 @@ export class Worker {\n             ...process.env,\n             ...((farmOptions.forkOptions?.env || {}) as any),\n             IS_NEXT_WORKER: 'true',\n+            NODE_OPTIONS: formatNodeOptions(nodeOptions),\n           } as any,\n         },\n         maxRetries: 0,"
        },
        {
            "sha": "3ebbb3f52663d5c5fe8ec2ff9ce94e4208eb6201",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5b3ba20ccaf1365bee2942ec05bf0ce948f3f576/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fnext.config.js?ref=5b3ba20ccaf1365bee2942ec05bf0ce948f3f576",
            "patch": "@@ -3,6 +3,7 @@\n  */\n const nextConfig = {\n   experimental: {\n+    cpus: 1,\n     dynamicIO: true,\n     serverSourceMaps: true,\n   },"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 92,
        "deletions": 41
    }
}