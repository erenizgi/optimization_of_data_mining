{
    "author": "bgw",
    "message": "Turbopack: Simplify the return type of `FileSystemPath::try_join` (#86523)\n\nThis is probably left over from when more of `FileSystemPath` was using `turbo_task::function`s...\n\nWe can't ever possibly return an error, so the wrapping `Result` isn't needed.",
    "sha": "dae80fb704c507e2af823c9235e4086037e2cf77",
    "files": [
        {
            "sha": "21791590e0571179c6eae994e80d9bd045f73723",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 15,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -1438,30 +1438,27 @@ impl FileSystemPath {\n         ))\n     }\n \n-    /// Similar to [FileSystemPath::join], but returns an Option that will be\n-    /// None when the joined path would leave the filesystem root.\n+    /// Similar to [FileSystemPath::join], but returns an [`Option`] that will be [`None`] when the\n+    /// joined path would leave the filesystem root.\n     #[allow(clippy::needless_borrow)] // for windows build\n-    pub fn try_join(&self, path: &str) -> Result<Option<FileSystemPath>> {\n+    pub fn try_join(&self, path: &str) -> Option<FileSystemPath> {\n         // TODO(PACK-3279): Remove this once we do not produce invalid paths at the first place.\n         #[cfg(target_os = \"windows\")]\n         let path = path.replace('\\\\', \"/\");\n \n-        if let Some(path) = join_path(&self.path, &path) {\n-            Ok(Some(Self::new_normalized(self.fs, path.into())))\n-        } else {\n-            Ok(None)\n-        }\n+        join_path(&self.path, &path).map(|p| Self::new_normalized(self.fs, RcStr::from(p)))\n     }\n \n-    /// Similar to [FileSystemPath::join], but returns an Option that will be\n-    /// None when the joined path would leave the current path.\n-    pub fn try_join_inside(&self, path: &str) -> Result<Option<FileSystemPath>> {\n-        if let Some(path) = join_path(&self.path, path)\n-            && path.starts_with(&*self.path)\n+    /// Similar to [FileSystemPath::try_join], but returns [`None`] when the new path would leave\n+    /// the current path (not just the filesystem root). This is useful for preventing access\n+    /// outside of a directory.\n+    pub fn try_join_inside(&self, path: &str) -> Option<FileSystemPath> {\n+        if let Some(p) = join_path(&self.path, path)\n+            && p.starts_with(&*self.path)\n         {\n-            return Ok(Some(Self::new_normalized(self.fs, path.into())));\n+            return Some(Self::new_normalized(self.fs, RcStr::from(p)));\n         }\n-        Ok(None)\n+        None\n     }\n \n     /// DETERMINISM: Result is in random order. Either sort result or do not depend"
        },
        {
            "sha": "ca51714710efddd8ff41928f178b385a2e291637",
            "filename": "turbopack/crates/turbopack-core/src/resolve/pattern.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -1561,9 +1561,9 @@ pub async fn read_matches(\n                     if last_segment.is_empty() {\n                         // This means we don't have a last segment, so we just have a directory\n                         let joined = if force_in_lookup_dir {\n-                            lookup_dir.try_join_inside(parent_path)?\n+                            lookup_dir.try_join_inside(parent_path)\n                         } else {\n-                            lookup_dir.try_join(parent_path)?\n+                            lookup_dir.try_join(parent_path)\n                         };\n                         let Some(fs_path) = joined else {\n                             continue;\n@@ -1579,9 +1579,9 @@ pub async fn read_matches(\n                         Entry::Occupied(e) => Some(e.into_mut()),\n                         Entry::Vacant(e) => {\n                             let path_option = if force_in_lookup_dir {\n-                                lookup_dir.try_join_inside(parent_path)?\n+                                lookup_dir.try_join_inside(parent_path)\n                             } else {\n-                                lookup_dir.try_join(parent_path)?\n+                                lookup_dir.try_join(parent_path)\n                             };\n                             if let Some(path) = path_option {\n                                 Some(e.insert((path.raw_read_dir().await?, path)))\n@@ -1635,9 +1635,9 @@ pub async fn read_matches(\n                     let subpath = &str[..=str.rfind('/').unwrap()];\n                     if handled.insert(subpath) {\n                         let joined = if force_in_lookup_dir {\n-                            lookup_dir.try_join_inside(subpath)?\n+                            lookup_dir.try_join_inside(subpath)\n                         } else {\n-                            lookup_dir.try_join(subpath)?\n+                            lookup_dir.try_join(subpath)\n                         };\n                         let Some(fs_path) = joined else {\n                             continue;"
        },
        {
            "sha": "23b3ce9f82320285205f46941ad782c0f61d611a",
            "filename": "turbopack/crates/turbopack-core/src/source_map/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Fmod.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -377,7 +377,7 @@ impl SourceMap {\n             origin: FileSystemPath,\n         ) -> Result<(BytesStr, BytesStr)> {\n             Ok(\n-                if let Some(path) = origin.parent().try_join(&source_request)? {\n+                if let Some(path) = origin.parent().try_join(&source_request) {\n                     let path_str = path.value_to_string().await?;\n                     let source = format!(\"{SOURCE_URL_PROTOCOL}///{path_str}\");\n                     let source_content = if let Some(source_content) = source_content {"
        },
        {
            "sha": "c6d30049733df76c609e2eb50449f6a26750d04c",
            "filename": "turbopack/crates/turbopack-core/src/source_map/utils.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -128,9 +128,9 @@ pub async fn resolve_source_map_sources(\n             } else {\n                 // assume it's a relative URL, and just remove any percent encoding from path\n                 // segments. Our internal path format is POSIX-like, without percent encoding.\n-                origin.parent().try_join(\n-                    &urlencoding::decode(source_url).unwrap_or(Cow::Borrowed(source_url)),\n-                )?\n+                origin\n+                    .parent()\n+                    .try_join(&urlencoding::decode(source_url).unwrap_or(Cow::Borrowed(source_url)))\n             };\n \n             if let Some(fs_path) = fs_path {"
        },
        {
            "sha": "f1d2340c9d7070e23939b9cd92851c2b392970f5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/typescript.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Ftypescript.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -78,7 +78,7 @@ impl ModuleReference for TsReferencePathAssetReference {\n                 .origin_path()\n                 .await?\n                 .parent()\n-                .try_join(&self.path)?\n+                .try_join(&self.path)\n             {\n                 let module = self\n                     .origin"
        },
        {
            "sha": "655448d7ee5809ef34fc70a0dfb141e0b3c2e5d8",
            "filename": "turbopack/crates/turbopack-resolve/src/typescript.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dae80fb704c507e2af823c9235e4086037e2cf77/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs?ref=dae80fb704c507e2af823c9235e4086037e2cf77",
            "patch": "@@ -255,7 +255,7 @@ async fn try_join_base_url(\n     base_url: RcStr,\n ) -> Result<Vc<FileSystemPathOption>> {\n     Ok(Vc::cell(\n-        source.ident().path().await?.parent().try_join(&base_url)?,\n+        source.ident().path().await?.parent().try_join(&base_url),\n     ))\n }\n \n@@ -294,7 +294,7 @@ pub async fn tsconfig_resolve_options(\n         {\n             let mut context_dir = source.ident().path().await?.parent();\n             if let Some(base_url) = json[\"compilerOptions\"][\"baseUrl\"].as_str()\n-                && let Some(new_context) = context_dir.try_join(base_url)?\n+                && let Some(new_context) = context_dir.try_join(base_url)\n             {\n                 context_dir = new_context;\n             };"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 25,
        "deletions": 28
    }
}