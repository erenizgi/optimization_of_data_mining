{
    "author": "unstubbable",
    "message": "[dynamicIO] Use filled Resume Data Cache for final-phase prerenders (#79743)\n\nWhen a route with dynamic params is prerendered using defined params\nfrom `generateStaticParams`, the filled Resume Data Cache is now used\nfor the final-phase prerender of the matching optional fallback shell.\n\nThis ensures that the fallback shell can reuse existing cache entries,\nwhich partially mitigates the performance hit we accepted by splitting\nup the prerendering into two phases.\n\nFurthermore, it will allow us to short-circuit fallback params access in\n`\"use cache\"` functions. Instead of having to wait for the timeout\nerror, we will be able to regard cache misses (excluding cached pages\nand layouts, whose params access is already handled swiftly) to be\ncaused by including the params in the cache key, if\n`allowEmptyFallbackShell` is `true`.",
    "sha": "2c95fefdacdeed440893273d34f956fb8d36e8f8",
    "files": [
        {
            "sha": "5306a4e07020828a7863e803011c19d6efb1ebaf",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -365,9 +365,9 @@ export async function handler(\n \n           // If the warmup is successful, we should use the resume data\n           // cache from the warmup.\n-          if (warmup.metadata.devRenderResumeDataCache) {\n-            context.renderOpts.devRenderResumeDataCache =\n-              warmup.metadata.devRenderResumeDataCache\n+          if (warmup.metadata.renderResumeDataCache) {\n+            context.renderOpts.renderResumeDataCache =\n+              warmup.metadata.renderResumeDataCache\n           }\n         }\n       }"
        },
        {
            "sha": "58b7ddb795844afff95e848b5d262460da314c61",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -560,7 +560,8 @@ async function exportAppImpl(\n \n   const exportPagesInBatches = async (\n     worker: StaticWorker,\n-    exportPaths: ExportPathEntry[]\n+    exportPaths: ExportPathEntry[],\n+    renderResumeDataCachesByPage?: Record<string, string>\n   ): Promise<ExportPagesResult> => {\n     // Batch filtered pages into smaller batches, and call the export worker on\n     // each batch. We've set a default minimum of 25 pages per batch to ensure\n@@ -607,6 +608,7 @@ async function exportAppImpl(\n             cacheMaxMemorySize: nextConfig.cacheMaxMemorySize,\n             fetchCache: true,\n             fetchCacheKeyPrefix: nextConfig.experimental.fetchCacheKeyPrefix,\n+            renderResumeDataCachesByPage,\n           })\n         )\n       )\n@@ -641,7 +643,31 @@ async function exportAppImpl(\n   const results = await exportPagesInBatches(worker, initialPhaseExportPaths)\n \n   if (finalPhaseExportPaths.length > 0) {\n-    results.push(...(await exportPagesInBatches(worker, finalPhaseExportPaths)))\n+    const renderResumeDataCachesByPage: Record<string, string> = {}\n+\n+    for (const { page, result } of results) {\n+      if (!result) {\n+        continue\n+      }\n+\n+      if ('renderResumeDataCache' in result && result.renderResumeDataCache) {\n+        // The last RDC for each page is used. We only need one. It should have\n+        // all the entries that the fallback shell also needs. We don't need to\n+        // merge them per page.\n+        renderResumeDataCachesByPage[page] = result.renderResumeDataCache\n+        // Remove the RDC string from the result so that it can be garbage\n+        // collected, when there are more results for the same page.\n+        result.renderResumeDataCache = undefined\n+      }\n+    }\n+\n+    const finalPhaseResults = await exportPagesInBatches(\n+      worker,\n+      finalPhaseExportPaths,\n+      renderResumeDataCachesByPage\n+    )\n+\n+    results.push(...finalPhaseResults)\n   }\n \n   let hadValidationError = false"
        },
        {
            "sha": "11f2038ea06ac9ecdd9c1afb4d91d51522fe2fd3",
            "filename": "packages/next/src/export/routes/app-page.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -29,6 +29,7 @@ import { AfterRunner } from '../../server/after/run-with-after'\n import type { RequestLifecycleOpts } from '../../server/base-server'\n import type { AppSharedContext } from '../../server/app-render/app-render'\n import type { MultiFileWriter } from '../../lib/multi-file-writer'\n+import { stringifyResumeDataCache } from '../../server/resume-data-cache/resume-data-cache'\n \n /**\n  * Renders & exports a page associated with the /app directory\n@@ -92,6 +93,7 @@ export async function exportAppPage(\n       fetchTags,\n       fetchMetrics,\n       segmentData,\n+      renderResumeDataCache,\n     } = metadata\n \n     // Ensure we don't postpone without having PPR enabled.\n@@ -220,6 +222,9 @@ export async function exportAppPage(\n       hasPostponed: Boolean(postponed),\n       cacheControl,\n       fetchMetrics,\n+      renderResumeDataCache: renderResumeDataCache\n+        ? await stringifyResumeDataCache(renderResumeDataCache)\n+        : undefined,\n     }\n   } catch (err) {\n     if (!isDynamicUsageError(err)) {"
        },
        {
            "sha": "6fcea46d1cbffd5ccbb759caf73585bda3ea9065",
            "filename": "packages/next/src/export/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -12,6 +12,7 @@ import type {\n } from '../build/turborepo-access-trace'\n import type { FetchMetrics } from '../server/base-http'\n import type { RouteMetadata } from './routes/types'\n+import type { RenderResumeDataCache } from '../server/resume-data-cache/resume-data-cache'\n \n export interface AmpValidation {\n   page: string\n@@ -40,6 +41,7 @@ export interface ExportPagesInput {\n   cacheHandler: string | undefined\n   fetchCacheKeyPrefix: string | undefined\n   options: ExportAppOptions\n+  renderResumeDataCachesByPage: Record<string, string> | undefined\n }\n \n export interface ExportPageInput {\n@@ -62,6 +64,7 @@ export interface ExportPageInput {\n   nextConfigOutput?: NextConfigComplete['output']\n   enableExperimentalReact?: boolean\n   sriEnabled: boolean\n+  renderResumeDataCache: RenderResumeDataCache | undefined\n }\n \n export type ExportRouteResult =\n@@ -73,6 +76,7 @@ export type ExportRouteResult =\n       hasEmptyStaticShell?: boolean\n       hasPostponed?: boolean\n       fetchMetrics?: FetchMetrics\n+      renderResumeDataCache?: string\n     }\n   | {\n       error: boolean"
        },
        {
            "sha": "9eb521f65ebcd971434f1363b2918f17641e361f",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -49,6 +49,7 @@ import { isStaticGenBailoutError } from '../client/components/static-generation-\n import type { PagesRenderContext, PagesSharedContext } from '../server/render'\n import type { AppSharedContext } from '../server/app-render/app-render'\n import { MultiFileWriter } from '../lib/multi-file-writer'\n+import { createRenderResumeDataCache } from '../server/resume-data-cache/resume-data-cache'\n \n const envConfig =\n   require('../shared/lib/runtime-config.external') as typeof import('../shared/lib/runtime-config.external')\n@@ -86,6 +87,7 @@ async function exportPageImpl(\n     renderOpts: commonRenderOpts,\n     outDir: commonOutDir,\n     buildId,\n+    renderResumeDataCache,\n   } = input\n \n   if (enableExperimentalReact) {\n@@ -276,6 +278,7 @@ async function exportPageImpl(\n       ...commonRenderOpts.experimental,\n       isRoutePPREnabled,\n     },\n+    renderResumeDataCache,\n   }\n \n   if (hasNextSupport) {\n@@ -355,6 +358,7 @@ export async function exportPages(\n     renderOpts,\n     nextConfig,\n     options,\n+    renderResumeDataCachesByPage = {},\n   } = input\n \n   if (nextConfig.experimental.enablePrerenderSourceMaps) {\n@@ -399,6 +403,10 @@ export async function exportPages(\n       // Also tests for `inspect-brk`\n       process.env.NODE_OPTIONS?.includes('--inspect')\n \n+    const renderResumeDataCache = renderResumeDataCachesByPage[page]\n+      ? createRenderResumeDataCache(renderResumeDataCachesByPage[page])\n+      : undefined\n+\n     while (attempt < maxAttempts) {\n       try {\n         result = await Promise.race<ExportPageResult | undefined>([\n@@ -423,6 +431,7 @@ export async function exportPages(\n             enableExperimentalReact: needsExperimentalReact(nextConfig),\n             sriEnabled: Boolean(nextConfig.experimental.sri?.algorithm),\n             buildId: input.buildId,\n+            renderResumeDataCache,\n           }),\n           hasDebuggerAttached\n             ? // With a debugger attached, exporting can take infinitely if we paused script execution.\n@@ -591,15 +600,9 @@ async function exportPage(\n \n   // Otherwise we can return the result.\n   return {\n+    ...result,\n     duration: Date.now() - start,\n-    ampValidations: result.ampValidations,\n-    cacheControl: result.cacheControl,\n-    metadata: result.metadata,\n-    ssgNotFound: result.ssgNotFound,\n-    hasEmptyStaticShell: result.hasEmptyStaticShell,\n-    hasPostponed: result.hasPostponed,\n     turborepoAccessTraceResult: turborepoAccessTraceResult.serialize(),\n-    fetchMetrics: result.fetchMetrics,\n   }\n }\n "
        },
        {
            "sha": "ec6578b5d4ab593ba4e6356a0ddaa07325a0ac49",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 40,
            "deletions": 13,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -181,6 +181,8 @@ import { parseLoaderTree } from './parse-loader-tree'\n import {\n   createPrerenderResumeDataCache,\n   createRenderResumeDataCache,\n+  type PrerenderResumeDataCache,\n+  type RenderResumeDataCache,\n } from '../resume-data-cache/resume-data-cache'\n import type { MetadataErrorType } from '../../lib/metadata/resolve-metadata'\n import isError from '../../lib/is-error'\n@@ -714,6 +716,7 @@ async function warmupDevRender(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    renderResumeDataCache: null,\n     hmrRefreshHash: req.cookies[NEXT_HMR_REFRESH_HASH_COOKIE],\n   }\n \n@@ -750,7 +753,7 @@ async function warmupDevRender(\n   // lift the warmup pathway outside of renderToHTML... but for now this suffices\n   return new FlightRenderResult('', {\n     fetchMetrics: workStore.fetchMetrics,\n-    devRenderResumeDataCache: createRenderResumeDataCache(\n+    renderResumeDataCache: createRenderResumeDataCache(\n       prerenderResumeDataCache\n     ),\n   })\n@@ -1493,12 +1496,15 @@ async function renderToHTMLOrFlightImpl(\n       }\n     }\n \n+    if (response.renderResumeDataCache) {\n+      metadata.renderResumeDataCache = response.renderResumeDataCache\n+    }\n+\n     return new RenderResult(await streamToString(response.stream), options)\n   } else {\n     // We're rendering dynamically\n     const renderResumeDataCache =\n-      renderOpts.devRenderResumeDataCache ??\n-      postponedState?.renderResumeDataCache\n+      renderOpts.renderResumeDataCache ?? postponedState?.renderResumeDataCache\n \n     const rootParams = getRootParams(loaderTree, ctx.getDynamicParamFromSegment)\n     const requestStore = createRequestStoreForRender(\n@@ -1696,7 +1702,7 @@ export const renderToHTMLOrFlight: AppPageRender = (\n \n   if (\n     postponedState?.renderResumeDataCache &&\n-    renderOpts.devRenderResumeDataCache\n+    renderOpts.renderResumeDataCache\n   ) {\n     throw new InvariantError(\n       'postponed state and dev warmup immutable resume data cache should not be provided together'\n@@ -2310,6 +2316,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [...implicitTags.tags],\n     prerenderResumeDataCache,\n+    renderResumeDataCache: null,\n     hmrRefreshHash,\n   }\n \n@@ -2416,6 +2423,7 @@ async function spawnDynamicValidationInDev(\n       stale: INFINITE_CACHE,\n       tags: [...implicitTags.tags],\n       prerenderResumeDataCache,\n+      renderResumeDataCache: null,\n       hmrRefreshHash: undefined,\n     }\n \n@@ -2501,6 +2509,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [...implicitTags.tags],\n     prerenderResumeDataCache,\n+    renderResumeDataCache: null,\n     hmrRefreshHash,\n   }\n \n@@ -2563,6 +2572,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [...implicitTags.tags],\n     prerenderResumeDataCache,\n+    renderResumeDataCache: null,\n     hmrRefreshHash,\n   }\n \n@@ -2673,6 +2683,7 @@ type PrerenderToStreamResult = {\n   collectedExpire: number\n   collectedStale: number\n   collectedTags: null | string[]\n+  renderResumeDataCache?: RenderResumeDataCache\n }\n \n /**\n@@ -2866,11 +2877,22 @@ async function prerenderToStream(\n       // to cut the render off.\n       const cacheSignal = new CacheSignal()\n \n-      // The resume data cache here should use a fresh instance as it's\n-      // performing a fresh prerender. If we get to implementing the\n-      // prerendering of an already prerendered page, we should use the passed\n-      // resume data cache instead.\n-      const prerenderResumeDataCache = createPrerenderResumeDataCache()\n+      let resumeDataCache: RenderResumeDataCache | PrerenderResumeDataCache\n+      let renderResumeDataCache: RenderResumeDataCache | null = null\n+      let prerenderResumeDataCache: PrerenderResumeDataCache | null = null\n+\n+      if (renderOpts.renderResumeDataCache) {\n+        // If a prefilled immutable render resume data cache is provided, e.g.\n+        // when prerendering an optional fallback shell after having prerendered\n+        // pages with defined params, we use this instead of a prerender resume\n+        // data cache.\n+        resumeDataCache = renderResumeDataCache =\n+          renderOpts.renderResumeDataCache\n+      } else {\n+        // Otherwise we create a new mutable prerender resume data cache.\n+        resumeDataCache = prerenderResumeDataCache =\n+          createPrerenderResumeDataCache()\n+      }\n \n       const initialServerPrerenderStore: PrerenderStore = (prerenderStore = {\n         type: 'prerender',\n@@ -2889,6 +2911,7 @@ async function prerenderToStream(\n         stale: INFINITE_CACHE,\n         tags: [...implicitTags.tags],\n         prerenderResumeDataCache,\n+        renderResumeDataCache,\n         hmrRefreshHash: undefined,\n       })\n \n@@ -3011,6 +3034,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          renderResumeDataCache,\n           hmrRefreshHash: undefined,\n         }\n \n@@ -3096,6 +3120,7 @@ async function prerenderToStream(\n         stale: INFINITE_CACHE,\n         tags: [...implicitTags.tags],\n         prerenderResumeDataCache,\n+        renderResumeDataCache,\n         hmrRefreshHash: undefined,\n       })\n \n@@ -3166,6 +3191,7 @@ async function prerenderToStream(\n         stale: INFINITE_CACHE,\n         tags: [...implicitTags.tags],\n         prerenderResumeDataCache,\n+        renderResumeDataCache,\n         hmrRefreshHash: undefined,\n       }\n \n@@ -3267,13 +3293,12 @@ async function prerenderToStream(\n           metadata.postponed = await getDynamicHTMLPostponedState(\n             postponed,\n             fallbackRouteParams,\n-            prerenderResumeDataCache\n+            resumeDataCache\n           )\n         } else {\n           // Dynamic Data case\n-          metadata.postponed = await getDynamicDataPostponedState(\n-            prerenderResumeDataCache\n-          )\n+          metadata.postponed =\n+            await getDynamicDataPostponedState(resumeDataCache)\n         }\n         reactServerResult.consume()\n         return {\n@@ -3292,6 +3317,7 @@ async function prerenderToStream(\n           collectedExpire: finalServerPrerenderStore.expire,\n           collectedStale: selectStaleTime(finalServerPrerenderStore.stale),\n           collectedTags: finalServerPrerenderStore.tags,\n+          renderResumeDataCache: createRenderResumeDataCache(resumeDataCache),\n         }\n       } else {\n         // Static case\n@@ -3355,6 +3381,7 @@ async function prerenderToStream(\n           collectedExpire: finalServerPrerenderStore.expire,\n           collectedStale: selectStaleTime(finalServerPrerenderStore.stale),\n           collectedTags: finalServerPrerenderStore.tags,\n+          renderResumeDataCache: createRenderResumeDataCache(resumeDataCache),\n         }\n       }\n     } else if (experimental.isRoutePPREnabled) {"
        },
        {
            "sha": "6576aa39142447d067b9b8dbb8dc8bd43553ee0f",
            "filename": "packages/next/src/server/app-render/postponed-state.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fpostponed-state.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -62,14 +62,14 @@ export type PostponedState =\n export async function getDynamicHTMLPostponedState(\n   data: object,\n   fallbackRouteParams: FallbackRouteParams | null,\n-  prerenderResumeDataCache: PrerenderResumeDataCache\n+  resumeDataCache: PrerenderResumeDataCache | RenderResumeDataCache\n ): Promise<string> {\n   if (!fallbackRouteParams || fallbackRouteParams.size === 0) {\n     const postponedString = JSON.stringify(data)\n \n     // Serialized as `<postponedString.length>:<postponedString><renderResumeDataCache>`\n     return `${postponedString.length}:${postponedString}${await stringifyResumeDataCache(\n-      createRenderResumeDataCache(prerenderResumeDataCache)\n+      createRenderResumeDataCache(resumeDataCache)\n     )}`\n   }\n \n@@ -81,13 +81,13 @@ export async function getDynamicHTMLPostponedState(\n   const postponedString = `${replacementsString.length}${replacementsString}${dataString}`\n \n   // Serialized as `<postponedString.length>:<postponedString><renderResumeDataCache>`\n-  return `${postponedString.length}:${postponedString}${await stringifyResumeDataCache(prerenderResumeDataCache)}`\n+  return `${postponedString.length}:${postponedString}${await stringifyResumeDataCache(resumeDataCache)}`\n }\n \n export async function getDynamicDataPostponedState(\n-  prerenderResumeDataCache: PrerenderResumeDataCache\n+  resumeDataCache: PrerenderResumeDataCache | RenderResumeDataCache\n ): Promise<string> {\n-  return `4:null${await stringifyResumeDataCache(createRenderResumeDataCache(prerenderResumeDataCache))}`\n+  return `4:null${await stringifyResumeDataCache(createRenderResumeDataCache(resumeDataCache))}`\n }\n \n export function parsePostponedState("
        },
        {
            "sha": "95737918aa6e418f1f4abf72f3c2d59d8f2e1c91",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -250,10 +250,11 @@ export interface RenderOptsPartial {\n   shouldWaitOnAllReady?: boolean\n \n   /**\n-   * The resume data cache that was generated for this partially prerendered\n-   * page during dev warmup.\n+   * A prefilled resume data cache. This was either generated for this page\n+   * during dev warmup, or when a page with defined params was previously\n+   * prerendered, and now its matching optional fallback shell is prerendered.\n    */\n-  devRenderResumeDataCache?: RenderResumeDataCache\n+  renderResumeDataCache?: RenderResumeDataCache\n \n   /**\n    * When true, the page will be rendered using the static rendering to detect"
        },
        {
            "sha": "fcd89c493f6d1b3b7d78b04f70a93f32baa709b5",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 14,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -116,10 +116,18 @@ export interface PrerenderStoreModern extends CommonWorkUnitStore {\n   tags: null | string[]\n \n   /**\n-   * The resume data cache for this prerender.\n+   * A mutable resume data cache for this prerender.\n    */\n   prerenderResumeDataCache: PrerenderResumeDataCache | null\n \n+  /**\n+   * An immutable resume data cache for this prerender. This may be provided\n+   * instead of the `prerenderResumeDataCache` if the prerender is not supposed\n+   * to fill caches, and only read from prefilled caches, e.g. when prerendering\n+   * an optional fallback shell.\n+   */\n+  renderResumeDataCache: RenderResumeDataCache | null\n+\n   /**\n    * The HMR refresh hash is only provided in dev mode. It is needed for the dev\n    * warmup render to ensure that the cache keys will be identical for the\n@@ -272,21 +280,24 @@ export function getPrerenderResumeDataCache(\n export function getRenderResumeDataCache(\n   workUnitStore: WorkUnitStore\n ): RenderResumeDataCache | null {\n-  if (\n-    workUnitStore.type !== 'prerender-legacy' &&\n-    workUnitStore.type !== 'cache' &&\n-    workUnitStore.type !== 'unstable-cache'\n-  ) {\n-    if (workUnitStore.type === 'request') {\n+  switch (workUnitStore.type) {\n+    case 'request':\n       return workUnitStore.renderResumeDataCache\n-    }\n-\n-    // We return the mutable resume data cache here as an immutable version of\n-    // the cache as it can also be used for reading.\n-    return workUnitStore.prerenderResumeDataCache\n+    case 'prerender':\n+    case 'prerender-client':\n+      if (workUnitStore.renderResumeDataCache) {\n+        // If we are in a prerender, we might have a render resume data cache\n+        // that is used to read from prefilled caches.\n+        return workUnitStore.renderResumeDataCache\n+      }\n+    // fallthrough\n+    case 'prerender-ppr':\n+      // Otherwise we return the mutable resume data cache here as an immutable\n+      // version of the cache as it can also be used for reading.\n+      return workUnitStore.prerenderResumeDataCache\n+    default:\n+      return null\n   }\n-\n-  return null\n }\n \n export function getHmrRefreshHash("
        },
        {
            "sha": "2765ea2fafcd6a120dc56d9c442ab01165d1b56f",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -2774,9 +2774,9 @@ export default abstract class Server<\n \n                 // If the warmup is successful, we should use the resume data\n                 // cache from the warmup.\n-                if (warmup.metadata.devRenderResumeDataCache) {\n-                  renderOpts.devRenderResumeDataCache =\n-                    warmup.metadata.devRenderResumeDataCache\n+                if (warmup.metadata.renderResumeDataCache) {\n+                  renderOpts.renderResumeDataCache =\n+                    warmup.metadata.renderResumeDataCache\n                 }\n               }\n "
        },
        {
            "sha": "e12210255fa95f76cd55899fad3e255aa57df278",
            "filename": "packages/next/src/server/render-result.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -38,10 +38,12 @@ export type AppPageRenderResultMetadata = {\n   segmentData?: Map<string, Buffer>\n \n   /**\n-   * In development, the cache is warmed up before the render. This is attached\n-   * to the metadata so that it can be used during the render.\n+   * In development, the resume data cache is warmed up before the render. This\n+   * is attached to the metadata so that it can be used during the render. When\n+   * prerendering, the filled resume data cache is also attached to the metadata\n+   * so that it can be used when prerendering matching fallback shells.\n    */\n-  devRenderResumeDataCache?: RenderResumeDataCache\n+  renderResumeDataCache?: RenderResumeDataCache\n }\n \n export type PagesRenderResultMetadata = {"
        },
        {
            "sha": "56787ed654e3715782991c2726cb2015ad4c3ddc",
            "filename": "packages/next/src/server/resume-data-cache/resume-data-cache.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fresume-data-cache%2Fresume-data-cache.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -157,31 +157,38 @@ export function createPrerenderResumeDataCache(): PrerenderResumeDataCache {\n  * 1. An existing prerender cache instance\n  * 2. A serialized cache string\n  *\n+ * @param renderResumeDataCache - A RenderResumeDataCache instance to be used directly\n  * @param prerenderResumeDataCache - A PrerenderResumeDataCache instance to convert to immutable\n  * @param persistedCache - A serialized cache string to parse\n  * @returns An immutable RenderResumeDataCache instance\n  */\n+export function createRenderResumeDataCache(\n+  renderResumeDataCache: RenderResumeDataCache\n+): RenderResumeDataCache\n export function createRenderResumeDataCache(\n   prerenderResumeDataCache: PrerenderResumeDataCache\n ): RenderResumeDataCache\n export function createRenderResumeDataCache(\n   persistedCache: string\n ): RenderResumeDataCache\n export function createRenderResumeDataCache(\n-  prerenderResumeDataCacheOrPersistedCache: PrerenderResumeDataCache | string\n+  resumeDataCacheOrPersistedCache:\n+    | RenderResumeDataCache\n+    | PrerenderResumeDataCache\n+    | string\n ): RenderResumeDataCache {\n   if (process.env.NEXT_RUNTIME === 'edge') {\n     throw new InvariantError(\n       '`createRenderResumeDataCache` should not be called in edge runtime.'\n     )\n   } else {\n-    if (typeof prerenderResumeDataCacheOrPersistedCache !== 'string') {\n-      // If the cache is already a prerender cache, we can return it directly,\n-      // we're just performing a type change.\n-      return prerenderResumeDataCacheOrPersistedCache\n+    if (typeof resumeDataCacheOrPersistedCache !== 'string') {\n+      // If the cache is already a prerender or render cache, we can return it\n+      // directly. For the former, we're just performing a type change.\n+      return resumeDataCacheOrPersistedCache\n     }\n \n-    if (prerenderResumeDataCacheOrPersistedCache === 'null') {\n+    if (resumeDataCacheOrPersistedCache === 'null') {\n       return {\n         cache: new Map(),\n         fetch: new Map(),\n@@ -197,7 +204,7 @@ export function createRenderResumeDataCache(\n \n     const json: ResumeStoreSerialized = JSON.parse(\n       inflateSync(\n-        Buffer.from(prerenderResumeDataCacheOrPersistedCache, 'base64')\n+        Buffer.from(resumeDataCacheOrPersistedCache, 'base64')\n       ).toString('utf-8')\n     )\n "
        },
        {
            "sha": "dcbf40334dcff51a008a4f48dc883271915c9cb5",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -395,7 +395,9 @@ export class AppRouteRouteModule extends RouteModule<\n               expire: INFINITE_CACHE,\n               stale: INFINITE_CACHE,\n               tags: [...implicitTags.tags],\n+              // TODO: Shouldn't we provide an RDC here?\n               prerenderResumeDataCache: null,\n+              renderResumeDataCache: null,\n               hmrRefreshHash: undefined,\n             })\n \n@@ -483,7 +485,9 @@ export class AppRouteRouteModule extends RouteModule<\n             expire: INFINITE_CACHE,\n             stale: INFINITE_CACHE,\n             tags: [...implicitTags.tags],\n+            // TODO: Shouldn't we provide an RDC here?\n             prerenderResumeDataCache: null,\n+            renderResumeDataCache: null,\n             hmrRefreshHash: undefined,\n           })\n "
        },
        {
            "sha": "c224b77b4586782a39e549ac4b9f3199b89a7e8a",
            "filename": "test/e2e/app-dir/fallback-shells/app/with-cached-io/with-suspense/layout.jsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Flayout.jsx?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -7,8 +7,8 @@ export default async function Layout({ children }) {\n   return (\n     <html>\n       <body>\n-        <div id=\"layout\">\n-          Layout: {new Date().toISOString()} ({getSentinelValue()})\n+        <div id=\"root-layout\">\n+          Root Layout: {new Date().toISOString()} ({getSentinelValue()})\n         </div>\n         <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n       </body>"
        },
        {
            "sha": "77515816b1c27f7fb04da274b043841fd4985fb4",
            "filename": "test/e2e/app-dir/fallback-shells/app/with-cached-io/with-suspense/params-in-page/[slug]/layout.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Fparams-in-page%2F%5Bslug%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Fparams-in-page%2F%5Bslug%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwith-suspense%2Fparams-in-page%2F%5Bslug%5D%2Flayout.tsx?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -0,0 +1,19 @@\n+'use cache'\n+\n+import { getSentinelValue } from '../../../sentinel'\n+\n+export default async function Layout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <div>\n+      <p>This layout is explicitly not reading params.</p>\n+      <div id=\"layout\">\n+        Layout: {new Date().toISOString()} ({getSentinelValue()})\n+      </div>\n+      <div>{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "030f333e73a7c669aad2220d7f18a3fde3239ed5",
            "filename": "test/e2e/app-dir/fallback-shells/app/with-cached-io/without-suspense/layout.jsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwithout-suspense%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwithout-suspense%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Fapp%2Fwith-cached-io%2Fwithout-suspense%2Flayout.jsx?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -6,8 +6,8 @@ export default async function Layout({ children }) {\n   return (\n     <html>\n       <body>\n-        <div id=\"layout\">\n-          Layout: {new Date().toISOString()} ({getSentinelValue()})\n+        <div id=\"root-layout\">\n+          Root Layout: {new Date().toISOString()} ({getSentinelValue()})\n         </div>\n         {children}\n       </body>"
        },
        {
            "sha": "337822ca197efdc40164f31898d7e31d908de68a",
            "filename": "test/e2e/app-dir/fallback-shells/fallback-shells.test.ts",
            "status": "modified",
            "additions": 99,
            "deletions": 7,
            "changes": 106,
            "blob_url": "https://github.com/vercel/next.js/blob/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Ffallback-shells.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c95fefdacdeed440893273d34f956fb8d36e8f8/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Ffallback-shells.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffallback-shells%2Ffallback-shells.test.ts?ref=2c95fefdacdeed440893273d34f956fb8d36e8f8",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { assertNoConsoleErrors } from 'next-test-utils'\n \n describe('fallback-shells', () => {\n   const { next, isNextDev, isNextDeploy, isNextStart } = nextTestSetup({\n@@ -28,14 +29,15 @@ describe('fallback-shells', () => {\n       describe('and the params accessed in the cached page', () => {\n         it('resumes a postponed fallback shell', async () => {\n           const { browser, response } = await next.browserWithResponse(\n-            '/with-cached-io/with-suspense/params-in-page/bar'\n+            '/with-cached-io/with-suspense/params-in-page/bar',\n+            { pushErrorAsConsoleLog: true }\n           )\n \n           const lastModified = await browser.elementById('last-modified').text()\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude(isNextDev ? 'runtime' : 'buildtime')\n \n           const headers = response.headers()\n@@ -48,6 +50,96 @@ describe('fallback-shells', () => {\n             expect(headers['x-nextjs-postponed']).toBe('1')\n           }\n         })\n+\n+        // TODO: To be implemented in NAR-136.\n+        it.skip('does not produce hydration errors when resuming a fallback shell containing a layout with unused params', async () => {\n+          const browser = await next.browser(\n+            '/with-cached-io/with-suspense/params-in-page/bar',\n+            { pushErrorAsConsoleLog: true }\n+          )\n+\n+          const layout = await browser.elementById('layout').text()\n+\n+          // When prerendered, this should be restored from the RDC during the\n+          // resume of the fallback shell, so it should be \"buildtime\". If the\n+          // layout is unexpectedly a cache miss, then it will be \"runtime\".\n+          expect(layout).toInclude(isNextDev ? 'runtime' : 'buildtime')\n+\n+          // There should also be no hydration errors due to a buildtime date\n+          // being replaced by a new runtime date.\n+          await assertNoConsoleErrors(browser)\n+        })\n+\n+        // TODO: Activate for deploy tests once background revalidation for\n+        // prerendered pages is not triggered anymore on the first visit.\n+        if (!isNextDeploy) {\n+          it('shares a cached parent layout between a prerendered route shell and the fallback shell', async () => {\n+            // `/foo` was prerendered\n+            const browser = await next.browser(\n+              '/with-cached-io/with-suspense/params-in-page/foo'\n+            )\n+\n+            const layoutDateRouteShell = await browser\n+              .elementById('root-layout')\n+              .text()\n+\n+            expect(layoutDateRouteShell).toInclude(\n+              isNextDev ? 'runtime' : 'buildtime'\n+            )\n+\n+            // `/bar` was not prerendered, and thus resumes the fallback shell.\n+            await browser.loadPage(\n+              new URL(\n+                '/with-cached-io/with-suspense/params-in-page/bar',\n+                next.url\n+              ).href\n+            )\n+\n+            const layoutDateFallbackShell = await browser\n+              .elementById('root-layout')\n+              .text()\n+\n+            expect(layoutDateRouteShell).toInclude(\n+              isNextDev ? 'runtime' : 'buildtime'\n+            )\n+\n+            expect(layoutDateFallbackShell).toBe(layoutDateRouteShell)\n+          })\n+\n+          // TODO: To be implemented in NAR-136.\n+          it.skip('shares a cached layout with unused params between a prerendered route shell and the fallback shell', async () => {\n+            // `/foo` was prerendered\n+            const browser = await next.browser(\n+              '/with-cached-io/with-suspense/params-in-page/foo'\n+            )\n+\n+            const layoutDateRouteShell = await browser\n+              .elementById('layout')\n+              .text()\n+\n+            expect(layoutDateRouteShell).toInclude(\n+              isNextDev ? 'runtime' : 'buildtime'\n+            )\n+\n+            // `/bar` was not prerendered, and thus resumes the fallback shell.\n+            await browser.loadPage(\n+              new URL(\n+                '/with-cached-io/with-suspense/params-in-page/bar',\n+                next.url\n+              ).href\n+            )\n+\n+            const layoutDateFallbackShell = await browser\n+              .elementById('layout')\n+              .text()\n+\n+            expect(layoutDateRouteShell).toInclude(\n+              isNextDev ? 'runtime' : 'buildtime'\n+            )\n+\n+            expect(layoutDateFallbackShell).toBe(layoutDateRouteShell)\n+          })\n+        }\n       })\n \n       describe('and the params accessed in cached non-page function', () => {\n@@ -60,7 +152,7 @@ describe('fallback-shells', () => {\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude(isNextDev ? 'runtime' : 'buildtime')\n \n           const headers = response.headers()\n@@ -85,7 +177,7 @@ describe('fallback-shells', () => {\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude(isNextDev ? 'runtime' : 'buildtime')\n \n           const headers = response.headers()\n@@ -112,7 +204,7 @@ describe('fallback-shells', () => {\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude('runtime')\n \n           const headers = response.headers()\n@@ -154,7 +246,7 @@ describe('fallback-shells', () => {\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude('runtime')\n \n           const headers = response.headers()\n@@ -179,7 +271,7 @@ describe('fallback-shells', () => {\n           expect(lastModified).toInclude('Page /bar')\n           expect(lastModified).toInclude('runtime')\n \n-          const layout = await browser.elementById('layout').text()\n+          const layout = await browser.elementById('root-layout').text()\n           expect(layout).toInclude('runtime')\n \n           const headers = response.headers()"
        }
    ],
    "stats": {
        "total": 343,
        "additions": 272,
        "deletions": 71
    }
}