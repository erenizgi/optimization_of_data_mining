{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in pages/ service-side-dev-errors (#76779)",
    "sha": "5d53fd00fb8cf183c8bc20090b09aa46abe29330",
    "files": [
        {
            "sha": "8151d9866255ab11e413aa3231779b9fb0294e98",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 219,
            "deletions": 15,
            "changes": 234,
            "blob_url": "https://github.com/vercel/next.js/blob/5d53fd00fb8cf183c8bc20090b09aa46abe29330/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5d53fd00fb8cf183c8bc20090b09aa46abe29330/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=5d53fd00fb8cf183c8bc20090b09aa46abe29330",
            "patch": "@@ -4,12 +4,10 @@ import fs from 'fs/promises'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n import {\n-  assertHasRedbox,\n   killApp,\n   findPort,\n   launchApp,\n   retry,\n-  getRedboxSource,\n   assertNoRedbox,\n } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n@@ -87,9 +85,38 @@ describe('server-side dev errors', () => {\n           '\\n> 6 |   missingVar;return {'\n       )\n \n-      await assertHasRedbox(browser)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/gsp.js (6:3) @ getStaticProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getStaticProps ../../test/integration/server-side-dev-errors/pages/gsp.js (6:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/gsp.js (6:3) @ getStaticProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getStaticProps pages/gsp.js (6:3)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain('missingVar')\n       await fs.writeFile(gspPage, content, { flush: true })\n       await assertNoRedbox(browser)\n     } finally {\n@@ -137,9 +164,38 @@ describe('server-side dev errors', () => {\n           '\\n> 6 |   missingVar;return {'\n       )\n \n-      await assertHasRedbox(browser)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/gssp.js (6:3) @ getServerSideProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getServerSideProps ../../test/integration/server-side-dev-errors/pages/gssp.js (6:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/gssp.js (6:3) @ getServerSideProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getServerSideProps pages/gssp.js (6:3)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain('missingVar')\n       await fs.writeFile(gsspPage, content)\n       await assertNoRedbox(browser)\n     } finally {\n@@ -187,11 +243,39 @@ describe('server-side dev errors', () => {\n           '\\n> 6 |   missingVar;return {'\n       )\n \n-      await assertHasRedbox(browser)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/blog/[slug].js (6:3) @ getServerSideProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getServerSideProps ../../test/integration/server-side-dev-errors/pages/blog/[slug].js (6:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/blog/[slug].js (6:3) @ getServerSideProps\n+         > 6 |   missingVar;return {\n+             |   ^\",\n+           \"stack\": [\n+             \"getServerSideProps pages/blog/[slug].js (6:3)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain('missingVar')\n       await fs.writeFile(dynamicGsspPage, content)\n-      await assertHasRedbox(browser)\n     } finally {\n       await fs.writeFile(dynamicGsspPage, content)\n     }\n@@ -237,11 +321,71 @@ describe('server-side dev errors', () => {\n           \"\\n> 2 |   missingVar;res.status(200).json({ hello: 'world' })\"\n       )\n \n-      await assertHasRedbox(browser)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler ../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/api/hello.js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler pages/api/hello.js (2:3)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain('missingVar')\n       await fs.writeFile(apiPage, content)\n-      await assertHasRedbox(browser)\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler ../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/api/hello.js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler pages/api/hello.js (2:3)\",\n+           ],\n+         }\n+        `)\n+      }\n     } finally {\n       await fs.writeFile(apiPage, content)\n     }\n@@ -289,11 +433,71 @@ describe('server-side dev errors', () => {\n           '\\n> 2 |   missingVar;res.status(200).json({ slug: req.query.slug })'\n       )\n \n-      await assertHasRedbox(browser)\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler ../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler pages/api/blog/[slug].js (2:3)\",\n+           ],\n+         }\n+        `)\n+      }\n \n-      expect(await getRedboxSource(browser)).toContain('missingVar')\n       await fs.writeFile(dynamicApiPage, content)\n-      await assertHasRedbox(browser)\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler ../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: missingVar is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n+         > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n+             |   ^\",\n+           \"stack\": [\n+             \"handler pages/api/blog/[slug].js (2:3)\",\n+           ],\n+         }\n+        `)\n+      }\n     } finally {\n       await fs.writeFile(dynamicApiPage, content)\n     }"
        }
    ],
    "stats": {
        "total": 234,
        "additions": 219,
        "deletions": 15
    }
}