{
    "author": "lukesandberg",
    "message": "[turbopack] Install late loaded script and link tags at the end of the `head` instead of the end of the `body` (#81425)\n\n### What?\nAppend CSS and JS chunks to `document.head` instead of `document.body` in the Turbopack runtime.\n\n### Why?\nThis change improves webpack compatibility by ensuring that dynamically loaded CSS and JS resources are appended to the document head rather than the body, matching webpack's behavior.   We don't believe this should have a performance or behavior impact, however aligning with webpack should eliminate rare incompatibilities with applications that might be confused by the presence of these script tags in the body.\n\nOne delta with webpack does remain, webpack removes the added script tags from the DOM after they load apparently to workaround a memory leak in IE.  We are not bothering with this.\n\nSee also: https://github.com/webpack/webpack/blob/a11302288d2a8851ff89405a122c1d04709574ea/lib/runtime/LoadScriptRuntimeModule.js#L167",
    "sha": "bab62242883150c5267fae8a2c42535374c11911",
    "files": [
        {
            "sha": "dd6b22db681acfc1318d04d59b449d5c16867660",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/js/src/browser/runtime/dom/runtime-backend-dom.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fdom%2Fruntime-backend-dom.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fdom%2Fruntime-backend-dom.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fdom%2Fruntime-backend-dom.ts?ref=bab62242883150c5267fae8a2c42535374c11911",
            "patch": "@@ -187,7 +187,8 @@ const chunkResolvers: Map<ChunkUrl, ChunkResolver> = new Map()\n             // loaded instantly.\n             resolver.resolve()\n           }\n-          document.body.appendChild(link)\n+          // Append to the `head` for webpack compatibility.\n+          document.head.appendChild(link)\n         }\n       } else if (isJs(chunkUrl)) {\n         const previousScripts = document.querySelectorAll(\n@@ -210,7 +211,8 @@ const chunkResolvers: Map<ChunkUrl, ChunkResolver> = new Map()\n           script.onerror = () => {\n             resolver.reject()\n           }\n-          document.body.appendChild(script)\n+          // Append to the `head` for webpack compatibility.\n+          document.head.appendChild(script)\n         }\n       } else {\n         throw new Error(`can't infer type of chunk from URL ${chunkUrl}`)"
        },
        {
            "sha": "803ac46effc51942610cc405b0902524989ae5e3",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js?ref=bab62242883150c5267fae8a2c42535374c11911",
            "patch": "@@ -1602,7 +1602,8 @@ async function loadWebAssemblyModule(_source, wasmChunkPath, _edgeModule) {\n                         // loaded instantly.\n                         resolver.resolve();\n                     };\n-                    document.body.appendChild(link);\n+                    // Append to the `head` for webpack compatibility.\n+                    document.head.appendChild(link);\n                 }\n             } else if (isJs(chunkUrl)) {\n                 const previousScripts = document.querySelectorAll(`script[src=\"${chunkUrl}\"],script[src^=\"${chunkUrl}?\"],script[src=\"${decodedChunkUrl}\"],script[src^=\"${decodedChunkUrl}?\"]`);\n@@ -1623,7 +1624,8 @@ async function loadWebAssemblyModule(_source, wasmChunkPath, _edgeModule) {\n                     script.onerror = ()=>{\n                         resolver.reject();\n                     };\n-                    document.body.appendChild(script);\n+                    // Append to the `head` for webpack compatibility.\n+                    document.head.appendChild(script);\n                 }\n             } else {\n                 throw new Error(`can't infer type of chunk from URL ${chunkUrl}`);"
        },
        {
            "sha": "4e5da9724f3a94bd8f5ef2145e86d0d8b3f4dbe2",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js.map",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/bab62242883150c5267fae8a2c42535374c11911/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_73aab4ae.js.map?ref=bab62242883150c5267fae8a2c42535374c11911"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 10,
        "deletions": 6
    }
}