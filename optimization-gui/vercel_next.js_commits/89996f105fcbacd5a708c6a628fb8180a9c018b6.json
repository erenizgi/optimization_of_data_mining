{
    "author": "wyattjoh",
    "message": "refactor: handle null RenderResult responses gracefully (#81895)\n\n### What?\n- Removed unused `toUnchunkedBuffer` method from RenderResult\n- Changed null response handling to return empty values instead of\nthrowing errors\n\n### Why?\nThe codebase now provides `RenderResult.EMPTY` for null responses,\nmaking it a valid state rather than an error condition. This change\nensures consistent behavior across the rendering pipeline when dealing\nwith empty responses.\n\n### How?\n- Modified `toUnchunkedString()` to return empty string for null\nresponses\n- Updated `coerce()` to return empty array for null responses  \n- Fixed `chainStreams()` to return an empty stream when no streams are\nprovided\n- Removed dead code that was no longer used\n\nThis refactor improves error handling and simplifies the stream\nprocessing logic by treating empty/null responses as valid states.",
    "sha": "89996f105fcbacd5a708c6a628fb8180a9c018b6",
    "files": [
        {
            "sha": "e5a635b1ed25154c525594ac66031ab3322e9664",
            "filename": "packages/next/src/server/render-result.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 23,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/89996f105fcbacd5a708c6a628fb8180a9c018b6/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/89996f105fcbacd5a708c6a628fb8180a9c018b6/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender-result.ts?ref=89996f105fcbacd5a708c6a628fb8180a9c018b6",
            "patch": "@@ -6,7 +6,6 @@ import {\n   chainStreams,\n   streamFromBuffer,\n   streamFromString,\n-  streamToBuffer,\n   streamToString,\n } from './stream-utils/node-web-streams-helper'\n import { isAbortError, pipeToNodeResponse } from './pipe-readable'\n@@ -167,26 +166,6 @@ export default class RenderResult<\n     return typeof this.response !== 'string'\n   }\n \n-  public toUnchunkedBuffer(stream?: false): Buffer\n-  public toUnchunkedBuffer(stream: true): Promise<Buffer>\n-  public toUnchunkedBuffer(stream = false): Promise<Buffer> | Buffer {\n-    if (this.response === null) {\n-      throw new InvariantError('null responses cannot be unchunked')\n-    }\n-\n-    if (typeof this.response !== 'string') {\n-      if (!stream) {\n-        throw new InvariantError(\n-          'dynamic responses cannot be unchunked. This is a bug in Next.js'\n-        )\n-      }\n-\n-      return streamToBuffer(this.readable)\n-    }\n-\n-    return Buffer.from(this.response)\n-  }\n-\n   /**\n    * Returns the response if it is a string. If the page was dynamic, this will\n    * return a promise if the `stream` option is true, or it will throw an error.\n@@ -198,7 +177,9 @@ export default class RenderResult<\n   public toUnchunkedString(stream: true): Promise<string>\n   public toUnchunkedString(stream = false): Promise<string> | string {\n     if (this.response === null) {\n-      throw new InvariantError('null responses cannot be unchunked')\n+      // If the response is null, return an empty string. This behavior is\n+      // intentional as we're now providing the `RenderResult.EMPTY` value.\n+      return ''\n     }\n \n     if (typeof this.response !== 'string') {\n@@ -252,7 +233,9 @@ export default class RenderResult<\n    */\n   private coerce(): ReadableStream<Uint8Array>[] {\n     if (this.response === null) {\n-      throw new Error('Invariant: response is null. This is a bug in Next.js')\n+      // If the response is null, return an empty stream. This behavior is\n+      // intentional as we're now providing the `RenderResult.EMPTY` value.\n+      return []\n     }\n \n     if (typeof this.response === 'string') {"
        },
        {
            "sha": "fd8687c99c67d2f002691a04d749ecc09ce3ff8f",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/89996f105fcbacd5a708c6a628fb8180a9c018b6/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/89996f105fcbacd5a708c6a628fb8180a9c018b6/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=89996f105fcbacd5a708c6a628fb8180a9c018b6",
            "patch": "@@ -10,7 +10,6 @@ import {\n } from './uint8array-helpers'\n import { MISSING_ROOT_TAGS_ERROR } from '../../shared/lib/errors/constants'\n import { insertBuildIdComment } from '../../shared/lib/segment-cache/output-export-prefetch-encoding'\n-import { InvariantError } from '../../shared/lib/invariant-error'\n \n function voidCatch() {\n   // this catcher is designed to be used with pipeTo where we expect the underlying\n@@ -30,10 +29,14 @@ const encoder = new TextEncoder()\n export function chainStreams<T>(\n   ...streams: ReadableStream<T>[]\n ): ReadableStream<T> {\n-  // We could encode this invariant in the arguments but current uses of this function pass\n-  // use spread so it would be missed by\n+  // If we have no streams, return an empty stream. This behavior is\n+  // intentional as we're now providing the `RenderResult.EMPTY` value.\n   if (streams.length === 0) {\n-    throw new InvariantError('chainStreams requires at least one stream')\n+    return new ReadableStream<T>({\n+      start(controller) {\n+        controller.close()\n+      },\n+    })\n   }\n \n   // If we only have 1 stream we fast path it by returning just this stream"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 13,
        "deletions": 27
    }
}