{
    "author": "timneutkens",
    "message": "Development: Clarify TypescriptStatus in watcher (#83857)\n\n## What?\n\nMakes it easier to reason about given there's only one variable to keep\ntrack off instead of `usingTypeScript` vs `enabledTypeScript`.",
    "sha": "f982260248c149d3b43ee87105b11e30b11e0b70",
    "files": [
        {
            "sha": "20814a4e3ca2a3fd116a632486f570d288880848",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f982260248c149d3b43ee87105b11e30b11e0b70/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f982260248c149d3b43ee87105b11e30b11e0b70/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=f982260248c149d3b43ee87105b11e30b11e0b70",
            "patch": "@@ -133,7 +133,6 @@ export type ServerFields = {\n }\n \n async function verifyTypeScript(opts: SetupOpts) {\n-  let usingTypeScript = false\n   const verifyResult = await verifyTypeScriptSetup({\n     dir: opts.dir,\n     distDir: opts.nextConfig.distDir,\n@@ -146,9 +145,9 @@ async function verifyTypeScript(opts: SetupOpts) {\n   })\n \n   if (verifyResult.version) {\n-    usingTypeScript = true\n+    return true\n   }\n-  return usingTypeScript\n+  return false\n }\n \n export async function propagateServerField(\n@@ -242,8 +241,6 @@ async function startWatcher(\n     opts.nextConfig\n   )\n \n-  const usingTypeScript = await verifyTypeScript(opts)\n-\n   const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n   const routesManifest: DevRoutesManifest = {\n     version: 3,\n@@ -348,14 +345,15 @@ async function startWatcher(\n       },\n     })\n     const fileWatchTimes = new Map()\n-    let enabledTypeScript = usingTypeScript\n+    let enabledTypeScript = await verifyTypeScript(opts)\n     let previousClientRouterFilters: any\n     let previousConflictingPagePaths: Set<string> = new Set()\n \n     const routeTypesFilePath = path.join(distDir, 'types', 'routes.d.ts')\n     const validatorFilePath = path.join(distDir, 'types', 'validator.ts')\n \n     wp.on('aggregated', async () => {\n+      let typescriptStatusFromLastAggregation = enabledTypeScript\n       let middlewareMatchers: MiddlewareMatcher[] | undefined\n       const routedPages: string[] = []\n       const knownFiles = wp.getTimeInfoEntries()\n@@ -728,7 +726,8 @@ async function startWatcher(\n         }\n       }\n \n-      if (!usingTypeScript && enabledTypeScript) {\n+      // Using === false to make the check clearer.\n+      if (typescriptStatusFromLastAggregation === false && enabledTypeScript) {\n         // we tolerate the error here as this is best effort\n         // and the manual install command will be shown\n         await verifyTypeScript(opts)\n@@ -753,7 +752,7 @@ async function startWatcher(\n             }\n           )\n \n-          if (usingTypeScript && nextConfig.experimental?.typedEnv) {\n+          if (enabledTypeScript && nextConfig.experimental?.typedEnv) {\n             // do not await, this is not essential for further process\n             createEnvDefinitions({\n               distDir,\n@@ -1091,7 +1090,7 @@ async function startWatcher(\n         }\n         prevSortedRoutes = sortedRoutes\n \n-        if (usingTypeScript) {\n+        if (enabledTypeScript) {\n           const routeTypesManifest = await createRouteTypesManifest({\n             dir,\n             pageRoutes,"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 8,
        "deletions": 9
    }
}