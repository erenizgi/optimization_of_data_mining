{
    "author": "acdlite",
    "message": "[Fix] Inverse prefetch segment for Pages routes (#78932)\n\nAnother follow-up to https://github.com/vercel/next.js/pull/78387 and\nhttps://github.com/vercel/next.js/pull/78568. Refer to those PRs for\nfull details.\n\nFixes a routing conflict related to per-segment prefetches in sites that\nuse both App Router and Pages Router.\n\nThe fix is to expand the behavior added in the previous PRs â€” we output\nan \"inverse\" tree prefetch route for every route in the route manifest\nthat is not PPR-enabled, including ones defined by Pages Router.\n\n---------\n\nCo-authored-by: Wyatt Johnson <accounts+github@wyattjoh.ca>",
    "sha": "9f4a7f03b3e23d187eaea59c1cebea183920a928",
    "files": [
        {
            "sha": "917818eed19f47512ff68f7b4c4f19188ac839f4",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 17,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -3557,18 +3557,11 @@ export default async function build(\n               ...routesManifest.staticRoutes,\n               ...routesManifest.dynamicRoutes,\n             ]) {\n-              // We only want to handle pages that are using the app router. We\n-              // need this path in order to determine if it's an app route or an\n-              // app page.\n-              const originalAppPath = pageInfos.get(route.page)?.originalAppPath\n-              if (!originalAppPath) {\n-                continue\n-              }\n-\n-              // We only want to handle app pages, not app routes.\n-              if (isAppRouteRoute(originalAppPath)) {\n-                continue\n-              }\n+              // If the segment paths aren't defined, we need to insert a\n+              // reverse routing rule so that there isn't any conflicts\n+              // with other dynamic routes for the prefetch segment\n+              // routes. This is true for any route that is not PPR-enabled,\n+              // including all routes defined by Pages Router.\n \n               // We don't need to add the prefetch segment data routes if it was\n               // added due to a page that was already generated. This would have\n@@ -3577,11 +3570,6 @@ export default async function build(\n                 continue\n               }\n \n-              // If the segment paths aren't defined, we need to insert a\n-              // reverse routing rule so that there isn't any conflicts\n-              // with other dynamic routes for the prefetch segment\n-              // routes. This is only an issue for pages that do not have\n-              // partial prerendering enabled.\n               route.prefetchSegmentDataRoutes = [\n                 buildInversePrefetchSegmentDataRoute(\n                   route.page,"
        },
        {
            "sha": "803f17d863c8ad887c14588aab3487e473367b41",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/new/[teamSlug]/layout.jsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Flayout.jsx?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "72ece76bc537927ef8c7fcc3f138c0a5c5cb3704",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/new/[teamSlug]/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fnew%2F%5BteamSlug%5D%2Fpage.tsx?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return '/new/[teamSlug]/page.tsx'\n+}"
        },
        {
            "sha": "3f2056b2dd8274121bd1399570b4b9d3abc1e499",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 6,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -32,12 +32,6 @@ describe('conflicting routes', () => {\n   })\n \n   it('matches the right route when the original route has no dynamic params, is dynamic, and PPR is disabled', async () => {\n-    if (isNextDeploy) {\n-      // TODO: Temporarily disabled until corresponding fix in Vercel builder\n-      // (https://github.com/vercel/vercel/pull/13275) is released.\n-      return\n-    }\n-\n     const res = await next.fetch('/prefetch-tests/dynamic', {\n       headers: {\n         RSC: '1',\n@@ -54,4 +48,31 @@ describe('conflicting routes', () => {\n       )\n     }\n   })\n+\n+  it('handles conflict between App Router and Pages Router routes', async () => {\n+    const res = await next.fetch('/new/templates', {\n+      headers: {\n+        RSC: '1',\n+        'Next-Router-Prefetch': '1',\n+        'Next-Router-Segment-Prefetch': '/_tree',\n+      },\n+    })\n+\n+    // Should match the route defined at pages/new/templates/[[...slug]].js,\n+    // not the one at app/new/[teamSlug]/page.tsx\n+    if (isNextDeploy) {\n+      // In a deployed environment the builder routes this to the .prefetch.rsc\n+      // route, which doesn't exist, so it returns a 404.\n+      // TODO: It'd probably be more correct if it didn't re-route to\n+      // .prefetch.rsc and just routed to the normal Pages route. This would\n+      // match the behavior in server mode. This only happens when the\n+      // prefetch header is present, though, so the only observable effect right\n+      // now is that it shows up as a 404 in the network panel. Either way, the\n+      // page can't be prefetched by App Router because it's a Pages route.\n+      expect(res.status).toBe(404)\n+    } else {\n+      expect(res.status).toBe(200)\n+      expect(await res.text()).toContain('/new/templates/[[...slug]].js')\n+    }\n+  })\n })"
        },
        {
            "sha": "cf06318a0f30ff6c1107cb7644cef92a9efe9f66",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/pages/_app.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_app.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_app.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_app.js?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -0,0 +1,3 @@\n+export default function App({ Component, pageProps }) {\n+  return <Component {...pageProps} />\n+}"
        },
        {
            "sha": "54e8bf3e2a29015a45e11cdc279e06b459890d8b",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/pages/_document.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_document.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_document.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2F_document.js?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -0,0 +1,13 @@\n+import { Html, Head, Main, NextScript } from 'next/document'\n+\n+export default function Document() {\n+  return (\n+    <Html lang=\"en\">\n+      <Head />\n+      <body>\n+        <Main />\n+        <NextScript />\n+      </body>\n+    </Html>\n+  )\n+}"
        },
        {
            "sha": "acad19b3cc2c7d14dbf6e92ec8aa5774b6330552",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/pages/new/templates/[[...slug]].js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2Fnew%2Ftemplates%2F%5B%5B...slug%5D%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9f4a7f03b3e23d187eaea59c1cebea183920a928/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2Fnew%2Ftemplates%2F%5B%5B...slug%5D%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fpages%2Fnew%2Ftemplates%2F%5B%5B...slug%5D%5D.js?ref=9f4a7f03b3e23d187eaea59c1cebea183920a928",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return '/new/templates/[[...slug]].js'\n+}"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 61,
        "deletions": 23
    }
}