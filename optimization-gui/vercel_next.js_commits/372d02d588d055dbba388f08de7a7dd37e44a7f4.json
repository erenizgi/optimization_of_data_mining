{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in pages/ client-navigation/rendering (#76798)",
    "sha": "372d02d588d055dbba388f08de7a7dd37e44a7f4",
    "files": [
        {
            "sha": "66cfc6c560048f189ecee80332b16436cb6925b7",
            "filename": "test/development/pages-dir/client-navigation/rendering.test.ts",
            "status": "modified",
            "additions": 143,
            "deletions": 39,
            "changes": 182,
            "blob_url": "https://github.com/vercel/next.js/blob/372d02d588d055dbba388f08de7a7dd37e44a7f4/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/372d02d588d055dbba388f08de7a7dd37e44a7f4/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts?ref=372d02d588d055dbba388f08de7a7dd37e44a7f4",
            "patch": "@@ -2,12 +2,7 @@\n \n import cheerio from 'cheerio'\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  fetchViaHTTP,\n-  getRedboxHeader,\n-  renderViaHTTP,\n-} from 'next-test-utils'\n+import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { BUILD_MANIFEST, REACT_LOADABLE_MANIFEST } from 'next/constants'\n import path from 'path'\n@@ -16,7 +11,7 @@ import url from 'url'\n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n describe('Client Navigation rendering', () => {\n-  const { next } = nextTestSetup({\n+  const { isTurbopack, next } = nextTestSetup({\n     files: path.join(__dirname, 'fixture'),\n     env: {\n       TEST_STRICT_NEXT_HEAD: String(true),\n@@ -132,12 +127,32 @@ describe('Client Navigation rendering', () => {\n \n     test('getInitialProps circular structure', async () => {\n       const browser = await webdriver(next.appPort, '/circular-json-error')\n-      const expectedErrorMessage =\n-        'Circular structure in \"getInitialProps\" result of page \"/circular-json-error\".'\n \n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toContain(expectedErrorMessage)\n+      if (isReact18 && isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: Circular structure in \"getInitialProps\" result of page \"/circular-json-error\". https://nextjs.org/docs/messages/circular-structure\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": null,\n+           \"stack\": [\n+             \"new Promise <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: Circular structure in \"getInitialProps\" result of page \"/circular-json-error\". https://nextjs.org/docs/messages/circular-structure\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": null,\n+           \"stack\": [],\n+         }\n+        `)\n+      }\n     })\n \n     test('getInitialProps should be class method', async () => {\n@@ -146,22 +161,31 @@ describe('Client Navigation rendering', () => {\n         '/instance-get-initial-props'\n       )\n \n-      const expectedErrorMessage =\n-        '\"InstanceInitialPropsPage.getInitialProps()\" is defined as an instance method - visit https://nextjs.org/docs/messages/get-initial-props-as-an-instance-method for more information.'\n-\n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toContain(expectedErrorMessage)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: \"InstanceInitialPropsPage.getInitialProps()\" is defined as an instance method - visit https://nextjs.org/docs/messages/get-initial-props-as-an-instance-method for more information.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n     })\n \n     test('getInitialProps resolves to null', async () => {\n       const browser = await webdriver(next.appPort, '/empty-get-initial-props')\n-      const expectedErrorMessage =\n-        '\"EmptyInitialPropsPage.getInitialProps()\" should resolve to an object. But found \"null\" instead.'\n \n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toContain(expectedErrorMessage)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: \"EmptyInitialPropsPage.getInitialProps()\" should resolve to an object. But found \"null\" instead.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n     })\n \n     test('default Content-Type', async () => {\n@@ -195,28 +219,103 @@ describe('Client Navigation rendering', () => {\n \n     test('default export is not a React Component', async () => {\n       const browser = await webdriver(next.appPort, '/no-default-export')\n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toMatch(/The default export is not a React Component/)\n+\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: The default export is not a React Component in page: \"/no-default-export\"\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n     })\n \n     test('error-inside-page', async () => {\n       const browser = await webdriver(next.appPort, '/error-inside-page')\n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toMatch(/This is an expected error/)\n-      // Sourcemaps are applied by react-error-overlay, so we can't check them on SSR.\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: This is an expected error\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/error-inside-page.js (2:9) @\n+         {default export}\n+         > 2 |   throw new Error('This is an expected error')\n+             |         ^\",\n+           \"stack\": [\n+             \"{default export} pages/error-inside-page.js (2:9)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: This is an expected error\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/error-inside-page.js (2:9) @ default\n+         > 2 |   throw new Error('This is an expected error')\n+             |         ^\",\n+           \"stack\": [\n+             \"default pages/error-inside-page.js (2:9)\",\n+           ],\n+         }\n+        `)\n+      }\n     })\n \n     test('error-in-the-global-scope', async () => {\n       const browser = await webdriver(\n         next.appPort,\n         '/error-in-the-global-scope'\n       )\n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n-      expect(text).toMatch(/aa is not defined/)\n-      // Sourcemaps are applied by react-error-overlay, so we can't check them on SSR.\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: aa is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/error-in-the-global-scope.js (1:1) @ [project]/pages/error-in-the-global-scope.js [ssr] (ecmascript)\n+         > 1 | aa = 10 //eslint-disable-line\n+             | ^\",\n+           \"stack\": [\n+             \"[project]/pages/error-in-the-global-scope.js [ssr] (ecmascript) pages/error-in-the-global-scope.js (1:1)\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"ReferenceError: aa is not defined\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"pages/error-in-the-global-scope.js (1:1) @ eval\n+         > 1 | aa = 10 //eslint-disable-line\n+             | ^\",\n+           \"stack\": [\n+             \"eval pages/error-in-the-global-scope.js (1:1)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+           ],\n+         }\n+        `)\n+      }\n     })\n \n     it('should set Cache-Control header', async () => {\n@@ -320,12 +419,17 @@ describe('Client Navigation rendering', () => {\n \n     it('should show a valid error when undefined is thrown', async () => {\n       const browser = await webdriver(next.appPort, '/throw-undefined')\n-      await assertHasRedbox(browser)\n-      const text = await getRedboxHeader(browser)\n \n-      expect(text).toContain(\n-        'An undefined error was thrown, see here for more info:'\n-      )\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: An undefined error was thrown, see here for more info: https://nextjs.org/docs/messages/threw-undefined\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n     })\n   })\n })"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 143,
        "deletions": 39
    }
}