{
    "author": "bgw",
    "message": "[devtools] Add a very minimal API for restarting the dev server (#79265)\n\nExample:\n\n```\ncurl -v --request POST --header \"Content-Type: application/json\" --data '{}' http://localhost:3000/__nextjs_restart_dev\n```",
    "sha": "7903a5745158671f7943214838ee541adfc7f6a0",
    "files": [
        {
            "sha": "c3d52d2e7cbaa4d3d6e86a908bada1cc922bc0d1",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/restart-dev-server-middleware.ts",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts?ref=7903a5745158671f7943214838ee541adfc7f6a0",
            "patch": "@@ -0,0 +1,35 @@\n+import type { ServerResponse, IncomingMessage } from 'http'\n+import type { Telemetry } from '../../../../telemetry/storage'\n+import { RESTART_EXIT_CODE } from '../../../../server/lib/utils'\n+import { middlewareResponse } from './middleware-response'\n+\n+const EVENT_DEV_OVERLAY_RESTART_SERVER = 'DEV_OVERLAY_RESTART_SERVER'\n+\n+export function getRestartDevServerMiddleware(telemetry: Telemetry) {\n+  return async function (\n+    req: IncomingMessage,\n+    res: ServerResponse,\n+    next: () => void\n+  ): Promise<void> {\n+    const { pathname } = new URL(`http://n${req.url}`)\n+    if (pathname !== '/__nextjs_restart_dev' || req.method !== 'POST') {\n+      return next()\n+    }\n+\n+    telemetry.record({\n+      eventName: EVENT_DEV_OVERLAY_RESTART_SERVER,\n+      payload: {},\n+    })\n+\n+    // TODO: Use flushDetached\n+    await telemetry.flush()\n+\n+    // do this async to try to give the response a chance to send\n+    // it's not really important if it doesn't though\n+    setTimeout(() => {\n+      process.exit(RESTART_EXIT_CODE)\n+    }, 0)\n+\n+    return middlewareResponse.noContent(res)\n+  }\n+}"
        },
        {
            "sha": "6fafa48f97166c84ac40f6aae168f579b8a33ebc",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=7903a5745158671f7943214838ee541adfc7f6a0",
            "patch": "@@ -97,6 +97,7 @@ import {\n import { getDevOverlayFontMiddleware } from '../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware'\n import { devIndicatorServerState } from './dev-indicator-server-state'\n import { getDisableDevIndicatorMiddleware } from './dev-indicator-middleware'\n+import { getRestartDevServerMiddleware } from '../../client/components/react-dev-overlay/server/restart-dev-server-middleware'\n // import { getSupportedBrowsers } from '../../build/utils'\n \n const wsServer = new ws.Server({ noServer: true })\n@@ -649,6 +650,7 @@ export async function createHotReloaderTurbopack(\n     getNextErrorFeedbackMiddleware(opts.telemetry),\n     getDevOverlayFontMiddleware(),\n     getDisableDevIndicatorMiddleware(),\n+    getRestartDevServerMiddleware(opts.telemetry),\n   ]\n \n   const versionInfoPromise = getVersionInfo()"
        },
        {
            "sha": "646a66fac67293c418a6b13060fe8fc5bb1a5524",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7903a5745158671f7943214838ee541adfc7f6a0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=7903a5745158671f7943214838ee541adfc7f6a0",
            "patch": "@@ -87,6 +87,7 @@ import { getNextErrorFeedbackMiddleware } from '../../client/components/react-de\n import { getDevOverlayFontMiddleware } from '../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware'\n import { getDisableDevIndicatorMiddleware } from './dev-indicator-middleware'\n import getWebpackBundler from '../../shared/lib/get-webpack-bundler'\n+import { getRestartDevServerMiddleware } from '../../client/components/react-dev-overlay/server/restart-dev-server-middleware'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -1569,6 +1570,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       getNextErrorFeedbackMiddleware(this.telemetry),\n       getDevOverlayFontMiddleware(),\n       getDisableDevIndicatorMiddleware(),\n+      getRestartDevServerMiddleware(this.telemetry),\n     ]\n   }\n "
        }
    ],
    "stats": {
        "total": 39,
        "additions": 39,
        "deletions": 0
    }
}