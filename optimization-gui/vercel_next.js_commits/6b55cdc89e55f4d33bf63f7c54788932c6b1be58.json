{
    "author": "sokra",
    "message": "Turbopack: fix chunking context caching (#80862)\n\n### What?\r\n\r\nFixes caching by changing arguments from `Option<RcStr>` to `Vc<Option<RcStr>>`.\r\n\r\nThis changes the argument from passed by value to passed by reference. This makes a big differences regarding caching when the string value is changing.\r\n\r\n`Option<RcStr>`: When the string changes a completely new task is created resulting in ChunkingContext being in a new cell, which ends up creating new tasks for all functions that receive the ChunkingContext. This results in a lot of new tasks that need to be computed and stored.\r\n\r\n`Vc<Option<RcStr>>`: When the string changes the existing task is invalidated and recomputed. The result is still the same cell and no new tasks for functions that receive the ChunkingContext are created. Only tasks that use the string are invalidated and recomputed.",
    "sha": "6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
    "files": [
        {
            "sha": "e5a611a5c79cb9c5203ddbb06539c8b0bacc9dbe",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
            "patch": "@@ -1010,8 +1010,8 @@ impl Project {\n             self.project_root_path(),\n             self.client_relative_path(),\n             rcstr!(\"/ROOT\"),\n-            self.next_config().computed_asset_prefix().owned().await?,\n-            self.next_config().chunk_suffix_path().owned().await?,\n+            self.next_config().computed_asset_prefix(),\n+            self.next_config().chunk_suffix_path(),\n             self.client_compile_time_info().environment(),\n             self.next_mode(),\n             self.module_ids(),\n@@ -1068,9 +1068,9 @@ impl Project {\n                 self.next_mode(),\n                 self.project_root_path(),\n                 self.node_root(),\n-                self.node_root_to_root_path().owned().await?,\n+                self.node_root_to_root_path(),\n                 self.client_relative_path(),\n-                self.next_config().computed_asset_prefix().owned().await?,\n+                self.next_config().computed_asset_prefix(),\n                 self.edge_compile_time_info().environment(),\n                 self.module_ids(),\n                 self.next_config().turbo_minify(self.next_mode()),\n@@ -1083,7 +1083,7 @@ impl Project {\n                 self.next_mode(),\n                 self.project_root_path(),\n                 self.node_root(),\n-                self.node_root_to_root_path().owned().await?,\n+                self.node_root_to_root_path(),\n                 self.edge_compile_time_info().environment(),\n                 self.module_ids(),\n                 self.next_config().turbo_minify(self.next_mode()),"
        },
        {
            "sha": "a62528ba68677a3d2630efe90d95ce413c1f36de",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
            "patch": "@@ -427,8 +427,8 @@ pub async fn get_client_chunking_context(\n     root_path: ResolvedVc<FileSystemPath>,\n     client_root: ResolvedVc<FileSystemPath>,\n     client_root_to_root_path: RcStr,\n-    asset_prefix: Option<RcStr>,\n-    chunk_suffix_path: Option<RcStr>,\n+    asset_prefix: ResolvedVc<Option<RcStr>>,\n+    chunk_suffix_path: ResolvedVc<Option<RcStr>>,\n     environment: ResolvedVc<Environment>,\n     mode: Vc<NextMode>,\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n@@ -438,6 +438,8 @@ pub async fn get_client_chunking_context(\n     scope_hoisting: Vc<bool>,\n ) -> Result<Vc<Box<dyn ChunkingContext>>> {\n     let next_mode = mode.await?;\n+    let asset_prefix = asset_prefix.owned().await?;\n+    let chunk_suffix_path = chunk_suffix_path.owned().await?;\n     let mut builder = BrowserChunkingContext::builder(\n         root_path,\n         client_root,"
        },
        {
            "sha": "c957b761b9c9f38f7a9e10ab2c298d6f28ccae13",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
            "patch": "@@ -223,9 +223,9 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     mode: Vc<NextMode>,\n     root_path: ResolvedVc<FileSystemPath>,\n     node_root: ResolvedVc<FileSystemPath>,\n-    output_root_to_root_path: RcStr,\n+    output_root_to_root_path: ResolvedVc<RcStr>,\n     client_root: ResolvedVc<FileSystemPath>,\n-    asset_prefix: Option<RcStr>,\n+    asset_prefix: ResolvedVc<Option<RcStr>>,\n     environment: ResolvedVc<Environment>,\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n     turbo_minify: Vc<bool>,\n@@ -238,7 +238,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     let mut builder = BrowserChunkingContext::builder(\n         root_path,\n         output_root,\n-        output_root_to_root_path,\n+        output_root_to_root_path.owned().await?,\n         client_root,\n         output_root.join(rcstr!(\"chunks/ssr\")).to_resolved().await?,\n         client_root\n@@ -248,7 +248,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         environment,\n         next_mode.runtime_type(),\n     )\n-    .asset_base_path(asset_prefix)\n+    .asset_base_path(asset_prefix.owned().await?)\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n             // React needs deterministic function names to work correctly.\n@@ -291,7 +291,7 @@ pub async fn get_edge_chunking_context(\n     mode: Vc<NextMode>,\n     root_path: ResolvedVc<FileSystemPath>,\n     node_root: ResolvedVc<FileSystemPath>,\n-    node_root_to_root_path: RcStr,\n+    node_root_to_root_path: ResolvedVc<RcStr>,\n     environment: ResolvedVc<Environment>,\n     module_id_strategy: ResolvedVc<Box<dyn ModuleIdStrategy>>,\n     turbo_minify: Vc<bool>,\n@@ -304,7 +304,7 @@ pub async fn get_edge_chunking_context(\n     let mut builder = BrowserChunkingContext::builder(\n         root_path,\n         output_root,\n-        node_root_to_root_path,\n+        node_root_to_root_path.owned().await?,\n         output_root,\n         output_root.join(rcstr!(\"chunks\")).to_resolved().await?,\n         output_root.join(rcstr!(\"assets\")).to_resolved().await?,"
        },
        {
            "sha": "fa8a00f412ab6f426a24b6f657c1eb975632c4ce",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
            "patch": "@@ -166,7 +166,7 @@ impl BrowserChunkingContextBuilder {\n     }\n \n     pub fn build(self) -> Vc<BrowserChunkingContext> {\n-        BrowserChunkingContext::new(self.chunking_context)\n+        BrowserChunkingContext::cell(self.chunking_context)\n     }\n }\n \n@@ -302,11 +302,6 @@ impl BrowserChunkingContext {\n \n #[turbo_tasks::value_impl]\n impl BrowserChunkingContext {\n-    #[turbo_tasks::function]\n-    fn new(this: BrowserChunkingContext) -> Vc<Self> {\n-        this.cell()\n-    }\n-\n     #[turbo_tasks::function]\n     fn generate_evaluate_chunk(\n         self: Vc<Self>,"
        },
        {
            "sha": "e3f14bd0439caf16543bdb8b128416c1e5a564e8",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6b55cdc89e55f4d33bf63f7c54788932c6b1be58/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=6b55cdc89e55f4d33bf63f7c54788932c6b1be58",
            "patch": "@@ -96,7 +96,7 @@ impl NodeJsChunkingContextBuilder {\n \n     /// Builds the chunking context.\n     pub fn build(self) -> Vc<NodeJsChunkingContext> {\n-        NodeJsChunkingContext::new(self.chunking_context)\n+        NodeJsChunkingContext::cell(self.chunking_context)\n     }\n }\n \n@@ -199,11 +199,6 @@ impl NodeJsChunkingContext {\n \n #[turbo_tasks::value_impl]\n impl NodeJsChunkingContext {\n-    #[turbo_tasks::function]\n-    fn new(this: NodeJsChunkingContext) -> Vc<Self> {\n-        this.cell()\n-    }\n-\n     #[turbo_tasks::function]\n     async fn generate_chunk(\n         self: Vc<Self>,"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 17,
        "deletions": 25
    }
}