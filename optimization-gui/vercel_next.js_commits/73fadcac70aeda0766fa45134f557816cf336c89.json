{
    "author": "mischnic",
    "message": "Turbopack: don't look into fallback import map twice (#82786)\n\nFixes a panic where we tried to lookup a `Pattern::Alternatives` in a `fallback_import_map.lookup()` (but the API is that the caller is in charge of unwrapping the alternative and calling lookup multiple times). We can completely skip this in this case, because the individual requests inside the `Request::Alternatives` already looked at the `fallback_import_map`, so no need to check again for the whole alternative as well.\n\nThis was a somewhat recent regression:\n- https://github.com/vercel/next.js/pull/77954 made sure that `var` variables always have a `<dynamic>` variant added, due to their weird scope rules (or lack thereof).\n- https://github.com/vercel/next.js/pull/81541 then added a `fallback_import_map`",
    "sha": "73fadcac70aeda0766fa45134f557816cf336c89",
    "files": [
        {
            "sha": "a04b849ec46c950c6101e151f76b5c18fa6011f0",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 20,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=73fadcac70aeda0766fa45134f557816cf336c89",
            "patch": "@@ -2094,27 +2094,31 @@ async fn resolve_internal_inline(\n             }\n         };\n \n-        // Apply fallback import mappings if provided\n-        if let Some(import_map) = &options_value.fallback_import_map\n-            && *result.is_unresolvable().await?\n-        {\n-            let result = import_map\n-                .await?\n-                .lookup(lookup_path.clone(), request)\n-                .await?;\n-            let resolved_result = resolve_import_map_result(\n-                &result,\n-                lookup_path.clone(),\n-                lookup_path.clone(),\n-                request,\n-                options,\n-                request.query().owned().await?,\n-            )\n-            .await?;\n-            if let Some(result) = resolved_result\n-                && !*result.is_unresolvable().await?\n+        // The individual variants inside the alternative already looked at the fallback import\n+        // map in the recursive `resolve_internal_inline` calls\n+        if !matches!(*request_value, Request::Alternatives { .. }) {\n+            // Apply fallback import mappings if provided\n+            if let Some(import_map) = &options_value.fallback_import_map\n+                && *result.is_unresolvable().await?\n             {\n-                return Ok(result);\n+                let result = import_map\n+                    .await?\n+                    .lookup(lookup_path.clone(), request)\n+                    .await?;\n+                let resolved_result = resolve_import_map_result(\n+                    &result,\n+                    lookup_path.clone(),\n+                    lookup_path.clone(),\n+                    request,\n+                    options,\n+                    request.query().owned().await?,\n+                )\n+                .await?;\n+                if let Some(result) = resolved_result\n+                    && !*result.is_unresolvable().await?\n+                {\n+                    return Ok(result);\n+                }\n             }\n         }\n "
        },
        {
            "sha": "2155412ba0f77740abb7ce8720daa7837b0e760f",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=73fadcac70aeda0766fa45134f557816cf336c89",
            "patch": "@@ -392,6 +392,17 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n             .resolved_cell(),\n     );\n \n+    let mut fallback_import_map = ImportMap::empty();\n+    fallback_import_map.insert_exact_alias(\n+        rcstr!(\"fallback\"),\n+        ImportMapping::External(\n+            None,\n+            ExternalType::EcmaScriptModule,\n+            ExternalTraced::Untraced,\n+        )\n+        .resolved_cell(),\n+    );\n+\n     let remove_unused_exports = options.remove_unused_exports.unwrap_or(true);\n \n     let asset_context: Vc<Box<dyn AssetContext>> = Vc::upcast(ModuleAssetContext::new(\n@@ -435,6 +446,7 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n             browser: true,\n             module: true,\n             import_map: Some(import_map.resolved_cell()),\n+            fallback_import_map: Some(fallback_import_map.resolved_cell()),\n             ..Default::default()\n         }\n         .cell(),"
        },
        {
            "sha": "b9df4b1693a187d1a0cce0ba71ad1e094954df65",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/dynamic/input/index.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Finput%2Findex.js?ref=73fadcac70aeda0766fa45134f557816cf336c89",
            "patch": "@@ -0,0 +1,19 @@\n+let names = ['cannot-resolve']\n+if (globalThis.foo != undefined) {\n+  // ensure `<dynamic>` is part of the array\n+  names.push(globalThis.foo)\n+}\n+\n+let result\n+for (let name of names) {\n+  try {\n+    result = require(name).Iconv\n+    return\n+  } catch {}\n+}\n+\n+console.log(result)\n+\n+it('should correctly handle potentially completely dynamic requests', () => {\n+  expect(result).toBeUndefined()\n+})"
        },
        {
            "sha": "0cc286244b2d6b2e2308f21928a33ff7ceec666d",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/dynamic/issues/__l___Module not found____c__ Can't resolve __c_('-fa7799.txt",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Fissues%2F__l___Module%20not%20found____c__%20Can't%20resolve%20__c_('-fa7799.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/73fadcac70aeda0766fa45134f557816cf336c89/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Fissues%2F__l___Module%20not%20found____c__%20Can't%20resolve%20__c_('-fa7799.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Fdynamic%2Fissues%2F__l___Module%20not%20found____c__%20Can't%20resolve%20__c_('-fa7799.txt?ref=73fadcac70aeda0766fa45134f557816cf336c89",
            "patch": "@@ -0,0 +1,21 @@\n+warning - [resolve] /turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/dynamic/input/index.js:10:13  Module not found: Can't resolve ('cannot-resolve' | <dynamic>)\n+  \n+       6 | \n+       7 | let result\n+       8 | for (let name of names) {\n+       9 |   try {\n+         +              v-----------v\n+      10 +     result = require(name).Iconv\n+         +              ^-----------^\n+      11 |     return\n+      12 |   } catch {}\n+      13 | }\n+      14 | \n+  \n+  \n+  \n+  | It was not possible to find the requested file.\n+  | Parsed request as written in source code: module \"'cannot-resolve'\" or dynamic\n+  | Path where resolving has started: [project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/dynamic/input/index.js\n+  | Type of request: commonjs request\n+  |\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 76,
        "deletions": 20
    }
}