{
    "author": "unstubbable",
    "message": "Exit `next dev` with a non-zero code when next.config.js is invalid (#83602)\n\nIn `next dev`, we're currently ignoring the exit code of the spawned\nchild process, and always exiting with `0` instead. We should exit the\nprocess with the child's exit code instead. This is relevant when the\n`next.config.js` is invalid, for example.",
    "sha": "80bc175dbd15f00e0b6c8befe24b1039fc5ea40d",
    "files": [
        {
            "sha": "33e6e51bc6d881fc282f6660bddfe5dba13e8de0",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=80bc175dbd15f00e0b6c8befe24b1039fc5ea40d",
            "patch": "@@ -76,6 +76,10 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n   if (sessionStopHandled) return\n   sessionStopHandled = true\n \n+  // Capture the child's exit code if it has already exited and caused the\n+  // session stop (via the 'exit' event), otherwise assume success (0).\n+  const exitCode = child?.exitCode || 0\n+\n   if (\n     signal != null &&\n     child?.pid &&\n@@ -150,7 +154,7 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n   // the program, or the cursor could remain hidden\n   process.stdout.write('\\x1B[?25h')\n   process.stdout.write('\\n')\n-  process.exit(0)\n+  process.exit(exitCode)\n }\n \n process.on('SIGINT', () => handleSessionStop('SIGINT'))"
        },
        {
            "sha": "4a2bfb5fce89f655027d90e65a75787907d44497",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=80bc175dbd15f00e0b6c8befe24b1039fc5ea40d",
            "patch": "@@ -367,22 +367,22 @@ export async function startServer(\n       // Only load env and config in dev to for logging purposes\n       let envInfo: string[] | undefined\n       let experimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n-      if (isDev) {\n-        const startServerInfo = await getStartServerInfo({ dir, dev: isDev })\n-        envInfo = startServerInfo.envInfo\n-        experimentalFeatures = startServerInfo.experimentalFeatures\n-      }\n-      logStartInfo({\n-        networkUrl,\n-        appUrl,\n-        envInfo,\n-        experimentalFeatures,\n-        logBundler: isDev,\n-      })\n+      try {\n+        if (isDev) {\n+          const startServerInfo = await getStartServerInfo({ dir, dev: isDev })\n+          envInfo = startServerInfo.envInfo\n+          experimentalFeatures = startServerInfo.experimentalFeatures\n+        }\n+        logStartInfo({\n+          networkUrl,\n+          appUrl,\n+          envInfo,\n+          experimentalFeatures,\n+          logBundler: isDev,\n+        })\n \n-      Log.event(`Starting...`)\n+        Log.event(`Starting...`)\n \n-      try {\n         let cleanupStarted = false\n         let closeUpgraded: (() => void) | null = null\n         const cleanup = () => {"
        },
        {
            "sha": "cb04de4f31a6b1391742d6a6ac8780a6cab07879",
            "filename": "test/e2e/build-indicator/test/index.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts?ref=80bc175dbd15f00e0b6c8befe24b1039fc5ea40d",
            "patch": "@@ -1,7 +1,7 @@\n /* eslint-env jest */\n import { join } from 'path'\n import { retry } from 'next-test-utils'\n-import { nextTestSetup, isNextDev, isNextStart } from 'e2e-utils'\n+import { nextTestSetup, isNextDev, isNextDeploy } from 'e2e-utils'\n \n const installCheckVisible = (browser) => {\n   return browser.eval(`(function() {\n@@ -19,24 +19,34 @@ const installCheckVisible = (browser) => {\n \n describe('Build Activity Indicator', () => {\n   // Use describe.skip so that this suite does not fail with \"no tests\" during deploy tests.\n-  ;(isNextStart ? describe : describe.skip)('Invalid position config', () => {\n+  ;(isNextDeploy ? describe.skip : describe)('Invalid position config', () => {\n     const { next } = nextTestSetup({\n       files: join(__dirname, '..'),\n       skipStart: true,\n-      startServerTimeout: 1000,\n       nextConfig: {\n         devIndicators: {\n           // Intentionally invalid position to test error\n-          position: 'ttop-leff' as any,\n+          // @ts-expect-error\n+          position: 'ttop-leff',\n         },\n       },\n     })\n \n     it('should validate position config', async () => {\n-      const result = await next.build()\n+      if (isNextDev) {\n+        try {\n+          await next.start()\n+        } catch (err) {\n+          expect(err).toEqual(\n+            new Error('next dev exited unexpectedly with code/signal 1')\n+          )\n+        }\n+      } else {\n+        const result = await next.build()\n+        expect(result.exitCode).toBe(1)\n+      }\n \n-      expect(result.exitCode).toBe(1)\n-      expect(result.cliOutput).toContain(\n+      expect(next.cliOutput).toContain(\n         `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n       )\n     })"
        },
        {
            "sha": "cb9121b03b5cfaf1cdd8aaf2a3cb122dbe2a49a5",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/80bc175dbd15f00e0b6c8befe24b1039fc5ea40d/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=80bc175dbd15f00e0b6c8befe24b1039fc5ea40d",
            "patch": "@@ -81,20 +81,24 @@ export class NextDevInstance extends NextInstance {\n           this.emit('stderr', [msg])\n         })\n \n+        const serverReadyTimeoutId = this.setServerReadyTimeout(\n+          reject,\n+          this.startServerTimeout\n+        )\n+\n         this.childProcess.on('close', (code, signal) => {\n           if (this.isStopping) return\n           if (code || signal) {\n-            require('console').error(\n+            this.childProcess = undefined\n+            const error = new Error(\n               `next dev exited unexpectedly with code/signal ${code || signal}`\n             )\n+            clearTimeout(serverReadyTimeoutId)\n+            require('console').error(error)\n+            reject(error)\n           }\n         })\n \n-        const serverReadyTimeoutId = this.setServerReadyTimeout(\n-          reject,\n-          this.startServerTimeout\n-        )\n-\n         const readyCb = (msg) => {\n           const resolveServer = () => {\n             clearTimeout(serverReadyTimeoutId)"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 46,
        "deletions": 28
    }
}