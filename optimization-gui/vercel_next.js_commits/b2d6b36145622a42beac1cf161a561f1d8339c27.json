{
    "author": "eps1lon",
    "message": "Fix preview builds for forks (#80833)",
    "sha": "b2d6b36145622a42beac1cf161a561f1d8339c27",
    "files": [
        {
            "sha": "a069ee307df56bc484952f2e3b5f92d651c16361",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b2d6b36145622a42beac1cf161a561f1d8339c27/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/b2d6b36145622a42beac1cf161a561f1d8339c27/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=b2d6b36145622a42beac1cf161a561f1d8339c27",
            "patch": "@@ -37,6 +37,7 @@ jobs:\n       - uses: actions/checkout@v4\n         with:\n           fetch-depth: 1\n+      - run: echo \"${{ github.event.after }}\"\n       - name: Setup node\n         uses: actions/setup-node@v4\n         with:\n@@ -535,7 +536,9 @@ jobs:\n           path: crates/wasm\n \n       - name: Create tarballs\n-        run: node scripts/create-preview-tarballs.js \"${{ github.sha }}\" \"${{ github.workflow_sha }}\" \"${{ runner.temp }}/preview-tarballs\"\n+        # github.event.after is available on push and pull_request#synchronize events.\n+        # For workflow_dispatch events, github.sha is the head commit.\n+        run: node scripts/create-preview-tarballs.js \"${{ github.sha }}\" \"${{ github.event.after || github.sha }}\" \"${{ runner.temp }}/preview-tarballs\"\n \n       - name: Upload tarballs\n         uses: actions/upload-artifact@v4"
        },
        {
            "sha": "0bffdf9b9341f1e946382a439ab44c3cbc3699c4",
            "filename": "scripts/create-preview-tarballs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b2d6b36145622a42beac1cf161a561f1d8339c27/scripts%2Fcreate-preview-tarballs.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b2d6b36145622a42beac1cf161a561f1d8339c27/scripts%2Fcreate-preview-tarballs.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcreate-preview-tarballs.js?ref=b2d6b36145622a42beac1cf161a561f1d8339c27",
            "patch": "@@ -7,7 +7,7 @@ const path = require('node:path')\n async function main() {\n   const [\n     githubSha,\n-    githubWorkflowSha,\n+    githubHeadSha,\n     tarballDirectory = path.join(os.tmpdir(), 'vercel-nextjs-preview-tarballs'),\n   ] = process.argv.slice(2)\n   const repoRoot = path.resolve(__dirname, '..')\n@@ -103,13 +103,13 @@ async function main() {\n   for (const packageInfo of packages) {\n     packagesByVersion.set(\n       packageInfo.name,\n-      `https://vercel-packages.vercel.app/next/commits/${githubWorkflowSha}/${packageInfo.name}`\n+      `https://vercel-packages.vercel.app/next/commits/${githubHeadSha}/${packageInfo.name}`\n     )\n   }\n   for (const nextSwcPackageName of nextSwcPackageNames) {\n     packagesByVersion.set(\n       nextSwcPackageName,\n-      `https://vercel-packages.vercel.app/next/commits/${githubWorkflowSha}/${nextSwcPackageName}`\n+      `https://vercel-packages.vercel.app/next/commits/${githubHeadSha}/${nextSwcPackageName}`\n     )\n   }\n "
        }
    ],
    "stats": {
        "total": 11,
        "additions": 7,
        "deletions": 4
    }
}