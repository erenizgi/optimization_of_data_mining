{
    "author": "lukesandberg",
    "message": "[turbopack] Fix a small issue in the analyzer where we wouldn't skip assignments to free vars that were just identifiers (#82392)\n\nCorrectly skip assignments when replacing free variables\n\nDrop an `Option<..>` for a parameter that is always supplied.\n\nThese are fixes i tripped over when attempting to compile time replace `module` and `exports`. That approach failed (see #82285 for what happened instead), but we can keep these cleanups.",
    "sha": "74a0aa2f2de22983f73a0f185a86bf425e26c650",
    "files": [
        {
            "sha": "c32e9edb369c98efdd761706f23e763433850920",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/74a0aa2f2de22983f73a0f185a86bf425e26c650/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/74a0aa2f2de22983f73a0f185a86bf425e26c650/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=74a0aa2f2de22983f73a0f185a86bf425e26c650",
            "patch": "@@ -2042,11 +2042,11 @@ impl JsValue {\n     /// Returns any matching defined replacement that matches this value (the replacement that\n     /// matches `$self.$prop`).\n     ///\n-    /// Optionally when passed a VarGraph, verifies that the first segment is not a local\n+    /// Uses the `VarGraph` to verify that the first segment is not a local\n     /// variable/was not reassigned.\n     pub fn match_free_var_reference<'a, T>(\n         &self,\n-        var_graph: Option<&VarGraph>,\n+        var_graph: &VarGraph,\n         free_var_references: &'a FxIndexMap<\n             DefinableNameSegment,\n             FxIndexMap<Vec<DefinableNameSegment>, T>,\n@@ -2063,9 +2063,7 @@ impl JsValue {\n \n                 let name_rev_it = name.iter().map(Cow::Borrowed).rev();\n                 if name_rev_it.eq(self.iter_definable_name_rev()) {\n-                    if let Some(var_graph) = var_graph\n-                        && let DefinableNameSegment::Name(first_str) = name.first().unwrap()\n-                    {\n+                    if let DefinableNameSegment::Name(first_str) = name.first().unwrap() {\n                         let first_str: &str = first_str;\n                         if var_graph\n                             .free_var_ids"
        },
        {
            "sha": "d539dbdfcc3655ba499e67bf42ef61188e4d842e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/74a0aa2f2de22983f73a0f185a86bf425e26c650/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/74a0aa2f2de22983f73a0f185a86bf425e26c650/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=74a0aa2f2de22983f73a0f185a86bf425e26c650",
            "patch": "@@ -52,7 +52,9 @@ use swc_core::{\n         utils::IsDirective,\n         visit::{\n             AstParentKind, AstParentNodeRef, VisitAstPath, VisitWithAstPath,\n-            fields::{AssignExprField, AssignTargetField, SimpleAssignTargetField},\n+            fields::{\n+                AssignExprField, AssignTargetField, BindingIdentField, SimpleAssignTargetField,\n+            },\n         },\n     },\n };\n@@ -2485,7 +2487,7 @@ async fn handle_typeof(\n     analysis: &mut AnalyzeEcmascriptModuleResultBuilder,\n ) -> Result<()> {\n     if let Some(value) = arg.match_free_var_reference(\n-        Some(state.var_graph),\n+        state.var_graph,\n         &*state.free_var_references,\n         &DefinableNameSegment::TypeOf,\n     ) {\n@@ -2533,11 +2535,20 @@ async fn handle_free_var_reference(\n     // We don't want to replace assignments as this would lead to invalid code.\n     if matches!(\n         ast_path,\n+        // Matches assignments to members\n         [\n             ..,\n             AstParentKind::AssignExpr(AssignExprField::Left),\n             AstParentKind::AssignTarget(AssignTargetField::Simple),\n             AstParentKind::SimpleAssignTarget(SimpleAssignTargetField::Member),\n+        ] |\n+        // Matches assignments to identifiers\n+        [\n+            ..,\n+            AstParentKind::AssignExpr(AssignExprField::Left),\n+            AstParentKind::AssignTarget(AssignTargetField::Simple),\n+            AstParentKind::SimpleAssignTarget(SimpleAssignTargetField::Ident),\n+            AstParentKind::BindingIdent(BindingIdentField::Id),\n         ]\n     ) {\n         return Ok(false);\n@@ -2887,7 +2898,7 @@ async fn value_visitor_inner(\n         let compile_time_info = compile_time_info.await?;\n         if let JsValue::TypeOf(_, arg) = &v\n             && let Some(value) = arg.match_free_var_reference(\n-                Some(var_graph),\n+                var_graph,\n                 free_var_references,\n                 &DefinableNameSegment::TypeOf,\n             )"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 17,
        "deletions": 8
    }
}