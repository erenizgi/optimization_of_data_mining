{
    "author": "ale-grosselle",
    "message": "fix: ensure req.query is writable (#81573)\n\n### What?\n- Upgrade development dependency **Express** to the latest version\n(5.1.0).\n- Replace direct assignment of `apiReq.query` with\n`Object.defineProperty` to ensure the property is writable, enumerable,\nand configurable.\n\n### Why?\n- To use the most up-to-date and supported version of Express instead of\na legacy one.\n- To fix\n[expressjs/express#6633](https://github.com/expressjs/express/issues/6633),\nwhere Express 5.x defines `req.query` as a read-only getter, preventing\nNext.js from overriding it directly.\n\n### How?\n- Update the Express version in `package.json` and run `pnpm install` to\napply the change.\n- Replace:\n\n```js\napiReq.query = query;\n```\nWith \n```js\nObject.defineProperty(apiReq, 'query', {\n  value: { ...query },\n  writable: true,\n  enumerable: true,\n  configurable: true,\n});\n```\n\n---------\n\nCo-authored-by: Alessandro Grosselle <alessandro.grosselle@adevinta.com>\nCo-authored-by: graphite-app[bot] <96075541+graphite-app[bot]@users.noreply.github.com>\nCo-authored-by: Sebastian Beltran <bjohansebas@gmail.com>\nCo-authored-by: Tim Neutkens <tim@timneutkens.nl>",
    "sha": "456d8e7b8c0f1f11fa9d290ccc916c6c686d5081",
    "files": [
        {
            "sha": "aab866f2bbdc01f7d5dc8531e1dfd45290a30eea",
            "filename": "packages/next/src/server/api-utils/node/api-resolver.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts?ref=456d8e7b8c0f1f11fa9d290ccc916c6c686d5081",
            "patch": "@@ -355,8 +355,14 @@ export async function apiResolver(\n \n     // Parsing of cookies\n     setLazyProp({ req: apiReq }, 'cookies', getCookieParser(req.headers))\n-    // Parsing query string\n-    apiReq.query = query\n+    // Ensure req.query is a writable, enumerable property by using Object.defineProperty.\n+    // This addresses Express 5.x, which defines query as a getter only (read-only).\n+    Object.defineProperty(apiReq, 'query', {\n+      value: { ...query },\n+      writable: true,\n+      enumerable: true,\n+      configurable: true,\n+    })\n     // Parsing preview data\n     setLazyProp({ req: apiReq }, 'previewData', () =>\n       tryGetPreviewData(req, res, apiContext, !!apiContext.multiZoneDraftMode)"
        },
        {
            "sha": "19a56e9db80be5d6d1ef9bd6d70cce20ad224227",
            "filename": "test/e2e/api-resolver-query-writeable/api-resolver-query-writeable.test.ts",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fapi-resolver-query-writeable.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fapi-resolver-query-writeable.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapi-resolver-query-writeable%2Fapi-resolver-query-writeable.test.ts?ref=456d8e7b8c0f1f11fa9d290ccc916c6c686d5081",
            "patch": "@@ -0,0 +1,31 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('api-resolver-query-writeable', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    startCommand: 'node server.js',\n+    serverReadyPattern: /Next mode: (production|development)/,\n+    dependencies: {\n+      'get-port': '5.1.1',\n+      express: '5.1.0',\n+    },\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should allow req.query to be writable and reflect changes made in the API handler', async () => {\n+    const res = await next.fetch('/api?hello=yes', {\n+      headers: {\n+        'Content-Type': 'application/json; charset=utf-8',\n+      },\n+    })\n+    if (!res.ok) {\n+      throw new Error('Fetch failed')\n+    }\n+    const data = await res.json()\n+    expect(data).toEqual({ query: { hello: 'yes', changed: 'yes' } })\n+  })\n+})"
        },
        {
            "sha": "80909dde278a1ef7817ced631fd802718bf9e333",
            "filename": "test/e2e/api-resolver-query-writeable/pages/api/index.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fpages%2Fapi%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fpages%2Fapi%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapi-resolver-query-writeable%2Fpages%2Fapi%2Findex.js?ref=456d8e7b8c0f1f11fa9d290ccc916c6c686d5081",
            "patch": "@@ -0,0 +1,4 @@\n+export default (req, res) => {\n+  req.query = { ...req.query, changed: 'yes' }\n+  res.status(200).json({ query: req.query })\n+}"
        },
        {
            "sha": "060d67e5706cdf072da4376e9a3b466925ce4a87",
            "filename": "test/e2e/api-resolver-query-writeable/server.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fserver.js",
            "raw_url": "https://github.com/vercel/next.js/raw/456d8e7b8c0f1f11fa9d290ccc916c6c686d5081/test%2Fe2e%2Fapi-resolver-query-writeable%2Fserver.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapi-resolver-query-writeable%2Fserver.js?ref=456d8e7b8c0f1f11fa9d290ccc916c6c686d5081",
            "patch": "@@ -0,0 +1,35 @@\n+const next = require('next')\n+const express = require('express')\n+\n+const getPort = require('get-port')\n+\n+async function main() {\n+  const dev = process.env.NEXT_TEST_MODE === 'dev'\n+  process.env.NODE_ENV = dev ? 'development' : 'production'\n+\n+  const port = await getPort()\n+  const app = next({ dev })\n+  const handleNextRequest = app.getRequestHandler()\n+\n+  await app.prepare()\n+\n+  const server = express()\n+\n+  server.all('/:path', (req, res) => {\n+    handleNextRequest(req, res)\n+  })\n+\n+  server.listen(port, (err) => {\n+    if (err) {\n+      throw err\n+    }\n+\n+    console.log(`- Local: http://localhost:${port}`)\n+    console.log(`- Next mode: ${dev ? 'development' : process.env.NODE_ENV}`)\n+  })\n+}\n+\n+main().catch((err) => {\n+  console.error(err)\n+  process.exit(1)\n+})"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 78,
        "deletions": 2
    }
}