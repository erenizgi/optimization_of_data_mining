{
    "author": "gaojude",
    "message": "only log when instrumentation client takes too long (#77378)\n\nOnly log when the sync code inside instrumentation client takes more\nthan 16ms, instead of logging every single time.",
    "sha": "31dc9381add7ba1074437d0d71eb7a974b0a331d",
    "files": [
        {
            "sha": "9fbe8cb58f546b1b570881bf05cd6613167d85bf",
            "filename": "packages/next/src/lib/require-instrumentation-client.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/31dc9381add7ba1074437d0d71eb7a974b0a331d/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/31dc9381add7ba1074437d0d71eb7a974b0a331d/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts?ref=31dc9381add7ba1074437d0d71eb7a974b0a331d",
            "patch": "@@ -6,12 +6,27 @@\n  */\n if (process.env.__NEXT_EXPERIMENTAL_CLIENT_INSTRUMENTATION_HOOK) {\n   if (process.env.NODE_ENV === 'development') {\n+    const measureName = 'Client Instrumentation Hook'\n     const startTime = performance.now()\n     require('private-next-instrumentation-client')\n     const endTime = performance.now()\n-    console.log(\n-      `[Client Instrumentation Hook] executed in ${(endTime - startTime).toFixed(0)}ms (Note: Code download overhead is not included in this measurement)`\n-    )\n+\n+    const duration = endTime - startTime\n+    performance.measure(measureName, {\n+      start: startTime,\n+      end: endTime,\n+      detail: 'Client instrumentation initialization',\n+    })\n+\n+    // Using 16ms threshold as it represents one frame (1000ms/60fps)\n+    // This helps identify if the instrumentation hook initialization\n+    // could potentially cause frame drops during development.\n+    const THRESHOLD = 16\n+    if (duration > THRESHOLD) {\n+      console.log(\n+        `[${measureName}] Slow execution detected: ${duration.toFixed(0)}ms (Note: Code download overhead is not included in this measurement)`\n+      )\n+    }\n   } else {\n     require('private-next-instrumentation-client')\n   }"
        },
        {
            "sha": "abfc089edebb953cea52526e612056727e09214e",
            "filename": "test/e2e/instrumentation-client-hook/app-router/instrumentation-client.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/31dc9381add7ba1074437d0d71eb7a974b0a331d/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/31dc9381add7ba1074437d0d71eb7a974b0a331d/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts?ref=31dc9381add7ba1074437d0d71eb7a974b0a331d",
            "patch": "@@ -1 +1,6 @@\n ;(window as any).__INSTRUMENTATION_CLIENT_EXECUTED_AT = performance.now()\n+\n+const start = performance.now()\n+while (performance.now() - start < 20) {\n+  // Intentionally block for 20ms to test instrumentation timing\n+}"
        },
        {
            "sha": "f46e81a8baae48b5aa615d19c986bb439fa7ae93",
            "filename": "test/e2e/instrumentation-client-hook/instrumentation-client-hook.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/31dc9381add7ba1074437d0d71eb7a974b0a331d/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/31dc9381add7ba1074437d0d71eb7a974b0a331d/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts?ref=31dc9381add7ba1074437d0d71eb7a974b0a331d",
            "patch": "@@ -7,18 +7,21 @@ describe('Instrumentation Client Hook', () => {\n     {\n       name: 'With src folder',\n       appDir: 'app-with-src',\n+      shouldLog: false,\n     },\n     {\n       name: 'App Router',\n       appDir: 'app-router',\n+      shouldLog: true,\n     },\n     {\n       name: 'Pages Router',\n       appDir: 'pages-router',\n+      shouldLog: false,\n     },\n   ]\n \n-  testCases.forEach(({ name, appDir }) => {\n+  testCases.forEach(({ name, appDir, shouldLog }) => {\n     describe(name, () => {\n       const { next, isNextDev } = nextTestSetup({\n         files: path.join(__dirname, appDir),\n@@ -37,9 +40,11 @@ describe('Instrumentation Client Hook', () => {\n         expect(instrumentationTime).toBeLessThan(hydrationTime)\n         expect(\n           (await browser.log()).some((log) =>\n-            log.message.startsWith('[Client Instrumentation Hook]')\n+            log.message.startsWith(\n+              '[Client Instrumentation Hook] Slow execution detected'\n+            )\n           )\n-        ).toBe(isNextDev)\n+        ).toBe(isNextDev && shouldLog)\n       })\n     })\n   })"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 31,
        "deletions": 6
    }
}