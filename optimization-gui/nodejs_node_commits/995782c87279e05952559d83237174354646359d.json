{
    "author": "addaleax",
    "message": "process: generate list of allowed env flags programmatically\n\nAvoids having a separate, second source of truth on this matter.\n\nPR-URL: https://github.com/nodejs/node/pull/22638\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "995782c87279e05952559d83237174354646359d",
    "files": [
        {
            "sha": "128725a5320eae11bd9b3f8e4a9b3634a9eec2cd",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 42,
            "deletions": 3,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/995782c87279e05952559d83237174354646359d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/995782c87279e05952559d83237174354646359d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=995782c87279e05952559d83237174354646359d",
            "patch": "@@ -671,9 +671,45 @@\n     const test = Function.call.bind(RegExp.prototype.test);\n \n     const {\n-      allowedV8EnvironmentFlags,\n-      allowedNodeEnvironmentFlags\n-    } = process.binding('config');\n+      getOptions,\n+      types: { kV8Option },\n+      envSettings: { kAllowedInEnvironment }\n+    } = internalBinding('options');\n+    const { options, aliases } = getOptions();\n+\n+    const allowedV8EnvironmentFlags = [];\n+    const allowedNodeEnvironmentFlags = [];\n+    for (const [name, info] of options) {\n+      if (info.envVarSettings === kAllowedInEnvironment) {\n+        if (info.type === kV8Option) {\n+          allowedV8EnvironmentFlags.push(name);\n+        } else {\n+          allowedNodeEnvironmentFlags.push(name);\n+        }\n+      }\n+    }\n+\n+    for (const [ from, expansion ] of aliases) {\n+      let isAccepted = true;\n+      for (const to of expansion) {\n+        if (!to.startsWith('-')) continue;\n+        const recursiveExpansion = aliases.get(to);\n+        if (recursiveExpansion) {\n+          expansion.push(...recursiveExpansion);\n+          continue;\n+        }\n+        isAccepted = options.get(to).envVarSettings === kAllowedInEnvironment;\n+        if (!isAccepted) break;\n+      }\n+      if (isAccepted) {\n+        let canonical = from;\n+        if (canonical.endsWith('='))\n+          canonical = canonical.substr(0, canonical.length - 1);\n+        if (canonical.endsWith(' <arg>'))\n+          canonical = canonical.substr(0, canonical.length - 4);\n+        allowedNodeEnvironmentFlags.push(canonical);\n+      }\n+    }\n \n     const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n \n@@ -711,6 +747,9 @@\n         // permutations of a flag, including present/missing leading\n         // dash(es) and/or underscores-for-dashes in the case of V8-specific\n         // flags.  Strips any values after `=`, inclusive.\n+        // TODO(addaleax): It might be more flexible to run the option parser\n+        // on a dummy option set and see whether it rejects the argument or\n+        // not.\n         if (typeof key === 'string') {\n           key = replace(key, trailingValuesRegex, '');\n           if (test(leadingDashesRegex, key)) {"
        },
        {
            "sha": "72a83d538ff5d520740b389757b3d840efdcc374",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 62,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/995782c87279e05952559d83237174354646359d/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/995782c87279e05952559d83237174354646359d/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=995782c87279e05952559d83237174354646359d",
            "patch": "@@ -598,68 +598,6 @@ const char* signo_string(int signo) {\n   }\n }\n \n-// These are all flags available for use with NODE_OPTIONS.\n-//\n-// Disallowed flags:\n-//  These flags cause Node to do things other than run scripts:\n-//    --version / -v\n-//    --eval / -e\n-//    --print / -p\n-//    --check / -c\n-//    --interactive / -i\n-//    --prof-process\n-//    --v8-options\n-//  These flags are disallowed because security:\n-//    --preserve-symlinks\n-const char* const environment_flags[] = {\n-  // Node options, sorted in `node --help` order for ease of comparison.\n-  \"--enable-fips\",\n-  \"--experimental-modules\",\n-  \"--experimenatl-repl-await\",\n-  \"--experimental-vm-modules\",\n-  \"--experimental-worker\",\n-  \"--force-fips\",\n-  \"--icu-data-dir\",\n-  \"--inspect\",\n-  \"--inspect-brk\",\n-  \"--inspect-port\",\n-  \"--loader\",\n-  \"--napi-modules\",\n-  \"--no-deprecation\",\n-  \"--no-force-async-hooks-checks\",\n-  \"--no-warnings\",\n-  \"--openssl-config\",\n-  \"--pending-deprecation\",\n-  \"--redirect-warnings\",\n-  \"--require\",\n-  \"--throw-deprecation\",\n-  \"--tls-cipher-list\",\n-  \"--trace-deprecation\",\n-  \"--trace-event-categories\",\n-  \"--trace-event-file-pattern\",\n-  \"--trace-events-enabled\",\n-  \"--trace-sync-io\",\n-  \"--trace-warnings\",\n-  \"--track-heap-objects\",\n-  \"--use-bundled-ca\",\n-  \"--use-openssl-ca\",\n-  \"--v8-pool-size\",\n-  \"--zero-fill-buffers\",\n-  \"-r\"\n-};\n-\n-  // V8 options (define with '_', which allows '-' or '_')\n-const char* const v8_environment_flags[] = {\n-  \"--abort_on_uncaught_exception\",\n-  \"--max_old_space_size\",\n-  \"--perf_basic_prof\",\n-  \"--perf_prof\",\n-  \"--stack_trace_limit\",\n-};\n-\n-int v8_environment_flags_count = arraysize(v8_environment_flags);\n-int environment_flags_count = arraysize(environment_flags);\n-\n // Look up environment variable unless running as setuid root.\n bool SafeGetenv(const char* key, std::string* text) {\n #if !defined(__CloudABI__) && !defined(_WIN32)"
        },
        {
            "sha": "e9561be9d7f1faf50fec148dc7b2d1e4aafaf562",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/995782c87279e05952559d83237174354646359d/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/995782c87279e05952559d83237174354646359d/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=995782c87279e05952559d83237174354646359d",
            "patch": "@@ -5,7 +5,6 @@\n \n namespace node {\n \n-using v8::Array;\n using v8::Boolean;\n using v8::Context;\n using v8::Integer;\n@@ -137,22 +136,6 @@ static void Initialize(Local<Object> target,\n   READONLY_PROPERTY(debug_options_obj,\n                     \"inspectorEnabled\",\n                     Boolean::New(isolate, debug_options->inspector_enabled));\n-\n-  Local<Array> environmentFlags = Array::New(env->isolate(),\n-                                  environment_flags_count);\n-  READONLY_PROPERTY(target, \"allowedNodeEnvironmentFlags\", environmentFlags);\n-  for (int i = 0; i < environment_flags_count; ++i) {\n-    environmentFlags->Set(i, OneByteString(env->isolate(),\n-        environment_flags[i]));\n-  }\n-\n-  Local<Array> v8EnvironmentFlags = Array::New(env->isolate(),\n-                                    v8_environment_flags_count);\n-  READONLY_PROPERTY(target, \"allowedV8EnvironmentFlags\", v8EnvironmentFlags);\n-  for (int i = 0; i < v8_environment_flags_count; ++i) {\n-    v8EnvironmentFlags->Set(i, OneByteString(env->isolate(),\n-        v8_environment_flags[i]));\n-  }\n }  // InitConfig\n \n }  // namespace node"
        },
        {
            "sha": "5cf606ddeecd72c8113e50437ba88502adc3f924",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/995782c87279e05952559d83237174354646359d/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/995782c87279e05952559d83237174354646359d/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=995782c87279e05952559d83237174354646359d",
            "patch": "@@ -180,11 +180,6 @@ extern bool v8_initialized;\n extern Mutex per_process_opts_mutex;\n extern std::shared_ptr<PerProcessOptions> per_process_opts;\n \n-extern const char* const environment_flags[];\n-extern int environment_flags_count;\n-extern const char* const v8_environment_flags[];\n-extern int v8_environment_flags_count;\n-\n // Forward declaration\n class Environment;\n "
        },
        {
            "sha": "b853bdd539852e71f4620846bf263c7022280f9a",
            "filename": "test/parallel/test-process-env-allowed-flags.js",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/995782c87279e05952559d83237174354646359d/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "raw_url": "https://github.com/nodejs/node/raw/995782c87279e05952559d83237174354646359d/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-allowed-flags.js?ref=995782c87279e05952559d83237174354646359d",
            "patch": "@@ -6,8 +6,6 @@ require('../common');\n // assert legit flags are allowed, and bogus flags are disallowed\n {\n   const goodFlags = [\n-    '--inspect-brk',\n-    'inspect-brk',\n     '--perf_basic_prof',\n     '--perf-basic-prof',\n     'perf-basic-prof',\n@@ -17,8 +15,11 @@ require('../common');\n     '-r',\n     'r',\n     '--stack-trace-limit=100',\n-    '--stack-trace-limit=-=xX_nodejs_Xx=-'\n-  ];\n+    '--stack-trace-limit=-=xX_nodejs_Xx=-',\n+  ].concat(process.config.variables.v8_enable_inspector ? [\n+    '--inspect-brk',\n+    'inspect-brk',\n+  ] : []);\n \n   const badFlags = [\n     '--inspect_brk',"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 47,
        "deletions": 91
    }
}