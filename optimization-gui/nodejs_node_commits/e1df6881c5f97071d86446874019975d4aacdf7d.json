{
    "author": "addaleax",
    "message": "src: do not cache `NumberOfHeapSpaces()` globally\n\nWhile `NumberOfHeapSpaces()` currently returns a constant value,\nthat is not strictly guaranteed by the V8 API as far as I can tell.\nTherefore, caching it globally does not seem appropriate.\n\n(The motivation here is that this squelches warnings which are\nproduced by concurrency debugging tooling due to the apparent\nrace conditions when accessing the global variable.)\n\nPR-URL: https://github.com/nodejs/node/pull/20971\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e1df6881c5f97071d86446874019975d4aacdf7d",
    "files": [
        {
            "sha": "d546eeba93f4d928a48a024ab7858ffe68afacd9",
            "filename": "src/node_v8.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/e1df6881c5f97071d86446874019975d4aacdf7d/src%2Fnode_v8.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e1df6881c5f97071d86446874019975d4aacdf7d/src%2Fnode_v8.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_v8.cc?ref=e1df6881c5f97071d86446874019975d4aacdf7d",
            "patch": "@@ -71,9 +71,6 @@ static const size_t kHeapSpaceStatisticsPropertiesCount =\n     HEAP_SPACE_STATISTICS_PROPERTIES(V);\n #undef V\n \n-// Will be populated in InitializeV8Bindings.\n-static size_t number_of_heap_spaces = 0;\n-\n \n void CachedDataVersionTag(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n@@ -100,6 +97,7 @@ void UpdateHeapSpaceStatisticsBuffer(const FunctionCallbackInfo<Value>& args) {\n   HeapSpaceStatistics s;\n   Isolate* const isolate = env->isolate();\n   double* buffer = env->heap_space_statistics_buffer();\n+  size_t number_of_heap_spaces = env->isolate()->NumberOfHeapSpaces();\n \n   for (size_t i = 0; i < number_of_heap_spaces; i++) {\n     isolate->GetHeapSpaceStatistics(&s, i);\n@@ -153,7 +151,7 @@ void Initialize(Local<Object> target,\n               Uint32::NewFromUnsigned(env->isolate(),\n                                       kHeapSpaceStatisticsPropertiesCount));\n \n-  number_of_heap_spaces = env->isolate()->NumberOfHeapSpaces();\n+  size_t number_of_heap_spaces = env->isolate()->NumberOfHeapSpaces();\n \n   // Heap space names are extracted once and exposed to JavaScript to\n   // avoid excessive creation of heap space name Strings."
        }
    ],
    "stats": {
        "total": 6,
        "additions": 2,
        "deletions": 4
    }
}