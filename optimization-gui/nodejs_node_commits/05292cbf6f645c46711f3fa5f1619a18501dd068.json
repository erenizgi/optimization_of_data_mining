{
    "author": "danbev",
    "message": "src: extract common sockaddr creation code\n\nThis commit extracts code to create sockaddr which is shared by both\nUDPWrap::DoBind and UDPWrap::DoSend.\n\nPR-URL: https://github.com/nodejs/node/pull/26070\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "05292cbf6f645c46711f3fa5f1619a18501dd068",
    "files": [
        {
            "sha": "be1f59d2c5286360d1f9242a9d9929cee28ad56c",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 32,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/05292cbf6f645c46711f3fa5f1619a18501dd068/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/05292cbf6f645c46711f3fa5f1619a18501dd068/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=05292cbf6f645c46711f3fa5f1619a18501dd068",
            "patch": "@@ -175,6 +175,19 @@ void UDPWrap::GetFD(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(fd);\n }\n \n+int sockaddr_for_family(int address_family,\n+                        const char* address,\n+                        const unsigned short port,\n+                        struct sockaddr_storage* addr) {\n+  switch (address_family) {\n+  case AF_INET:\n+    return uv_ip4_addr(address, port, reinterpret_cast<sockaddr_in*>(addr));\n+  case AF_INET6:\n+    return uv_ip6_addr(address, port, reinterpret_cast<sockaddr_in6*>(addr));\n+  default:\n+    CHECK(0 && \"unexpected address family\");\n+  }\n+}\n \n void UDPWrap::DoBind(const FunctionCallbackInfo<Value>& args, int family) {\n   UDPWrap* wrap;\n@@ -191,24 +204,11 @@ void UDPWrap::DoBind(const FunctionCallbackInfo<Value>& args, int family) {\n   if (!args[1]->Uint32Value(ctx).To(&port) ||\n       !args[2]->Uint32Value(ctx).To(&flags))\n     return;\n-  char addr[sizeof(sockaddr_in6)];\n-  int err;\n-\n-  switch (family) {\n-  case AF_INET:\n-    err = uv_ip4_addr(*address, port, reinterpret_cast<sockaddr_in*>(&addr));\n-    break;\n-  case AF_INET6:\n-    err = uv_ip6_addr(*address, port, reinterpret_cast<sockaddr_in6*>(&addr));\n-    break;\n-  default:\n-    CHECK(0 && \"unexpected address family\");\n-    ABORT();\n-  }\n-\n+  struct sockaddr_storage addr_storage;\n+  int err = sockaddr_for_family(family, address.out(), port, &addr_storage);\n   if (err == 0) {\n     err = uv_udp_bind(&wrap->handle_,\n-                      reinterpret_cast<const sockaddr*>(&addr),\n+                      reinterpret_cast<const sockaddr*>(&addr_storage),\n                       flags);\n   }\n \n@@ -392,27 +392,14 @@ void UDPWrap::DoSend(const FunctionCallbackInfo<Value>& args, int family) {\n \n   req_wrap->msg_size = msg_size;\n \n-  char addr[sizeof(sockaddr_in6)];\n-  int err;\n-\n-  switch (family) {\n-  case AF_INET:\n-    err = uv_ip4_addr(*address, port, reinterpret_cast<sockaddr_in*>(&addr));\n-    break;\n-  case AF_INET6:\n-    err = uv_ip6_addr(*address, port, reinterpret_cast<sockaddr_in6*>(&addr));\n-    break;\n-  default:\n-    CHECK(0 && \"unexpected address family\");\n-    ABORT();\n-  }\n-\n+  struct sockaddr_storage addr_storage;\n+  int err = sockaddr_for_family(family, address.out(), port, &addr_storage);\n   if (err == 0) {\n     err = req_wrap->Dispatch(uv_udp_send,\n                              &wrap->handle_,\n                              *bufs,\n                              count,\n-                             reinterpret_cast<const sockaddr*>(&addr),\n+                             reinterpret_cast<const sockaddr*>(&addr_storage),\n                              OnSend);\n   }\n "
        }
    ],
    "stats": {
        "total": 51,
        "additions": 19,
        "deletions": 32
    }
}