{
    "author": "apapirovski",
    "message": "timers: reschedule interval even if it threw\n\nTo match browser behaviour, intervals should continue being\nscheduled even if the user callback threw during execution.\n\nPR-URL: https://github.com/nodejs/node/pull/20002\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce",
    "files": [
        {
            "sha": "30bffb432ac26b5e197ee32fe84a80e03aad64ef",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce",
            "patch": "@@ -285,15 +285,18 @@ function tryOnTimeout(timer, start) {\n   var threw = true;\n   if (timerAsyncId !== null)\n     emitBefore(timerAsyncId, timer[trigger_async_id_symbol]);\n+  if (start === undefined && timer._repeat)\n+    start = TimerWrap.now();\n   try {\n-    ontimeout(timer, start);\n+    ontimeout(timer);\n     threw = false;\n   } finally {\n     if (timerAsyncId !== null) {\n       if (!threw)\n         emitAfter(timerAsyncId);\n-      if ((threw || !timer._repeat) && destroyHooksExist() &&\n-          !timer._destroyed) {\n+      if (timer._repeat) {\n+        rearm(timer, start);\n+      } else if (destroyHooksExist() && !timer._destroyed) {\n         emitDestroy(timerAsyncId);\n         timer._destroyed = true;\n       }\n@@ -417,18 +420,14 @@ setTimeout[internalUtil.promisify.custom] = function(after, value) {\n exports.setTimeout = setTimeout;\n \n \n-function ontimeout(timer, start) {\n+function ontimeout(timer) {\n   const args = timer._timerArgs;\n   if (typeof timer._onTimeout !== 'function')\n     return promiseResolve(timer._onTimeout, args[0]);\n-  if (start === undefined && timer._repeat)\n-    start = TimerWrap.now();\n   if (!args)\n     timer._onTimeout();\n   else\n     Reflect.apply(timer._onTimeout, timer, args);\n-  if (timer._repeat)\n-    rearm(timer, start);\n }\n \n function rearm(timer, start = TimerWrap.now()) {"
        },
        {
            "sha": "10b2bafb2a2598542f329035829f7141bc1aa1d3",
            "filename": "test/async-hooks/test-timers.setInterval.js",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/test%2Fasync-hooks%2Ftest-timers.setInterval.js",
            "raw_url": "https://github.com/nodejs/node/raw/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/test%2Fasync-hooks%2Ftest-timers.setInterval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-timers.setInterval.js?ref=198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce",
            "patch": "@@ -9,7 +9,7 @@ const TIMEOUT = common.platformTimeout(100);\n const hooks = initHooks();\n hooks.enable();\n \n-setInterval(common.mustCall(ontimeout), TIMEOUT);\n+const interval = setInterval(common.mustCall(ontimeout, 2), TIMEOUT);\n const as = hooks.activitiesOfTypes('Timeout');\n assert.strictEqual(as.length, 1);\n const t1 = as[0];\n@@ -18,9 +18,18 @@ assert.strictEqual(typeof t1.uid, 'number');\n assert.strictEqual(typeof t1.triggerAsyncId, 'number');\n checkInvocations(t1, { init: 1 }, 't1: when timer installed');\n \n+let iter = 0;\n function ontimeout() {\n-  checkInvocations(t1, { init: 1, before: 1 }, 't1: when first timer fired');\n-\n+  if (iter === 0) {\n+    checkInvocations(t1, { init: 1, before: 1 }, 't1: when first timer fired');\n+  } else {\n+    checkInvocations(t1, { init: 1, before: 2, after: 1 },\n+                     't1: when first interval fired again');\n+    clearInterval(interval);\n+    return;\n+  }\n+\n+  iter++;\n   throw new Error('setInterval Error');\n }\n \n@@ -32,6 +41,6 @@ process.on('exit', () => {\n   hooks.disable();\n   hooks.sanityCheck('Timeout');\n \n-  checkInvocations(t1, { init: 1, before: 1, after: 1, destroy: 1 },\n+  checkInvocations(t1, { init: 1, before: 2, after: 2, destroy: 1 },\n                    't1: when process exits');\n });"
        },
        {
            "sha": "876f0de55aa27ef7755b9096449322f12e75af5e",
            "filename": "test/parallel/test-timers-interval-throw.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/test%2Fparallel%2Ftest-timers-interval-throw.js",
            "raw_url": "https://github.com/nodejs/node/raw/198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce/test%2Fparallel%2Ftest-timers-interval-throw.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-interval-throw.js?ref=198eb9c5d6ac6a90dadb8c58396f9b35eaf6f5ce",
            "patch": "@@ -0,0 +1,17 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+// To match browser behaviour, interval should continue\n+// being rescheduled even if it throws.\n+\n+let count = 2;\n+const interval = setInterval(() => { throw new Error('IntervalError'); }, 1);\n+\n+process.on('uncaughtException', common.mustCall((err) => {\n+  assert.strictEqual(err.message, 'IntervalError');\n+  if (--count === 0) {\n+    clearInterval(interval);\n+  }\n+}, 2));"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 37,
        "deletions": 12
    }
}