{
    "author": "Trott",
    "message": "test: remove internal errorCache property\n\nThe internal `assert` modules `errorCache` property is exposed only for\ntesting. The one test that used it is rewritten here to not use it.\n\nThis has the following advantages:\n\n* The test now makes sure that there is an empty cache in a more robust\n  way. Instead of relying on the internal implementation of\n  `errorCache`, it simply spawns a separate process.\n* One less test using the `--expose-internals` flag.\n\nPR-URL: https://github.com/nodejs/node/pull/23304\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "1f94b850690c2d43d9e29529409d80b372b54484",
    "files": [
        {
            "sha": "7855f830add10b984dac45de8245ecb8f5ac054a",
            "filename": "test/parallel/test-assert-builtins-not-read-from-filesystem.js",
            "status": "modified",
            "additions": 26,
            "deletions": 29,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/1f94b850690c2d43d9e29529409d80b372b54484/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js",
            "raw_url": "https://github.com/nodejs/node/raw/1f94b850690c2d43d9e29529409d80b372b54484/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js?ref=1f94b850690c2d43d9e29529409d80b372b54484",
            "patch": "@@ -5,47 +5,44 @@\n \n require('../common');\n const assert = require('assert');\n+const EventEmitter = require('events');\n+const e = new EventEmitter();\n+e.on('hello', assert);\n \n if (process.argv[2] !== 'child') {\n   const tmpdir = require('../common/tmpdir');\n   tmpdir.refresh();\n   const { spawnSync } = require('child_process');\n-  const { output, status, error } =\n-    spawnSync(process.execPath,\n-              ['--expose-internals', process.argv[1], 'child'],\n-              { cwd: tmpdir.path, env: process.env });\n-  assert.ifError(error);\n-  assert.strictEqual(status, 0, `Exit code: ${status}\\n${output}`);\n-} else {\n-  const EventEmitter = require('events');\n-  const { errorCache } = require('internal/assert');\n-  const { writeFileSync } = require('fs');\n-  const e = new EventEmitter();\n-\n-  e.on('hello', assert);\n \n   let threw = false;\n   try {\n     e.emit('hello', false);\n   } catch (err) {\n     const frames = err.stack.split('\\n');\n-    const [, filename, line, column] = frames[1].match(/\\((.+):(\\d+):(\\d+)\\)/);\n-    // Reset the cache to check again\n-    const size = errorCache.size;\n-    errorCache.delete(`${filename}${line - 1}${column - 1}`);\n-    assert.strictEqual(errorCache.size, size - 1);\n-    const data = `${'\\n'.repeat(line - 1)}${' '.repeat(column - 1)}` +\n-                 'ok(failed(badly));';\n+    const [, filename, , ] = frames[1].match(/\\((.+):(\\d+):(\\d+)\\)/);\n+    // Spawn a child process to avoid the error having been cached in the assert\n+    // module's `errorCache` Map.\n \n-    writeFileSync(filename, data);\n-    assert.throws(\n-      () => e.emit('hello', false),\n-      {\n-        message: 'false == true'\n-      }\n-    );\n+    const { output, status, error } =\n+      spawnSync(process.execPath,\n+                [process.argv[1], 'child', filename],\n+                { cwd: tmpdir.path, env: process.env });\n+    assert.ifError(error);\n+    assert.strictEqual(status, 0, `Exit code: ${status}\\n${output}`);\n     threw = true;\n-\n   }\n-  assert(threw);\n+  assert.ok(threw);\n+} else {\n+  const { writeFileSync } = require('fs');\n+  const [, , , filename, line, column] = process.argv;\n+  const data = `${'\\n'.repeat(line - 1)}${' '.repeat(column - 1)}` +\n+               'ok(failed(badly));';\n+\n+  writeFileSync(filename, data);\n+  assert.throws(\n+    () => e.emit('hello', false),\n+    {\n+      message: 'false == true'\n+    }\n+  );\n }"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 26,
        "deletions": 29
    }
}