{
    "author": "joyeecheung",
    "message": "process: normalize process.argv before user code execution\n\nAnd make sure that `process.argv` from the preloaded modules\nis the same as the one in the main module.\n\nRefs: https://github.com/nodejs/node/issues/25967\nPR-URL: https://github.com/nodejs/node/pull/26000\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>",
    "sha": "69714ab1c44f45f7949484ab7f4574f3ad9894ce",
    "files": [
        {
            "sha": "392fadb99ff668affa37a79527301f4350bef022",
            "filename": "lib/internal/main/check_syntax.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/69714ab1c44f45f7949484ab7f4574f3ad9894ce/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "raw_url": "https://github.com/nodejs/node/raw/69714ab1c44f45f7949484ab7f4574f3ad9894ce/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fcheck_syntax.js?ref=69714ab1c44f45f7949484ab7f4574f3ad9894ce",
            "patch": "@@ -17,9 +17,6 @@ const {\n   stripShebang, stripBOM\n } = require('internal/modules/cjs/helpers');\n \n-// TODO(joyeecheung): not every one of these are necessary\n-prepareMainThreadExecution();\n-markBootstrapComplete();\n \n if (process.argv[1] && process.argv[1] !== '-') {\n   // Expand process.argv[1] into a full path.\n@@ -31,8 +28,16 @@ if (process.argv[1] && process.argv[1] !== '-') {\n   const fs = require('fs');\n   const source = fs.readFileSync(filename, 'utf-8');\n \n+  // TODO(joyeecheung): not every one of these are necessary\n+  prepareMainThreadExecution();\n+  markBootstrapComplete();\n+\n   checkScriptSyntax(source, filename);\n } else {\n+  // TODO(joyeecheung): not every one of these are necessary\n+  prepareMainThreadExecution();\n+  markBootstrapComplete();\n+\n   readStdin((code) => {\n     checkScriptSyntax(code, '[stdin]');\n   });"
        },
        {
            "sha": "634abe493ea60e5e3eecb9c6125226fa0b7c36d6",
            "filename": "lib/internal/main/run_main_module.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/69714ab1c44f45f7949484ab7f4574f3ad9894ce/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "raw_url": "https://github.com/nodejs/node/raw/69714ab1c44f45f7949484ab7f4574f3ad9894ce/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frun_main_module.js?ref=69714ab1c44f45f7949484ab7f4574f3ad9894ce",
            "patch": "@@ -4,12 +4,12 @@ const {\n   prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n \n-prepareMainThreadExecution();\n-\n // Expand process.argv[1] into a full path.\n const path = require('path');\n process.argv[1] = path.resolve(process.argv[1]);\n \n+prepareMainThreadExecution();\n+\n const CJSModule = require('internal/modules/cjs/loader');\n \n markBootstrapComplete();"
        },
        {
            "sha": "ace20dfb3947c430bbfdb8d126ca207239f0e5fc",
            "filename": "test/parallel/test-preload-print-process-argv.js",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/69714ab1c44f45f7949484ab7f4574f3ad9894ce/test%2Fparallel%2Ftest-preload-print-process-argv.js",
            "raw_url": "https://github.com/nodejs/node/raw/69714ab1c44f45f7949484ab7f4574f3ad9894ce/test%2Fparallel%2Ftest-preload-print-process-argv.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-preload-print-process-argv.js?ref=69714ab1c44f45f7949484ab7f4574f3ad9894ce",
            "patch": "@@ -0,0 +1,38 @@\n+'use strict';\n+\n+// This tests that process.argv is the same in the preloaded module\n+// and the user module.\n+\n+const common = require('../common');\n+\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+const fs = require('fs');\n+\n+if (!common.isMainThread) {\n+  common.skip('Cannot chdir to the tmp directory in workers');\n+}\n+\n+tmpdir.refresh();\n+\n+process.chdir(tmpdir.path);\n+fs.writeFileSync(\n+  'preload.js',\n+  'console.log(JSON.stringify(process.argv));',\n+  'utf-8');\n+\n+fs.writeFileSync(\n+  'main.js',\n+  'console.log(JSON.stringify(process.argv));',\n+  'utf-8');\n+\n+const child = spawnSync(process.execPath, ['-r', './preload.js', 'main.js']);\n+\n+if (child.status !== 0) {\n+  console.log(child.stderr.toString());\n+  assert.strictEqual(child.status, 0);\n+}\n+\n+const lines = child.stdout.toString().trim().split('\\n');\n+assert.deepStrictEqual(JSON.parse(lines[0]), JSON.parse(lines[1]));"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 48,
        "deletions": 5
    }
}