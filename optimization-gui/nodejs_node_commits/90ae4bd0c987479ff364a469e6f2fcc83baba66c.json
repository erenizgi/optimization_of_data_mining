{
    "author": "danbev",
    "message": "src: add InitializeV8Platform function\n\nThis commit adds an InitializeV8Platform function which calls\nv8_platform's Initialize to create the NodePlatform and also set the\nstructs members.\n\nWhen running cctests this functions was not being called (it is called\nfrom the Start function but that function is not called by the test\nfixture.\n\nThe motivation for adding this is that I'm guessing that embedders\nwould might need the ability to do the same thing.\n\nRefs: https://github.com/nodejs/node-v8/issues/69\n\nPR-URL: https://github.com/nodejs/node/pull/21983\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "90ae4bd0c987479ff364a469e6f2fcc83baba66c",
    "files": [
        {
            "sha": "89e4f76caca049d05f8d0576ec821960de9e1d3e",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/90ae4bd0c987479ff364a469e6f2fcc83baba66c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/90ae4bd0c987479ff364a469e6f2fcc83baba66c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=90ae4bd0c987479ff364a469e6f2fcc83baba66c",
            "patch": "@@ -2990,6 +2990,12 @@ MultiIsolatePlatform* CreatePlatform(\n }\n \n \n+MultiIsolatePlatform* InitializeV8Platform(int thread_pool_size) {\n+  v8_platform.Initialize(thread_pool_size);\n+  return v8_platform.Platform();\n+}\n+\n+\n void FreePlatform(MultiIsolatePlatform* platform) {\n   delete platform;\n }\n@@ -3209,8 +3215,7 @@ int Start(int argc, char** argv) {\n   V8::SetEntropySource(crypto::EntropySource);\n #endif  // HAVE_OPENSSL\n \n-  v8_platform.Initialize(\n-      per_process_opts->v8_thread_pool_size);\n+  InitializeV8Platform(per_process_opts->v8_thread_pool_size);\n   V8::Initialize();\n   performance::performance_v8_start = PERFORMANCE_NOW();\n   v8_initialized = true;"
        },
        {
            "sha": "9b4dfa6e149db7337f674cbd7cc9c5e22f1b6164",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/90ae4bd0c987479ff364a469e6f2fcc83baba66c/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/90ae4bd0c987479ff364a469e6f2fcc83baba66c/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=90ae4bd0c987479ff364a469e6f2fcc83baba66c",
            "patch": "@@ -291,6 +291,7 @@ NODE_EXTERN MultiIsolatePlatform* GetMainThreadMultiIsolatePlatform();\n NODE_EXTERN MultiIsolatePlatform* CreatePlatform(\n     int thread_pool_size,\n     v8::TracingController* tracing_controller);\n+MultiIsolatePlatform* InitializeV8Platform(int thread_pool_size);\n NODE_EXTERN void FreePlatform(MultiIsolatePlatform* platform);\n \n NODE_EXTERN void EmitBeforeExit(Environment* env);"
        },
        {
            "sha": "775a211f54380a72b7ac7da5c0dbfdaa537361fe",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/90ae4bd0c987479ff364a469e6f2fcc83baba66c/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/90ae4bd0c987479ff364a469e6f2fcc83baba66c/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=90ae4bd0c987479ff364a469e6f2fcc83baba66c",
            "patch": "@@ -70,9 +70,9 @@ class NodeTestFixture : public ::testing::Test {\n     tracing_controller.reset(new v8::TracingController());\n     node::tracing::TraceEventHelper::SetTracingController(\n         tracing_controller.get());\n-    platform.reset(new node::NodePlatform(4, nullptr));\n     CHECK_EQ(0, uv_loop_init(&current_loop));\n-    v8::V8::InitializePlatform(platform.get());\n+    platform.reset(static_cast<node::NodePlatform*>(\n+          node::InitializeV8Platform(4)));\n     v8::V8::Initialize();\n   }\n \n@@ -88,10 +88,8 @@ class NodeTestFixture : public ::testing::Test {\n   virtual void SetUp() {\n     allocator = ArrayBufferUniquePtr(node::CreateArrayBufferAllocator(),\n                                      &node::FreeArrayBufferAllocator);\n-    isolate_ = NewIsolate(allocator.get());\n+    isolate_ = NewIsolate(allocator.get(), &current_loop);\n     CHECK_NE(isolate_, nullptr);\n-    platform->RegisterIsolate(isolate_, &current_loop);\n-    v8::Isolate::Initialize(isolate_, params);\n   }\n \n   virtual void TearDown() {"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 11,
        "deletions": 7
    }
}