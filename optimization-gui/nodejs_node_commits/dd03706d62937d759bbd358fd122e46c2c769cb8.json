{
    "author": "jasnell",
    "message": "http2: throw better error when accessing unbound socket proxy\n\nFixes: https://github.com/nodejs/node/issues/22268\n\nPR-URL: https://github.com/nodejs/node/pull/22486\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "dd03706d62937d759bbd358fd122e46c2c769cb8",
    "files": [
        {
            "sha": "a29dc5be72209e371d3dde66e515d4b25ebef962",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/dd03706d62937d759bbd358fd122e46c2c769cb8/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/dd03706d62937d759bbd358fd122e46c2c769cb8/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=dd03706d62937d759bbd358fd122e46c2c769cb8",
            "patch": "@@ -1033,6 +1033,12 @@ The `Http2Session` settings canceled.\n An attempt was made to connect a `Http2Session` object to a `net.Socket` or\n `tls.TLSSocket` that had already been bound to another `Http2Session` object.\n \n+<a id=\"ERR_HTTP2_SOCKET_UNBOUND\"></a>\n+### ERR_HTTP2_SOCKET_UNBOUND\n+\n+An attempt was made to use the `socket` property of an `Http2Session` that\n+has already been closed.\n+\n <a id=\"ERR_HTTP2_STATUS_101\"></a>\n ### ERR_HTTP2_STATUS_101\n "
        },
        {
            "sha": "899979e5cc39e8f12e5a5e560d6af4b105d4f7d5",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/dd03706d62937d759bbd358fd122e46c2c769cb8/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd03706d62937d759bbd358fd122e46c2c769cb8/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=dd03706d62937d759bbd358fd122e46c2c769cb8",
            "patch": "@@ -588,6 +588,8 @@ E('ERR_HTTP2_SESSION_ERROR', 'Session closed with error code %s', Error);\n E('ERR_HTTP2_SETTINGS_CANCEL', 'HTTP2 session settings canceled', Error);\n E('ERR_HTTP2_SOCKET_BOUND',\n   'The socket is already bound to an Http2Session', Error);\n+E('ERR_HTTP2_SOCKET_UNBOUND',\n+  'The socket has been disconnected from the Http2Session', Error);\n E('ERR_HTTP2_STATUS_101',\n   'HTTP status code 101 (Switching Protocols) is forbidden in HTTP/2', Error);\n E('ERR_HTTP2_STATUS_INVALID', 'Invalid status code: %s', RangeError);"
        },
        {
            "sha": "61dd06b5edec76a6823f18ac93930ab96d201c54",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/dd03706d62937d759bbd358fd122e46c2c769cb8/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd03706d62937d759bbd358fd122e46c2c769cb8/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=dd03706d62937d759bbd358fd122e46c2c769cb8",
            "patch": "@@ -60,6 +60,7 @@ const {\n     ERR_HTTP2_SESSION_ERROR,\n     ERR_HTTP2_SETTINGS_CANCEL,\n     ERR_HTTP2_SOCKET_BOUND,\n+    ERR_HTTP2_SOCKET_UNBOUND,\n     ERR_HTTP2_STATUS_101,\n     ERR_HTTP2_STATUS_INVALID,\n     ERR_HTTP2_STREAM_CANCEL,\n@@ -685,12 +686,17 @@ const proxySocketHandler = {\n         throw new ERR_HTTP2_NO_SOCKET_MANIPULATION();\n       default:\n         const socket = session[kSocket];\n+        if (socket === undefined)\n+          throw new ERR_HTTP2_SOCKET_UNBOUND();\n         const value = socket[prop];\n         return typeof value === 'function' ? value.bind(socket) : value;\n     }\n   },\n   getPrototypeOf(session) {\n-    return Reflect.getPrototypeOf(session[kSocket]);\n+    const socket = session[kSocket];\n+    if (socket === undefined)\n+      throw new ERR_HTTP2_SOCKET_UNBOUND();\n+    return Reflect.getPrototypeOf(socket);\n   },\n   set(session, prop, value) {\n     switch (prop) {\n@@ -706,7 +712,10 @@ const proxySocketHandler = {\n       case 'write':\n         throw new ERR_HTTP2_NO_SOCKET_MANIPULATION();\n       default:\n-        session[kSocket][prop] = value;\n+        const socket = session[kSocket];\n+        if (socket === undefined)\n+          throw new ERR_HTTP2_SOCKET_UNBOUND();\n+        socket[prop] = value;\n         return true;\n     }\n   }"
        },
        {
            "sha": "44f113bac962f7430e48b41c67fd10c65c9616c2",
            "filename": "test/parallel/test-http2-unbound-socket-proxy.js",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/nodejs/node/blob/dd03706d62937d759bbd358fd122e46c2c769cb8/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd03706d62937d759bbd358fd122e46c2c769cb8/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js?ref=dd03706d62937d759bbd358fd122e46c2c769cb8",
            "patch": "@@ -0,0 +1,69 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const http2 = require('http2');\n+const net = require('net');\n+\n+const server = http2.createServer();\n+server.on('stream', common.mustCall((stream) => {\n+  stream.respond();\n+  stream.end('ok');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  const socket = client.socket;\n+  const req = client.request();\n+  req.resume();\n+  req.on('close', common.mustCall(() => {\n+    client.close();\n+    server.close();\n+\n+    // Tests to make sure accessing the socket proxy fails with an\n+    // informative error.\n+    setImmediate(common.mustCall(() => {\n+      common.expectsError(() => {\n+        socket.example;\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.example = 1;\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket instanceof net.Socket;\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.ref();\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.unref();\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.setEncoding();\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.setKeepAlive();\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+      common.expectsError(() => {\n+        socket.setNoDelay();\n+      }, {\n+        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n+      });\n+    }));\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 88,
        "deletions": 2
    }
}