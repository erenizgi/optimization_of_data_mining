{
    "author": "jasnell",
    "message": "console: add trace-events for time and count\n\nAdd the `node.console` trace event category to capture\n`console.count()`, `console.countReset()`, `console.time()`,\n`console.timeLog()`, and `console.timeEnd()` to the trace\nevent log.\n\nPR-URL: https://github.com/nodejs/node/pull/23703\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "9c82a1e7ba8d5ce7e743f99348cf992965594f0a",
    "files": [
        {
            "sha": "04db3f12f42e2e4ffd8ea31479b2bcce420c82d4",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=9c82a1e7ba8d5ce7e743f99348cf992965594f0a",
            "patch": "@@ -18,6 +18,8 @@ The available categories are:\n   The [`async_hooks`] events have a unique `asyncId` and a special `triggerId`\n   `triggerAsyncId` property.\n * `node.bootstrap` - Enables capture of Node.js bootstrap milestones.\n+* `node.console` - Enables capture of `console.time()` and `console.count()`\n+  output.\n * `node.environment` - Enables capture of Node.js Environment milestones.\n * `node.fs.sync` - Enables capture of trace data for file system sync methods.\n * `node.perf` - Enables capture of [Performance API] measurements."
        },
        {
            "sha": "96bd185585980991fe94db0c8420d000d1d6f932",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=9c82a1e7ba8d5ce7e743f99348cf992965594f0a",
            "patch": "@@ -21,6 +21,7 @@\n \n 'use strict';\n \n+const { trace } = internalBinding('trace_events');\n const {\n   isStackOverflowError,\n   codes: {\n@@ -37,6 +38,12 @@ const {\n } = util.types;\n const kCounts = Symbol('counts');\n \n+const kTraceConsoleCategory = 'node,node.console';\n+const kTraceCount = 'C'.charCodeAt(0);\n+const kTraceBegin = 'b'.charCodeAt(0);\n+const kTraceEnd = 'e'.charCodeAt(0);\n+const kTraceInstant = 'n'.charCodeAt(0);\n+\n const {\n   keys: ObjectKeys,\n   values: ObjectValues,\n@@ -232,13 +239,15 @@ Console.prototype.time = function time(label = 'default') {\n     process.emitWarning(`Label '${label}' already exists for console.time()`);\n     return;\n   }\n+  trace(kTraceBegin, kTraceConsoleCategory, `time::${label}`, 0);\n   this._times.set(label, process.hrtime());\n };\n \n Console.prototype.timeEnd = function timeEnd(label = 'default') {\n   // Coerces everything other than Symbol to a string\n   label = `${label}`;\n   const hasWarned = timeLogImpl(this, 'timeEnd', label);\n+  trace(kTraceEnd, kTraceConsoleCategory, `time::${label}`, 0);\n   if (!hasWarned) {\n     this._times.delete(label);\n   }\n@@ -248,6 +257,7 @@ Console.prototype.timeLog = function timeLog(label, ...data) {\n   // Coerces everything other than Symbol to a string\n   label = `${label}`;\n   timeLogImpl(this, 'timeLog', label, data);\n+  trace(kTraceInstant, kTraceConsoleCategory, `time::${label}`, 0);\n };\n \n // Returns true if label was not found\n@@ -308,6 +318,7 @@ Console.prototype.count = function count(label = 'default') {\n   else\n     count++;\n   counts.set(label, count);\n+  trace(kTraceCount, kTraceConsoleCategory, `count::${label}`, 0, count);\n   this.log(`${label}: ${count}`);\n };\n \n@@ -318,7 +329,7 @@ Console.prototype.countReset = function countReset(label = 'default') {\n     process.emitWarning(`Count for '${label}' does not exist`);\n     return;\n   }\n-\n+  trace(kTraceCount, kTraceConsoleCategory, `count::${label}`, 0, 0);\n   counts.delete(`${label}`);\n };\n "
        },
        {
            "sha": "a4860b5da008b4a2135c6756c698ffc61fa0e5ca",
            "filename": "test/parallel/test-trace-events-console.js",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/test%2Fparallel%2Ftest-trace-events-console.js",
            "raw_url": "https://github.com/nodejs/node/raw/9c82a1e7ba8d5ce7e743f99348cf992965594f0a/test%2Fparallel%2Ftest-trace-events-console.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-console.js?ref=9c82a1e7ba8d5ce7e743f99348cf992965594f0a",
            "patch": "@@ -0,0 +1,62 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+\n+// Tests that node.console trace events for counters and time methods are\n+// emitted as expected.\n+\n+const names = [\n+  'time::foo',\n+  'count::bar'\n+];\n+const expectedCounts = [ 1, 2, 0 ];\n+const expectedTimeTypes = [ 'b', 'n', 'e' ];\n+\n+if (process.argv[2] === 'child') {\n+  // The following console outputs exercise the test, causing node.console\n+  // trace events to be emitted for the counter and time calls.\n+  console.count('bar');\n+  console.count('bar');\n+  console.countReset('bar');\n+  console.time('foo');\n+  setImmediate(() => {\n+    console.timeLog('foo');\n+    setImmediate(() => {\n+      console.timeEnd('foo');\n+    });\n+  });\n+} else {\n+  tmpdir.refresh();\n+\n+  const proc = cp.fork(__filename,\n+                       [ 'child' ], {\n+                         cwd: tmpdir.path,\n+                         execArgv: [\n+                           '--trace-event-categories',\n+                           'node.console'\n+                         ]\n+                       });\n+\n+  proc.once('exit', common.mustCall(async () => {\n+    const file = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+    assert(fs.existsSync(file));\n+    const data = await fs.promises.readFile(file, { encoding: 'utf8' });\n+    JSON.parse(data).traceEvents\n+      .filter((trace) => trace.cat !== '__metadata')\n+      .forEach((trace) => {\n+        assert.strictEqual(trace.pid, proc.pid);\n+        assert(names.includes(trace.name));\n+        if (trace.name === 'count::bar')\n+          assert.strictEqual(trace.args.data, expectedCounts.shift());\n+        else if (trace.name === 'time::foo')\n+          assert.strictEqual(trace.ph, expectedTimeTypes.shift());\n+      });\n+    assert.strictEqual(expectedCounts.length, 0);\n+    assert.strictEqual(expectedTimeTypes.length, 0);\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 76,
        "deletions": 1
    }
}