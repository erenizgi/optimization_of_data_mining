{
    "author": "jasnell",
    "message": "http2: do not emit our own close emit in Http2Stream\n\nStreams were recently updated to emit their own close event. The\nHttp2Stream was an exception because it included the close argument\nwith the close event. Refactor that to use the built in close.\n\nPR-URL: https://github.com/nodejs/node/pull/19451\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "cef909797af1d716b802f04264e51cf7f26c1b51",
    "files": [
        {
            "sha": "050ef5d0b222d2a53d3c3e9c34b714261a770c95",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -335,7 +335,7 @@ Immediately terminates the `Http2Session` and the associated `net.Socket` or\n `tls.TLSSocket`.\n \n Once destroyed, the `Http2Session` will emit the `'close'` event. If `error`\n-is not undefined, an `'error'` event will be emitted immediately after the\n+is not undefined, an `'error'` event will be emitted immediately before the\n `'close'` event.\n \n If there are any remaining open `Http2Streams` associated with the\n@@ -816,9 +816,9 @@ added: v8.4.0\n The `'close'` event is emitted when the `Http2Stream` is destroyed. Once\n this event is emitted, the `Http2Stream` instance is no longer usable.\n \n-The listener callback is passed a single argument specifying the HTTP/2 error\n-code specified when closing the stream. If the code is any value other than\n-`NGHTTP2_NO_ERROR` (`0`), an `'error'` event will also be emitted.\n+The HTTP/2 error code used when closing the stream can be retrieved using\n+the `http2stream.rstCode` property. If the code is any value other than\n+`NGHTTP2_NO_ERROR` (`0`), an `'error'` event will have also been emitted.\n \n #### Event: 'error'\n <!-- YAML"
        },
        {
            "sha": "2485a145519494ed16c967de230072fddd230972",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -1503,7 +1503,6 @@ class Http2Stream extends Duplex {\n   constructor(session, options) {\n     options.allowHalfOpen = true;\n     options.decodeStrings = false;\n-    options.emitClose = false;\n     super(options);\n     this[async_id_symbol] = -1;\n \n@@ -1888,9 +1887,7 @@ class Http2Stream extends Duplex {\n     // will destroy if it has been closed and there are no other open or\n     // pending streams.\n     session[kMaybeDestroy]();\n-    process.nextTick(emit, this, 'close', code);\n     callback(err);\n-\n   }\n   // The Http2Stream can be destroyed if it has closed and if the readable\n   // side has received the final chunk."
        },
        {
            "sha": "3120a80b11ddf4052892dbeea2f01b87dcae1065",
            "filename": "test/parallel/test-http2-client-rststream-before-connect.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-client-rststream-before-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-client-rststream-before-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-rststream-before-connect.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -49,9 +49,9 @@ server.listen(0, common.mustCall(() => {\n   // Second call doesn't do anything.\n   req.close(closeCode + 1);\n \n-  req.on('close', common.mustCall((code) => {\n+  req.on('close', common.mustCall(() => {\n     assert.strictEqual(req.destroyed, true);\n-    assert.strictEqual(code, closeCode);\n+    assert.strictEqual(req.rstCode, closeCode);\n     server.close();\n     client.close();\n   }));"
        },
        {
            "sha": "d834de5d11ebe7e9f3719fd05be8f16bc59545b1",
            "filename": "test/parallel/test-http2-client-stream-destroy-before-connect.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -36,9 +36,9 @@ server.listen(0, common.mustCall(() => {\n     message: 'test'\n   }));\n \n-  req.on('close', common.mustCall((code) => {\n+  req.on('close', common.mustCall(() => {\n+    assert.strictEqual(req.rstCode, NGHTTP2_INTERNAL_ERROR);\n     assert.strictEqual(req.rstCode, NGHTTP2_INTERNAL_ERROR);\n-    assert.strictEqual(code, NGHTTP2_INTERNAL_ERROR);\n     server.close();\n     client.close();\n   }));"
        },
        {
            "sha": "6dbf54bf31c980a795164a18b5623f71cb8bd136",
            "filename": "test/parallel/test-http2-options-max-reserved-streams.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-options-max-reserved-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-options-max-reserved-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-options-max-reserved-streams.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -37,8 +37,8 @@ server.on('stream', common.mustCall((stream) => {\n     pushedStream.respond();\n     pushedStream.on('aborted', common.mustCall());\n     pushedStream.on('error', common.mustNotCall());\n-    pushedStream.on('close', common.mustCall((code) => {\n-      assert.strictEqual(code, 8);\n+    pushedStream.on('close', common.mustCall(() => {\n+      assert.strictEqual(pushedStream.rstCode, 8);\n       countdown.dec();\n     }));\n   }));"
        },
        {
            "sha": "e7218aaeea29af78bb3fa73359b593c860c36dd6",
            "filename": "test/parallel/test-http2-server-rst-before-respond.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-server-rst-before-respond.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-server-rst-before-respond.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-rst-before-respond.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -28,8 +28,8 @@ server.on('listening', common.mustCall(() => {\n   const client = h2.connect(`http://localhost:${server.address().port}`);\n   const req = client.request();\n   req.on('headers', common.mustNotCall());\n-  req.on('close', common.mustCall((code) => {\n-    assert.strictEqual(h2.constants.NGHTTP2_NO_ERROR, code);\n+  req.on('close', common.mustCall(() => {\n+    assert.strictEqual(h2.constants.NGHTTP2_NO_ERROR, req.rstCode);\n     server.close();\n     client.close();\n   }));"
        },
        {
            "sha": "132c32ead600dd4be58432d737eb566154b9276a",
            "filename": "test/parallel/test-http2-server-rst-stream.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-rst-stream.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -50,8 +50,8 @@ server.listen(0, common.mustCall(() => {\n       ':method': 'POST',\n       'rstcode': test[0]\n     });\n-    req.on('close', common.mustCall((code) => {\n-      assert.strictEqual(code, test[0]);\n+    req.on('close', common.mustCall(() => {\n+      assert.strictEqual(req.rstCode, test[0]);\n       countdown.dec();\n     }));\n     req.on('aborted', common.mustCall());"
        },
        {
            "sha": "b62a41d05f5984a4ed02996a469c5d47a549e54e",
            "filename": "test/parallel/test-http2-too-large-headers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-too-large-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-too-large-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-too-large-headers.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -22,8 +22,8 @@ server.listen(0, common.mustCall(() => {\n       type: Error,\n       message: 'Stream closed with error code NGHTTP2_ENHANCE_YOUR_CALM'\n     }));\n-    req.on('close', common.mustCall((code) => {\n-      assert.strictEqual(code, NGHTTP2_ENHANCE_YOUR_CALM);\n+    req.on('close', common.mustCall(() => {\n+      assert.strictEqual(req.rstCode, NGHTTP2_ENHANCE_YOUR_CALM);\n       server.close();\n       client.close();\n     }));"
        },
        {
            "sha": "6c8315c80ebf2fe8819e742abc5259cab8e3452a",
            "filename": "test/parallel/test-http2-too-many-headers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-too-many-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/cef909797af1d716b802f04264e51cf7f26c1b51/test%2Fparallel%2Ftest-http2-too-many-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-too-many-headers.js?ref=cef909797af1d716b802f04264e51cf7f26c1b51",
            "patch": "@@ -25,8 +25,8 @@ server.listen(0, common.mustCall(() => {\n     type: Error,\n     message: 'Stream closed with error code NGHTTP2_ENHANCE_YOUR_CALM'\n   }));\n-  req.on('close', common.mustCall((code) => {\n-    assert.strictEqual(code, NGHTTP2_ENHANCE_YOUR_CALM);\n+  req.on('close', common.mustCall(() => {\n+    assert.strictEqual(req.rstCode, NGHTTP2_ENHANCE_YOUR_CALM);\n     server.close();\n     client.close();\n   }));"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 18,
        "deletions": 21
    }
}