{
    "author": "yaelhe",
    "message": "worker: drain messages from internal message port\n\nWhen the worker thread exits, drain the messages also from the internal\nmessage port so that the call to 'kDispose' will occur only after all\nthe messages from the worker were processed in the parent, so stdio\nmessages from the worker will be successfully pushed to their target\nstreams in the parent.\n\nPR-URL: https://github.com/nodejs/node/pull/24932\nFixes: https://github.com/nodejs/node/issues/24636\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "c61327d37673ab2ea454d14c36329b113aaca32a",
    "files": [
        {
            "sha": "669a86bb23faef6c4cc0522e8423f03f3f1d83e2",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/c61327d37673ab2ea454d14c36329b113aaca32a/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/c61327d37673ab2ea454d14c36329b113aaca32a/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=c61327d37673ab2ea454d14c36329b113aaca32a",
            "patch": "@@ -317,6 +317,7 @@ class Worker extends EventEmitter {\n   [kOnExit](code) {\n     debug(`[${threadId}] hears end event for Worker ${this.threadId}`);\n     MessagePortPrototype.drain.call(this[kPublicPort]);\n+    MessagePortPrototype.drain.call(this[kPort]);\n     this[kDispose]();\n     this.emit('exit', code);\n     this.removeAllListeners();"
        },
        {
            "sha": "4fcb3da25e3f14b4769453bb104621f1f17acfa5",
            "filename": "test/parallel/test-worker-message-port-drain.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/c61327d37673ab2ea454d14c36329b113aaca32a/test%2Fparallel%2Ftest-worker-message-port-drain.js",
            "raw_url": "https://github.com/nodejs/node/raw/c61327d37673ab2ea454d14c36329b113aaca32a/test%2Fparallel%2Ftest-worker-message-port-drain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-drain.js?ref=c61327d37673ab2ea454d14c36329b113aaca32a",
            "patch": "@@ -0,0 +1,41 @@\n+// Flags: --experimental-worker\n+'use strict';\n+require('../common');\n+\n+// This test ensures that the messages from the internal\n+// message port are drained before the call to 'kDispose',\n+// and so all the stdio messages from the worker are processed\n+// in the parent and are pushed to their target streams.\n+\n+const assert = require('assert');\n+const {\n+  Worker,\n+  isMainThread,\n+  parentPort,\n+  threadId,\n+} = require('worker_threads');\n+\n+if (isMainThread) {\n+  const workerIdsToOutput = new Map();\n+\n+  for (let i = 0; i < 2; i++) {\n+    const worker = new Worker(__filename, { stdout: true });\n+    const workerOutput = [];\n+    workerIdsToOutput.set(worker.threadId, workerOutput);\n+    worker.on('message', console.log);\n+    worker.stdout.on('data', (chunk) => {\n+      workerOutput.push(chunk.toString().trim());\n+    });\n+  }\n+\n+  process.on('exit', () => {\n+    for (const [threadId, workerOutput] of workerIdsToOutput) {\n+      assert.ok(workerOutput.includes(`1 threadId: ${threadId}`));\n+      assert.ok(workerOutput.includes(`2 threadId: ${threadId}`));\n+    }\n+  });\n+} else {\n+  console.log(`1 threadId: ${threadId}`);\n+  console.log(`2 threadId: ${threadId}`);\n+  parentPort.postMessage(Array(100).fill(1));\n+}"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 42,
        "deletions": 0
    }
}