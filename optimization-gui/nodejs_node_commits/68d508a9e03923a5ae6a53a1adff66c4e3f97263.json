{
    "author": "addaleax",
    "message": "events: show throw stack trace for uncaught exception\n\nShow the stack trace for the `eventemitter.emit('error')` call\nin the case of an uncaught exception.\n\nPreviously, there would be no clue in Nodeâ€™s output about where\nthe actual `throw` comes from.\n\nPR-URL: https://github.com/nodejs/node/pull/19003\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "68d508a9e03923a5ae6a53a1adff66c4e3f97263",
    "files": [
        {
            "sha": "0a220b5d821e7f10397976a2909610066ac8b0ff",
            "filename": "lib/events.js",
            "status": "modified",
            "additions": 54,
            "deletions": 1,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Fevents.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Fevents.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fevents.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -98,6 +98,47 @@ EventEmitter.prototype.getMaxListeners = function getMaxListeners() {\n   return $getMaxListeners(this);\n };\n \n+// Returns the longest sequence of `a` that fully appears in `b`,\n+// of length at least 3.\n+// This is a lazy approach but should work well enough, given that stack\n+// frames are usually unequal or otherwise appear in groups, and that\n+// we only run this code in case of an unhandled exception.\n+function longestSeqContainedIn(a, b) {\n+  for (var len = a.length; len >= 3; --len) {\n+    for (var i = 0; i < a.length - len; ++i) {\n+      // Attempt to find a[i:i+len] in b\n+      for (var j = 0; j < b.length - len; ++j) {\n+        let matches = true;\n+        for (var k = 0; k < len; ++k) {\n+          if (a[i + k] !== b[j + k]) {\n+            matches = false;\n+            break;\n+          }\n+        }\n+        if (matches)\n+          return [ len, i, j ];\n+      }\n+    }\n+  }\n+\n+  return [ 0, 0, 0 ];\n+}\n+\n+function enhanceStackTrace(err, own) {\n+  const sep = '\\nEmitted \\'error\\' event at:\\n';\n+\n+  const errStack = err.stack.split('\\n').slice(1);\n+  const ownStack = own.stack.split('\\n').slice(1);\n+\n+  const [ len, off ] = longestSeqContainedIn(ownStack, errStack);\n+  if (len > 0) {\n+    ownStack.splice(off + 1, len - 1,\n+                    '    [... lines matching original stack trace ...]');\n+  }\n+  // Do this last, because it is the only operation with side effects.\n+  err.stack = err.stack + sep + ownStack.join('\\n');\n+}\n+\n EventEmitter.prototype.emit = function emit(type, ...args) {\n   let doError = (type === 'error');\n \n@@ -113,13 +154,25 @@ EventEmitter.prototype.emit = function emit(type, ...args) {\n     if (args.length > 0)\n       er = args[0];\n     if (er instanceof Error) {\n+      try {\n+        const { kExpandStackSymbol } = require('internal/util');\n+        const capture = {};\n+        Error.captureStackTrace(capture, EventEmitter.prototype.emit);\n+        Object.defineProperty(er, kExpandStackSymbol, {\n+          value: enhanceStackTrace.bind(null, er, capture),\n+          configurable: true\n+        });\n+      } catch (e) {}\n+\n+      // Note: The comments on the `throw` lines are intentional, they show\n+      // up in Node's output if this results in an unhandled exception.\n       throw er; // Unhandled 'error' event\n     }\n     // At least give some kind of context to the user\n     const errors = lazyErrors();\n     const err = new errors.Error('ERR_UNHANDLED_ERROR', er);\n     err.context = er;\n-    throw err;\n+    throw err; // Unhandled 'error' event\n   }\n \n   const handler = events[type];"
        },
        {
            "sha": "a0d508c5b135a33073117c8dc13735f10d5bcaa7",
            "filename": "lib/internal/bootstrap_node.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Finternal%2Fbootstrap_node.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Finternal%2Fbootstrap_node.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap_node.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -458,6 +458,11 @@\n         } catch (er) {\n           // nothing to be done about it at this point.\n         }\n+        try {\n+          const { kExpandStackSymbol } = NativeModule.require('internal/util');\n+          if (typeof er[kExpandStackSymbol] === 'function')\n+            er[kExpandStackSymbol]();\n+        } catch (er) {}\n         return false;\n       }\n "
        },
        {
            "sha": "6a4cf7ee2ae91d5394e6c0014a6f0308715cb85c",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -394,5 +394,6 @@ module.exports = {\n \n   // Used by the buffer module to capture an internal reference to the\n   // default isEncoding implementation, just in case userland overrides it.\n-  kIsEncodingSymbol: Symbol('node.isEncoding')\n+  kIsEncodingSymbol: Symbol('kIsEncodingSymbol'),\n+  kExpandStackSymbol: Symbol('kExpandStackSymbol')\n };"
        },
        {
            "sha": "e6c168fc06eb3311bb3f56ce7496c4cc98b8bea3",
            "filename": "test/message/events_unhandled_error_common_trace.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_common_trace.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_common_trace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_common_trace.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,20 @@\n+'use strict';\n+require('../common');\n+const EventEmitter = require('events');\n+\n+function foo() {\n+  function bar() {\n+    return new Error('foo:bar');\n+  }\n+\n+  return bar();\n+}\n+\n+const ee = new EventEmitter();\n+const err = foo();\n+\n+function quux() {\n+  ee.emit('error', err);\n+}\n+\n+quux();"
        },
        {
            "sha": "d39a95cb77f068c911c7bb2c5e60c38567968f60",
            "filename": "test/message/events_unhandled_error_common_trace.out",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_common_trace.out",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_common_trace.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_common_trace.out?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,22 @@\n+events.js:*\n+      throw er; // Unhandled 'error' event\n+      ^\n+\n+Error: foo:bar\n+    at bar (*events_unhandled_error_common_trace.js:*:*)\n+    at foo (*events_unhandled_error_common_trace.js:*:*)\n+    at Object.<anonymous> (*events_unhandled_error_common_trace.js:*:*)\n+    at Module._compile (module.js:*:*)\n+    at Object.Module._extensions..js (module.js:*:*)\n+    at Module.load (module.js:*:*)\n+    at tryModuleLoad (module.js:*:*)\n+    at Function.Module._load (module.js:*:*)\n+    at Function.Module.runMain (module.js:*:*)\n+    at startup (bootstrap_node.js:*:*)\n+Emitted 'error' event at:\n+    at quux (*events_unhandled_error_common_trace.js:*:*)\n+    at Object.<anonymous> (*events_unhandled_error_common_trace.js:*:*)\n+    at Module._compile (module.js:*:*)\n+    [... lines matching original stack trace ...]\n+    at startup (bootstrap_node.js:*:*)\n+    at bootstrap_node.js:*:*"
        },
        {
            "sha": "713031eeefa042990564303cd0fa401b2e76ccae",
            "filename": "test/message/events_unhandled_error_nexttick.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_nexttick.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_nexttick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_nexttick.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,7 @@\n+'use strict';\n+require('../common');\n+const EventEmitter = require('events');\n+const er = new Error();\n+process.nextTick(() => {\n+  new EventEmitter().emit('error', er);\n+});"
        },
        {
            "sha": "f0591610ffdb313019e5419680d3c6605f5ada2e",
            "filename": "test/message/events_unhandled_error_nexttick.out",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_nexttick.out?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,20 @@\n+events.js:*\n+      throw er; // Unhandled 'error' event\n+      ^\n+\n+Error\n+    at Object.<anonymous> (*events_unhandled_error_nexttick.js:*:*)\n+    at Module._compile (module.js:*:*)\n+    at Object.Module._extensions..js (module.js:*:*)\n+    at Module.load (module.js:*:*)\n+    at tryModuleLoad (module.js:*:*)\n+    at Function.Module._load (module.js:*:*)\n+    at Function.Module.runMain (module.js:*:*)\n+    at startup (bootstrap_node.js:*:*)\n+    at bootstrap_node.js:*:*\n+Emitted 'error' event at:\n+    at process.nextTick (*events_unhandled_error_nexttick.js:*:*)\n+    at process._tickCallback (internal/process/next_tick.js:*:*)\n+    at Function.Module.runMain (module.js:*:*)\n+    at startup (bootstrap_node.js:*:*)\n+    at bootstrap_node.js:*:*"
        },
        {
            "sha": "1e5e77d08c9919da43f4ff29f7d0df9734e82f41",
            "filename": "test/message/events_unhandled_error_sameline.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_sameline.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_sameline.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_sameline.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,4 @@\n+'use strict';\n+require('../common');\n+const EventEmitter = require('events');\n+new EventEmitter().emit('error', new Error());"
        },
        {
            "sha": "100c294276d04bfdbfdcb8ef1cbb249c4580acbe",
            "filename": "test/message/events_unhandled_error_sameline.out",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_sameline.out?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,19 @@\n+events.js:*\n+      throw er; // Unhandled 'error' event\n+      ^\n+\n+Error\n+    at Object.<anonymous> (*events_unhandled_error_sameline.js:*:*)\n+    at Module._compile (module.js:*:*)\n+    at Object.Module._extensions..js (module.js:*:*)\n+    at Module.load (module.js:*:*)\n+    at tryModuleLoad (module.js:*:*)\n+    at Function.Module._load (module.js:*:*)\n+    at Function.Module.runMain (module.js:*:*)\n+    at startup (bootstrap_node.js:*:*)\n+    at bootstrap_node.js:*:*\n+Emitted 'error' event at:\n+    at Object.<anonymous> (*events_unhandled_error_sameline.js:*:*)\n+    at Module._compile (module.js:*:*)\n+    [... lines matching original stack trace ...]\n+    at bootstrap_node.js:*:*"
        },
        {
            "sha": "c55322a5aa56c4ca240ad363574687a0eb498831",
            "filename": "test/parallel/test-events-uncaught-exception-stack.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fparallel%2Ftest-events-uncaught-exception-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/68d508a9e03923a5ae6a53a1adff66c4e3f97263/test%2Fparallel%2Ftest-events-uncaught-exception-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-events-uncaught-exception-stack.js?ref=68d508a9e03923a5ae6a53a1adff66c4e3f97263",
            "patch": "@@ -0,0 +1,16 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const EventEmitter = require('events');\n+\n+// Tests that the error stack where the exception was thrown is *not* appended.\n+\n+process.on('uncaughtException', common.mustCall((err) => {\n+  const lines = err.stack.split('\\n');\n+  assert.strictEqual(lines[0], 'Error');\n+  lines.slice(1).forEach((line) => {\n+    assert(/^    at/.test(line), `${line} has an unexpected format`);\n+  });\n+}));\n+\n+new EventEmitter().emit('error', new Error());"
        }
    ],
    "stats": {
        "total": 171,
        "additions": 169,
        "deletions": 2
    }
}