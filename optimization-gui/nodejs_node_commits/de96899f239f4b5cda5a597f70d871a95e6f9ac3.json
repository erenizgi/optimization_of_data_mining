{
    "author": "rvagg",
    "message": "build: require --openssl-no-asm if old assembler\n\nPR-URL: https://github.com/nodejs/node/pull/20226\nFixes: https://github.com/nodejs/node/issues/19944\nRefs: https://github.com/nodejs/node/pull/20217\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Myles Borins <myles.borins@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "de96899f239f4b5cda5a597f70d871a95e6f9ac3",
    "files": [
        {
            "sha": "0294e3a13114663835e039a7a6c6f9efda85ecd4",
            "filename": "configure",
            "status": "modified",
            "additions": 38,
            "deletions": 29,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/de96899f239f4b5cda5a597f70d871a95e6f9ac3/configure",
            "raw_url": "https://github.com/nodejs/node/raw/de96899f239f4b5cda5a597f70d871a95e6f9ac3/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=de96899f239f4b5cda5a597f70d871a95e6f9ac3",
            "patch": "@@ -650,7 +650,7 @@ def get_version_helper(cc, regexp):\n   if match:\n     return match.group(2)\n   else:\n-    return 0\n+    return '0'\n \n def get_nasm_version(asm):\n   try:\n@@ -661,15 +661,15 @@ def get_nasm_version(asm):\n     warn('''No acceptable ASM compiler found!\n          Please make sure you have installed NASM from http://www.nasm.us\n          and refer BUILDING.md.''')\n-    return 0\n+    return '0'\n \n   match = re.match(r\"NASM version ([2-9]\\.[0-9][0-9]+)\",\n                    proc.communicate()[0])\n \n   if match:\n     return match.group(1)\n   else:\n-    return 0\n+    return '0'\n \n def get_llvm_version(cc):\n   return get_version_helper(\n@@ -699,7 +699,7 @@ def get_gas_version(cc):\n   if match:\n     return match.group(1)\n   else:\n-    return 0\n+    return '0'\n \n # Note: Apple clang self-reports as clang 4.2.0 and gcc 4.2.1.  It passes\n # the version check more by accident than anything else but a more rigorous\n@@ -1084,6 +1084,19 @@ def configure_openssl(o):\n   variables['node_use_openssl'] = b(not options.without_ssl)\n   variables['node_shared_openssl'] = b(options.shared_openssl)\n   variables['openssl_no_asm'] = 1 if options.openssl_no_asm else 0\n+  variables['openssl_fips'] = ''\n+\n+  if options.without_ssl:\n+    def without_ssl_error(option):\n+      error('--without-ssl is incompatible with %s' % option)\n+    if options.shared_openssl:\n+      without_ssl_error('--shared-openssl')\n+    if options.openssl_no_asm:\n+      without_ssl_error('--openssl-no-asm')\n+    if options.openssl_fips:\n+      without_ssl_error('--openssl-fips')\n+    return\n+\n   if options.use_openssl_ca_store:\n     o['defines'] += ['NODE_OPENSSL_CERT_STORE']\n   if options.openssl_system_ca_path:\n@@ -1092,35 +1105,31 @@ def configure_openssl(o):\n   if options.without_node_options:\n       o['defines'] += ['NODE_WITHOUT_NODE_OPTIONS']\n \n-  # supported asm compiler for AVX2. See https://github.com/openssl/openssl/\n-  # blob/OpenSSL_1_1_0-stable/crypto/modes/asm/aesni-gcm-x86_64.pl#L52-L69\n-  openssl110_asm_supported = \\\n-  ('gas_version' in variables and variables['gas_version'] >= '2.23') or \\\n-  ('xcode_version' in variables and variables['xcode_version'] >= '5.0') or \\\n-  ('llvm_version' in variables and variables['llvm_version'] >= '3.3') or \\\n-  ('nasm_version' in variables and variables['nasm_version'] >= '2.10')\n+  if not options.shared_openssl and not options.openssl_no_asm:\n+    # supported asm compiler for AVX2. See https://github.com/openssl/openssl/\n+    # blob/OpenSSL_1_1_0-stable/crypto/modes/asm/aesni-gcm-x86_64.pl#L52-L69\n+    openssl110_asm_supported = \\\n+      ('gas_version' in variables and float(variables['gas_version']) >= 2.23) or \\\n+      ('xcode_version' in variables and float(variables['xcode_version']) >= 5.0) or \\\n+      ('llvm_version' in variables and float(variables['llvm_version']) >= 3.3) or \\\n+      ('nasm_version' in variables and float(variables['nasm_version']) >= 2.10)\n \n-  if not options.without_ssl and not openssl110_asm_supported and \\\n-\t  variables['openssl_no_asm'] == 0:\n-    warn('''openssl_no_asm is enabled due to missed or old assembler.\n-            Please refer BUILDING.md''')\n-    variables['openssl_no_asm'] = 1\n+    if not openssl110_asm_supported:\n+      error('''Did not find a new enough assembler, install one or build with\n+       --openssl-no-asm.\n+       Please refer to BUILDING.md''')\n+\n+  elif options.openssl_no_asm:\n+    warn('''--openssl-no-asm will result in binaries that do not take advantage\n+         of modern CPU cryptographic instructions and will therefore be slower.\n+         Please refer to BUILDING.md''')\n+\n+  if options.openssl_no_asm and options.shared_openssl:\n+    error('--openssl-no-asm is incompatible with --shared-openssl')\n \n   if options.openssl_fips:\n-     error('FIPS is not supported in this version')\n-  variables['openssl_fips'] = ''\n+     error('FIPS is not supported in this version of Node.js')\n \n-  if options.without_ssl:\n-    def without_ssl_error(option):\n-      print('Error: --without-ssl is incompatible with %s' % option)\n-      exit(1)\n-    if options.shared_openssl:\n-      without_ssl_error('--shared-openssl')\n-    if options.openssl_no_asm:\n-      without_ssl_error('--openssl-no-asm')\n-    if options.openssl_fips:\n-      without_ssl_error('--openssl-fips')\n-    return\n   configure_library('openssl', o)\n \n "
        }
    ],
    "stats": {
        "total": 67,
        "additions": 38,
        "deletions": 29
    }
}