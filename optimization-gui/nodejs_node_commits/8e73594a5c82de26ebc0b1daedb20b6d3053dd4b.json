{
    "author": "starkwang",
    "message": "net: port isIPv6 to JS\n\nPorting isIPv6() to JS makes it 10%-250% faster in most cases and\nreduces some C++ code. This change also adds tests for some edge\ncases.\n\nPR-URL: https://github.com/nodejs/node/pull/22673\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Roman Reiss <me@silverwind.io>",
    "sha": "8e73594a5c82de26ebc0b1daedb20b6d3053dd4b",
    "files": [
        {
            "sha": "d2b097573b918e1637f6818e1261c366b7249aa3",
            "filename": "lib/internal/net.js",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/lib%2Finternal%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/lib%2Finternal%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fnet.js?ref=8e73594a5c82de26ebc0b1daedb20b6d3053dd4b",
            "patch": "@@ -1,16 +1,33 @@\n 'use strict';\n \n const Buffer = require('buffer').Buffer;\n-const { internalBinding } = require('internal/bootstrap/loaders');\n-const { isIPv6 } = internalBinding('cares_wrap');\n const { writeBuffer } = process.binding('fs');\n const errors = require('internal/errors');\n \n-const octet = '(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])';\n-const re = new RegExp(`^${octet}[.]${octet}[.]${octet}[.]${octet}$`);\n+// IPv4 Segment\n+const v4Seg = '(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])';\n+const v4Str = `(${v4Seg}[.]){3}${v4Seg}`;\n+const IPv4Reg = new RegExp(`^${v4Str}$`);\n+\n+// IPv6 Segment\n+const v6Seg = '(?:[0-9a-fA-F]{1,4})';\n+const IPv6Reg = new RegExp('^(' +\n+  `(?:${v6Seg}:){7}(?:${v6Seg}|:)|` +\n+  `(?:${v6Seg}:){6}(?:${v4Str}|:${v6Seg}|:)|` +\n+  `(?:${v6Seg}:){5}(?::${v4Str}|(:${v6Seg}){1,2}|:)|` +\n+  `(?:${v6Seg}:){4}(?:(:${v6Seg}){0,1}:${v4Str}|(:${v6Seg}){1,3}|:)|` +\n+  `(?:${v6Seg}:){3}(?:(:${v6Seg}){0,2}:${v4Str}|(:${v6Seg}){1,4}|:)|` +\n+  `(?:${v6Seg}:){2}(?:(:${v6Seg}){0,3}:${v4Str}|(:${v6Seg}){1,5}|:)|` +\n+  `(?:${v6Seg}:){1}(?:(:${v6Seg}){0,4}:${v4Str}|(:${v6Seg}){1,6}|:)|` +\n+  `(?::((?::${v6Seg}){0,5}:${v4Str}|(?::${v6Seg}){1,7}|:))` +\n+')(%[0-9a-zA-Z]{1,})?$');\n \n function isIPv4(s) {\n-  return re.test(s);\n+  return IPv4Reg.test(s);\n+}\n+\n+function isIPv6(s) {\n+  return IPv6Reg.test(s);\n }\n \n function isIP(s) {"
        },
        {
            "sha": "51ca93742932335061583e41fbf18720b126cbfe",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=8e73594a5c82de26ebc0b1daedb20b6d3053dd4b",
            "patch": "@@ -1955,11 +1955,6 @@ int ParseIP(const char* ip, ParseIPResult* result = nullptr) {\n   return 0;\n }\n \n-void IsIPv6(const FunctionCallbackInfo<Value>& args) {\n-  node::Utf8Value ip(args.GetIsolate(), args[0]);\n-  args.GetReturnValue().Set(6 == ParseIP(*ip));\n-}\n-\n void CanonicalizeIP(const FunctionCallbackInfo<Value>& args) {\n   v8::Isolate* isolate = args.GetIsolate();\n   node::Utf8Value ip(isolate, args[0]);\n@@ -2208,7 +2203,6 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"getaddrinfo\", GetAddrInfo);\n   env->SetMethod(target, \"getnameinfo\", GetNameInfo);\n-  env->SetMethodNoSideEffect(target, \"isIPv6\", IsIPv6);\n   env->SetMethodNoSideEffect(target, \"canonicalizeIP\", CanonicalizeIP);\n \n   env->SetMethod(target, \"strerror\", StrError);"
        },
        {
            "sha": "ec04505cedb27f29fdb17f05a959683c8908501f",
            "filename": "test/parallel/test-net-isipv4.js",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/test%2Fparallel%2Ftest-net-isipv4.js",
            "raw_url": "https://github.com/nodejs/node/raw/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/test%2Fparallel%2Ftest-net-isipv4.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-isipv4.js?ref=8e73594a5c82de26ebc0b1daedb20b6d3053dd4b",
            "patch": "@@ -0,0 +1,46 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const net = require('net');\n+\n+const v4 = [\n+  '0.0.0.0',\n+  '8.8.8.8',\n+  '127.0.0.1',\n+  '100.100.100.100',\n+  '192.168.0.1',\n+  '18.101.25.153',\n+  '123.23.34.2',\n+  '172.26.168.134',\n+  '212.58.241.131',\n+  '128.0.0.0',\n+  '23.71.254.72',\n+  '223.255.255.255',\n+  '192.0.2.235',\n+  '99.198.122.146',\n+  '46.51.197.88',\n+  '173.194.34.134'\n+];\n+\n+const v4not = [\n+  '.100.100.100.100',\n+  '100..100.100.100.',\n+  '100.100.100.100.',\n+  '999.999.999.999',\n+  '256.256.256.256',\n+  '256.100.100.100.100',\n+  '123.123.123',\n+  'http://123.123.123',\n+  '1000.2.3.4',\n+  '999.2.3.4',\n+  '0000000192.168.0.200',\n+  '192.168.0.2000000000'\n+];\n+\n+v4.forEach((ip) => {\n+  assert.strictEqual(net.isIPv4(ip), true);\n+});\n+\n+v4not.forEach((ip) => {\n+  assert.strictEqual(net.isIPv4(ip), false);\n+});"
        },
        {
            "sha": "7ba379c3bdd27e42af6146adfec7518127583ec5",
            "filename": "test/parallel/test-net-isipv6.js",
            "status": "added",
            "additions": 244,
            "deletions": 0,
            "changes": 244,
            "blob_url": "https://github.com/nodejs/node/blob/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/test%2Fparallel%2Ftest-net-isipv6.js",
            "raw_url": "https://github.com/nodejs/node/raw/8e73594a5c82de26ebc0b1daedb20b6d3053dd4b/test%2Fparallel%2Ftest-net-isipv6.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-isipv6.js?ref=8e73594a5c82de26ebc0b1daedb20b6d3053dd4b",
            "patch": "@@ -0,0 +1,244 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const net = require('net');\n+\n+const v6 = [\n+  '::',\n+  '1::',\n+  '::1',\n+  '1::8',\n+  '1::7:8',\n+  '1:2:3:4:5:6:7:8',\n+  '1:2:3:4:5:6::8',\n+  '1:2:3:4:5:6:7::',\n+  '1:2:3:4:5::7:8',\n+  '1:2:3:4:5::8',\n+  '1:2:3::8',\n+  '1::4:5:6:7:8',\n+  '1::6:7:8',\n+  '1::3:4:5:6:7:8',\n+  '1:2:3:4::6:7:8',\n+  '1:2::4:5:6:7:8',\n+  '::2:3:4:5:6:7:8',\n+  '1:2::8',\n+  '2001:0000:1234:0000:0000:C1C0:ABCD:0876',\n+  '3ffe:0b00:0000:0000:0001:0000:0000:000a',\n+  'FF02:0000:0000:0000:0000:0000:0000:0001',\n+  '0000:0000:0000:0000:0000:0000:0000:0001',\n+  '0000:0000:0000:0000:0000:0000:0000:0000',\n+  '::ffff:192.168.1.26',\n+  '2::10',\n+  'ff02::1',\n+  'fe80::',\n+  '2002::',\n+  '2001:db8::',\n+  '2001:0db8:1234::',\n+  '::ffff:0:0',\n+  '::ffff:192.168.1.1',\n+  '1:2:3:4::8',\n+  '1::2:3:4:5:6:7',\n+  '1::2:3:4:5:6',\n+  '1::2:3:4:5',\n+  '1::2:3:4',\n+  '1::2:3',\n+  '::2:3:4:5:6:7',\n+  '::2:3:4:5:6',\n+  '::2:3:4:5',\n+  '::2:3:4',\n+  '::2:3',\n+  '::8',\n+  '1:2:3:4:5:6::',\n+  '1:2:3:4:5::',\n+  '1:2:3:4::',\n+  '1:2:3::',\n+  '1:2::',\n+  '1:2:3:4::7:8',\n+  '1:2:3::7:8',\n+  '1:2::7:8',\n+  '1:2:3:4:5:6:1.2.3.4',\n+  '1:2:3:4:5::1.2.3.4',\n+  '1:2:3:4::1.2.3.4',\n+  '1:2:3::1.2.3.4',\n+  '1:2::1.2.3.4',\n+  '1::1.2.3.4',\n+  '1:2:3:4::5:1.2.3.4',\n+  '1:2:3::5:1.2.3.4',\n+  '1:2::5:1.2.3.4',\n+  '1::5:1.2.3.4',\n+  '1::5:11.22.33.44',\n+  'fe80::217:f2ff:254.7.237.98',\n+  'fe80::217:f2ff:fe07:ed62',\n+  '2001:DB8:0:0:8:800:200C:417A',\n+  'FF01:0:0:0:0:0:0:101',\n+  '0:0:0:0:0:0:0:1',\n+  '0:0:0:0:0:0:0:0',\n+  '2001:DB8::8:800:200C:417A',\n+  'FF01::101',\n+  '0:0:0:0:0:0:13.1.68.3',\n+  '0:0:0:0:0:FFFF:129.144.52.38',\n+  '::13.1.68.3',\n+  '::FFFF:129.144.52.38',\n+  'fe80:0000:0000:0000:0204:61ff:fe9d:f156',\n+  'fe80:0:0:0:204:61ff:fe9d:f156',\n+  'fe80::204:61ff:fe9d:f156',\n+  'fe80:0:0:0:204:61ff:254.157.241.86',\n+  'fe80::204:61ff:254.157.241.86',\n+  'fe80::1',\n+  '2001:0db8:85a3:0000:0000:8a2e:0370:7334',\n+  '2001:db8:85a3:0:0:8a2e:370:7334',\n+  '2001:db8:85a3::8a2e:370:7334',\n+  '2001:0db8:0000:0000:0000:0000:1428:57ab',\n+  '2001:0db8:0000:0000:0000::1428:57ab',\n+  '2001:0db8:0:0:0:0:1428:57ab',\n+  '2001:0db8:0:0::1428:57ab',\n+  '2001:0db8::1428:57ab',\n+  '2001:db8::1428:57ab',\n+  '::ffff:12.34.56.78',\n+  '::ffff:0c22:384e',\n+  '2001:0db8:1234:0000:0000:0000:0000:0000',\n+  '2001:0db8:1234:ffff:ffff:ffff:ffff:ffff',\n+  '2001:db8:a::123',\n+  '::ffff:192.0.2.128',\n+  '::ffff:c000:280',\n+  'a:b:c:d:e:f:f1:f2',\n+  'a:b:c::d:e:f:f1',\n+  'a:b:c::d:e:f',\n+  'a:b:c::d:e',\n+  'a:b:c::d',\n+  '::a',\n+  '::a:b:c',\n+  '::a:b:c:d:e:f:f1',\n+  'a::',\n+  'a:b:c::',\n+  'a:b:c:d:e:f:f1::',\n+  'a:bb:ccc:dddd:000e:00f:0f::',\n+  '0:a:0:a:0:0:0:a',\n+  '0:a:0:0:a:0:0:a',\n+  '2001:db8:1:1:1:1:0:0',\n+  '2001:db8:1:1:1:0:0:0',\n+  '2001:db8:1:1:0:0:0:0',\n+  '2001:db8:1:0:0:0:0:0',\n+  '2001:db8:0:0:0:0:0:0',\n+  '2001:0:0:0:0:0:0:0',\n+  'A:BB:CCC:DDDD:000E:00F:0F::',\n+  '0:0:0:0:0:0:0:a',\n+  '0:0:0:0:a:0:0:0',\n+  '0:0:0:a:0:0:0:0',\n+  'a:0:0:a:0:0:a:a',\n+  'a:0:0:a:0:0:0:a',\n+  'a:0:0:0:a:0:0:a',\n+  'a:0:0:0:a:0:0:0',\n+  'a:0:0:0:0:0:0:0',\n+  'fe80::7:8%eth0',\n+  'fe80::7:8%1'\n+];\n+\n+const v6not = [\n+  '',\n+  '1:',\n+  ':1',\n+  '11:36:12',\n+  '02001:0000:1234:0000:0000:C1C0:ABCD:0876',\n+  '2001:0000:1234:0000:00001:C1C0:ABCD:0876',\n+  '2001:0000:1234: 0000:0000:C1C0:ABCD:0876',\n+  '2001:1:1:1:1:1:255Z255X255Y255',\n+  '3ffe:0b00:0000:0001:0000:0000:000a',\n+  'FF02:0000:0000:0000:0000:0000:0000:0000:0001',\n+  '3ffe:b00::1::a',\n+  '::1111:2222:3333:4444:5555:6666::',\n+  '1:2:3::4:5::7:8',\n+  '12345::6:7:8',\n+  '1::5:400.2.3.4',\n+  '1::5:260.2.3.4',\n+  '1::5:256.2.3.4',\n+  '1::5:1.256.3.4',\n+  '1::5:1.2.256.4',\n+  '1::5:1.2.3.256',\n+  '1::5:300.2.3.4',\n+  '1::5:1.300.3.4',\n+  '1::5:1.2.300.4',\n+  '1::5:1.2.3.300',\n+  '1::5:900.2.3.4',\n+  '1::5:1.900.3.4',\n+  '1::5:1.2.900.4',\n+  '1::5:1.2.3.900',\n+  '1::5:300.300.300.300',\n+  '1::5:3000.30.30.30',\n+  '1::400.2.3.4',\n+  '1::260.2.3.4',\n+  '1::256.2.3.4',\n+  '1::1.256.3.4',\n+  '1::1.2.256.4',\n+  '1::1.2.3.256',\n+  '1::300.2.3.4',\n+  '1::1.300.3.4',\n+  '1::1.2.300.4',\n+  '1::1.2.3.300',\n+  '1::900.2.3.4',\n+  '1::1.900.3.4',\n+  '1::1.2.900.4',\n+  '1::1.2.3.900',\n+  '1::300.300.300.300',\n+  '1::3000.30.30.30',\n+  '::400.2.3.4',\n+  '::260.2.3.4',\n+  '::256.2.3.4',\n+  '::1.256.3.4',\n+  '::1.2.256.4',\n+  '::1.2.3.256',\n+  '::300.2.3.4',\n+  '::1.300.3.4',\n+  '::1.2.300.4',\n+  '::1.2.3.300',\n+  '::900.2.3.4',\n+  '::1.900.3.4',\n+  '::1.2.900.4',\n+  '::1.2.3.900',\n+  '::300.300.300.300',\n+  '::3000.30.30.30',\n+  '2001:DB8:0:0:8:800:200C:417A:221',\n+  'FF01::101::2',\n+  '1111:2222:3333:4444::5555:',\n+  '1111:2222:3333::5555:',\n+  '1111:2222::5555:',\n+  '1111::5555:',\n+  '::5555:',\n+  ':::',\n+  '1111:',\n+  ':',\n+  ':1111:2222:3333:4444::5555',\n+  ':1111:2222:3333::5555',\n+  ':1111:2222::5555',\n+  ':1111::5555',\n+  ':::5555',\n+  '1.2.3.4:1111:2222:3333:4444::5555',\n+  '1.2.3.4:1111:2222:3333::5555',\n+  '1.2.3.4:1111:2222::5555',\n+  '1.2.3.4:1111::5555',\n+  '1.2.3.4::5555',\n+  '1.2.3.4::',\n+  'fe80:0000:0000:0000:0204:61ff:254.157.241.086',\n+  '123',\n+  'ldkfj',\n+  '2001::FFD3::57ab',\n+  '2001:db8:85a3::8a2e:37023:7334',\n+  '2001:db8:85a3::8a2e:370k:7334',\n+  '1:2:3:4:5:6:7:8:9',\n+  '1::2::3',\n+  '1:::3:4:5',\n+  '1:2:3::4:5:6:7:8:9',\n+  '::ffff:2.3.4',\n+  '::ffff:257.1.2.3',\n+  '::ffff:12345678901234567890.1.26',\n+  '2001:0000:1234:0000:0000:C1C0:ABCD:0876 0',\n+  '02001:0000:1234:0000:0000:C1C0:ABCD:0876'\n+];\n+\n+v6.forEach((ip) => {\n+  assert.strictEqual(net.isIPv6(ip), true);\n+});\n+\n+v6not.forEach((ip) => {\n+  assert.strictEqual(net.isIPv6(ip), false);\n+});"
        }
    ],
    "stats": {
        "total": 323,
        "additions": 312,
        "deletions": 11
    }
}