{
    "author": "danbev",
    "message": "n-api: add missing handle scopes\n\nCurrently when building with --debug\ntest/addons-napi/test_threadsafe_function will error:\n\n$  out/Debug/node test/addons-napi/test_threadsafe_function/test.js\nFATAL ERROR: v8::HandleScope::CreateHandle()\n  Cannot create a handle without a HandleScope\n 1: 0x10004e287 node::DumpBacktrace(__sFILE*) [node/out/Debug/node]\n 2: 0x1000cd37b node::Abort() [/node/out/Debug/node]\n 3: 0x1000cd69f node::OnFatalError(char const*, char const*)\n    [/node/out/Debug/node]\n 4: 0x1004df0b1 v8::Utils::ReportApiFailure(char const*, char const*)\n    [/nodejs/node/out/Debug/node]\n 5: 0x100a8c0a9 v8::internal::HandleScope::Extend(\n        v8::internal::Isolate*)\n    [/node/out/Debug/node]\n 6: 0x1004e4229 v8::EmbedderDataFor(v8::Context*,\n                                    int, bool,\n                                    char const*)\n    [/node/out/Debug/node]\n 7: 0x1004e43fa v8::Context::SlowGetAlignedPointerFromEmbedderData(int)\n    [/node/out/Debug/node]\n 8: 0x10001c26b v8::Context::GetAlignedPointerFromEmbedderData(int)\n    [/node/out/Debug/node]\n 9: 0x1000144ea node::Environment::GetCurrent(v8::Local<v8::Context>)\n    [/node/out/Debug/node]\n10: 0x1000f49e2 napi_env__::node_env() const\n    [/node/out/Debug/node]\n11: 0x1000f9885\n    (anonymous namespace)::v8impl::ThreadSafeFunction::\n        CloseHandlesAndMaybeDelete(bool)\n    [/node/out/Debug/node]\n12: 0x1000fb34f (anonymous namespace)::v8impl::ThreadSafeFunction::\n        DispatchOne()\n    [/node/out/Debug/node]\n13: 0x1000fb129\n    (anonymous namespace)::v8impl::ThreadSafeFunction::\n        IdleCb(uv_idle_s*)\n    [/node/out/Debug/node]\n14: 0x1011a1b69 uv__run_idle\n    [/node/out/Debug/node]\n15: 0x101198179 uv_run\n    [/node/out/Debug/node]\n16: 0x1000dfca1\n    node::Start(...)\n    [/node/out/Debug/node]\n17: 0x1000dae50 node::Start(...)\n    [/node/out/Debug/node]\n18: 0x1000da56f node::Start(int, char**)\n    [/node/out/Debug/node]\n19: 0x10141112e main\n    [/node/out/Debug/node]\n20: 0x100001034 start\n    [/node/out/Debug/node]\nAbort trap: 6\n\nThis commit adds two HandleScope's, one to CloseHandlesAndMaybeDelete\nand one to the lambda.\n\nSlowGetAlignedPointerFromEmbedderData will only be called for debug\nbuilds:\nhttps://github.com/v8/v8/blob/2ef0aa662fe907a1b36ac1abe7d77ad2bcd27733\n/include/v8.h#L10440-L10447\n\nPR-URL: https://github.com/nodejs/node/pull/24011\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "315b1c656cee39c989015cc2b17fe8c864dbc3dd",
    "files": [
        {
            "sha": "1f7b1405539e7b1c118ff7a3317c3054960771f5",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/315b1c656cee39c989015cc2b17fe8c864dbc3dd/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/315b1c656cee39c989015cc2b17fe8c864dbc3dd/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=315b1c656cee39c989015cc2b17fe8c864dbc3dd",
            "patch": "@@ -1084,6 +1084,7 @@ class ThreadSafeFunction : public node::AsyncResource {\n   }\n \n   void CloseHandlesAndMaybeDelete(bool set_closing = false) {\n+    v8::HandleScope scope(env->isolate);\n     if (set_closing) {\n       node::Mutex::ScopedLock lock(this->mutex);\n       is_closing = true;\n@@ -1101,6 +1102,7 @@ class ThreadSafeFunction : public node::AsyncResource {\n           ThreadSafeFunction* ts_fn =\n               node::ContainerOf(&ThreadSafeFunction::async,\n                                 reinterpret_cast<uv_async_t*>(handle));\n+          v8::HandleScope scope(ts_fn->env->isolate);\n           ts_fn->env->node_env()->CloseHandle(\n               reinterpret_cast<uv_handle_t*>(&ts_fn->idle),\n               [](uv_handle_t* handle) -> void {"
        }
    ],
    "stats": {
        "total": 2,
        "additions": 2,
        "deletions": 0
    }
}