{
    "author": "guybedford",
    "message": "esm: ensure require.main for CJS top-level loads\n\nPR-URL: https://github.com/nodejs/node/pull/21150\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "8ee604ca71dfa459ec2fe00495aeb51e12a20af1",
    "files": [
        {
            "sha": "b3023fcd4f8e36a288b2a492c806ce6a7e04f8a1",
            "filename": "lib/internal/modules/esm/loader.js",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Floader.js?ref=8ee604ca71dfa459ec2fe00495aeb51e12a20af1",
            "patch": "@@ -110,12 +110,7 @@ class Loader {\n       loaderInstance = translators.get(format);\n     }\n \n-    let inspectBrk = false;\n-    if (process._breakFirstLine) {\n-      delete process._breakFirstLine;\n-      inspectBrk = true;\n-    }\n-    job = new ModuleJob(this, url, loaderInstance, inspectBrk);\n+    job = new ModuleJob(this, url, loaderInstance, parentURL === undefined);\n     this.moduleMap.set(url, job);\n     return job;\n   }"
        },
        {
            "sha": "6f0bb8693144048d19550a32968d60e4ea0d1baa",
            "filename": "lib/internal/modules/esm/module_job.js",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js?ref=8ee604ca71dfa459ec2fe00495aeb51e12a20af1",
            "patch": "@@ -12,15 +12,15 @@ const resolvedPromise = SafePromise.resolve();\n class ModuleJob {\n   // `loader` is the Loader instance used for loading dependencies.\n   // `moduleProvider` is a function\n-  constructor(loader, url, moduleProvider, inspectBrk) {\n+  constructor(loader, url, moduleProvider, isMain) {\n     this.loader = loader;\n     this.error = null;\n     this.hadError = false;\n-    this.inspectBrk = inspectBrk;\n+    this.isMain = isMain;\n \n     // This is a Promise<{ module, reflect }>, whose fields will be copied\n     // onto `this` by `link()` below once it has been resolved.\n-    this.modulePromise = moduleProvider(url);\n+    this.modulePromise = moduleProvider(url, isMain);\n     this.module = undefined;\n     this.reflect = undefined;\n \n@@ -82,7 +82,8 @@ class ModuleJob {\n       throw e;\n     }\n     try {\n-      if (this.inspectBrk) {\n+      if (this.isMain && process._breakFirstLine) {\n+        delete process._breakFirstLine;\n         const initWrapper = process.binding('inspector').callAndPauseOnStart;\n         initWrapper(this.module.instantiate, this.module);\n       } else {"
        },
        {
            "sha": "476a420b8a9620f9c1151808b7d722916610d2e1",
            "filename": "lib/internal/modules/esm/translators.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js?ref=8ee604ca71dfa459ec2fe00495aeb51e12a20af1",
            "patch": "@@ -36,7 +36,7 @@ translators.set('esm', async (url) => {\n // Strategy for loading a node-style CommonJS module\n const isWindows = process.platform === 'win32';\n const winSepRegEx = /\\//g;\n-translators.set('cjs', async (url) => {\n+translators.set('cjs', async (url, isMain) => {\n   debug(`Translating CJSModule ${url}`);\n   const pathname = internalURLModule.getPathFromURL(new URL(url));\n   const module = CJSModule._cache[\n@@ -51,7 +51,7 @@ translators.set('cjs', async (url) => {\n     // we don't care about the return val of _load here because Module#load\n     // will handle it for us by checking the loader registry and filling the\n     // exports like above\n-    CJSModule._load(pathname);\n+    CJSModule._load(pathname, undefined, isMain);\n   });\n });\n "
        },
        {
            "sha": "ed6730aec1d2a2831fa1488f28535fe0e3e31e47",
            "filename": "test/es-module/test-esm-cjs-main.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/test%2Fes-module%2Ftest-esm-cjs-main.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ee604ca71dfa459ec2fe00495aeb51e12a20af1/test%2Fes-module%2Ftest-esm-cjs-main.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-cjs-main.js?ref=8ee604ca71dfa459ec2fe00495aeb51e12a20af1",
            "patch": "@@ -0,0 +1,6 @@\n+// Flags: --experimental-modules\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+exports.asdf = 'asdf';\n+assert.strictEqual(require.main.exports.asdf, 'asdf');"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 14,
        "deletions": 12
    }
}