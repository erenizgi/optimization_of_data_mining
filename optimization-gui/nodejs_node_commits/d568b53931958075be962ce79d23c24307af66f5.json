{
    "author": "danbev",
    "message": "src: reduce duplication in tcp_wrap Connect\n\nThis commit extracts identical code from Connect and Connect6 into a\nseparate function to avoid some code duplication.\n\nPR-URL: https://github.com/nodejs/node/pull/23753\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>",
    "sha": "d568b53931958075be962ce79d23c24307af66f5",
    "files": [
        {
            "sha": "cda30d84105735fbc21fa0dacffa3fc903e2b454",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 34,
            "changes": 54,
            "blob_url": "https://github.com/nodejs/node/blob/d568b53931958075be962ce79d23c24307af66f5/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d568b53931958075be962ce79d23c24307af66f5/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=d568b53931958075be962ce79d23c24307af66f5",
            "patch": "@@ -276,58 +276,44 @@ void TCPWrap::Listen(const FunctionCallbackInfo<Value>& args) {\n \n \n void TCPWrap::Connect(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  TCPWrap* wrap;\n-  ASSIGN_OR_RETURN_UNWRAP(&wrap,\n-                          args.Holder(),\n-                          args.GetReturnValue().Set(UV_EBADF));\n-\n-  CHECK(args[0]->IsObject());\n-  CHECK(args[1]->IsString());\n   CHECK(args[2]->IsUint32());\n-\n-  Local<Object> req_wrap_obj = args[0].As<Object>();\n-  node::Utf8Value ip_address(env->isolate(), args[1]);\n   int port = args[2].As<Uint32>()->Value();\n+  Connect<sockaddr_in>(args,\n+                       [port](const char* ip_address, sockaddr_in* addr) {\n+      return uv_ip4_addr(ip_address, port, addr);\n+  });\n+}\n \n-  sockaddr_in addr;\n-  int err = uv_ip4_addr(*ip_address, port, &addr);\n-\n-  if (err == 0) {\n-    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(wrap);\n-    ConnectWrap* req_wrap =\n-        new ConnectWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_TCPCONNECTWRAP);\n-    err = req_wrap->Dispatch(uv_tcp_connect,\n-                             &wrap->handle_,\n-                             reinterpret_cast<const sockaddr*>(&addr),\n-                             AfterConnect);\n-    if (err)\n-      delete req_wrap;\n-  }\n \n-  args.GetReturnValue().Set(err);\n+void TCPWrap::Connect6(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(args[2]->IsUint32());\n+  int port;\n+  if (!args[2]->Int32Value(env->context()).To(&port)) return;\n+  Connect<sockaddr_in6>(args,\n+                        [port](const char* ip_address, sockaddr_in6* addr) {\n+      return uv_ip6_addr(ip_address, port, addr);\n+  });\n }\n \n+template <typename T>\n+void TCPWrap::Connect(const FunctionCallbackInfo<Value>& args,\n+    std::function<int(const char* ip_address, T* addr)> uv_ip_addr) {\n+  Environment* env = Environment::GetCurrent(args);\n \n-void TCPWrap::Connect6(const FunctionCallbackInfo<Value>& args) {\n   TCPWrap* wrap;\n   ASSIGN_OR_RETURN_UNWRAP(&wrap,\n                           args.Holder(),\n                           args.GetReturnValue().Set(UV_EBADF));\n-  Environment* env = wrap->env();\n \n   CHECK(args[0]->IsObject());\n   CHECK(args[1]->IsString());\n-  CHECK(args[2]->IsUint32());\n \n   Local<Object> req_wrap_obj = args[0].As<Object>();\n   node::Utf8Value ip_address(env->isolate(), args[1]);\n-  int port;\n-  if (!args[2]->Int32Value(env->context()).To(&port)) return;\n \n-  sockaddr_in6 addr;\n-  int err = uv_ip6_addr(*ip_address, port, &addr);\n+  T addr;\n+  int err = uv_ip_addr(*ip_address, &addr);\n \n   if (err == 0) {\n     AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(wrap);"
        },
        {
            "sha": "3cbeae6d64a949da6bcc0b00314f42bd36fb22b2",
            "filename": "src/tcp_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d568b53931958075be962ce79d23c24307af66f5/src%2Ftcp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/d568b53931958075be962ce79d23c24307af66f5/src%2Ftcp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.h?ref=d568b53931958075be962ce79d23c24307af66f5",
            "patch": "@@ -75,6 +75,9 @@ class TCPWrap : public ConnectionWrap<TCPWrap, uv_tcp_t> {\n   static void Listen(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void Connect(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void Connect6(const v8::FunctionCallbackInfo<v8::Value>& args);\n+  template <typename T>\n+  static void Connect(const v8::FunctionCallbackInfo<v8::Value>& args,\n+      std::function<int(const char* ip_address, T* addr)> uv_ip_addr);\n   static void Open(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n #ifdef _WIN32"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 23,
        "deletions": 34
    }
}