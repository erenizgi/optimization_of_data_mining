{
    "author": "addaleax",
    "message": "tls,http2: handle writes after SSL destroy more gracefully\n\nThis might otherwise result in a hard crash when trying\nto write to a socket after a sudden disconnect.\n\nNote that the test here uses an aborted `h2load` run to create\nthe failing requests; Thatâ€™s far from ideal, but it provides\na reasonably reliably reproduction at this point.\n\nPR-URL: https://github.com/nodejs/node/pull/18987\nFixes: https://github.com/nodejs/node/issues/18973\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "0c25cdf39a40a94fcb829ea91caa217d640054b1",
    "files": [
        {
            "sha": "1cc5478bb572960adbc599f68218c5ab3c049ffc",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/0c25cdf39a40a94fcb829ea91caa217d640054b1/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0c25cdf39a40a94fcb829ea91caa217d640054b1/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=0c25cdf39a40a94fcb829ea91caa217d640054b1",
            "patch": "@@ -553,7 +553,12 @@ int TLSWrap::DoWrite(WriteWrap* w,\n                      size_t count,\n                      uv_stream_t* send_handle) {\n   CHECK_EQ(send_handle, nullptr);\n-  CHECK_NE(ssl_, nullptr);\n+\n+  if (ssl_ == nullptr) {\n+    ClearError();\n+    error_ = \"Write after DestroySSL\";\n+    return UV_EPROTO;\n+  }\n \n   bool empty = true;\n \n@@ -593,12 +598,6 @@ int TLSWrap::DoWrite(WriteWrap* w,\n     return 0;\n   }\n \n-  if (ssl_ == nullptr) {\n-    ClearError();\n-    error_ = \"Write after DestroySSL\";\n-    return UV_EPROTO;\n-  }\n-\n   crypto::MarkPopErrorOnReturn mark_pop_error_on_return;\n \n   int written = 0;"
        },
        {
            "sha": "2e635fe1376a5135dd54e7dbfe70c1ab41a19040",
            "filename": "test/parallel/test-http2-tls-disconnect.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/0c25cdf39a40a94fcb829ea91caa217d640054b1/test%2Fparallel%2Ftest-http2-tls-disconnect.js",
            "raw_url": "https://github.com/nodejs/node/raw/0c25cdf39a40a94fcb829ea91caa217d640054b1/test%2Fparallel%2Ftest-http2-tls-disconnect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-tls-disconnect.js?ref=0c25cdf39a40a94fcb829ea91caa217d640054b1",
            "patch": "@@ -0,0 +1,32 @@\n+'use strict';\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const child_process = require('child_process');\n+const http2 = require('http2');\n+const fs = require('fs');\n+\n+const key = fixtures.readKey('agent8-key.pem', 'binary');\n+const cert = fixtures.readKey('agent8-cert.pem', 'binary');\n+\n+const server = http2.createSecureServer({ key, cert }, (request, response) => {\n+  fs.createReadStream(process.execPath).pipe(response);\n+});\n+\n+// This should be doable with a reproduction purely written in Node;\n+// that just requires somebody to take the time and actually do it.\n+server.listen(0, () => {\n+  const proc = child_process.spawn('h2load', [\n+    '-n', '1000',\n+    `https://localhost:${server.address().port}/`\n+  ]);\n+  proc.on('error', (err) => {\n+    if (err.code === 'ENOENT')\n+      common.skip('no h2load');\n+  });\n+  proc.on('exit', () => server.close());\n+  setTimeout(() => proc.kill(2), 100);\n+});"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 38,
        "deletions": 7
    }
}