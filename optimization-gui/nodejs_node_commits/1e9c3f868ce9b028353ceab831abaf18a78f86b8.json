{
    "author": "lundibundi",
    "message": "workers: fix invalid exit code in parent upon uncaught exception\n\nNow worker.on('exit') reports correct exit code (1) if worker has exited\nwith uncaught exception.\n\nFixes: https://github.com/nodejs/node/issues/21707\n\nPR-URL: https://github.com/nodejs/node/pull/21713\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Yuta Hiroto <hello@hiroppy.me>\nReviewed-By: Weijia Wang <starkwang@126.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "1e9c3f868ce9b028353ceab831abaf18a78f86b8",
    "files": [
        {
            "sha": "83389d204d285f36678d133a9ee29e581c35a268",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1e9c3f868ce9b028353ceab831abaf18a78f86b8/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/1e9c3f868ce9b028353ceab831abaf18a78f86b8/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=1e9c3f868ce9b028353ceab831abaf18a78f86b8",
            "patch": "@@ -454,6 +454,9 @@ function setupChild(evalScript) {\n     debug(`[${threadId}] fatal exception caught = ${caught}`);\n \n     if (!caught) {\n+      // set correct code (uncaughtException) for [kOnExit](code) handler\n+      process.exitCode = 1;\n+\n       let serialized;\n       try {\n         serialized = serializeError(error);"
        },
        {
            "sha": "bb47e1cece7a62a3b0c45754648b798068d71f3f",
            "filename": "test/parallel/test-worker-exit-code.js",
            "status": "added",
            "additions": 130,
            "deletions": 0,
            "changes": 130,
            "blob_url": "https://github.com/nodejs/node/blob/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-exit-code.js",
            "raw_url": "https://github.com/nodejs/node/raw/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-exit-code.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-exit-code.js?ref=1e9c3f868ce9b028353ceab831abaf18a78f86b8",
            "patch": "@@ -0,0 +1,130 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const common = require('../common');\n+\n+// This test checks that Worker has correct exit codes on parent side\n+// in multiple situations.\n+\n+const assert = require('assert');\n+const worker = require('worker_threads');\n+const { Worker, isMainThread, parentPort } = worker;\n+\n+if (isMainThread) {\n+  parent();\n+} else {\n+  if (!parentPort) {\n+    console.error('Parent port must not be null');\n+    process.exit(100);\n+    return;\n+  }\n+  parentPort.once('message', (msg) => {\n+    switch (msg) {\n+      case 'child1':\n+        return child1();\n+      case 'child2':\n+        return child2();\n+      case 'child3':\n+        return child3();\n+      case 'child4':\n+        return child4();\n+      case 'child5':\n+        return child5();\n+      case 'child6':\n+        return child6();\n+      case 'child7':\n+        return child7();\n+      default:\n+        throw new Error('invalid');\n+    }\n+  });\n+}\n+\n+function child1() {\n+  process.exitCode = 42;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 42);\n+  });\n+}\n+\n+function child2() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 42);\n+  });\n+  process.exit(42);\n+}\n+\n+function child3() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 0);\n+  });\n+  process.exit(0);\n+}\n+\n+function child4() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    // cannot use assert because it will be uncaughtException -> 1 exit code\n+    // that will render this test useless\n+    if (code !== 1) {\n+      console.error('wrong code! expected 1 for uncaughtException');\n+      process.exit(99);\n+    }\n+  });\n+  throw new Error('ok');\n+}\n+\n+function child5() {\n+  process.exitCode = 95;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 95);\n+    process.exitCode = 99;\n+  });\n+}\n+\n+function child6() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 0);\n+  });\n+  process.on('uncaughtException', common.mustCall(() => {\n+    // handle\n+  }));\n+  throw new Error('ok');\n+}\n+\n+function child7() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(code, 97);\n+  });\n+  process.on('uncaughtException', common.mustCall(() => {\n+    process.exitCode = 97;\n+  }));\n+  throw new Error('ok');\n+}\n+\n+function parent() {\n+  const test = (arg, exit, error = null) => {\n+    const w = new Worker(__filename);\n+    w.on('exit', common.mustCall((code) => {\n+      assert.strictEqual(\n+        code, exit,\n+        `wrong exit for ${arg}\\nexpected:${exit} but got:${code}`);\n+      console.log(`ok - ${arg} exited with ${exit}`);\n+    }));\n+    if (error) {\n+      w.on('error', common.mustCall((err) => {\n+        assert(error.test(err));\n+      }));\n+    }\n+    w.postMessage(arg);\n+  };\n+\n+  test('child1', 42);\n+  test('child2', 42);\n+  test('child3', 0);\n+  test('child4', 1, /^Error: ok$/);\n+  test('child5', 99);\n+  test('child6', 0);\n+  test('child7', 97);\n+}"
        },
        {
            "sha": "f820976c11ebcdaea61c69333459eb7c7a7e0cf1",
            "filename": "test/parallel/test-worker-uncaught-exception-async.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js",
            "raw_url": "https://github.com/nodejs/node/raw/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js?ref=1e9c3f868ce9b028353ceab831abaf18a78f86b8",
            "patch": "@@ -12,6 +12,10 @@ if (!process.env.HAS_STARTED_WORKER) {\n   w.on('error', common.mustCall((err) => {\n     assert(/^Error: foo$/.test(err));\n   }));\n+  w.on('exit', common.mustCall((code) => {\n+    // uncaughtException is code 1\n+    assert.strictEqual(code, 1);\n+  }));\n } else {\n   setImmediate(() => {\n     throw new Error('foo');"
        },
        {
            "sha": "67b861e22619aab43cfa9c25bf7d06a3f236195e",
            "filename": "test/parallel/test-worker-uncaught-exception.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/1e9c3f868ce9b028353ceab831abaf18a78f86b8/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-uncaught-exception.js?ref=1e9c3f868ce9b028353ceab831abaf18a78f86b8",
            "patch": "@@ -12,6 +12,10 @@ if (!process.env.HAS_STARTED_WORKER) {\n   w.on('error', common.mustCall((err) => {\n     assert(/^Error: foo$/.test(err));\n   }));\n+  w.on('exit', common.mustCall((code) => {\n+    // uncaughtException is code 1\n+    assert.strictEqual(code, 1);\n+  }));\n } else {\n   throw new Error('foo');\n }"
        }
    ],
    "stats": {
        "total": 141,
        "additions": 141,
        "deletions": 0
    }
}