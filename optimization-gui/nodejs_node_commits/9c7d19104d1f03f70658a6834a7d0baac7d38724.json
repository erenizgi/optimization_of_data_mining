{
    "author": "addaleax",
    "message": "buffer: throw exception when creating from non-Node.js Context\n\nThrow an exception instead of crashing when attempting to create\n`Buffer` objects from a Context that is not associated with\na Node.js `Environment`.\n\nPossible alternatives for the future might be just returning\na plain `Uint8Array`, or working on providing `Buffer` for all\n`Context`s.\n\nPR-URL: https://github.com/nodejs/node/pull/23938\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "9c7d19104d1f03f70658a6834a7d0baac7d38724",
    "files": [
        {
            "sha": "aecb5282e79808333453b364457bb9cb62ec9894",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/9c7d19104d1f03f70658a6834a7d0baac7d38724/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/9c7d19104d1f03f70658a6834a7d0baac7d38724/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=9c7d19104d1f03f70658a6834a7d0baac7d38724",
            "patch": "@@ -613,6 +613,19 @@ An attempt was made to register something that is not a function as an\n The type of an asynchronous resource was invalid. Note that users are also able\n to define their own types if using the public embedder API.\n \n+<a id=\"ERR_BUFFER_CONTEXT_NOT_AVAILABLE\"></a>\n+### ERR_BUFFER_CONTEXT_NOT_AVAILABLE\n+\n+An attempt was made to create a Node.js `Buffer` instance from addon or embedder\n+code, while in a JS engine Context that is not associated with a Node.js\n+instance. The data passed to the `Buffer` method will have been released\n+by the time the method returns.\n+\n+When encountering this error, a possible alternative to creating a `Buffer`\n+instance is to create a normal `Uint8Array`, which only differs in the\n+prototype of the resulting object. `Uint8Array`s are generally accepted in all\n+Node.js core APIs where `Buffer`s are; they are available in all Contexts.\n+\n <a id=\"ERR_BUFFER_OUT_OF_BOUNDS\"></a>\n ### ERR_BUFFER_OUT_OF_BOUNDS\n "
        },
        {
            "sha": "2a2fb45e7abf1540c2ee601e769b138eacdeed06",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/9c7d19104d1f03f70658a6834a7d0baac7d38724/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9c7d19104d1f03f70658a6834a7d0baac7d38724/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=9c7d19104d1f03f70658a6834a7d0baac7d38724",
            "patch": "@@ -271,7 +271,10 @@ MaybeLocal<Object> New(Isolate* isolate, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Local<Object> obj;\n   Environment* env = Environment::GetCurrent(isolate);\n-  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n+  if (env == nullptr) {\n+    THROW_ERR_BUFFER_CONTEXT_NOT_AVAILABLE(isolate);\n+    return MaybeLocal<Object>();\n+  }\n   if (Buffer::New(env, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n   return Local<Object>();\n@@ -314,7 +317,10 @@ MaybeLocal<Object> New(Environment* env, size_t length) {\n MaybeLocal<Object> Copy(Isolate* isolate, const char* data, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n+  if (env == nullptr) {\n+    THROW_ERR_BUFFER_CONTEXT_NOT_AVAILABLE(isolate);\n+    return MaybeLocal<Object>();\n+  }\n   Local<Object> obj;\n   if (Buffer::Copy(env, data, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n@@ -364,7 +370,11 @@ MaybeLocal<Object> New(Isolate* isolate,\n                        void* hint) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n+  if (env == nullptr) {\n+    callback(data, hint);\n+    THROW_ERR_BUFFER_CONTEXT_NOT_AVAILABLE(isolate);\n+    return MaybeLocal<Object>();\n+  }\n   Local<Object> obj;\n   if (Buffer::New(env, data, length, callback, hint).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n@@ -403,7 +413,11 @@ MaybeLocal<Object> New(Environment* env,\n MaybeLocal<Object> New(Isolate* isolate, char* data, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n+  if (env == nullptr) {\n+    free(data);\n+    THROW_ERR_BUFFER_CONTEXT_NOT_AVAILABLE(isolate);\n+    return MaybeLocal<Object>();\n+  }\n   Local<Object> obj;\n   if (Buffer::New(env, data, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);"
        },
        {
            "sha": "a435695693ba188ae1bbd2bc90d59dde6ff36e6b",
            "filename": "src/node_errors.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9c7d19104d1f03f70658a6834a7d0baac7d38724/src%2Fnode_errors.h",
            "raw_url": "https://github.com/nodejs/node/raw/9c7d19104d1f03f70658a6834a7d0baac7d38724/src%2Fnode_errors.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.h?ref=9c7d19104d1f03f70658a6834a7d0baac7d38724",
            "patch": "@@ -21,6 +21,7 @@ namespace node {\n // a `Local<Value>` containing the TypeError with proper code and message\n \n #define ERRORS_WITH_CODE(V)                                                  \\\n+  V(ERR_BUFFER_CONTEXT_NOT_AVAILABLE, Error)                                 \\\n   V(ERR_BUFFER_OUT_OF_BOUNDS, RangeError)                                    \\\n   V(ERR_BUFFER_TOO_LARGE, Error)                                             \\\n   V(ERR_CANNOT_TRANSFER_OBJECT, TypeError)                                   \\\n@@ -64,6 +65,8 @@ namespace node {\n // Errors with predefined static messages\n \n #define PREDEFINED_ERROR_MESSAGES(V)                                         \\\n+  V(ERR_BUFFER_CONTEXT_NOT_AVAILABLE,                                        \\\n+    \"Buffer is not available for the current Context\")                       \\\n   V(ERR_CANNOT_TRANSFER_OBJECT, \"Cannot transfer object of unsupported type\")\\\n   V(ERR_CLOSED_MESSAGE_PORT, \"Cannot send data on closed MessagePort\")       \\\n   V(ERR_CONSTRUCT_CALL_REQUIRED, \"Cannot call constructor without `new`\")    \\"
        },
        {
            "sha": "776786cef5180f4c1ba460c512c2f0653ebc8c8d",
            "filename": "test/addons/non-node-context/binding.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/9c7d19104d1f03f70658a6834a7d0baac7d38724/test%2Faddons%2Fnon-node-context%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9c7d19104d1f03f70658a6834a7d0baac7d38724/test%2Faddons%2Fnon-node-context%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fnon-node-context%2Fbinding.cc?ref=9c7d19104d1f03f70658a6834a7d0baac7d38724",
            "patch": "@@ -1,4 +1,5 @@\n #include <node.h>\n+#include <node_buffer.h>\n #include <assert.h>\n \n namespace {\n@@ -15,6 +16,17 @@ using v8::Script;\n using v8::String;\n using v8::Value;\n \n+inline void MakeBufferInNewContext(\n+    const v8::FunctionCallbackInfo<v8::Value>& args) {\n+  Isolate* isolate = args.GetIsolate();\n+  Local<Context> context = Context::New(isolate);\n+  Context::Scope context_scope(context);\n+\n+  // This should throw an exception, rather than actually do anything.\n+  MaybeLocal<Object> buf = node::Buffer::Copy(isolate, \"foo\", 3);\n+  assert(buf.IsEmpty());\n+}\n+\n inline void RunInNewContext(\n     const v8::FunctionCallbackInfo<v8::Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n@@ -41,13 +53,8 @@ inline void RunInNewContext(\n inline void Initialize(Local<Object> exports,\n                        Local<Value> module,\n                        Local<Context> context) {\n-  Isolate* isolate = context->GetIsolate();\n-  Local<String> key = String::NewFromUtf8(\n-      isolate, \"runInNewContext\", NewStringType::kNormal).ToLocalChecked();\n-  Local<Function> value = FunctionTemplate::New(isolate, RunInNewContext)\n-                   ->GetFunction(context)\n-                   .ToLocalChecked();\n-  assert(exports->Set(context, key, value).IsJust());\n+  NODE_SET_METHOD(exports, \"runInNewContext\", RunInNewContext);\n+  NODE_SET_METHOD(exports, \"makeBufferInNewContext\", MakeBufferInNewContext);\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "9b17fa4ee930aee34bc9c667532597fb74d84544",
            "filename": "test/addons/non-node-context/test-make-buffer.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/9c7d19104d1f03f70658a6834a7d0baac7d38724/test%2Faddons%2Fnon-node-context%2Ftest-make-buffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/9c7d19104d1f03f70658a6834a7d0baac7d38724/test%2Faddons%2Fnon-node-context%2Ftest-make-buffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fnon-node-context%2Ftest-make-buffer.js?ref=9c7d19104d1f03f70658a6834a7d0baac7d38724",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+\n+const common = require('../../common');\n+const assert = require('assert');\n+const {\n+  makeBufferInNewContext\n+} = require(`./build/${common.buildType}/binding`);\n+\n+// Because the `Buffer` function and its protoype property only (currently)\n+// exist in a Node.js instanceâ€™s main context, trying to create buffers from\n+// another context throws an exception.\n+\n+try {\n+  makeBufferInNewContext();\n+} catch (exception) {\n+  assert.strictEqual(exception.constructor.name, 'Error');\n+  assert(!(exception.constructor instanceof Error));\n+\n+  assert.strictEqual(exception.code, 'ERR_BUFFER_CONTEXT_NOT_AVAILABLE');\n+  assert.strictEqual(exception.message,\n+                     'Buffer is not available for the current Context');\n+}"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 70,
        "deletions": 11
    }
}