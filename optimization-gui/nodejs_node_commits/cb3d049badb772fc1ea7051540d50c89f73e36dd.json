{
    "author": "jasnell",
    "message": "src: refactor bootstrap to use bootstrap object\n\nPR-URL: https://github.com/nodejs/node/pull/20917\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "cb3d049badb772fc1ea7051540d50c89f73e36dd",
    "files": [
        {
            "sha": "6477c2d8282f4339ffe17728a6fdfdeb7025f81e",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 32,
            "deletions": 10,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -10,10 +10,19 @@\n // process.binding(), process._linkedBinding(), internalBinding() and\n // NativeModule. And then { internalBinding, NativeModule } will be passed\n // into this bootstrapper to bootstrap Node.js core.\n-\n 'use strict';\n \n-(function bootstrapNodeJSCore(process, { internalBinding, NativeModule }) {\n+(function bootstrapNodeJSCore(process,\n+                              // bootstrapper properties... destructured to\n+                              // avoid retaining a reference to the bootstrap\n+                              // object.\n+                              { _setupProcessObject, _setupNextTick,\n+                                _setupPromises, _chdir, _cpuUsage,\n+                                _hrtime, _memoryUsage, _rawDebug,\n+                                _umask, _initgroups, _setegid, _seteuid,\n+                                _setgid, _setuid, _setgroups,\n+                                _shouldAbortOnUncaughtToggle },\n+                              { internalBinding, NativeModule }) {\n   const exceptionHandlerState = { captureFn: null };\n \n   function startup() {\n@@ -36,11 +45,24 @@\n     const _process = NativeModule.require('internal/process');\n     _process.setupConfig(NativeModule._source);\n     _process.setupSignalHandlers();\n-    _process.setupUncaughtExceptionCapture(exceptionHandlerState);\n+    _process.setupUncaughtExceptionCapture(exceptionHandlerState,\n+                                           _shouldAbortOnUncaughtToggle);\n     NativeModule.require('internal/process/warning').setup();\n-    NativeModule.require('internal/process/next_tick').setup();\n+    NativeModule.require('internal/process/next_tick').setup(_setupNextTick,\n+                                                             _setupPromises);\n     NativeModule.require('internal/process/stdio').setup();\n-    NativeModule.require('internal/process/methods').setup();\n+    NativeModule.require('internal/process/methods').setup(_chdir,\n+                                                           _cpuUsage,\n+                                                           _hrtime,\n+                                                           _memoryUsage,\n+                                                           _rawDebug,\n+                                                           _umask,\n+                                                           _initgroups,\n+                                                           _setegid,\n+                                                           _seteuid,\n+                                                           _setgid,\n+                                                           _setuid,\n+                                                           _setgroups);\n \n     const perf = process.binding('performance');\n     const {\n@@ -55,9 +77,9 @@\n       NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_END\n     } = perf.constants;\n \n-    _process.setup_hrtime();\n-    _process.setup_cpuUsage();\n-    _process.setupMemoryUsage();\n+    _process.setup_hrtime(_hrtime);\n+    _process.setup_cpuUsage(_cpuUsage);\n+    _process.setupMemoryUsage(_memoryUsage);\n     _process.setupKillAndExit();\n     if (global.__coverage__)\n       NativeModule.require('internal/process/write-coverage').setup();\n@@ -79,7 +101,7 @@\n     }\n \n     _process.setupChannel();\n-    _process.setupRawDebug();\n+    _process.setupRawDebug(_rawDebug);\n \n     const browserGlobals = !process._noBrowserGlobals;\n     if (browserGlobals) {\n@@ -294,7 +316,7 @@\n   }\n \n   function setupProcessObject() {\n-    process._setupProcessObject(pushValueToArray);\n+    _setupProcessObject(pushValueToArray);\n \n     function pushValueToArray() {\n       for (var i = 0; i < arguments.length; i++)"
        },
        {
            "sha": "0f0e40d6a0cdbcc7cf5f2658530f9690bf8cf34b",
            "filename": "lib/internal/process.js",
            "status": "modified",
            "additions": 10,
            "deletions": 16,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess.js?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -25,10 +25,7 @@ process.assert = deprecate(\n   'DEP0100');\n \n // Set up the process.cpuUsage() function.\n-function setup_cpuUsage() {\n-  // Get the native function, which will be replaced with a JS version.\n-  const _cpuUsage = process.cpuUsage;\n-\n+function setup_cpuUsage(_cpuUsage) {\n   // Create the argument array that will be passed to the native function.\n   const cpuValues = new Float64Array(2);\n \n@@ -92,8 +89,7 @@ function setup_cpuUsage() {\n // The 3 entries filled in by the original process.hrtime contains\n // the upper/lower 32 bits of the second part of the value,\n // and the remaining nanoseconds of the value.\n-function setup_hrtime() {\n-  const _hrtime = process.hrtime;\n+function setup_hrtime(_hrtime) {\n   const hrValues = new Uint32Array(3);\n \n   process.hrtime = function hrtime(time) {\n@@ -120,12 +116,11 @@ function setup_hrtime() {\n   };\n }\n \n-function setupMemoryUsage() {\n-  const memoryUsage_ = process.memoryUsage;\n+function setupMemoryUsage(_memoryUsage) {\n   const memValues = new Float64Array(4);\n \n   process.memoryUsage = function memoryUsage() {\n-    memoryUsage_(memValues);\n+    _memoryUsage(memValues);\n     return {\n       rss: memValues[0],\n       heapTotal: memValues[1],\n@@ -245,18 +240,17 @@ function setupChannel() {\n }\n \n \n-function setupRawDebug() {\n-  const rawDebug = process._rawDebug;\n+function setupRawDebug(_rawDebug) {\n   process._rawDebug = function() {\n-    rawDebug(util.format.apply(null, arguments));\n+    _rawDebug(util.format.apply(null, arguments));\n   };\n }\n \n \n-function setupUncaughtExceptionCapture(exceptionHandlerState) {\n-  // This is a typed array for faster communication with JS.\n-  const shouldAbortOnUncaughtToggle = process._shouldAbortOnUncaughtToggle;\n-  delete process._shouldAbortOnUncaughtToggle;\n+function setupUncaughtExceptionCapture(exceptionHandlerState,\n+                                       shouldAbortOnUncaughtToggle) {\n+  // shouldAbortOnUncaughtToggle is a typed array for faster\n+  // communication with JS.\n \n   process.setUncaughtExceptionCaptureCallback = function(fn) {\n     if (fn === null) {"
        },
        {
            "sha": "27fb7311f36a7df8d8ff0d98983b5d13441c849b",
            "filename": "lib/internal/process/methods.js",
            "status": "modified",
            "additions": 24,
            "deletions": 43,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fmethods.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fmethods.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmethods.js?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -9,55 +9,36 @@ const {\n   validateUint32\n } = require('internal/validators');\n \n-function setupProcessMethods() {\n+function setupProcessMethods(_chdir, _cpuUsage, _hrtime, _memoryUsage,\n+                             _rawDebug, _umask, _initgroups, _setegid,\n+                             _seteuid, _setgid, _setuid, _setgroups) {\n   // Non-POSIX platforms like Windows don't have certain methods.\n-  if (process.setgid !== undefined) {\n-    setupPosixMethods();\n+  if (_setgid !== undefined) {\n+    setupPosixMethods(_initgroups, _setegid, _seteuid,\n+                      _setgid, _setuid, _setgroups);\n   }\n \n-  const {\n-    chdir: _chdir,\n-    umask: _umask,\n-  } = process;\n-\n-  process.chdir = chdir;\n-  process.umask = umask;\n-\n-  function chdir(directory) {\n+  process.chdir = function chdir(directory) {\n     if (typeof directory !== 'string') {\n       throw new ERR_INVALID_ARG_TYPE('directory', 'string', directory);\n     }\n     return _chdir(directory);\n-  }\n+  };\n \n-  function umask(mask) {\n+  process.umask = function umask(mask) {\n     if (mask === undefined) {\n       // Get the mask\n       return _umask(mask);\n     }\n     mask = validateAndMaskMode(mask, 'mask');\n     return _umask(mask);\n-  }\n+  };\n }\n \n-function setupPosixMethods() {\n-  const {\n-    initgroups: _initgroups,\n-    setegid: _setegid,\n-    seteuid: _seteuid,\n-    setgid: _setgid,\n-    setuid: _setuid,\n-    setgroups: _setgroups\n-  } = process;\n-\n-  process.initgroups = initgroups;\n-  process.setegid = setegid;\n-  process.seteuid = seteuid;\n-  process.setgid = setgid;\n-  process.setuid = setuid;\n-  process.setgroups = setgroups;\n+function setupPosixMethods(_initgroups, _setegid, _seteuid,\n+                           _setgid, _setuid, _setgroups) {\n \n-  function initgroups(user, extraGroup) {\n+  process.initgroups = function initgroups(user, extraGroup) {\n     validateId(user, 'user');\n     validateId(extraGroup, 'extraGroup');\n     // Result is 0 on success, 1 if user is unknown, 2 if group is unknown.\n@@ -67,25 +48,25 @@ function setupPosixMethods() {\n     } else if (result === 2) {\n       throw new ERR_UNKNOWN_CREDENTIAL('Group', extraGroup);\n     }\n-  }\n+  };\n \n-  function setegid(id) {\n+  process.setegid = function setegid(id) {\n     return execId(id, 'Group', _setegid);\n-  }\n+  };\n \n-  function seteuid(id) {\n+  process.seteuid = function seteuid(id) {\n     return execId(id, 'User', _seteuid);\n-  }\n+  };\n \n-  function setgid(id) {\n+  process.setgid = function setgid(id) {\n     return execId(id, 'Group', _setgid);\n-  }\n+  };\n \n-  function setuid(id) {\n+  process.setuid = function setuid(id) {\n     return execId(id, 'User', _setuid);\n-  }\n+  };\n \n-  function setgroups(groups) {\n+  process.setgroups = function setgroups(groups) {\n     if (!Array.isArray(groups)) {\n       throw new ERR_INVALID_ARG_TYPE('groups', 'Array', groups);\n     }\n@@ -98,7 +79,7 @@ function setupPosixMethods() {\n     if (result > 0) {\n       throw new ERR_UNKNOWN_CREDENTIAL('Group', groups[result - 1]);\n     }\n-  }\n+  };\n \n   function execId(id, type, method) {\n     validateId(id, 'id');"
        },
        {
            "sha": "df6984aabc8c07d9136e072cb9d6deb6d0dce8b5",
            "filename": "lib/internal/process/next_tick.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fnext_tick.js?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -2,7 +2,7 @@\n \n exports.setup = setupNextTick;\n \n-function setupNextTick() {\n+function setupNextTick(_setupNextTick, _setupPromises) {\n   const {\n     getDefaultTriggerAsyncId,\n     newAsyncId,\n@@ -14,10 +14,10 @@ function setupNextTick() {\n     emitDestroy,\n     symbols: { async_id_symbol, trigger_async_id_symbol }\n   } = require('internal/async_hooks');\n-  const promises = require('internal/process/promises');\n+  const emitPromiseRejectionWarnings =\n+    require('internal/process/promises').setup(_setupPromises);\n   const { ERR_INVALID_CALLBACK } = require('internal/errors').codes;\n   const FixedQueue = require('internal/fixed_queue');\n-  const { emitPromiseRejectionWarnings } = promises;\n \n   // tickInfo is used so that the C++ code in src/node.cc can\n   // have easy access to our nextTick state, and avoid unnecessary\n@@ -26,7 +26,7 @@ function setupNextTick() {\n   const [\n     tickInfo,\n     runMicrotasks\n-  ] = process._setupNextTick(_tickCallback);\n+  ] = _setupNextTick(_tickCallback);\n \n   // *Must* match Environment::TickInfo::Fields in src/env.h.\n   const kHasScheduled = 0;"
        },
        {
            "sha": "f54f34b9ae92f4fd66180f401a056c303cd0ce21",
            "filename": "lib/internal/process/promises.js",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/lib%2Finternal%2Fprocess%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fpromises.js?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -7,11 +7,12 @@ const pendingUnhandledRejections = [];\n const asyncHandledRejections = [];\n let lastPromiseId = 0;\n \n-module.exports = {\n-  emitPromiseRejectionWarnings\n-};\n+exports.setup = setupPromises;\n \n-process._setupPromises(unhandledRejection, handledRejection);\n+function setupPromises(_setupPromises) {\n+  _setupPromises(unhandledRejection, handledRejection);\n+  return emitPromiseRejectionWarnings;\n+}\n \n function unhandledRejection(promise, reason) {\n   maybeUnhandledPromises.set(promise, {"
        },
        {
            "sha": "4b94c1dd6b2ad9da783577e73338bcd6c3229227",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -309,6 +309,7 @@\n \n       'sources': [\n         'src/async_wrap.cc',\n+        'src/bootstrapper.cc',\n         'src/callback_scope.cc',\n         'src/cares_wrap.cc',\n         'src/connection_wrap.cc',"
        },
        {
            "sha": "6c7c1af3e31cf69fe36803a3d63a3b47133fcf5c",
            "filename": "src/bootstrapper.cc",
            "status": "added",
            "additions": 133,
            "deletions": 0,
            "changes": 133,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -0,0 +1,133 @@\n+#include \"node.h\"\n+#include \"env.h\"\n+#include \"env-inl.h\"\n+#include \"node_internals.h\"\n+#include \"v8.h\"\n+\n+namespace node {\n+\n+using v8::Array;\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::MaybeLocal;\n+using v8::Object;\n+using v8::Promise;\n+using v8::PromiseRejectEvent;\n+using v8::PromiseRejectMessage;\n+using v8::Value;\n+\n+void SetupProcessObject(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(args[0]->IsFunction());\n+  env->set_push_values_to_array_function(args[0].As<Function>());\n+}\n+\n+void RunMicrotasks(const FunctionCallbackInfo<Value>& args) {\n+  args.GetIsolate()->RunMicrotasks();\n+}\n+\n+void SetupNextTick(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n+  Local<Context> context = env->context();\n+\n+  CHECK(args[0]->IsFunction());\n+\n+  env->set_tick_callback_function(args[0].As<Function>());\n+\n+  Local<Function> run_microtasks_fn =\n+      env->NewFunctionTemplate(RunMicrotasks)->GetFunction(context)\n+          .ToLocalChecked();\n+  run_microtasks_fn->SetName(FIXED_ONE_BYTE_STRING(isolate, \"runMicrotasks\"));\n+\n+  Local<Array> ret = Array::New(isolate, 2);\n+  ret->Set(context, 0, env->tick_info()->fields().GetJSArray()).FromJust();\n+  ret->Set(context, 1, run_microtasks_fn).FromJust();\n+\n+  args.GetReturnValue().Set(ret);\n+}\n+\n+void PromiseRejectCallback(PromiseRejectMessage message) {\n+  Local<Promise> promise = message.GetPromise();\n+  Isolate* isolate = promise->GetIsolate();\n+  PromiseRejectEvent event = message.GetEvent();\n+\n+  Environment* env = Environment::GetCurrent(isolate);\n+  Local<Function> callback;\n+  Local<Value> value;\n+\n+  if (event == v8::kPromiseRejectWithNoHandler) {\n+    callback = env->promise_reject_unhandled_function();\n+    value = message.GetValue();\n+\n+    if (value.IsEmpty())\n+      value = Undefined(isolate);\n+  } else if (event == v8::kPromiseHandlerAddedAfterReject) {\n+    callback = env->promise_reject_handled_function();\n+    value = Undefined(isolate);\n+  } else {\n+    UNREACHABLE();\n+  }\n+\n+  Local<Value> args[] = { promise, value };\n+  MaybeLocal<Value> ret = callback->Call(env->context(),\n+                                         Undefined(isolate),\n+                                         arraysize(args),\n+                                         args);\n+\n+  if (!ret.IsEmpty() && ret.ToLocalChecked()->IsTrue())\n+    env->tick_info()->promise_rejections_toggle_on();\n+}\n+\n+void SetupPromises(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n+\n+  CHECK(args[0]->IsFunction());\n+  CHECK(args[1]->IsFunction());\n+\n+  isolate->SetPromiseRejectCallback(PromiseRejectCallback);\n+  env->set_promise_reject_unhandled_function(args[0].As<Function>());\n+  env->set_promise_reject_handled_function(args[1].As<Function>());\n+}\n+\n+#define BOOTSTRAP_METHOD(name, fn) env->SetMethod(bootstrapper, #name, fn)\n+\n+// The Bootstrapper object is an ephemeral object that is used only during\n+// the bootstrap process of the Node.js environment. A reference to the\n+// bootstrap object must not be kept around after the bootstrap process\n+// completes so that it can be gc'd as soon as possible.\n+void SetupBootstrapObject(Environment* env,\n+                          Local<Object> bootstrapper) {\n+  BOOTSTRAP_METHOD(_setupProcessObject, SetupProcessObject);\n+  BOOTSTRAP_METHOD(_setupNextTick, SetupNextTick);\n+  BOOTSTRAP_METHOD(_setupPromises, SetupPromises);\n+  BOOTSTRAP_METHOD(_chdir, Chdir);\n+  BOOTSTRAP_METHOD(_cpuUsage, CPUUsage);\n+  BOOTSTRAP_METHOD(_hrtime, Hrtime);\n+  BOOTSTRAP_METHOD(_memoryUsage, MemoryUsage);\n+  BOOTSTRAP_METHOD(_rawDebug, RawDebug);\n+  BOOTSTRAP_METHOD(_umask, Umask);\n+\n+#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n+  BOOTSTRAP_METHOD(_initgroups, InitGroups);\n+  BOOTSTRAP_METHOD(_setegid, SetEGid);\n+  BOOTSTRAP_METHOD(_seteuid, SetEUid);\n+  BOOTSTRAP_METHOD(_setgid, SetGid);\n+  BOOTSTRAP_METHOD(_setuid, SetUid);\n+  BOOTSTRAP_METHOD(_setgroups, SetGroups);\n+#endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n+\n+  auto should_abort_on_uncaught_toggle =\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"_shouldAbortOnUncaughtToggle\");\n+  CHECK(bootstrapper->Set(env->context(),\n+                       should_abort_on_uncaught_toggle,\n+                       env->should_abort_on_uncaught_toggle().GetJSArray())\n+                           .FromJust());\n+}\n+#undef BOOTSTRAP_METHOD\n+\n+}  // namespace node"
        },
        {
            "sha": "bf3aae2d35f7737d3edc4b619c8e32955bb990dc",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 123,
            "changes": 138,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -159,7 +159,6 @@ using v8::Number;\n using v8::Object;\n using v8::ObjectTemplate;\n using v8::Promise;\n-using v8::PromiseRejectMessage;\n using v8::PropertyCallbackInfo;\n using v8::ScriptOrigin;\n using v8::SealHandleScope;\n@@ -617,97 +616,6 @@ bool ShouldAbortOnUncaughtException(Isolate* isolate) {\n          !env->inside_should_not_abort_on_uncaught_scope();\n }\n \n-\n-void RunMicrotasks(const FunctionCallbackInfo<Value>& args) {\n-  args.GetIsolate()->RunMicrotasks();\n-}\n-\n-\n-void SetupProcessObject(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  CHECK(args[0]->IsFunction());\n-\n-  env->set_push_values_to_array_function(args[0].As<Function>());\n-  env->process_object()->Delete(\n-      env->context(),\n-      FIXED_ONE_BYTE_STRING(env->isolate(), \"_setupProcessObject\")).FromJust();\n-}\n-\n-\n-void SetupNextTick(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  CHECK(args[0]->IsFunction());\n-\n-  env->set_tick_callback_function(args[0].As<Function>());\n-\n-  env->process_object()->Delete(\n-      env->context(),\n-      FIXED_ONE_BYTE_STRING(env->isolate(), \"_setupNextTick\")).FromJust();\n-\n-  v8::Local<v8::Function> run_microtasks_fn =\n-      env->NewFunctionTemplate(RunMicrotasks)->GetFunction(env->context())\n-          .ToLocalChecked();\n-  run_microtasks_fn->SetName(\n-      FIXED_ONE_BYTE_STRING(env->isolate(), \"runMicrotasks\"));\n-\n-  Local<Array> ret = Array::New(env->isolate(), 2);\n-  ret->Set(env->context(), 0,\n-           env->tick_info()->fields().GetJSArray()).FromJust();\n-  ret->Set(env->context(), 1, run_microtasks_fn).FromJust();\n-\n-  args.GetReturnValue().Set(ret);\n-}\n-\n-void PromiseRejectCallback(PromiseRejectMessage message) {\n-  Local<Promise> promise = message.GetPromise();\n-  Isolate* isolate = promise->GetIsolate();\n-  v8::PromiseRejectEvent event = message.GetEvent();\n-\n-  Environment* env = Environment::GetCurrent(isolate);\n-  Local<Function> callback;\n-  Local<Value> value;\n-\n-  if (event == v8::kPromiseRejectWithNoHandler) {\n-    callback = env->promise_reject_unhandled_function();\n-    value = message.GetValue();\n-\n-    if (value.IsEmpty())\n-      value = Undefined(isolate);\n-  } else if (event == v8::kPromiseHandlerAddedAfterReject) {\n-    callback = env->promise_reject_handled_function();\n-    value = Undefined(isolate);\n-  } else {\n-    UNREACHABLE();\n-  }\n-\n-  Local<Value> args[] = { promise, value };\n-  MaybeLocal<Value> ret = callback->Call(env->context(),\n-                                         Undefined(isolate),\n-                                         arraysize(args),\n-                                         args);\n-\n-  if (!ret.IsEmpty() && ret.ToLocalChecked()->IsTrue())\n-    env->tick_info()->promise_rejections_toggle_on();\n-}\n-\n-void SetupPromises(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  Isolate* isolate = env->isolate();\n-\n-  CHECK(args[0]->IsFunction());\n-  CHECK(args[1]->IsFunction());\n-\n-  isolate->SetPromiseRejectCallback(PromiseRejectCallback);\n-  env->set_promise_reject_unhandled_function(args[0].As<Function>());\n-  env->set_promise_reject_handled_function(args[1].As<Function>());\n-\n-  env->process_object()->Delete(\n-      env->context(),\n-      FIXED_ONE_BYTE_STRING(isolate, \"_setupPromises\")).FromJust();\n-}\n-\n }  // anonymous namespace\n \n \n@@ -1315,7 +1223,7 @@ static void Abort(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void Chdir(const FunctionCallbackInfo<Value>& args) {\n+void Chdir(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1351,7 +1259,7 @@ static void Cwd(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void Umask(const FunctionCallbackInfo<Value>& args) {\n+void Umask(const FunctionCallbackInfo<Value>& args) {\n   uint32_t old;\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1496,7 +1404,7 @@ static void GetEGid(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void SetGid(const FunctionCallbackInfo<Value>& args) {\n+void SetGid(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1515,7 +1423,7 @@ static void SetGid(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void SetEGid(const FunctionCallbackInfo<Value>& args) {\n+void SetEGid(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1534,7 +1442,7 @@ static void SetEGid(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void SetUid(const FunctionCallbackInfo<Value>& args) {\n+void SetUid(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1553,7 +1461,7 @@ static void SetUid(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void SetEUid(const FunctionCallbackInfo<Value>& args) {\n+void SetEUid(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1610,7 +1518,7 @@ static void GetGroups(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void SetGroups(const FunctionCallbackInfo<Value>& args) {\n+void SetGroups(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 1);\n@@ -1644,7 +1552,7 @@ static void SetGroups(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void InitGroups(const FunctionCallbackInfo<Value>& args) {\n+void InitGroups(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 2);\n@@ -1733,7 +1641,7 @@ static void Uptime(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-static void MemoryUsage(const FunctionCallbackInfo<Value>& args) {\n+void MemoryUsage(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   size_t rss;\n@@ -1785,7 +1693,7 @@ static void Kill(const FunctionCallbackInfo<Value>& args) {\n // broken into the upper/lower 32 bits to be converted back in JS,\n // because there is no Uint64Array in JS.\n // The third entry contains the remaining nanosecond part of the value.\n-static void Hrtime(const FunctionCallbackInfo<Value>& args) {\n+void Hrtime(const FunctionCallbackInfo<Value>& args) {\n   uint64_t t = uv_hrtime();\n \n   Local<ArrayBuffer> ab = args[0].As<Uint32Array>()->Buffer();\n@@ -1804,7 +1712,7 @@ static void Hrtime(const FunctionCallbackInfo<Value>& args) {\n // which are uv_timeval_t structs (long tv_sec, long tv_usec).\n // Returns those values as Float64 microseconds in the elements of the array\n // passed to the function.\n-static void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n+void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n   uv_rusage_t rusage;\n \n   // Call libuv to get the values we'll return.\n@@ -2829,13 +2737,6 @@ void SetupProcessObject(Environment* env,\n                              FIXED_ONE_BYTE_STRING(env->isolate(), \"ppid\"),\n                              GetParentProcessId).FromJust());\n \n-  auto should_abort_on_uncaught_toggle =\n-      FIXED_ONE_BYTE_STRING(env->isolate(), \"_shouldAbortOnUncaughtToggle\");\n-  CHECK(process->Set(env->context(),\n-                     should_abort_on_uncaught_toggle,\n-                     env->should_abort_on_uncaught_toggle().GetJSArray())\n-                         .FromJust());\n-\n   // -e, --eval\n   if (eval_string) {\n     READONLY_PROPERTY(process,\n@@ -2978,17 +2879,9 @@ void SetupProcessObject(Environment* env,\n #if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n   env->SetMethod(process, \"getuid\", GetUid);\n   env->SetMethod(process, \"geteuid\", GetEUid);\n-  env->SetMethod(process, \"setuid\", SetUid);\n-  env->SetMethod(process, \"seteuid\", SetEUid);\n-\n-  env->SetMethod(process, \"setgid\", SetGid);\n-  env->SetMethod(process, \"setegid\", SetEGid);\n   env->SetMethod(process, \"getgid\", GetGid);\n   env->SetMethod(process, \"getegid\", GetEGid);\n-\n   env->SetMethod(process, \"getgroups\", GetGroups);\n-  env->SetMethod(process, \"setgroups\", SetGroups);\n-  env->SetMethod(process, \"initgroups\", InitGroups);\n #endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n \n   env->SetMethod(process, \"_kill\", Kill);\n@@ -3004,10 +2897,6 @@ void SetupProcessObject(Environment* env,\n \n   env->SetMethod(process, \"uptime\", Uptime);\n   env->SetMethod(process, \"memoryUsage\", MemoryUsage);\n-\n-  env->SetMethod(process, \"_setupProcessObject\", SetupProcessObject);\n-  env->SetMethod(process, \"_setupNextTick\", SetupNextTick);\n-  env->SetMethod(process, \"_setupPromises\", SetupPromises);\n }\n \n \n@@ -3032,7 +2921,7 @@ void SignalExit(int signo) {\n // to the process.stderr stream.  However, in some cases, such as\n // when debugging the stream.Writable class or the process.nextTick\n // function, it is useful to bypass JavaScript entirely.\n-static void RawDebug(const FunctionCallbackInfo<Value>& args) {\n+void RawDebug(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args.Length() == 1 && args[0]->IsString() &&\n         \"must be called with a single string\");\n   node::Utf8Value message(args.GetIsolate(), args[0]);\n@@ -3163,9 +3052,12 @@ void LoadEnvironment(Environment* env) {\n   }\n \n   // Bootstrap Node.js\n+  Local<Object> bootstrapper = Object::New(env->isolate());\n+  SetupBootstrapObject(env, bootstrapper);\n   Local<Value> bootstrapped_node;\n   Local<Value> node_bootstrapper_args[] = {\n     env->process_object(),\n+    bootstrapper,\n     bootstrapped_loaders\n   };\n   if (!ExecuteBootstrapper(env, node_bootstrapper,"
        },
        {
            "sha": "3014a0e5f7a4428d421ad2481c43c0d91f05ed56",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/cb3d049badb772fc1ea7051540d50c89f73e36dd/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=cb3d049badb772fc1ea7051540d50c89f73e36dd",
            "patch": "@@ -357,6 +357,8 @@ inline v8::Local<v8::Value> FillGlobalStatsArray(Environment* env,\n   return node::FillStatsArray(env->fs_stats_field_array(), s, offset);\n }\n \n+void SetupBootstrapObject(Environment* env,\n+                          v8::Local<v8::Object> bootstrapper);\n void SetupProcessObject(Environment* env,\n                         int argc,\n                         const char* const* argv,\n@@ -873,6 +875,24 @@ static inline const char *errno_string(int errorno) {\n     TRACING_CATEGORY_NODE \".\" #one \",\"                                        \\\n     TRACING_CATEGORY_NODE \".\" #one \".\" #two\n \n+// Functions defined in node.cc that are exposed via the bootstrapper object\n+\n+void Chdir(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void CPUUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void Hrtime(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void MemoryUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void RawDebug(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void Umask(const v8::FunctionCallbackInfo<v8::Value>& args);\n+\n+#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n+void SetGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void SetEGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void SetUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void SetEUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void SetGroups(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void InitGroups(const v8::FunctionCallbackInfo<v8::Value>& args);\n+#endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n+\n }  // namespace node\n \n void napi_module_register_by_symbol(v8::Local<v8::Object> exports,"
        }
    ],
    "stats": {
        "total": 444,
        "additions": 244,
        "deletions": 200
    }
}