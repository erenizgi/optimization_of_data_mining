{
    "author": "refack",
    "message": "test: refacor spawn[Sync]Pwd\n\n* extract the gist into common.pwdCommand\n* Merge test-child-process-buffering.js into test-child-process-stdio.js\n\nPR-URL: https://github.com/nodejs/node/pull/22522\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "8569f4a4178d1a114a95aabcb27cb30cb265e621",
    "files": [
        {
            "sha": "28d9bd04f0a8b680e899b489ec6ea2ad3e0c7bc1",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 11,
            "deletions": 12,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -317,6 +317,17 @@ A port number for tests to use if one is needed.\n \n Logs '1..0 # Skipped: ' + `msg`\n \n+### pwdCommand\n+* [&lt;array>] First two argument for the `spawn`/`exec` functions.\n+\n+Platform normalized `pwd` command options. Usage example:\n+```js\n+const common = require('../common');\n+const { spawn } = require('child_process');\n+\n+spawn(...common.pwdCommand, { stdio: ['pipe'] });\n+```\n+\n ### rootDir\n * [&lt;string>]\n \n@@ -350,18 +361,6 @@ was disabled at compile time.\n Skip the rest of the tests in the current file when the Node.js executable\n was compiled with a pointer size smaller than 64 bits.\n \n-### spawnPwd(options)\n-* `options` [&lt;Object>]\n-* return [&lt;Object>]\n-\n-Platform normalizes the `pwd` command.\n-\n-### spawnSyncPwd(options)\n-* `options` [&lt;Object>]\n-* return [&lt;Object>]\n-\n-Synchronous version of `spawnPwd`.\n-\n ## ArrayStream Module\n \n The `ArrayStream` module provides a simple `Stream` that pushes elements from"
        },
        {
            "sha": "6f37cb734a424043d159eac9178befbb90f0f44b",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 4,
            "deletions": 16,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -26,7 +26,7 @@ const path = require('path');\n const fs = require('fs');\n const assert = require('assert');\n const os = require('os');\n-const { exec, execSync, spawn, spawnSync } = require('child_process');\n+const { exec, execSync, spawnSync } = require('child_process');\n const util = require('util');\n const { fixturesDir } = require('./fixtures');\n const tmpdir = require('./tmpdir');\n@@ -268,22 +268,10 @@ exports.ddCommand = function(filename, kilobytes) {\n };\n \n \n-exports.spawnPwd = function(options) {\n-  if (exports.isWindows) {\n-    return spawn('cmd.exe', ['/d', '/c', 'cd'], options);\n-  } else {\n-    return spawn('pwd', [], options);\n-  }\n-};\n-\n+exports.pwdCommand = exports.isWindows ?\n+  ['cmd.exe', ['/d', '/c', 'cd']] :\n+  ['pwd', []];\n \n-exports.spawnSyncPwd = function(options) {\n-  if (exports.isWindows) {\n-    return spawnSync('cmd.exe', ['/d', '/c', 'cd'], options);\n-  } else {\n-    return spawnSync('pwd', [], options);\n-  }\n-};\n \n exports.platformTimeout = function(ms) {\n   if (process.features.debug)"
        },
        {
            "sha": "d37d255e18b007edceee9ee2d496a4ef748cfac5",
            "filename": "test/parallel/test-child-process-buffering.js",
            "status": "removed",
            "additions": 0,
            "deletions": 51,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/6a689c8aa3ef3bf517cc86807406b9a8958d4ffb/test%2Fparallel%2Ftest-child-process-buffering.js",
            "raw_url": "https://github.com/nodejs/node/raw/6a689c8aa3ef3bf517cc86807406b9a8958d4ffb/test%2Fparallel%2Ftest-child-process-buffering.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-buffering.js?ref=6a689c8aa3ef3bf517cc86807406b9a8958d4ffb",
            "patch": "@@ -1,51 +0,0 @@\n-// Copyright Joyent, Inc. and other Node contributors.\n-//\n-// Permission is hereby granted, free of charge, to any person obtaining a\n-// copy of this software and associated documentation files (the\n-// \"Software\"), to deal in the Software without restriction, including\n-// without limitation the rights to use, copy, modify, merge, publish,\n-// distribute, sublicense, and/or sell copies of the Software, and to permit\n-// persons to whom the Software is furnished to do so, subject to the\n-// following conditions:\n-//\n-// The above copyright notice and this permission notice shall be included\n-// in all copies or substantial portions of the Software.\n-//\n-// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n-// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n-// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n-// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n-// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n-// USE OR OTHER DEALINGS IN THE SOFTWARE.\n-\n-'use strict';\n-const common = require('../common');\n-const assert = require('assert');\n-\n-function pwd(callback) {\n-  let output = '';\n-  const child = common.spawnPwd();\n-\n-  child.stdout.setEncoding('utf8');\n-  child.stdout.on('data', function(s) {\n-    console.log(`stdout: ${JSON.stringify(s)}`);\n-    output += s;\n-  });\n-\n-  child.on('exit', common.mustCall(function(c) {\n-    console.log(`exit: ${c}`);\n-    assert.strictEqual(0, c);\n-  }));\n-\n-  child.on('close', common.mustCall(function() {\n-    callback(output);\n-  }));\n-}\n-\n-\n-pwd(function(result) {\n-  console.dir(result);\n-  assert.strictEqual(true, result.length > 1);\n-  assert.strictEqual('\\n', result[result.length - 1]);\n-});"
        },
        {
            "sha": "1c89c207d37f99f94f17511ed97e8b73913ce4e1",
            "filename": "test/parallel/test-child-process-custom-fds.js",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-custom-fds.js",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-custom-fds.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-custom-fds.js?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -2,19 +2,22 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n+const { spawnSync } = require('child_process');\n const internalCp = require('internal/child_process');\n-const oldSpawnSync = internalCp.spawnSync;\n \n if (!common.isMainThread)\n   common.skip('stdio is not associated with file descriptors in Workers');\n \n+// This test uses the deprecated `customFds` option. We expect a deprecation\n+// warning, but only once (per node process).\n+const msg = 'child_process: options.customFds option is deprecated. ' +\n+            'Use options.stdio instead.';\n+common.expectWarning('DeprecationWarning', msg, 'DEP0006');\n+\n // Verify that customFds is used if stdio is not provided.\n {\n-  const msg = 'child_process: options.customFds option is deprecated. ' +\n-              'Use options.stdio instead.';\n-  common.expectWarning('DeprecationWarning', msg, 'DEP0006');\n-\n   const customFds = [-1, process.stdout.fd, process.stderr.fd];\n+  const oldSpawnSync = internalCp.spawnSync;\n   internalCp.spawnSync = common.mustCall(function(opts) {\n     assert.deepStrictEqual(opts.options.customFds, customFds);\n     assert.deepStrictEqual(opts.options.stdio, [\n@@ -23,13 +26,14 @@ if (!common.isMainThread)\n       { type: 'fd', fd: process.stderr.fd }\n     ]);\n   });\n-  common.spawnSyncPwd({ customFds });\n+  spawnSync(...common.pwdCommand, { customFds });\n   internalCp.spawnSync = oldSpawnSync;\n }\n \n // Verify that customFds is ignored when stdio is present.\n {\n   const customFds = [0, 1, 2];\n+  const oldSpawnSync = internalCp.spawnSync;\n   internalCp.spawnSync = common.mustCall(function(opts) {\n     assert.deepStrictEqual(opts.options.customFds, customFds);\n     assert.deepStrictEqual(opts.options.stdio, [\n@@ -38,6 +42,6 @@ if (!common.isMainThread)\n       { type: 'pipe', readable: false, writable: true }\n     ]);\n   });\n-  common.spawnSyncPwd({ customFds, stdio: 'pipe' });\n+  spawnSync(...common.pwdCommand, { customFds, stdio: 'pipe' });\n   internalCp.spawnSync = oldSpawnSync;\n }"
        },
        {
            "sha": "fdca618a8bcc9c8fe2344e224f89b759bf9fd1d4",
            "filename": "test/parallel/test-child-process-cwd.js",
            "status": "modified",
            "additions": 21,
            "deletions": 34,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-cwd.js",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-cwd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-cwd.js?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -22,47 +22,37 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-\n-let returns = 0;\n+const { spawn } = require('child_process');\n \n /*\n   Spawns 'pwd' with given options, then test\n-  - whether the exit code equals forCode,\n-  - optionally whether the stdout result matches forData\n-    (after removing trailing whitespace)\n+  - whether the exit code equals expectCode,\n+  - optionally whether the trimmed stdout result matches expectData\n */\n-function testCwd(options, forCode, forData) {\n-  let data = '';\n-\n-  const child = common.spawnPwd(options);\n+function testCwd(options, expectCode = 0, expectData) {\n+  const child = spawn(...common.pwdCommand, options);\n \n   child.stdout.setEncoding('utf8');\n \n+  // No need to assert callback since `data` is asserted.\n+  let data = '';\n   child.stdout.on('data', function(chunk) {\n     data += chunk;\n   });\n \n+  // Can't assert callback, as stayed in to API:\n+  // _The 'exit' event may or may not fire after an error has occurred._\n   child.on('exit', function(code, signal) {\n-    assert.strictEqual(forCode, code);\n-  });\n-\n-  child.on('close', function() {\n-    forData && assert.strictEqual(forData, data.replace(/[\\s\\r\\n]+$/, ''));\n-    returns--;\n+    assert.strictEqual(expectCode, code);\n   });\n \n-  returns++;\n+  child.on('close', common.mustCall(function() {\n+    expectData && assert.strictEqual(data.trim(), expectData);\n+  }));\n \n   return child;\n }\n \n-// Assume these exist, and 'pwd' gives us the right directory back\n-testCwd({ cwd: common.rootDir }, 0, common.rootDir);\n-if (common.isWindows) {\n-  testCwd({ cwd: process.env.windir }, 0, process.env.windir);\n-} else {\n-  testCwd({ cwd: '/dev' }, 0, '/dev');\n-}\n \n // Assume does-not-exist doesn't exist, expect exitCode=-1 and errno=ENOENT\n {\n@@ -72,15 +62,12 @@ if (common.isWindows) {\n     }));\n }\n \n-// Spawn() shouldn't try to chdir() so this should just work\n-testCwd(undefined, 0);\n-testCwd({}, 0);\n-testCwd({ cwd: '' }, 0);\n-testCwd({ cwd: undefined }, 0);\n-testCwd({ cwd: null }, 0);\n+// Assume these exist, and 'pwd' gives us the right directory back\n+testCwd({ cwd: common.rootDir }, 0, common.rootDir);\n+const shouldExistDir = common.isWindows ? process.env.windir : '/dev';\n+testCwd({ cwd: shouldExistDir }, 0, shouldExistDir);\n \n-// Check whether all tests actually returned\n-assert.notStrictEqual(returns, 0);\n-process.on('exit', function() {\n-  assert.strictEqual(returns, 0);\n-});\n+// Spawn() shouldn't try to chdir() to invalid arg, so this should just work\n+testCwd({ cwd: '' });\n+testCwd({ cwd: undefined });\n+testCwd({ cwd: null });"
        },
        {
            "sha": "99ce75da12091aaa7114af24fa8c1aa5c076392b",
            "filename": "test/parallel/test-child-process-spawnsync.js",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-spawnsync.js",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-spawnsync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-spawnsync.js?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -22,10 +22,9 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n+const { spawnSync } = require('child_process');\n \n-const spawnSync = require('child_process').spawnSync;\n-\n-// Echo does different things on Windows and Unix, but in both cases, it does\n+// `sleep` does different things on Windows and Unix, but in both cases, it does\n // more-or-less nothing if there are no parameters\n const ret = spawnSync('sleep', ['0']);\n assert.strictEqual(ret.status, 0);\n@@ -42,21 +41,23 @@ assert.deepStrictEqual(ret_err.spawnargs, ['bar']);\n {\n   // Test the cwd option\n   const cwd = common.rootDir;\n-  const response = common.spawnSyncPwd({ cwd });\n+  const response = spawnSync(...common.pwdCommand, { cwd });\n \n   assert.strictEqual(response.stdout.toString().trim(), cwd);\n }\n \n+\n {\n-  // Test the encoding option\n-  const noEncoding = common.spawnSyncPwd();\n-  const bufferEncoding = common.spawnSyncPwd({ encoding: 'buffer' });\n-  const utf8Encoding = common.spawnSyncPwd({ encoding: 'utf8' });\n+  // Assert Buffer is the default encoding\n+  const retDefault = spawnSync(...common.pwdCommand);\n+  const retBuffer = spawnSync(...common.pwdCommand, { encoding: 'buffer' });\n+  assert.deepStrictEqual(retDefault.output, retBuffer.output);\n \n-  assert.deepStrictEqual(noEncoding.output, bufferEncoding.output);\n-  assert.deepStrictEqual([\n+  const retUTF8 = spawnSync(...common.pwdCommand, { encoding: 'utf8' });\n+  const stringifiedDefault = [\n     null,\n-    noEncoding.stdout.toString(),\n-    noEncoding.stderr.toString()\n-  ], utf8Encoding.output);\n+    retDefault.stdout.toString(),\n+    retDefault.stderr.toString()\n+  ];\n+  assert.deepStrictEqual(retUTF8.output, stringifiedDefault);\n }"
        },
        {
            "sha": "5ca3875f5600f6c225e403683eb456e3ca23621e",
            "filename": "test/parallel/test-child-process-stdio.js",
            "status": "modified",
            "additions": 47,
            "deletions": 15,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-stdio.js",
            "raw_url": "https://github.com/nodejs/node/raw/8569f4a4178d1a114a95aabcb27cb30cb265e621/test%2Fparallel%2Ftest-child-process-stdio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-stdio.js?ref=8569f4a4178d1a114a95aabcb27cb30cb265e621",
            "patch": "@@ -22,24 +22,56 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-const spawnSync = require('child_process').spawnSync;\n+const { spawn } = require('child_process');\n \n-let options = { stdio: ['pipe'] };\n-let child = common.spawnPwd(options);\n+// Test stdio piping.\n+{\n+  const child = spawn(...common.pwdCommand, { stdio: ['pipe'] });\n+  assert.notStrictEqual(child.stdout, null);\n+  assert.notStrictEqual(child.stderr, null);\n+}\n \n-assert.notStrictEqual(child.stdout, null);\n-assert.notStrictEqual(child.stderr, null);\n+// Test stdio ignoring.\n+{\n+  const child = spawn(...common.pwdCommand, { stdio: 'ignore' });\n+  assert.strictEqual(child.stdout, null);\n+  assert.strictEqual(child.stderr, null);\n+}\n \n-options = { stdio: 'ignore' };\n-child = common.spawnPwd(options);\n+// Asset options invariance.\n+{\n+  const options = { stdio: 'ignore' };\n+  spawn(...common.pwdCommand, options);\n+  assert.deepStrictEqual(options, { stdio: 'ignore' });\n+}\n \n-assert.strictEqual(child.stdout, null);\n-assert.strictEqual(child.stderr, null);\n+// Test stdout buffering.\n+{\n+  let output = '';\n+  const child = spawn(...common.pwdCommand);\n \n-options = { stdio: 'ignore' };\n-child = spawnSync('cat', [], options);\n-assert.deepStrictEqual(options, { stdio: 'ignore' });\n+  child.stdout.setEncoding('utf8');\n+  child.stdout.on('data', function(s) {\n+    output += s;\n+  });\n \n-common.expectsError(() => {\n-  common.spawnPwd({ stdio: ['pipe', 'pipe', 'pipe', 'ipc', 'ipc'] });\n-}, { code: 'ERR_IPC_ONE_PIPE', type: Error });\n+  child.on('exit', common.mustCall(function(code) {\n+    assert.strictEqual(code, 0);\n+  }));\n+\n+  child.on('close', common.mustCall(function() {\n+    assert.strictEqual(true, output.length > 1);\n+    assert.strictEqual('\\n', output[output.length - 1]);\n+  }));\n+}\n+\n+// Assert only one IPC pipe allowed.\n+common.expectsError(\n+  () => {\n+    spawn(\n+      ...common.pwdCommand,\n+      { stdio: ['pipe', 'pipe', 'pipe', 'ipc', 'ipc'] }\n+    );\n+  },\n+  { code: 'ERR_IPC_ONE_PIPE', type: Error }\n+);"
        }
    ],
    "stats": {
        "total": 256,
        "additions": 108,
        "deletions": 148
    }
}