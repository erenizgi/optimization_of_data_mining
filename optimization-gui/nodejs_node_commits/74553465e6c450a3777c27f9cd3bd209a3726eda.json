{
    "author": "lpinca",
    "message": "test: refactor test-cluster-send-deadlock\n\nWait for the sockets to be connected before closing them and remove\nunneeded `setTimeout()`.\n\nPR-URL: https://github.com/nodejs/node/pull/19241\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>",
    "sha": "74553465e6c450a3777c27f9cd3bd209a3726eda",
    "files": [
        {
            "sha": "b02837e7fb1793419db3544abb2534692bfd5236",
            "filename": "test/parallel/test-cluster-send-deadlock.js",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/74553465e6c450a3777c27f9cd3bd209a3726eda/test%2Fparallel%2Ftest-cluster-send-deadlock.js",
            "raw_url": "https://github.com/nodejs/node/raw/74553465e6c450a3777c27f9cd3bd209a3726eda/test%2Fparallel%2Ftest-cluster-send-deadlock.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cluster-send-deadlock.js?ref=74553465e6c450a3777c27f9cd3bd209a3726eda",
            "patch": "@@ -47,19 +47,25 @@ if (cluster.isMaster) {\n   process.on('message', function(msg, handle) {\n     if (msg.message && msg.message === 'listen') {\n       assert(msg.port);\n-      const client1 = net.connect({ host: 'localhost', port: msg.port });\n-      const client2 = net.connect({ host: 'localhost', port: msg.port });\n+      const client1 = net.connect({\n+        host: 'localhost',\n+        port: msg.port\n+      }, function() {\n+        const client2 = net.connect({\n+          host: 'localhost',\n+          port: msg.port\n+        }, function() {\n+          client1.on('close', onclose);\n+          client2.on('close', onclose);\n+          client1.end();\n+          client2.end();\n+        });\n+      });\n       let waiting = 2;\n-      client1.on('close', onclose);\n-      client2.on('close', onclose);\n       function onclose() {\n         if (--waiting === 0)\n           cluster.worker.disconnect();\n       }\n-      setTimeout(function() {\n-        client1.end();\n-        client2.end();\n-      }, 50);\n     } else {\n       process.send('reply', handle);\n     }"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 14,
        "deletions": 8
    }
}