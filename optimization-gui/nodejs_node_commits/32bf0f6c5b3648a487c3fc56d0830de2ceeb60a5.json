{
    "author": "joyeecheung",
    "message": "fs: throw errors from fs.symlinkSync in JS\n\nPR-URL: https://github.com/nodejs/node/pull/18348\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5",
    "files": [
        {
            "sha": "c75a8501b674284e1c97877cb3e8a563da474bec",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5",
            "patch": "@@ -1220,6 +1220,7 @@ fs.symlink = function(target, path, type_, callback_) {\n   const flags = stringToSymlinkType(type);\n   const req = new FSReqWrap();\n   req.oncomplete = callback;\n+\n   binding.symlink(preprocessSymlinkDestination(target, type, path),\n                   pathModule.toNamespacedPath(path), flags, req);\n };\n@@ -1234,8 +1235,19 @@ fs.symlinkSync = function(target, path, type) {\n   validatePath(target, 'target');\n   validatePath(path);\n   const flags = stringToSymlinkType(type);\n-  return binding.symlink(preprocessSymlinkDestination(target, type, path),\n-                         pathModule.toNamespacedPath(path), flags);\n+\n+  const ctx = { path: target, dest: path };\n+  binding.symlink(preprocessSymlinkDestination(target, type, path),\n+                  pathModule.toNamespacedPath(path), flags, undefined, ctx);\n+\n+  if (ctx.errno !== undefined) {\n+    throw new errors.uvException(ctx);\n+  } else if (ctx.error) {\n+    // TODO(joyeecheung): this is an encoding error usually caused by memory\n+    // problems. We need to figure out proper error code(s) for this.\n+    Error.captureStackTrace(ctx.error);\n+    throw ctx.error;\n+  }\n };\n \n fs.link = function(existingPath, newPath, callback) {"
        },
        {
            "sha": "d67d45d4a8274dd937d1ee4e71b2615c1dd346fd",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=32bf0f6c5b3648a487c3fc56d0830de2ceeb60a5",
            "patch": "@@ -598,22 +598,26 @@ static void FStat(const FunctionCallbackInfo<Value>& args) {\n static void Symlink(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  CHECK_GE(args.Length(), 3);\n+  int argc = args.Length();\n+  CHECK_GE(argc, 4);\n \n   BufferValue target(env->isolate(), args[0]);\n   CHECK_NE(*target, nullptr);\n   BufferValue path(env->isolate(), args[1]);\n   CHECK_NE(*path, nullptr);\n \n-  CHECK(args[2]->IsUint32());\n-  int flags = args[2]->Uint32Value(env->context()).ToChecked();\n+  CHECK(args[2]->IsInt32());\n+  int flags = args[2].As<Int32>()->Value();\n \n   if (args[3]->IsObject()) {  // symlink(target, path, flags, req)\n     CHECK_EQ(args.Length(), 4);\n     AsyncDestCall(env, args, \"symlink\", *path, path.length(), UTF8,\n                   AfterNoArgs, uv_fs_symlink, *target, *path, flags);\n-  } else {  // symlink(target, path, flags)\n-    SYNC_DEST_CALL(symlink, *target, *path, *target, *path, flags)\n+  } else {  // symlink(target, path, flags, undefinec, ctx)\n+    CHECK_EQ(argc, 5);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[4], &req_wrap, \"symlink\",\n+             uv_fs_symlink, *target, *path, flags);\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 30,
        "additions": 23,
        "deletions": 7
    }
}