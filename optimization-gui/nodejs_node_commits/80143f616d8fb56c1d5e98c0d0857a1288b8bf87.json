{
    "author": "boneskull",
    "message": "process: add allowedNodeEnvironmentFlags property\n\n`process.allowedNodeEnvironmentFlags` provides an API to validate and\nlist flags as specified in `NODE_OPTIONS` from user code.\n\nRefs: https://github.com/nodejs/node/issues/17740\nSigned-off-by: Christopher Hiller <boneskull@boneskull.com>\n\nPR-URL: https://github.com/nodejs/node/pull/19335\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Gibson Fahnestock <gibfahn@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Sam Ruby <rubys@intertwingly.net>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
    "files": [
        {
            "sha": "5aec229e9e8ed91bdcf7d29bd5646633860f8f3e",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -416,6 +416,55 @@ generate a core file.\n \n This feature is not available in [`Worker`][] threads.\n \n+## process.allowedNodeEnvironmentFlags\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {Set}\n+\n+The `process.allowedNodeEnvironmentFlags` property is a special,\n+read-only `Set` of flags allowable within the [`NODE_OPTIONS`][]\n+environment variable.\n+\n+`process.allowedNodeEnvironmentFlags` extends `Set`, but overrides\n+`Set.prototype.has` to recognize several different possible flag\n+representations.  `process.allowedNodeEnvironmentFlags.has()` will\n+return `true` in the following cases:\n+\n+- Flags may omit leading single (`-`) or double (`--`) dashes; e.g.,\n+  `inspect-brk` for `--inspect-brk`, or `r` for `-r`.\n+- Flags passed through to V8 (as listed in `--v8-options`) may replace\n+  one or more *non-leading* dashes for an underscore, or vice-versa;\n+  e.g., `--perf_basic_prof`, `--perf-basic-prof`, `--perf_basic-prof`,\n+  etc.\n+- Flags may contain one or more equals (`=`) characters; all\n+  characters after and including the first equals will be ignored;\n+  e.g., `--stack-trace-limit=100`.\n+- Flags *must* be allowable within [`NODE_OPTIONS`][].\n+\n+When iterating over `process.allowedNodeEnvironmentFlags`, flags will\n+appear only *once*; each will begin with one or more dashes. Flags\n+passed through to V8 will contain underscores instead of non-leading\n+dashes:\n+\n+```js\n+process.allowedNodeEnvironmentFlags.forEach((flag) => {\n+  // -r\n+  // --inspect-brk\n+  // --abort_on_uncaught_exception\n+  // ...\n+});\n+```\n+\n+The methods `add()`, `clear()`, and `delete()` of\n+`process.allowedNodeEnvironmentFlags` do nothing, and will fail\n+silently.\n+\n+If Node.js was compiled *without* [`NODE_OPTIONS`][] support (shown in\n+[`process.config`][]), `process.allowedNodeEnvironmentFlags` will\n+contain what *would have* been allowable.\n+\n ## process.arch\n <!-- YAML\n added: v0.5.0\n@@ -2061,8 +2110,10 @@ cases:\n [`end()`]: stream.html#stream_writable_end_chunk_encoding_callback\n [`net.Server`]: net.html#net_class_net_server\n [`net.Socket`]: net.html#net_class_net_socket\n+[`NODE_OPTIONS`]: cli.html#cli_node_options_options\n [`os.constants.dlopen`]: os.html#os_dlopen_constants\n [`process.argv`]: #process_process_argv\n+[`process.config`]: #process_process_config\n [`process.execPath`]: #process_process_execpath\n [`process.exit()`]: #process_process_exit_code\n [`process.exitCode`]: #process_process_exitcode"
        },
        {
            "sha": "c98ea207984734de29c96872e316fe964bf5cd66",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -185,6 +185,8 @@\n \n     perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n \n+    setupAllowedFlags();\n+\n     // There are various modes that Node can run in. The most common two\n     // are running from a script and running the REPL - but there are a few\n     // others like the debugger or running --eval arguments. Here we decide\n@@ -635,5 +637,92 @@\n     new vm.Script(source, { displayErrors: true, filename });\n   }\n \n+  function setupAllowedFlags() {\n+    // This builds process.allowedNodeEnvironmentFlags\n+    // from data in the config binding\n+\n+    const replaceDashesRegex = /-/g;\n+    const leadingDashesRegex = /^--?/;\n+    const trailingValuesRegex = /=.*$/;\n+\n+    // Save references so user code does not interfere\n+    const replace = Function.call.bind(String.prototype.replace);\n+    const has = Function.call.bind(Set.prototype.has);\n+    const test = Function.call.bind(RegExp.prototype.test);\n+\n+    const {\n+      allowedV8EnvironmentFlags,\n+      allowedNodeEnvironmentFlags\n+    } = process.binding('config');\n+\n+    const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n+\n+    // Save these for comparison against flags provided to\n+    // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n+    // Avoid interference w/ user code by flattening `Set.prototype` into\n+    // each object.\n+    const [nodeFlags, v8Flags] = [\n+      allowedNodeEnvironmentFlags, allowedV8EnvironmentFlags\n+    ].map((flags) => Object.defineProperties(\n+      new Set(flags.map(trimLeadingDashes)),\n+      Object.getOwnPropertyDescriptors(Set.prototype))\n+    );\n+\n+    class NodeEnvironmentFlagsSet extends Set {\n+      constructor(...args) {\n+        super(...args);\n+\n+        // the super constructor consumes `add`, but\n+        // disallow any future adds.\n+        this.add = () => this;\n+      }\n+\n+      delete() {\n+        // noop, `Set` API compatible\n+        return false;\n+      }\n+\n+      clear() {\n+        // noop\n+      }\n+\n+      has(key) {\n+        // This will return `true` based on various possible\n+        // permutations of a flag, including present/missing leading\n+        // dash(es) and/or underscores-for-dashes in the case of V8-specific\n+        // flags.  Strips any values after `=`, inclusive.\n+        if (typeof key === 'string') {\n+          key = replace(key, trailingValuesRegex, '');\n+          if (test(leadingDashesRegex, key)) {\n+            return has(this, key) ||\n+                  has(v8Flags,\n+                      replace(\n+                        replace(\n+                          key,\n+                          leadingDashesRegex,\n+                          ''\n+                        ),\n+                        replaceDashesRegex,\n+                        '_'\n+                      )\n+                  );\n+          }\n+          return has(nodeFlags, key) ||\n+                has(v8Flags, replace(key, replaceDashesRegex, '_'));\n+        }\n+        return false;\n+      }\n+    }\n+\n+    Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n+    Object.freeze(NodeEnvironmentFlagsSet.prototype);\n+\n+    process.allowedNodeEnvironmentFlags = Object.freeze(\n+      new NodeEnvironmentFlagsSet(\n+        allowedNodeEnvironmentFlags.concat(allowedV8EnvironmentFlags)\n+      )\n+    );\n+  }\n+\n   startup();\n });"
        },
        {
            "sha": "5ec559fe5f7d32b2b1d523c5841eb07098d1354d",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -587,6 +587,68 @@ const char* signo_string(int signo) {\n   }\n }\n \n+// These are all flags available for use with NODE_OPTIONS.\n+//\n+// Disallowed flags:\n+//  These flags cause Node to do things other than run scripts:\n+//    --version / -v\n+//    --eval / -e\n+//    --print / -p\n+//    --check / -c\n+//    --interactive / -i\n+//    --prof-process\n+//    --v8-options\n+//  These flags are disallowed because security:\n+//    --preserve-symlinks\n+const char* const environment_flags[] = {\n+  // Node options, sorted in `node --help` order for ease of comparison.\n+  \"--enable-fips\",\n+  \"--experimental-modules\",\n+  \"--experimenatl-repl-await\",\n+  \"--experimental-vm-modules\",\n+  \"--experimental-worker\",\n+  \"--force-fips\",\n+  \"--icu-data-dir\",\n+  \"--inspect\",\n+  \"--inspect-brk\",\n+  \"--inspect-port\",\n+  \"--loader\",\n+  \"--napi-modules\",\n+  \"--no-deprecation\",\n+  \"--no-force-async-hooks-checks\",\n+  \"--no-warnings\",\n+  \"--openssl-config\",\n+  \"--pending-deprecation\",\n+  \"--redirect-warnings\",\n+  \"--require\",\n+  \"--throw-deprecation\",\n+  \"--tls-cipher-list\",\n+  \"--trace-deprecation\",\n+  \"--trace-event-categories\",\n+  \"--trace-event-file-pattern\",\n+  \"--trace-events-enabled\",\n+  \"--trace-sync-io\",\n+  \"--trace-warnings\",\n+  \"--track-heap-objects\",\n+  \"--use-bundled-ca\",\n+  \"--use-openssl-ca\",\n+  \"--v8-pool-size\",\n+  \"--zero-fill-buffers\",\n+  \"-r\"\n+};\n+\n+  // V8 options (define with '_', which allows '-' or '_')\n+const char* const v8_environment_flags[] = {\n+  \"--abort_on_uncaught_exception\",\n+  \"--max_old_space_size\",\n+  \"--perf_basic_prof\",\n+  \"--perf_prof\",\n+  \"--stack_trace_limit\",\n+};\n+\n+int v8_environment_flags_count = arraysize(v8_environment_flags);\n+int environment_flags_count = arraysize(environment_flags);\n+\n // Look up environment variable unless running as setuid root.\n bool SafeGetenv(const char* key, std::string* text) {\n #if !defined(__CloudABI__) && !defined(_WIN32)"
        },
        {
            "sha": "c6e6211da288e4f4af9fd64a44cc29e3afe13e23",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -5,6 +5,7 @@\n \n namespace node {\n \n+using v8::Array;\n using v8::Boolean;\n using v8::Context;\n using v8::Integer;\n@@ -132,6 +133,22 @@ static void Initialize(Local<Object> target,\n   READONLY_PROPERTY(debug_options_obj,\n                     \"inspectorEnabled\",\n                     Boolean::New(isolate, debug_options->inspector_enabled));\n+\n+  Local<Array> environmentFlags = Array::New(env->isolate(),\n+                                  environment_flags_count);\n+  READONLY_PROPERTY(target, \"allowedNodeEnvironmentFlags\", environmentFlags);\n+  for (int i = 0; i < environment_flags_count; ++i) {\n+    environmentFlags->Set(i, OneByteString(env->isolate(),\n+        environment_flags[i]));\n+  }\n+\n+  Local<Array> v8EnvironmentFlags = Array::New(env->isolate(),\n+                                    v8_environment_flags_count);\n+  READONLY_PROPERTY(target, \"allowedV8EnvironmentFlags\", v8EnvironmentFlags);\n+  for (int i = 0; i < v8_environment_flags_count; ++i) {\n+    v8EnvironmentFlags->Set(i, OneByteString(env->isolate(),\n+        v8_environment_flags[i]));\n+  }\n }  // InitConfig\n \n }  // namespace node"
        },
        {
            "sha": "eb9e79d9e8b522b110ddeb1a3570ff3d71c86cf7",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -178,6 +178,11 @@ extern bool v8_initialized;\n \n extern std::shared_ptr<PerProcessOptions> per_process_opts;\n \n+extern const char* const environment_flags[];\n+extern int environment_flags_count;\n+extern const char* const v8_environment_flags[];\n+extern int v8_environment_flags_count;\n+\n // Forward declaration\n class Environment;\n "
        },
        {
            "sha": "25907c3b0e8f3c04dfb757b1c015d11f0ed66e52",
            "filename": "test/parallel/test-process-env-allowed-flags.js",
            "status": "added",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-allowed-flags.js?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -0,0 +1,74 @@\n+'use strict';\n+\n+const assert = require('assert');\n+require('../common');\n+\n+// assert legit flags are allowed, and bogus flags are disallowed\n+{\n+  const goodFlags = [\n+    '--inspect-brk',\n+    'inspect-brk',\n+    '--perf_basic_prof',\n+    '--perf-basic-prof',\n+    'perf-basic-prof',\n+    '--perf_basic-prof',\n+    'perf_basic-prof',\n+    'perf_basic_prof',\n+    '-r',\n+    'r',\n+    '--stack-trace-limit=100',\n+    '--stack-trace-limit=-=xX_nodejs_Xx=-'\n+  ];\n+\n+  const badFlags = [\n+    '--inspect_brk',\n+    'INSPECT-BRK',\n+    '--INSPECT-BRK',\n+    '--r',\n+    '-R',\n+    '---inspect-brk',\n+    '--cheeseburgers'\n+  ];\n+\n+  goodFlags.forEach((flag) => {\n+    assert.strictEqual(\n+      process.allowedNodeEnvironmentFlags.has(flag),\n+      true,\n+      `flag should be in set: ${flag}`\n+    );\n+  });\n+\n+  badFlags.forEach((flag) => {\n+    assert.strictEqual(\n+      process.allowedNodeEnvironmentFlags.has(flag),\n+      false,\n+      `flag should not be in set: ${flag}`\n+    );\n+  });\n+}\n+\n+// assert all \"canonical\" flags begin with dash(es)\n+{\n+  process.allowedNodeEnvironmentFlags.forEach((flag) => {\n+    assert.strictEqual(/^--?[a-z8_-]+$/.test(flag), true);\n+  });\n+}\n+\n+// assert immutability of process.allowedNodeEnvironmentFlags\n+{\n+  assert.strictEqual(Object.isFrozen(process.allowedNodeEnvironmentFlags),\n+                     true);\n+\n+  process.allowedNodeEnvironmentFlags.add('foo');\n+  assert.strictEqual(process.allowedNodeEnvironmentFlags.has('foo'), false);\n+  process.allowedNodeEnvironmentFlags.forEach((flag) => {\n+    assert.strictEqual(flag === 'foo', false);\n+  });\n+\n+  process.allowedNodeEnvironmentFlags.clear();\n+  assert.strictEqual(process.allowedNodeEnvironmentFlags.size > 0, true);\n+\n+  const size = process.allowedNodeEnvironmentFlags.size;\n+  process.allowedNodeEnvironmentFlags.delete('-r');\n+  assert.strictEqual(process.allowedNodeEnvironmentFlags.size, size);\n+}"
        },
        {
            "sha": "b57dc6957a9ae01226ee61b06432e004290705e3",
            "filename": "tools/doc/type-parser.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/tools%2Fdoc%2Ftype-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/80143f616d8fb56c1d5e98c0d0857a1288b8bf87/tools%2Fdoc%2Ftype-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Ftype-parser.js?ref=80143f616d8fb56c1d5e98c0d0857a1288b8bf87",
            "patch": "@@ -16,7 +16,7 @@ const jsPrimitives = {\n const jsGlobalObjectsUrl = `${jsDocPrefix}Reference/Global_Objects/`;\n const jsGlobalTypes = [\n   'Array', 'ArrayBuffer', 'DataView', 'Date', 'Error', 'EvalError', 'Function',\n-  'Object', 'Promise', 'RangeError', 'ReferenceError', 'RegExp',\n+  'Object', 'Promise', 'RangeError', 'ReferenceError', 'RegExp', 'Set',\n   'SharedArrayBuffer', 'SyntaxError', 'TypeError', 'TypedArray', 'URIError',\n   'Uint8Array',\n ];"
        }
    ],
    "stats": {
        "total": 300,
        "additions": 299,
        "deletions": 1
    }
}