{
    "author": "billywhizz",
    "message": "test: refactor test after review\n\nPR-URL: https://github.com/nodejs/node/pull/18999\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "38eb0fa7372052433520ea2e1575072892bc5eec",
    "files": [
        {
            "sha": "58a2f92de9405444ca79fa5ac11f9425b4b415a8",
            "filename": "test/parallel/test-http-client-spurious-aborted.js",
            "status": "modified",
            "additions": 12,
            "deletions": 20,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/38eb0fa7372052433520ea2e1575072892bc5eec/test%2Fparallel%2Ftest-http-client-spurious-aborted.js",
            "raw_url": "https://github.com/nodejs/node/raw/38eb0fa7372052433520ea2e1575072892bc5eec/test%2Fparallel%2Ftest-http-client-spurious-aborted.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-spurious-aborted.js?ref=38eb0fa7372052433520ea2e1575072892bc5eec",
            "patch": "@@ -3,37 +3,26 @@\n const common = require('../common');\n const http = require('http');\n const assert = require('assert');\n-const fs = require('fs');\n+const { Writable } = require('stream');\n const Countdown = require('../common/countdown');\n \n-function cleanup(fname) {\n-  try {\n-    if (fs.statSync(fname)) fs.unlinkSync(fname);\n-  } catch (err) {}\n-}\n-\n const N = 2;\n-const fname = '/dev/null';\n let abortRequest = true;\n \n const server = http.Server(common.mustCall((req, res) => {\n   const headers = { 'Content-Type': 'text/plain' };\n   headers['Content-Length'] = 50;\n   const socket = res.socket;\n   res.writeHead(200, headers);\n-  setTimeout(() => res.write('aaaaaaaaaa'), 100);\n-  setTimeout(() => res.write('bbbbbbbbbb'), 200);\n-  setTimeout(() => res.write('cccccccccc'), 300);\n-  setTimeout(() => res.write('dddddddddd'), 400);\n+  res.write('aaaaaaaaaabbbbbbbbbbccccccccccdddddddddd');\n   if (abortRequest) {\n-    setTimeout(() => socket.destroy(), 600);\n+    process.nextTick(() => socket.destroy());\n   } else {\n-    setTimeout(() => res.end('eeeeeeeeee'), 1000);\n+    process.nextTick(() => res.end('eeeeeeeeee'));\n   }\n }, N));\n \n server.listen(0, common.mustCall(() => {\n-  cleanup(fname);\n   download();\n }));\n \n@@ -53,13 +42,17 @@ function download() {\n     assert.strictEqual(res.statusCode, 200);\n     assert.strictEqual(res.headers.connection, 'close');\n     let aborted = false;\n-    const fstream = fs.createWriteStream(fname);\n-    res.pipe(fstream);\n+    const writable = new Writable({\n+      write(chunk, encoding, callback) {\n+        callback();\n+      }\n+    });\n+    res.pipe(writable);\n     const _handle = res.socket._handle;\n     _handle._close = res.socket._handle.close;\n     _handle.close = function(callback) {\n       _handle._close();\n-      // set readable to true event though request is complete\n+      // set readable to true even though request is complete\n       if (res.complete) res.readable = true;\n       callback();\n     };\n@@ -70,9 +63,8 @@ function download() {\n       aborted = true;\n     });\n     res.on('error', common.mustNotCall());\n-    fstream.on('finish', () => {\n+    writable.on('finish', () => {\n       assert.strictEqual(aborted, abortRequest);\n-      cleanup(fname);\n       finishCountdown.dec();\n       if (finishCountdown.remaining === 0) return;\n       abortRequest = false; // next one should be a good response"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 12,
        "deletions": 20
    }
}