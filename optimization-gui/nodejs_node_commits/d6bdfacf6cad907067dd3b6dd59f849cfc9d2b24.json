{
    "author": "apapirovski",
    "message": "src: do not persist timer handle in cares_wrap\n\nInstead of relying on garbage collection to close the timer handle,\nmanage its state more explicitly.\n\nPR-URL: https://github.com/nodejs/node/pull/21093\nFixes: https://github.com/nodejs/node/issues/18190\nRefs: https://github.com/nodejs/node/pull/18307\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "d6bdfacf6cad907067dd3b6dd59f849cfc9d2b24",
    "files": [
        {
            "sha": "05ef2b7e12090e39fe00c1fdd72ee17c9d52ab12",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 23,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/d6bdfacf6cad907067dd3b6dd59f849cfc9d2b24/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d6bdfacf6cad907067dd3b6dd59f849cfc9d2b24/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=d6bdfacf6cad907067dd3b6dd59f849cfc9d2b24",
            "patch": "@@ -151,7 +151,8 @@ class ChannelWrap : public AsyncWrap {\n \n   void Setup();\n   void EnsureServers();\n-  void CleanupTimer();\n+  void StartTimer();\n+  void CloseTimer();\n \n   void ModifyActivityQueryCount(int count);\n \n@@ -313,13 +314,7 @@ void ares_sockstate_cb(void* data,\n   if (read || write) {\n     if (!task) {\n       /* New socket */\n-\n-      /* If this is the first socket then start the timer. */\n-      uv_timer_t* timer_handle = channel->timer_handle();\n-      if (!uv_is_active(reinterpret_cast<uv_handle_t*>(timer_handle))) {\n-        CHECK(channel->task_list()->empty());\n-        uv_timer_start(timer_handle, ChannelWrap::AresTimeout, 1000, 1000);\n-      }\n+      channel->StartTimer();\n \n       task = ares_task_create(channel, sock);\n       if (task == nullptr) {\n@@ -349,7 +344,7 @@ void ares_sockstate_cb(void* data,\n     channel->env()->CloseHandle(&task->poll_watcher, ares_poll_close_cb);\n \n     if (channel->task_list()->empty()) {\n-      uv_timer_stop(channel->timer_handle());\n+      channel->CloseTimer();\n     }\n   }\n }\n@@ -490,15 +485,26 @@ void ChannelWrap::Setup() {\n   }\n \n   library_inited_ = true;\n+}\n \n-  /* Initialize the timeout timer. The timer won't be started until the */\n-  /* first socket is opened. */\n-  CleanupTimer();\n-  timer_handle_ = new uv_timer_t();\n-  timer_handle_->data = static_cast<void*>(this);\n-  uv_timer_init(env()->event_loop(), timer_handle_);\n+void ChannelWrap::StartTimer() {\n+  if (timer_handle_ == nullptr) {\n+    timer_handle_ = new uv_timer_t();\n+    timer_handle_->data = static_cast<void*>(this);\n+    uv_timer_init(env()->event_loop(), timer_handle_);\n+  } else if (uv_is_active(reinterpret_cast<uv_handle_t*>(timer_handle_))) {\n+    return;\n+  }\n+  uv_timer_start(timer_handle_, AresTimeout, 1000, 1000);\n }\n \n+void ChannelWrap::CloseTimer() {\n+  if (timer_handle_ == nullptr)\n+    return;\n+\n+  env()->CloseHandle(timer_handle_, [](uv_timer_t* handle) { delete handle; });\n+  timer_handle_ = nullptr;\n+}\n \n ChannelWrap::~ChannelWrap() {\n   if (library_inited_) {\n@@ -508,17 +514,10 @@ ChannelWrap::~ChannelWrap() {\n   }\n \n   ares_destroy(channel_);\n-  CleanupTimer();\n+  CloseTimer();\n }\n \n \n-void ChannelWrap::CleanupTimer() {\n-  if (timer_handle_ == nullptr) return;\n-\n-  env()->CloseHandle(timer_handle_, [](uv_timer_t* handle) { delete handle; });\n-  timer_handle_ = nullptr;\n-}\n-\n void ChannelWrap::ModifyActivityQueryCount(int count) {\n   active_query_count_ += count;\n   if (active_query_count_ < 0) active_query_count_ = 0;\n@@ -566,6 +565,7 @@ void ChannelWrap::EnsureServers() {\n   /* destroy channel and reset channel */\n   ares_destroy(channel_);\n \n+  CloseTimer();\n   Setup();\n }\n "
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}