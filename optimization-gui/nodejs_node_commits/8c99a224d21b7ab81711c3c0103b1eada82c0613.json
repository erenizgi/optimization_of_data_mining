{
    "author": "forivall",
    "message": "test: add test-benchmark-napi\n\nAlso makes sure that the napi benchmark is built before running jstest.\n\nSkipped on windows since n-api benchmarks aren't built there yet.\n\nPR-URL: https://github.com/nodejs/node/pull/23585\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "8c99a224d21b7ab81711c3c0103b1eada82c0613",
    "files": [
        {
            "sha": "dadc1e91ec5b720096db7a6b40a51e76d70aff7e",
            "filename": "Makefile",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/8c99a224d21b7ab81711c3c0103b1eada82c0613/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/8c99a224d21b7ab81711c3c0103b1eada82c0613/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=8c99a224d21b7ab81711c3c0103b1eada82c0613",
            "patch": "@@ -270,7 +270,7 @@ v8:\n \ttools/make-v8.sh $(V8_ARCH).$(BUILDTYPE_LOWER) $(V8_BUILD_OPTIONS)\n \n .PHONY: jstest\n-jstest: build-addons build-addons-napi ## Runs addon tests and JS tests\n+jstest: build-addons build-addons-napi bench-addons-build ## Runs addon tests and JS tests\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) --mode=$(BUILDTYPE_LOWER) \\\n \t\t--skip-tests=$(CI_SKIP_TESTS) \\\n \t\t$(CI_JS_SUITES) \\\n@@ -414,7 +414,7 @@ clear-stalled:\n \t\techo $${PS_OUT} | xargs kill -9; \\\n \tfi\n \n-test-build: | all build-addons build-addons-napi\n+test-build: | all build-addons build-addons-napi bench-addons-build\n \n test-build-addons-napi: all build-addons-napi\n \n@@ -444,7 +444,7 @@ test-ci-native: | test/addons/.buildstamp test/addons-napi/.buildstamp\n test-ci-js: | clear-stalled\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) -p tap --logfile test.tap \\\n \t\t--mode=$(BUILDTYPE_LOWER) --flaky-tests=$(FLAKY_TESTS) \\\n-\t\t$(TEST_CI_ARGS) $(CI_JS_SUITES)\n+\t\t$(TEST_CI_ARGS) $(CI_JS_SUITES) --skip-tests=sequential/test-benchmark-napi\n \t@echo \"Clean up any leftover processes, error if found.\"\n \tps awwx | grep Release/node | grep -v grep | cat\n \t@PS_OUT=`ps awwx | grep Release/node | grep -v grep | awk '{print $$1}'`; \\\n@@ -455,7 +455,7 @@ test-ci-js: | clear-stalled\n .PHONY: test-ci\n # Related CI jobs: most CI tests, excluding node-test-commit-arm-fanned\n test-ci: LOGLEVEL := info\n-test-ci: | clear-stalled build-addons build-addons-napi doc-only\n+test-ci: | clear-stalled build-addons build-addons-napi doc-only bench-addons-build\n \tout/Release/cctest --gtest_output=tap:cctest.tap\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) -p tap --logfile test.tap \\\n \t\t--mode=$(BUILDTYPE_LOWER) --flaky-tests=$(FLAKY_TESTS) \\\n@@ -496,7 +496,7 @@ test-debug: test-build\n test-message: test-build\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) message\n \n-test-simple: | cctest  # Depends on 'all'.\n+test-simple: | cctest bench-addons-build  # Depends on 'all'.\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) parallel sequential\n \n test-pummel: all"
        },
        {
            "sha": "1a3a0f1cd2b96e6064e87acaedb92537438bbac0",
            "filename": "benchmark/napi/function_args/napi_binding.c",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8c99a224d21b7ab81711c3c0103b1eada82c0613/benchmark%2Fnapi%2Ffunction_args%2Fnapi_binding.c",
            "raw_url": "https://github.com/nodejs/node/raw/8c99a224d21b7ab81711c3c0103b1eada82c0613/benchmark%2Fnapi%2Ffunction_args%2Fnapi_binding.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnapi%2Ffunction_args%2Fnapi_binding.c?ref=8c99a224d21b7ab81711c3c0103b1eada82c0613",
            "patch": "@@ -50,7 +50,8 @@ static napi_value CallWithArray(napi_env env, napi_callback_info info) {\n     status = napi_get_array_length(env, array, &length);\n     assert(status == napi_ok);\n \n-    for (uint32_t i = 0; i < length; ++i) {\n+    uint32_t i;\n+    for (i = 0; i < length; ++i) {\n       napi_value v;\n       status = napi_get_element(env, array, i, &v);\n       assert(status == napi_ok);\n@@ -173,7 +174,8 @@ static napi_value CallWithArguments(napi_env env, napi_callback_info info) {\n     status = napi_get_value_uint32(env, args[0], &loop);\n     assert(status == napi_ok);\n \n-    for (uint32_t i = 1; i < loop; ++i) {\n+    uint32_t i;\n+    for (i = 1; i < loop; ++i) {\n       assert(i < argc);\n       status = napi_typeof(env, args[i], types);\n       assert(status == napi_ok);"
        },
        {
            "sha": "1a1ff23d60c5c07ae8897214dbec53655d6cd79e",
            "filename": "test/sequential/test-benchmark-napi.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/8c99a224d21b7ab81711c3c0103b1eada82c0613/test%2Fsequential%2Ftest-benchmark-napi.js",
            "raw_url": "https://github.com/nodejs/node/raw/8c99a224d21b7ab81711c3c0103b1eada82c0613/test%2Fsequential%2Ftest-benchmark-napi.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-benchmark-napi.js?ref=8c99a224d21b7ab81711c3c0103b1eada82c0613",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+if (common.isWindows) {\n+  common.skip('vcbuild.bat doesn\\'t build the n-api benchmarks yet');\n+}\n+\n+if (!common.isMainThread) {\n+  common.skip('addons are not supported in workers');\n+}\n+\n+if (process.features.debug) {\n+  common.skip('benchmark does not work with debug build yet');\n+}\n+const runBenchmark = require('../common/benchmark');\n+\n+runBenchmark('napi',\n+             [\n+               'n=1',\n+               'engine=v8',\n+               'type=String'\n+             ],\n+             { NODEJS_BENCHMARK_ZERO_ALLOWED: 1 });"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 33,
        "deletions": 7
    }
}