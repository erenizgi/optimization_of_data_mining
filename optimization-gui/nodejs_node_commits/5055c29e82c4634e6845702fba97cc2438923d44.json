{
    "author": "joyeecheung",
    "message": "test: use runWithInvalidFD() in tests expecting EBADF\n\nPR-URL: https://github.com/nodejs/node/pull/18864\nFixes: https://github.com/nodejs/node/issues/18820\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "5055c29e82c4634e6845702fba97cc2438923d44",
    "files": [
        {
            "sha": "f81d96c0569990b4f41d7a89c2bda9ec390ba414",
            "filename": "test/parallel/test-fs-close-errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 40,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-fs-close-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-fs-close-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-close-errors.js?ref=5055c29e82c4634e6845702fba97cc2438923d44",
            "patch": "@@ -4,9 +4,7 @@\n // include the desired properties\n \n const common = require('../common');\n-const assert = require('assert');\n const fs = require('fs');\n-const uv = process.binding('uv');\n \n ['', false, null, undefined, {}, []].forEach((i) => {\n   common.expectsError(\n@@ -26,41 +24,3 @@ const uv = process.binding('uv');\n     }\n   );\n });\n-\n-{\n-  assert.throws(\n-    () => {\n-      const fd = fs.openSync(__filename, 'r');\n-      fs.closeSync(fd);\n-      fs.closeSync(fd);\n-    },\n-    (err) => {\n-      assert.strictEqual(err.code, 'EBADF');\n-      assert.strictEqual(\n-        err.message,\n-        'EBADF: bad file descriptor, close'\n-      );\n-      assert.strictEqual(err.constructor, Error);\n-      assert.strictEqual(err.syscall, 'close');\n-      assert.strictEqual(err.errno, uv.UV_EBADF);\n-      return true;\n-    }\n-  );\n-}\n-\n-{\n-  const fd = fs.openSync(__filename, 'r');\n-  fs.close(fd, common.mustCall((err) => {\n-    assert.ifError(err);\n-    fs.close(fd, common.mustCall((err) => {\n-      assert.strictEqual(err.code, 'EBADF');\n-      assert.strictEqual(\n-        err.message,\n-        'EBADF: bad file descriptor, close'\n-      );\n-      assert.strictEqual(err.constructor, Error);\n-      assert.strictEqual(err.syscall, 'close');\n-      assert.strictEqual(err.errno, uv.UV_EBADF);\n-    }));\n-  }));\n-}"
        },
        {
            "sha": "28461de9bee9b298e11749e899711211c24f952d",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 50,
            "deletions": 33,
            "changes": 83,
            "blob_url": "https://github.com/nodejs/node/blob/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=5055c29e82c4634e6845702fba97cc2438923d44",
            "patch": "@@ -94,15 +94,14 @@ function re(literals, ...values) {\n     return true;\n   };\n \n-  const fd = fs.openSync(existingFile, 'r');\n-  fs.closeSync(fd);\n-\n-  fs.fstat(fd, common.mustCall(validateError));\n-\n-  assert.throws(\n-    () => fs.fstatSync(fd),\n-    validateError\n-  );\n+  common.runWithInvalidFD((fd) => {\n+    fs.fstat(fd, common.mustCall(validateError));\n+\n+    assert.throws(\n+      () => fs.fstatSync(fd),\n+      validateError\n+    );\n+  });\n }\n \n // realpath\n@@ -414,6 +413,27 @@ function re(literals, ...values) {\n   );\n }\n \n+\n+// close\n+{\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, close');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'close');\n+    return true;\n+  };\n+\n+  common.runWithInvalidFD((fd) => {\n+    fs.close(fd, common.mustCall(validateError));\n+\n+    assert.throws(\n+      () => fs.closeSync(fd),\n+      validateError\n+    );\n+  });\n+}\n+\n // readFile\n {\n   const validateError = (err) => {\n@@ -472,15 +492,14 @@ function re(literals, ...values) {\n     return true;\n   };\n \n-  const fd = fs.openSync(existingFile, 'r');\n-  fs.closeSync(fd);\n+  common.runWithInvalidFD((fd) => {\n+    fs.ftruncate(fd, 4, common.mustCall(validateError));\n \n-  fs.ftruncate(fd, 4, common.mustCall(validateError));\n-\n-  assert.throws(\n-    () => fs.ftruncateSync(fd, 4),\n-    validateError\n-  );\n+    assert.throws(\n+      () => fs.ftruncateSync(fd, 4),\n+      validateError\n+    );\n+  });\n }\n \n // fdatasync\n@@ -493,15 +512,14 @@ function re(literals, ...values) {\n     return true;\n   };\n \n-  const fd = fs.openSync(existingFile, 'r');\n-  fs.closeSync(fd);\n-\n-  fs.fdatasync(fd, common.mustCall(validateError));\n+  common.runWithInvalidFD((fd) => {\n+    fs.fdatasync(fd, common.mustCall(validateError));\n \n-  assert.throws(\n-    () => fs.fdatasyncSync(fd),\n-    validateError\n-  );\n+    assert.throws(\n+      () => fs.fdatasyncSync(fd),\n+      validateError\n+    );\n+  });\n }\n \n // fsync\n@@ -514,13 +532,12 @@ function re(literals, ...values) {\n     return true;\n   };\n \n-  const fd = fs.openSync(existingFile, 'r');\n-  fs.closeSync(fd);\n-\n-  fs.fsync(fd, common.mustCall(validateError));\n+  common.runWithInvalidFD((fd) => {\n+    fs.fsync(fd, common.mustCall(validateError));\n \n-  assert.throws(\n-    () => fs.fsyncSync(fd),\n-    validateError\n-  );\n+    assert.throws(\n+      () => fs.fsyncSync(fd),\n+      validateError\n+    );\n+  });\n }"
        },
        {
            "sha": "adf88cbde659ce5fff37a8cd8f4e57dd377710ee",
            "filename": "test/parallel/test-ttywrap-invalid-fd.js",
            "status": "modified",
            "additions": 6,
            "deletions": 13,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/5055c29e82c4634e6845702fba97cc2438923d44/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js?ref=5055c29e82c4634e6845702fba97cc2438923d44",
            "patch": "@@ -2,7 +2,6 @@\n // Flags: --expose-internals\n \n const common = require('../common');\n-const fs = require('fs');\n const tty = require('tty');\n const { SystemError } = require('internal/errors');\n \n@@ -22,12 +21,9 @@ common.expectsError(\n \n   common.expectsError(\n     () => {\n-      let fd = 2;\n-      // Get first known bad file descriptor.\n-      try {\n-        while (fs.fstatSync(++fd));\n-      } catch (e) { }\n-      new tty.WriteStream(fd);\n+      common.runWithInvalidFD((fd) => {\n+        new tty.WriteStream(fd);\n+      });\n     }, {\n       code: 'ERR_SYSTEM_ERROR',\n       type: SystemError,\n@@ -37,12 +33,9 @@ common.expectsError(\n \n   common.expectsError(\n     () => {\n-      let fd = 2;\n-      // Get first known bad file descriptor.\n-      try {\n-        while (fs.fstatSync(++fd));\n-      } catch (e) { }\n-      new tty.ReadStream(fd);\n+      common.runWithInvalidFD((fd) => {\n+        new tty.ReadStream(fd);\n+      });\n     }, {\n       code: 'ERR_SYSTEM_ERROR',\n       type: SystemError,"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 56,
        "deletions": 86
    }
}