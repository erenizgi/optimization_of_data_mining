{
    "author": "killagu",
    "message": "child_process: fix exec set stdout.setEncoding\n\ncp.exec decide to use `_stdout`(_stdout is string) or\n`Buffer.concat(_stdout)`(_stdout is buffer array) by options.encoding.\nbut std(out|err) encoding can be changed. If encoding is changed to\nnot null, `_stdout` will become string, and `Buffer.concat(_stdout)`\nwill throw TypeError. This patch will fix it, use\noptions.encoding and `std(out|err)._readableState.encoding`.\n\nPR-URL: https://github.com/nodejs/node/pull/18976\nFixes: https://github.com/nodejs/node/issues/18969\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
    "files": [
        {
            "sha": "3b614a7924f8937fcb9f94775e3859692e6ead5d",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
            "patch": "@@ -324,7 +324,8 @@ Readable.prototype.setEncoding = function(enc) {\n   if (!StringDecoder)\n     StringDecoder = require('string_decoder').StringDecoder;\n   this._readableState.decoder = new StringDecoder(enc);\n-  this._readableState.encoding = enc;\n+  // if setEncoding(null), decoder.encoding equals utf8\n+  this._readableState.encoding = this._readableState.decoder.encoding;\n   return this;\n };\n "
        },
        {
            "sha": "b2835b0a8f58bebeb72172f63951f30fa43470f2",
            "filename": "lib/child_process.js",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/lib%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/lib%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fchild_process.js?ref=7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
            "patch": "@@ -226,15 +226,11 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n   });\n \n   var encoding;\n-  var _stdout;\n-  var _stderr;\n+  var _stdout = [];\n+  var _stderr = [];\n   if (options.encoding !== 'buffer' && Buffer.isEncoding(options.encoding)) {\n     encoding = options.encoding;\n-    _stdout = '';\n-    _stderr = '';\n   } else {\n-    _stdout = [];\n-    _stderr = [];\n     encoding = null;\n   }\n   var stdoutLen = 0;\n@@ -261,11 +257,24 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n     // merge chunks\n     var stdout;\n     var stderr;\n-    if (encoding) {\n-      stdout = _stdout;\n-      stderr = _stderr;\n+    if (encoding ||\n+      (\n+        child.stdout &&\n+        child.stdout._readableState &&\n+        child.stdout._readableState.encoding\n+      )) {\n+      stdout = _stdout.join('');\n     } else {\n       stdout = Buffer.concat(_stdout);\n+    }\n+    if (encoding ||\n+      (\n+        child.stderr &&\n+        child.stderr._readableState &&\n+        child.stderr._readableState.encoding\n+      )) {\n+      stderr = _stderr.join('');\n+    } else {\n       stderr = Buffer.concat(_stderr);\n     }\n \n@@ -329,13 +338,12 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n       child.stdout.setEncoding(encoding);\n \n     child.stdout.on('data', function onChildStdout(chunk) {\n+      var encoding = child.stdout._readableState.encoding;\n       stdoutLen += encoding ? Buffer.byteLength(chunk, encoding) : chunk.length;\n \n       if (stdoutLen > options.maxBuffer) {\n         ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER('stdout');\n         kill();\n-      } else if (encoding) {\n-        _stdout += chunk;\n       } else {\n         _stdout.push(chunk);\n       }\n@@ -347,13 +355,12 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n       child.stderr.setEncoding(encoding);\n \n     child.stderr.on('data', function onChildStderr(chunk) {\n+      var encoding = child.stderr._readableState.encoding;\n       stderrLen += encoding ? Buffer.byteLength(chunk, encoding) : chunk.length;\n \n       if (stderrLen > options.maxBuffer) {\n         ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER('stderr');\n         kill();\n-      } else if (encoding) {\n-        _stderr += chunk;\n       } else {\n         _stderr.push(chunk);\n       }"
        },
        {
            "sha": "94545e719ba2d74e6d9e0c4520f1f74a6ac7b7a8",
            "filename": "test/parallel/test-child-process-exec-maxBuffer.js",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js?ref=7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
            "patch": "@@ -41,3 +41,25 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n \n   cp.exec(cmd, { maxBuffer: 10 }, checkFactory('stderr'));\n }\n+\n+{\n+  const cmd = `\"${process.execPath}\" -e \"console.log('${unicode}');\"`;\n+\n+  const child = cp.exec(\n+    cmd,\n+    { encoding: null, maxBuffer: 10 },\n+    checkFactory('stdout'));\n+\n+  child.stdout.setEncoding('utf-8');\n+}\n+\n+{\n+  const cmd = `\"${process.execPath}\" -e \"console.error('${unicode}');\"`;\n+\n+  const child = cp.exec(\n+    cmd,\n+    { encoding: null, maxBuffer: 10 },\n+    checkFactory('stderr'));\n+\n+  child.stderr.setEncoding('utf-8');\n+}"
        },
        {
            "sha": "11cb66cf42cc5b36662e27ee3d22d12d6345c760",
            "filename": "test/parallel/test-child-process-exec-std-encoding.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-child-process-exec-std-encoding.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-child-process-exec-std-encoding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-exec-std-encoding.js?ref=7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
            "patch": "@@ -0,0 +1,23 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const stdoutData = 'foo';\n+const stderrData = 'bar';\n+const expectedStdout = `${stdoutData}\\n`;\n+const expectedStderr = `${stderrData}\\n`;\n+\n+if (process.argv[2] === 'child') {\n+  // The following console calls are part of the test.\n+  console.log(stdoutData);\n+  console.error(stderrData);\n+} else {\n+  const cmd = `\"${process.execPath}\" \"${__filename}\" child`;\n+  const child = cp.exec(cmd, common.mustCall((err, stdout, stderr) => {\n+    assert.ifError(err);\n+    assert.strictEqual(stdout, expectedStdout);\n+    assert.strictEqual(stderr, expectedStderr);\n+  }));\n+  child.stdout.setEncoding('utf-8');\n+  child.stderr.setEncoding('utf-8');\n+}"
        },
        {
            "sha": "b95b26bb7957283e341ac3ca320124e5e475b477",
            "filename": "test/parallel/test-stream-readable-setEncoding-null.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-stream-readable-setEncoding-null.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d81f5d1435a208f34f0d3ca15034ff8eaf060ce/test%2Fparallel%2Ftest-stream-readable-setEncoding-null.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-setEncoding-null.js?ref=7d81f5d1435a208f34f0d3ca15034ff8eaf060ce",
            "patch": "@@ -0,0 +1,15 @@\n+'use strict';\n+\n+require('../common');\n+const assert = require('assert');\n+const { Readable } = require('stream');\n+\n+\n+{\n+  const readable = new Readable({ encoding: 'hex' });\n+  assert.strictEqual(readable._readableState.encoding, 'hex');\n+\n+  readable.setEncoding(null);\n+\n+  assert.strictEqual(readable._readableState.encoding, 'utf8');\n+}"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 82,
        "deletions": 14
    }
}