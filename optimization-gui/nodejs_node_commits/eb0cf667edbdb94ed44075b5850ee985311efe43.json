{
    "author": "addaleax",
    "message": "src: fix tracing if cwd or file path is inaccessible\n\nOtherwise this would have crashed the process.\nIn particular, checking the return value of an libuv call against `-1`\nwas invalid to begin with, as libuv uses it to propagate the\nerror code.\n\nPR-URL: https://github.com/nodejs/node/pull/21867\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "eb0cf667edbdb94ed44075b5850ee985311efe43",
    "files": [
        {
            "sha": "5e3ddc633f153fe3988dedb15d2e4d4488b10e5d",
            "filename": "src/tracing/node_trace_writer.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/eb0cf667edbdb94ed44075b5850ee985311efe43/src%2Ftracing%2Fnode_trace_writer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eb0cf667edbdb94ed44075b5850ee985311efe43/src%2Ftracing%2Fnode_trace_writer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.cc?ref=eb0cf667edbdb94ed44075b5850ee985311efe43",
            "patch": "@@ -77,8 +77,13 @@ void NodeTraceWriter::OpenNewFileForStreaming() {\n \n   fd_ = uv_fs_open(tracing_loop_, &req, filepath.c_str(),\n       O_CREAT | O_WRONLY | O_TRUNC, 0644, nullptr);\n-  CHECK_NE(fd_, -1);\n   uv_fs_req_cleanup(&req);\n+  if (fd_ < 0) {\n+    fprintf(stderr, \"Could not open trace file %s: %s\\n\",\n+                    filepath.c_str(),\n+                    uv_strerror(fd_));\n+    fd_ = -1;\n+  }\n }\n \n void NodeTraceWriter::AppendTraceEvent(TraceObject* trace_event) {\n@@ -145,6 +150,7 @@ void NodeTraceWriter::Flush(bool blocking) {\n }\n \n void NodeTraceWriter::WriteToFile(std::string&& str, int highest_request_id) {\n+  if (fd_ == -1) return;\n   WriteRequest* write_req = new WriteRequest();\n   write_req->str = std::move(str);\n   write_req->writer = this;"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}