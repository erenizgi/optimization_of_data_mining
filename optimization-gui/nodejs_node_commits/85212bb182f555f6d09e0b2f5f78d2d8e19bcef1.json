{
    "author": "AndreasMadsen",
    "message": "trace_events: add file pattern cli option\n\nAllow the user to specify the filepath for the trace_events log file\nusing a template string.\n\nPR-URL: https://github.com/nodejs/node/pull/18480\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
    "files": [
        {
            "sha": "9bc997a98ae64b6436e73afd215b966bdaad2815",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -235,6 +235,14 @@ added: v7.7.0\n A comma separated list of categories that should be traced when trace event\n tracing is enabled using `--trace-events-enabled`.\n \n+### `--trace-event-file-pattern`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Template string specifying the filepath for the trace event data, it\n+supports `${rotation}` and `${pid}`.\n+\n ### `--zero-fill-buffers`\n <!-- YAML\n added: v6.0.0\n@@ -464,6 +472,7 @@ Node options that are allowed are:\n - `--trace-deprecation`\n - `--trace-events-categories`\n - `--trace-events-enabled`\n+- `--trace-event-file-pattern`\n - `--trace-sync-io`\n - `--trace-warnings`\n - `--track-heap-objects`"
        },
        {
            "sha": "4e161faf9cdf5b696017e061f3daf00a0bfe808a",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -33,6 +33,15 @@ Running Node.js with tracing enabled will produce log files that can be opened\n in the [`chrome://tracing`](https://www.chromium.org/developers/how-tos/trace-event-profiling-tool)\n tab of Chrome.\n \n+The logging file is by default called `node_trace.${rotation}.log`, where\n+`${rotation}` is an incrementing log-rotation id. The filepath pattern can\n+be specified with `--trace-event-file-pattern` that accepts a template\n+string that supports `${rotation}` and `${pid}`. For example:\n+\n+```txt\n+node --trace-events-enabled --trace-event-file-pattern '${pid}-${rotation}.log' server.js\n+```\n+\n Starting with Node 10.0.0, the tracing system uses the same time source as the\n one used by `process.hrtime()` however the trace-event timestamps are expressed\n in microseconds, unlike `process.hrtime()` which returns nanoseconds."
        },
        {
            "sha": "d543d9fa0355f227ab15ec5c1c8599ea32af3b9f",
            "filename": "doc/node.1",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fnode.1",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/doc%2Fnode.1",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fnode.1?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -156,6 +156,10 @@ Enable the collection of trace event tracing information.\n A comma-separated list of categories that should be traced when trace event tracing is enabled using\n .Fl -trace-events-enabled .\n .\n+.It Fl -trace-event-file-pattern Ar pattern\n+Template string specifying the filepath for the trace event data, it\n+supports \\fB${rotation}\\fR and \\fB${pid}\\fR.\n+.\n .It Fl -zero-fill-buffers\n Automatically zero-fills all newly allocated Buffer and SlowBuffer instances.\n ."
        },
        {
            "sha": "64de859bc6a2786d9f9e72a0fc3d698489d25c3e",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -192,6 +192,8 @@ static node_module* modlist_linked;\n static node_module* modlist_addon;\n static bool trace_enabled = false;\n static std::string trace_enabled_categories;  // NOLINT(runtime/string)\n+static std::string trace_file_pattern =  // NOLINT(runtime/string)\n+  \"node_trace.${rotation}.log\";\n static bool abort_on_uncaught_exception = false;\n \n // Bit flag used to track security reverts (see node_revert.h)\n@@ -275,7 +277,7 @@ static struct {\n #if NODE_USE_V8_PLATFORM\n   void Initialize(int thread_pool_size) {\n     if (trace_enabled) {\n-      tracing_agent_.reset(new tracing::Agent());\n+      tracing_agent_.reset(new tracing::Agent(trace_file_pattern));\n       platform_ = new NodePlatform(thread_pool_size,\n         tracing_agent_->GetTracingController());\n       V8::InitializePlatform(platform_);\n@@ -3422,6 +3424,10 @@ static void PrintHelp() {\n          \"  --trace-events-enabled     track trace events\\n\"\n          \"  --trace-event-categories   comma separated list of trace event\\n\"\n          \"                             categories to record\\n\"\n+         \"  --trace-event-file-pattern Template string specifying the\\n\"\n+         \"                             filepath for the trace-events data, it\\n\"\n+         \"                             supports ${rotation} and ${pid}\\n\"\n+         \"                             log-rotation id. %%2$u is the pid.\\n\"\n          \"  --track-heap-objects       track heap object allocations for heap \"\n          \"snapshots\\n\"\n          \"  --prof-process             process v8 profiler output generated\\n\"\n@@ -3550,6 +3556,7 @@ static void CheckIfAllowedInEnv(const char* exe, bool is_env,\n     \"--no-force-async-hooks-checks\",\n     \"--trace-events-enabled\",\n     \"--trace-event-categories\",\n+    \"--trace-event-file-pattern\",\n     \"--track-heap-objects\",\n     \"--zero-fill-buffers\",\n     \"--v8-pool-size\",\n@@ -3701,6 +3708,14 @@ static void ParseArgs(int* argc,\n       }\n       args_consumed += 1;\n       trace_enabled_categories = categories;\n+    } else if (strcmp(arg, \"--trace-event-file-pattern\") == 0) {\n+      const char* file_pattern = argv[index + 1];\n+      if (file_pattern == nullptr) {\n+        fprintf(stderr, \"%s: %s requires an argument\\n\", argv[0], arg);\n+        exit(9);\n+      }\n+      args_consumed += 1;\n+      trace_file_pattern = file_pattern;\n     } else if (strcmp(arg, \"--track-heap-objects\") == 0) {\n       track_heap_objects = true;\n     } else if (strcmp(arg, \"--throw-deprecation\") == 0) {"
        },
        {
            "sha": "71e53e787a464e4ae26dabfad11e4320e051758f",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -13,11 +13,12 @@ namespace tracing {\n using v8::platform::tracing::TraceConfig;\n using std::string;\n \n-Agent::Agent() {\n+Agent::Agent(const std::string& log_file_pattern) {\n   int err = uv_loop_init(&tracing_loop_);\n   CHECK_EQ(err, 0);\n \n-  NodeTraceWriter* trace_writer = new NodeTraceWriter(&tracing_loop_);\n+  NodeTraceWriter* trace_writer = new NodeTraceWriter(\n+      log_file_pattern, &tracing_loop_);\n   TraceBuffer* trace_buffer = new NodeTraceBuffer(\n       NodeTraceBuffer::kBufferChunks, trace_writer, &tracing_loop_);\n   tracing_controller_ = new TracingController();"
        },
        {
            "sha": "9d6bc4e90a35af7af0a35d60710534189e120b2d",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -19,7 +19,7 @@ class TracingController : public v8::platform::tracing::TracingController {\n \n class Agent {\n  public:\n-  Agent();\n+  explicit Agent(const std::string& log_file_pattern);\n   void Start(const std::string& enabled_categories);\n   void Stop();\n "
        },
        {
            "sha": "15c59fc98a8747cb870e32b2298c4e79eb4b6149",
            "filename": "src/tracing/node_trace_writer.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fnode_trace_writer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fnode_trace_writer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.cc?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -8,8 +8,9 @@\n namespace node {\n namespace tracing {\n \n-NodeTraceWriter::NodeTraceWriter(uv_loop_t* tracing_loop)\n-    : tracing_loop_(tracing_loop) {\n+NodeTraceWriter::NodeTraceWriter(const std::string& log_file_pattern,\n+                                 uv_loop_t* tracing_loop)\n+    : tracing_loop_(tracing_loop), log_file_pattern_(log_file_pattern) {\n   flush_signal_.data = this;\n   int err = uv_async_init(tracing_loop_, &flush_signal_, FlushSignalCb);\n   CHECK_EQ(err, 0);\n@@ -54,12 +55,27 @@ NodeTraceWriter::~NodeTraceWriter() {\n   }\n }\n \n+void replace_substring(std::string* target,\n+                       const std::string& search,\n+                       const std::string& insert) {\n+  size_t pos = target->find(search);\n+  for (; pos != std::string::npos; pos = target->find(search, pos)) {\n+    target->replace(pos, search.size(), insert);\n+    pos += insert.size();\n+  }\n+}\n+\n void NodeTraceWriter::OpenNewFileForStreaming() {\n   ++file_num_;\n   uv_fs_t req;\n-  std::ostringstream log_file;\n-  log_file << \"node_trace.\" << file_num_ << \".log\";\n-  fd_ = uv_fs_open(tracing_loop_, &req, log_file.str().c_str(),\n+\n+  // Evaluate a JS-style template string, it accepts the values ${pid} and\n+  // ${rotation}\n+  std::string filepath(log_file_pattern_);\n+  replace_substring(&filepath, \"${pid}\", std::to_string(uv_os_getpid()));\n+  replace_substring(&filepath, \"${rotation}\", std::to_string(file_num_));\n+\n+  fd_ = uv_fs_open(tracing_loop_, &req, filepath.c_str(),\n       O_CREAT | O_WRONLY | O_TRUNC, 0644, nullptr);\n   CHECK_NE(fd_, -1);\n   uv_fs_req_cleanup(&req);"
        },
        {
            "sha": "9211790777bddb635142bb76f52226f34d94a034",
            "filename": "src/tracing/node_trace_writer.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fnode_trace_writer.h",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/src%2Ftracing%2Fnode_trace_writer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.h?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -16,7 +16,8 @@ using v8::platform::tracing::TraceWriter;\n \n class NodeTraceWriter : public TraceWriter {\n  public:\n-  explicit NodeTraceWriter(uv_loop_t* tracing_loop);\n+  explicit NodeTraceWriter(const std::string& log_file_pattern,\n+                           uv_loop_t* tracing_loop);\n   ~NodeTraceWriter();\n \n   void AppendTraceEvent(TraceObject* trace_event) override;\n@@ -62,6 +63,7 @@ class NodeTraceWriter : public TraceWriter {\n   int highest_request_id_completed_ = 0;\n   int total_traces_ = 0;\n   int file_num_ = 0;\n+  const std::string& log_file_pattern_;\n   std::ostringstream stream_;\n   TraceWriter* json_trace_writer_ = nullptr;\n   bool exited_ = false;"
        },
        {
            "sha": "8eae27b1a2a3a2e8725bff12da7cd50b8272495d",
            "filename": "test/parallel/test-cli-node-options.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/test%2Fparallel%2Ftest-cli-node-options.js",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/test%2Fparallel%2Ftest-cli-node-options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cli-node-options.js?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -25,6 +25,8 @@ expect('--throw-deprecation', 'B\\n');\n expect('--zero-fill-buffers', 'B\\n');\n expect('--v8-pool-size=10', 'B\\n');\n expect('--trace-event-categories node', 'B\\n');\n+// eslint-disable-next-line no-template-curly-in-string\n+expect('--trace-event-file-pattern {pid}-${rotation}.trace_events', 'B\\n');\n \n if (!common.isWindows) {\n   expect('--perf-basic-prof', 'B\\n');"
        },
        {
            "sha": "46059ad31d58b25a17065659788765e662d63255",
            "filename": "test/parallel/test-trace-events-file-pattern.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/test%2Fparallel%2Ftest-trace-events-file-pattern.js",
            "raw_url": "https://github.com/nodejs/node/raw/85212bb182f555f6d09e0b2f5f78d2d8e19bcef1/test%2Fparallel%2Ftest-trace-events-file-pattern.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-file-pattern.js?ref=85212bb182f555f6d09e0b2f5f78d2d8e19bcef1",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const fs = require('fs');\n+\n+tmpdir.refresh();\n+process.chdir(tmpdir.path);\n+\n+const CODE =\n+  'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1)';\n+\n+const proc = cp.spawn(process.execPath, [\n+  '--trace-events-enabled',\n+  '--trace-event-file-pattern',\n+  // eslint-disable-next-line no-template-curly-in-string\n+  '${pid}-${rotation}-${pid}-${rotation}.tracing.log',\n+  '-e', CODE\n+]);\n+\n+proc.once('exit', common.mustCall(() => {\n+  const expectedFilename = `${proc.pid}-1-${proc.pid}-1.tracing.log`;\n+\n+  assert(common.fileExists(expectedFilename));\n+  fs.readFile(expectedFilename, common.mustCall((err, data) => {\n+    const traces = JSON.parse(data.toString()).traceEvents;\n+    assert(traces.length > 0);\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 98,
        "deletions": 10
    }
}