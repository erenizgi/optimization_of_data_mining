{
    "author": "cjihrig",
    "message": "test: refactor test-fs-write-file-sync.js\n\nThis commit reduces shared state by introducing scopes and\nblock scoped variables. It also makes the monkey patching used\nby the test more robust.\n\nPR-URL: https://github.com/nodejs/node/pull/24834\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "df19b07d1fdda7dc7f531f6014cf7c3b0f2978fc",
    "files": [
        {
            "sha": "743a3858546931305d4c0b567788e3a01a351cda",
            "filename": "test/parallel/test-fs-write-file-sync.js",
            "status": "modified",
            "additions": 58,
            "deletions": 62,
            "changes": 120,
            "blob_url": "https://github.com/nodejs/node/blob/df19b07d1fdda7dc7f531f6014cf7c3b0f2978fc/test%2Fparallel%2Ftest-fs-write-file-sync.js",
            "raw_url": "https://github.com/nodejs/node/raw/df19b07d1fdda7dc7f531f6014cf7c3b0f2978fc/test%2Fparallel%2Ftest-fs-write-file-sync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-write-file-sync.js?ref=df19b07d1fdda7dc7f531f6014cf7c3b0f2978fc",
            "patch": "@@ -21,87 +21,83 @@\n \n 'use strict';\n const common = require('../common');\n-const assert = require('assert');\n-const path = require('path');\n-const fs = require('fs');\n-let openCount = 0;\n-let mode;\n-let content;\n \n if (!common.isMainThread)\n   common.skip('process.umask is not available in Workers');\n \n-// Need to hijack fs.open/close to make sure that things\n-// get closed once they're opened.\n-fs._openSync = fs.openSync;\n-fs.openSync = openSync;\n-fs._closeSync = fs.closeSync;\n-fs.closeSync = closeSync;\n-\n-// Reset the umask for testing\n-process.umask(0o000);\n+const assert = require('assert');\n+const path = require('path');\n+const fs = require('fs');\n \n // On Windows chmod is only able to manipulate read-only bit. Test if creating\n // the file in read-only mode works.\n-if (common.isWindows) {\n-  mode = 0o444;\n-} else {\n-  mode = 0o755;\n-}\n+const mode = common.isWindows ? 0o444 : 0o755;\n+\n+// Reset the umask for testing\n+process.umask(0o000);\n \n const tmpdir = require('../common/tmpdir');\n tmpdir.refresh();\n \n // Test writeFileSync\n-const file1 = path.join(tmpdir.path, 'testWriteFileSync.txt');\n-\n-fs.writeFileSync(file1, '123', { mode });\n+{\n+  const file = path.join(tmpdir.path, 'testWriteFileSync.txt');\n \n-content = fs.readFileSync(file1, { encoding: 'utf8' });\n-assert.strictEqual(content, '123');\n-\n-assert.strictEqual(fs.statSync(file1).mode & 0o777, mode);\n+  fs.writeFileSync(file, '123', { mode });\n+  const content = fs.readFileSync(file, { encoding: 'utf8' });\n+  assert.strictEqual(content, '123');\n+  assert.strictEqual(fs.statSync(file).mode & 0o777, mode);\n+}\n \n // Test appendFileSync\n-const file2 = path.join(tmpdir.path, 'testAppendFileSync.txt');\n-\n-fs.appendFileSync(file2, 'abc', { mode });\n-\n-content = fs.readFileSync(file2, { encoding: 'utf8' });\n-assert.strictEqual(content, 'abc');\n-\n-assert.strictEqual(fs.statSync(file2).mode & mode, mode);\n-\n-// Test writeFileSync with file descriptor\n-const file3 = path.join(tmpdir.path, 'testWriteFileSyncFd.txt');\n+{\n+  const file = path.join(tmpdir.path, 'testAppendFileSync.txt');\n \n-const fd = fs.openSync(file3, 'w+', mode);\n-fs.writeFileSync(fd, '123');\n-fs.closeSync(fd);\n-\n-content = fs.readFileSync(file3, { encoding: 'utf8' });\n-assert.strictEqual(content, '123');\n-\n-assert.strictEqual(fs.statSync(file3).mode & 0o777, mode);\n-\n-// Verify that all opened files were closed.\n-assert.strictEqual(openCount, 0);\n-\n-function openSync() {\n-  openCount++;\n-  return fs._openSync.apply(fs, arguments);\n+  fs.appendFileSync(file, 'abc', { mode });\n+  const content = fs.readFileSync(file, { encoding: 'utf8' });\n+  assert.strictEqual(content, 'abc');\n+  assert.strictEqual(fs.statSync(file).mode & mode, mode);\n }\n \n-function closeSync() {\n-  openCount--;\n-  return fs._closeSync.apply(fs, arguments);\n+// Test writeFileSync with file descriptor\n+{\n+  // Need to hijack fs.open/close to make sure that things\n+  // get closed once they're opened.\n+  const _openSync = fs.openSync;\n+  const _closeSync = fs.closeSync;\n+  let openCount = 0;\n+\n+  fs.openSync = (...args) => {\n+    openCount++;\n+    return _openSync(...args);\n+  };\n+\n+  fs.closeSync = (...args) => {\n+    openCount--;\n+    return _closeSync(...args);\n+  };\n+\n+  const file = path.join(tmpdir.path, 'testWriteFileSyncFd.txt');\n+  const fd = fs.openSync(file, 'w+', mode);\n+\n+  fs.writeFileSync(fd, '123');\n+  fs.closeSync(fd);\n+  const content = fs.readFileSync(file, { encoding: 'utf8' });\n+  assert.strictEqual(content, '123');\n+  assert.strictEqual(fs.statSync(file).mode & 0o777, mode);\n+\n+  // Verify that all opened files were closed.\n+  assert.strictEqual(openCount, 0);\n+  fs.openSync = _openSync;\n+  fs.closeSync = _closeSync;\n }\n \n // Test writeFileSync with flags\n-const file4 = path.join(tmpdir.path, 'testWriteFileSyncFlags.txt');\n-\n-fs.writeFileSync(file4, 'hello ', { encoding: 'utf8', flag: 'a' });\n-fs.writeFileSync(file4, 'world!', { encoding: 'utf8', flag: 'a' });\n+{\n+  const file = path.join(tmpdir.path, 'testWriteFileSyncFlags.txt');\n \n-content = fs.readFileSync(file4, { encoding: 'utf8' });\n-assert.strictEqual(content, 'hello world!');\n+  fs.writeFileSync(file, 'hello ', { encoding: 'utf8', flag: 'a' });\n+  fs.writeFileSync(file, 'world!', { encoding: 'utf8', flag: 'a' });\n+  const content = fs.readFileSync(file, { encoding: 'utf8' });\n+  assert.strictEqual(content, 'hello world!');\n+}"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 58,
        "deletions": 62
    }
}