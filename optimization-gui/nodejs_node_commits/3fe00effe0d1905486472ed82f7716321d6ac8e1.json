{
    "author": "Trott",
    "message": "test: make http2 timeout test robust\n\nInstead of using magic values for the server timeout in\ntest-http2-session-timeout, measure the duration of the first request\n(which should be longer than subsequent requests) and use that value.\n\nFixes: https://github.com/nodejs/node/issues/20628\n\nPR-URL: https://github.com/nodejs/node/pull/24877\nFixes: https://github.com/https://github.com/nodejs/node/issues/20628\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "3fe00effe0d1905486472ed82f7716321d6ac8e1",
    "files": [
        {
            "sha": "d9963bc6f77328f1bcc5721bd3a941991397caf8",
            "filename": "test/sequential/sequential.status",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3fe00effe0d1905486472ed82f7716321d6ac8e1/test%2Fsequential%2Fsequential.status",
            "raw_url": "https://github.com/nodejs/node/raw/3fe00effe0d1905486472ed82f7716321d6ac8e1/test%2Fsequential%2Fsequential.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Fsequential.status?ref=3fe00effe0d1905486472ed82f7716321d6ac8e1",
            "patch": "@@ -23,5 +23,3 @@ test-http2-large-file: PASS, FLAKY\n [$system==aix]\n \n [$arch==arm]\n-# https://github.com/nodejs/node/issues/20628\n-test-http2-session-timeout: PASS,FLAKY"
        },
        {
            "sha": "0fa6a2c13c6b6cd9122fa5520fa0cdfee14624c1",
            "filename": "test/sequential/test-http2-session-timeout.js",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/3fe00effe0d1905486472ed82f7716321d6ac8e1/test%2Fsequential%2Ftest-http2-session-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/3fe00effe0d1905486472ed82f7716321d6ac8e1/test%2Fsequential%2Ftest-http2-session-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-session-timeout.js?ref=3fe00effe0d1905486472ed82f7716321d6ac8e1",
            "patch": "@@ -6,15 +6,15 @@ if (!common.hasCrypto)\n const assert = require('assert');\n const http2 = require('http2');\n \n-const serverTimeout = common.platformTimeout(200);\n-\n let requests = 0;\n const mustNotCall = () => {\n   assert.fail(`Timeout after ${requests} request(s)`);\n };\n \n const server = http2.createServer();\n-server.timeout = serverTimeout;\n+// Disable server timeout until first request. We will set the timeout based on\n+// how long the first request takes.\n+server.timeout = 0;\n \n server.on('request', (req, res) => res.end());\n server.on('timeout', mustNotCall);\n@@ -24,7 +24,7 @@ server.listen(0, common.mustCall(() => {\n \n   const url = `http://localhost:${port}`;\n   const client = http2.connect(url);\n-  const startTime = process.hrtime();\n+  let startTime = process.hrtime();\n   makeReq();\n \n   function makeReq() {\n@@ -42,7 +42,15 @@ server.listen(0, common.mustCall(() => {\n     request.on('end', () => {\n       const diff = process.hrtime(startTime);\n       const milliseconds = (diff[0] * 1e3 + diff[1] / 1e6);\n-      if (milliseconds < serverTimeout * 2) {\n+      if (server.timeout === 0) {\n+        // Set the timeout now. First connection will take significantly longer\n+        // than subsequent connections, so using the duration of the first\n+        // connection as the timeout should be robust. Double it anyway for good\n+        // measure.\n+        server.timeout = milliseconds * 2;\n+        startTime = process.hrtime();\n+        makeReq();\n+      } else if (milliseconds < server.timeout * 2) {\n         makeReq();\n       } else {\n         server.removeListener('timeout', mustNotCall);"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 13,
        "deletions": 7
    }
}