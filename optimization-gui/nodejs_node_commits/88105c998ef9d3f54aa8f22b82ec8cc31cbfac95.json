{
    "author": "rvagg",
    "message": "buffer: avoid overrun on UCS-2 string write\n\nCVE-2018-12115\nDiscovered by ChALkeR - Сковорода Никита Андреевич\nFix by Anna Henningsen\n\nWriting to the second-to-last byte with UCS-2 encoding will cause a -1\nlength to be send to String::Write(), writing all of the provided Buffer\nfrom that point and beyond.\n\nFixes: https://github.com/nodejs-private/security/issues/203\nPR-URL: https://github.com/nodejs-private/node-private/pull/138",
    "sha": "88105c998ef9d3f54aa8f22b82ec8cc31cbfac95",
    "files": [
        {
            "sha": "da54ca6023721fde818359807c10d5dccc2fc209",
            "filename": "src/string_bytes.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/88105c998ef9d3f54aa8f22b82ec8cc31cbfac95/src%2Fstring_bytes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/88105c998ef9d3f54aa8f22b82ec8cc31cbfac95/src%2Fstring_bytes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_bytes.cc?ref=88105c998ef9d3f54aa8f22b82ec8cc31cbfac95",
            "patch": "@@ -265,7 +265,11 @@ size_t StringBytes::WriteUCS2(char* buf,\n                               size_t* chars_written) {\n   uint16_t* const dst = reinterpret_cast<uint16_t*>(buf);\n \n-  size_t max_chars = (buflen / sizeof(*dst));\n+  size_t max_chars = buflen / sizeof(*dst);\n+  if (max_chars == 0) {\n+    return 0;\n+  }\n+\n   size_t nchars;\n   size_t alignment = reinterpret_cast<uintptr_t>(dst) % sizeof(*dst);\n   if (alignment == 0) {"
        },
        {
            "sha": "c0c5e9c88fbc6c5e866c855c336d7a76c417cf80",
            "filename": "test/parallel/test-buffer-write.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/88105c998ef9d3f54aa8f22b82ec8cc31cbfac95/test%2Fparallel%2Ftest-buffer-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/88105c998ef9d3f54aa8f22b82ec8cc31cbfac95/test%2Fparallel%2Ftest-buffer-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-write.js?ref=88105c998ef9d3f54aa8f22b82ec8cc31cbfac95",
            "patch": "@@ -70,3 +70,24 @@ for (let i = 1; i < 10; i++) {\n   assert.ok(!Buffer.isEncoding(encoding));\n   assert.throws(() => Buffer.alloc(9).write('foo', encoding), error);\n }\n+\n+// UCS-2 overflow CVE-2018-12115\n+for (let i = 1; i < 4; i++) {\n+  // Allocate two Buffers sequentially off the pool. Run more than once in case\n+  // we hit the end of the pool and don't get sequential allocations\n+  const x = Buffer.allocUnsafe(4).fill(0);\n+  const y = Buffer.allocUnsafe(4).fill(1);\n+  // Should not write anything, pos 3 doesn't have enough room for a 16-bit char\n+  assert.strictEqual(x.write('ыыыыыы', 3, 'ucs2'), 0);\n+  // CVE-2018-12115 experienced via buffer overrun to next block in the pool\n+  assert.strictEqual(Buffer.compare(y, Buffer.alloc(4, 1)), 0);\n+}\n+\n+// Should not write any data when there is no space for 16-bit chars\n+const z = Buffer.alloc(4, 0);\n+assert.strictEqual(z.write('\\u0001', 3, 'ucs2'), 0);\n+assert.strictEqual(Buffer.compare(z, Buffer.alloc(4, 0)), 0);\n+\n+// Large overrun could corrupt the process\n+assert.strictEqual(Buffer.alloc(4)\n+  .write('ыыыыыы'.repeat(100), 3, 'utf16le'), 0);"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}