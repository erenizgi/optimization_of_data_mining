{
    "author": "kjin",
    "message": "trace_events: fix trace events JS API writing\n\nThe Trace Events JS API isn't functional if none of\n--trace-events-enabled or --trace-event-categories is passed as a CLI\nargument. This commit fixes that.\n\nIn addition, we currently don't test the trace_events JS API in the\ncasewhere no CLI args are provided. This commit adds that test.\n\nFixes https://github.com/nodejs/node/issues/24944\n\nPR-URL: https://github.com/nodejs/node/pull/24945\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "582c0d5a092b04616fef4b11b0fd893c181356f1",
    "files": [
        {
            "sha": "6a0d4f037a76c42ef90ea6b5a2b30b41bcdf1781",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=582c0d5a092b04616fef4b11b0fd893c181356f1",
            "patch": "@@ -74,6 +74,9 @@ void NodeCategorySet::Enable(const FunctionCallbackInfo<Value>& args) {\n   CHECK_NOT_NULL(category_set);\n   const auto& categories = category_set->GetCategories();\n   if (!category_set->enabled_ && !categories.empty()) {\n+    // Starts the Tracing Agent if it wasn't started already (e.g. through\n+    // a command line flag.)\n+    StartTracingAgent();\n     GetTracingAgentWriter()->Enable(categories);\n     category_set->enabled_ = true;\n   }"
        },
        {
            "sha": "2c89ee9e5244b5c40125d42d0c7b10227a5cf089",
            "filename": "src/node_v8_platform-inl.h",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Fnode_v8_platform-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Fnode_v8_platform-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_v8_platform-inl.h?ref=582c0d5a092b04616fef4b11b0fd893c181356f1",
            "patch": "@@ -85,7 +85,11 @@ struct V8Platform {\n         tracing_agent_->GetTracingController();\n     trace_state_observer_.reset(new NodeTraceStateObserver(controller));\n     controller->AddTraceStateObserver(trace_state_observer_.get());\n-    StartTracingAgent();\n+    tracing_file_writer_ = tracing_agent_->DefaultHandle();\n+    // Only start the tracing agent if we enabled any tracing categories.\n+    if (!per_process::cli_options->trace_event_categories.empty()) {\n+      StartTracingAgent();\n+    }\n     // Tracing must be initialized before platform threads are created.\n     platform_ = new NodePlatform(thread_pool_size, controller);\n     v8::V8::InitializePlatform(platform_);\n@@ -111,9 +115,9 @@ struct V8Platform {\n   }\n \n   inline void StartTracingAgent() {\n-    if (per_process::cli_options->trace_event_categories.empty()) {\n-      tracing_file_writer_ = tracing_agent_->DefaultHandle();\n-    } else {\n+    // Attach a new NodeTraceWriter only if this function hasn't been called\n+    // before.\n+    if (tracing_file_writer_.IsDefaultHandle()) {\n       std::vector<std::string> categories =\n           SplitString(per_process::cli_options->trace_event_categories, ',');\n \n@@ -163,6 +167,10 @@ namespace per_process {\n extern struct V8Platform v8_platform;\n }\n \n+inline void StartTracingAgent() {\n+  return per_process::v8_platform.StartTracingAgent();\n+}\n+\n inline tracing::AgentWriterHandle* GetTracingAgentWriter() {\n   return per_process::v8_platform.GetTracingAgentWriter();\n }"
        },
        {
            "sha": "0039cc36793054ff9155844e461a94dc6b77a416",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/582c0d5a092b04616fef4b11b0fd893c181356f1/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=582c0d5a092b04616fef4b11b0fd893c181356f1",
            "patch": "@@ -59,6 +59,8 @@ class AgentWriterHandle {\n   inline void Enable(const std::set<std::string>& categories);\n   inline void Disable(const std::set<std::string>& categories);\n \n+  inline bool IsDefaultHandle();\n+\n   inline Agent* agent() { return agent_; }\n \n   inline v8::TracingController* GetTracingController();\n@@ -175,6 +177,10 @@ void AgentWriterHandle::Disable(const std::set<std::string>& categories) {\n   if (agent_ != nullptr) agent_->Disable(id_, categories);\n }\n \n+bool AgentWriterHandle::IsDefaultHandle() {\n+  return agent_ != nullptr && id_ == Agent::kDefaultHandleId;\n+}\n+\n inline v8::TracingController* AgentWriterHandle::GetTracingController() {\n   return agent_ != nullptr ? agent_->GetTracingController() : nullptr;\n }"
        },
        {
            "sha": "cf11daa6edf8699f69681df1c33b692327d77a92",
            "filename": "test/parallel/test-trace-events-api.js",
            "status": "modified",
            "additions": 25,
            "deletions": 5,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/582c0d5a092b04616fef4b11b0fd893c181356f1/test%2Fparallel%2Ftest-trace-events-api.js",
            "raw_url": "https://github.com/nodejs/node/raw/582c0d5a092b04616fef4b11b0fd893c181356f1/test%2Fparallel%2Ftest-trace-events-api.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-api.js?ref=582c0d5a092b04616fef4b11b0fd893c181356f1",
            "patch": "@@ -17,8 +17,17 @@ const {\n   getEnabledCategories\n } = require('trace_events');\n \n+function getEnabledCategoriesFromCommandLine() {\n+  const indexOfCatFlag = process.execArgv.indexOf('--trace-event-categories');\n+  if (indexOfCatFlag === -1) {\n+    return undefined;\n+  } else {\n+    return process.execArgv[indexOfCatFlag + 1];\n+  }\n+}\n+\n const isChild = process.argv[2] === 'child';\n-const enabledCategories = isChild ? 'foo' : undefined;\n+const enabledCategories = getEnabledCategoriesFromCommandLine();\n \n assert.strictEqual(getEnabledCategories(), enabledCategories);\n [1, 'foo', true, false, null, undefined].forEach((i) => {\n@@ -51,7 +60,9 @@ tracing.enable();  // purposefully enable twice to test calling twice\n assert.strictEqual(tracing.enabled, true);\n \n assert.strictEqual(getEnabledCategories(),\n-                   isChild ? 'foo,node.perf' : 'node.perf');\n+                   [\n+                     ...[enabledCategories].filter((_) => !!_), 'node.perf'\n+                   ].join(','));\n \n tracing.disable();\n assert.strictEqual(tracing.enabled, false);\n@@ -106,7 +117,15 @@ if (isChild) {\n     }\n   }\n \n+  testApiInChildProcess([], () => {\n+    testApiInChildProcess(['--trace-event-categories', 'foo']);\n+  });\n+}\n+\n+function testApiInChildProcess(execArgs, cb) {\n   tmpdir.refresh();\n+  // Save the current directory so we can chdir back to it later\n+  const parentDir = process.cwd();\n   process.chdir(tmpdir.path);\n \n   const expectedMarks = ['A', 'B'];\n@@ -121,15 +140,14 @@ if (isChild) {\n \n   const proc = cp.fork(__filename,\n                        ['child'],\n-                       { execArgv: [ '--expose-gc',\n-                                     '--trace-event-categories',\n-                                     'foo' ] });\n+                       { execArgv: [ '--expose-gc', ...execArgs ] });\n \n   proc.once('exit', common.mustCall(() => {\n     const file = path.join(tmpdir.path, 'node_trace.1.log');\n \n     assert(fs.existsSync(file));\n     fs.readFile(file, common.mustCall((err, data) => {\n+      assert.ifError(err);\n       const traces = JSON.parse(data.toString()).traceEvents\n         .filter((trace) => trace.cat !== '__metadata');\n       assert.strictEqual(traces.length,\n@@ -160,6 +178,8 @@ if (isChild) {\n             assert.fail('Unexpected trace event phase');\n         }\n       });\n+      process.chdir(parentDir);\n+      cb && process.nextTick(cb);\n     }));\n   }));\n }"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 46,
        "deletions": 9
    }
}