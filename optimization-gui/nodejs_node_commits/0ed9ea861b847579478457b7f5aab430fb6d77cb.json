{
    "author": "addaleax",
    "message": "test: make sure WriteWrap tests are actually async\n\nPR-URL: https://github.com/nodejs/node/pull/18676\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0ed9ea861b847579478457b7f5aab430fb6d77cb",
    "files": [
        {
            "sha": "4f3455480ba84924cccb670c7a0fbb182d302be2",
            "filename": "test/async-hooks/test-writewrap.js",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/0ed9ea861b847579478457b7f5aab430fb6d77cb/test%2Fasync-hooks%2Ftest-writewrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ed9ea861b847579478457b7f5aab430fb6d77cb/test%2Fasync-hooks%2Ftest-writewrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-writewrap.js?ref=0ed9ea861b847579478457b7f5aab430fb6d77cb",
            "patch": "@@ -47,6 +47,7 @@ function checkDestroyedWriteWraps(n, stage) {\n }\n \n function onconnection(conn) {\n+  conn.write('hi');  // Let the client know we're ready.\n   conn.resume();\n   //\n   // Server received client connection\n@@ -60,15 +61,35 @@ function onconnect() {\n   //\n   checkDestroyedWriteWraps(0, 'client connected');\n \n+  this.once('data', common.mustCall(ondata));\n+}\n+\n+function ondata() {\n   //\n-  // Destroying client socket\n+  // Writing data to client socket\n   //\n-  this.write('f'.repeat(128000), () => onafterwrite(this));\n+  const write = () => {\n+    let writeFinished = false;\n+    this.write('f'.repeat(1280000), () => {\n+      writeFinished = true;\n+    });\n+    process.nextTick(() => {\n+      if (writeFinished) {\n+        // Synchronous finish, write more data immediately.\n+        writeFinished = false;\n+        write();\n+      } else {\n+        // Asynchronous write; this is what we are here for.\n+        onafterwrite(this);\n+      }\n+    });\n+  };\n+  write();\n }\n \n function onafterwrite(self) {\n   checkDestroyedWriteWraps(1, 'client destroyed');\n-  self.destroy();\n+  self.end();\n \n   checkDestroyedWriteWraps(1, 'client destroyed');\n "
        },
        {
            "sha": "2db6ba9db661cf3e1e7116c655f64f207d5b8261",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 15,
            "deletions": 11,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/0ed9ea861b847579478457b7f5aab430fb6d77cb/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ed9ea861b847579478457b7f5aab430fb6d77cb/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=0ed9ea861b847579478457b7f5aab430fb6d77cb",
            "patch": "@@ -197,7 +197,6 @@ if (common.hasCrypto) { // eslint-disable-line crypto-check\n     const handle = new tcp_wrap.TCP(tcp_wrap.constants.SOCKET);\n     const req = new tcp_wrap.TCPConnectWrap();\n     const sreq = new stream_wrap.ShutdownWrap();\n-    const wreq = new stream_wrap.WriteWrap();\n     testInitialized(handle, 'TCP');\n     testUninitialized(req, 'TCPConnectWrap');\n     testUninitialized(sreq, 'ShutdownWrap');\n@@ -206,20 +205,25 @@ if (common.hasCrypto) { // eslint-disable-line crypto-check\n       handle.close();\n     });\n \n-    wreq.handle = handle;\n-    wreq.oncomplete = common.mustCall(() => {\n-      handle.shutdown(sreq);\n-      testInitialized(sreq, 'ShutdownWrap');\n-    });\n-    wreq.async = true;\n-\n-    req.oncomplete = common.mustCall(() => {\n-      // Use a long string to make sure the write happens asynchronously.\n+    req.oncomplete = common.mustCall(writeData);\n+    function writeData() {\n+      const wreq = new stream_wrap.WriteWrap();\n+      wreq.handle = handle;\n+      wreq.oncomplete = () => {\n+        handle.shutdown(sreq);\n+        testInitialized(sreq, 'ShutdownWrap');\n+      };\n       const err = handle.writeLatin1String(wreq, 'hi'.repeat(100000));\n       if (err)\n         throw new Error(`write failed: ${getSystemErrorName(err)}`);\n+      if (!wreq.async) {\n+        testUninitialized(wreq, 'WriteWrap');\n+        // Synchronous finish. Write more data until we hit an\n+        // asynchronous write.\n+        return writeData();\n+      }\n       testInitialized(wreq, 'WriteWrap');\n-    });\n+    }\n     req.address = common.localhostIPv4;\n     req.port = server.address().port;\n     const err = handle.connect(req, req.address, req.port);"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 39,
        "deletions": 14
    }
}