{
    "author": "addaleax",
    "message": "doc: improve worker_threads documentation\n\nThis adds a few examples and clarifications.\n\nPR-URL: https://github.com/nodejs/node/pull/26110\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Anto Aravinth <anto.aravinth.cse@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>",
    "sha": "70a500f3fd8b081b9e0bcf487c2ea1aba33b6771",
    "files": [
        {
            "sha": "95cdae5f9a81af83d65af803b9a1ee51da17791e",
            "filename": "doc/api/worker_threads.md",
            "status": "modified",
            "additions": 112,
            "deletions": 5,
            "changes": 117,
            "blob_url": "https://github.com/nodejs/node/blob/70a500f3fd8b081b9e0bcf487c2ea1aba33b6771/doc%2Fapi%2Fworker_threads.md",
            "raw_url": "https://github.com/nodejs/node/raw/70a500f3fd8b081b9e0bcf487c2ea1aba33b6771/doc%2Fapi%2Fworker_threads.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker_threads.md?ref=70a500f3fd8b081b9e0bcf487c2ea1aba33b6771",
            "patch": "@@ -4,8 +4,8 @@\n \n > Stability: 1 - Experimental\n \n-The `worker_threads` module enables the use of threads with message channels\n-between them. To access it:\n+The `worker_threads` module enables the use of threads that execute JS code\n+in parallel. To access it:\n \n ```js\n const worker = require('worker_threads');\n@@ -58,6 +58,18 @@ added: v10.5.0\n \n Is `true` if this code is not running inside of a [`Worker`][] thread.\n \n+```js\n+const { Worker, isMainThread } = require('worker_threads');\n+\n+if (isMainThread) {\n+  // This re-loads the current file inside a Worker instance.\n+  new Worker(__filename);\n+} else {\n+  console.log('Inside Worker!');\n+  console.log(isMainThread);  // Prints 'false'.\n+}\n+```\n+\n ## worker.parentPort\n <!-- YAML\n added: v10.5.0\n@@ -72,6 +84,23 @@ using `worker.on('message')`, and messages sent from the parent thread\n using `worker.postMessage()` will be available in this thread using\n `parentPort.on('message')`.\n \n+```js\n+const { Worker, isMainThread, parentPort } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const worker = new Worker(__filename);\n+  worker.once('message', (message) => {\n+    console.log(message);  // Prints 'Hello, world!'.\n+  });\n+  worker.postMessage('Hello, world!');\n+} else {\n+  // When a message from the parent thread is received, send it back:\n+  parentPort.once('message', (message) => {\n+    parentPort.postMessage(message);\n+  });\n+}\n+```\n+\n ## worker.threadId\n <!-- YAML\n added: v10.5.0\n@@ -91,6 +120,19 @@ added: v10.5.0\n An arbitrary JavaScript value that contains a clone of the data passed\n to this threadâ€™s `Worker` constructor.\n \n+The data is cloned as if using [`postMessage()`][`port.postMessage()`],\n+according to the [HTML structured clone algorithm][].\n+\n+```js\n+const { Worker, isMainThread, workerData } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const worker = new Worker(__filename, { workerData: 'Hello, world!' });\n+} else {\n+  console.log(workerData);  // Prints 'Hello, world!'.\n+}\n+```\n+\n ## Class: MessageChannel\n <!-- YAML\n added: v10.5.0\n@@ -134,6 +176,20 @@ added: v10.5.0\n The `'close'` event is emitted once either side of the channel has been\n disconnected.\n \n+```js\n+const { MessageChannel } = require('worker_threads');\n+const { port1, port2 } = new MessageChannel();\n+\n+// Prints:\n+//   foobar\n+//   closed!\n+port2.on('message', (message) => console.log(message));\n+port2.on('close', () => console.log('closed!'));\n+\n+port1.postMessage('foobar');\n+port1.close();\n+```\n+\n ### Event: 'message'\n <!-- YAML\n added: v10.5.0\n@@ -156,6 +212,9 @@ Disables further sending of messages on either side of the connection.\n This method can be called when no further communication will happen over this\n `MessagePort`.\n \n+The [`'close'` event][] will be emitted on both `MessagePort` instances that\n+are part of the channel.\n+\n ### port.postMessage(value[, transferList])\n <!-- YAML\n added: v10.5.0\n@@ -166,9 +225,28 @@ added: v10.5.0\n \n Sends a JavaScript value to the receiving side of this channel.\n `value` will be transferred in a way which is compatible with\n-the [HTML structured clone algorithm][]. In particular, it may contain circular\n-references and objects like typed arrays that the `JSON` API is not able\n-to stringify.\n+the [HTML structured clone algorithm][].\n+\n+In particular, the significant differences to `JSON` are:\n+- `value` may contain circular references.\n+- `value` may contain instances of builtin JS types such as `RegExp`s,\n+  `BigInt`s, `Map`s, `Set`s, etc.\n+- `value` may contained typed arrays, both using `ArrayBuffer`s\n+   and `SharedArrayBuffer`s.\n+- `value` may contain [`WebAssembly.Module`][] instances.\n+- `value` may not contain native (C++-backed) objects other than `MessagePort`s.\n+\n+```js\n+const { MessageChannel } = require('worker_threads');\n+const { port1, port2 } = new MessageChannel();\n+\n+port1.on('message', (message) => console.log(message));\n+\n+const circularData = {};\n+circularData.foo = circularData;\n+// Prints: { foo: [Circular] }\n+port2.postMessage(circularData);\n+```\n \n `transferList` may be a list of `ArrayBuffer` and `MessagePort` objects.\n After transferring, they will not be usable on the sending side of the channel\n@@ -182,6 +260,30 @@ from either thread. They cannot be listed in `transferList`.\n `value` may still contain `ArrayBuffer` instances that are not in\n `transferList`; in that case, the underlying memory is copied rather than moved.\n \n+```js\n+const { MessageChannel } = require('worker_threads');\n+const { port1, port2 } = new MessageChannel();\n+\n+port1.on('message', (message) => console.log(message));\n+\n+const uint8Array = new Uint8Array([ 1, 2, 3, 4 ]);\n+// This posts a copy of `uint8Array`:\n+port2.postMessage(uint8Array);\n+// This does not copy data, but renders `uint8Array` unusable:\n+port2.postMessage(uint8Array, [ uint8Array.buffer ]);\n+\n+// The memory for the `sharedUint8Array` will be accessible from both the\n+// original and the copy received by `.on('message')`:\n+const sharedUint8Array = new Uint8Array(new SharedArrayBuffer(4));\n+port2.postMessage(sharedUint8Array);\n+\n+// This transfers a freshly created message port to the receiver.\n+// This can be used, for example, to create communication channels between\n+// multiple `Worker` threads that are children of the same parent thread.\n+const otherChannel = new MessageChannel();\n+port2.postMessage({ port: otherChannel.port1 }, [ otherChannel.port1 ]);\n+```\n+\n Because the object cloning uses the structured clone algorithm,\n non-enumerable properties, property accessors, and object prototypes are\n not preserved. In particular, [`Buffer`][] objects will be read as\n@@ -215,6 +317,9 @@ Starts receiving messages on this `MessagePort`. When using this port\n as an event emitter, this will be called automatically once `'message'`\n listeners are attached.\n \n+This method exists for parity with the Web `MessagePort` API. In Node.js,\n+it is only useful for ignoring messages when no event listener is present.\n+\n ### port.unref()\n <!-- YAML\n added: v10.5.0\n@@ -465,12 +570,14 @@ Calling `unref()` on a worker will allow the thread to exit if this is the only\n active handle in the event system. If the worker is already `unref()`ed calling\n `unref()` again will have no effect.\n \n+[`'close'` event]: #worker_threads_event_close\n [`Buffer`]: buffer.html\n [`EventEmitter`]: events.html\n [`EventTarget`]: https://developer.mozilla.org/en-US/docs/Web/API/EventTarget\n [`MessagePort`]: #worker_threads_class_messageport\n [`SharedArrayBuffer`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\n [`Uint8Array`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\n+[`WebAssembly.Module`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Module\n [`Worker`]: #worker_threads_class_worker\n [`cluster` module]: cluster.html\n [`inspector`]: inspector.html"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 112,
        "deletions": 5
    }
}