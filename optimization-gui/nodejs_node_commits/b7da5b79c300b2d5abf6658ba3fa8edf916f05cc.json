{
    "author": "addaleax",
    "message": "benchmark,test: add brotli\n\nCo-authored-by: Hackzzila <admin@hackzzila.com>\n\nPR-URL: https://github.com/nodejs/node/pull/24938\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Jan Krems <jan.krems@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Myles Borins <myles.borins@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
    "files": [
        {
            "sha": "f23759fa0ebf38db752d3542487f671dc24ac1d1",
            "filename": "benchmark/zlib/creation.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/benchmark%2Fzlib%2Fcreation.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/benchmark%2Fzlib%2Fcreation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fzlib%2Fcreation.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -4,7 +4,8 @@ const zlib = require('zlib');\n \n const bench = common.createBenchmark(main, {\n   type: [\n-    'Deflate', 'DeflateRaw', 'Inflate', 'InflateRaw', 'Gzip', 'Gunzip', 'Unzip'\n+    'Deflate', 'DeflateRaw', 'Inflate', 'InflateRaw', 'Gzip', 'Gunzip', 'Unzip',\n+    'BrotliCompress', 'BrotliDecompress'\n   ],\n   options: ['true', 'false'],\n   n: [5e5]"
        },
        {
            "sha": "6a1c427bc8380baf6e2f7c80fd70b0ad2720dab3",
            "filename": "benchmark/zlib/pipe.js",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/benchmark%2Fzlib%2Fpipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/benchmark%2Fzlib%2Fpipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fzlib%2Fpipe.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -6,15 +6,18 @@ const zlib = require('zlib');\n const bench = common.createBenchmark(main, {\n   inputLen: [1024],\n   duration: [5],\n-  type: ['string', 'buffer']\n+  type: ['string', 'buffer'],\n+  algorithm: ['gzip', 'brotli']\n });\n \n-function main({ inputLen, duration, type }) {\n+function main({ inputLen, duration, type, algorithm }) {\n   const buffer = Buffer.alloc(inputLen, fs.readFileSync(__filename));\n   const chunk = type === 'buffer' ? buffer : buffer.toString('utf8');\n \n-  const input = zlib.createGzip();\n-  const output = zlib.createGunzip();\n+  const input = algorithm === 'gzip' ?\n+    zlib.createGzip() : zlib.createBrotliCompress();\n+  const output = algorithm === 'gzip' ?\n+    zlib.createGunzip() : zlib.createBrotliDecompress();\n \n   let readFromOutput = 0;\n   input.pipe(output);"
        },
        {
            "sha": "7d35b1238fb7ec7324c3837dd41e7958d746480e",
            "filename": "test/fixtures/person.jpg.br",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Ffixtures%2Fperson.jpg.br",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Ffixtures%2Fperson.jpg.br",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fperson.jpg.br?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc"
        },
        {
            "sha": "6883fb903a6478e494cbfab08069c0816bc17b3a",
            "filename": "test/parallel/test-zlib-brotli-flush.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-flush.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-flush.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-brotli-flush.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -0,0 +1,27 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+const fixtures = require('../common/fixtures');\n+\n+const file = fixtures.readSync('person.jpg');\n+const chunkSize = 16;\n+const deflater = new zlib.BrotliCompress();\n+\n+const chunk = file.slice(0, chunkSize);\n+const expectedFull = Buffer.from('iweA/9j/4AAQSkZJRgABAQEASA==', 'base64');\n+let actualFull;\n+\n+deflater.write(chunk, function() {\n+  deflater.flush(function() {\n+    const bufs = [];\n+    let buf;\n+    while (buf = deflater.read())\n+      bufs.push(buf);\n+    actualFull = Buffer.concat(bufs);\n+  });\n+});\n+\n+process.once('exit', function() {\n+  assert.deepStrictEqual(actualFull, expectedFull);\n+});"
        },
        {
            "sha": "a0afc425d25a6dbfae9f8a84f8564bac40a6052d",
            "filename": "test/parallel/test-zlib-brotli-from-brotli.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-from-brotli.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-from-brotli.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-brotli-from-brotli.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -0,0 +1,32 @@\n+'use strict';\n+// Test unzipping a file that was created with a non-node brotli lib,\n+// piped in as fast as possible.\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+const path = require('path');\n+const fixtures = require('../common/fixtures');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const decompress = new zlib.BrotliDecompress();\n+\n+const fs = require('fs');\n+\n+const fixture = fixtures.path('person.jpg.br');\n+const unzippedFixture = fixtures.path('person.jpg');\n+const outputFile = path.resolve(tmpdir.path, 'person.jpg');\n+const expect = fs.readFileSync(unzippedFixture);\n+const inp = fs.createReadStream(fixture);\n+const out = fs.createWriteStream(outputFile);\n+\n+inp.pipe(decompress).pipe(out);\n+out.on('close', common.mustCall(() => {\n+  const actual = fs.readFileSync(outputFile);\n+  assert.strictEqual(actual.length, expect.length);\n+  for (let i = 0, l = actual.length; i < l; i++) {\n+    assert.strictEqual(actual[i], expect[i], `byte[${i}]`);\n+  }\n+}));"
        },
        {
            "sha": "ab3673374f1d2f57f1b639d5e1562e9d8ee1d5bc",
            "filename": "test/parallel/test-zlib-brotli-from-string.js",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-from-string.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-from-string.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-brotli-from-string.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -0,0 +1,34 @@\n+'use strict';\n+// Test compressing and uncompressing a string with brotli\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+\n+const inputString = 'ΩΩLorem ipsum dolor sit amet, consectetur adipiscing eli' +\n+                    't. Morbi faucibus, purus at gravida dictum, libero arcu ' +\n+                    'convallis lacus, in commodo libero metus eu nisi. Nullam' +\n+                    ' commodo, neque nec porta placerat, nisi est fermentum a' +\n+                    'ugue, vitae gravida tellus sapien sit amet tellus. Aenea' +\n+                    'n non diam orci. Proin quis elit turpis. Suspendisse non' +\n+                    ' diam ipsum. Suspendisse nec ullamcorper odio. Vestibulu' +\n+                    'm arcu mi, sodales non suscipit id, ultrices ut massa. S' +\n+                    'ed ac sem sit amet arcu malesuada fermentum. Nunc sed. ';\n+const expectedBase64Compress = 'G/gBQBwHdky2aHV5KK9Snf05//1pPdmNw/7232fnIm1IB' +\n+                               'K1AA8RsN8OB8Nb7Lpgk3UWWUlzQXZyHQeBBbXMTQXC1j7' +\n+                               'wg3LJs9LqOGHRH2bj/a2iCTLLx8hBOyTqgoVuD1e+Qqdn' +\n+                               'f1rkUNyrWq6LtOhWgxP3QUwdhKGdZm3rJWaDDBV7+pDk1' +\n+                               'MIkrmjp4ma2xVi5MsgJScA3tP1I7mXeby6MELozrwoBQD' +\n+                               'mVTnEAicZNj4lkGqntJe2qSnGyeMmcFgraK94vCg/4iLu' +\n+                               'Tw5RhKhnVY++dZ6niUBmRqIutsjf5TzwF5iAg8a9UkjF5' +\n+                               '2eZ0tB2vo6v8SqVfNMkBmmhxr0NT9LkYF69aEjlYzj7IE' +\n+                               'KmEUQf1HBogRYhFIt4ymRNEgHAIzOyNEsQM=';\n+\n+zlib.brotliCompress(inputString, common.mustCall((err, buffer) => {\n+  assert.strictEqual(buffer.toString('base64'), expectedBase64Compress);\n+}));\n+\n+const buffer = Buffer.from(expectedBase64Compress, 'base64');\n+zlib.brotliDecompress(buffer, common.mustCall((err, buffer) => {\n+  assert.strictEqual(buffer.toString(), inputString);\n+}));"
        },
        {
            "sha": "c1765eec2983eeeb7461896472c3a08f3e9df317",
            "filename": "test/parallel/test-zlib-brotli-kmaxlength-rangeerror.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-kmaxlength-rangeerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli-kmaxlength-rangeerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-brotli-kmaxlength-rangeerror.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -0,0 +1,28 @@\n+'use strict';\n+require('../common');\n+\n+// This test ensures that zlib throws a RangeError if the final buffer needs to\n+// be larger than kMaxLength and concatenation fails.\n+// https://github.com/nodejs/node/pull/1811\n+\n+const assert = require('assert');\n+\n+// Change kMaxLength for zlib to trigger the error without having to allocate\n+// large Buffers.\n+const buffer = require('buffer');\n+const oldkMaxLength = buffer.kMaxLength;\n+buffer.kMaxLength = 128;\n+const zlib = require('zlib');\n+buffer.kMaxLength = oldkMaxLength;\n+\n+const encoded = Buffer.from('G38A+CXCIrFAIAM=', 'base64');\n+\n+// Async\n+zlib.brotliDecompress(encoded, function(err) {\n+  assert.ok(err instanceof RangeError);\n+});\n+\n+// Sync\n+assert.throws(function() {\n+  zlib.brotliDecompressSync(encoded);\n+}, RangeError);"
        },
        {
            "sha": "2dc60aff4058abc317721d0337d2de7b557850b4",
            "filename": "test/parallel/test-zlib-brotli.js",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-brotli.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-brotli.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -0,0 +1,73 @@\n+'use strict';\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+\n+// Test some brotli-specific properties of the brotli streams that can not\n+// be easily covered through expanding zlib-only tests.\n+\n+const sampleBuffer = fixtures.readSync('/pss-vectors.json');\n+\n+{\n+  // Test setting the quality parameter at stream creation:\n+  const sizes = [];\n+  for (let quality = zlib.constants.BROTLI_MIN_QUALITY;\n+    quality <= zlib.constants.BROTLI_MAX_QUALITY;\n+    quality++) {\n+    const encoded = zlib.brotliCompressSync(sampleBuffer, {\n+      params: {\n+        [zlib.constants.BROTLI_PARAM_QUALITY]: quality\n+      }\n+    });\n+    sizes.push(encoded.length);\n+  }\n+\n+  // Increasing quality should roughly correspond to decreasing compressed size:\n+  for (let i = 0; i < sizes.length - 1; i++) {\n+    assert(sizes[i + 1] <= sizes[i] * 1.05, sizes);  // 5 % margin of error.\n+  }\n+  assert(sizes[0] > sizes[sizes.length - 1], sizes);\n+}\n+\n+{\n+  // Test that setting out-of-bounds option values or keys fails.\n+  common.expectsError(() => {\n+    zlib.createBrotliCompress({\n+      params: {\n+        10000: 0\n+      }\n+    });\n+  }, {\n+    code: 'ERR_BROTLI_INVALID_PARAM',\n+    type: RangeError,\n+    message: '10000 is not a valid Brotli parameter'\n+  });\n+\n+  // Test that accidentally using duplicate keys fails.\n+  common.expectsError(() => {\n+    zlib.createBrotliCompress({\n+      params: {\n+        '0': 0,\n+        '00': 0\n+      }\n+    });\n+  }, {\n+    code: 'ERR_BROTLI_INVALID_PARAM',\n+    type: RangeError,\n+    message: '00 is not a valid Brotli parameter'\n+  });\n+\n+  common.expectsError(() => {\n+    zlib.createBrotliCompress({\n+      params: {\n+        // This is a boolean flag\n+        [zlib.constants.BROTLI_PARAM_DISABLE_LITERAL_CONTEXT_MODELING]: 42\n+      }\n+    });\n+  }, {\n+    code: 'ERR_ZLIB_INITIALIZATION_FAILED',\n+    type: Error,\n+    message: 'Initialization failed'\n+  });\n+}"
        },
        {
            "sha": "a7a4e523f7060b7303a25346345f6cbcd1e07b2e",
            "filename": "test/parallel/test-zlib-bytes-read.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-bytes-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-bytes-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-bytes-read.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -31,7 +31,8 @@ for (const method of [\n   ['createGzip', 'createGunzip', false],\n   ['createGzip', 'createUnzip', false],\n   ['createDeflate', 'createInflate', true],\n-  ['createDeflateRaw', 'createInflateRaw', true]\n+  ['createDeflateRaw', 'createInflateRaw', true],\n+  ['createBrotliCompress', 'createBrotliDecompress', true]\n ]) {\n   let compWriter;\n   let compData = Buffer.alloc(0);"
        },
        {
            "sha": "b60d0e15ac263af6c9e891e02c5942d054dc8fd7",
            "filename": "test/parallel/test-zlib-convenience-methods.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-convenience-methods.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-convenience-methods.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-convenience-methods.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -52,6 +52,8 @@ for (const [type, expect] of [\n     ['gzip', 'unzip', 'Gzip', 'Unzip'],\n     ['deflate', 'inflate', 'Deflate', 'Inflate'],\n     ['deflateRaw', 'inflateRaw', 'DeflateRaw', 'InflateRaw'],\n+    ['brotliCompress', 'brotliDecompress',\n+     'BrotliCompress', 'BrotliDecompress'],\n   ]) {\n     zlib[method[0]](expect, opts, common.mustCall((err, result) => {\n       zlib[method[1]](result, opts, common.mustCall((err, result) => {"
        },
        {
            "sha": "3b52896d29965e72260378ed5bf7fbb8ce56f709",
            "filename": "test/parallel/test-zlib-empty-buffer.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-empty-buffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-empty-buffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-empty-buffer.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -10,9 +10,11 @@ const emptyBuffer = Buffer.alloc(0);\n     [ zlib.deflateRawSync, zlib.inflateRawSync, 'raw sync' ],\n     [ zlib.deflateSync, zlib.inflateSync, 'deflate sync' ],\n     [ zlib.gzipSync, zlib.gunzipSync, 'gzip sync' ],\n+    [ zlib.brotliCompressSync, zlib.brotliDecompressSync, 'br sync' ],\n     [ promisify(zlib.deflateRaw), promisify(zlib.inflateRaw), 'raw' ],\n     [ promisify(zlib.deflate), promisify(zlib.inflate), 'deflate' ],\n-    [ promisify(zlib.gzip), promisify(zlib.gunzip), 'gzip' ]\n+    [ promisify(zlib.gzip), promisify(zlib.gunzip), 'gzip' ],\n+    [ promisify(zlib.brotliCompress), promisify(zlib.brotliDecompress), 'br' ]\n   ]) {\n     const compressed = await compress(emptyBuffer);\n     const decompressed = await decompress(compressed);"
        },
        {
            "sha": "dbfb5235b8a9088357b9c3db861699e50f9c5ca7",
            "filename": "test/parallel/test-zlib-invalid-input.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-invalid-input.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-invalid-input.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-invalid-input.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -38,7 +38,8 @@ const unzips = [\n   zlib.Unzip(),\n   zlib.Gunzip(),\n   zlib.Inflate(),\n-  zlib.InflateRaw()\n+  zlib.InflateRaw(),\n+  zlib.BrotliDecompress()\n ];\n \n nonStringInputs.forEach(common.mustCall((input) => {"
        },
        {
            "sha": "c7026163e77586339f50ab4e63454ecc19e714d8",
            "filename": "test/parallel/test-zlib-random-byte-pipes.js",
            "status": "modified",
            "additions": 15,
            "deletions": 11,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-random-byte-pipes.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-random-byte-pipes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-random-byte-pipes.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -141,14 +141,18 @@ class HashStream extends Stream {\n   }\n }\n \n-\n-const inp = new RandomReadStream({ total: 1024, block: 256, jitter: 16 });\n-const out = new HashStream();\n-const gzip = zlib.createGzip();\n-const gunz = zlib.createGunzip();\n-\n-inp.pipe(gzip).pipe(gunz).pipe(out);\n-\n-out.on('data', common.mustCall((c) => {\n-  assert.strictEqual(c, inp._hash, `Hash '${c}' equals '${inp._hash}'.`);\n-}));\n+for (const [ createCompress, createDecompress ] of [\n+  [ zlib.createGzip, zlib.createGunzip ],\n+  [ zlib.createBrotliCompress, zlib.createBrotliDecompress ],\n+]) {\n+  const inp = new RandomReadStream({ total: 1024, block: 256, jitter: 16 });\n+  const out = new HashStream();\n+  const gzip = createCompress();\n+  const gunz = createDecompress();\n+\n+  inp.pipe(gzip).pipe(gunz).pipe(out);\n+\n+  out.on('data', common.mustCall((c) => {\n+    assert.strictEqual(c, inp._hash, `Hash '${c}' equals '${inp._hash}'.`);\n+  }));\n+}"
        },
        {
            "sha": "2fcae2a2139768853345555eb7c3a40cf0992df0",
            "filename": "test/parallel/test-zlib-write-after-flush.js",
            "status": "modified",
            "additions": 21,
            "deletions": 16,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-write-after-flush.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-write-after-flush.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-write-after-flush.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -24,22 +24,27 @@ const common = require('../common');\n const assert = require('assert');\n const zlib = require('zlib');\n \n-const gzip = zlib.createGzip();\n-const gunz = zlib.createUnzip();\n+for (const [ createCompress, createDecompress ] of [\n+  [ zlib.createGzip, zlib.createGunzip ],\n+  [ zlib.createBrotliCompress, zlib.createBrotliDecompress ],\n+]) {\n+  const gzip = createCompress();\n+  const gunz = createDecompress();\n \n-gzip.pipe(gunz);\n+  gzip.pipe(gunz);\n \n-let output = '';\n-const input = 'A line of data\\n';\n-gunz.setEncoding('utf8');\n-gunz.on('data', (c) => output += c);\n-gunz.on('end', common.mustCall(() => {\n-  assert.strictEqual(output, input);\n-  assert.strictEqual(gzip._nextFlush, -1);\n-}));\n+  let output = '';\n+  const input = 'A line of data\\n';\n+  gunz.setEncoding('utf8');\n+  gunz.on('data', (c) => output += c);\n+  gunz.on('end', common.mustCall(() => {\n+    assert.strictEqual(output, input);\n+    assert.strictEqual(gzip._nextFlush, -1);\n+  }));\n \n-// Make sure that flush/write doesn't trigger an assert failure\n-gzip.flush();\n-gzip.write(input);\n-gzip.end();\n-gunz.read(0);\n+  // Make sure that flush/write doesn't trigger an assert failure\n+  gzip.flush();\n+  gzip.write(input);\n+  gzip.end();\n+  gunz.read(0);\n+}"
        },
        {
            "sha": "fc57960f1e56cbae82980bf986c3609f2497ff3d",
            "filename": "test/parallel/test-zlib-zero-byte.js",
            "status": "modified",
            "additions": 17,
            "deletions": 13,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-zero-byte.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib-zero-byte.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-zero-byte.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -22,18 +22,22 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-\n const zlib = require('zlib');\n-const gz = zlib.Gzip();\n-const emptyBuffer = Buffer.alloc(0);\n-let received = 0;\n-gz.on('data', function(c) {\n-  received += c.length;\n-});\n \n-gz.on('end', common.mustCall(function() {\n-  assert.strictEqual(received, 20);\n-}));\n-gz.on('finish', common.mustCall());\n-gz.write(emptyBuffer);\n-gz.end();\n+for (const Compressor of [ zlib.Gzip, zlib.BrotliCompress ]) {\n+  const gz = Compressor();\n+  const emptyBuffer = Buffer.alloc(0);\n+  let received = 0;\n+  gz.on('data', function(c) {\n+    received += c.length;\n+  });\n+\n+  gz.on('end', common.mustCall(function() {\n+    const expected = Compressor === zlib.Gzip ? 20 : 1;\n+    assert.strictEqual(received, expected,\n+                       `${received}, ${expected}, ${Compressor.name}`);\n+  }));\n+  gz.on('finish', common.mustCall());\n+  gz.write(emptyBuffer);\n+  gz.end();\n+}"
        },
        {
            "sha": "6104172c7ae5901c7f6467f20f62f76d1dbf83b6",
            "filename": "test/parallel/test-zlib.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7da5b79c300b2d5abf6658ba3fa8edf916f05cc/test%2Fparallel%2Ftest-zlib.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib.js?ref=b7da5b79c300b2d5abf6658ba3fa8edf916f05cc",
            "patch": "@@ -32,7 +32,8 @@ let zlibPairs = [\n   [zlib.Gzip, zlib.Gunzip],\n   [zlib.Deflate, zlib.Unzip],\n   [zlib.Gzip, zlib.Unzip],\n-  [zlib.DeflateRaw, zlib.InflateRaw]\n+  [zlib.DeflateRaw, zlib.InflateRaw],\n+  [zlib.BrotliCompress, zlib.BrotliDecompress],\n ];\n \n // how fast to trickle through the slowstream"
        }
    ],
    "stats": {
        "total": 316,
        "additions": 267,
        "deletions": 49
    }
}