{
    "author": "joyeecheung",
    "message": "process: move child process IPC setup condition into node.js\n\nInstead of branching in main_thread_only.js, move the branch on\nprocess.env.NODE_CHANNEL_FD in node.js so it's easier to tell when\nthis needs to happen. Also added comments about what side effect\nthis causes, and lazy load `assert`.\n\nPR-URL: https://github.com/nodejs/node/pull/25130\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "0c1a38821825d4aced001e223bbba23b19b521f1",
    "files": [
        {
            "sha": "0f207ab6602fdc50d186166463f15431c660e283",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/0c1a38821825d4aced001e223bbba23b19b521f1/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/0c1a38821825d4aced001e223bbba23b19b521f1/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=0c1a38821825d4aced001e223bbba23b19b521f1",
            "patch": "@@ -155,7 +155,12 @@ function startup() {\n     return;\n   }\n \n-  if (isMainThread) {\n+  // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n+  // spawned by our child_process module, then initialize IPC.\n+  // This attaches some internal event listeners and creates:\n+  // process.send(), process.channel, process.connected,\n+  // process.disconnect()\n+  if (isMainThread && process.env.NODE_CHANNEL_FD) {\n     mainThreadSetup.setupChildProcessIpcChannel();\n   }\n "
        },
        {
            "sha": "862194ae46e27e20960b685713c1bb749ba57886",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 8,
            "deletions": 12,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/0c1a38821825d4aced001e223bbba23b19b521f1/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/0c1a38821825d4aced001e223bbba23b19b521f1/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=0c1a38821825d4aced001e223bbba23b19b521f1",
            "patch": "@@ -21,8 +21,6 @@ const {\n   getMainThreadStdio\n } = require('internal/process/stdio');\n \n-const assert = require('assert').strict;\n-\n function setupStdio() {\n   setupProcessStdio(getMainThreadStdio());\n }\n@@ -163,18 +161,16 @@ function setupSignalHandlers(internalBinding) {\n }\n \n function setupChildProcessIpcChannel() {\n-  // If we were spawned with env NODE_CHANNEL_FD then load that up and\n-  // start parsing data from that stream.\n-  if (process.env.NODE_CHANNEL_FD) {\n-    const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n-    assert(fd >= 0);\n+  const assert = require('assert').strict;\n \n-    // Make sure it's not accidentally inherited by child processes.\n-    delete process.env.NODE_CHANNEL_FD;\n+  const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n+  assert(fd >= 0);\n \n-    require('child_process')._forkChild(fd);\n-    assert(process.send);\n-  }\n+  // Make sure it's not accidentally inherited by child processes.\n+  delete process.env.NODE_CHANNEL_FD;\n+\n+  require('child_process')._forkChild(fd);\n+  assert(process.send);\n }\n \n module.exports = {"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 14,
        "deletions": 13
    }
}