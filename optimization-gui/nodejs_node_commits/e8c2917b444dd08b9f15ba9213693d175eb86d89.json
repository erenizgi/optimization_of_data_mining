{
    "author": "addaleax",
    "message": "src: simplify http2 perf tracking code\n\nUse `unique_ptr`s and use the resulting simplification to\nreduce indentation in these functions.\n\nPR-URL: https://github.com/nodejs/node/pull/19470\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "e8c2917b444dd08b9f15ba9213693d175eb86d89",
    "files": [
        {
            "sha": "52b0f8d66622a563645495cb2635118cd7280cc7",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 48,
            "deletions": 47,
            "changes": 95,
            "blob_url": "https://github.com/nodejs/node/blob/e8c2917b444dd08b9f15ba9213693d175eb86d89/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e8c2917b444dd08b9f15ba9213693d175eb86d89/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=e8c2917b444dd08b9f15ba9213693d175eb86d89",
            "patch": "@@ -515,35 +515,35 @@ void Http2Stream::EmitStatistics() {\n   Http2StreamPerformanceEntry* entry =\n     new Http2StreamPerformanceEntry(env(), id_, statistics_);\n   env()->SetImmediate([](Environment* env, void* data) {\n-    Http2StreamPerformanceEntry* entry =\n-      static_cast<Http2StreamPerformanceEntry*>(data);\n-    if (HasHttp2Observer(env)) {\n-      AliasedBuffer<double, v8::Float64Array>& buffer =\n-          env->http2_state()->stream_stats_buffer;\n-      buffer[IDX_STREAM_STATS_ID] = entry->id();\n-      if (entry->first_byte() != 0) {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTE] =\n-            (entry->first_byte() - entry->startTimeNano()) / 1e6;\n-      } else {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTE] = 0;\n-      }\n-      if (entry->first_header() != 0) {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTHEADER] =\n-            (entry->first_header() - entry->startTimeNano()) / 1e6;\n-      } else {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTHEADER] = 0;\n-      }\n-      if (entry->first_byte_sent() != 0) {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTESENT] =\n-            (entry->first_byte_sent() - entry->startTimeNano()) / 1e6;\n-      } else {\n-        buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTESENT] = 0;\n-      }\n-      buffer[IDX_STREAM_STATS_SENTBYTES] = entry->sent_bytes();\n-      buffer[IDX_STREAM_STATS_RECEIVEDBYTES] = entry->received_bytes();\n-      entry->Notify(entry->ToObject());\n+    // This takes ownership, the entr is destroyed at the end of this scope.\n+    std::unique_ptr<Http2StreamPerformanceEntry> entry {\n+        static_cast<Http2StreamPerformanceEntry*>(data) };\n+    if (!HasHttp2Observer(env))\n+      return;\n+    AliasedBuffer<double, v8::Float64Array>& buffer =\n+        env->http2_state()->stream_stats_buffer;\n+    buffer[IDX_STREAM_STATS_ID] = entry->id();\n+    if (entry->first_byte() != 0) {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTE] =\n+          (entry->first_byte() - entry->startTimeNano()) / 1e6;\n+    } else {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTE] = 0;\n     }\n-    delete entry;\n+    if (entry->first_header() != 0) {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTHEADER] =\n+          (entry->first_header() - entry->startTimeNano()) / 1e6;\n+    } else {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTHEADER] = 0;\n+    }\n+    if (entry->first_byte_sent() != 0) {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTESENT] =\n+          (entry->first_byte_sent() - entry->startTimeNano()) / 1e6;\n+    } else {\n+      buffer[IDX_STREAM_STATS_TIMETOFIRSTBYTESENT] = 0;\n+    }\n+    buffer[IDX_STREAM_STATS_SENTBYTES] = entry->sent_bytes();\n+    buffer[IDX_STREAM_STATS_RECEIVEDBYTES] = entry->received_bytes();\n+    entry->Notify(entry->ToObject());\n   }, static_cast<void*>(entry));\n }\n \n@@ -553,25 +553,25 @@ void Http2Session::EmitStatistics() {\n   Http2SessionPerformanceEntry* entry =\n     new Http2SessionPerformanceEntry(env(), statistics_, session_type_);\n   env()->SetImmediate([](Environment* env, void* data) {\n-    Http2SessionPerformanceEntry* entry =\n-      static_cast<Http2SessionPerformanceEntry*>(data);\n-    if (HasHttp2Observer(env)) {\n-      AliasedBuffer<double, v8::Float64Array>& buffer =\n-          env->http2_state()->session_stats_buffer;\n-      buffer[IDX_SESSION_STATS_TYPE] = entry->type();\n-      buffer[IDX_SESSION_STATS_PINGRTT] = entry->ping_rtt() / 1e6;\n-      buffer[IDX_SESSION_STATS_FRAMESRECEIVED] = entry->frame_count();\n-      buffer[IDX_SESSION_STATS_FRAMESSENT] = entry->frame_sent();\n-      buffer[IDX_SESSION_STATS_STREAMCOUNT] = entry->stream_count();\n-      buffer[IDX_SESSION_STATS_STREAMAVERAGEDURATION] =\n-          entry->stream_average_duration();\n-      buffer[IDX_SESSION_STATS_DATA_SENT] = entry->data_sent();\n-      buffer[IDX_SESSION_STATS_DATA_RECEIVED] = entry->data_received();\n-      buffer[IDX_SESSION_STATS_MAX_CONCURRENT_STREAMS] =\n-          entry->max_concurrent_streams();\n-      entry->Notify(entry->ToObject());\n-    }\n-    delete entry;\n+    // This takes ownership, the entr is destroyed at the end of this scope.\n+    std::unique_ptr<Http2SessionPerformanceEntry> entry {\n+        static_cast<Http2SessionPerformanceEntry*>(data) };\n+    if (!HasHttp2Observer(env))\n+      return;\n+    AliasedBuffer<double, v8::Float64Array>& buffer =\n+        env->http2_state()->session_stats_buffer;\n+    buffer[IDX_SESSION_STATS_TYPE] = entry->type();\n+    buffer[IDX_SESSION_STATS_PINGRTT] = entry->ping_rtt() / 1e6;\n+    buffer[IDX_SESSION_STATS_FRAMESRECEIVED] = entry->frame_count();\n+    buffer[IDX_SESSION_STATS_FRAMESSENT] = entry->frame_sent();\n+    buffer[IDX_SESSION_STATS_STREAMCOUNT] = entry->stream_count();\n+    buffer[IDX_SESSION_STATS_STREAMAVERAGEDURATION] =\n+        entry->stream_average_duration();\n+    buffer[IDX_SESSION_STATS_DATA_SENT] = entry->data_sent();\n+    buffer[IDX_SESSION_STATS_DATA_RECEIVED] = entry->data_received();\n+    buffer[IDX_SESSION_STATS_MAX_CONCURRENT_STREAMS] =\n+        entry->max_concurrent_streams();\n+    entry->Notify(entry->ToObject());\n   }, static_cast<void*>(entry));\n }\n \n@@ -1379,6 +1379,7 @@ void Http2Session::MaybeScheduleWrite() {\n \n       // Sending data may call arbitrary JS code, so keep track of\n       // async context.\n+      HandleScope handle_scope(env->isolate());\n       InternalCallbackScope callback_scope(session);\n       session->SendPendingData();\n     }, static_cast<void*>(this), object());"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 48,
        "deletions": 47
    }
}