{
    "author": "vsemozhetbyt",
    "message": "tools: simplify tools/doc/preprocess.js\n\nPR-URL: https://github.com/nodejs/node/pull/19539\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Daijiro Wachi <daijiro.wachi@gmail.com>",
    "sha": "cde98ce14743c4f2b80ac7825fc52fb179feeef6",
    "files": [
        {
            "sha": "f8d394735dd30bc3b27aa0266a5ea11eb3fd4668",
            "filename": "tools/doc/preprocess.js",
            "status": "modified",
            "additions": 18,
            "deletions": 38,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/cde98ce14743c4f2b80ac7825fc52fb179feeef6/tools%2Fdoc%2Fpreprocess.js",
            "raw_url": "https://github.com/nodejs/node/raw/cde98ce14743c4f2b80ac7825fc52fb179feeef6/tools%2Fdoc%2Fpreprocess.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fpreprocess.js?ref=cde98ce14743c4f2b80ac7825fc52fb179feeef6",
            "patch": "@@ -1,58 +1,38 @@\n 'use strict';\n \n-module.exports = preprocess;\n+module.exports = processIncludes;\n \n const path = require('path');\n const fs = require('fs');\n \n-const includeExpr = /^@include\\s+[\\w-]+\\.?[a-zA-Z]*$/gmi;\n-const includeData = {};\n-\n-function preprocess(inputFile, input, cb) {\n-  input = stripComments(input);\n-  processIncludes(inputFile, input, cb);\n-}\n-\n-function stripComments(input) {\n-  return input.replace(/^@\\/\\/.*$/gmi, '');\n-}\n+const includeExpr = /^@include\\s+([\\w-]+)(?:\\.md)?$/gmi;\n+const commentExpr = /^@\\/\\/.*$/gmi;\n \n function processIncludes(inputFile, input, cb) {\n   const includes = input.match(includeExpr);\n-  if (includes === null) return cb(null, input);\n+  if (includes === null)\n+    return cb(null, input.replace(commentExpr, ''));\n+\n   let errState = null;\n   let incCount = includes.length;\n \n   includes.forEach((include) => {\n-    let fname = include.replace(/^@include\\s+/, '');\n-    if (!/\\.md$/.test(fname)) fname = `${fname}.md`;\n-\n-    if (includeData.hasOwnProperty(fname)) {\n-      input = input.split(include).join(includeData[fname]);\n-      incCount--;\n-      if (incCount === 0) {\n-        return cb(null, input);\n-      }\n-    }\n-\n+    const fname = include.replace(includeExpr, '$1.md');\n     const fullFname = path.resolve(path.dirname(inputFile), fname);\n+\n     fs.readFile(fullFname, 'utf8', function(er, inc) {\n       if (errState) return;\n       if (er) return cb(errState = er);\n-      preprocess(inputFile, inc, function(er, inc) {\n-        if (errState) return;\n-        if (er) return cb(errState = er);\n-        incCount--;\n-\n-        // Add comments to let the HTML generator know how the anchors for\n-        // headings should look like.\n-        includeData[fname] = `<!-- [start-include:${fname}] -->\\n` +\n-                             `${inc}\\n<!-- [end-include:${fname}] -->\\n`;\n-        input = input.split(`${include}\\n`).join(`${includeData[fname]}\\n`);\n-        if (incCount === 0) {\n-          return cb(null, input);\n-        }\n-      });\n+      incCount--;\n+\n+      // Add comments to let the HTML generator know\n+      // how the anchors for headings should look like.\n+      inc = `<!-- [start-include:${fname}] -->\\n` +\n+            `${inc}\\n<!-- [end-include:${fname}] -->\\n`;\n+      input = input.split(`${include}\\n`).join(`${inc}\\n`);\n+\n+      if (incCount === 0)\n+        return cb(null, input.replace(commentExpr, ''));\n     });\n   });\n }"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 18,
        "deletions": 38
    }
}