{
    "author": "BridgeAR",
    "message": "assert: fix diff color output\n\nThe color output was broken at some point and that was not detected\nbecause it was not tested for properly so far. This makes sure the\ncolors work again and it adds a regression test as well.\n\nPR-URL: https://github.com/nodejs/node/pull/19464\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "2e6dd93aaa40e9f205a2e84920213effab81bea1",
    "files": [
        {
            "sha": "e79041d91d5d8dd4c364d55cbf8ffcbf6ae8b00a",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 34,
            "deletions": 32,
            "changes": 66,
            "blob_url": "https://github.com/nodejs/node/blob/2e6dd93aaa40e9f205a2e84920213effab81bea1/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/2e6dd93aaa40e9f205a2e84920213effab81bea1/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=2e6dd93aaa40e9f205a2e84920213effab81bea1",
            "patch": "@@ -15,9 +15,9 @@ const kInfo = Symbol('info');\n const messages = new Map();\n const codes = {};\n \n-var green = '';\n-var red = '';\n-var white = '';\n+let green = '';\n+let red = '';\n+let white = '';\n \n const {\n   errmap,\n@@ -29,16 +29,9 @@ const { kMaxLength } = process.binding('buffer');\n const { defineProperty } = Object;\n \n // Lazily loaded\n-var util_ = null;\n+var util;\n var buffer;\n \n-function lazyUtil() {\n-  if (!util_) {\n-    util_ = require('util');\n-  }\n-  return util_;\n-}\n-\n var internalUtil = null;\n function lazyInternalUtil() {\n   if (!internalUtil) {\n@@ -47,6 +40,13 @@ function lazyInternalUtil() {\n   return internalUtil;\n }\n \n+function inspectValue(val) {\n+  return util.inspect(\n+    val,\n+    { compact: false, customInspect: false }\n+  ).split('\\n');\n+}\n+\n function makeNodeError(Base) {\n   return class NodeError extends Base {\n     constructor(key, ...args) {\n@@ -210,11 +210,9 @@ function createErrDiff(actual, expected, operator) {\n   var lastPos = 0;\n   var end = '';\n   var skipped = false;\n-  const util = lazyUtil();\n-  const actualLines = util\n-    .inspect(actual, { compact: false, customInspect: false }).split('\\n');\n-  const expectedLines = util\n-    .inspect(expected, { compact: false, customInspect: false }).split('\\n');\n+  if (util === undefined) util = require('util');\n+  const actualLines = inspectValue(actual);\n+  const expectedLines = inspectValue(expected);\n   const msg = `Input A expected to ${operator} input B:\\n` +\n         `${green}+ expected${white} ${red}- actual${white}`;\n   const skippedMsg = ' ... Lines skipped';\n@@ -333,14 +331,20 @@ class AssertionError extends Error {\n     if (message != null) {\n       super(message);\n     } else {\n-      if (util_ === null &&\n-          process.stdout.isTTY &&\n-          process.stdout.getColorDepth() !== 1) {\n-        green = '\\u001b[32m';\n-        white = '\\u001b[39m';\n-        red = '\\u001b[31m';\n+      if (process.stdout.isTTY) {\n+        // Reset on each call to make sure we handle dynamically set environment\n+        // variables correct.\n+        if (process.stdout.getColorDepth() !== 1) {\n+          green = '\\u001b[32m';\n+          white = '\\u001b[39m';\n+          red = '\\u001b[31m';\n+        } else {\n+          green = '';\n+          white = '';\n+          red = '';\n+        }\n       }\n-      const util = lazyUtil();\n+      if (util === undefined) util = require('util');\n       if (typeof actual === 'object' && actual !== null &&\n         'stack' in actual && actual instanceof Error) {\n         actual = `${actual.name}: ${actual.message}`;\n@@ -361,10 +365,7 @@ class AssertionError extends Error {\n       } else if (errorDiff === 1) {\n         // In case the objects are equal but the operator requires unequal, show\n         // the first object and say A equals B\n-        const res = util.inspect(\n-          actual,\n-          { compact: false, customInspect: false }\n-        ).split('\\n');\n+        const res = inspectValue(actual);\n \n         if (res.length > 20) {\n           res[19] = '...';\n@@ -406,10 +407,10 @@ function message(key, args) {\n   const msg = messages.get(key);\n   internalAssert(msg, `An invalid error message key was used: ${key}.`);\n   let fmt;\n+  if (util === undefined) util = require('util');\n   if (typeof msg === 'function') {\n     fmt = msg;\n   } else {\n-    const util = lazyUtil();\n     fmt = util.format;\n     if (args === undefined || args.length === 0)\n       return msg;\n@@ -479,7 +480,8 @@ function errnoException(err, syscall, original) {\n   // getSystemErrorName(err) to guard against invalid arguments from users.\n   // This can be replaced with [ code ] = errmap.get(err) when this method\n   // is no longer exposed to user land.\n-  const code = lazyUtil().getSystemErrorName(err);\n+  if (util === undefined) util = require('util');\n+  const code = util.getSystemErrorName(err);\n   const message = original ?\n     `${syscall} ${code} ${original}` : `${syscall} ${code}`;\n \n@@ -508,7 +510,8 @@ function exceptionWithHostPort(err, syscall, address, port, additional) {\n   // getSystemErrorName(err) to guard against invalid arguments from users.\n   // This can be replaced with [ code ] = errmap.get(err) when this method\n   // is no longer exposed to user land.\n-  const code = lazyUtil().getSystemErrorName(err);\n+  if (util === undefined) util = require('util');\n+  const code = util.getSystemErrorName(err);\n   let details = '';\n   if (port && port > 0) {\n     details = ` ${address}:${port}`;\n@@ -768,10 +771,9 @@ E('ERR_INSPECTOR_NOT_CONNECTED', 'Session is not connected', Error);\n E('ERR_INVALID_ADDRESS_FAMILY', 'Invalid address family: %s', RangeError);\n E('ERR_INVALID_ARG_TYPE', invalidArgType, TypeError);\n E('ERR_INVALID_ARG_VALUE', (name, value, reason = 'is invalid') => {\n-  const util = lazyUtil();\n   let inspected = util.inspect(value);\n   if (inspected.length > 128) {\n-    inspected = inspected.slice(0, 128) + '...';\n+    inspected = `${inspected.slice(0, 128)}...`;\n   }\n   return `The argument '${name}' ${reason}. Received ${inspected}`;\n }, TypeError, RangeError);"
        },
        {
            "sha": "54972657e94dd44ec06ecf446320aa1a6232dd54",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 22,
            "deletions": 27,
            "changes": 49,
            "blob_url": "https://github.com/nodejs/node/blob/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=2e6dd93aaa40e9f205a2e84920213effab81bea1",
            "patch": "@@ -34,11 +34,8 @@ const { writeFileSync, unlinkSync } = require('fs');\n const { inspect } = require('util');\n const a = assert;\n \n-const colors = process.stdout.isTTY && process.stdout.getColorDepth() > 1;\n const start = 'Input A expected to deepStrictEqual input B:';\n-const actExp = colors ?\n-  '\\u001b[32m+ expected\\u001b[39m \\u001b[31m- actual\\u001b[39m' :\n-  '+ expected - actual';\n+const actExp = '+ expected - actual';\n \n assert.ok(a.AssertionError.prototype instanceof Error,\n           'a.AssertionError instanceof Error');\n@@ -442,8 +439,6 @@ common.expectsError(\n   Error.stackTraceLimit = tmpLimit;\n \n   // Test error diffs.\n-  const plus = colors ? '\\u001b[32m+\\u001b[39m' : '+';\n-  const minus = colors ? '\\u001b[31m-\\u001b[39m' : '-';\n   let message = [\n     start,\n     `${actExp} ... Lines skipped`,\n@@ -452,8 +447,8 @@ common.expectsError(\n     '    [',\n     '...',\n     '        2,',\n-    `${minus}       3`,\n-    `${plus}       '3'`,\n+    '-       3',\n+    \"+       '3'\",\n     '      ]',\n     '...',\n     '    5',\n@@ -470,7 +465,7 @@ common.expectsError(\n     '    1,',\n     '...',\n     '    0,',\n-    `${plus}   1,`,\n+    '+   1,',\n     '    1,',\n     '...',\n     '    1',\n@@ -490,7 +485,7 @@ common.expectsError(\n     '    1,',\n     '...',\n     '    0,',\n-    `${minus}   1,`,\n+    '-   1,',\n     '    1,',\n     '...',\n     '    1',\n@@ -508,12 +503,12 @@ common.expectsError(\n     '',\n     '  [',\n     '    1,',\n-    `${minus}   2,`,\n-    `${plus}   1,`,\n+    '-   2,',\n+    '+   1,',\n     '    1,',\n     '    1,',\n     '    0,',\n-    `${minus}   1,`,\n+    '-   1,',\n     '    1',\n     '  ]'\n   ].join('\\n');\n@@ -527,12 +522,12 @@ common.expectsError(\n     start,\n     actExp,\n     '',\n-    `${minus} [`,\n-    `${minus}   1,`,\n-    `${minus}   2,`,\n-    `${minus}   1`,\n-    `${minus} ]`,\n-    `${plus} undefined`,\n+    '- [',\n+    '-   1,',\n+    '-   2,',\n+    '-   1',\n+    '- ]',\n+    '+ undefined',\n   ].join('\\n');\n   assert.throws(\n     () => assert.deepEqual([1, 2, 1]),\n@@ -543,7 +538,7 @@ common.expectsError(\n     actExp,\n     '',\n     '  [',\n-    `${minus}   1,`,\n+    '-   1,',\n     '    2,',\n     '    1',\n     '  ]'\n@@ -556,9 +551,9 @@ common.expectsError(\n     `${actExp} ... Lines skipped\\n` +\n     '\\n' +\n     '  [\\n' +\n-    `${minus}   1,\\n`.repeat(10) +\n+    '-   1,\\n'.repeat(10) +\n     '...\\n' +\n-    `${plus}   2,\\n`.repeat(10) +\n+    '+   2,\\n'.repeat(10) +\n     '...';\n   assert.throws(\n     () => assert.deepEqual(Array(12).fill(1), Array(12).fill(2)),\n@@ -572,11 +567,11 @@ common.expectsError(\n     message: `${start}\\n` +\n     `${actExp}\\n` +\n     '\\n' +\n-    `${minus} {}\\n` +\n-    `${plus} {\\n` +\n-    `${plus}   loop: 'forever',\\n` +\n-    `${plus}   [Symbol(util.inspect.custom)]: [Function]\\n` +\n-    `${plus} }`\n+    '- {}\\n' +\n+    '+ {\\n' +\n+    \"+   loop: 'forever',\\n\" +\n+    '+   [Symbol(util.inspect.custom)]: [Function]\\n' +\n+    '+ }'\n   });\n \n   // notDeepEqual tests"
        },
        {
            "sha": "7c5845bdaa271a3661c58c97763680cbb6f157ad",
            "filename": "test/pseudo-tty/test-assert-colors.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fpseudo-tty%2Ftest-assert-colors.js",
            "raw_url": "https://github.com/nodejs/node/raw/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fpseudo-tty%2Ftest-assert-colors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-assert-colors.js?ref=2e6dd93aaa40e9f205a2e84920213effab81bea1",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert').strict;\n+\n+try {\n+  // Activate colors even if the tty does not support colors.\n+  process.env.COLORTERM = '1';\n+  assert.deepStrictEqual([1, 2], [2, 2]);\n+} catch (err) {\n+  const expected = 'Input A expected to deepStrictEqual input B:\\n' +\n+    '\\u001b[32m+ expected\\u001b[39m \\u001b[31m- actual\\u001b[39m\\n\\n' +\n+    '  [\\n' +\n+    '\\u001b[31m-\\u001b[39m   1,\\n' +\n+    '\\u001b[32m+\\u001b[39m   2,\\n' +\n+    '    2\\n' +\n+    '  ]';\n+  assert.strictEqual(err.message, expected);\n+}"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-assert-colors.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fpseudo-tty%2Ftest-assert-colors.out",
            "raw_url": "https://github.com/nodejs/node/raw/2e6dd93aaa40e9f205a2e84920213effab81bea1/test%2Fpseudo-tty%2Ftest-assert-colors.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-assert-colors.out?ref=2e6dd93aaa40e9f205a2e84920213effab81bea1"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 74,
        "deletions": 59
    }
}