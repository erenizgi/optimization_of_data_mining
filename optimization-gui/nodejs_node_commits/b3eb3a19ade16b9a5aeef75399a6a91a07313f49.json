{
    "author": "addaleax",
    "message": "test: fix flaky test-worker-message-port-transfer-self\n\nLook at the status of the `MessagePort` rather than\nrelying on a timeout.\n\nPR-URL: https://github.com/nodejs/node/pull/22658\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "b3eb3a19ade16b9a5aeef75399a6a91a07313f49",
    "files": [
        {
            "sha": "4fe12c0a88d81db8edd12fb84a8b0712a6d7727c",
            "filename": "test/parallel/test-worker-message-port-transfer-self.js",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/b3eb3a19ade16b9a5aeef75399a6a91a07313f49/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "raw_url": "https://github.com/nodejs/node/raw/b3eb3a19ade16b9a5aeef75399a6a91a07313f49/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js?ref=b3eb3a19ade16b9a5aeef75399a6a91a07313f49",
            "patch": "@@ -3,6 +3,7 @@\n \n const common = require('../common');\n const assert = require('assert');\n+const util = require('util');\n const { MessageChannel } = require('worker_threads');\n \n const { port1, port2 } = new MessageChannel();\n@@ -25,9 +26,22 @@ assert.throws(common.mustCall(() => {\n // The failed transfer should not affect the ports in anyway.\n port2.onmessage = common.mustCall((message) => {\n   assert.strictEqual(message, 2);\n+\n+  assert(util.inspect(port1).includes('active: true'), util.inspect(port1));\n+  assert(util.inspect(port2).includes('active: true'), util.inspect(port2));\n+\n   port1.close();\n \n-  setTimeout(common.mustNotCall('The communication channel is still open'),\n-             common.platformTimeout(1000)).unref();\n+  tick(10, () => {\n+    assert(util.inspect(port1).includes('active: false'), util.inspect(port1));\n+    assert(util.inspect(port2).includes('active: false'), util.inspect(port2));\n+  });\n });\n port1.postMessage(2);\n+\n+function tick(n, cb) {\n+  if (n > 0)\n+    setImmediate(() => tick(n - 1, cb));\n+  else\n+    cb();\n+}"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 16,
        "deletions": 2
    }
}