{
    "author": "joyeecheung",
    "message": "process: move C++ process events into node_process_events.cc\n\nMove the C++ `process.emit` and `process.emitWarning` methods\nfrom `node.cc` into into `node_process_events.cc`, and\nreuse the implementation in other places that need to do\n`process.emit` in C++.\n\nPR-URL: https://github.com/nodejs/node/pull/25397\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "84f0581d36bddbf7083e82c082275ef562fa8568",
    "files": [
        {
            "sha": "c7bc857b1530f13a4982f900411ba212540bcbba",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/84f0581d36bddbf7083e82c082275ef562fa8568/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/84f0581d36bddbf7083e82c082275ef562fa8568/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=84f0581d36bddbf7083e82c082275ef562fa8568",
            "patch": "@@ -370,6 +370,7 @@\n         'src/node_perf.cc',\n         'src/node_platform.cc',\n         'src/node_postmortem_metadata.cc',\n+        'src/node_process_events.cc',\n         'src/node_process_methods.cc',\n         'src/node_process_object.cc',\n         'src/node_serdes.cc',"
        },
        {
            "sha": "a53c58337e900be84c963a25c83ae2b69a632e0d",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=84f0581d36bddbf7083e82c082275ef562fa8568",
            "patch": "@@ -370,26 +370,13 @@ class SameThreadInspectorSession : public InspectorSession {\n void NotifyClusterWorkersDebugEnabled(Environment* env) {\n   Isolate* isolate = env->isolate();\n   HandleScope handle_scope(isolate);\n-  auto context = env->context();\n+  Local<Context> context = env->context();\n \n   // Send message to enable debug in cluster workers\n-  Local<Object> process_object = env->process_object();\n-  Local<Value> emit_fn =\n-      process_object->Get(context, FIXED_ONE_BYTE_STRING(isolate, \"emit\"))\n-          .ToLocalChecked();\n-  // In case the thread started early during the startup\n-  if (!emit_fn->IsFunction())\n-    return;\n-\n   Local<Object> message = Object::New(isolate);\n   message->Set(context, FIXED_ONE_BYTE_STRING(isolate, \"cmd\"),\n                FIXED_ONE_BYTE_STRING(isolate, \"NODE_DEBUG_ENABLED\")).FromJust();\n-  Local<Value> argv[] = {\n-    FIXED_ONE_BYTE_STRING(isolate, \"internalMessage\"),\n-    message\n-  };\n-  MakeCallback(env->isolate(), process_object, emit_fn.As<Function>(),\n-               arraysize(argv), argv, {0, 0});\n+  ProcessEmit(env, \"internalMessage\", message);\n }\n \n #ifdef _WIN32"
        },
        {
            "sha": "d5f3f4e6aad2bfb1f9fe4a4f643393ed7601e69e",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 98,
            "changes": 105,
            "blob_url": "https://github.com/nodejs/node/blob/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=84f0581d36bddbf7083e82c082275ef562fa8568",
            "patch": "@@ -124,8 +124,6 @@ using v8::Maybe;\n using v8::MaybeLocal;\n using v8::Message;\n using v8::MicrotasksPolicy;\n-using v8::NewStringType;\n-using v8::Nothing;\n using v8::Object;\n using v8::ObjectTemplate;\n using v8::Script;\n@@ -582,82 +580,6 @@ void Exit(const FunctionCallbackInfo<Value>& args) {\n   env->Exit(code);\n }\n \n-static Maybe<bool> ProcessEmitWarningGeneric(Environment* env,\n-                                      const char* warning,\n-                                      const char* type = nullptr,\n-                                      const char* code = nullptr) {\n-  HandleScope handle_scope(env->isolate());\n-  Context::Scope context_scope(env->context());\n-\n-  Local<Object> process = env->process_object();\n-  Local<Value> emit_warning;\n-  if (!process->Get(env->context(),\n-                    env->emit_warning_string()).ToLocal(&emit_warning)) {\n-    return Nothing<bool>();\n-  }\n-\n-  if (!emit_warning->IsFunction()) return Just(false);\n-\n-  int argc = 0;\n-  Local<Value> args[3];  // warning, type, code\n-\n-  // The caller has to be able to handle a failure anyway, so we might as well\n-  // do proper error checking for string creation.\n-  if (!String::NewFromUtf8(env->isolate(),\n-                           warning,\n-                           NewStringType::kNormal).ToLocal(&args[argc++])) {\n-    return Nothing<bool>();\n-  }\n-  if (type != nullptr) {\n-    if (!String::NewFromOneByte(env->isolate(),\n-                                reinterpret_cast<const uint8_t*>(type),\n-                                NewStringType::kNormal)\n-                                    .ToLocal(&args[argc++])) {\n-      return Nothing<bool>();\n-    }\n-    if (code != nullptr &&\n-        !String::NewFromOneByte(env->isolate(),\n-                                reinterpret_cast<const uint8_t*>(code),\n-                                NewStringType::kNormal)\n-                                    .ToLocal(&args[argc++])) {\n-      return Nothing<bool>();\n-    }\n-  }\n-\n-  // MakeCallback() unneeded because emitWarning is internal code, it calls\n-  // process.emit('warning', ...), but does so on the nextTick.\n-  if (emit_warning.As<Function>()->Call(env->context(),\n-                                        process,\n-                                        argc,\n-                                        args).IsEmpty()) {\n-    return Nothing<bool>();\n-  }\n-  return Just(true);\n-}\n-\n-\n-// Call process.emitWarning(str), fmt is a snprintf() format string\n-Maybe<bool> ProcessEmitWarning(Environment* env, const char* fmt, ...) {\n-  char warning[1024];\n-  va_list ap;\n-\n-  va_start(ap, fmt);\n-  vsnprintf(warning, sizeof(warning), fmt, ap);\n-  va_end(ap);\n-\n-  return ProcessEmitWarningGeneric(env, warning);\n-}\n-\n-\n-Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n-                                          const char* warning,\n-                                          const char* deprecation_code) {\n-  return ProcessEmitWarningGeneric(env,\n-                                   warning,\n-                                   \"DeprecationWarning\",\n-                                   deprecation_code);\n-}\n-\n static void OnMessage(Local<Message> message, Local<Value> error) {\n   Isolate* isolate = message->GetIsolate();\n   switch (message->ErrorLevel()) {\n@@ -1160,19 +1082,14 @@ void RunBeforeExit(Environment* env) {\n void EmitBeforeExit(Environment* env) {\n   HandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(env->context());\n-  Local<Object> process_object = env->process_object();\n-  Local<String> exit_code = env->exit_code_string();\n-  Local<Value> args[] = {\n-    FIXED_ONE_BYTE_STRING(env->isolate(), \"beforeExit\"),\n-    process_object->Get(env->context(), exit_code).ToLocalChecked()\n-        ->ToInteger(env->context()).ToLocalChecked()\n-  };\n-  MakeCallback(env->isolate(),\n-               process_object, \"emit\", arraysize(args), args,\n-               {0, 0}).ToLocalChecked();\n+  Local<Value> exit_code = env->process_object()\n+                               ->Get(env->context(), env->exit_code_string())\n+                               .ToLocalChecked()\n+                               ->ToInteger(env->context())\n+                               .ToLocalChecked();\n+  ProcessEmit(env, \"beforeExit\", exit_code).ToLocalChecked();\n }\n \n-\n int EmitExit(Environment* env) {\n   // process.emit('exit')\n   HandleScope handle_scope(env->isolate());\n@@ -1185,15 +1102,7 @@ int EmitExit(Environment* env) {\n   Local<String> exit_code = env->exit_code_string();\n   int code = process_object->Get(env->context(), exit_code).ToLocalChecked()\n       ->Int32Value(env->context()).ToChecked();\n-\n-  Local<Value> args[] = {\n-    FIXED_ONE_BYTE_STRING(env->isolate(), \"exit\"),\n-    Integer::New(env->isolate(), code)\n-  };\n-\n-  MakeCallback(env->isolate(),\n-               process_object, \"emit\", arraysize(args), args,\n-               {0, 0}).ToLocalChecked();\n+  ProcessEmit(env, \"exit\", Integer::New(env->isolate(), code));\n \n   // Reload exit code, it may be changed by `emit('exit')`\n   return process_object->Get(env->context(), exit_code).ToLocalChecked()"
        },
        {
            "sha": "865223c1634010a556a7b091756606baebd15baf",
            "filename": "src/node_process.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode_process.h",
            "raw_url": "https://github.com/nodejs/node/raw/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode_process.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.h?ref=84f0581d36bddbf7083e82c082275ef562fa8568",
            "patch": "@@ -17,6 +17,15 @@ v8::Local<v8::Object> CreateEnvVarProxy(v8::Local<v8::Context> context,\n // function, it is useful to bypass JavaScript entirely.\n void RawDebug(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n+v8::MaybeLocal<v8::Value> ProcessEmit(Environment* env,\n+                                      const char* event,\n+                                      v8::Local<v8::Value> message);\n+\n+v8::Maybe<bool> ProcessEmitWarningGeneric(Environment* env,\n+                                          const char* warning,\n+                                          const char* type = nullptr,\n+                                          const char* code = nullptr);\n+\n v8::Maybe<bool> ProcessEmitWarning(Environment* env, const char* fmt, ...);\n v8::Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                               const char* warning,"
        },
        {
            "sha": "d9c87173abe3172350802634a6dcc682a46c7c87",
            "filename": "src/node_process_events.cc",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/nodejs/node/blob/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode_process_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/84f0581d36bddbf7083e82c082275ef562fa8568/src%2Fnode_process_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process_events.cc?ref=84f0581d36bddbf7083e82c082275ef562fa8568",
            "patch": "@@ -0,0 +1,103 @@\n+#include <stdarg.h>\n+\n+#include \"env.h\"\n+#include \"node_internals.h\"\n+#include \"node_process.h\"\n+\n+namespace node {\n+using v8::Context;\n+using v8::Function;\n+using v8::HandleScope;\n+using v8::Isolate;\n+using v8::Just;\n+using v8::Local;\n+using v8::Maybe;\n+using v8::MaybeLocal;\n+using v8::NewStringType;\n+using v8::Nothing;\n+using v8::Object;\n+using v8::String;\n+using v8::Value;\n+\n+MaybeLocal<Value> ProcessEmit(Environment* env,\n+                              const char* event,\n+                              Local<Value> message) {\n+  // Send message to enable debug in cluster workers\n+  Local<Object> process = env->process_object();\n+  Isolate* isolate = env->isolate();\n+  Local<Value> argv[] = {OneByteString(isolate, event), message};\n+\n+  return MakeCallback(isolate, process, \"emit\", arraysize(argv), argv, {0, 0});\n+}\n+\n+Maybe<bool> ProcessEmitWarningGeneric(Environment* env,\n+                                      const char* warning,\n+                                      const char* type,\n+                                      const char* code) {\n+  HandleScope handle_scope(env->isolate());\n+  Context::Scope context_scope(env->context());\n+\n+  Local<Object> process = env->process_object();\n+  Local<Value> emit_warning;\n+  if (!process->Get(env->context(), env->emit_warning_string())\n+           .ToLocal(&emit_warning)) {\n+    return Nothing<bool>();\n+  }\n+\n+  if (!emit_warning->IsFunction()) return Just(false);\n+\n+  int argc = 0;\n+  Local<Value> args[3];  // warning, type, code\n+\n+  // The caller has to be able to handle a failure anyway, so we might as well\n+  // do proper error checking for string creation.\n+  if (!String::NewFromUtf8(env->isolate(), warning, NewStringType::kNormal)\n+           .ToLocal(&args[argc++])) {\n+    return Nothing<bool>();\n+  }\n+  if (type != nullptr) {\n+    if (!String::NewFromOneByte(env->isolate(),\n+                                reinterpret_cast<const uint8_t*>(type),\n+                                NewStringType::kNormal)\n+             .ToLocal(&args[argc++])) {\n+      return Nothing<bool>();\n+    }\n+    if (code != nullptr &&\n+        !String::NewFromOneByte(env->isolate(),\n+                                reinterpret_cast<const uint8_t*>(code),\n+                                NewStringType::kNormal)\n+             .ToLocal(&args[argc++])) {\n+      return Nothing<bool>();\n+    }\n+  }\n+\n+  // MakeCallback() unneeded because emitWarning is internal code, it calls\n+  // process.emit('warning', ...), but does so on the nextTick.\n+  if (emit_warning.As<Function>()\n+          ->Call(env->context(), process, argc, args)\n+          .IsEmpty()) {\n+    return Nothing<bool>();\n+  }\n+  return Just(true);\n+}\n+\n+// Call process.emitWarning(str), fmt is a snprintf() format string\n+Maybe<bool> ProcessEmitWarning(Environment* env, const char* fmt, ...) {\n+  char warning[1024];\n+  va_list ap;\n+\n+  va_start(ap, fmt);\n+  vsnprintf(warning, sizeof(warning), fmt, ap);\n+  va_end(ap);\n+\n+  return ProcessEmitWarningGeneric(env, warning);\n+}\n+\n+Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n+                                          const char* warning,\n+                                          const char* deprecation_code) {\n+  return ProcessEmitWarningGeneric(\n+      env, warning, \"DeprecationWarning\", deprecation_code);\n+}\n+\n+}  // namespace node"
        }
    ],
    "stats": {
        "total": 235,
        "additions": 122,
        "deletions": 113
    }
}