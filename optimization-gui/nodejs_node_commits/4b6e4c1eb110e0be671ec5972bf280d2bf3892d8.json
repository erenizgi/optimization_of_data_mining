{
    "author": "lpinca",
    "message": "http: make timeout event work with agent timeout\n\nThe `'timeout'` event is currently not emitted on the `ClientRequest`\ninstance when the socket timeout expires if only the `timeout` option\nof the agent is set. This happens because, under these circumstances,\n`listenSocketTimeout()` is not called.\n\nThis commit fixes the issue by calling it also when only the agent\n`timeout` option is set.\n\nPR-URL: https://github.com/nodejs/node/pull/25488\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "4b6e4c1eb110e0be671ec5972bf280d2bf3892d8",
    "files": [
        {
            "sha": "1ccb289b24791a1c511e9cbb39633e481dc694b7",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/4b6e4c1eb110e0be671ec5972bf280d2bf3892d8/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/4b6e4c1eb110e0be671ec5972bf280d2bf3892d8/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=4b6e4c1eb110e0be671ec5972bf280d2bf3892d8",
            "patch": "@@ -653,7 +653,10 @@ function tickOnSocket(req, socket) {\n   socket.on('end', socketOnEnd);\n   socket.on('close', socketCloseListener);\n \n-  if (req.timeout !== undefined) {\n+  if (\n+    req.timeout !== undefined ||\n+    (req.agent && req.agent.options && req.agent.options.timeout)\n+  ) {\n     listenSocketTimeout(req);\n   }\n   req.emit('socket', socket);"
        },
        {
            "sha": "4fcfc1f1da54b19ecd1bbeb3a73458a1e4fd0d49",
            "filename": "test/parallel/test-http-agent-timeout-option.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/4b6e4c1eb110e0be671ec5972bf280d2bf3892d8/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "raw_url": "https://github.com/nodejs/node/raw/4b6e4c1eb110e0be671ec5972bf280d2bf3892d8/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-timeout-option.js?ref=4b6e4c1eb110e0be671ec5972bf280d2bf3892d8",
            "patch": "@@ -0,0 +1,23 @@\n+'use strict';\n+\n+const { expectsError, mustCall } = require('../common');\n+const { Agent, get } = require('http');\n+\n+// Test that the `'timeout'` event is emitted on the `ClientRequest` instance\n+// when the socket timeout set via the `timeout` option of the `Agent` expires.\n+\n+const request = get({\n+  agent: new Agent({ timeout: 500 }),\n+  // Non-routable IP address to prevent the connection from being established.\n+  host: '192.0.2.1'\n+});\n+\n+request.on('error', expectsError({\n+  type: Error,\n+  code: 'ECONNRESET',\n+  message: 'socket hang up'\n+}));\n+\n+request.on('timeout', mustCall(() => {\n+  request.abort();\n+}));"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 27,
        "deletions": 1
    }
}