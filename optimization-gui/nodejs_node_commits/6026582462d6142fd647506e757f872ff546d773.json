{
    "author": "jasnell",
    "message": "http2: cleanup endStream logic\n\nPR-URL: https://github.com/nodejs/node/pull/24063\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nNote: Landed with one collaborator approval after PR\n      was open for 18 days",
    "sha": "6026582462d6142fd647506e757f872ff546d773",
    "files": [
        {
            "sha": "0302d535c3731d6aaf571ed823a46b3b5f185b65",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 17,
            "deletions": 19,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/6026582462d6142fd647506e757f872ff546d773/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/6026582462d6142fd647506e757f872ff546d773/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=6026582462d6142fd647506e757f872ff546d773",
            "patch": "@@ -2005,11 +2005,11 @@ class Http2Stream extends Duplex {\n function processHeaders(headers) {\n   assertIsObject(headers, 'headers');\n   headers = Object.assign(Object.create(null), headers);\n-  if (headers[HTTP2_HEADER_STATUS] == null)\n-    headers[HTTP2_HEADER_STATUS] = HTTP_STATUS_OK;\n+  const statusCode =\n+    headers[HTTP2_HEADER_STATUS] =\n+      headers[HTTP2_HEADER_STATUS] | 0 || HTTP_STATUS_OK;\n   headers[HTTP2_HEADER_DATE] = utcDate();\n \n-  const statusCode = headers[HTTP2_HEADER_STATUS] |= 0;\n   // This is intentionally stricter than the HTTP/1 implementation, which\n   // allows values between 100 and 999 (inclusive) in order to allow for\n   // backwards compatibility with non-spec compliant code. With HTTP/2,\n@@ -2342,26 +2342,22 @@ class ServerHttp2Stream extends Http2Stream {\n     }\n \n     headers = processHeaders(headers);\n-    const statusCode = headers[HTTP2_HEADER_STATUS] |= 0;\n-\n-    // Payload/DATA frames are not permitted in these cases so set\n-    // the options.endStream option to true so that the underlying\n-    // bits do not attempt to send any.\n-    if (statusCode === HTTP_STATUS_NO_CONTENT ||\n-        statusCode === HTTP_STATUS_RESET_CONTENT ||\n-        statusCode === HTTP_STATUS_NOT_MODIFIED ||\n-        this.headRequest === true) {\n-      options.endStream = true;\n-    }\n-\n     const headersList = mapToHeaders(headers, assertValidPseudoHeaderResponse);\n     this[kSentHeaders] = headers;\n \n     state.flags |= STREAM_FLAGS_HEADERS_SENT;\n \n-    // Close the writable side if the endStream option is set\n-    if (options.endStream)\n+    // Close the writable side if the endStream option is set or status\n+    // is one of known codes with no payload, or it's a head request\n+    const statusCode = headers[HTTP2_HEADER_STATUS] | 0;\n+    if (!!options.endStream ||\n+        statusCode === HTTP_STATUS_NO_CONTENT ||\n+        statusCode === HTTP_STATUS_RESET_CONTENT ||\n+        statusCode === HTTP_STATUS_NOT_MODIFIED ||\n+        this.headRequest === true) {\n+      options.endStream = true;\n       this.end();\n+    }\n \n     const ret = this[kHandle].respond(headersList, streamOptions);\n     if (ret < 0)\n@@ -2414,7 +2410,8 @@ class ServerHttp2Stream extends Http2Stream {\n     // Payload/DATA frames are not permitted in these cases\n     if (statusCode === HTTP_STATUS_NO_CONTENT ||\n         statusCode === HTTP_STATUS_RESET_CONTENT ||\n-        statusCode === HTTP_STATUS_NOT_MODIFIED) {\n+        statusCode === HTTP_STATUS_NOT_MODIFIED ||\n+        this.headRequest) {\n       throw new ERR_HTTP2_PAYLOAD_FORBIDDEN(statusCode);\n     }\n \n@@ -2475,7 +2472,8 @@ class ServerHttp2Stream extends Http2Stream {\n     // Payload/DATA frames are not permitted in these cases\n     if (statusCode === HTTP_STATUS_NO_CONTENT ||\n         statusCode === HTTP_STATUS_RESET_CONTENT ||\n-        statusCode === HTTP_STATUS_NOT_MODIFIED) {\n+        statusCode === HTTP_STATUS_NOT_MODIFIED ||\n+        this.headRequest) {\n       throw new ERR_HTTP2_PAYLOAD_FORBIDDEN(statusCode);\n     }\n "
        }
    ],
    "stats": {
        "total": 36,
        "additions": 17,
        "deletions": 19
    }
}