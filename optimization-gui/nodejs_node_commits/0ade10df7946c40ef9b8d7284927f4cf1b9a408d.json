{
    "author": "tniessen",
    "message": "crypto: hide native handles from JS modules\n\nPR-URL: https://github.com/nodejs/node/pull/22747\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Vladimir de Turckheim <vlad2t@hotmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
    "files": [
        {
            "sha": "9c983319d3379f6c7e3d4286a4a8e210ccf5e491",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -2184,6 +2184,22 @@ The [Legacy URL API][] is deprecated. This includes [`url.format()`][],\n [`url.parse()`][], [`url.resolve()`][], and the [legacy `urlObject`][]. Please\n use the [WHATWG URL API][] instead.\n \n+<a id=\"DEP00XX\"></a>\n+### DEP00XX: Native crypto handles\n+<!-- YAML\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22747\n+    description: Runtime deprecation.\n+-->\n+\n+Type: Runtime\n+\n+Previous versions of Node.js exposed handles to internal native objects through\n+the `_handle` property of the `Cipher`, `Decipher`, `DiffieHellman`,\n+`DiffieHellmanGroup`, `ECDH`, `Hash`, `Hmac`, `Sign`, and `Verify` classes.\n+Using the `_handle` property to access the native object is deprecated because\n+improper use of the native object can lead to crashing the application.\n \n [`--pending-deprecation`]: cli.html#cli_pending_deprecation\n [`Buffer.allocUnsafeSlow(size)`]: buffer.html#buffer_class_method_buffer_allocunsafeslow_size"
        },
        {
            "sha": "51dd3cea86606d9dd3e3f39b8023ce8a984e0b1d",
            "filename": "lib/internal/crypto/cipher.js",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fcipher.js?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -14,6 +14,8 @@ const { validateString } = require('internal/validators');\n \n const {\n   getDefaultEncoding,\n+  kHandle,\n+  legacyNativeHandle,\n   toBuf\n } = require('internal/crypto/util');\n \n@@ -73,11 +75,11 @@ function getUIntOption(options, key) {\n function createCipherBase(cipher, credential, options, decipher, iv) {\n   const authTagLength = getUIntOption(options, 'authTagLength');\n \n-  this._handle = new CipherBase(decipher);\n+  legacyNativeHandle(this, new CipherBase(decipher));\n   if (iv === undefined) {\n-    this._handle.init(cipher, credential, authTagLength);\n+    this[kHandle].init(cipher, credential, authTagLength);\n   } else {\n-    this._handle.initiv(cipher, credential, iv, authTagLength);\n+    this[kHandle].initiv(cipher, credential, iv, authTagLength);\n   }\n   this._decoder = null;\n \n@@ -130,13 +132,13 @@ function Cipher(cipher, password, options) {\n inherits(Cipher, LazyTransform);\n \n Cipher.prototype._transform = function _transform(chunk, encoding, callback) {\n-  this.push(this._handle.update(chunk, encoding));\n+  this.push(this[kHandle].update(chunk, encoding));\n   callback();\n };\n \n Cipher.prototype._flush = function _flush(callback) {\n   try {\n-    this.push(this._handle.final());\n+    this.push(this[kHandle].final());\n   } catch (e) {\n     callback(e);\n     return;\n@@ -157,7 +159,7 @@ Cipher.prototype.update = function update(data, inputEncoding, outputEncoding) {\n     );\n   }\n \n-  const ret = this._handle.update(data, inputEncoding);\n+  const ret = this[kHandle].update(data, inputEncoding);\n \n   if (outputEncoding && outputEncoding !== 'buffer') {\n     this._decoder = getDecoder(this._decoder, outputEncoding);\n@@ -170,7 +172,7 @@ Cipher.prototype.update = function update(data, inputEncoding, outputEncoding) {\n \n Cipher.prototype.final = function final(outputEncoding) {\n   outputEncoding = outputEncoding || getDefaultEncoding();\n-  const ret = this._handle.final();\n+  const ret = this[kHandle].final();\n \n   if (outputEncoding && outputEncoding !== 'buffer') {\n     this._decoder = getDecoder(this._decoder, outputEncoding);\n@@ -182,13 +184,13 @@ Cipher.prototype.final = function final(outputEncoding) {\n \n \n Cipher.prototype.setAutoPadding = function setAutoPadding(ap) {\n-  if (!this._handle.setAutoPadding(!!ap))\n+  if (!this[kHandle].setAutoPadding(!!ap))\n     throw new ERR_CRYPTO_INVALID_STATE('setAutoPadding');\n   return this;\n };\n \n Cipher.prototype.getAuthTag = function getAuthTag() {\n-  const ret = this._handle.getAuthTag();\n+  const ret = this[kHandle].getAuthTag();\n   if (ret === undefined)\n     throw new ERR_CRYPTO_INVALID_STATE('getAuthTag');\n   return ret;\n@@ -201,7 +203,7 @@ function setAuthTag(tagbuf) {\n                                    ['Buffer', 'TypedArray', 'DataView'],\n                                    tagbuf);\n   }\n-  if (!this._handle.setAuthTag(tagbuf))\n+  if (!this[kHandle].setAuthTag(tagbuf))\n     throw new ERR_CRYPTO_INVALID_STATE('setAuthTag');\n   return this;\n }\n@@ -221,7 +223,7 @@ Cipher.prototype.setAAD = function setAAD(aadbuf, options) {\n   }\n \n   const plaintextLength = getUIntOption(options, 'plaintextLength');\n-  if (!this._handle.setAAD(aadbuf, plaintextLength))\n+  if (!this[kHandle].setAAD(aadbuf, plaintextLength))\n     throw new ERR_CRYPTO_INVALID_STATE('setAAD');\n   return this;\n };"
        },
        {
            "sha": "02142d4b1f0b2d5a5e38506e07fe84336d64c6fd",
            "filename": "lib/internal/crypto/diffiehellman.js",
            "status": "modified",
            "additions": 17,
            "deletions": 15,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fdiffiehellman.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fdiffiehellman.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fdiffiehellman.js?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -10,6 +10,8 @@ const { validateString } = require('internal/validators');\n const { isArrayBufferView } = require('internal/util/types');\n const {\n   getDefaultEncoding,\n+  kHandle,\n+  legacyNativeHandle,\n   toBuf\n } = require('internal/crypto/util');\n const {\n@@ -59,10 +61,10 @@ function DiffieHellman(sizeOrKey, keyEncoding, generator, genEncoding) {\n   else if (typeof generator !== 'number')\n     generator = toBuf(generator, genEncoding);\n \n-  this._handle = new _DiffieHellman(sizeOrKey, generator);\n+  legacyNativeHandle(this, new _DiffieHellman(sizeOrKey, generator));\n   Object.defineProperty(this, 'verifyError', {\n     enumerable: true,\n-    value: this._handle.verifyError,\n+    value: this[kHandle].verifyError,\n     writable: false\n   });\n }\n@@ -71,10 +73,10 @@ function DiffieHellman(sizeOrKey, keyEncoding, generator, genEncoding) {\n function DiffieHellmanGroup(name) {\n   if (!(this instanceof DiffieHellmanGroup))\n     return new DiffieHellmanGroup(name);\n-  this._handle = new _DiffieHellmanGroup(name);\n+  legacyNativeHandle(this, new _DiffieHellmanGroup(name));\n   Object.defineProperty(this, 'verifyError', {\n     enumerable: true,\n-    value: this._handle.verifyError,\n+    value: this[kHandle].verifyError,\n     writable: false\n   });\n }\n@@ -85,7 +87,7 @@ DiffieHellmanGroup.prototype.generateKeys =\n     dhGenerateKeys;\n \n function dhGenerateKeys(encoding) {\n-  const keys = this._handle.generateKeys();\n+  const keys = this[kHandle].generateKeys();\n   encoding = encoding || getDefaultEncoding();\n   return encode(keys, encoding);\n }\n@@ -99,7 +101,7 @@ function dhComputeSecret(key, inEnc, outEnc) {\n   const encoding = getDefaultEncoding();\n   inEnc = inEnc || encoding;\n   outEnc = outEnc || encoding;\n-  const ret = this._handle.computeSecret(toBuf(key, inEnc));\n+  const ret = this[kHandle].computeSecret(toBuf(key, inEnc));\n   if (typeof ret === 'string')\n     throw new ERR_CRYPTO_ECDH_INVALID_PUBLIC_KEY();\n   return encode(ret, outEnc);\n@@ -111,7 +113,7 @@ DiffieHellmanGroup.prototype.getPrime =\n     dhGetPrime;\n \n function dhGetPrime(encoding) {\n-  const prime = this._handle.getPrime();\n+  const prime = this[kHandle].getPrime();\n   encoding = encoding || getDefaultEncoding();\n   return encode(prime, encoding);\n }\n@@ -122,7 +124,7 @@ DiffieHellmanGroup.prototype.getGenerator =\n     dhGetGenerator;\n \n function dhGetGenerator(encoding) {\n-  const generator = this._handle.getGenerator();\n+  const generator = this[kHandle].getGenerator();\n   encoding = encoding || getDefaultEncoding();\n   return encode(generator, encoding);\n }\n@@ -133,7 +135,7 @@ DiffieHellmanGroup.prototype.getPublicKey =\n     dhGetPublicKey;\n \n function dhGetPublicKey(encoding) {\n-  const key = this._handle.getPublicKey();\n+  const key = this[kHandle].getPublicKey();\n   encoding = encoding || getDefaultEncoding();\n   return encode(key, encoding);\n }\n@@ -144,22 +146,22 @@ DiffieHellmanGroup.prototype.getPrivateKey =\n     dhGetPrivateKey;\n \n function dhGetPrivateKey(encoding) {\n-  const key = this._handle.getPrivateKey();\n+  const key = this[kHandle].getPrivateKey();\n   encoding = encoding || getDefaultEncoding();\n   return encode(key, encoding);\n }\n \n \n DiffieHellman.prototype.setPublicKey = function setPublicKey(key, encoding) {\n   encoding = encoding || getDefaultEncoding();\n-  this._handle.setPublicKey(toBuf(key, encoding));\n+  this[kHandle].setPublicKey(toBuf(key, encoding));\n   return this;\n };\n \n \n DiffieHellman.prototype.setPrivateKey = function setPrivateKey(key, encoding) {\n   encoding = encoding || getDefaultEncoding();\n-  this._handle.setPrivateKey(toBuf(key, encoding));\n+  this[kHandle].setPrivateKey(toBuf(key, encoding));\n   return this;\n };\n \n@@ -169,7 +171,7 @@ function ECDH(curve) {\n     return new ECDH(curve);\n \n   validateString(curve, 'curve');\n-  this._handle = new _ECDH(curve);\n+  legacyNativeHandle(this, new _ECDH(curve));\n }\n \n ECDH.prototype.computeSecret = DiffieHellman.prototype.computeSecret;\n@@ -178,14 +180,14 @@ ECDH.prototype.setPublicKey = DiffieHellman.prototype.setPublicKey;\n ECDH.prototype.getPrivateKey = DiffieHellman.prototype.getPrivateKey;\n \n ECDH.prototype.generateKeys = function generateKeys(encoding, format) {\n-  this._handle.generateKeys();\n+  this[kHandle].generateKeys();\n \n   return this.getPublicKey(encoding, format);\n };\n \n ECDH.prototype.getPublicKey = function getPublicKey(encoding, format) {\n   const f = getFormat(format);\n-  const key = this._handle.getPublicKey(f);\n+  const key = this[kHandle].getPublicKey(f);\n   encoding = encoding || getDefaultEncoding();\n   return encode(key, encoding);\n };"
        },
        {
            "sha": "6522a19509f3537fc95c3e0804801e9d11b716c2",
            "filename": "lib/internal/crypto/hash.js",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fhash.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fhash.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fhash.js?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -7,6 +7,8 @@ const {\n \n const {\n   getDefaultEncoding,\n+  kHandle,\n+  legacyNativeHandle,\n   toBuf\n } = require('internal/crypto/util');\n \n@@ -30,7 +32,7 @@ function Hash(algorithm, options) {\n   if (!(this instanceof Hash))\n     return new Hash(algorithm, options);\n   validateString(algorithm, 'algorithm');\n-  this._handle = new _Hash(algorithm);\n+  legacyNativeHandle(this, new _Hash(algorithm));\n   this[kState] = {\n     [kFinalized]: false\n   };\n@@ -40,12 +42,12 @@ function Hash(algorithm, options) {\n inherits(Hash, LazyTransform);\n \n Hash.prototype._transform = function _transform(chunk, encoding, callback) {\n-  this._handle.update(chunk, encoding);\n+  this[kHandle].update(chunk, encoding);\n   callback();\n };\n \n Hash.prototype._flush = function _flush(callback) {\n-  this.push(this._handle.digest());\n+  this.push(this[kHandle].digest());\n   callback();\n };\n \n@@ -59,7 +61,7 @@ Hash.prototype.update = function update(data, encoding) {\n                                    ['string', 'TypedArray', 'DataView'], data);\n   }\n \n-  if (!this._handle.update(data, encoding || getDefaultEncoding()))\n+  if (!this[kHandle].update(data, encoding || getDefaultEncoding()))\n     throw new ERR_CRYPTO_HASH_UPDATE_FAILED();\n   return this;\n };\n@@ -74,7 +76,7 @@ Hash.prototype.digest = function digest(outputEncoding) {\n     throw new ERR_CRYPTO_HASH_DIGEST_NO_UTF16();\n \n   // Explicit conversion for backward compatibility.\n-  const ret = this._handle.digest(`${outputEncoding}`);\n+  const ret = this[kHandle].digest(`${outputEncoding}`);\n   state[kFinalized] = true;\n   return ret;\n };\n@@ -88,8 +90,8 @@ function Hmac(hmac, key, options) {\n     throw new ERR_INVALID_ARG_TYPE('key',\n                                    ['string', 'TypedArray', 'DataView'], key);\n   }\n-  this._handle = new _Hmac();\n-  this._handle.init(hmac, toBuf(key));\n+  legacyNativeHandle(this, new _Hmac());\n+  this[kHandle].init(hmac, toBuf(key));\n   this[kState] = {\n     [kFinalized]: false\n   };\n@@ -112,7 +114,7 @@ Hmac.prototype.digest = function digest(outputEncoding) {\n   }\n \n   // Explicit conversion for backward compatibility.\n-  const ret = this._handle.digest(`${outputEncoding}`);\n+  const ret = this[kHandle].digest(`${outputEncoding}`);\n   state[kFinalized] = true;\n   return ret;\n };"
        },
        {
            "sha": "5a1787d00f3639712974238c28089308525e3f7c",
            "filename": "lib/internal/crypto/sig.js",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fsig.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Fsig.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fsig.js?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -13,6 +13,8 @@ const {\n } = process.binding('constants').crypto;\n const {\n   getDefaultEncoding,\n+  kHandle,\n+  legacyNativeHandle,\n   toBuf,\n   validateArrayBufferView,\n } = require('internal/crypto/util');\n@@ -23,8 +25,8 @@ function Sign(algorithm, options) {\n   if (!(this instanceof Sign))\n     return new Sign(algorithm, options);\n   validateString(algorithm, 'algorithm');\n-  this._handle = new _Sign();\n-  this._handle.init(algorithm);\n+  legacyNativeHandle(this, new _Sign());\n+  this[kHandle].init(algorithm);\n \n   Writable.call(this, options);\n }\n@@ -40,7 +42,7 @@ Sign.prototype.update = function update(data, encoding) {\n   encoding = encoding || getDefaultEncoding();\n   data = validateArrayBufferView(toBuf(data, encoding),\n                                  'data');\n-  this._handle.update(data);\n+  this[kHandle].update(data);\n   return this;\n };\n \n@@ -78,7 +80,7 @@ Sign.prototype.sign = function sign(options, encoding) {\n \n   key = validateArrayBufferView(key, 'key');\n \n-  var ret = this._handle.sign(key, passphrase, rsaPadding, pssSaltLength);\n+  var ret = this[kHandle].sign(key, passphrase, rsaPadding, pssSaltLength);\n \n   encoding = encoding || getDefaultEncoding();\n   if (encoding && encoding !== 'buffer')\n@@ -92,8 +94,8 @@ function Verify(algorithm, options) {\n   if (!(this instanceof Verify))\n     return new Verify(algorithm, options);\n   validateString(algorithm, 'algorithm');\n-  this._handle = new _Verify();\n-  this._handle.init(algorithm);\n+  legacyNativeHandle(this, new _Verify());\n+  this[kHandle].init(algorithm);\n \n   Writable.call(this, options);\n }\n@@ -117,7 +119,7 @@ Verify.prototype.verify = function verify(options, signature, sigEncoding) {\n   signature = validateArrayBufferView(toBuf(signature, sigEncoding),\n                                       'signature');\n \n-  return this._handle.verify(key, signature, rsaPadding, pssSaltLength);\n+  return this[kHandle].verify(key, signature, rsaPadding, pssSaltLength);\n };\n \n module.exports = {"
        },
        {
            "sha": "7ff25be186ba4a2c31463e043691e89bfd11237c",
            "filename": "lib/internal/crypto/util.js",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ade10df7946c40ef9b8d7284927f4cf1b9a408d/lib%2Finternal%2Fcrypto%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Futil.js?ref=0ade10df7946c40ef9b8d7284927f4cf1b9a408d",
            "patch": "@@ -22,12 +22,28 @@ const { validateString } = require('internal/validators');\n const { Buffer } = require('buffer');\n const {\n   cachedResult,\n+  deprecate,\n   filterDuplicateStrings\n } = require('internal/util');\n const {\n   isArrayBufferView\n } = require('internal/util/types');\n \n+const kHandle = Symbol('kHandle');\n+\n+function legacyNativeHandle(obj, handle) {\n+  obj[kHandle] = handle;\n+  Object.defineProperty(obj, '_handle', {\n+    get: deprecate(() => handle,\n+                   `${obj.constructor.name}._handle is deprecated. Use the ` +\n+                   'public API instead.', 'DEP00XX'),\n+    set: deprecate((h) => obj[kHandle] = handle = h,\n+                   `${obj.constructor.name}._handle is deprecated. Use the ` +\n+                   'public API instead.', 'DEP00XX'),\n+    enumerable: false\n+  });\n+}\n+\n var defaultEncoding = 'buffer';\n \n function setDefaultEncoding(val) {\n@@ -101,6 +117,8 @@ module.exports = {\n   getCurves,\n   getDefaultEncoding,\n   getHashes,\n+  kHandle,\n+  legacyNativeHandle,\n   setDefaultEncoding,\n   setEngine,\n   timingSafeEqual,"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 83,
        "deletions": 41
    }
}