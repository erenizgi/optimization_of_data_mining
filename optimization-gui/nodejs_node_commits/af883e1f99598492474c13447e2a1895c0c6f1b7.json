{
    "author": "tkamenoko",
    "message": "child_process: fix switches for alternative shells on Windows\n\nOn Windows, normalizeSpawnArguments set \"/d /s /c\" for any shells.\nIt cause exec and other methods are limited to cmd.exe as a shell.\n\nPowershell and git-bash are often used instead of cmd.exe,\nand they can recieve \"-c\" switch like unix shells.\nSo normalizeSpawnArguments is changed to set \"/d /s /c\" for cmd.exe,\nand \"-c\" for others.\n\nFixes: https://github.com/nodejs/node/issues/21905\nPR-URL: https://github.com/nodejs/node/pull/21943\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jo√£o Reis <reis@janeasystems.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "af883e1f99598492474c13447e2a1895c0c6f1b7",
    "files": [
        {
            "sha": "9cee76c02ea0f97e56103287a7e603a7f0711d70",
            "filename": "doc/api/child_process.md",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/af883e1f99598492474c13447e2a1895c0c6f1b7/doc%2Fapi%2Fchild_process.md",
            "raw_url": "https://github.com/nodejs/node/raw/af883e1f99598492474c13447e2a1895c0c6f1b7/doc%2Fapi%2Fchild_process.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fchild_process.md?ref=af883e1f99598492474c13447e2a1895c0c6f1b7",
            "patch": "@@ -415,7 +415,7 @@ changes:\n     [Default Windows Shell][]. **Default:** `false` (no shell).\n   * `windowsVerbatimArguments` {boolean} No quoting or escaping of arguments is\n     done on Windows. Ignored on Unix. This is set to `true` automatically\n-    when `shell` is specified. **Default:** `false`.\n+    when `shell` is specified and is CMD. **Default:** `false`.\n   * `windowsHide` {boolean} Hide the subprocess console window that would\n     normally be created on Windows systems. **Default:** `true`.\n * Returns: {ChildProcess}\n@@ -867,7 +867,7 @@ changes:\n     [Default Windows Shell][]. **Default:** `false` (no shell).\n   * `windowsVerbatimArguments` {boolean} No quoting or escaping of arguments is\n     done on Windows. Ignored on Unix. This is set to `true` automatically\n-    when `shell` is specified. **Default:** `false`.\n+    when `shell` is specified and is CMD. **Default:** `false`.\n   * `windowsHide` {boolean} Hide the subprocess console window that would\n     normally be created on Windows systems. **Default:** `true`.\n * Returns: {Object}\n@@ -1432,8 +1432,9 @@ to `stdout` although there are only 4 characters.\n \n ## Shell Requirements\n \n-The shell should understand the `-c` switch on UNIX or `/d /s /c` on Windows.\n-On Windows, command line parsing should be compatible with `'cmd.exe'`.\n+The shell should understand the `-c` switch. If the shell is `'cmd.exe'`, it\n+should understand the `/d /s /c` switches and command line parsing should be\n+compatible.\n \n ## Default Windows Shell\n "
        },
        {
            "sha": "2962f5cf0599af157f833326d596357f978109ac",
            "filename": "lib/child_process.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/af883e1f99598492474c13447e2a1895c0c6f1b7/lib%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/af883e1f99598492474c13447e2a1895c0c6f1b7/lib%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fchild_process.js?ref=af883e1f99598492474c13447e2a1895c0c6f1b7",
            "patch": "@@ -469,14 +469,19 @@ function normalizeSpawnArguments(file, args, options) {\n \n   if (options.shell) {\n     const command = [file].concat(args).join(' ');\n-\n+    // Set the shell, switches, and commands.\n     if (process.platform === 'win32') {\n       if (typeof options.shell === 'string')\n         file = options.shell;\n       else\n         file = process.env.comspec || 'cmd.exe';\n-      args = ['/d', '/s', '/c', `\"${command}\"`];\n-      options.windowsVerbatimArguments = true;\n+      // '/d /s /c' is used only for cmd.exe.\n+      if (/^(?:.*\\\\)?cmd(?:\\.exe)?$/i.test(file)) {\n+        args = ['/d', '/s', '/c', `\"${command}\"`];\n+        options.windowsVerbatimArguments = true;\n+      } else {\n+        args = ['-c', command];\n+      }\n     } else {\n       if (typeof options.shell === 'string')\n         file = options.shell;"
        },
        {
            "sha": "8cdd03d7e510d5588d35fd9bf1f7509dfeb27cbc",
            "filename": "test/parallel/test-child-process-exec-any-shells-windows.js",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/af883e1f99598492474c13447e2a1895c0c6f1b7/test%2Fparallel%2Ftest-child-process-exec-any-shells-windows.js",
            "raw_url": "https://github.com/nodejs/node/raw/af883e1f99598492474c13447e2a1895c0c6f1b7/test%2Fparallel%2Ftest-child-process-exec-any-shells-windows.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-exec-any-shells-windows.js?ref=af883e1f99598492474c13447e2a1895c0c6f1b7",
            "patch": "@@ -0,0 +1,68 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+\n+// This test is only relevant on Windows.\n+if (!common.isWindows)\n+  common.skip('Windows specific test.');\n+\n+// This test ensures that child_process.exec can work with any shells.\n+\n+tmpdir.refresh();\n+const tmpPath = `${tmpdir.path}\\\\path with spaces`;\n+fs.mkdirSync(tmpPath);\n+\n+const test = (shell) => {\n+  cp.exec('echo foo bar', { shell: shell },\n+          common.mustCall((error, stdout, stderror) => {\n+            assert.ok(!error && !stderror);\n+            assert.ok(stdout.includes('foo') && stdout.includes('bar'));\n+          }));\n+};\n+const testCopy = (shellName, shellPath) => {\n+  // Copy the executable to a path with spaces, to ensure there are no issues\n+  // related to quoting of argv0\n+  const copyPath = `${tmpPath}\\\\${shellName}`;\n+  fs.copyFileSync(shellPath, copyPath);\n+  test(copyPath);\n+};\n+\n+const system32 = `${process.env.SystemRoot}\\\\System32`;\n+\n+// Test CMD\n+test(true);\n+test('cmd');\n+testCopy('cmd.exe', `${system32}\\\\cmd.exe`);\n+test('cmd.exe');\n+test('CMD');\n+\n+// Test PowerShell\n+test('powershell');\n+testCopy('powershell.exe',\n+         `${system32}\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe`);\n+fs.writeFile(`${tmpPath}\\\\test file`, 'Test', common.mustCall((err) => {\n+  assert.ifError(err);\n+  cp.exec(`Get-ChildItem \"${tmpPath}\" | Select-Object -Property Name`,\n+          { shell: 'PowerShell' },\n+          common.mustCall((error, stdout, stderror) => {\n+            assert.ok(!error && !stderror);\n+            assert.ok(stdout.includes(\n+              'test file'));\n+          }));\n+}));\n+\n+// Test Bash (from WSL and Git), if available\n+cp.exec('where bash', common.mustCall((error, stdout) => {\n+  if (error) {\n+    return;\n+  }\n+  const lines = stdout.trim().split(/[\\r\\n]+/g);\n+  for (let i = 0; i < lines.length; ++i) {\n+    const bashPath = lines[i].trim();\n+    test(bashPath);\n+    testCopy(`bash_${i}.exe`, bashPath);\n+  }\n+}));"
        },
        {
            "sha": "6f7c0ec0f14a26105cc73dfa9435d4bcb6faf2cb",
            "filename": "test/parallel/test-child-process-spawnsync-shell.js",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/af883e1f99598492474c13447e2a1895c0c6f1b7/test%2Fparallel%2Ftest-child-process-spawnsync-shell.js",
            "raw_url": "https://github.com/nodejs/node/raw/af883e1f99598492474c13447e2a1895c0c6f1b7/test%2Fparallel%2Ftest-child-process-spawnsync-shell.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-spawnsync-shell.js?ref=af883e1f99598492474c13447e2a1895c0c6f1b7",
            "patch": "@@ -54,11 +54,12 @@ assert.strictEqual(env.stdout.toString().trim(), 'buzz');\n \n   function test(testPlatform, shell, shellOutput) {\n     platform = testPlatform;\n-\n+    const isCmd = /^(?:.*\\\\)?cmd(?:\\.exe)?$/i.test(shellOutput);\n     const cmd = 'not_a_real_command';\n-    const shellFlags = platform === 'win32' ? ['/d', '/s', '/c'] : ['-c'];\n-    const outputCmd = platform === 'win32' ? `\"${cmd}\"` : cmd;\n-    const windowsVerbatim = platform === 'win32' ? true : undefined;\n+\n+    const shellFlags = isCmd ? ['/d', '/s', '/c'] : ['-c'];\n+    const outputCmd = isCmd ? `\"${cmd}\"` : cmd;\n+    const windowsVerbatim = isCmd ? true : undefined;\n     internalCp.spawnSync = common.mustCall(function(opts) {\n       assert.strictEqual(opts.file, shellOutput);\n       assert.deepStrictEqual(opts.args,"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 86,
        "deletions": 11
    }
}