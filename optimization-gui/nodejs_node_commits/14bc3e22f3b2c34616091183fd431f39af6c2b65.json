{
    "author": "AndreasMadsen",
    "message": "domain: runtime deprecate MakeCallback\n\nUsers of MakeCallback that adds the domain property to carry context,\nshould start using the async_context variant of MakeCallback or the\nAsyncResource class.\n\nPR-URL: https://github.com/nodejs/node/pull/17417\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "14bc3e22f3b2c34616091183fd431f39af6c2b65",
    "files": [
        {
            "sha": "1f5809624afe95f481d9677055169dc51ab14ff2",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/14bc3e22f3b2c34616091183fd431f39af6c2b65/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/14bc3e22f3b2c34616091183fd431f39af6c2b65/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=14bc3e22f3b2c34616091183fd431f39af6c2b65",
            "patch": "@@ -871,6 +871,15 @@ Type: Runtime\n \n `timers.unenroll()` is deprecated. Please use the publicly documented [`clearTimeout()`][] or [`clearInterval()`][] instead.\n \n+<a id=\"DEP0097\"></a>\n+### DEP0097: MakeCallback with domain property\n+\n+Type: Runtime\n+\n+Users of `MakeCallback` that add the `domain` property to carry context,\n+should start using the `async_context` variant of `MakeCallback` or\n+`CallbackScope`, or the the high-level `AsyncResource` class.\n+\n [`--pending-deprecation`]: cli.html#cli_pending_deprecation\n [`Buffer.allocUnsafeSlow(size)`]: buffer.html#buffer_class_method_buffer_allocunsafeslow_size\n [`Buffer.from(array)`]: buffer.html#buffer_class_method_buffer_from_array"
        },
        {
            "sha": "be109c9ce056bd864b286347a05bdc1fa001f1af",
            "filename": "lib/domain.js",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/14bc3e22f3b2c34616091183fd431f39af6c2b65/lib%2Fdomain.js",
            "raw_url": "https://github.com/nodejs/node/raw/14bc3e22f3b2c34616091183fd431f39af6c2b65/lib%2Fdomain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdomain.js?ref=14bc3e22f3b2c34616091183fd431f39af6c2b65",
            "patch": "@@ -94,13 +94,29 @@ process.setUncaughtExceptionCaptureCallback = function(fn) {\n   throw err;\n };\n \n+\n+let sendMakeCallbackDeprecation = false;\n+function emitMakeCallbackDeprecation() {\n+  if (!sendMakeCallbackDeprecation) {\n+    process.emitWarning(\n+      'Using a domain property in MakeCallback is deprecated. Use the ' +\n+      'async_context variant of MakeCallback or the AsyncResource class ' +\n+      'instead.', 'DeprecationWarning', 'DEP0097');\n+    sendMakeCallbackDeprecation = true;\n+  }\n+}\n+\n function topLevelDomainCallback(cb, ...args) {\n   const domain = this.domain;\n+  if (exports.active && domain)\n+    emitMakeCallbackDeprecation();\n+\n   if (domain)\n     domain.enter();\n   const ret = Reflect.apply(cb, this, args);\n   if (domain)\n     domain.exit();\n+\n   return ret;\n }\n "
        },
        {
            "sha": "c42166c745527702d2f9e99d5b633452159a01c7",
            "filename": "test/addons/make-callback-domain-warning/binding.cc",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.cc?ref=14bc3e22f3b2c34616091183fd431f39af6c2b65",
            "patch": "@@ -0,0 +1,31 @@\n+#include \"node.h\"\n+#include \"v8.h\"\n+\n+#include <assert.h>\n+\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::Object;\n+using v8::Value;\n+\n+namespace {\n+\n+void MakeCallback(const FunctionCallbackInfo<Value>& args) {\n+  assert(args[0]->IsObject());\n+  assert(args[1]->IsFunction());\n+  Isolate* isolate = args.GetIsolate();\n+  Local<Object> recv = args[0].As<Object>();\n+  Local<Function> method = args[1].As<Function>();\n+\n+  node::MakeCallback(isolate, recv, method, 0, nullptr);\n+}\n+\n+void Initialize(Local<Object> exports) {\n+  NODE_SET_METHOD(exports, \"makeCallback\", MakeCallback);\n+}\n+\n+}  // namespace\n+\n+NODE_MODULE(NODE_GYP_MODULE_NAME, Initialize)"
        },
        {
            "sha": "7ede63d94a0d77635ff78b8ad2d0079216eefa1a",
            "filename": "test/addons/make-callback-domain-warning/binding.gyp",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback-domain-warning%2Fbinding.gyp?ref=14bc3e22f3b2c34616091183fd431f39af6c2b65",
            "patch": "@@ -0,0 +1,9 @@\n+{\n+  'targets': [\n+    {\n+      'target_name': 'binding',\n+      'defines': [ 'V8_DEPRECATION_WARNINGS=1' ],\n+      'sources': [ 'binding.cc' ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "2ea3c3f3d14b2bde7a95b919ab84f359573c6e81",
            "filename": "test/addons/make-callback-domain-warning/test.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/14bc3e22f3b2c34616091183fd431f39af6c2b65/test%2Faddons%2Fmake-callback-domain-warning%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback-domain-warning%2Ftest.js?ref=14bc3e22f3b2c34616091183fd431f39af6c2b65",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+const common = require('../../common');\n+const assert = require('assert');\n+const domain = require('domain');\n+const binding = require(`./build/${common.buildType}/binding`);\n+\n+function makeCallback(object, cb) {\n+  binding.makeCallback(object, () => setImmediate(cb));\n+}\n+\n+let latestWarning = null;\n+process.on('warning', function(warning) {\n+  latestWarning = warning;\n+});\n+\n+const d = domain.create();\n+\n+// When domain is disabled, no warning will be emitted\n+makeCallback({ domain: d }, common.mustCall(function() {\n+  assert.strictEqual(latestWarning, null);\n+\n+  d.run(common.mustCall(function() {\n+    // No warning will be emitted when no domain property is applied\n+    makeCallback({}, common.mustCall(function() {\n+      assert.strictEqual(latestWarning, null);\n+\n+      // Warning is emitted when domain property is used and domain is enabled\n+      makeCallback({ domain: d }, common.mustCall(function() {\n+        assert.strictEqual(latestWarning.name, 'DeprecationWarning');\n+        assert.strictEqual(latestWarning.code, 'DEP0097');\n+      }));\n+    }));\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 100,
        "deletions": 0
    }
}