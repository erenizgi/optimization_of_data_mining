{
    "author": "bzoz",
    "message": "build, win: make LTCG optional\n\nDisables Link Time Code Generation by default. Adds ‘ltcg’ vcbuild\noption to enable it. LTCG will be used by default by release and CI\nbuilds.\n\nPR-URL: https://github.com/nodejs/node/pull/21186\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "7c452845b8d44287f5db96a7f19e7d395e1899ab",
    "files": [
        {
            "sha": "d25a434b03d43340139be7339d0acbac64d9c009",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 32,
            "deletions": 16,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/7c452845b8d44287f5db96a7f19e7d395e1899ab/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/7c452845b8d44287f5db96a7f19e7d395e1899ab/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=7c452845b8d44287f5db96a7f19e7d395e1899ab",
            "patch": "@@ -16,6 +16,7 @@\n     'node_use_v8_platform%': 'true',\n     'node_use_bundled_v8%': 'true',\n     'node_module_version%': '',\n+    'node_with_ltcg%': '',\n \n     'node_tag%': '',\n     'uv_library%': 'static_library',\n@@ -192,36 +193,51 @@\n                 'RuntimeLibrary': 0 # MultiThreaded (/MT)\n               }\n             }\n+          }],\n+          ['node_with_ltcg==\"true\"', {\n+            'msvs_settings': {\n+              'VCCLCompilerTool': {\n+                'WholeProgramOptimization': 'true' # /GL, whole program optimization, needed for LTCG\n+              },\n+              'VCLibrarianTool': {\n+                'AdditionalOptions': [\n+                  '/LTCG:INCREMENTAL', # link time code generation\n+                ]\n+              },\n+              'VCLinkerTool': {\n+                'OptimizeReferences': 2, # /OPT:REF\n+                'EnableCOMDATFolding': 2, # /OPT:ICF\n+                'LinkIncremental': 1, # disable incremental linking\n+                'AdditionalOptions': [\n+                  '/LTCG:INCREMENTAL', # incremental link-time code generation\n+                ]\n+              }\n+            }\n+          }, {\n+            'msvs_settings': {\n+              'VCCLCompilerTool': {\n+                'WholeProgramOptimization': 'false'\n+              },\n+              'VCLinkerTool': {\n+                'LinkIncremental': 2 # enable incremental linking\n+              }\n+            }\n           }]\n         ],\n         'msvs_settings': {\n           'VCCLCompilerTool': {\n             'Optimization': 3, # /Ox, full optimization\n             'FavorSizeOrSpeed': 1, # /Ot, favor speed over size\n             'InlineFunctionExpansion': 2, # /Ob2, inline anything eligible\n-            'WholeProgramOptimization': 'true', # /GL, whole program optimization, needed for LTCG\n             'OmitFramePointers': 'true',\n             'EnableFunctionLevelLinking': 'true',\n             'EnableIntrinsicFunctions': 'true',\n             'RuntimeTypeInfo': 'false',\n             'AdditionalOptions': [\n               '/MP', # compile across multiple CPUs\n             ],\n-          },\n-          'VCLibrarianTool': {\n-            'AdditionalOptions': [\n-              '/LTCG', # link time code generation\n-            ],\n-          },\n-          'VCLinkerTool': {\n-            'OptimizeReferences': 2, # /OPT:REF\n-            'EnableCOMDATFolding': 2, # /OPT:ICF\n-            'LinkIncremental': 1, # disable incremental linking\n-            'AdditionalOptions': [\n-              '/LTCG:INCREMENTAL', # incremental link-time code generation\n-            ],\n-          },\n-        },\n+          }\n+        }\n       }\n     },\n     # Forcibly disable -Werror.  We support a wide range of compilers, it's"
        },
        {
            "sha": "1b3ff0162fc4c479042a81f60d284ea2d323353f",
            "filename": "configure",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/7c452845b8d44287f5db96a7f19e7d395e1899ab/configure",
            "raw_url": "https://github.com/nodejs/node/raw/7c452845b8d44287f5db96a7f19e7d395e1899ab/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=7c452845b8d44287f5db96a7f19e7d395e1899ab",
            "patch": "@@ -425,6 +425,11 @@ intl_optgroup.add_option('--with-icu-source',\n     dest='with_icu_source',\n     help='Intl mode: optional local path to icu/ dir, or path/URL of icu source archive.')\n \n+parser.add_option('--with-ltcg',\n+    action='store_true',\n+    dest='with_ltcg',\n+    help='Use Link Time Code Generation. This feature is only available on Windows.')\n+\n intl_optgroup.add_option('--download',\n     action='store',\n     dest='download_list',\n@@ -953,6 +958,10 @@ def configure_node(o):\n   else:\n     o['variables']['node_use_perfctr'] = 'false'\n \n+  o['variables']['node_with_ltcg'] = b(options.with_ltcg)\n+  if flavor != 'win' and options.with_ltcg:\n+    raise Exception('Link Time Code Generation is only supported on Windows.')\n+\n   if options.tag:\n     o['variables']['node_tag'] = '-' + options.tag\n   else:"
        },
        {
            "sha": "368112edf9a02cd58e93bc923c68c0c132817b2b",
            "filename": "vcbuild.bat",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/7c452845b8d44287f5db96a7f19e7d395e1899ab/vcbuild.bat",
            "raw_url": "https://github.com/nodejs/node/raw/7c452845b8d44287f5db96a7f19e7d395e1899ab/vcbuild.bat",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/vcbuild.bat?ref=7c452845b8d44287f5db96a7f19e7d395e1899ab",
            "patch": "@@ -15,6 +15,7 @@ cd %~dp0\n set config=Release\n set target=Build\n set target_arch=x64\n+set ltcg=\n set target_env=\n set noprojgen=\n set projgen=\n@@ -61,7 +62,7 @@ set doc=\n :next-arg\n if \"%1\"==\"\" goto args-done\n if /i \"%1\"==\"debug\"         set config=Debug&goto arg-ok\n-if /i \"%1\"==\"release\"       set config=Release&goto arg-ok\n+if /i \"%1\"==\"release\"       set config=Release&set ltcg=1&goto arg-ok\n if /i \"%1\"==\"clean\"         set target=Clean&goto arg-ok\n if /i \"%1\"==\"ia32\"          set target_arch=x86&goto arg-ok\n if /i \"%1\"==\"x86\"           set target_arch=x86&goto arg-ok\n@@ -75,6 +76,7 @@ if /i \"%1\"==\"sign\"          set sign=1&goto arg-ok\n if /i \"%1\"==\"nosnapshot\"    set nosnapshot=1&goto arg-ok\n if /i \"%1\"==\"noetw\"         set noetw=1&goto arg-ok\n if /i \"%1\"==\"noperfctr\"     set noperfctr=1&goto arg-ok\n+if /i \"%1\"==\"ltcg\"          set ltcg=1&goto arg-ok\n if /i \"%1\"==\"licensertf\"    set licensertf=1&goto arg-ok\n if /i \"%1\"==\"test\"          set test_args=%test_args% -J %common_test_suites%&set lint_cpp=1&set lint_js=1&set lint_md=1&goto arg-ok\n if /i \"%1\"==\"test-ci\"       set test_args=%test_args% %test_ci_args% -p tap --logfile test.tap %common_test_suites%&set cctest_args=%cctest_args% --gtest_output=tap:cctest.tap&goto arg-ok\n@@ -150,6 +152,7 @@ if defined build_release (\n   set download_arg=\"--download=all\"\n   set i18n_arg=small-icu\n   set projgen=1\n+  set ltcg=1\n )\n \n :: assign path to node_exe\n@@ -162,6 +165,7 @@ if \"%config%\"==\"Debug\"      set configure_flags=%configure_flags% --debug\n if defined nosnapshot       set configure_flags=%configure_flags% --without-snapshot\n if defined noetw            set configure_flags=%configure_flags% --without-etw& set noetw_msi_arg=/p:NoETW=1\n if defined noperfctr        set configure_flags=%configure_flags% --without-perfctr& set noperfctr_msi_arg=/p:NoPerfCtr=1\n+if defined ltcg             set configure_flags=%configure_flags% --with-ltcg\n if defined release_urlbase  set configure_flags=%configure_flags% --release-urlbase=%release_urlbase%\n if defined download_arg     set configure_flags=%configure_flags% %download_arg%\n if defined enable_vtune_arg set configure_flags=%configure_flags% --enable-vtune-profiling\n@@ -656,7 +660,7 @@ del .used_configure_flags\n goto exit\n \n :help\n-echo vcbuild.bat [debug/release] [msi] [doc] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [projgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci/lint-md] [lint-md-build] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n+echo vcbuild.bat [debug/release] [msi] [doc] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [projgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [ltcg] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci/lint-md] [lint-md-build] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n echo Examples:\n echo   vcbuild.bat                          : builds release build\n echo   vcbuild.bat debug                    : builds debug build"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 47,
        "deletions": 18
    }
}