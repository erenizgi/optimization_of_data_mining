{
    "author": "addaleax",
    "message": "v8: enable inline WASM in serialization API\n\nSince the API we expose through the `v8` module is Buffer-based,\nwe cannot transfer WASM modules directly. Instead, we enable\nthe V8-provided inline WASM (de)serialization for WASM modules.\n\nPR-URL: https://github.com/nodejs/node/pull/25313\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "47a9eea8c8843414aa09dbdea9ca5fb74279f5ab",
    "files": [
        {
            "sha": "58ce70b2e08b5ebdcb7b41323238e2f559a7b73d",
            "filename": "src/node_serdes.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/47a9eea8c8843414aa09dbdea9ca5fb74279f5ab/src%2Fnode_serdes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/47a9eea8c8843414aa09dbdea9ca5fb74279f5ab/src%2Fnode_serdes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_serdes.cc?ref=47a9eea8c8843414aa09dbdea9ca5fb74279f5ab",
            "patch": "@@ -282,6 +282,7 @@ DeserializerContext::DeserializerContext(Environment* env,\n     length_(Buffer::Length(buffer)),\n     deserializer_(env->isolate(), data_, length_, this) {\n   object()->Set(env->context(), env->buffer_string(), buffer).FromJust();\n+  deserializer_.SetExpectInlineWasm(true);\n \n   MakeWeak();\n }"
        },
        {
            "sha": "3f88503546f4534046edad204abfc3cdfa4514cf",
            "filename": "test/parallel/test-v8-serdes.js",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/47a9eea8c8843414aa09dbdea9ca5fb74279f5ab/test%2Fparallel%2Ftest-v8-serdes.js",
            "raw_url": "https://github.com/nodejs/node/raw/47a9eea8c8843414aa09dbdea9ca5fb74279f5ab/test%2Fparallel%2Ftest-v8-serdes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-v8-serdes.js?ref=47a9eea8c8843414aa09dbdea9ca5fb74279f5ab",
            "patch": "@@ -4,13 +4,16 @@\n \n const { internalBinding } = require('internal/test/binding');\n const common = require('../common');\n+const fixtures = require('../common/fixtures');\n const assert = require('assert');\n const v8 = require('v8');\n const os = require('os');\n \n const circular = {};\n circular.circular = circular;\n \n+const wasmModule = new WebAssembly.Module(fixtures.readSync('test.wasm'));\n+\n const objects = [\n   { foo: 'bar' },\n   { bar: 'baz' },\n@@ -20,7 +23,8 @@ const objects = [\n   undefined,\n   null,\n   42,\n-  circular\n+  circular,\n+  wasmModule\n ];\n \n const hostObject = new (internalBinding('js_stream').JSStream)();\n@@ -230,3 +234,9 @@ const deserializerTypeError =\n     /^TypeError: buffer must be a TypedArray or a DataView$/,\n   );\n }\n+\n+{\n+  const deserializedWasmModule = v8.deserialize(v8.serialize(wasmModule));\n+  const instance = new WebAssembly.Instance(deserializedWasmModule);\n+  assert.strictEqual(instance.exports.addTwo(10, 20), 30);\n+}"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 12,
        "deletions": 1
    }
}