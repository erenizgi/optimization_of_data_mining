{
    "author": "RidgeA",
    "message": "http2: remove `waitTrailers` listener after closing a stream\n\nWhen `writeHeader` of `Http2ServerResponse` instance are called with\n204, 205 and 304 status codes an underlying stream closes.\nIf call `end` method after sending any of these status codes it will\ncause an error `TypeError: Cannot read property 'Symbol(trailers)' of\nundefined` because a reference to `Http2ServerResponse` instance\nassociated with Http2Stream already was deleted.\nThe closing of stream causes emitting `waitTrailers` event and, when\nthis event handles inside `onStreamTrailerReady` handler, there is\nno reference to Http2ServerResponse instance.\n\nFixes: https://github.com/nodejs/node/issues/21740\nPR-URL: https://github.com/nodejs/node/pull/21764\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "8babbc5e457a7cfcf7205dd574b4b93919fbf996",
    "files": [
        {
            "sha": "4a006107b2fceaa0beb21883f997462c1e8c7827",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8babbc5e457a7cfcf7205dd574b4b93919fbf996/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/8babbc5e457a7cfcf7205dd574b4b93919fbf996/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=8babbc5e457a7cfcf7205dd574b4b93919fbf996",
            "patch": "@@ -391,6 +391,8 @@ function onStreamCloseResponse() {\n   state.closed = true;\n \n   this[kProxySocket] = null;\n+\n+  this.removeListener('wantTrailers', onStreamTrailersReady);\n   this[kResponse] = undefined;\n \n   res.emit('finish');"
        },
        {
            "sha": "83d5521bf2473f91d729caf17f1c23b88d98d0b0",
            "filename": "test/parallel/test-http2-compat-serverresponse-end-after-statuses-without-body.js",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/8babbc5e457a7cfcf7205dd574b4b93919fbf996/test%2Fparallel%2Ftest-http2-compat-serverresponse-end-after-statuses-without-body.js",
            "raw_url": "https://github.com/nodejs/node/raw/8babbc5e457a7cfcf7205dd574b4b93919fbf996/test%2Fparallel%2Ftest-http2-compat-serverresponse-end-after-statuses-without-body.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-end-after-statuses-without-body.js?ref=8babbc5e457a7cfcf7205dd574b4b93919fbf996",
            "patch": "@@ -0,0 +1,47 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const h2 = require('http2');\n+\n+// This test case ensures that calling of res.end after sending\n+// 204, 205 and 304 HTTP statuses will not cause an error\n+// See issue: https://github.com/nodejs/node/issues/21740\n+\n+const {\n+  HTTP_STATUS_NO_CONTENT,\n+  HTTP_STATUS_RESET_CONTENT,\n+  HTTP_STATUS_NOT_MODIFIED\n+} = h2.constants;\n+\n+const statusWithouBody = [\n+  HTTP_STATUS_NO_CONTENT,\n+  HTTP_STATUS_RESET_CONTENT,\n+  HTTP_STATUS_NOT_MODIFIED,\n+];\n+const STATUS_CODES_COUNT = statusWithouBody.length;\n+\n+const server = h2.createServer(common.mustCall(function(req, res) {\n+  res.writeHead(statusWithouBody.pop());\n+  res.end();\n+}, STATUS_CODES_COUNT));\n+\n+server.listen(0, common.mustCall(function() {\n+  const url = `http://localhost:${server.address().port}`;\n+  const client = h2.connect(url, common.mustCall(() => {\n+    let responseCount = 0;\n+    const closeAfterResponse = () => {\n+      if (STATUS_CODES_COUNT === ++responseCount) {\n+        client.destroy();\n+        server.close();\n+      }\n+    };\n+\n+    for (let i = 0; i < STATUS_CODES_COUNT; i++) {\n+      const request = client.request();\n+      request.on('response', common.mustCall(closeAfterResponse));\n+    }\n+\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 49,
        "deletions": 0
    }
}