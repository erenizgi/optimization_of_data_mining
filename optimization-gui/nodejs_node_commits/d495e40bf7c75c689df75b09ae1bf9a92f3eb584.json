{
    "author": "jasnell",
    "message": "test: move common.onGC to individual module\n\nIncrementally making `require('../common')` less of a monolith.\nMove the `common.onGC()` utility to a separate standalone module\nthat is only imported when it's actually needed.\n\nPR-URL: https://github.com/nodejs/node/pull/22446\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Weijia Wang <starkwang@126.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
    "files": [
        {
            "sha": "63d3b1636165bc2f8d3e41f6376dbe9d2cfb3db9",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 28,
            "deletions": 15,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -296,21 +296,6 @@ otherwise.\n ### noWarnCode\n See `common.expectWarning()` for usage.\n \n-### onGC(target, listener)\n-* `target` [&lt;Object>]\n-* `listener` [&lt;Object>]\n-  * `ongc` [&lt;Function>]\n-\n-Installs a GC listener for the collection of `target`.\n-\n-This uses `async_hooks` for GC tracking. This means that it enables\n-`async_hooks` tracking, which may affect the test functionality. It also\n-means that between a `global.gc()` call and the listener being invoked\n-a full `setImmediate()` invocation passes.\n-\n-`listener` is an object to make it easier to use a closure; the target object\n-should not be in scope when `listener.ongc()` is created.\n-\n ### opensslCli\n * [&lt;boolean>]\n \n@@ -759,6 +744,34 @@ via `NODE_TEST_*` environment variables. For example, to configure\n `internet.addresses.INET_HOST`, set the environment\n variable `NODE_TEST_INET_HOST` to a specified host.\n \n+## ongc Module\n+\n+The `ongc` module allows a garbage collection listener to be installed. The\n+module exports a single `onGC()` function.\n+\n+```js\n+require('../common');\n+const onGC = require('../common/ongc');\n+\n+onGC({}, { ongc() { console.log('collected'); } });\n+```\n+\n+### onGC(target, listener)\n+* `target` [&lt;Object>]\n+* `listener` [&lt;Object>]\n+  * `ongc` [&lt;Function>]\n+\n+Installs a GC listener for the collection of `target`.\n+\n+This uses `async_hooks` for GC tracking. This means that it enables\n+`async_hooks` tracking, which may affect the test functionality. It also\n+means that between a `global.gc()` call and the listener being invoked\n+a full `setImmediate()` invocation passes.\n+\n+`listener` is an object to make it easier to use a closure; the target object\n+should not be in scope when `listener.ongc()` is created.\n+\n+\n ## tmpdir Module\n \n The `tmpdir` module supports the use of a temporary directory for testing."
        },
        {
            "sha": "a4f31022b0ab79641279cc6b4f672b8fdcf54e85",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 0,
            "deletions": 27,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -805,30 +805,3 @@ exports.isCPPSymbolsNotMapped = exports.isWindows ||\n                                 exports.isAIX ||\n                                 exports.isLinuxPPCBE ||\n                                 exports.isFreeBSD;\n-\n-const gcTrackerMap = new WeakMap();\n-const gcTrackerTag = 'NODE_TEST_COMMON_GC_TRACKER';\n-\n-exports.onGC = function(obj, gcListener) {\n-  const async_hooks = require('async_hooks');\n-\n-  const onGcAsyncHook = async_hooks.createHook({\n-    init: exports.mustCallAtLeast(function(id, type, trigger, resource) {\n-      if (this.trackedId === undefined) {\n-        assert.strictEqual(type, gcTrackerTag);\n-        this.trackedId = id;\n-      }\n-    }),\n-    destroy(id) {\n-      assert.notStrictEqual(this.trackedId, -1);\n-      if (id === this.trackedId) {\n-        this.gcListener.ongc();\n-        onGcAsyncHook.disable();\n-      }\n-    }\n-  }).enable();\n-  onGcAsyncHook.gcListener = gcListener;\n-\n-  gcTrackerMap.set(obj, new async_hooks.AsyncResource(gcTrackerTag));\n-  obj = null;\n-};"
        },
        {
            "sha": "d8e27beb8f0a13bf3faae57155a3db71f4159fdc",
            "filename": "test/common/ongc.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2Fongc.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fcommon%2Fongc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fongc.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -0,0 +1,32 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const gcTrackerMap = new WeakMap();\n+const gcTrackerTag = 'NODE_TEST_COMMON_GC_TRACKER';\n+\n+function onGC(obj, gcListener) {\n+  const async_hooks = require('async_hooks');\n+\n+  const onGcAsyncHook = async_hooks.createHook({\n+    init: common.mustCallAtLeast(function(id, type) {\n+      if (this.trackedId === undefined) {\n+        assert.strictEqual(type, gcTrackerTag);\n+        this.trackedId = id;\n+      }\n+    }),\n+    destroy(id) {\n+      assert.notStrictEqual(this.trackedId, -1);\n+      if (id === this.trackedId) {\n+        this.gcListener.ongc();\n+        onGcAsyncHook.disable();\n+      }\n+    }\n+  }).enable();\n+  onGcAsyncHook.gcListener = gcListener;\n+\n+  gcTrackerMap.set(obj, new async_hooks.AsyncResource(gcTrackerTag));\n+  obj = null;\n+}\n+\n+module.exports = onGC;"
        },
        {
            "sha": "96dc7e2e7b601deeff6bec4c1f53bad28a707488",
            "filename": "test/parallel/test-common-gc.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-common-gc.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-common-gc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-common-gc.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -1,15 +1,14 @@\n 'use strict';\n // Flags: --expose-gc\n const common = require('../common');\n+const onGC = require('../common/ongc');\n \n {\n-  const gcListener = { ongc: common.mustCall() };\n-  common.onGC({}, gcListener);\n+  onGC({}, { ongc: common.mustCall() });\n   global.gc();\n }\n \n {\n-  const gcListener = { ongc: common.mustNotCall() };\n-  common.onGC(process, gcListener);\n+  onGC(process, { ongc: common.mustNotCall() });\n   global.gc();\n }"
        },
        {
            "sha": "c043c474a65c6b80e0b178fb4e88059807068461",
            "filename": "test/parallel/test-gc-http-client-connaborted.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-connaborted.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-connaborted.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client-connaborted.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -3,7 +3,8 @@\n // just like test-gc-http-client.js,\n // but aborting every connection that comes in.\n \n-const common = require('../common');\n+require('../common');\n+const onGC = require('../common/ongc');\n \n function serverHandler(req, res) {\n   res.connection.destroy();\n@@ -36,7 +37,7 @@ function getall() {\n     }, cb).on('error', cb);\n \n     count++;\n-    common.onGC(req, { ongc });\n+    onGC(req, { ongc });\n   })();\n \n   setImmediate(getall);"
        },
        {
            "sha": "ef643d255e7ed894e7334ba64e759bee89329ef1",
            "filename": "test/parallel/test-gc-http-client-onerror.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-onerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-onerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client-onerror.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -3,7 +3,8 @@\n // just like test-gc-http-client.js,\n // but with an on('error') handler that does nothing.\n \n-const common = require('../common');\n+require('../common');\n+const onGC = require('../common/ongc');\n \n function serverHandler(req, res) {\n   req.resume();\n@@ -42,7 +43,7 @@ function getall() {\n     }, cb).on('error', onerror);\n \n     count++;\n-    common.onGC(req, { ongc });\n+    onGC(req, { ongc });\n   })();\n \n   setImmediate(getall);"
        },
        {
            "sha": "4b4d1610c3ebdb5ab8f63e2ae8128931aad7c97b",
            "filename": "test/parallel/test-gc-http-client-timeout.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client-timeout.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -3,7 +3,8 @@\n // just like test-gc-http-client.js,\n // but with a timeout set\n \n-const common = require('../common');\n+require('../common');\n+const onGC = require('../common/ongc');\n \n function serverHandler(req, res) {\n   setTimeout(function() {\n@@ -45,7 +46,7 @@ function getall() {\n     });\n \n     count++;\n-    common.onGC(req, { ongc });\n+    onGC(req, { ongc });\n   })();\n \n   setImmediate(getall);"
        },
        {
            "sha": "431c6387e171a0a734638d4a25af61ca566cf55b",
            "filename": "test/parallel/test-gc-http-client.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-http-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -3,6 +3,7 @@\n // just a simple http server and client.\n \n const common = require('../common');\n+const onGC = require('../common/ongc');\n \n function serverHandler(req, res) {\n   res.writeHead(200, { 'Content-Type': 'text/plain' });\n@@ -34,7 +35,7 @@ function getall() {\n   }, cb);\n \n   count++;\n-  common.onGC(req, { ongc });\n+  onGC(req, { ongc });\n \n   setImmediate(getall);\n }"
        },
        {
            "sha": "9651e4a2a686dceda6c7b072caaf06de01a05a73",
            "filename": "test/parallel/test-gc-net-timeout.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-net-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-gc-net-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-net-timeout.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -3,7 +3,8 @@\n // just like test-gc-http-client-timeout.js,\n // but using a net server/client instead\n \n-const common = require('../common');\n+require('../common');\n+const onGC = require('../common/ongc');\n \n function serverHandler(sock) {\n   sock.setTimeout(120000);\n@@ -44,7 +45,7 @@ function getall() {\n   });\n \n   count++;\n-  common.onGC(req, { ongc });\n+  onGC(req, { ongc });\n \n   setImmediate(getall);\n }"
        },
        {
            "sha": "4efceee0eae138efac9fdbfb02cc22ecbfb775c1",
            "filename": "test/parallel/test-net-connect-memleak.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-net-connect-memleak.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-net-connect-memleak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-connect-memleak.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -23,6 +23,7 @@\n // Flags: --expose-gc\n \n const common = require('../common');\n+const onGC = require('../common/ongc');\n const assert = require('assert');\n const net = require('net');\n \n@@ -36,7 +37,7 @@ const gcListener = { ongc() { collected = true; } };\n \n {\n   const gcObject = {};\n-  common.onGC(gcObject, gcListener);\n+  onGC(gcObject, gcListener);\n \n   const sock = net.createConnection(\n     server.address().port,"
        },
        {
            "sha": "0278e6c7159a68c71d003c778f9c52fd919a223d",
            "filename": "test/parallel/test-tls-connect-memleak.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-tls-connect-memleak.js",
            "raw_url": "https://github.com/nodejs/node/raw/d495e40bf7c75c689df75b09ae1bf9a92f3eb584/test%2Fparallel%2Ftest-tls-connect-memleak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-connect-memleak.js?ref=d495e40bf7c75c689df75b09ae1bf9a92f3eb584",
            "patch": "@@ -26,6 +26,7 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+const onGC = require('../common/ongc');\n const assert = require('assert');\n const tls = require('tls');\n const fixtures = require('../common/fixtures');\n@@ -43,7 +44,7 @@ const gcListener = { ongc() { collected = true; } };\n \n {\n   const gcObject = {};\n-  common.onGC(gcObject, gcListener);\n+  onGC(gcObject, gcListener);\n \n   const sock = tls.connect(\n     server.address().port,"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 81,
        "deletions": 57
    }
}