{
    "author": "szmarczak",
    "message": "http2: don't expose the original socket through the socket proxy\n\nRefs: https://github.com/nodejs/node/pull/22486\n\nPR-URL: https://github.com/nodejs/node/pull/22650\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57",
    "files": [
        {
            "sha": "f2a298b6e5df693f225ddb1536977a3ed1fbba3b",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57",
            "patch": "@@ -646,14 +646,19 @@ const proxySocketHandler = {\n   get(session, prop) {\n     switch (prop) {\n       case 'setTimeout':\n-        return session.setTimeout.bind(session);\n+      case 'ref':\n+      case 'unref':\n+        return session[prop].bind(session);\n       case 'destroy':\n       case 'emit':\n       case 'end':\n       case 'pause':\n       case 'read':\n       case 'resume':\n       case 'write':\n+      case 'setEncoding':\n+      case 'setKeepAlive':\n+      case 'setNoDelay':\n         throw new ERR_HTTP2_NO_SOCKET_MANIPULATION();\n       default:\n         const socket = session[kSocket];\n@@ -672,7 +677,9 @@ const proxySocketHandler = {\n   set(session, prop, value) {\n     switch (prop) {\n       case 'setTimeout':\n-        session.setTimeout = value;\n+      case 'ref':\n+      case 'unref':\n+        session[prop] = value;\n         return true;\n       case 'destroy':\n       case 'emit':\n@@ -681,6 +688,9 @@ const proxySocketHandler = {\n       case 'read':\n       case 'resume':\n       case 'write':\n+      case 'setEncoding':\n+      case 'setKeepAlive':\n+      case 'setNoDelay':\n         throw new ERR_HTTP2_NO_SOCKET_MANIPULATION();\n       default:\n         const socket = session[kSocket];"
        },
        {
            "sha": "64daeb62baebf2634ddcfcd42d286434923a49dd",
            "filename": "test/parallel/test-http2-socket-proxy.js",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/test%2Fparallel%2Ftest-http2-socket-proxy.js",
            "raw_url": "https://github.com/nodejs/node/raw/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/test%2Fparallel%2Ftest-http2-socket-proxy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-socket-proxy.js?ref=d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57",
            "patch": "@@ -42,6 +42,9 @@ server.on('stream', common.mustCall(function(stream, headers) {\n   common.expectsError(() => socket.read, errMsg);\n   common.expectsError(() => socket.resume, errMsg);\n   common.expectsError(() => socket.write, errMsg);\n+  common.expectsError(() => socket.setEncoding, errMsg);\n+  common.expectsError(() => socket.setKeepAlive, errMsg);\n+  common.expectsError(() => socket.setNoDelay, errMsg);\n \n   common.expectsError(() => (socket.destroy = undefined), errMsg);\n   common.expectsError(() => (socket.emit = undefined), errMsg);\n@@ -50,11 +53,19 @@ server.on('stream', common.mustCall(function(stream, headers) {\n   common.expectsError(() => (socket.read = undefined), errMsg);\n   common.expectsError(() => (socket.resume = undefined), errMsg);\n   common.expectsError(() => (socket.write = undefined), errMsg);\n+  common.expectsError(() => (socket.setEncoding = undefined), errMsg);\n+  common.expectsError(() => (socket.setKeepAlive = undefined), errMsg);\n+  common.expectsError(() => (socket.setNoDelay = undefined), errMsg);\n \n   // Resetting the socket listeners to their own value should not throw.\n   socket.on = socket.on;  // eslint-disable-line no-self-assign\n   socket.once = socket.once;  // eslint-disable-line no-self-assign\n \n+  socket.unref();\n+  assert.strictEqual(socket._handle.hasRef(), false);\n+  socket.ref();\n+  assert.strictEqual(socket._handle.hasRef(), true);\n+\n   stream.respond();\n \n   socket.writable = 0;"
        },
        {
            "sha": "18881574f2c09b072c45476a921462cf28d60cf5",
            "filename": "test/parallel/test-http2-unbound-socket-proxy.js",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js",
            "raw_url": "https://github.com/nodejs/node/raw/d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-unbound-socket-proxy.js?ref=d6a43438d6ed3f262cc87fe2ebd0c46a87c1ff57",
            "patch": "@@ -39,31 +39,6 @@ server.listen(0, common.mustCall(() => {\n       }, {\n         code: 'ERR_HTTP2_SOCKET_UNBOUND'\n       });\n-      common.expectsError(() => {\n-        socket.ref();\n-      }, {\n-        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n-      });\n-      common.expectsError(() => {\n-        socket.unref();\n-      }, {\n-        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n-      });\n-      common.expectsError(() => {\n-        socket.setEncoding();\n-      }, {\n-        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n-      });\n-      common.expectsError(() => {\n-        socket.setKeepAlive();\n-      }, {\n-        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n-      });\n-      common.expectsError(() => {\n-        socket.setNoDelay();\n-      }, {\n-        code: 'ERR_HTTP2_SOCKET_UNBOUND'\n-      });\n     }));\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 23,
        "deletions": 27
    }
}