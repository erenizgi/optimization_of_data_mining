{
    "author": "oyyd",
    "message": "net: emit \"write after end\" errors in the next tick\n\nThis commit makes those errors caused by calling\n`net.Socket.write()` after sockets ending be emitted in the next\ntick.\n\nPR-URL: https://github.com/nodejs/node/pull/24457\nFixes: https://github.com/nodejs/node/issues/24111\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "9389b464eaea7e74cf60c1d81c7bf1efda4e8897",
    "files": [
        {
            "sha": "ba7c3eb6daca0ddd302f3aaf97a419eb33a8981f",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9389b464eaea7e74cf60c1d81c7bf1efda4e8897/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/9389b464eaea7e74cf60c1d81c7bf1efda4e8897/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=9389b464eaea7e74cf60c1d81c7bf1efda4e8897",
            "patch": "@@ -401,8 +401,7 @@ function writeAfterFIN(chunk, encoding, cb) {\n   // eslint-disable-next-line no-restricted-syntax\n   var er = new Error('This socket has been ended by the other party');\n   er.code = 'EPIPE';\n-  // TODO: defer error events consistently everywhere, not just the cb\n-  this.emit('error', er);\n+  process.nextTick(emitErrorNT, this, er);\n   if (typeof cb === 'function') {\n     defaultTriggerAsyncIdScope(this[async_id_symbol], process.nextTick, cb, er);\n   }"
        },
        {
            "sha": "3f93b444f4cb36808718faea809ea101b8774450",
            "filename": "test/parallel/test-net-write-after-end-nt.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/9389b464eaea7e74cf60c1d81c7bf1efda4e8897/test%2Fparallel%2Ftest-net-write-after-end-nt.js",
            "raw_url": "https://github.com/nodejs/node/raw/9389b464eaea7e74cf60c1d81c7bf1efda4e8897/test%2Fparallel%2Ftest-net-write-after-end-nt.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-write-after-end-nt.js?ref=9389b464eaea7e74cf60c1d81c7bf1efda4e8897",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+const common = require('../common');\n+\n+const assert = require('assert');\n+const net = require('net');\n+\n+const { mustCall } = common;\n+\n+// This test ensures those errors caused by calling `net.Socket.write()`\n+// after sockets ending will be emitted in the next tick.\n+const server = net.createServer(mustCall((socket) => {\n+  socket.end();\n+})).listen(() => {\n+  const client = net.connect(server.address().port, () => {\n+    let hasError = false;\n+    client.on('error', mustCall((err) => {\n+      hasError = true;\n+      server.close();\n+    }));\n+    client.on('end', mustCall(() => {\n+      client.write('hello', mustCall());\n+      assert(!hasError, 'The error should be emitted in the next tick.');\n+    }));\n+    client.end();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 27,
        "deletions": 2
    }
}