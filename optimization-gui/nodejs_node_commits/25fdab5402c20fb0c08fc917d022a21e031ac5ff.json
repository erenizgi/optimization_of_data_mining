{
    "author": "addaleax",
    "message": "src: use unique_ptr for internal JSON trace writer\n\nPR-URL: https://github.com/nodejs/node/pull/21867\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "25fdab5402c20fb0c08fc917d022a21e031ac5ff",
    "files": [
        {
            "sha": "c188495422e029e4b78082363e50421fb5d98fa1",
            "filename": "src/tracing/node_trace_writer.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/25fdab5402c20fb0c08fc917d022a21e031ac5ff/src%2Ftracing%2Fnode_trace_writer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/25fdab5402c20fb0c08fc917d022a21e031ac5ff/src%2Ftracing%2Fnode_trace_writer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.cc?ref=25fdab5402c20fb0c08fc917d022a21e031ac5ff",
            "patch": "@@ -37,9 +37,7 @@ void NodeTraceWriter::WriteSuffix() {\n   {\n     Mutex::ScopedLock scoped_lock(stream_mutex_);\n     if (total_traces_ > 0) {\n-      total_traces_ = 0;  // so we don't write it again in FlushPrivate\n-      // Appends \"]}\" to stream_.\n-      delete json_trace_writer_;\n+      total_traces_ = kTracesPerFile;  // Act as if we reached the file limit.\n       should_flush = true;\n     }\n   }\n@@ -111,7 +109,7 @@ void NodeTraceWriter::AppendTraceEvent(TraceObject* trace_event) {\n     // to a state where we can start writing trace events to it.\n     // Repeatedly constructing and destroying json_trace_writer_ allows\n     // us to use V8's JSON writer instead of implementing our own.\n-    json_trace_writer_ = TraceWriter::CreateJSONTraceWriter(stream_);\n+    json_trace_writer_.reset(TraceWriter::CreateJSONTraceWriter(stream_));\n   }\n   ++total_traces_;\n   json_trace_writer_->AppendTraceEvent(trace_event);\n@@ -126,7 +124,7 @@ void NodeTraceWriter::FlushPrivate() {\n       total_traces_ = 0;\n       // Destroying the member JSONTraceWriter object appends \"]}\" to\n       // stream_ - in other words, ending a JSON file.\n-      delete json_trace_writer_;\n+      json_trace_writer_.reset();\n     }\n     // str() makes a copy of the contents of the stream.\n     str = stream_.str();"
        },
        {
            "sha": "53311db9922e5ea50b1787b81e7440f892aa7e4d",
            "filename": "src/tracing/node_trace_writer.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/25fdab5402c20fb0c08fc917d022a21e031ac5ff/src%2Ftracing%2Fnode_trace_writer.h",
            "raw_url": "https://github.com/nodejs/node/raw/25fdab5402c20fb0c08fc917d022a21e031ac5ff/src%2Ftracing%2Fnode_trace_writer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.h?ref=25fdab5402c20fb0c08fc917d022a21e031ac5ff",
            "patch": "@@ -63,7 +63,7 @@ class NodeTraceWriter : public AsyncTraceWriter {\n   int file_num_ = 0;\n   const std::string& log_file_pattern_;\n   std::ostringstream stream_;\n-  TraceWriter* json_trace_writer_ = nullptr;\n+  std::unique_ptr<TraceWriter> json_trace_writer_;\n   bool exited_ = false;\n };\n "
        }
    ],
    "stats": {
        "total": 10,
        "additions": 4,
        "deletions": 6
    }
}