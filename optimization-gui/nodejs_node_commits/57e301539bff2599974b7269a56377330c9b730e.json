{
    "author": "addaleax",
    "message": "src: enable more detailed memory tracking\n\nThis will enable more detailed heap snapshots based on\na newer V8 API.\n\nThis commit itself is not tied to that API and could\nbe backported.\n\nPR-URL: https://github.com/nodejs/node/pull/21742\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "57e301539bff2599974b7269a56377330c9b730e",
    "files": [
        {
            "sha": "1ee29f18647990bb0fe91bab98b718606aeef197",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -423,6 +423,8 @@\n         'src/node_revert.h',\n         'src/node_i18n.h',\n         'src/node_worker.h',\n+        'src/memory_tracker.h',\n+        'src/memory_tracker-inl.h',\n         'src/pipe_wrap.h',\n         'src/tty_wrap.h',\n         'src/tcp_wrap.h',"
        },
        {
            "sha": "e98dca3c56651b801b43262fd92e2d8beeb90d90",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -76,14 +76,22 @@ class RetainedAsyncInfo: public RetainedObjectInfo {\n  private:\n   const char* label_;\n   const AsyncWrap* wrap_;\n-  const int length_;\n+  const size_t length_;\n };\n \n \n+static int OwnMemory(AsyncWrap* async_wrap) {\n+  MemoryTracker tracker;\n+  tracker.set_track_only_self(true);\n+  tracker.Track(async_wrap);\n+  return tracker.accumulated_size();\n+}\n+\n+\n RetainedAsyncInfo::RetainedAsyncInfo(uint16_t class_id, AsyncWrap* wrap)\n     : label_(provider_names[class_id - NODE_ASYNC_ID_OFFSET]),\n       wrap_(wrap),\n-      length_(wrap->self_size()) {\n+      length_(OwnMemory(wrap)) {\n }\n \n \n@@ -147,7 +155,9 @@ struct AsyncWrapObject : public AsyncWrap {\n   inline AsyncWrapObject(Environment* env, Local<Object> object,\n                          ProviderType type) : AsyncWrap(env, object, type) {}\n \n-  inline size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n };\n \n \n@@ -252,7 +262,10 @@ class PromiseWrap : public AsyncWrap {\n       : AsyncWrap(env, object, PROVIDER_PROMISE, -1, silent) {\n     MakeWeak();\n   }\n-  size_t self_size() const override { return sizeof(*this); }\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n   static constexpr int kPromiseField = 1;\n   static constexpr int kIsChainedPromiseField = 2;"
        },
        {
            "sha": "ef3a5934893d7f793c6b3e4ab3b57e90a7ad8d05",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -173,7 +173,6 @@ class AsyncWrap : public BaseObject {\n       int argc,\n       v8::Local<v8::Value>* argv);\n \n-  virtual size_t self_size() const = 0;\n   virtual std::string diagnostic_name() const;\n \n   static void WeakCallback(const v8::WeakCallbackInfo<DestroyParam> &info);"
        },
        {
            "sha": "d067a807cb8e14cd6b6467f4ccdda43326ef5f7b",
            "filename": "src/base_object-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fbase_object-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fbase_object-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object-inl.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -61,11 +61,11 @@ Persistent<v8::Object>& BaseObject::persistent() {\n }\n \n \n-v8::Local<v8::Object> BaseObject::object() {\n+v8::Local<v8::Object> BaseObject::object() const {\n   return PersistentToLocal(env_->isolate(), persistent_handle_);\n }\n \n-v8::Local<v8::Object> BaseObject::object(v8::Isolate* isolate) {\n+v8::Local<v8::Object> BaseObject::object(v8::Isolate* isolate) const {\n   v8::Local<v8::Object> handle = object();\n #ifdef DEBUG\n   CHECK_EQ(handle->CreationContext()->GetIsolate(), isolate);\n@@ -91,12 +91,6 @@ T* BaseObject::FromJSObject(v8::Local<v8::Object> object) {\n }\n \n \n-void BaseObject::DeleteMe(void* data) {\n-  BaseObject* self = static_cast<BaseObject*>(data);\n-  delete self;\n-}\n-\n-\n void BaseObject::MakeWeak() {\n   persistent_handle_.SetWeak(\n       this,"
        },
        {
            "sha": "e0f3f27950e7d0d16679b6e70d6f4f8d8ba858e0",
            "filename": "src/base_object.h",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fbase_object.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fbase_object.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -25,14 +25,15 @@\n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #include \"node_persistent.h\"\n+#include \"memory_tracker-inl.h\"\n #include \"v8.h\"\n #include <type_traits>  // std::remove_reference\n \n namespace node {\n \n class Environment;\n \n-class BaseObject {\n+class BaseObject : public MemoryRetainer {\n  public:\n   // Associates this object with `object`. It uses the 0th internal field for\n   // that, and in particular aborts if there is no such field.\n@@ -41,11 +42,11 @@ class BaseObject {\n \n   // Returns the wrapped object.  Returns an empty handle when\n   // persistent.IsEmpty() is true.\n-  inline v8::Local<v8::Object> object();\n+  inline v8::Local<v8::Object> object() const;\n \n   // Same as the above, except it additionally verifies that this object\n   // is associated with the passed Isolate in debug mode.\n-  inline v8::Local<v8::Object> object(v8::Isolate* isolate);\n+  inline v8::Local<v8::Object> object(v8::Isolate* isolate) const;\n \n   inline Persistent<v8::Object>& persistent();\n \n@@ -75,14 +76,18 @@ class BaseObject {\n  private:\n   BaseObject();\n \n-  static inline void DeleteMe(void* data);\n+  v8::Local<v8::Object> WrappedObject() const override;\n+  bool IsRootNode() const override;\n+  static void DeleteMe(void* data);\n \n   // persistent_handle_ needs to be at a fixed offset from the start of the\n   // class because it is used by src/node_postmortem_metadata.cc to calculate\n   // offsets and generate debug symbols for BaseObject, which assumes that the\n   // position of members in memory are predictable. For more information please\n   // refer to `doc/guides/node-postmortem-support.md`\n   friend int GenDebugSymbols();\n+  friend class Environment;\n+\n   Persistent<v8::Object> persistent_handle_;\n   Environment* env_;\n };"
        },
        {
            "sha": "69a3d46668193acbe041fe25d40f57da9042dc16",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 59,
            "deletions": 18,
            "changes": 77,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -121,10 +121,12 @@ inline const char* ToErrorCodeString(int status) {\n \n class ChannelWrap;\n \n-struct node_ares_task {\n+struct node_ares_task : public MemoryRetainer {\n   ChannelWrap* channel;\n   ares_socket_t sock;\n   uv_poll_t poll_watcher;\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override;\n };\n \n struct TaskHash {\n@@ -167,7 +169,12 @@ class ChannelWrap : public AsyncWrap {\n   inline int active_query_count() { return active_query_count_; }\n   inline node_ares_task_list* task_list() { return &task_list_; }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    if (timer_handle_ != nullptr)\n+      tracker->TrackFieldWithSize(\"timer handle\", sizeof(*timer_handle_));\n+    tracker->TrackField(\"task list\", task_list_);\n+  }\n \n   static void AresTimeout(uv_timer_t* handle);\n \n@@ -181,6 +188,11 @@ class ChannelWrap : public AsyncWrap {\n   node_ares_task_list task_list_;\n };\n \n+void node_ares_task::MemoryInfo(MemoryTracker* tracker) const {\n+  tracker->TrackThis(this);\n+  tracker->TrackField(\"channel\", channel);\n+}\n+\n ChannelWrap::ChannelWrap(Environment* env,\n                          Local<Object> object)\n   : AsyncWrap(env, object, PROVIDER_DNSCHANNEL),\n@@ -209,7 +221,10 @@ class GetAddrInfoReqWrap : public ReqWrap<uv_getaddrinfo_t> {\n                      Local<Object> req_wrap_obj,\n                      bool verbatim);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n   bool verbatim() const { return verbatim_; }\n \n  private:\n@@ -228,7 +243,9 @@ class GetNameInfoReqWrap : public ReqWrap<uv_getnameinfo_t> {\n  public:\n   GetNameInfoReqWrap(Environment* env, Local<Object> req_wrap_obj);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n };\n \n GetNameInfoReqWrap::GetNameInfoReqWrap(Environment* env,\n@@ -270,13 +287,13 @@ void ares_poll_cb(uv_poll_t* watcher, int status, int events) {\n \n void ares_poll_close_cb(uv_poll_t* watcher) {\n   node_ares_task* task = ContainerOf(&node_ares_task::poll_watcher, watcher);\n-  free(task);\n+  delete task;\n }\n \n \n /* Allocates and returns a new node_ares_task */\n node_ares_task* ares_task_create(ChannelWrap* channel, ares_socket_t sock) {\n-  auto task = node::UncheckedMalloc<node_ares_task>(1);\n+  auto task = new node_ares_task();\n \n   if (task == nullptr) {\n     /* Out of memory. */\n@@ -1172,7 +1189,9 @@ class QueryAnyWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1349,7 +1368,9 @@ class QueryAWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1393,7 +1414,9 @@ class QueryAaaaWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1437,7 +1460,9 @@ class QueryCnameWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1468,7 +1493,9 @@ class QueryMxWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1499,7 +1526,9 @@ class QueryNsWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1530,7 +1559,9 @@ class QueryTxtWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1560,7 +1591,9 @@ class QuerySrvWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1589,7 +1622,9 @@ class QueryPtrWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1620,7 +1655,9 @@ class QueryNaptrWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1650,7 +1687,9 @@ class QuerySoaWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(unsigned char* buf, int len) override {\n@@ -1729,7 +1768,9 @@ class GetHostByAddrWrap: public QueryWrap {\n     return 0;\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   void Parse(struct hostent* host) override {"
        },
        {
            "sha": "587e4c6b0593e5f48992f4e9e89525463e36e8ba",
            "filename": "src/connect_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fconnect_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fconnect_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fconnect_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -16,7 +16,9 @@ class ConnectWrap : public ReqWrap<uv_connect_t> {\n               v8::Local<v8::Object> req_wrap_obj,\n               AsyncWrap::ProviderType provider);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n };\n \n }  // namespace node"
        },
        {
            "sha": "30bc85559a9a0aa0772589c748e4ae66aa113b75",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -734,4 +734,18 @@ void Environment::stop_sub_worker_contexts() {\n   }\n }\n \n+// Not really any better place than env.cc at this moment.\n+void BaseObject::DeleteMe(void* data) {\n+  BaseObject* self = static_cast<BaseObject*>(data);\n+  delete self;\n+}\n+\n+Local<Object> BaseObject::WrappedObject() const {\n+  return object();\n+}\n+\n+bool BaseObject::IsRootNode() const {\n+  return !persistent_handle_.IsWeak();\n+}\n+\n }  // namespace node"
        },
        {
            "sha": "7587ace8e3ce70fc41e74a8c6d242d4f99da721d",
            "filename": "src/fs_event_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ffs_event_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ffs_event_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ffs_event_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -56,7 +56,10 @@ class FSEventWrap: public HandleWrap {\n   static void New(const FunctionCallbackInfo<Value>& args);\n   static void Start(const FunctionCallbackInfo<Value>& args);\n   static void GetInitialized(const FunctionCallbackInfo<Value>& args);\n-  size_t self_size() const override { return sizeof(*this); }\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   static const encoding kDefaultEncoding = UTF8;"
        },
        {
            "sha": "9a74f4d1098c293a00f170f784b1ea4d39c3ee0a",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -103,7 +103,11 @@ class JSBindingsConnection : public AsyncWrap {\n     }\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"callback\", callback_);\n+    tracker->TrackFieldWithSize(\"session\", sizeof(*session_));\n+  }\n \n  private:\n   std::unique_ptr<InspectorSession> session_;"
        },
        {
            "sha": "f3406ae83ee560f1be40a02ade7c5ff879ba31b0",
            "filename": "src/js_stream.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fjs_stream.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fjs_stream.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -27,7 +27,9 @@ class JSStream : public AsyncWrap, public StreamBase {\n               size_t count,\n               uv_stream_t* send_handle) override;\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  protected:\n   JSStream(Environment* env, v8::Local<v8::Object> obj);"
        },
        {
            "sha": "758223492f6e711b396643b2134c47e25e32fdb3",
            "filename": "src/memory_tracker-inl.h",
            "status": "added",
            "additions": 107,
            "deletions": 0,
            "changes": 107,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fmemory_tracker-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fmemory_tracker-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmemory_tracker-inl.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -0,0 +1,107 @@\n+#ifndef SRC_MEMORY_TRACKER_INL_H_\n+#define SRC_MEMORY_TRACKER_INL_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include \"memory_tracker.h\"\n+\n+namespace node {\n+\n+template <typename T>\n+void MemoryTracker::TrackThis(const T* obj) {\n+  accumulated_size_ += sizeof(T);\n+}\n+\n+void MemoryTracker::TrackFieldWithSize(const char* name, size_t size) {\n+  accumulated_size_ += size;\n+}\n+\n+void MemoryTracker::TrackField(const char* name, const MemoryRetainer& value) {\n+  TrackField(name, &value);\n+}\n+\n+void MemoryTracker::TrackField(const char* name, const MemoryRetainer* value) {\n+  if (track_only_self_ || value == nullptr || seen_.count(value) > 0) return;\n+  seen_.insert(value);\n+  Track(value);\n+}\n+\n+template <typename T>\n+void MemoryTracker::TrackField(const char* name,\n+                               const std::unique_ptr<T>& value) {\n+  TrackField(name, value.get());\n+}\n+\n+template <typename T, typename Iterator>\n+void MemoryTracker::TrackField(const char* name, const T& value) {\n+  if (value.begin() == value.end()) return;\n+  size_t index = 0;\n+  for (Iterator it = value.begin(); it != value.end(); ++it)\n+    TrackField(std::to_string(index++).c_str(), *it);\n+}\n+\n+template <typename T>\n+void MemoryTracker::TrackField(const char* name, const std::queue<T>& value) {\n+  struct ContainerGetter : public std::queue<T> {\n+    static const typename std::queue<T>::container_type& Get(\n+        const std::queue<T>& value) {\n+      return value.*&ContainerGetter::c;\n+    }\n+  };\n+\n+  const auto& container = ContainerGetter::Get(value);\n+  TrackField(name, container);\n+}\n+\n+template <typename T, typename test_for_number, typename dummy>\n+void MemoryTracker::TrackField(const char* name, const T& value) {\n+  // For numbers, creating new nodes is not worth the overhead.\n+  TrackFieldWithSize(name, sizeof(T));\n+}\n+\n+template <typename T, typename U>\n+void MemoryTracker::TrackField(const char* name, const std::pair<T, U>& value) {\n+  TrackField(\"first\", value.first);\n+  TrackField(\"second\", value.second);\n+}\n+\n+template <typename T>\n+void MemoryTracker::TrackField(const char* name,\n+                               const std::basic_string<T>& value) {\n+  TrackFieldWithSize(name, value.size() * sizeof(T));\n+}\n+\n+template <typename T, typename Traits>\n+void MemoryTracker::TrackField(const char* name,\n+                               const v8::Persistent<T, Traits>& value) {\n+}\n+\n+template <typename T>\n+void MemoryTracker::TrackField(const char* name, const v8::Local<T>& value) {\n+}\n+\n+template <typename T>\n+void MemoryTracker::TrackField(const char* name,\n+                               const MallocedBuffer<T>& value) {\n+  TrackFieldWithSize(name, value.size);\n+}\n+\n+void MemoryTracker::TrackField(const char* name, const uv_buf_t& value) {\n+  TrackFieldWithSize(name, value.len);\n+}\n+\n+template <class NativeT, class V8T>\n+void MemoryTracker::TrackField(const char* name,\n+                       const AliasedBuffer<NativeT, V8T>& value) {\n+  TrackField(name, value.GetJSArray());\n+}\n+\n+void MemoryTracker::Track(const MemoryRetainer* value) {\n+  value->MemoryInfo(this);\n+}\n+\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#endif  // SRC_MEMORY_TRACKER_INL_H_"
        },
        {
            "sha": "18822651f67873da2dbc82bc2aafc2710d1cc493",
            "filename": "src/memory_tracker.h",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fmemory_tracker.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fmemory_tracker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmemory_tracker.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -0,0 +1,87 @@\n+#ifndef SRC_MEMORY_TRACKER_H_\n+#define SRC_MEMORY_TRACKER_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include <unordered_set>\n+#include <queue>\n+#include <limits>\n+#include <uv.h>\n+#include <aliased_buffer.h>\n+\n+namespace node {\n+\n+class MemoryTracker;\n+\n+namespace crypto {\n+class NodeBIO;\n+}\n+\n+class MemoryRetainer {\n+ public:\n+  virtual ~MemoryRetainer() {}\n+\n+  // Subclasses should implement this to provide information for heap snapshots.\n+  virtual void MemoryInfo(MemoryTracker* tracker) const = 0;\n+\n+  virtual v8::Local<v8::Object> WrappedObject() const {\n+    return v8::Local<v8::Object>();\n+  }\n+\n+  virtual bool IsRootNode() const { return false; }\n+};\n+\n+class MemoryTracker {\n+ public:\n+  template <typename T>\n+  inline void TrackThis(const T* obj);\n+\n+  inline void TrackFieldWithSize(const char* name, size_t size);\n+\n+  inline void TrackField(const char* name, const MemoryRetainer& value);\n+  inline void TrackField(const char* name, const MemoryRetainer* value);\n+  template <typename T>\n+  inline void TrackField(const char* name, const std::unique_ptr<T>& value);\n+  template <typename T, typename Iterator = typename T::const_iterator>\n+  inline void TrackField(const char* name, const T& value);\n+  template <typename T>\n+  inline void TrackField(const char* name, const std::queue<T>& value);\n+  template <typename T>\n+  inline void TrackField(const char* name, const std::basic_string<T>& value);\n+  template <typename T, typename test_for_number =\n+      typename std::enable_if<\n+          std::numeric_limits<T>::is_specialized, bool>::type,\n+      typename dummy = bool>\n+  inline void TrackField(const char* name, const T& value);\n+  template <typename T, typename U>\n+  inline void TrackField(const char* name, const std::pair<T, U>& value);\n+  template <typename T, typename Traits>\n+  inline void TrackField(const char* name,\n+                         const v8::Persistent<T, Traits>& value);\n+  template <typename T>\n+  inline void TrackField(const char* name, const v8::Local<T>& value);\n+  template <typename T>\n+  inline void TrackField(const char* name, const MallocedBuffer<T>& value);\n+  inline void TrackField(const char* name, const uv_buf_t& value);\n+  template <class NativeT, class V8T>\n+  inline void TrackField(const char* name,\n+                         const AliasedBuffer<NativeT, V8T>& value);\n+\n+  inline void Track(const MemoryRetainer* value);\n+  inline size_t accumulated_size() const { return accumulated_size_; }\n+\n+  inline void set_track_only_self(bool value) { track_only_self_ = value; }\n+\n+  inline MemoryTracker() {}\n+\n+ private:\n+  bool track_only_self_ = false;\n+  size_t accumulated_size_ = 0;\n+  std::unordered_set<const MemoryRetainer*> seen_;\n+};\n+\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#endif  // SRC_MEMORY_TRACKER_H_"
        },
        {
            "sha": "2d6f5c49d88988be88c98b8564df913b6f26c341",
            "filename": "src/module_wrap.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fmodule_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fmodule_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -33,6 +33,12 @@ class ModuleWrap : public BaseObject {\n       v8::Local<v8::Module> module,\n       v8::Local<v8::Object> meta);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"url\", url_);\n+    tracker->TrackField(\"resolve_cache\", resolve_cache_);\n+  }\n+\n  private:\n   ModuleWrap(Environment* env,\n              v8::Local<v8::Object> object,"
        },
        {
            "sha": "e4b4fef3dca9896d5402dd4b54ef72f774579cb3",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -588,6 +588,10 @@ class ContextifyScript : public BaseObject {\n  private:\n   Persistent<UnboundScript> script_;\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  public:\n   static void Init(Environment* env, Local<Object> target) {\n     HandleScope scope(env->isolate());"
        },
        {
            "sha": "3d94fbc5c479475c58d63faf1a1f8d9d1c231948",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -49,6 +49,7 @@ class ContextifyContext {\n         context()->GetEmbedderData(ContextEmbedderIndex::kSandboxObject));\n   }\n \n+\n   template <typename T>\n   static ContextifyContext* Get(const v8::PropertyCallbackInfo<T>& args);\n "
        },
        {
            "sha": "5bceae0ce00c8bb9b4c288c781bfd81573ae1a69",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -4582,6 +4582,8 @@ bool ECDH::IsKeyPairValid() {\n }\n \n \n+// TODO(addaleax): If there is an `AsyncWrap`, it currently has no access to\n+// this object. This makes proper reporting of memory usage impossible.\n struct CryptoJob : public ThreadPoolWork {\n   Environment* const env;\n   std::unique_ptr<AsyncWrap> async_wrap;"
        },
        {
            "sha": "7df2660c779760b55943001edb6e8fedc2e67e0d",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -105,6 +105,10 @@ class SecureContext : public BaseObject {\n \n   static void Initialize(Environment* env, v8::Local<v8::Object> target);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n   SSLCtxPointer ctx_;\n   X509Pointer cert_;\n   X509Pointer issuer_;\n@@ -337,6 +341,10 @@ class CipherBase : public BaseObject {\n  public:\n   static void Initialize(Environment* env, v8::Local<v8::Object> target);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  protected:\n   enum CipherKind {\n     kCipher,\n@@ -407,6 +415,10 @@ class Hmac : public BaseObject {\n  public:\n   static void Initialize(Environment* env, v8::Local<v8::Object> target);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  protected:\n   void HmacInit(const char* hash_type, const char* key, int key_len);\n   bool HmacUpdate(const char* data, int len);\n@@ -430,6 +442,10 @@ class Hash : public BaseObject {\n  public:\n   static void Initialize(Environment* env, v8::Local<v8::Object> target);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n   bool HashInit(const char* hash_type);\n   bool HashUpdate(const char* data, int len);\n \n@@ -469,6 +485,10 @@ class SignBase : public BaseObject {\n   Error Init(const char* sign_type);\n   Error Update(const char* data, int len);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  protected:\n   void CheckThrow(Error error);\n \n@@ -581,6 +601,10 @@ class DiffieHellman : public BaseObject {\n     MakeWeak();\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  private:\n   static void GetField(const v8::FunctionCallbackInfo<v8::Value>& args,\n                        const BIGNUM* (*get_field)(const DH*),\n@@ -606,6 +630,10 @@ class ECDH : public BaseObject {\n                                       char* data,\n                                       size_t len);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  protected:\n   ECDH(Environment* env, v8::Local<v8::Object> wrap, ECKeyPointer&& key)\n       : BaseObject(env, wrap),"
        },
        {
            "sha": "dea010fa0158b44f80a120988873718728919a24",
            "filename": "src/node_crypto_bio.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto_bio.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_crypto_bio.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto_bio.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -32,7 +32,7 @@\n namespace node {\n namespace crypto {\n \n-class NodeBIO {\n+class NodeBIO : public MemoryRetainer {\n  public:\n   NodeBIO() : env_(nullptr),\n               initial_(kInitialBufferLength),\n@@ -110,6 +110,11 @@ class NodeBIO {\n \n   static NodeBIO* FromBIO(BIO* bio);\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackFieldWithSize(\"buffer\", length_);\n+  }\n+\n  private:\n   static int New(BIO* bio);\n   static int Free(BIO* bio);"
        },
        {
            "sha": "6b45dc881750a7b09ea3612e46f33ab28fb41413",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 23,
            "deletions": 4,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -66,7 +66,6 @@ class FSReqBase : public ReqWrap<uv_fs_t> {\n   const char* data() const { return has_data_ ? *buffer_ : nullptr; }\n   enum encoding encoding() const { return encoding_; }\n \n-  size_t self_size() const override { return sizeof(*this); }\n   bool use_bigint() const { return use_bigint_; }\n \n  private:\n@@ -92,6 +91,10 @@ class FSReqWrap : public FSReqBase {\n   void ResolveStat(const uv_stat_t* stat) override;\n   void SetReturnValue(const FunctionCallbackInfo<Value>& args) override;\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  private:\n   DISALLOW_COPY_AND_ASSIGN(FSReqWrap);\n };\n@@ -150,6 +153,11 @@ class FSReqPromise : public FSReqBase {\n     args.GetReturnValue().Set(resolver->GetPromise());\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"stats_field_array\", stats_field_array_);\n+  }\n+\n  private:\n   bool finished_ = false;\n   AliasedBuffer<NativeT, V8T> stats_field_array_;\n@@ -184,7 +192,10 @@ class FileHandleReadWrap : public ReqWrap<uv_fs_t> {\n     return static_cast<FileHandleReadWrap*>(ReqWrap::from_req(req));\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"buffer\", buffer_);\n+  }\n \n  private:\n   FileHandle* file_handle_;\n@@ -205,7 +216,6 @@ class FileHandle : public AsyncWrap, public StreamBase {\n   static void New(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n   int fd() const { return fd_; }\n-  size_t self_size() const override { return sizeof(*this); }\n \n   // Will asynchronously close the FD and return a Promise that will\n   // be resolved once closing is complete.\n@@ -233,6 +243,11 @@ class FileHandle : public AsyncWrap, public StreamBase {\n     return UV_ENOSYS;  // Not implemented (yet).\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"current_read\", current_read_);\n+  }\n+\n  private:\n   // Synchronous close that emits a warning\n   void Close();\n@@ -259,7 +274,11 @@ class FileHandle : public AsyncWrap, public StreamBase {\n \n     FileHandle* file_handle();\n \n-    size_t self_size() const override { return sizeof(*this); }\n+    void MemoryInfo(MemoryTracker* tracker) const override {\n+      tracker->TrackThis(this);\n+      tracker->TrackField(\"promise\", promise_);\n+      tracker->TrackField(\"ref\", ref_);\n+    }\n \n     void Resolve();\n "
        },
        {
            "sha": "7a5e9ba23e99b3a95a59d8011a37f688de961f13",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 6,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -737,15 +737,15 @@ inline void Http2Session::AddStream(Http2Stream* stream) {\n   size_t size = streams_.size();\n   if (size > statistics_.max_concurrent_streams)\n     statistics_.max_concurrent_streams = size;\n-  IncrementCurrentSessionMemory(stream->self_size());\n+  IncrementCurrentSessionMemory(sizeof(*stream));\n }\n \n \n inline void Http2Session::RemoveStream(Http2Stream* stream) {\n   if (streams_.empty() || stream == nullptr)\n     return;  // Nothing to remove, item was never added?\n   streams_.erase(stream->id());\n-  DecrementCurrentSessionMemory(stream->self_size());\n+  DecrementCurrentSessionMemory(sizeof(*stream));\n }\n \n // Used as one of the Padding Strategy functions. Will attempt to ensure\n@@ -2694,7 +2694,7 @@ Http2Session::Http2Ping* Http2Session::PopPing() {\n   if (!outstanding_pings_.empty()) {\n     ping = outstanding_pings_.front();\n     outstanding_pings_.pop();\n-    DecrementCurrentSessionMemory(ping->self_size());\n+    DecrementCurrentSessionMemory(sizeof(*ping));\n   }\n   return ping;\n }\n@@ -2703,7 +2703,7 @@ bool Http2Session::AddPing(Http2Session::Http2Ping* ping) {\n   if (outstanding_pings_.size() == max_outstanding_pings_)\n     return false;\n   outstanding_pings_.push(ping);\n-  IncrementCurrentSessionMemory(ping->self_size());\n+  IncrementCurrentSessionMemory(sizeof(*ping));\n   return true;\n }\n \n@@ -2712,7 +2712,7 @@ Http2Session::Http2Settings* Http2Session::PopSettings() {\n   if (!outstanding_settings_.empty()) {\n     settings = outstanding_settings_.front();\n     outstanding_settings_.pop();\n-    DecrementCurrentSessionMemory(settings->self_size());\n+    DecrementCurrentSessionMemory(sizeof(*settings));\n   }\n   return settings;\n }\n@@ -2721,7 +2721,7 @@ bool Http2Session::AddSettings(Http2Session::Http2Settings* settings) {\n   if (outstanding_settings_.size() == max_outstanding_settings_)\n     return false;\n   outstanding_settings_.push(settings);\n-  IncrementCurrentSessionMemory(settings->self_size());\n+  IncrementCurrentSessionMemory(sizeof(*settings));\n   return true;\n }\n \n@@ -2766,6 +2766,21 @@ void Http2Session::Http2Ping::Done(bool ack, const uint8_t* payload) {\n }\n \n \n+void nghttp2_stream_write::MemoryInfo(MemoryTracker* tracker) const {\n+  tracker->TrackThis(this);\n+  if (req_wrap != nullptr)\n+    tracker->TrackField(\"req_wrap\", req_wrap->GetAsyncWrap());\n+  tracker->TrackField(\"buf\", buf);\n+}\n+\n+\n+void nghttp2_header::MemoryInfo(MemoryTracker* tracker) const {\n+  tracker->TrackThis(this);\n+  tracker->TrackFieldWithSize(\"name\", nghttp2_rcbuf_get_buf(name).len);\n+  tracker->TrackFieldWithSize(\"value\", nghttp2_rcbuf_get_buf(value).len);\n+}\n+\n+\n // Set up the process.binding('http2') binding.\n void Initialize(Local<Object> target,\n                 Local<Value> unused,"
        },
        {
            "sha": "cbed2a267d171e85cd2b7e8bca0184f8ba2b142b",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -83,19 +83,23 @@ enum nghttp2_stream_options {\n   STREAM_OPTION_GET_TRAILERS = 0x2,\n };\n \n-struct nghttp2_stream_write {\n+struct nghttp2_stream_write : public MemoryRetainer {\n   WriteWrap* req_wrap = nullptr;\n   uv_buf_t buf;\n \n   inline explicit nghttp2_stream_write(uv_buf_t buf_) : buf(buf_) {}\n   inline nghttp2_stream_write(WriteWrap* req, uv_buf_t buf_) :\n       req_wrap(req), buf(buf_) {}\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override;\n };\n \n-struct nghttp2_header {\n+struct nghttp2_header : public MemoryRetainer {\n   nghttp2_rcbuf* name = nullptr;\n   nghttp2_rcbuf* value = nullptr;\n   uint8_t flags = 0;\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override;\n };\n \n \n@@ -617,7 +621,12 @@ class Http2Stream : public AsyncWrap,\n   int DoWrite(WriteWrap* w, uv_buf_t* bufs, size_t count,\n               uv_stream_t* send_handle) override;\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"current_headers\", current_headers_);\n+    tracker->TrackField(\"queue\", queue_);\n+  }\n+\n   std::string diagnostic_name() const override;\n \n   // JavaScript API\n@@ -793,7 +802,17 @@ class Http2Session : public AsyncWrap, public StreamListener {\n   // Write data to the session\n   ssize_t Write(const uv_buf_t* bufs, size_t nbufs);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"streams\", streams_);\n+    tracker->TrackField(\"outstanding_pings\", outstanding_pings_);\n+    tracker->TrackField(\"outstanding_settings\", outstanding_settings_);\n+    tracker->TrackField(\"outgoing_buffers\", outgoing_buffers_);\n+    tracker->TrackFieldWithSize(\"outgoing_storage\", outgoing_storage_.size());\n+    tracker->TrackFieldWithSize(\"pending_rst_streams\",\n+                                pending_rst_streams_.size() * sizeof(int32_t));\n+  }\n+\n   std::string diagnostic_name() const override;\n \n   // Schedule an RstStream for after the current write finishes.\n@@ -1109,7 +1128,10 @@ class Http2Session::Http2Ping : public AsyncWrap {\n  public:\n   explicit Http2Ping(Http2Session* session);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"session\", session_);\n+  }\n \n   void Send(uint8_t* payload);\n   void Done(bool ack, const uint8_t* payload = nullptr);\n@@ -1129,7 +1151,10 @@ class Http2Session::Http2Settings : public AsyncWrap {\n   explicit Http2Settings(Environment* env);\n   explicit Http2Settings(Http2Session* session);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"session\", session_);\n+  }\n \n   void Send();\n   void Done(bool ack);"
        },
        {
            "sha": "e8fc1f22e4938aae48f7b4c2540abe5671194cca",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -155,8 +155,9 @@ class Parser : public AsyncWrap, public StreamListener {\n   }\n \n \n-  size_t self_size() const override {\n-    return sizeof(*this);\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"current_buffer\", current_buffer_);\n   }\n \n "
        },
        {
            "sha": "288ad77f6191887d756da05b7c603b3e92904b24",
            "filename": "src/node_i18n.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_i18n.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_i18n.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_i18n.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -250,6 +250,10 @@ class ConverterObject : public BaseObject, Converter {\n     }\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  protected:\n   ConverterObject(Environment* env,\n                   v8::Local<v8::Object> wrap,"
        },
        {
            "sha": "20e0c7673b8fa9379521ebd83e191dc5a53606f9",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -325,13 +325,27 @@ Maybe<bool> Message::Serialize(Environment* env,\n   return Just(true);\n }\n \n+void Message::MemoryInfo(MemoryTracker* tracker) const {\n+  tracker->TrackThis(this);\n+  tracker->TrackField(\"array_buffer_contents\", array_buffer_contents_);\n+  tracker->TrackFieldWithSize(\"shared_array_buffers\",\n+      shared_array_buffers_.size() * sizeof(shared_array_buffers_[0]));\n+  tracker->TrackField(\"message_ports\", message_ports_);\n+}\n+\n MessagePortData::MessagePortData(MessagePort* owner) : owner_(owner) { }\n \n MessagePortData::~MessagePortData() {\n   CHECK_EQ(owner_, nullptr);\n   Disentangle();\n }\n \n+void MessagePortData::MemoryInfo(MemoryTracker* tracker) const {\n+  Mutex::ScopedLock lock(mutex_);\n+  tracker->TrackThis(this);\n+  tracker->TrackField(\"incoming_messages\", incoming_messages_);\n+}\n+\n void MessagePortData::AddToIncomingQueue(Message&& message) {\n   // This function will be called by other threads.\n   Mutex::ScopedLock lock(mutex_);\n@@ -688,14 +702,6 @@ void MessagePort::Drain(const FunctionCallbackInfo<Value>& args) {\n   port->OnMessage();\n }\n \n-size_t MessagePort::self_size() const {\n-  Mutex::ScopedLock lock(data_->mutex_);\n-  size_t sz = sizeof(*this) + sizeof(*data_);\n-  for (const Message& msg : data_->incoming_messages_)\n-    sz += sizeof(msg) + msg.main_message_buf_.size;\n-  return sz;\n-}\n-\n void MessagePort::Entangle(MessagePort* a, MessagePort* b) {\n   Entangle(a, b->data_.get());\n }"
        },
        {
            "sha": "da10300aedbd42ac365d6db190eeb49ec65d1d7f",
            "filename": "src/node_messaging.h",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_messaging.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_messaging.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -15,7 +15,7 @@ class MessagePortData;\n class MessagePort;\n \n // Represents a single communication message.\n-class Message {\n+class Message : public MemoryRetainer {\n  public:\n   explicit Message(MallocedBuffer<char>&& payload = MallocedBuffer<char>());\n \n@@ -55,6 +55,8 @@ class Message {\n     return message_ports_;\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override;\n+\n  private:\n   MallocedBuffer<char> main_message_buf_;\n   std::vector<MallocedBuffer<char>> array_buffer_contents_;\n@@ -66,7 +68,7 @@ class Message {\n \n // This contains all data for a `MessagePort` instance that is not tied to\n // a specific Environment/Isolate/event loop, for easier transfer between those.\n-class MessagePortData {\n+class MessagePortData : public MemoryRetainer {\n  public:\n   explicit MessagePortData(MessagePort* owner);\n   ~MessagePortData();\n@@ -94,6 +96,8 @@ class MessagePortData {\n   // which can happen on either side of a worker.\n   void Disentangle();\n \n+  void MemoryInfo(MemoryTracker* tracker) const override;\n+\n  private:\n   // After disentangling this message port, the owner handle (if any)\n   // is asynchronously triggered, so that it can close down naturally.\n@@ -178,7 +182,10 @@ class MessagePort : public HandleWrap {\n   // NULL pointer to the C++ MessagePort object is also detached.\n   inline bool IsDetached() const;\n \n-  size_t self_size() const override;\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"data\", data_);\n+  }\n \n  private:\n   void OnClose() override;"
        },
        {
            "sha": "4b2cc60b3f7584f4184799e84457874538351176",
            "filename": "src/node_serdes.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_serdes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_serdes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_serdes.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -52,6 +52,11 @@ class SerializerContext : public BaseObject,\n   static void WriteUint64(const FunctionCallbackInfo<Value>& args);\n   static void WriteDouble(const FunctionCallbackInfo<Value>& args);\n   static void WriteRawBytes(const FunctionCallbackInfo<Value>& args);\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  private:\n   ValueSerializer serializer_;\n };\n@@ -76,6 +81,11 @@ class DeserializerContext : public BaseObject,\n   static void ReadUint64(const FunctionCallbackInfo<Value>& args);\n   static void ReadDouble(const FunctionCallbackInfo<Value>& args);\n   static void ReadRawBytes(const FunctionCallbackInfo<Value>& args);\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  private:\n   const uint8_t* data_;\n   const size_t length_;"
        },
        {
            "sha": "baf6bdc14ee3175c05516cebb2e6526cc3e68be9",
            "filename": "src/node_stat_watcher.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_stat_watcher.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_stat_watcher.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -44,7 +44,9 @@ class StatWatcher : public HandleWrap {\n   static void New(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void Start(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   static void Callback(uv_fs_poll_t* handle,"
        },
        {
            "sha": "0904311dad865b8e472243a8d6f1b35a2cd78acd",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -27,6 +27,11 @@ class NodeCategorySet : public BaseObject {\n \n   const std::set<std::string>& GetCategories() { return categories_; }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackField(\"categories\", categories_);\n+  }\n+\n  private:\n   NodeCategorySet(Environment* env,\n                   Local<Object> wrap,"
        },
        {
            "sha": "3768d80a9c58d4613cc2376b39ffd8079b804b1e",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -403,10 +403,6 @@ void Worker::Exit(int code) {\n   }\n }\n \n-size_t Worker::self_size() const {\n-  return sizeof(*this);\n-}\n-\n namespace {\n \n // Return the MessagePort that is global for this Environment and communicates"
        },
        {
            "sha": "bd737d4800fd7931682d59c0f58ff2334d4bdd0a",
            "filename": "src/node_worker.h",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_worker.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_worker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -25,7 +25,14 @@ class Worker : public AsyncWrap {\n   // Wait for the worker thread to stop (in a blocking manner).\n   void JoinThread();\n \n-  size_t self_size() const override;\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackFieldWithSize(\"isolate_data\", sizeof(IsolateData));\n+    tracker->TrackFieldWithSize(\"env\", sizeof(Environment));\n+    tracker->TrackFieldWithSize(\"thread_exit_async\", sizeof(uv_async_t));\n+    tracker->TrackField(\"parent_port\", parent_port_);\n+  }\n+\n   bool is_stopped() const;\n \n   static void New(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "031666e19ad29c67aadc6e04860ccd606dd7bd1c",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -646,7 +646,12 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n     }\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackFieldWithSize(\"dictionary\", dictionary_len_);\n+    tracker->TrackFieldWithSize(\"zlib memory\",\n+        zlib_memory_ + unreported_allocations_);\n+  }\n \n  private:\n   void Ref() {"
        },
        {
            "sha": "9ed4f153ae5c4c2417725e44d62ef8943200a32b",
            "filename": "src/pipe_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fpipe_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fpipe_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -45,7 +45,9 @@ class PipeWrap : public ConnectionWrap<PipeWrap, uv_pipe_t> {\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   PipeWrap(Environment* env,"
        },
        {
            "sha": "b9a20c34a770ba9fff684479b51877cfae4c57a5",
            "filename": "src/process_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fprocess_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fprocess_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fprocess_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -66,7 +66,9 @@ class ProcessWrap : public HandleWrap {\n     target->Set(processString, constructor->GetFunction());\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   static void New(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "95fed87c8d4ea0990b1236e37e5df81d0e7b9990",
            "filename": "src/sharedarraybuffer_metadata.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fsharedarraybuffer_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fsharedarraybuffer_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fsharedarraybuffer_metadata.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -47,6 +47,10 @@ class SABLifetimePartner : public BaseObject {\n     MakeWeak();\n   }\n \n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n   SharedArrayBufferMetadataReference reference;\n };\n "
        },
        {
            "sha": "043aa3f10e4254d4c653a79dee75f209c0cf9d19",
            "filename": "src/signal_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fsignal_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fsignal_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fsignal_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -60,7 +60,9 @@ class SignalWrap : public HandleWrap {\n     target->Set(signalString, constructor->GetFunction());\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   static void New(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "bbb20e52e1a8de9f88169aecc24a2c52c61334b1",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -346,7 +346,10 @@ class SimpleShutdownWrap : public ShutdownWrap, public OtherBase {\n                      v8::Local<v8::Object> req_wrap_obj);\n \n   AsyncWrap* GetAsyncWrap() override { return this; }\n-  size_t self_size() const override { return sizeof(*this); }\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n };\n \n template <typename OtherBase>\n@@ -356,7 +359,11 @@ class SimpleWriteWrap : public WriteWrap, public OtherBase {\n                   v8::Local<v8::Object> req_wrap_obj);\n \n   AsyncWrap* GetAsyncWrap() override { return this; }\n-  size_t self_size() const override { return sizeof(*this) + StorageSize(); }\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+    tracker->TrackFieldWithSize(\"storage\", StorageSize());\n+  }\n };\n \n }  // namespace node"
        },
        {
            "sha": "b72a60941b610ac488393a0393db570e2f4ba6c5",
            "filename": "src/stream_pipe.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fstream_pipe.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fstream_pipe.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_pipe.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -18,7 +18,9 @@ class StreamPipe : public AsyncWrap {\n   static void Start(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void Unpipe(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   StreamBase* source();"
        },
        {
            "sha": "d6ca9306099e378455d194abe5253a71b27d9700",
            "filename": "src/tcp_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ftcp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ftcp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -44,7 +44,9 @@ class TCPWrap : public ConnectionWrap<TCPWrap, uv_tcp_t> {\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context);\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   typedef uv_tcp_t HandleType;"
        },
        {
            "sha": "c3962e83eef1eba47f883e0b246565b61f246f74",
            "filename": "src/timer_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ftimer_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ftimer_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftimer_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -67,7 +67,9 @@ class TimerWrap : public HandleWrap {\n                    ->GetFunction(env->context()).ToLocalChecked()).FromJust();\n   }\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   static void SetupTimers(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "0d0791b710c860a6bd958eb10bd232cac90edb87",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -864,6 +864,15 @@ void TLSWrap::GetWriteQueueSize(const FunctionCallbackInfo<Value>& info) {\n }\n \n \n+void TLSWrap::MemoryInfo(MemoryTracker* tracker) const {\n+  tracker->TrackThis(this);\n+  tracker->TrackField(\"error\", error_);\n+  tracker->TrackField(\"pending_cleartext_input\", pending_cleartext_input_);\n+  tracker->TrackField(\"enc_in\", crypto::NodeBIO::FromBIO(enc_in_));\n+  tracker->TrackField(\"enc_out\", crypto::NodeBIO::FromBIO(enc_out_));\n+}\n+\n+\n void TLSWrap::Initialize(Local<Object> target,\n                          Local<Value> unused,\n                          Local<Context> context) {"
        },
        {
            "sha": "b45e379ca3f61c241a06d931ee9487f6bb591a1e",
            "filename": "src/tls_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ftls_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ftls_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -76,7 +76,7 @@ class TLSWrap : public AsyncWrap,\n \n   void NewSessionDoneCb();\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override;\n \n  protected:\n   inline StreamBase* underlying_stream() {"
        },
        {
            "sha": "cca5650ddb396498cc1630b446801208187dc002",
            "filename": "src/tty_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Ftty_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Ftty_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftty_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -38,7 +38,9 @@ class TTYWrap : public LibuvStreamWrap {\n \n   uv_tty_t* UVHandle();\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   TTYWrap(Environment* env,"
        },
        {
            "sha": "e5243319a553e7c347221f25943cb1e9d96e3017",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -55,7 +55,11 @@ class SendWrap : public ReqWrap<uv_udp_send_t> {\n   SendWrap(Environment* env, Local<Object> req_wrap_obj, bool have_callback);\n   inline bool have_callback() const;\n   size_t msg_size;\n-  size_t self_size() const override { return sizeof(*this); }\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+\n  private:\n   const bool have_callback_;\n };"
        },
        {
            "sha": "3792bcc459da23297c01cccb1aa79b1359a55cc3",
            "filename": "src/udp_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/src%2Fudp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/src%2Fudp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.h?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -64,7 +64,9 @@ class UDPWrap: public HandleWrap {\n                                            SocketType type);\n   uv_udp_t* UVHandle();\n \n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n  private:\n   typedef uv_udp_t HandleType;"
        },
        {
            "sha": "e9acd629f35f914e075ae8fcdfd033301d53a2d6",
            "filename": "test/cctest/test_node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/57e301539bff2599974b7269a56377330c9b730e/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/57e301539bff2599974b7269a56377330c9b730e/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_node_postmortem_metadata.cc?ref=57e301539bff2599974b7269a56377330c9b730e",
            "patch": "@@ -34,7 +34,9 @@ class DebugSymbolsTest : public EnvironmentTestFixture {};\n \n class TestHandleWrap : public node::HandleWrap {\n  public:\n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(node::MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n   TestHandleWrap(node::Environment* env,\n                  v8::Local<v8::Object> object,\n@@ -48,7 +50,9 @@ class TestHandleWrap : public node::HandleWrap {\n \n class TestReqWrap : public node::ReqWrap<uv_req_t> {\n  public:\n-  size_t self_size() const override { return sizeof(*this); }\n+  void MemoryInfo(node::MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n \n   TestReqWrap(node::Environment* env, v8::Local<v8::Object> object)\n       : node::ReqWrap<uv_req_t>(env,\n@@ -67,6 +71,16 @@ TEST_F(DebugSymbolsTest, ExternalStringDataOffset) {\n             NODE_OFF_EXTSTR_DATA);\n }\n \n+class DummyBaseObject : public node::BaseObject {\n+ public:\n+  DummyBaseObject(node::Environment* env, v8::Local<v8::Object> obj) :\n+    BaseObject(env, obj) {}\n+\n+  void MemoryInfo(node::MemoryTracker* tracker) const override {\n+    tracker->TrackThis(this);\n+  }\n+};\n+\n TEST_F(DebugSymbolsTest, BaseObjectPersistentHandle) {\n   const v8::HandleScope handle_scope(isolate_);\n   const Argv argv;\n@@ -77,7 +91,7 @@ TEST_F(DebugSymbolsTest, BaseObjectPersistentHandle) {\n \n   v8::Local<v8::Object> object =\n       obj_templ->NewInstance(env.context()).ToLocalChecked();\n-  node::BaseObject obj(*env, object);\n+  DummyBaseObject obj(*env, object);\n \n   auto expected = reinterpret_cast<uintptr_t>(&obj.persistent());\n   auto calculated = reinterpret_cast<uintptr_t>(&obj) +"
        }
    ],
    "stats": {
        "total": 657,
        "additions": 566,
        "deletions": 91
    }
}