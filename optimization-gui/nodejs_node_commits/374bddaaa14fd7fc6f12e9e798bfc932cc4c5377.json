{
    "author": "sam-github",
    "message": "test: rework ephemeralkeyinfo to run in parallel\n\nRemove:\n- use of tls global so tests can run in parallel\n- test counting in favour of common.mustCall()\n- limit of only one cipher suite per ephemeral key type tested\n\nThe last change  will allow adding TLS 1.3 cipher suites and testing\n'ECDH' key info with them.\n\nPR-URL: https://github.com/nodejs/node/pull/25409\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "374bddaaa14fd7fc6f12e9e798bfc932cc4c5377",
    "files": [
        {
            "sha": "a5db18a5652b45ffa038ead637f4fa03a5f317de",
            "filename": "test/parallel/test-tls-client-getephemeralkeyinfo.js",
            "status": "modified",
            "additions": 15,
            "deletions": 56,
            "changes": 71,
            "blob_url": "https://github.com/nodejs/node/blob/374bddaaa14fd7fc6f12e9e798bfc932cc4c5377/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js",
            "raw_url": "https://github.com/nodejs/node/raw/374bddaaa14fd7fc6f12e9e798bfc932cc4c5377/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js?ref=374bddaaa14fd7fc6f12e9e798bfc932cc4c5377",
            "patch": "@@ -10,90 +10,49 @@ const tls = require('tls');\n const key = fixtures.readKey('agent2-key.pem');\n const cert = fixtures.readKey('agent2-cert.pem');\n \n-let ntests = 0;\n-let nsuccess = 0;\n-\n function loadDHParam(n) {\n   return fixtures.readKey(`dh${n}.pem`);\n }\n \n-const cipherlist = {\n-  'NOT_PFS': 'AES128-SHA256',\n-  'DH': 'DHE-RSA-AES128-GCM-SHA256',\n-  'ECDH': 'ECDHE-RSA-AES128-GCM-SHA256'\n-};\n-\n-function test(size, type, name, next) {\n-  const cipher = type ? cipherlist[type] : cipherlist.NOT_PFS;\n-\n-  if (name) tls.DEFAULT_ECDH_CURVE = name;\n+function test(size, type, name, cipher) {\n+  assert(cipher);\n \n   const options = {\n     key: key,\n     cert: cert,\n     ciphers: cipher\n   };\n \n+  if (name) options.ecdhCurve = name;\n+\n   if (type === 'DH') options.dhparam = loadDHParam(size);\n \n-  const server = tls.createServer(options, function(conn) {\n+  const server = tls.createServer(options, common.mustCall((conn) => {\n     assert.strictEqual(conn.getEphemeralKeyInfo(), null);\n     conn.end();\n-  });\n+  }));\n \n-  server.on('close', common.mustCall(function(err) {\n+  server.on('close', common.mustCall((err) => {\n     assert.ifError(err);\n-    if (next) next();\n   }));\n \n-  server.listen(0, '127.0.0.1', common.mustCall(function() {\n+  server.listen(0, '127.0.0.1', common.mustCall(() => {\n     const client = tls.connect({\n-      port: this.address().port,\n+      port: server.address().port,\n       rejectUnauthorized: false\n     }, function() {\n       const ekeyinfo = client.getEphemeralKeyInfo();\n       assert.strictEqual(ekeyinfo.type, type);\n       assert.strictEqual(ekeyinfo.size, size);\n       assert.strictEqual(ekeyinfo.name, name);\n-      nsuccess++;\n       server.close();\n     });\n   }));\n }\n \n-function testNOT_PFS() {\n-  test(undefined, undefined, undefined, testDHE1024);\n-  ntests++;\n-}\n-\n-function testDHE1024() {\n-  test(1024, 'DH', undefined, testDHE2048);\n-  ntests++;\n-}\n-\n-function testDHE2048() {\n-  test(2048, 'DH', undefined, testECDHE256);\n-  ntests++;\n-}\n-\n-function testECDHE256() {\n-  test(256, 'ECDH', 'prime256v1', testECDHE512);\n-  ntests++;\n-}\n-\n-function testECDHE512() {\n-  test(521, 'ECDH', 'secp521r1', testX25519);\n-  ntests++;\n-}\n-\n-function testX25519() {\n-  test(253, 'ECDH', 'X25519', null);\n-  ntests++;\n-}\n-\n-testNOT_PFS();\n-\n-process.on('exit', function() {\n-  assert.strictEqual(ntests, nsuccess);\n-  assert.strictEqual(ntests, 6);\n-});\n+test(undefined, undefined, undefined, 'AES128-SHA256');\n+test(1024, 'DH', undefined, 'DHE-RSA-AES128-GCM-SHA256');\n+test(2048, 'DH', undefined, 'DHE-RSA-AES128-GCM-SHA256');\n+test(256, 'ECDH', 'prime256v1', 'ECDHE-RSA-AES128-GCM-SHA256');\n+test(521, 'ECDH', 'secp521r1', 'ECDHE-RSA-AES128-GCM-SHA256');\n+test(253, 'ECDH', 'X25519', 'ECDHE-RSA-AES128-GCM-SHA256');"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 15,
        "deletions": 56
    }
}