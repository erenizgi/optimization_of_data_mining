{
    "author": "danbev",
    "message": "src: set thread local env in CreateEnvironment\n\nThis commit set the Environment as a thread local when CreateEnvironment\nis called which is currently not being done. This would lead to a\nsegment fault if later node::AtExit is called without specifying the\nenvironment parameter. This specific issue was reported by Electron.\n\nIf I recall correctly, back when this was implemented the motivation was\nthat if embedders have multiple environments per isolate they should be\nusing the AtExit functions that take an environment. This is not the\ncase with Electron which only create a single environment (as far as I\nknow), and if a native module calls AtExit this would lead to the\nsegment fault.\n\nI was able to reproduce Electron issue and the provided test simulates\nit. I was also able to use this patch and verify that it works for the\nElectron issue as well.\n\nPR-URL: https://github.com/nodejs/node/pull/18573\nRefs: https://github.com/nodejs/node/pull/9163\nRefs: https://github.com/electron/electron/issues/11299\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Matheus Marchini <matheus@sthima.com>",
    "sha": "42c14c5c17c427aa82722fff41f3e723354239b9",
    "files": [
        {
            "sha": "1e64a0fda5f6e9a33573344e9c595207acea976a",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=42c14c5c17c427aa82722fff41f3e723354239b9",
            "patch": "@@ -311,6 +311,10 @@ inline Environment* Environment::GetCurrent(\n       info.Data().template As<v8::External>()->Value());\n }\n \n+inline Environment* Environment::GetThreadLocalEnv() {\n+  return static_cast<Environment*>(uv_key_get(&thread_local_env));\n+}\n+\n inline Environment::Environment(IsolateData* isolate_data,\n                                 v8::Local<v8::Context> context)\n     : isolate_(context->GetIsolate()),"
        },
        {
            "sha": "cb1f4a231b548130647e3993f02cf711b374452b",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=42c14c5c17c427aa82722fff41f3e723354239b9",
            "patch": "@@ -80,6 +80,11 @@ v8::CpuProfiler* IsolateData::GetCpuProfiler() {\n   return cpu_profiler_;\n }\n \n+\n+void InitThreadLocalOnce() {\n+  CHECK_EQ(0, uv_key_create(&Environment::thread_local_env));\n+}\n+\n void Environment::Start(int argc,\n                         const char* const* argv,\n                         int exec_argc,\n@@ -147,6 +152,10 @@ void Environment::Start(int argc,\n \n   SetupProcessObject(this, argc, argv, exec_argc, exec_argv);\n   LoadAsyncWrapperInfo(this);\n+\n+  static uv_once_t init_once = UV_ONCE_INIT;\n+  uv_once(&init_once, InitThreadLocalOnce);\n+  uv_key_set(&thread_local_env, this);\n }\n \n void Environment::CleanupHandles() {\n@@ -471,4 +480,6 @@ void Environment::AsyncHooks::grow_async_ids_stack() {\n       async_ids_stack_.GetJSArray()).FromJust();\n }\n \n+uv_key_t Environment::thread_local_env = {};\n+\n }  // namespace node"
        },
        {
            "sha": "a9118082b8addaf7d65d502bcc89ee68c78edf90",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=42c14c5c17c427aa82722fff41f3e723354239b9",
            "patch": "@@ -564,6 +564,9 @@ class Environment {\n   static inline Environment* GetCurrent(\n       const v8::PropertyCallbackInfo<T>& info);\n \n+  static uv_key_t thread_local_env;\n+  static inline Environment* GetThreadLocalEnv();\n+\n   inline Environment(IsolateData* isolate_data, v8::Local<v8::Context> context);\n   inline ~Environment();\n "
        },
        {
            "sha": "0d62c89b030703013037214f8af3cd720420a57d",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/42c14c5c17c427aa82722fff41f3e723354239b9/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=42c14c5c17c427aa82722fff41f3e723354239b9",
            "patch": "@@ -4207,11 +4207,8 @@ uv_loop_t* GetCurrentEventLoop(v8::Isolate* isolate) {\n }\n \n \n-static uv_key_t thread_local_env;\n-\n-\n void AtExit(void (*cb)(void* arg), void* arg) {\n-  auto env = static_cast<Environment*>(uv_key_get(&thread_local_env));\n+  auto env = Environment::GetThreadLocalEnv();\n   AtExit(env, cb, arg);\n }\n \n@@ -4342,8 +4339,6 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n   Environment env(isolate_data, context);\n-  CHECK_EQ(0, uv_key_create(&thread_local_env));\n-  uv_key_set(&thread_local_env, &env);\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n   const char* path = argc > 1 ? argv[1] : nullptr;\n@@ -4393,7 +4388,6 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n \n   const int exit_code = EmitExit(&env);\n   RunAtExit(&env);\n-  uv_key_delete(&thread_local_env);\n \n   v8_platform.DrainVMTasks(isolate);\n   v8_platform.CancelVMTasks(isolate);"
        },
        {
            "sha": "07170ac267adeaf634ff8f5766170cd739b8f256",
            "filename": "test/cctest/test_environment.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/42c14c5c17c427aa82722fff41f3e723354239b9/test%2Fcctest%2Ftest_environment.cc",
            "raw_url": "https://github.com/nodejs/node/raw/42c14c5c17c427aa82722fff41f3e723354239b9/test%2Fcctest%2Ftest_environment.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_environment.cc?ref=42c14c5c17c427aa82722fff41f3e723354239b9",
            "patch": "@@ -33,6 +33,16 @@ TEST_F(EnvironmentTest, AtExitWithEnvironment) {\n   EXPECT_TRUE(called_cb_1);\n }\n \n+TEST_F(EnvironmentTest, AtExitWithoutEnvironment) {\n+  const v8::HandleScope handle_scope(isolate_);\n+  const Argv argv;\n+  Env env {handle_scope, argv};\n+\n+  AtExit(at_exit_callback1);  // No Environment is passed to AtExit.\n+  RunAtExit(*env);\n+  EXPECT_TRUE(called_cb_1);\n+}\n+\n TEST_F(EnvironmentTest, AtExitWithArgument) {\n   const v8::HandleScope handle_scope(isolate_);\n   const Argv argv;"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 29,
        "deletions": 7
    }
}