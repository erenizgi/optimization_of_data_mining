{
    "author": "laverdet",
    "message": "deps: cherry-pick 22116dd from upstream V8\n\nRefs: https://github.com/v8/v8/commit/22116dd6c884c026225e56dd8e442a660193e729\n\nOriginal commit message:\n\n    [snapshot] fix resetting function code.\n\n    Unconditionally setting the JSFunction code to that of the SFI\n    may skip initializing the feedback vector.\n\n    R=leszeks@chromium.org\n\n    Bug: v8:7857\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: I65d4bf32493be4cade2eaf3d665d44f93e80f809\n    Reviewed-on: https://chromium-review.googlesource.com/1107618\n    Commit-Queue: Yang Guo <yangguo@chromium.org>\n    Reviewed-by: Leszek Swirski <leszeks@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#53881}\n\nPR-URL: https://github.com/nodejs/node/pull/21992\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "0d3da39f575afba5ab6a5a34f4e88a798a66dc6d",
    "files": [
        {
            "sha": "1e154381b0e9d03262644b03e8ec4ee8c1bacc1f",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=0d3da39f575afba5ab6a5a34f4e88a798a66dc6d",
            "patch": "@@ -29,7 +29,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.25',\n+    'v8_embedder_string': '-node.26',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "5df3188ab61006ae5a0ac91c233f746e000ef3fe",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=0d3da39f575afba5ab6a5a34f4e88a798a66dc6d",
            "patch": "@@ -766,8 +766,11 @@ StartupData SnapshotCreator::CreateBlob(\n       // Complete in-object slack tracking for all functions.\n       fun->CompleteInobjectSlackTrackingIfActive();\n \n-      // Also, clear out feedback vectors.\n-      fun->feedback_cell()->set_value(isolate->heap()->undefined_value());\n+      // Also, clear out feedback vectors, or any optimized code.\n+      if (fun->has_feedback_vector()) {\n+        fun->feedback_cell()->set_value(isolate->heap()->undefined_value());\n+        fun->set_code(isolate->builtins()->builtin(i::Builtins::kCompileLazy));\n+      }\n     }\n \n     // Clear out re-compilable data from all shared function infos. Any"
        },
        {
            "sha": "5624ba9887966659878b24b65f2b0246b6461166",
            "filename": "deps/v8/src/snapshot/partial-serializer.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Fsrc%2Fsnapshot%2Fpartial-serializer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Fsrc%2Fsnapshot%2Fpartial-serializer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fsnapshot%2Fpartial-serializer.cc?ref=0d3da39f575afba5ab6a5a34f4e88a798a66dc6d",
            "patch": "@@ -105,7 +105,7 @@ void PartialSerializer::SerializeObject(HeapObject* obj, HowToCode how_to_code,\n     // Unconditionally reset the JSFunction to its SFI's code, since we can't\n     // serialize optimized code anyway.\n     JSFunction* closure = JSFunction::cast(obj);\n-    closure->set_code(closure->shared()->GetCode());\n+    if (closure->is_compiled()) closure->set_code(closure->shared()->GetCode());\n   }\n \n   CheckRehashability(obj);"
        },
        {
            "sha": "c26a7e734811a07c2f362d86017741e60dae59ca",
            "filename": "deps/v8/test/cctest/test-serialize.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0d3da39f575afba5ab6a5a34f4e88a798a66dc6d/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc?ref=0d3da39f575afba5ab6a5a34f4e88a798a66dc6d",
            "patch": "@@ -2640,6 +2640,47 @@ TEST(SnapshotCreatorNoExternalReferencesDefault) {\n   delete[] blob.data;\n }\n \n+v8::StartupData CreateCustomSnapshotArrayJoinWithKeep() {\n+  v8::SnapshotCreator creator;\n+  v8::Isolate* isolate = creator.GetIsolate();\n+  {\n+    v8::HandleScope handle_scope(isolate);\n+    {\n+      v8::Local<v8::Context> context = v8::Context::New(isolate);\n+      v8::Context::Scope context_scope(context);\n+      CompileRun(\n+          \"[].join('');\\n\"\n+          \"function g() { return String([1,2,3]); }\\n\");\n+      ExpectString(\"g()\", \"1,2,3\");\n+      creator.SetDefaultContext(context);\n+    }\n+  }\n+  return creator.CreateBlob(v8::SnapshotCreator::FunctionCodeHandling::kKeep);\n+}\n+\n+TEST(SnapshotCreatorArrayJoinWithKeep) {\n+  DisableAlwaysOpt();\n+  v8::StartupData blob = CreateCustomSnapshotArrayJoinWithKeep();\n+\n+  // Deserialize with an incomplete list of external references.\n+  {\n+    v8::Isolate::CreateParams params;\n+    params.snapshot_blob = &blob;\n+    params.array_buffer_allocator = CcTest::array_buffer_allocator();\n+    // Test-appropriate equivalent of v8::Isolate::New.\n+    v8::Isolate* isolate = TestIsolate::New(params);\n+    {\n+      v8::Isolate::Scope isolate_scope(isolate);\n+      v8::HandleScope handle_scope(isolate);\n+      v8::Local<v8::Context> context = v8::Context::New(isolate);\n+      v8::Context::Scope context_scope(context);\n+      ExpectString(\"g()\", \"1,2,3\");\n+    }\n+    isolate->Dispose();\n+  }\n+  delete[] blob.data;\n+}\n+\n TEST(SnapshotCreatorNoExternalReferencesCustomFail1) {\n   DisableAlwaysOpt();\n   v8::StartupData blob = CreateSnapshotWithDefaultAndCustom();"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 48,
        "deletions": 4
    }
}