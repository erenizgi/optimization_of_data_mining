{
    "author": "addaleax",
    "message": "http2: use `_final` instead of `on('finish')`\n\nPR-URL: https://github.com/nodejs/node/pull/18609\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "377cfd6fccd9e0ab455a50dada3b3cb37805479d",
    "files": [
        {
            "sha": "2fdcb8d63881802ab1f1af6d8c0fd11e16587780",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 24,
            "deletions": 13,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/377cfd6fccd9e0ab455a50dada3b3cb37805479d/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/377cfd6fccd9e0ab455a50dada3b3cb37805479d/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=377cfd6fccd9e0ab455a50dada3b3cb37805479d",
            "patch": "@@ -1415,18 +1415,6 @@ function afterDoStreamWrite(status, handle, req) {\n   req.handle = undefined;\n }\n \n-function onHandleFinish() {\n-  const handle = this[kHandle];\n-  if (this[kID] === undefined) {\n-    this.once('ready', onHandleFinish);\n-  } else if (handle !== undefined) {\n-    const req = new ShutdownWrap();\n-    req.oncomplete = () => {};\n-    req.handle = handle;\n-    handle.shutdown(req);\n-  }\n-}\n-\n function streamOnResume() {\n   if (!this.destroyed && !this.pending)\n     this[kHandle].readStart();\n@@ -1447,6 +1435,13 @@ function abort(stream) {\n   }\n }\n \n+function afterShutdown() {\n+  this.callback();\n+  const stream = this.handle[kOwner];\n+  if (stream)\n+    stream[kMaybeDestroy]();\n+}\n+\n // An Http2Stream is a Duplex stream that is backed by a\n // node::http2::Http2Stream handle implementing StreamBase.\n class Http2Stream extends Duplex {\n@@ -1471,7 +1466,6 @@ class Http2Stream extends Duplex {\n       writeQueueSize: 0\n     };\n \n-    this.once('finish', onHandleFinish);\n     this.on('resume', streamOnResume);\n     this.on('pause', streamOnPause);\n   }\n@@ -1678,6 +1672,23 @@ class Http2Stream extends Duplex {\n     trackWriteState(this, req.bytes);\n   }\n \n+  _final(cb) {\n+    const handle = this[kHandle];\n+    if (this[kID] === undefined) {\n+      this.once('ready', () => this._final(cb));\n+    } else if (handle !== undefined) {\n+      debug(`Http2Stream ${this[kID]} [Http2Session ` +\n+            `${sessionName(this[kSession][kType])}]: _final shutting down`);\n+      const req = new ShutdownWrap();\n+      req.oncomplete = afterShutdown;\n+      req.callback = cb;\n+      req.handle = handle;\n+      handle.shutdown(req);\n+    } else {\n+      cb();\n+    }\n+  }\n+\n   _read(nread) {\n     if (this.destroyed) {\n       this.push(null);"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 24,
        "deletions": 13
    }
}