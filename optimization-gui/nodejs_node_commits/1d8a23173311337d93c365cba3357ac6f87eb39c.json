{
    "author": "joyeecheung",
    "message": "process: implement process.hrtime.bigint()\n\nPR-URL: https://github.com/nodejs/node/pull/21256\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "1d8a23173311337d93c365cba3357ac6f87eb39c",
    "files": [
        {
            "sha": "e6612278b6bc4a16cc0802e9a1aade7d21b7bfff",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -1159,6 +1159,9 @@ added: v0.7.6\n * `time` {integer[]} The result of a previous call to `process.hrtime()`\n * Returns: {integer[]}\n \n+This is the legacy version of [`process.hrtime.bigint()`][]\n+before `bigint` was introduced in JavaScript.\n+\n The `process.hrtime()` method returns the current high-resolution real time\n in a `[seconds, nanoseconds]` tuple `Array`, where `nanoseconds` is the\n remaining part of the real time that can't be represented in second precision.\n@@ -1187,6 +1190,33 @@ setTimeout(() => {\n }, 1000);\n ```\n \n+## process.hrtime.bigint()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {bigint}\n+\n+The `bigint` version of the [`process.hrtime()`][] method returning the\n+current high-resolution real time in a `bigint`.\n+\n+Unlike [`process.hrtime()`][], it does not support an additional `time`\n+argument since the difference can just be computed directly\n+by subtraction of the two `bigint`s.\n+\n+```js\n+const start = process.hrtime.bigint();\n+// 191051479007711n\n+\n+setTimeout(() => {\n+  const end = process.hrtime.bigint();\n+  // 191052633396993n\n+\n+  console.log(`Benchmark took ${end - start} nanoseconds`);\n+  // Benchmark took 1154389282 nanoseconds\n+}, 1000);\n+```\n+\n ## process.initgroups(user, extraGroup)\n <!-- YAML\n added: v0.9.4\n@@ -2030,6 +2060,8 @@ cases:\n [`process.execPath`]: #process_process_execpath\n [`process.exit()`]: #process_process_exit_code\n [`process.exitCode`]: #process_process_exitcode\n+[`process.hrtime()`]: #process_process_hrtime_time\n+[`process.hrtime.bigint()`]: #process_process_hrtime_bigint\n [`process.kill()`]: #process_process_kill_pid_signal\n [`process.setUncaughtExceptionCaptureCallback()`]: process.html#process_process_setuncaughtexceptioncapturecallback_fn\n [`promise.catch()`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch"
        },
        {
            "sha": "b6233b17e24fa62adafac2caa235b7bbac1eeb0b",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -18,7 +18,8 @@\n                               // object.\n                               { _setupProcessObject, _setupNextTick,\n                                 _setupPromises, _chdir, _cpuUsage,\n-                                _hrtime, _memoryUsage, _rawDebug,\n+                                _hrtime, _hrtimeBigInt,\n+                                _memoryUsage, _rawDebug,\n                                 _umask, _initgroups, _setegid, _seteuid,\n                                 _setgid, _setuid, _setgroups,\n                                 _shouldAbortOnUncaughtToggle },\n@@ -70,7 +71,7 @@\n       NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,\n     } = perf.constants;\n \n-    _process.setup_hrtime(_hrtime);\n+    _process.setup_hrtime(_hrtime, _hrtimeBigInt);\n     _process.setup_cpuUsage(_cpuUsage);\n     _process.setupMemoryUsage(_memoryUsage);\n     _process.setupKillAndExit();"
        },
        {
            "sha": "2db9441975fb783d3da988cbf0191d3643f5456d",
            "filename": "lib/internal/process.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/lib%2Finternal%2Fprocess.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/lib%2Finternal%2Fprocess.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess.js?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -90,7 +90,7 @@ function setup_cpuUsage(_cpuUsage) {\n // The 3 entries filled in by the original process.hrtime contains\n // the upper/lower 32 bits of the second part of the value,\n // and the remaining nanoseconds of the value.\n-function setup_hrtime(_hrtime) {\n+function setup_hrtime(_hrtime, _hrtimeBigInt) {\n   const hrValues = new Uint32Array(3);\n \n   process.hrtime = function hrtime(time) {\n@@ -115,6 +115,14 @@ function setup_hrtime(_hrtime) {\n       hrValues[2]\n     ];\n   };\n+\n+  // Use a BigUint64Array in the closure because V8 does not have an API for\n+  // creating a BigInt out of a uint64_t yet.\n+  const hrBigintValues = new BigUint64Array(1);\n+  process.hrtime.bigint = function() {\n+    _hrtimeBigInt(hrBigintValues);\n+    return hrBigintValues[0];\n+  };\n }\n \n function setupMemoryUsage(_memoryUsage) {"
        },
        {
            "sha": "c470b99445fbd164ef39c03d2a3aa6b022dadea8",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -109,6 +109,7 @@ void SetupBootstrapObject(Environment* env,\n   BOOTSTRAP_METHOD(_chdir, Chdir);\n   BOOTSTRAP_METHOD(_cpuUsage, CPUUsage);\n   BOOTSTRAP_METHOD(_hrtime, Hrtime);\n+  BOOTSTRAP_METHOD(_hrtimeBigInt, HrtimeBigInt);\n   BOOTSTRAP_METHOD(_memoryUsage, MemoryUsage);\n   BOOTSTRAP_METHOD(_rawDebug, RawDebug);\n   BOOTSTRAP_METHOD(_umask, Umask);"
        },
        {
            "sha": "025fa10100de92202ddf781442f4fd87876d6e0c",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -905,6 +905,7 @@ void Chdir(const v8::FunctionCallbackInfo<v8::Value>& args);\n void CPUUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n void Cwd(const v8::FunctionCallbackInfo<v8::Value>& args);\n void Hrtime(const v8::FunctionCallbackInfo<v8::Value>& args);\n+void HrtimeBigInt(const v8::FunctionCallbackInfo<v8::Value>& args);\n void Kill(const v8::FunctionCallbackInfo<v8::Value>& args);\n void MemoryUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n void RawDebug(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "3655a05648e2cdaa366b320ae3ab70d506e9dbb7",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -31,6 +31,7 @@ namespace node {\n \n using v8::Array;\n using v8::ArrayBuffer;\n+using v8::BigUint64Array;\n using v8::Float64Array;\n using v8::FunctionCallbackInfo;\n using v8::HeapStatistics;\n@@ -113,7 +114,11 @@ void Cwd(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(cwd);\n }\n \n+\n // Hrtime exposes libuv's uv_hrtime() high-resolution timer.\n+\n+// This is the legacy version of hrtime before BigInt was introduced in\n+// JavaScript.\n // The value returned by uv_hrtime() is a 64-bit int representing nanoseconds,\n // so this function instead fills in an Uint32Array with 3 entries,\n // to avoid any integer overflow possibility.\n@@ -132,6 +137,12 @@ void Hrtime(const FunctionCallbackInfo<Value>& args) {\n   fields[2] = t % NANOS_PER_SEC;\n }\n \n+void HrtimeBigInt(const FunctionCallbackInfo<Value>& args) {\n+  Local<ArrayBuffer> ab = args[0].As<BigUint64Array>()->Buffer();\n+  uint64_t* fields = static_cast<uint64_t*>(ab->GetContents().Data());\n+  fields[0] = uv_hrtime();\n+}\n+\n void Kill(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n "
        },
        {
            "sha": "e5ce40a994d81554f4a2c006db19379dc771c7e7",
            "filename": "test/parallel/test-process-hrtime-bigint.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/1d8a23173311337d93c365cba3357ac6f87eb39c/test%2Fparallel%2Ftest-process-hrtime-bigint.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d8a23173311337d93c365cba3357ac6f87eb39c/test%2Fparallel%2Ftest-process-hrtime-bigint.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-hrtime-bigint.js?ref=1d8a23173311337d93c365cba3357ac6f87eb39c",
            "patch": "@@ -0,0 +1,14 @@\n+'use strict';\n+\n+// Tests that process.hrtime.bigint() works.\n+\n+require('../common');\n+const assert = require('assert');\n+\n+const start = process.hrtime.bigint();\n+assert.strictEqual(typeof start, 'bigint');\n+\n+const end = process.hrtime.bigint();\n+assert.strictEqual(typeof end, 'bigint');\n+\n+assert(end - start >= 0n);"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 71,
        "deletions": 3
    }
}