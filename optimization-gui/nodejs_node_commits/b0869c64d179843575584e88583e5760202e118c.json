{
    "author": "joyeecheung",
    "message": "process: move initialization of node-report into pre_execution.js\n\n- Splits signal handler setup code into two functions: one sets up\n  `process.on('SIGNAL_NAME')`, another takes care of the signal\n  triggers of node-report. Both should only happen on the main thread.\n  The latter needs to happen after the node-report configurations\n  are read into the process.\n- Move the initialization of node-report into pre_execution.js\n  because it depends on CLI/environment settings.\n\nPR-URL: https://github.com/nodejs/node/pull/26227\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "b0869c64d179843575584e88583e5760202e118c",
    "files": [
        {
            "sha": "8b40c2258b6e69adfc44643c4ebc17f9ba2ae0c8",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=b0869c64d179843575584e88583e5760202e118c",
            "patch": "@@ -38,7 +38,6 @@\n \n const { internalBinding, NativeModule } = loaderExports;\n const { Object, Symbol } = primordials;\n-const { getOptionValue } = NativeModule.require('internal/options');\n const config = internalBinding('config');\n const { deprecate } = NativeModule.require('internal/util');\n \n@@ -282,17 +281,6 @@ if (process.env.NODE_V8_COVERAGE) {\n   };\n }\n \n-if (getOptionValue('--experimental-report')) {\n-  const {\n-    config,\n-    report,\n-    syncConfig\n-  } = NativeModule.require('internal/process/report');\n-  process.report = report;\n-  // Download the CLI / ENV config into JS land.\n-  syncConfig(config, false);\n-}\n-\n function setupProcessObject() {\n   const EventEmitter = NativeModule.require('events');\n   const origProcProto = Object.getPrototypeOf(process);"
        },
        {
            "sha": "072112e68ba07f964d33e94b5c756b14cf70c9c3",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "modified",
            "additions": 33,
            "deletions": 9,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=b0869c64d179843575584e88583e5760202e118c",
            "patch": "@@ -11,6 +11,10 @@ function prepareMainThreadExecution() {\n   // Only main thread receives signals.\n   setupSignalHandlers();\n \n+  // Process initial configurations of node-report, if any.\n+  initializeReport();\n+  initializeReportSignalHandlers();  // Main-thread-only.\n+\n   // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n   // spawned by our child_process module, then initialize IPC.\n   // This attaches some internal event listeners and creates:\n@@ -31,6 +35,20 @@ function prepareMainThreadExecution() {\n   loadPreloadModules();\n }\n \n+function initializeReport() {\n+  if (!getOptionValue('--experimental-report')) {\n+    return;\n+  }\n+  const {\n+    config,\n+    report,\n+    syncConfig\n+  } = require('internal/process/report');\n+  process.report = report;\n+  // Download the CLI / ENV config into JS land.\n+  syncConfig(config, false);\n+}\n+\n function setupSignalHandlers() {\n   const {\n     createSignalHandlers\n@@ -41,15 +59,20 @@ function setupSignalHandlers() {\n   } = createSignalHandlers();\n   process.on('newListener', startListeningIfSignal);\n   process.on('removeListener', stopListeningIfSignal);\n+}\n \n-  if (getOptionValue('--experimental-report')) {\n-    const {\n-      config,\n-      handleSignal\n-    } = require('internal/process/report');\n-    if (config.events.includes('signal')) {\n-      process.on(config.signal, handleSignal);\n-    }\n+// This has to be called after both initializeReport() and\n+// setupSignalHandlers() are called\n+function initializeReportSignalHandlers() {\n+  if (!getOptionValue('--experimental-report')) {\n+    return;\n+  }\n+  const {\n+    config,\n+    handleSignal\n+  } = require('internal/process/report');\n+  if (config.events.includes('signal')) {\n+    process.on(config.signal, handleSignal);\n   }\n }\n \n@@ -204,5 +227,6 @@ module.exports = {\n   initializeDeprecations,\n   initializeESMLoader,\n   loadPreloadModules,\n-  setupTraceCategoryState\n+  setupTraceCategoryState,\n+  initializeReport\n };"
        },
        {
            "sha": "b6dbc47274a7da495cf7a5163fbe388c06879f05",
            "filename": "lib/internal/main/worker_thread.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0869c64d179843575584e88583e5760202e118c/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fworker_thread.js?ref=b0869c64d179843575584e88583e5760202e118c",
            "patch": "@@ -6,6 +6,7 @@\n const {\n   initializeDeprecations,\n   initializeESMLoader,\n+  initializeReport,\n   loadPreloadModules,\n   setupTraceCategoryState\n } = require('internal/bootstrap/pre_execution');\n@@ -75,6 +76,7 @@ port.on('message', (message) => {\n     } = message;\n \n     setupTraceCategoryState();\n+    initializeReport();\n     if (manifestSrc) {\n       require('internal/process/policy').setup(manifestSrc, manifestURL);\n     }"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 35,
        "deletions": 21
    }
}