{
    "author": "jasnell",
    "message": "http2: set js callbacks once\n\nMake the http2 binding a bit more efficient by setting the callback\nfunctions once when the module is loaded rather than for each\n`Http2Session` and `Http2Stream`.\n\nPR-URL: https://github.com/nodejs/node/pull/24063\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nNote: Landed with one collaborator approval after PR\n      was open for 18 days",
    "sha": "ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3",
    "files": [
        {
            "sha": "8d3764ffc7bdd73125498f4ed1fd8f1759c87fd8",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 33,
            "deletions": 24,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3",
            "patch": "@@ -159,6 +159,7 @@ const kProceed = Symbol('proceed');\n const kProtocol = Symbol('protocol');\n const kProxySocket = Symbol('proxy-socket');\n const kRemoteSettings = Symbol('remote-settings');\n+const kSelectPadding = Symbol('select-padding');\n const kSentHeaders = Symbol('sent-headers');\n const kSentTrailers = Symbol('sent-trailers');\n const kServer = Symbol('server');\n@@ -368,8 +369,8 @@ function onPing(payload) {\n // longer usable so destroy it also.\n function onStreamClose(code) {\n   const stream = this[kOwner];\n-  if (stream.destroyed)\n-    return;\n+  if (!stream || stream.destroyed)\n+    return false;\n \n   debug(`Http2Stream ${stream[kID]} [Http2Session ` +\n         `${sessionName(stream[kSession][kType])}]: closed with code ${code}`);\n@@ -399,6 +400,7 @@ function onStreamClose(code) {\n     else\n       stream.read(0);\n   }\n+  return true;\n }\n \n // Called when the remote peer settings have been updated.\n@@ -523,12 +525,14 @@ function onGoawayData(code, lastStreamID, buf) {\n // on the options. It is invoked with two arguments, the frameLen, and the\n // maxPayloadLen. The method must return a numeric value within the range\n // frameLen <= n <= maxPayloadLen.\n-function onSelectPadding(fn) {\n-  return function getPadding() {\n-    const frameLen = paddingBuffer[PADDING_BUF_FRAME_LENGTH];\n-    const maxFramePayloadLen = paddingBuffer[PADDING_BUF_MAX_PAYLOAD_LENGTH];\n-    paddingBuffer[PADDING_BUF_RETURN_VALUE] = fn(frameLen, maxFramePayloadLen);\n-  };\n+function onSelectPadding() {\n+  const session = this[kOwner];\n+  if (session.destroyed)\n+    return;\n+  const fn = session[kSelectPadding];\n+  const frameLen = paddingBuffer[PADDING_BUF_FRAME_LENGTH];\n+  const maxFramePayloadLen = paddingBuffer[PADDING_BUF_MAX_PAYLOAD_LENGTH];\n+  paddingBuffer[PADDING_BUF_RETURN_VALUE] = fn(frameLen, maxFramePayloadLen);\n }\n \n // When a ClientHttp2Session is first created, the socket may not yet be\n@@ -826,28 +830,20 @@ function setupHandle(socket, type, options) {\n     process.nextTick(emit, this, 'connect', this, socket);\n     return;\n   }\n+\n+  assert(socket._handle !== undefined,\n+         'Internal HTTP/2 Failure. The socket is not connected. Please ' +\n+         'report this as a bug in Node.js');\n+\n   debug(`Http2Session ${sessionName(type)}: setting up session handle`);\n   this[kState].flags |= SESSION_FLAGS_READY;\n \n   updateOptionsBuffer(options);\n   const handle = new binding.Http2Session(type);\n   handle[kOwner] = this;\n-  handle.error = onSessionInternalError;\n-  handle.onpriority = onPriority;\n-  handle.onsettings = onSettings;\n-  handle.onping = onPing;\n-  handle.onheaders = onSessionHeaders;\n-  handle.onframeerror = onFrameError;\n-  handle.ongoawaydata = onGoawayData;\n-  handle.onaltsvc = onAltSvc;\n-  handle.onorigin = onOrigin;\n \n   if (typeof options.selectPadding === 'function')\n-    handle.ongetpadding = onSelectPadding(options.selectPadding);\n-\n-  assert(socket._handle !== undefined,\n-         'Internal HTTP/2 Failure. The socket is not connected. Please ' +\n-         'report this as a bug in Node.js');\n+    this[kSelectPadding] = options.selectPadding;\n   handle.consume(socket._handle._externalStream);\n \n   this[kHandle] = handle;\n@@ -1654,8 +1650,6 @@ class Http2Stream extends Duplex {\n     this[async_id_symbol] = handle.getAsyncId();\n     handle[kOwner] = this;\n     this[kHandle] = handle;\n-    handle.ontrailers = onStreamTrailers;\n-    handle.onstreamclose = onStreamClose;\n     handle.onread = onStreamRead;\n     this.uncork();\n     this.emit('ready');\n@@ -2899,6 +2893,21 @@ function getUnpackedSettings(buf, options = {}) {\n   return settings;\n }\n \n+binding.setCallbackFunctions(\n+  onSessionInternalError,\n+  onPriority,\n+  onSettings,\n+  onPing,\n+  onSessionHeaders,\n+  onFrameError,\n+  onGoawayData,\n+  onAltSvc,\n+  onOrigin,\n+  onSelectPadding,\n+  onStreamTrailers,\n+  onStreamClose\n+);\n+\n // Exports\n module.exports = {\n   connect,"
        },
        {
            "sha": "64593a0025c3b6140112e336b660b0bb1221e502",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3",
            "patch": "@@ -212,7 +212,6 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(nistcurve_string, \"nistCurve\")                                             \\\n   V(nsname_string, \"nsname\")                                                   \\\n   V(ocsp_request_string, \"OCSPRequest\")                                        \\\n-  V(onaltsvc_string, \"onaltsvc\")                                               \\\n   V(oncertcb_string, \"oncertcb\")                                               \\\n   V(onchange_string, \"onchange\")                                               \\\n   V(onclienthello_string, \"onclienthello\")                                     \\\n@@ -221,26 +220,16 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(ondone_string, \"ondone\")                                                   \\\n   V(onerror_string, \"onerror\")                                                 \\\n   V(onexit_string, \"onexit\")                                                   \\\n-  V(onframeerror_string, \"onframeerror\")                                       \\\n-  V(ongetpadding_string, \"ongetpadding\")                                       \\\n-  V(ongoawaydata_string, \"ongoawaydata\")                                       \\\n   V(onhandshakedone_string, \"onhandshakedone\")                                 \\\n   V(onhandshakestart_string, \"onhandshakestart\")                               \\\n-  V(onheaders_string, \"onheaders\")                                             \\\n   V(onmessage_string, \"onmessage\")                                             \\\n   V(onnewsession_string, \"onnewsession\")                                       \\\n   V(onocspresponse_string, \"onocspresponse\")                                   \\\n-  V(onorigin_string, \"onorigin\")                                               \\\n-  V(onping_string, \"onping\")                                                   \\\n-  V(onpriority_string, \"onpriority\")                                           \\\n   V(onread_string, \"onread\")                                                   \\\n   V(onreadstart_string, \"onreadstart\")                                         \\\n   V(onreadstop_string, \"onreadstop\")                                           \\\n-  V(onsettings_string, \"onsettings\")                                           \\\n   V(onshutdown_string, \"onshutdown\")                                           \\\n   V(onsignal_string, \"onsignal\")                                               \\\n-  V(onstreamclose_string, \"onstreamclose\")                                     \\\n-  V(ontrailers_string, \"ontrailers\")                                           \\\n   V(onunpipe_string, \"onunpipe\")                                               \\\n   V(onwrite_string, \"onwrite\")                                                 \\\n   V(openssl_error_stack, \"opensslErrorStack\")                                  \\\n@@ -343,6 +332,18 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(host_import_module_dynamically_callback, v8::Function)                     \\\n   V(host_initialize_import_meta_object_callback, v8::Function)                 \\\n   V(http2ping_constructor_template, v8::ObjectTemplate)                        \\\n+  V(http2session_on_altsvc_function, v8::Function)                             \\\n+  V(http2session_on_error_function, v8::Function)                              \\\n+  V(http2session_on_frame_error_function, v8::Function)                        \\\n+  V(http2session_on_goaway_data_function, v8::Function)                        \\\n+  V(http2session_on_headers_function, v8::Function)                            \\\n+  V(http2session_on_origin_function, v8::Function)                             \\\n+  V(http2session_on_ping_function, v8::Function)                               \\\n+  V(http2session_on_priority_function, v8::Function)                           \\\n+  V(http2session_on_select_padding_function, v8::Function)                     \\\n+  V(http2session_on_settings_function, v8::Function)                           \\\n+  V(http2session_on_stream_close_function, v8::Function)                       \\\n+  V(http2session_on_stream_trailers_function, v8::Function)                    \\\n   V(http2settings_constructor_template, v8::ObjectTemplate)                    \\\n   V(http2stream_constructor_template, v8::ObjectTemplate)                      \\\n   V(immediate_callback_function, v8::Function)                                 \\"
        },
        {
            "sha": "58ba052f04c3cf7eb086ee247bbe37da45a4af73",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 55,
            "deletions": 28,
            "changes": 83,
            "blob_url": "https://github.com/nodejs/node/blob/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=ee80aaab13e6bac136e2ccc84ffc5934d9ebc0c3",
            "patch": "@@ -851,7 +851,7 @@ ssize_t Http2Session::OnCallbackPadding(size_t frameLen,\n   buffer[PADDING_BUF_FRAME_LENGTH] = frameLen;\n   buffer[PADDING_BUF_MAX_PAYLOAD_LENGTH] = maxPayloadLen;\n   buffer[PADDING_BUF_RETURN_VALUE] = frameLen;\n-  MakeCallback(env()->ongetpadding_string(), 0, nullptr);\n+  MakeCallback(env()->http2session_on_select_padding_function(), 0, nullptr);\n   uint32_t retval = buffer[PADDING_BUF_RETURN_VALUE];\n   retval = std::min(retval, static_cast<uint32_t>(maxPayloadLen));\n   retval = std::max(retval, static_cast<uint32_t>(frameLen));\n@@ -1017,7 +1017,7 @@ int Http2Session::OnInvalidFrame(nghttp2_session* handle,\n     Local<Context> context = env->context();\n     Context::Scope context_scope(context);\n     Local<Value> arg = Integer::New(isolate, lib_error_code);\n-    session->MakeCallback(env->error_string(), 1, &arg);\n+    session->MakeCallback(env->http2session_on_error_function(), 1, &arg);\n   }\n   return 0;\n }\n@@ -1054,7 +1054,9 @@ int Http2Session::OnFrameNotSent(nghttp2_session* handle,\n     Integer::New(isolate, frame->hd.type),\n     Integer::New(isolate, error_code)\n   };\n-  session->MakeCallback(env->onframeerror_string(), arraysize(argv), argv);\n+  session->MakeCallback(\n+      env->http2session_on_frame_error_function(),\n+      arraysize(argv), argv);\n   return 0;\n }\n \n@@ -1085,22 +1087,19 @@ int Http2Session::OnStreamClose(nghttp2_session* handle,\n     return 0;\n \n   stream->Close(code);\n+\n   // It is possible for the stream close to occur before the stream is\n-  // ever passed on to the javascript side. If that happens, skip straight\n-  // to destroying the stream. We can check this by looking for the\n-  // onstreamclose function. If it exists, then the stream has already\n-  // been passed on to javascript.\n-  Local<Value> fn =\n-      stream->object()->Get(context, env->onstreamclose_string())\n-          .ToLocalChecked();\n-\n-  if (!fn->IsFunction()) {\n+  // ever passed on to the javascript side. If that happens, the callback\n+  // will return false.\n+  Local<Value> arg = Integer::NewFromUnsigned(isolate, code);\n+  MaybeLocal<Value> answer =\n+    stream->MakeCallback(env->http2session_on_stream_close_function(),\n+                          1, &arg);\n+  if (answer.IsEmpty() ||\n+      !(answer.ToLocalChecked()->BooleanValue(env->context()).FromJust())) {\n+    // Skip to destroy\n     stream->Destroy();\n-    return 0;\n   }\n-\n-  Local<Value> arg = Integer::NewFromUnsigned(isolate, code);\n-  stream->MakeCallback(fn.As<Function>(), 1, &arg);\n   return 0;\n }\n \n@@ -1233,7 +1232,7 @@ int Http2Session::OnNghttpError(nghttp2_session* handle,\n     Local<Context> context = env->context();\n     Context::Scope context_scope(context);\n     Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n-    session->MakeCallback(env->error_string(), 1, &arg);\n+    session->MakeCallback(env->http2session_on_error_function(), 1, &arg);\n   }\n   return 0;\n }\n@@ -1317,7 +1316,8 @@ void Http2Session::HandleHeadersFrame(const nghttp2_frame* frame) {\n       Integer::New(isolate, stream->headers_category()),\n       Integer::New(isolate, frame->hd.flags),\n       Array::New(isolate, headers_v.data(), headers_size * 2)};\n-  MakeCallback(env()->onheaders_string(), arraysize(args), args);\n+  MakeCallback(env()->http2session_on_headers_function(),\n+               arraysize(args), args);\n }\n \n \n@@ -1343,7 +1343,8 @@ void Http2Session::HandlePriorityFrame(const nghttp2_frame* frame) {\n     Integer::New(isolate, spec.weight),\n     Boolean::New(isolate, spec.exclusive)\n   };\n-  MakeCallback(env()->onpriority_string(), arraysize(argv), argv);\n+  MakeCallback(env()->http2session_on_priority_function(),\n+               arraysize(argv), argv);\n }\n \n \n@@ -1383,7 +1384,8 @@ void Http2Session::HandleGoawayFrame(const nghttp2_frame* frame) {\n                            length).ToLocalChecked();\n   }\n \n-  MakeCallback(env()->ongoawaydata_string(), arraysize(argv), argv);\n+  MakeCallback(env()->http2session_on_goaway_data_function(),\n+               arraysize(argv), argv);\n }\n \n // Called by OnFrameReceived when a complete ALTSVC frame has been received.\n@@ -1411,7 +1413,8 @@ void Http2Session::HandleAltSvcFrame(const nghttp2_frame* frame) {\n                            altsvc->field_value_len).ToLocalChecked(),\n   };\n \n-  MakeCallback(env()->onaltsvc_string(), arraysize(argv), argv);\n+  MakeCallback(env()->http2session_on_altsvc_function(),\n+               arraysize(argv), argv);\n }\n \n void Http2Session::HandleOriginFrame(const nghttp2_frame* frame) {\n@@ -1436,7 +1439,7 @@ void Http2Session::HandleOriginFrame(const nghttp2_frame* frame) {\n             .ToLocalChecked();\n   }\n   Local<Value> holder = Array::New(isolate, origin_v.data(), origin_v.size());\n-  MakeCallback(env()->onorigin_string(), 1, &holder);\n+  MakeCallback(env()->http2session_on_origin_function(), 1, &holder);\n }\n \n // Called by OnFrameReceived when a complete PING frame has been received.\n@@ -1457,7 +1460,7 @@ void Http2Session::HandlePingFrame(const nghttp2_frame* frame) {\n       // is buggy or malicious, and we're not going to tolerate such\n       // nonsense.\n       arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n-      MakeCallback(env()->error_string(), 1, &arg);\n+      MakeCallback(env()->http2session_on_error_function(), 1, &arg);\n       return;\n     }\n \n@@ -1469,15 +1472,15 @@ void Http2Session::HandlePingFrame(const nghttp2_frame* frame) {\n   arg = Buffer::Copy(env(),\n                       reinterpret_cast<const char*>(frame->ping.opaque_data),\n                       8).ToLocalChecked();\n-  MakeCallback(env()->onping_string(), 1, &arg);\n+  MakeCallback(env()->http2session_on_ping_function(), 1, &arg);\n }\n \n // Called by OnFrameReceived when a complete SETTINGS frame has been received.\n void Http2Session::HandleSettingsFrame(const nghttp2_frame* frame) {\n   bool ack = frame->hd.flags & NGHTTP2_FLAG_ACK;\n   if (!ack) {\n     // This is not a SETTINGS acknowledgement, notify and return\n-    MakeCallback(env()->onsettings_string(), 0, nullptr);\n+    MakeCallback(env()->http2session_on_settings_function(), 0, nullptr);\n     return;\n   }\n \n@@ -1502,7 +1505,7 @@ void Http2Session::HandleSettingsFrame(const nghttp2_frame* frame) {\n   Local<Context> context = env()->context();\n   Context::Scope context_scope(context);\n   Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n-  MakeCallback(env()->error_string(), 1, &arg);\n+  MakeCallback(env()->http2session_on_error_function(), 1, &arg);\n }\n \n // Callback used when data has been written to the stream.\n@@ -1827,7 +1830,7 @@ void Http2Session::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n   if (UNLIKELY(ret < 0)) {\n     Debug(this, \"fatal error receiving data: %d\", ret);\n     Local<Value> arg = Integer::New(isolate, ret);\n-    MakeCallback(env()->error_string(), 1, &arg);\n+    MakeCallback(env()->http2session_on_error_function(), 1, &arg);\n     return;\n   }\n \n@@ -2032,7 +2035,7 @@ void Http2Stream::OnTrailers() {\n   Local<Context> context = env()->context();\n   Context::Scope context_scope(context);\n   flags_ &= ~NGHTTP2_STREAM_FLAG_TRAILERS;\n-  MakeCallback(env()->ontrailers_string(), 0, nullptr);\n+  MakeCallback(env()->http2session_on_stream_trailers_function(), 0, nullptr);\n }\n \n // Submit informational headers for a stream.\n@@ -2898,6 +2901,29 @@ void nghttp2_header::MemoryInfo(MemoryTracker* tracker) const {\n   tracker->TrackFieldWithSize(\"value\", nghttp2_rcbuf_get_buf(value).len);\n }\n \n+void SetCallbackFunctions(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK_EQ(args.Length(), 12);\n+\n+#define SET_FUNCTION(arg, name)                                               \\\n+  CHECK(args[arg]->IsFunction());                                             \\\n+  env->set_http2session_on_ ## name ## _function(args[arg].As<Function>());\n+\n+  SET_FUNCTION(0, error)\n+  SET_FUNCTION(1, priority)\n+  SET_FUNCTION(2, settings)\n+  SET_FUNCTION(3, ping)\n+  SET_FUNCTION(4, headers)\n+  SET_FUNCTION(5, frame_error)\n+  SET_FUNCTION(6, goaway_data)\n+  SET_FUNCTION(7, altsvc)\n+  SET_FUNCTION(8, origin)\n+  SET_FUNCTION(9, select_padding)\n+  SET_FUNCTION(10, stream_trailers)\n+  SET_FUNCTION(11, stream_close)\n+\n+#undef SET_FUNCTION\n+}\n \n // Set up the process.binding('http2') binding.\n void Initialize(Local<Object> target,\n@@ -3106,6 +3132,7 @@ HTTP_STATUS_CODES(V)\n \n   env->SetMethod(target, \"refreshDefaultSettings\", RefreshDefaultSettings);\n   env->SetMethod(target, \"packSettings\", PackSettings);\n+  env->SetMethod(target, \"setCallbackFunctions\", SetCallbackFunctions);\n \n   target->Set(context,\n               env->constants_string(),"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 100,
        "deletions": 63
    }
}