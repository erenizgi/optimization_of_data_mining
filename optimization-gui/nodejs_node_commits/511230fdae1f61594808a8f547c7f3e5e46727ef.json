{
    "author": "santigimeno",
    "message": "child_process: fix leak when passing http sockets\n\nAfter passing an HTTP socket, release its associated resources.\n\nPR-URL: https://github.com/nodejs/node/pull/20305\nFixes: https://github.com/nodejs/node/issues/15651\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "511230fdae1f61594808a8f547c7f3e5e46727ef",
    "files": [
        {
            "sha": "a630cff717bcada0f2ef9dd2cc09e6bd20661037",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/511230fdae1f61594808a8f547c7f3e5e46727ef/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/511230fdae1f61594808a8f547c7f3e5e46727ef/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=511230fdae1f61594808a8f547c7f3e5e46727ef",
            "patch": "@@ -31,6 +31,8 @@ const SocketList = require('internal/socket_list');\n const { convertToValidSignal } = require('internal/util');\n const { isUint8Array } = require('internal/util/types');\n const spawn_sync = process.binding('spawn_sync');\n+const { HTTPParser } = process.binding('http_parser');\n+const { freeParser } = require('_http_common');\n \n const {\n   UV_EACCES,\n@@ -107,6 +109,14 @@ const handleConversion = {\n       if (!options.keepOpen) {\n         handle.onread = nop;\n         socket._handle = null;\n+        socket.setTimeout(0);\n+        // In case of an HTTP connection socket, release the associated\n+        // resources\n+        if (socket.parser && socket.parser instanceof HTTPParser) {\n+          freeParser(socket.parser, null, socket);\n+          if (socket._httpMessage)\n+            socket._httpMessage.detachSocket(socket);\n+        }\n       }\n \n       return handle;"
        },
        {
            "sha": "30d8601b840626f370288ad621d75cf5eb713567",
            "filename": "test/parallel/test-child-process-http-socket-leak.js",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/511230fdae1f61594808a8f547c7f3e5e46727ef/test%2Fparallel%2Ftest-child-process-http-socket-leak.js",
            "raw_url": "https://github.com/nodejs/node/raw/511230fdae1f61594808a8f547c7f3e5e46727ef/test%2Fparallel%2Ftest-child-process-http-socket-leak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-http-socket-leak.js?ref=511230fdae1f61594808a8f547c7f3e5e46727ef",
            "patch": "@@ -0,0 +1,56 @@\n+// Flags: --expose_internals\n+\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const { fork } = require('child_process');\n+const http = require('http');\n+const { kTimeout } = require('internal/timers');\n+\n+if (process.argv[2] === 'child') {\n+  process.once('message', (req, socket) => {\n+    const res = new http.ServerResponse(req);\n+    res.assignSocket(socket);\n+    res.end();\n+  });\n+\n+  process.send('ready');\n+  return;\n+}\n+\n+let child;\n+let socket;\n+\n+const server = http.createServer(common.mustCall((req, res) => {\n+  const r = {\n+    method: req.method,\n+    headers: req.headers,\n+    path: req.path,\n+    httpVersionMajor: req.httpVersionMajor,\n+    query: req.query,\n+  };\n+\n+  socket = res.socket;\n+  child.send(r, socket);\n+  server.close();\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  child = fork(__filename, [ 'child' ]);\n+  child.once('message', (msg) => {\n+    assert.strictEqual(msg, 'ready');\n+    const req = http.request({\n+      port: server.address().port,\n+    }, common.mustCall((res) => {\n+      res.on('data', () => {});\n+      res.on('end', common.mustCall(() => {\n+        assert.strictEqual(socket[kTimeout]._idleTimeout, -1);\n+        assert.strictEqual(socket.parser, null);\n+        assert.strictEqual(socket._httpMessage, null);\n+      }));\n+    }));\n+\n+    req.end();\n+  });\n+}));"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 66,
        "deletions": 0
    }
}