{
    "author": "addaleax",
    "message": "zlib: fix memory leak for invalid input\n\nDon’t toggle the weak/strong reference flag from the error\nhandler, that’s too confusing. Instead, always do it in the\ncode that handles the write call.\n\nFixes: https://github.com/nodejs/node/issues/22705\n\nPR-URL: https://github.com/nodejs/node/pull/22713\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a",
    "files": [
        {
            "sha": "3d7c6b004797f2c8fbb69c8183b614458094ca64",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a",
            "patch": "@@ -215,8 +215,8 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n         ctx->write_result_[0] = ctx->strm_.avail_out;\n         ctx->write_result_[1] = ctx->strm_.avail_in;\n         ctx->write_in_progress_ = false;\n-        ctx->Unref();\n       }\n+      ctx->Unref();\n       return;\n     }\n \n@@ -364,6 +364,7 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n   // v8 land!\n   void AfterThreadPoolWork(int status) override {\n     AllocScope alloc_scope(this);\n+    OnScopeLeave on_scope_leave([&]() { Unref(); });\n \n     write_in_progress_ = false;\n \n@@ -388,7 +389,6 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n                                            write_js_callback_);\n     MakeCallback(cb, 0, nullptr);\n \n-    Unref();\n     if (pending_close_)\n       Close();\n   }\n@@ -410,8 +410,6 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n     MakeCallback(env()->onerror_string(), arraysize(args), args);\n \n     // no hope of rescue.\n-    if (write_in_progress_)\n-      Unref();\n     write_in_progress_ = false;\n     if (pending_close_)\n       Close();"
        },
        {
            "sha": "d626e6e5b8df380d2c87b083dda6208d927327ad",
            "filename": "test/parallel/test-zlib-invalid-input-memory.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a/test%2Fparallel%2Ftest-zlib-invalid-input-memory.js",
            "raw_url": "https://github.com/nodejs/node/raw/0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a/test%2Fparallel%2Ftest-zlib-invalid-input-memory.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-invalid-input-memory.js?ref=0c30d0e4e02e5b2b125a4eccb29ae8f48b457b8a",
            "patch": "@@ -0,0 +1,28 @@\n+// Flags: --expose-gc\n+'use strict';\n+const common = require('../common');\n+const onGC = require('../common/ongc');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+\n+// Checks that, if a zlib context fails with an error, it can still be GC'ed:\n+// Refs: https://github.com/nodejs/node/issues/22705\n+\n+const ongc = common.mustCall();\n+\n+{\n+  const input = Buffer.from('foobar');\n+  const strm = zlib.createInflate();\n+  strm.end(input);\n+  strm.once('error', common.mustCall((err) => {\n+    assert(err);\n+    setImmediate(() => {\n+      global.gc();\n+      // Keep the event loop alive for seeing the async_hooks destroy hook\n+      // we use for GC tracking...\n+      // TODO(addaleax): This should maybe not be necessary?\n+      setImmediate(() => {});\n+    });\n+  }));\n+  onGC(strm, { ongc });\n+}"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}