{
    "author": "joyeecheung",
    "message": "test: add test for dynamically enabling node.async_hooks tracing\n\nPR-URL: https://github.com/nodejs/node/pull/26062\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "85df2c4703242679e409f648de95843f4a1f69a7",
    "files": [
        {
            "sha": "884909b2a380fb75cfc5d7ccc54a6ffd1baec9f2",
            "filename": "test/parallel/test-trace-events-async-hooks-dynamic.js",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/nodejs/node/blob/85df2c4703242679e409f648de95843f4a1f69a7/test%2Fparallel%2Ftest-trace-events-async-hooks-dynamic.js",
            "raw_url": "https://github.com/nodejs/node/raw/85df2c4703242679e409f648de95843f4a1f69a7/test%2Fparallel%2Ftest-trace-events-async-hooks-dynamic.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-async-hooks-dynamic.js?ref=85df2c4703242679e409f648de95843f4a1f69a7",
            "patch": "@@ -0,0 +1,83 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!process.binding('config').hasTracing)\n+  common.skip('missing trace events');\n+\n+const assert = require('assert');\n+const cp = require('child_process');\n+const fs = require('fs');\n+const path = require('path');\n+const util = require('util');\n+\n+const enable = `require(\"trace_events\").createTracing(\n+{ categories: [\"node.async_hooks\"] }).enable();`;\n+const code =\n+  'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1)';\n+\n+const tmpdir = require('../common/tmpdir');\n+const filename = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+tmpdir.refresh();\n+const proc = cp.spawnSync(\n+  process.execPath,\n+  ['-e', enable + code ],\n+  {\n+    cwd: tmpdir.path,\n+    env: Object.assign({}, process.env, {\n+      'NODE_DEBUG_NATIVE': 'tracing',\n+      'NODE_DEBUG': 'tracing'\n+    })\n+  });\n+console.log(proc.signal);\n+console.log(proc.stderr.toString());\n+assert.strictEqual(proc.status, 0);\n+\n+assert(fs.existsSync(filename));\n+const data = fs.readFileSync(filename, 'utf-8');\n+const traces = JSON.parse(data).traceEvents;\n+assert(traces.length > 0);\n+// V8 trace events should be generated.\n+assert(!traces.some((trace) => {\n+  if (trace.pid !== proc.pid)\n+    return false;\n+  if (trace.cat !== 'v8')\n+    return false;\n+  if (trace.name !== 'V8.ScriptCompiler')\n+    return false;\n+  return true;\n+}));\n+\n+// C++ async_hooks trace events should be generated.\n+assert(traces.some((trace) => {\n+  if (trace.pid !== proc.pid)\n+    return false;\n+  if (trace.cat !== 'node,node.async_hooks')\n+    return false;\n+  return true;\n+}));\n+\n+// JavaScript async_hooks trace events should be generated.\n+assert(traces.some((trace) => {\n+  if (trace.pid !== proc.pid)\n+    return false;\n+  if (trace.cat !== 'node,node.async_hooks')\n+    return false;\n+  if (trace.name !== 'Timeout')\n+    return false;\n+  return true;\n+}));\n+\n+// Check args in init events\n+const initEvents = traces.filter((trace) => {\n+  return (trace.ph === 'b' && !trace.name.includes('_CALLBACK'));\n+});\n+for (const trace of initEvents) {\n+  console.log(trace);\n+  if (trace.args.data.executionAsyncId > 0 &&\n+    trace.args.data.triggerAsyncId > 0) {\n+    continue;\n+  }\n+  assert.fail('Unexpected initEvent: ',\n+              util.inspect(trace, { depth: Infinity }));\n+}"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 83,
        "deletions": 0
    }
}