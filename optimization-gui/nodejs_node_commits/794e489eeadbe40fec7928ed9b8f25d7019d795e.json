{
    "author": "BridgeAR",
    "message": "benchmark: (buffer) refactor\n\nPR-URL: https://github.com/nodejs/node/pull/18320\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "794e489eeadbe40fec7928ed9b8f25d7019d795e",
    "files": [
        {
            "sha": "fa8852a233ea888030d8007d2a334def18a51387",
            "filename": "benchmark/buffers/buffer-bytelength.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-bytelength.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-bytelength.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-bytelength.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -17,10 +17,9 @@ const chars = [\n \n function main({ n, len, encoding }) {\n   var strings = [];\n-  var results;\n+  var results = [ len * 16 ];\n   if (encoding === 'buffer') {\n     strings = [ Buffer.alloc(len * 16, 'a') ];\n-    results = [ len * 16 ];\n   } else {\n     for (const string of chars) {\n       // Strings must be built differently, depending on encoding"
        },
        {
            "sha": "551fcd2f0cec3773c52991945b95a6edc96f977e",
            "filename": "benchmark/buffers/buffer-compare-offset.js",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-compare-offset.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-compare-offset.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-compare-offset.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -8,26 +8,22 @@ const bench = common.createBenchmark(main, {\n });\n \n function compareUsingSlice(b0, b1, len, iter) {\n-  var i;\n-  bench.start();\n-  for (i = 0; i < iter; i++)\n+  for (var i = 0; i < iter; i++)\n     Buffer.compare(b0.slice(1, len), b1.slice(1, len));\n-  bench.end(iter / 1e6);\n }\n \n function compareUsingOffset(b0, b1, len, iter) {\n-  var i;\n-  bench.start();\n-  for (i = 0; i < iter; i++)\n+  for (var i = 0; i < iter; i++)\n     b0.compare(b1, 1, len, 1, len);\n-  bench.end(iter / 1e6);\n }\n \n function main({ millions, size, method }) {\n   const iter = millions * 1e6;\n   const fn = method === 'slice' ? compareUsingSlice : compareUsingOffset;\n+  bench.start();\n   fn(Buffer.alloc(size, 'a'),\n      Buffer.alloc(size, 'b'),\n      size >> 1,\n      iter);\n+  bench.end(millions);\n }"
        },
        {
            "sha": "a7b340131eb8aad09a1aa5eeadccc78218c6e974",
            "filename": "benchmark/buffers/buffer-creation.js",
            "status": "modified",
            "additions": 15,
            "deletions": 28,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-creation.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-creation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-creation.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -16,51 +16,38 @@ const bench = common.createBenchmark(main, {\n });\n \n function main({ len, n, type }) {\n+  let fn, i;\n   switch (type) {\n     case '':\n     case 'fast-alloc':\n-      bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n-        Buffer.alloc(len);\n-      }\n-      bench.end(n);\n+      fn = Buffer.alloc;\n       break;\n     case 'fast-alloc-fill':\n       bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n+      for (i = 0; i < n * 1024; i++) {\n         Buffer.alloc(len, 0);\n       }\n       bench.end(n);\n-      break;\n+      return;\n     case 'fast-allocUnsafe':\n-      bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n-        Buffer.allocUnsafe(len);\n-      }\n-      bench.end(n);\n+      fn = Buffer.allocUnsafe;\n       break;\n     case 'slow-allocUnsafe':\n-      bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n-        Buffer.allocUnsafeSlow(len);\n-      }\n-      bench.end(n);\n+      fn = Buffer.allocUnsafeSlow;\n       break;\n     case 'slow':\n-      bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n-        SlowBuffer(len);\n-      }\n-      bench.end(n);\n+      fn = SlowBuffer;\n       break;\n     case 'buffer()':\n-      bench.start();\n-      for (let i = 0; i < n * 1024; i++) {\n-        Buffer(len);\n-      }\n-      bench.end(n);\n+      fn = Buffer;\n       break;\n     default:\n-      assert.fail(null, null, 'Should not get here');\n+      assert.fail('Should not get here');\n+  }\n+\n+  bench.start();\n+  for (i = 0; i < n * 1024; i++) {\n+    fn(len);\n   }\n+  bench.end(n);\n }"
        },
        {
            "sha": "4d87313961aa67c754fdba2c40ab9070e86a19b2",
            "filename": "benchmark/buffers/buffer-hex.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-hex.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-hex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-hex.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -9,15 +9,16 @@ const bench = common.createBenchmark(main, {\n \n function main({ len, n }) {\n   const buf = Buffer.alloc(len);\n+  var i;\n \n-  for (let i = 0; i < buf.length; i++)\n+  for (i = 0; i < buf.length; i++)\n     buf[i] = i & 0xff;\n \n   const hex = buf.toString('hex');\n \n   bench.start();\n \n-  for (let i = 0; i < n; i += 1)\n+  for (i = 0; i < n; i += 1)\n     Buffer.from(hex, 'hex');\n \n   bench.end(n);"
        },
        {
            "sha": "7a275b0bcb81823d422ddf237b567b0917cb7b46",
            "filename": "benchmark/buffers/buffer-iterate.js",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-iterate.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-iterate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-iterate.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -20,36 +20,30 @@ function main({ size, type, method, n }) {\n   const clazz = type === 'fast' ? Buffer : SlowBuffer;\n   const buffer = new clazz(size);\n   buffer.fill(0);\n-  methods[method || 'for'](buffer, n);\n-}\n-\n+  const fn = methods[method || 'for'];\n \n-function benchFor(buffer, n) {\n   bench.start();\n+  fn(buffer, n);\n+  bench.end(n);\n+}\n \n+function benchFor(buffer, n) {\n   for (var k = 0; k < n; k++) {\n     for (var i = 0; i < buffer.length; i++) {\n       assert(buffer[i] === 0);\n     }\n   }\n-\n-  bench.end(n);\n }\n \n function benchForOf(buffer, n) {\n-  bench.start();\n-\n   for (var k = 0; k < n; k++) {\n     for (const b of buffer) {\n       assert(b === 0);\n     }\n   }\n-  bench.end(n);\n }\n \n function benchIterator(buffer, n) {\n-  bench.start();\n-\n   for (var k = 0; k < n; k++) {\n     const iter = buffer[Symbol.iterator]();\n     var cur = iter.next();\n@@ -60,6 +54,4 @@ function benchIterator(buffer, n) {\n     }\n \n   }\n-\n-  bench.end(n);\n }"
        },
        {
            "sha": "afd9edf5578308c84112aef3d7b6894ac27ee17a",
            "filename": "benchmark/buffers/buffer-read-float.js",
            "status": "modified",
            "additions": 9,
            "deletions": 14,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read-float.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read-float.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-read-float.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -9,12 +9,10 @@ const bench = common.createBenchmark(main, {\n   millions: [1]\n });\n \n-function main(conf) {\n-  const noAssert = conf.noAssert === 'true';\n-  const len = +conf.millions * 1e6;\n+function main({ noAssert, millions, type, endian, value }) {\n+  noAssert = noAssert === 'true';\n+  type = type || 'Double';\n   const buff = Buffer.alloc(8);\n-  const type = conf.type || 'Double';\n-  const endian = conf.endian;\n   const fn = `read${type}${endian}`;\n   const values = {\n     Double: {\n@@ -32,15 +30,12 @@ function main(conf) {\n       nan: NaN,\n     },\n   };\n-  const value = values[type][conf.value];\n \n-  buff[`write${type}${endian}`](value, 0, noAssert);\n-  const testFunction = new Function('buff', `\n-    for (var i = 0; i !== ${len}; i++) {\n-      buff.${fn}(0, ${JSON.stringify(noAssert)});\n-    }\n-  `);\n+  buff[`write${type}${endian}`](values[type][value], 0, noAssert);\n+\n   bench.start();\n-  testFunction(buff);\n-  bench.end(len / 1e6);\n+  for (var i = 0; i !== millions * 1e6; i++) {\n+    buff[fn](0, noAssert);\n+  }\n+  bench.end(millions);\n }"
        },
        {
            "sha": "9fe5e6f4bf43ff0efb06ca9df986153494a2857c",
            "filename": "benchmark/buffers/buffer-read-with-byteLength.js",
            "status": "modified",
            "additions": 8,
            "deletions": 12,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read-with-byteLength.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read-with-byteLength.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-read-with-byteLength.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -16,21 +16,17 @@ const bench = common.createBenchmark(main, {\n   byteLength: [1, 2, 4, 6]\n });\n \n-function main(conf) {\n-  const noAssert = conf.noAssert === 'true';\n-  const len = conf.millions * 1e6;\n-  const clazz = conf.buf === 'fast' ? Buffer : require('buffer').SlowBuffer;\n+function main({ millions, noAssert, buf, type, byteLength }) {\n+  noAssert = noAssert === 'true';\n+  type = type || 'UInt8';\n+  const clazz = buf === 'fast' ? Buffer : require('buffer').SlowBuffer;\n   const buff = new clazz(8);\n-  const type = conf.type || 'UInt8';\n   const fn = `read${type}`;\n \n   buff.writeDoubleLE(0, 0, noAssert);\n-  const testFunction = new Function('buff', `\n-    for (var i = 0; i !== ${len}; i++) {\n-      buff.${fn}(0, ${conf.byteLength}, ${JSON.stringify(noAssert)});\n-    }\n-  `);\n   bench.start();\n-  testFunction(buff);\n-  bench.end(len / 1e6);\n+  for (var i = 0; i !== millions * 1e6; i++) {\n+    buff[fn](0, byteLength, noAssert);\n+  }\n+  bench.end(millions);\n }"
        },
        {
            "sha": "868f5cede8bd2ddcfc0089112aa6976779609902",
            "filename": "benchmark/buffers/buffer-read.js",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-read.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -27,18 +27,14 @@ const bench = common.createBenchmark(main, {\n \n function main({ noAssert, millions, buf, type }) {\n   noAssert = noAssert === 'true';\n-  const len = millions * 1e6;\n   const clazz = buf === 'fast' ? Buffer : require('buffer').SlowBuffer;\n   const buff = new clazz(8);\n   const fn = `read${type || 'UInt8'}`;\n \n   buff.writeDoubleLE(0, 0, noAssert);\n-  const testFunction = new Function('buff', `\n-    for (var i = 0; i !== ${len}; i++) {\n-      buff.${fn}(0, ${JSON.stringify(noAssert)});\n-    }\n-  `);\n   bench.start();\n-  testFunction(buff);\n-  bench.end(len / 1e6);\n+  for (var i = 0; i !== millions * 1e6; i++) {\n+    buff[fn](0, noAssert);\n+  }\n+  bench.end(millions);\n }"
        },
        {
            "sha": "823e95bf15d7047e8d33c3123e0d2d1591ed473b",
            "filename": "benchmark/buffers/buffer-write.js",
            "status": "modified",
            "additions": 12,
            "deletions": 19,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer-write.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -46,36 +46,29 @@ const mod = {\n };\n \n function main({ noAssert, millions, buf, type }) {\n-  const len = millions * 1e6;\n   const clazz = buf === 'fast' ? Buffer : require('buffer').SlowBuffer;\n   const buff = new clazz(8);\n   const fn = `write${type || 'UInt8'}`;\n \n   if (/Int/.test(fn))\n-    benchInt(buff, fn, len, noAssert);\n+    benchInt(buff, fn, millions, noAssert);\n   else\n-    benchFloat(buff, fn, len, noAssert);\n+    benchFloat(buff, fn, millions, noAssert);\n }\n \n-function benchInt(buff, fn, len, noAssert) {\n+function benchInt(buff, fn, millions, noAssert) {\n   const m = mod[fn];\n-  const testFunction = new Function('buff', `\n-    for (var i = 0; i !== ${len}; i++) {\n-      buff.${fn}(i & ${m}, 0, ${noAssert});\n-    }\n-  `);\n   bench.start();\n-  testFunction(buff);\n-  bench.end(len / 1e6);\n+  for (var i = 0; i !== millions * 1e6; i++) {\n+    buff[fn](i & m, 0, noAssert);\n+  }\n+  bench.end(millions);\n }\n \n-function benchFloat(buff, fn, len, noAssert) {\n-  const testFunction = new Function('buff', `\n-    for (var i = 0; i !== ${len}; i++) {\n-      buff.${fn}(i, 0, ${noAssert});\n-    }\n-  `);\n+function benchFloat(buff, fn, millions, noAssert) {\n   bench.start();\n-  testFunction(buff);\n-  bench.end(len / 1e6);\n+  for (var i = 0; i !== millions * 1e6; i++) {\n+    buff[fn](i, 0, noAssert);\n+  }\n+  bench.end(millions);\n }"
        },
        {
            "sha": "1263732dce8e4317ed90d3a41ac67a5c1b894701",
            "filename": "benchmark/buffers/buffer_zero.js",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer_zero.js",
            "raw_url": "https://github.com/nodejs/node/raw/794e489eeadbe40fec7928ed9b8f25d7019d795e/benchmark%2Fbuffers%2Fbuffer_zero.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fbuffers%2Fbuffer_zero.js?ref=794e489eeadbe40fec7928ed9b8f25d7019d795e",
            "patch": "@@ -11,12 +11,9 @@ const zeroBuffer = Buffer.alloc(0);\n const zeroString = '';\n \n function main({ n, type }) {\n-  bench.start();\n-\n-  if (type === 'buffer')\n-    for (let i = 0; i < n * 1024; i++) Buffer.from(zeroBuffer);\n-  else if (type === 'string')\n-    for (let i = 0; i < n * 1024; i++) Buffer.from(zeroString);\n+  const data = type === 'buffer' ? zeroBuffer : zeroString;\n \n+  bench.start();\n+  for (var i = 0; i < n * 1024; i++) Buffer.from(data);\n   bench.end(n);\n }"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 64,
        "deletions": 112
    }
}