{
    "author": "Trott",
    "message": "test: improve reliability of http2-session-timeout\n\nCheck actual expired time rather than relying on a number of calls to\nsetTimeout() in test-http2-session-timeout more robust.\n\nPR-URL: https://github.com/nodejs/node/pull/20692\nFixes: https://github.com/nodejs/node/issues/20628\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "9e4ae56cc7a81e299850c2525f8b1c071fabc6e6",
    "files": [
        {
            "sha": "48e98998c700b62f94bd0795c7fab1b7c33060a4",
            "filename": "test/sequential/test-http2-session-timeout.js",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/9e4ae56cc7a81e299850c2525f8b1c071fabc6e6/test%2Fsequential%2Ftest-http2-session-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/9e4ae56cc7a81e299850c2525f8b1c071fabc6e6/test%2Fsequential%2Ftest-http2-session-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-session-timeout.js?ref=9e4ae56cc7a81e299850c2525f8b1c071fabc6e6",
            "patch": "@@ -7,7 +7,6 @@ const h2 = require('http2');\n \n const serverTimeout = common.platformTimeout(200);\n const callTimeout = common.platformTimeout(20);\n-const minRuns = Math.ceil(serverTimeout / callTimeout) * 2;\n const mustNotCall = common.mustNotCall();\n \n const server = h2.createServer();\n@@ -21,9 +20,10 @@ server.listen(0, common.mustCall(() => {\n \n   const url = `http://localhost:${port}`;\n   const client = h2.connect(url);\n-  makeReq(minRuns);\n+  const startTime = process.hrtime();\n+  makeReq();\n \n-  function makeReq(attempts) {\n+  function makeReq() {\n     const request = client.request({\n       ':path': '/foobar',\n       ':method': 'GET',\n@@ -34,12 +34,14 @@ server.listen(0, common.mustCall(() => {\n     request.end();\n \n     request.on('end', () => {\n-      if (attempts) {\n-        setTimeout(() => makeReq(attempts - 1), callTimeout);\n+      const diff = process.hrtime(startTime);\n+      const milliseconds = (diff[0] * 1e3 + diff[1] / 1e6);\n+      if (milliseconds < serverTimeout * 2) {\n+        setTimeout(makeReq, callTimeout);\n       } else {\n         server.removeListener('timeout', mustNotCall);\n-        client.close();\n         server.close();\n+        client.close();\n       }\n     });\n   }"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 8,
        "deletions": 6
    }
}