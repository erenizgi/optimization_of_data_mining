{
    "author": "BridgeAR",
    "message": "lib,src: replace all C++ promises with JS promises\n\nC++ promises can not be properly optimized by V8. They also behave\na tiny bit different than \"regular\" promises.\n\nPR-URL: https://github.com/nodejs/node/pull/20830\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>",
    "sha": "bd1f355fc5805c8307da85a16d1a385e5c48813a",
    "files": [
        {
            "sha": "a790e85ee216df3efcc411837f5f4ad8daabf740",
            "filename": "lib/child_process.js",
            "status": "modified",
            "additions": 10,
            "deletions": 13,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fchild_process.js?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -26,8 +26,6 @@ const {\n   deprecate, convertToValidSignal, getSystemErrorName\n } = require('internal/util');\n const { isUint8Array } = require('internal/util/types');\n-const { createPromise,\n-        promiseResolve, promiseReject } = process.binding('util');\n const debug = util.debuglog('child_process');\n const { Buffer } = require('buffer');\n const { Pipe, constants: PipeConstants } = process.binding('pipe_wrap');\n@@ -152,18 +150,17 @@ exports.exec = function exec(command /* , options, callback */) {\n \n const customPromiseExecFunction = (orig) => {\n   return (...args) => {\n-    const promise = createPromise();\n-\n-    orig(...args, (err, stdout, stderr) => {\n-      if (err !== null) {\n-        err.stdout = stdout;\n-        err.stderr = stderr;\n-        promiseReject(promise, err);\n-      } else {\n-        promiseResolve(promise, { stdout, stderr });\n-      }\n+    return new Promise((resolve, reject) => {\n+      orig(...args, (err, stdout, stderr) => {\n+        if (err !== null) {\n+          err.stdout = stdout;\n+          err.stderr = stderr;\n+          reject(err);\n+        } else {\n+          resolve({ stdout, stderr });\n+        }\n+      });\n     });\n-    return promise;\n   };\n };\n "
        },
        {
            "sha": "bc7642447cbc99ba39065af0911e12d40dd5faab",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -214,10 +214,7 @@ function exists(path, callback) {\n \n Object.defineProperty(exists, internalUtil.promisify.custom, {\n   value: (path) => {\n-    const { createPromise, promiseResolve } = process.binding('util');\n-    const promise = createPromise();\n-    fs.exists(path, (exists) => promiseResolve(promise, exists));\n-    return promise;\n+    return new Promise((resolve) => fs.exists(path, resolve));\n   }\n });\n "
        },
        {
            "sha": "be4545ecc3d70b53868a53dc9c4f7cf199825dc4",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -113,7 +113,6 @@ const { isArrayBufferView } = require('internal/util/types');\n const { FileHandle } = process.binding('fs');\n const binding = process.binding('http2');\n const { ShutdownWrap } = process.binding('stream_wrap');\n-const { createPromise, promiseResolve } = process.binding('util');\n const { UV_EOF } = process.binding('uv');\n \n const { StreamPipe } = internalBinding('stream_pipe');\n@@ -2747,11 +2746,9 @@ function connect(authority, options, listener) {\n // Support util.promisify\n Object.defineProperty(connect, promisify.custom, {\n   value: (authority, options) => {\n-    const promise = createPromise();\n-    const server = connect(authority,\n-                           options,\n-                           () => promiseResolve(promise, server));\n-    return promise;\n+    return new Promise((resolve) => {\n+      const server = connect(authority, options, () => resolve(server));\n+    });\n   }\n });\n "
        },
        {
            "sha": "49dad0c6c35692551868654c1a05ffecbaeec44a",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -8,10 +8,7 @@ const {\n const { signals } = process.binding('constants').os;\n \n const {\n-  createPromise,\n   getHiddenValue,\n-  promiseResolve,\n-  promiseReject,\n   setHiddenValue,\n   arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex,\n   decorated_private_symbol: kDecoratedPrivateSymbolIndex\n@@ -276,24 +273,21 @@ function promisify(original) {\n   const argumentNames = original[kCustomPromisifyArgsSymbol];\n \n   function fn(...args) {\n-    const promise = createPromise();\n-    try {\n+    return new Promise((resolve, reject) => {\n       original.call(this, ...args, (err, ...values) => {\n         if (err) {\n-          promiseReject(promise, err);\n-        } else if (argumentNames !== undefined && values.length > 1) {\n+          return reject(err);\n+        }\n+        if (argumentNames !== undefined && values.length > 1) {\n           const obj = {};\n           for (var i = 0; i < argumentNames.length; i++)\n             obj[argumentNames[i]] = values[i];\n-          promiseResolve(promise, obj);\n+          resolve(obj);\n         } else {\n-          promiseResolve(promise, values[0]);\n+          resolve(values[0]);\n         }\n       });\n-    } catch (err) {\n-      promiseReject(promise, err);\n-    }\n-    return promise;\n+    });\n   }\n \n   Object.setPrototypeOf(fn, Object.getPrototypeOf(original));"
        },
        {
            "sha": "dc9b875ec374c93da03a052e77a410387ff8ceb5",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -41,7 +41,6 @@ const {\n   validateTimerDuration\n } = require('internal/timers');\n const internalUtil = require('internal/util');\n-const { createPromise, promiseResolve } = process.binding('util');\n const util = require('util');\n const { ERR_INVALID_CALLBACK } = require('internal/errors').codes;\n const debug = util.debuglog('timer');\n@@ -439,11 +438,9 @@ function setTimeout(callback, after, arg1, arg2, arg3) {\n }\n \n setTimeout[internalUtil.promisify.custom] = function(after, value) {\n-  const promise = createPromise();\n-  const timeout = new Timeout(promise, after, [value], false);\n-  active(timeout);\n-\n-  return promise;\n+  return new Promise((resolve) => {\n+    active(new Timeout(resolve, after, [value], false));\n+  });\n };\n \n exports.setTimeout = setTimeout;\n@@ -452,7 +449,7 @@ exports.setTimeout = setTimeout;\n function ontimeout(timer) {\n   const args = timer._timerArgs;\n   if (typeof timer._onTimeout !== 'function')\n-    return promiseResolve(timer._onTimeout, args[0]);\n+    return Promise.resolve(timer._onTimeout, args[0]);\n   if (!args)\n     timer._onTimeout();\n   else\n@@ -659,7 +656,7 @@ function tryOnImmediate(immediate, oldTail, count, refCount) {\n function runCallback(timer) {\n   const argv = timer._argv;\n   if (typeof timer._onImmediate !== 'function')\n-    return promiseResolve(timer._onImmediate, argv[0]);\n+    return Promise.resolve(timer._onImmediate, argv[0]);\n   if (!argv)\n     return timer._onImmediate();\n   Reflect.apply(timer._onImmediate, timer, argv);\n@@ -738,9 +735,7 @@ function setImmediate(callback, arg1, arg2, arg3) {\n }\n \n setImmediate[internalUtil.promisify.custom] = function(value) {\n-  const promise = createPromise();\n-  new Immediate(promise, [value]);\n-  return promise;\n+  return new Promise((resolve) => new Immediate(resolve, [value]));\n };\n \n exports.setImmediate = setImmediate;"
        },
        {
            "sha": "9f31786b32557f0126a44f6cb847c109d47c8fc4",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 35,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/bd1f355fc5805c8307da85a16d1a385e5c48813a/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd1f355fc5805c8307da85a16d1a385e5c48813a/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=bd1f355fc5805c8307da85a16d1a385e5c48813a",
            "patch": "@@ -9,7 +9,6 @@ using v8::Context;\n using v8::FunctionCallbackInfo;\n using v8::Integer;\n using v8::Local;\n-using v8::Maybe;\n using v8::Object;\n using v8::Private;\n using v8::Promise;\n@@ -127,36 +126,6 @@ void WatchdogHasPendingSigint(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(ret);\n }\n \n-\n-void CreatePromise(const FunctionCallbackInfo<Value>& args) {\n-  Local<Context> context = args.GetIsolate()->GetCurrentContext();\n-  auto maybe_resolver = Promise::Resolver::New(context);\n-  if (!maybe_resolver.IsEmpty())\n-    args.GetReturnValue().Set(maybe_resolver.ToLocalChecked());\n-}\n-\n-\n-void PromiseResolve(const FunctionCallbackInfo<Value>& args) {\n-  Local<Context> context = args.GetIsolate()->GetCurrentContext();\n-  Local<Value> promise = args[0];\n-  CHECK(promise->IsPromise());\n-  if (promise.As<Promise>()->State() != Promise::kPending) return;\n-  Local<Promise::Resolver> resolver = promise.As<Promise::Resolver>();  // sic\n-  Maybe<bool> ret = resolver->Resolve(context, args[1]);\n-  args.GetReturnValue().Set(ret.FromMaybe(false));\n-}\n-\n-\n-void PromiseReject(const FunctionCallbackInfo<Value>& args) {\n-  Local<Context> context = args.GetIsolate()->GetCurrentContext();\n-  Local<Value> promise = args[0];\n-  CHECK(promise->IsPromise());\n-  if (promise.As<Promise>()->State() != Promise::kPending) return;\n-  Local<Promise::Resolver> resolver = promise.As<Promise::Resolver>();  // sic\n-  Maybe<bool> ret = resolver->Reject(context, args[1]);\n-  args.GetReturnValue().Set(ret.FromMaybe(false));\n-}\n-\n void SafeGetenv(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args[0]->IsString());\n   Utf8Value strenvtag(args.GetIsolate(), args[0]);\n@@ -211,10 +180,6 @@ void Initialize(Local<Object> target,\n   env->SetMethodNoSideEffect(target, \"watchdogHasPendingSigint\",\n                              WatchdogHasPendingSigint);\n \n-  env->SetMethodNoSideEffect(target, \"createPromise\", CreatePromise);\n-  env->SetMethod(target, \"promiseResolve\", PromiseResolve);\n-  env->SetMethod(target, \"promiseReject\", PromiseReject);\n-\n   env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n }\n "
        },
        {
            "sha": "7142c872d9452e784f9347d90986f04e36fc633a",
            "filename": "test/parallel/test-promise-internal-creation.js",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/b70367e8cf0f4eae8a4f0c92b1a8a1fa59fec288/test%2Fparallel%2Ftest-promise-internal-creation.js",
            "raw_url": "https://github.com/nodejs/node/raw/b70367e8cf0f4eae8a4f0c92b1a8a1fa59fec288/test%2Fparallel%2Ftest-promise-internal-creation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-promise-internal-creation.js?ref=b70367e8cf0f4eae8a4f0c92b1a8a1fa59fec288",
            "patch": "@@ -1,41 +0,0 @@\n-'use strict';\n-const common = require('../common');\n-const assert = require('assert');\n-const {\n-  createPromise, promiseResolve, promiseReject\n-} = process.binding('util');\n-const { inspect } = require('util');\n-\n-common.crashOnUnhandledRejection();\n-\n-{\n-  const promise = createPromise();\n-  assert.strictEqual(inspect(promise), 'Promise { <pending> }');\n-  promiseResolve(promise, 42);\n-  assert.strictEqual(inspect(promise), 'Promise { 42 }');\n-  promise.then(common.mustCall((value) => {\n-    assert.strictEqual(value, 42);\n-  }));\n-}\n-\n-{\n-  const promise = createPromise();\n-  const error = new Error('foobar');\n-  promiseReject(promise, error);\n-  assert(inspect(promise).includes('<rejected> Error: foobar'));\n-  promise.catch(common.mustCall((value) => {\n-    assert.strictEqual(value, error);\n-  }));\n-}\n-\n-{\n-  const promise = createPromise();\n-  const error = new Error('foobar');\n-  promiseReject(promise, error);\n-  assert(inspect(promise).includes('<rejected> Error: foobar'));\n-  promiseResolve(promise, 42);\n-  assert(inspect(promise).includes('<rejected> Error: foobar'));\n-  promise.catch(common.mustCall((value) => {\n-    assert.strictEqual(value, error);\n-  }));\n-}"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 27,
        "deletions": 123
    }
}