{
    "author": "joyeecheung",
    "message": "benchmark: support more options in startup benchmark\n\n1. Add options to benchmark the startup performance of a node\n  \"instance\" after running a script. By default there are two options:\n  `test/fixtures/semicolon` which is basically an empty file,\n  and `benchmark/fixtures/require-cachable` which require all\n  the cachable modules before exiting. This allows us to measure\n  the overhead of bootstrap in more scenarios.\n2. Add options to benchmark the overhead of spinning\n  node through a process and through a worker.\n\nPR-URL: https://github.com/nodejs/node/pull/24220\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "1698fc96af2d58dce414cd22b7d9898f30efde3e",
    "files": [
        {
            "sha": "f651728dc78f359d52009d79b5b453f616e76939",
            "filename": "benchmark/fixtures/require-cachable.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/1698fc96af2d58dce414cd22b7d9898f30efde3e/benchmark%2Ffixtures%2Frequire-cachable.js",
            "raw_url": "https://github.com/nodejs/node/raw/1698fc96af2d58dce414cd22b7d9898f30efde3e/benchmark%2Ffixtures%2Frequire-cachable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Ffixtures%2Frequire-cachable.js?ref=1698fc96af2d58dce414cd22b7d9898f30efde3e",
            "patch": "@@ -0,0 +1,13 @@\n+'use strict';\n+\n+const list = require('internal/bootstrap/cache');\n+const {\n+  isMainThread\n+} = require('worker_threads');\n+\n+for (const key of list.cachableBuiltins) {\n+  if (!isMainThread && key === 'trace_events') {\n+    continue;\n+  }\n+  require(key);\n+}"
        },
        {
            "sha": "1350cd291e2b1890ee9b6334cc9deaabe89dcdbe",
            "filename": "benchmark/misc/startup.js",
            "status": "modified",
            "additions": 64,
            "deletions": 24,
            "changes": 88,
            "blob_url": "https://github.com/nodejs/node/blob/1698fc96af2d58dce414cd22b7d9898f30efde3e/benchmark%2Fmisc%2Fstartup.js",
            "raw_url": "https://github.com/nodejs/node/raw/1698fc96af2d58dce414cd22b7d9898f30efde3e/benchmark%2Fmisc%2Fstartup.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Fstartup.js?ref=1698fc96af2d58dce414cd22b7d9898f30efde3e",
            "patch": "@@ -1,36 +1,76 @@\n 'use strict';\n const common = require('../common.js');\n-const spawn = require('child_process').spawn;\n+const { spawn } = require('child_process');\n const path = require('path');\n-const emptyJsFile = path.resolve(__dirname, '../../test/fixtures/semicolon.js');\n \n-const bench = common.createBenchmark(startNode, {\n-  dur: [1]\n+let Worker;  // Lazy loaded in main\n+\n+const bench = common.createBenchmark(main, {\n+  dur: [1],\n+  script: ['benchmark/fixtures/require-cachable', 'test/fixtures/semicolon'],\n+  mode: ['process', 'worker']\n+}, {\n+  flags: ['--expose-internals', '--experimental-worker']  // for workers\n });\n \n-function startNode({ dur }) {\n-  var go = true;\n-  var starts = 0;\n+function spawnProcess(script) {\n+  const cmd = process.execPath || process.argv[0];\n+  const argv = ['--expose-internals', script];\n+  return spawn(cmd, argv);\n+}\n+\n+function spawnWorker(script) {\n+  return new Worker(script, { stderr: true, stdout: true });\n+}\n+\n+function start(state, script, bench, getNode) {\n+  const node = getNode(script);\n+  let stdout = '';\n+  let stderr = '';\n+\n+  node.stdout.on('data', (data) => {\n+    stdout += data;\n+  });\n+\n+  node.stderr.on('data', (data) => {\n+    stderr += data;\n+  });\n+\n+  node.on('exit', (code) => {\n+    if (code !== 0) {\n+      console.error('------ stdout ------');\n+      console.error(stdout);\n+      console.error('------ stderr ------');\n+      console.error(stderr);\n+      throw new Error(`Error during node startup, exit code ${code}`);\n+    }\n+    state.throughput++;\n+\n+    if (state.go) {\n+      start(state, script, bench, getNode);\n+    } else {\n+      bench.end(state.throughput);\n+    }\n+  });\n+}\n+\n+function main({ dur, script, mode }) {\n+  const state = {\n+    go: true,\n+    throughput: 0\n+  };\n \n   setTimeout(function() {\n-    go = false;\n+    state.go = false;\n   }, dur * 1000);\n \n-  bench.start();\n-  start();\n-\n-  function start() {\n-    const node = spawn(process.execPath || process.argv[0], [emptyJsFile]);\n-    node.on('exit', function(exitCode) {\n-      if (exitCode !== 0) {\n-        throw new Error('Error during node startup');\n-      }\n-      starts++;\n-\n-      if (go)\n-        start();\n-      else\n-        bench.end(starts);\n-    });\n+  script = path.resolve(__dirname, '../../', `${script}.js`);\n+  if (mode === 'worker') {\n+    Worker = require('worker_threads').Worker;\n+    bench.start();\n+    start(state, script, bench, spawnWorker);\n+  } else {\n+    bench.start();\n+    start(state, script, bench, spawnProcess);\n   }\n }"
        },
        {
            "sha": "b88415280833bcec3d8d176e84620c67375fe65b",
            "filename": "test/parallel/test-benchmark-misc.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/1698fc96af2d58dce414cd22b7d9898f30efde3e/test%2Fparallel%2Ftest-benchmark-misc.js",
            "raw_url": "https://github.com/nodejs/node/raw/1698fc96af2d58dce414cd22b7d9898f30efde3e/test%2Fparallel%2Ftest-benchmark-misc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-benchmark-misc.js?ref=1698fc96af2d58dce414cd22b7d9898f30efde3e",
            "patch": "@@ -11,4 +11,6 @@ runBenchmark('misc', [\n   'n=1',\n   'type=',\n   'val=magyarorsz√°g.icom.museum',\n+  'script=test/fixtures/semicolon',\n+  'mode=worker'\n ], { NODEJS_BENCHMARK_ZERO_ALLOWED: 1 });"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 79,
        "deletions": 24
    }
}