{
    "author": "addaleax",
    "message": "process: use owner_symbol for `_getActive*`\n\nThis makes it easier to provide public APIs in the return types\nof `process._getActiveHandles()` and `process._getActiveRequests()`.\n\nPR-URL: https://github.com/nodejs/node/pull/22002\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e",
    "files": [
        {
            "sha": "d47c0d6cfb6f442b677018630c8caf2b0bb18950",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e",
            "patch": "@@ -734,6 +734,27 @@ std::string AsyncWrap::diagnostic_name() const {\n       std::to_string(static_cast<int64_t>(async_id_)) + \")\";\n }\n \n+Local<Object> AsyncWrap::GetOwner() {\n+  return GetOwner(env(), object());\n+}\n+\n+Local<Object> AsyncWrap::GetOwner(Environment* env, Local<Object> obj) {\n+  v8::EscapableHandleScope handle_scope(env->isolate());\n+  CHECK(!obj.IsEmpty());\n+\n+  v8::TryCatch ignore_exceptions(env->isolate());\n+  while (true) {\n+    Local<Value> owner;\n+    if (!obj->Get(env->context(),\n+                  env->owner_symbol()).ToLocal(&owner) ||\n+        !owner->IsObject()) {\n+      return handle_scope.Escape(obj);\n+    }\n+\n+    obj = owner.As<Object>();\n+  }\n+}\n+\n }  // namespace node\n \n NODE_BUILTIN_MODULE_CONTEXT_AWARE(async_wrap, node::AsyncWrap::Initialize)"
        },
        {
            "sha": "ee04479de06e6deb78dad6f72a46e81e0e16163d",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e",
            "patch": "@@ -178,6 +178,12 @@ class AsyncWrap : public BaseObject {\n \n   static void WeakCallback(const v8::WeakCallbackInfo<DestroyParam> &info);\n \n+  // Returns the object that 'owns' an async wrap. For example, for a\n+  // TCP connection handle, this is the corresponding net.Socket.\n+  v8::Local<v8::Object> GetOwner();\n+  static v8::Local<v8::Object> GetOwner(Environment* env,\n+                                        v8::Local<v8::Object> obj);\n+\n   // This is a simplified version of InternalCallbackScope that only runs\n   // the `before` and `after` hooks. Only use it when not actually calling\n   // back into JS; otherwise, use InternalCallbackScope."
        },
        {
            "sha": "a6bf512e04f0440f29f6b102cbd9a81ac4cf4de8",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 9,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=5be9b1d7f37ca41b0bb27d532881cb6b0dc54f6e",
            "patch": "@@ -1138,7 +1138,7 @@ static void GetActiveRequests(const FunctionCallbackInfo<Value>& args) {\n   for (auto w : *env->req_wrap_queue()) {\n     if (w->persistent().IsEmpty())\n       continue;\n-    argv[idx] = w->object();\n+    argv[idx] = w->GetOwner();\n     if (++idx >= arraysize(argv)) {\n       fn->Call(ctx, ary, idx, argv).ToLocalChecked();\n       idx = 0;\n@@ -1164,16 +1164,10 @@ void GetActiveHandles(const FunctionCallbackInfo<Value>& args) {\n   Local<Value> argv[NODE_PUSH_VAL_TO_ARRAY_MAX];\n   size_t idx = 0;\n \n-  Local<String> owner_sym = env->owner_string();\n-\n   for (auto w : *env->handle_wrap_queue()) {\n-    if (w->persistent().IsEmpty() || !HandleWrap::HasRef(w))\n+    if (!HandleWrap::HasRef(w))\n       continue;\n-    Local<Object> object = w->object();\n-    Local<Value> owner = object->Get(owner_sym);\n-    if (owner->IsUndefined())\n-      owner = object;\n-    argv[idx] = owner;\n+    argv[idx] = w->GetOwner();\n     if (++idx >= arraysize(argv)) {\n       fn->Call(ctx, ary, idx, argv).ToLocalChecked();\n       idx = 0;"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 30,
        "deletions": 9
    }
}