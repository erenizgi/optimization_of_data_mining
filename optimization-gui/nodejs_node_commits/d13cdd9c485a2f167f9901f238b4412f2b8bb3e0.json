{
    "author": "devsnek",
    "message": "src: move context bootstrap to js\n\nPR-URL: https://github.com/nodejs/node/pull/21518\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
    "files": [
        {
            "sha": "77a44d52b937e16583ef1de7359e6dbfe9a0b56f",
            "filename": "lib/internal/per_context.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/lib%2Finternal%2Fper_context.js",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/lib%2Finternal%2Fper_context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fper_context.js?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -0,0 +1,16 @@\n+'use strict';\n+\n+// node::NewContext calls this script\n+\n+(function(global) {\n+  // https://github.com/nodejs/node/issues/14909\n+  delete global.Intl.v8BreakIterator;\n+\n+  // https://github.com/nodejs/node/issues/21219\n+  Object.defineProperty(global.Atomics, 'notify', {\n+    value: global.Atomics.wake,\n+    writable: true,\n+    enumerable: false,\n+    configurable: true,\n+  });\n+}(this));"
        },
        {
            "sha": "a1f7255fe8636351e7b515b64823703508028d51",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -25,6 +25,7 @@\n     'node_lib_target_name%': 'node_lib',\n     'node_intermediate_lib_type%': 'static_library',\n     'library_files': [\n+      'lib/internal/per_context.js',\n       'lib/internal/bootstrap/cache.js',\n       'lib/internal/bootstrap/loaders.js',\n       'lib/internal/bootstrap/node.js',"
        },
        {
            "sha": "0db313fd36b81e732bde81e8cc75772330c7e949",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 26,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -3497,35 +3497,19 @@ Local<Context> NewContext(Isolate* isolate,\n   auto context = Context::New(isolate, nullptr, object_template);\n   if (context.IsEmpty()) return context;\n   HandleScope handle_scope(isolate);\n+\n   context->SetEmbedderData(\n       ContextEmbedderIndex::kAllowWasmCodeGeneration, True(isolate));\n \n-  auto intl_key = FIXED_ONE_BYTE_STRING(isolate, \"Intl\");\n-  auto break_iter_key = FIXED_ONE_BYTE_STRING(isolate, \"v8BreakIterator\");\n-  Local<Value> intl_v;\n-  if (context->Global()->Get(context, intl_key).ToLocal(&intl_v) &&\n-      intl_v->IsObject()) {\n-    Local<Object> intl = intl_v.As<Object>();\n-    intl->Delete(context, break_iter_key).FromJust();\n-  }\n-\n-  // https://github.com/nodejs/node/issues/21219\n-  // TODO(devsnek): remove when v8 supports Atomics.notify\n-  auto atomics_key = FIXED_ONE_BYTE_STRING(isolate, \"Atomics\");\n-  Local<Value> atomics_v;\n-  if (context->Global()->Get(context, atomics_key).ToLocal(&atomics_v) &&\n-      atomics_v->IsObject()) {\n-    Local<Object> atomics = atomics_v.As<Object>();\n-    auto wake_key = FIXED_ONE_BYTE_STRING(isolate, \"wake\");\n-\n-    Local<Value> wake = atomics->Get(context, wake_key).ToLocalChecked();\n-    auto notify_key = FIXED_ONE_BYTE_STRING(isolate, \"notify\");\n-\n-    v8::PropertyDescriptor desc(wake, true);\n-    desc.set_enumerable(false);\n-    desc.set_configurable(true);\n-\n-    atomics->DefineProperty(context, notify_key, desc).ToChecked();\n+  {\n+    // Run lib/internal/per_context.js\n+    Context::Scope context_scope(context);\n+    Local<String> per_context = NodePerContextSource(isolate);\n+    v8::ScriptCompiler::Source per_context_src(per_context, nullptr);\n+    Local<v8::Script> s = v8::ScriptCompiler::Compile(\n+        context,\n+        &per_context_src).ToLocalChecked();\n+    s->Run(context).ToLocalChecked();\n   }\n \n   return context;"
        },
        {
            "sha": "b551c8bb09baf9d67b361beab06f167cadccab5d",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -241,9 +241,7 @@ class MultiIsolatePlatform : public v8::Platform {\n // Creates a new isolate with Node.js-specific settings.\n NODE_EXTERN v8::Isolate* NewIsolate(ArrayBufferAllocator* allocator);\n \n-// Creates a new context with Node.js-specific tweaks.  Currently, it removes\n-// the `v8BreakIterator` property from the global `Intl` object if present.\n-// See https://github.com/nodejs/node/issues/14909 for more info.\n+// Creates a new context with Node.js-specific tweaks.\n NODE_EXTERN v8::Local<v8::Context> NewContext(\n     v8::Isolate* isolate,\n     v8::Local<v8::ObjectTemplate> object_template ="
        },
        {
            "sha": "00cdc0c0b6c13e352614e83d3953d52e409f0d9d",
            "filename": "src/node_javascript.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode_javascript.h",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/src%2Fnode_javascript.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_javascript.h?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -29,6 +29,7 @@\n namespace node {\n \n void DefineJavaScript(Environment* env, v8::Local<v8::Object> target);\n+v8::Local<v8::String> NodePerContextSource(v8::Isolate* isolate);\n v8::Local<v8::String> LoadersBootstrapperSource(Environment* env);\n v8::Local<v8::String> NodeBootstrapperSource(Environment* env);\n "
        },
        {
            "sha": "249df58085dd96416d97eaecf9faae6915060ced",
            "filename": "tools/js2c.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/tools%2Fjs2c.py",
            "raw_url": "https://github.com/nodejs/node/raw/d13cdd9c485a2f167f9901f238b4412f2b8bb3e0/tools%2Fjs2c.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fjs2c.py?ref=d13cdd9c485a2f167f9901f238b4412f2b8bb3e0",
            "patch": "@@ -189,6 +189,10 @@ def ReadMacros(lines):\n \n }}  // anonymous namespace\n \n+v8::Local<v8::String> NodePerContextSource(v8::Isolate* isolate) {{\n+  return internal_per_context_value.ToStringChecked(isolate);\n+}}\n+\n v8::Local<v8::String> LoadersBootstrapperSource(Environment* env) {{\n   return internal_bootstrap_loaders_value.ToStringChecked(env->isolate());\n }}"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 33,
        "deletions": 29
    }
}