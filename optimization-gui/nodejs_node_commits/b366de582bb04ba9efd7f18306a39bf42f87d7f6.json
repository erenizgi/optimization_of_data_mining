{
    "author": "chinhuang007",
    "message": "src: add trace points to dns\n\nAdd trace points to dns under node.dns.native category.\nEmit trace events for dns operations. Use the\nnestable async events instead of deprecated ones.\nInclude test code to verify the trace log. The\ntrace name is stored as const char* class variable.\nThe test code is to check each operation in separate\nsync processes.\n\nRefs: https://github.com/nodejs/node/pull/19157\n\nPR-URL: https://github.com/nodejs/node/pull/21840\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "b366de582bb04ba9efd7f18306a39bf42f87d7f6",
    "files": [
        {
            "sha": "376af021f80bc87ed2705b2860284bd890adc6c2",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 57,
            "deletions": 16,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/b366de582bb04ba9efd7f18306a39bf42f87d7f6/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b366de582bb04ba9efd7f18306a39bf42f87d7f6/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=b366de582bb04ba9efd7f18306a39bf42f87d7f6",
            "patch": "@@ -596,9 +596,10 @@ void ChannelWrap::EnsureServers() {\n \n class QueryWrap : public AsyncWrap {\n  public:\n-  QueryWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n+  QueryWrap(ChannelWrap* channel, Local<Object> req_wrap_obj, const char* name)\n       : AsyncWrap(channel->env(), req_wrap_obj, AsyncWrap::PROVIDER_QUERYWRAP),\n-        channel_(channel) {\n+        channel_(channel),\n+        trace_name_(name) {\n     // Make sure the channel object stays alive during the query lifetime.\n     req_wrap_obj->Set(env()->context(),\n                       env()->channel_string(),\n@@ -625,6 +626,9 @@ class QueryWrap : public AsyncWrap {\n                  int dnsclass,\n                  int type) {\n     channel_->EnsureServers();\n+    TRACE_EVENT_NESTABLE_ASYNC_BEGIN1(\n+      TRACING_CATEGORY_NODE2(dns, native), trace_name_, this,\n+      \"name\", TRACE_STR_COPY(name));\n     ares_query(channel_->cares_channel(), name, dnsclass, type, Callback,\n                static_cast<void*>(this));\n   }\n@@ -721,6 +725,9 @@ class QueryWrap : public AsyncWrap {\n       extra\n     };\n     const int argc = arraysize(argv) - extra.IsEmpty();\n+    TRACE_EVENT_NESTABLE_ASYNC_END0(\n+        TRACING_CATEGORY_NODE2(dns, native), trace_name_, this);\n+\n     MakeCallback(env()->oncomplete_string(), argc, argv);\n   }\n \n@@ -730,6 +737,9 @@ class QueryWrap : public AsyncWrap {\n     Context::Scope context_scope(env()->context());\n     const char* code = ToErrorCodeString(status);\n     Local<Value> arg = OneByteString(env()->isolate(), code);\n+    TRACE_EVENT_NESTABLE_ASYNC_END1(\n+        TRACING_CATEGORY_NODE2(dns, native), trace_name_, this,\n+        \"error\", status);\n     MakeCallback(env()->oncomplete_string(), 1, &arg);\n   }\n \n@@ -743,6 +753,9 @@ class QueryWrap : public AsyncWrap {\n   }\n \n   ChannelWrap* channel_;\n+\n+ private:\n+  const char* trace_name_;\n };\n \n \n@@ -1173,7 +1186,7 @@ int ParseSoaReply(Environment* env,\n class QueryAnyWrap: public QueryWrap {\n  public:\n   QueryAnyWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-    : QueryWrap(channel, req_wrap_obj) {\n+    : QueryWrap(channel, req_wrap_obj, \"resolveAny\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1354,7 +1367,7 @@ class QueryAnyWrap: public QueryWrap {\n class QueryAWrap: public QueryWrap {\n  public:\n   QueryAWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolve4\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1402,7 +1415,7 @@ class QueryAWrap: public QueryWrap {\n class QueryAaaaWrap: public QueryWrap {\n  public:\n   QueryAaaaWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolve6\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1450,7 +1463,7 @@ class QueryAaaaWrap: public QueryWrap {\n class QueryCnameWrap: public QueryWrap {\n  public:\n   QueryCnameWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveCname\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1485,7 +1498,7 @@ class QueryCnameWrap: public QueryWrap {\n class QueryMxWrap: public QueryWrap {\n  public:\n   QueryMxWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveMx\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1520,7 +1533,7 @@ class QueryMxWrap: public QueryWrap {\n class QueryNsWrap: public QueryWrap {\n  public:\n   QueryNsWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveNs\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1555,7 +1568,7 @@ class QueryNsWrap: public QueryWrap {\n class QueryTxtWrap: public QueryWrap {\n  public:\n   QueryTxtWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveTxt\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1589,7 +1602,7 @@ class QueryTxtWrap: public QueryWrap {\n class QuerySrvWrap: public QueryWrap {\n  public:\n   explicit QuerySrvWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveSrv\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1622,7 +1635,7 @@ class QuerySrvWrap: public QueryWrap {\n class QueryPtrWrap: public QueryWrap {\n  public:\n   explicit QueryPtrWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolvePtr\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1657,7 +1670,7 @@ class QueryPtrWrap: public QueryWrap {\n class QueryNaptrWrap: public QueryWrap {\n  public:\n   explicit QueryNaptrWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveNaptr\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1691,7 +1704,7 @@ class QueryNaptrWrap: public QueryWrap {\n class QuerySoaWrap: public QueryWrap {\n  public:\n   QuerySoaWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"resolveSoa\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1756,7 +1769,7 @@ class QuerySoaWrap: public QueryWrap {\n class GetHostByAddrWrap: public QueryWrap {\n  public:\n   explicit GetHostByAddrWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n-      : QueryWrap(channel, req_wrap_obj) {\n+      : QueryWrap(channel, req_wrap_obj, \"reverse\") {\n   }\n \n   int Send(const char* name) override {\n@@ -1773,6 +1786,11 @@ class GetHostByAddrWrap: public QueryWrap {\n       return UV_EINVAL;  // So errnoException() reports a proper error.\n     }\n \n+    TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(\n+        TRACING_CATEGORY_NODE2(dns, native), \"reverse\", this,\n+        \"name\", TRACE_STR_COPY(name),\n+        \"family\", family == AF_INET ? \"ipv4\" : \"ipv6\");\n+\n     ares_gethostbyaddr(channel_->cares_channel(),\n                        address_buffer,\n                        length,\n@@ -1835,8 +1853,10 @@ void AfterGetAddrInfo(uv_getaddrinfo_t* req, int status, struct addrinfo* res) {\n     Null(env->isolate())\n   };\n \n+  uint64_t n = 0;\n+  const bool verbatim = req_wrap->verbatim();\n+\n   if (status == 0) {\n-    int n = 0;\n     Local<Array> results = Array::New(env->isolate());\n \n     auto add = [&] (bool want_ipv4, bool want_ipv6) {\n@@ -1864,7 +1884,6 @@ void AfterGetAddrInfo(uv_getaddrinfo_t* req, int status, struct addrinfo* res) {\n       }\n     };\n \n-    const bool verbatim = req_wrap->verbatim();\n     add(true, verbatim);\n     if (verbatim == false)\n       add(false, true);\n@@ -1879,6 +1898,10 @@ void AfterGetAddrInfo(uv_getaddrinfo_t* req, int status, struct addrinfo* res) {\n \n   uv_freeaddrinfo(res);\n \n+  TRACE_EVENT_NESTABLE_ASYNC_END2(\n+      TRACING_CATEGORY_NODE2(dns, native), \"lookup\", req_wrap,\n+      \"count\", n, \"verbatim\", verbatim);\n+\n   // Make the callback into JavaScript\n   req_wrap->MakeCallback(env->oncomplete_string(), arraysize(argv), argv);\n \n@@ -1910,6 +1933,11 @@ void AfterGetNameInfo(uv_getnameinfo_t* req,\n     argv[2] = js_service;\n   }\n \n+  TRACE_EVENT_NESTABLE_ASYNC_END2(\n+      TRACING_CATEGORY_NODE2(dns, native), \"lookupService\", req_wrap,\n+      \"hostname\", TRACE_STR_COPY(hostname),\n+      \"service\", TRACE_STR_COPY(service));\n+\n   // Make the callback into JavaScript\n   req_wrap->MakeCallback(env->oncomplete_string(), arraysize(argv), argv);\n \n@@ -1986,6 +2014,12 @@ void GetAddrInfo(const FunctionCallbackInfo<Value>& args) {\n   hints.ai_socktype = SOCK_STREAM;\n   hints.ai_flags = flags;\n \n+  TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(\n+      TRACING_CATEGORY_NODE2(dns, native), \"lookup\", req_wrap,\n+      \"hostname\", TRACE_STR_COPY(*hostname),\n+      \"family\",\n+      family == AF_INET ? \"ipv4\" : family == AF_INET6 ? \"ipv6\" : \"unspec\");\n+\n   int err = req_wrap->Dispatch(uv_getaddrinfo,\n                                AfterGetAddrInfo,\n                                *hostname,\n@@ -2014,6 +2048,10 @@ void GetNameInfo(const FunctionCallbackInfo<Value>& args) {\n \n   GetNameInfoReqWrap* req_wrap = new GetNameInfoReqWrap(env, req_wrap_obj);\n \n+  TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(\n+      TRACING_CATEGORY_NODE2(dns, native), \"lookupService\", req_wrap,\n+      \"ip\", TRACE_STR_COPY(*ip), \"port\", port);\n+\n   int err = req_wrap->Dispatch(uv_getnameinfo,\n                                AfterGetNameInfo,\n                                reinterpret_cast<struct sockaddr*>(&addr),\n@@ -2145,6 +2183,9 @@ void Cancel(const FunctionCallbackInfo<Value>& args) {\n   ChannelWrap* channel;\n   ASSIGN_OR_RETURN_UNWRAP(&channel, args.Holder());\n \n+  TRACE_EVENT_INSTANT0(TRACING_CATEGORY_NODE2(dns, native),\n+      \"cancel\", TRACE_EVENT_SCOPE_THREAD);\n+\n   ares_cancel(channel->cares_channel());\n }\n "
        },
        {
            "sha": "3eb787a2caf70ea18b8875a2d8c3532f2dc106f4",
            "filename": "test/internet/test-trace-events-dns.js",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/b366de582bb04ba9efd7f18306a39bf42f87d7f6/test%2Finternet%2Ftest-trace-events-dns.js",
            "raw_url": "https://github.com/nodejs/node/raw/b366de582bb04ba9efd7f18306a39bf42f87d7f6/test%2Finternet%2Ftest-trace-events-dns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Finternet%2Ftest-trace-events-dns.js?ref=b366de582bb04ba9efd7f18306a39bf42f87d7f6",
            "patch": "@@ -0,0 +1,68 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const fs = require('fs');\n+const util = require('util');\n+\n+if (!common.isMainThread)\n+  common.skip('process.chdir is not available in Workers');\n+\n+const traceFile = 'node_trace.1.log';\n+\n+tmpdir.refresh();\n+process.chdir(tmpdir.path);\n+\n+const test_str = 'const dns = require(\"dns\");' +\n+'const options = {' +\n+'  family: 4,' +\n+'  hints: dns.ADDRCONFIG | dns.V4MAPPED,' +\n+'};';\n+\n+const tests = {\n+  'lookup': 'dns.lookup(\"example.com\", options, (err, address, family) => {});',\n+  'lookupService': 'dns.lookupService(\"127.0.0.1\", 22, ' +\n+                   '(err, hostname, service) => {});',\n+  'reverse': 'dns.reverse(\"8.8.8.8\", (err, hostnames) => {});',\n+  'resolveAny': 'dns.resolveAny(\"example.com\", (err, res) => {});',\n+  'resolve4': 'dns.resolve4(\"example.com\", (err, res) => {});',\n+  'resolve6': 'dns.resolve6(\"example.com\", (err, res) => {});',\n+  'resolveCname': 'dns.resolveCname(\"example.com\", (err, res) => {});',\n+  'resolveMx': 'dns.resolveMx(\"example.com\", (err, res) => {});',\n+  'resolveNs': 'dns.resolveNs(\"example.com\", (err, res) => {});',\n+  'resolveTxt': 'dns.resolveTxt(\"example.com\", (err, res) => {});',\n+  'resolveSrv': 'dns.resolveSrv(\"example.com\", (err, res) => {});',\n+  'resolvePtr': 'dns.resolvePtr(\"example.com\", (err, res) => {});',\n+  'resolveNaptr': 'dns.resolveNaptr(\"example.com\", (err, res) => {});',\n+  'resolveSoa': 'dns.resolveSoa(\"example.com\", (err, res) => {});'\n+};\n+\n+for (const tr in tests) {\n+  const proc = cp.spawnSync(process.execPath,\n+                            [ '--trace-event-categories',\n+                              'node.dns.native',\n+                              '-e',\n+                              test_str + tests[tr]\n+                            ],\n+                            { encoding: 'utf8' });\n+\n+  // Make sure the operation is successful.\n+  assert.strictEqual(proc.status, 0, `${tr}:\\n${util.inspect(proc)}`);\n+\n+  const file = path.join(tmpdir.path, traceFile);\n+\n+  // Confirm that trace log file is created.\n+  assert(common.fileExists(file));\n+  const data = fs.readFileSync(file);\n+  const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n+\n+  assert(traces.length > 0);\n+\n+  // DNS native trace events should be generated.\n+  assert(traces.some((trace) => {\n+    return (trace.name === tr && trace.pid === proc.pid);\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 141,
        "additions": 125,
        "deletions": 16
    }
}