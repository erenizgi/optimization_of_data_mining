{
    "author": "joyeecheung",
    "message": "fs: throw errors from fs.fsyncSync in JS\n\nPR-URL: https://github.com/nodejs/node/pull/18348\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "eca93e631f4c080ca72a762bfa3b214aef3af48a",
    "files": [
        {
            "sha": "e3801d30db2cec94615e93f902f76183ecbc0d12",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/eca93e631f4c080ca72a762bfa3b214aef3af48a/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/eca93e631f4c080ca72a762bfa3b214aef3af48a/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=eca93e631f4c080ca72a762bfa3b214aef3af48a",
            "patch": "@@ -1045,7 +1045,11 @@ fs.fsync = function(fd, callback) {\n \n fs.fsyncSync = function(fd) {\n   validateUint32(fd, 'fd');\n-  return binding.fsync(fd);\n+  const ctx = {};\n+  binding.fsync(fd, undefined, ctx);\n+  if (ctx.errno !== undefined) {\n+    throw new errors.uvException(ctx);\n+  }\n };\n \n fs.mkdir = function(path, mode, callback) {"
        },
        {
            "sha": "3ffec4225b216cc640cdbba1808dfd6720f01de3",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 7,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/eca93e631f4c080ca72a762bfa3b214aef3af48a/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eca93e631f4c080ca72a762bfa3b214aef3af48a/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=eca93e631f4c080ca72a762bfa3b214aef3af48a",
            "patch": "@@ -739,7 +739,7 @@ static void Fdatasync(const FunctionCallbackInfo<Value>& args) {\n   CHECK_GE(argc, 2);\n \n   CHECK(args[0]->IsInt32());\n-  const int fd = args[0]->As<Int32>()->Value();\n+  const int fd = args[0].As<Int32>()->Value();\n \n   if (args[1]->IsObject()) {  // fdatasync(fd, req)\n     CHECK_EQ(argc, 2);\n@@ -756,16 +756,21 @@ static void Fdatasync(const FunctionCallbackInfo<Value>& args) {\n static void Fsync(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  CHECK(args[0]->IsInt32());\n+  const int argc = args.Length();\n+  CHECK_GE(argc, 2);\n \n-  int fd = args[0]->Int32Value();\n+  CHECK(args[0]->IsInt32());\n+  const int fd = args[0].As<Int32>()->Value();\n \n-  if (args[1]->IsObject()) {\n-    CHECK_EQ(args.Length(), 2);\n+  if (args[1]->IsObject()) {  // fsync(fd, req)\n+    CHECK_EQ(argc, 2);\n     AsyncCall(env, args, \"fsync\", UTF8, AfterNoArgs,\n               uv_fs_fsync, fd);\n-  } else {\n-    SYNC_CALL(fsync, 0, fd)\n+  } else {  // fsync(fd, undefined, ctx)\n+    CHECK_EQ(argc, 3);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[2], &req_wrap, \"fsync\",\n+             uv_fs_fsync, fd);\n   }\n }\n "
        },
        {
            "sha": "ba44c28d432983ee96659affda4742cae08c7f04",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/eca93e631f4c080ca72a762bfa3b214aef3af48a/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/eca93e631f4c080ca72a762bfa3b214aef3af48a/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=eca93e631f4c080ca72a762bfa3b214aef3af48a",
            "patch": "@@ -503,3 +503,24 @@ function re(literals, ...values) {\n     validateError\n   );\n }\n+\n+// fsync\n+{\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, fsync');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'fsync');\n+    return true;\n+  };\n+\n+  const fd = fs.openSync(existingFile, 'r');\n+  fs.closeSync(fd);\n+\n+  fs.fsync(fd, common.mustCall(validateError));\n+\n+  assert.throws(\n+    () => fs.fsyncSync(fd),\n+    validateError\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}