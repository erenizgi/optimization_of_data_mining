{
    "author": "sam-github",
    "message": "test: do not race connection and rejection\n\nExisting code assumed that the server completed the handshake before the\nclient rejected the certificate, and destroyed the socket. This\nassumption is fragile, remove it, and instead check explicitly that data\ncan or cannot be exchanged via TLS, whichever is expected.\n\nPR-URL: https://github.com/nodejs/node/pull/25508\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1316b7652a50da7e996897edfab9a1d3c365d3b5",
    "files": [
        {
            "sha": "9eff6cb9cead012b6ebc1a30c69dc01133c88c9a",
            "filename": "test/parallel/test-tls-client-reject.js",
            "status": "modified",
            "additions": 23,
            "deletions": 15,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/1316b7652a50da7e996897edfab9a1d3c365d3b5/test%2Fparallel%2Ftest-tls-client-reject.js",
            "raw_url": "https://github.com/nodejs/node/raw/1316b7652a50da7e996897edfab9a1d3c365d3b5/test%2Fparallel%2Ftest-tls-client-reject.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-client-reject.js?ref=1316b7652a50da7e996897edfab9a1d3c365d3b5",
            "patch": "@@ -33,49 +33,57 @@ const options = {\n   cert: fixtures.readSync('test_cert.pem')\n };\n \n-const server = tls.createServer(options, common.mustCall(function(socket) {\n-  socket.on('data', function(data) {\n-    console.error(data.toString());\n-    assert.strictEqual(data.toString(), 'ok');\n-  });\n-}, 3)).listen(0, function() {\n+const server = tls.createServer(options, function(socket) {\n+  socket.pipe(socket);\n+  socket.on('end', () => socket.end());\n+}).listen(0, common.mustCall(function() {\n   unauthorized();\n-});\n+}));\n \n function unauthorized() {\n+  console.log('connect unauthorized');\n   const socket = tls.connect({\n     port: server.address().port,\n     servername: 'localhost',\n     rejectUnauthorized: false\n   }, common.mustCall(function() {\n+    console.log('... unauthorized');\n     assert(!socket.authorized);\n-    socket.end();\n-    rejectUnauthorized();\n+    socket.on('data', common.mustCall((data) => {\n+      assert.strictEqual(data.toString(), 'ok');\n+    }));\n+    socket.on('end', () => rejectUnauthorized());\n   }));\n   socket.on('error', common.mustNotCall());\n-  socket.write('ok');\n+  socket.end('ok');\n }\n \n function rejectUnauthorized() {\n+  console.log('reject unauthorized');\n   const socket = tls.connect(server.address().port, {\n     servername: 'localhost'\n   }, common.mustNotCall());\n+  socket.on('data', common.mustNotCall());\n   socket.on('error', common.mustCall(function(err) {\n-    console.error(err);\n+    console.log('... rejected:', err);\n     authorized();\n   }));\n-  socket.write('ng');\n+  socket.end('ng');\n }\n \n function authorized() {\n+  console.log('connect authorized');\n   const socket = tls.connect(server.address().port, {\n     ca: [fixtures.readSync('test_cert.pem')],\n     servername: 'localhost'\n   }, common.mustCall(function() {\n+    console.log('... authorized');\n     assert(socket.authorized);\n-    socket.end();\n-    server.close();\n+    socket.on('data', common.mustCall((data) => {\n+      assert.strictEqual(data.toString(), 'ok');\n+    }));\n+    socket.on('end', () => server.close());\n   }));\n   socket.on('error', common.mustNotCall());\n-  socket.write('ok');\n+  socket.end('ok');\n }"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 23,
        "deletions": 15
    }
}