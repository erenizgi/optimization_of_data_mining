{
    "author": "cjihrig",
    "message": "cli: add --max-http-header-size flag\n\nAllow the maximum size of HTTP headers to be overridden from\nthe command line.\n\nco-authored-by: Matteo Collina <hello@matteocollina.com>\nPR-URL: https://github.com/nodejs/node/pull/24811\nFixes: https://github.com/nodejs/node/issues/24692\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Myles Borins <myles.borins@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "632f2633249dc0f295e9d2abab33baaf0f75ce6f",
    "files": [
        {
            "sha": "97cfea239e4f1fcc3337c54bb52bc168546053d2",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -197,6 +197,13 @@ added: v9.0.0\n \n Specify the `file` of the custom [experimental ECMAScript Module][] loader.\n \n+### `--max-http-header-size=size`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Specify the maximum size, in bytes, of HTTP headers. Defaults to 8KB.\n+\n ### `--napi-modules`\n <!-- YAML\n added: v7.10.0\n@@ -620,6 +627,7 @@ Node.js options that are allowed are:\n - `--inspect-brk`\n - `--inspect-port`\n - `--loader`\n+- `--max-http-header-size`\n - `--napi-modules`\n - `--no-deprecation`\n - `--no-force-async-hooks-checks`"
        },
        {
            "sha": "66933066bcae15cefa7b0bacea56e0a3650ad5ea",
            "filename": "doc/node.1",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/doc%2Fnode.1",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/doc%2Fnode.1",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fnode.1?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -139,6 +139,9 @@ Specify the\n as a custom loader, to load\n .Fl -experimental-modules .\n .\n+.It Fl -max-http-header-size Ns = Ns Ar size\n+Specify the maximum size of HTTP headers in bytes. Defaults to 8KB.\n+.\n .It Fl -napi-modules\n This option is a no-op.\n It is kept for compatibility."
        },
        {
            "sha": "9274f9dae0b7f9dc57436dae6bc1d93f0bd5db18",
            "filename": "src/node_http_parser_impl.h",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_http_parser_impl.h",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_http_parser_impl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser_impl.h?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -830,7 +830,7 @@ class Parser : public AsyncWrap, public StreamListener {\n   int TrackHeader(size_t len) {\n #ifdef NODE_EXPERIMENTAL_HTTP\n     header_nread_ += len;\n-    if (header_nread_ >= kMaxHeaderSize) {\n+    if (header_nread_ >= per_process_opts->max_http_header_size) {\n       llhttp_set_error_reason(&parser_, \"HPE_HEADER_OVERFLOW:Header overflow\");\n       return HPE_USER;\n     }\n@@ -892,9 +892,6 @@ class Parser : public AsyncWrap, public StreamListener {\n   typedef int (Parser::*DataCall)(const char* at, size_t length);\n \n   static const parser_settings_t settings;\n-#ifdef NODE_EXPERIMENTAL_HTTP\n-  static const uint64_t kMaxHeaderSize = 8 * 1024;\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n };\n \n const parser_settings_t Parser::settings = {\n@@ -916,6 +913,14 @@ const parser_settings_t Parser::settings = {\n };\n \n \n+#ifndef NODE_EXPERIMENTAL_HTTP\n+void InitMaxHttpHeaderSizeOnce() {\n+  const uint32_t max_http_header_size = per_process_opts->max_http_header_size;\n+  http_parser_set_max_header_size(max_http_header_size);\n+}\n+#endif  /* NODE_EXPERIMENTAL_HTTP */\n+\n+\n void InitializeHttpParser(Local<Object> target,\n                           Local<Value> unused,\n                           Local<Context> context,\n@@ -965,6 +970,11 @@ void InitializeHttpParser(Local<Object> target,\n   target->Set(env->context(),\n               FIXED_ONE_BYTE_STRING(env->isolate(), \"HTTPParser\"),\n               t->GetFunction(env->context()).ToLocalChecked()).FromJust();\n+\n+#ifndef NODE_EXPERIMENTAL_HTTP\n+  static uv_once_t init_once = UV_ONCE_INIT;\n+  uv_once(&init_once, InitMaxHttpHeaderSizeOnce);\n+#endif  /* NODE_EXPERIMENTAL_HTTP */\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "117bff4a944b39e07a9e2ac4a46ce6704d9a3689",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -259,6 +259,10 @@ PerProcessOptionsParser::PerProcessOptionsParser() {\n             kAllowedInEnvironment);\n   AddAlias(\"--trace-events-enabled\", {\n     \"--trace-event-categories\", \"v8,node,node.async_hooks\" });\n+  AddOption(\"--max-http-header-size\",\n+            \"set the maximum size of HTTP headers (default: 8KB)\",\n+            &PerProcessOptions::max_http_header_size,\n+            kAllowedInEnvironment);\n   AddOption(\"--v8-pool-size\",\n             \"set V8's thread pool size\",\n             &PerProcessOptions::v8_thread_pool_size,"
        },
        {
            "sha": "ae7d7a4be5f0656c17b817cfe5f49e9ded0c7bd0",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -151,6 +151,7 @@ class PerProcessOptions : public Options {\n   std::string title;\n   std::string trace_event_categories;\n   std::string trace_event_file_pattern = \"node_trace.${rotation}.log\";\n+  uint64_t max_http_header_size = 8 * 1024;\n   int64_t v8_thread_pool_size = 4;\n   bool zero_fill_all_buffers = false;\n "
        },
        {
            "sha": "b91135a61a2a5ae7df5c488d35231fa2e6d6234a",
            "filename": "test/sequential/test-http-max-http-headers.js",
            "status": "modified",
            "additions": 45,
            "deletions": 24,
            "changes": 69,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-max-http-headers.js?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -4,10 +4,14 @@ const common = require('../common');\n const assert = require('assert');\n const http = require('http');\n const net = require('net');\n-const MAX = 8 * 1024; // 8KB\n+const MAX = +(process.argv[2] || 8 * 1024); // Command line option, or 8KB.\n \n const { getOptionValue } = require('internal/options');\n \n+console.log('pid is', process.pid);\n+console.log('max header size is', getOptionValue('--max-http-header-size'));\n+console.log('current http parser is', getOptionValue('--http-parser'));\n+\n // Verify that we cannot receive more than 8KB of headers.\n \n function once(cb) {\n@@ -38,19 +42,15 @@ function fillHeaders(headers, currentSize, valid = false) {\n \n   // Generate valid headers\n   if (valid) {\n-    // TODO(mcollina): understand why -9 is needed instead of -1\n-    headers = headers.slice(0, -9);\n+    // TODO(mcollina): understand why -32 is needed instead of -1\n+    headers = headers.slice(0, -32);\n   }\n   return headers + '\\r\\n\\r\\n';\n }\n \n-const timeout = common.platformTimeout(10);\n-\n function writeHeaders(socket, headers) {\n   const array = [];\n-\n-  // This is off from 1024 so that \\r\\n does not get split\n-  const chunkSize = 1000;\n+  const chunkSize = 100;\n   let last = 0;\n \n   for (let i = 0; i < headers.length / chunkSize; i++) {\n@@ -65,19 +65,25 @@ function writeHeaders(socket, headers) {\n   next();\n \n   function next() {\n-    if (socket.write(array.shift())) {\n-      if (array.length === 0) {\n-        socket.end();\n-      } else {\n-        setTimeout(next, timeout);\n-      }\n+    if (socket.destroyed) {\n+      console.log('socket was destroyed early, data left to write:',\n+                  array.join('').length);\n+      return;\n+    }\n+\n+    const chunk = array.shift();\n+\n+    if (chunk) {\n+      console.log('writing chunk of size', chunk.length);\n+      socket.write(chunk, next);\n     } else {\n-      socket.once('drain', next);\n+      socket.end();\n     }\n   }\n }\n \n function test1() {\n+  console.log('test1');\n   let headers =\n     'HTTP/1.1 200 OK\\r\\n' +\n     'Content-Length: 0\\r\\n' +\n@@ -92,6 +98,9 @@ function test1() {\n       writeHeaders(sock, headers);\n       sock.resume();\n     });\n+\n+    // The socket might error but that's ok\n+    sock.on('error', () => {});\n   });\n \n   server.listen(0, common.mustCall(() => {\n@@ -100,17 +109,17 @@ function test1() {\n \n     client.on('error', common.mustCall((err) => {\n       assert.strictEqual(err.code, 'HPE_HEADER_OVERFLOW');\n-      server.close();\n-      setImmediate(test2);\n+      server.close(test2);\n     }));\n   }));\n }\n \n const test2 = common.mustCall(() => {\n+  console.log('test2');\n   let headers =\n     'GET / HTTP/1.1\\r\\n' +\n     'Host: localhost\\r\\n' +\n-    'Agent: node\\r\\n' +\n+    'Agent: nod2\\r\\n' +\n     'X-CRASH: ';\n \n   // /, Host, localhost, Agent, node, X-CRASH, a...\n@@ -119,7 +128,7 @@ const test2 = common.mustCall(() => {\n \n   const server = http.createServer(common.mustNotCall());\n \n-  server.on('clientError', common.mustCall((err) => {\n+  server.once('clientError', common.mustCall((err) => {\n     assert.strictEqual(err.code, 'HPE_HEADER_OVERFLOW');\n   }));\n \n@@ -131,34 +140,46 @@ const test2 = common.mustCall(() => {\n     });\n \n     finished(client, common.mustCall((err) => {\n-      server.close();\n-      setImmediate(test3);\n+      server.close(test3);\n     }));\n   }));\n });\n \n const test3 = common.mustCall(() => {\n+  console.log('test3');\n   let headers =\n     'GET / HTTP/1.1\\r\\n' +\n     'Host: localhost\\r\\n' +\n-    'Agent: node\\r\\n' +\n+    'Agent: nod3\\r\\n' +\n     'X-CRASH: ';\n \n   // /, Host, localhost, Agent, node, X-CRASH, a...\n   const currentSize = 1 + 4 + 9 + 5 + 4 + 7;\n   headers = fillHeaders(headers, currentSize, true);\n \n+  console.log('writing', headers.length);\n+\n   const server = http.createServer(common.mustCall((req, res) => {\n-    res.end('hello world');\n-    setImmediate(server.close.bind(server));\n+    res.end('hello from test3 server');\n+    server.close();\n   }));\n \n+  server.on('clientError', (err) => {\n+    console.log(err.code);\n+    if (err.code === 'HPE_HEADER_OVERFLOW') {\n+      console.log(err.rawPacket.toString('hex'));\n+    }\n+  });\n+  server.on('clientError', common.mustNotCall());\n+\n   server.listen(0, common.mustCall(() => {\n     const client = net.connect(server.address().port);\n     client.on('connect', () => {\n       writeHeaders(client, headers);\n       client.resume();\n     });\n+\n+    client.pipe(process.stdout);\n   }));\n });\n "
        },
        {
            "sha": "657f9948be149dd6e77b25c04ae2838ad302933c",
            "filename": "test/sequential/test-set-http-max-http-headers.js",
            "status": "added",
            "additions": 109,
            "deletions": 0,
            "changes": 109,
            "blob_url": "https://github.com/nodejs/node/blob/632f2633249dc0f295e9d2abab33baaf0f75ce6f/test%2Fsequential%2Ftest-set-http-max-http-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/632f2633249dc0f295e9d2abab33baaf0f75ce6f/test%2Fsequential%2Ftest-set-http-max-http-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-set-http-max-http-headers.js?ref=632f2633249dc0f295e9d2abab33baaf0f75ce6f",
            "patch": "@@ -0,0 +1,109 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const { spawn } = require('child_process');\n+const path = require('path');\n+const testName = path.join(__dirname, 'test-http-max-http-headers.js');\n+const parsers = ['legacy', 'llhttp'];\n+\n+const timeout = common.platformTimeout(100);\n+\n+const tests = [];\n+\n+function test(fn) {\n+  tests.push(fn);\n+}\n+\n+parsers.forEach((parser) => {\n+  test(function(cb) {\n+    console.log('running subtest expecting failure');\n+\n+    // Validate that the test fails if the max header size is too small.\n+    const args = ['--expose-internals',\n+                  `--http-parser=${parser}`,\n+                  '--max-http-header-size=1024',\n+                  testName];\n+    const cp = spawn(process.execPath, args, { stdio: 'inherit' });\n+\n+    cp.on('close', common.mustCall((code, signal) => {\n+      assert.strictEqual(code, 1);\n+      assert.strictEqual(signal, null);\n+      cb();\n+    }));\n+  });\n+\n+  test(function(cb) {\n+    console.log('running subtest expecting success');\n+\n+    const env = Object.assign({}, process.env, {\n+      NODE_DEBUG: 'http'\n+    });\n+\n+    // Validate that the test fails if the max header size is too small.\n+    // Validate that the test now passes if the same limit becomes large enough.\n+    const args = ['--expose-internals',\n+                  `--http-parser=${parser}`,\n+                  '--max-http-header-size=1024',\n+                  testName,\n+                  '1024'];\n+    const cp = spawn(process.execPath, args, {\n+      env,\n+      stdio: 'inherit'\n+    });\n+\n+    cp.on('close', common.mustCall((code, signal) => {\n+      assert.strictEqual(code, 0);\n+      assert.strictEqual(signal, null);\n+      cb();\n+    }));\n+  });\n+\n+  // Next, repeat the same checks using NODE_OPTIONS if it is supported.\n+  if (process.config.variables.node_without_node_options) {\n+    const env = Object.assign({}, process.env, {\n+      NODE_OPTIONS: `--http-parser=${parser} --max-http-header-size=1024`\n+    });\n+\n+    test(function(cb) {\n+      console.log('running subtest expecting failure');\n+\n+      // Validate that the test fails if the max header size is too small.\n+      const args = ['--expose-internals', testName];\n+      const cp = spawn(process.execPath, args, { env, stdio: 'inherit' });\n+\n+      cp.on('close', common.mustCall((code, signal) => {\n+        assert.strictEqual(code, 1);\n+        assert.strictEqual(signal, null);\n+        cb();\n+      }));\n+    });\n+\n+    test(function(cb) {\n+      // Validate that the test now passes if the same limit\n+      // becomes large enough.\n+      const args = ['--expose-internals', testName, '1024'];\n+      const cp = spawn(process.execPath, args, { env, stdio: 'inherit' });\n+\n+      cp.on('close', common.mustCall((code, signal) => {\n+        assert.strictEqual(code, 0);\n+        assert.strictEqual(signal, null);\n+        cb();\n+      }));\n+    });\n+  }\n+});\n+\n+function runTest() {\n+  const fn = tests.shift();\n+\n+  if (!fn) {\n+    return;\n+  }\n+\n+  fn(() => {\n+    setTimeout(runTest, timeout);\n+  });\n+}\n+\n+runTest();"
        }
    ],
    "stats": {
        "total": 212,
        "additions": 184,
        "deletions": 28
    }
}