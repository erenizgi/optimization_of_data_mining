{
    "author": "cjihrig",
    "message": "report: refactor report option validation\n\nPR-URL: https://github.com/nodejs/node/pull/25990\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "46c16b3caec239b7e9eca829f3da3490730ebc43",
    "files": [
        {
            "sha": "3a0afaf76335dd068feee29b25e6791017f2f552",
            "filename": "lib/internal/process/report.js",
            "status": "modified",
            "additions": 50,
            "deletions": 83,
            "changes": 133,
            "blob_url": "https://github.com/nodejs/node/blob/46c16b3caec239b7e9eca829f3da3490730ebc43/lib%2Finternal%2Fprocess%2Freport.js",
            "raw_url": "https://github.com/nodejs/node/raw/46c16b3caec239b7e9eca829f3da3490730ebc43/lib%2Finternal%2Fprocess%2Freport.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Freport.js?ref=46c16b3caec239b7e9eca829f3da3490730ebc43",
            "patch": "@@ -1,17 +1,13 @@\n 'use strict';\n-\n-const { emitExperimentalWarning } = require('internal/util');\n+const {\n+  convertToValidSignal,\n+  emitExperimentalWarning\n+} = require('internal/util');\n const {\n   ERR_INVALID_ARG_TYPE,\n   ERR_SYNTHETIC\n } = require('internal/errors').codes;\n \n-const REPORTEVENTS = 1;\n-const REPORTSIGNAL = 2;\n-const REPORTFILENAME = 3;\n-const REPORTPATH = 4;\n-const REPORTVERBOSE = 5;\n-\n // If report is enabled, extract the binding and\n // wrap the APIs with thin layers, with some error checks.\n // user options can come in from CLI / ENV / API.\n@@ -35,68 +31,56 @@ let config = {\n const report = {\n   setDiagnosticReportOptions(options) {\n     emitExperimentalWarning('report');\n-    // Reuse the null and undefined checks. Save\n-    // space when dealing with large number of arguments.\n-    const list = parseOptions(options);\n+    const previousConfig = config;\n+    const newConfig = {};\n \n-    // Flush the stale entries from report, as\n-    // we are refreshing it, items that the users did not\n-    // touch may be hanging around stale otherwise.\n-    config = {};\n+    if (options === null || typeof options !== 'object')\n+      options = {};\n \n-    // The parseOption method returns an array that include\n-    // the indices at which valid params are present.\n-    list.forEach((i) => {\n-      switch (i) {\n-        case REPORTEVENTS:\n-          if (Array.isArray(options.events))\n-            config.events = options.events;\n-          else\n-            throw new ERR_INVALID_ARG_TYPE('events',\n-                                           'Array',\n-                                           options.events);\n-          break;\n-        case REPORTSIGNAL:\n-          if (typeof options.signal !== 'string') {\n-            throw new ERR_INVALID_ARG_TYPE('signal',\n-                                           'String',\n-                                           options.signal);\n-          }\n-          process.removeListener(config.signal, handleSignal);\n-          if (config.events.includes('signal'))\n-            process.on(options.signal, handleSignal);\n-          config.signal = options.signal;\n-          break;\n-        case REPORTFILENAME:\n-          if (typeof options.filename !== 'string') {\n-            throw new ERR_INVALID_ARG_TYPE('filename',\n-                                           'String',\n-                                           options.filename);\n-          }\n-          config.filename = options.filename;\n-          break;\n-        case REPORTPATH:\n-          if (typeof options.path !== 'string')\n-            throw new ERR_INVALID_ARG_TYPE('path', 'String', options.path);\n-          config.path = options.path;\n-          break;\n-        case REPORTVERBOSE:\n-          if (typeof options.verbose !== 'string' &&\n-              typeof options.verbose !== 'boolean') {\n-            throw new ERR_INVALID_ARG_TYPE('verbose',\n-                                           'Booelan | String' +\n-                                            ' (true|false|yes|no)',\n-                                           options.verbose);\n-          }\n-          config.verbose = options.verbose;\n-          break;\n-      }\n-    });\n-    // Upload this new config to C++ land\n-    nr.syncConfig(config, true);\n-  },\n+    if (Array.isArray(options.events))\n+      newConfig.events = options.events.slice();\n+    else if (options.events === undefined)\n+      newConfig.events = [];\n+    else\n+      throw new ERR_INVALID_ARG_TYPE('events', 'Array', options.events);\n+\n+    if (typeof options.filename === 'string')\n+      newConfig.filename = options.filename;\n+    else if (options.filename === undefined)\n+      newConfig.filename = '';\n+    else\n+      throw new ERR_INVALID_ARG_TYPE('filename', 'string', options.filename);\n+\n+    if (typeof options.path === 'string')\n+      newConfig.path = options.path;\n+    else if (options.path === undefined)\n+      newConfig.path = '';\n+    else\n+      throw new ERR_INVALID_ARG_TYPE('path', 'string', options.path);\n \n+    if (typeof options.verbose === 'boolean')\n+      newConfig.verbose = options.verbose;\n+    else if (options.verbose === undefined)\n+      newConfig.verbose = false;\n+    else\n+      throw new ERR_INVALID_ARG_TYPE('verbose', 'boolean', options.verbose);\n \n+    if (typeof options.signal === 'string')\n+      newConfig.signal = convertToValidSignal(options.signal);\n+    else if (options.signal === undefined)\n+      newConfig.signal = 'SIGUSR2';\n+    else\n+      throw new ERR_INVALID_ARG_TYPE('signal', 'string', options.signal);\n+\n+    if (previousConfig.signal)\n+      process.removeListener(previousConfig.signal, handleSignal);\n+\n+    if (newConfig.events.includes('signal'))\n+      process.on(newConfig.signal, handleSignal);\n+\n+    config = newConfig;\n+    nr.syncConfig(config, true);\n+  },\n   triggerReport(file, err) {\n     emitExperimentalWarning('report');\n     if (err == null) {\n@@ -133,23 +117,6 @@ function handleSignal(signo) {\n   nr.onUserSignal(signo);\n }\n \n-function parseOptions(obj) {\n-  const list = [];\n-  if (obj == null)\n-    return list;\n-  if (obj.events != null)\n-    list.push(REPORTEVENTS);\n-  if (obj.signal != null)\n-    list.push(REPORTSIGNAL);\n-  if (obj.filename != null)\n-    list.push(REPORTFILENAME);\n-  if (obj.path != null)\n-    list.push(REPORTPATH);\n-  if (obj.verbose != null)\n-    list.push(REPORTVERBOSE);\n-  return list;\n-}\n-\n module.exports = {\n   config,\n   handleSignal,"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 50,
        "deletions": 83
    }
}