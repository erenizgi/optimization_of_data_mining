{
    "author": "joyeecheung",
    "message": "src: move per-process global variables into node::per_process\n\nSo that it's easier to tell whether we are manipulating per-process\nglobal states that may need to be treated with care to avoid races.\n\nAlso added comments about these variables and moved some of them\nto a more suitable compilation unit:\n\n- Move `v8_initialized` to `util.h` since it's only used in\n  `util.cc` and `node.cc`\n- Rename `process_mutex` to `tty_mutex` and move it into\n  `node_errors.cc` since that's the only place it's used\n  to guard the tty.\n- Move `per_process_opts_mutex` and `per_process_opts`\n  into `node_options.h` and rename them to\n  `per_process::cli_options[_mutex]`\n- Rename `node_isolate[_mutex]` to `per_process::main_isolate[_mutex]`\n\nPR-URL: https://github.com/nodejs/node/pull/25302\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
    "files": [
        {
            "sha": "58d7cea841bc3061a73840e8a9646ade40904d7b",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -79,7 +79,8 @@ IsolateData::IsolateData(Isolate* isolate,\n   if (platform_ != nullptr)\n     platform_->RegisterIsolate(isolate_, event_loop);\n \n-  options_.reset(new PerIsolateOptions(*per_process_opts->per_isolate));\n+  options_.reset(\n+      new PerIsolateOptions(*(per_process::cli_options->per_isolate)));\n \n   // Create string and private symbol properties as internalized one byte\n   // strings after the platform is properly initialized."
        },
        {
            "sha": "01c9c072da74667b2c9768c79492aba4d3f7f9d5",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 51,
            "deletions": 39,
            "changes": 90,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -139,21 +139,31 @@ using v8::Undefined;\n using v8::V8;\n using v8::Value;\n \n+namespace per_process {\n+// Tells whether --prof is passed.\n+// TODO(joyeecheung): move env->options()->prof_process to\n+// per_process::cli_options.prof_process and use that instead.\n static bool v8_is_profiling = false;\n \n-// Bit flag used to track security reverts (see node_revert.h)\n-unsigned int reverted = 0;\n+// TODO(joyeecheung): these are no longer necessary. Remove them.\n+// See: https://github.com/nodejs/node/pull/25302#discussion_r244924196\n+// Isolate on the main thread\n+static Mutex main_isolate_mutex;\n+static Isolate* main_isolate;\n \n+// node_revert.h\n+// Bit flag used to track security reverts.\n+unsigned int reverted_cve = 0;\n+\n+// util.h\n+// Tells whether the per-process V8::Initialize() is called and\n+// if it is safe to call v8::Isolate::GetCurrent().\n bool v8_initialized = false;\n \n+// node_internals.h\n // process-relative uptime base, initialized at start-up\n double prog_start_time;\n-\n-Mutex per_process_opts_mutex;\n-std::shared_ptr<PerProcessOptions> per_process_opts {\n-    new PerProcessOptions() };\n-static Mutex node_isolate_mutex;\n-static Isolate* node_isolate;\n+}  // namespace per_process\n \n // Ensures that __metadata trace events are only emitted\n // when tracing is enabled.\n@@ -269,14 +279,15 @@ static struct {\n #endif  // HAVE_INSPECTOR\n \n   void StartTracingAgent() {\n-    if (per_process_opts->trace_event_categories.empty()) {\n+    if (per_process::cli_options->trace_event_categories.empty()) {\n       tracing_file_writer_ = tracing_agent_->DefaultHandle();\n     } else {\n       tracing_file_writer_ = tracing_agent_->AddClient(\n-          ParseCommaSeparatedSet(per_process_opts->trace_event_categories),\n+          ParseCommaSeparatedSet(\n+              per_process::cli_options->trace_event_categories),\n           std::unique_ptr<tracing::AsyncTraceWriter>(\n               new tracing::NodeTraceWriter(\n-                  per_process_opts->trace_event_file_pattern)),\n+                  per_process::cli_options->trace_event_file_pattern)),\n           tracing::Agent::kUseDefaultCategories);\n     }\n   }\n@@ -500,7 +511,7 @@ const char* signo_string(int signo) {\n }\n \n void* ArrayBufferAllocator::Allocate(size_t size) {\n-  if (zero_fill_field_ || per_process_opts->zero_fill_all_buffers)\n+  if (zero_fill_field_ || per_process::cli_options->zero_fill_all_buffers)\n     return UncheckedCalloc(size);\n   else\n     return UncheckedMalloc(size);\n@@ -1276,12 +1287,12 @@ void ProcessArgv(std::vector<std::string>* args,\n   {\n     // TODO(addaleax): The mutex here should ideally be held during the\n     // entire function, but that doesn't play well with the exit() calls below.\n-    Mutex::ScopedLock lock(per_process_opts_mutex);\n+    Mutex::ScopedLock lock(per_process::cli_options_mutex);\n     options_parser::PerProcessOptionsParser::instance.Parse(\n         args,\n         exec_args,\n         &v8_args,\n-        per_process_opts.get(),\n+        per_process::cli_options.get(),\n         is_env ? kAllowedInEnvironment : kDisallowedInEnvironment,\n         &errors);\n   }\n@@ -1293,20 +1304,20 @@ void ProcessArgv(std::vector<std::string>* args,\n     exit(9);\n   }\n \n-  if (per_process_opts->print_version) {\n+  if (per_process::cli_options->print_version) {\n     printf(\"%s\\n\", NODE_VERSION);\n     exit(0);\n   }\n \n-  if (per_process_opts->print_v8_help) {\n+  if (per_process::cli_options->print_v8_help) {\n     V8::SetFlagsFromString(\"--help\", 6);\n     exit(0);\n   }\n \n-  for (const std::string& cve : per_process_opts->security_reverts)\n+  for (const std::string& cve : per_process::cli_options->security_reverts)\n     Revert(cve.c_str());\n \n-  auto env_opts = per_process_opts->per_isolate->per_env;\n+  auto env_opts = per_process::cli_options->per_isolate->per_env;\n   if (std::find(v8_args.begin(), v8_args.end(),\n                 \"--abort-on-uncaught-exception\") != v8_args.end() ||\n       std::find(v8_args.begin(), v8_args.end(),\n@@ -1319,14 +1330,14 @@ void ProcessArgv(std::vector<std::string>* args,\n   // behavior but it could also interfere with the user's intentions in ways\n   // we fail to anticipate.  Dillema.\n   if (std::find(v8_args.begin(), v8_args.end(), \"--prof\") != v8_args.end()) {\n-    v8_is_profiling = true;\n+    per_process::v8_is_profiling = true;\n   }\n \n #ifdef __POSIX__\n   // Block SIGPROF signals when sleeping in epoll_wait/kevent/etc.  Avoids the\n   // performance penalty of frequent EINTR wakeups when the profiler is running.\n   // Only do this for v8.log profiling, as it breaks v8::CpuProfiler users.\n-  if (v8_is_profiling) {\n+  if (per_process::v8_is_profiling) {\n     uv_loop_configure(uv_default_loop(), UV_LOOP_BLOCK_SIGNAL, SIGPROF);\n   }\n #endif\n@@ -1355,7 +1366,7 @@ void ProcessArgv(std::vector<std::string>* args,\n void Init(std::vector<std::string>* argv,\n           std::vector<std::string>* exec_argv) {\n   // Initialize prog_start_time to get relative uptime.\n-  prog_start_time = static_cast<double>(uv_now(uv_default_loop()));\n+  per_process::prog_start_time = static_cast<double>(uv_now(uv_default_loop()));\n \n   // Register built-in modules\n   binding::RegisterBuiltinModules();\n@@ -1371,7 +1382,7 @@ void Init(std::vector<std::string>* argv,\n #endif\n \n   std::shared_ptr<EnvironmentOptions> default_env_options =\n-      per_process_opts->per_isolate->per_env;\n+      per_process::cli_options->per_isolate->per_env;\n   {\n     std::string text;\n     default_env_options->pending_deprecation =\n@@ -1400,7 +1411,7 @@ void Init(std::vector<std::string>* argv,\n   }\n \n #if HAVE_OPENSSL\n-  std::string* openssl_config = &per_process_opts->openssl_config;\n+  std::string* openssl_config = &per_process::cli_options->openssl_config;\n   if (openssl_config->empty()) {\n     credentials::SafeGetenv(\"OPENSSL_CONF\", openssl_config);\n   }\n@@ -1434,16 +1445,17 @@ void Init(std::vector<std::string>* argv,\n   ProcessArgv(argv, exec_argv, false);\n \n   // Set the process.title immediately after processing argv if --title is set.\n-  if (!per_process_opts->title.empty())\n-    uv_set_process_title(per_process_opts->title.c_str());\n+  if (!per_process::cli_options->title.empty())\n+    uv_set_process_title(per_process::cli_options->title.c_str());\n \n #if defined(NODE_HAVE_I18N_SUPPORT)\n   // If the parameter isn't given, use the env variable.\n-  if (per_process_opts->icu_data_dir.empty())\n-    credentials::SafeGetenv(\"NODE_ICU_DATA\", &per_process_opts->icu_data_dir);\n+  if (per_process::cli_options->icu_data_dir.empty())\n+    credentials::SafeGetenv(\"NODE_ICU_DATA\",\n+                            &per_process::cli_options->icu_data_dir);\n   // Initialize ICU.\n   // If icu_data_dir is empty here, it will load the 'minimal' data.\n-  if (!i18n::InitializeICUDirectory(per_process_opts->icu_data_dir)) {\n+  if (!i18n::InitializeICUDirectory(per_process::cli_options->icu_data_dir)) {\n     fprintf(stderr,\n             \"%s: could not initialize ICU \"\n             \"(check NODE_ICU_DATA or --icu-data-dir parameters)\\n\",\n@@ -1604,7 +1616,7 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   std::vector<std::string> args(argv, argv + argc);\n   std::vector<std::string> exec_args(exec_argv, exec_argv + exec_argc);\n   Environment* env = new Environment(isolate_data, context);\n-  env->Start(args, exec_args, v8_is_profiling);\n+  env->Start(args, exec_args, per_process::v8_is_profiling);\n   return env;\n }\n \n@@ -1678,7 +1690,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n   Environment env(isolate_data, context);\n-  env.Start(args, exec_args, v8_is_profiling);\n+  env.Start(args, exec_args, per_process::v8_is_profiling);\n \n   const char* path = args.size() > 1 ? args[1].c_str() : nullptr;\n   StartInspector(&env, path);\n@@ -1785,9 +1797,9 @@ inline int Start(uv_loop_t* event_loop,\n     return 12;  // Signal internal error.\n \n   {\n-    Mutex::ScopedLock scoped_lock(node_isolate_mutex);\n-    CHECK_NULL(node_isolate);\n-    node_isolate = isolate;\n+    Mutex::ScopedLock scoped_lock(per_process::main_isolate_mutex);\n+    CHECK_NULL(per_process::main_isolate);\n+    per_process::main_isolate = isolate;\n   }\n \n   int exit_code;\n@@ -1812,9 +1824,9 @@ inline int Start(uv_loop_t* event_loop,\n   }\n \n   {\n-    Mutex::ScopedLock scoped_lock(node_isolate_mutex);\n-    CHECK_EQ(node_isolate, isolate);\n-    node_isolate = nullptr;\n+    Mutex::ScopedLock scoped_lock(per_process::main_isolate_mutex);\n+    CHECK_EQ(per_process::main_isolate, isolate);\n+    per_process::main_isolate = nullptr;\n   }\n \n   isolate->Dispose();\n@@ -1862,14 +1874,14 @@ int Start(int argc, char** argv) {\n   V8::SetEntropySource(crypto::EntropySource);\n #endif  // HAVE_OPENSSL\n \n-  InitializeV8Platform(per_process_opts->v8_thread_pool_size);\n+  InitializeV8Platform(per_process::cli_options->v8_thread_pool_size);\n   V8::Initialize();\n   performance::performance_v8_start = PERFORMANCE_NOW();\n-  v8_initialized = true;\n+  per_process::v8_initialized = true;\n   const int exit_code =\n       Start(uv_default_loop(), args, exec_args);\n   v8_platform.StopTracingAgent();\n-  v8_initialized = false;\n+  per_process::v8_initialized = false;\n   V8::Dispose();\n \n   // uv_run cannot be called from the time before the beforeExit callback"
        },
        {
            "sha": "ae2d1a06a78ebb174606f63d7b7a799400f2ef20",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -59,9 +59,9 @@ namespace node {\n namespace {\n \n inline void* BufferMalloc(size_t length) {\n-  return per_process_opts->zero_fill_all_buffers ?\n-      node::UncheckedCalloc(length) :\n-      node::UncheckedMalloc(length);\n+  return per_process::cli_options->zero_fill_all_buffers ?\n+             node::UncheckedCalloc(length) :\n+             node::UncheckedMalloc(length);\n }\n \n }  // namespace"
        },
        {
            "sha": "4fd4b1a53b98cabcb06114804267ec3dc926ef2d",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -41,7 +41,7 @@ static void Initialize(Local<Object> target,\n #ifdef NODE_FIPS_MODE\n   READONLY_TRUE_PROPERTY(target, \"fipsMode\");\n   // TODO(addaleax): Use options parser variable instead.\n-  if (per_process_opts->force_fips_crypto)\n+  if (per_process::cli_options->force_fips_crypto)\n     READONLY_TRUE_PROPERTY(target, \"fipsForced\");\n #endif\n "
        },
        {
            "sha": "debcf0e10045a11bea48c8fc4f7229f3081278b4",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -1234,9 +1234,10 @@ void DefineCryptoConstants(Local<Object> target) {\n   NODE_DEFINE_STRING_CONSTANT(target,\n                               \"defaultCoreCipherList\",\n                               DEFAULT_CIPHER_LIST_CORE);\n-  NODE_DEFINE_STRING_CONSTANT(target,\n-                              \"defaultCipherList\",\n-                              per_process_opts->tls_cipher_list.c_str());\n+  NODE_DEFINE_STRING_CONSTANT(\n+      target,\n+      \"defaultCipherList\",\n+      per_process::cli_options->tls_cipher_list.c_str());\n \n   NODE_DEFINE_CONSTANT(target, TLS1_VERSION);\n   NODE_DEFINE_CONSTANT(target, TLS1_1_VERSION);"
        },
        {
            "sha": "1fea2659f79bb9bf9fd16db7e6b30ba49fbfcdb7",
            "filename": "src/node_credentials.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_credentials.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_credentials.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_credentials.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -38,7 +38,7 @@ bool SafeGetenv(const char* key, std::string* text) {\n #endif\n \n   {\n-    Mutex::ScopedLock lock(environ_mutex);\n+    Mutex::ScopedLock lock(per_process::env_var_mutex);\n     if (const char* value = getenv(key)) {\n       *text = value;\n       return true;"
        },
        {
            "sha": "c92ace2497942b83188753d43bbeb229e9a4d50d",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -787,7 +787,7 @@ static X509_STORE* NewRootCertStore() {\n   if (*system_cert_path != '\\0') {\n     X509_STORE_load_locations(store, system_cert_path, nullptr);\n   }\n-  if (per_process_opts->ssl_openssl_cert_store) {\n+  if (per_process::cli_options->ssl_openssl_cert_store) {\n     X509_STORE_set_default_paths(store);\n   } else {\n     for (X509* cert : root_certs_vector) {\n@@ -6183,16 +6183,15 @@ void InitCryptoOnce() {\n   OPENSSL_no_config();\n \n   // --openssl-config=...\n-  if (!per_process_opts->openssl_config.empty()) {\n+  if (!per_process::cli_options->openssl_config.empty()) {\n     OPENSSL_load_builtin_modules();\n #ifndef OPENSSL_NO_ENGINE\n     ENGINE_load_builtin_engines();\n #endif\n     ERR_clear_error();\n-    CONF_modules_load_file(\n-        per_process_opts->openssl_config.c_str(),\n-        nullptr,\n-        CONF_MFLAGS_DEFAULT_SECTION);\n+    CONF_modules_load_file(per_process::cli_options->openssl_config.c_str(),\n+                           nullptr,\n+                           CONF_MFLAGS_DEFAULT_SECTION);\n     int err = ERR_get_error();\n     if (0 != err) {\n       fprintf(stderr,\n@@ -6208,8 +6207,8 @@ void InitCryptoOnce() {\n #ifdef NODE_FIPS_MODE\n   /* Override FIPS settings in cnf file, if needed. */\n   unsigned long err = 0;  // NOLINT(runtime/int)\n-  if (per_process_opts->enable_fips_crypto ||\n-      per_process_opts->force_fips_crypto) {\n+  if (per_process::cli_options->enable_fips_crypto ||\n+      per_process::cli_options->force_fips_crypto) {\n     if (0 == FIPS_mode() && !FIPS_mode_set(1)) {\n       err = ERR_get_error();\n     }\n@@ -6272,7 +6271,7 @@ void GetFipsCrypto(const FunctionCallbackInfo<Value>& args) {\n }\n \n void SetFipsCrypto(const FunctionCallbackInfo<Value>& args) {\n-  CHECK(!per_process_opts->force_fips_crypto);\n+  CHECK(!per_process::cli_options->force_fips_crypto);\n   Environment* env = Environment::GetCurrent(args);\n   const bool enabled = FIPS_mode();\n   bool enable = args[0]->BooleanValue(env->isolate());"
        },
        {
            "sha": "8cbfa22973c65dd6ce35ca9e73de690044269a29",
            "filename": "src/node_env_var.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_env_var.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_env_var.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_env_var.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -25,13 +25,17 @@ using v8::PropertyCallbackInfo;\n using v8::String;\n using v8::Value;\n \n+namespace per_process {\n+Mutex env_var_mutex;\n+}  // namespace per_process\n+\n static void EnvGetter(Local<Name> property,\n                       const PropertyCallbackInfo<Value>& info) {\n   Isolate* isolate = info.GetIsolate();\n   if (property->IsSymbol()) {\n     return info.GetReturnValue().SetUndefined();\n   }\n-  Mutex::ScopedLock lock(environ_mutex);\n+  Mutex::ScopedLock lock(per_process::env_var_mutex);\n #ifdef __POSIX__\n   node::Utf8Value key(isolate, property);\n   const char* val = getenv(*key);\n@@ -80,7 +84,7 @@ static void EnvSetter(Local<Name> property,\n       return;\n   }\n \n-  Mutex::ScopedLock lock(environ_mutex);\n+  Mutex::ScopedLock lock(per_process::env_var_mutex);\n #ifdef __POSIX__\n   node::Utf8Value key(info.GetIsolate(), property);\n   node::Utf8Value val(info.GetIsolate(), value);\n@@ -100,7 +104,7 @@ static void EnvSetter(Local<Name> property,\n \n static void EnvQuery(Local<Name> property,\n                      const PropertyCallbackInfo<Integer>& info) {\n-  Mutex::ScopedLock lock(environ_mutex);\n+  Mutex::ScopedLock lock(per_process::env_var_mutex);\n   int32_t rc = -1;  // Not found unless proven otherwise.\n   if (property->IsString()) {\n #ifdef __POSIX__\n@@ -127,7 +131,7 @@ static void EnvQuery(Local<Name> property,\n \n static void EnvDeleter(Local<Name> property,\n                        const PropertyCallbackInfo<Boolean>& info) {\n-  Mutex::ScopedLock lock(environ_mutex);\n+  Mutex::ScopedLock lock(per_process::env_var_mutex);\n   if (property->IsString()) {\n #ifdef __POSIX__\n     node::Utf8Value key(info.GetIsolate(), property);\n@@ -148,7 +152,7 @@ static void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n   Environment* env = Environment::GetCurrent(info);\n   Isolate* isolate = env->isolate();\n \n-  Mutex::ScopedLock lock(environ_mutex);\n+  Mutex::ScopedLock lock(per_process::env_var_mutex);\n   Local<Array> envarr;\n   int env_size = 0;\n #ifdef __POSIX__"
        },
        {
            "sha": "9ffd8d88f1e4732fa1ed958b88cd9b425e031e12",
            "filename": "src/node_errors.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_errors.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_errors.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -35,6 +35,10 @@ bool IsExceptionDecorated(Environment* env, Local<Value> er) {\n   return false;\n }\n \n+namespace per_process {\n+static Mutex tty_mutex;\n+}  // namespace per_process\n+\n void AppendExceptionLine(Environment* env,\n                          Local<Value> er,\n                          Local<Message> message,\n@@ -137,7 +141,7 @@ void AppendExceptionLine(Environment* env,\n   // by the caller.\n   if (!can_set_arrow || (mode == FATAL_ERROR && !err_obj->IsNativeError())) {\n     if (env->printed_error()) return;\n-    Mutex::ScopedLock lock(process_mutex);\n+    Mutex::ScopedLock lock(per_process::tty_mutex);\n     env->set_printed_error(true);\n \n     uv_tty_reset_mode();"
        },
        {
            "sha": "48d669a7593e6ca7d6a349dacb7ddd338fd42a87",
            "filename": "src/node_http_parser_impl.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_http_parser_impl.h",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_http_parser_impl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser_impl.h?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -830,7 +830,7 @@ class Parser : public AsyncWrap, public StreamListener {\n   int TrackHeader(size_t len) {\n #ifdef NODE_EXPERIMENTAL_HTTP\n     header_nread_ += len;\n-    if (header_nread_ >= per_process_opts->max_http_header_size) {\n+    if (header_nread_ >= per_process::cli_options->max_http_header_size) {\n       llhttp_set_error_reason(&parser_, \"HPE_HEADER_OVERFLOW:Header overflow\");\n       return HPE_USER;\n     }\n@@ -915,7 +915,8 @@ const parser_settings_t Parser::settings = {\n \n #ifndef NODE_EXPERIMENTAL_HTTP\n void InitMaxHttpHeaderSizeOnce() {\n-  const uint32_t max_http_header_size = per_process_opts->max_http_header_size;\n+  const uint32_t max_http_header_size =\n+      per_process::cli_options->max_http_header_size;\n   http_parser_set_max_header_size(max_http_header_size);\n }\n #endif  /* NODE_EXPERIMENTAL_HTTP */"
        },
        {
            "sha": "f9ef31eea5aa853f824969475dee0ce96aefccef",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -83,14 +83,10 @@ namespace native_module {\n class NativeModuleLoader;\n }\n \n-extern Mutex process_mutex;\n-extern Mutex environ_mutex;\n-\n-// Tells whether it is safe to call v8::Isolate::GetCurrent().\n-extern bool v8_initialized;\n-\n-extern Mutex per_process_opts_mutex;\n-extern std::shared_ptr<PerProcessOptions> per_process_opts;\n+namespace per_process {\n+extern Mutex env_var_mutex;\n+extern double prog_start_time;\n+}  // namespace per_process\n \n // Forward declaration\n class Environment;\n@@ -699,8 +695,6 @@ static inline const char* errno_string(int errorno) {\n \n // Functions defined in node.cc that are exposed via the bootstrapper object\n \n-extern double prog_start_time;\n-\n void RawDebug(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n void DebugPortGetter(v8::Local<v8::Name> property,"
        },
        {
            "sha": "aa82d57f0a4168f99b3bffe83fc6979b9287fc17",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -17,6 +17,11 @@ using v8::Value;\n \n namespace node {\n \n+namespace per_process {\n+Mutex cli_options_mutex;\n+std::shared_ptr<PerProcessOptions> cli_options{new PerProcessOptions()};\n+}  // namespace per_process\n+\n void PerProcessOptions::CheckOptions(std::vector<std::string>* errors) {\n #if HAVE_OPENSSL\n   if (use_openssl_ca && use_bundled_ca) {\n@@ -397,21 +402,21 @@ HostPort SplitHostPort(const std::string& arg,\n // Return a map containing all the options and their metadata as well\n // as the aliases\n void GetOptions(const FunctionCallbackInfo<Value>& args) {\n-  Mutex::ScopedLock lock(per_process_opts_mutex);\n+  Mutex::ScopedLock lock(per_process::cli_options_mutex);\n   Environment* env = Environment::GetCurrent(args);\n   Isolate* isolate = env->isolate();\n   Local<Context> context = env->context();\n \n   // Temporarily act as if the current Environment's/IsolateData's options were\n   // the default options, i.e. like they are the ones we'd access for global\n   // options parsing, so that all options are available from the main parser.\n-  auto original_per_isolate = per_process_opts->per_isolate;\n-  per_process_opts->per_isolate = env->isolate_data()->options();\n-  auto original_per_env = per_process_opts->per_isolate->per_env;\n-  per_process_opts->per_isolate->per_env = env->options();\n+  auto original_per_isolate = per_process::cli_options->per_isolate;\n+  per_process::cli_options->per_isolate = env->isolate_data()->options();\n+  auto original_per_env = per_process::cli_options->per_isolate->per_env;\n+  per_process::cli_options->per_isolate->per_env = env->options();\n   OnScopeLeave on_scope_leave([&]() {\n-    per_process_opts->per_isolate->per_env = original_per_env;\n-    per_process_opts->per_isolate = original_per_isolate;\n+    per_process::cli_options->per_isolate->per_env = original_per_env;\n+    per_process::cli_options->per_isolate = original_per_isolate;\n   });\n \n   const auto& parser = PerProcessOptionsParser::instance;\n@@ -421,7 +426,7 @@ void GetOptions(const FunctionCallbackInfo<Value>& args) {\n     Local<Value> value;\n     const auto& option_info = item.second;\n     auto field = option_info.field;\n-    PerProcessOptions* opts = per_process_opts.get();\n+    PerProcessOptions* opts = per_process::cli_options.get();\n     switch (option_info.type) {\n       case kNoOp:\n       case kV8Option:"
        },
        {
            "sha": "5668df421aa0a7b1074fe790d3b1bee7d4cc25d2",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -8,6 +8,7 @@\n #include <unordered_map>\n #include <vector>\n #include \"node_constants.h\"\n+#include \"node_mutex.h\"\n #include \"util.h\"\n \n namespace node {\n@@ -422,6 +423,13 @@ class PerProcessOptionsParser : public OptionsParser<PerProcessOptions> {\n };\n \n }  // namespace options_parser\n+\n+namespace per_process {\n+\n+extern Mutex cli_options_mutex;\n+extern std::shared_ptr<PerProcessOptions> cli_options;\n+\n+}  // namespace per_process\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "69f08a219b67e6bfde1243aec31c224dbc169bbc",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -50,9 +50,6 @@ using v8::Uint32;\n using v8::Uint32Array;\n using v8::Value;\n \n-Mutex process_mutex;\n-Mutex environ_mutex;\n-\n // Microseconds in a second, as a float, used in CPUUsage() below\n #define MICROS_PER_SEC 1e6\n // used in Hrtime() below\n@@ -244,7 +241,7 @@ static void Uptime(const FunctionCallbackInfo<Value>& args) {\n   double uptime;\n \n   uv_update_time(env->event_loop());\n-  uptime = uv_now(env->event_loop()) - prog_start_time;\n+  uptime = uv_now(env->event_loop()) - per_process::prog_start_time;\n \n   args.GetReturnValue().Set(uptime / 1000);\n }"
        },
        {
            "sha": "4c0ebcd9fd66b08e668ac1bbf1e0e6eab453838f",
            "filename": "src/node_revert.h",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_revert.h",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Fnode_revert.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_revert.h?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -24,7 +24,9 @@ enum reversion {\n #undef V\n };\n \n-extern unsigned int reverted;\n+namespace per_process {\n+extern unsigned int reverted_cve;\n+}\n \n inline const char* RevertMessage(const reversion cve) {\n #define V(code, label, msg) case SECURITY_REVERT_##code: return label \": \" msg;\n@@ -37,7 +39,7 @@ inline const char* RevertMessage(const reversion cve) {\n }\n \n inline void Revert(const reversion cve) {\n-  reverted |= 1 << cve;\n+  per_process::reverted_cve |= 1 << cve;\n   printf(\"SECURITY WARNING: Reverting %s\\n\", RevertMessage(cve));\n }\n \n@@ -51,7 +53,7 @@ inline void Revert(const char* cve) {\n }\n \n inline bool IsReverted(const reversion cve) {\n-  return reverted & (1 << cve);\n+  return per_process::reverted_cve & (1 << cve);\n }\n \n inline bool IsReverted(const char* cve) {"
        },
        {
            "sha": "e88b39f47b8ddc1f2e4f40c4ef9465422bdfc087",
            "filename": "src/util.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Futil.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Futil.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.cc?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -101,7 +101,7 @@ BufferValue::BufferValue(Isolate* isolate, Local<Value> value) {\n }\n \n void LowMemoryNotification() {\n-  if (v8_initialized) {\n+  if (per_process::v8_initialized) {\n     auto isolate = Isolate::GetCurrent();\n     if (isolate != nullptr) {\n       isolate->LowMemoryNotification();"
        },
        {
            "sha": "1205f2d06b142d398be18847acf156131e2a25cc",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=9db9e7e541c1ff9a30b7f1b61c6d3a7b6d30fab3",
            "patch": "@@ -74,6 +74,12 @@ inline char* UncheckedCalloc(size_t n);\n template <typename T>\n inline T MultiplyWithOverflowCheck(T a, T b);\n \n+namespace per_process {\n+// Tells whether the per-process V8::Initialize() is called and\n+// if it is safe to call v8::Isolate::GetCurrent().\n+extern bool v8_initialized;\n+}  // namespace per_process\n+\n // Used by the allocation functions when allocation fails.\n // Thin wrapper around v8::Isolate::LowMemoryNotification() that checks\n // whether V8 is initialized."
        }
    ],
    "stats": {
        "total": 216,
        "additions": 125,
        "deletions": 91
    }
}