{
    "author": "jasnell",
    "message": "workers,trace_events: set thread name for workers\n\nSet the thread name for workers in trace events. Also,\nuse uint64_t for thread_id_ because there's really no\nreason for those to be doubles\n\nPR-URL: https://github.com/nodejs/node/pull/21246\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "99e6ecbb17fa9ffef8e77a043e44367810403dbd",
    "files": [
        {
            "sha": "bbb80c6f7ae91603e17325a1c3de3408a9070289",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=99e6ecbb17fa9ffef8e77a043e44367810403dbd",
            "patch": "@@ -598,11 +598,11 @@ inline bool Environment::is_main_thread() const {\n   return thread_id_ == 0;\n }\n \n-inline double Environment::thread_id() const {\n+inline uint64_t Environment::thread_id() const {\n   return thread_id_;\n }\n \n-inline void Environment::set_thread_id(double id) {\n+inline void Environment::set_thread_id(uint64_t id) {\n   thread_id_ = id;\n }\n "
        },
        {
            "sha": "786f0846f4ae1a8ddd1648f8aea1442ddd504e41",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=99e6ecbb17fa9ffef8e77a043e44367810403dbd",
            "patch": "@@ -726,8 +726,8 @@ class Environment {\n   bool is_stopping_worker() const;\n \n   inline bool is_main_thread() const;\n-  inline double thread_id() const;\n-  inline void set_thread_id(double id);\n+  inline uint64_t thread_id() const;\n+  inline void set_thread_id(uint64_t id);\n   inline worker::Worker* worker_context() const;\n   inline void set_worker_context(worker::Worker* context);\n   inline void add_sub_worker_context(worker::Worker* context);\n@@ -881,7 +881,7 @@ class Environment {\n   std::unordered_map<std::string, uint64_t> performance_marks_;\n \n   bool can_call_into_js_ = true;\n-  double thread_id_ = 0;\n+  uint64_t thread_id_ = 0;\n   std::unordered_set<worker::Worker*> sub_worker_contexts_;\n \n "
        },
        {
            "sha": "c628e6295c46af80df98995e39cab34ece69d685",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=99e6ecbb17fa9ffef8e77a043e44367810403dbd",
            "patch": "@@ -9,6 +9,8 @@\n #include \"async_wrap.h\"\n #include \"async_wrap-inl.h\"\n \n+#include <string>\n+\n using v8::ArrayBuffer;\n using v8::Context;\n using v8::Function;\n@@ -30,7 +32,7 @@ namespace worker {\n \n namespace {\n \n-double next_thread_id = 1;\n+uint64_t next_thread_id = 1;\n Mutex next_thread_id_mutex;\n \n }  // anonymous namespace\n@@ -44,7 +46,8 @@ Worker::Worker(Environment* env, Local<Object> wrap)\n   }\n   wrap->Set(env->context(),\n             env->thread_id_string(),\n-            Number::New(env->isolate(), thread_id_)).FromJust();\n+            Number::New(env->isolate(),\n+                        static_cast<double>(thread_id_))).FromJust();\n \n   // Set up everything that needs to be set up in the parent environment.\n   parent_port_ = MessagePort::New(env, env->context());\n@@ -112,6 +115,11 @@ bool Worker::is_stopped() const {\n }\n \n void Worker::Run() {\n+  std::string name = \"WorkerThread \";\n+  name += std::to_string(thread_id_);\n+  TRACE_EVENT_METADATA1(\n+      \"__metadata\", \"thread_name\", \"name\",\n+      TRACE_STR_COPY(name.c_str()));\n   MultiIsolatePlatform* platform = isolate_data_->platform();\n   CHECK_NE(platform, nullptr);\n \n@@ -418,7 +426,8 @@ void InitWorker(Local<Object> target,\n   auto thread_id_string = FIXED_ONE_BYTE_STRING(env->isolate(), \"threadId\");\n   target->Set(env->context(),\n               thread_id_string,\n-              Number::New(env->isolate(), env->thread_id())).FromJust();\n+              Number::New(env->isolate(),\n+                          static_cast<double>(env->thread_id()))).FromJust();\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "d802b5cfefdf779871331db68cec9d975ae702ec",
            "filename": "src/node_worker.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fnode_worker.h",
            "raw_url": "https://github.com/nodejs/node/raw/99e6ecbb17fa9ffef8e77a043e44367810403dbd/src%2Fnode_worker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.h?ref=99e6ecbb17fa9ffef8e77a043e44367810403dbd",
            "patch": "@@ -62,7 +62,7 @@ class Worker : public AsyncWrap {\n \n   bool thread_joined_ = true;\n   int exit_code_ = 0;\n-  double thread_id_ = -1;\n+  uint64_t thread_id_ = -1;\n \n   std::unique_ptr<MessagePortData> child_port_data_;\n "
        },
        {
            "sha": "8d21d6b7ab9e0be18c47e669909185da2193b5f5",
            "filename": "test/parallel/test-trace-events-worker-metadata.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/99e6ecbb17fa9ffef8e77a043e44367810403dbd/test%2Fparallel%2Ftest-trace-events-worker-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/99e6ecbb17fa9ffef8e77a043e44367810403dbd/test%2Fparallel%2Ftest-trace-events-worker-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-worker-metadata.js?ref=99e6ecbb17fa9ffef8e77a043e44367810403dbd",
            "patch": "@@ -0,0 +1,33 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const fs = require('fs');\n+const { isMainThread } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const CODE = 'const { Worker } = require(\\'worker_threads\\'); ' +\n+               `new Worker('${__filename.replace(/\\\\/g, '/')}')`;\n+  const FILE_NAME = 'node_trace.1.log';\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  process.chdir(tmpdir.path);\n+\n+  const proc = cp.spawn(process.execPath,\n+                        [ '--experimental-worker',\n+                          '--trace-event-categories', 'node',\n+                          '-e', CODE ]);\n+  proc.once('exit', common.mustCall(() => {\n+    assert(common.fileExists(FILE_NAME));\n+    fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n+      const traces = JSON.parse(data.toString()).traceEvents;\n+      assert(traces.length > 0);\n+      assert(traces.some((trace) =>\n+        trace.cat === '__metadata' && trace.name === 'thread_name' &&\n+          trace.args.name === 'WorkerThread 1'));\n+    }));\n+  }));\n+} else {\n+  // Do nothing here.\n+}"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 51,
        "deletions": 9
    }
}