{
    "author": "lpinca",
    "message": "test: refactor test-http-agent-timeout-option\n\nThere is no need to establish a TCP connection. It is sufficient to\ntest that the listener that forwards the `'timeout'` event from the\nsocket to the `ClientRequest` instance is added to the socket.\n\nPR-URL: https://github.com/nodejs/node/pull/25886\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "b8d9d4ac68be5b95747a77b7f8bbdd62db379931",
    "files": [
        {
            "sha": "d0c05827f23d561010a26ce619d9a972a4547b76",
            "filename": "test/parallel/test-http-agent-timeout-option.js",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/b8d9d4ac68be5b95747a77b7f8bbdd62db379931/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "raw_url": "https://github.com/nodejs/node/raw/b8d9d4ac68be5b95747a77b7f8bbdd62db379931/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-timeout-option.js?ref=b8d9d4ac68be5b95747a77b7f8bbdd62db379931",
            "patch": "@@ -1,29 +1,23 @@\n 'use strict';\n \n-const { expectsError, mustCall } = require('../common');\n-const { Agent, get, createServer } = require('http');\n+const { mustCall } = require('../common');\n+const { strictEqual } = require('assert');\n+const { Agent, get } = require('http');\n \n-// Test that the `'timeout'` event is emitted on the `ClientRequest` instance\n-// when the socket timeout set via the `timeout` option of the `Agent` expires.\n+// Test that the listener that forwards the `'timeout'` event from the socket to\n+// the `ClientRequest` instance is added to the socket when the `timeout` option\n+// of the `Agent` is set.\n \n-const server = createServer(mustCall(() => {\n-  // Never respond.\n-}));\n+const request = get({\n+  agent: new Agent({ timeout: 50 }),\n+  lookup: () => {}\n+});\n \n-server.listen(() => {\n-  const request = get({\n-    agent: new Agent({ timeout: 500 }),\n-    port: server.address().port\n-  });\n+request.on('socket', mustCall((socket) => {\n+  strictEqual(socket.timeout, 50);\n \n-  request.on('error', expectsError({\n-    type: Error,\n-    code: 'ECONNRESET',\n-    message: 'socket hang up'\n-  }));\n+  const listeners = socket.listeners('timeout');\n \n-  request.on('timeout', mustCall(() => {\n-    request.abort();\n-    server.close();\n-  }));\n-});\n+  strictEqual(listeners.length, 1);\n+  strictEqual(listeners[0], request.timeoutCb);\n+}));"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 16,
        "deletions": 22
    }
}