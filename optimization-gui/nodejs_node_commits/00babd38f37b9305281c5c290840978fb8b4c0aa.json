{
    "author": "joyeecheung",
    "message": "process: move worker bootstrap code into worker_thread_only.js\n\nMove worker bootstrap code into worker_thread_only.js from\ninternal/worker.js since they are only run once during bootstrap.\n\nPR-URL: https://github.com/nodejs/node/pull/25199\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "00babd38f37b9305281c5c290840978fb8b4c0aa",
    "files": [
        {
            "sha": "d26159ab451c9784e83d8fd8a6a5d963e85de08c",
            "filename": "lib/internal/process/worker_thread_only.js",
            "status": "modified",
            "additions": 89,
            "deletions": 8,
            "changes": 97,
            "blob_url": "https://github.com/nodejs/node/blob/00babd38f37b9305281c5c290840978fb8b4c0aa/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/00babd38f37b9305281c5c290840978fb8b4c0aa/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fworker_thread_only.js?ref=00babd38f37b9305281c5c290840978fb8b4c0aa",
            "patch": "@@ -7,18 +7,21 @@ const {\n   threadId\n } = internalBinding('worker');\n \n-const debug = require('util').debuglog('worker');\n-\n const {\n+  messageTypes,\n+  kStdioWantsMoreDataCallback,\n   kWaitingStreams,\n   ReadableWorkerStdio,\n   WritableWorkerStdio\n } = require('internal/worker/io');\n \n-const {\n-  createMessageHandler,\n-  createWorkerFatalExeception\n-} = require('internal/worker');\n+let debuglog;\n+function debug(...args) {\n+  if (!debuglog) {\n+    debuglog = require('util').debuglog('worker');\n+  }\n+  return debuglog(...args);\n+}\n \n const workerStdio = {};\n \n@@ -36,12 +39,90 @@ function initializeWorkerStdio() {\n   };\n }\n \n+function createMessageHandler(port) {\n+  const publicWorker = require('worker_threads');\n+\n+  return function(message) {\n+    if (message.type === messageTypes.LOAD_SCRIPT) {\n+      const { filename, doEval, workerData, publicPort, hasStdin } = message;\n+      publicWorker.parentPort = publicPort;\n+      publicWorker.workerData = workerData;\n+\n+      if (!hasStdin)\n+        workerStdio.stdin.push(null);\n+\n+      debug(`[${threadId}] starts worker script ${filename} ` +\n+            `(eval = ${eval}) at cwd = ${process.cwd()}`);\n+      port.unref();\n+      port.postMessage({ type: messageTypes.UP_AND_RUNNING });\n+      if (doEval) {\n+        const { evalScript } = require('internal/process/execution');\n+        evalScript('[worker eval]', filename);\n+      } else {\n+        process.argv[1] = filename; // script filename\n+        require('module').runMain();\n+      }\n+      return;\n+    } else if (message.type === messageTypes.STDIO_PAYLOAD) {\n+      const { stream, chunk, encoding } = message;\n+      workerStdio[stream].push(chunk, encoding);\n+      return;\n+    } else if (message.type === messageTypes.STDIO_WANTS_MORE_DATA) {\n+      const { stream } = message;\n+      workerStdio[stream][kStdioWantsMoreDataCallback]();\n+      return;\n+    }\n+\n+    require('assert').fail(`Unknown worker message type ${message.type}`);\n+  };\n+}\n+\n+// XXX(joyeecheung): this has to be returned as an anonymous function\n+// wrapped in a closure, see the comment of the original\n+// process._fatalException in lib/internal/process/execution.js\n+function createWorkerFatalExeception(port) {\n+  const {\n+    fatalException: originalFatalException\n+  } = require('internal/process/execution');\n+\n+  return (error) => {\n+    debug(`[${threadId}] gets fatal exception`);\n+    let caught = false;\n+    try {\n+      caught = originalFatalException.call(this, error);\n+    } catch (e) {\n+      error = e;\n+    }\n+    debug(`[${threadId}] fatal exception caught = ${caught}`);\n+\n+    if (!caught) {\n+      let serialized;\n+      try {\n+        const { serializeError } = require('internal/error-serdes');\n+        serialized = serializeError(error);\n+      } catch {}\n+      debug(`[${threadId}] fatal exception serialized = ${!!serialized}`);\n+      if (serialized)\n+        port.postMessage({\n+          type: messageTypes.ERROR_MESSAGE,\n+          error: serialized\n+        });\n+      else\n+        port.postMessage({ type: messageTypes.COULD_NOT_SERIALIZE_ERROR });\n+\n+      const { clearAsyncIdStack } = require('internal/async_hooks');\n+      clearAsyncIdStack();\n+\n+      process.exit();\n+    }\n+  };\n+}\n+\n function setup() {\n   debug(`[${threadId}] is setting up worker child environment`);\n \n   const port = getEnvMessagePort();\n-  const publicWorker = require('worker_threads');\n-  port.on('message', createMessageHandler(publicWorker, port, workerStdio));\n+  port.on('message', createMessageHandler(port));\n   port.start();\n \n   return {"
        },
        {
            "sha": "2e1568a73822b90c134e60badf89356c7d6cd282",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 1,
            "deletions": 75,
            "changes": 76,
            "blob_url": "https://github.com/nodejs/node/blob/00babd38f37b9305281c5c290840978fb8b4c0aa/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/00babd38f37b9305281c5c290840978fb8b4c0aa/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=00babd38f37b9305281c5c290840978fb8b4c0aa",
            "patch": "@@ -10,7 +10,6 @@ const {\n   ERR_WORKER_UNSUPPORTED_EXTENSION,\n } = require('internal/errors').codes;\n const { validateString } = require('internal/validators');\n-const { clearAsyncIdStack } = require('internal/async_hooks');\n \n const {\n   drainMessagePort,\n@@ -24,7 +23,7 @@ const {\n   ReadableWorkerStdio,\n   WritableWorkerStdio,\n } = require('internal/worker/io');\n-const { serializeError, deserializeError } = require('internal/error-serdes');\n+const { deserializeError } = require('internal/error-serdes');\n const { pathToFileURL } = require('url');\n \n const {\n@@ -219,77 +218,6 @@ class Worker extends EventEmitter {\n   }\n }\n \n-function createMessageHandler(publicWorker, port, workerStdio) {\n-  return function(message) {\n-    if (message.type === messageTypes.LOAD_SCRIPT) {\n-      const { filename, doEval, workerData, publicPort, hasStdin } = message;\n-      publicWorker.parentPort = publicPort;\n-      publicWorker.workerData = workerData;\n-\n-      if (!hasStdin)\n-        workerStdio.stdin.push(null);\n-\n-      debug(`[${threadId}] starts worker script ${filename} ` +\n-            `(eval = ${eval}) at cwd = ${process.cwd()}`);\n-      port.unref();\n-      port.postMessage({ type: messageTypes.UP_AND_RUNNING });\n-      if (doEval) {\n-        const { evalScript } = require('internal/process/execution');\n-        evalScript('[worker eval]', filename);\n-      } else {\n-        process.argv[1] = filename; // script filename\n-        require('module').runMain();\n-      }\n-      return;\n-    } else if (message.type === messageTypes.STDIO_PAYLOAD) {\n-      const { stream, chunk, encoding } = message;\n-      workerStdio[stream].push(chunk, encoding);\n-      return;\n-    } else if (message.type === messageTypes.STDIO_WANTS_MORE_DATA) {\n-      const { stream } = message;\n-      workerStdio[stream][kStdioWantsMoreDataCallback]();\n-      return;\n-    }\n-\n-    assert.fail(`Unknown worker message type ${message.type}`);\n-  };\n-}\n-\n-function createWorkerFatalExeception(port) {\n-  const {\n-    fatalException: originalFatalException\n-  } = require('internal/process/execution');\n-\n-  return function(error) {\n-    debug(`[${threadId}] gets fatal exception`);\n-    let caught = false;\n-    try {\n-      caught = originalFatalException.call(this, error);\n-    } catch (e) {\n-      error = e;\n-    }\n-    debug(`[${threadId}] fatal exception caught = ${caught}`);\n-\n-    if (!caught) {\n-      let serialized;\n-      try {\n-        serialized = serializeError(error);\n-      } catch {}\n-      debug(`[${threadId}] fatal exception serialized = ${!!serialized}`);\n-      if (serialized)\n-        port.postMessage({\n-          type: messageTypes.ERROR_MESSAGE,\n-          error: serialized\n-        });\n-      else\n-        port.postMessage({ type: messageTypes.COULD_NOT_SERIALIZE_ERROR });\n-      clearAsyncIdStack();\n-\n-      process.exit();\n-    }\n-  };\n-}\n-\n function pipeWithoutWarning(source, dest) {\n   const sourceMaxListeners = source._maxListeners;\n   const destMaxListeners = dest._maxListeners;\n@@ -303,8 +231,6 @@ function pipeWithoutWarning(source, dest) {\n }\n \n module.exports = {\n-  createMessageHandler,\n-  createWorkerFatalExeception,\n   threadId,\n   Worker,\n   isMainThread"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 90,
        "deletions": 83
    }
}