{
    "author": "bnoordhuis",
    "message": "src: fix GetCpuProfiler() deprecation warning\n\nReplace `v8::Isolate::GetCpuProfiler()` with `v8::CpuProfiler::New()`\nand cache the instance; creating and disposing an instance every loop\ntick is too expensive.\n\nPR-URL: https://github.com/nodejs/node/pull/18534\nFixes: https://github.com/nodejs/node/issues/18039\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "f02b74dfdb364e1ccfa59ba7ee22790fe65548c3",
    "files": [
        {
            "sha": "1b3323eb26c2e7a1028ea528dbe2efc147834551",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f02b74dfdb364e1ccfa59ba7ee22790fe65548c3/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f02b74dfdb364e1ccfa59ba7ee22790fe65548c3/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=f02b74dfdb364e1ccfa59ba7ee22790fe65548c3",
            "patch": "@@ -1,6 +1,5 @@\n #include \"node_internals.h\"\n #include \"async_wrap.h\"\n-#include \"v8-profiler.h\"\n #include \"node_buffer.h\"\n #include \"node_platform.h\"\n \n@@ -67,6 +66,15 @@ IsolateData::IsolateData(Isolate* isolate,\n IsolateData::~IsolateData() {\n   if (platform_ != nullptr)\n     platform_->UnregisterIsolate(this);\n+  if (cpu_profiler_ != nullptr)\n+    cpu_profiler_->Dispose();\n+}\n+\n+v8::CpuProfiler* IsolateData::GetCpuProfiler() {\n+  if (cpu_profiler_ != nullptr) return cpu_profiler_;\n+  cpu_profiler_ = v8::CpuProfiler::New(isolate());\n+  CHECK_NE(cpu_profiler_, nullptr);\n+  return cpu_profiler_;\n }\n \n void Environment::Start(int argc,\n@@ -152,12 +160,12 @@ void Environment::CleanupHandles() {\n void Environment::StartProfilerIdleNotifier() {\n   uv_prepare_start(&idle_prepare_handle_, [](uv_prepare_t* handle) {\n     Environment* env = ContainerOf(&Environment::idle_prepare_handle_, handle);\n-    env->isolate()->GetCpuProfiler()->SetIdle(true);\n+    env->isolate_data()->GetCpuProfiler()->SetIdle(true);\n   });\n \n   uv_check_start(&idle_check_handle_, [](uv_check_t* handle) {\n     Environment* env = ContainerOf(&Environment::idle_check_handle_, handle);\n-    env->isolate()->GetCpuProfiler()->SetIdle(false);\n+    env->isolate_data()->GetCpuProfiler()->SetIdle(false);\n   });\n }\n "
        },
        {
            "sha": "4701b58e8a99c6e265e13cc1db5f7f8edd18b7c5",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f02b74dfdb364e1ccfa59ba7ee22790fe65548c3/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/f02b74dfdb364e1ccfa59ba7ee22790fe65548c3/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=f02b74dfdb364e1ccfa59ba7ee22790fe65548c3",
            "patch": "@@ -33,6 +33,7 @@\n #include \"req_wrap.h\"\n #include \"util.h\"\n #include \"uv.h\"\n+#include \"v8-profiler.h\"\n #include \"v8.h\"\n #include \"node.h\"\n #include \"node_http2_state.h\"\n@@ -340,6 +341,8 @@ class IsolateData {\n   std::unordered_map<nghttp2_rcbuf*, v8::Eternal<v8::String>> http2_static_strs;\n   inline v8::Isolate* isolate() const;\n \n+  v8::CpuProfiler* GetCpuProfiler();\n+\n  private:\n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n@@ -355,6 +358,7 @@ class IsolateData {\n   uv_loop_t* const event_loop_;\n   uint32_t* const zero_fill_field_;\n   MultiIsolatePlatform* platform_;\n+  v8::CpuProfiler* cpu_profiler_ = nullptr;\n \n   DISALLOW_COPY_AND_ASSIGN(IsolateData);\n };"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 15,
        "deletions": 3
    }
}