{
    "author": "lundibundi",
    "message": "worker: exit after uncaught exception\n\nPreviously even after uncaught exception the worker would continue to\nexecute until there is no more work to do.\n\nPR-URL: https://github.com/nodejs/node/pull/21739\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "7c2925e60956019fa4ca7bbcafcb98ea79022710",
    "files": [
        {
            "sha": "26c16f86e3e8fc60319cabaf4cc1c5141d3c3815",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/7c2925e60956019fa4ca7bbcafcb98ea79022710/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c2925e60956019fa4ca7bbcafcb98ea79022710/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=7c2925e60956019fa4ca7bbcafcb98ea79022710",
            "patch": "@@ -467,6 +467,8 @@ function setupChild(evalScript) {\n       else\n         port.postMessage({ type: messageTypes.COULD_NOT_SERIALIZE_ERROR });\n       clearAsyncIdStack();\n+\n+      process.exit();\n     }\n   }\n }"
        },
        {
            "sha": "862b1a66d619c3b736038f8623efcd1fc745110b",
            "filename": "test/parallel/test-worker-uncaught-exception-async.js",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/7c2925e60956019fa4ca7bbcafcb98ea79022710/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c2925e60956019fa4ca7bbcafcb98ea79022710/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-uncaught-exception-async.js?ref=7c2925e60956019fa4ca7bbcafcb98ea79022710",
            "patch": "@@ -10,13 +10,27 @@ if (!process.env.HAS_STARTED_WORKER) {\n   const w = new Worker(__filename);\n   w.on('message', common.mustNotCall());\n   w.on('error', common.mustCall((err) => {\n+    console.log(err.message);\n     assert(/^Error: foo$/.test(err));\n   }));\n   w.on('exit', common.mustCall((code) => {\n     // uncaughtException is code 1\n     assert.strictEqual(code, 1);\n   }));\n } else {\n+  // cannot use common.mustCall as it cannot catch this\n+  let called = false;\n+  process.on('exit', (code) => {\n+    if (!called) {\n+      called = true;\n+    } else {\n+      assert.fail('Exit callback called twice in worker');\n+    }\n+  });\n+\n+  setTimeout(() => assert.fail('Timeout executed after uncaughtException'),\n+             2000);\n+\n   setImmediate(() => {\n     throw new Error('foo');\n   });"
        },
        {
            "sha": "95c142b6c70d64e9b15a5fcdc17f591fda0fbcd6",
            "filename": "test/parallel/test-worker-uncaught-exception.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/7c2925e60956019fa4ca7bbcafcb98ea79022710/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c2925e60956019fa4ca7bbcafcb98ea79022710/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-uncaught-exception.js?ref=7c2925e60956019fa4ca7bbcafcb98ea79022710",
            "patch": "@@ -27,5 +27,9 @@ if (!process.env.HAS_STARTED_WORKER) {\n       assert.fail('Exit callback called twice in worker');\n     }\n   });\n+\n+  setTimeout(() => assert.fail('Timeout executed after uncaughtException'),\n+             2000);\n+\n   throw new Error('foo');\n }"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 20,
        "deletions": 0
    }
}