{
    "author": "addaleax",
    "message": "src: pass along errors from vm data wrapper creation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "2c18d973a58fa782e0b2028221ef886596ee2050",
    "files": [
        {
            "sha": "b7c7f38eb6f695265686eef297180011f7486391",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 18,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/2c18d973a58fa782e0b2028221ef886596ee2050/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2c18d973a58fa782e0b2028221ef886596ee2050/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=2c18d973a58fa782e0b2028221ef886596ee2050",
            "patch": "@@ -104,12 +104,12 @@ Local<Name> Uint32ToName(Local<Context> context, uint32_t index) {\n ContextifyContext::ContextifyContext(\n     Environment* env,\n     Local<Object> sandbox_obj, const ContextOptions& options) : env_(env) {\n-  Local<Context> v8_context = CreateV8Context(env, sandbox_obj, options);\n-  context_.Reset(env->isolate(), v8_context);\n+  MaybeLocal<Context> v8_context = CreateV8Context(env, sandbox_obj, options);\n \n-  // Allocation failure or maximum call stack size reached\n-  if (context_.IsEmpty())\n-    return;\n+  // Allocation failure, maximum call stack size reached, termination, etc.\n+  if (v8_context.IsEmpty()) return;\n+\n+  context_.Reset(env->isolate(), v8_context.ToLocalChecked());\n   context_.SetWeak(this, WeakCallback, WeakCallbackType::kParameter);\n }\n \n@@ -119,20 +119,19 @@ ContextifyContext::ContextifyContext(\n // pass the main JavaScript context object we're embedded in, then the\n // NamedPropertyHandler will store a reference to it forever and keep it\n // from getting gc'd.\n-Local<Value> ContextifyContext::CreateDataWrapper(Environment* env) {\n-  EscapableHandleScope scope(env->isolate());\n-  Local<Object> wrapper =\n-      env->script_data_constructor_function()\n-          ->NewInstance(env->context()).FromMaybe(Local<Object>());\n-  if (wrapper.IsEmpty())\n-    return scope.Escape(Local<Value>::New(env->isolate(), Local<Value>()));\n+MaybeLocal<Object> ContextifyContext::CreateDataWrapper(Environment* env) {\n+  Local<Object> wrapper;\n+  if (!env->script_data_constructor_function()\n+           ->NewInstance(env->context())\n+           .ToLocal(&wrapper)) {\n+    return MaybeLocal<Object>();\n+  }\n \n   wrapper->SetAlignedPointerInInternalField(0, this);\n-  return scope.Escape(wrapper);\n+  return wrapper;\n }\n \n-\n-Local<Context> ContextifyContext::CreateV8Context(\n+MaybeLocal<Context> ContextifyContext::CreateV8Context(\n     Environment* env,\n     Local<Object> sandbox_obj,\n     const ContextOptions& options) {\n@@ -145,13 +144,17 @@ Local<Context> ContextifyContext::CreateV8Context(\n   Local<ObjectTemplate> object_template =\n       function_template->InstanceTemplate();\n \n+  Local<Object> data_wrapper;\n+  if (!CreateDataWrapper(env).ToLocal(&data_wrapper))\n+    return MaybeLocal<Context>();\n+\n   NamedPropertyHandlerConfiguration config(PropertyGetterCallback,\n                                            PropertySetterCallback,\n                                            PropertyDescriptorCallback,\n                                            PropertyDeleterCallback,\n                                            PropertyEnumeratorCallback,\n                                            PropertyDefinerCallback,\n-                                           CreateDataWrapper(env));\n+                                           data_wrapper);\n \n   IndexedPropertyHandlerConfiguration indexed_config(\n       IndexedPropertyGetterCallback,\n@@ -160,7 +163,7 @@ Local<Context> ContextifyContext::CreateV8Context(\n       IndexedPropertyDeleterCallback,\n       PropertyEnumeratorCallback,\n       IndexedPropertyDefinerCallback,\n-      CreateDataWrapper(env));\n+      data_wrapper);\n \n   object_template->SetHandler(config);\n   object_template->SetHandler(indexed_config);\n@@ -169,7 +172,7 @@ Local<Context> ContextifyContext::CreateV8Context(\n \n   if (ctx.IsEmpty()) {\n     env->ThrowError(\"Could not instantiate context\");\n-    return Local<Context>();\n+    return MaybeLocal<Context>();\n   }\n \n   ctx->SetSecurityToken(env->context()->GetSecurityToken());"
        },
        {
            "sha": "cb3ca83553a61c3a62e340bfa9a37d4d224eec6f",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/2c18d973a58fa782e0b2028221ef886596ee2050/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/2c18d973a58fa782e0b2028221ef886596ee2050/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=2c18d973a58fa782e0b2028221ef886596ee2050",
            "patch": "@@ -23,9 +23,10 @@ class ContextifyContext {\n                     v8::Local<v8::Object> sandbox_obj,\n                     const ContextOptions& options);\n \n-  v8::Local<v8::Value> CreateDataWrapper(Environment* env);\n-  v8::Local<v8::Context> CreateV8Context(Environment* env,\n-      v8::Local<v8::Object> sandbox_obj, const ContextOptions& options);\n+  v8::MaybeLocal<v8::Object> CreateDataWrapper(Environment* env);\n+  v8::MaybeLocal<v8::Context> CreateV8Context(Environment* env,\n+                                              v8::Local<v8::Object> sandbox_obj,\n+                                              const ContextOptions& options);\n   static void Init(Environment* env, v8::Local<v8::Object> target);\n \n   static ContextifyContext* ContextFromContextifiedSandbox("
        }
    ],
    "stats": {
        "total": 46,
        "additions": 25,
        "deletions": 21
    }
}