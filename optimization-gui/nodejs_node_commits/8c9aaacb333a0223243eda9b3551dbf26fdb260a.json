{
    "author": "sam-github",
    "message": "test: assert on client and server side seperately\n\nThis gets better coverage of the codes, and is more explicit. It also\nworks around ordering differences in the errors produced by openssl.\nThe approach was tested with 1.1.0 and 1.1.1, as well as TLSv1.2 vs\nTLSv1.3. OpenSSL 1.1.0 is relevant when node is built against a shared\nopenssl.\n\nPR-URL: https://github.com/nodejs/node/pull/25381\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Shigeki Ohtsu <ohtsu@ohtsu.org>",
    "sha": "8c9aaacb333a0223243eda9b3551dbf26fdb260a",
    "files": [
        {
            "sha": "9a8b73c40e496edaf1bbb89a8ce46dc382c9e2d6",
            "filename": "test/parallel/test-tls-min-max-version.js",
            "status": "modified",
            "additions": 74,
            "deletions": 28,
            "changes": 102,
            "blob_url": "https://github.com/nodejs/node/blob/8c9aaacb333a0223243eda9b3551dbf26fdb260a/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "raw_url": "https://github.com/nodejs/node/raw/8c9aaacb333a0223243eda9b3551dbf26fdb260a/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-min-max-version.js?ref=8c9aaacb333a0223243eda9b3551dbf26fdb260a",
            "patch": "@@ -8,9 +8,11 @@ const {\n   assert, connect, keys, tls\n } = require(fixtures.path('tls-connect'));\n const DEFAULT_MIN_VERSION = tls.DEFAULT_MIN_VERSION;\n+const DEFAULT_MAX_VERSION = tls.DEFAULT_MAX_VERSION;\n \n-function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n-  assert(expect);\n+\n+function test(cmin, cmax, cprot, smin, smax, sprot, proto, cerr, serr) {\n+  assert(proto || cerr || serr, 'test missing any expectations');\n   connect({\n     client: {\n       checkServerIdentity: (servername, cert) => { },\n@@ -27,8 +29,25 @@ function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n       secureProtocol: sprot,\n     },\n   }, common.mustCall((err, pair, cleanup) => {\n-    if (err) {\n-      assert.strictEqual(err.code, expect, err + '.code !== ' + expect);\n+    function u(_) { return _ === undefined ? 'U' : _; }\n+    console.log('test:', u(cmin), u(cmax), u(cprot), u(smin), u(smax), u(sprot),\n+                'expect', u(proto), u(cerr), u(serr));\n+    if (!proto) {\n+      console.log('client', pair.client.err ? pair.client.err.code : undefined);\n+      console.log('server', pair.server.err ? pair.server.err.code : undefined);\n+      if (cerr) {\n+        assert(pair.client.err);\n+        // Accept these codes as aliases, the one reported depends on the\n+        // OpenSSL version.\n+        if (cerr === 'ERR_SSL_UNSUPPORTED_PROTOCOL' &&\n+            pair.client.err.code === 'ERR_SSL_VERSION_TOO_LOW')\n+          cerr = 'ERR_SSL_VERSION_TOO_LOW';\n+        assert.strictEqual(pair.client.err.code, cerr);\n+      }\n+      if (serr) {\n+        assert(pair.server.err);\n+        assert.strictEqual(pair.server.err.code, serr);\n+      }\n       return cleanup();\n     }\n \n@@ -37,8 +56,8 @@ function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n     assert.ifError(pair.client.err);\n     assert(pair.server.conn);\n     assert(pair.client.conn);\n-    assert.strictEqual(pair.client.conn.getProtocol(), expect);\n-    assert.strictEqual(pair.server.conn.getProtocol(), expect);\n+    assert.strictEqual(pair.client.conn.getProtocol(), proto);\n+    assert.strictEqual(pair.server.conn.getProtocol(), proto);\n     return cleanup();\n   }));\n }\n@@ -49,22 +68,28 @@ const U = undefined;\n test(U, U, U, U, U, U, 'TLSv1.2');\n \n // Insecure or invalid protocols cannot be enabled.\n-test(U, U, U, U, U, 'SSLv2_method', 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n-test(U, U, U, U, U, 'SSLv3_method', 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n-test(U, U, 'SSLv2_method', U, U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n-test(U, U, 'SSLv3_method', U, U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n-test(U, U, 'hokey-pokey', U, U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n-test(U, U, U, U, U, 'hokey-pokey', 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, U, U, U, 'SSLv2_method',\n+     U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, U, U, U, 'SSLv3_method',\n+     U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, 'SSLv2_method', U, U, U,\n+     U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, 'SSLv3_method', U, U, U,\n+     U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, 'hokey-pokey', U, U, U,\n+     U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n+test(U, U, U, U, U, 'hokey-pokey',\n+     U, U, 'ERR_TLS_INVALID_PROTOCOL_METHOD');\n \n // Cannot use secureProtocol and min/max versions simultaneously.\n test(U, U, U, U, 'TLSv1.2', 'TLS1_2_method',\n-     'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n+     U, U, 'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n test(U, U, U, 'TLSv1.2', U, 'TLS1_2_method',\n-     'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n+     U, U, 'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n test(U, 'TLSv1.2', 'TLS1_2_method', U, U, U,\n-     'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n+     U, 'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n test('TLSv1.2', U, 'TLS1_2_method', U, U, U,\n-     'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n+     U, 'ERR_TLS_PROTOCOL_VERSION_CONFLICT');\n \n // TLS_method means \"any supported protocol\".\n test(U, U, 'TLSv1_2_method', U, U, 'TLS_method', 'TLSv1.2');\n@@ -79,18 +104,23 @@ test(U, U, 'TLS_method', U, U, 'TLSv1_method', 'TLSv1');\n test(U, U, 'TLSv1_2_method', U, U, 'SSLv23_method', 'TLSv1.2');\n \n if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n-  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n-  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n+  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method',\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method',\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n   test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method',\n-       'ERR_SSL_VERSION_TOO_LOW');\n-  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n+       U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method',\n+       U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n }\n \n if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n   test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'TLSv1.1');\n-  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method',\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n   test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n-  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method',\n+       U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n }\n \n if (DEFAULT_MIN_VERSION === 'TLSv1') {\n@@ -108,18 +138,34 @@ test(U, U, 'TLSv1_method', U, U, 'TLSv1_method', 'TLSv1');\n \n // The default default.\n if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n-  test(U, U, 'TLSv1_1_method', U, U, U, 'ECONNRESET');\n-  test(U, U, 'TLSv1_method', U, U, U, 'ECONNRESET');\n-  test(U, U, U, U, U, 'TLSv1_1_method', 'ERR_SSL_VERSION_TOO_LOW');\n-  test(U, U, U, U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n+  test(U, U, 'TLSv1_1_method', U, U, U,\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n+  test(U, U, 'TLSv1_method', U, U, U,\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n+\n+  if (DEFAULT_MAX_VERSION === 'TLSv1.2') {\n+    test(U, U, U, U, U, 'TLSv1_1_method',\n+         U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n+    test(U, U, U, U, U, 'TLSv1_method',\n+         U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n+  } else {\n+    assert(false, 'unreachable');\n+  }\n }\n \n // The default with --tls-v1.1.\n if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n   test(U, U, 'TLSv1_1_method', U, U, U, 'TLSv1.1');\n-  test(U, U, 'TLSv1_method', U, U, U, 'ECONNRESET');\n+  test(U, U, 'TLSv1_method', U, U, U,\n+       U, 'ECONNRESET', 'ERR_SSL_UNSUPPORTED_PROTOCOL');\n   test(U, U, U, U, U, 'TLSv1_1_method', 'TLSv1.1');\n-  test(U, U, U, U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n+\n+  if (DEFAULT_MAX_VERSION === 'TLSv1.2') {\n+    test(U, U, U, U, U, 'TLSv1_method',\n+         U, 'ERR_SSL_UNSUPPORTED_PROTOCOL', 'ERR_SSL_WRONG_VERSION_NUMBER');\n+  } else {\n+    assert(false, 'unreachable');\n+  }\n }\n \n // The default with --tls-v1.0."
        }
    ],
    "stats": {
        "total": 102,
        "additions": 74,
        "deletions": 28
    }
}