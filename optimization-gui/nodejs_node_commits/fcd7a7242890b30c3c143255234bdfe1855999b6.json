{
    "author": "addaleax",
    "message": "async_hooks: add HandleScopes to C++ embedder/addon API\n\nAdd `HandleScope`s to the public C++ API for embedders/addons,\nsince these methods create V8 handles that should not leak into\nthe outer scopes.\n\nIn particular, for some of the methods it was not clear from\nthe function signatures that these functions previously\nneeded to be invoked with a `HandleScope`.\n\nPR-URL: https://github.com/nodejs/node/pull/24285\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "fcd7a7242890b30c3c143255234bdfe1855999b6",
    "files": [
        {
            "sha": "a104d9a6557edff6634562e2dcec722dce318abd",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/fcd7a7242890b30c3c143255234bdfe1855999b6/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fcd7a7242890b30c3c143255234bdfe1855999b6/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=fcd7a7242890b30c3c143255234bdfe1855999b6",
            "patch": "@@ -694,13 +694,17 @@ MaybeLocal<Value> AsyncWrap::MakeCallback(const Local<Function> cb,\n \n \n async_id AsyncHooksGetExecutionAsyncId(Isolate* isolate) {\n+  // Environment::GetCurrent() allocates a Local<> handle.\n+  v8::HandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n   if (env == nullptr) return -1;\n   return env->execution_async_id();\n }\n \n \n async_id AsyncHooksGetTriggerAsyncId(Isolate* isolate) {\n+  // Environment::GetCurrent() allocates a Local<> handle.\n+  v8::HandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n   if (env == nullptr) return -1;\n   return env->trigger_async_id();\n@@ -711,6 +715,7 @@ async_context EmitAsyncInit(Isolate* isolate,\n                             Local<Object> resource,\n                             const char* name,\n                             async_id trigger_async_id) {\n+  v8::HandleScope handle_scope(isolate);\n   Local<String> type =\n       String::NewFromUtf8(isolate, name, v8::NewStringType::kInternalized)\n           .ToLocalChecked();\n@@ -721,6 +726,7 @@ async_context EmitAsyncInit(Isolate* isolate,\n                             Local<Object> resource,\n                             v8::Local<v8::String> name,\n                             async_id trigger_async_id) {\n+  v8::HandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n   CHECK_NOT_NULL(env);\n \n@@ -741,6 +747,8 @@ async_context EmitAsyncInit(Isolate* isolate,\n }\n \n void EmitAsyncDestroy(Isolate* isolate, async_context asyncContext) {\n+  // Environment::GetCurrent() allocates a Local<> handle.\n+  v8::HandleScope handle_scope(isolate);\n   AsyncWrap::EmitDestroy(\n       Environment::GetCurrent(isolate), asyncContext.async_id);\n }"
        },
        {
            "sha": "ff899628c4d56d1209f04669df5c450fc91dbf99",
            "filename": "test/addons/async-hello-world/binding.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/fcd7a7242890b30c3c143255234bdfe1855999b6/test%2Faddons%2Fasync-hello-world%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fcd7a7242890b30c3c143255234bdfe1855999b6/test%2Faddons%2Fasync-hello-world%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fasync-hello-world%2Fbinding.cc?ref=fcd7a7242890b30c3c143255234bdfe1855999b6",
            "patch": "@@ -57,6 +57,8 @@ void AfterAsync(uv_work_t* r) {\n                    global, 2, argv).ToLocalChecked();\n   }\n \n+  // None of the following operations should allocate handles into this scope.\n+  v8::SealHandleScope seal_handle_scope(isolate);\n   // cleanup\n   node::EmitAsyncDestroy(isolate, req->context);\n   req->callback.Reset();"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 10,
        "deletions": 0
    }
}