{
    "author": "addaleax",
    "message": "src: split `LoadEnvironment()` at `startExecution()`\n\nThis makes it easier to cater to embedders which wish to skip\nthe `startExecution()` part.\n\nPR-URL: https://github.com/nodejs/node/pull/25320\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "f6a1d88c5d1c813c8d55933436b4b834a29f449f",
    "files": [
        {
            "sha": "e229d2a2c6b2461665ae7ab52f7294ccaea0fe02",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -303,7 +303,7 @@ function startup() {\n   } = perf.constants;\n   perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n \n-  startExecution();\n+  return startExecution;\n }\n \n // There are various modes that Node can run in. The most common two\n@@ -729,4 +729,4 @@ function checkScriptSyntax(source, filename) {\n   new vm.Script(source, { displayErrors: true, filename });\n }\n \n-startup();\n+return startup();"
        },
        {
            "sha": "0555e79c81205151d8e1c3f94c0151af354964a0",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -637,6 +637,14 @@ inline void Environment::set_can_call_into_js(bool can_call_into_js) {\n   can_call_into_js_ = can_call_into_js;\n }\n \n+inline bool Environment::has_run_bootstrapping_code() const {\n+  return has_run_bootstrapping_code_;\n+}\n+\n+inline void Environment::set_has_run_bootstrapping_code(bool value) {\n+  has_run_bootstrapping_code_ = value;\n+}\n+\n inline bool Environment::is_main_thread() const {\n   return thread_id_ == 0;\n }"
        },
        {
            "sha": "636ff5c8692d2c343e5b9a8119776f700fa02579",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -371,6 +371,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(script_data_constructor_function, v8::Function)                            \\\n   V(secure_context_constructor_template, v8::FunctionTemplate)                 \\\n   V(shutdown_wrap_template, v8::ObjectTemplate)                                \\\n+  V(start_execution_function, v8::Function)                                    \\\n   V(tcp_constructor_template, v8::FunctionTemplate)                            \\\n   V(tick_callback_function, v8::Function)                                      \\\n   V(timers_callback_function, v8::Function)                                    \\\n@@ -755,6 +756,9 @@ class Environment {\n   inline bool can_call_into_js() const;\n   inline void set_can_call_into_js(bool can_call_into_js);\n \n+  inline bool has_run_bootstrapping_code() const;\n+  inline void set_has_run_bootstrapping_code(bool has_run_bootstrapping_code);\n+\n   inline bool is_main_thread() const;\n   inline uint64_t thread_id() const;\n   inline void set_thread_id(uint64_t id);\n@@ -980,6 +984,7 @@ class Environment {\n   std::unique_ptr<performance::performance_state> performance_state_;\n   std::unordered_map<std::string, uint64_t> performance_marks_;\n \n+  bool has_run_bootstrapping_code_ = false;\n   bool can_call_into_js_ = true;\n   uint64_t thread_id_ = 0;\n   std::unordered_set<worker::Worker*> sub_worker_contexts_;"
        },
        {
            "sha": "cec333bd82c01c795f661d3989e3257ecf054654",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -1085,6 +1085,14 @@ static MaybeLocal<Value> ExecuteBootstrapper(\n }\n \n void LoadEnvironment(Environment* env) {\n+  RunBootstrapping(env);\n+  StartExecution(env);\n+}\n+\n+void RunBootstrapping(Environment* env) {\n+  CHECK(!env->has_run_bootstrapping_code());\n+  env->set_has_run_bootstrapping_code(true);\n+\n   HandleScope handle_scope(env->isolate());\n   Isolate* isolate = env->isolate();\n   Local<Context> context = env->context();\n@@ -1146,11 +1154,29 @@ void LoadEnvironment(Environment* env) {\n       loader_exports.ToLocalChecked(),\n       Boolean::New(isolate, env->is_main_thread())};\n \n-  if (ExecuteBootstrapper(\n+  Local<Value> start_execution;\n+  if (!ExecuteBootstrapper(\n           env, \"internal/bootstrap/node\", &node_params, &node_args)\n-          .IsEmpty()) {\n+          .ToLocal(&start_execution)) {\n     return;\n   }\n+\n+  if (start_execution->IsFunction())\n+    env->set_start_execution_function(start_execution.As<Function>());\n+}\n+\n+void StartExecution(Environment* env) {\n+  HandleScope handle_scope(env->isolate());\n+  // We have to use Local<>::New because of the optimized way in which we access\n+  // the object in the env->...() getters, which does not play well with\n+  // resetting the handle while we're accessing the object through the Local<>.\n+  Local<Function> start_execution =\n+      Local<Function>::New(env->isolate(), env->start_execution_function());\n+  env->set_start_execution_function(Local<Function>());\n+\n+  if (start_execution.IsEmpty()) return;\n+  USE(start_execution->Call(\n+      env->context(), Undefined(env->isolate()), 0, nullptr));\n }\n \n static void StartInspector(Environment* env, const char* path) {"
        },
        {
            "sha": "acc97633ce9e786bf1d0d03e1ddbbd744de3bd53",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -724,6 +724,9 @@ bool SafeGetenv(const char* key, std::string* text);\n \n void DefineZlibConstants(v8::Local<v8::Object> target);\n \n+void RunBootstrapping(Environment* env);\n+void StartExecution(Environment* env);\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "cf96ee42c98cb760ddac5a975187d5fb420a8ab7",
            "filename": "test/message/assert_throws_stack.out",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fassert_throws_stack.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fassert_throws_stack.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fassert_throws_stack.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -18,4 +18,3 @@ AssertionError [ERR_ASSERTION]: Expected values to be strictly deep-equal:\n     at *\n     at *\n     at *\n-    at *"
        },
        {
            "sha": "6e9b42167dde18d8689b7649a33bb8d346718ffc",
            "filename": "test/message/error_exit.out",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Ferror_exit.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Ferror_exit.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Ferror_exit.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -16,4 +16,3 @@ AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)"
        },
        {
            "sha": "f41af4617d9dc06bba18ea958796b54f436e11d8",
            "filename": "test/message/eval_messages.out",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Feval_messages.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Feval_messages.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Feval_messages.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -11,8 +11,6 @@ SyntaxError: Strict mode code may not include a with statement\n     at evalScript (internal/process/execution.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*\n 42\n 42\n [eval]:1\n@@ -28,8 +26,6 @@ Error: hello\n     at evalScript (internal/process/execution.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*\n \n [eval]:1\n throw new Error(\"hello\")\n@@ -44,8 +40,6 @@ Error: hello\n     at evalScript (internal/process/execution.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*\n 100\n [eval]:1\n var x = 100; y = x;\n@@ -60,8 +54,6 @@ ReferenceError: y is not defined\n     at evalScript (internal/process/execution.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*\n \n [eval]:1\n var ______________________________________________; throw 10"
        },
        {
            "sha": "cd098b64bfb5f10959412253b06ca9c1ebedfd72",
            "filename": "test/message/events_unhandled_error_nexttick.out",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_nexttick.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -12,13 +12,10 @@ Error\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n Emitted 'error' event at:\n     at process.nextTick (*events_unhandled_error_nexttick.js:*:*)\n     at internalTickCallback (internal/process/next_tick.js:*:*)\n     at process.runNextTicks [as _tickCallback] (internal/process/next_tick.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*"
        },
        {
            "sha": "678a9ae4b11d7df4b74c0284e0b3b54ef88bc3a0",
            "filename": "test/message/events_unhandled_error_sameline.out",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_sameline.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -12,9 +12,8 @@ Error\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n Emitted 'error' event at:\n     at Object.<anonymous> (*events_unhandled_error_sameline.js:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     [... lines matching original stack trace ...]\n-    at startup (internal/bootstrap/node.js:*:*)\n+    at startExecution (internal/bootstrap/node.js:*:*)"
        },
        {
            "sha": "6a4d7ed2dabcb0e1988d217ffa8d21089f200dab",
            "filename": "test/message/nexttick_throw.out",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fnexttick_throw.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Fnexttick_throw.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fnexttick_throw.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -9,5 +9,3 @@ ReferenceError: undefined_reference_error_maker is not defined\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n     at executeUserCode (internal/bootstrap/node.js:*:*)\n     at startExecution (internal/bootstrap/node.js:*:*)\n-    at startup (internal/bootstrap/node.js:*:*)\n-    at internal/bootstrap/node.js:*:*"
        },
        {
            "sha": "1f88a136a9aa136e4e0f143a705647bb919c540d",
            "filename": "test/message/unhandled_promise_trace_warnings.out",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Funhandled_promise_trace_warnings.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Funhandled_promise_trace_warnings.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Funhandled_promise_trace_warnings.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -15,9 +15,6 @@\n     at *\n     at *\n     at *\n-    at *\n-    at *\n-    at *\n (node:*) Error: This was rejected\n     at * (*test*message*unhandled_promise_trace_warnings.js:*)\n     at *\n@@ -28,7 +25,6 @@\n     at *\n     at *\n     at *\n-    at *\n (node:*) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\n     at *\n     at *\n@@ -38,8 +34,6 @@\n     at *\n     at *\n     at *\n-    at *\n-    at *\n (node:*) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 1)\n     at handledRejection (internal/process/promises.js:*)\n     at promiseRejectHandler (internal/process/promises.js:*)"
        },
        {
            "sha": "406d8112ce2599645a4703a6238e6631d6658656",
            "filename": "test/message/util_inspect_error.out",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Futil_inspect_error.out",
            "raw_url": "https://github.com/nodejs/node/raw/f6a1d88c5d1c813c8d55933436b4b834a29f449f/test%2Fmessage%2Futil_inspect_error.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Futil_inspect_error.out?ref=f6a1d88c5d1c813c8d55933436b4b834a29f449f",
            "patch": "@@ -10,7 +10,6 @@\n        at *\n        at *\n        at *\n-       at *\n   nested:\n    { err:\n       Error: foo\n@@ -23,7 +22,6 @@\n           at *\n           at *\n           at *\n-          at *\n           at * } }\n {\n   err: Error: foo\n@@ -36,7 +34,6 @@\n       at *\n       at *\n       at *\n-      at *\n       at *,\n   nested: {\n     err: Error: foo\n@@ -50,7 +47,6 @@\n         at *\n         at *\n         at *\n-        at *\n   }\n }\n { Error: foo\n@@ -64,5 +60,4 @@ bar\n     at *\n     at *\n     at *\n-    at *\n   foo: 'bar' }"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 47,
        "deletions": 32
    }
}