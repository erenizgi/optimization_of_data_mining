{
    "author": "BeniCheni",
    "message": "vm: allow `cachedData` to also be TypedArray|DataView\n\nPR-URL: https://github.com/nodejs/node/pull/22921\nRefs: https://github.com/nodejs/node/issues/1826\nRefs: https://github.com/nodejs/node/pull/22921#issuecomment-422350213\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "65fe999ed77c958468ca55c24e9242e193b55f95",
    "files": [
        {
            "sha": "ae4daec7166eb6894c1e194a3161bded78d79a56",
            "filename": "doc/api/vm.md",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/65fe999ed77c958468ca55c24e9242e193b55f95/doc%2Fapi%2Fvm.md",
            "raw_url": "https://github.com/nodejs/node/raw/65fe999ed77c958468ca55c24e9242e193b55f95/doc%2Fapi%2Fvm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fvm.md?ref=65fe999ed77c958468ca55c24e9242e193b55f95",
            "patch": "@@ -434,10 +434,10 @@ changes:\n     in stack traces produced by this script.\n   * `columnOffset` {number} Specifies the column number offset that is displayed\n     in stack traces produced by this script.\n-  * `cachedData` {Buffer} Provides an optional `Buffer` with V8's code cache\n-    data for the supplied source. When supplied, the `cachedDataRejected` value\n-    will be set to either `true` or `false` depending on acceptance of the data\n-    by V8.\n+  * `cachedData` {Buffer|TypedArray|DataView} Provides an optional `Buffer` or\n+    `TypedArray`, or `DataView` with V8's code cache data for the supplied\n+     source. When supplied, the `cachedDataRejected` value will be set to\n+     either `true` or `false` depending on acceptance of the data by V8.\n   * `produceCachedData` {boolean} When `true` and no `cachedData` is present, V8\n     will attempt to produce code cache data for `code`. Upon success, a\n     `Buffer` with V8's code cache data will be produced and stored in the\n@@ -669,8 +669,9 @@ added: v10.10.0\n     in stack traces produced by this script. **Default:** `0`.\n   * `columnOffset` {number} Specifies the column number offset that is displayed\n     in stack traces produced by this script. **Default:** `0`.\n-  * `cachedData` {Buffer} Provides an optional `Buffer` with V8's code cache\n-    data for the supplied source.\n+  * `cachedData` {Buffer|TypedArray|DataView} Provides an optional `Buffer` or\n+    `TypedArray`, or `DataView` with V8's code cache data for the supplied\n+     source.\n   * `produceCachedData` {boolean} Specifies whether to produce new cache data.\n     **Default:** `false`.\n   * `parsingContext` {Object} The [contextified][] sandbox in which the said"
        },
        {
            "sha": "6e735bca4a76d9300d0d9659b596a08ea053c26e",
            "filename": "lib/vm.js",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/65fe999ed77c958468ca55c24e9242e193b55f95/lib%2Fvm.js",
            "raw_url": "https://github.com/nodejs/node/raw/65fe999ed77c958468ca55c24e9242e193b55f95/lib%2Fvm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fvm.js?ref=65fe999ed77c958468ca55c24e9242e193b55f95",
            "patch": "@@ -32,7 +32,7 @@ const {\n   ERR_INVALID_ARG_TYPE,\n   ERR_VM_MODULE_NOT_MODULE,\n } = require('internal/errors').codes;\n-const { isModuleNamespaceObject, isUint8Array } = require('util').types;\n+const { isModuleNamespaceObject, isArrayBufferView } = require('util').types;\n const { validateInt32, validateUint32 } = require('internal/validators');\n const kParsingContext = Symbol('script parsing context');\n \n@@ -64,9 +64,12 @@ class Script extends ContextifyScript {\n     }\n     validateInt32(lineOffset, 'options.lineOffset');\n     validateInt32(columnOffset, 'options.columnOffset');\n-    if (cachedData !== undefined && !isUint8Array(cachedData)) {\n-      throw new ERR_INVALID_ARG_TYPE('options.cachedData',\n-                                     ['Buffer', 'Uint8Array'], cachedData);\n+    if (cachedData !== undefined && !isArrayBufferView(cachedData)) {\n+      throw new ERR_INVALID_ARG_TYPE(\n+        'options.cachedData',\n+        ['Buffer', 'TypedArray', 'DataView'],\n+        cachedData\n+      );\n     }\n     if (typeof produceCachedData !== 'boolean') {\n       throw new ERR_INVALID_ARG_TYPE('options.produceCachedData', 'boolean',\n@@ -346,10 +349,10 @@ function compileFunction(code, params, options = {}) {\n   }\n   validateUint32(columnOffset, 'options.columnOffset');\n   validateUint32(lineOffset, 'options.lineOffset');\n-  if (cachedData !== undefined && !isUint8Array(cachedData)) {\n+  if (cachedData !== undefined && !isArrayBufferView(cachedData)) {\n     throw new ERR_INVALID_ARG_TYPE(\n       'options.cachedData',\n-      'Uint8Array',\n+      ['Buffer', 'TypedArray', 'DataView'],\n       cachedData\n     );\n   }"
        },
        {
            "sha": "79943f1ad6a7a4660bae72e750fd2f5daf87ce9b",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/65fe999ed77c958468ca55c24e9242e193b55f95/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65fe999ed77c958468ca55c24e9242e193b55f95/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=65fe999ed77c958468ca55c24e9242e193b55f95",
            "patch": "@@ -33,6 +33,7 @@ namespace contextify {\n \n using v8::Array;\n using v8::ArrayBuffer;\n+using v8::ArrayBufferView;\n using v8::Boolean;\n using v8::Context;\n using v8::EscapableHandleScope;\n@@ -64,7 +65,6 @@ using v8::String;\n using v8::Symbol;\n using v8::TryCatch;\n using v8::Uint32;\n-using v8::Uint8Array;\n using v8::UnboundScript;\n using v8::Value;\n using v8::WeakCallbackInfo;\n@@ -629,7 +629,7 @@ void ContextifyScript::New(const FunctionCallbackInfo<Value>& args) {\n \n   Local<Integer> line_offset;\n   Local<Integer> column_offset;\n-  Local<Uint8Array> cached_data_buf;\n+  Local<ArrayBufferView> cached_data_buf;\n   bool produce_cached_data = false;\n   Local<Context> parsing_context = context;\n \n@@ -642,8 +642,8 @@ void ContextifyScript::New(const FunctionCallbackInfo<Value>& args) {\n     CHECK(args[3]->IsNumber());\n     column_offset = args[3].As<Integer>();\n     if (!args[4]->IsUndefined()) {\n-      CHECK(args[4]->IsUint8Array());\n-      cached_data_buf = args[4].As<Uint8Array>();\n+      CHECK(args[4]->IsArrayBufferView());\n+      cached_data_buf = args[4].As<ArrayBufferView>();\n     }\n     CHECK(args[5]->IsBoolean());\n     produce_cached_data = args[5]->IsTrue();\n@@ -994,10 +994,10 @@ void ContextifyContext::CompileFunction(\n   Local<Integer> column_offset = args[3].As<Integer>();\n \n   // Argument 5: cached data (optional)\n-  Local<Uint8Array> cached_data_buf;\n+  Local<ArrayBufferView> cached_data_buf;\n   if (!args[4]->IsUndefined()) {\n-    CHECK(args[4]->IsUint8Array());\n-    cached_data_buf = args[4].As<Uint8Array>();\n+    CHECK(args[4]->IsArrayBufferView());\n+    cached_data_buf = args[4].As<ArrayBufferView>();\n   }\n \n   // Argument 6: produce cache data"
        },
        {
            "sha": "df0c7df1062c1494acecb17d221df65c8f34a67d",
            "filename": "test/parallel/test-vm-basic.js",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/65fe999ed77c958468ca55c24e9242e193b55f95/test%2Fparallel%2Ftest-vm-basic.js",
            "raw_url": "https://github.com/nodejs/node/raw/65fe999ed77c958468ca55c24e9242e193b55f95/test%2Fparallel%2Ftest-vm-basic.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-basic.js?ref=65fe999ed77c958468ca55c24e9242e193b55f95",
            "patch": "@@ -178,18 +178,20 @@ const vm = require('vm');\n     'filename': 'string',\n     'columnOffset': 'number',\n     'lineOffset': 'number',\n-    'cachedData': 'Uint8Array',\n+    'cachedData': 'Buffer, TypedArray, or DataView',\n     'produceCachedData': 'boolean',\n   };\n \n   for (const option in optionTypes) {\n+    const typeErrorMessage = `The \"options.${option}\" property must be ` +\n+       `${option === 'cachedData' ? 'one of' : 'of'} type`;\n     common.expectsError(() => {\n       vm.compileFunction('', undefined, { [option]: null });\n     }, {\n       type: TypeError,\n       code: 'ERR_INVALID_ARG_TYPE',\n-      message: `The \"options.${option}\" property must be of type ` +\n-        `${optionTypes[option]}. Received type object`\n+      message: typeErrorMessage +\n+        ` ${optionTypes[option]}. Received type object`\n     });\n   }\n "
        },
        {
            "sha": "1b14999cdbc2f74c3c891c605c49eceb1f8bf4ba",
            "filename": "test/parallel/test-vm-cached-data.js",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/65fe999ed77c958468ca55c24e9242e193b55f95/test%2Fparallel%2Ftest-vm-cached-data.js",
            "raw_url": "https://github.com/nodejs/node/raw/65fe999ed77c958468ca55c24e9242e193b55f95/test%2Fparallel%2Ftest-vm-cached-data.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-cached-data.js?ref=65fe999ed77c958468ca55c24e9242e193b55f95",
            "patch": "@@ -41,12 +41,14 @@ function testProduceConsume() {\n \n   const data = produce(source);\n \n-  // It should consume code cache\n-  const script = new vm.Script(source, {\n-    cachedData: data\n-  });\n-  assert(!script.cachedDataRejected);\n-  assert.strictEqual(script.runInThisContext()(), 'original');\n+  for (const cachedData of common.getArrayBufferViews(data)) {\n+    // It should consume code cache\n+    const script = new vm.Script(source, {\n+      cachedData\n+    });\n+    assert(!script.cachedDataRejected);\n+    assert.strictEqual(script.runInThisContext()(), 'original');\n+  }\n }\n testProduceConsume();\n \n@@ -91,5 +93,5 @@ common.expectsError(() => {\n }, {\n   code: 'ERR_INVALID_ARG_TYPE',\n   type: TypeError,\n-  message: /must be one of type Buffer or Uint8Array/\n+  message: /must be one of type Buffer, TypedArray, or DataView/\n });"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 37,
        "deletions": 29
    }
}