{
    "author": "apapirovski",
    "message": "string_decoder: fix regressions\n\nThere are libraries which invoke StringDecoder using .call and\n.inherits, which directly conflicts with making StringDecoder\nbe a class which can only be invoked with the new keyword.\nRevert to declaring it as a function.\n\nStringDecoder#lastNeed was not defined, redefine it using\nthe new interface and fix StringDecoder#lastTotal.\n\nPR-URL: https://github.com/nodejs/node/pull/18723\nRefs: https://github.com/nodejs/node/pull/18537\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "e782715d0a1c33f98212bdc064b4b4eea198e605",
    "files": [
        {
            "sha": "04d31b2607c63e2568962724eecc4e3745a764e5",
            "filename": "lib/string_decoder.js",
            "status": "modified",
            "additions": 51,
            "deletions": 37,
            "changes": 88,
            "blob_url": "https://github.com/nodejs/node/blob/e782715d0a1c33f98212bdc064b4b4eea198e605/lib%2Fstring_decoder.js",
            "raw_url": "https://github.com/nodejs/node/raw/e782715d0a1c33f98212bdc064b4b4eea198e605/lib%2Fstring_decoder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fstring_decoder.js?ref=e782715d0a1c33f98212bdc064b4b4eea198e605",
            "patch": "@@ -56,47 +56,61 @@ for (var i = 0; i < encodings.length; ++i)\n // StringDecoder provides an interface for efficiently splitting a series of\n // buffers into a series of JS strings without breaking apart multi-byte\n // characters.\n-class StringDecoder {\n-  constructor(encoding) {\n-    this.encoding = normalizeEncoding(encoding);\n-    this[kNativeDecoder] = Buffer.alloc(kSize);\n-    this[kNativeDecoder][kEncodingField] = encodingsMap[this.encoding];\n-  }\n-\n-  write(buf) {\n-    if (typeof buf === 'string')\n-      return buf;\n-    if (!ArrayBuffer.isView(buf))\n-      throw new errors.TypeError('ERR_INVALID_ARG_TYPE', 'buf',\n-                                 ['Buffer', 'Uint8Array', 'ArrayBufferView']);\n-    return decode(this[kNativeDecoder], buf);\n-  }\n-\n-  end(buf) {\n-    let ret = '';\n-    if (buf !== undefined)\n-      ret = this.write(buf);\n-    if (this[kNativeDecoder][kBufferedBytes] > 0)\n-      ret += flush(this[kNativeDecoder]);\n-    return ret;\n-  }\n+function StringDecoder(encoding) {\n+  this.encoding = normalizeEncoding(encoding);\n+  this[kNativeDecoder] = Buffer.alloc(kSize);\n+  this[kNativeDecoder][kEncodingField] = encodingsMap[this.encoding];\n+}\n \n-  /* Everything below this line is undocumented legacy stuff. */\n+StringDecoder.prototype.write = function write(buf) {\n+  if (typeof buf === 'string')\n+    return buf;\n+  if (!ArrayBuffer.isView(buf))\n+    throw new errors.TypeError('ERR_INVALID_ARG_TYPE', 'buf',\n+                               ['Buffer', 'Uint8Array', 'ArrayBufferView']);\n+  return decode(this[kNativeDecoder], buf);\n+};\n \n-  text(buf, offset) {\n-    this[kNativeDecoder][kMissingBytes] = 0;\n-    this[kNativeDecoder][kBufferedBytes] = 0;\n-    return this.write(buf.slice(offset));\n-  }\n+StringDecoder.prototype.end = function end(buf) {\n+  let ret = '';\n+  if (buf !== undefined)\n+    ret = this.write(buf);\n+  if (this[kNativeDecoder][kBufferedBytes] > 0)\n+    ret += flush(this[kNativeDecoder]);\n+  return ret;\n+};\n \n-  get lastTotal() {\n-    return this[kNativeDecoder][kBufferedBytes] + this.lastNeed;\n-  }\n+/* Everything below this line is undocumented legacy stuff. */\n+StringDecoder.prototype.text = function text(buf, offset) {\n+  this[kNativeDecoder][kMissingBytes] = 0;\n+  this[kNativeDecoder][kBufferedBytes] = 0;\n+  return this.write(buf.slice(offset));\n+};\n \n-  get lastChar() {\n-    return this[kNativeDecoder].subarray(kIncompleteCharactersStart,\n-                                         kIncompleteCharactersEnd);\n+Object.defineProperties(StringDecoder.prototype, {\n+  lastChar: {\n+    configurable: true,\n+    enumerable: true,\n+    get() {\n+      return this[kNativeDecoder].subarray(kIncompleteCharactersStart,\n+                                           kIncompleteCharactersEnd);\n+    }\n+  },\n+  lastNeed: {\n+    configurable: true,\n+    enumerable: true,\n+    get() {\n+      return this[kNativeDecoder][kMissingBytes];\n+    }\n+  },\n+  lastTotal: {\n+    configurable: true,\n+    enumerable: true,\n+    get() {\n+      return this[kNativeDecoder][kBufferedBytes] +\n+             this[kNativeDecoder][kMissingBytes];\n+    }\n   }\n-}\n+});\n \n exports.StringDecoder = StringDecoder;"
        },
        {
            "sha": "0e7ea8ffdd56a61d98b6f65fea76e9db736a523d",
            "filename": "test/parallel/test-string-decoder.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/e782715d0a1c33f98212bdc064b4b4eea198e605/test%2Fparallel%2Ftest-string-decoder.js",
            "raw_url": "https://github.com/nodejs/node/raw/e782715d0a1c33f98212bdc064b4b4eea198e605/test%2Fparallel%2Ftest-string-decoder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-string-decoder.js?ref=e782715d0a1c33f98212bdc064b4b4eea198e605",
            "patch": "@@ -29,6 +29,11 @@ const StringDecoder = require('string_decoder').StringDecoder;\n let decoder = new StringDecoder();\n assert.strictEqual(decoder.encoding, 'utf8');\n \n+// Should work without 'new' keyword\n+const decoder2 = {};\n+StringDecoder.call(decoder2);\n+assert.strictEqual(decoder2.encoding, 'utf8');\n+\n // UTF-8\n test('utf-8', Buffer.from('$', 'utf-8'), '$');\n test('utf-8', Buffer.from('¢', 'utf-8'), '¢');\n@@ -84,6 +89,11 @@ test('utf16le', Buffer.from('3DD84DDC', 'hex'), '\\ud83d\\udc4d'); // thumbs up\n // Additional UTF-8 tests\n decoder = new StringDecoder('utf8');\n assert.strictEqual(decoder.write(Buffer.from('E1', 'hex')), '');\n+\n+// A quick test for lastNeed & lastTotal which are undocumented.\n+assert.strictEqual(decoder.lastNeed, 2);\n+assert.strictEqual(decoder.lastTotal, 3);\n+\n assert.strictEqual(decoder.end(), '\\ufffd');\n \n decoder = new StringDecoder('utf8');"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 61,
        "deletions": 37
    }
}