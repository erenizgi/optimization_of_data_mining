{
    "author": "targos",
    "message": "lib: introduce internal/validators\n\nCreate a file to centralize argument validators that are used in\nmultiple internal modules.\nMove validateInt32 and validateUint32 to this file.\n\nPR-URL: https://github.com/nodejs/node/pull/19973\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e8361287030fbaa773761bb3798d45903bb160f6",
    "files": [
        {
            "sha": "c49d470f0355dc4688c532d52bb52d33657284fe",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -51,7 +51,6 @@ const internalUtil = require('internal/util');\n const {\n   copyObject,\n   getOptions,\n-  isUint32,\n   modeNum,\n   nullCheck,\n   preprocessSymlinkDestination,\n@@ -61,16 +60,19 @@ const {\n   stringToSymlinkType,\n   toUnixTimestamp,\n   validateBuffer,\n-  validateLen,\n   validateOffsetLengthRead,\n   validateOffsetLengthWrite,\n-  validatePath,\n-  validateUint32\n+  validatePath\n } = internalFS;\n const {\n   CHAR_FORWARD_SLASH,\n   CHAR_BACKWARD_SLASH,\n } = require('internal/constants');\n+const {\n+  isUint32,\n+  validateInt32,\n+  validateUint32\n+} = require('internal/validators');\n \n Object.defineProperty(exports, 'constants', {\n   configurable: false,\n@@ -755,8 +757,8 @@ fs.ftruncate = function(fd, len = 0, callback) {\n   // TODO(BridgeAR): This does not seem right.\n   // There does not seem to be any validation before and if there is any, it\n   // should work similar to validateUint32 or not have a upper cap at all.\n-  // This applies to all usage of `validateLen`.\n-  validateLen(len);\n+  // This applies to all usage of `validateInt32(len, 'len')`.\n+  validateInt32(len, 'len');\n   len = Math.max(0, len);\n   const req = new FSReqWrap();\n   req.oncomplete = makeCallback(callback);\n@@ -765,7 +767,7 @@ fs.ftruncate = function(fd, len = 0, callback) {\n \n fs.ftruncateSync = function(fd, len = 0) {\n   validateUint32(fd, 'fd');\n-  validateLen(len);\n+  validateInt32(len, 'len');\n   len = Math.max(0, len);\n   const ctx = {};\n   binding.ftruncate(fd, len, undefined, ctx);"
        },
        {
            "sha": "6ccff6933bf106bfa25426e1a5ee05cdb547e7a1",
            "filename": "lib/fs/promises.js",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs%2Fpromises.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -24,20 +24,22 @@ const {\n   copyObject,\n   getOptions,\n   getStatsFromBinding,\n-  isUint32,\n   modeNum,\n   nullCheck,\n   preprocessSymlinkDestination,\n   stringToFlags,\n   stringToSymlinkType,\n   toUnixTimestamp,\n   validateBuffer,\n-  validateLen,\n   validateOffsetLengthRead,\n   validateOffsetLengthWrite,\n-  validatePath,\n-  validateUint32\n+  validatePath\n } = require('internal/fs');\n+const {\n+  isUint32,\n+  validateInt32,\n+  validateUint32\n+} = require('internal/validators');\n const pathModule = require('path');\n \n const kHandle = Symbol('handle');\n@@ -275,7 +277,7 @@ async function truncate(path, len = 0) {\n \n async function ftruncate(handle, len = 0) {\n   validateFileHandle(handle);\n-  validateLen(len);\n+  validateInt32(len, 'len');\n   len = Math.max(0, len);\n   return binding.ftruncate(handle.fd, len, kUsePromises);\n }"
        },
        {
            "sha": "2f7a8d8ced176e20d6e8537a33972dbb6a99f2c0",
            "filename": "lib/internal/fs.js",
            "status": "modified",
            "additions": 1,
            "deletions": 44,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -70,9 +70,6 @@ function getOptions(options, defaultOptions) {\n   return options;\n }\n \n-function isInt32(n) { return n === (n | 0); }\n-function isUint32(n) { return n === (n >>> 0); }\n-\n function modeNum(m, def) {\n   if (typeof m === 'number')\n     return m;\n@@ -341,26 +338,6 @@ function validateBuffer(buffer) {\n   }\n }\n \n-function validateLen(len) {\n-  let err;\n-\n-  if (!isInt32(len)) {\n-    if (typeof len !== 'number') {\n-      err = new ERR_INVALID_ARG_TYPE('len', 'number', len);\n-    } else if (!Number.isInteger(len)) {\n-      err = new ERR_OUT_OF_RANGE('len', 'an integer', len);\n-    } else {\n-      // 2 ** 31 === 2147483648\n-      err = new ERR_OUT_OF_RANGE('len', '> -2147483649 && < 2147483648', len);\n-    }\n-  }\n-\n-  if (err !== undefined) {\n-    Error.captureStackTrace(err, validateLen);\n-    throw err;\n-  }\n-}\n-\n function validateOffsetLengthRead(offset, length, bufferLength) {\n   let err;\n \n@@ -410,28 +387,10 @@ function validatePath(path, propName = 'path') {\n   }\n }\n \n-function validateUint32(value, propName) {\n-  if (!isUint32(value)) {\n-    let err;\n-    if (typeof value !== 'number') {\n-      err = new ERR_INVALID_ARG_TYPE(propName, 'number', value);\n-    } else if (!Number.isInteger(value)) {\n-      err = new ERR_OUT_OF_RANGE(propName, 'an integer', value);\n-    } else {\n-      // 2 ** 32 === 4294967296\n-      err = new ERR_OUT_OF_RANGE(propName, '>= 0 && < 4294967296', value);\n-    }\n-    Error.captureStackTrace(err, validateUint32);\n-    throw err;\n-  }\n-}\n-\n module.exports = {\n   assertEncoding,\n   copyObject,\n   getOptions,\n-  isInt32,\n-  isUint32,\n   modeNum,\n   nullCheck,\n   preprocessSymlinkDestination,\n@@ -443,9 +402,7 @@ module.exports = {\n   SyncWriteStream,\n   toUnixTimestamp,\n   validateBuffer,\n-  validateLen,\n   validateOffsetLengthRead,\n   validateOffsetLengthWrite,\n-  validatePath,\n-  validateUint32\n+  validatePath\n };"
        },
        {
            "sha": "556bfb2dc08f5fb223d159ef7f852ec36ca1aefa",
            "filename": "lib/internal/validators.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Fvalidators.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Fvalidators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvalidators.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+const {\n+  ERR_INVALID_ARG_TYPE,\n+  ERR_OUT_OF_RANGE\n+} = require('internal/errors').codes;\n+\n+function isInt32(value) {\n+  return value === (value | 0);\n+}\n+\n+function isUint32(value) {\n+  return value === (value >>> 0);\n+}\n+\n+function validateInt32(value, name) {\n+  if (!isInt32(value)) {\n+    let err;\n+    if (typeof value !== 'number') {\n+      err = new ERR_INVALID_ARG_TYPE(name, 'number', value);\n+    } else if (!Number.isInteger(value)) {\n+      err = new ERR_OUT_OF_RANGE(name, 'an integer', value);\n+    } else {\n+      // 2 ** 31 === 2147483648\n+      err = new ERR_OUT_OF_RANGE(name, '> -2147483649 && < 2147483648', value);\n+    }\n+    Error.captureStackTrace(err, validateInt32);\n+    throw err;\n+  }\n+}\n+\n+function validateUint32(value, name, positive) {\n+  if (!isUint32(value)) {\n+    let err;\n+    if (typeof value !== 'number') {\n+      err = new ERR_INVALID_ARG_TYPE(name, 'number', value);\n+    } else if (!Number.isInteger(value)) {\n+      err = new ERR_OUT_OF_RANGE(name, 'an integer', value);\n+    } else {\n+      const min = positive ? 1 : 0;\n+      // 2 ** 32 === 4294967296\n+      err = new ERR_OUT_OF_RANGE(name, `>= ${min} && < 4294967296`, value);\n+    }\n+    Error.captureStackTrace(err, validateUint32);\n+    throw err;\n+  } else if (positive && value === 0) {\n+    const err = new ERR_OUT_OF_RANGE(name, '>= 1 && < 4294967296', value);\n+    Error.captureStackTrace(err, validateUint32);\n+    throw err;\n+  }\n+}\n+\n+module.exports = {\n+  isInt32,\n+  isUint32,\n+  validateInt32,\n+  validateUint32\n+};"
        },
        {
            "sha": "9e945c45c3de8a6098a448661e4b0b51f5220d7c",
            "filename": "lib/internal/vm/module.js",
            "status": "modified",
            "additions": 5,
            "deletions": 15,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Fvm%2Fmodule.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Finternal%2Fvm%2Fmodule.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvm%2Fmodule.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -6,7 +6,6 @@ const { URL } = require('internal/url');\n const { isContext } = process.binding('contextify');\n const {\n   ERR_INVALID_ARG_TYPE,\n-  ERR_OUT_OF_RANGE,\n   ERR_VM_MODULE_ALREADY_LINKED,\n   ERR_VM_MODULE_DIFFERENT_CONTEXT,\n   ERR_VM_MODULE_LINKING_ERRORED,\n@@ -19,6 +18,7 @@ const {\n   customInspectSymbol,\n } = require('internal/util');\n const { SafePromise } = require('internal/safe_globals');\n+const { validateInt32, validateUint32 } = require('internal/validators');\n \n const {\n   ModuleWrap,\n@@ -92,8 +92,8 @@ class Module {\n       perContextModuleId.set(context, 1);\n     }\n \n-    validateInteger(lineOffset, 'options.lineOffset');\n-    validateInteger(columnOffset, 'options.columnOffset');\n+    validateInt32(lineOffset, 'options.lineOffset');\n+    validateInt32(columnOffset, 'options.columnOffset');\n \n     if (initializeImportMeta !== undefined) {\n       if (typeof initializeImportMeta === 'function') {\n@@ -203,9 +203,8 @@ class Module {\n     let timeout = options.timeout;\n     if (timeout === undefined) {\n       timeout = -1;\n-    } else if (!Number.isInteger(timeout) || timeout <= 0) {\n-      throw new ERR_INVALID_ARG_TYPE('options.timeout', 'a positive integer',\n-                                     timeout);\n+    } else {\n+      validateUint32(timeout, 'options.timeout', true);\n     }\n \n     const { breakOnSigint = false } = options;\n@@ -243,15 +242,6 @@ class Module {\n   }\n }\n \n-function validateInteger(prop, propName) {\n-  if (!Number.isInteger(prop)) {\n-    throw new ERR_INVALID_ARG_TYPE(propName, 'integer', prop);\n-  }\n-  if ((prop >> 0) !== prop) {\n-    throw new ERR_OUT_OF_RANGE(propName, '32-bit integer', prop);\n-  }\n-}\n-\n module.exports = {\n   Module,\n   initImportMetaMap,"
        },
        {
            "sha": "3ab50c815803659682497e8d7951691d384cbe0c",
            "filename": "lib/vm.js",
            "status": "modified",
            "additions": 6,
            "deletions": 18,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Fvm.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/lib%2Fvm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fvm.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -28,11 +28,9 @@ const {\n   isContext: _isContext,\n } = process.binding('contextify');\n \n-const {\n-  ERR_INVALID_ARG_TYPE,\n-  ERR_OUT_OF_RANGE\n-} = require('internal/errors').codes;\n+const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n const { isUint8Array } = require('internal/util/types');\n+const { validateInt32, validateUint32 } = require('internal/validators');\n \n class Script extends ContextifyScript {\n   constructor(code, options = {}) {\n@@ -56,8 +54,8 @@ class Script extends ContextifyScript {\n     if (typeof filename !== 'string') {\n       throw new ERR_INVALID_ARG_TYPE('options.filename', 'string', filename);\n     }\n-    validateInteger(lineOffset, 'options.lineOffset');\n-    validateInteger(columnOffset, 'options.columnOffset');\n+    validateInt32(lineOffset, 'options.lineOffset');\n+    validateInt32(columnOffset, 'options.columnOffset');\n     if (cachedData !== undefined && !isUint8Array(cachedData)) {\n       throw new ERR_INVALID_ARG_TYPE('options.cachedData',\n                                      ['Buffer', 'Uint8Array'], cachedData);\n@@ -119,15 +117,6 @@ function validateContext(sandbox) {\n   }\n }\n \n-function validateInteger(prop, propName) {\n-  if (!Number.isInteger(prop)) {\n-    throw new ERR_INVALID_ARG_TYPE(propName, 'integer', prop);\n-  }\n-  if ((prop >> 0) !== prop) {\n-    throw new ERR_OUT_OF_RANGE(propName, '32-bit integer', prop);\n-  }\n-}\n-\n function validateString(prop, propName) {\n   if (prop !== undefined && typeof prop !== 'string')\n     throw new ERR_INVALID_ARG_TYPE(propName, 'string', prop);\n@@ -151,9 +140,8 @@ function getRunInContextArgs(options = {}) {\n   let timeout = options.timeout;\n   if (timeout === undefined) {\n     timeout = -1;\n-  } else if (!Number.isInteger(timeout) || timeout <= 0) {\n-    throw new ERR_INVALID_ARG_TYPE('options.timeout', 'a positive integer',\n-                                   timeout);\n+  } else {\n+    validateUint32(timeout, 'options.timeout', true);\n   }\n \n   const {"
        },
        {
            "sha": "2c7eb994d247cc02d3e540f97cbd32ba1f28139f",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -146,6 +146,7 @@\n       'lib/internal/v8.js',\n       'lib/internal/v8_prof_polyfill.js',\n       'lib/internal/v8_prof_processor.js',\n+      'lib/internal/validators.js',\n       'lib/internal/stream_base_commons.js',\n       'lib/internal/vm/module.js',\n       'lib/internal/streams/lazy_transform.js',"
        },
        {
            "sha": "67a27d58fff80516cbf6fb09ee8a12b458f7b518",
            "filename": "test/parallel/test-vm-options-validation.js",
            "status": "modified",
            "additions": 25,
            "deletions": 10,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/e8361287030fbaa773761bb3798d45903bb160f6/test%2Fparallel%2Ftest-vm-options-validation.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8361287030fbaa773761bb3798d45903bb160f6/test%2Fparallel%2Ftest-vm-options-validation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-options-validation.js?ref=e8361287030fbaa773761bb3798d45903bb160f6",
            "patch": "@@ -17,7 +17,7 @@ common.expectsError(() => {\n   new vm.Script('void 0', 42);\n }, invalidArgType);\n \n-[null, {}, [1], 'bad', true, 0.1].forEach((value) => {\n+[null, {}, [1], 'bad', true].forEach((value) => {\n   common.expectsError(() => {\n     new vm.Script('void 0', { lineOffset: value });\n   }, invalidArgType);\n@@ -27,6 +27,16 @@ common.expectsError(() => {\n   }, invalidArgType);\n });\n \n+[0.1, 2 ** 32].forEach((value) => {\n+  common.expectsError(() => {\n+    new vm.Script('void 0', { lineOffset: value });\n+  }, outOfRange);\n+\n+  common.expectsError(() => {\n+    new vm.Script('void 0', { columnOffset: value });\n+  }, outOfRange);\n+});\n+\n common.expectsError(() => {\n   new vm.Script('void 0', { lineOffset: Number.MAX_SAFE_INTEGER });\n }, outOfRange);\n@@ -53,26 +63,31 @@ common.expectsError(() => {\n   const script = new vm.Script('void 0');\n   const sandbox = vm.createContext();\n \n-  function assertErrors(options) {\n+  function assertErrors(options, errCheck) {\n     common.expectsError(() => {\n       script.runInThisContext(options);\n-    }, invalidArgType);\n+    }, errCheck);\n \n     common.expectsError(() => {\n       script.runInContext(sandbox, options);\n-    }, invalidArgType);\n+    }, errCheck);\n \n     common.expectsError(() => {\n       script.runInNewContext({}, options);\n-    }, invalidArgType);\n+    }, errCheck);\n   }\n \n-  [null, 'bad', 42].forEach(assertErrors);\n-  [{}, [1], 'bad', null, -1, 0, NaN].forEach((value) => {\n-    assertErrors({ timeout: value });\n+  [null, 'bad', 42].forEach((value) => {\n+    assertErrors(value, invalidArgType);\n+  });\n+  [{}, [1], 'bad', null].forEach((value) => {\n+    assertErrors({ timeout: value }, invalidArgType);\n+  });\n+  [-1, 0, NaN].forEach((value) => {\n+    assertErrors({ timeout: value }, outOfRange);\n   });\n   [{}, [1], 'bad', 1, null].forEach((value) => {\n-    assertErrors({ displayErrors: value });\n-    assertErrors({ breakOnSigint: value });\n+    assertErrors({ displayErrors: value }, invalidArgType);\n+    assertErrors({ breakOnSigint: value }, invalidArgType);\n   });\n }"
        }
    ],
    "stats": {
        "total": 211,
        "additions": 112,
        "deletions": 99
    }
}