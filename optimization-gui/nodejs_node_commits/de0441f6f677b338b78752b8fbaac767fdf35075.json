{
    "author": "devsnek",
    "message": "lib: implement queueMicrotask\n\nPR-URL: https://github.com/nodejs/node/pull/22951\nRefs: https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#dom-queuemicrotask\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "de0441f6f677b338b78752b8fbaac767fdf35075",
    "files": [
        {
            "sha": "50b6d5238b9a058e6be142e300ce79346827b410",
            "filename": ".eslintrc.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/.eslintrc.js",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/.eslintrc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/.eslintrc.js?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -277,6 +277,7 @@ module.exports = {\n     DTRACE_NET_SERVER_CONNECTION: false,\n     DTRACE_NET_STREAM_END: false,\n     TextEncoder: false,\n-    TextDecoder: false\n+    TextDecoder: false,\n+    queueMicrotask: false,\n   },\n };"
        },
        {
            "sha": "ff3e14b96c250e17b6a28de2f2a294279c4dbeb8",
            "filename": "doc/api/async_hooks.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/doc%2Fapi%2Fasync_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/doc%2Fapi%2Fasync_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fasync_hooks.md?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -240,7 +240,7 @@ FSEVENTWRAP, FSREQWRAP, GETADDRINFOREQWRAP, GETNAMEINFOREQWRAP, HTTPPARSER,\n JSSTREAM, PIPECONNECTWRAP, PIPEWRAP, PROCESSWRAP, QUERYWRAP, SHUTDOWNWRAP,\n SIGNALWRAP, STATWATCHER, TCPCONNECTWRAP, TCPSERVER, TCPWRAP, TTYWRAP,\n UDPSENDWRAP, UDPWRAP, WRITEWRAP, ZLIB, SSLCONNECTION, PBKDF2REQUEST,\n-RANDOMBYTESREQUEST, TLSWRAP, Timeout, Immediate, TickObject\n+RANDOMBYTESREQUEST, TLSWRAP, Microtask, Timeout, Immediate, TickObject\n ```\n \n There is also the `PROMISE` resource type, which is used to track `Promise`"
        },
        {
            "sha": "a461dca2ae2f3dcc89f575dfa4ae6bee080745ed",
            "filename": "doc/api/globals.md",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/doc%2Fapi%2Fglobals.md",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/doc%2Fapi%2Fglobals.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fglobals.md?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -107,6 +107,46 @@ added: v0.1.7\n \n The process object. See the [`process` object][] section.\n \n+## queueMicrotask(callback)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+<!-- type=global -->\n+\n+> Stability: 1 - Experimental\n+\n+* `callback` {Function} Function to be queued.\n+\n+The `queueMicrotask()` method queues a microtask to invoke `callback`. If\n+`callback` throws an exception, the [`process` object][] `'error'` event will\n+be emitted.\n+\n+In general, `queueMicrotask` is the idiomatic choice over `process.nextTick()`.\n+`process.nextTick()` will always run before microtasks, and so unexpected\n+execution order may be observed.\n+\n+```js\n+// Here, `queueMicrotask()` is used to ensure the 'load' event is always\n+// emitted asynchronously, and therefore consistently. Using\n+// `process.nextTick()` here would result in the 'load' event always emitting\n+// before any other promise jobs.\n+\n+DataHandler.prototype.load = async function load(key) {\n+  const hit = this._cache.get(url);\n+  if (hit !== undefined) {\n+    queueMicrotask(() => {\n+      this.emit('load', hit);\n+    });\n+    return;\n+  }\n+\n+  const data = await fetchData(key);\n+  this._cache.set(url, data);\n+  this.emit('load', data);\n+};\n+```\n+\n ## require()\n \n This variable may appear to be global but is not. See [`require()`]."
        },
        {
            "sha": "e1c56e9b7e66791d545f37318d309af12b1c18cb",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -134,6 +134,7 @@\n       setupGlobalConsole();\n       setupGlobalURL();\n       setupGlobalEncoding();\n+      setupQueueMicrotask();\n     }\n \n     if (process.binding('config').experimentalWorker) {\n@@ -527,6 +528,33 @@\n     });\n   }\n \n+  function setupQueueMicrotask() {\n+    const { queueMicrotask } = NativeModule.require('internal/queue_microtask');\n+    Object.defineProperty(global, 'queueMicrotask', {\n+      get: () => {\n+        process.emitWarning('queueMicrotask() is experimental.',\n+                            'ExperimentalWarning');\n+        Object.defineProperty(global, 'queueMicrotask', {\n+          value: queueMicrotask,\n+          writable: true,\n+          enumerable: false,\n+          configurable: true,\n+        });\n+        return queueMicrotask;\n+      },\n+      set: (v) => {\n+        Object.defineProperty(global, 'queueMicrotask', {\n+          value: v,\n+          writable: true,\n+          enumerable: false,\n+          configurable: true,\n+        });\n+      },\n+      enumerable: false,\n+      configurable: true,\n+    });\n+  }\n+\n   function setupDOMException() {\n     // Registers the constructor with C++.\n     NativeModule.require('internal/domexception');"
        },
        {
            "sha": "3ff7ae9ae487021386b78b0eefd7741b40cfe3f7",
            "filename": "lib/internal/queue_microtask.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/lib%2Finternal%2Fqueue_microtask.js",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/lib%2Finternal%2Fqueue_microtask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fqueue_microtask.js?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -0,0 +1,32 @@\n+'use strict';\n+\n+const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n+const { AsyncResource } = require('async_hooks');\n+const { getDefaultTriggerAsyncId } = require('internal/async_hooks');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { enqueueMicrotask } = internalBinding('util');\n+\n+// declared separately for name, arrow function to prevent construction\n+const queueMicrotask = (callback) => {\n+  if (typeof callback !== 'function') {\n+    throw new ERR_INVALID_ARG_TYPE('callback', 'function', callback);\n+  }\n+\n+  const asyncResource = new AsyncResource('Microtask', {\n+    triggerAsyncId: getDefaultTriggerAsyncId(),\n+    requireManualDestroy: true,\n+  });\n+\n+  enqueueMicrotask(() => {\n+    asyncResource.runInAsyncScope(() => {\n+      try {\n+        callback();\n+      } catch (e) {\n+        process.emit('error', e);\n+      }\n+    });\n+    asyncResource.emitDestroy();\n+  });\n+};\n+\n+module.exports = { queueMicrotask };"
        },
        {
            "sha": "30fb4ca8ef08c6cd5d08e010a096a3e83e20062a",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -146,6 +146,7 @@\n       'lib/internal/querystring.js',\n       'lib/internal/process/write-coverage.js',\n       'lib/internal/process/coverage.js',\n+      'lib/internal/queue_microtask.js',\n       'lib/internal/readline.js',\n       'lib/internal/repl.js',\n       'lib/internal/repl/await.js',"
        },
        {
            "sha": "c183f314a1394f92fa713cd2fc0e969bb77b865c",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -7,8 +7,10 @@ namespace util {\n using v8::ALL_PROPERTIES;\n using v8::Array;\n using v8::Context;\n+using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::Integer;\n+using v8::Isolate;\n using v8::Local;\n using v8::Object;\n using v8::ONLY_CONFIGURABLE;\n@@ -172,6 +174,15 @@ void SafeGetenv(const FunctionCallbackInfo<Value>& args) {\n             v8::NewStringType::kNormal).ToLocalChecked());\n }\n \n+void EnqueueMicrotask(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n+\n+  CHECK(args[0]->IsFunction());\n+\n+  isolate->EnqueueMicrotask(args[0].As<Function>());\n+}\n+\n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n                 Local<Context> context) {\n@@ -219,6 +230,8 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n \n+  env->SetMethod(target, \"enqueueMicrotask\", EnqueueMicrotask);\n+\n   Local<Object> constants = Object::New(env->isolate());\n   NODE_DEFINE_CONSTANT(constants, ALL_PROPERTIES);\n   NODE_DEFINE_CONSTANT(constants, ONLY_WRITABLE);"
        },
        {
            "sha": "dfa537752e37fcd1f8d575abbb545616094f8899",
            "filename": "test/async-hooks/test-queue-microtask.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/test%2Fasync-hooks%2Ftest-queue-microtask.js",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/test%2Fasync-hooks%2Ftest-queue-microtask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-queue-microtask.js?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -0,0 +1,25 @@\n+'use strict';\n+const common = require('../common');\n+\n+const assert = require('assert');\n+const async_hooks = require('async_hooks');\n+const initHooks = require('./init-hooks');\n+const { checkInvocations } = require('./hook-checks');\n+\n+const hooks = initHooks();\n+hooks.enable();\n+\n+const rootAsyncId = async_hooks.executionAsyncId();\n+\n+queueMicrotask(common.mustCall(function() {\n+  assert.strictEqual(async_hooks.triggerAsyncId(), rootAsyncId);\n+}));\n+\n+process.on('exit', function() {\n+  hooks.sanityCheck();\n+\n+  const as = hooks.activitiesOfTypes('Microtask');\n+  checkInvocations(as[0], {\n+    init: 1, before: 1, after: 1, destroy: 1\n+  }, 'when process exits');\n+});"
        },
        {
            "sha": "ea9b88c71e2966d40c69b5aeca4d25f3f84a4868",
            "filename": "test/parallel/test-queue-microtask.js",
            "status": "added",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/nodejs/node/blob/de0441f6f677b338b78752b8fbaac767fdf35075/test%2Fparallel%2Ftest-queue-microtask.js",
            "raw_url": "https://github.com/nodejs/node/raw/de0441f6f677b338b78752b8fbaac767fdf35075/test%2Fparallel%2Ftest-queue-microtask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-queue-microtask.js?ref=de0441f6f677b338b78752b8fbaac767fdf35075",
            "patch": "@@ -0,0 +1,60 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+assert.strictEqual(typeof queueMicrotask, 'function');\n+\n+[\n+  undefined,\n+  null,\n+  0,\n+  'x = 5',\n+].forEach((t) => {\n+  assert.throws(common.mustCall(() => {\n+    queueMicrotask(t);\n+  }), {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+  });\n+});\n+\n+{\n+  let called = false;\n+  queueMicrotask(common.mustCall(() => {\n+    called = true;\n+  }));\n+  assert.strictEqual(called, false);\n+}\n+\n+queueMicrotask(common.mustCall(function() {\n+  assert.strictEqual(arguments.length, 0);\n+}), 'x', 'y');\n+\n+{\n+  const q = [];\n+  Promise.resolve().then(() => q.push('a'));\n+  queueMicrotask(common.mustCall(() => q.push('b')));\n+  Promise.reject().catch(() => q.push('c'));\n+\n+  queueMicrotask(common.mustCall(() => {\n+    assert.deepStrictEqual(q, ['a', 'b', 'c']);\n+  }));\n+}\n+\n+const eq = [];\n+process.on('error', (e) => {\n+  eq.push(e);\n+});\n+\n+process.on('exit', () => {\n+  assert.strictEqual(eq.length, 2);\n+  assert.strictEqual(eq[0].message, 'E1');\n+  assert.strictEqual(\n+    eq[1].message, 'Class constructor  cannot be invoked without \\'new\\'');\n+});\n+\n+queueMicrotask(common.mustCall(() => {\n+  throw new Error('E1');\n+}));\n+\n+queueMicrotask(class {});"
        }
    ],
    "stats": {
        "total": 204,
        "additions": 202,
        "deletions": 2
    }
}