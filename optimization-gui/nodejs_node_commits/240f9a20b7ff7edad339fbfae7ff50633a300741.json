{
    "author": "mafintosh",
    "message": "process: use linked reusable queue for ticks\n\nPR-URL: https://github.com/nodejs/node/pull/18617\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "240f9a20b7ff7edad339fbfae7ff50633a300741",
    "files": [
        {
            "sha": "84a7402117c5c244515f56bd6ceb4020ca044e55",
            "filename": "lib/internal/process/next_tick.js",
            "status": "modified",
            "additions": 49,
            "deletions": 27,
            "changes": 76,
            "blob_url": "https://github.com/nodejs/node/blob/240f9a20b7ff7edad339fbfae7ff50633a300741/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "raw_url": "https://github.com/nodejs/node/raw/240f9a20b7ff7edad339fbfae7ff50633a300741/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fnext_tick.js?ref=240f9a20b7ff7edad339fbfae7ff50633a300741",
            "patch": "@@ -32,32 +32,55 @@ function setupNextTick() {\n   const kHasScheduled = 0;\n   const kHasPromiseRejections = 1;\n \n-  const nextTickQueue = {\n-    head: null,\n-    tail: null,\n+  // Queue size for each tick array. Must be a factor of two.\n+  const kQueueSize = 2048;\n+  const kQueueMask = kQueueSize - 1;\n+\n+  class FixedQueue {\n+    constructor() {\n+      this.bottom = 0;\n+      this.top = 0;\n+      this.list = new Array(kQueueSize);\n+      this.next = null;\n+    }\n+\n     push(data) {\n-      const entry = { data, next: null };\n-      if (this.tail !== null) {\n-        this.tail.next = entry;\n-      } else {\n-        this.head = entry;\n-        tickInfo[kHasScheduled] = 1;\n-      }\n-      this.tail = entry;\n-    },\n+      this.list[this.top] = data;\n+      this.top = (this.top + 1) & kQueueMask;\n+    }\n+\n     shift() {\n-      if (this.head === null)\n-        return;\n-      const ret = this.head.data;\n-      if (this.head === this.tail) {\n-        this.head = this.tail = null;\n+      const next = this.list[this.bottom];\n+      if (next === undefined) return null;\n+      this.list[this.bottom] = undefined;\n+      this.bottom = (this.bottom + 1) & kQueueMask;\n+      return next;\n+    }\n+  }\n+\n+  var head = new FixedQueue();\n+  var tail = head;\n+\n+  function push(data) {\n+    if (head.bottom === head.top) {\n+      if (head.list[head.top] !== undefined)\n+        head = head.next = new FixedQueue();\n+      else\n+        tickInfo[kHasScheduled] = 1;\n+    }\n+    head.push(data);\n+  }\n+\n+  function shift() {\n+    const next = tail.shift();\n+    if (tail.top === tail.bottom) {\n+      if (tail.next)\n+        tail = tail.next;\n+      else\n         tickInfo[kHasScheduled] = 0;\n-      } else {\n-        this.head = this.head.next;\n-      }\n-      return ret;\n     }\n-  };\n+    return next;\n+  }\n \n   process.nextTick = nextTick;\n   // Needs to be accessible from beyond this scope.\n@@ -69,7 +92,7 @@ function setupNextTick() {\n   function _tickCallback() {\n     let tock;\n     do {\n-      while (tock = nextTickQueue.shift()) {\n+      while (tock = shift()) {\n         const asyncId = tock[async_id_symbol];\n         emitBefore(asyncId, tock[trigger_async_id_symbol]);\n         // emitDestroy() places the async_id_symbol into an asynchronous queue\n@@ -93,7 +116,7 @@ function setupNextTick() {\n         emitAfter(asyncId);\n       }\n       runMicrotasks();\n-    } while (nextTickQueue.head !== null || emitPromiseRejectionWarnings());\n+    } while (head.top !== head.bottom || emitPromiseRejectionWarnings());\n     tickInfo[kHasPromiseRejections] = 0;\n   }\n \n@@ -139,8 +162,7 @@ function setupNextTick() {\n           args[i - 1] = arguments[i];\n     }\n \n-    nextTickQueue.push(new TickObject(callback, args,\n-                                      getDefaultTriggerAsyncId()));\n+    push(new TickObject(callback, args, getDefaultTriggerAsyncId()));\n   }\n \n   // `internalNextTick()` will not enqueue any callback when the process is\n@@ -168,6 +190,6 @@ function setupNextTick() {\n \n     if (triggerAsyncId === null)\n       triggerAsyncId = getDefaultTriggerAsyncId();\n-    nextTickQueue.push(new TickObject(callback, args, triggerAsyncId));\n+    push(new TickObject(callback, args, triggerAsyncId));\n   }\n }"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 49,
        "deletions": 27
    }
}