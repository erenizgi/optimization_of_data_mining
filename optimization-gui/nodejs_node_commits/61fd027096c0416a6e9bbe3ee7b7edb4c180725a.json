{
    "author": "addaleax",
    "message": "src: use cleanup hooks to tear down BaseObjects\n\nClean up after `BaseObject` instances when the `Environment`\nis being shut down. This takes care of closing non-libuv resources\nlike `zlib` instances, which do not require asynchronous shutdown.\n\nMany thanks for Stephen Belanger, Timothy Gu and Alexey Orlenko for\nreviewing the original version of this commit in the Ayo.js project.\n\nRefs: https://github.com/ayojs/ayo/pull/88\nPR-URL: https://github.com/nodejs/node/pull/19377\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
    "files": [
        {
            "sha": "3bd854639b2c6d43de9482f58d7d65cca6f4ee86",
            "filename": "src/base_object-inl.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fbase_object-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fbase_object-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object-inl.h?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -37,10 +37,13 @@ BaseObject::BaseObject(Environment* env, v8::Local<v8::Object> object)\n   CHECK_EQ(false, object.IsEmpty());\n   CHECK_GT(object->InternalFieldCount(), 0);\n   object->SetAlignedPointerInInternalField(0, static_cast<void*>(this));\n+  env_->AddCleanupHook(DeleteMe, static_cast<void*>(this));\n }\n \n \n BaseObject::~BaseObject() {\n+  env_->RemoveCleanupHook(DeleteMe, static_cast<void*>(this));\n+\n   if (persistent_handle_.IsEmpty()) {\n     // This most likely happened because the weak callback below cleared it.\n     return;\n@@ -80,6 +83,12 @@ T* BaseObject::FromJSObject(v8::Local<v8::Object> object) {\n }\n \n \n+void BaseObject::DeleteMe(void* data) {\n+  BaseObject* self = static_cast<BaseObject*>(data);\n+  delete self;\n+}\n+\n+\n void BaseObject::MakeWeak() {\n   persistent_handle_.SetWeak(\n       this,"
        },
        {
            "sha": "e0b608434016814cc98e45a418bb2fa4601e0965",
            "filename": "src/base_object.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fbase_object.h",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fbase_object.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object.h?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -71,6 +71,8 @@ class BaseObject {\n  private:\n   BaseObject();\n \n+  static inline void DeleteMe(void* data);\n+\n   // persistent_handle_ needs to be at a fixed offset from the start of the\n   // class because it is used by src/node_postmortem_metadata.cc to calculate\n   // offsets and generate debug symbols for BaseObject, which assumes that the"
        },
        {
            "sha": "ab5de3e2ee1b1d21bcce17209103801688b217d3",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -133,6 +133,10 @@ Environment::Environment(IsolateData* isolate_data,\n }\n \n Environment::~Environment() {\n+  // Make sure there are no re-used libuv wrapper objects.\n+  // CleanupHandles() should have removed all of them.\n+  CHECK(file_handle_read_wrap_freelist_.empty());\n+\n   v8::HandleScope handle_scope(isolate());\n \n #if HAVE_INSPECTOR\n@@ -245,6 +249,8 @@ void Environment::CleanupHandles() {\n          !handle_wrap_queue_.IsEmpty()) {\n     uv_run(event_loop(), UV_RUN_ONCE);\n   }\n+\n+  file_handle_read_wrap_freelist_.clear();\n }\n \n void Environment::StartProfilerIdleNotifier() {"
        },
        {
            "sha": "391d3bc037927eee3cb43b07ad853781813f7608",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -576,6 +576,8 @@ std::unique_ptr<InspectorSession> Agent::Connect(\n \n void Agent::WaitForDisconnect() {\n   CHECK_NE(client_, nullptr);\n+  // TODO(addaleax): Maybe this should use an at-exit hook for the Environment\n+  // or something similar?\n   client_->contextDestroyed(parent_env_->context());\n   if (io_ != nullptr) {\n     io_->WaitForDisconnect();"
        },
        {
            "sha": "5cb90d9d06e8523c2169d2eefee3eec3967114f2",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -4550,12 +4550,13 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n \n   const int exit_code = EmitExit(&env);\n \n+  WaitForInspectorDisconnect(&env);\n+\n   env.RunCleanup();\n   RunAtExit(&env);\n \n   v8_platform.DrainVMTasks(isolate);\n   v8_platform.CancelVMTasks(isolate);\n-  WaitForInspectorDisconnect(&env);\n #if defined(LEAK_SANITIZER)\n   __lsan_do_leak_check();\n #endif"
        },
        {
            "sha": "7e9e2d9fbbf912472f153832f935840b979f2698",
            "filename": "src/req_wrap-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Freq_wrap-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/61fd027096c0416a6e9bbe3ee7b7edb4c180725a/src%2Freq_wrap-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Freq_wrap-inl.h?ref=61fd027096c0416a6e9bbe3ee7b7edb4c180725a",
            "patch": "@@ -26,7 +26,6 @@ ReqWrap<T>::ReqWrap(Environment* env,\n \n template <typename T>\n ReqWrap<T>::~ReqWrap() {\n-  CHECK_EQ(req_.data, this);  // Assert that someone has called Dispatched().\n   CHECK_EQ(false, persistent().IsEmpty());\n }\n "
        }
    ],
    "stats": {
        "total": 23,
        "additions": 21,
        "deletions": 2
    }
}