{
    "author": "addaleax",
    "message": "test,doc: add tests and docs for addon unloading\n\nOriginally from portions of https://github.com/nodejs/node/pull/23319/.\n\nPR-URL: https://github.com/nodejs/node/pull/24861\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
    "files": [
        {
            "sha": "9bc75c7dfc15d1dcb9bc9d73eb52c5179d32d833",
            "filename": "doc/api/addons.md",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/doc%2Fapi%2Faddons.md",
            "raw_url": "https://github.com/nodejs/node/raw/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/doc%2Fapi%2Faddons.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Faddons.md?ref=622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
            "patch": "@@ -234,6 +234,23 @@ NODE_MODULE_INIT(/* exports, module, context */) {\n }\n ```\n \n+#### Worker support\n+\n+In order to support [`Worker`][] threads, addons need to clean up any resources\n+they may have allocated when such a thread exists. This can be achieved through\n+the usage of the `AddEnvironmentCleanupHook()` function:\n+\n+```c++\n+void AddEnvironmentCleanupHook(v8::Isolate* isolate,\n+                               void (*fun)(void* arg),\n+                               void* arg);\n+```\n+\n+This function adds a hook that will run before a given Node.js instance shuts\n+down. If necessary, such hooks can be removed using\n+`RemoveEnvironmentCleanupHook()` before they are run, which has the same\n+signature.\n+\n ### Building\n \n Once the source code has been written, it must be compiled into the binary\n@@ -1349,6 +1366,7 @@ Test in JavaScript by running:\n require('./build/Release/addon');\n ```\n \n+[`Worker`]: worker_threads.html#worker_threads_class_worker\n [Electron]: https://electronjs.org/\n [Embedder's Guide]: https://github.com/v8/v8/wiki/Embedder's%20Guide\n [Linking to Node.js' own dependencies]: #addons_linking_to_node_js_own_dependencies"
        },
        {
            "sha": "f989c738c873c76d8bdaa0d3b0210a9a4b319042",
            "filename": "test/addons/hello-world/test-worker.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fhello-world%2Ftest-worker.js",
            "raw_url": "https://github.com/nodejs/node/raw/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fhello-world%2Ftest-worker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fhello-world%2Ftest-worker.js?ref=622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
            "patch": "@@ -0,0 +1,14 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const path = require('path');\n+const { Worker } = require('worker_threads');\n+const binding = path.resolve(__dirname, `./build/${common.buildType}/binding`);\n+\n+const w = new Worker(`\n+require('worker_threads').parentPort.postMessage(\n+  require(${JSON.stringify(binding)}).hello());`, { eval: true });\n+w.on('message', common.mustCall((message) => {\n+  assert.strictEqual(message, 'world');\n+}));"
        },
        {
            "sha": "1fb85ae230eb5fa682b51d620555c4f8feaf6a64",
            "filename": "test/addons/worker-addon/binding.cc",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fworker-addon%2Fbinding.cc?ref=622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
            "patch": "@@ -0,0 +1,46 @@\n+#include <assert.h>\n+#include <node.h>\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include <v8.h>\n+\n+using v8::Context;\n+using v8::HandleScope;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::Object;\n+using v8::Value;\n+\n+size_t count = 0;\n+\n+struct statically_allocated {\n+  statically_allocated() {\n+    assert(count == 0);\n+    printf(\"ctor \");\n+  }\n+  ~statically_allocated() {\n+    assert(count == 0);\n+    printf(\"dtor\");\n+  }\n+} var;\n+\n+void Dummy(void*) {\n+  assert(0);\n+}\n+\n+void Cleanup(void* str) {\n+  printf(\"%s \", static_cast<const char*>(str));\n+}\n+\n+void Initialize(Local<Object> exports,\n+                Local<Value> module,\n+                Local<Context> context) {\n+  node::AddEnvironmentCleanupHook(\n+      context->GetIsolate(),\n+      Cleanup,\n+      const_cast<void*>(static_cast<const void*>(\"cleanup\")));\n+  node::AddEnvironmentCleanupHook(context->GetIsolate(), Dummy, nullptr);\n+  node::RemoveEnvironmentCleanupHook(context->GetIsolate(), Dummy, nullptr);\n+}\n+\n+NODE_MODULE_CONTEXT_AWARE(NODE_GYP_MODULE_NAME, Initialize)"
        },
        {
            "sha": "7ede63d94a0d77635ff78b8ad2d0079216eefa1a",
            "filename": "test/addons/worker-addon/binding.gyp",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fworker-addon%2Fbinding.gyp?ref=622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
            "patch": "@@ -0,0 +1,9 @@\n+{\n+  'targets': [\n+    {\n+      'target_name': 'binding',\n+      'defines': [ 'V8_DEPRECATION_WARNINGS=1' ],\n+      'sources': [ 'binding.cc' ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "2f4bb512fc65718b4813351d0f930db42b9c6c8c",
            "filename": "test/addons/worker-addon/test.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/622e348d8f70a4ec006ee1ce9207a6a5bc3fc325/test%2Faddons%2Fworker-addon%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fworker-addon%2Ftest.js?ref=622e348d8f70a4ec006ee1ce9207a6a5bc3fc325",
            "patch": "@@ -0,0 +1,21 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const child_process = require('child_process');\n+const path = require('path');\n+const { Worker } = require('worker_threads');\n+const binding = path.resolve(__dirname, `./build/${common.buildType}/binding`);\n+\n+if (process.argv[2] === 'child') {\n+  new Worker(`require(${JSON.stringify(binding)});`, { eval: true });\n+} else {\n+  const proc = child_process.spawnSync(process.execPath, [\n+    '--experimental-worker',\n+    __filename,\n+    'child'\n+  ]);\n+  assert.strictEqual(proc.stderr.toString(), '');\n+  assert.strictEqual(proc.stdout.toString(), 'ctor cleanup dtor');\n+  assert.strictEqual(proc.status, 0);\n+}"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 108,
        "deletions": 0
    }
}