{
    "author": "jdalton",
    "message": "lib: ensure --check flag works with --require\n\nPR-URL: https://github.com/nodejs/node/pull/19600\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "0876a0314d15129e8b29cb6e9753b886086cbfe2",
    "files": [
        {
            "sha": "33882e328540c120b770293e52a145680c196e48",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0876a0314d15129e8b29cb6e9753b886086cbfe2/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/0876a0314d15129e8b29cb6e9753b886086cbfe2/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=0876a0314d15129e8b29cb6e9753b886086cbfe2",
            "patch": "@@ -75,6 +75,10 @@ Identical to `-e` but prints the result.\n added:\n   - v5.0.0\n   - v4.2.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19600\n+    description: The `--require` option is now supported when checking a file.\n -->\n \n Syntax check the script without executing."
        },
        {
            "sha": "7762aac84691d653af8df95f070b86e64f1fd2a3",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/0876a0314d15129e8b29cb6e9753b886086cbfe2/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/0876a0314d15129e8b29cb6e9753b886086cbfe2/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=0876a0314d15129e8b29cb6e9753b886086cbfe2",
            "patch": "@@ -210,6 +210,12 @@\n \n         const CJSModule = NativeModule.require('internal/modules/cjs/loader');\n \n+        perf.markMilestone(NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_END);\n+        perf.markMilestone(\n+          NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_START);\n+        preloadModules();\n+        perf.markMilestone(\n+          NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_END);\n         // check if user passed `-c` or `--check` arguments to Node.\n         if (process._syntax_check_only != null) {\n           const fs = NativeModule.require('fs');\n@@ -219,12 +225,6 @@\n           checkScriptSyntax(source, filename);\n           process.exit(0);\n         }\n-        perf.markMilestone(NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_END);\n-        perf.markMilestone(\n-          NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_START);\n-        preloadModules();\n-        perf.markMilestone(\n-          NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_END);\n         CJSModule.runMain();\n       } else {\n         perf.markMilestone(NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_START);"
        },
        {
            "sha": "d8c6aca111d31b92cad8546ba1d6c7e6e1fa5701",
            "filename": "test/fixtures/no-wrapper.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0876a0314d15129e8b29cb6e9753b886086cbfe2/test%2Ffixtures%2Fno-wrapper.js",
            "raw_url": "https://github.com/nodejs/node/raw/0876a0314d15129e8b29cb6e9753b886086cbfe2/test%2Ffixtures%2Fno-wrapper.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fno-wrapper.js?ref=0876a0314d15129e8b29cb6e9753b886086cbfe2",
            "patch": "@@ -0,0 +1 @@\n+require('module').wrapper = ['', ''];"
        },
        {
            "sha": "d80e8c698d72dedcc612dad18ae28e715a05d565",
            "filename": "test/parallel/test-cli-syntax.js",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/0876a0314d15129e8b29cb6e9753b886086cbfe2/test%2Fparallel%2Ftest-cli-syntax.js",
            "raw_url": "https://github.com/nodejs/node/raw/0876a0314d15129e8b29cb6e9753b886086cbfe2/test%2Fparallel%2Ftest-cli-syntax.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cli-syntax.js?ref=0876a0314d15129e8b29cb6e9753b886086cbfe2",
            "patch": "@@ -140,3 +140,26 @@ syntaxArgs.forEach(function(args) {\n     }));\n   });\n });\n+\n+// should work with -r flags\n+['-c', '--check'].forEach(function(checkFlag) {\n+  ['-r', '--require'].forEach(function(requireFlag) {\n+    const preloadFile = fixtures.path('no-wrapper.js');\n+    const file = fixtures.path('syntax', 'illegal_if_not_wrapped.js');\n+    const args = [requireFlag, preloadFile, checkFlag, file];\n+    const cmd = [node, ...args].join(' ');\n+    exec(cmd, common.mustCall((err, stdout, stderr) => {\n+      assert.strictEqual(err instanceof Error, true);\n+      assert.strictEqual(err.code, 1);\n+\n+      // no stdout should be produced\n+      assert.strictEqual(stdout, '');\n+\n+      // stderr should have a syntax error message\n+      assert(syntaxErrorRE.test(stderr), `${syntaxErrorRE} === ${stderr}`);\n+\n+      // stderr should include the filename\n+      assert(stderr.startsWith(file), `${stderr} starts with ${file}`);\n+    }));\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 34,
        "deletions": 6
    }
}