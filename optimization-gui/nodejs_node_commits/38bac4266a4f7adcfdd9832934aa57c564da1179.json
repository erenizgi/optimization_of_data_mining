{
    "author": "tniessen",
    "message": "crypto: allow passing null as IV unless required\n\nPR-URL: https://github.com/nodejs/node/pull/18644\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "38bac4266a4f7adcfdd9832934aa57c564da1179",
    "files": [
        {
            "sha": "9adc9082fc2fc26005a8ebc049dd7f190fc1b11b",
            "filename": "doc/api/crypto.md",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/38bac4266a4f7adcfdd9832934aa57c564da1179/doc%2Fapi%2Fcrypto.md",
            "raw_url": "https://github.com/nodejs/node/raw/38bac4266a4f7adcfdd9832934aa57c564da1179/doc%2Fapi%2Fcrypto.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcrypto.md?ref=38bac4266a4f7adcfdd9832934aa57c564da1179",
            "patch": "@@ -1286,6 +1286,11 @@ Adversaries][] for details.\n ### crypto.createCipheriv(algorithm, key, iv[, options])\n <!-- YAML\n added: v0.1.94\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18644\n+    description: The `iv` parameter may now be `null` for ciphers which do not\n+                 need an initialization vector.\n -->\n - `algorithm` {string}\n - `key` {string | Buffer | TypedArray | DataView}\n@@ -1301,7 +1306,8 @@ available cipher algorithms.\n \n The `key` is the raw key used by the `algorithm` and `iv` is an\n [initialization vector][]. Both arguments must be `'utf8'` encoded strings,\n-[Buffers][`Buffer`], `TypedArray`, or `DataView`s.\n+[Buffers][`Buffer`], `TypedArray`, or `DataView`s. If the cipher does not need\n+an initialization vector, `iv` may be `null`.\n \n ### crypto.createCredentials(details)\n <!-- YAML\n@@ -1347,6 +1353,11 @@ to create the `Decipher` object.\n ### crypto.createDecipheriv(algorithm, key, iv[, options])\n <!-- YAML\n added: v0.1.94\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18644\n+    description: The `iv` parameter may now be `null` for ciphers which do not\n+                 need an initialization vector.\n -->\n - `algorithm` {string}\n - `key` {string | Buffer | TypedArray | DataView}\n@@ -1363,7 +1374,8 @@ available cipher algorithms.\n \n The `key` is the raw key used by the `algorithm` and `iv` is an\n [initialization vector][]. Both arguments must be `'utf8'` encoded strings,\n-[Buffers][`Buffer`], `TypedArray`, or `DataView`s.\n+[Buffers][`Buffer`], `TypedArray`, or `DataView`s. If the cipher does not need\n+an initialization vector, `iv` may be `null`.\n \n ### crypto.createDiffieHellman(prime[, primeEncoding][, generator][, generatorEncoding])\n <!-- YAML"
        },
        {
            "sha": "5426c7e6edeed7fbd48905a4ece71ee947e0dd81",
            "filename": "lib/internal/crypto/cipher.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/38bac4266a4f7adcfdd9832934aa57c564da1179/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "raw_url": "https://github.com/nodejs/node/raw/38bac4266a4f7adcfdd9832934aa57c564da1179/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fcipher.js?ref=38bac4266a4f7adcfdd9832934aa57c564da1179",
            "patch": "@@ -182,7 +182,7 @@ function Cipheriv(cipher, key, iv, options) {\n   }\n \n   iv = toBuf(iv);\n-  if (!isArrayBufferView(iv)) {\n+  if (iv !== null && !isArrayBufferView(iv)) {\n     throw new errors.TypeError('ERR_INVALID_ARG_TYPE', 'iv',\n                                ['string', 'Buffer', 'TypedArray', 'DataView']);\n   }\n@@ -253,7 +253,7 @@ function Decipheriv(cipher, key, iv, options) {\n   }\n \n   iv = toBuf(iv);\n-  if (!isArrayBufferView(iv)) {\n+  if (iv !== null && !isArrayBufferView(iv)) {\n     throw new errors.TypeError('ERR_INVALID_ARG_TYPE', 'iv',\n                                ['string', 'Buffer', 'TypedArray', 'DataView']);\n   }"
        },
        {
            "sha": "a0b21e7c39d76cfd2bdd774923711a7b319a64b3",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 8,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/38bac4266a4f7adcfdd9832934aa57c564da1179/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/38bac4266a4f7adcfdd9832934aa57c564da1179/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=38bac4266a4f7adcfdd9832934aa57c564da1179",
            "patch": "@@ -3090,8 +3090,17 @@ void CipherBase::InitIv(const char* cipher_type,\n   const int expected_iv_len = EVP_CIPHER_iv_length(cipher);\n   const int mode = EVP_CIPHER_mode(cipher);\n   const bool is_gcm_mode = (EVP_CIPH_GCM_MODE == mode);\n+  const bool has_iv = iv_len >= 0;\n \n-  if (is_gcm_mode == false && iv_len != expected_iv_len) {\n+  // Throw if no IV was passed and the cipher requires an IV\n+  if (!has_iv && expected_iv_len != 0) {\n+    char msg[128];\n+    snprintf(msg, sizeof(msg), \"Missing IV for cipher %s\", cipher_type);\n+    return env()->ThrowError(msg);\n+  }\n+\n+  // Throw if an IV was passed which does not match the cipher's fixed IV length\n+  if (is_gcm_mode == false && has_iv && iv_len != expected_iv_len) {\n     return env()->ThrowError(\"Invalid IV length\");\n   }\n \n@@ -3103,11 +3112,13 @@ void CipherBase::InitIv(const char* cipher_type,\n   const bool encrypt = (kind_ == kCipher);\n   EVP_CipherInit_ex(ctx_, cipher, nullptr, nullptr, nullptr, encrypt);\n \n-  if (is_gcm_mode &&\n-      !EVP_CIPHER_CTX_ctrl(ctx_, EVP_CTRL_GCM_SET_IVLEN, iv_len, nullptr)) {\n-    EVP_CIPHER_CTX_free(ctx_);\n-    ctx_ = nullptr;\n-    return env()->ThrowError(\"Invalid IV length\");\n+  if (is_gcm_mode) {\n+    CHECK(has_iv);\n+    if (!EVP_CIPHER_CTX_ctrl(ctx_, EVP_CTRL_GCM_SET_IVLEN, iv_len, nullptr)) {\n+      EVP_CIPHER_CTX_free(ctx_);\n+      ctx_ = nullptr;\n+      return env()->ThrowError(\"Invalid IV length\");\n+    }\n   }\n \n   if (!EVP_CIPHER_CTX_set_key_length(ctx_, key_len)) {\n@@ -3135,8 +3146,15 @@ void CipherBase::InitIv(const FunctionCallbackInfo<Value>& args) {\n   const node::Utf8Value cipher_type(env->isolate(), args[0]);\n   ssize_t key_len = Buffer::Length(args[1]);\n   const char* key_buf = Buffer::Data(args[1]);\n-  ssize_t iv_len = Buffer::Length(args[2]);\n-  const char* iv_buf = Buffer::Data(args[2]);\n+  ssize_t iv_len;\n+  const char* iv_buf;\n+  if (args[2]->IsNull()) {\n+    iv_buf = nullptr;\n+    iv_len = -1;\n+  } else {\n+    iv_buf = Buffer::Data(args[2]);\n+    iv_len = Buffer::Length(args[2]);\n+  }\n   cipher->InitIv(*cipher_type, key_buf, key_len, iv_buf, iv_len);\n }\n "
        },
        {
            "sha": "dcdec728f1e3eb89224ba7a2a20b6ae298ad7ea6",
            "filename": "test/parallel/test-crypto-cipheriv-decipheriv.js",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/38bac4266a4f7adcfdd9832934aa57c564da1179/test%2Fparallel%2Ftest-crypto-cipheriv-decipheriv.js",
            "raw_url": "https://github.com/nodejs/node/raw/38bac4266a4f7adcfdd9832934aa57c564da1179/test%2Fparallel%2Ftest-crypto-cipheriv-decipheriv.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-cipheriv-decipheriv.js?ref=38bac4266a4f7adcfdd9832934aa57c564da1179",
            "patch": "@@ -105,7 +105,7 @@ function testCipher3(key, iv) {\n     });\n \n   common.expectsError(\n-    () => crypto.createCipheriv('des-ede3-cbc', key, null),\n+    () => crypto.createCipheriv('des-ede3-cbc', key, 10),\n     {\n       code: 'ERR_INVALID_ARG_TYPE',\n       type: TypeError,\n@@ -141,7 +141,7 @@ function testCipher3(key, iv) {\n     });\n \n   common.expectsError(\n-    () => crypto.createDecipheriv('des-ede3-cbc', key, null),\n+    () => crypto.createDecipheriv('des-ede3-cbc', key, 10),\n     {\n       code: 'ERR_INVALID_ARG_TYPE',\n       type: TypeError,\n@@ -161,8 +161,9 @@ if (!common.hasFipsCrypto) {\n               Buffer.from('A6A6A6A6A6A6A6A6', 'hex'));\n }\n \n-// Zero-sized IV should be accepted in ECB mode.\n+// Zero-sized IV or null should be accepted in ECB mode.\n crypto.createCipheriv('aes-128-ecb', Buffer.alloc(16), Buffer.alloc(0));\n+crypto.createCipheriv('aes-128-ecb', Buffer.alloc(16), null);\n \n const errMessage = /Invalid IV length/;\n \n@@ -186,6 +187,11 @@ for (let n = 0; n < 256; n += 1) {\n     errMessage);\n }\n \n+// And so should null be.\n+assert.throws(() => {\n+  crypto.createCipheriv('aes-128-cbc', Buffer.alloc(16), null);\n+}, /Missing IV for cipher aes-128-cbc/);\n+\n // Zero-sized IV should be rejected in GCM mode.\n assert.throws(\n   () => crypto.createCipheriv('aes-128-gcm', Buffer.alloc(16),"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 51,
        "deletions": 15
    }
}