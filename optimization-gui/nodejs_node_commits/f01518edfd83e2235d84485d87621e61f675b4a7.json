{
    "author": "addaleax",
    "message": "src: improve StreamBase write throughput\n\nImprove performance by transferring information about write status\nto JS through an `AliasedBuffer`, rather than object properties\nset from C++.\n\nPR-URL: https://github.com/nodejs/node/pull/23843\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "f01518edfd83e2235d84485d87621e61f675b4a7",
    "files": [
        {
            "sha": "dc2a5bc01523dda471c656fbd70396fd818c490b",
            "filename": "benchmark/net/net-c2s.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-c2s.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-c2s.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Fnet-c2s.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -6,7 +6,7 @@ const net = require('net');\n const PORT = common.PORT;\n \n const bench = common.createBenchmark(main, {\n-  len: [102400, 1024 * 1024 * 16],\n+  len: [64, 102400, 1024 * 1024 * 16],\n   type: ['utf', 'asc', 'buf'],\n   dur: [5],\n });"
        },
        {
            "sha": "e0b2842fd1de986f5e118cba9cd8ac0eac36a2c6",
            "filename": "benchmark/net/net-pipe.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Fnet-pipe.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -6,7 +6,7 @@ const net = require('net');\n const PORT = common.PORT;\n \n const bench = common.createBenchmark(main, {\n-  len: [102400, 1024 * 1024 * 16],\n+  len: [64, 102400, 1024 * 1024 * 16],\n   type: ['utf', 'asc', 'buf'],\n   dur: [5],\n });"
        },
        {
            "sha": "6ee5afa663aaca9fef525b191b4a5ab501e24b2a",
            "filename": "benchmark/net/net-s2c.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-s2c.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-s2c.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Fnet-s2c.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -5,7 +5,7 @@ const common = require('../common.js');\n const PORT = common.PORT;\n \n const bench = common.createBenchmark(main, {\n-  len: [102400, 1024 * 1024 * 16],\n+  len: [64, 102400, 1024 * 1024 * 16],\n   type: ['utf', 'asc', 'buf'],\n   dur: [5]\n });"
        },
        {
            "sha": "c4d11fa56c741175d9b0cfbd1f81f807abb71870",
            "filename": "benchmark/net/net-wrap-js-stream-passthrough.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-wrap-js-stream-passthrough.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/benchmark%2Fnet%2Fnet-wrap-js-stream-passthrough.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Fnet-wrap-js-stream-passthrough.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -5,7 +5,7 @@ const common = require('../common.js');\n const { PassThrough } = require('stream');\n \n const bench = common.createBenchmark(main, {\n-  len: [102400, 1024 * 1024 * 16],\n+  len: [64, 102400, 1024 * 1024 * 16],\n   type: ['utf', 'asc', 'buf'],\n   dur: [5],\n }, {"
        },
        {
            "sha": "ddb7e58d7c88873282d5d5fd6f9c2452866fb1f9",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -26,6 +26,7 @@ const {\n   WriteWrap,\n   kReadBytesOrError,\n   kArrayBufferOffset,\n+  kLastWriteWasAsync,\n   streamBaseState\n } = internalBinding('stream_wrap');\n const { Pipe, constants: PipeConstants } = internalBinding('pipe_wrap');\n@@ -716,10 +717,10 @@ function setupChannel(target, channel) {\n     }\n \n     var req = new WriteWrap();\n-    req.async = false;\n \n     var string = JSON.stringify(message) + '\\n';\n     var err = channel.writeUtf8String(req, string, handle);\n+    var wasAsyncWrite = streamBaseState[kLastWriteWasAsync];\n \n     if (err === 0) {\n       if (handle) {\n@@ -729,7 +730,7 @@ function setupChannel(target, channel) {\n           obj.postSend(message, handle, options, callback, target);\n       }\n \n-      if (req.async) {\n+      if (wasAsyncWrite) {\n         req.oncomplete = function() {\n           control.unref();\n           if (typeof callback === 'function')"
        },
        {
            "sha": "709395fa910cb22fdef373e4c455379ee0ca8ef2",
            "filename": "lib/internal/stream_base_commons.js",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/lib%2Finternal%2Fstream_base_commons.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/lib%2Finternal%2Fstream_base_commons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstream_base_commons.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -6,6 +6,8 @@ const {\n   WriteWrap,\n   kReadBytesOrError,\n   kArrayBufferOffset,\n+  kBytesWritten,\n+  kLastWriteWasAsync,\n   streamBaseState\n } = internalBinding('stream_wrap');\n const { UV_EOF } = internalBinding('uv');\n@@ -20,7 +22,12 @@ function handleWriteReq(req, data, encoding) {\n \n   switch (encoding) {\n     case 'buffer':\n-      return handle.writeBuffer(req, data);\n+    {\n+      const ret = handle.writeBuffer(req, data);\n+      if (streamBaseState[kLastWriteWasAsync])\n+        req.buffer = data;\n+      return ret;\n+    }\n     case 'latin1':\n     case 'binary':\n       return handle.writeLatin1String(req, data);\n@@ -35,7 +42,13 @@ function handleWriteReq(req, data, encoding) {\n     case 'utf-16le':\n       return handle.writeUcs2String(req, data);\n     default:\n-      return handle.writeBuffer(req, Buffer.from(data, encoding));\n+    {\n+      const buffer = Buffer.from(data, encoding);\n+      const ret = handle.writeBuffer(req, buffer);\n+      if (streamBaseState[kLastWriteWasAsync])\n+        req.buffer = buffer;\n+      return ret;\n+    }\n   }\n }\n \n@@ -45,6 +58,8 @@ function createWriteWrap(handle, oncomplete) {\n   req.handle = handle;\n   req.oncomplete = oncomplete;\n   req.async = false;\n+  req.bytes = 0;\n+  req.buffer = null;\n \n   return req;\n }\n@@ -80,6 +95,9 @@ function writeGeneric(self, req, data, encoding, cb) {\n }\n \n function afterWriteDispatched(self, req, err, cb) {\n+  req.bytes = streamBaseState[kBytesWritten];\n+  req.async = !!streamBaseState[kLastWriteWasAsync];\n+\n   if (err !== 0)\n     return self.destroy(errnoException(err, 'write', req.error), cb);\n "
        },
        {
            "sha": "a7ea3de82fff8a375963676c846981d2bfb7812a",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -128,10 +128,8 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(address_string, \"address\")                                                \\\n   V(aliases_string, \"aliases\")                                                \\\n   V(args_string, \"args\")                                                      \\\n-  V(async, \"async\")                                                           \\\n   V(async_ids_stack_string, \"async_ids_stack\")                                \\\n   V(buffer_string, \"buffer\")                                                  \\\n-  V(bytes_string, \"bytes\")                                                    \\\n   V(bytes_parsed_string, \"bytesParsed\")                                       \\\n   V(bytes_read_string, \"bytesRead\")                                           \\\n   V(bytes_written_string, \"bytesWritten\")                                     \\"
        },
        {
            "sha": "adb839c3e5d633f1c07b765385c2de08e58b293c",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 26,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -18,13 +18,11 @@ namespace node {\n \n using v8::Array;\n using v8::ArrayBuffer;\n-using v8::Boolean;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n using v8::HandleScope;\n using v8::Integer;\n using v8::Local;\n-using v8::Number;\n using v8::Object;\n using v8::String;\n using v8::Value;\n@@ -56,18 +54,9 @@ int StreamBase::Shutdown(const FunctionCallbackInfo<Value>& args) {\n   return Shutdown(req_wrap_obj);\n }\n \n-inline void SetWriteResultPropertiesOnWrapObject(\n-    Environment* env,\n-    Local<Object> req_wrap_obj,\n-    const StreamWriteResult& res) {\n-  req_wrap_obj->Set(\n-      env->context(),\n-      env->bytes_string(),\n-      Number::New(env->isolate(), res.bytes)).FromJust();\n-  req_wrap_obj->Set(\n-      env->context(),\n-      env->async(),\n-      Boolean::New(env->isolate(), res.async)).FromJust();\n+void StreamBase::SetWriteResult(const StreamWriteResult& res) {\n+  env_->stream_base_state()[kBytesWritten] = res.bytes;\n+  env_->stream_base_state()[kLastWriteWasAsync] = res.async;\n }\n \n int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n@@ -160,7 +149,7 @@ int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   StreamWriteResult res = Write(*bufs, count, nullptr, req_wrap_obj);\n-  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res);\n+  SetWriteResult(res);\n   if (res.wrap != nullptr && storage_size > 0) {\n     res.wrap->SetAllocatedStorage(storage.release(), storage_size);\n   }\n@@ -185,10 +174,7 @@ int StreamBase::WriteBuffer(const FunctionCallbackInfo<Value>& args) {\n   buf.len = Buffer::Length(args[1]);\n \n   StreamWriteResult res = Write(&buf, 1, nullptr, req_wrap_obj);\n-\n-  if (res.async)\n-    req_wrap_obj->Set(env->context(), env->buffer_string(), args[1]).FromJust();\n-  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res);\n+  SetWriteResult(res);\n \n   return res.err;\n }\n@@ -247,12 +233,7 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n \n     // Immediate failure or success\n     if (err != 0 || count == 0) {\n-      req_wrap_obj->Set(env->context(), env->async(), False(env->isolate()))\n-          .FromJust();\n-      req_wrap_obj->Set(env->context(),\n-                        env->bytes_string(),\n-                        Integer::NewFromUnsigned(env->isolate(), data_size))\n-          .FromJust();\n+      SetWriteResult(StreamWriteResult { false, err, nullptr, data_size });\n       return err;\n     }\n \n@@ -295,7 +276,7 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n   StreamWriteResult res = Write(&buf, 1, send_handle, req_wrap_obj);\n   res.bytes += synchronously_written;\n \n-  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res);\n+  SetWriteResult(res);\n   if (res.wrap != nullptr) {\n     res.wrap->SetAllocatedStorage(data.release(), data_size);\n   }"
        },
        {
            "sha": "063c8714fd8eb88add730edbe13b6cb534e90e1a",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -332,13 +332,17 @@ class StreamBase : public StreamResource {\n   enum StreamBaseStateFields {\n     kReadBytesOrError,\n     kArrayBufferOffset,\n+    kBytesWritten,\n+    kLastWriteWasAsync,\n     kNumStreamBaseStateFields\n   };\n \n  private:\n   Environment* env_;\n   EmitToJSStreamListener default_listener_;\n \n+  void SetWriteResult(const StreamWriteResult& res);\n+\n   friend class WriteWrap;\n   friend class ShutdownWrap;\n   friend class Environment;  // For kNumStreamBaseStateFields."
        },
        {
            "sha": "dac5ebdeb32211821f8faade7b2625d6d31788dc",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -83,6 +83,8 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n \n   NODE_DEFINE_CONSTANT(target, kReadBytesOrError);\n   NODE_DEFINE_CONSTANT(target, kArrayBufferOffset);\n+  NODE_DEFINE_CONSTANT(target, kBytesWritten);\n+  NODE_DEFINE_CONSTANT(target, kLastWriteWasAsync);\n   target->Set(context, FIXED_ONE_BYTE_STRING(env->isolate(), \"streamBaseState\"),\n               env->stream_base_state().GetJSArray()).FromJust();\n }"
        },
        {
            "sha": "851a0b3fbc2118b951f9b1d53f81ed3b23df01ab",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f01518edfd83e2235d84485d87621e61f675b4a7/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/f01518edfd83e2235d84485d87621e61f675b4a7/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=f01518edfd83e2235d84485d87621e61f675b4a7",
            "patch": "@@ -239,7 +239,7 @@ if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n       const err = handle.writeLatin1String(wreq, 'hi'.repeat(100000));\n       if (err)\n         throw new Error(`write failed: ${getSystemErrorName(err)}`);\n-      if (!wreq.async) {\n+      if (!stream_wrap.streamBaseState[stream_wrap.kLastWriteWasAsync]) {\n         testUninitialized(wreq, 'WriteWrap');\n         // Synchronous finish. Write more data until we hit an\n         // asynchronous write."
        }
    ],
    "stats": {
        "total": 78,
        "additions": 41,
        "deletions": 37
    }
}