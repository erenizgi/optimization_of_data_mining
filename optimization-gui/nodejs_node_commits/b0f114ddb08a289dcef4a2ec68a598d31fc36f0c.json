{
    "author": "devsnek",
    "message": "loader: fix up #18394\n\nThis commit fixes up some issues in #18394.\n\n* Switch vm.Module internals to use the new link method properly\n* Fix bug with ModuleWrap::Link\n* Add tests for ModuleWrap::Link\n\nPR-URL: https://github.com/nodejs/node/pull/18509\nFixes: https://github.com/nodejs/node/issues/18249\nRefs: https://github.com/nodejs/node/pull/18394\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
    "files": [
        {
            "sha": "b2b11daead7ddeb59f5e63332fba036bc86a49a1",
            "filename": "lib/internal/loader/ModuleWrap.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/lib%2Finternal%2Floader%2FModuleWrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/lib%2Finternal%2Floader%2FModuleWrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Floader%2FModuleWrap.js?ref=b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
            "patch": "@@ -0,0 +1,5 @@\n+'use strict';\n+\n+// exposes ModuleWrap for testing\n+\n+module.exports = internalBinding('module_wrap').ModuleWrap;"
        },
        {
            "sha": "a8fb7303aec13142acf8dd948b02e08a1e9237aa",
            "filename": "lib/internal/vm/Module.js",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/lib%2Finternal%2Fvm%2FModule.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/lib%2Finternal%2Fvm%2FModule.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvm%2FModule.js?ref=b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
            "patch": "@@ -8,6 +8,7 @@ const {\n   getConstructorOf,\n   customInspectSymbol,\n } = require('internal/util');\n+const { SafePromise } = require('internal/safe_globals');\n \n const {\n   ModuleWrap,\n@@ -131,27 +132,26 @@ class Module {\n     const wrap = wrapMap.get(this);\n     if (wrap.getStatus() !== kUninstantiated)\n       throw new errors.Error('ERR_VM_MODULE_STATUS', 'must be uninstantiated');\n+\n     linkingStatusMap.set(this, 'linking');\n-    const promises = [];\n-    wrap.link((specifier) => {\n-      const p = (async () => {\n-        const m = await linker(specifier, this);\n-        if (!m || !wrapMap.has(m))\n-          throw new errors.Error('ERR_VM_MODULE_NOT_MODULE');\n-        if (m.context !== this.context)\n-          throw new errors.Error('ERR_VM_MODULE_DIFFERENT_CONTEXT');\n-        const childLinkingStatus = linkingStatusMap.get(m);\n-        if (childLinkingStatus === 'errored')\n-          throw new errors.Error('ERR_VM_MODULE_LINKING_ERRORED');\n-        if (childLinkingStatus === 'unlinked')\n-          await m.link(linker);\n-        return wrapMap.get(m);\n-      })();\n-      promises.push(p);\n-      return p;\n+\n+    const promises = wrap.link(async (specifier) => {\n+      const m = await linker(specifier, this);\n+      if (!m || !wrapMap.has(m))\n+        throw new errors.Error('ERR_VM_MODULE_NOT_MODULE');\n+      if (m.context !== this.context)\n+        throw new errors.Error('ERR_VM_MODULE_DIFFERENT_CONTEXT');\n+      const childLinkingStatus = linkingStatusMap.get(m);\n+      if (childLinkingStatus === 'errored')\n+        throw new errors.Error('ERR_VM_MODULE_LINKING_ERRORED');\n+      if (childLinkingStatus === 'unlinked')\n+        await m.link(linker);\n+      return wrapMap.get(m);\n     });\n+\n     try {\n-      await Promise.all(promises);\n+      if (promises !== undefined)\n+        await SafePromise.all(promises);\n       linkingStatusMap.set(this, 'linked');\n     } catch (err) {\n       linkingStatusMap.set(this, 'errored');"
        },
        {
            "sha": "9c398284939b506e1c83cf90f7194c0cffea02cd",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
            "patch": "@@ -107,6 +107,7 @@\n       'lib/internal/loader/DefaultResolve.js',\n       'lib/internal/loader/ModuleJob.js',\n       'lib/internal/loader/ModuleMap.js',\n+      'lib/internal/loader/ModuleWrap.js',\n       'lib/internal/loader/Translators.js',\n       'lib/internal/safe_globals.js',\n       'lib/internal/net.js',"
        },
        {
            "sha": "4a9c847a6a08361511c6d397f39c7306f0ad7eb4",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
            "patch": "@@ -209,7 +209,7 @@ void ModuleWrap::Link(const FunctionCallbackInfo<Value>& args) {\n     Local<Promise> resolve_promise = resolve_return_value.As<Promise>();\n     obj->resolve_cache_[specifier_std].Reset(env->isolate(), resolve_promise);\n \n-    promises->Set(mod_context, specifier, resolve_promise).FromJust();\n+    promises->Set(mod_context, i, resolve_promise).FromJust();\n   }\n \n   args.GetReturnValue().Set(promises);"
        },
        {
            "sha": "634d1ebc6f678e0b7aca41507ce473834ff45fcd",
            "filename": "test/parallel/test-internal-module-wrap.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/test%2Fparallel%2Ftest-internal-module-wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/b0f114ddb08a289dcef4a2ec68a598d31fc36f0c/test%2Fparallel%2Ftest-internal-module-wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-module-wrap.js?ref=b0f114ddb08a289dcef4a2ec68a598d31fc36f0c",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+\n+const common = require('../common');\n+common.crashOnUnhandledRejection();\n+const assert = require('assert');\n+\n+const ModuleWrap = require('internal/loader/ModuleWrap');\n+const { getPromiseDetails, isPromise } = process.binding('util');\n+const setTimeoutAsync = require('util').promisify(setTimeout);\n+\n+const foo = new ModuleWrap('export * from \"bar\"; 6;', 'foo');\n+const bar = new ModuleWrap('export const five = 5', 'bar');\n+\n+(async () => {\n+  const promises = foo.link(() => setTimeoutAsync(1000).then(() => bar));\n+  assert.strictEqual(promises.length, 1);\n+  assert(isPromise(promises[0]));\n+\n+  await Promise.all(promises);\n+\n+  assert.strictEqual(getPromiseDetails(promises[0])[1], bar);\n+\n+  foo.instantiate();\n+\n+  assert.strictEqual(await foo.evaluate(), 6);\n+  assert.strictEqual(foo.namespace().five, 5);\n+})();"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 54,
        "deletions": 19
    }
}