{
    "author": "jasnell",
    "message": "trace_events: add process_name metadata\n\nPR-URL: https://github.com/nodejs/node/pull/21477\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "67053568eee71a887578029ee715e3cef595c429",
    "files": [
        {
            "sha": "4fb793705bd7132eb30ffb1117514fc8d87bc1c7",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/67053568eee71a887578029ee715e3cef595c429/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/67053568eee71a887578029ee715e3cef595c429/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=67053568eee71a887578029ee715e3cef595c429",
            "patch": "@@ -1665,6 +1665,8 @@ static void ProcessTitleSetter(Local<Name> property,\n                                Local<Value> value,\n                                const PropertyCallbackInfo<void>& info) {\n   node::Utf8Value title(info.GetIsolate(), value);\n+  TRACE_EVENT_METADATA1(\"__metadata\", \"process_name\", \"name\",\n+                        TRACE_STR_COPY(*title));\n   uv_set_process_title(*title);\n }\n \n@@ -3525,6 +3527,13 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Environment env(isolate_data, context, v8_platform.GetTracingAgent());\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n+  char name_buffer[512];\n+  if (uv_get_process_title(name_buffer, sizeof(name_buffer)) == 0) {\n+    // Only emit the metadata event if the title can be retrieved successfully.\n+    // Ignore it otherwise.\n+    TRACE_EVENT_METADATA1(\"__metadata\", \"process_name\", \"name\",\n+                          TRACE_STR_COPY(name_buffer));\n+  }\n   TRACE_EVENT_METADATA1(\"__metadata\", \"version\", \"node\", NODE_VERSION_STRING);\n   TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\", \"name\",\n                         \"JavaScriptMainThread\");"
        },
        {
            "sha": "7f9ccc3c7378d53e92ddd7231b031f4fce869bd7",
            "filename": "test/parallel/test-trace-events-metadata.js",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/67053568eee71a887578029ee715e3cef595c429/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/67053568eee71a887578029ee715e3cef595c429/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-metadata.js?ref=67053568eee71a887578029ee715e3cef595c429",
            "patch": "@@ -8,7 +8,8 @@ if (!common.isMainThread)\n   common.skip('process.chdir is not available in Workers');\n \n const CODE =\n-  'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1)';\n+  'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1);' +\n+  'process.title = \"foo\"';\n const FILE_NAME = 'node_trace.1.log';\n \n const tmpdir = require('../common/tmpdir');\n@@ -17,6 +18,7 @@ process.chdir(tmpdir.path);\n \n const proc = cp.spawn(process.execPath,\n                       [ '--trace-event-categories', 'node.perf.usertiming',\n+                        '--title=bar',\n                         '-e', CODE ]);\n proc.once('exit', common.mustCall(() => {\n   assert(common.fileExists(FILE_NAME));\n@@ -32,5 +34,14 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) =>\n       trace.cat === '__metadata' && trace.name === 'version' &&\n         trace.args.node === process.versions.node));\n+    if (!common.isSunOS) {\n+      // Changing process.title is currently unsupported on SunOS/SmartOS\n+      assert(traces.some((trace) =>\n+        trace.cat === '__metadata' && trace.name === 'process_name' &&\n+          trace.args.name === 'foo'));\n+      assert(traces.some((trace) =>\n+        trace.cat === '__metadata' && trace.name === 'process_name' &&\n+          trace.args.name === 'bar'));\n+    }\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 21,
        "deletions": 1
    }
}