{
    "author": "addaleax",
    "message": "net: simplify Socket.prototype._final\n\nRemove conditions that should be irrelevant since we started\nusing `_final`, as well as an extra `defaultTriggerAsyncIdScope()`\ncall which is unnecessary because there is an equivalent\nscope already present on the native side.\n\nPR-URL: https://github.com/nodejs/node/pull/24075\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "b7e6ccd0cc60f20cc397e6ac0705bb3f38c7d225",
    "files": [
        {
            "sha": "5d332d9e1d30d73457e5bd5a323c790129071648",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 8,
            "deletions": 23,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/b7e6ccd0cc60f20cc397e6ac0705bb3f38c7d225/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/b7e6ccd0cc60f20cc397e6ac0705bb3f38c7d225/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=b7e6ccd0cc60f20cc397e6ac0705bb3f38c7d225",
            "patch": "@@ -336,14 +336,6 @@ Socket.prototype._unrefTimer = function _unrefTimer() {\n };\n \n \n-function shutdownSocket(self, callback) {\n-  var req = new ShutdownWrap();\n-  req.oncomplete = afterShutdown;\n-  req.handle = self._handle;\n-  req.callback = callback;\n-  return self._handle.shutdown(req);\n-}\n-\n // the user has called .end(), and all the bytes have been\n // sent out to the other side.\n Socket.prototype._final = function(cb) {\n@@ -353,23 +345,16 @@ Socket.prototype._final = function(cb) {\n     return this.once('connect', () => this._final(cb));\n   }\n \n-  if (!this.readable || this._readableState.ended) {\n-    debug('_final: ended, destroy', this._readableState);\n-    cb();\n-    return this.destroy();\n-  }\n+  if (!this._handle)\n+    return cb();\n \n   debug('_final: not ended, call shutdown()');\n \n-  // otherwise, just shutdown, or destroy() if not possible\n-  if (!this._handle || !this._handle.shutdown) {\n-    cb();\n-    return this.destroy();\n-  }\n-\n-  var err = defaultTriggerAsyncIdScope(\n-    this[async_id_symbol], shutdownSocket, this, cb\n-  );\n+  var req = new ShutdownWrap();\n+  req.oncomplete = afterShutdown;\n+  req.handle = this._handle;\n+  req.callback = cb;\n+  var err = this._handle.shutdown(req);\n \n   if (err)\n     return this.destroy(errnoException(err, 'shutdown'));\n@@ -388,7 +373,7 @@ function afterShutdown(status, handle) {\n   if (self.destroyed)\n     return;\n \n-  if (self._readableState.ended) {\n+  if (!self.readable || self._readableState.ended) {\n     debug('readableState ended, destroying');\n     self.destroy();\n   }"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 8,
        "deletions": 23
    }
}