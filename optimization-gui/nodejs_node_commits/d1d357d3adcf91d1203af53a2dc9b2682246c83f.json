{
    "author": "apapirovski",
    "message": "test: fix sequential/test-performance delay\n\nPR-URL: https://github.com/nodejs/node/pull/25695\nFixes: https://github.com/nodejs/node/issues/23291\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "d1d357d3adcf91d1203af53a2dc9b2682246c83f",
    "files": [
        {
            "sha": "825cf85ef5a0597829c3702dd31df6e9a5173af3",
            "filename": "test/sequential/test-performance.js",
            "status": "modified",
            "additions": 20,
            "deletions": 47,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/d1d357d3adcf91d1203af53a2dc9b2682246c83f/test%2Fsequential%2Ftest-performance.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1d357d3adcf91d1203af53a2dc9b2682246c83f/test%2Fsequential%2Ftest-performance.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-performance.js?ref=d1d357d3adcf91d1203af53a2dc9b2682246c83f",
            "patch": "@@ -56,42 +56,17 @@ assert(inited < 15000);\n assert.strictEqual(performance.nodeTiming.name, 'node');\n assert.strictEqual(performance.nodeTiming.entryType, 'node');\n \n-let timeoutDelay = 111; // An extra of 111 ms for the first call.\n-\n-function checkDelay(cb) {\n-  const defaultTimeout = 1;\n-  const timer = setInterval(checkDelay, defaultTimeout);\n-  const timeouts = 10;\n-\n-  const now = getTime();\n-  let resolved = 0;\n-\n-  function checkDelay() {\n-    resolved++;\n-    if (resolved === timeouts) {\n-      clearInterval(timer);\n-      timeoutDelay = getTime() - now;\n-      cb();\n-    }\n-  }\n-}\n-\n-function getTime() {\n-  const ts = process.hrtime();\n-  return Math.ceil((ts[0] * 1e3) + (ts[1] / 1e6));\n-}\n-\n+const delay = 250;\n function checkNodeTiming(props) {\n   console.log(props);\n \n   for (const prop of Object.keys(props)) {\n     if (props[prop].around !== undefined) {\n       assert.strictEqual(typeof performance.nodeTiming[prop], 'number');\n       const delta = performance.nodeTiming[prop] - props[prop].around;\n-      const delay = 1000 + timeoutDelay;\n       assert(\n-        Math.abs(delta) < delay,\n-        `${prop}: ${Math.abs(delta)} >= ${delay}`\n+        Math.abs(delta) < (props[prop].delay || delay),\n+        `${prop}: ${Math.abs(delta)} >= ${props[prop].delay || delay}`\n       );\n     } else {\n       assert.strictEqual(performance.nodeTiming[prop], props[prop],\n@@ -108,28 +83,26 @@ checkNodeTiming({\n   duration: { around: performance.now() },\n   nodeStart: { around: 0 },\n   v8Start: { around: 0 },\n-  bootstrapComplete: { around: inited },\n+  bootstrapComplete: { around: inited, delay: 2500 },\n   environment: { around: 0 },\n   loopStart: -1,\n   loopExit: -1\n });\n \n-checkDelay(() => {\n-  setTimeout(() => {\n-    checkNodeTiming({\n-      name: 'node',\n-      entryType: 'node',\n-      startTime: 0,\n-      duration: { around: performance.now() },\n-      nodeStart: { around: 0 },\n-      v8Start: { around: 0 },\n-      bootstrapComplete: { around: inited },\n-      environment: { around: 0 },\n-      loopStart: { around: inited },\n-      loopExit: -1\n-    });\n-  }, 1000);\n-});\n+setTimeout(() => {\n+  checkNodeTiming({\n+    name: 'node',\n+    entryType: 'node',\n+    startTime: 0,\n+    duration: { around: performance.now() },\n+    nodeStart: { around: 0 },\n+    v8Start: { around: 0 },\n+    bootstrapComplete: { around: inited, delay: 2500 },\n+    environment: { around: 0 },\n+    loopStart: { around: inited, delay: 2500 },\n+    loopExit: -1\n+  });\n+}, 1000);\n \n process.on('exit', () => {\n   checkNodeTiming({\n@@ -139,9 +112,9 @@ process.on('exit', () => {\n     duration: { around: performance.now() },\n     nodeStart: { around: 0 },\n     v8Start: { around: 0 },\n-    bootstrapComplete: { around: inited },\n+    bootstrapComplete: { around: inited, delay: 2500 },\n     environment: { around: 0 },\n-    loopStart: { around: inited },\n+    loopStart: { around: inited, delay: 2500 },\n     loopExit: { around: performance.now() }\n   });\n });"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 20,
        "deletions": 47
    }
}