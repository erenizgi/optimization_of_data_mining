{
    "author": "addaleax",
    "message": "worker: copy transferList ArrayBuffers on unknown allocator\n\nIf the `ArrayBuffer::Allocator` used to create `ArrayBuffer`s\nin the current `Isolate` is not a Node.js `ArrayBufferAllocator`,\nwe cannot know that it is `malloc()`-based, an in particular it might\nnot be compatible with the `ArrayBuffer::Allocator` on the receiving\nend of the connection.\n\nPR-URL: https://github.com/nodejs/node/pull/26207\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "a8ba838e1a94c17ecf7a290c1951040d2957cb62",
    "files": [
        {
            "sha": "c659ac06f1d41dde9566750d01c632a1951be166",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/a8ba838e1a94c17ecf7a290c1951040d2957cb62/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a8ba838e1a94c17ecf7a290c1951040d2957cb62/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=a8ba838e1a94c17ecf7a290c1951040d2957cb62",
            "patch": "@@ -132,6 +132,18 @@ MaybeLocal<Value> Message::Deserialize(Environment* env,\n \n   // Attach all transferred ArrayBuffers to their new Isolate.\n   for (uint32_t i = 0; i < array_buffer_contents_.size(); ++i) {\n+    if (!env->isolate_data()->uses_node_allocator()) {\n+      // We don't use Node's allocator on the receiving side, so we have\n+      // to create the ArrayBuffer from a copy of the memory.\n+      AllocatedBuffer buf =\n+          env->AllocateManaged(array_buffer_contents_[i].size);\n+      memcpy(buf.data(),\n+             array_buffer_contents_[i].data,\n+             array_buffer_contents_[i].size);\n+      deserializer.TransferArrayBuffer(i, buf.ToArrayBuffer());\n+      continue;\n+    }\n+\n     Local<ArrayBuffer> ab =\n         ArrayBuffer::New(env->isolate(),\n                          array_buffer_contents_[i].release(),\n@@ -288,8 +300,10 @@ Maybe<bool> Message::Serialize(Environment* env,\n         Local<ArrayBuffer> ab = entry.As<ArrayBuffer>();\n         // If we cannot render the ArrayBuffer unusable in this Isolate and\n         // take ownership of its memory, copying the buffer will have to do.\n-        if (!ab->IsNeuterable() || ab->IsExternal())\n+        if (!ab->IsNeuterable() || ab->IsExternal() ||\n+            !env->isolate_data()->uses_node_allocator()) {\n           continue;\n+        }\n         if (std::find(array_buffers.begin(), array_buffers.end(), ab) !=\n             array_buffers.end()) {\n           ThrowDataCloneException("
        }
    ],
    "stats": {
        "total": 16,
        "additions": 15,
        "deletions": 1
    }
}