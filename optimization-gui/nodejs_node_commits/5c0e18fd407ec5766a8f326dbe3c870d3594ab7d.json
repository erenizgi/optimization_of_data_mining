{
    "author": "addaleax",
    "message": "src: make IsolateData store ArrayBufferAllocator\n\nThis enables us to identify whether we are using an\nallocator that we know more about than what the generic\n`ArrayBuffer::Allocator` API provides, in particular\nwhether it is `malloc()`-compatible.\n\nPR-URL: https://github.com/nodejs/node/pull/26207\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "5c0e18fd407ec5766a8f326dbe3c870d3594ab7d",
    "files": [
        {
            "sha": "7b6de8ba8dc3676e7f179c5e555ca718c559290e",
            "filename": "src/api/environment.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fapi%2Fenvironment.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fapi%2Fenvironment.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fapi%2Fenvironment.cc?ref=5c0e18fd407ec5766a8f326dbe3c870d3594ab7d",
            "patch": "@@ -124,11 +124,7 @@ IsolateData* CreateIsolateData(Isolate* isolate,\n                                uv_loop_t* loop,\n                                MultiIsolatePlatform* platform,\n                                ArrayBufferAllocator* allocator) {\n-  return new IsolateData(\n-      isolate,\n-      loop,\n-      platform,\n-      allocator != nullptr ? allocator->zero_fill_field() : nullptr);\n+  return new IsolateData(isolate, loop, platform, allocator);\n }\n \n void FreeIsolateData(IsolateData* isolate_data) {"
        },
        {
            "sha": "51c7e0d7b06561a37b37b62f6c1e45619ddf11fe",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=5c0e18fd407ec5766a8f326dbe3c870d3594ab7d",
            "patch": "@@ -49,8 +49,16 @@ inline uv_loop_t* IsolateData::event_loop() const {\n   return event_loop_;\n }\n \n-inline uint32_t* IsolateData::zero_fill_field() const {\n-  return zero_fill_field_;\n+inline bool IsolateData::uses_node_allocator() const {\n+  return uses_node_allocator_;\n+}\n+\n+inline v8::ArrayBuffer::Allocator* IsolateData::allocator() const {\n+  return allocator_;\n+}\n+\n+inline ArrayBufferAllocator* IsolateData::node_allocator() const {\n+  return node_allocator_;\n }\n \n inline MultiIsolatePlatform* IsolateData::platform() const {"
        },
        {
            "sha": "b7b6d745d8a231d4cf8b7d72dbf4565b7886be89",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=5c0e18fd407ec5766a8f326dbe3c870d3594ab7d",
            "patch": "@@ -74,11 +74,14 @@ void* const Environment::kNodeContextTagPtr = const_cast<void*>(\n IsolateData::IsolateData(Isolate* isolate,\n                          uv_loop_t* event_loop,\n                          MultiIsolatePlatform* platform,\n-                         uint32_t* zero_fill_field) :\n-    isolate_(isolate),\n-    event_loop_(event_loop),\n-    zero_fill_field_(zero_fill_field),\n-    platform_(platform) {\n+                         ArrayBufferAllocator* node_allocator)\n+    : isolate_(isolate),\n+      event_loop_(event_loop),\n+      allocator_(isolate->GetArrayBufferAllocator()),\n+      node_allocator_(node_allocator),\n+      uses_node_allocator_(allocator_ == node_allocator_),\n+      platform_(platform) {\n+  CHECK_NOT_NULL(allocator_);\n   if (platform_ != nullptr)\n     platform_->RegisterIsolate(isolate_, event_loop);\n "
        },
        {
            "sha": "527a28f6957fd86dda1b971582dabc446a1968de",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c0e18fd407ec5766a8f326dbe3c870d3594ab7d/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5c0e18fd407ec5766a8f326dbe3c870d3594ab7d",
            "patch": "@@ -394,16 +394,20 @@ class Environment;\n \n class IsolateData {\n  public:\n-  IsolateData(v8::Isolate* isolate, uv_loop_t* event_loop,\n+  IsolateData(v8::Isolate* isolate,\n+              uv_loop_t* event_loop,\n               MultiIsolatePlatform* platform = nullptr,\n-              uint32_t* zero_fill_field = nullptr);\n+              ArrayBufferAllocator* node_allocator = nullptr);\n   ~IsolateData();\n   inline uv_loop_t* event_loop() const;\n-  inline uint32_t* zero_fill_field() const;\n   inline MultiIsolatePlatform* platform() const;\n   inline std::shared_ptr<PerIsolateOptions> options();\n   inline void set_options(std::shared_ptr<PerIsolateOptions> options);\n \n+  inline bool uses_node_allocator() const;\n+  inline v8::ArrayBuffer::Allocator* allocator() const;\n+  inline ArrayBufferAllocator* node_allocator() const;\n+\n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n #define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n@@ -436,7 +440,9 @@ class IsolateData {\n \n   v8::Isolate* const isolate_;\n   uv_loop_t* const event_loop_;\n-  uint32_t* const zero_fill_field_;\n+  v8::ArrayBuffer::Allocator* const allocator_;\n+  ArrayBufferAllocator* const node_allocator_;\n+  const bool uses_node_allocator_;\n   MultiIsolatePlatform* platform_;\n   std::shared_ptr<PerIsolateOptions> options_;\n "
        }
    ],
    "stats": {
        "total": 45,
        "additions": 29,
        "deletions": 16
    }
}