{
    "author": "addaleax",
    "message": "worker: use fake MessageEvent for port.onmessage\n\nInstead of passing the payload for Workers directly to `.onmessage`,\nperform something more similar to what the browser API provides,\nnamely create an event object with a `.data` property.\n\nThis does not make `MessagePort` implement the `EventTarget` API, nor\ndoes it implement the full `MessageEvent` API, but it would make\nsuch extensions non-breaking changes if we desire them at\nsome point in the future.\n\n(This would be a breaking change if Workers were not experimental.\nCurrently, this method is also undocumented and only exists with\nthe idea of enabling some degree of Web compatibility.)\n\nPR-URL: https://github.com/nodejs/node/pull/26082\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "5adda2c44748ace543447da8844b9b08965e402b",
    "files": [
        {
            "sha": "a72868916ca6ccc1b9c98b514c5a0bbc1756b591",
            "filename": "lib/internal/worker/io.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/lib%2Finternal%2Fworker%2Fio.js",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/lib%2Finternal%2Fworker%2Fio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker%2Fio.js?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -61,11 +61,11 @@ MessagePort.prototype.unref = MessagePortPrototype.unref;\n // uv_async_t) which can receive information from other threads and emits\n // .onmessage events, and a function used for sending data to a MessagePort\n // in some other thread.\n-MessagePort.prototype[kOnMessageListener] = function onmessage(payload) {\n-  if (payload.type !== messageTypes.STDIO_WANTS_MORE_DATA)\n-    debug(`[${threadId}] received message`, payload);\n+MessagePort.prototype[kOnMessageListener] = function onmessage(event) {\n+  if (event.data && event.data.type !== messageTypes.STDIO_WANTS_MORE_DATA)\n+    debug(`[${threadId}] received message`, event);\n   // Emit the deserialized object to userland.\n-  this.emit('message', payload);\n+  this.emit('message', event.data);\n };\n \n // This is for compatibility with the Web's MessagePort API. It makes sense to"
        },
        {
            "sha": "5cf2ee2c8b493e3876dff9777e937624ccd90e2c",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -146,6 +146,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(crypto_ec_string, \"ec\")                                                    \\\n   V(crypto_rsa_string, \"rsa\")                                                  \\\n   V(cwd_string, \"cwd\")                                                         \\\n+  V(data_string, \"data\")                                                       \\\n   V(dest_string, \"dest\")                                                       \\\n   V(destroyed_string, \"destroyed\")                                             \\\n   V(detached_string, \"detached\")                                               \\\n@@ -293,6 +294,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(subject_string, \"subject\")                                                 \\\n   V(subjectaltname_string, \"subjectaltname\")                                   \\\n   V(syscall_string, \"syscall\")                                                 \\\n+  V(target_string, \"target\")                                                   \\\n   V(thread_id_string, \"threadId\")                                              \\\n   V(ticketkeycallback_string, \"onticketkeycallback\")                           \\\n   V(timeout_string, \"timeout\")                                                 \\\n@@ -361,6 +363,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(inspector_console_extension_installer, v8::Function)                       \\\n   V(libuv_stream_wrap_ctor_template, v8::FunctionTemplate)                     \\\n   V(message_port, v8::Object)                                                  \\\n+  V(message_event_object_template, v8::ObjectTemplate)                         \\\n   V(message_port_constructor_template, v8::FunctionTemplate)                   \\\n   V(native_module_require, v8::Function)                                       \\\n   V(performance_entry_callback, v8::Function)                                  \\"
        },
        {
            "sha": "62f333bab0db98df545faee12607b457b18a92bc",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -25,6 +25,7 @@ using v8::Maybe;\n using v8::MaybeLocal;\n using v8::Nothing;\n using v8::Object;\n+using v8::ObjectTemplate;\n using v8::SharedArrayBuffer;\n using v8::String;\n using v8::Value;\n@@ -589,12 +590,19 @@ void MessagePort::OnMessage() {\n       // Call the JS .onmessage() callback.\n       HandleScope handle_scope(env()->isolate());\n       Context::Scope context_scope(context);\n-      Local<Value> args[] = {\n-        received.Deserialize(env(), context).FromMaybe(Local<Value>())\n-      };\n \n-      if (args[0].IsEmpty() ||\n-          MakeCallback(env()->onmessage_string(), 1, args).IsEmpty()) {\n+      Local<Object> event;\n+      Local<Value> payload;\n+      Local<Value> cb_args[1];\n+      if (!received.Deserialize(env(), context).ToLocal(&payload) ||\n+          !env()->message_event_object_template()->NewInstance(context)\n+              .ToLocal(&event) ||\n+          event->Set(context, env()->data_string(), payload).IsNothing() ||\n+          event->Set(context, env()->target_string(), object()).IsNothing() ||\n+          (cb_args[0] = event, false) ||\n+          MakeCallback(env()->onmessage_string(),\n+                       arraysize(cb_args),\n+                       cb_args).IsEmpty()) {\n         // Re-schedule OnMessage() execution in case of failure.\n         if (data_)\n           TriggerAsync();\n@@ -763,6 +771,8 @@ MaybeLocal<Function> GetMessagePortConstructor(\n   if (!templ.IsEmpty())\n     return templ->GetFunction(context);\n \n+  Isolate* isolate = env->isolate();\n+\n   {\n     Local<FunctionTemplate> m = env->NewFunctionTemplate(MessagePort::New);\n     m->SetClassName(env->message_port_constructor_string());\n@@ -775,6 +785,13 @@ MaybeLocal<Function> GetMessagePortConstructor(\n     env->SetProtoMethod(m, \"drain\", MessagePort::Drain);\n \n     env->set_message_port_constructor_template(m);\n+\n+    Local<FunctionTemplate> event_ctor = FunctionTemplate::New(isolate);\n+    event_ctor->SetClassName(FIXED_ONE_BYTE_STRING(isolate, \"MessageEvent\"));\n+    Local<ObjectTemplate> e = event_ctor->InstanceTemplate();\n+    e->Set(env->data_string(), Null(isolate));\n+    e->Set(env->target_string(), Null(isolate));\n+    env->set_message_event_object_template(e);\n   }\n \n   return GetMessagePortConstructor(env, context);"
        },
        {
            "sha": "f02f06eaaea53f58f5bf898551f9c0c279cc4bd0",
            "filename": "test/parallel/test-worker-message-port-transfer-self.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -25,7 +25,7 @@ assert.throws(common.mustCall(() => {\n \n // The failed transfer should not affect the ports in anyway.\n port2.onmessage = common.mustCall((message) => {\n-  assert.strictEqual(message, 2);\n+  assert.strictEqual(message.data, 2);\n \n   const inspectedPort1 = util.inspect(port1);\n   const inspectedPort2 = util.inspect(port2);"
        },
        {
            "sha": "dce9da0b3063f52ca2890362ea05fd6fbe3f5de9",
            "filename": "test/parallel/test-worker-message-port.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-message-port.js",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-message-port.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port.js?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -21,14 +21,15 @@ const { MessageChannel, MessagePort } = require('worker_threads');\n   const { port1, port2 } = new MessageChannel();\n \n   port1.onmessage = common.mustCall((message) => {\n-    assert.strictEqual(message, 4);\n+    assert.strictEqual(message.data, 4);\n+    assert.strictEqual(message.target, port1);\n     port2.close(common.mustCall());\n   });\n \n   port1.postMessage(2);\n \n   port2.onmessage = common.mustCall((message) => {\n-    port2.postMessage(message * 2);\n+    port2.postMessage(message.data * 2);\n   });\n }\n "
        },
        {
            "sha": "f315b0d2019a9a9507b15ba75515e21614482a26",
            "filename": "test/parallel/test-worker-onmessage.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-onmessage.js",
            "raw_url": "https://github.com/nodejs/node/raw/5adda2c44748ace543447da8844b9b08965e402b/test%2Fparallel%2Ftest-worker-onmessage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-onmessage.js?ref=5adda2c44748ace543447da8844b9b08965e402b",
            "patch": "@@ -14,6 +14,6 @@ if (!process.env.HAS_STARTED_WORKER) {\n   w.postMessage(2);\n } else {\n   parentPort.onmessage = common.mustCall((message) => {\n-    parentPort.postMessage(message * 2);\n+    parentPort.postMessage(message.data * 2);\n   });\n }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 34,
        "deletions": 13
    }
}