{
    "author": "jasnell",
    "message": "http2: explicitly disallow nested push streams\n\nFixes: https://github.com/nodejs/node/issues/19095\n\nPR-URL: https://github.com/nodejs/node/pull/22245\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "78584b64d88c0567c46e3cf7bae42aa73927df40",
    "files": [
        {
            "sha": "e4a709d45a8031f55042f61904667126591b09c2",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/78584b64d88c0567c46e3cf7bae42aa73927df40/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/78584b64d88c0567c46e3cf7bae42aa73927df40/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=78584b64d88c0567c46e3cf7bae42aa73927df40",
            "patch": "@@ -956,6 +956,12 @@ required to send an acknowledgment that it has received and applied the new\n be sent at any given time. This error code is used when that limit has been\n reached.\n \n+<a id=\"ERR_HTTP2_NESTED_PUSH\"></a>\n+### ERR_HTTP2_NESTED_PUSH\n+\n+An attempt was made to initiate a new push stream from within a push stream.\n+Nested push streams are not permitted.\n+\n <a id=\"ERR_HTTP2_NO_SOCKET_MANIPULATION\"></a>\n ### ERR_HTTP2_NO_SOCKET_MANIPULATION\n "
        },
        {
            "sha": "05b5ff7718d4aacd9d7208c515e16798b391effe",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/78584b64d88c0567c46e3cf7bae42aa73927df40/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/78584b64d88c0567c46e3cf7bae42aa73927df40/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=78584b64d88c0567c46e3cf7bae42aa73927df40",
            "patch": "@@ -1256,6 +1256,9 @@ Setting the weight of a push stream is not allowed in the `HEADERS` frame. Pass\n a `weight` value to `http2stream.priority` with the `silent` option set to\n `true` to enable server-side bandwidth balancing between concurrent streams.\n \n+Calling `http2stream.pushStream()` from within a pushed stream is not permitted\n+and will throw an error.\n+\n #### http2stream.respond([headers[, options]])\n <!-- YAML\n added: v8.4.0"
        },
        {
            "sha": "89b51a4cecc9d869e523b1ac75712778b3c24897",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/78584b64d88c0567c46e3cf7bae42aa73927df40/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/78584b64d88c0567c46e3cf7bae42aa73927df40/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=78584b64d88c0567c46e3cf7bae42aa73927df40",
            "patch": "@@ -566,6 +566,8 @@ E('ERR_HTTP2_INVALID_SETTING_VALUE',\n E('ERR_HTTP2_INVALID_STREAM', 'The stream has been destroyed', Error);\n E('ERR_HTTP2_MAX_PENDING_SETTINGS_ACK',\n   'Maximum number of pending settings acknowledgements', Error);\n+E('ERR_HTTP2_NESTED_PUSH',\n+  'A push stream cannot initiate another push stream.', Error);\n E('ERR_HTTP2_NO_SOCKET_MANIPULATION',\n   'HTTP/2 sockets should not be directly manipulated (e.g. read and written)',\n   Error);"
        },
        {
            "sha": "288c97d1051294fdd8e8e8fc529b39110b62ef7f",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/78584b64d88c0567c46e3cf7bae42aa73927df40/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/78584b64d88c0567c46e3cf7bae42aa73927df40/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=78584b64d88c0567c46e3cf7bae42aa73927df40",
            "patch": "@@ -48,6 +48,7 @@ const {\n     ERR_HTTP2_INVALID_SETTING_VALUE,\n     ERR_HTTP2_INVALID_STREAM,\n     ERR_HTTP2_MAX_PENDING_SETTINGS_ACK,\n+    ERR_HTTP2_NESTED_PUSH,\n     ERR_HTTP2_NO_SOCKET_MANIPULATION,\n     ERR_HTTP2_OUT_OF_STREAMS,\n     ERR_HTTP2_PAYLOAD_FORBIDDEN,\n@@ -2159,6 +2160,8 @@ class ServerHttp2Stream extends Http2Stream {\n   pushStream(headers, options, callback) {\n     if (!this.pushAllowed)\n       throw new ERR_HTTP2_PUSH_DISABLED();\n+    if (this[kID] % 2 === 0)\n+      throw new ERR_HTTP2_NESTED_PUSH();\n \n     const session = this[kSession];\n "
        },
        {
            "sha": "69e74349475c42049b5ecdbad20ad7993fbff2bf",
            "filename": "test/parallel/test-http2-server-push-stream.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/78584b64d88c0567c46e3cf7bae42aa73927df40/test%2Fparallel%2Ftest-http2-server-push-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/78584b64d88c0567c46e3cf7bae42aa73927df40/test%2Fparallel%2Ftest-http2-server-push-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-push-stream.js?ref=78584b64d88c0567c46e3cf7bae42aa73927df40",
            "patch": "@@ -22,6 +22,14 @@ server.on('stream', common.mustCall((stream, headers) => {\n         'x-push-data': 'pushed by server',\n       });\n       push.end('pushed by server data');\n+\n+      common.expectsError(() => {\n+        push.pushStream({}, common.mustNotCall());\n+      }, {\n+        code: 'ERR_HTTP2_NESTED_PUSH',\n+        type: Error\n+      });\n+\n       stream.end('test');\n     }));\n   }"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 22,
        "deletions": 0
    }
}