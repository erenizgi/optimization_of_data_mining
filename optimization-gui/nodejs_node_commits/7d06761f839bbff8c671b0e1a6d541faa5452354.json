{
    "author": "joyeecheung",
    "message": "errors: improve SystemError messages\n\nThis commit improves the SystemError messages by allowing user\nto combine a custom message and the libuv error message. Also\nsince we now prefer use subclasses to construct the errors instead\nof using `new errors.SystemError()` directly, this removes\nthe behavior of assigning a default error code `ERR_SYSTEM_ERROR`\nto SystemError and requires the user to directly use the\n`ERR_SYSTEM_ERROR` class to construct errors instead.\n\nAlso merges `makeNodeError` into the SystemError class definition\nsince that's the only place the function gets used and it seems\nunnecessary to introduce another level of inheritance. SystemError\nnow directly inherits from Error instead of an intermmediate Error\nclass that inherits from Error.\n\nClass hierarchy before this patch:\n\nERR_SOCKET_BUFFER_SIZE -> Error (use message formatted by SystemError)\nERR_SYSTEM_ERROR -> NodeError (temp) -> Error\n\nAfter:\n\nERR_SOCKET_BUFFER_SIZE -> SystemError -> Error\nERR_TTY_INIT_FAILED -> SystemError -> Error\nERR_SYSTEM_ERROR -> SystemError -> Error\n\nError messages before this patch:\n\n```\nconst dgram = require('dgram');\nconst socket = dgram.createSocket('udp4');\nsocket.setRecvBufferSize(8192);\n\n// Error [ERR_SOCKET_BUFFER_SIZE]: Could not get or set buffer\n// size: Error [ERR_SYSTEM_ERROR]: bad file descriptor:\n// EBADF [uv_recv_buffer_size]\n//    at bufferSize (dgram.js:191:11)\n//    at Socket.setRecvBufferSize (dgram.js:689:3)\n\nconst tty = require('tty');\nnew tty.WriteStream(1 << 30);\n// Error [ERR_SYSTEM_ERROR]: invalid argument: EINVAL [uv_tty_init]\n//     at new WriteStream (tty.js:84:11)\n```\n\nAfter:\n\n```\nconst dgram = require('dgram');\nconst socket = dgram.createSocket('udp4');\nsocket.setRecvBufferSize(8192);\n\n// SystemError [ERR_SOCKET_BUFFER_SIZE]: Could not get or set buffer\n// size: uv_recv_buffer_size returned EBADF (bad file descriptor)\n//     at bufferSize (dgram.js:191:11)\n//     at Socket.setRecvBufferSize (dgram.js:689:3)\n\nconst tty = require('tty');\nnew tty.WriteStream(1 << 30);\n// SystemError [ERR_TTY_INIT_FAILED]: TTY initialization failed:\n// uv_tty_init returned EINVAL (invalid argument)\n//     at new WriteStream (tty.js:84:11)\n```\n\nPR-URL: https://github.com/nodejs/node/pull/19514\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "7d06761f839bbff8c671b0e1a6d541faa5452354",
    "files": [
        {
            "sha": "936b1b0cd5d53c2fdd02901c32eb3ce3ca79412a",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -1521,6 +1521,11 @@ A Transform stream finished while it was still transforming.\n \n A Transform stream finished with data still in the write buffer.\n \n+<a id=\"ERR_TTY_INIT_FAILED\"></a>\n+### ERR_TTY_INIT_FAILED\n+\n+The initialization of a TTY failed due to a system error.\n+\n <a id=\"ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET\"></a>\n ### ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET\n "
        },
        {
            "sha": "0a72834873e8bdcf393ecc18d60c34c68bca6fee",
            "filename": "lib/dgram.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Fdgram.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Fdgram.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdgram.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -188,7 +188,7 @@ function bufferSize(self, size, buffer) {\n   const ctx = {};\n   const ret = self._handle.bufferSize(size, buffer, ctx);\n   if (ret === undefined) {\n-    throw new ERR_SOCKET_BUFFER_SIZE(new errors.SystemError(ctx));\n+    throw new ERR_SOCKET_BUFFER_SIZE(ctx);\n   }\n   return ret;\n }"
        },
        {
            "sha": "17b6f966d42357ac902b2dbb9f4d29367071c5a4",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 115,
            "deletions": 116,
            "changes": 231,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -47,42 +47,112 @@ function inspectValue(val) {\n   ).split('\\n');\n }\n \n-function makeNodeError(Base) {\n-  return class NodeError extends Base {\n-    constructor(key, ...args) {\n-      super(message(key, args));\n-      defineProperty(this, kCode, {\n-        configurable: true,\n-        enumerable: false,\n-        value: key,\n-        writable: true\n-      });\n-    }\n+function sysErrorMessage(prefix, ctx) {\n+  let message = `${prefix}: ${ctx.syscall} returned ` +\n+                `${ctx.code} (${ctx.message})`;\n+  if (ctx.path !== undefined)\n+    message += ` ${ctx.path}`;\n+  if (ctx.dest !== undefined)\n+    message += ` => ${ctx.dest}`;\n+  return message;\n+}\n \n-    get name() {\n-      return `${super.name} [${this[kCode]}]`;\n-    }\n+// A specialized Error that includes an additional info property with\n+// additional information about the error condition.\n+// It has the properties present in a UVException but with a custom error\n+// message followed by the uv error code and uv error message.\n+// It also has its own error code with the original uv error context put into\n+// `err.info`.\n+// The context passed into this error must have .code, .syscall and .message,\n+// and may have .path and .dest.\n+class SystemError extends Error {\n+  constructor(key, context = {}) {\n+    context = context || {};\n+    super(sysErrorMessage(message(key), context));\n+    Object.defineProperty(this, kInfo, {\n+      configurable: false,\n+      enumerable: false,\n+      value: context\n+    });\n+    Object.defineProperty(this, kCode, {\n+      configurable: true,\n+      enumerable: false,\n+      value: key,\n+      writable: true\n+    });\n+  }\n \n-    set name(value) {\n-      defineProperty(this, 'name', {\n-        configurable: true,\n-        enumerable: true,\n-        value,\n-        writable: true\n-      });\n-    }\n+  get name() {\n+    return `SystemError [${this[kCode]}]`;\n+  }\n \n-    get code() {\n-      return this[kCode];\n-    }\n+  set name(value) {\n+    defineProperty(this, 'name', {\n+      configurable: true,\n+      enumerable: true,\n+      value,\n+      writable: true\n+    });\n+  }\n \n-    set code(value) {\n-      defineProperty(this, 'code', {\n-        configurable: true,\n-        enumerable: true,\n-        value,\n-        writable: true\n-      });\n+  get code() {\n+    return this[kCode];\n+  }\n+\n+  set code(value) {\n+    defineProperty(this, 'code', {\n+      configurable: true,\n+      enumerable: true,\n+      value,\n+      writable: true\n+    });\n+  }\n+\n+  get info() {\n+    return this[kInfo];\n+  }\n+\n+  get errno() {\n+    return this[kInfo].errno;\n+  }\n+\n+  set errno(val) {\n+    this[kInfo].errno = val;\n+  }\n+\n+  get syscall() {\n+    return this[kInfo].syscall;\n+  }\n+\n+  set syscall(val) {\n+    this[kInfo].syscall = val;\n+  }\n+\n+  get path() {\n+    return this[kInfo].path !== undefined ?\n+      this[kInfo].path.toString() : undefined;\n+  }\n+\n+  set path(val) {\n+    this[kInfo].path = val ?\n+      lazyBuffer().from(val.toString()) : undefined;\n+  }\n+\n+  get dest() {\n+    return this[kInfo].path !== undefined ?\n+      this[kInfo].dest.toString() : undefined;\n+  }\n+\n+  set dest(val) {\n+    this[kInfo].dest = val ?\n+      lazyBuffer().from(val.toString()) : undefined;\n+  }\n+}\n+\n+function makeSystemErrorWithCode(key) {\n+  return class NodeError extends SystemError {\n+    constructor(...args) {\n+      super(key, ...args);\n     }\n   };\n }\n@@ -124,8 +194,15 @@ function makeNodeErrorWithCode(Base, key) {\n // Utility function for registering the error codes. Only used here. Exported\n // *only* to allow for testing.\n function E(sym, val, def, ...otherClasses) {\n+  // Special case for SystemError that formats the error message differently\n+  // The SystemErrors only have SystemError as their base classes.\n   messages.set(sym, val);\n-  def = makeNodeErrorWithCode(def, sym);\n+  if (def === SystemError) {\n+    def = makeSystemErrorWithCode(sym);\n+  } else {\n+    def = makeNodeErrorWithCode(def, sym);\n+  }\n+\n   if (otherClasses.length !== 0) {\n     otherClasses.forEach((clazz) => {\n       def[clazz.name] = makeNodeErrorWithCode(clazz, sym);\n@@ -140,70 +217,6 @@ function lazyBuffer() {\n   return buffer;\n }\n \n-// A specialized Error that includes an additional info property with\n-// additional information about the error condition. The code key will\n-// be extracted from the context object or the ERR_SYSTEM_ERROR default\n-// will be used.\n-class SystemError extends makeNodeError(Error) {\n-  constructor(context) {\n-    context = context || {};\n-    let code = 'ERR_SYSTEM_ERROR';\n-    if (messages.has(context.code))\n-      code = context.code;\n-    super(code,\n-          context.code,\n-          context.syscall,\n-          context.path,\n-          context.dest,\n-          context.message);\n-    Object.defineProperty(this, kInfo, {\n-      configurable: false,\n-      enumerable: false,\n-      value: context\n-    });\n-  }\n-\n-  get info() {\n-    return this[kInfo];\n-  }\n-\n-  get errno() {\n-    return this[kInfo].errno;\n-  }\n-\n-  set errno(val) {\n-    this[kInfo].errno = val;\n-  }\n-\n-  get syscall() {\n-    return this[kInfo].syscall;\n-  }\n-\n-  set syscall(val) {\n-    this[kInfo].syscall = val;\n-  }\n-\n-  get path() {\n-    return this[kInfo].path !== undefined ?\n-      this[kInfo].path.toString() : undefined;\n-  }\n-\n-  set path(val) {\n-    this[kInfo].path = val ?\n-      lazyBuffer().from(val.toString()) : undefined;\n-  }\n-\n-  get dest() {\n-    return this[kInfo].path !== undefined ?\n-      this[kInfo].dest.toString() : undefined;\n-  }\n-\n-  set dest(val) {\n-    this[kInfo].dest = val ?\n-      lazyBuffer().from(val.toString()) : undefined;\n-  }\n-}\n-\n function createErrDiff(actual, expected, operator) {\n   var other = '';\n   var res = '';\n@@ -872,7 +885,9 @@ E('ERR_SOCKET_BAD_PORT',\n   'Port should be > 0 and < 65536. Received %s.', RangeError);\n E('ERR_SOCKET_BAD_TYPE',\n   'Bad socket type specified. Valid types are: udp4, udp6', TypeError);\n-E('ERR_SOCKET_BUFFER_SIZE', 'Could not get or set buffer size: %s', Error);\n+E('ERR_SOCKET_BUFFER_SIZE',\n+  'Could not get or set buffer size',\n+  SystemError);\n E('ERR_SOCKET_CANNOT_SEND', 'Unable to send data', Error);\n E('ERR_SOCKET_CLOSED', 'Socket is closed', Error);\n E('ERR_SOCKET_DGRAM_NOT_RUNNING', 'Not running', Error);\n@@ -886,6 +901,7 @@ E('ERR_STREAM_UNSHIFT_AFTER_END_EVENT',\n   'stream.unshift() after end event', Error);\n E('ERR_STREAM_WRAP', 'Stream has StringDecoder set or is in objectMode', Error);\n E('ERR_STREAM_WRITE_AFTER_END', 'write after end', Error);\n+E('ERR_SYSTEM_ERROR', 'A system error occurred', SystemError);\n E('ERR_TLS_CERT_ALTNAME_INVALID',\n   'Hostname/IP does not match certificate\\'s altnames: %s', Error);\n E('ERR_TLS_DH_PARAM_SIZE', 'DH parameter size %s is less than 2048', Error);\n@@ -905,6 +921,7 @@ E('ERR_TRANSFORM_ALREADY_TRANSFORMING',\n // This should probably be a `RangeError`.\n E('ERR_TRANSFORM_WITH_LENGTH_0',\n   'Calling transform done when writableState.length != 0', Error);\n+E('ERR_TTY_INIT_FAILED', 'TTY initialization failed', SystemError);\n E('ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET',\n   '`process.setupUncaughtExceptionCapture()` was called while a capture ' +\n     'callback was already active',\n@@ -945,24 +962,6 @@ E('ERR_VM_MODULE_NOT_MODULE',\n E('ERR_VM_MODULE_STATUS', 'Module status %s', Error);\n E('ERR_ZLIB_INITIALIZATION_FAILED', 'Initialization failed', Error);\n \n-function sysError(code, syscall, path, dest,\n-                  message = 'A system error occurred') {\n-  if (code !== undefined)\n-    message += `: ${code}`;\n-  if (syscall !== undefined) {\n-    if (code === undefined)\n-      message += ':';\n-    message += ` [${syscall}]`;\n-  }\n-  if (path !== undefined) {\n-    message += `: ${path}`;\n-    if (dest !== undefined)\n-      message += ` => ${dest}`;\n-  }\n-  return message;\n-}\n-messages.set('ERR_SYSTEM_ERROR', sysError);\n-\n function invalidArgType(name, expected, actual) {\n   internalAssert(typeof name === 'string');\n   internalAssert(arguments.length === 3);"
        },
        {
            "sha": "5c83dbfab7b6e3eb64a6d6f4074bee69865c2f31",
            "filename": "lib/os.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Fos.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Fos.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fos.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -27,7 +27,7 @@ const { deprecate } = require('internal/util');\n const { getCIDRSuffix } = require('internal/os');\n const isWindows = process.platform === 'win32';\n \n-const errors = require('internal/errors');\n+const { ERR_SYSTEM_ERROR } = require('internal/errors');\n \n const {\n   getCPUs,\n@@ -49,7 +49,7 @@ function getCheckedFunction(fn) {\n     const ctx = {};\n     const ret = fn(...args, ctx);\n     if (ret === undefined) {\n-      const err = new errors.SystemError(ctx);\n+      const err = new ERR_SYSTEM_ERROR(ctx);\n       Error.captureStackTrace(err, checkError);\n       throw err;\n     }"
        },
        {
            "sha": "4e9023b0eb6114247b5640bfda93e165b515cf52",
            "filename": "lib/tty.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Ftty.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/lib%2Ftty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftty.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -25,7 +25,7 @@ const { inherits, _extend } = require('util');\n const net = require('net');\n const { TTY, isTTY } = process.binding('tty_wrap');\n const errors = require('internal/errors');\n-const { ERR_INVALID_FD } = errors.codes;\n+const { ERR_INVALID_FD, ERR_TTY_INIT_FAILED } = errors.codes;\n const readline = require('readline');\n const { getColorDepth } = require('internal/tty');\n \n@@ -42,7 +42,7 @@ function ReadStream(fd, options) {\n   const ctx = {};\n   const tty = new TTY(fd, true, ctx);\n   if (ctx.code !== undefined) {\n-    throw new errors.SystemError(ctx);\n+    throw new ERR_TTY_INIT_FAILED(ctx);\n   }\n \n   options = _extend({\n@@ -74,7 +74,7 @@ function WriteStream(fd) {\n   const ctx = {};\n   const tty = new TTY(fd, false, ctx);\n   if (ctx.code !== undefined) {\n-    throw new errors.SystemError(ctx);\n+    throw new ERR_TTY_INIT_FAILED(ctx);\n   }\n \n   net.Socket.call(this, {"
        },
        {
            "sha": "834ca30c57d92657ff12a6aecabb0f50a03e7572",
            "filename": "test/parallel/test-dgram-socket-buffer-size.js",
            "status": "modified",
            "additions": 71,
            "deletions": 17,
            "changes": 88,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-dgram-socket-buffer-size.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-dgram-socket-buffer-size.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-dgram-socket-buffer-size.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -1,33 +1,61 @@\n 'use strict';\n+// Flags: --expose-internals\n \n const common = require('../common');\n const assert = require('assert');\n const dgram = require('dgram');\n+const { SystemError } = require('internal/errors');\n+const uv = process.binding('uv');\n+\n+function getExpectedError(type) {\n+  const code = common.isWindows ? 'ENOTSOCK' : 'EBADF';\n+  const message = common.isWindows ?\n+    'socket operation on non-socket' : 'bad file descriptor';\n+  const errno = common.isWindows ? uv.UV_ENOTSOCK : uv.UV_EBADF;\n+  const syscall = `uv_${type}_buffer_size`;\n+  const suffix = common.isWindows ?\n+    'ENOTSOCK (socket operation on non-socket)' : 'EBADF (bad file descriptor)';\n+  const error = {\n+    code: 'ERR_SOCKET_BUFFER_SIZE',\n+    type: SystemError,\n+    message: `Could not get or set buffer size: ${syscall} returned ${suffix}`,\n+    info: {\n+      code,\n+      message,\n+      errno,\n+      syscall\n+    }\n+  };\n+  return error;\n+}\n \n {\n   // Should throw error if the socket is never bound.\n-  const errorObj = {\n-    code: 'ERR_SOCKET_BUFFER_SIZE',\n-    type: Error,\n-    message: /^Could not get or set buffer size:.*$/\n-  };\n+  const errorObj = getExpectedError('send');\n \n   const socket = dgram.createSocket('udp4');\n \n   common.expectsError(() => {\n-    socket.setRecvBufferSize(8192);\n+    socket.setSendBufferSize(8192);\n   }, errorObj);\n \n   common.expectsError(() => {\n-    socket.setSendBufferSize(8192);\n+    socket.getSendBufferSize();\n   }, errorObj);\n+}\n+\n+{\n+  const socket = dgram.createSocket('udp4');\n+\n+  // Should throw error if the socket is never bound.\n+  const errorObj = getExpectedError('recv');\n \n   common.expectsError(() => {\n-    socket.getRecvBufferSize();\n+    socket.setRecvBufferSize(8192);\n   }, errorObj);\n \n   common.expectsError(() => {\n-    socket.getSendBufferSize();\n+    socket.getRecvBufferSize();\n   }, errorObj);\n }\n \n@@ -73,22 +101,48 @@ const dgram = require('dgram');\n   }));\n }\n \n-function checkBufferSizeError(type, size) {\n+{\n+  const info = {\n+    code: 'EINVAL',\n+    message: 'invalid argument',\n+    errno: uv.UV_EINVAL,\n+    syscall: 'uv_recv_buffer_size'\n+  };\n   const errorObj = {\n     code: 'ERR_SOCKET_BUFFER_SIZE',\n-    type: Error,\n-    message: /^Could not get or set buffer size:.*$/\n+    type: SystemError,\n+    message: 'Could not get or set buffer size: uv_recv_buffer_size ' +\n+             'returned EINVAL (invalid argument)',\n+    info\n   };\n-  const functionName = `set${type.charAt(0).toUpperCase()}${type.slice(1)}` +\n-    'BufferSize';\n   const socket = dgram.createSocket('udp4');\n   socket.bind(common.mustCall(() => {\n     common.expectsError(() => {\n-      socket[functionName](size);\n+      socket.setRecvBufferSize(2147483648);\n     }, errorObj);\n     socket.close();\n   }));\n }\n \n-checkBufferSizeError('recv', 2147483648);\n-checkBufferSizeError('send', 2147483648);\n+{\n+  const info = {\n+    code: 'EINVAL',\n+    message: 'invalid argument',\n+    errno: uv.UV_EINVAL,\n+    syscall: 'uv_send_buffer_size'\n+  };\n+  const errorObj = {\n+    code: 'ERR_SOCKET_BUFFER_SIZE',\n+    type: SystemError,\n+    message: 'Could not get or set buffer size: uv_send_buffer_size ' +\n+             'returned EINVAL (invalid argument)',\n+    info\n+  };\n+  const socket = dgram.createSocket('udp4');\n+  socket.bind(common.mustCall(() => {\n+    common.expectsError(() => {\n+      socket.setSendBufferSize(2147483648);\n+    }, errorObj);\n+    socket.close();\n+  }));\n+}"
        },
        {
            "sha": "285c89b5d25c2ad1986055eedd028d18183b9eac",
            "filename": "test/parallel/test-errors-systemerror.js",
            "status": "modified",
            "additions": 45,
            "deletions": 115,
            "changes": 160,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-errors-systemerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-errors-systemerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-errors-systemerror.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -4,149 +4,79 @@\n const common = require('../common');\n const assert = require('assert');\n const errors = require('internal/errors');\n+const { AssertionError } = require('assert');\n \n-common.expectsError(\n-  () => { throw new errors.SystemError(); },\n-  {\n-    code: 'ERR_SYSTEM_ERROR',\n-    type: errors.SystemError,\n-    message: 'A system error occurred'\n-  }\n-);\n-\n-common.expectsError(\n-  () => { throw new errors.SystemError({}); },\n-  {\n-    code: 'ERR_SYSTEM_ERROR',\n-    type: errors.SystemError,\n-    message: 'A system error occurred'\n-  }\n-);\n+const { E, SystemError } = errors;\n \n common.expectsError(\n-  () => { throw new errors.SystemError(null); },\n+  () => { throw new errors.SystemError(); },\n   {\n-    code: 'ERR_SYSTEM_ERROR',\n-    type: errors.SystemError,\n-    message: 'A system error occurred'\n+    code: 'ERR_ASSERTION',\n+    type: AssertionError,\n+    message: 'An invalid error message key was used: undefined.'\n   }\n );\n \n-common.expectsError(\n-  () => { throw new errors.SystemError({ code: 'ERR' }); },\n-  {\n-    code: 'ERR_SYSTEM_ERROR',\n-    type: errors.SystemError,\n-    message: 'A system error occurred: ERR'\n-  }\n-);\n+E('ERR_TEST', 'custom message', SystemError);\n+const { ERR_TEST } = errors.codes;\n \n {\n   const ctx = {\n-    code: 'ERR',\n-    syscall: 'foo'\n+    code: 'ETEST',\n+    message: 'code message',\n+    syscall: 'syscall_test',\n+    path: '/str',\n+    dest: '/str2'\n   };\n-  common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n-    {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'A system error occurred: ERR [foo]'\n-    }\n-  );\n-}\n \n-{\n-  const ctx = {\n-    code: 'ERR',\n-    syscall: 'foo',\n-    path: Buffer.from('a')\n-  };\n   common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n+    () => { throw new ERR_TEST(ctx); },\n     {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'A system error occurred: ERR [foo]: a'\n+      code: 'ERR_TEST',\n+      type: SystemError,\n+      message: 'custom message: syscall_test returned ETEST (code message)' +\n+               ' /str => /str2',\n+      info: ctx\n     }\n   );\n }\n \n {\n   const ctx = {\n-    code: 'ERR',\n-    syscall: 'foo',\n-    path: Buffer.from('a'),\n-    dest: Buffer.from('b')\n-  };\n-  common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n-    {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'A system error occurred: ERR [foo]: a => b'\n-    }\n-  );\n-}\n-\n-{\n-  const ctx = {\n-    syscall: 'foo',\n-    path: Buffer.from('a'),\n-    dest: Buffer.from('b')\n-  };\n-  common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n-    {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'A system error occurred: [foo]: a => b'\n-    }\n-  );\n-}\n-\n-{\n-  const ctx = {\n-    path: Buffer.from('a'),\n-    dest: Buffer.from('b')\n-  };\n-  common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n-    {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'A system error occurred: a => b'\n-    }\n-  );\n-}\n-\n-{\n-  const ctx = {\n-    code: 'ERR',\n-    message: 'something happened',\n-    syscall: 'foo',\n-    path: Buffer.from('a'),\n-    dest: Buffer.from('b')\n+    code: 'ETEST',\n+    message: 'code message',\n+    syscall: 'syscall_test',\n+    path: Buffer.from('/buf'),\n+    dest: '/str2'\n   };\n   common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n+    () => { throw new ERR_TEST(ctx); },\n     {\n-      code: 'ERR_SYSTEM_ERROR',\n-      type: errors.SystemError,\n-      message: 'something happened: ERR [foo]: a => b'\n+      code: 'ERR_TEST',\n+      type: SystemError,\n+      message: 'custom message: syscall_test returned ETEST (code message)' +\n+               ' /buf => /str2',\n+      info: ctx\n     }\n   );\n }\n \n {\n   const ctx = {\n-    code: 'ERR_ASSERTION'\n+    code: 'ETEST',\n+    message: 'code message',\n+    syscall: 'syscall_test',\n+    path: Buffer.from('/buf'),\n+    dest: Buffer.from('/buf2')\n   };\n   common.expectsError(\n-    () => { throw new errors.SystemError(ctx); },\n+    () => { throw new ERR_TEST(ctx); },\n     {\n-      code: 'ERR_ASSERTION',\n-      type: errors.SystemError\n+      code: 'ERR_TEST',\n+      type: SystemError,\n+      message: 'custom message: syscall_test returned ETEST (code message)' +\n+               ' /buf => /buf2',\n+      info: ctx\n     }\n   );\n }\n@@ -156,20 +86,20 @@ common.expectsError(\n     code: 'ERR',\n     errno: 123,\n     message: 'something happened',\n-    syscall: 'foo',\n+    syscall: 'syscall_test',\n     path: Buffer.from('a'),\n     dest: Buffer.from('b')\n   };\n-  const err = new errors.SystemError(ctx);\n+  const err = new ERR_TEST(ctx);\n   assert.strictEqual(err.info, ctx);\n-  assert.strictEqual(err.code, 'ERR_SYSTEM_ERROR');\n+  assert.strictEqual(err.code, 'ERR_TEST');\n   err.code = 'test';\n   assert.strictEqual(err.code, 'test');\n \n   // Test legacy properties. These shouldn't be used anymore\n   // but let us make sure they still work\n   assert.strictEqual(err.errno, 123);\n-  assert.strictEqual(err.syscall, 'foo');\n+  assert.strictEqual(err.syscall, 'syscall_test');\n   assert.strictEqual(err.path, 'a');\n   assert.strictEqual(err.dest, 'b');\n "
        },
        {
            "sha": "c360489cb335295cb5f222dccdb1cce30eb86f9a",
            "filename": "test/parallel/test-ttywrap-invalid-fd.js",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d06761f839bbff8c671b0e1a6d541faa5452354/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-ttywrap-invalid-fd.js?ref=7d06761f839bbff8c671b0e1a6d541faa5452354",
            "patch": "@@ -4,6 +4,7 @@\n const common = require('../common');\n const tty = require('tty');\n const { SystemError } = require('internal/errors');\n+const uv = process.binding('uv');\n \n common.expectsError(\n   () => new tty.WriteStream(-1),\n@@ -15,19 +16,27 @@ common.expectsError(\n );\n \n {\n-  const message = common.isWindows ?\n-    'bad file descriptor: EBADF [uv_tty_init]' :\n-    'invalid argument: EINVAL [uv_tty_init]';\n+  const info = {\n+    code: common.isWindows ? 'EBADF' : 'EINVAL',\n+    message: common.isWindows ? 'bad file descriptor' : 'invalid argument',\n+    errno: common.isWindows ? uv.UV_EBADF : uv.UV_EINVAL,\n+    syscall: 'uv_tty_init'\n+  };\n+\n+  const suffix = common.isWindows ?\n+    'EBADF (bad file descriptor)' : 'EINVAL (invalid argument)';\n+  const message = `TTY initialization failed: uv_tty_init returned ${suffix}`;\n \n   common.expectsError(\n     () => {\n       common.runWithInvalidFD((fd) => {\n         new tty.WriteStream(fd);\n       });\n     }, {\n-      code: 'ERR_SYSTEM_ERROR',\n+      code: 'ERR_TTY_INIT_FAILED',\n       type: SystemError,\n-      message\n+      message,\n+      info\n     }\n   );\n \n@@ -37,9 +46,10 @@ common.expectsError(\n         new tty.ReadStream(fd);\n       });\n     }, {\n-      code: 'ERR_SYSTEM_ERROR',\n+      code: 'ERR_TTY_INIT_FAILED',\n       type: SystemError,\n-      message\n+      message,\n+      info\n     });\n }\n "
        }
    ],
    "stats": {
        "total": 520,
        "additions": 259,
        "deletions": 261
    }
}