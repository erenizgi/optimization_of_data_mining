{
    "author": "addaleax",
    "message": "src: pass along errors from `--security-reverts`\n\nPass along errors from `Revert()` when a security revert\nis unknown (which currently applies to all possible values).\n\nPreviously, we would unconditionally call `exit()`, which is\nnot nice for embedding use cases, and could crash because we\nwere holding a lock for a mutex in `ProcessGlobalArgs()` that\nwould be destroyed by calling `exit()`.\n\nAlso, add a regression test that makes sure that the process\nexits with the right exit code and not a crash.\n\nPR-URL: https://github.com/nodejs/node/pull/25466\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "38ab1e9ade1e473f1c0b7a1e7535d41654506a3d",
    "files": [
        {
            "sha": "7e0fb828e5377858d63044362bed58d9cae796df",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=38ab1e9ade1e473f1c0b7a1e7535d41654506a3d",
            "patch": "@@ -915,8 +915,14 @@ int ProcessGlobalArgs(std::vector<std::string>* args,\n \n   if (!errors->empty()) return 9;\n \n-  for (const std::string& cve : per_process::cli_options->security_reverts)\n-    Revert(cve.c_str());\n+  std::string revert_error;\n+  for (const std::string& cve : per_process::cli_options->security_reverts) {\n+    Revert(cve.c_str(), &revert_error);\n+    if (!revert_error.empty()) {\n+      errors->emplace_back(std::move(revert_error));\n+      return 12;\n+    }\n+  }\n \n   auto env_opts = per_process::cli_options->per_isolate->per_env;\n   if (std::find(v8_args.begin(), v8_args.end(),"
        },
        {
            "sha": "38e2ba710536918bda45d64aec3e1908c601dc70",
            "filename": "src/node_revert.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/src%2Fnode_revert.h",
            "raw_url": "https://github.com/nodejs/node/raw/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/src%2Fnode_revert.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_revert.h?ref=38ab1e9ade1e473f1c0b7a1e7535d41654506a3d",
            "patch": "@@ -43,13 +43,14 @@ inline void Revert(const reversion cve) {\n   printf(\"SECURITY WARNING: Reverting %s\\n\", RevertMessage(cve));\n }\n \n-inline void Revert(const char* cve) {\n+inline void Revert(const char* cve, std::string* error) {\n #define V(code, label, _)                                                     \\\n   if (strcmp(cve, label) == 0) return Revert(SECURITY_REVERT_##code);\n   SECURITY_REVERSIONS(V)\n #undef V\n-  printf(\"Error: Attempt to revert an unknown CVE [%s]\\n\", cve);\n-  exit(12);\n+  *error = \"Error: Attempt to revert an unknown CVE [\";\n+  *error += cve;\n+  *error += ']';\n }\n \n inline bool IsReverted(const reversion cve) {"
        },
        {
            "sha": "688076ce94582a5c9959bcfa89caebbf0a83c6c0",
            "filename": "test/parallel/test-security-revert-unknown.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/test%2Fparallel%2Ftest-security-revert-unknown.js",
            "raw_url": "https://github.com/nodejs/node/raw/38ab1e9ade1e473f1c0b7a1e7535d41654506a3d/test%2Fparallel%2Ftest-security-revert-unknown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-security-revert-unknown.js?ref=38ab1e9ade1e473f1c0b7a1e7535d41654506a3d",
            "patch": "@@ -0,0 +1,14 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+const os = require('os');\n+\n+const { signal, status, output } =\n+  spawnSync(process.execPath, ['--security-reverts=not-a-cve']);\n+assert.strictEqual(signal, null);\n+assert.strictEqual(status, 12);\n+assert.strictEqual(\n+  output[2].toString(),\n+  `${process.execPath}: Error: ` +\n+  `Attempt to revert an unknown CVE [not-a-cve]${os.EOL}`);"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 26,
        "deletions": 5
    }
}