{
    "author": "tniessen",
    "message": "crypto: use kNoAuthTagLength in InitAuthenticated\n\nPR-URL: https://github.com/nodejs/node/pull/20225\nRefs: https://github.com/nodejs/node/pull/20039\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4",
    "files": [
        {
            "sha": "0eac04bebbf9c8cc88945e9ce958b0ad27514d66",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4",
            "patch": "@@ -2629,7 +2629,7 @@ void CipherBase::New(const FunctionCallbackInfo<Value>& args) {\n void CipherBase::Init(const char* cipher_type,\n                       const char* key_buf,\n                       int key_buf_len,\n-                      int auth_tag_len) {\n+                      unsigned int auth_tag_len) {\n   HandleScope scope(env()->isolate());\n \n #ifdef NODE_FIPS_MODE\n@@ -2700,10 +2700,16 @@ void CipherBase::Init(const FunctionCallbackInfo<Value>& args) {\n   const node::Utf8Value cipher_type(args.GetIsolate(), args[0]);\n   const char* key_buf = Buffer::Data(args[1]);\n   ssize_t key_buf_len = Buffer::Length(args[1]);\n-  CHECK(args[2]->IsInt32());\n+\n   // Don't assign to cipher->auth_tag_len_ directly; the value might not\n   // represent a valid length at this point.\n-  int auth_tag_len = args[2].As<v8::Int32>()->Value();\n+  unsigned int auth_tag_len;\n+  if (args[2]->IsUint32()) {\n+    auth_tag_len = args[2].As<v8::Uint32>()->Value();\n+  } else {\n+    CHECK(args[2]->IsInt32() && args[2].As<v8::Int32>()->Value() == -1);\n+    auth_tag_len = kNoAuthTagLength;\n+  }\n \n   cipher->Init(*cipher_type, key_buf, key_buf_len, auth_tag_len);\n }\n@@ -2714,7 +2720,7 @@ void CipherBase::InitIv(const char* cipher_type,\n                         int key_len,\n                         const char* iv,\n                         int iv_len,\n-                        int auth_tag_len) {\n+                        unsigned int auth_tag_len) {\n   HandleScope scope(env()->isolate());\n \n   const EVP_CIPHER* const cipher = EVP_get_cipherbyname(cipher_type);\n@@ -2788,10 +2794,16 @@ void CipherBase::InitIv(const FunctionCallbackInfo<Value>& args) {\n     iv_buf = Buffer::Data(args[2]);\n     iv_len = Buffer::Length(args[2]);\n   }\n-  CHECK(args[3]->IsInt32());\n+\n   // Don't assign to cipher->auth_tag_len_ directly; the value might not\n   // represent a valid length at this point.\n-  int auth_tag_len = args[3].As<v8::Int32>()->Value();\n+  unsigned int auth_tag_len;\n+  if (args[3]->IsUint32()) {\n+    auth_tag_len = args[3].As<v8::Uint32>()->Value();\n+  } else {\n+    CHECK(args[3]->IsInt32() && args[3].As<v8::Int32>()->Value() == -1);\n+    auth_tag_len = kNoAuthTagLength;\n+  }\n \n   cipher->InitIv(*cipher_type, key_buf, key_len, iv_buf, iv_len, auth_tag_len);\n }\n@@ -2802,7 +2814,7 @@ static bool IsValidGCMTagLength(unsigned int tag_len) {\n }\n \n bool CipherBase::InitAuthenticated(const char *cipher_type, int iv_len,\n-                                   int auth_tag_len) {\n+                                   unsigned int auth_tag_len) {\n   CHECK(IsAuthenticatedMode());\n \n   // TODO(tniessen) Use EVP_CTRL_AEAD_SET_IVLEN when migrating to OpenSSL 1.1.0\n@@ -2815,7 +2827,7 @@ bool CipherBase::InitAuthenticated(const char *cipher_type, int iv_len,\n \n   const int mode = EVP_CIPHER_CTX_mode(ctx_);\n   if (mode == EVP_CIPH_CCM_MODE) {\n-    if (auth_tag_len < 0) {\n+    if (auth_tag_len == kNoAuthTagLength) {\n       char msg[128];\n       snprintf(msg, sizeof(msg), \"authTagLength required for %s\", cipher_type);\n       env()->ThrowError(msg);\n@@ -2850,7 +2862,7 @@ bool CipherBase::InitAuthenticated(const char *cipher_type, int iv_len,\n   } else {\n     CHECK_EQ(mode, EVP_CIPH_GCM_MODE);\n \n-    if (auth_tag_len >= 0) {\n+    if (auth_tag_len != kNoAuthTagLength) {\n       if (!IsValidGCMTagLength(auth_tag_len)) {\n         char msg[50];\n         snprintf(msg, sizeof(msg),"
        },
        {
            "sha": "a706c2805726bf2d0653a77bbcc21ca9e93af025",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=4809db93178b7fbe95e5f2e0ff9f7d5f080d2ee4",
            "patch": "@@ -364,14 +364,15 @@ class CipherBase : public BaseObject {\n   void Init(const char* cipher_type,\n             const char* key_buf,\n             int key_buf_len,\n-            int auth_tag_len);\n+            unsigned int auth_tag_len);\n   void InitIv(const char* cipher_type,\n               const char* key,\n               int key_len,\n               const char* iv,\n               int iv_len,\n-              int auth_tag_len);\n-  bool InitAuthenticated(const char *cipher_type, int iv_len, int auth_tag_len);\n+              unsigned int auth_tag_len);\n+  bool InitAuthenticated(const char *cipher_type, int iv_len,\n+                         unsigned int auth_tag_len);\n   bool CheckCCMMessageLength(int message_len);\n   UpdateResult Update(const char* data, int len, unsigned char** out,\n                       int* out_len);"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 25,
        "deletions": 12
    }
}