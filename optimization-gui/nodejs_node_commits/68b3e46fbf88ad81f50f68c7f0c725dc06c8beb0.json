{
    "author": "ofrobots",
    "message": "trace_events: destroy platform before tracing\n\nFor safer shutdown, we should destroy the platform â€“ and background\nthreads - before the tracing infrastructure is destroyed. This change\nfixes the relative order of NodePlatform disposition and the tracing\nagent shutting down. This matches the nesting order for startup.\n\nMake the tracing agent own the tracing controller instead of platform\nto match the above.\n\nFixes: https://github.com/nodejs/node/issues/22865\n\nPR-URL: https://github.com/nodejs/node/pull/22938\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
    "files": [
        {
            "sha": "6250acfd5d540f023b752b931cefc8eb7ad428c8",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
            "patch": "@@ -292,15 +292,18 @@ static struct {\n     controller->AddTraceStateObserver(new NodeTraceStateObserver(controller));\n     tracing::TraceEventHelper::SetTracingController(controller);\n     StartTracingAgent();\n+    // Tracing must be initialized before platform threads are created.\n     platform_ = new NodePlatform(thread_pool_size, controller);\n     V8::InitializePlatform(platform_);\n   }\n \n   void Dispose() {\n-    tracing_agent_.reset(nullptr);\n     platform_->Shutdown();\n     delete platform_;\n     platform_ = nullptr;\n+    // Destroy tracing after the platform (and platform threads) have been\n+    // stopped.\n+    tracing_agent_.reset(nullptr);\n   }\n \n   void DrainVMTasks(Isolate* isolate) {"
        },
        {
            "sha": "278c1684835f7fac5459313471da419b735647e0",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
            "patch": "@@ -283,10 +283,9 @@ int PerIsolatePlatformData::unref() {\n NodePlatform::NodePlatform(int thread_pool_size,\n                            TracingController* tracing_controller) {\n   if (tracing_controller) {\n-    tracing_controller_.reset(tracing_controller);\n+    tracing_controller_ = tracing_controller;\n   } else {\n-    TracingController* controller = new TracingController();\n-    tracing_controller_.reset(controller);\n+    tracing_controller_ = new TracingController();\n   }\n   worker_thread_task_runner_ =\n       std::make_shared<WorkerThreadsTaskRunner>(thread_pool_size);\n@@ -456,7 +455,7 @@ double NodePlatform::CurrentClockTimeMillis() {\n }\n \n TracingController* NodePlatform::GetTracingController() {\n-  return tracing_controller_.get();\n+  return tracing_controller_;\n }\n \n template <class T>"
        },
        {
            "sha": "c926c17852878a17fde761b065228c7356f365e3",
            "filename": "src/node_platform.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode_platform.h",
            "raw_url": "https://github.com/nodejs/node/raw/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Fnode_platform.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.h?ref=68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
            "patch": "@@ -158,7 +158,7 @@ class NodePlatform : public MultiIsolatePlatform {\n   std::unordered_map<v8::Isolate*,\n                      std::shared_ptr<PerIsolatePlatformData>> per_isolate_;\n \n-  std::unique_ptr<v8::TracingController> tracing_controller_;\n+  v8::TracingController* tracing_controller_;\n   std::shared_ptr<WorkerThreadsTaskRunner> worker_thread_task_runner_;\n };\n "
        },
        {
            "sha": "fd5cb3387b14aecfe8e6ff10a3cc74b18b2c441a",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
            "patch": "@@ -48,8 +48,7 @@ using v8::platform::tracing::TraceConfig;\n using v8::platform::tracing::TraceWriter;\n using std::string;\n \n-Agent::Agent() {\n-  tracing_controller_ = new TracingController();\n+Agent::Agent() : tracing_controller_(new TracingController()) {\n   tracing_controller_->Initialize(nullptr);\n \n   CHECK_EQ(uv_loop_init(&tracing_loop_), 0);\n@@ -117,7 +116,7 @@ AgentWriterHandle Agent::AddClient(\n     use_categories = &categories_with_default;\n   }\n \n-  ScopedSuspendTracing suspend(tracing_controller_, this);\n+  ScopedSuspendTracing suspend(tracing_controller_.get(), this);\n   int id = next_writer_id_++;\n   AsyncTraceWriter* raw = writer.get();\n   writers_[id] = std::move(writer);\n@@ -157,7 +156,7 @@ void Agent::Disconnect(int client) {\n     Mutex::ScopedLock lock(initialize_writer_mutex_);\n     to_be_initialized_.erase(writers_[client].get());\n   }\n-  ScopedSuspendTracing suspend(tracing_controller_, this);\n+  ScopedSuspendTracing suspend(tracing_controller_.get(), this);\n   writers_.erase(client);\n   categories_.erase(client);\n }\n@@ -166,13 +165,13 @@ void Agent::Enable(int id, const std::set<std::string>& categories) {\n   if (categories.empty())\n     return;\n \n-  ScopedSuspendTracing suspend(tracing_controller_, this,\n+  ScopedSuspendTracing suspend(tracing_controller_.get(), this,\n                                id != kDefaultHandleId);\n   categories_[id].insert(categories.begin(), categories.end());\n }\n \n void Agent::Disable(int id, const std::set<std::string>& categories) {\n-  ScopedSuspendTracing suspend(tracing_controller_, this,\n+  ScopedSuspendTracing suspend(tracing_controller_.get(), this,\n                                id != kDefaultHandleId);\n   std::multiset<std::string>& writer_categories = categories_[id];\n   for (const std::string& category : categories) {"
        },
        {
            "sha": "e9f52abe647a2d8ae3ee059fcdf2cc76b729b503",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=68b3e46fbf88ad81f50f68c7f0c725dc06c8beb0",
            "patch": "@@ -70,7 +70,9 @@ class Agent {\n   Agent();\n   ~Agent();\n \n-  TracingController* GetTracingController() { return tracing_controller_; }\n+  TracingController* GetTracingController() {\n+    return tracing_controller_.get();\n+  }\n \n   enum UseDefaultCategoryMode {\n     kUseDefaultCategories,\n@@ -121,7 +123,7 @@ class Agent {\n   // These maps store the original arguments to AddClient(), by id.\n   std::unordered_map<int, std::multiset<std::string>> categories_;\n   std::unordered_map<int, std::unique_ptr<AsyncTraceWriter>> writers_;\n-  TracingController* tracing_controller_ = nullptr;\n+  std::unique_ptr<TracingController> tracing_controller_;\n \n   // Variables related to initializing per-event-loop properties of individual\n   // writers, such as libuv handles."
        }
    ],
    "stats": {
        "total": 31,
        "additions": 17,
        "deletions": 14
    }
}