{
    "author": "killagu",
    "message": "tools, test: fix prof polyfill readline\n\n`node --prof foo.js` may not print the full profile log file, leaving\nthe last line broken (for example `tick,`. When that happens, `readline`\nwill be stuck in an infinite loop. This patch fixes it.\n\nAlso introduced `common.isCPPSymbolsNotMapped` to avoid duplicated code\non tick-processor tests.\n\nPR-URL: https://github.com/nodejs/node/pull/18641\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: Matheus Marchini <matheus@sthima.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "38f04d4da179dd3610ee07c2441601cdb2436a6a",
    "files": [
        {
            "sha": "43ccc0e5d8bfaca08941e21a91eb1ce47cee1f23",
            "filename": "lib/internal/v8_prof_polyfill.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/lib%2Finternal%2Fv8_prof_polyfill.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/lib%2Finternal%2Fv8_prof_polyfill.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fv8_prof_polyfill.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -96,6 +96,13 @@ function readline() {\n     if (line.length === 0) {\n       return '';\n     }\n+    if (bytes === 0) {\n+      process.emitWarning(`Profile file ${logFile} is broken`, {\n+        code: 'BROKEN_PROFILE_FILE',\n+        detail: `${JSON.stringify(line)} at the file end is broken`\n+      });\n+      return '';\n+    }\n   }\n }\n "
        },
        {
            "sha": "e0a66e9da0c2c9f53d340f093804e51a3e2f2553",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -243,6 +243,11 @@ Platform check for Windows.\n \n Platform check for Windows 32-bit on Windows 64-bit.\n \n+### isCPPSymbolsNotMapped\n+* [&lt;Boolean>]\n+\n+Platform check for C++ symbols are mapped or not.\n+\n ### leakedGlobals()\n * return [&lt;Array>]\n "
        },
        {
            "sha": "b24d2158e7d0897412f4d769841bcc0650077a87",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -803,3 +803,8 @@ exports.hijackStdout = hijackStdWritable.bind(null, 'stdout');\n exports.hijackStderr = hijackStdWritable.bind(null, 'stderr');\n exports.restoreStdout = restoreWritable.bind(null, 'stdout');\n exports.restoreStderr = restoreWritable.bind(null, 'stderr');\n+exports.isCPPSymbolsNotMapped = exports.isWindows ||\n+                                exports.isSunOS ||\n+                                exports.isAIX ||\n+                                exports.isLinuxPPCBE ||\n+                                exports.isFreeBSD;"
        },
        {
            "sha": "3d4e1b9d236030f697d16f9c0c5723adb4cab3eb",
            "filename": "test/tick-processor/test-tick-processor-builtin.js",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-builtin.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-builtin.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ftick-processor%2Ftest-tick-processor-builtin.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -4,12 +4,9 @@ const common = require('../common');\n if (!common.enoughTestCpu)\n   common.skip('test is CPU-intensive');\n \n-if (common.isWindows ||\n-    common.isSunOS ||\n-    common.isAIX ||\n-    common.isLinuxPPCBE ||\n-    common.isFreeBSD)\n+if (common.isCPPSymbolsNotMapped) {\n   common.skip('C++ symbols are not mapped for this os.');\n+}\n \n const base = require('./tick-processor-base.js');\n "
        },
        {
            "sha": "26daf60aa3c1ce1d43c908c2ffd3e639ab342134",
            "filename": "test/tick-processor/test-tick-processor-cpp-core.js",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-cpp-core.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-cpp-core.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ftick-processor%2Ftest-tick-processor-cpp-core.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -4,12 +4,9 @@ const common = require('../common');\n if (!common.enoughTestCpu)\n   common.skip('test is CPU-intensive');\n \n-if (common.isWindows ||\n-    common.isSunOS ||\n-    common.isAIX ||\n-    common.isLinuxPPCBE ||\n-    common.isFreeBSD)\n+if (common.isCPPSymbolsNotMapped) {\n   common.skip('C++ symbols are not mapped for this os.');\n+}\n \n const base = require('./tick-processor-base.js');\n "
        },
        {
            "sha": "3348b6f11b2e673a51de285c27cdfccf644b30e5",
            "filename": "test/tick-processor/test-tick-processor-polyfill-brokenfile.js",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-polyfill-brokenfile.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-polyfill-brokenfile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ftick-processor%2Ftest-tick-processor-polyfill-brokenfile.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -0,0 +1,62 @@\n+'use strict';\n+const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+if (!common.enoughTestCpu)\n+  common.skip('test is CPU-intensive');\n+\n+if (common.isCPPSymbolsNotMapped) {\n+  common.skip('C++ symbols are not mapped for this OS.');\n+}\n+\n+// This test will produce a broken profile log.\n+// ensure prof-polyfill not stuck in infinite loop\n+// and success process\n+\n+\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+\n+const LOG_FILE = path.join(tmpdir.path, 'tick-processor.log');\n+const RETRY_TIMEOUT = 150;\n+const BROKEN_PART = 'tick,';\n+const WARN_REG_EXP = /\\(node:\\d+\\) \\[BROKEN_PROFILE_FILE] Warning: Profile file .* is broken/;\n+const WARN_DETAIL_REG_EXP = /\".*tick,\" at the file end is broken/;\n+\n+const code = `function f() {\n+           this.ts = Date.now();\n+           setImmediate(function() { new f(); });\n+         };\n+         f();`;\n+\n+const proc = cp.spawn(process.execPath, [\n+  '--no_logfile_per_isolate',\n+  '--logfile=-',\n+  '--prof',\n+  '-pe', code\n+], {\n+  stdio: ['ignore', 'pipe', 'inherit']\n+});\n+\n+let ticks = '';\n+proc.stdout.on('data', (chunk) => ticks += chunk);\n+\n+\n+function runPolyfill(content) {\n+  proc.kill();\n+  content += BROKEN_PART;\n+  fs.writeFileSync(LOG_FILE, content);\n+  const child = cp.spawnSync(\n+    `${process.execPath}`,\n+    [\n+      '--prof-process', LOG_FILE\n+    ]);\n+  assert(WARN_REG_EXP.test(child.stderr.toString()));\n+  assert(WARN_DETAIL_REG_EXP.test(child.stderr.toString()));\n+  assert.strictEqual(child.status, 0);\n+}\n+\n+setTimeout(() => runPolyfill(ticks), RETRY_TIMEOUT);"
        },
        {
            "sha": "93367361aceea38068c701438a410440e681ab00",
            "filename": "test/tick-processor/test-tick-processor-preprocess-flag.js",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-preprocess-flag.js",
            "raw_url": "https://github.com/nodejs/node/raw/38f04d4da179dd3610ee07c2441601cdb2436a6a/test%2Ftick-processor%2Ftest-tick-processor-preprocess-flag.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ftick-processor%2Ftest-tick-processor-preprocess-flag.js?ref=38f04d4da179dd3610ee07c2441601cdb2436a6a",
            "patch": "@@ -4,12 +4,9 @@ const common = require('../common');\n if (!common.enoughTestCpu)\n   common.skip('test is CPU-intensive');\n \n-if (common.isWindows ||\n-    common.isSunOS ||\n-    common.isAIX ||\n-    common.isLinuxPPCBE ||\n-    common.isFreeBSD)\n+if (common.isCPPSymbolsNotMapped) {\n   common.skip('C++ symbols are not mapped for this os.');\n+}\n \n const base = require('./tick-processor-base.js');\n "
        }
    ],
    "stats": {
        "total": 100,
        "additions": 85,
        "deletions": 15
    }
}