{
    "author": "tniessen",
    "message": "crypto: fix behavior of createCipher in wrap mode\n\nThe old implementation silently failed in EVP_CipherInit_ex in\nEVP_CIPH_WRAP_MODE, this commit should fix that.\n\nPR-URL: https://github.com/nodejs/node/pull/21287\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a703df9785b79987ca03a2ad66f13afcfa2e4ade",
    "files": [
        {
            "sha": "8b152e65c3335cc1c50a93f302e5df69fa5c94bc",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/a703df9785b79987ca03a2ad66f13afcfa2e4ade/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a703df9785b79987ca03a2ad66f13afcfa2e4ade/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=a703df9785b79987ca03a2ad66f13afcfa2e4ade",
            "patch": "@@ -2611,10 +2611,14 @@ void CipherBase::Init(const char* cipher_type,\n                                iv);\n \n   ctx_.reset(EVP_CIPHER_CTX_new());\n+\n+  const int mode = EVP_CIPHER_mode(cipher);\n+  if (mode == EVP_CIPH_WRAP_MODE)\n+    EVP_CIPHER_CTX_set_flags(ctx_.get(), EVP_CIPHER_CTX_FLAG_WRAP_ALLOW);\n+\n   const bool encrypt = (kind_ == kCipher);\n   EVP_CipherInit_ex(ctx_.get(), cipher, nullptr, nullptr, nullptr, encrypt);\n \n-  int mode = EVP_CIPHER_CTX_mode(ctx_.get());\n   if (encrypt && (mode == EVP_CIPH_CTR_MODE || mode == EVP_CIPH_GCM_MODE ||\n       mode == EVP_CIPH_CCM_MODE)) {\n     // Ignore the return value (i.e. possible exception) because we are\n@@ -2624,9 +2628,6 @@ void CipherBase::Init(const char* cipher_type,\n                        cipher_type);\n   }\n \n-  if (mode == EVP_CIPH_WRAP_MODE)\n-    EVP_CIPHER_CTX_set_flags(ctx_.get(), EVP_CIPHER_CTX_FLAG_WRAP_ALLOW);\n-\n   if (IsAuthenticatedMode()) {\n     if (!InitAuthenticated(cipher_type, EVP_CIPHER_iv_length(cipher),\n                            auth_tag_len))"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 5,
        "deletions": 4
    }
}