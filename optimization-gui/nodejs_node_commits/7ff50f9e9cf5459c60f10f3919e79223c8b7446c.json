{
    "author": "cjihrig",
    "message": "fs: undeprecate lchown()\n\nuv_fs_lchown() exists, as of libuv 1.21.0. fs.lchown() can now\nbe undeprecated. This commit also adds tests, as there were\nnone.\n\nPR-URL: https://github.com/nodejs/node/pull/21498\nFixes: https://github.com/nodejs/node/issues/19868\nReviewed-By: Wyatt Preul <wpreul@gmail.com>",
    "sha": "7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
    "files": [
        {
            "sha": "0773166720510e4e26ee2fb41baf0f3688617b66",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -351,20 +351,6 @@ Type: Documentation-only\n \n The [`fs.lchmodSync(path, mode)`][] API is deprecated.\n \n-<a id=\"DEP0037\"></a>\n-### DEP0037: fs.lchown(path, uid, gid, callback)\n-\n-Type: Documentation-only\n-\n-The [`fs.lchown(path, uid, gid, callback)`][] API is deprecated.\n-\n-<a id=\"DEP0038\"></a>\n-### DEP0038: fs.lchownSync(path, uid, gid)\n-\n-Type: Documentation-only\n-\n-The [`fs.lchownSync(path, uid, gid)`][] API is deprecated.\n-\n <a id=\"DEP0039\"></a>\n ### DEP0039: require.extensions\n \n@@ -1049,8 +1035,6 @@ The option `produceCachedData` has been deprecated. Use\n [`fs.exists(path, callback)`]: fs.html#fs_fs_exists_path_callback\n [`fs.lchmod(path, mode, callback)`]: fs.html#fs_fs_lchmod_path_mode_callback\n [`fs.lchmodSync(path, mode)`]: fs.html#fs_fs_lchmodsync_path_mode\n-[`fs.lchown(path, uid, gid, callback)`]: fs.html#fs_fs_lchown_path_uid_gid_callback\n-[`fs.lchownSync(path, uid, gid)`]: fs.html#fs_fs_lchownsync_path_uid_gid\n [`fs.read()`]: fs.html#fs_fs_read_fd_buffer_offset_length_position_callback\n [`fs.readSync()`]: fs.html#fs_fs_readsync_fd_buffer_offset_length_position\n [`fs.stat()`]: fs.html#fs_fs_stat_path_callback"
        },
        {
            "sha": "f9fa9591af9805894a569ce80eb3f36d522bc55c",
            "filename": "doc/api/documentation.md",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Fdocumentation.md",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Fdocumentation.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdocumentation.md?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -83,10 +83,6 @@ which simply wrap a syscall,\n like [`fs.open()`][], will document that. The docs link to the corresponding man\n pages (short for manual pages) which describe how the syscalls work.\n \n-Some syscalls, like lchown(2), are BSD-specific. That means, for\n-example, that [`fs.lchown()`][] only works on macOS and other BSD-derived\n-systems, and is not available on Linux.\n-\n Most Unix syscalls have Windows equivalents, but behavior may differ on Windows\n relative to Linux and macOS. For an example of the subtle ways in which it's\n sometimes impossible to replace Unix syscall semantics on Windows, see [Node\n@@ -95,6 +91,5 @@ issue 4760](https://github.com/nodejs/node/issues/4760).\n [`'warning'`]: process.html#process_event_warning\n [`stderr`]: process.html#process_process_stderr\n [`fs.open()`]: fs.html#fs_fs_open_path_flags_mode_callback\n-[`fs.lchown()`]: fs.html#fs_fs_lchown_path_uid_gid_callback\n [submit an issue]: https://github.com/nodejs/node/issues/new\n [the contributing guide]: https://github.com/nodejs/node/blob/master/CONTRIBUTING.md"
        },
        {
            "sha": "f648527435f8a9ec991fcefc574616b1d39ff1bc",
            "filename": "doc/api/fs.md",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Ffs.md",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/doc%2Fapi%2Ffs.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ffs.md?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -1908,8 +1908,10 @@ Synchronous lchmod(2). Returns `undefined`.\n \n ## fs.lchown(path, uid, gid, callback)\n <!-- YAML\n-deprecated: v0.4.7\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/21498\n+    description: This API is no longer deprecated.\n   - version: v10.0.0\n     pr-url: https://github.com/nodejs/node/pull/12562\n     description: The `callback` parameter is no longer optional. Not passing\n@@ -1931,7 +1933,10 @@ to the completion callback.\n \n ## fs.lchownSync(path, uid, gid)\n <!-- YAML\n-deprecated: v0.4.7\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/21498\n+    description: This API is no longer deprecated.\n -->\n \n * `path` {string|Buffer|URL}\n@@ -3904,7 +3909,11 @@ no arguments upon success. This method is only implemented on macOS.\n \n ### fsPromises.lchown(path, uid, gid)\n <!-- YAML\n-deprecated: v10.0.0\n+added: v10.0.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/21498\n+    description: This API is no longer deprecated.\n -->\n \n * `path` {string|Buffer|URL}\n@@ -3913,7 +3922,7 @@ deprecated: v10.0.0\n * Returns: {Promise}\n \n Changes the ownership on a symbolic link then resolves the `Promise` with\n-no arguments upon success. This method is only implemented on macOS.\n+no arguments upon success.\n \n ### fsPromises.link(existingPath, newPath)\n <!-- YAML"
        },
        {
            "sha": "d770c6ecd2dd6e8ea92b8ee7036c430b8987c38a",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 17,
            "deletions": 24,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -997,31 +997,24 @@ function chmodSync(path, mode) {\n }\n \n function lchown(path, uid, gid, callback) {\n-  callback = maybeCallback(callback);\n-  fs.open(path, O_WRONLY | O_SYMLINK, function(err, fd) {\n-    if (err) {\n-      callback(err);\n-      return;\n-    }\n-    // Prefer to return the chown error, if one occurs,\n-    // but still try to close, and report closing errors if they occur.\n-    fs.fchown(fd, uid, gid, function(err) {\n-      fs.close(fd, function(err2) {\n-        callback(err || err2);\n-      });\n-    });\n-  });\n+  callback = makeCallback(callback);\n+  path = getPathFromURL(path);\n+  validatePath(path);\n+  validateUint32(uid, 'uid');\n+  validateUint32(gid, 'gid');\n+  const req = new FSReqWrap();\n+  req.oncomplete = callback;\n+  binding.lchown(pathModule.toNamespacedPath(path), uid, gid, req);\n }\n \n function lchownSync(path, uid, gid) {\n-  const fd = fs.openSync(path, O_WRONLY | O_SYMLINK);\n-  let ret;\n-  try {\n-    ret = fs.fchownSync(fd, uid, gid);\n-  } finally {\n-    fs.closeSync(fd);\n-  }\n-  return ret;\n+  path = getPathFromURL(path);\n+  validatePath(path);\n+  validateUint32(uid, 'uid');\n+  validateUint32(gid, 'gid');\n+  const ctx = { path };\n+  binding.lchown(pathModule.toNamespacedPath(path), uid, gid, undefined, ctx);\n+  handleErrorFromBinding(ctx);\n }\n \n function fchown(fd, uid, gid, callback) {\n@@ -1753,8 +1746,8 @@ module.exports = fs = {\n   ftruncateSync,\n   futimes,\n   futimesSync,\n-  lchown: constants.O_SYMLINK !== undefined ? lchown : undefined,\n-  lchownSync: constants.O_SYMLINK !== undefined ? lchownSync : undefined,\n+  lchown,\n+  lchownSync,\n   lchmod: constants.O_SYMLINK !== undefined ? lchmod : undefined,\n   lchmodSync: constants.O_SYMLINK !== undefined ? lchmodSync : undefined,\n   link,"
        },
        {
            "sha": "0cac39534abae44a89af9c739d319008becd4db4",
            "filename": "lib/internal/fs/promises.js",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/lib%2Finternal%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/lib%2Finternal%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fpromises.js?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -377,11 +377,12 @@ async function lchmod(path, mode) {\n }\n \n async function lchown(path, uid, gid) {\n-  if (O_SYMLINK === undefined)\n-    throw new ERR_METHOD_NOT_IMPLEMENTED();\n-\n-  const fd = await open(path, O_WRONLY | O_SYMLINK);\n-  return fchown(fd, uid, gid).finally(fd.close.bind(fd));\n+  path = getPathFromURL(path);\n+  validatePath(path);\n+  validateUint32(uid, 'uid');\n+  validateUint32(gid, 'gid');\n+  return binding.lchown(pathModule.toNamespacedPath(path),\n+                        uid, gid, kUsePromises);\n }\n \n async function fchown(handle, uid, gid) {"
        },
        {
            "sha": "ed1799da586e24e5de9f0743896993ef6ae25814",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -1771,6 +1771,36 @@ static void FChown(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n+static void LChown(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  const int argc = args.Length();\n+  CHECK_GE(argc, 3);\n+\n+  BufferValue path(env->isolate(), args[0]);\n+  CHECK_NOT_NULL(*path);\n+\n+  CHECK(args[1]->IsUint32());\n+  const uv_uid_t uid = static_cast<uv_uid_t>(args[1].As<Uint32>()->Value());\n+\n+  CHECK(args[2]->IsUint32());\n+  const uv_gid_t gid = static_cast<uv_gid_t>(args[2].As<Uint32>()->Value());\n+\n+  FSReqBase* req_wrap_async = GetReqWrap(env, args[3]);\n+  if (req_wrap_async != nullptr) {  // lchown(path, uid, gid, req)\n+    AsyncCall(env, req_wrap_async, args, \"lchown\", UTF8, AfterNoArgs,\n+              uv_fs_lchown, *path, uid, gid);\n+  } else {  // lchown(path, uid, gid, undefined, ctx)\n+    CHECK_EQ(argc, 5);\n+    FSReqWrapSync req_wrap_sync;\n+    FS_SYNC_TRACE_BEGIN(lchown);\n+    SyncCall(env, args[4], &req_wrap_sync, \"lchown\",\n+             uv_fs_lchown, *path, uid, gid);\n+    FS_SYNC_TRACE_END(lchown);\n+  }\n+}\n+\n+\n static void UTimes(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n@@ -1904,7 +1934,7 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"chown\", Chown);\n   env->SetMethod(target, \"fchown\", FChown);\n-  // env->SetMethod(target, \"lchown\", LChown);\n+  env->SetMethod(target, \"lchown\", LChown);\n \n   env->SetMethod(target, \"utimes\", UTimes);\n   env->SetMethod(target, \"futimes\", FUTimes);"
        },
        {
            "sha": "23469eb279aedee5c773ddd51eb88f0695cefbb3",
            "filename": "test/parallel/test-fs-lchown.js",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-fs-lchown.js",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-fs-lchown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-lchown.js?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -0,0 +1,67 @@\n+'use strict';\n+\n+const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+const { promises } = fs;\n+\n+common.crashOnUnhandledRejection();\n+\n+// Validate the path argument.\n+[false, 1, {}, [], null, undefined].forEach((i) => {\n+  const err = { type: TypeError, code: 'ERR_INVALID_ARG_TYPE' };\n+\n+  common.expectsError(() => fs.lchown(i, 1, 1, common.mustNotCall()), err);\n+  common.expectsError(() => fs.lchownSync(i, 1, 1), err);\n+  promises.lchown(false, 1, 1)\n+    .then(common.mustNotCall())\n+    .catch(common.expectsError(err));\n+});\n+\n+// Validate the uid and gid arguments.\n+[false, 'test', {}, [], null, undefined].forEach((i) => {\n+  const err = { type: TypeError, code: 'ERR_INVALID_ARG_TYPE' };\n+\n+  common.expectsError(\n+    () => fs.lchown('not_a_file_that_exists', i, 1, common.mustNotCall()),\n+    err\n+  );\n+  common.expectsError(\n+    () => fs.lchown('not_a_file_that_exists', 1, i, common.mustNotCall()),\n+    err\n+  );\n+  common.expectsError(() => fs.lchownSync('not_a_file_that_exists', i, 1), err);\n+  common.expectsError(() => fs.lchownSync('not_a_file_that_exists', 1, i), err);\n+\n+  promises.lchown('not_a_file_that_exists', i, 1)\n+    .then(common.mustNotCall())\n+    .catch(common.expectsError(err));\n+\n+  promises.lchown('not_a_file_that_exists', 1, i)\n+    .then(common.mustNotCall())\n+    .catch(common.expectsError(err));\n+});\n+\n+// Validate the callback argument.\n+[false, 1, 'test', {}, [], null, undefined].forEach((i) => {\n+  common.expectsError(() => fs.lchown('not_a_file_that_exists', 1, 1, i), {\n+    type: TypeError,\n+    code: 'ERR_INVALID_CALLBACK'\n+  });\n+});\n+\n+if (!common.isWindows) {\n+  const testFile = path.join(tmpdir.path, path.basename(__filename));\n+  const uid = process.geteuid();\n+  const gid = process.getegid();\n+\n+  tmpdir.refresh();\n+  fs.copyFileSync(__filename, testFile);\n+  fs.lchownSync(testFile, uid, gid);\n+  fs.lchown(testFile, uid, gid, common.mustCall(async (err) => {\n+    assert.ifError(err);\n+    await promises.lchown(testFile, uid, gid);\n+  }));\n+}"
        },
        {
            "sha": "f5a56b01d5f883a96655c5b55603ff71ae311d1c",
            "filename": "test/parallel/test-fs-null-bytes.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-fs-null-bytes.js",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-fs-null-bytes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-null-bytes.js?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -59,6 +59,7 @@ check(fs.chmod, fs.chmodSync, 'foo\\u0000bar', '0644');\n check(fs.chown, fs.chownSync, 'foo\\u0000bar', 12, 34);\n check(fs.copyFile, fs.copyFileSync, 'foo\\u0000bar', 'abc');\n check(fs.copyFile, fs.copyFileSync, 'abc', 'foo\\u0000bar');\n+check(fs.lchown, fs.lchownSync, 'foo\\u0000bar', 12, 34);\n check(fs.link, fs.linkSync, 'foo\\u0000bar', 'foobar');\n check(fs.link, fs.linkSync, 'foobar', 'foo\\u0000bar');\n check(fs.lstat, fs.lstatSync, 'foo\\u0000bar');\n@@ -92,6 +93,7 @@ check(fs.chmod, fs.chmodSync, fileUrl, '0644');\n check(fs.chown, fs.chownSync, fileUrl, 12, 34);\n check(fs.copyFile, fs.copyFileSync, fileUrl, 'abc');\n check(fs.copyFile, fs.copyFileSync, 'abc', fileUrl);\n+check(fs.lchown, fs.lchownSync, fileUrl, 12, 34);\n check(fs.link, fs.linkSync, fileUrl, 'foobar');\n check(fs.link, fs.linkSync, 'foobar', fileUrl);\n check(fs.lstat, fs.lstatSync, fileUrl);\n@@ -122,6 +124,7 @@ check(fs.chmod, fs.chmodSync, fileUrl2, '0644');\n check(fs.chown, fs.chownSync, fileUrl2, 12, 34);\n check(fs.copyFile, fs.copyFileSync, fileUrl2, 'abc');\n check(fs.copyFile, fs.copyFileSync, 'abc', fileUrl2);\n+check(fs.lchown, fs.lchownSync, fileUrl2, 12, 34);\n check(fs.link, fs.linkSync, fileUrl2, 'foobar');\n check(fs.link, fs.linkSync, 'foobar', fileUrl2);\n check(fs.lstat, fs.lstatSync, fileUrl2);"
        },
        {
            "sha": "77ec0863406379615ce0af5b60ed78ed96a9ba9e",
            "filename": "test/parallel/test-trace-events-fs-sync.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-trace-events-fs-sync.js",
            "raw_url": "https://github.com/nodejs/node/raw/7ff50f9e9cf5459c60f10f3919e79223c8b7446c/test%2Fparallel%2Ftest-trace-events-fs-sync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-fs-sync.js?ref=7ff50f9e9cf5459c60f10f3919e79223c8b7446c",
            "patch": "@@ -60,6 +60,9 @@ tests['fs.sync.futimes'] = 'fs.writeFileSync(\"fs.txt\", \"123\", \"utf8\");' +\n                            'const fd = fs.openSync(\"fs.txt\", \"r+\");' +\n                            'fs.futimesSync(fd,1,1);' +\n                            'fs.unlinkSync(\"fs.txt\")';\n+tests['fs.sync.lchown'] = 'fs.writeFileSync(\"fs.txt\", \"123\", \"utf8\");' +\n+                          'fs.lchownSync(\"fs.txt\",' + uid + ',' + gid + ');' +\n+                          'fs.unlinkSync(\"fs.txt\")';\n tests['fs.sync.link'] = 'fs.writeFileSync(\"fs.txt\", \"123\", \"utf8\");' +\n                         'fs.linkSync(\"fs.txt\", \"linkx\");' +\n                         'fs.unlinkSync(\"linkx\");' +"
        }
    ],
    "stats": {
        "total": 195,
        "additions": 140,
        "deletions": 55
    }
}