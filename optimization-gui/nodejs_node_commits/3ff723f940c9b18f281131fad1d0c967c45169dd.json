{
    "author": "ofrobots",
    "message": "src: trace_events: support for metadata events\n\nAdd support for metadata events. At this point they are added to the\nmain buffer. Emit a metadata event for the main thread.\n\nPR-URL: https://github.com/nodejs/node/pull/20757\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "3ff723f940c9b18f281131fad1d0c967c45169dd",
    "files": [
        {
            "sha": "47e5abec5047a4def485d7875271bf42fcdc58b7",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -4545,6 +4545,9 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Environment env(isolate_data, context, v8_platform.GetTracingAgent());\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n+  TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\", \"name\",\n+                        \"JavaScriptMainThread\");\n+\n   const char* path = argc > 1 ? argv[1] : nullptr;\n   StartInspector(&env, path, debug_options);\n "
        },
        {
            "sha": "1165fca59a99ea449af8414608cfa0db61dd909a",
            "filename": "src/tracing/trace_event.h",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/src%2Ftracing%2Ftrace_event.h",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/src%2Ftracing%2Ftrace_event.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.h?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -118,6 +118,15 @@ enum CategoryGroupEnabledFlags {\n   node::tracing::TraceEventHelper::GetTracingController()       \\\n       ->UpdateTraceEventDuration\n \n+// Adds a metadata event to the trace log. The |AppendValueAsTraceFormat| method\n+// on the convertable value will be called at flush time.\n+// TRACE_EVENT_API_ADD_METADATA_EVENT(\n+//     const unsigned char* category_group_enabled,\n+//     const char* event_name,\n+//     const char* arg_name,\n+//     std::unique_ptr<ConvertableToTraceFormat> arg_value)\n+#define TRACE_EVENT_API_ADD_METADATA_EVENT node::tracing::AddMetadataEvent\n+\n // Defines atomic operations used internally by the tracing system.\n #define TRACE_EVENT_API_ATOMIC_WORD intptr_t\n #define TRACE_EVENT_API_ATOMIC_LOAD(var) (var)\n@@ -259,6 +268,16 @@ enum CategoryGroupEnabledFlags {\n     }                                                                        \\\n   } while (0)\n \n+#define INTERNAL_TRACE_EVENT_METADATA_ADD(category_group, name, ...)  \\\n+  do { \\\n+    INTERNAL_TRACE_EVENT_GET_CATEGORY_INFO(category_group); \\\n+    if (INTERNAL_TRACE_EVENT_CATEGORY_GROUP_ENABLED_FOR_RECORDING_MODE()) { \\\n+      TRACE_EVENT_API_ADD_METADATA_EVENT( \\\n+          INTERNAL_TRACE_EVENT_UID(category_group_enabled), name, \\\n+          ##__VA_ARGS__); \\\n+    } \\\n+  } while(0)\n+\n // Enter and leave a context based on the current scope.\n #define INTERNAL_TRACE_EVENT_SCOPED_CONTEXT(category_group, name, context) \\\n   struct INTERNAL_TRACE_EVENT_UID(ScopedContext) {                         \\\n@@ -612,6 +631,26 @@ static V8_INLINE uint64_t AddTraceEventWithTimestamp(\n       arg_names, arg_types, arg_values, flags, timestamp);\n }\n \n+template <class ARG1_TYPE>\n+static V8_INLINE uint64_t AddMetadataEvent(\n+    const uint8_t* category_group_enabled, const char* name,\n+    const char* arg1_name, ARG1_TYPE&& arg1_val) {\n+  const int num_args = 1;\n+  uint8_t arg_type;\n+  uint64_t arg_value;\n+  SetTraceValue(std::forward<ARG1_TYPE>(arg1_val), &arg_type, &arg_value);\n+  // TODO(ofrobots): It would be good to add metadata events to a separate\n+  // buffer so that they can be periodically reemitted. For now, we have a\n+  // single buffer, so we just add them to the main buffer.\n+  return TRACE_EVENT_API_ADD_TRACE_EVENT(\n+      TRACE_EVENT_PHASE_METADATA,\n+      category_group_enabled, name,\n+      node::tracing::kGlobalScope,  // scope\n+      node::tracing::kNoId,         // id\n+      node::tracing::kNoId,         // bind_id\n+      num_args, &arg1_name, &arg_type, &arg_value, TRACE_EVENT_FLAG_NONE);\n+}\n+\n // Used by TRACE_EVENTx macros. Do not use directly.\n class ScopedTracer {\n  public:"
        },
        {
            "sha": "a68a2850a37c4533422aced8f56d6d53ba386f4b",
            "filename": "test/parallel/test-trace-events-api.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-api.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-api.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-api.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -130,7 +130,8 @@ if (isChild) {\n \n     assert(common.fileExists(file));\n     fs.readFile(file, common.mustCall((err, data) => {\n-      const traces = JSON.parse(data.toString()).traceEvents;\n+      const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n       assert.strictEqual(traces.length,\n                          expectedMarks.length +\n                          expectedBegins.length +"
        },
        {
            "sha": "e52f1c769f5283ebeedb9f830470ebdfc13687e9",
            "filename": "test/parallel/test-trace-events-binding.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-binding.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-binding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-binding.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -31,7 +31,8 @@ const proc = cp.spawn(process.execPath,\n proc.once('exit', common.mustCall(() => {\n   assert(common.fileExists(FILE_NAME));\n   fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n-    const traces = JSON.parse(data.toString()).traceEvents;\n+    const traces = JSON.parse(data.toString()).traceEvents\n+      .filter((trace) => trace.cat !== '__metadata');\n     assert.strictEqual(traces.length, 3);\n \n     assert.strictEqual(traces[0].pid, proc.pid);"
        },
        {
            "sha": "6f8c76564a8ac488585b141f9635ceb8ac185c72",
            "filename": "test/parallel/test-trace-events-bootstrap.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-bootstrap.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -42,7 +42,8 @@ if (process.argv[2] === 'child') {\n \n     assert(common.fileExists(file));\n     fs.readFile(file, common.mustCall((err, data) => {\n-      const traces = JSON.parse(data.toString()).traceEvents;\n+      const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n       traces.forEach((trace) => {\n         assert.strictEqual(trace.pid, proc.pid);\n         assert(names.includes(trace.name));"
        },
        {
            "sha": "f8fcdcfe5bb788f696a939f49fffcd05a87b88cf",
            "filename": "test/parallel/test-trace-events-metadata.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-metadata.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const fs = require('fs');\n+\n+const CODE =\n+  'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1)';\n+const FILE_NAME = 'node_trace.1.log';\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+process.chdir(tmpdir.path);\n+\n+const proc = cp.spawn(process.execPath,\n+                      [ '--trace-events-enabled', '-e', CODE ]);\n+proc.once('exit', common.mustCall(() => {\n+  assert(common.fileExists(FILE_NAME));\n+  fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n+    const traces = JSON.parse(data.toString()).traceEvents;\n+    assert(traces.length > 0);\n+    assert(traces.some((trace) =>\n+      trace.cat === '__metadata' && trace.name === 'thread_name' &&\n+        trace.args.name === 'JavaScriptMainThread'));\n+  }));\n+}));"
        },
        {
            "sha": "a3f0338f28af354ef08ff4d810978296935172c2",
            "filename": "test/parallel/test-trace-events-none.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-none.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-none.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-none.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -2,6 +2,7 @@\n const common = require('../common');\n const assert = require('assert');\n const cp = require('child_process');\n+const fs = require('fs');\n \n const CODE =\n   'setTimeout(() => { for (var i = 0; i < 100000; i++) { \"test\" + i } }, 1)';\n@@ -17,5 +18,10 @@ const proc_no_categories = cp.spawn(\n );\n \n proc_no_categories.once('exit', common.mustCall(() => {\n-  assert(!common.fileExists(FILE_NAME));\n+  assert(common.fileExists(FILE_NAME));\n+  // Only __metadata categories should have been emitted.\n+  fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n+    assert.ok(JSON.parse(data.toString()).traceEvents.every(\n+      (trace) => trace.cat === '__metadata'));\n+  }));\n }));"
        },
        {
            "sha": "57ac0e3142f66ddb30005e7acb1c796d5796a4ec",
            "filename": "test/parallel/test-trace-events-perf.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-perf.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -49,7 +49,8 @@ if (process.argv[2] === 'child') {\n \n     assert(common.fileExists(file));\n     fs.readFile(file, common.mustCall((err, data) => {\n-      const traces = JSON.parse(data.toString()).traceEvents;\n+      const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n       assert.strictEqual(traces.length,\n                          expectedMarks.length +\n                          expectedBegins.length +"
        },
        {
            "sha": "3dc6e263e1b6a1565a728630b97e32c2f34dc84c",
            "filename": "test/parallel/test-trace-events-vm.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-vm.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ff723f940c9b18f281131fad1d0c967c45169dd/test%2Fparallel%2Ftest-trace-events-vm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-vm.js?ref=3ff723f940c9b18f281131fad1d0c967c45169dd",
            "patch": "@@ -32,7 +32,8 @@ if (process.argv[2] === 'child') {\n \n     assert(common.fileExists(file));\n     fs.readFile(file, common.mustCall((err, data) => {\n-      const traces = JSON.parse(data.toString()).traceEvents;\n+      const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n       traces.forEach((trace) => {\n         assert.strictEqual(trace.pid, proc.pid);\n         assert(names.includes(trace.name));"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 85,
        "deletions": 6
    }
}