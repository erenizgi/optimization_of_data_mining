{
    "author": "lundibundi",
    "message": "module: fix inconsistency between load and _findPath\n\nFiles with multiple extensions are not handled by require-module system\ntherefore if you have file 'file.foo.bar' and require('./file') it won't\nbe found even while using require.extensions['foo.bar'] but before this\ncommit if you have require.extensions['foo.bar'] and\nrequire.extensions['bar'] set then the latter will be called if you do\nrequire('./file') but if you remove the former the former ('foo.bar')\nproperty it will fail.\nThis commit makes it always fail in such cases.\n\nFixes: https://github.com/nodejs/node/issues/4778\n\nPR-URL: https://github.com/nodejs/node/pull/22382\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "1b92214d097358040efb7d3ec5dff1736f364bc0",
    "files": [
        {
            "sha": "fba416d4db35d65d104969868c82055d946ee51d",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/1b92214d097358040efb7d3ec5dff1736f364bc0/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/1b92214d097358040efb7d3ec5dff1736f364bc0/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=1b92214d097358040efb7d3ec5dff1736f364bc0",
            "patch": "@@ -217,6 +217,16 @@ function tryExtensions(p, exts, isMain) {\n   return false;\n }\n \n+function readExtensions() {\n+  const exts = Object.keys(Module._extensions);\n+  for (var i = 0, j = 0; i < exts.length; ++i) {\n+    if (path.extname(exts[i]) === '')\n+      exts[j++] = exts[i];\n+  }\n+  exts.length = j;\n+  return exts;\n+}\n+\n var warned = false;\n Module._findPath = function(request, paths, isMain) {\n   if (path.isAbsolute(request)) {\n@@ -273,15 +283,15 @@ Module._findPath = function(request, paths, isMain) {\n       if (!filename) {\n         // try it with each of the extensions\n         if (exts === undefined)\n-          exts = Object.keys(Module._extensions);\n+          exts = readExtensions();\n         filename = tryExtensions(basePath, exts, isMain);\n       }\n     }\n \n     if (!filename && rc === 1) {  // Directory.\n       // try it with each of the extensions at \"index\"\n       if (exts === undefined)\n-        exts = Object.keys(Module._extensions);\n+        exts = readExtensions();\n       filename = tryPackage(basePath, exts, isMain);\n       if (!filename) {\n         filename = tryExtensions(path.resolve(basePath, 'index'), exts, isMain);"
        },
        {
            "sha": "3a51e8725eec60ab196c43e8b94b8deaf4468156",
            "filename": "test/known_issues/test-module-deleted-extensions.js",
            "status": "removed",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/3c2aa4b9f3a566c58d2958e96f239d59f509b50c/test%2Fknown_issues%2Ftest-module-deleted-extensions.js",
            "raw_url": "https://github.com/nodejs/node/raw/3c2aa4b9f3a566c58d2958e96f239d59f509b50c/test%2Fknown_issues%2Ftest-module-deleted-extensions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-module-deleted-extensions.js?ref=3c2aa4b9f3a566c58d2958e96f239d59f509b50c",
            "patch": "@@ -1,18 +0,0 @@\n-'use strict';\n-// Refs: https://github.com/nodejs/node/issues/4778\n-const common = require('../common');\n-const assert = require('assert');\n-const fs = require('fs');\n-const path = require('path');\n-const tmpdir = require('../common/tmpdir');\n-const file = path.join(tmpdir.path, 'test-extensions.foo.bar');\n-\n-tmpdir.refresh();\n-fs.writeFileSync(file, '', 'utf8');\n-require.extensions['.foo.bar'] = (module, path) => {};\n-delete require.extensions['.foo.bar'];\n-require.extensions['.bar'] = common.mustCall((module, path) => {\n-  assert.strictEqual(module.id, file);\n-  assert.strictEqual(path, file);\n-});\n-require(path.join(tmpdir.path, 'test-extensions'));"
        },
        {
            "sha": "f14da0a70f7656fa24708abc7178d4d2cd5b199a",
            "filename": "test/parallel/test-module-deleted-extensions.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/1b92214d097358040efb7d3ec5dff1736f364bc0/test%2Fparallel%2Ftest-module-deleted-extensions.js",
            "raw_url": "https://github.com/nodejs/node/raw/1b92214d097358040efb7d3ec5dff1736f364bc0/test%2Fparallel%2Ftest-module-deleted-extensions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-deleted-extensions.js?ref=1b92214d097358040efb7d3ec5dff1736f364bc0",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+// Refs: https://github.com/nodejs/node/issues/4778\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const file = path.join(tmpdir.path, 'test-extensions.foo.bar');\n+\n+tmpdir.refresh();\n+fs.writeFileSync(file, '', 'utf8');\n+\n+{\n+  require.extensions['.bar'] = common.mustNotCall();\n+  require.extensions['.foo.bar'] = common.mustNotCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  assert.throws(\n+    () => require(modulePath),\n+    new Error(`Cannot find module '${modulePath}'`)\n+  );\n+}\n+\n+{\n+  delete require.extensions['.bar'];\n+  require.extensions['.foo.bar'] = common.mustNotCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  assert.throws(\n+    () => require(modulePath),\n+    new Error(`Cannot find module '${modulePath}'`)\n+  );\n+  assert.throws(\n+    () => require(modulePath + '.foo'),\n+    new Error(`Cannot find module '${modulePath}.foo'`)\n+  );\n+}\n+\n+{\n+  delete require.extensions['.bar'];\n+  delete require.extensions['.foo.bar'];\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  assert.throws(\n+    () => require(modulePath),\n+    new Error(`Cannot find module '${modulePath}'`)\n+  );\n+}\n+\n+{\n+  delete require.extensions['.foo.bar'];\n+  require.extensions['.bar'] = common.mustCall((module, path) => {\n+    assert.strictEqual(module.id, file);\n+    assert.strictEqual(path, file);\n+  });\n+\n+  const modulePath = path.join(tmpdir.path, 'test-extensions.foo');\n+  require(modulePath);\n+}"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 70,
        "deletions": 20
    }
}