{
    "author": "joyeecheung",
    "message": "src: move READONLY_* macros into util.h\n\nMove these macros to util.h so they can be shared among different\nC++ files.\nAlso, renames `READONLY_BOOLEAN_PROPERTY` to `READONLY_TRUE_PROPERTY`\n(since it sets the property to true), and use `ToV8Value` in\n`READONLY_STRING_PROPERTY`.\n\nPR-URL: https://github.com/nodejs/node/pull/24774\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "77618817d0e8210506f8e6e739ac7bf469122179",
    "files": [
        {
            "sha": "dc7d8e21e5a945a1e9de26d942fb68e79618fcaa",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 28,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/77618817d0e8210506f8e6e739ac7bf469122179/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/77618817d0e8210506f8e6e739ac7bf469122179/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=77618817d0e8210506f8e6e739ac7bf469122179",
            "patch": "@@ -123,7 +123,6 @@ using v8::Array;\n using v8::Boolean;\n using v8::Context;\n using v8::DEFAULT;\n-using v8::DontEnum;\n using v8::EscapableHandleScope;\n using v8::Exception;\n using v8::Function;\n@@ -145,8 +144,6 @@ using v8::None;\n using v8::Nothing;\n using v8::Object;\n using v8::ObjectTemplate;\n-using v8::PropertyAttribute;\n-using v8::ReadOnly;\n using v8::Script;\n using v8::ScriptOrigin;\n using v8::SealHandleScope;\n@@ -917,31 +914,12 @@ static Local<Object> GetFeatures(Environment* env) {\n static void DebugProcess(const FunctionCallbackInfo<Value>& args);\n static void DebugEnd(const FunctionCallbackInfo<Value>& args);\n \n-namespace {\n-\n-#define READONLY_PROPERTY(obj, str, var)                                      \\\n-  do {                                                                        \\\n-    obj->DefineOwnProperty(env->context(),                                    \\\n-                           OneByteString(env->isolate(), str),                \\\n-                           var,                                               \\\n-                           ReadOnly).FromJust();                              \\\n-  } while (0)\n-\n-#define READONLY_DONT_ENUM_PROPERTY(obj, str, var)                            \\\n-  do {                                                                        \\\n-    obj->DefineOwnProperty(env->context(),                                    \\\n-                           OneByteString(env->isolate(), str),                \\\n-                           var,                                               \\\n-                           static_cast<PropertyAttribute>(ReadOnly|DontEnum)) \\\n-        .FromJust();                                                          \\\n-  } while (0)\n-\n-}  // anonymous namespace\n-\n void SetupProcessObject(Environment* env,\n                         const std::vector<std::string>& args,\n                         const std::vector<std::string>& exec_args) {\n-  HandleScope scope(env->isolate());\n+  Isolate* isolate = env->isolate();\n+  HandleScope scope(isolate);\n+  Local<Context> context = env->context();\n \n   Local<Object> process = env->process_object();\n \n@@ -1282,9 +1260,6 @@ void SetupProcessObject(Environment* env,\n }\n \n \n-#undef READONLY_PROPERTY\n-\n-\n void SignalExit(int signo) {\n   uv_tty_reset_mode();\n #ifdef __FreeBSD__"
        },
        {
            "sha": "6b7f4e62b7cd94f067054adaf8d10f67555ccdf9",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 43,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/77618817d0e8210506f8e6e739ac7bf469122179/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/77618817d0e8210506f8e6e739ac7bf469122179/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=77618817d0e8210506f8e6e739ac7bf469122179",
            "patch": "@@ -12,68 +12,40 @@ using v8::Isolate;\n using v8::Local;\n using v8::Number;\n using v8::Object;\n-using v8::ReadOnly;\n-using v8::String;\n using v8::Value;\n \n // The config binding is used to provide an internal view of compile or runtime\n // config options that are required internally by lib/*.js code. This is an\n // alternative to dropping additional properties onto the process object as\n // has been the practice previously in node.cc.\n \n-#define READONLY_BOOLEAN_PROPERTY(str)                                        \\\n-  do {                                                                        \\\n-    target->DefineOwnProperty(context,                                        \\\n-                              FIXED_ONE_BYTE_STRING(isolate, str),            \\\n-                              True(isolate), ReadOnly).FromJust();            \\\n-  } while (0)\n-\n-#define READONLY_STRING_PROPERTY(obj, str, val)                                \\\n-  do {                                                                         \\\n-    (obj)->DefineOwnProperty(context,                                          \\\n-                             FIXED_ONE_BYTE_STRING(isolate, str),              \\\n-                             String::NewFromUtf8(                              \\\n-                                 isolate,                                      \\\n-                                 val.data(),                                   \\\n-                                 v8::NewStringType::kNormal).ToLocalChecked(), \\\n-                             ReadOnly).FromJust();                             \\\n-  } while (0)\n-\n-\n-#define READONLY_PROPERTY(obj, name, value)                                   \\\n-  do {                                                                        \\\n-    obj->DefineOwnProperty(env->context(),                                    \\\n-                           FIXED_ONE_BYTE_STRING(isolate, name),              \\\n-                           value, ReadOnly).FromJust();                       \\\n-  } while (0)\n-\n static void Initialize(Local<Object> target,\n                        Local<Value> unused,\n                        Local<Context> context) {\n   Environment* env = Environment::GetCurrent(context);\n   Isolate* isolate = env->isolate();\n \n #ifdef NODE_FIPS_MODE\n-  READONLY_BOOLEAN_PROPERTY(\"fipsMode\");\n+  READONLY_TRUE_PROPERTY(target, \"fipsMode\");\n   // TODO(addaleax): Use options parser variable instead.\n   if (per_process_opts->force_fips_crypto)\n-    READONLY_BOOLEAN_PROPERTY(\"fipsForced\");\n+    READONLY_TRUE_PROPERTY(target, \"fipsForced\");\n #endif\n \n #ifdef NODE_HAVE_I18N_SUPPORT\n \n-  READONLY_BOOLEAN_PROPERTY(\"hasIntl\");\n+  READONLY_TRUE_PROPERTY(target, \"hasIntl\");\n \n #ifdef NODE_HAVE_SMALL_ICU\n-  READONLY_BOOLEAN_PROPERTY(\"hasSmallICU\");\n+  READONLY_TRUE_PROPERTY(target, \"hasSmallICU\");\n #endif  // NODE_HAVE_SMALL_ICU\n \n #if NODE_USE_V8_PLATFORM\n-  READONLY_BOOLEAN_PROPERTY(\"hasTracing\");\n+  READONLY_TRUE_PROPERTY(target, \"hasTracing\");\n #endif\n \n #if !defined(NODE_WITHOUT_NODE_OPTIONS)\n-  READONLY_BOOLEAN_PROPERTY(\"hasNodeOptions\");\n+  READONLY_TRUE_PROPERTY(target, \"hasNodeOptions\");\n #endif\n \n   // TODO(addaleax): This seems to be an unused, private API. Remove it?\n@@ -83,35 +55,35 @@ static void Initialize(Local<Object> target,\n #endif  // NODE_HAVE_I18N_SUPPORT\n \n   if (env->options()->preserve_symlinks)\n-    READONLY_BOOLEAN_PROPERTY(\"preserveSymlinks\");\n+    READONLY_TRUE_PROPERTY(target, \"preserveSymlinks\");\n   if (env->options()->preserve_symlinks_main)\n-    READONLY_BOOLEAN_PROPERTY(\"preserveSymlinksMain\");\n+    READONLY_TRUE_PROPERTY(target, \"preserveSymlinksMain\");\n \n   if (env->options()->experimental_modules) {\n-    READONLY_BOOLEAN_PROPERTY(\"experimentalModules\");\n+    READONLY_TRUE_PROPERTY(target, \"experimentalModules\");\n     const std::string& userland_loader = env->options()->userland_loader;\n     if (!userland_loader.empty()) {\n       READONLY_STRING_PROPERTY(target, \"userLoader\",  userland_loader);\n     }\n   }\n \n   if (env->options()->experimental_vm_modules)\n-    READONLY_BOOLEAN_PROPERTY(\"experimentalVMModules\");\n+    READONLY_TRUE_PROPERTY(target, \"experimentalVMModules\");\n \n   if (env->options()->experimental_worker)\n-    READONLY_BOOLEAN_PROPERTY(\"experimentalWorker\");\n+    READONLY_TRUE_PROPERTY(target, \"experimentalWorker\");\n \n   if (env->options()->experimental_repl_await)\n-    READONLY_BOOLEAN_PROPERTY(\"experimentalREPLAwait\");\n+    READONLY_TRUE_PROPERTY(target, \"experimentalREPLAwait\");\n \n   if (env->options()->pending_deprecation)\n-    READONLY_BOOLEAN_PROPERTY(\"pendingDeprecation\");\n+    READONLY_TRUE_PROPERTY(target, \"pendingDeprecation\");\n \n   if (env->options()->expose_internals)\n-    READONLY_BOOLEAN_PROPERTY(\"exposeInternals\");\n+    READONLY_TRUE_PROPERTY(target, \"exposeInternals\");\n \n   if (env->abort_on_uncaught_exception())\n-    READONLY_BOOLEAN_PROPERTY(\"shouldAbortOnUncaughtException\");\n+    READONLY_TRUE_PROPERTY(target, \"shouldAbortOnUncaughtException\");\n \n   READONLY_PROPERTY(target,\n                     \"bits\","
        },
        {
            "sha": "9bf8bb05823c51fb22c295a5620e70c08cfde2cf",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/77618817d0e8210506f8e6e739ac7bf469122179/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/77618817d0e8210506f8e6e739ac7bf469122179/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=77618817d0e8210506f8e6e739ac7bf469122179",
            "patch": "@@ -479,6 +479,31 @@ template <typename T, typename U>\n inline v8::MaybeLocal<v8::Value> ToV8Value(v8::Local<v8::Context> context,\n                                            const std::unordered_map<T, U>& map);\n \n+// These macros expects a `Isolate* isolate` and a `Local<Context> context`\n+// to be in the scope.\n+#define READONLY_PROPERTY(obj, name, value)                                    \\\n+  do {                                                                         \\\n+    obj->DefineOwnProperty(                                                    \\\n+           context, FIXED_ONE_BYTE_STRING(isolate, name), value, v8::ReadOnly) \\\n+        .FromJust();                                                           \\\n+  } while (0)\n+\n+#define READONLY_DONT_ENUM_PROPERTY(obj, name, var)                            \\\n+  do {                                                                         \\\n+    obj->DefineOwnProperty(                                                    \\\n+           context,                                                            \\\n+           OneByteString(isolate, name),                                       \\\n+           var,                                                                \\\n+           static_cast<v8::PropertyAttribute>(v8::ReadOnly | v8::DontEnum))    \\\n+        .FromJust();                                                           \\\n+  } while (0)\n+\n+#define READONLY_TRUE_PROPERTY(obj, name)                                      \\\n+  READONLY_PROPERTY(obj, name, True(isolate))\n+\n+#define READONLY_STRING_PROPERTY(obj, name, str)                               \\\n+  READONLY_PROPERTY(obj, name, ToV8Value(context, str).ToLocalChecked())\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 43,
        "deletions": 71
    }
}