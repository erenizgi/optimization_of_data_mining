{
    "author": "joyeecheung",
    "message": "process: move process mutation into bootstrap/node.js\n\nThis patch moves the part in the report initialization\nthat mutates the process object into bootstrap/node.js\nso it's easier to tell the side effect of the initialization\non the global state during bootstrap.\n\nPR-URL: https://github.com/nodejs/node/pull/25821\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "406329de577d9604e8b1dce9c5a5161e8cb33e25",
    "files": [
        {
            "sha": "c2403bd9ff96049b01936ac5e93c346064e1afc7",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/406329de577d9604e8b1dce9c5a5161e8cb33e25/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/406329de577d9604e8b1dce9c5a5161e8cb33e25/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=406329de577d9604e8b1dce9c5a5161e8cb33e25",
            "patch": "@@ -309,7 +309,18 @@ if (process.env.NODE_V8_COVERAGE) {\n }\n \n if (getOptionValue('--experimental-report')) {\n-  NativeModule.require('internal/process/report').setup();\n+  const {\n+    config,\n+    handleSignal,\n+    report,\n+    syncConfig\n+  } = NativeModule.require('internal/process/report');\n+  process.report = report;\n+  // Download the CLI / ENV config into JS land.\n+  syncConfig(config, false);\n+  if (config.events.includes('signal')) {\n+    process.on(config.signal, handleSignal);\n+  }\n }\n \n function setupTraceCategoryState() {"
        },
        {
            "sha": "4ef03885ec64a7978eb978c25553773816ebc900",
            "filename": "lib/internal/process/report.js",
            "status": "modified",
            "additions": 137,
            "deletions": 139,
            "changes": 276,
            "blob_url": "https://github.com/nodejs/node/blob/406329de577d9604e8b1dce9c5a5161e8cb33e25/lib%2Finternal%2Fprocess%2Freport.js",
            "raw_url": "https://github.com/nodejs/node/raw/406329de577d9604e8b1dce9c5a5161e8cb33e25/lib%2Finternal%2Fprocess%2Freport.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Freport.js?ref=406329de577d9604e8b1dce9c5a5161e8cb33e25",
            "patch": "@@ -3,158 +3,156 @@\n const { emitExperimentalWarning } = require('internal/util');\n const {\n   ERR_INVALID_ARG_TYPE,\n-  ERR_SYNTHETIC } = require('internal/errors').codes;\n+  ERR_SYNTHETIC\n+} = require('internal/errors').codes;\n \n-exports.setup = function() {\n-  const REPORTEVENTS = 1;\n-  const REPORTSIGNAL = 2;\n-  const REPORTFILENAME = 3;\n-  const REPORTPATH = 4;\n-  const REPORTVERBOSE = 5;\n+const REPORTEVENTS = 1;\n+const REPORTSIGNAL = 2;\n+const REPORTFILENAME = 3;\n+const REPORTPATH = 4;\n+const REPORTVERBOSE = 5;\n \n-  // If report is enabled, extract the binding and\n-  // wrap the APIs with thin layers, with some error checks.\n-  // user options can come in from CLI / ENV / API.\n-  // CLI and ENV is intercepted in C++ and the API call here (JS).\n-  // So sync up with both sides as appropriate - initially from\n-  // C++ to JS and from JS to C++ whenever the API is called.\n-  // Some events are controlled purely from JS (signal | exception)\n-  // and some from C++ (fatalerror) so this sync-up is essential for\n-  // correct behavior and alignment with the supplied tunables.\n-  const nr = internalBinding('report');\n+// If report is enabled, extract the binding and\n+// wrap the APIs with thin layers, with some error checks.\n+// user options can come in from CLI / ENV / API.\n+// CLI and ENV is intercepted in C++ and the API call here (JS).\n+// So sync up with both sides as appropriate - initially from\n+// C++ to JS and from JS to C++ whenever the API is called.\n+// Some events are controlled purely from JS (signal | exception)\n+// and some from C++ (fatalerror) so this sync-up is essential for\n+// correct behavior and alignment with the supplied tunables.\n+const nr = internalBinding('report');\n \n-  // Keep it un-exposed; lest programs play with it\n-  // leaving us with a lot of unwanted sanity checks.\n-  let config = {\n-    events: [],\n-    signal: 'SIGUSR2',\n-    filename: '',\n-    path: '',\n-    verbose: false\n-  };\n-  const report = {\n-    setDiagnosticReportOptions(options) {\n-      emitExperimentalWarning('report');\n-      // Reuse the null and undefined checks. Save\n-      // space when dealing with large number of arguments.\n-      const list = parseOptions(options);\n+// Keep it un-exposed; lest programs play with it\n+// leaving us with a lot of unwanted sanity checks.\n+let config = {\n+  events: [],\n+  signal: 'SIGUSR2',\n+  filename: '',\n+  path: '',\n+  verbose: false\n+};\n+const report = {\n+  setDiagnosticReportOptions(options) {\n+    emitExperimentalWarning('report');\n+    // Reuse the null and undefined checks. Save\n+    // space when dealing with large number of arguments.\n+    const list = parseOptions(options);\n \n-      // Flush the stale entries from report, as\n-      // we are refreshing it, items that the users did not\n-      // touch may be hanging around stale otherwise.\n-      config = {};\n+    // Flush the stale entries from report, as\n+    // we are refreshing it, items that the users did not\n+    // touch may be hanging around stale otherwise.\n+    config = {};\n \n-      // The parseOption method returns an array that include\n-      // the indices at which valid params are present.\n-      list.forEach((i) => {\n-        switch (i) {\n-          case REPORTEVENTS:\n-            if (Array.isArray(options.events))\n-              config.events = options.events;\n-            else\n-              throw new ERR_INVALID_ARG_TYPE('events',\n-                                             'Array',\n-                                             options.events);\n-            break;\n-          case REPORTSIGNAL:\n-            if (typeof options.signal !== 'string') {\n-              throw new ERR_INVALID_ARG_TYPE('signal',\n-                                             'String',\n-                                             options.signal);\n-            }\n-            process.removeListener(config.signal, handleSignal);\n-            if (config.events.includes('signal'))\n-              process.on(options.signal, handleSignal);\n-            config.signal = options.signal;\n-            break;\n-          case REPORTFILENAME:\n-            if (typeof options.filename !== 'string') {\n-              throw new ERR_INVALID_ARG_TYPE('filename',\n-                                             'String',\n-                                             options.filename);\n-            }\n-            config.filename = options.filename;\n-            break;\n-          case REPORTPATH:\n-            if (typeof options.path !== 'string')\n-              throw new ERR_INVALID_ARG_TYPE('path', 'String', options.path);\n-            config.path = options.path;\n-            break;\n-          case REPORTVERBOSE:\n-            if (typeof options.verbose !== 'string' &&\n-                typeof options.verbose !== 'boolean') {\n-              throw new ERR_INVALID_ARG_TYPE('verbose',\n-                                             'Booelan | String' +\n-                                             ' (true|false|yes|no)',\n-                                             options.verbose);\n-            }\n-            config.verbose = options.verbose;\n-            break;\n-        }\n-      });\n-      // Upload this new config to C++ land\n-      nr.syncConfig(config, true);\n-    },\n+    // The parseOption method returns an array that include\n+    // the indices at which valid params are present.\n+    list.forEach((i) => {\n+      switch (i) {\n+        case REPORTEVENTS:\n+          if (Array.isArray(options.events))\n+            config.events = options.events;\n+          else\n+            throw new ERR_INVALID_ARG_TYPE('events',\n+                                           'Array',\n+                                           options.events);\n+          break;\n+        case REPORTSIGNAL:\n+          if (typeof options.signal !== 'string') {\n+            throw new ERR_INVALID_ARG_TYPE('signal',\n+                                           'String',\n+                                           options.signal);\n+          }\n+          process.removeListener(config.signal, handleSignal);\n+          if (config.events.includes('signal'))\n+            process.on(options.signal, handleSignal);\n+          config.signal = options.signal;\n+          break;\n+        case REPORTFILENAME:\n+          if (typeof options.filename !== 'string') {\n+            throw new ERR_INVALID_ARG_TYPE('filename',\n+                                           'String',\n+                                           options.filename);\n+          }\n+          config.filename = options.filename;\n+          break;\n+        case REPORTPATH:\n+          if (typeof options.path !== 'string')\n+            throw new ERR_INVALID_ARG_TYPE('path', 'String', options.path);\n+          config.path = options.path;\n+          break;\n+        case REPORTVERBOSE:\n+          if (typeof options.verbose !== 'string' &&\n+              typeof options.verbose !== 'boolean') {\n+            throw new ERR_INVALID_ARG_TYPE('verbose',\n+                                           'Booelan | String' +\n+                                            ' (true|false|yes|no)',\n+                                           options.verbose);\n+          }\n+          config.verbose = options.verbose;\n+          break;\n+      }\n+    });\n+    // Upload this new config to C++ land\n+    nr.syncConfig(config, true);\n+  },\n \n \n-    triggerReport(file, err) {\n-      emitExperimentalWarning('report');\n-      if (err == null) {\n-        if (file == null) {\n-          return nr.triggerReport(new ERR_SYNTHETIC().stack);\n-        }\n-        if (typeof file !== 'string')\n-          throw new ERR_INVALID_ARG_TYPE('file', 'String', file);\n-        return nr.triggerReport(file, new ERR_SYNTHETIC().stack);\n+  triggerReport(file, err) {\n+    emitExperimentalWarning('report');\n+    if (err == null) {\n+      if (file == null) {\n+        return nr.triggerReport(new ERR_SYNTHETIC().stack);\n       }\n-      if (typeof err !== 'object')\n-        throw new ERR_INVALID_ARG_TYPE('err', 'Object', err);\n-      if (file == null)\n-        return nr.triggerReport(err.stack);\n       if (typeof file !== 'string')\n         throw new ERR_INVALID_ARG_TYPE('file', 'String', file);\n-      return nr.triggerReport(file, err.stack);\n-    },\n-    getReport(err) {\n-      emitExperimentalWarning('report');\n-      if (err == null) {\n-        return nr.getReport(new ERR_SYNTHETIC().stack);\n-      } else if (typeof err !== 'object') {\n-        throw new ERR_INVALID_ARG_TYPE('err', 'Object', err);\n-      } else {\n-        return nr.getReport(err.stack);\n-      }\n+      return nr.triggerReport(file, new ERR_SYNTHETIC().stack);\n+    }\n+    if (typeof err !== 'object')\n+      throw new ERR_INVALID_ARG_TYPE('err', 'Object', err);\n+    if (file == null)\n+      return nr.triggerReport(err.stack);\n+    if (typeof file !== 'string')\n+      throw new ERR_INVALID_ARG_TYPE('file', 'String', file);\n+    return nr.triggerReport(file, err.stack);\n+  },\n+  getReport(err) {\n+    emitExperimentalWarning('report');\n+    if (err == null) {\n+      return nr.getReport(new ERR_SYNTHETIC().stack);\n+    } else if (typeof err !== 'object') {\n+      throw new ERR_INVALID_ARG_TYPE('err', 'Object', err);\n+    } else {\n+      return nr.getReport(err.stack);\n     }\n-  };\n-\n-  // Download the CLI / ENV config into JS land.\n-  nr.syncConfig(config, false);\n-\n-  function handleSignal(signo) {\n-    if (typeof signo !== 'string')\n-      signo = config.signal;\n-    nr.onUserSignal(signo);\n   }\n+};\n \n-  if (config.events.includes('signal')) {\n-    process.on(config.signal, handleSignal);\n-  }\n+function handleSignal(signo) {\n+  if (typeof signo !== 'string')\n+    signo = config.signal;\n+  nr.onUserSignal(signo);\n+}\n \n-  function parseOptions(obj) {\n-    const list = [];\n-    if (obj == null)\n-      return list;\n-    if (obj.events != null)\n-      list.push(REPORTEVENTS);\n-    if (obj.signal != null)\n-      list.push(REPORTSIGNAL);\n-    if (obj.filename != null)\n-      list.push(REPORTFILENAME);\n-    if (obj.path != null)\n-      list.push(REPORTPATH);\n-    if (obj.verbose != null)\n-      list.push(REPORTVERBOSE);\n+function parseOptions(obj) {\n+  const list = [];\n+  if (obj == null)\n     return list;\n-  }\n-  process.report = report;\n+  if (obj.events != null)\n+    list.push(REPORTEVENTS);\n+  if (obj.signal != null)\n+    list.push(REPORTSIGNAL);\n+  if (obj.filename != null)\n+    list.push(REPORTFILENAME);\n+  if (obj.path != null)\n+    list.push(REPORTPATH);\n+  if (obj.verbose != null)\n+    list.push(REPORTVERBOSE);\n+  return list;\n+}\n+\n+module.exports = {\n+  config,\n+  handleSignal,\n+  report,\n+  syncConfig: nr.syncConfig\n };"
        }
    ],
    "stats": {
        "total": 289,
        "additions": 149,
        "deletions": 140
    }
}