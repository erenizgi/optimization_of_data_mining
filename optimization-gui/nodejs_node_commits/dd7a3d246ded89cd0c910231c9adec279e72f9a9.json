{
    "author": "antsmartian",
    "message": "lib: repl multiline history support\n\nPR-URL: https://github.com/nodejs/node/pull/22153\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "dd7a3d246ded89cd0c910231c9adec279e72f9a9",
    "files": [
        {
            "sha": "f22d84f1a0df776d82f8a436e16712541133cd9b",
            "filename": "lib/readline.js",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/dd7a3d246ded89cd0c910231c9adec279e72f9a9/lib%2Freadline.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd7a3d246ded89cd0c910231c9adec279e72f9a9/lib%2Freadline.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Freadline.js?ref=dd7a3d246ded89cd0c910231c9adec279e72f9a9",
            "patch": "@@ -217,6 +217,7 @@ function Interface(input, output, completer, terminal) {\n \n     // Current line\n     this.line = '';\n+    this.multiline = '';\n \n     this._setRawMode(true);\n     this.terminal = true;\n@@ -327,6 +328,7 @@ Interface.prototype._addHistory = function() {\n       if (dupIndex !== -1) this.history.splice(dupIndex, 1);\n     }\n \n+    this.multiline += this.line;\n     this.history.unshift(this.line);\n \n     // Only store so many\n@@ -337,6 +339,29 @@ Interface.prototype._addHistory = function() {\n   return this.history[0];\n };\n \n+// Called when a multiline is seen by the repl\n+Interface.prototype.undoHistory = function() {\n+  if (this.terminal) {\n+    this.history.shift();\n+  }\n+};\n+\n+// If it's a multiline code, then add history\n+// accordingly.\n+Interface.prototype.multilineHistory = function() {\n+  // check if we got a multiline code\n+  if (this.multiline !== '' && this.terminal) {\n+    const dupIndex = this.history.indexOf(this.multiline);\n+    if (dupIndex !== -1) this.history.splice(dupIndex, 1);\n+    // Remove the last entered line as multiline\n+    // already contains them.\n+    this.history.shift();\n+    this.history.unshift(this.multiline);\n+  }\n+\n+  // clear the multiline buffer\n+  this.multiline = '';\n+};\n \n Interface.prototype._refreshLine = function() {\n   // line length"
        },
        {
            "sha": "2ecb5abaa4005ce6623f7e8e658708b46175ab40",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/dd7a3d246ded89cd0c910231c9adec279e72f9a9/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd7a3d246ded89cd0c910231c9adec279e72f9a9/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=dd7a3d246ded89cd0c910231c9adec279e72f9a9",
            "patch": "@@ -779,6 +779,7 @@ exports.start = function(prompt,\n \n REPLServer.prototype.clearBufferedCommand = function clearBufferedCommand() {\n   this[kBufferedCommandSymbol] = '';\n+  REPLServer.super_.prototype.multilineHistory.call(this);\n };\n \n REPLServer.prototype.close = function close() {\n@@ -893,6 +894,7 @@ REPLServer.prototype.displayPrompt = function(preserveCursor) {\n     const len = this.lines.level.length ? this.lines.level.length - 1 : 0;\n     const levelInd = '..'.repeat(len);\n     prompt += levelInd + ' ';\n+    REPLServer.super_.prototype.undoHistory.call(this);\n   }\n \n   // Do not overwrite `_initialPrompt` here"
        },
        {
            "sha": "32bab3c8ed9f8310a511be25315d54d57f12b620",
            "filename": "test/parallel/test-repl-persistent-history.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/dd7a3d246ded89cd0c910231c9adec279e72f9a9/test%2Fparallel%2Ftest-repl-persistent-history.js",
            "raw_url": "https://github.com/nodejs/node/raw/dd7a3d246ded89cd0c910231c9adec279e72f9a9/test%2Fparallel%2Ftest-repl-persistent-history.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-persistent-history.js?ref=dd7a3d246ded89cd0c910231c9adec279e72f9a9",
            "patch": "@@ -111,6 +111,13 @@ const tests = [\n     test: [UP],\n     expected: [prompt, replFailedRead, prompt, replDisabled, prompt]\n   },\n+  { // Tests multiline history\n+    env: {},\n+    test: ['{', '}', UP, CLEAR],\n+    expected: [prompt, '{', '... ', '}', '{}\\n',\n+               prompt, `${prompt}{}`, prompt],\n+    clean: false\n+  },\n   {\n     before: function before() {\n       if (common.isWindows) {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}