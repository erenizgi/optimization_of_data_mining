{
    "author": "lpinca",
    "message": "http: destroy the socket on parse error\n\nDestroy the socket if the `'clientError'` event is emitted and there is\nno listener for it.\n\nFixes: https://github.com/nodejs/node/issues/24586\n\nPR-URL: https://github.com/nodejs/node/pull/24757\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "ff7d053ae6b7f620516049e5c9bd1b6ab348835f",
    "files": [
        {
            "sha": "cb62578f564a939be04f070ece0bdb02e69286bc",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ff7d053ae6b7f620516049e5c9bd1b6ab348835f/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff7d053ae6b7f620516049e5c9bd1b6ab348835f/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=ff7d053ae6b7f620516049e5c9bd1b6ab348835f",
            "patch": "@@ -512,8 +512,7 @@ function socketOnError(e) {\n \n   if (!this.server.emit('clientError', e, this)) {\n     if (this.writable) {\n-      this.end(badRequestResponse);\n-      return;\n+      this.write(badRequestResponse);\n     }\n     this.destroy(e);\n   }"
        },
        {
            "sha": "9d51364183385b4d6c854efea0bd66414b18b723",
            "filename": "test/parallel/test-http-server-destroy-socket-on-client-error.js",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/ff7d053ae6b7f620516049e5c9bd1b6ab348835f/test%2Fparallel%2Ftest-http-server-destroy-socket-on-client-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff7d053ae6b7f620516049e5c9bd1b6ab348835f/test%2Fparallel%2Ftest-http-server-destroy-socket-on-client-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-server-destroy-socket-on-client-error.js?ref=ff7d053ae6b7f620516049e5c9bd1b6ab348835f",
            "patch": "@@ -0,0 +1,45 @@\n+'use strict';\n+\n+const { expectsError, mustCall } = require('../common');\n+\n+// Test that the request socket is destroyed if the `'clientError'` event is\n+// emitted and there is no listener for it.\n+\n+const assert = require('assert');\n+const { createServer } = require('http');\n+const { createConnection } = require('net');\n+\n+const server = createServer();\n+\n+server.on('connection', mustCall((socket) => {\n+  socket.on('error', expectsError({\n+    type: Error,\n+    message: 'Parse Error',\n+    code: 'HPE_INVALID_METHOD',\n+    bytesParsed: 0,\n+    rawPacket: Buffer.from('FOO /\\r\\n')\n+  }));\n+}));\n+\n+server.listen(0, () => {\n+  const chunks = [];\n+  const socket = createConnection({\n+    allowHalfOpen: true,\n+    port: server.address().port\n+  });\n+\n+  socket.on('connect', mustCall(() => {\n+    socket.write('FOO /\\r\\n');\n+  }));\n+\n+  socket.on('data', (chunk) => {\n+    chunks.push(chunk);\n+  });\n+\n+  socket.on('end', mustCall(() => {\n+    const expected = Buffer.from('HTTP/1.1 400 Bad Request\\r\\n\\r\\n');\n+    assert(Buffer.concat(chunks).equals(expected));\n+\n+    server.close();\n+  }));\n+});"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 46,
        "deletions": 2
    }
}