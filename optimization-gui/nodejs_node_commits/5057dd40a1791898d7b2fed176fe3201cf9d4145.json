{
    "author": "TimothyGu",
    "message": "fs: support pseudofiles in promises.readFile\n\nPR-URL: https://github.com/nodejs/node/pull/21497\nFixes: https://github.com/nodejs/node/issues/21331\nRefs: http://pubs.opengroup.org/onlinepubs/9699919799/functions/read.html\nRefs: https://groups.google.com/forum/#!topic/nodejs-dev/rxZ_RoH1Gn0\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>",
    "sha": "5057dd40a1791898d7b2fed176fe3201cf9d4145",
    "files": [
        {
            "sha": "bf8a1f2f6a050c75eb2c23555c35bda81ca12f62",
            "filename": "lib/internal/fs/promises.js",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/5057dd40a1791898d7b2fed176fe3201cf9d4145/lib%2Finternal%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/5057dd40a1791898d7b2fed176fe3201cf9d4145/lib%2Finternal%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fpromises.js?ref=5057dd40a1791898d7b2fed176fe3201cf9d4145",
            "patch": "@@ -125,6 +125,10 @@ async function writeFileHandle(filehandle, data, options) {\n   } while (remaining > 0);\n }\n \n+// Note: This is different from kReadFileBufferLength used for non-promisified\n+// fs.readFile.\n+const kReadFileMaxChunkSize = 16384;\n+\n async function readFileHandle(filehandle, options) {\n   const statFields = await binding.fstat(filehandle.fd, false, kUsePromises);\n \n@@ -135,22 +139,19 @@ async function readFileHandle(filehandle, options) {\n     size = 0;\n   }\n \n-  if (size === 0)\n-    return options.encoding ? '' : Buffer.alloc(0);\n-\n   if (size > kMaxLength)\n     throw new ERR_FS_FILE_TOO_LARGE(size);\n \n   const chunks = [];\n-  const chunkSize = Math.min(size, 16384);\n-  let totalRead = 0;\n+  const chunkSize = size === 0 ?\n+    kReadFileMaxChunkSize :\n+    Math.min(size, kReadFileMaxChunkSize);\n   let endOfFile = false;\n   do {\n     const buf = Buffer.alloc(chunkSize);\n     const { bytesRead, buffer } =\n-      await read(filehandle, buf, 0, chunkSize, totalRead);\n-    totalRead += bytesRead;\n-    endOfFile = bytesRead !== chunkSize;\n+      await read(filehandle, buf, 0, chunkSize, -1);\n+    endOfFile = bytesRead === 0;\n     if (bytesRead > 0)\n       chunks.push(buffer.slice(0, bytesRead));\n   } while (!endOfFile);"
        },
        {
            "sha": "9e6fcc2784c49ddbfc69d99ea6dfe0791694e125",
            "filename": "test/parallel/test-fs-promises-file-handle-readFile.js",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/5057dd40a1791898d7b2fed176fe3201cf9d4145/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js",
            "raw_url": "https://github.com/nodejs/node/raw/5057dd40a1791898d7b2fed176fe3201cf9d4145/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js?ref=5057dd40a1791898d7b2fed176fe3201cf9d4145",
            "patch": "@@ -28,5 +28,22 @@ async function validateReadFile() {\n   assert.deepStrictEqual(buffer, readFileData);\n }\n \n+async function validateReadFileProc() {\n+  // Test to make sure reading a file under the /proc directory works. Adapted\n+  // from test-fs-read-file-sync-hostname.js.\n+  // Refs:\n+  // - https://groups.google.com/forum/#!topic/nodejs-dev/rxZ_RoH1Gn0\n+  // - https://github.com/nodejs/node/issues/21331\n+\n+  // Test is Linux-specific.\n+  if (!common.isLinux)\n+    return;\n+\n+  const fileHandle = await open('/proc/sys/kernel/hostname', 'r');\n+  const hostname = await fileHandle.readFile();\n+  assert.ok(hostname.length > 0);\n+}\n+\n validateReadFile()\n+  .then(() => validateReadFileProc())\n   .then(common.mustCall());"
        },
        {
            "sha": "b1186ad2172507e49a814d12058dc99421a01a4f",
            "filename": "test/parallel/test-fs-promises-readfile.js",
            "status": "modified",
            "additions": 31,
            "deletions": 13,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/5057dd40a1791898d7b2fed176fe3201cf9d4145/test%2Fparallel%2Ftest-fs-promises-readfile.js",
            "raw_url": "https://github.com/nodejs/node/raw/5057dd40a1791898d7b2fed176fe3201cf9d4145/test%2Fparallel%2Ftest-fs-promises-readfile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-readfile.js?ref=5057dd40a1791898d7b2fed176fe3201cf9d4145",
            "patch": "@@ -12,17 +12,35 @@ const fn = path.join(tmpdir.path, 'large-file');\n \n common.crashOnUnhandledRejection();\n \n-// Creating large buffer with random content\n-const buffer = Buffer.from(\n-  Array.apply(null, { length: 16834 * 2 })\n-    .map(Math.random)\n-    .map((number) => (number * (1 << 8)))\n-);\n-\n-// Writing buffer to a file then try to read it\n-writeFile(fn, buffer)\n-  .then(() => readFile(fn))\n-  .then((readBuffer) => {\n-    assert.strictEqual(readBuffer.equals(buffer), true);\n-  })\n+async function validateReadFile() {\n+  // Creating large buffer with random content\n+  const buffer = Buffer.from(\n+    Array.apply(null, { length: 16834 * 2 })\n+      .map(Math.random)\n+      .map((number) => (number * (1 << 8)))\n+  );\n+\n+  // Writing buffer to a file then try to read it\n+  await writeFile(fn, buffer);\n+  const readBuffer = await readFile(fn);\n+  assert.strictEqual(readBuffer.equals(buffer), true);\n+}\n+\n+async function validateReadFileProc() {\n+  // Test to make sure reading a file under the /proc directory works. Adapted\n+  // from test-fs-read-file-sync-hostname.js.\n+  // Refs:\n+  // - https://groups.google.com/forum/#!topic/nodejs-dev/rxZ_RoH1Gn0\n+  // - https://github.com/nodejs/node/issues/21331\n+\n+  // Test is Linux-specific.\n+  if (!common.isLinux)\n+    return;\n+\n+  const hostname = await readFile('/proc/sys/kernel/hostname');\n+  assert.ok(hostname.length > 0);\n+}\n+\n+validateReadFile()\n+  .then(() => validateReadFileProc())\n   .then(common.mustCall());"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 57,
        "deletions": 21
    }
}