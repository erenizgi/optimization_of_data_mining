{
    "author": "Trott",
    "message": "test: remove s_client from test-tls-ci-reneg-attack\n\nRewrite test-tls-ci-reneg-attack to use tls.renegotiate() instead of\nexternal (and potentially unpredictable/quirky/buggy) s_client.\n\nRefs: https://github.com/nodejs/node/pull/25676#issuecomment-457307881\n\nPR-URL: https://github.com/nodejs/node/pull/25700\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "c4216194be1b6856b9d02999ea0adc25cc036804",
    "files": [
        {
            "sha": "558efdbdece9e5f7d8e3d707245f2318a680f45b",
            "filename": "test/pummel/test-tls-ci-reneg-attack.js",
            "status": "modified",
            "additions": 21,
            "deletions": 36,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/c4216194be1b6856b9d02999ea0adc25cc036804/test%2Fpummel%2Ftest-tls-ci-reneg-attack.js",
            "raw_url": "https://github.com/nodejs/node/raw/c4216194be1b6856b9d02999ea0adc25cc036804/test%2Fpummel%2Ftest-tls-ci-reneg-attack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpummel%2Ftest-tls-ci-reneg-attack.js?ref=c4216194be1b6856b9d02999ea0adc25cc036804",
            "patch": "@@ -28,7 +28,6 @@ if (!common.opensslCli)\n   common.skip('node compiled without OpenSSL CLI.');\n \n const assert = require('assert');\n-const spawn = require('child_process').spawn;\n const tls = require('tls');\n const fixtures = require('../common/fixtures');\n \n@@ -51,63 +50,49 @@ function test(next) {\n     key: fixtures.readSync('test_key.pem')\n   };\n \n-  let seenError = false;\n-\n   const server = tls.createServer(options, function(conn) {\n     conn.on('error', function(err) {\n       console.error(`Caught exception: ${err}`);\n       assert(/TLS session renegotiation attack/.test(err));\n       conn.destroy();\n-      seenError = true;\n     });\n     conn.pipe(conn);\n   });\n \n-  server.listen(common.PORT, function() {\n-    const args = (`s_client -connect 127.0.0.1:${common.PORT}`).split(' ');\n-    const child = spawn(common.opensslCli, args);\n-\n-    child.stdout.resume();\n-    child.stderr.resume();\n+  server.listen(0, function() {\n+    const options = {\n+      host: server.address().host,\n+      port: server.address().port,\n+      rejectUnauthorized: false\n+    };\n+    const client = tls.connect(options, spam);\n \n-    // Count handshakes, start the attack after the initial handshake is done\n-    let handshakes = 0;\n     let renegs = 0;\n \n-    child.stderr.on('data', function(data) {\n-      if (seenError) return;\n-      handshakes += ((String(data)).match(/verify return:1/g) || []).length;\n-      if (handshakes === 2) spam();\n-      renegs += ((String(data)).match(/RENEGOTIATING/g) || []).length;\n-    });\n-\n-    child.on('exit', function() {\n+    client.on('close', function() {\n       assert.strictEqual(renegs, tls.CLIENT_RENEG_LIMIT + 1);\n       server.close();\n       process.nextTick(next);\n     });\n \n-    let closed = false;\n-    child.stdin.on('error', function(err) {\n-      switch (err.code) {\n-        case 'ECONNRESET':\n-        case 'EPIPE':\n-          break;\n-        default:\n-          assert.strictEqual(err.code, 'ECONNRESET');\n-          break;\n-      }\n-      closed = true;\n+    client.on('error', function(err) {\n+      console.log('CLIENT ERR', err);\n+      throw err;\n     });\n-    child.stdin.on('close', function() {\n-      closed = true;\n+\n+    client.on('close', function(hadErr) {\n+      assert.strictEqual(hadErr, false);\n     });\n \n     // simulate renegotiation attack\n     function spam() {\n-      if (closed) return;\n-      child.stdin.write('R\\n');\n-      setTimeout(spam, 50);\n+      client.write('');\n+      client.renegotiate({}, (err) => {\n+        assert.ifError(err);\n+        assert.ok(renegs <= tls.CLIENT_RENEG_LIMIT);\n+        spam();\n+      });\n+      renegs++;\n     }\n   });\n }"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 21,
        "deletions": 36
    }
}