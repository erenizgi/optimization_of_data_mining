{
    "author": "Trott",
    "message": "test: fix flaky test-http2-ping-flood\n\nThe test is unreliable on some Windows platforms in its current form.\nMake it more robust by using `setInterval()` to repeat the flooding\nuntil an error is triggered.\n\nPR-URL: https://github.com/nodejs/node/pull/19395\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0fb017d684448308bb78d43f2c32e0b15d1c8241",
    "files": [
        {
            "sha": "cf4763b00129cca60c721ed713bc565d6fb28aee",
            "filename": "test/sequential/sequential.status",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0fb017d684448308bb78d43f2c32e0b15d1c8241/test%2Fsequential%2Fsequential.status",
            "raw_url": "https://github.com/nodejs/node/raw/0fb017d684448308bb78d43f2c32e0b15d1c8241/test%2Fsequential%2Fsequential.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Fsequential.status?ref=0fb017d684448308bb78d43f2c32e0b15d1c8241",
            "patch": "@@ -11,7 +11,6 @@ test-inspector-async-call-stack       : PASS, FLAKY\n test-inspector-bindings               : PASS, FLAKY\n test-inspector-debug-end              : PASS, FLAKY\n test-inspector-async-hook-setup-at-signal:  PASS, FLAKY\n-test-http2-ping-flood                 : PASS, FLAKY\n \n [$system==linux]\n "
        },
        {
            "sha": "b414aca8a4703a0af92c02a4b4a5a12cf507f9d7",
            "filename": "test/sequential/test-http2-ping-flood.js",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/0fb017d684448308bb78d43f2c32e0b15d1c8241/test%2Fsequential%2Ftest-http2-ping-flood.js",
            "raw_url": "https://github.com/nodejs/node/raw/0fb017d684448308bb78d43f2c32e0b15d1c8241/test%2Fsequential%2Ftest-http2-ping-flood.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-ping-flood.js?ref=0fb017d684448308bb78d43f2c32e0b15d1c8241",
            "patch": "@@ -4,8 +4,10 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+const assert = require('assert');\n const http2 = require('http2');\n const net = require('net');\n+\n const http2util = require('../common/http2');\n \n // Test that ping flooding causes the session to be torn down\n@@ -15,13 +17,15 @@ const kPing = new http2util.PingFrame();\n \n const server = http2.createServer();\n \n+let interval;\n+\n server.on('stream', common.mustNotCall());\n server.on('session', common.mustCall((session) => {\n-  session.on('error', common.expectsError({\n-    code: 'ERR_HTTP2_ERROR',\n-    message:\n-      'Flooding was detected in this HTTP/2 session, and it must be closed'\n-  }));\n+  session.on('error', (e) => {\n+    assert.strictEqual(e.code, 'ERR_HTTP2_ERROR');\n+    assert(e.message.includes('Flooding was detected'));\n+    clearInterval(interval);\n+  });\n   session.on('close', common.mustCall(() => {\n     server.close();\n   }));\n@@ -31,9 +35,7 @@ server.listen(0, common.mustCall(() => {\n   const client = net.connect(server.address().port);\n \n   // nghttp2 uses a limit of 10000 items in it's outbound queue.\n-  // If this number is exceeded, a flooding error is raised. Set\n-  // this lim higher to account for the ones that nghttp2 is\n-  // successfully able to respond to.\n+  // If this number is exceeded, a flooding error is raised.\n   // TODO(jasnell): Unfortunately, this test is inherently flaky because\n   // it is entirely dependent on how quickly the server is able to handle\n   // the inbound frames and whether those just happen to overflow nghttp2's\n@@ -42,8 +44,10 @@ server.listen(0, common.mustCall(() => {\n   client.on('connect', common.mustCall(() => {\n     client.write(http2util.kClientMagic, () => {\n       client.write(kSettings.data, () => {\n-        for (let n = 0; n < 35000; n++)\n-          client.write(kPing.data);\n+        interval = setInterval(() => {\n+          for (let n = 0; n < 10000; n++)\n+            client.write(kPing.data);\n+        }, 1);\n       });\n     });\n   }));"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 14,
        "deletions": 11
    }
}