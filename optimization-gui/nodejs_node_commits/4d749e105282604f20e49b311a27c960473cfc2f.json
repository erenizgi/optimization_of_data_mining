{
    "author": "Trott",
    "message": "test: fix flaky test-cluster-send-handle-twice\n\nUse `common.mustCall()` to make sure connection callback runs exactly\nonce.\n\nUse `connect` event instead of `setTimeout` to avoid test failing if\ntimer runs before client is connected.\n\nRemove `cluster.worker.disconnect()` after `assert.fail()`. It is\nunreachable code that is unnecessary.\n\nPR-URL: https://github.com/nodejs/node/pull/19700\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "4d749e105282604f20e49b311a27c960473cfc2f",
    "files": [
        {
            "sha": "9eb87d826daa20bfca59f44349568f5cc1ee96b6",
            "filename": "test/parallel/test-cluster-send-handle-twice.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4d749e105282604f20e49b311a27c960473cfc2f/test%2Fparallel%2Ftest-cluster-send-handle-twice.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d749e105282604f20e49b311a27c960473cfc2f/test%2Fparallel%2Ftest-cluster-send-handle-twice.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cluster-send-handle-twice.js?ref=4d749e105282604f20e49b311a27c960473cfc2f",
            "patch": "@@ -40,21 +40,20 @@ if (cluster.isMaster) {\n     }));\n   }\n } else {\n-  const server = net.createServer(function(socket) {\n+  const server = net.createServer(common.mustCall((socket) => {\n     process.send('send-handle-1', socket);\n     process.send('send-handle-2', socket);\n-  });\n+  }));\n \n   server.listen(0, function() {\n     const client = net.connect({\n       host: 'localhost',\n       port: server.address().port\n     });\n     client.on('close', common.mustCall(() => { cluster.worker.disconnect(); }));\n-    setTimeout(function() { client.end(); }, 50);\n+    client.on('connect', () => { client.end(); });\n   }).on('error', function(e) {\n     console.error(e);\n     assert.fail('server.listen failed');\n-    cluster.worker.disconnect();\n   });\n }"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 3,
        "deletions": 4
    }
}