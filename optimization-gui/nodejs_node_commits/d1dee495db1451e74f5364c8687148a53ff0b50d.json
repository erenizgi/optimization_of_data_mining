{
    "author": "bcoe",
    "message": "test: switch to native v8 coverage\n\nPR-URL: https://github.com/nodejs/node/pull/25157\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "d1dee495db1451e74f5364c8687148a53ff0b50d",
    "files": [
        {
            "sha": "b848f777f36d0e452147069caef8b6d5f1acb708",
            "filename": "BUILDING.md",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/BUILDING.md",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/BUILDING.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/BUILDING.md?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -290,9 +290,15 @@ $ CI_JS_SUITES=child-process CI_NATIVE_SUITES= make coverage\n The above command executes tests for the `child-process` subsystem and\n outputs the resulting coverage report.\n \n-The `make coverage` command downloads some tools to the project root directory\n-and overwrites the `lib/` directory. To clean up after generating the coverage\n-reports:\n+Alternatively, for the JavaScript test suite, you can use the `CI_JS_SUITES`\n+variable to run tests in isolation, outputting reports:\n+\n+```text\n+$ CI_JS_SUITES=fs CI_NATIVE_SUITES= make coverage-run-js\n+```\n+\n+The `make coverage` command downloads some tools to the project root directory.\n+To clean up after generating the coverage reports:\n \n ```console\n $ make coverage-clean"
        },
        {
            "sha": "36b61af399da58ef0a3e6ea71ec29d544eae1ab5",
            "filename": "Makefile",
            "status": "modified",
            "additions": 27,
            "deletions": 23,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -11,6 +11,7 @@ STAGINGSERVER ?= node-www\n LOGLEVEL ?= silent\n OSTYPE := $(shell uname -s | tr '[A-Z]' '[a-z]')\n COVTESTS ?= test-cov\n+COV_SKIP_TESTS ?= core_line_numbers.js,testFinalizer.js,test_function/test.js\n GTEST_FILTER ?= \"*\"\n GNUMAKEFLAGS += --no-print-directory\n GCOV ?= gcov\n@@ -181,7 +182,6 @@ coverage-clean:\n \t$(RM) -r node_modules\n \t$(RM) -r gcovr build\n \t$(RM) -r out/$(BUILDTYPE)/.coverage\n-\t$(RM) -r .cov_tmp\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/gen/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/tracing/*.gcda\n@@ -201,55 +201,51 @@ coverage: coverage-test ## Run the tests and generate a coverage report.\n \n .PHONY: coverage-build\n coverage-build: all\n-\tmkdir -p node_modules\n-\tif [ ! -d node_modules/nyc ]; then \\\n-\t\t$(NODE) ./deps/npm install nyc@13 --no-save --no-package-lock; fi\n+\t-$(MAKE) coverage-build-js\n \tif [ ! -d gcovr ]; then git clone -b 3.4 --depth=1 \\\n \t\t--single-branch https://github.com/gcovr/gcovr.git; fi\n \tif [ ! -d build ]; then git clone --depth=1 \\\n \t\t--single-branch https://github.com/nodejs/build.git; fi\n \tif [ ! -f gcovr/scripts/gcovr.orig ]; then \\\n \t\t(cd gcovr && patch -N -p1 < \\\n \t\t\"$(CURDIR)/build/jenkins/scripts/coverage/gcovr-patches-3.4.diff\"); fi\n-\tif [ -d lib_ ]; then $(RM) -r lib; mv lib_ lib; fi\n-\tmv lib lib_\n-\tNODE_DEBUG=nyc $(NODE) ./node_modules/.bin/nyc instrument --extension .js \\\n-\t\t--extension .mjs --exit-on-error lib_/ lib/\n \t$(MAKE)\n \n+.PHONY: coverage-build-js\n+coverage-build-js:\n+\tmkdir -p node_modules\n+\tif [ ! -d node_modules/c8 ]; then \\\n+\t\t$(NODE) ./deps/npm install c8@next --no-save --no-package-lock;\\\n+\tfi\n+\n .PHONY: coverage-test\n coverage-test: coverage-build\n-\t$(RM) -r out/$(BUILDTYPE)/.coverage\n-\t$(RM) -r .cov_tmp\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/gen/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/tracing/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/gen/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/src/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/src/tracing/*.gcda\n-\t-$(MAKE) $(COVTESTS)\n-\tmv lib lib__\n-\tmv lib_ lib\n-\tmkdir -p coverage .cov_tmp\n-\t$(NODE) ./node_modules/.bin/nyc merge 'out/Release/.coverage' \\\n-\t\t.cov_tmp/libcov.json\n-\t(cd lib && .$(NODE) ../node_modules/.bin/nyc report \\\n-\t\t--temp-dir \"$(CURDIR)/.cov_tmp\" \\\n-\t\t--report-dir \"$(CURDIR)/coverage\" \\\n-\t\t--reporter html)\n+\t-NODE_V8_COVERAGE=out/$(BUILDTYPE)/.coverage $(MAKE) $(COVTESTS)\n+\t$(MAKE) coverage-report-js\n \t-(cd out && \"../gcovr/scripts/gcovr\" --gcov-exclude='.*deps' \\\n \t\t--gcov-exclude='.*usr' -v -r Release/obj.target \\\n \t\t--html --html-detail -o ../coverage/cxxcoverage.html \\\n \t\t--gcov-executable=\"$(GCOV)\")\n-\tmv lib lib_\n-\tmv lib__ lib\n \t@echo -n \"Javascript coverage %: \"\n \t@grep -B1 Lines coverage/index.html | head -n1 \\\n \t\t| sed 's/<[^>]*>//g'| sed 's/ //g'\n \t@echo -n \"C++ coverage %: \"\n \t@grep -A3 Lines coverage/cxxcoverage.html | grep style  \\\n \t\t| sed 's/<[^>]*>//g'| sed 's/ //g'\n \n+.PHONY: coverage-report-js\n+coverage-report-js:\n+\t$(NODE) ./node_modules/.bin/c8 report --reporter=html \\\n+\t\t--temp-directory=out/$(BUILDTYPE)/.coverage --omit-relative=false \\\n+\t\t--resolve=./lib --exclude=\"deps/\" --exclude=\"test/\" --exclude=\"tools/\" \\\n+\t\t--wrapper-length=0\n+\n .PHONY: cctest\n # Runs the C++ tests using the built `cctest` executable.\n cctest: all\n@@ -276,6 +272,14 @@ jstest: build-addons build-js-native-api-tests build-node-api-tests ## Runs addo\n \t\t$(CI_JS_SUITES) \\\n \t\t$(CI_NATIVE_SUITES)\n \n+.PHONY: coverage-run-js\n+coverage-run-js:\n+\t$(RM) -r out/$(BUILDTYPE)/.coverage\n+\t$(MAKE) coverage-build-js\n+\t-NODE_V8_COVERAGE=out/$(BUILDTYPE)/.coverage CI_SKIP_TESTS=$(COV_SKIP_TESTS) \\\n+\t  $(MAKE) jstest\n+\t$(MAKE) coverage-report-js\n+\n .PHONY: test\n # This does not run tests of third-party libraries inside deps.\n test: all ## Runs default tests, linters, and builds docs.\n@@ -300,7 +304,7 @@ test-cov: all\n \t$(MAKE) build-js-native-api-tests\n \t$(MAKE) build-node-api-tests\n \t# $(MAKE) cctest\n-\tCI_SKIP_TESTS=core_line_numbers.js $(MAKE) jstest\n+\tCI_SKIP_TESTS=$(COV_SKIP_TESTS) $(MAKE) jstest\n \n test-parallel: all\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) --mode=$(BUILDTYPE_LOWER) parallel"
        },
        {
            "sha": "dec4f12ea6ba99d890459125c7522e8f046eab41",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 17,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -318,26 +318,10 @@ function startup() {\n     }\n   });\n \n-  // Set up coverage exit hooks.\n-  let originalReallyExit = process.reallyExit;\n-  // Core coverage generation using nyc instrumented lib/ files.\n-  // See `make coverage-build`. This does not affect user land.\n-  // TODO(joyeecheung): this and `with_instrumentation.js` can be\n-  // removed in favor of NODE_V8_COVERAGE once we switch to that\n-  // in https://coverage.nodejs.org/\n-  if (global.__coverage__) {\n-    const {\n-      writeCoverage\n-    } = NativeModule.require('internal/coverage-gen/with_instrumentation');\n-    process.on('exit', writeCoverage);\n-    originalReallyExit = process.reallyExit = (code) => {\n-      writeCoverage();\n-      originalReallyExit(code);\n-    };\n-  }\n   // User-facing NODE_V8_COVERAGE environment variable that writes\n   // ScriptCoverage to a specified file.\n   if (process.env.NODE_V8_COVERAGE) {\n+    const originalReallyExit = process.reallyExit;\n     const cwd = NativeModule.require('internal/process/execution').tryGetCwd();\n     const { resolve } = NativeModule.require('path');\n     // Resolve the coverage directory to an absolute path, and"
        },
        {
            "sha": "711a3c3f12b1c8980167c6cb3a2896d0dcafc34f",
            "filename": "lib/internal/coverage-gen/with_instrumentation.js",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/fac11b05b7fa36a936cce32f303a29dd093ac2dc/lib%2Finternal%2Fcoverage-gen%2Fwith_instrumentation.js",
            "raw_url": "https://github.com/nodejs/node/raw/fac11b05b7fa36a936cce32f303a29dd093ac2dc/lib%2Finternal%2Fcoverage-gen%2Fwith_instrumentation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcoverage-gen%2Fwith_instrumentation.js?ref=fac11b05b7fa36a936cce32f303a29dd093ac2dc",
            "patch": "@@ -1,36 +0,0 @@\n-'use strict';\n-\n-// This file contains hooks for nyc instrumented lib/ files to collect\n-// JS coverage for core.\n-// See `make coverage-build`.\n-function writeCoverage() {\n-  if (!global.__coverage__) {\n-    return;\n-  }\n-\n-  const path = require('path');\n-  const { mkdirSync, writeFileSync } = require('fs');\n-\n-  const dirname = path.join(path.dirname(process.execPath), '.coverage');\n-  const filename = `coverage-${process.pid}-${Date.now()}.json`;\n-  try {\n-    mkdirSync(dirname);\n-  } catch (err) {\n-    if (err.code !== 'EEXIST') {\n-      console.error(err);\n-      return;\n-    }\n-  }\n-\n-  const target = path.join(dirname, filename);\n-  const coverageInfo = JSON.stringify(global.__coverage__);\n-  try {\n-    writeFileSync(target, coverageInfo);\n-  } catch (err) {\n-    console.error(err);\n-  }\n-}\n-\n-module.exports = {\n-  writeCoverage\n-};"
        },
        {
            "sha": "91a6304049931aaceecb376f957b0af1328c55f6",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -99,7 +99,6 @@\n       'lib/internal/console/global.js',\n       'lib/internal/console/inspector.js',\n       'lib/internal/coverage-gen/with_profiler.js',\n-      'lib/internal/coverage-gen/with_instrumentation.js',\n       'lib/internal/crypto/certificate.js',\n       'lib/internal/crypto/cipher.js',\n       'lib/internal/crypto/diffiehellman.js',"
        },
        {
            "sha": "eb9d511cb3cf9728c39ad7488826ba80643af460",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -238,9 +238,6 @@ function platformTimeout(ms) {\n   if (process.features.debug)\n     ms = multipliers.two * ms;\n \n-  if (global.__coverage__)\n-    ms = multipliers.four * ms;\n-\n   if (isAIX)\n     return multipliers.two * ms; // default localhost speed is slower on AIX\n \n@@ -299,11 +296,7 @@ function leakedGlobals() {\n     }\n   }\n \n-  if (global.__coverage__) {\n-    return leaked.filter((varname) => !/^(?:cov_|__cov)/.test(varname));\n-  } else {\n-    return leaked;\n-  }\n+  return leaked;\n }\n \n process.on('exit', function() {"
        },
        {
            "sha": "87210ec344c1d767f8e799141b993a5947ce00d7",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d1dee495db1451e74f5364c8687148a53ff0b50d/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1dee495db1451e74f5364c8687148a53ff0b50d/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=d1dee495db1451e74f5364c8687148a53ff0b50d",
            "patch": "@@ -9,7 +9,8 @@ const common = require('../common');\n const assert = require('assert');\n \n const isMainThread = common.isMainThread;\n-const kMaxModuleCount = isMainThread ? 63 : 85;\n+const kCoverageModuleCount = process.env.NODE_V8_COVERAGE ? 1 : 0;\n+const kMaxModuleCount = (isMainThread ? 63 : 85) + kCoverageModuleCount;\n \n assert(list.length <= kMaxModuleCount,\n        `Total length: ${list.length}\\n` + list.join('\\n')"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 40,
        "deletions": 89
    }
}