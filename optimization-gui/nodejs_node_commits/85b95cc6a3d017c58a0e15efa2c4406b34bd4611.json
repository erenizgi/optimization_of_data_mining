{
    "author": "addaleax",
    "message": "worker: ignore --abort-on-uncaught-exception for terminate()\n\nWhen running Worker threads with `--abort-on-uncaught-exception`,\ndo not abort the process when `worker.terminate()` is called.\n\nPR-URL: https://github.com/nodejs/node/pull/26111\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "85b95cc6a3d017c58a0e15efa2c4406b34bd4611",
    "files": [
        {
            "sha": "37028dff6260fcbdabbe2c8fac61a074decf7329",
            "filename": "src/api/environment.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/src%2Fapi%2Fenvironment.cc",
            "raw_url": "https://github.com/nodejs/node/raw/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/src%2Fapi%2Fenvironment.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fapi%2Fenvironment.cc?ref=85b95cc6a3d017c58a0e15efa2c4406b34bd4611",
            "patch": "@@ -32,7 +32,9 @@ static bool AllowWasmCodeGenerationCallback(Local<Context> context,\n static bool ShouldAbortOnUncaughtException(Isolate* isolate) {\n   HandleScope scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  return env != nullptr && env->should_abort_on_uncaught_toggle()[0] &&\n+  return env != nullptr &&\n+         (env->is_main_thread() || !env->is_stopping_worker()) &&\n+         env->should_abort_on_uncaught_toggle()[0] &&\n          !env->inside_should_not_abort_on_uncaught_scope();\n }\n "
        },
        {
            "sha": "63f7acdddc7fd7b51e4a7b278fdeea2dc83a916a",
            "filename": "test/abort/test-worker-abort-uncaught-exception.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/test%2Fabort%2Ftest-worker-abort-uncaught-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/test%2Fabort%2Ftest-worker-abort-uncaught-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fabort%2Ftest-worker-abort-uncaught-exception.js?ref=85b95cc6a3d017c58a0e15efa2c4406b34bd4611",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { spawn } = require('child_process');\n+const { Worker } = require('worker_threads');\n+\n+// Tests that --abort-on-uncaught-exception applies to workers as well.\n+\n+if (process.argv[2] === 'child') {\n+  new Worker('throw new Error(\"foo\");', { eval: true });\n+  return;\n+}\n+\n+const child = spawn(process.execPath, [\n+  '--abort-on-uncaught-exception', __filename, 'child'\n+]);\n+child.on('exit', common.mustCall((code, sig) => {\n+  if (common.isWindows) {\n+    assert.strictEqual(code, 0xC0000005);\n+  } else {\n+    assert(['SIGABRT', 'SIGTRAP', 'SIGILL'].includes(sig),\n+           `Unexpected signal ${sig}`);\n+  }\n+}));"
        },
        {
            "sha": "de73b5e4e34e47298b82c706708554205e944cf3",
            "filename": "test/parallel/test-worker-abort-on-uncaught-exception-terminate.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/test%2Fparallel%2Ftest-worker-abort-on-uncaught-exception-terminate.js",
            "raw_url": "https://github.com/nodejs/node/raw/85b95cc6a3d017c58a0e15efa2c4406b34bd4611/test%2Fparallel%2Ftest-worker-abort-on-uncaught-exception-terminate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-abort-on-uncaught-exception-terminate.js?ref=85b95cc6a3d017c58a0e15efa2c4406b34bd4611",
            "patch": "@@ -0,0 +1,12 @@\n+// Flags: --abort-on-uncaught-exception\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { Worker } = require('worker_threads');\n+\n+// Tests that --abort-on-uncaught-exception does not apply to\n+// termination exceptions.\n+\n+const w = new Worker('while(true);', { eval: true });\n+w.on('online', common.mustCall(() => w.terminate()));\n+w.on('exit', common.mustCall((code) => assert.strictEqual(code, 1)));"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 39,
        "deletions": 1
    }
}