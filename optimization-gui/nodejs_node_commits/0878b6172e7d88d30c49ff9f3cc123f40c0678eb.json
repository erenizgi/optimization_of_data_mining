{
    "author": "joyeecheung",
    "message": "process: move setup of process warnings into node.js\n\nTo clarify the side effects and conditions of the warning setup\nduring bootstrap.\n\nPR-URL: https://github.com/nodejs/node/pull/25263\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>",
    "sha": "0878b6172e7d88d30c49ff9f3cc123f40c0678eb",
    "files": [
        {
            "sha": "307736597108eaac34602f7a6777978c85cdc505",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/0878b6172e7d88d30c49ff9f3cc123f40c0678eb/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/0878b6172e7d88d30c49ff9f3cc123f40c0678eb/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=0878b6172e7d88d30c49ff9f3cc123f40c0678eb",
            "patch": "@@ -107,7 +107,15 @@ function startup() {\n     process.exit = wrapped.exit;\n   }\n \n-  NativeModule.require('internal/process/warning').setup();\n+  const {\n+    onWarning,\n+    emitWarning\n+  } = NativeModule.require('internal/process/warning');\n+  if (!process.noProcessWarnings && process.env.NODE_NO_WARNINGS !== '1') {\n+    process.on('warning', onWarning);\n+  }\n+  process.emitWarning = emitWarning;\n+\n   const {\n     nextTick,\n     runNextTicks"
        },
        {
            "sha": "2052ecf7075f6cf655f9bd9e5e991eaf15052610",
            "filename": "lib/internal/process/warning.js",
            "status": "modified",
            "additions": 78,
            "deletions": 79,
            "changes": 157,
            "blob_url": "https://github.com/nodejs/node/blob/0878b6172e7d88d30c49ff9f3cc123f40c0678eb/lib%2Finternal%2Fprocess%2Fwarning.js",
            "raw_url": "https://github.com/nodejs/node/raw/0878b6172e7d88d30c49ff9f3cc123f40c0678eb/lib%2Finternal%2Fprocess%2Fwarning.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fwarning.js?ref=0878b6172e7d88d30c49ff9f3cc123f40c0678eb",
            "patch": "@@ -3,8 +3,6 @@\n const prefix = `(${process.release.name}:${process.pid}) `;\n const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n \n-exports.setup = setupProcessWarnings;\n-\n // Lazily loaded\n let fs;\n let fd;\n@@ -51,83 +49,84 @@ function doEmitWarning(warning) {\n   return () => process.emit('warning', warning);\n }\n \n-function setupProcessWarnings() {\n-  if (!process.noProcessWarnings && process.env.NODE_NO_WARNINGS !== '1') {\n-    process.on('warning', (warning) => {\n-      if (!(warning instanceof Error)) return;\n-      const isDeprecation = warning.name === 'DeprecationWarning';\n-      if (isDeprecation && process.noDeprecation) return;\n-      const trace = process.traceProcessWarnings ||\n-                    (isDeprecation && process.traceDeprecation);\n-      var msg = prefix;\n-      if (warning.code)\n-        msg += `[${warning.code}] `;\n-      if (trace && warning.stack) {\n-        msg += `${warning.stack}`;\n-      } else {\n-        const toString =\n-          typeof warning.toString === 'function' ?\n-            warning.toString : Error.prototype.toString;\n-        msg += `${toString.apply(warning)}`;\n-      }\n-      if (typeof warning.detail === 'string') {\n-        msg += `\\n${warning.detail}`;\n-      }\n-      const warningFile = lazyOption();\n-      if (warningFile) {\n-        return writeToFile(msg);\n-      }\n-      writeOut(msg);\n-    });\n+function onWarning(warning) {\n+  if (!(warning instanceof Error)) return;\n+  const isDeprecation = warning.name === 'DeprecationWarning';\n+  if (isDeprecation && process.noDeprecation) return;\n+  const trace = process.traceProcessWarnings ||\n+                (isDeprecation && process.traceDeprecation);\n+  var msg = prefix;\n+  if (warning.code)\n+    msg += `[${warning.code}] `;\n+  if (trace && warning.stack) {\n+    msg += `${warning.stack}`;\n+  } else {\n+    const toString =\n+      typeof warning.toString === 'function' ?\n+        warning.toString : Error.prototype.toString;\n+    msg += `${toString.apply(warning)}`;\n+  }\n+  if (typeof warning.detail === 'string') {\n+    msg += `\\n${warning.detail}`;\n+  }\n+  const warningFile = lazyOption();\n+  if (warningFile) {\n+    return writeToFile(msg);\n   }\n+  writeOut(msg);\n+}\n \n-  // process.emitWarning(error)\n-  // process.emitWarning(str[, type[, code]][, ctor])\n-  // process.emitWarning(str[, options])\n-  process.emitWarning = (warning, type, code, ctor, now) => {\n-    let detail;\n-    if (type !== null && typeof type === 'object' && !Array.isArray(type)) {\n-      ctor = type.ctor;\n-      code = type.code;\n-      if (typeof type.detail === 'string')\n-        detail = type.detail;\n-      type = type.type || 'Warning';\n-    } else if (typeof type === 'function') {\n-      ctor = type;\n-      code = undefined;\n-      type = 'Warning';\n-    }\n-    if (type !== undefined && typeof type !== 'string') {\n-      throw new ERR_INVALID_ARG_TYPE('type', 'string', type);\n-    }\n-    if (typeof code === 'function') {\n-      ctor = code;\n-      code = undefined;\n-    } else if (code !== undefined && typeof code !== 'string') {\n-      throw new ERR_INVALID_ARG_TYPE('code', 'string', code);\n-    }\n-    if (typeof warning === 'string') {\n-      // Improve error creation performance by skipping the error frames.\n-      // They are added in the `captureStackTrace()` function below.\n-      const tmpStackLimit = Error.stackTraceLimit;\n-      Error.stackTraceLimit = 0;\n-      // eslint-disable-next-line no-restricted-syntax\n-      warning = new Error(warning);\n-      Error.stackTraceLimit = tmpStackLimit;\n-      warning.name = String(type || 'Warning');\n-      if (code !== undefined) warning.code = code;\n-      if (detail !== undefined) warning.detail = detail;\n-      Error.captureStackTrace(warning, ctor || process.emitWarning);\n-    } else if (!(warning instanceof Error)) {\n-      throw new ERR_INVALID_ARG_TYPE('warning', ['Error', 'string'], warning);\n-    }\n-    if (warning.name === 'DeprecationWarning') {\n-      if (process.noDeprecation)\n-        return;\n-      if (process.throwDeprecation)\n-        throw warning;\n-    }\n-    if (now) process.emit('warning', warning);\n-    else process.nextTick(doEmitWarning(warning));\n-  };\n+// process.emitWarning(error)\n+// process.emitWarning(str[, type[, code]][, ctor])\n+// process.emitWarning(str[, options])\n+function emitWarning(warning, type, code, ctor, now) {\n+  let detail;\n+  if (type !== null && typeof type === 'object' && !Array.isArray(type)) {\n+    ctor = type.ctor;\n+    code = type.code;\n+    if (typeof type.detail === 'string')\n+      detail = type.detail;\n+    type = type.type || 'Warning';\n+  } else if (typeof type === 'function') {\n+    ctor = type;\n+    code = undefined;\n+    type = 'Warning';\n+  }\n+  if (type !== undefined && typeof type !== 'string') {\n+    throw new ERR_INVALID_ARG_TYPE('type', 'string', type);\n+  }\n+  if (typeof code === 'function') {\n+    ctor = code;\n+    code = undefined;\n+  } else if (code !== undefined && typeof code !== 'string') {\n+    throw new ERR_INVALID_ARG_TYPE('code', 'string', code);\n+  }\n+  if (typeof warning === 'string') {\n+    // Improve error creation performance by skipping the error frames.\n+    // They are added in the `captureStackTrace()` function below.\n+    const tmpStackLimit = Error.stackTraceLimit;\n+    Error.stackTraceLimit = 0;\n+    // eslint-disable-next-line no-restricted-syntax\n+    warning = new Error(warning);\n+    Error.stackTraceLimit = tmpStackLimit;\n+    warning.name = String(type || 'Warning');\n+    if (code !== undefined) warning.code = code;\n+    if (detail !== undefined) warning.detail = detail;\n+    Error.captureStackTrace(warning, ctor || process.emitWarning);\n+  } else if (!(warning instanceof Error)) {\n+    throw new ERR_INVALID_ARG_TYPE('warning', ['Error', 'string'], warning);\n+  }\n+  if (warning.name === 'DeprecationWarning') {\n+    if (process.noDeprecation)\n+      return;\n+    if (process.throwDeprecation)\n+      throw warning;\n+  }\n+  if (now) process.emit('warning', warning);\n+  else process.nextTick(doEmitWarning(warning));\n }\n+\n+module.exports = {\n+  onWarning,\n+  emitWarning\n+};"
        }
    ],
    "stats": {
        "total": 167,
        "additions": 87,
        "deletions": 80
    }
}