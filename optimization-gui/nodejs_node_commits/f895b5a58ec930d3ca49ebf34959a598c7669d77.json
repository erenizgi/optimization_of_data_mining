{
    "author": "joyeecheung",
    "message": "src: cache the result of GetOptions() in JS land\n\nInstead of calling into C++ each time we need to check the value\nof a command line option, cache the option map in a new\n`internal/options` module for faster access to the values in JS land.\n\nPR-URL: https://github.com/nodejs/node/pull/24091\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "f895b5a58ec930d3ca49ebf34959a598c7669d77",
    "files": [
        {
            "sha": "2645e78e5eba2142d611b2479f0c189c41469593",
            "filename": "lib/crypto.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Fcrypto.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Fcrypto.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fcrypto.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -35,8 +35,8 @@ const {\n   ERR_CRYPTO_FIPS_UNAVAILABLE\n } = require('internal/errors').codes;\n const constants = internalBinding('constants').crypto;\n-const { getOptions } = internalBinding('options');\n-const pendingDeprecation = getOptions('--pending-deprecation');\n+const { getOptionValue } = require('internal/options');\n+const pendingDeprecation = getOptionValue('--pending-deprecation');\n const {\n   fipsMode,\n   fipsForced"
        },
        {
            "sha": "13363e8c4b8c32067bcd292864c3f83215acbe42",
            "filename": "lib/internal/bash_completion.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbash_completion.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbash_completion.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbash_completion.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -1,8 +1,7 @@\n 'use strict';\n-const { getOptions } = internalBinding('options');\n+const { options, aliases } = require('internal/options');\n \n function print(stream) {\n-  const { options, aliases } = getOptions();\n   const all_opts = [...options.keys(), ...aliases.keys()];\n \n   stream.write(`_node_complete() {"
        },
        {
            "sha": "6e06e560a5728fba30f6b929b04a9bc374816fcc",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -251,8 +251,7 @@\n \n     NativeModule.isInternal = function(id) {\n       return id.startsWith('internal/') ||\n-          (id === 'worker_threads' &&\n-           !internalBinding('options').getOptions('--experimental-worker'));\n+          (id === 'worker_threads' && !config.experimentalWorker);\n     };\n   }\n "
        },
        {
            "sha": "a0cf67b9ead6710bfbcccc095a0fd33f1d951d6e",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -103,12 +103,13 @@\n       NativeModule.require('internal/inspector_async_hook').setup();\n     }\n \n-    const { getOptions } = internalBinding('options');\n-    const helpOption = getOptions('--help');\n-    const completionBashOption = getOptions('--completion-bash');\n-    const experimentalModulesOption = getOptions('--experimental-modules');\n-    const experimentalVMModulesOption = getOptions('--experimental-vm-modules');\n-    const experimentalWorkerOption = getOptions('--experimental-worker');\n+    const { getOptionValue } = NativeModule.require('internal/options');\n+    const helpOption = getOptionValue('--help');\n+    const completionBashOption = getOptionValue('--completion-bash');\n+    const experimentalModulesOption = getOptionValue('--experimental-modules');\n+    const experimentalVMModulesOption =\n+      getOptionValue('--experimental-vm-modules');\n+    const experimentalWorkerOption = getOptionValue('--experimental-worker');\n     if (helpOption) {\n       NativeModule.require('internal/print_help').print(process.stdout);\n       return;\n@@ -721,10 +722,9 @@\n \n     const get = () => {\n       const {\n-        getOptions,\n         envSettings: { kAllowedInEnvironment }\n       } = internalBinding('options');\n-      const { options, aliases } = getOptions();\n+      const { options, aliases } = NativeModule.require('internal/options');\n \n       const allowedNodeEnvironmentFlags = [];\n       for (const [name, info] of options) {"
        },
        {
            "sha": "b08e97b29c5c8d2bf6c737c0997decd78a020f9f",
            "filename": "lib/internal/modules/cjs/helpers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -9,7 +9,7 @@ const {\n   CHAR_HASH,\n } = require('internal/constants');\n \n-const { getOptions } = internalBinding('options');\n+const { getOptionValue } = require('internal/options');\n \n // Invoke with makeRequireFunction(module) where |module| is the Module object\n // to use as the context for the require() function.\n@@ -107,7 +107,7 @@ const builtinLibs = [\n   'v8', 'vm', 'zlib'\n ];\n \n-if (getOptions('--experimental-worker')) {\n+if (getOptionValue('--experimental-worker')) {\n   builtinLibs.push('worker_threads');\n   builtinLibs.sort();\n }"
        },
        {
            "sha": "506bae4b7870e4e18bdd2de2182075eb0f4f0300",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -41,10 +41,10 @@ const {\n   stripBOM,\n   stripShebang\n } = require('internal/modules/cjs/helpers');\n-const options = internalBinding('options');\n-const preserveSymlinks = options.getOptions('--preserve-symlinks');\n-const preserveSymlinksMain = options.getOptions('--preserve-symlinks-main');\n-const experimentalModules = options.getOptions('--experimental-modules');\n+const { getOptionValue } = require('internal/options');\n+const preserveSymlinks = getOptionValue('--preserve-symlinks');\n+const preserveSymlinksMain = getOptionValue('--preserve-symlinks-main');\n+const experimentalModules = getOptionValue('--experimental-modules');\n \n const {\n   ERR_INVALID_ARG_TYPE,"
        },
        {
            "sha": "9aa54d09a1b07c126afce1e2a598cf2b8ab6c4f6",
            "filename": "lib/internal/modules/esm/default_resolve.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -6,9 +6,9 @@ const internalFS = require('internal/fs/utils');\n const { NativeModule } = require('internal/bootstrap/loaders');\n const { extname } = require('path');\n const { realpathSync } = require('fs');\n-const { getOptions } = internalBinding('options');\n-const preserveSymlinks = getOptions('--preserve-symlinks');\n-const preserveSymlinksMain = getOptions('--preserve-symlinks-main');\n+const { getOptionValue } = require('internal/options');\n+const preserveSymlinks = getOptionValue('--preserve-symlinks');\n+const preserveSymlinksMain = getOptionValue('--preserve-symlinks-main');\n const {\n   ERR_MISSING_MODULE,\n   ERR_MODULE_RESOLUTION_LEGACY,"
        },
        {
            "sha": "e494787b96c0882d2c2960f3b8f6840ba05fea4b",
            "filename": "lib/internal/options.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Foptions.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Foptions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Foptions.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+\n+const { getOptions } = internalBinding('options');\n+const { options, aliases } = getOptions();\n+\n+function getOptionValue(option) {\n+  const result = options.get(option);\n+  if (!result) {\n+    return undefined;\n+  }\n+  return result.value;\n+}\n+\n+module.exports = {\n+  options,\n+  aliases,\n+  getOptionValue\n+};"
        },
        {
            "sha": "d9ab3c1ad84e9035056419961f7a82df64263f2d",
            "filename": "lib/internal/print_help.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fprint_help.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fprint_help.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprint_help.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -1,5 +1,6 @@\n 'use strict';\n-const { getOptions, types } = internalBinding('options');\n+\n+const { types } = internalBinding('options');\n \n const typeLookup = [];\n for (const key of Object.keys(types))\n@@ -132,7 +133,7 @@ function format({ options, aliases = new Map(), firstColumn, secondColumn }) {\n }\n \n function print(stream) {\n-  const { options, aliases } = getOptions();\n+  const { options, aliases } = require('internal/options');\n \n   // Use 75 % of the available width, and at least 70 characters.\n   const width = Math.max(70, (stream.columns || 0) * 0.75);"
        },
        {
            "sha": "f81053a1c3c3ad7274a1344cf64ccc2203657022",
            "filename": "lib/internal/process/esm_loader.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fprocess%2Fesm_loader.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Finternal%2Fprocess%2Fesm_loader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fesm_loader.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -48,7 +48,7 @@ exports.ESMLoader = undefined;\n exports.setup = function() {\n   let ESMLoader = new Loader();\n   const loaderPromise = (async () => {\n-    const userLoader = internalBinding('options').getOptions('--loader');\n+    const userLoader = require('internal/options').getOptionValue('--loader');\n     if (userLoader) {\n       const hooks = await ESMLoader.import(\n         userLoader, pathToFileURL(`${process.cwd()}/`).href);"
        },
        {
            "sha": "3391a94396db11447bb9b4079128579206d467a3",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -70,7 +70,7 @@ const {\n   ERR_SCRIPT_EXECUTION_INTERRUPTED\n } = require('internal/errors').codes;\n const { sendInspectorCommand } = require('internal/util/inspector');\n-const experimentalREPLAwait = internalBinding('options').getOptions(\n+const experimentalREPLAwait = require('internal/options').getOptionValue(\n   '--experimental-repl-await'\n );\n const { isRecoverableError } = require('internal/repl/recoverable');"
        },
        {
            "sha": "0cccd284bfc75841bb20c2279d83e300699a5d30",
            "filename": "lib/vm.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Fvm.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/lib%2Fvm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fvm.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -418,7 +418,7 @@ module.exports = {\n   compileFunction,\n };\n \n-if (internalBinding('options').getOptions('--experimental-vm-modules')) {\n+if (require('internal/options').getOptionValue('--experimental-vm-modules')) {\n   const { SourceTextModule } = require('internal/vm/source_text_module');\n   module.exports.SourceTextModule = SourceTextModule;\n }"
        },
        {
            "sha": "1b675458d7e3fd039ba49461b46ffc3b1071c4ab",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -133,6 +133,7 @@\n       'lib/internal/modules/esm/translators.js',\n       'lib/internal/safe_globals.js',\n       'lib/internal/net.js',\n+      'lib/internal/options.js',\n       'lib/internal/print_help.js',\n       'lib/internal/priority_queue.js',\n       'lib/internal/process/esm_loader.js',"
        },
        {
            "sha": "98beb9f4c66b9aed3c6e1d159c2a0893d52c3129",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -365,9 +365,8 @@ HostPort SplitHostPort(const std::string& arg,\n                     ParseAndValidatePort(arg.substr(colon + 1), errors) };\n }\n \n-// Usage: Either:\n-// - getOptions() to get all options + metadata or\n-// - getOptions(string) to get the value of a particular option\n+// Return a map containing all the options and their metadata as well\n+// as the aliases\n void GetOptions(const FunctionCallbackInfo<Value>& args) {\n   Mutex::ScopedLock lock(per_process_opts_mutex);\n   Environment* env = Environment::GetCurrent(args);\n@@ -388,13 +387,8 @@ void GetOptions(const FunctionCallbackInfo<Value>& args) {\n \n   const auto& parser = PerProcessOptionsParser::instance;\n \n-  std::string filter;\n-  if (args[0]->IsString()) filter = *node::Utf8Value(isolate, args[0]);\n-\n   Local<Map> options = Map::New(isolate);\n   for (const auto& item : parser.options_) {\n-    if (!filter.empty() && item.first != filter) continue;\n-\n     Local<Value> value;\n     const auto& option_info = item.second;\n     auto field = option_info.field;\n@@ -443,11 +437,6 @@ void GetOptions(const FunctionCallbackInfo<Value>& args) {\n     }\n     CHECK(!value.IsEmpty());\n \n-    if (!filter.empty()) {\n-      args.GetReturnValue().Set(value);\n-      return;\n-    }\n-\n     Local<Value> name = ToV8Value(context, item.first).ToLocalChecked();\n     Local<Object> info = Object::New(isolate);\n     Local<Value> help_text;\n@@ -469,8 +458,6 @@ void GetOptions(const FunctionCallbackInfo<Value>& args) {\n     }\n   }\n \n-  if (!filter.empty()) return;\n-\n   Local<Value> aliases;\n   if (!ToV8Value(context, parser.aliases_).ToLocal(&aliases)) return;\n "
        },
        {
            "sha": "70011637e08af44ae7d4eaae49010e6538735aae",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f895b5a58ec930d3ca49ebf34959a598c7669d77/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/f895b5a58ec930d3ca49ebf34959a598c7669d77/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=f895b5a58ec930d3ca49ebf34959a598c7669d77",
            "patch": "@@ -11,4 +11,4 @@ const list = process.moduleLoadList.slice();\n \n const assert = require('assert');\n \n-assert(list.length <= 77, list);\n+assert(list.length <= 78, list);"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 49,
        "deletions": 44
    }
}