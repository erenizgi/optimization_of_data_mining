{
    "author": "TimothyGu",
    "message": "deps: cherry-pick 6989b3f6d7 from V8 upstream\n\nOriginal commit message:\n  Fix default Intl language tag handling\n\n  With certain ICU data bundles (such as the Node.js \"small-icu\"),\n  %GetDefaultICULocale() may return a more specific language tag (e.g.\n  \"en-US\") than what's available (e.g. \"en\"). In those cases, consider the\n  more specific language tag supported.\n\n  This CL also resolves the following Node.js issue:\n     https://github.com/nodejs/node/issues/15223\n\n  Bug: v8:7024\n  Cq-Include-Trybots: luci.v8.try:v8_linux_noi18n_rel_ng\n  Change-Id: Ifda0776b3418734d5caa8af4e50c17cda95add73\n  Reviewed-on: https://chromium-review.googlesource.com/668350\n  Commit-Queue: Daniel Ehrenberg <littledan@chromium.org>\n  Reviewed-by: Daniel Ehrenberg <littledan@chromium.org>\n  Cr-Commit-Position: refs/heads/master@{#52716}\n\nPR-URL: https://github.com/nodejs/node/pull/20826\nFixes: https://github.com/nodejs/node/issues/15223\nRefs: https://github.com/v8/v8/commit/6989b3f6d7d6a5e68127332296723317917821eb\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
    "files": [
        {
            "sha": "dd11d7af3c63509e524f89c9d70abe401f08b1a6",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -27,7 +27,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.8',\n+    'v8_embedder_string': '-node.9',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "3c7112716c30cc7973cd6703635cbeeecd33bdeb",
            "filename": "deps/v8/src/js/intl.js",
            "status": "modified",
            "additions": 59,
            "deletions": 30,
            "changes": 89,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Fsrc%2Fjs%2Fintl.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Fsrc%2Fjs%2Fintl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fjs%2Fintl.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -152,18 +152,11 @@ var AVAILABLE_LOCALES = {\n  */\n var DEFAULT_ICU_LOCALE = UNDEFINED;\n \n-function GetDefaultICULocaleJS(service) {\n+function GetDefaultICULocaleJS() {\n   if (IS_UNDEFINED(DEFAULT_ICU_LOCALE)) {\n     DEFAULT_ICU_LOCALE = %GetDefaultICULocale();\n   }\n-  // Check that this is a valid default for this service,\n-  // otherwise fall back to \"und\"\n-  // TODO(littledan,jshin): AvailableLocalesOf sometimes excludes locales\n-  // which don't require tailoring, but work fine with root data. Look into\n-  // exposing this fact in ICU or the way Chrome bundles data.\n-  return (IS_UNDEFINED(service) ||\n-          HAS_OWN_PROPERTY(getAvailableLocalesOf(service), DEFAULT_ICU_LOCALE))\n-         ? DEFAULT_ICU_LOCALE : \"und\";\n+  return DEFAULT_ICU_LOCALE;\n }\n \n /**\n@@ -434,6 +427,48 @@ function resolveLocale(service, requestedLocales, options) {\n }\n \n \n+/**\n+ * Look up the longest non-empty prefix of |locale| that is an element of\n+ * |availableLocales|. Returns undefined when the |locale| is completely\n+ * unsupported by |availableLocales|.\n+ */\n+function bestAvailableLocale(availableLocales, locale) {\n+  do {\n+    if (!IS_UNDEFINED(availableLocales[locale])) {\n+      return locale;\n+    }\n+    // Truncate locale if possible.\n+    var pos = %StringLastIndexOf(locale, '-');\n+    if (pos === -1) {\n+      break;\n+    }\n+    locale = %_Call(StringSubstring, locale, 0, pos);\n+  } while (true);\n+\n+  return UNDEFINED;\n+}\n+\n+\n+/**\n+ * Try to match any mutation of |requestedLocale| against |availableLocales|.\n+ */\n+function attemptSingleLookup(availableLocales, requestedLocale) {\n+  // Remove all extensions.\n+  var noExtensionsLocale = %RegExpInternalReplace(\n+      GetAnyExtensionRE(), requestedLocale, '');\n+  var availableLocale = bestAvailableLocale(\n+      availableLocales, requestedLocale);\n+  if (!IS_UNDEFINED(availableLocale)) {\n+    // Return the resolved locale and extension.\n+    var extensionMatch = %regexp_internal_match(\n+        GetUnicodeExtensionRE(), requestedLocale);\n+    var extension = IS_NULL(extensionMatch) ? '' : extensionMatch[0];\n+    return {locale: availableLocale, extension: extension};\n+  }\n+  return UNDEFINED;\n+}\n+\n+\n /**\n  * Returns best matched supported locale and extension info using basic\n  * lookup algorithm.\n@@ -446,31 +481,25 @@ function lookupMatcher(service, requestedLocales) {\n   var availableLocales = getAvailableLocalesOf(service);\n \n   for (var i = 0; i < requestedLocales.length; ++i) {\n-    // Remove all extensions.\n-    var locale = %RegExpInternalReplace(\n-        GetAnyExtensionRE(), requestedLocales[i], '');\n-    do {\n-      if (!IS_UNDEFINED(availableLocales[locale])) {\n-        // Return the resolved locale and extension.\n-        var extensionMatch = %regexp_internal_match(\n-            GetUnicodeExtensionRE(), requestedLocales[i]);\n-        var extension = IS_NULL(extensionMatch) ? '' : extensionMatch[0];\n-        return {locale: locale, extension: extension, position: i};\n-      }\n-      // Truncate locale if possible.\n-      var pos = %StringLastIndexOf(locale, '-');\n-      if (pos === -1) {\n-        break;\n-      }\n-      locale = %_Call(StringSubstring, locale, 0, pos);\n-    } while (true);\n+    var result = attemptSingleLookup(availableLocales, requestedLocales[i]);\n+    if (!IS_UNDEFINED(result)) {\n+      return result;\n+    }\n+  }\n+\n+  var defLocale = GetDefaultICULocaleJS();\n+\n+  // While ECMA-402 returns defLocale directly, we have to check if it is\n+  // supported, as such support is not guaranteed.\n+  var result = attemptSingleLookup(availableLocales, defLocale);\n+  if (!IS_UNDEFINED(result)) {\n+    return result;\n   }\n \n   // Didn't find a match, return default.\n   return {\n-    locale: GetDefaultICULocaleJS(service),\n-    extension: '',\n-    position: -1\n+    locale: 'und',\n+    extension: ''\n   };\n }\n "
        },
        {
            "sha": "c11e7c0bbf8914938c5bea06300b7a249b334d9f",
            "filename": "deps/v8/test/intl/assert.js",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fassert.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -132,6 +132,16 @@ function assertFalse(value, user_message = '') {\n }\n \n \n+/**\n+ * Throws if value is null.\n+ */\n+function assertNotNull(value, user_message = '') {\n+  if (value === null) {\n+    fail(\"not null\", value, user_message);\n+  }\n+}\n+\n+\n /**\n  * Runs code() and asserts that it throws the specified exception.\n  */\n@@ -189,3 +199,34 @@ function assertInstanceof(obj, type) {\n                     (actualTypeName ? ' but of < ' + actualTypeName + '>' : ''));\n   }\n }\n+\n+\n+/**\n+ * Split a BCP 47 language tag into locale and extension.\n+ */\n+function splitLanguageTag(tag) {\n+  var extRe = /(-[0-9A-Za-z](-[0-9A-Za-z]{2,8})+)+$/;\n+  var match = %regexp_internal_match(extRe, tag);\n+  if (match) {\n+    return { locale: tag.slice(0, match.index), extension: match[0] };\n+  }\n+\n+  return { locale: tag, extension: '' };\n+}\n+\n+\n+/**\n+ * Throw if |parent| is not a more general language tag of |child|, nor |child|\n+ * itself, per BCP 47 rules.\n+ */\n+function assertLanguageTag(child, parent) {\n+  var childSplit = splitLanguageTag(child);\n+  var parentSplit = splitLanguageTag(parent);\n+\n+  // Do not compare extensions at this moment, as %GetDefaultICULocale()\n+  // doesn't always output something we support.\n+  if (childSplit.locale !== parentSplit.locale &&\n+      !childSplit.locale.startsWith(parentSplit.locale + '-')) {\n+    fail(child, parent, 'language tag comparison');\n+  }\n+}"
        },
        {
            "sha": "e1a42a100a6b0f7544c9759586b252fe471b4e2d",
            "filename": "deps/v8/test/intl/break-iterator/default-locale.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fdefault-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fdefault-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fdefault-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -37,8 +37,8 @@ assertFalse(options.locale === 'und');\n assertFalse(options.locale === '');\n assertFalse(options.locale === undefined);\n \n-// Then check for equality.\n-assertEquals(options.locale, %GetDefaultICULocale());\n+// Then check for legitimacy.\n+assertLanguageTag(%GetDefaultICULocale(), options.locale);\n \n var iteratorNone = new Intl.v8BreakIterator();\n assertEquals(options.locale, iteratorNone.resolvedOptions().locale);"
        },
        {
            "sha": "ffa44aef081eafb94d6eee5c21d65ccb20ac283c",
            "filename": "deps/v8/test/intl/break-iterator/wellformed-unsupported-locale.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fwellformed-unsupported-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fwellformed-unsupported-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fbreak-iterator%2Fwellformed-unsupported-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -29,4 +29,4 @@\n \n var iterator = Intl.v8BreakIterator(['xx']);\n \n-assertEquals(iterator.resolvedOptions().locale, %GetDefaultICULocale());\n+assertLanguageTag(%GetDefaultICULocale(), iterator.resolvedOptions().locale);"
        },
        {
            "sha": "5fc6ff4665c903908d32278b28ea16c80a3a08ba",
            "filename": "deps/v8/test/intl/collator/default-locale.js",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fdefault-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fdefault-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fdefault-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -37,8 +37,8 @@ assertFalse(options.locale === 'und');\n assertFalse(options.locale === '');\n assertFalse(options.locale === undefined);\n \n-// Then check for equality.\n-assertEquals(options.locale, %GetDefaultICULocale());\n+// Then check for legitimacy.\n+assertLanguageTag(%GetDefaultICULocale(), options.locale);\n \n var collatorNone = new Intl.Collator();\n assertEquals(options.locale, collatorNone.resolvedOptions().locale);\n@@ -48,5 +48,8 @@ var collatorBraket = new Intl.Collator({});\n assertEquals(options.locale, collatorBraket.resolvedOptions().locale);\n \n var collatorWithOptions = new Intl.Collator(undefined, {usage: 'search'});\n-assertEquals(%GetDefaultICULocale() + '-u-co-search',\n-             collatorWithOptions.resolvedOptions().locale);\n+assertLanguageTag(%GetDefaultICULocale(),\n+                  collatorWithOptions.resolvedOptions().locale);\n+assertNotNull(\n+    %regexp_internal_match(/-u(-[a-zA-Z]+-[a-zA-Z]+)*-co-search/,\n+        collatorWithOptions.resolvedOptions().locale));"
        },
        {
            "sha": "ad89e3e2203e31cc2b5ecf2217169c55b548e074",
            "filename": "deps/v8/test/intl/collator/wellformed-unsupported-locale.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fwellformed-unsupported-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fwellformed-unsupported-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fcollator%2Fwellformed-unsupported-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -29,4 +29,4 @@\n \n var collator = Intl.Collator(['xx']);\n \n-assertEquals(collator.resolvedOptions().locale, %GetDefaultICULocale());\n+assertLanguageTag(%GetDefaultICULocale(), collator.resolvedOptions().locale);"
        },
        {
            "sha": "2d79e895b54c38487fc8f850721851343f740d22",
            "filename": "deps/v8/test/intl/date-format/default-locale.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fdefault-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fdefault-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fdefault-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -37,8 +37,8 @@ assertFalse(options.locale === 'und');\n assertFalse(options.locale === '');\n assertFalse(options.locale === undefined);\n \n-// Then check for equality.\n-assertEquals(options.locale, %GetDefaultICULocale());\n+// Then check for legitimacy.\n+assertLanguageTag(%GetDefaultICULocale(), options.locale);\n \n var dtfNone = new Intl.DateTimeFormat();\n assertEquals(options.locale, dtfNone.resolvedOptions().locale);"
        },
        {
            "sha": "b81216483250af335ce2ee71823c32f9f4b150d9",
            "filename": "deps/v8/test/intl/date-format/wellformed-unsupported-locale.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fwellformed-unsupported-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fwellformed-unsupported-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fdate-format%2Fwellformed-unsupported-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -29,4 +29,4 @@\n \n var dtf = Intl.DateTimeFormat(['xx']);\n \n-assertEquals(dtf.resolvedOptions().locale, %GetDefaultICULocale());\n+assertLanguageTag(%GetDefaultICULocale(), dtf.resolvedOptions().locale);"
        },
        {
            "sha": "a24aec23332786bf35225dc69d4ed0c6d8552ca3",
            "filename": "deps/v8/test/intl/number-format/default-locale.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fdefault-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fdefault-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fdefault-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -37,8 +37,8 @@ assertFalse(options.locale === 'und');\n assertFalse(options.locale === '');\n assertFalse(options.locale === undefined);\n \n-// Then check for equality.\n-assertEquals(options.locale, %GetDefaultICULocale());\n+// Then check for legitimacy.\n+assertLanguageTag(%GetDefaultICULocale(), options.locale);\n \n var nfNone = new Intl.NumberFormat();\n assertEquals(options.locale, nfNone.resolvedOptions().locale);"
        },
        {
            "sha": "c51753928eeb8741476f5e99b8023aa86f093112",
            "filename": "deps/v8/test/intl/number-format/wellformed-unsupported-locale.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fwellformed-unsupported-locale.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fwellformed-unsupported-locale.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fintl%2Fnumber-format%2Fwellformed-unsupported-locale.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -29,4 +29,4 @@\n \n var nf = Intl.NumberFormat(['xx']);\n \n-assertEquals(nf.resolvedOptions().locale, %GetDefaultICULocale());\n+assertLanguageTag(%GetDefaultICULocale(), nf.resolvedOptions().locale);"
        },
        {
            "sha": "5f550c31c8b72d021fcc1148a5c738c0e0d0dd4b",
            "filename": "deps/v8/test/mjsunit/regress/regress-6288.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-6288.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fac1d910f3b45fb4ee0479a0d565b564a08b35b/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-6288.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-6288.js?ref=8fac1d910f3b45fb4ee0479a0d565b564a08b35b",
            "patch": "@@ -8,6 +8,6 @@\n // DateTimeFormat but not Collation\n \n if (this.Intl) {\n-  assertEquals('und', Intl.Collator().resolvedOptions().locale);\n+  assertEquals('pt', Intl.Collator().resolvedOptions().locale);\n   assertEquals('pt-BR', Intl.DateTimeFormat().resolvedOptions().locale);\n }"
        }
    ],
    "stats": {
        "total": 165,
        "additions": 119,
        "deletions": 46
    }
}