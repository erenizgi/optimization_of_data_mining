{
    "author": "guybedford",
    "message": "esm: loader hook URL validation and error messages\n\nPR-URL: https://github.com/nodejs/node/pull/21352\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "1bf42f4777bfc7ce61873dbd17660b9e265357e9",
    "files": [
        {
            "sha": "57f64367c1d3ebf8252e005f30fd55f0c91eb012",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -1209,10 +1209,23 @@ An invalid `options.protocol` was passed.\n Both `breakEvalOnSigint` and `eval` options were set in the REPL config, which\n is not supported.\n \n+<a id=\"ERR_INVALID_RETURN_PROPERTY\"></a>\n+### ERR_INVALID_RETURN_PROPERTY\n+\n+Thrown in case a function option does not provide a valid value for one of its\n+returned object properties on execution.\n+\n+<a id=\"ERR_INVALID_RETURN_PROPERTY_VALUE\"></a>\n+### ERR_INVALID_RETURN_PROPERTY_VALUE\n+\n+Thrown in case a function option does not provide an expected value\n+type for one of its returned object properties on execution.\n+\n <a id=\"ERR_INVALID_RETURN_VALUE\"></a>\n ### ERR_INVALID_RETURN_VALUE\n \n-Thrown in case a function option does not return an expected value on execution.\n+Thrown in case a function option does not return an expected value\n+type on execution.\n For example when a function is expected to return a promise.\n \n <a id=\"ERR_INVALID_SYNC_FORK_INPUT\"></a>"
        },
        {
            "sha": "be37c96d018704cff32a96098d6563d55ff2e9df",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -681,6 +681,20 @@ E('ERR_INVALID_PROTOCOL',\n   TypeError);\n E('ERR_INVALID_REPL_EVAL_CONFIG',\n   'Cannot specify both \"breakEvalOnSigint\" and \"eval\" for REPL', TypeError);\n+E('ERR_INVALID_RETURN_PROPERTY', (input, name, prop, value) => {\n+  return `Expected a valid ${input} to be returned for the \"${prop}\" from the` +\n+         ` \"${name}\" function but got ${value}.`;\n+}, TypeError);\n+E('ERR_INVALID_RETURN_PROPERTY_VALUE', (input, name, prop, value) => {\n+  let type;\n+  if (value && value.constructor && value.constructor.name) {\n+    type = `instance of ${value.constructor.name}`;\n+  } else {\n+    type = `type ${typeof value}`;\n+  }\n+  return `Expected ${input} to be returned for the \"${prop}\" from the` +\n+         ` \"${name}\" function but got ${type}.`;\n+}, TypeError);\n E('ERR_INVALID_RETURN_VALUE', (input, name, value) => {\n   let type;\n   if (value && value.constructor && value.constructor.name) {\n@@ -689,7 +703,7 @@ E('ERR_INVALID_RETURN_VALUE', (input, name, value) => {\n     type = `type ${typeof value}`;\n   }\n   return `Expected ${input} to be returned from the \"${name}\"` +\n-          ` function but got ${type}.`;\n+         ` function but got ${type}.`;\n }, TypeError);\n E('ERR_INVALID_SYNC_FORK_INPUT',\n   'Asynchronous forks do not support Buffer, Uint8Array or string input: %s',"
        },
        {
            "sha": "2fa10c7eab9b449cbfcb8fa5fe982d4effcfad8e",
            "filename": "lib/internal/modules/esm/loader.js",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/lib%2Finternal%2Fmodules%2Fesm%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/lib%2Finternal%2Fmodules%2Fesm%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Floader.js?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -2,10 +2,13 @@\n \n const {\n   ERR_INVALID_ARG_TYPE,\n-  ERR_INVALID_PROTOCOL,\n+  ERR_INVALID_RETURN_PROPERTY,\n+  ERR_INVALID_RETURN_PROPERTY_VALUE,\n+  ERR_INVALID_RETURN_VALUE,\n   ERR_MISSING_DYNAMIC_INTSTANTIATE_HOOK,\n   ERR_UNKNOWN_MODULE_FORMAT\n } = require('internal/errors').codes;\n+const { URL } = require('url');\n const ModuleMap = require('internal/modules/esm/module_map');\n const ModuleJob = require('internal/modules/esm/module_job');\n const defaultResolve = require('internal/modules/esm/default_resolve');\n@@ -52,20 +55,42 @@ class Loader {\n     if (!isMain && typeof parentURL !== 'string')\n       throw new ERR_INVALID_ARG_TYPE('parentURL', 'string', parentURL);\n \n-    const { url, format } =\n-      await this._resolve(specifier, parentURL, defaultResolve);\n+    const resolved = await this._resolve(specifier, parentURL, defaultResolve);\n+\n+    if (typeof resolved !== 'object')\n+      throw new ERR_INVALID_RETURN_VALUE(\n+        'object', 'loader resolve', resolved\n+      );\n+\n+    const { url, format } = resolved;\n \n     if (typeof url !== 'string')\n-      throw new ERR_INVALID_ARG_TYPE('url', 'string', url);\n+      throw new ERR_INVALID_RETURN_PROPERTY_VALUE(\n+        'string', 'loader resolve', 'url', url\n+      );\n \n     if (typeof format !== 'string')\n-      throw new ERR_INVALID_ARG_TYPE('format', 'string', format);\n+      throw new ERR_INVALID_RETURN_PROPERTY_VALUE(\n+        'string', 'loader resolve', 'format', format\n+      );\n \n     if (format === 'builtin')\n       return { url: `node:${url}`, format };\n \n+    if (this._resolve !== defaultResolve) {\n+      try {\n+        new URL(url);\n+      } catch (e) {\n+        throw new ERR_INVALID_RETURN_PROPERTY(\n+          'url', 'loader resolve', 'url', url\n+        );\n+      }\n+    }\n+\n     if (format !== 'dynamic' && !url.startsWith('file:'))\n-      throw new ERR_INVALID_PROTOCOL(url, 'file:');\n+      throw new ERR_INVALID_RETURN_PROPERTY(\n+        'file: url', 'loader resolve', 'url', url\n+      );\n \n     return { url, format };\n   }"
        },
        {
            "sha": "f73a9d9be5c08e0c1879951171b4869b3ade1e09",
            "filename": "test/common/index.mjs",
            "status": "modified",
            "additions": 119,
            "deletions": 67,
            "changes": 186,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fcommon%2Findex.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fcommon%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.mjs?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -1,71 +1,123 @@\n // Flags: --experimental-modules\n /* eslint-disable node-core/required-modules */\n+import common from './index.js';\n \n-import assert from 'assert';\n+const {\n+  PORT,\n+  isMainThread,\n+  isWindows,\n+  isWOW64,\n+  isAIX,\n+  isLinuxPPCBE,\n+  isSunOS,\n+  isFreeBSD,\n+  isOpenBSD,\n+  isLinux,\n+  isOSX,\n+  isGlibc,\n+  enoughTestMem,\n+  enoughTestCpu,\n+  rootDir,\n+  buildType,\n+  localIPv6Hosts,\n+  opensslCli,\n+  PIPE,\n+  hasIPv6,\n+  childShouldThrowAndAbort,\n+  ddCommand,\n+  spawnPwd,\n+  spawnSyncPwd,\n+  platformTimeout,\n+  allowGlobals,\n+  leakedGlobals,\n+  mustCall,\n+  mustCallAtLeast,\n+  mustCallAsync,\n+  hasMultiLocalhost,\n+  fileExists,\n+  skipIfEslintMissing,\n+  canCreateSymLink,\n+  getCallSite,\n+  mustNotCall,\n+  printSkipMessage,\n+  skip,\n+  ArrayStream,\n+  nodeProcessAborted,\n+  busyLoop,\n+  isAlive,\n+  noWarnCode,\n+  expectWarning,\n+  expectsError,\n+  skipIfInspectorDisabled,\n+  skipIf32Bits,\n+  getArrayBufferViews,\n+  getBufferSources,\n+  crashOnUnhandledRejection,\n+  getTTYfd,\n+  runWithInvalidFD,\n+  hijackStdout,\n+  hijackStderr,\n+  restoreStdout,\n+  restoreStderr,\n+  isCPPSymbolsNotMapped\n+} = common;\n \n-let knownGlobals = [\n-  Buffer,\n-  clearImmediate,\n-  clearInterval,\n-  clearTimeout,\n-  global,\n-  process,\n-  setImmediate,\n-  setInterval,\n-  setTimeout\n-];\n-\n-if (process.env.NODE_TEST_KNOWN_GLOBALS) {\n-  const knownFromEnv = process.env.NODE_TEST_KNOWN_GLOBALS.split(',');\n-  allowGlobals(...knownFromEnv);\n-}\n-\n-export function allowGlobals(...whitelist) {\n-  knownGlobals = knownGlobals.concat(whitelist);\n-}\n-\n-export function leakedGlobals() {\n-  // Add possible expected globals\n-  if (global.gc) {\n-    knownGlobals.push(global.gc);\n-  }\n-\n-  if (global.DTRACE_HTTP_SERVER_RESPONSE) {\n-    knownGlobals.push(DTRACE_HTTP_SERVER_RESPONSE);\n-    knownGlobals.push(DTRACE_HTTP_SERVER_REQUEST);\n-    knownGlobals.push(DTRACE_HTTP_CLIENT_RESPONSE);\n-    knownGlobals.push(DTRACE_HTTP_CLIENT_REQUEST);\n-    knownGlobals.push(DTRACE_NET_STREAM_END);\n-    knownGlobals.push(DTRACE_NET_SERVER_CONNECTION);\n-  }\n-\n-  if (global.COUNTER_NET_SERVER_CONNECTION) {\n-    knownGlobals.push(COUNTER_NET_SERVER_CONNECTION);\n-    knownGlobals.push(COUNTER_NET_SERVER_CONNECTION_CLOSE);\n-    knownGlobals.push(COUNTER_HTTP_SERVER_REQUEST);\n-    knownGlobals.push(COUNTER_HTTP_SERVER_RESPONSE);\n-    knownGlobals.push(COUNTER_HTTP_CLIENT_REQUEST);\n-    knownGlobals.push(COUNTER_HTTP_CLIENT_RESPONSE);\n-  }\n-\n-  const leaked = [];\n-\n-  for (const val in global) {\n-    if (!knownGlobals.includes(global[val])) {\n-      leaked.push(val);\n-    }\n-  }\n-\n-  if (global.__coverage__) {\n-    return leaked.filter((varname) => !/^(?:cov_|__cov)/.test(varname));\n-  } else {\n-    return leaked;\n-  }\n-}\n-\n-process.on('exit', function() {\n-  const leaked = leakedGlobals();\n-  if (leaked.length > 0) {\n-    assert.fail(`Unexpected global(s) found: ${leaked.join(', ')}`);\n-  }\n-});\n+export {\n+  PORT,\n+  isMainThread,\n+  isWindows,\n+  isWOW64,\n+  isAIX,\n+  isLinuxPPCBE,\n+  isSunOS,\n+  isFreeBSD,\n+  isOpenBSD,\n+  isLinux,\n+  isOSX,\n+  isGlibc,\n+  enoughTestMem,\n+  enoughTestCpu,\n+  rootDir,\n+  buildType,\n+  localIPv6Hosts,\n+  opensslCli,\n+  PIPE,\n+  hasIPv6,\n+  childShouldThrowAndAbort,\n+  ddCommand,\n+  spawnPwd,\n+  spawnSyncPwd,\n+  platformTimeout,\n+  allowGlobals,\n+  leakedGlobals,\n+  mustCall,\n+  mustCallAtLeast,\n+  mustCallAsync,\n+  hasMultiLocalhost,\n+  fileExists,\n+  skipIfEslintMissing,\n+  canCreateSymLink,\n+  getCallSite,\n+  mustNotCall,\n+  printSkipMessage,\n+  skip,\n+  ArrayStream,\n+  nodeProcessAborted,\n+  busyLoop,\n+  isAlive,\n+  noWarnCode,\n+  expectWarning,\n+  expectsError,\n+  skipIfInspectorDisabled,\n+  skipIf32Bits,\n+  getArrayBufferViews,\n+  getBufferSources,\n+  crashOnUnhandledRejection,\n+  getTTYfd,\n+  runWithInvalidFD,\n+  hijackStdout,\n+  hijackStderr,\n+  restoreStdout,\n+  restoreStderr,\n+  isCPPSymbolsNotMapped\n+};"
        },
        {
            "sha": "88b128affd528f56857d1cfbaadb289951e92050",
            "filename": "test/es-module/test-esm-loader-invalid-format.mjs",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fes-module%2Ftest-esm-loader-invalid-format.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fes-module%2Ftest-esm-loader-invalid-format.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-loader-invalid-format.mjs?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -0,0 +1,11 @@\n+// Flags: --experimental-modules --loader ./test/fixtures/es-module-loaders/loader-invalid-format.mjs\n+import { expectsError, mustCall } from '../common';\n+import assert from 'assert';\n+\n+import('../fixtures/es-modules/test-esm-ok.mjs')\n+.then(assert.fail, expectsError({\n+  code: 'ERR_INVALID_RETURN_PROPERTY',\n+  message: 'Expected string to be returned for the \"url\" from the ' +\n+           '\"loader resolve\" function but got \"undefined\"'\n+}))\n+.then(mustCall());"
        },
        {
            "sha": "43971a2e6e3b71fbd15512a1ca093791a93abd1e",
            "filename": "test/es-module/test-esm-loader-invalid-url.mjs",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fes-module%2Ftest-esm-loader-invalid-url.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Fes-module%2Ftest-esm-loader-invalid-url.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-loader-invalid-url.mjs?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -0,0 +1,12 @@\n+// Flags: --experimental-modules --loader ./test/fixtures/es-module-loaders/loader-invalid-url.mjs\n+import { expectsError, mustCall } from '../common';\n+import assert from 'assert';\n+\n+import('../fixtures/es-modules/test-esm-ok.mjs')\n+.then(assert.fail, expectsError({\n+  code: 'ERR_INVALID_RETURN_PROPERTY',\n+  message: 'Expected a valid url to be returned for the \"url\" from the ' +\n+           '\"loader resolve\" function but got ' +\n+           '../fixtures/es-modules/test-esm-ok.mjs.'\n+}))\n+.then(mustCall());"
        },
        {
            "sha": "17a0dcd04daad96f8c2ce3f6f78edf4c87e4acdf",
            "filename": "test/fixtures/es-module-loaders/loader-invalid-format.mjs",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-format.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-format.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-format.mjs?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -0,0 +1,8 @@\n+export async function resolve(specifier, parentModuleURL, defaultResolve) {\n+  if (parentModuleURL && specifier === '../fixtures/es-modules/test-esm-ok.mjs') {\n+    return {\n+      url: 'file:///asdf'\n+    };\n+  }\n+  return defaultResolve(specifier, parentModuleURL);\n+}"
        },
        {
            "sha": "12efbb5021a4bcb655c6a4885a529c0f8835028c",
            "filename": "test/fixtures/es-module-loaders/loader-invalid-url.mjs",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-url.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/1bf42f4777bfc7ce61873dbd17660b9e265357e9/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-url.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-module-loaders%2Floader-invalid-url.mjs?ref=1bf42f4777bfc7ce61873dbd17660b9e265357e9",
            "patch": "@@ -0,0 +1,9 @@\n+export async function resolve(specifier, parentModuleURL, defaultResolve) {\n+  if (parentModuleURL && specifier === '../fixtures/es-modules/test-esm-ok.mjs') {\n+    return {\n+      url: specifier,\n+      format: 'esm'\n+    };\n+  }\n+  return defaultResolve(specifier, parentModuleURL);\n+}"
        }
    ],
    "stats": {
        "total": 294,
        "additions": 219,
        "deletions": 75
    }
}