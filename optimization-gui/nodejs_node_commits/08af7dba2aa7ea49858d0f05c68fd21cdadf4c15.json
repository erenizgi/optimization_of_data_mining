{
    "author": "shigeki",
    "message": "build: add OpenSSL-1.1.0 support\n\n- For Windows, nasm is new build requirements and openssl_no_asm is\n  set to 1 with warning if it is not installed.\n- For use of openssl assemble codes, either gas_version >= 2.23,\n  xcode_version >= 5.0 ,llvm_version >= 3.3 or nasm_version >= 2.10 is\n  needed. Otherwise, openssl_no_asm is set to 1 with warning.\n- FIPS is not supported in OpenSSL-1.1.0 so that it leads an error\n  when openssl_fips options is enabled in configure.\n\nFixes: https://github.com/nodejs/node/issues/4270\nPR-URL: https://github.com/nodejs/node/pull/19794\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "08af7dba2aa7ea49858d0f05c68fd21cdadf4c15",
    "files": [
        {
            "sha": "19b227af403b6de104a2e0a3613408636e1ac8ad",
            "filename": "BUILDING.md",
            "status": "modified",
            "additions": 18,
            "deletions": 38,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/BUILDING.md",
            "raw_url": "https://github.com/nodejs/node/raw/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/BUILDING.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/BUILDING.md?ref=08af7dba2aa7ea49858d0f05c68fd21cdadf4c15",
            "patch": "@@ -88,6 +88,23 @@ Depending on host platform, the selection of toolchains may vary.\n \n * Visual Studio 2017 or the Build Tools thereof\n \n+#### OpenSSL asm support\n+\n+OpenSSL-1.1.0 requires the following asssembler version for use of asm\n+support.\n+\n+* gas (GNU assembler) version 2.23 or higher\n+* xcode version 5.0 or higher\n+* llvm version 3.3 or higher\n+* nasm version 2.10 or higher in Windows\n+\n+Otherwise, `--openssl-no-asm` is added with warning in configure.\n+\n+*Note:* The forthcoming OpenSSL-1.1.1 will require higher\n+ version. Please refer\n+ https://www.openssl.org/docs/man1.1.1/man3/OPENSSL_ia32cap.html for\n+ details.\n+\n ## Building Node.js on supported platforms\n \n *Note:* All prerequisites can be easily installed by following\n@@ -377,44 +394,7 @@ as `deps/icu` (You'll have: `deps/icu/source/...`)\n \n ## Building Node.js with FIPS-compliant OpenSSL\n \n-It is possible to build Node.js with the\n-[OpenSSL FIPS module](https://www.openssl.org/docs/fipsnotes.html) on POSIX\n-systems. Windows is not supported.\n-\n-Building in this way does not mean the runtime is FIPS 140-2 validated, but\n-rather that the runtime uses a validated module. In addition, the validation for\n-the underlying module is only valid if it is deployed in accordance with its\n-[security policy](http://csrc.nist.gov/groups/STM/cmvp/documents/140-1/140sp/140sp1747.pdf).\n-If you need FIPS validated cryptography it is recommended that you read both\n-the [security policy](http://csrc.nist.gov/groups/STM/cmvp/documents/140-1/140sp/140sp1747.pdf)\n-and [user guide](https://openssl.org/docs/fips/UserGuide-2.0.pdf).\n-\n-### Instructions\n-\n-1. Obtain a copy of openssl-fips-x.x.x.tar.gz.\n-   To comply with the security policy you must ensure the path\n-   through which you get the file complies with the requirements\n-   for a \"secure installation\" as described in section 6.6 in\n-   the [user guide](https://openssl.org/docs/fips/UserGuide-2.0.pdf).\n-   For evaluation/experimentation, you can simply download and verify\n-   `openssl-fips-x.x.x.tar.gz` from https://www.openssl.org/source/\n-2. Extract source to `openssl-fips` folder and `cd openssl-fips`\n-3. `./config`\n-4. `make`\n-5. `make install`\n-   (NOTE: to comply with the security policy you must use the exact\n-   commands in steps 3-5 without any additional options as per\n-   Appendix A in the [security policy](http://csrc.nist.gov/groups/STM/cmvp/documents/140-1/140sp/140sp1747.pdf).\n-   The only exception is that `./config no-asm` can be\n-   used in place of `./config`, and the FIPSDIR environment variable\n-   may be used to specify a non-standard install folder for the\n-   validated module, as per User Guide sections 4.2.1, 4.2.2, and 4.2.3.\n-6. Get into Node.js checkout folder\n-7. `./configure --openssl-fips=/path/to/openssl-fips/installdir`\n-   For example on ubuntu 12 the installation directory was\n-   `/usr/local/ssl/fips-2.0`\n-8. Build Node.js with `make -j`\n-9. Verify with `node -p \"process.versions.openssl\"` (for example `1.0.2a-fips`)\n+This version of Node.js does not support FIPS.\n \n ## Building Node.js with external core modules\n "
        },
        {
            "sha": "e1843240adbf32e234d6cd0f8e912d51857da3db",
            "filename": "configure",
            "status": "modified",
            "additions": 47,
            "deletions": 20,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/configure",
            "raw_url": "https://github.com/nodejs/node/raw/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=08af7dba2aa7ea49858d0f05c68fd21cdadf4c15",
            "patch": "@@ -639,6 +639,25 @@ def get_version_helper(cc, regexp):\n   else:\n     return 0\n \n+def get_nasm_version(asm):\n+  try:\n+    proc = subprocess.Popen(shlex.split(asm) + ['-v'],\n+                            stdin=subprocess.PIPE, stderr=subprocess.PIPE,\n+                            stdout=subprocess.PIPE)\n+  except OSError:\n+    warn('''No acceptable ASM compiler found!\n+         Please make sure you have installed nasm from http://www.nasm.us\n+         and refer BUILDING.md.''')\n+    return 0\n+\n+  match = re.match(r\"NASM version ([2-9]\\.[0-9][0-9]+)\",\n+                   proc.communicate()[0])\n+\n+  if match:\n+    return match.group(1)\n+  else:\n+    return 0\n+\n def get_llvm_version(cc):\n   return get_version_helper(\n     cc, r\"(^(?:FreeBSD )?clang version|based on LLVM) ([3-9]\\.[0-9]+)\")\n@@ -677,6 +696,11 @@ def get_gas_version(cc):\n # quite prepared to go that far yet.\n def check_compiler(o):\n   if sys.platform == 'win32':\n+    if not options.openssl_no_asm:\n+      nasm_version = get_nasm_version('nasm')\n+      o['variables']['nasm_version'] = nasm_version\n+      if nasm_version == 0:\n+        o['variables']['openssl_no_asm'] = 1\n     return\n \n   ok, is_clang, clang_version, gcc_version = try_check_compiler(CXX, 'c++')\n@@ -1039,32 +1063,35 @@ def configure_v8(o):\n \n \n def configure_openssl(o):\n-  o['variables']['node_use_openssl'] = b(not options.without_ssl)\n-  o['variables']['node_shared_openssl'] = b(options.shared_openssl)\n-  o['variables']['openssl_no_asm'] = 1 if options.openssl_no_asm else 0\n+  variables = o['variables']\n+  variables['node_use_openssl'] = b(not options.without_ssl)\n+  variables['node_shared_openssl'] = b(options.shared_openssl)\n+  variables['openssl_no_asm'] = 1 if options.openssl_no_asm else 0\n   if options.use_openssl_ca_store:\n     o['defines'] += ['NODE_OPENSSL_CERT_STORE']\n   if options.openssl_system_ca_path:\n-    o['variables']['openssl_system_ca_path'] = options.openssl_system_ca_path\n-  o['variables']['node_without_node_options'] = b(options.without_node_options)\n+    variables['openssl_system_ca_path'] = options.openssl_system_ca_path\n+  variables['node_without_node_options'] = b(options.without_node_options)\n   if options.without_node_options:\n       o['defines'] += ['NODE_WITHOUT_NODE_OPTIONS']\n+\n+  # supported asm compiler for AVX2. See https://github.com/openssl/openssl/\n+  # blob/OpenSSL_1_1_0-stable/crypto/modes/asm/aesni-gcm-x86_64.pl#L52-L69\n+  openssl110_asm_supported = \\\n+  ('gas_version' in variables and variables['gas_version'] >= '2.23') or \\\n+  ('xcode_version' in variables and variables['xcode_version'] >= '5.0') or \\\n+  ('llvm_version' in variables and variables['llvm_version'] >= '3.3') or \\\n+  ('nasm_version' in variables and variables['nasm_version'] >= '2.10')\n+\n+  if not openssl110_asm_supported and variables['openssl_no_asm'] == 0:\n+    warn('''openssl_no_asm is enabled due to missed or old assembler.\n+            Please refer BUILDING.md''')\n+    variables['openssl_no_asm'] = 1\n+\n   if options.openssl_fips:\n-    o['variables']['openssl_fips'] = options.openssl_fips\n-    fips_dir = os.path.join('deps', 'openssl', 'fips')\n-    fips_ld = os.path.abspath(os.path.join(fips_dir, 'fipsld'))\n-    # LINK is for Makefiles, LD/LDXX is for ninja\n-    o['make_fips_settings'] = [\n-      ['LINK', fips_ld + ' <(openssl_fips)/bin/fipsld'],\n-      ['LD', fips_ld + ' <(openssl_fips)/bin/fipsld'],\n-      ['LDXX', fips_ld + ' <(openssl_fips)/bin/fipsld'],\n-    ]\n-  else:\n-    o['variables']['openssl_fips'] = ''\n-    try:\n-      os.remove('config_fips.gypi')\n-    except OSError:\n-      pass\n+     print('Error: FIPS is not supported yet in this version')\n+     exit(1)\n+  variables['openssl_fips'] = ''\n \n   if options.without_ssl:\n     def without_ssl_error(option):"
        },
        {
            "sha": "0f6c160969092b713058a7a97534bcde287d54a4",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=08af7dba2aa7ea49858d0f05c68fd21cdadf4c15",
            "patch": "@@ -609,8 +609,8 @@\n             {\n               'action_name': 'mkssldef',\n               'inputs': [\n-                'deps/openssl/openssl/util/libeay.num',\n-                'deps/openssl/openssl/util/ssleay.num',\n+                'deps/openssl/openssl/util/libcrypto.num',\n+                'deps/openssl/openssl/util/libssl.num',\n               ],\n               'outputs': ['<(SHARED_INTERMEDIATE_DIR)/openssl.def'],\n               'action': ["
        },
        {
            "sha": "3ff53531667417f8a4d74dfdbe509302116584c8",
            "filename": "tools/mkssldef.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/tools%2Fmkssldef.py",
            "raw_url": "https://github.com/nodejs/node/raw/08af7dba2aa7ea49858d0f05c68fd21cdadf4c15/tools%2Fmkssldef.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fmkssldef.py?ref=08af7dba2aa7ea49858d0f05c68fd21cdadf4c15",
            "patch": "@@ -26,7 +26,7 @@\n \n   for filename in filenames:\n     for line in open(filename).readlines():\n-      name, _, meta, _ = re.split('\\s+', line)\n+      name, _, _, meta, _ = re.split('\\s+', line)\n       if any(map(lambda p: p.match(name), excludes)): continue\n       meta = meta.split(':')\n       assert meta[0] in ('EXIST', 'NOEXIST')"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 68,
        "deletions": 61
    }
}