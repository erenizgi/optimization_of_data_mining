{
    "author": "apapirovski",
    "message": "test: fix flaky http2-session-unref\n\nIt's possible for the connections to take too long and since the server\nis already unrefed, the process will just exit. Instead adjust the test\nso that server unref only happens after all sessions have been\nsuccessfuly established and unrefed. That still tests the same condition\nbut will not fail under load.\n\nPR-URL: https://github.com/nodejs/node/pull/20772\nFixes: https://github.com/nodejs/node/issues/20705\nFixes: https://github.com/nodejs/node/issues/20750\nFixes: https://github.com/nodejs/node/issues/20850\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "ef9d0ae6f209851dd43d7d24b12e19547bcf0dbf",
    "files": [
        {
            "sha": "0381971c0eace5419270fb177e1a2e8cfacbba52",
            "filename": "test/parallel/test-http2-session-unref.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/ef9d0ae6f209851dd43d7d24b12e19547bcf0dbf/test%2Fparallel%2Ftest-http2-session-unref.js",
            "raw_url": "https://github.com/nodejs/node/raw/ef9d0ae6f209851dd43d7d24b12e19547bcf0dbf/test%2Fparallel%2Ftest-http2-session-unref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-session-unref.js?ref=ef9d0ae6f209851dd43d7d24b12e19547bcf0dbf",
            "patch": "@@ -9,16 +9,20 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n const http2 = require('http2');\n+const Countdown = require('../common/countdown');\n const makeDuplexPair = require('../common/duplexpair');\n \n const server = http2.createServer();\n const { clientSide, serverSide } = makeDuplexPair();\n \n+const counter = new Countdown(3, () => server.unref());\n+\n // 'session' event should be emitted 3 times:\n // - the vanilla client\n // - the destroyed client\n // - manual 'connection' event emission with generic Duplex stream\n server.on('session', common.mustCallAtLeast((session) => {\n+  counter.dec();\n   session.unref();\n }, 3));\n \n@@ -54,4 +58,3 @@ server.listen(0, common.mustCall(() => {\n   }\n }));\n server.emit('connection', serverSide);\n-server.unref();"
        }
    ],
    "stats": {
        "total": 5,
        "additions": 4,
        "deletions": 1
    }
}