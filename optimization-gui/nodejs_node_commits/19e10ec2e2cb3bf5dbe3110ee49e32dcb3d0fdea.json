{
    "author": "lundibundi",
    "message": "test: refactor process/worker exitCode tests\n\nPR-URL: https://github.com/nodejs/node/pull/21739\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea",
    "files": [
        {
            "sha": "c8c4a2ebe6c7ff6a2b179ae8ae9dde7f8b4e996b",
            "filename": "test/fixtures/process-exit-code-cases.js",
            "status": "added",
            "additions": 113,
            "deletions": 0,
            "changes": 113,
            "blob_url": "https://github.com/nodejs/node/blob/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Ffixtures%2Fprocess-exit-code-cases.js",
            "raw_url": "https://github.com/nodejs/node/raw/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Ffixtures%2Fprocess-exit-code-cases.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fprocess-exit-code-cases.js?ref=19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea",
            "patch": "@@ -0,0 +1,113 @@\n+'use strict';\n+\n+const assert = require('assert');\n+\n+const cases = [];\n+module.exports = cases;\n+\n+function exitsOnExitCodeSet() {\n+  process.exitCode = 42;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 42);\n+    assert.strictEqual(code, 42);\n+  });\n+}\n+cases.push({ func: exitsOnExitCodeSet, result: 42 });\n+\n+function changesCodeViaExit() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 42);\n+    assert.strictEqual(code, 42);\n+  });\n+  process.exit(42);\n+}\n+cases.push({ func: changesCodeViaExit, result: 42 });\n+\n+function changesCodeZeroExit() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 0);\n+    assert.strictEqual(code, 0);\n+  });\n+  process.exit(0);\n+}\n+cases.push({ func: changesCodeZeroExit, result: 0 });\n+\n+function exitWithOneOnUncaught() {\n+  process.exitCode = 99;\n+  process.on('exit', (code) => {\n+    // cannot use assert because it will be uncaughtException -> 1 exit code\n+    // that will render this test useless\n+    if (code !== 1 || process.exitCode !== 1) {\n+      console.log('wrong code! expected 1 for uncaughtException');\n+      process.exit(99);\n+    }\n+  });\n+  throw new Error('ok');\n+}\n+cases.push({\n+  func: exitWithOneOnUncaught,\n+  result: 1,\n+  error: /^Error: ok$/,\n+});\n+\n+function changeCodeInsideExit() {\n+  process.exitCode = 95;\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 95);\n+    assert.strictEqual(code, 95);\n+    process.exitCode = 99;\n+  });\n+}\n+cases.push({ func: changeCodeInsideExit, result: 99 });\n+\n+function zeroExitWithUncaughtHandler() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 0);\n+    assert.strictEqual(code, 0);\n+  });\n+  process.on('uncaughtException', () => {});\n+  throw new Error('ok');\n+}\n+cases.push({ func: zeroExitWithUncaughtHandler, result: 0 });\n+\n+function changeCodeInUncaughtHandler() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 97);\n+    assert.strictEqual(code, 97);\n+  });\n+  process.on('uncaughtException', () => {\n+    process.exitCode = 97;\n+  });\n+  throw new Error('ok');\n+}\n+cases.push({ func: changeCodeInUncaughtHandler, result: 97 });\n+\n+function changeCodeInExitWithUncaught() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 98;\n+  });\n+  throw new Error('ok');\n+}\n+cases.push({\n+  func: changeCodeInExitWithUncaught,\n+  result: 98,\n+  error: /^Error: ok$/,\n+});\n+\n+function exitWithZeroInExitWithUncaught() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 0;\n+  });\n+  throw new Error('ok');\n+}\n+cases.push({\n+  func: exitWithZeroInExitWithUncaught,\n+  result: 0,\n+  error: /^Error: ok$/,\n+});"
        },
        {
            "sha": "9059b0b5c22487b8765cc136b4e0cd6fbfb4f92c",
            "filename": "test/parallel/test-process-exit-code.js",
            "status": "modified",
            "additions": 14,
            "deletions": 117,
            "changes": 131,
            "blob_url": "https://github.com/nodejs/node/blob/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Fparallel%2Ftest-process-exit-code.js",
            "raw_url": "https://github.com/nodejs/node/raw/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Fparallel%2Ftest-process-exit-code.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-exit-code.js?ref=19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea",
            "patch": "@@ -23,113 +23,18 @@\n require('../common');\n const assert = require('assert');\n \n-switch (process.argv[2]) {\n-  case 'child1':\n-    return child1();\n-  case 'child2':\n-    return child2();\n-  case 'child3':\n-    return child3();\n-  case 'child4':\n-    return child4();\n-  case 'child5':\n-    return child5();\n-  case 'child6':\n-    return child6();\n-  case 'child7':\n-    return child7();\n-  case 'child8':\n-    return child8();\n-  case 'child9':\n-    return child9();\n-  case undefined:\n-    return parent();\n-  default:\n-    throw new Error('invalid');\n-}\n-\n-function child1() {\n-  process.exitCode = 42;\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 42);\n-    assert.strictEqual(code, 42);\n-  });\n-}\n-\n-function child2() {\n-  process.exitCode = 99;\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 42);\n-    assert.strictEqual(code, 42);\n-  });\n-  process.exit(42);\n-}\n-\n-function child3() {\n-  process.exitCode = 99;\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 0);\n-    assert.strictEqual(code, 0);\n-  });\n-  process.exit(0);\n-}\n-\n-function child4() {\n-  process.exitCode = 99;\n-  process.on('exit', function(code) {\n-    if (code !== 1 || process.exitCode !== 1) {\n-      console.log('wrong code! expected 1 for uncaughtException');\n-      process.exit(99);\n-    }\n-  });\n-  throw new Error('ok');\n-}\n-\n-function child5() {\n-  process.exitCode = 95;\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 95);\n-    assert.strictEqual(code, 95);\n-    process.exitCode = 99;\n-  });\n-}\n-\n-function child6() {\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 0);\n-    assert.strictEqual(code, 0);\n-  });\n-  process.on('uncaughtException', () => {});\n-  throw new Error('ok');\n-}\n-\n-function child7() {\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 97);\n-    assert.strictEqual(code, 97);\n-  });\n-  process.on('uncaughtException', () => {\n-    process.exitCode = 97;\n-  });\n-  throw new Error('ok');\n-}\n-\n-function child8() {\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 1);\n-    assert.strictEqual(code, 1);\n-    process.exitCode = 98;\n-  });\n-  throw new Error('ok');\n-}\n+const testCases = require('../fixtures/process-exit-code-cases');\n \n-function child9() {\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 1);\n-    assert.strictEqual(code, 1);\n-    process.exitCode = 0;\n-  });\n-  throw new Error('ok');\n+if (!process.argv[2]) {\n+  parent();\n+} else {\n+  const i = parseInt(process.argv[2]);\n+  if (Number.isNaN(i)) {\n+    console.log('Invalid test case index');\n+    process.exit(100);\n+    return;\n+  }\n+  testCases[i].func();\n }\n \n function parent() {\n@@ -138,22 +43,14 @@ function parent() {\n   const f = __filename;\n   const option = { stdio: [ 0, 1, 'ignore' ] };\n \n-  const test = (arg, exit) => {\n+  const test = (arg, name = 'child', exit) => {\n     spawn(node, [f, arg], option).on('exit', (code) => {\n       assert.strictEqual(\n         code, exit,\n-        `wrong exit for ${arg}\\nexpected:${exit} but got:${code}`);\n+        `wrong exit for ${arg}-${name}\\nexpected:${exit} but got:${code}`);\n       console.log(`ok - ${arg} exited with ${exit}`);\n     });\n   };\n \n-  test('child1', 42);\n-  test('child2', 42);\n-  test('child3', 0);\n-  test('child4', 1);\n-  test('child5', 99);\n-  test('child6', 0);\n-  test('child7', 97);\n-  test('child8', 98);\n-  test('child9', 0);\n+  testCases.forEach((tc, i) => test(i, tc.func.name, tc.result));\n }"
        },
        {
            "sha": "f09b834f853b12d1e1e0532251aed6b2c5382f40",
            "filename": "test/parallel/test-worker-exit-code.js",
            "status": "modified",
            "additions": 6,
            "deletions": 117,
            "changes": 123,
            "blob_url": "https://github.com/nodejs/node/blob/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Fparallel%2Ftest-worker-exit-code.js",
            "raw_url": "https://github.com/nodejs/node/raw/19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea/test%2Fparallel%2Ftest-worker-exit-code.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-exit-code.js?ref=19e10ec2e2cb3bf5dbe3110ee49e32dcb3d0fdea",
            "patch": "@@ -9,6 +9,8 @@ const assert = require('assert');\n const worker = require('worker_threads');\n const { Worker, parentPort } = worker;\n \n+const testCases = require('../fixtures/process-exit-code-cases');\n+\n // Do not use isMainThread so that this test itself can be run inside a Worker.\n if (!process.env.HAS_STARTED_WORKER) {\n   process.env.HAS_STARTED_WORKER = 1;\n@@ -19,121 +21,16 @@ if (!process.env.HAS_STARTED_WORKER) {\n     process.exit(100);\n     return;\n   }\n-  parentPort.once('message', (msg) => {\n-    switch (msg) {\n-      case 'child1':\n-        return child1();\n-      case 'child2':\n-        return child2();\n-      case 'child3':\n-        return child3();\n-      case 'child4':\n-        return child4();\n-      case 'child5':\n-        return child5();\n-      case 'child6':\n-        return child6();\n-      case 'child7':\n-        return child7();\n-      case 'child8':\n-        return child8();\n-      case 'child9':\n-        return child9();\n-      default:\n-        throw new Error('invalid');\n-    }\n-  });\n-}\n-\n-function child1() {\n-  process.exitCode = 42;\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 42);\n-  });\n-}\n-\n-function child2() {\n-  process.exitCode = 99;\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 42);\n-  });\n-  process.exit(42);\n-}\n-\n-function child3() {\n-  process.exitCode = 99;\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 0);\n-  });\n-  process.exit(0);\n-}\n-\n-function child4() {\n-  process.exitCode = 99;\n-  process.on('exit', (code) => {\n-    // cannot use assert because it will be uncaughtException -> 1 exit code\n-    // that will render this test useless\n-    if (code !== 1) {\n-      console.error('wrong code! expected 1 for uncaughtException');\n-      process.exit(99);\n-    }\n-  });\n-  throw new Error('ok');\n-}\n-\n-function child5() {\n-  process.exitCode = 95;\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 95);\n-    process.exitCode = 99;\n-  });\n-}\n-\n-function child6() {\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 0);\n-  });\n-  process.on('uncaughtException', common.mustCall(() => {\n-    // handle\n-  }));\n-  throw new Error('ok');\n-}\n-\n-function child7() {\n-  process.on('exit', (code) => {\n-    assert.strictEqual(code, 97);\n-  });\n-  process.on('uncaughtException', common.mustCall(() => {\n-    process.exitCode = 97;\n-  }));\n-  throw new Error('ok');\n-}\n-\n-function child8() {\n-  process.on('exit', (code) => {\n-    assert.strictEqual(process.exitCode, 1);\n-    assert.strictEqual(code, 1);\n-    process.exitCode = 98;\n-  });\n-  throw new Error('ok');\n-}\n-\n-function child9() {\n-  process.on('exit', function(code) {\n-    assert.strictEqual(process.exitCode, 1);\n-    assert.strictEqual(code, 1);\n-    process.exitCode = 0;\n-  });\n-  throw new Error('ok');\n+  parentPort.once('message', (msg) => testCases[msg].func());\n }\n \n function parent() {\n-  const test = (arg, exit, error = null) => {\n+  const test = (arg, name = 'worker', exit, error = null) => {\n     const w = new Worker(__filename);\n     w.on('exit', common.mustCall((code) => {\n       assert.strictEqual(\n         code, exit,\n-        `wrong exit for ${arg}\\nexpected:${exit} but got:${code}`);\n+        `wrong exit for ${arg}-${name}\\nexpected:${exit} but got:${code}`);\n       console.log(`ok - ${arg} exited with ${exit}`);\n     }));\n     if (error) {\n@@ -146,13 +43,5 @@ function parent() {\n     w.postMessage(arg);\n   };\n \n-  test('child1', 42);\n-  test('child2', 42);\n-  test('child3', 0);\n-  test('child4', 1, /^Error: ok$/);\n-  test('child5', 99);\n-  test('child6', 0);\n-  test('child7', 97);\n-  test('child8', 98, /^Error: ok$/);\n-  test('child9', 0, /^Error: ok$/);\n+  testCases.forEach((tc, i) => test(i, tc.func.name, tc.result, tc.error));\n }"
        }
    ],
    "stats": {
        "total": 367,
        "additions": 133,
        "deletions": 234
    }
}