{
    "author": "ofrobots",
    "message": "doc: expand on promises and async_hooks\n\nAsyncHooks have a few subtleties with being able to track promises.\nThis commit adds a section to the docs that explains things the issues.\n\nPR-URL: https://github.com/nodejs/node/pull/18540\nFixes: https://github.com/nodejs/node/issues/18520\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d4b605b9903f261c2cadbec3d04822b0de4e14e2",
    "files": [
        {
            "sha": "e0922fcd1134f51a33ebb6b010405e641938d425",
            "filename": "doc/api/async_hooks.md",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/d4b605b9903f261c2cadbec3d04822b0de4e14e2/doc%2Fapi%2Fasync_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/d4b605b9903f261c2cadbec3d04822b0de4e14e2/doc%2Fapi%2Fasync_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fasync_hooks.md?ref=d4b605b9903f261c2cadbec3d04822b0de4e14e2",
            "patch": "@@ -509,6 +509,9 @@ const server = net.createServer(function onConnection(conn) {\n });\n ```\n \n+Note that promise contexts may not get precise executionAsyncIds by default.\n+See the section on [promise execution tracking][].\n+\n #### `async_hooks.triggerAsyncId()`\n \n * Returns: {number} The ID of the resource responsible for calling the callback\n@@ -531,6 +534,57 @@ const server = net.createServer((conn) => {\n });\n ```\n \n+Note that promise contexts may not get valid triggerAsyncIds by default. See\n+the section on [promise execution tracking][].\n+\n+## Promise execution tracking\n+\n+By default, promise executions are not assigned asyncIds due to the relatively\n+expensive nature of the [promise introspection API][PromiseHooks] provided by\n+V8. This means that programs using promises or `async`/`await` will not get\n+correct execution and trigger ids for promise callback contexts by default.\n+\n+Here's an example:\n+\n+```js\n+const ah = require('async_hooks');\n+Promise.resolve(1729).then(() => {\n+  console.log(`eid ${ah.executionAsyncId()} tid ${ah.triggerAsyncId()}`);\n+});\n+// produces:\n+// eid 1 tid 0\n+```\n+\n+Observe that the `then` callback claims to have executed in the context of the\n+outer scope even though there was an asynchronous hop involved. Also note that\n+the triggerAsyncId value is 0, which means that we are missing context about the\n+resource that caused (triggered) the `then` callback to be executed.\n+\n+Installing async hooks via `async_hooks.createHook` enables promise execution\n+tracking. Example:\n+\n+```js\n+const ah = require('async_hooks');\n+ah.createHook({ init() {} }).enable(); // forces PromiseHooks to be enabled.\n+Promise.resolve(1729).then(() => {\n+  console.log(`eid ${ah.executionAsyncId()} tid ${ah.triggerAsyncId()}`);\n+});\n+// produces:\n+// eid 7 tid 6\n+```\n+\n+In this example, adding any actual hook function enabled the tracking of\n+promises. There are two promises in the example above; the promise created by\n+`Promise.resolve()` and the promise returned by the call to `then`. In the\n+example above, the first promise got the asyncId 6 and the latter got asyncId 7.\n+During the execution of the `then` callback, we are executing in the context of\n+promise with asyncId 7. This promise was triggered by async resource 6.\n+\n+Another subtlety with promises is that `before` and `after` callbacks are run\n+only on chained promises. That means promises not created by `then`/`catch` will\n+not have the `before` and `after` callbacks fired on them. For more details see\n+the details of the V8 [PromiseHooks][] API.\n+\n ## JavaScript Embedder API\n \n Library developers that handle their own asynchronous resources performing tasks\n@@ -655,3 +709,5 @@ constructor.\n [`destroy` callback]: #async_hooks_destroy_asyncid\n [`init` callback]: #async_hooks_init_asyncid_type_triggerasyncid_resource\n [Hook Callbacks]: #async_hooks_hook_callbacks\n+[PromiseHooks]: https://docs.google.com/document/d/1rda3yKGHimKIhg5YeoAmCOtyURgsbTH_qaYR79FELlk\n+[promise execution tracking]: #async_hooks_promise_execution_tracking"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 56,
        "deletions": 0
    }
}