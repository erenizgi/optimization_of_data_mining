{
    "author": "addaleax",
    "message": "src: store fd for libuv streams on Windows\n\nOn Windows, we can't just look up a FD for libuv streams and\nreturn it in `GetFD()`.\nHowever, we do sometimes construct streams from their FDs;\nin those cases, it should be okay to store the value on a class field.\n\nPR-URL: https://github.com/nodejs/node/pull/19377\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "63a84609fb24b245838f2d0838d5141d36f09f83",
    "files": [
        {
            "sha": "f3a88a2ecc80c31012042ef31566a03c730ab68a",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=63a84609fb24b245838f2d0838d5141d36f09f83",
            "patch": "@@ -204,6 +204,7 @@ void PipeWrap::Open(const FunctionCallbackInfo<Value>& args) {\n   int fd = args[0]->Int32Value();\n \n   int err = uv_pipe_open(&wrap->handle_, fd);\n+  wrap->set_fd(fd);\n \n   if (err != 0)\n     env->isolate()->ThrowException(UVException(err, \"uv_pipe_open\"));"
        },
        {
            "sha": "0e700ba39a6b952b267c8bba8ce7f675f5a64a79",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=63a84609fb24b245838f2d0838d5141d36f09f83",
            "patch": "@@ -115,12 +115,14 @@ void LibuvStreamWrap::AddMethods(Environment* env,\n \n \n int LibuvStreamWrap::GetFD() {\n+#ifdef _WIN32\n+  return fd_;\n+#else\n   int fd = -1;\n-#if !defined(_WIN32)\n   if (stream() != nullptr)\n     uv_fileno(reinterpret_cast<uv_handle_t*>(stream()), &fd);\n-#endif\n   return fd;\n+#endif\n }\n \n "
        },
        {
            "sha": "7847ebe754614abda82980cebe2c9d1146536324",
            "filename": "src/stream_wrap.h",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fstream_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Fstream_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.h?ref=63a84609fb24b245838f2d0838d5141d36f09f83",
            "patch": "@@ -88,6 +88,14 @@ class LibuvStreamWrap : public HandleWrap, public StreamBase {\n                          v8::Local<v8::FunctionTemplate> target,\n                          int flags = StreamBase::kFlagNone);\n \n+ protected:\n+  inline void set_fd(int fd) {\n+#ifdef _WIN32\n+    fd_ = fd;\n+#endif\n+  }\n+\n+\n  private:\n   static void GetWriteQueueSize(\n       const v8::FunctionCallbackInfo<v8::Value>& info);\n@@ -101,6 +109,16 @@ class LibuvStreamWrap : public HandleWrap, public StreamBase {\n   static void AfterUvShutdown(uv_shutdown_t* req, int status);\n \n   uv_stream_t* const stream_;\n+\n+#ifdef _WIN32\n+  // We don't always have an FD that we could look up on the stream_\n+  // object itself on Windows. However, for some cases, we open handles\n+  // using FDs; In that case, we can store and provide the value.\n+  // This became necessary because it allows to detect situations\n+  // where multiple handles refer to the same stdio FDs (in particular,\n+  // a possible IPC channel and a regular process.std??? stream).\n+  int fd_ = -1;\n+#endif\n };\n \n "
        },
        {
            "sha": "8200353b17bf999608c009afe938dfb4be67f37d",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=63a84609fb24b245838f2d0838d5141d36f09f83",
            "patch": "@@ -212,6 +212,7 @@ void TCPWrap::Open(const FunctionCallbackInfo<Value>& args) {\n                           args.GetReturnValue().Set(UV_EBADF));\n   int fd = static_cast<int>(args[0]->IntegerValue());\n   uv_tcp_open(&wrap->handle_, fd);\n+  wrap->set_fd(fd);\n }\n \n "
        },
        {
            "sha": "cd8589cc7fc2e7e65f389962a5edc531ed0643f6",
            "filename": "src/tty_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Ftty_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/63a84609fb24b245838f2d0838d5141d36f09f83/src%2Ftty_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftty_wrap.cc?ref=63a84609fb24b245838f2d0838d5141d36f09f83",
            "patch": "@@ -172,6 +172,7 @@ TTYWrap::TTYWrap(Environment* env,\n                       reinterpret_cast<uv_stream_t*>(&handle_),\n                       AsyncWrap::PROVIDER_TTYWRAP) {\n   *init_err = uv_tty_init(env->event_loop(), &handle_, fd, readable);\n+  set_fd(fd);\n   if (*init_err != 0)\n     MarkAsUninitialized();\n }"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 25,
        "deletions": 2
    }
}