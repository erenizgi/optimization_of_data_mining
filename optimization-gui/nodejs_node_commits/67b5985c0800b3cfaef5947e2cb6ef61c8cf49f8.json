{
    "author": "joyeecheung",
    "message": "net: fix usage of writeBuffer in makeSyncWrite\n\nThe binding writeBuffer has been changed in\nhttps://github.com/nodejs/node/pull/19041 and it now requires\nthe last argument to be a context object. makeSyncWrite\nwas not updated accordingly, resulting assertions on Windows.\nThis patch fixes the usage of writeBuffer there.\n\nAlso fix errors.uvException() so error.message are no longer\nenumerable, this fixes the deepStrictEqual assertion on the\nerror object in test-stdout-close-catch.\n\nPR-URL: https://github.com/nodejs/node/pull/19103\nRefs: https://github.com/nodejs/node/pull/19041\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8",
    "files": [
        {
            "sha": "a4a79d671e49384d726fa76f4bf3dcee2cfb763a",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 19,
            "deletions": 10,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8",
            "patch": "@@ -426,7 +426,23 @@ function message(key, args) {\n  * @returns {Error}\n  */\n function uvException(ctx) {\n-  const err = new Error();\n+  const [ code, uvmsg ] = errmap.get(ctx.errno);\n+  let message = `${code}: ${uvmsg}, ${ctx.syscall}`;\n+\n+  let path;\n+  let dest;\n+  if (ctx.path) {\n+    path = ctx.path.toString();\n+    message += ` '${path}'`;\n+  }\n+  if (ctx.dest) {\n+    dest = ctx.dest.toString();\n+    message += ` -> '${dest}'`;\n+  }\n+\n+  // Pass the message to the constructor instead of setting it on the object\n+  // to make sure it is the same as the one created in C++\n+  const err = new Error(message);\n \n   for (const prop of Object.keys(ctx)) {\n     if (prop === 'message' || prop === 'path' || prop === 'dest') {\n@@ -435,20 +451,13 @@ function uvException(ctx) {\n     err[prop] = ctx[prop];\n   }\n \n-  const [ code, uvmsg ] = errmap.get(ctx.errno);\n   err.code = code;\n-  let message = `${code}: ${uvmsg}, ${ctx.syscall}`;\n-  if (ctx.path) {\n-    const path = ctx.path.toString();\n-    message += ` '${path}'`;\n+  if (path) {\n     err.path = path;\n   }\n-  if (ctx.dest) {\n-    const dest = ctx.dest.toString();\n-    message += ` -> '${dest}'`;\n+  if (dest) {\n     err.dest = dest;\n   }\n-  err.message = message;\n \n   Error.captureStackTrace(err, uvException);\n   return err;"
        },
        {
            "sha": "9c2602b79e9208628ca9c1a3a2bf0bf41730d1e1",
            "filename": "lib/internal/net.js",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8/lib%2Finternal%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8/lib%2Finternal%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fnet.js?ref=67b5985c0800b3cfaef5947e2cb6ef61c8cf49f8",
            "patch": "@@ -3,6 +3,7 @@\n const Buffer = require('buffer').Buffer;\n const { isIPv6 } = process.binding('cares_wrap');\n const { writeBuffer } = process.binding('fs');\n+const errors = require('internal/errors');\n \n const octet = '(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])';\n const re = new RegExp(`^${octet}[.]${octet}[.]${octet}[.]${octet}$`);\n@@ -33,13 +34,13 @@ function makeSyncWrite(fd) {\n \n     this._bytesDispatched += chunk.length;\n \n-    try {\n-      writeBuffer(fd, chunk, 0, chunk.length, null);\n-    } catch (ex) {\n+    const ctx = {};\n+    writeBuffer(fd, chunk, 0, chunk.length, null, undefined, ctx);\n+    if (ctx.errno !== undefined) {\n+      const ex = errors.uvException(ctx);\n       // Legacy: net writes have .code === .errno, whereas writeBuffer gives the\n       // raw errno number in .errno.\n-      if (typeof ex.code === 'string')\n-        ex.errno = ex.code;\n+      ex.errno = ex.code;\n       return cb(ex);\n     }\n     cb();"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 25,
        "deletions": 15
    }
}