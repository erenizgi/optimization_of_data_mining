{
    "author": "danbev",
    "message": "test: introduce SetUpTestCase/TearDownTestCase\n\nThis commit add SetUpTestCase and TearDownTestCase functions that will\nbe called once per test case. Currently we only have SetUp/TearDown\nwhich are called for each test.\n\nThis commit moves the initialization and configuration of Node and V8 to\nbe done on a per test case basis, but gives each test a new Isolate.\n\nPR-URL: https://github.com/nodejs/node/pull/18558\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "c64e130913a4c1a65b35253fcacf942fc5389223",
    "files": [
        {
            "sha": "3e5a112240f6d3614393197c9d3dd868983e79d4",
            "filename": "test/cctest/node_test_fixture.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/c64e130913a4c1a65b35253fcacf942fc5389223/test%2Fcctest%2Fnode_test_fixture.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c64e130913a4c1a65b35253fcacf942fc5389223/test%2Fcctest%2Fnode_test_fixture.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.cc?ref=c64e130913a4c1a65b35253fcacf942fc5389223",
            "patch": "@@ -1,3 +1,7 @@\n #include \"node_test_fixture.h\"\n \n-uv_loop_t current_loop;\n+uv_loop_t NodeTestFixture::current_loop;\n+std::unique_ptr<node::NodePlatform> NodeTestFixture::platform;\n+std::unique_ptr<v8::ArrayBuffer::Allocator> NodeTestFixture::allocator;\n+std::unique_ptr<v8::TracingController> NodeTestFixture::tracing_controller;\n+v8::Isolate::CreateParams NodeTestFixture::params;"
        },
        {
            "sha": "eaa4aaecdf3e605da59bc3849dc176dbf2170d0b",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 26,
            "deletions": 29,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/c64e130913a4c1a65b35253fcacf942fc5389223/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/c64e130913a4c1a65b35253fcacf942fc5389223/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=c64e130913a4c1a65b35253fcacf942fc5389223",
            "patch": "@@ -53,49 +53,46 @@ struct Argv {\n   int nr_args_;\n };\n \n-extern uv_loop_t current_loop;\n \n class NodeTestFixture : public ::testing::Test {\n- public:\n-  static uv_loop_t* CurrentLoop() { return &current_loop; }\n-\n-  node::MultiIsolatePlatform* Platform() const { return platform_; }\n-\n  protected:\n+  static std::unique_ptr<v8::ArrayBuffer::Allocator> allocator;\n+  static std::unique_ptr<v8::TracingController> tracing_controller;\n+  static std::unique_ptr<node::NodePlatform> platform;\n+  static v8::Isolate::CreateParams params;\n+  static uv_loop_t current_loop;\n   v8::Isolate* isolate_;\n \n-  virtual void SetUp() {\n+  static void SetUpTestCase() {\n+    platform.reset(new node::NodePlatform(4, nullptr));\n+    tracing_controller.reset(new v8::TracingController());\n+    allocator.reset(v8::ArrayBuffer::Allocator::NewDefaultAllocator());\n+    params.array_buffer_allocator = allocator.get();\n+    node::tracing::TraceEventHelper::SetTracingController(\n+        tracing_controller.get());\n     CHECK_EQ(0, uv_loop_init(&current_loop));\n-    platform_ = new node::NodePlatform(8, nullptr);\n-    v8::V8::InitializePlatform(platform_);\n+    v8::V8::InitializePlatform(platform.get());\n     v8::V8::Initialize();\n-    v8::Isolate::CreateParams params_;\n-    params_.array_buffer_allocator = allocator_.get();\n-    isolate_ = v8::Isolate::New(params_);\n-\n-    // As the TracingController is stored globally, we only need to create it\n-    // one time for all tests.\n-    if (node::tracing::TraceEventHelper::GetTracingController() == nullptr) {\n-      node::tracing::TraceEventHelper::SetTracingController(\n-          new v8::TracingController());\n-    }\n   }\n \n-  virtual void TearDown() {\n-    platform_->Shutdown();\n+  static void TearDownTestCase() {\n+    platform->Shutdown();\n     while (uv_loop_alive(&current_loop)) {\n       uv_run(&current_loop, UV_RUN_ONCE);\n     }\n     v8::V8::ShutdownPlatform();\n-    delete platform_;\n-    platform_ = nullptr;\n     CHECK_EQ(0, uv_loop_close(&current_loop));\n   }\n \n- private:\n-  node::NodePlatform* platform_ = nullptr;\n-  std::unique_ptr<v8::ArrayBuffer::Allocator> allocator_{\n-      v8::ArrayBuffer::Allocator::NewDefaultAllocator()};\n+  virtual void SetUp() {\n+    isolate_ = v8::Isolate::New(params);\n+    CHECK_NE(isolate_, nullptr);\n+  }\n+\n+  virtual void TearDown() {\n+    isolate_->Dispose();\n+    isolate_ = nullptr;\n+  }\n };\n \n \n@@ -112,8 +109,8 @@ class EnvironmentTestFixture : public NodeTestFixture {\n       context_->Enter();\n \n       isolate_data_ = node::CreateIsolateData(isolate,\n-                                              NodeTestFixture::CurrentLoop(),\n-                                              test_fixture->Platform());\n+                                              &NodeTestFixture::current_loop,\n+                                              platform.get());\n       CHECK_NE(nullptr, isolate_data_);\n       environment_ = node::CreateEnvironment(isolate_data_,\n                                              context_,"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 31,
        "deletions": 30
    }
}