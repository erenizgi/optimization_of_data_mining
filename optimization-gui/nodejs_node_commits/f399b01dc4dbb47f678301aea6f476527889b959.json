{
    "author": "bnoordhuis",
    "message": "dns: use IDNA 2008 to encode non-ascii hostnames\n\nBefore this commit, Node.js left it up to the system resolver or c-ares.\n\nLeaving it to the system resolver introduces platform differences\nbecause:\n\n* some support IDNA 2008\n* some only IDNA 2003 (glibc until 2.28), and\n* some don't support IDNA at all (musl libc)\n\nc-ares doesn't support IDNA either although curl does, by virtue of\nlinking against libidn2. Upgrading from libidn1 to libidn2 in order\nto get proper IDNA 2008 support was the fix for curl's CVE-2016-8625.\n\nlibidn2 is not an option (incompatible license) but ICU has an IDNA API\nand we already use that in one place. For non-ICU builds, we fall back\nto the bundled punycode.js that also supports IDNA 2008.\n\nFixes: https://github.com/nodejs-private/security/issues/97\nFixes: https://github.com/nodejs/node/issues/25558\n\nPR-URL: https://github.com/nodejs/node/pull/25679\nReviewed-By: Santiago Gimeno <santiago.gimeno@gmail.com>\nReviewed-By: Saúl Ibarra Corretgé <saghul@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "f399b01dc4dbb47f678301aea6f476527889b959",
    "files": [
        {
            "sha": "952ef39006c8e4bc0179662f8e69e26c1630e813",
            "filename": "lib/dns.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Fdns.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Fdns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdns.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -22,6 +22,7 @@\n 'use strict';\n \n const cares = internalBinding('cares_wrap');\n+const { toASCII } = require('internal/idna');\n const { isIP, isIPv4, isLegalPort } = require('internal/net');\n const { customPromisifyArgs } = require('internal/util');\n const errors = require('internal/errors');\n@@ -139,7 +140,7 @@ function lookup(hostname, options, callback) {\n   req.hostname = hostname;\n   req.oncomplete = all ? onlookupall : onlookup;\n \n-  var err = cares.getaddrinfo(req, hostname, family, hints, verbatim);\n+  var err = cares.getaddrinfo(req, toASCII(hostname), family, hints, verbatim);\n   if (err) {\n     process.nextTick(callback, dnsException(err, 'getaddrinfo', hostname));\n     return {};\n@@ -219,7 +220,7 @@ function resolver(bindingName) {\n     req.hostname = name;\n     req.oncomplete = onresolve;\n     req.ttl = !!(options && options.ttl);\n-    var err = this._handle[bindingName](req, name);\n+    var err = this._handle[bindingName](req, toASCII(name));\n     if (err) throw dnsException(err, bindingName, name);\n     return req;\n   }"
        },
        {
            "sha": "25696bf2228b64a5b3b56cb7a1c1bbb80b91ef74",
            "filename": "lib/internal/dns/promises.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Finternal%2Fdns%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Finternal%2Fdns%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fdns%2Fpromises.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -6,6 +6,7 @@ const {\n   emitInvalidHostnameWarning,\n } = require('internal/dns/utils');\n const { codes, dnsException } = require('internal/errors');\n+const { toASCII } = require('internal/idna');\n const { isIP, isIPv4, isLegalPort } = require('internal/net');\n const {\n   getaddrinfo,\n@@ -86,7 +87,7 @@ function createLookupPromise(family, hostname, all, hints, verbatim) {\n     req.resolve = resolve;\n     req.reject = reject;\n \n-    const err = getaddrinfo(req, hostname, family, hints, verbatim);\n+    const err = getaddrinfo(req, toASCII(hostname), family, hints, verbatim);\n \n     if (err) {\n       reject(dnsException(err, 'getaddrinfo', hostname));\n@@ -184,7 +185,7 @@ function createResolverPromise(resolver, bindingName, hostname, ttl) {\n     req.reject = reject;\n     req.ttl = ttl;\n \n-    const err = resolver._handle[bindingName](req, hostname);\n+    const err = resolver._handle[bindingName](req, toASCII(hostname));\n \n     if (err)\n       reject(dnsException(err, bindingName, hostname));"
        },
        {
            "sha": "409cabedf10d1abf972f999dfa4f63d9a1402357",
            "filename": "lib/internal/idna.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Finternal%2Fidna.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Finternal%2Fidna.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fidna.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -0,0 +1,9 @@\n+'use strict';\n+\n+if (process.binding('config').hasIntl) {\n+  const { toASCII, toUnicode } = internalBinding('icu');\n+  module.exports = { toASCII, toUnicode };\n+} else {\n+  const { toASCII, toUnicode } = require('punycode');\n+  module.exports = { toASCII, toUnicode };\n+}"
        },
        {
            "sha": "569733bfc4b0d7e037bbe767a85dce02b1507bef",
            "filename": "lib/url.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Furl.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/lib%2Furl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Furl.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -21,11 +21,8 @@\n \n 'use strict';\n \n-const { toASCII } = internalBinding('config').hasIntl ?\n-  internalBinding('icu') : require('punycode');\n-\n+const { toASCII } = require('internal/idna');\n const { hexTable } = require('internal/querystring');\n-\n const { SafeSet } = require('internal/safe_globals');\n \n const {"
        },
        {
            "sha": "0089b0a850619de1905ecfeb77bd7e906791244d",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -126,6 +126,7 @@\n       'lib/internal/fs/utils.js',\n       'lib/internal/fs/watchers.js',\n       'lib/internal/http.js',\n+      'lib/internal/idna.js',\n       'lib/internal/inspector_async_hook.js',\n       'lib/internal/js_stream_socket.js',\n       'lib/internal/linkedlist.js',"
        },
        {
            "sha": "ebabe322f0db0d62dd2807e1179a19eb3133687e",
            "filename": "test/internet/test-dns-idna2008.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/test%2Finternet%2Ftest-dns-idna2008.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/test%2Finternet%2Ftest-dns-idna2008.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Finternet%2Ftest-dns-idna2008.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -0,0 +1,33 @@\n+'use strict';\n+\n+// Verify that non-ASCII hostnames are handled correctly as IDNA 2008.\n+//\n+// * Tests will fail with NXDOMAIN when UTF-8 leaks through to a getaddrinfo()\n+//   that doesn't support IDNA at all.\n+//\n+// * \"straße.de\" will resolve to the wrong address when the resolver supports\n+//   only IDNA 2003 (e.g., glibc until 2.28) because it encodes it wrong.\n+\n+const { mustCall } = require('../common');\n+const assert = require('assert');\n+const dns = require('dns');\n+\n+const [host, expectedAddress] = ['straße.de', '81.169.145.78'];\n+\n+dns.lookup(host, mustCall((err, address) => {\n+  assert.ifError(err);\n+  assert.strictEqual(address, expectedAddress);\n+}));\n+\n+dns.promises.lookup(host).then(mustCall(({ address }) => {\n+  assert.strictEqual(address, expectedAddress);\n+}));\n+\n+dns.resolve4(host, mustCall((err, addresses) => {\n+  assert.ifError(err);\n+  assert.deepStrictEqual(addresses, [expectedAddress]);\n+}));\n+\n+new dns.promises.Resolver().resolve4(host).then(mustCall((addresses) => {\n+  assert.deepStrictEqual(addresses, [expectedAddress]);\n+}));"
        },
        {
            "sha": "73e47ed9d502e046e08dbbf95775725be0092010",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f399b01dc4dbb47f678301aea6f476527889b959/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/f399b01dc4dbb47f678301aea6f476527889b959/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=f399b01dc4dbb47f678301aea6f476527889b959",
            "patch": "@@ -10,7 +10,7 @@ const assert = require('assert');\n \n const isMainThread = common.isMainThread;\n const kCoverageModuleCount = process.env.NODE_V8_COVERAGE ? 1 : 0;\n-const kMaxModuleCount = (isMainThread ? 63 : 85) + kCoverageModuleCount;\n+const kMaxModuleCount = (isMainThread ? 64 : 86) + kCoverageModuleCount;\n \n assert(list.length <= kMaxModuleCount,\n        `Total length: ${list.length}\\n` + list.join('\\n')"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 51,
        "deletions": 9
    }
}