{
    "author": "sam-github",
    "message": "test: do not assume tls handshake order\n\nDo not assume that server handshake event happens before client, it is\nnot guaranteed.\n\nPR-URL: https://github.com/nodejs/node/pull/25508\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "426a87025ba093c292026760ec548e9a68c0fb1c",
    "files": [
        {
            "sha": "76604e05875c6564be4ca5e7357447492a52bd0f",
            "filename": "test/parallel/test-tls-alpn-server-client.js",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/426a87025ba093c292026760ec548e9a68c0fb1c/test%2Fparallel%2Ftest-tls-alpn-server-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/426a87025ba093c292026760ec548e9a68c0fb1c/test%2Fparallel%2Ftest-tls-alpn-server-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-alpn-server-client.js?ref=426a87025ba093c292026760ec548e9a68c0fb1c",
            "patch": "@@ -23,9 +23,10 @@ function runTest(clientsOptions, serverOptions, cb) {\n   serverOptions.key = loadPEM('agent2-key');\n   serverOptions.cert = loadPEM('agent2-cert');\n   const results = [];\n-  let index = 0;\n+  let clientIndex = 0;\n+  let serverIndex = 0;\n   const server = tls.createServer(serverOptions, function(c) {\n-    results[index].server = { ALPN: c.alpnProtocol };\n+    results[serverIndex++].server = { ALPN: c.alpnProtocol };\n   });\n \n   server.listen(0, serverIP, function() {\n@@ -38,16 +39,18 @@ function runTest(clientsOptions, serverOptions, cb) {\n     opt.host = serverIP;\n     opt.rejectUnauthorized = false;\n \n-    results[index] = {};\n+    results[clientIndex] = {};\n     const client = tls.connect(opt, function() {\n-      results[index].client = { ALPN: client.alpnProtocol };\n-      client.destroy();\n+      results[clientIndex].client = { ALPN: client.alpnProtocol };\n+      client.end();\n       if (options.length) {\n-        index++;\n+        clientIndex++;\n         connectClient(options);\n       } else {\n         server.close();\n-        cb(results);\n+        server.on('close', () => {\n+          cb(results);\n+        });\n       }\n     });\n   }"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 10,
        "deletions": 7
    }
}