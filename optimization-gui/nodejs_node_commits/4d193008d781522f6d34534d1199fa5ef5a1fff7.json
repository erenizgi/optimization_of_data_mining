{
    "author": "refack",
    "message": "tools: refloat Node.js patches to cpplint.py\n\n* Preserve 3 node-core checks\n* Preserve patch to `FileInfo.RepositoryName`\n* Remove TAP to logfile (unused)\n\nPR-URL: https://github.com/nodejs/node/pull/25771\nFixes: https://github.com/nodejs/node/issues/25760\nRefs: https://github.com/cpplint/cpplint/blob/3d8f6f876dd6e3918e5641483298dbc82e65f358/cpplint.py\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "4d193008d781522f6d34534d1199fa5ef5a1fff7",
    "files": [
        {
            "sha": "17f341a61d7a2cd84d790c10dfda5688fd3e2781",
            "filename": "tools/cpplint.py",
            "status": "modified",
            "additions": 87,
            "deletions": 51,
            "changes": 138,
            "blob_url": "https://github.com/nodejs/node/blob/4d193008d781522f6d34534d1199fa5ef5a1fff7/tools%2Fcpplint.py",
            "raw_url": "https://github.com/nodejs/node/raw/4d193008d781522f6d34534d1199fa5ef5a1fff7/tools%2Fcpplint.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fcpplint.py?ref=4d193008d781522f6d34534d1199fa5ef5a1fff7",
            "patch": "@@ -122,7 +122,7 @@ def GetNonHeaderExtensions():\n       likely to be false positives.\n \n     quiet\n-      Supress output other than linting errors, such as information about\n+      Suppress output other than linting errors, such as information about\n       which files have been processed and excluded.\n \n     filter=-x,+y,...\n@@ -298,11 +298,13 @@ def GetNonHeaderExtensions():\n     'readability/constructors',\n     'readability/fn_size',\n     'readability/inheritance',\n+    'readability/pointer_notation',\n     'readability/multiline_comment',\n     'readability/multiline_string',\n     'readability/namespace',\n     'readability/nolint',\n     'readability/nul',\n+    'readability/null_usage',\n     'readability/strings',\n     'readability/todo',\n     'readability/utf8',\n@@ -353,7 +355,11 @@ def GetNonHeaderExtensions():\n # flag. By default all errors are on, so only add here categories that should be\n # off by default (i.e., categories that must be enabled by the --filter= flags).\n # All entries here should start with a '-' or '+', as in the --filter= flag.\n-_DEFAULT_FILTERS = ['-build/include_alpha']\n+_DEFAULT_FILTERS = [\n+    '-build/include',\n+    '-build/include_subdir',\n+    '-legal/copyright',\n+    ]\n \n # The default list of categories suppressed for C (not C++) files.\n _DEFAULT_C_SUPPRESSED_CATEGORIES = [\n@@ -626,6 +632,12 @@ def GetNonHeaderExtensions():\n # Match string that indicates we're working on a Linux Kernel file.\n _SEARCH_KERNEL_FILE = re.compile(r'\\b(?:LINT_KERNEL_FILE)')\n \n+_NULL_TOKEN_PATTERN = re.compile(r'\\bNULL\\b')\n+\n+_RIGHT_LEANING_POINTER_PATTERN = re.compile(r'[^=|(,\\s><);&?:}]'\n+                                            r'(?<!(sizeof|return))'\n+                                            r'\\s\\*[a-zA-z_][0-9a-zA-z_]*')\n+\n _regexp_compile_cache = {}\n \n # {str, set(int)}: a map from error categories to sets of linenumbers\n@@ -644,7 +656,7 @@ def GetNonHeaderExtensions():\n # Files to exclude from linting. This is set by the --exclude flag.\n _excludes = None\n \n-# Whether to supress PrintInfo messages\n+# Whether to suppress PrintInfo messages\n _quiet = False\n \n # The allowed line length of files.\n@@ -1284,54 +1296,12 @@ def RepositoryName(self):\n     locations won't see bogus errors.\n     \"\"\"\n     fullname = self.FullName()\n-\n-    if os.path.exists(fullname):\n-      project_dir = os.path.dirname(fullname)\n-\n-      # If the user specified a repository path, it exists, and the file is\n-      # contained in it, use the specified repository path\n-      if _repository:\n-        repo = FileInfo(_repository).FullName()\n-        root_dir = project_dir\n-        while os.path.exists(root_dir):\n-          # allow case insensitive compare on Windows\n-          if os.path.normcase(root_dir) == os.path.normcase(repo):\n-            return os.path.relpath(fullname, root_dir).replace('\\\\', '/')\n-          one_up_dir = os.path.dirname(root_dir)\n-          if one_up_dir == root_dir:\n-            break\n-          root_dir = one_up_dir\n-\n-      if os.path.exists(os.path.join(project_dir, \".svn\")):\n-        # If there's a .svn file in the current directory, we recursively look\n-        # up the directory tree for the top of the SVN checkout\n-        root_dir = project_dir\n-        one_up_dir = os.path.dirname(root_dir)\n-        while os.path.exists(os.path.join(one_up_dir, \".svn\")):\n-          root_dir = os.path.dirname(root_dir)\n-          one_up_dir = os.path.dirname(one_up_dir)\n-\n-        prefix = os.path.commonprefix([root_dir, project_dir])\n-        return fullname[len(prefix) + 1:]\n-\n-      # Not SVN <= 1.6? Try to find a git, hg, or svn top level directory by\n-      # searching up from the current path.\n-      root_dir = current_dir = os.path.dirname(fullname)\n-      while current_dir != os.path.dirname(current_dir):\n-        if (os.path.exists(os.path.join(current_dir, \".git\")) or\n-            os.path.exists(os.path.join(current_dir, \".hg\")) or\n-            os.path.exists(os.path.join(current_dir, \".svn\"))):\n-          root_dir = current_dir\n-        current_dir = os.path.dirname(current_dir)\n-\n-      if (os.path.exists(os.path.join(root_dir, \".git\")) or\n-          os.path.exists(os.path.join(root_dir, \".hg\")) or\n-          os.path.exists(os.path.join(root_dir, \".svn\"))):\n-        prefix = os.path.commonprefix([root_dir, project_dir])\n-        return fullname[len(prefix) + 1:]\n-\n-    # Don't know what to do; header guard warnings may be wrong...\n-    return fullname\n+    # XXX(bnoordhuis) Expects that cpplint.py lives in the tools/ directory.\n+    toplevel = os.path.abspath(os.path.join(os.path.dirname(__file__), '..')).replace('\\\\', '/')\n+    toplevel = unicode_escape_decode(toplevel)\n+    prefix = os.path.commonprefix([fullname, toplevel])\n+    return fullname[len(prefix) + 1:]\n+    # End Node.js patch\n \n   def Split(self):\n     \"\"\"Splits the file into the directory, basename, and extension.\n@@ -2148,6 +2118,21 @@ def CheckForBadCharacters(filename, lines, error):\n       error(filename, linenum, 'readability/nul', 5, 'Line contains NUL byte.')\n \n \n+def CheckInlineHeader(filename, include_state, error):\n+  \"\"\"Logs an error if both a header and its inline variant are included.\"\"\"\n+\n+  all_headers = dict(item for sublist in include_state.include_list\n+                     for item in sublist)\n+  bad_headers = set('%s.h' % name[:-6] for name in all_headers.keys()\n+                    if name.endswith('-inl.h'))\n+  bad_headers &= set(all_headers.keys())\n+\n+  for name in bad_headers:\n+    err =  '%s includes both %s and %s-inl.h' % (filename, name, name)\n+    linenum = all_headers[name]\n+    error(filename, linenum, 'build/include', 5, err)\n+\n+\n def CheckForNewlineAtEOF(filename, lines, error):\n   \"\"\"Logs an error if there is no newline char at the end of the file.\n \n@@ -4425,6 +4410,49 @@ def CheckAltTokens(filename, clean_lines, linenum, error):\n           'Use operator %s instead of %s' % (\n               _ALT_TOKEN_REPLACEMENT[match.group(1)], match.group(1)))\n \n+def CheckNullTokens(filename, clean_lines, linenum, error):\n+  \"\"\"Check NULL usage.\n+\n+  Args:\n+    filename: The name of the current file.\n+    clean_lines: A CleansedLines instance containing the file.\n+    linenum: The number of the line to check.\n+    error: The function to call with any errors found.\n+  \"\"\"\n+  line = clean_lines.elided[linenum]\n+\n+  # Avoid preprocessor lines\n+  if Match(r'^\\s*#', line):\n+    return\n+\n+  if line.find('/*') >= 0 or line.find('*/') >= 0:\n+    return\n+\n+  for match in _NULL_TOKEN_PATTERN.finditer(line):\n+    error(filename, linenum, 'readability/null_usage', 2,\n+          'Use nullptr instead of NULL')\n+\n+def CheckLeftLeaningPointer(filename, clean_lines, linenum, error):\n+  \"\"\"Check for left-leaning pointer placement.\n+\n+  Args:\n+    filename: The name of the current file.\n+    clean_lines: A CleansedLines instance containing the file.\n+    linenum: The number of the line to check.\n+    error: The function to call with any errors found.\n+  \"\"\"\n+  line = clean_lines.elided[linenum]\n+\n+  # Avoid preprocessor lines\n+  if Match(r'^\\s*#', line):\n+    return\n+\n+  if '/*' in line or '*/' in line:\n+    return\n+\n+  for match in _RIGHT_LEANING_POINTER_PATTERN.finditer(line):\n+    error(filename, linenum, 'readability/pointer_notation', 2,\n+          'Use left leaning pointer instead of right leaning')\n \n def GetLineWidth(line):\n   \"\"\"Determines the width of the line in column positions.\n@@ -4477,6 +4505,10 @@ def CheckStyle(filename, clean_lines, linenum, file_extension, nesting_state,\n     error(filename, linenum, 'whitespace/tab', 1,\n           'Tab found; better to use spaces')\n \n+  if line.find('template<') != -1:\n+    error(filename, linenum, 'whitespace/template', 1,\n+          'Leave a single space after template, as in `template <...>`')\n+\n   # One or three blank spaces at the beginning of the line is weird; it's\n   # hard to reconcile that with 2-space indents.\n   # NOTE: here are the conditions rob pike used for his tests.  Mine aren't\n@@ -4570,6 +4602,8 @@ def CheckStyle(filename, clean_lines, linenum, file_extension, nesting_state,\n   CheckSpacingForFunctionCall(filename, clean_lines, linenum, error)\n   CheckCheck(filename, clean_lines, linenum, error)\n   CheckAltTokens(filename, clean_lines, linenum, error)\n+  CheckNullTokens(filename, clean_lines, linenum, error)\n+  CheckLeftLeaningPointer(filename, clean_lines, linenum, error)\n   classinfo = nesting_state.InnermostClass()\n   if classinfo:\n     CheckSectionSpacing(filename, clean_lines, classinfo, linenum, error)\n@@ -6112,6 +6146,8 @@ def ProcessFileData(filename, file_extension, lines, error,\n \n   CheckForNewlineAtEOF(filename, lines, error)\n \n+  CheckInlineHeader(filename, include_state, error)\n+\n def ProcessConfigOverrides(filename):\n   \"\"\" Loads the configuration files and processes the config overrides.\n "
        }
    ],
    "stats": {
        "total": 138,
        "additions": 87,
        "deletions": 51
    }
}