{
    "author": "unknown",
    "message": "vm: pass parsing_context to ScriptCompiler::CompileFunctionInContext\n\nContextifyContext::CompileFunction in src/node_contextify.cc\nwas incorrectly passing the context variable to\nScriptCompiler::CompileFunctionInContext\n\nThis meant that the parsingContext option in vm.compileFunction\nwas not being applied properly to the compiled function.\n\nfixes: https://github.com/nodejs/node/issues/23194\n\ndoc: clarify parsingContext option for vm.compileScript\n\ntest: usage of parsingContext in vm.compileFunction\n\nPR-URL: https://github.com/nodejs/node/pull/23206\nFixes: https://github.com/nodejs/node/issues/23194\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "8da674df493e2ded8dc812252ac4f1f90c362807",
    "files": [
        {
            "sha": "5bf09de37940fbddec3b4c99372e7564b6ae3c9e",
            "filename": "doc/api/vm.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8da674df493e2ded8dc812252ac4f1f90c362807/doc%2Fapi%2Fvm.md",
            "raw_url": "https://github.com/nodejs/node/raw/8da674df493e2ded8dc812252ac4f1f90c362807/doc%2Fapi%2Fvm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fvm.md?ref=8da674df493e2ded8dc812252ac4f1f90c362807",
            "patch": "@@ -673,8 +673,8 @@ added: v10.10.0\n     data for the supplied source.\n   * `produceCachedData` {boolean} Specifies whether to produce new cache data.\n     **Default:** `false`.\n-  * `parsingContext` {Object} The sandbox/context in which the said function\n-    should be compiled in.\n+  * `parsingContext` {Object} The [contextified][] sandbox in which the said\n+    function should be compiled in.\n   * `contextExtensions` {Object[]} An array containing a collection of context\n     extensions (objects wrapping the current scope) to be applied while\n     compiling. **Default:** `[]`."
        },
        {
            "sha": "9559747467440ba5cb30c06bdd873ee7ebc01497",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8da674df493e2ded8dc812252ac4f1f90c362807/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8da674df493e2ded8dc812252ac4f1f90c362807/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=8da674df493e2ded8dc812252ac4f1f90c362807",
            "patch": "@@ -1070,7 +1070,7 @@ void ContextifyContext::CompileFunction(\n   }\n \n   MaybeLocal<Function> maybe_fun = ScriptCompiler::CompileFunctionInContext(\n-      context, &source, params.size(), params.data(),\n+      parsing_context, &source, params.size(), params.data(),\n       context_extensions.size(), context_extensions.data(), options);\n \n   Local<Function> fun;"
        },
        {
            "sha": "54b7c45ff8043a29fbce673ee90993b2661bfe0c",
            "filename": "test/parallel/test-vm-basic.js",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/8da674df493e2ded8dc812252ac4f1f90c362807/test%2Fparallel%2Ftest-vm-basic.js",
            "raw_url": "https://github.com/nodejs/node/raw/8da674df493e2ded8dc812252ac4f1f90c362807/test%2Fparallel%2Ftest-vm-basic.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-basic.js?ref=8da674df493e2ded8dc812252ac4f1f90c362807",
            "patch": "@@ -267,6 +267,46 @@ const vm = require('vm');\n     stack: 'Error: Sample Error\\n    at <anonymous>:1:10'\n   });\n \n+  assert.strictEqual(\n+    vm.compileFunction(\n+      'return varInContext',\n+      [],\n+      {\n+        parsingContext: vm.createContext({ varInContext: 'abc' })\n+      }\n+    )(),\n+    'abc'\n+  );\n+\n+  common.expectsError(() => {\n+    vm.compileFunction(\n+      'return varInContext',\n+      []\n+    )();\n+  }, {\n+    message: 'varInContext is not defined',\n+    stack: 'ReferenceError: varInContext is not defined\\n    at <anonymous>:1:1'\n+  });\n+\n+  assert.notDeepStrictEqual(\n+    vm.compileFunction(\n+      'return global',\n+      [],\n+      {\n+        parsingContext: vm.createContext({ global: {} })\n+      }\n+    )(),\n+    global\n+  );\n+\n+  assert.deepStrictEqual(\n+    vm.compileFunction(\n+      'return global',\n+      []\n+    )(),\n+    global\n+  );\n+\n   // Resetting value\n   Error.stackTraceLimit = oldLimit;\n }"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 43,
        "deletions": 3
    }
}