{
    "author": "addaleax",
    "message": "worker,coverage: support V8 coverage generation\n\nPR-URL: https://github.com/nodejs/node/pull/22928\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0dbc8c8198f653ae4a5626ad82904e1cd55d817a",
    "files": [
        {
            "sha": "df45285baaee021473e87d5bf4d37574cde3b25a",
            "filename": "lib/internal/process/coverage.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/lib%2Finternal%2Fprocess%2Fcoverage.js",
            "raw_url": "https://github.com/nodejs/node/raw/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/lib%2Finternal%2Fprocess%2Fcoverage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fcoverage.js?ref=0dbc8c8198f653ae4a5626ad82904e1cd55d817a",
            "patch": "@@ -1,9 +1,7 @@\n 'use strict';\n const path = require('path');\n const { mkdirSync, writeFileSync } = require('fs');\n-// TODO(addaleax): add support for coverage to worker threads.\n-const hasInspector = process.config.variables.v8_enable_inspector === 1 &&\n-  require('internal/worker').isMainThread;\n+const hasInspector = process.config.variables.v8_enable_inspector === 1;\n let inspector = null;\n if (hasInspector) inspector = require('inspector');\n \n@@ -14,7 +12,9 @@ function writeCoverage() {\n     return;\n   }\n \n-  const filename = `coverage-${process.pid}-${Date.now()}.json`;\n+  const { threadId } = require('internal/worker');\n+\n+  const filename = `coverage-${process.pid}-${Date.now()}-${threadId}.json`;\n   try {\n     // TODO(bcoe): switch to mkdirp once #22302 is addressed.\n     mkdirSync(process.env.NODE_V8_COVERAGE);"
        },
        {
            "sha": "901794e97ac8ab480b15f01faa5b0d54d0c0093d",
            "filename": "test/fixtures/v8-coverage/worker.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/test%2Ffixtures%2Fv8-coverage%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/test%2Ffixtures%2Fv8-coverage%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fv8-coverage%2Fworker.js?ref=0dbc8c8198f653ae4a5626ad82904e1cd55d817a",
            "patch": "@@ -0,0 +1,5 @@\n+'use strict';\n+const { Worker } = require('worker_threads');\n+const path = require('path');\n+\n+new Worker(path.resolve(__dirname, 'subprocess.js'));"
        },
        {
            "sha": "16a55b0fc4b8e8e3424c47cbfc3285a88e605c17",
            "filename": "test/parallel/test-v8-coverage.js",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/test%2Fparallel%2Ftest-v8-coverage.js",
            "raw_url": "https://github.com/nodejs/node/raw/0dbc8c8198f653ae4a5626ad82904e1cd55d817a/test%2Fparallel%2Ftest-v8-coverage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-v8-coverage.js?ref=0dbc8c8198f653ae4a5626ad82904e1cd55d817a",
            "patch": "@@ -79,6 +79,23 @@ function nextdir() {\n   assert.strictEqual(fixtureCoverage.functions[2].ranges[1].count, 0);\n }\n \n+// outputs coverage from worker.\n+{\n+  const coverageDirectory = path.join(tmpdir.path, nextdir());\n+  const output = spawnSync(process.execPath, [\n+    '--experimental-worker',\n+    require.resolve('../fixtures/v8-coverage/worker')\n+  ], { env: { ...process.env, NODE_V8_COVERAGE: coverageDirectory } });\n+  assert.strictEqual(output.status, 0);\n+  const fixtureCoverage = getFixtureCoverage('subprocess.js',\n+                                             coverageDirectory);\n+  assert.ok(fixtureCoverage);\n+  // first branch executed.\n+  assert.strictEqual(fixtureCoverage.functions[2].ranges[0].count, 1);\n+  // second branch did not execute.\n+  assert.strictEqual(fixtureCoverage.functions[2].ranges[1].count, 0);\n+}\n+\n // does not output coverage if NODE_V8_COVERAGE is empty.\n {\n   const coverageDirectory = path.join(tmpdir.path, nextdir());"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 26,
        "deletions": 4
    }
}