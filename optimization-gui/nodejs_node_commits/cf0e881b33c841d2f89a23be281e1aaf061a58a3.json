{
    "author": "unknown",
    "message": "n-api: add generic finalizer callback\n\nAdd `napi_add_finalizer()`, which provides the ability to attach data\nto an arbitrary object and be notified when that object is garbage-\ncollected so as to have an opportunity to delete the data previously\nattached.\n\nThis differs from `napi_wrap()` in that it does not use up the private\nslot on the object, and is therefore neither removable, nor retrievable\nafter the call to `napi_add_finalizer()`. It is assumed that the data\nis accessible by other means, yet it must be tied to the lifetime of\nthe object. This is the case for data passed to a dynamically created\nfunction which is itself heap-allocated and must therefore be freed\nalong with the function.\n\nFixes: https://github.com/nodejs/abi-stable-node/issues/313\nPR-URL: https://github.com/nodejs/node/pull/22244\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "cf0e881b33c841d2f89a23be281e1aaf061a58a3",
    "files": [
        {
            "sha": "3bee50b7f6d4ca3005b16780c9baeb6c901a807c",
            "filename": "doc/api/n-api.md",
            "status": "modified",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/cf0e881b33c841d2f89a23be281e1aaf061a58a3/doc%2Fapi%2Fn-api.md",
            "raw_url": "https://github.com/nodejs/node/raw/cf0e881b33c841d2f89a23be281e1aaf061a58a3/doc%2Fapi%2Fn-api.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fn-api.md?ref=cf0e881b33c841d2f89a23be281e1aaf061a58a3",
            "patch": "@@ -3238,6 +3238,11 @@ JavaScript functions from native code. One can either call a function\n like a regular JavaScript function call, or as a constructor\n function.\n \n+Any non-`NULL` data which is passed to this API via the `data` field of the\n+`napi_property_descriptor` items can be associated with `object` and freed\n+whenever `object` is garbage-collected by passing both `object` and the data to\n+[`napi_add_finalizer`][].\n+\n ### napi_call_function\n <!-- YAML\n added: v8.0.0\n@@ -3375,6 +3380,11 @@ myaddon.sayHello();\n The string passed to `require()` is the name of the target in `binding.gyp`\n responsible for creating the `.node` file.\n \n+Any non-`NULL` data which is passed to this API via the `data` parameter can\n+be associated with the resulting JavaScript function (which is returned in the\n+`result` parameter) and freed whenever the function is garbage-collected by\n+passing both the JavaScript function and the data to [`napi_add_finalizer`][].\n+\n JavaScript `Function`s are described in\n [Section 19.2](https://tc39.github.io/ecma262/#sec-function-objects)\n of the ECMAScript Language Specification.\n@@ -3581,6 +3591,12 @@ case, to prevent the function value from being garbage-collected, create a\n persistent reference to it using [`napi_create_reference`][] and ensure the\n reference count is kept >= 1.\n \n+Any non-`NULL` data which is passed to this API via the `data` parameter or via\n+the `data` field of the `napi_property_descriptor` array items can be associated\n+with the resulting JavaScript constructor (which is returned in the `result`\n+parameter) and freed whenever the class is garbage-collected by passing both\n+the JavaScript function and the data to [`napi_add_finalizer`][].\n+\n ### napi_wrap\n <!-- YAML\n added: v8.0.0\n@@ -3685,6 +3701,47 @@ object `js_object` using `napi_wrap()` and removes the wrapping. If a finalize\n callback was associated with the wrapping, it will no longer be called when the\n JavaScript object becomes garbage-collected.\n \n+### napi_add_finalizer\n+<!-- YAML\n+added: v8.0.0\n+napiVersion: 1\n+-->\n+```C\n+napi_status napi_add_finalizer(napi_env env,\n+                               napi_value js_object,\n+                               void* native_object,\n+                               napi_finalize finalize_cb,\n+                               void* finalize_hint,\n+                               napi_ref* result);\n+```\n+\n+ - `[in] env`: The environment that the API is invoked under.\n+ - `[in] js_object`: The JavaScript object to which the native data will be\n+   attached.\n+ - `[in] native_object`: The native data that will be attached to the JavaScript\n+   object.\n+ - `[in] finalize_cb`: Native callback that will be used to free the\n+   native data when the JavaScript object is ready for garbage-collection.\n+ - `[in] finalize_hint`: Optional contextual hint that is passed to the\n+   finalize callback.\n+ - `[out] result`: Optional reference to the JavaScript object.\n+\n+Returns `napi_ok` if the API succeeded.\n+\n+Adds a `napi_finalize` callback which will be called when the JavaScript object\n+in `js_object` is ready for garbage collection. This API is similar to\n+`napi_wrap()` except that\n+* the native data cannot be retrieved later using `napi_unwrap()`,\n+* nor can it be removed later using `napi_remove_wrap()`, and\n+* the API can be called multiple times with different data items in order to\n+  attach each of them to the JavaScript object.\n+\n+*Caution*: The optional returned reference (if obtained) should be deleted via\n+[`napi_delete_reference`][] ONLY in response to the finalize callback\n+invocation. If it is deleted before then, then the finalize callback may never\n+be invoked. Therefore, when obtaining a reference a finalize callback is also\n+required in order to enable correct disposal of the reference.\n+\n ## Simple Asynchronous Operations\n \n Addon modules often need to leverage async helpers from libuv as part of their\n@@ -4559,6 +4616,7 @@ This API may only be called from the main thread.\n [Working with JavaScript Values]: #n_api_working_with_javascript_values\n [Working with JavaScript Values - Abstract Operations]: #n_api_working_with_javascript_values_abstract_operations\n \n+[`napi_add_finalizer`]: #n_api_napi_add_finalizer\n [`napi_async_init`]: #n_api_napi_async_init\n [`napi_cancel_async_work`]: #n_api_napi_cancel_async_work\n [`napi_close_escapable_handle_scope`]: #n_api_napi_close_escapable_handle_scope"
        },
        {
            "sha": "690579f573bdf26528c9b5388d27129a80fc2d8c",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 77,
            "deletions": 35,
            "changes": 112,
            "blob_url": "https://github.com/nodejs/node/blob/cf0e881b33c841d2f89a23be281e1aaf061a58a3/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cf0e881b33c841d2f89a23be281e1aaf061a58a3/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=cf0e881b33c841d2f89a23be281e1aaf061a58a3",
            "patch": "@@ -1157,6 +1157,63 @@ class ThreadSafeFunction : public node::AsyncResource {\n   bool handles_closing;\n };\n \n+enum WrapType {\n+  retrievable,\n+  anonymous\n+};\n+\n+template <WrapType wrap_type> static inline\n+napi_status Wrap(napi_env env,\n+                 napi_value js_object,\n+                 void* native_object,\n+                 napi_finalize finalize_cb,\n+                 void* finalize_hint,\n+                 napi_ref* result) {\n+  NAPI_PREAMBLE(env);\n+  CHECK_ARG(env, js_object);\n+\n+  v8::Isolate* isolate = env->isolate;\n+  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+\n+  v8::Local<v8::Value> value = v8impl::V8LocalValueFromJsValue(js_object);\n+  RETURN_STATUS_IF_FALSE(env, value->IsObject(), napi_invalid_arg);\n+  v8::Local<v8::Object> obj = value.As<v8::Object>();\n+\n+  if (wrap_type == retrievable) {\n+    // If we've already wrapped this object, we error out.\n+    RETURN_STATUS_IF_FALSE(env,\n+        !obj->HasPrivate(context, NAPI_PRIVATE_KEY(context, wrapper))\n+            .FromJust(),\n+        napi_invalid_arg);\n+  } else if (wrap_type == anonymous) {\n+    // If no finalize callback is provided, we error out.\n+    CHECK_ARG(env, finalize_cb);\n+  }\n+\n+  v8impl::Reference* reference = nullptr;\n+  if (result != nullptr) {\n+    // The returned reference should be deleted via napi_delete_reference()\n+    // ONLY in response to the finalize callback invocation. (If it is deleted\n+    // before then, then the finalize callback will never be invoked.)\n+    // Therefore a finalize callback is required when returning a reference.\n+    CHECK_ARG(env, finalize_cb);\n+    reference = v8impl::Reference::New(\n+        env, obj, 0, false, finalize_cb, native_object, finalize_hint);\n+    *result = reinterpret_cast<napi_ref>(reference);\n+  } else {\n+    // Create a self-deleting reference.\n+    reference = v8impl::Reference::New(env, obj, 0, true, finalize_cb,\n+        native_object, finalize_cb == nullptr ? nullptr : finalize_hint);\n+  }\n+\n+  if (wrap_type == retrievable) {\n+    CHECK(obj->SetPrivate(context, NAPI_PRIVATE_KEY(context, wrapper),\n+          v8::External::New(isolate, reference)).FromJust());\n+  }\n+\n+  return GET_RETURN_STATUS(env);\n+}\n+\n }  // end of namespace v8impl\n \n // Intercepts the Node-V8 module registration callback. Converts parameters\n@@ -2859,41 +2916,12 @@ napi_status napi_wrap(napi_env env,\n                       napi_finalize finalize_cb,\n                       void* finalize_hint,\n                       napi_ref* result) {\n-  NAPI_PREAMBLE(env);\n-  CHECK_ARG(env, js_object);\n-\n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n-\n-  v8::Local<v8::Value> value = v8impl::V8LocalValueFromJsValue(js_object);\n-  RETURN_STATUS_IF_FALSE(env, value->IsObject(), napi_invalid_arg);\n-  v8::Local<v8::Object> obj = value.As<v8::Object>();\n-\n-  // If we've already wrapped this object, we error out.\n-  RETURN_STATUS_IF_FALSE(env,\n-      !obj->HasPrivate(context, NAPI_PRIVATE_KEY(context, wrapper)).FromJust(),\n-      napi_invalid_arg);\n-\n-  v8impl::Reference* reference = nullptr;\n-  if (result != nullptr) {\n-    // The returned reference should be deleted via napi_delete_reference()\n-    // ONLY in response to the finalize callback invocation. (If it is deleted\n-    // before then, then the finalize callback will never be invoked.)\n-    // Therefore a finalize callback is required when returning a reference.\n-    CHECK_ARG(env, finalize_cb);\n-    reference = v8impl::Reference::New(\n-        env, obj, 0, false, finalize_cb, native_object, finalize_hint);\n-    *result = reinterpret_cast<napi_ref>(reference);\n-  } else {\n-    // Create a self-deleting reference.\n-    reference = v8impl::Reference::New(env, obj, 0, true, finalize_cb,\n-        native_object, finalize_cb == nullptr ? nullptr : finalize_hint);\n-  }\n-\n-  CHECK(obj->SetPrivate(context, NAPI_PRIVATE_KEY(context, wrapper),\n-        v8::External::New(isolate, reference)).FromJust());\n-\n-  return GET_RETURN_STATUS(env);\n+  return v8impl::Wrap<v8impl::retrievable>(env,\n+                                           js_object,\n+                                           native_object,\n+                                           finalize_cb,\n+                                           finalize_hint,\n+                                           result);\n }\n \n napi_status napi_unwrap(napi_env env, napi_value obj, void** result) {\n@@ -4138,3 +4166,17 @@ napi_ref_threadsafe_function(napi_env env, napi_threadsafe_function func) {\n   CHECK(func != nullptr);\n   return reinterpret_cast<v8impl::ThreadSafeFunction*>(func)->Ref();\n }\n+\n+napi_status napi_add_finalizer(napi_env env,\n+                               napi_value js_object,\n+                               void* native_object,\n+                               napi_finalize finalize_cb,\n+                               void* finalize_hint,\n+                               napi_ref* result) {\n+  return v8impl::Wrap<v8impl::anonymous>(env,\n+                                         js_object,\n+                                         native_object,\n+                                         finalize_cb,\n+                                         finalize_hint,\n+                                         result);\n+}"
        },
        {
            "sha": "10a2c8ff3098bef349240e410721caaa1f9467f0",
            "filename": "src/node_api.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/cf0e881b33c841d2f89a23be281e1aaf061a58a3/src%2Fnode_api.h",
            "raw_url": "https://github.com/nodejs/node/raw/cf0e881b33c841d2f89a23be281e1aaf061a58a3/src%2Fnode_api.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.h?ref=cf0e881b33c841d2f89a23be281e1aaf061a58a3",
            "patch": "@@ -695,6 +695,12 @@ NAPI_EXTERN napi_status napi_get_value_bigint_words(napi_env env,\n                                                     int* sign_bit,\n                                                     size_t* word_count,\n                                                     uint64_t* words);\n+NAPI_EXTERN napi_status napi_add_finalizer(napi_env env,\n+                                           napi_value js_object,\n+                                           void* native_object,\n+                                           napi_finalize finalize_cb,\n+                                           void* finalize_hint,\n+                                           napi_ref* result);\n #endif  // NAPI_EXPERIMENTAL\n \n EXTERN_C_END"
        },
        {
            "sha": "d5df4c8c724f9832a76c0a4c6de407a632d0166a",
            "filename": "test/addons-napi/test_general/testFinalizer.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/cf0e881b33c841d2f89a23be281e1aaf061a58a3/test%2Faddons-napi%2Ftest_general%2FtestFinalizer.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf0e881b33c841d2f89a23be281e1aaf061a58a3/test%2Faddons-napi%2Ftest_general%2FtestFinalizer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_general%2FtestFinalizer.js?ref=cf0e881b33c841d2f89a23be281e1aaf061a58a3",
            "patch": "@@ -0,0 +1,33 @@\n+'use strict';\n+// Flags: --expose-gc\n+\n+const common = require('../../common');\n+const test_general = require(`./build/${common.buildType}/test_general`);\n+const assert = require('assert');\n+\n+let finalized = {};\n+const callback = common.mustCall(2);\n+\n+// Add two items to be finalized and ensure the callback is called for each.\n+test_general.addFinalizerOnly(finalized, callback);\n+test_general.addFinalizerOnly(finalized, callback);\n+\n+// Ensure attached items cannot be retrieved.\n+common.expectsError(() => test_general.unwrap(finalized),\n+                    { type: Error, message: 'Invalid argument' });\n+\n+// Ensure attached items cannot be removed.\n+common.expectsError(() => test_general.removeWrap(finalized),\n+                    { type: Error, message: 'Invalid argument' });\n+finalized = null;\n+global.gc();\n+\n+// Add an item to an object that is already wrapped, and ensure that its\n+// finalizer as well as the wrap finalizer gets called.\n+let finalizeAndWrap = {};\n+test_general.wrap(finalizeAndWrap);\n+test_general.addFinalizerOnly(finalizeAndWrap, common.mustCall());\n+finalizeAndWrap = null;\n+global.gc();\n+assert.strictEqual(test_general.derefItemWasCalled(), true,\n+                   'finalize callback was called');"
        },
        {
            "sha": "498aec4983c0c8b352d04393b9d9730a2e05f3e7",
            "filename": "test/addons-napi/test_general/test_general.c",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/cf0e881b33c841d2f89a23be281e1aaf061a58a3/test%2Faddons-napi%2Ftest_general%2Ftest_general.c",
            "raw_url": "https://github.com/nodejs/node/raw/cf0e881b33c841d2f89a23be281e1aaf061a58a3/test%2Faddons-napi%2Ftest_general%2Ftest_general.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_general%2Ftest_general.c?ref=cf0e881b33c841d2f89a23be281e1aaf061a58a3",
            "patch": "@@ -1,3 +1,4 @@\n+#define NAPI_EXPERIMENTAL\n #include <node_api.h>\n #include <stdlib.h>\n #include \"../common.h\"\n@@ -177,6 +178,17 @@ static napi_value wrap(napi_env env, napi_callback_info info) {\n   return NULL;\n }\n \n+static napi_value unwrap(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value wrapped;\n+  void* data;\n+\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, &wrapped, NULL, NULL));\n+  NAPI_CALL(env, napi_unwrap(env, wrapped, &data));\n+\n+  return NULL;\n+}\n+\n static napi_value remove_wrap(napi_env env, napi_callback_info info) {\n   size_t argc = 1;\n   napi_value wrapped;\n@@ -232,6 +244,33 @@ static napi_value testNapiRun(napi_env env, napi_callback_info info) {\n   return result;\n }\n \n+static void finalizer_only_callback(napi_env env, void* data, void* hint) {\n+  napi_ref js_cb_ref = data;\n+  napi_value js_cb, undefined;\n+  NAPI_CALL_RETURN_VOID(env, napi_get_reference_value(env, js_cb_ref, &js_cb));\n+  NAPI_CALL_RETURN_VOID(env, napi_get_undefined(env, &undefined));\n+  NAPI_CALL_RETURN_VOID(env,\n+      napi_call_function(env, undefined, js_cb, 0, NULL, NULL));\n+  NAPI_CALL_RETURN_VOID(env, napi_delete_reference(env, js_cb_ref));\n+}\n+\n+static napi_value add_finalizer_only(napi_env env, napi_callback_info info) {\n+  size_t argc = 2;\n+  napi_value argv[2];\n+  napi_ref js_cb_ref;\n+\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, argv, NULL, NULL));\n+  NAPI_CALL(env, napi_create_reference(env, argv[1], 1, &js_cb_ref));\n+  NAPI_CALL(env,\n+      napi_add_finalizer(env,\n+                         argv[0],\n+                         js_cb_ref,\n+                         finalizer_only_callback,\n+                         NULL,\n+                         NULL));\n+  return NULL;\n+}\n+\n static napi_value Init(napi_env env, napi_value exports) {\n   napi_property_descriptor descriptors[] = {\n     DECLARE_NAPI_PROPERTY(\"testStrictEquals\", testStrictEquals),\n@@ -246,7 +285,9 @@ static napi_value Init(napi_env env, napi_value exports) {\n     DECLARE_NAPI_PROPERTY(\"testNapiErrorCleanup\", testNapiErrorCleanup),\n     DECLARE_NAPI_PROPERTY(\"testNapiTypeof\", testNapiTypeof),\n     DECLARE_NAPI_PROPERTY(\"wrap\", wrap),\n+    DECLARE_NAPI_PROPERTY(\"unwrap\", unwrap),\n     DECLARE_NAPI_PROPERTY(\"removeWrap\", remove_wrap),\n+    DECLARE_NAPI_PROPERTY(\"addFinalizerOnly\", add_finalizer_only),\n     DECLARE_NAPI_PROPERTY(\"testFinalizeWrap\", test_finalize_wrap),\n     DECLARE_NAPI_PROPERTY(\"finalizeWasCalled\", finalize_was_called),\n     DECLARE_NAPI_PROPERTY(\"derefItemWasCalled\", deref_item_was_called),"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 215,
        "deletions": 35
    }
}