{
    "author": "addaleax",
    "message": "lib: generate allowedNodeEnvironmentFlags lazily\n\nPR-URL: https://github.com/nodejs/node/pull/22638\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "d994e261c352604fdf22b1bb14ebd984851045d6",
    "files": [
        {
            "sha": "265bc81d0c8711183adb48b303ce75dc2c720c72",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 111,
            "deletions": 96,
            "changes": 207,
            "blob_url": "https://github.com/nodejs/node/blob/d994e261c352604fdf22b1bb14ebd984851045d6/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/d994e261c352604fdf22b1bb14ebd984851045d6/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=d994e261c352604fdf22b1bb14ebd984851045d6",
            "patch": "@@ -670,117 +670,132 @@\n     const has = Function.call.bind(Set.prototype.has);\n     const test = Function.call.bind(RegExp.prototype.test);\n \n-    const {\n-      getOptions,\n-      types: { kV8Option },\n-      envSettings: { kAllowedInEnvironment }\n-    } = internalBinding('options');\n-    const { options, aliases } = getOptions();\n-\n-    const allowedV8EnvironmentFlags = [];\n-    const allowedNodeEnvironmentFlags = [];\n-    for (const [name, info] of options) {\n-      if (info.envVarSettings === kAllowedInEnvironment) {\n-        if (info.type === kV8Option) {\n-          allowedV8EnvironmentFlags.push(name);\n-        } else {\n-          allowedNodeEnvironmentFlags.push(name);\n+    const get = () => {\n+      const {\n+        getOptions,\n+        types: { kV8Option },\n+        envSettings: { kAllowedInEnvironment }\n+      } = internalBinding('options');\n+      const { options, aliases } = getOptions();\n+\n+      const allowedV8EnvironmentFlags = [];\n+      const allowedNodeEnvironmentFlags = [];\n+      for (const [name, info] of options) {\n+        if (info.envVarSettings === kAllowedInEnvironment) {\n+          if (info.type === kV8Option) {\n+            allowedV8EnvironmentFlags.push(name);\n+          } else {\n+            allowedNodeEnvironmentFlags.push(name);\n+          }\n         }\n       }\n-    }\n \n-    for (const [ from, expansion ] of aliases) {\n-      let isAccepted = true;\n-      for (const to of expansion) {\n-        if (!to.startsWith('-')) continue;\n-        const recursiveExpansion = aliases.get(to);\n-        if (recursiveExpansion) {\n-          expansion.push(...recursiveExpansion);\n-          continue;\n+      for (const [ from, expansion ] of aliases) {\n+        let isAccepted = true;\n+        for (const to of expansion) {\n+          if (!to.startsWith('-')) continue;\n+          const recursiveExpansion = aliases.get(to);\n+          if (recursiveExpansion) {\n+            expansion.push(...recursiveExpansion);\n+            continue;\n+          }\n+          isAccepted = options.get(to).envVarSettings === kAllowedInEnvironment;\n+          if (!isAccepted) break;\n+        }\n+        if (isAccepted) {\n+          let canonical = from;\n+          if (canonical.endsWith('='))\n+            canonical = canonical.substr(0, canonical.length - 1);\n+          if (canonical.endsWith(' <arg>'))\n+            canonical = canonical.substr(0, canonical.length - 4);\n+          allowedNodeEnvironmentFlags.push(canonical);\n         }\n-        isAccepted = options.get(to).envVarSettings === kAllowedInEnvironment;\n-        if (!isAccepted) break;\n-      }\n-      if (isAccepted) {\n-        let canonical = from;\n-        if (canonical.endsWith('='))\n-          canonical = canonical.substr(0, canonical.length - 1);\n-        if (canonical.endsWith(' <arg>'))\n-          canonical = canonical.substr(0, canonical.length - 4);\n-        allowedNodeEnvironmentFlags.push(canonical);\n       }\n-    }\n \n-    const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n-\n-    // Save these for comparison against flags provided to\n-    // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n-    // Avoid interference w/ user code by flattening `Set.prototype` into\n-    // each object.\n-    const [nodeFlags, v8Flags] = [\n-      allowedNodeEnvironmentFlags, allowedV8EnvironmentFlags\n-    ].map((flags) => Object.defineProperties(\n-      new Set(flags.map(trimLeadingDashes)),\n-      Object.getOwnPropertyDescriptors(Set.prototype))\n-    );\n-\n-    class NodeEnvironmentFlagsSet extends Set {\n-      constructor(...args) {\n-        super(...args);\n-\n-        // the super constructor consumes `add`, but\n-        // disallow any future adds.\n-        this.add = () => this;\n-      }\n+      const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n+\n+      // Save these for comparison against flags provided to\n+      // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n+      // Avoid interference w/ user code by flattening `Set.prototype` into\n+      // each object.\n+      const [nodeFlags, v8Flags] = [\n+        allowedNodeEnvironmentFlags, allowedV8EnvironmentFlags\n+      ].map((flags) => Object.defineProperties(\n+        new Set(flags.map(trimLeadingDashes)),\n+        Object.getOwnPropertyDescriptors(Set.prototype))\n+      );\n \n-      delete() {\n-        // noop, `Set` API compatible\n-        return false;\n-      }\n+      class NodeEnvironmentFlagsSet extends Set {\n+        constructor(...args) {\n+          super(...args);\n \n-      clear() {\n-        // noop\n-      }\n+          // the super constructor consumes `add`, but\n+          // disallow any future adds.\n+          this.add = () => this;\n+        }\n \n-      has(key) {\n-        // This will return `true` based on various possible\n-        // permutations of a flag, including present/missing leading\n-        // dash(es) and/or underscores-for-dashes in the case of V8-specific\n-        // flags.  Strips any values after `=`, inclusive.\n-        // TODO(addaleax): It might be more flexible to run the option parser\n-        // on a dummy option set and see whether it rejects the argument or\n-        // not.\n-        if (typeof key === 'string') {\n-          key = replace(key, trailingValuesRegex, '');\n-          if (test(leadingDashesRegex, key)) {\n-            return has(this, key) ||\n-                  has(v8Flags,\n-                      replace(\n+        delete() {\n+          // noop, `Set` API compatible\n+          return false;\n+        }\n+\n+        clear() {\n+          // noop\n+        }\n+\n+        has(key) {\n+          // This will return `true` based on various possible\n+          // permutations of a flag, including present/missing leading\n+          // dash(es) and/or underscores-for-dashes in the case of V8-specific\n+          // flags.  Strips any values after `=`, inclusive.\n+          // TODO(addaleax): It might be more flexible to run the option parser\n+          // on a dummy option set and see whether it rejects the argument or\n+          // not.\n+          if (typeof key === 'string') {\n+            key = replace(key, trailingValuesRegex, '');\n+            if (test(leadingDashesRegex, key)) {\n+              return has(this, key) ||\n+                    has(v8Flags,\n                         replace(\n-                          key,\n-                          leadingDashesRegex,\n-                          ''\n-                        ),\n-                        replaceDashesRegex,\n-                        '_'\n-                      )\n-                  );\n+                          replace(\n+                            key,\n+                            leadingDashesRegex,\n+                            ''\n+                          ),\n+                          replaceDashesRegex,\n+                          '_'\n+                        )\n+                    );\n+            }\n+            return has(nodeFlags, key) ||\n+                  has(v8Flags, replace(key, replaceDashesRegex, '_'));\n           }\n-          return has(nodeFlags, key) ||\n-                has(v8Flags, replace(key, replaceDashesRegex, '_'));\n+          return false;\n         }\n-        return false;\n       }\n-    }\n \n-    Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n-    Object.freeze(NodeEnvironmentFlagsSet.prototype);\n+      Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n+      Object.freeze(NodeEnvironmentFlagsSet.prototype);\n+\n+      return process.allowedNodeEnvironmentFlags = Object.freeze(\n+        new NodeEnvironmentFlagsSet(\n+          allowedNodeEnvironmentFlags.concat(allowedV8EnvironmentFlags)\n+        ));\n+    };\n \n-    process.allowedNodeEnvironmentFlags = Object.freeze(\n-      new NodeEnvironmentFlagsSet(\n-        allowedNodeEnvironmentFlags.concat(allowedV8EnvironmentFlags)\n-      )\n-    );\n+    Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n+      get,\n+      set(value) {\n+        Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n+          value,\n+          configurable: true,\n+          enumerable: true,\n+          writable: true\n+        });\n+      },\n+      enumerable: true,\n+      configurable: true\n+    });\n   }\n \n   startup();"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 111,
        "deletions": 96
    }
}