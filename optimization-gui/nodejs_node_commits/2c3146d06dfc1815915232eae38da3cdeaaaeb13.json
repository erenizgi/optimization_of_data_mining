{
    "author": "BridgeAR",
    "message": "assert: add direct promises support in rejects\n\nThis adds direct promise support to `assert.rejects` and\n`assert.doesNotReject`. It will now accept both, functions and ES2015\npromises as input.\n\nBesides this the documentation was updated to reflect the latest\nchanges.\n\nIt also refactors the tests to a non blocking way to improve the\nexecution performance and improves the coverage.\n\nPR-URL: https://github.com/nodejs/node/pull/19885\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "2c3146d06dfc1815915232eae38da3cdeaaaeb13",
    "files": [
        {
            "sha": "c868ef64e0a2c210060939b41bcf93170c70b8f2",
            "filename": "doc/api/assert.md",
            "status": "modified",
            "additions": 32,
            "deletions": 22,
            "changes": 54,
            "blob_url": "https://github.com/nodejs/node/blob/2c3146d06dfc1815915232eae38da3cdeaaaeb13/doc%2Fapi%2Fassert.md",
            "raw_url": "https://github.com/nodejs/node/raw/2c3146d06dfc1815915232eae38da3cdeaaaeb13/doc%2Fapi%2Fassert.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fassert.md?ref=2c3146d06dfc1815915232eae38da3cdeaaaeb13",
            "patch": "@@ -378,22 +378,23 @@ parameter is an instance of an [`Error`][] then it will be thrown instead of the\n <!-- YAML\n added: REPLACEME\n -->\n-* `block` {Function}\n+* `block` {Function|Promise}\n * `error` {RegExp|Function}\n * `message` {any}\n \n-Awaits for the promise returned by function `block` to complete and not be\n-rejected.\n+Awaits the `block` promise or, if `block` is a function, immediately calls the\n+function and awaits the returned promise to complete. It will then check that\n+the promise is not rejected.\n+\n+If `block` is a function and it throws an error synchronously,\n+`assert.doesNotReject()` will return a rejected Promise with that error without\n+checking the error handler.\n \n Please note: Using `assert.doesNotReject()` is actually not useful because there\n is little benefit by catching a rejection and then rejecting it again. Instead,\n consider adding a comment next to the specific code path that should not reject\n and keep error messages as expressive as possible.\n \n-When `assert.doesNotReject()` is called, it will immediately call the `block`\n-function, and awaits for completion. See [`assert.rejects()`][] for more\n-details.\n-\n Besides the async nature to await the completion behaves identically to\n [`assert.doesNotThrow()`][].\n \n@@ -409,12 +410,10 @@ Besides the async nature to await the completion behaves identically to\n ```\n \n ```js\n-assert.doesNotReject(\n-  () => Promise.reject(new TypeError('Wrong value')),\n-  SyntaxError\n-).then(() => {\n-  // ...\n-});\n+assert.doesNotReject(Promise.reject(new TypeError('Wrong value')))\n+  .then(() => {\n+    // ...\n+  });\n ```\n \n ## assert.doesNotThrow(block[, error][, message])\n@@ -916,14 +915,17 @@ assert(0);\n <!-- YAML\n added: REPLACEME\n -->\n-* `block` {Function}\n+* `block` {Function|Promise}\n * `error` {RegExp|Function|Object}\n * `message` {any}\n \n-Awaits for promise returned by function `block` to be rejected.\n+Awaits the `block` promise or, if `block` is a function, immediately calls the\n+function and awaits the returned promise to complete. It will then check that\n+the promise is rejected.\n \n-When `assert.rejects()` is called, it will immediately call the `block`\n-function, and awaits for completion.\n+If `block` is a function and it throws an error synchronously,\n+`assert.rejects()` will return a rejected Promise with that error without\n+checking the error handler.\n \n Besides the async nature to await the completion behaves identically to\n [`assert.throws()`][].\n@@ -938,22 +940,31 @@ the block fails to reject.\n (async () => {\n   await assert.rejects(\n     async () => {\n-      throw new Error('Wrong value');\n+      throw new TypeError('Wrong value');\n     },\n-    Error\n+    {\n+      name: 'TypeError',\n+      message: 'Wrong value'\n+    }\n   );\n })();\n ```\n \n ```js\n assert.rejects(\n-  () => Promise.reject(new Error('Wrong value')),\n+  Promise.reject(new Error('Wrong value')),\n   Error\n ).then(() => {\n   // ...\n });\n ```\n \n+Note that `error` cannot be a string. If a string is provided as the second\n+argument, then `error` is assumed to be omitted and the string will be used for\n+`message` instead. This can lead to easy-to-miss mistakes. Please read the\n+example in [`assert.throws()`][] carefully if using a string as the second\n+argument gets considered.\n+\n ## assert.strictEqual(actual, expected[, message])\n <!-- YAML\n added: v0.1.21\n@@ -1069,7 +1080,7 @@ assert.throws(\n );\n ```\n \n-Note that `error` can not be a string. If a string is provided as the second\n+Note that `error` cannot be a string. If a string is provided as the second\n argument, then `error` is assumed to be omitted and the string will be used for\n `message` instead. This can lead to easy-to-miss mistakes. Please read the\n example below carefully if using a string as the second argument gets\n@@ -1123,7 +1134,6 @@ second argument. This might lead to difficult-to-spot errors.\n [`assert.notDeepStrictEqual()`]: #assert_assert_notdeepstrictequal_actual_expected_message\n [`assert.notStrictEqual()`]: #assert_assert_notstrictequal_actual_expected_message\n [`assert.ok()`]: #assert_assert_ok_value_message\n-[`assert.rejects()`]: #assert_assert_rejects_block_error_message\n [`assert.strictEqual()`]: #assert_assert_strictequal_actual_expected_message\n [`assert.throws()`]: #assert_assert_throws_block_error_message\n [`strict mode`]: #assert_strict_mode"
        },
        {
            "sha": "62847e55c3e26f0bf1ca7e6518ffb821b2b9441c",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 30,
            "deletions": 23,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/2c3146d06dfc1815915232eae38da3cdeaaaeb13/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/2c3146d06dfc1815915232eae38da3cdeaaaeb13/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=2c3146d06dfc1815915232eae38da3cdeaaaeb13",
            "patch": "@@ -34,7 +34,7 @@ const {\n   }\n } = require('internal/errors');\n const { openSync, closeSync, readSync } = require('fs');\n-const { inspect } = require('util');\n+const { inspect, types: { isPromise } } = require('util');\n const { EOL } = require('os');\n const { NativeModule } = require('internal/bootstrap/loaders');\n \n@@ -440,13 +440,27 @@ function getActual(block) {\n   return NO_EXCEPTION_SENTINEL;\n }\n \n+function checkIsPromise(obj) {\n+  // Accept native ES6 promises and promises that are implemented in a similar\n+  // way. Do not accept thenables that use a function as `obj` and that have no\n+  // `catch` handler.\n+  return isPromise(obj) ||\n+    obj !== null && typeof obj === 'object' &&\n+    typeof obj.then === 'function' &&\n+    typeof obj.catch === 'function';\n+}\n+\n async function waitForActual(block) {\n-  if (typeof block !== 'function') {\n-    throw new ERR_INVALID_ARG_TYPE('block', 'Function', block);\n+  let resultPromise;\n+  if (typeof block === 'function') {\n+    // Return a rejected promise if `block` throws synchronously.\n+    resultPromise = block();\n+  } else if (checkIsPromise(block)) {\n+    resultPromise = block;\n+  } else {\n+    throw new ERR_INVALID_ARG_TYPE('block', ['Function', 'Promise'], block);\n   }\n \n-  // Return a rejected promise if `block` throws synchronously.\n-  const resultPromise = block();\n   try {\n     await resultPromise;\n   } catch (e) {\n@@ -485,7 +499,7 @@ function expectsError(stackStartFn, actual, error, message) {\n       details += ` (${error.name})`;\n     }\n     details += message ? `: ${message}` : '.';\n-    const fnType = stackStartFn === rejects ? 'rejection' : 'exception';\n+    const fnType = stackStartFn.name === 'rejects' ? 'rejection' : 'exception';\n     innerFail({\n       actual: undefined,\n       expected: error,\n@@ -510,7 +524,8 @@ function expectsNoError(stackStartFn, actual, error, message) {\n \n   if (!error || expectedException(actual, error)) {\n     const details = message ? `: ${message}` : '.';\n-    const fnType = stackStartFn === doesNotReject ? 'rejection' : 'exception';\n+    const fnType = stackStartFn.name === 'doesNotReject' ?\n+      'rejection' : 'exception';\n     innerFail({\n       actual,\n       expected: error,\n@@ -523,29 +538,21 @@ function expectsNoError(stackStartFn, actual, error, message) {\n   throw actual;\n }\n \n-function throws(block, ...args) {\n+assert.throws = function throws(block, ...args) {\n   expectsError(throws, getActual(block), ...args);\n-}\n-\n-assert.throws = throws;\n+};\n \n-async function rejects(block, ...args) {\n+assert.rejects = async function rejects(block, ...args) {\n   expectsError(rejects, await waitForActual(block), ...args);\n-}\n-\n-assert.rejects = rejects;\n+};\n \n-function doesNotThrow(block, ...args) {\n+assert.doesNotThrow = function doesNotThrow(block, ...args) {\n   expectsNoError(doesNotThrow, getActual(block), ...args);\n-}\n-\n-assert.doesNotThrow = doesNotThrow;\n+};\n \n-async function doesNotReject(block, ...args) {\n+assert.doesNotReject = async function doesNotReject(block, ...args) {\n   expectsNoError(doesNotReject, await waitForActual(block), ...args);\n-}\n-\n-assert.doesNotReject = doesNotReject;\n+};\n \n assert.ifError = function ifError(err) {\n   if (err !== null && err !== undefined) {"
        },
        {
            "sha": "2a865c121f36dabac74e339764fa701b94af73a8",
            "filename": "test/parallel/test-assert-async.js",
            "status": "modified",
            "additions": 99,
            "deletions": 57,
            "changes": 156,
            "blob_url": "https://github.com/nodejs/node/blob/2c3146d06dfc1815915232eae38da3cdeaaaeb13/test%2Fparallel%2Ftest-assert-async.js",
            "raw_url": "https://github.com/nodejs/node/raw/2c3146d06dfc1815915232eae38da3cdeaaaeb13/test%2Fparallel%2Ftest-assert-async.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-async.js?ref=2c3146d06dfc1815915232eae38da3cdeaaaeb13",
            "patch": "@@ -1,74 +1,116 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-const { promisify } = require('util');\n-const wait = promisify(setTimeout);\n-\n-/* eslint-disable prefer-common-expectserror, no-restricted-properties */\n \n // Test assert.rejects() and assert.doesNotReject() by checking their\n // expected output and by verifying that they do not work sync\n \n common.crashOnUnhandledRejection();\n \n-(async () => {\n-  await assert.rejects(\n-    async () => assert.fail(),\n-    common.expectsError({\n-      code: 'ERR_ASSERTION',\n-      type: assert.AssertionError,\n-      message: 'Failed'\n-    })\n-  );\n+// Run all tests in parallel and check their outcome at the end.\n+const promises = [];\n \n-  await assert.doesNotReject(() => {});\n+// Check `assert.rejects`.\n+{\n+  const rejectingFn = async () => assert.fail();\n+  const errObj = {\n+    code: 'ERR_ASSERTION',\n+    name: 'AssertionError [ERR_ASSERTION]',\n+    message: 'Failed'\n+  };\n+  // `assert.rejects` accepts a function or a promise as first argument.\n+  promises.push(assert.rejects(rejectingFn, errObj));\n+  promises.push(assert.rejects(rejectingFn(), errObj));\n+}\n \n-  {\n-    const promise = assert.doesNotReject(async () => {\n-      await wait(1);\n-      throw new Error();\n-    });\n-    await assert.rejects(\n-      () => promise,\n-      (err) => {\n-        assert(err instanceof assert.AssertionError,\n-               `${err.name} is not instance of AssertionError`);\n-        assert.strictEqual(err.code, 'ERR_ASSERTION');\n-        assert.strictEqual(err.message,\n-                           'Got unwanted rejection.\\nActual message: \"\"');\n-        assert.strictEqual(err.operator, 'doesNotReject');\n-        assert.ok(!err.stack.includes('at Function.doesNotReject'));\n-        return true;\n-      }\n-    );\n-  }\n+{\n+  const handler = (err) => {\n+    assert(err instanceof assert.AssertionError,\n+           `${err.name} is not instance of AssertionError`);\n+    assert.strictEqual(err.code, 'ERR_ASSERTION');\n+    assert.strictEqual(err.message,\n+                       'Missing expected rejection (handler).');\n+    assert.strictEqual(err.operator, 'rejects');\n+    assert.ok(!err.stack.includes('at Function.rejects'));\n+    return true;\n+  };\n+\n+  let promise = assert.rejects(async () => {}, handler);\n+  promises.push(assert.rejects(promise, handler));\n+\n+  promise = assert.rejects(() => {}, handler);\n+  promises.push(assert.rejects(promise, handler));\n+\n+  promise = assert.rejects(Promise.resolve(), handler);\n+  promises.push(assert.rejects(promise, handler));\n+}\n+\n+{\n+  const THROWN_ERROR = new Error();\n+\n+  promises.push(assert.rejects(() => {\n+    throw THROWN_ERROR;\n+  }).catch(common.mustCall((err) => {\n+    assert.strictEqual(err, THROWN_ERROR);\n+  })));\n+}\n \n+promises.push(assert.rejects(\n+  assert.rejects('fail', {}),\n   {\n-    const promise = assert.rejects(() => {});\n-    await assert.rejects(\n-      () => promise,\n-      (err) => {\n-        assert(err instanceof assert.AssertionError,\n-               `${err.name} is not instance of AssertionError`);\n-        assert.strictEqual(err.code, 'ERR_ASSERTION');\n-        assert(/^Missing expected rejection\\.$/.test(err.message));\n-        assert.strictEqual(err.operator, 'rejects');\n-        assert.ok(!err.stack.includes('at Function.rejects'));\n-        return true;\n-      }\n-    );\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    message: 'The \"block\" argument must be one of type ' +\n+             'Function or Promise. Received type string'\n   }\n+));\n \n+// Check `assert.doesNotReject`.\n+{\n+  // `assert.doesNotReject` accepts a function or a promise as first argument.\n+  promises.push(assert.doesNotReject(() => {}));\n+  promises.push(assert.doesNotReject(async () => {}));\n+  promises.push(assert.doesNotReject(Promise.resolve()));\n+}\n+\n+{\n+  const handler1 = (err) => {\n+    assert(err instanceof assert.AssertionError,\n+           `${err.name} is not instance of AssertionError`);\n+    assert.strictEqual(err.code, 'ERR_ASSERTION');\n+    assert.strictEqual(err.message, 'Failed');\n+    return true;\n+  };\n+  const handler2 = (err) => {\n+    assert(err instanceof assert.AssertionError,\n+           `${err.name} is not instance of AssertionError`);\n+    assert.strictEqual(err.code, 'ERR_ASSERTION');\n+    assert.strictEqual(err.message,\n+                       'Got unwanted rejection.\\nActual message: \"Failed\"');\n+    assert.strictEqual(err.operator, 'doesNotReject');\n+    assert.ok(!err.stack.includes('at Function.doesNotReject'));\n+    return true;\n+  };\n+\n+  const rejectingFn = async () => assert.fail();\n+\n+  let promise = assert.doesNotReject(rejectingFn, handler1);\n+  promises.push(assert.rejects(promise, handler2));\n+\n+  promise = assert.doesNotReject(rejectingFn(), handler1);\n+  promises.push(assert.rejects(promise, handler2));\n+\n+  promise = assert.doesNotReject(() => assert.fail(), common.mustNotCall());\n+  promises.push(assert.rejects(promise, handler1));\n+}\n+\n+promises.push(assert.rejects(\n+  assert.doesNotReject(123),\n   {\n-    const THROWN_ERROR = new Error();\n-\n-    await assert.rejects(() => {\n-      throw THROWN_ERROR;\n-    }).then(common.mustNotCall())\n-      .catch(\n-        common.mustCall((err) => {\n-          assert.strictEqual(err, THROWN_ERROR);\n-        })\n-      );\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    message: 'The \"block\" argument must be one of type ' +\n+             'Function or Promise. Received type number'\n   }\n-})().then(common.mustCall());\n+));\n+\n+// Make sure all async code gets properly executed.\n+Promise.all(promises).then(common.mustCall());"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 161,
        "deletions": 102
    }
}