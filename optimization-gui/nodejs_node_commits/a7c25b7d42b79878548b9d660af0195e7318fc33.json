{
    "author": "mafintosh",
    "message": "stream: always emit error before close\n\nPR-URL: https://github.com/nodejs/node/pull/19836\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "a7c25b7d42b79878548b9d660af0195e7318fc33",
    "files": [
        {
            "sha": "3a0383cc3cea70d886cbd2676acc878a8a0245f0",
            "filename": "lib/internal/streams/destroy.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/a7c25b7d42b79878548b9d660af0195e7318fc33/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7c25b7d42b79878548b9d660af0195e7318fc33/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fdestroy.js?ref=a7c25b7d42b79878548b9d660af0195e7318fc33",
            "patch": "@@ -30,20 +30,27 @@ function destroy(err, cb) {\n   }\n \n   this._destroy(err || null, (err) => {\n-    process.nextTick(emitCloseNT, this);\n     if (!cb && err) {\n-      process.nextTick(emitErrorNT, this, err);\n+      process.nextTick(emitErrorAndCloseNT, this, err);\n       if (this._writableState) {\n         this._writableState.errorEmitted = true;\n       }\n     } else if (cb) {\n+      process.nextTick(emitCloseNT, this);\n       cb(err);\n+    } else {\n+      process.nextTick(emitCloseNT, this);\n     }\n   });\n \n   return this;\n }\n \n+function emitErrorAndCloseNT(self, err) {\n+  emitErrorNT(self, err);\n+  emitCloseNT(self);\n+}\n+\n function emitCloseNT(self) {\n   if (self._writableState && !self._writableState.emitClose)\n     return;"
        },
        {
            "sha": "88e4a99f99eee32a3f980a956abb18aa2aec6419",
            "filename": "test/parallel/test-http2-stream-destroy-event-order.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/a7c25b7d42b79878548b9d660af0195e7318fc33/test%2Fparallel%2Ftest-http2-stream-destroy-event-order.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7c25b7d42b79878548b9d660af0195e7318fc33/test%2Fparallel%2Ftest-http2-stream-destroy-event-order.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-stream-destroy-event-order.js?ref=a7c25b7d42b79878548b9d660af0195e7318fc33",
            "patch": "@@ -9,8 +9,8 @@ let client;\n let req;\n const server = http2.createServer();\n server.on('stream', common.mustCall((stream) => {\n-  stream.on('close', common.mustCall(() => {\n-    stream.on('error', common.mustCall(() => {\n+  stream.on('error', common.mustCall(() => {\n+    stream.on('close', common.mustCall(() => {\n       server.close();\n     }));\n   }));\n@@ -21,8 +21,8 @@ server.listen(0, common.mustCall(() => {\n   client = http2.connect(`http://localhost:${server.address().port}`);\n   req = client.request();\n   req.resume();\n-  req.on('close', common.mustCall(() => {\n-    req.on('error', common.mustCall(() => {\n+  req.on('error', common.mustCall(() => {\n+    req.on('close', common.mustCall(() => {\n       client.close();\n     }));\n   }));"
        },
        {
            "sha": "a88fff820dedb9d9c2035e15db338efed2c26c9f",
            "filename": "test/parallel/test-stream-destroy-event-order.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/a7c25b7d42b79878548b9d660af0195e7318fc33/test%2Fparallel%2Ftest-stream-destroy-event-order.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7c25b7d42b79878548b9d660af0195e7318fc33/test%2Fparallel%2Ftest-stream-destroy-event-order.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-destroy-event-order.js?ref=a7c25b7d42b79878548b9d660af0195e7318fc33",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const { Readable } = require('stream');\n+\n+const rs = new Readable({\n+  read() {}\n+});\n+\n+let closed = false;\n+let errored = false;\n+\n+rs.on('close', common.mustCall(() => {\n+  closed = true;\n+  assert(errored);\n+}));\n+\n+rs.on('error', common.mustCall((err) => {\n+  errored = true;\n+  assert(!closed);\n+}));\n+\n+rs.destroy(new Error('kaboom'));"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 37,
        "deletions": 6
    }
}