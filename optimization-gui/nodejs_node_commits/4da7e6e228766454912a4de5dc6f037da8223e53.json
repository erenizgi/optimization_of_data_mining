{
    "author": "addaleax",
    "message": "src: dispose of V8 platform in `process.exit()`\n\nCalling `process.exit()` calls the C `exit()` function, which in turn\ncalls the destructors of static C++ objects. This can lead to race\nconditions with other concurrently executing threads; disposing of all\nWorker threads and then the V8 platform instance helps with this\n(although it might not be a full solution for all problems of\nthis kind).\n\nRefs: https://github.com/nodejs/node/issues/24403\nRefs: https://github.com/nodejs/node/issues/25007\n\nPR-URL: https://github.com/nodejs/node/pull/25061\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "4da7e6e228766454912a4de5dc6f037da8223e53",
    "files": [
        {
            "sha": "50c718f9e936722dc42fde6072e34e03de01fed3",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=4da7e6e228766454912a4de5dc6f037da8223e53",
            "patch": "@@ -859,10 +859,13 @@ void Environment::AsyncHooks::grow_async_ids_stack() {\n uv_key_t Environment::thread_local_env = {};\n \n void Environment::Exit(int exit_code) {\n-  if (is_main_thread())\n+  if (is_main_thread()) {\n+    stop_sub_worker_contexts();\n+    DisposePlatform();\n     exit(exit_code);\n-  else\n+  } else {\n     worker_context_->Exit(exit_code);\n+  }\n }\n \n void Environment::stop_sub_worker_contexts() {"
        },
        {
            "sha": "7a585646f66ec4fd4246fcd16930777edcb31e78",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=4da7e6e228766454912a4de5dc6f037da8223e53",
            "patch": "@@ -345,6 +345,10 @@ tracing::AgentWriterHandle* GetTracingAgentWriter() {\n   return v8_platform.GetTracingAgentWriter();\n }\n \n+void DisposePlatform() {\n+  v8_platform.Dispose();\n+}\n+\n #ifdef __POSIX__\n static const unsigned kMaxSignal = 32;\n #endif"
        },
        {
            "sha": "fc27b384ec9ab6d720be687bfa4a813a40d8a679",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/4da7e6e228766454912a4de5dc6f037da8223e53/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=4da7e6e228766454912a4de5dc6f037da8223e53",
            "patch": "@@ -345,6 +345,7 @@ int ThreadPoolWork::CancelWork() {\n }\n \n tracing::AgentWriterHandle* GetTracingAgentWriter();\n+void DisposePlatform();\n \n static inline const char* errno_string(int errorno) {\n #define ERRNO_CASE(e)  case e: return #e;"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 10,
        "deletions": 2
    }
}