{
    "author": "jasnell",
    "message": "deps: V8: Backport of 0dd3390 from upstream\n\nOriginal commit message:\n\n  Reland \"[builtins] Add %IsTraceCategoryEnabled and %Trace builtins\"\n\n  This is a reland of 8d4572a\n\n  Original change's description:\n  > [builtins] Add %IsTraceCategoryEnabled and %Trace builtins\n  >\n  > Adds the builtin Trace and IsTraceCategoryEnabled functions\n  > exposed via extra bindings. These are intended to use by\n  > embedders to allow basic trace event support from JavaScript.\n  >\n  > ```js\n  > isTraceCategoryEnabled('v8.some-category')\n  >\n  > trace('e'.charCodeAt(0), 'v8.some-category',\n  >       'Foo', 0, { abc: 'xyz'})\n  > ```\n  >\n  > Bug: v8:7851\n  > Change-Id: I7bfb9bb059efdf87d92a56a0aae326650730c250\n  > Reviewed-on: chromium-review.googlesource.com/1103294\n  > Commit-Queue: Yang Guo <yangguo@chromium.org>\n  > Reviewed-by: Yang Guo <yangguo@chromium.org>\n  > Reviewed-by: Fadi Meawad <fmeawad@chromium.org>\n  > Reviewed-by: Camillo Bruni <cbruni@chromium.org>\n  > Reviewed-by: Benedikt Meurer <bmeurer@chromium.org>\n  > Cr-Commit-Position: refs/heads/master@{#54121}\n\n  TBR=cbruni@chromium.org\n\n  Bug: v8:7851\n  Change-Id: Id063754b2834b3b6a2b2654e76e8637bcd6aa5f8\n  Reviewed-on: chromium-review.googlesource.com/1137071\n  Commit-Queue: Yang Guo <yangguo@chromium.org>\n  Reviewed-by: Yang Guo <yangguo@chromium.org>\n  Reviewed-by: Camillo Bruni <cbruni@chromium.org>\n  Reviewed-by: Benedikt Meurer <bmeurer@chromium.org>\n  Cr-Commit-Position: refs/heads/master@{#54532}\n\nPR-URL: https://github.com/nodejs/node/pull/21899\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "284caaa852194f7418d24c44f2df58614437f3cc",
    "files": [
        {
            "sha": "e7ef87e701dbf19ce1d8037c962ea3944cf42a86",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.10',\n+    'v8_embedder_string': '-node.11',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "e920bbf42bd3d8de7fc005fb8af0677e673a5fa7",
            "filename": "deps/v8/AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2FAUTHORS",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2FAUTHORS",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2FAUTHORS?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -86,6 +86,7 @@ Jan de Mooij <jandemooij@gmail.com>\n Jan Krems <jan.krems@gmail.com>\n Jay Freeman <saurik@saurik.com>\n James Pike <g00gle@chilon.net>\n+James M Snell <jasnell@gmail.com>\n Jianghua Yang <jianghua.yjh@alibaba-inc.com>\n Joel Stanley <joel@jms.id.au>\n Johan Bergstr√∂m <johan@bergstroem.nu>"
        },
        {
            "sha": "f00a8280c10261e4879ae506fcdc879c2e62f3d3",
            "filename": "deps/v8/BUILD.gn",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2FBUILD.gn",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2FBUILD.gn",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2FBUILD.gn?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -1539,6 +1539,7 @@ v8_source_set(\"v8_base\") {\n     \"src/builtins/builtins-sharedarraybuffer.cc\",\n     \"src/builtins/builtins-string.cc\",\n     \"src/builtins/builtins-symbol.cc\",\n+    \"src/builtins/builtins-trace.cc\",\n     \"src/builtins/builtins-typed-array.cc\",\n     \"src/builtins/builtins-utils.h\",\n     \"src/builtins/builtins.cc\","
        },
        {
            "sha": "af5ffdc41b823a798b3657400f3b9ae837c2cb5f",
            "filename": "deps/v8/gypfiles/v8.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fgypfiles%2Fv8.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fgypfiles%2Fv8.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fgypfiles%2Fv8.gyp?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -642,6 +642,7 @@\n         '../src/builtins/builtins-intl.cc',\n         '../src/builtins/builtins-intl.h',\n         '../src/builtins/builtins-symbol.cc',\n+        '../src/builtins/builtins-trace.cc',\n         '../src/builtins/builtins-typed-array.cc',\n         '../src/builtins/builtins-utils.h',\n         '../src/builtins/builtins.cc',"
        },
        {
            "sha": "548ef5109a9a686bf05d134c0e405e5a967ef9fb",
            "filename": "deps/v8/src/bootstrapper.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fbootstrapper.cc?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -4981,6 +4981,15 @@ bool Genesis::InstallExtraNatives() {\n \n   Handle<JSObject> extras_binding =\n       factory()->NewJSObject(isolate()->object_function());\n+\n+  // binding.isTraceCategoryenabled(category)\n+  SimpleInstallFunction(extras_binding, \"isTraceCategoryEnabled\",\n+                        Builtins::kIsTraceCategoryEnabled, 1, true);\n+\n+  // binding.trace(phase, category, name, id, data)\n+  SimpleInstallFunction(extras_binding, \"trace\", Builtins::kTrace, 5,\n+                        true);\n+\n   native_context()->set_extras_binding_object(*extras_binding);\n \n   for (int i = ExtraNatives::GetDebuggerCount();"
        },
        {
            "sha": "4a4b17006cfc0e0ab4d13c3bed7f7ad86aff8502",
            "filename": "deps/v8/src/builtins/builtins-definitions.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-definitions.h",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-definitions.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-definitions.h?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -1269,7 +1269,11 @@ namespace internal {\n   /* Miscellaneous */                                                          \\\n   ASM(DoubleToI)                                                               \\\n   TFC(GetProperty, GetProperty, 1)                                             \\\n-  ASM(MathPowInternal)\n+  ASM(MathPowInternal)                                                         \\\n+                                                                               \\\n+  /* Trace */                                                                  \\\n+  CPP(IsTraceCategoryEnabled)                                                  \\\n+  CPP(Trace)\n \n #ifdef V8_INTL_SUPPORT\n #define BUILTIN_LIST(CPP, API, TFJ, TFC, TFS, TFH, ASM)          \\"
        },
        {
            "sha": "a10c1363387db8a3923e3909cbf7cf512f2d296f",
            "filename": "deps/v8/src/builtins/builtins-trace.cc",
            "status": "added",
            "additions": 191,
            "deletions": 0,
            "changes": 191,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-trace.cc",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-trace.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-trace.cc?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -0,0 +1,191 @@\n+// Copyright 2018 the V8 project authors. All rights reserved.\n+// Use of this source code is governed by a BSD-style license that can be\n+// found in the LICENSE file.\n+\n+#include \"src/api.h\"\n+#include \"src/builtins/builtins-utils.h\"\n+#include \"src/builtins/builtins.h\"\n+#include \"src/counters.h\"\n+#include \"src/json-stringifier.h\"\n+#include \"src/objects-inl.h\"\n+\n+namespace v8 {\n+namespace internal {\n+\n+namespace {\n+\n+using v8::tracing::TracedValue;\n+\n+#define MAX_STACK_LENGTH 100\n+\n+class MaybeUtf8 {\n+ public:\n+  explicit MaybeUtf8(Isolate* isolate, Handle<String> string) : buf_(data_) {\n+    string = String::Flatten(string);\n+    int len;\n+    if (string->IsOneByteRepresentation()) {\n+      // Technically this allows unescaped latin1 characters but the trace\n+      // events mechanism currently does the same and the current consuming\n+      // tools are tolerant of it. A more correct approach here would be to\n+      // escape non-ascii characters but this is easier and faster.\n+      len = string->length();\n+      AllocateSufficientSpace(len);\n+      if (len > 0) {\n+        // Why copy? Well, the trace event mechanism requires null-terminated\n+        // strings, the bytes we get from SeqOneByteString are not. buf_ is\n+        // guaranteed to be null terminated.\n+        memcpy(buf_, Handle<SeqOneByteString>::cast(string)->GetChars(), len);\n+      }\n+    } else {\n+      Local<v8::String> local = Utils::ToLocal(string);\n+      len = local->Utf8Length();\n+      AllocateSufficientSpace(len);\n+      if (len > 0) {\n+        local->WriteUtf8(reinterpret_cast<char*>(buf_));\n+      }\n+    }\n+    buf_[len] = 0;\n+  }\n+  const char* operator*() const { return reinterpret_cast<const char*>(buf_); }\n+\n+ private:\n+  void AllocateSufficientSpace(int len) {\n+    if (len + 1 > MAX_STACK_LENGTH) {\n+      allocated_.reset(new uint8_t[len + 1]);\n+      buf_ = allocated_.get();\n+    }\n+  }\n+\n+  // In the most common cases, the buffer here will be stack allocated.\n+  // A heap allocation will only occur if the data is more than MAX_STACK_LENGTH\n+  // Given that this is used primarily for trace event categories and names,\n+  // the MAX_STACK_LENGTH should be more than enough.\n+  uint8_t* buf_;\n+  uint8_t data_[MAX_STACK_LENGTH];\n+  std::unique_ptr<uint8_t> allocated_;\n+};\n+\n+class JsonTraceValue : public ConvertableToTraceFormat {\n+ public:\n+  explicit JsonTraceValue(Isolate* isolate, Handle<String> object) {\n+    // object is a JSON string serialized using JSON.stringify() from within\n+    // the BUILTIN(Trace) method. This may (likely) contain UTF8 values so\n+    // to grab the appropriate buffer data we have to serialize it out. We\n+    // hold on to the bits until the AppendAsTraceFormat method is called.\n+    MaybeUtf8 data(isolate, object);\n+    data_ = *data;\n+  }\n+\n+  void AppendAsTraceFormat(std::string* out) const override { *out += data_; }\n+\n+ private:\n+  std::string data_;\n+};\n+\n+const uint8_t* GetCategoryGroupEnabled(Isolate* isolate,\n+                                       Handle<String> string) {\n+  MaybeUtf8 category(isolate, string);\n+  return TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(*category);\n+}\n+\n+#undef MAX_STACK_LENGTH\n+\n+}  // namespace\n+\n+// Builins::kIsTraceCategoryEnabled(category) : bool\n+BUILTIN(IsTraceCategoryEnabled) {\n+  HandleScope scope(isolate);\n+  Handle<Object> category = args.atOrUndefined(isolate, 1);\n+  if (!category->IsString()) {\n+    THROW_NEW_ERROR_RETURN_FAILURE(\n+        isolate, NewTypeError(MessageTemplate::kTraceEventCategoryError));\n+  }\n+  return isolate->heap()->ToBoolean(\n+      *GetCategoryGroupEnabled(isolate, Handle<String>::cast(category)));\n+}\n+\n+// Builtins::kTrace(phase, category, name, id, data) : bool\n+BUILTIN(Trace) {\n+  HandleScope handle_scope(isolate);\n+\n+  Handle<Object> phase_arg = args.atOrUndefined(isolate, 1);\n+  Handle<Object> category = args.atOrUndefined(isolate, 2);\n+  Handle<Object> name_arg = args.atOrUndefined(isolate, 3);\n+  Handle<Object> id_arg = args.atOrUndefined(isolate, 4);\n+  Handle<Object> data_arg = args.atOrUndefined(isolate, 5);\n+\n+  const uint8_t* category_group_enabled =\n+      GetCategoryGroupEnabled(isolate, Handle<String>::cast(category));\n+\n+  // Exit early if the category group is not enabled.\n+  if (!*category_group_enabled) {\n+    return isolate->heap()->false_value();\n+  }\n+\n+  if (!phase_arg->IsNumber()) {\n+    THROW_NEW_ERROR_RETURN_FAILURE(\n+        isolate, NewTypeError(MessageTemplate::kTraceEventPhaseError));\n+  }\n+  if (!category->IsString()) {\n+    THROW_NEW_ERROR_RETURN_FAILURE(\n+        isolate, NewTypeError(MessageTemplate::kTraceEventCategoryError));\n+  }\n+  if (!name_arg->IsString()) {\n+    THROW_NEW_ERROR_RETURN_FAILURE(\n+        isolate, NewTypeError(MessageTemplate::kTraceEventNameError));\n+  }\n+\n+  uint32_t flags = TRACE_EVENT_FLAG_COPY;\n+  int32_t id = 0;\n+  if (!id_arg->IsNullOrUndefined(isolate)) {\n+    if (!id_arg->IsNumber()) {\n+      THROW_NEW_ERROR_RETURN_FAILURE(\n+          isolate, NewTypeError(MessageTemplate::kTraceEventIDError));\n+    }\n+    flags |= TRACE_EVENT_FLAG_HAS_ID;\n+    id = DoubleToInt32(id_arg->Number());\n+  }\n+\n+  Handle<String> name_str = Handle<String>::cast(name_arg);\n+  if (name_str->length() == 0) {\n+    THROW_NEW_ERROR_RETURN_FAILURE(\n+        isolate, NewTypeError(MessageTemplate::kTraceEventNameLengthError));\n+  }\n+  MaybeUtf8 name(isolate, name_str);\n+\n+  // We support passing one additional trace event argument with the\n+  // name \"data\". Any JSON serializable value may be passed.\n+  static const char* arg_name = \"data\";\n+  int32_t num_args = 0;\n+  uint8_t arg_type;\n+  uint64_t arg_value;\n+\n+  if (!data_arg->IsUndefined(isolate)) {\n+    // Serializes the data argument as a JSON string, which is then\n+    // copied into an object. This eliminates duplicated code but\n+    // could have perf costs. It is also subject to all the same\n+    // limitations as JSON.stringify() as it relates to circular\n+    // references and value limitations (e.g. BigInt is not supported).\n+    JsonStringifier stringifier(isolate);\n+    Handle<Object> result;\n+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(\n+        isolate, result,\n+        stringifier.Stringify(data_arg, isolate->factory()->undefined_value(),\n+                              isolate->factory()->undefined_value()));\n+    std::unique_ptr<JsonTraceValue> traced_value;\n+    traced_value.reset(\n+        new JsonTraceValue(isolate, Handle<String>::cast(result)));\n+    tracing::SetTraceValue(std::move(traced_value), &arg_type, &arg_value);\n+    num_args++;\n+  }\n+\n+  TRACE_EVENT_API_ADD_TRACE_EVENT(\n+      static_cast<char>(DoubleToInt32(phase_arg->Number())),\n+      category_group_enabled, *name, tracing::kGlobalScope, id, tracing::kNoId,\n+      num_args, &arg_name, &arg_type, &arg_value, flags);\n+\n+  return isolate->heap()->true_value();\n+}\n+\n+}  // namespace internal\n+}  // namespace v8"
        },
        {
            "sha": "505bbad2dda1bf51a06b570bdd0ecf2a169253a1",
            "filename": "deps/v8/src/debug/debug-evaluate.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fdebug%2Fdebug-evaluate.cc",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fdebug%2Fdebug-evaluate.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fdebug%2Fdebug-evaluate.cc?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -630,6 +630,9 @@ SharedFunctionInfo::SideEffectState BuiltinGetSideEffectState(\n     case Builtins::kArrayMap:\n     case Builtins::kArrayReduce:\n     case Builtins::kArrayReduceRight:\n+    // Trace builtins\n+    case Builtins::kIsTraceCategoryEnabled:\n+    case Builtins::kTrace:\n     // TypedArray builtins.\n     case Builtins::kTypedArrayConstructor:\n     case Builtins::kTypedArrayPrototypeBuffer:"
        },
        {
            "sha": "c4877ddf176ad377f57ac5620bdb067b64f63830",
            "filename": "deps/v8/src/messages.h",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fmessages.h",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Fsrc%2Fmessages.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fmessages.h?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -754,7 +754,14 @@ class ErrorUtils : public AllStatic {\n   T(DataCloneDeserializationError, \"Unable to deserialize cloned data.\")       \\\n   T(DataCloneDeserializationVersionError,                                      \\\n     \"Unable to deserialize cloned data due to invalid or unsupported \"         \\\n-    \"version.\")\n+    \"version.\")                                                                \\\n+  /* Builtins-Trace Errors */                                                  \\\n+  T(TraceEventCategoryError, \"Trace event category must be a string.\")         \\\n+  T(TraceEventNameError, \"Trace event name must be a string.\")                 \\\n+  T(TraceEventNameLengthError,                                                 \\\n+    \"Trace event name must not be an empty string.\")                           \\\n+  T(TraceEventPhaseError, \"Trace event phase must be a number.\")               \\\n+  T(TraceEventIDError, \"Trace event id must be a number.\")\n \n class MessageTemplate {\n  public:"
        },
        {
            "sha": "47545af37f89c0fcd648293a5bb1c70a5e6360b0",
            "filename": "deps/v8/test/cctest/test-trace-event.cc",
            "status": "modified",
            "additions": 133,
            "deletions": 1,
            "changes": 134,
            "blob_url": "https://github.com/nodejs/node/blob/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Ftest%2Fcctest%2Ftest-trace-event.cc",
            "raw_url": "https://github.com/nodejs/node/raw/284caaa852194f7418d24c44f2df58614437f3cc/deps%2Fv8%2Ftest%2Fcctest%2Ftest-trace-event.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-trace-event.cc?ref=284caaa852194f7418d24c44f2df58614437f3cc",
            "patch": "@@ -75,7 +75,7 @@ class MockTracingController : public v8::TracingController {\n                                 const char* name, uint64_t handle) override {}\n \n   const uint8_t* GetCategoryGroupEnabled(const char* name) override {\n-    if (strcmp(name, \"v8-cat\")) {\n+    if (strncmp(name, \"v8-cat\", 6)) {\n       static uint8_t no = 0;\n       return &no;\n     } else {\n@@ -282,3 +282,135 @@ TEST(TestEventWithTimestamp) {\n   CHECK_EQ(20683, GET_TRACE_OBJECT(3)->timestamp);\n   CHECK_EQ(32832, GET_TRACE_OBJECT(4)->timestamp);\n }\n+\n+TEST(BuiltinsIsTraceCategoryEnabled) {\n+  CcTest::InitializeVM();\n+  MockTracingPlatform platform;\n+\n+  v8::Isolate* isolate = CcTest::isolate();\n+  v8::HandleScope handle_scope(isolate);\n+  LocalContext env;\n+\n+  v8::Local<v8::Object> binding = env->GetExtrasBindingObject();\n+  CHECK(!binding.IsEmpty());\n+\n+  auto undefined = v8::Undefined(isolate);\n+  auto isTraceCategoryEnabled =\n+      binding->Get(env.local(), v8_str(\"isTraceCategoryEnabled\"))\n+          .ToLocalChecked()\n+          .As<v8::Function>();\n+\n+  {\n+    // Test with an enabled category\n+    v8::Local<v8::Value> argv[] = {v8_str(\"v8-cat\")};\n+    auto result = isTraceCategoryEnabled->Call(env.local(), undefined, 1, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(result->BooleanValue());\n+  }\n+\n+  {\n+    // Test with a disabled category\n+    v8::Local<v8::Value> argv[] = {v8_str(\"cat\")};\n+    auto result = isTraceCategoryEnabled->Call(env.local(), undefined, 1, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(!result->BooleanValue());\n+  }\n+\n+  {\n+    // Test with an enabled utf8 category\n+    v8::Local<v8::Value> argv[] = {v8_str(\"v8-cat\\u20ac\")};\n+    auto result = isTraceCategoryEnabled->Call(env.local(), undefined, 1, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(result->BooleanValue());\n+  }\n+}\n+\n+TEST(BuiltinsTrace) {\n+  CcTest::InitializeVM();\n+  MockTracingPlatform platform;\n+\n+  v8::Isolate* isolate = CcTest::isolate();\n+  v8::HandleScope handle_scope(isolate);\n+  LocalContext env;\n+\n+  v8::Local<v8::Object> binding = env->GetExtrasBindingObject();\n+  CHECK(!binding.IsEmpty());\n+\n+  auto undefined = v8::Undefined(isolate);\n+  auto trace = binding->Get(env.local(), v8_str(\"trace\"))\n+                   .ToLocalChecked()\n+                   .As<v8::Function>();\n+\n+  // Test with disabled category\n+  {\n+    v8::Local<v8::String> category = v8_str(\"cat\");\n+    v8::Local<v8::String> name = v8_str(\"name\");\n+    v8::Local<v8::Value> argv[] = {\n+        v8::Integer::New(isolate, 'b'),                // phase\n+        category, name, v8::Integer::New(isolate, 0),  // id\n+        undefined                                      // data\n+    };\n+    auto result = trace->Call(env.local(), undefined, 5, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(!result->BooleanValue());\n+    CHECK_EQ(0, GET_TRACE_OBJECTS_LIST->size());\n+  }\n+\n+  // Test with enabled category\n+  {\n+    v8::Local<v8::String> category = v8_str(\"v8-cat\");\n+    v8::Local<v8::String> name = v8_str(\"name\");\n+    v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+    v8::Local<v8::Object> data = v8::Object::New(isolate);\n+    data->Set(context, v8_str(\"foo\"), v8_str(\"bar\")).FromJust();\n+    v8::Local<v8::Value> argv[] = {\n+        v8::Integer::New(isolate, 'b'),                  // phase\n+        category, name, v8::Integer::New(isolate, 123),  // id\n+        data                                             // data arg\n+    };\n+    auto result = trace->Call(env.local(), undefined, 5, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(result->BooleanValue());\n+    CHECK_EQ(1, GET_TRACE_OBJECTS_LIST->size());\n+\n+    CHECK_EQ(123, GET_TRACE_OBJECT(0)->id);\n+    CHECK_EQ('b', GET_TRACE_OBJECT(0)->phase);\n+    CHECK_EQ(\"name\", GET_TRACE_OBJECT(0)->name);\n+    CHECK_EQ(1, GET_TRACE_OBJECT(0)->num_args);\n+  }\n+\n+  // Test with enabled utf8 category\n+  {\n+    v8::Local<v8::String> category = v8_str(\"v8-cat\\u20ac\");\n+    v8::Local<v8::String> name = v8_str(\"name\\u20ac\");\n+    v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+    v8::Local<v8::Object> data = v8::Object::New(isolate);\n+    data->Set(context, v8_str(\"foo\"), v8_str(\"bar\")).FromJust();\n+    v8::Local<v8::Value> argv[] = {\n+        v8::Integer::New(isolate, 'b'),                  // phase\n+        category, name, v8::Integer::New(isolate, 123),  // id\n+        data                                             // data arg\n+    };\n+    auto result = trace->Call(env.local(), undefined, 5, argv)\n+                      .ToLocalChecked()\n+                      .As<v8::Boolean>();\n+\n+    CHECK(result->BooleanValue());\n+    CHECK_EQ(2, GET_TRACE_OBJECTS_LIST->size());\n+\n+    CHECK_EQ(123, GET_TRACE_OBJECT(1)->id);\n+    CHECK_EQ('b', GET_TRACE_OBJECT(1)->phase);\n+    CHECK_EQ(\"name\\u20ac\", GET_TRACE_OBJECT(1)->name);\n+    CHECK_EQ(1, GET_TRACE_OBJECT(1)->num_args);\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 357,
        "additions": 353,
        "deletions": 4
    }
}