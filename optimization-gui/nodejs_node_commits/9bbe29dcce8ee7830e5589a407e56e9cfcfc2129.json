{
    "author": "cjihrig",
    "message": "report: use libuv calls for OS and machine info\n\nPR-URL: https://github.com/nodejs/node/pull/25900\nFixes: https://github.com/nodejs/node/issues/25843\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "9bbe29dcce8ee7830e5589a407e56e9cfcfc2129",
    "files": [
        {
            "sha": "d41fca20ef5a74063e6cd03c16a6795fb04d1ead",
            "filename": "doc/api/report.md",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/doc%2Fapi%2Freport.md",
            "raw_url": "https://github.com/nodejs/node/raw/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/doc%2Fapi%2Freport.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Freport.md?ref=9bbe29dcce8ee7830e5589a407e56e9cfcfc2129",
            "patch": "@@ -57,8 +57,11 @@ is provided below for reference.\n     \"release\": {\n       \"name\": \"node\"\n     },\n-    \"osVersion\": \"Linux 3.10.0-862.el7.x86_64 #1 SMP Wed Mar 21 18:14:51 EDT 2018\",\n-    \"machine\": \"test_machine x86_64\"\n+    \"osName\": \"Linux\",\n+    \"osRelease\": \"3.10.0-862.el7.x86_64\",\n+    \"osVersion\": \"#1 SMP Wed Mar 21 18:14:51 EDT 2018\",\n+    \"osMachine\": \"x86_64\",\n+    \"host\": \"test_machine\"\n   },\n   \"javascriptStack\": {\n     \"message\": \"Error: *** test-exception.js: throwing uncaught Error\","
        },
        {
            "sha": "e3ff9da6b95b2830dd7e97a5e3224aef75ffe62f",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=9bbe29dcce8ee7830e5589a407e56e9cfcfc2129",
            "patch": "@@ -334,13 +334,11 @@\n             ['OS==\"win\"', {\n               'libraries': [\n                 'dbghelp.lib',\n-                'Netapi32.lib',\n                 'PsApi.lib',\n                 'Ws2_32.lib',\n               ],\n               'dll_files': [\n                 'dbghelp.dll',\n-                'Netapi32.dll',\n                 'PsApi.dll',\n                 'Ws2_32.dll',\n               ],\n@@ -676,13 +674,11 @@\n             ['OS==\"win\"', {\n               'libraries': [\n                 'dbghelp.lib',\n-                'Netapi32.lib',\n                 'PsApi.lib',\n                 'Ws2_32.lib',\n               ],\n               'dll_files': [\n                 'dbghelp.dll',\n-                'Netapi32.dll',\n                 'PsApi.dll',\n                 'Ws2_32.dll',\n               ],\n@@ -1041,13 +1037,11 @@\n             ['OS==\"win\"', {\n               'libraries': [\n                 'dbghelp.lib',\n-                'Netapi32.lib',\n                 'PsApi.lib',\n                 'Ws2_32.lib',\n               ],\n               'dll_files': [\n                 'dbghelp.dll',\n-                'Netapi32.dll',\n                 'PsApi.dll',\n                 'Ws2_32.dll',\n               ],"
        },
        {
            "sha": "d10db1c97bc8b1d604f391a66226ba0dc6b39315",
            "filename": "src/node_report.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 100,
            "changes": 122,
            "blob_url": "https://github.com/nodejs/node/blob/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/src%2Fnode_report.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9bbe29dcce8ee7830e5589a407e56e9cfcfc2129/src%2Fnode_report.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_report.cc?ref=9bbe29dcce8ee7830e5589a407e56e9cfcfc2129",
            "patch": "@@ -28,7 +28,6 @@\n #include <cxxabi.h>\n #include <dlfcn.h>\n #include <inttypes.h>\n-#include <sys/utsname.h>\n #endif\n \n #include <fcntl.h>\n@@ -48,6 +47,15 @@\n extern char** environ;\n #endif\n \n+#ifdef __POSIX__\n+# include <netdb.h>         // MAXHOSTNAMELEN on Solaris.\n+# include <sys/param.h>     // MAXHOSTNAMELEN on Linux and the BSDs.\n+#endif  // __POSIX__\n+\n+#ifndef MAXHOSTNAMELEN\n+# define MAXHOSTNAMELEN 256\n+#endif  // MAXHOSTNAMELEN\n+\n namespace report {\n using node::arraysize;\n using node::Environment;\n@@ -351,107 +359,21 @@ static void PrintVersionInformation(JSONWriter* writer) {\n   // Report release metadata.\n   PrintRelease(writer);\n \n-  // Report operating system and machine information (Windows)\n-#ifdef _WIN32\n-  {\n-    // Level 101 to obtain the server name, type, and associated details.\n-    // ref: https://docs.microsoft.com/en-us/windows/desktop/\n-    // api/lmserver/nf-lmserver-netservergetinfo\n-    const DWORD level = 101;\n-    LPSERVER_INFO_101 os_info = nullptr;\n-    NET_API_STATUS nStatus =\n-        NetServerGetInfo(nullptr, level, reinterpret_cast<LPBYTE*>(&os_info));\n-    if (nStatus == NERR_Success) {\n-      LPSTR os_name = \"Windows\";\n-      const DWORD major = os_info->sv101_version_major & MAJOR_VERSION_MASK;\n-      const DWORD type = os_info->sv101_type;\n-      const bool isServer = (type & SV_TYPE_DOMAIN_CTRL) ||\n-                            (type & SV_TYPE_DOMAIN_BAKCTRL) ||\n-                            (type & SV_TYPE_SERVER_NT);\n-      switch (major) {\n-        case 5:\n-          switch (os_info->sv101_version_minor) {\n-            case 0:\n-              os_name = \"Windows 2000\";\n-              break;\n-            default:\n-              os_name = (isServer ? \"Windows Server 2003\" : \"Windows XP\");\n-          }\n-          break;\n-        case 6:\n-          switch (os_info->sv101_version_minor) {\n-            case 0:\n-              os_name = (isServer ? \"Windows Server 2008\" : \"Windows Vista\");\n-              break;\n-            case 1:\n-              os_name = (isServer ? \"Windows Server 2008 R2\" : \"Windows 7\");\n-              break;\n-            case 2:\n-              os_name = (isServer ? \"Windows Server 2012\" : \"Windows 8\");\n-              break;\n-            case 3:\n-              os_name = (isServer ? \"Windows Server 2012 R2\" : \"Windows 8.1\");\n-              break;\n-            default:\n-              os_name = (isServer ? \"Windows Server\" : \"Windows Client\");\n-          }\n-          break;\n-        case 10:\n-          os_name = (isServer ? \"Windows Server 2016\" : \"Windows 10\");\n-          break;\n-        default:\n-          os_name = (isServer ? \"Windows Server\" : \"Windows Client\");\n-      }\n-      writer->json_keyvalue(\"osVersion\", os_name);\n-\n-      // Convert and report the machine name and comment fields\n-      // (these are LPWSTR types)\n-      size_t count;\n-      char name_buf[256];\n-      wcstombs_s(\n-          &count, name_buf, sizeof(name_buf), os_info->sv101_name, _TRUNCATE);\n-      if (os_info->sv101_comment != nullptr) {\n-        char comment_buf[256];\n-        wcstombs_s(&count,\n-                   comment_buf,\n-                   sizeof(comment_buf),\n-                   os_info->sv101_comment,\n-                   _TRUNCATE);\n-        buf << name_buf << \" \" << comment_buf;\n-        writer->json_keyvalue(\"machine\", buf.str());\n-        buf.flush();\n-      } else {\n-        writer->json_keyvalue(\"machine\", name_buf);\n-      }\n+  // Report operating system and machine information\n+  uv_utsname_t os_info;\n \n-      if (os_info != nullptr) {\n-        NetApiBufferFree(os_info);\n-      }\n-    } else {\n-      // NetServerGetInfo() failed, fallback to use GetComputerName() instead\n-      TCHAR machine_name[256];\n-      DWORD machine_name_size = 256;\n-      writer->json_keyvalue(\"osVersion\", \"Windows\");\n-      if (GetComputerName(machine_name, &machine_name_size)) {\n-        writer->json_keyvalue(\"machine\", machine_name);\n-      }\n-    }\n-  }\n-#else\n-  // Report operating system and machine information (Unix/OSX)\n-  struct utsname os_info;\n-  if (uname(&os_info) >= 0) {\n-#ifdef _AIX\n-    buf << os_info.sysname << \" \" << os_info.version << \".\" << os_info.release;\n-#else\n-    buf << os_info.sysname << \" \" << os_info.release << \" \" << os_info.version;\n-#endif /* _AIX */\n-    writer->json_keyvalue(\"osVersion\", buf.str());\n-    buf.str(\"\");\n-    buf << os_info.nodename << \" \" << os_info.machine;\n-    writer->json_keyvalue(\"machine\", buf.str());\n+  if (uv_os_uname(&os_info) == 0) {\n+    writer->json_keyvalue(\"osName\", os_info.sysname);\n+    writer->json_keyvalue(\"osRelease\", os_info.release);\n+    writer->json_keyvalue(\"osVersion\", os_info.version);\n+    writer->json_keyvalue(\"osMachine\", os_info.machine);\n   }\n-#endif\n+\n+  char host[MAXHOSTNAMELEN + 1];\n+  size_t host_size = sizeof(host);\n+\n+  if (uv_os_gethostname(host, &host_size) == 0)\n+    writer->json_keyvalue(\"host\", host);\n }\n \n // Report the JavaScript stack."
        }
    ],
    "stats": {
        "total": 135,
        "additions": 27,
        "deletions": 108
    }
}