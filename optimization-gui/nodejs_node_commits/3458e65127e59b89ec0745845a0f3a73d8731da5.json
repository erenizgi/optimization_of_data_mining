{
    "author": "oyyd",
    "message": "net: `net.Server.listen()` avoid operations on `null` when fail\n\nWhen `net.Server` fails to create a new handle, an error shall be\nemitted in the next tick. Therefore, we make `net.Server.listen()`\ndirectly  return to avoid following operations on `null`\n`this._handle`.\n\nFixes: https://github.com/nodejs/node/issues/23917\n\nPR-URL: https://github.com/nodejs/node/pull/23920\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "3458e65127e59b89ec0745845a0f3a73d8731da5",
    "files": [
        {
            "sha": "05fc4fa9598b0474c0ac9166b6291d0b64b62df8",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3458e65127e59b89ec0745845a0f3a73d8731da5/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/3458e65127e59b89ec0745845a0f3a73d8731da5/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=3458e65127e59b89ec0745845a0f3a73d8731da5",
            "patch": "@@ -1435,6 +1435,13 @@ Server.prototype.listen = function(...args) {\n     backlog = options.backlog || backlogFromArgs;\n     listenInCluster(this, pipeName, -1, -1,\n                     backlog, undefined, options.exclusive);\n+\n+    if (!this._handle) {\n+      // Failed and an error shall be emitted in the next tick.\n+      // Therefore, we directly return.\n+      return this;\n+    }\n+\n     let mode = 0;\n     if (options.readableAll === true)\n       mode |= PipeConstants.UV_READABLE;"
        },
        {
            "sha": "cc7c6678b0422410253c098a026a582574e68017",
            "filename": "test/parallel/test-net-server-listen-path.js",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/3458e65127e59b89ec0745845a0f3a73d8731da5/test%2Fparallel%2Ftest-net-server-listen-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/3458e65127e59b89ec0745845a0f3a73d8731da5/test%2Fparallel%2Ftest-net-server-listen-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-server-listen-path.js?ref=3458e65127e59b89ec0745845a0f3a73d8731da5",
            "patch": "@@ -69,3 +69,23 @@ function randomPipePath() {\n       srv.close();\n     }));\n }\n+\n+// Test should emit \"error\" events when listening fails.\n+{\n+  const handlePath = randomPipePath();\n+  const srv1 = net.createServer().listen({ path: handlePath }, () => {\n+    // As the handlePath is in use, binding to the same address again should\n+    // make the server emit an 'EADDRINUSE' error.\n+    const srv2 = net.createServer()\n+      .listen({\n+        path: handlePath,\n+        writableAll: true,\n+      }, common.mustNotCall());\n+\n+    srv2.on('error', common.mustCall((err) => {\n+      srv1.close();\n+      assert.strictEqual(err.code, 'EADDRINUSE');\n+      assert(/^listen EADDRINUSE: address already in use/.test(err.message));\n+    }));\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 27,
        "deletions": 0
    }
}