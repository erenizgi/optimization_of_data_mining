{
    "author": "devsnek",
    "message": "tools: add no-duplicate-requires rule\n\nPR-URL: https://github.com/nodejs/node/pull/21712\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Weijia Wang <starkwang@126.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>",
    "sha": "8cae9b2ff808198b4451d9de634320fa5750c4cd",
    "files": [
        {
            "sha": "98568dd9bc43118d9b0ebb6f86e1122af9b151dc",
            "filename": ".eslintrc.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/.eslintrc.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/.eslintrc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/.eslintrc.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -98,6 +98,7 @@ module.exports = {\n     'no-dupe-class-members': 'error',\n     'no-dupe-keys': 'error',\n     'no-duplicate-case': 'error',\n+    'no-duplicate-imports': 'error',\n     'no-empty-character-class': 'error',\n     'no-ex-assign': 'error',\n     'no-extra-boolean-cast': 'error',\n@@ -246,6 +247,7 @@ module.exports = {\n \n     // Custom rules from eslint-plugin-node-core\n     'node-core/no-unescaped-regexp-dot': 'error',\n+    'node-core/no-duplicate-requires': 'error',\n   },\n   globals: {\n     Atomics: false,"
        },
        {
            "sha": "46a0a547907c4536d16d7f1ad9b70da603bb3be8",
            "filename": "benchmark/streams/creation.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/benchmark%2Fstreams%2Fcreation.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/benchmark%2Fstreams%2Fcreation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fstreams%2Fcreation.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -1,9 +1,11 @@\n 'use strict';\n const common = require('../common.js');\n-const Duplex = require('stream').Duplex;\n-const Readable = require('stream').Readable;\n-const Transform = require('stream').Transform;\n-const Writable = require('stream').Writable;\n+const {\n+  Duplex,\n+  Readable,\n+  Transform,\n+  Writable,\n+} = require('stream');\n \n const bench = common.createBenchmark(main, {\n   n: [50e6],"
        },
        {
            "sha": "8b301f42a87620e52626da52178ef0372a9bd323",
            "filename": "doc/api/worker_threads.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/doc%2Fapi%2Fworker_threads.md",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/doc%2Fapi%2Fworker_threads.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker_threads.md?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -286,7 +286,7 @@ For example:\n ```js\n const assert = require('assert');\n const {\n-  Worker, MessageChannel, MessagePort, isMainThread\n+  Worker, MessageChannel, MessagePort, isMainThread, parentPort\n } = require('worker_threads');\n if (isMainThread) {\n   const worker = new Worker(__filename);\n@@ -296,7 +296,7 @@ if (isMainThread) {\n     console.log('received:', value);\n   });\n } else {\n-  require('worker_threads').once('message', (value) => {\n+  parentPort.once('message', (value) => {\n     assert(value.hereIsYourPort instanceof MessagePort);\n     value.hereIsYourPort.postMessage('the worker is sending this');\n     value.hereIsYourPort.close();"
        },
        {
            "sha": "db251caf5f73efcbee325e3249f7751893211c64",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -24,8 +24,12 @@ const { kIncomingMessage } = require('_http_common');\n const { kServerResponse } = require('_http_server');\n const { StreamWrap } = require('_stream_wrap');\n \n-const { defaultTriggerAsyncIdScope } = require('internal/async_hooks');\n-const { async_id_symbol } = require('internal/async_hooks').symbols;\n+const {\n+  defaultTriggerAsyncIdScope,\n+  symbols: {\n+    async_id_symbol,\n+  },\n+} = require('internal/async_hooks');\n const { internalBinding } = require('internal/bootstrap/loaders');\n const {\n   codes: {"
        },
        {
            "sha": "618f1adac8deb7ac7f766313c065aff3623c64b5",
            "filename": "lib/internal/modules/esm/translators.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -14,13 +14,14 @@ const fs = require('fs');\n const { _makeLong } = require('path');\n const { SafeMap } = require('internal/safe_globals');\n const { URL } = require('url');\n-const util = require('util');\n-const debug = util.debuglog('esm');\n-const readFileAsync = util.promisify(fs.readFile);\n+const { debuglog, promisify } = require('util');\n+const readFileAsync = promisify(fs.readFile);\n const readFileSync = fs.readFileSync;\n const StringReplace = Function.call.bind(String.prototype.replace);\n const JsonParse = JSON.parse;\n \n+const debug = debuglog('esm');\n+\n const translators = new SafeMap();\n module.exports = translators;\n "
        },
        {
            "sha": "25026fec5a103a3e523ec08b5195975233da9ceb",
            "filename": "test/.eslintrc.yaml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/test%2F.eslintrc.yaml",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/test%2F.eslintrc.yaml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2F.eslintrc.yaml?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -18,6 +18,7 @@ rules:\n   node-core/number-isnan: error\n   ## common module is mandatory in tests\n   node-core/required-modules: [error, common]\n+  node-core/no-duplicate-requires: off\n \n   no-restricted-syntax:\n     # Config copied from .eslintrc.js"
        },
        {
            "sha": "c7edaeed2b6b6ee065cce0d949a47e1c3596fddf",
            "filename": "test/parallel/test-eslint-duplicate-requires.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/test%2Fparallel%2Ftest-eslint-duplicate-requires.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/test%2Fparallel%2Ftest-eslint-duplicate-requires.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-duplicate-requires.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -0,0 +1,25 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+common.skipIfEslintMissing();\n+\n+const { RuleTester } = require('../../tools/node_modules/eslint');\n+const rule = require('../../tools/eslint-rules/no-duplicate-requires');\n+\n+new RuleTester().run('no-duplicate-requires', rule, {\n+  valid: [\n+    {\n+      code: 'require(\"a\"); require(\"b\"); (function() { require(\"a\"); });',\n+    },\n+    {\n+      code: 'require(a); require(a);',\n+    },\n+  ],\n+  invalid: [\n+    {\n+      code: 'require(\"a\"); require(\"a\");',\n+      errors: [{ message: '\\'a\\' require is duplicated.' }],\n+    },\n+  ],\n+});"
        },
        {
            "sha": "595c22360112cae21a2a2dfcc76f11975f3cafb8",
            "filename": "tools/eslint-rules/no-duplicate-requires.js",
            "status": "added",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/8cae9b2ff808198b4451d9de634320fa5750c4cd/tools%2Feslint-rules%2Fno-duplicate-requires.js",
            "raw_url": "https://github.com/nodejs/node/raw/8cae9b2ff808198b4451d9de634320fa5750c4cd/tools%2Feslint-rules%2Fno-duplicate-requires.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Feslint-rules%2Fno-duplicate-requires.js?ref=8cae9b2ff808198b4451d9de634320fa5750c4cd",
            "patch": "@@ -0,0 +1,70 @@\n+/**\n+ * @fileoverview Ensure modules are not required twice at top level of a module\n+ * @author devsnek\n+ */\n+'use strict';\n+\n+//------------------------------------------------------------------------------\n+// Rule Definition\n+//------------------------------------------------------------------------------\n+\n+\n+function isString(node) {\n+  return node && node.type === 'Literal' && typeof node.value === 'string';\n+}\n+\n+function isRequireCall(node) {\n+  return node.callee.type === 'Identifier' && node.callee.name === 'require';\n+}\n+\n+function isTopLevel(node) {\n+  do {\n+    if (node.type === 'FunctionDeclaration' ||\n+        node.type === 'FunctionExpression' ||\n+        node.type === 'ArrowFunctionExpression' ||\n+        node.type === 'ClassBody' ||\n+        node.type === 'MethodDefinition') {\n+      return false;\n+    }\n+  } while (node = node.parent);\n+  return true;\n+}\n+\n+module.exports = (context) => {\n+  if (context.parserOptions.sourceType === 'module') {\n+    return {};\n+  }\n+\n+  function getRequiredModuleNameFromCall(node) {\n+    // node has arguments and first argument is string\n+    if (node.arguments.length && isString(node.arguments[0])) {\n+      return node.arguments[0].value.trim();\n+    }\n+\n+    return undefined;\n+  }\n+\n+  const required = new Set();\n+\n+  const rules = {\n+    CallExpression: (node) => {\n+      if (isRequireCall(node) && isTopLevel(node)) {\n+        const moduleName = getRequiredModuleNameFromCall(node);\n+        if (moduleName === undefined) {\n+          return;\n+        }\n+        if (required.has(moduleName)) {\n+          context.report(\n+            node,\n+            '\\'{{moduleName}}\\' require is duplicated.',\n+            { moduleName }\n+          );\n+        } else {\n+          required.add(moduleName);\n+        }\n+      }\n+    },\n+  };\n+\n+  return rules;\n+};"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 116,
        "deletions": 11
    }
}