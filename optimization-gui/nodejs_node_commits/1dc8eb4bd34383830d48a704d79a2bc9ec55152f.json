{
    "author": "addaleax",
    "message": "test: add regression test for large write\n\nFixes: https://github.com/nodejs/node/issues/19562\n\nPR-URL: https://github.com/nodejs/node/pull/19551\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1dc8eb4bd34383830d48a704d79a2bc9ec55152f",
    "files": [
        {
            "sha": "79a997ec5a38f1ae5203e40ec0f6400198616507",
            "filename": "test/parallel/test-net-bytes-written-large.js",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/1dc8eb4bd34383830d48a704d79a2bc9ec55152f/test%2Fparallel%2Ftest-net-bytes-written-large.js",
            "raw_url": "https://github.com/nodejs/node/raw/1dc8eb4bd34383830d48a704d79a2bc9ec55152f/test%2Fparallel%2Ftest-net-bytes-written-large.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-bytes-written-large.js?ref=1dc8eb4bd34383830d48a704d79a2bc9ec55152f",
            "patch": "@@ -0,0 +1,67 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const net = require('net');\n+\n+// Regression test for https://github.com/nodejs/node/issues/19562:\n+// Writing to a socket first tries to push through as much data as possible\n+// without blocking synchronously, and, if that is not enough, queues more\n+// data up for asynchronous writing.\n+// Check that `bytesWritten` accounts for both parts of a write.\n+\n+const N = 10000000;\n+{\n+  // Variant 1: Write a Buffer.\n+  const server = net.createServer(common.mustCall((socket) => {\n+    socket.end(Buffer.alloc(N), common.mustCall(() => {\n+      assert.strictEqual(socket.bytesWritten, N);\n+    }));\n+    assert.strictEqual(socket.bytesWritten, N);\n+  })).listen(0, common.mustCall(() => {\n+    const client = net.connect(server.address().port);\n+    client.resume();\n+    client.on('close', common.mustCall(() => {\n+      assert.strictEqual(client.bytesRead, N);\n+      server.close();\n+    }));\n+  }));\n+}\n+\n+{\n+  // Variant 2: Write a string.\n+  const server = net.createServer(common.mustCall((socket) => {\n+    socket.end('a'.repeat(N), common.mustCall(() => {\n+      assert.strictEqual(socket.bytesWritten, N);\n+    }));\n+    assert.strictEqual(socket.bytesWritten, N);\n+  })).listen(0, common.mustCall(() => {\n+    const client = net.connect(server.address().port);\n+    client.resume();\n+    client.on('close', common.mustCall(() => {\n+      assert.strictEqual(client.bytesRead, N);\n+      server.close();\n+    }));\n+  }));\n+}\n+\n+{\n+  // Variant 2: writev() with mixed data.\n+  const server = net.createServer(common.mustCall((socket) => {\n+    socket.cork();\n+    socket.write('a'.repeat(N));\n+    assert.strictEqual(socket.bytesWritten, N);\n+    socket.write(Buffer.alloc(N));\n+    assert.strictEqual(socket.bytesWritten, 2 * N);\n+    socket.end('', common.mustCall(() => {\n+      assert.strictEqual(socket.bytesWritten, 2 * N);\n+    }));\n+    socket.uncork();\n+  })).listen(0, common.mustCall(() => {\n+    const client = net.connect(server.address().port);\n+    client.resume();\n+    client.on('close', common.mustCall(() => {\n+      assert.strictEqual(client.bytesRead, 2 * N);\n+      server.close();\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 67,
        "deletions": 0
    }
}