{
    "author": "starkwang",
    "message": "http: improve performance for incoming headers\n\nPR-URL: https://github.com/nodejs/node/pull/26041\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "da0dc51e396ea4a1f12f259a8149f4177ad674e8",
    "files": [
        {
            "sha": "a4d623003947eb9f55eb5060816b87c61d6ee747",
            "filename": "benchmark/_http-benchmarkers.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/da0dc51e396ea4a1f12f259a8149f4177ad674e8/benchmark%2F_http-benchmarkers.js",
            "raw_url": "https://github.com/nodejs/node/raw/da0dc51e396ea4a1f12f259a8149f4177ad674e8/benchmark%2F_http-benchmarkers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2F_http-benchmarkers.js?ref=da0dc51e396ea4a1f12f259a8149f4177ad674e8",
            "patch": "@@ -25,8 +25,11 @@ class AutocannonBenchmarker {\n       '-c', options.connections,\n       '-j',\n       '-n',\n-      `http://127.0.0.1:${options.port}${options.path}`,\n     ];\n+    for (const field in options.headers) {\n+      args.push('-H', `${field}=${options.headers[field]}`);\n+    }\n+    args.push(`http://127.0.0.1:${options.port}${options.path}`);\n     const child = child_process.spawn(this.executable, args);\n     return child;\n   }"
        },
        {
            "sha": "a1ab57e23876bfc0de42e0c33cb024359499423e",
            "filename": "benchmark/http/incoming_headers.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/da0dc51e396ea4a1f12f259a8149f4177ad674e8/benchmark%2Fhttp%2Fincoming_headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/da0dc51e396ea4a1f12f259a8149f4177ad674e8/benchmark%2Fhttp%2Fincoming_headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp%2Fincoming_headers.js?ref=da0dc51e396ea4a1f12f259a8149f4177ad674e8",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+const common = require('../common.js');\n+const http = require('http');\n+\n+const bench = common.createBenchmark(main, {\n+  // unicode confuses ab on os x.\n+  c: [50, 500],\n+  headerDuplicates: [0, 5, 20]\n+});\n+\n+function main({ c, headerDuplicates }) {\n+  const server = http.createServer((req, res) => {\n+    res.end();\n+  });\n+\n+  server.listen(common.PORT, () => {\n+    const headers = {\n+      'Content-Type': 'text/plain',\n+      'Accept': 'text/plain',\n+      'User-Agent': 'nodejs-benchmark',\n+      'Date': new Date().toString(),\n+      'Cache-Control': 'no-cache'\n+    };\n+    for (let i = 0; i < headerDuplicates; i++) {\n+      headers[`foo${i}`] = `some header value ${i}`;\n+    }\n+    bench.http({\n+      path: '/',\n+      connections: c,\n+      headers\n+    }, () => {\n+      server.close();\n+    });\n+  });\n+}"
        },
        {
            "sha": "7ba4d366b2147f807401739e95c4b32039f79c4f",
            "filename": "lib/_http_incoming.js",
            "status": "modified",
            "additions": 85,
            "deletions": 117,
            "changes": 202,
            "blob_url": "https://github.com/nodejs/node/blob/da0dc51e396ea4a1f12f259a8149f4177ad674e8/lib%2F_http_incoming.js",
            "raw_url": "https://github.com/nodejs/node/raw/da0dc51e396ea4a1f12f259a8149f4177ad674e8/lib%2F_http_incoming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_incoming.js?ref=da0dc51e396ea4a1f12f259a8149f4177ad674e8",
            "patch": "@@ -134,133 +134,101 @@ function _addHeaderLines(headers, n) {\n // TODO: perhaps http_parser could be returning both raw and lowercased versions\n // of known header names to avoid us having to call toLowerCase() for those\n // headers.\n-\n-// 'array' header list is taken from:\n-// https://mxr.mozilla.org/mozilla/source/netwerk/protocol/http/src/nsHttpHeaderArray.cpp\n-function matchKnownFields(field) {\n-  var low = false;\n-  while (true) {\n-    switch (field) {\n-      case 'Content-Type':\n-      case 'content-type':\n-        return 'content-type';\n-      case 'Content-Length':\n-      case 'content-length':\n-        return 'content-length';\n-      case 'User-Agent':\n-      case 'user-agent':\n-        return 'user-agent';\n-      case 'Referer':\n-      case 'referer':\n-        return 'referer';\n-      case 'Host':\n-      case 'host':\n-        return 'host';\n-      case 'Authorization':\n-      case 'authorization':\n-        return 'authorization';\n-      case 'Proxy-Authorization':\n-      case 'proxy-authorization':\n-        return 'proxy-authorization';\n-      case 'If-Modified-Since':\n-      case 'if-modified-since':\n-        return 'if-modified-since';\n-      case 'If-Unmodified-Since':\n-      case 'if-unmodified-since':\n-        return 'if-unmodified-since';\n-      case 'From':\n-      case 'from':\n-        return 'from';\n-      case 'Location':\n-      case 'location':\n+function matchKnownFields(field, lowercased) {\n+  switch (field.length) {\n+    case 3:\n+      if (field === 'Age' || field === 'age') return 'age';\n+      break;\n+    case 4:\n+      if (field === 'Host' || field === 'host') return 'host';\n+      if (field === 'From' || field === 'from') return 'from';\n+      if (field === 'ETag' || field === 'etag') return 'etag';\n+      if (field === 'Date' || field === 'date') return '\\u0000date';\n+      if (field === 'Vary' || field === 'vary') return '\\u0000vary';\n+      break;\n+    case 6:\n+      if (field === 'Server' || field === 'server') return 'server';\n+      if (field === 'Cookie' || field === 'cookie') return '\\u0002cookie';\n+      if (field === 'Origin' || field === 'origin') return '\\u0000origin';\n+      if (field === 'Expect' || field === 'expect') return '\\u0000expect';\n+      if (field === 'Accept' || field === 'accept') return '\\u0000accept';\n+      break;\n+    case 7:\n+      if (field === 'Referer' || field === 'referer') return 'referer';\n+      if (field === 'Expires' || field === 'expires') return 'expires';\n+      if (field === 'Upgrade' || field === 'upgrade') return '\\u0000upgrade';\n+      break;\n+    case 8:\n+      if (field === 'Location' || field === 'location')\n         return 'location';\n-      case 'Max-Forwards':\n-      case 'max-forwards':\n-        return 'max-forwards';\n-      case 'Retry-After':\n-      case 'retry-after':\n-        return 'retry-after';\n-      case 'ETag':\n-      case 'etag':\n-        return 'etag';\n-      case 'Last-Modified':\n-      case 'last-modified':\n-        return 'last-modified';\n-      case 'Server':\n-      case 'server':\n-        return 'server';\n-      case 'Age':\n-      case 'age':\n-        return 'age';\n-      case 'Expires':\n-      case 'expires':\n-        return 'expires';\n-      case 'Set-Cookie':\n-      case 'set-cookie':\n+      if (field === 'If-Match' || field === 'if-match')\n+        return '\\u0000if-match';\n+      break;\n+    case 10:\n+      if (field === 'User-Agent' || field === 'user-agent')\n+        return 'user-agent';\n+      if (field === 'Set-Cookie' || field === 'set-cookie')\n         return '\\u0001';\n-      case 'Cookie':\n-      case 'cookie':\n-        return '\\u0002cookie';\n-      // The fields below are not used in _addHeaderLine(), but they are common\n-      // headers where we can avoid toLowerCase() if the mixed or lower case\n-      // versions match the first time through.\n-      case 'Transfer-Encoding':\n-      case 'transfer-encoding':\n-        return '\\u0000transfer-encoding';\n-      case 'Date':\n-      case 'date':\n-        return '\\u0000date';\n-      case 'Connection':\n-      case 'connection':\n+      if (field === 'Connection' || field === 'connection')\n         return '\\u0000connection';\n-      case 'Cache-Control':\n-      case 'cache-control':\n+      break;\n+    case 11:\n+      if (field === 'Retry-After' || field === 'retry-after')\n+        return 'retry-after';\n+      break;\n+    case 12:\n+      if (field === 'Content-Type' || field === 'content-type')\n+        return 'content-type';\n+      if (field === 'Max-Forwards' || field === 'max-forwards')\n+        return 'max-forwards';\n+      break;\n+    case 13:\n+      if (field === 'Authorization' || field === 'authorization')\n+        return 'authorization';\n+      if (field === 'Last-Modified' || field === 'last-modified')\n+        return 'last-modified';\n+      if (field === 'Cache-Control' || field === 'cache-control')\n         return '\\u0000cache-control';\n-      case 'Vary':\n-      case 'vary':\n-        return '\\u0000vary';\n-      case 'Content-Encoding':\n-      case 'content-encoding':\n-        return '\\u0000content-encoding';\n-      case 'Origin':\n-      case 'origin':\n-        return '\\u0000origin';\n-      case 'Upgrade':\n-      case 'upgrade':\n-        return '\\u0000upgrade';\n-      case 'Expect':\n-      case 'expect':\n-        return '\\u0000expect';\n-      case 'If-Match':\n-      case 'if-match':\n-        return '\\u0000if-match';\n-      case 'If-None-Match':\n-      case 'if-none-match':\n+      if (field === 'If-None-Match' || field === 'if-none-match')\n         return '\\u0000if-none-match';\n-      case 'Accept':\n-      case 'accept':\n-        return '\\u0000accept';\n-      case 'Accept-Encoding':\n-      case 'accept-encoding':\n+      break;\n+    case 14:\n+      if (field === 'Content-Length' || field === 'content-length')\n+        return 'content-length';\n+      break;\n+    case 15:\n+      if (field === 'Accept-Encoding' || field === 'accept-encoding')\n         return '\\u0000accept-encoding';\n-      case 'Accept-Language':\n-      case 'accept-language':\n+      if (field === 'Accept-Language' || field === 'accept-language')\n         return '\\u0000accept-language';\n-      case 'X-Forwarded-For':\n-      case 'x-forwarded-for':\n+      if (field === 'X-Forwarded-For' || field === 'x-forwarded-for')\n         return '\\u0000x-forwarded-for';\n-      case 'X-Forwarded-Host':\n-      case 'x-forwarded-host':\n+      break;\n+    case 16:\n+      if (field === 'Content-Encoding' || field === 'content-encoding')\n+        return '\\u0000content-encoding';\n+      if (field === 'X-Forwarded-Host' || field === 'x-forwarded-host')\n         return '\\u0000x-forwarded-host';\n-      case 'X-Forwarded-Proto':\n-      case 'x-forwarded-proto':\n+      break;\n+    case 17:\n+      if (field === 'If-Modified-Since' || field === 'if-modified-since')\n+        return 'if-modified-since';\n+      if (field === 'Transfer-Encoding' || field === 'transfer-encoding')\n+        return '\\u0000transfer-encoding';\n+      if (field === 'X-Forwarded-Proto' || field === 'x-forwarded-proto')\n         return '\\u0000x-forwarded-proto';\n-      default:\n-        if (low)\n-          return '\\u0000' + field;\n-        field = field.toLowerCase();\n-        low = true;\n-    }\n+      break;\n+    case 19:\n+      if (field === 'Proxy-Authorization' || field === 'proxy-authorization')\n+        return 'proxy-authorization';\n+      if (field === 'If-Unmodified-Since' || field === 'if-unmodified-since')\n+        return 'if-unmodified-since';\n+      break;\n+  }\n+  if (lowercased) {\n+    return '\\u0000' + field;\n+  } else {\n+    return matchKnownFields(field.toLowerCase(), true);\n   }\n }\n // Add the given (field, value) pair to the message"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 124,
        "deletions": 118
    }
}