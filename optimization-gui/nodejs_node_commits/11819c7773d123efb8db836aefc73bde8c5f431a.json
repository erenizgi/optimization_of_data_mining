{
    "author": "aduh95",
    "message": "fs: handle long files reading in fs.promises\n\nPR-URL: https://github.com/nodejs/node/pull/19643\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "11819c7773d123efb8db836aefc73bde8c5f431a",
    "files": [
        {
            "sha": "ba6c2b7aa64855aacc93a722ef846f401c7b905b",
            "filename": "lib/fs/promises.js",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/11819c7773d123efb8db836aefc73bde8c5f431a/lib%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/11819c7773d123efb8db836aefc73bde8c5f431a/lib%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs%2Fpromises.js?ref=11819c7773d123efb8db836aefc73bde8c5f431a",
            "patch": "@@ -147,15 +147,17 @@ async function readFileHandle(filehandle, options) {\n \n   const chunks = [];\n   const chunkSize = Math.min(size, 16384);\n-  const buf = Buffer.alloc(chunkSize);\n   let totalRead = 0;\n+  let endOfFile = false;\n   do {\n+    const buf = Buffer.alloc(chunkSize);\n     const { bytesRead, buffer } =\n-      await read(filehandle, buf, 0, buf.length);\n-    totalRead = bytesRead;\n-    if (totalRead > 0)\n-      chunks.push(buffer.slice(0, totalRead));\n-  } while (totalRead === chunkSize);\n+      await read(filehandle, buf, 0, chunkSize, totalRead);\n+    totalRead += bytesRead;\n+    endOfFile = bytesRead !== chunkSize;\n+    if (bytesRead > 0)\n+      chunks.push(buffer.slice(0, bytesRead));\n+  } while (!endOfFile);\n \n   const result = Buffer.concat(chunks);\n   if (options.encoding) {"
        },
        {
            "sha": "1bf49503c312c0ee9788823940766f0db883269d",
            "filename": "test/parallel/test-fs-promises-readfile.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/11819c7773d123efb8db836aefc73bde8c5f431a/test%2Fparallel%2Ftest-fs-promises-readfile.js",
            "raw_url": "https://github.com/nodejs/node/raw/11819c7773d123efb8db836aefc73bde8c5f431a/test%2Fparallel%2Ftest-fs-promises-readfile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-readfile.js?ref=11819c7773d123efb8db836aefc73bde8c5f431a",
            "patch": "@@ -0,0 +1,28 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+const assert = require('assert');\n+const path = require('path');\n+const { writeFile, readFile } = require('fs/promises');\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const fn = path.join(tmpdir.path, 'large-file');\n+\n+common.crashOnUnhandledRejection();\n+\n+// Creating large buffer with random content\n+const buffer = Buffer.from(\n+  Array.apply(null, { length: 16834 * 2 })\n+    .map(Math.random)\n+    .map((number) => (number * (1 << 8)))\n+);\n+\n+// Writing buffer to a file then try to read it\n+writeFile(fn, buffer)\n+  .then(() => readFile(fn))\n+  .then((readBuffer) => {\n+    assert.strictEqual(readBuffer.equals(buffer), true);\n+  })\n+  .then(common.mustCall());"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 36,
        "deletions": 6
    }
}