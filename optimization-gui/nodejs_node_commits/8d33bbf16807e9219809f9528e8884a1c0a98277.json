{
    "author": "itaysabato",
    "message": "worker: support relative paths\n\nThis commit adds support for relative paths in Worker.\nPaths are relative to the current working directory.\n\nPR-URL: https://github.com/nodejs/node/pull/21407\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "8d33bbf16807e9219809f9528e8884a1c0a98277",
    "files": [
        {
            "sha": "00e44618ef0dfdaa05168631e85427cc619fab75",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -1754,10 +1754,11 @@ The fulfilled value of a linking promise is not a `vm.Module` object.\n The current module's status does not allow for this operation. The specific\n meaning of the error depends on the specific function.\n \n-<a id=\"ERR_WORKER_NEED_ABSOLUTE_PATH\"></a>\n-### ERR_WORKER_NEED_ABSOLUTE_PATH\n+<a id=\"ERR_WORKER_PATH\"></a>\n+### ERR_WORKER_PATH\n \n-The path for the main script of a worker is not an absolute path.\n+The path for the main script of a worker is neither an absolute path\n+nor a relative path starting with `./` or `../`.\n \n <a id=\"ERR_WORKER_UNSERIALIZABLE_ERROR\"></a>\n ### ERR_WORKER_UNSERIALIZABLE_ERROR"
        },
        {
            "sha": "9578403c5ca94dd2adac21176d898f88e89901d2",
            "filename": "doc/api/worker_threads.md",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/doc%2Fapi%2Fworker_threads.md",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/doc%2Fapi%2Fworker_threads.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker_threads.md?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -306,7 +306,9 @@ if (isMainThread) {\n \n ### new Worker(filename[, options])\n \n-* `filename` {string} The absolute path to the Worker’s main script.\n+* `filename` {string} The path to the Worker’s main script. Must be\n+  either an absolute path or a relative path (i.e. relative to the\n+  current working directory) starting with `./` or `../`.\n   If `options.eval` is true, this is a string containing JavaScript code rather\n   than a path.\n * `options` {Object}"
        },
        {
            "sha": "24e1f34b25d96a8eaf945c875d478ce4259598e5",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -847,8 +847,9 @@ E('ERR_VM_MODULE_NOT_LINKED',\n E('ERR_VM_MODULE_NOT_MODULE',\n   'Provided module is not an instance of Module', Error);\n E('ERR_VM_MODULE_STATUS', 'Module status %s', Error);\n-E('ERR_WORKER_NEED_ABSOLUTE_PATH',\n-  'The worker script filename must be an absolute path. Received \"%s\"',\n+E('ERR_WORKER_PATH',\n+  'The worker script filename must be an absolute path or a relative ' +\n+  'path starting with \\'./\\' or \\'../\\'. Received \"%s\"',\n   TypeError);\n E('ERR_WORKER_UNSERIALIZABLE_ERROR',\n   'Serializing an uncaught exception failed', Error);"
        },
        {
            "sha": "df4f28cf749fe9a8dc7bb4521568bda5c40e61ef",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -7,7 +7,7 @@ const util = require('util');\n const { Readable, Writable } = require('stream');\n const {\n   ERR_INVALID_ARG_TYPE,\n-  ERR_WORKER_NEED_ABSOLUTE_PATH,\n+  ERR_WORKER_PATH,\n   ERR_WORKER_UNSERIALIZABLE_ERROR,\n   ERR_WORKER_UNSUPPORTED_EXTENSION,\n } = require('internal/errors').codes;\n@@ -212,9 +212,15 @@ class Worker extends EventEmitter {\n     }\n \n     if (!options.eval) {\n-      if (!path.isAbsolute(filename)) {\n-        throw new ERR_WORKER_NEED_ABSOLUTE_PATH(filename);\n+      if (!path.isAbsolute(filename) &&\n+          !filename.startsWith('./') &&\n+          !filename.startsWith('../') &&\n+          !filename.startsWith('.' + path.sep) &&\n+          !filename.startsWith('..' + path.sep)) {\n+        throw new ERR_WORKER_PATH(filename);\n       }\n+      filename = path.resolve(filename);\n+\n       const ext = path.extname(filename);\n       if (ext !== '.js' && ext !== '.mjs') {\n         throw new ERR_WORKER_UNSUPPORTED_EXTENSION(ext);"
        },
        {
            "sha": "ecd294a4d3cba4fa36a17285455b716f8192ed20",
            "filename": "test/parallel/test-worker-relative-path-double-dot.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-relative-path-double-dot.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-relative-path-double-dot.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-relative-path-double-dot.js?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -0,0 +1,17 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const path = require('path');\n+const assert = require('assert');\n+const common = require('../common');\n+const { Worker, isMainThread, parentPort } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const cwdName = path.relative('../', '.');\n+  const relativePath = path.relative('.', __filename);\n+  const w = new Worker(path.join('..', cwdName, relativePath));\n+  w.on('message', common.mustCall((message) => {\n+    assert.strictEqual(message, 'Hello, world!');\n+  }));\n+} else {\n+  parentPort.postMessage('Hello, world!');\n+}"
        },
        {
            "sha": "30d2a5dde3e779d5cd44c1d3b58c1fb6f4106b4e",
            "filename": "test/parallel/test-worker-relative-path.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-relative-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-relative-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-relative-path.js?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -0,0 +1,15 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const path = require('path');\n+const assert = require('assert');\n+const common = require('../common');\n+const { Worker, isMainThread, parentPort } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const w = new Worker('./' + path.relative('.', __filename));\n+  w.on('message', common.mustCall((message) => {\n+    assert.strictEqual(message, 'Hello, world!');\n+  }));\n+} else {\n+  parentPort.postMessage('Hello, world!');\n+}"
        },
        {
            "sha": "71999eb5fe44ec860f606bb10ce0a003f35b1451",
            "filename": "test/parallel/test-worker-unsupported-path.js",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-unsupported-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d33bbf16807e9219809f9528e8884a1c0a98277/test%2Fparallel%2Ftest-worker-unsupported-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-unsupported-path.js?ref=8d33bbf16807e9219809f9528e8884a1c0a98277",
            "patch": "@@ -1,21 +1,11 @@\n // Flags: --experimental-worker\n 'use strict';\n \n+const path = require('path');\n const common = require('../common');\n const assert = require('assert');\n const { Worker } = require('worker_threads');\n \n-{\n-  const expectedErr = common.expectsError({\n-    code: 'ERR_WORKER_NEED_ABSOLUTE_PATH',\n-    type: TypeError\n-  }, 4);\n-  assert.throws(() => { new Worker('a.js'); }, expectedErr);\n-  assert.throws(() => { new Worker('b'); }, expectedErr);\n-  assert.throws(() => { new Worker('c/d.js'); }, expectedErr);\n-  assert.throws(() => { new Worker('a.mjs'); }, expectedErr);\n-}\n-\n {\n   const expectedErr = common.expectsError({\n     code: 'ERR_WORKER_UNSUPPORTED_EXTENSION',\n@@ -25,3 +15,15 @@ const { Worker } = require('worker_threads');\n   assert.throws(() => { new Worker('/c.wasm'); }, expectedErr);\n   assert.throws(() => { new Worker('/d.txt'); }, expectedErr);\n }\n+\n+{\n+  const expectedErr = common.expectsError({\n+    code: 'ERR_WORKER_PATH',\n+    type: TypeError\n+  }, 4);\n+  const existingRelPathNoDot = path.relative('.', __filename);\n+  assert.throws(() => { new Worker(existingRelPathNoDot); }, expectedErr);\n+  assert.throws(() => { new Worker('relative_no_dot'); }, expectedErr);\n+  assert.throws(() => { new Worker('file:///file_url'); }, expectedErr);\n+  assert.throws(() => { new Worker('https://www.url.com'); }, expectedErr);\n+}"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 64,
        "deletions": 20
    }
}