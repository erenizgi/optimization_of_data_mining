{
    "author": "BridgeAR",
    "message": "util: improve format performance\n\nThis simplifies the `format()` code and significantly improves the\nperformance.\n\nPR-URL: https://github.com/nodejs/node/pull/24981\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Roman Reiss <me@silverwind.io>",
    "sha": "9752fce34d50400f8f4b5cbafbce2161b6e07a45",
    "files": [
        {
            "sha": "ef28427cd87bc8741ea89cc44a7d7dd46486cc97",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 40,
            "deletions": 45,
            "changes": 85,
            "blob_url": "https://github.com/nodejs/node/blob/9752fce34d50400f8f4b5cbafbce2161b6e07a45/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/9752fce34d50400f8f4b5cbafbce2161b6e07a45/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=9752fce34d50400f8f4b5cbafbce2161b6e07a45",
            "patch": "@@ -78,45 +78,32 @@ function format(...args) {\n   return formatWithOptions(emptyOptions, ...args);\n }\n \n-function formatValue(val, inspectOptions) {\n-  const inspectTypes = ['object', 'symbol', 'function', 'number'];\n-\n-  if (inspectTypes.includes(typeof val)) {\n-    return inspect(val, inspectOptions);\n-  } else {\n-    return String(val);\n-  }\n-}\n-\n function formatWithOptions(inspectOptions, ...args) {\n   const first = args[0];\n-  const parts = [];\n+  let a = 0;\n+  let str = '';\n+  let join = '';\n \n-  const firstIsString = typeof first === 'string';\n-\n-  if (firstIsString && args.length === 1) {\n-    return first;\n-  }\n-\n-  if (firstIsString && /%[sjdOoif%]/.test(first)) {\n-    let i, tempStr;\n-    let str = '';\n-    let a = 1;\n+  if (typeof first === 'string') {\n+    if (args.length === 1) {\n+      return first;\n+    }\n+    let tempStr;\n     let lastPos = 0;\n \n-    for (i = 0; i < first.length - 1; i++) {\n+    for (var i = 0; i < first.length - 1; i++) {\n       if (first.charCodeAt(i) === 37) { // '%'\n         const nextChar = first.charCodeAt(++i);\n-        if (a !== args.length) {\n+        if (a + 1 !== args.length) {\n           switch (nextChar) {\n             case 115: // 's'\n-              tempStr = String(args[a++]);\n+              tempStr = String(args[++a]);\n               break;\n             case 106: // 'j'\n-              tempStr = tryStringify(args[a++]);\n+              tempStr = tryStringify(args[++a]);\n               break;\n             case 100: // 'd'\n-              const tempNum = args[a++];\n+              const tempNum = args[++a];\n               // eslint-disable-next-line valid-typeof\n               if (typeof tempNum === 'bigint') {\n                 tempStr = `${tempNum}n`;\n@@ -127,20 +114,20 @@ function formatWithOptions(inspectOptions, ...args) {\n               }\n               break;\n             case 79: // 'O'\n-              tempStr = inspect(args[a++], inspectOptions);\n+              tempStr = inspect(args[++a], inspectOptions);\n               break;\n             case 111: // 'o'\n             {\n-              const opts = Object.assign({}, inspectOptions, {\n+              tempStr = inspect(args[++a], {\n+                ...inspectOptions,\n                 showHidden: true,\n                 showProxy: true,\n                 depth: 4\n               });\n-              tempStr = inspect(args[a++], opts);\n               break;\n             }\n             case 105: // 'i'\n-              const tempInteger = args[a++];\n+              const tempInteger = args[++a];\n               // eslint-disable-next-line valid-typeof\n               if (typeof tempInteger === 'bigint') {\n                 tempStr = `${tempInteger}n`;\n@@ -151,7 +138,7 @@ function formatWithOptions(inspectOptions, ...args) {\n               }\n               break;\n             case 102: // 'f'\n-              const tempFloat = args[a++];\n+              const tempFloat = args[++a];\n               if (typeof tempFloat === 'symbol') {\n                 tempStr = 'NaN';\n               } else {\n@@ -176,24 +163,32 @@ function formatWithOptions(inspectOptions, ...args) {\n         }\n       }\n     }\n-    if (lastPos === 0) {\n-      str = first;\n-    } else if (lastPos < first.length) {\n-      str += first.slice(lastPos);\n-    }\n-\n-    parts.push(str);\n-    while (a < args.length) {\n-      parts.push(formatValue(args[a], inspectOptions));\n+    if (lastPos !== 0) {\n       a++;\n-    }\n-  } else {\n-    for (const arg of args) {\n-      parts.push(formatValue(arg, inspectOptions));\n+      join = ' ';\n+      if (lastPos < first.length) {\n+        str += first.slice(lastPos);\n+      }\n     }\n   }\n \n-  return parts.join(' ');\n+  while (a < args.length) {\n+    const value = args[a];\n+    // TODO(BridgeAR): This should apply for all besides strings. Especially\n+    // BigInt should be properly inspected.\n+    str += join;\n+    if (typeof value !== 'string' &&\n+        typeof value !== 'boolean' &&\n+        // eslint-disable-next-line valid-typeof\n+        typeof value !== 'bigint') {\n+      str += inspect(value, inspectOptions);\n+    } else {\n+      str += value;\n+    }\n+    join = ' ';\n+    a++;\n+  }\n+  return str;\n }\n \n const debugs = {};"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 40,
        "deletions": 45
    }
}