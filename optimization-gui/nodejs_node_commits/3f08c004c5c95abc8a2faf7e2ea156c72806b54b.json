{
    "author": "dyatlov",
    "message": "src: revert removal of SecureContext `_external` getter\n\nThis `_external` getter is essential for some libs to work:\nuWebSockets as an example.\n\nPR-URL: https://github.com/nodejs/node/pull/21711\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "3f08c004c5c95abc8a2faf7e2ea156c72806b54b",
    "files": [
        {
            "sha": "dd7e0c846814380c2eb79ba6363bb3dc029219c6",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=3f08c004c5c95abc8a2faf7e2ea156c72806b54b",
            "patch": "@@ -359,6 +359,19 @@ void SecureContext::Initialize(Environment* env, Local<Object> target) {\n   t->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"kTicketKeyIVIndex\"),\n          Integer::NewFromUnsigned(env->isolate(), kTicketKeyIVIndex));\n \n+  Local<FunctionTemplate> ctx_getter_templ =\n+      FunctionTemplate::New(env->isolate(),\n+                            CtxGetter,\n+                            env->as_external(),\n+                            Signature::New(env->isolate(), t));\n+\n+\n+  t->PrototypeTemplate()->SetAccessorProperty(\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"_external\"),\n+      ctx_getter_templ,\n+      Local<FunctionTemplate>(),\n+      static_cast<PropertyAttribute>(ReadOnly | DontDelete));\n+\n   target->Set(secureContextString,\n               t->GetFunction(env->context()).ToLocalChecked());\n   env->set_secure_context_constructor_template(t);\n@@ -1331,6 +1344,14 @@ int SecureContext::TicketCompatibilityCallback(SSL* ssl,\n }\n \n \n+void SecureContext::CtxGetter(const FunctionCallbackInfo<Value>& info) {\n+  SecureContext* sc;\n+  ASSIGN_OR_RETURN_UNWRAP(&sc, info.This());\n+  Local<External> ext = External::New(info.GetIsolate(), sc->ctx_.get());\n+  info.GetReturnValue().Set(ext);\n+}\n+\n+\n template <bool primary>\n void SecureContext::GetCertificate(const FunctionCallbackInfo<Value>& args) {\n   SecureContext* wrap;"
        },
        {
            "sha": "2ca333f3c22d122bf3c55844fc6791766706501a",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=3f08c004c5c95abc8a2faf7e2ea156c72806b54b",
            "patch": "@@ -165,6 +165,7 @@ class SecureContext : public BaseObject {\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void EnableTicketKeyCallback(\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n+  static void CtxGetter(const v8::FunctionCallbackInfo<v8::Value>& info);\n \n   template <bool primary>\n   static void GetCertificate(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "95b960b202cd53cf75713aba5f0110b333181a9e",
            "filename": "test/parallel/test-accessor-properties.js",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/test%2Fparallel%2Ftest-accessor-properties.js",
            "raw_url": "https://github.com/nodejs/node/raw/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/test%2Fparallel%2Ftest-accessor-properties.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-accessor-properties.js?ref=3f08c004c5c95abc8a2faf7e2ea156c72806b54b",
            "patch": "@@ -1,7 +1,7 @@\n // Flags: --expose-internals\n 'use strict';\n \n-require('../common');\n+const common = require('../common');\n \n // This tests that the accessor properties do not raise assertions\n // when called with incompatible receivers.\n@@ -54,4 +54,19 @@ const UDP = internalBinding('udp_wrap').UDP;\n     typeof Object.getOwnPropertyDescriptor(StreamWrapProto, 'fd'),\n     'object'\n   );\n+\n+  if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n+    // There are accessor properties in crypto too\n+    const crypto = process.binding('crypto');\n+\n+    assert.throws(() => {\n+      crypto.SecureContext.prototype._external;\n+    }, TypeError);\n+\n+    assert.strictEqual(\n+      typeof Object.getOwnPropertyDescriptor(\n+        crypto.SecureContext.prototype, '_external'),\n+      'object'\n+    );\n+  }\n }"
        },
        {
            "sha": "33d371923a600c670424d95b2507e177d6d69073",
            "filename": "test/parallel/test-tls-external-accessor.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/test%2Fparallel%2Ftest-tls-external-accessor.js",
            "raw_url": "https://github.com/nodejs/node/raw/3f08c004c5c95abc8a2faf7e2ea156c72806b54b/test%2Fparallel%2Ftest-tls-external-accessor.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-external-accessor.js?ref=3f08c004c5c95abc8a2faf7e2ea156c72806b54b",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const tls = require('tls');\n+\n+// Ensure accessing ._external doesn't hit an assert in the accessor method.\n+{\n+  const pctx = tls.createSecureContext().context;\n+  const cctx = Object.create(pctx);\n+  assert.throws(() => cctx._external, TypeError);\n+  pctx._external;\n+}\n+{\n+  const pctx = tls.createSecurePair().credentials.context;\n+  const cctx = Object.create(pctx);\n+  assert.throws(() => cctx._external, TypeError);\n+  pctx._external;\n+}"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 60,
        "deletions": 1
    }
}