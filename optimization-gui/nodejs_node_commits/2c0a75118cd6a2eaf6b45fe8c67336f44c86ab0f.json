{
    "author": "BridgeAR",
    "message": "util: fix iterable types with special prototype\n\nThe fallback should only be taken for a null prototype. If an\niterable data type (e.g., Array) has a prototype without\n`Symbol.iterator`, just try the best to visualize it as object.\n\nPR-URL: https://github.com/nodejs/node/pull/25457\nFixes: https://github.com/nodejs/node/issues/25451\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anto Aravinth <anto.aravinth.cse@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f",
    "files": [
        {
            "sha": "0f81ab5d0296e9ece14e700976fcfe461b46e3d5",
            "filename": "lib/internal/util/inspect.js",
            "status": "modified",
            "additions": 12,
            "deletions": 16,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f/lib%2Finternal%2Futil%2Finspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f/lib%2Finternal%2Futil%2Finspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil%2Finspect.js?ref=2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f",
            "patch": "@@ -463,28 +463,22 @@ function clazzWithNullPrototype(clazz, name) {\n function noPrototypeIterator(ctx, value, recurseTimes) {\n   let newVal;\n   if (isSet(value)) {\n-    const clazz = Object.getPrototypeOf(value) ||\n-      clazzWithNullPrototype(Set, 'Set');\n+    const clazz = clazzWithNullPrototype(Set, 'Set');\n     newVal = new clazz(setValues(value));\n   } else if (isMap(value)) {\n-    const clazz = Object.getPrototypeOf(value) ||\n-      clazzWithNullPrototype(Map, 'Map');\n+    const clazz = clazzWithNullPrototype(Map, 'Map');\n     newVal = new clazz(mapEntries(value));\n   } else if (Array.isArray(value)) {\n-    const clazz = Object.getPrototypeOf(value) ||\n-      clazzWithNullPrototype(Array, 'Array');\n+    const clazz = clazzWithNullPrototype(Array, 'Array');\n     newVal = new clazz(value.length);\n   } else if (isTypedArray(value)) {\n-    let clazz = Object.getPrototypeOf(value);\n-    if (!clazz) {\n-      const constructor = findTypedConstructor(value);\n-      clazz = clazzWithNullPrototype(constructor, constructor.name);\n-    }\n+    const constructor = findTypedConstructor(value);\n+    const clazz = clazzWithNullPrototype(constructor, constructor.name);\n     newVal = new clazz(value);\n   }\n-  if (newVal) {\n+  if (newVal !== undefined) {\n     Object.defineProperties(newVal, Object.getOwnPropertyDescriptors(value));\n-    return formatValue(ctx, newVal, recurseTimes);\n+    return formatRaw(ctx, newVal, recurseTimes);\n   }\n }\n \n@@ -728,9 +722,11 @@ function formatRaw(ctx, value, recurseTimes, typedArray) {\n     } else {\n       // The input prototype got manipulated. Special handle these. We have to\n       // rebuild the information so we are able to display everything.\n-      const specialIterator = noPrototypeIterator(ctx, value, recurseTimes);\n-      if (specialIterator) {\n-        return specialIterator;\n+      if (constructor === null) {\n+        const specialIterator = noPrototypeIterator(ctx, value, recurseTimes);\n+        if (specialIterator) {\n+          return specialIterator;\n+        }\n       }\n       if (isMapIterator(value)) {\n         braces = [`[${tag || 'Map Iterator'}] {`, '}'];"
        },
        {
            "sha": "76f8caa31a88b832be148a607d4a85df0171ec4f",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=2c0a75118cd6a2eaf6b45fe8c67336f44c86ab0f",
            "patch": "@@ -1853,6 +1853,16 @@ assert.strictEqual(\n     util.inspect(new StorageObject()),\n     '<[Object: null prototype] {}> {}'\n   );\n+\n+  obj = [1, 2, 3];\n+  Object.setPrototypeOf(obj, Number.prototype);\n+  assert.strictEqual(inspect(obj), \"Number { '0': 1, '1': 2, '2': 3 }\");\n+\n+  Object.setPrototypeOf(obj, Object.create(null));\n+  assert.strictEqual(\n+    inspect(obj),\n+    \"<[Object: null prototype] {}> { '0': 1, '1': 2, '2': 3 }\"\n+  );\n }\n \n // Check that the fallback always works."
        }
    ],
    "stats": {
        "total": 38,
        "additions": 22,
        "deletions": 16
    }
}