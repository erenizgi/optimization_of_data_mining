{
    "author": "hashseed",
    "message": "deps: cherry-pick 073073b from upstream V8\n\nOriginal commit message:\n\n    [profiler] introduce API to enable detailed source positions\n\n    This allows Node.js to enable detailed source positions for optimized code\n    early on, without having to pass a flag string.\n\n    R=petermarshall@chromium.org\n\n    Change-Id: Ie74ea41f600cf6e31acbe802116df4976ccf1c75\n    Reviewed-on: https://chromium-review.googlesource.com/c/1319757\n    Commit-Queue: Yang Guo <yangguo@chromium.org>\n    Reviewed-by: Peter Marshall <petermarshall@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#57380}\n\nRefs: https://github.com/v8/v8/commit/073073b4f12b683fc0406cd15b3cb284633fe18e\n\nPR-URL: https://github.com/nodejs/node/pull/24515\nRefs: https://github.com/nodejs/node/pull/24274\nRefs: https://github.com/nodejs/node/pull/24394\nRefs: https://github.com/nodejs/node/issues/24393\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Peter Marshall <petermarshall@chromium.org>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "d08800799f487c2ab02cf567dca2e4ecfb589b63",
    "files": [
        {
            "sha": "33b1234035a08039aff396d71ef1800ad337f140",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -38,7 +38,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.3',\n+    'v8_embedder_string': '-node.4',\n \n     ##### V8 defaults for Node.js #####\n "
        },
        {
            "sha": "f30688582df8edfd83f0e2a4d403bf8c2b7ba900",
            "filename": "deps/v8/include/v8-profiler.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-profiler.h?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -341,6 +341,12 @@ class V8_EXPORT CpuProfiler {\n   V8_DEPRECATED(\"Use Isolate::SetIdle(bool) instead.\",\n                 void SetIdle(bool is_idle));\n \n+  /**\n+   * Generate more detailed source positions to code objects. This results in\n+   * better results when mapping profiling samples to script source.\n+   */\n+  static void UseDetailedSourcePositionsForProfiling(Isolate* isolate);\n+\n  private:\n   CpuProfiler();\n   ~CpuProfiler();"
        },
        {
            "sha": "161538638b1befe178c9647040ad974d674c2a45",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -10112,6 +10112,11 @@ void CpuProfiler::SetIdle(bool is_idle) {\n   isolate->SetIdle(is_idle);\n }\n \n+void CpuProfiler::UseDetailedSourcePositionsForProfiling(Isolate* isolate) {\n+  reinterpret_cast<i::Isolate*>(isolate)\n+      ->set_detailed_source_positions_for_profiling(true);\n+}\n+\n uintptr_t CodeEvent::GetCodeStartAddress() {\n   return reinterpret_cast<i::CodeEvent*>(this)->code_start_address;\n }"
        },
        {
            "sha": "e6a9e95a2f48b0cca0f484e4815f4dd63e754fac",
            "filename": "deps/v8/src/isolate.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.cc?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -3461,7 +3461,8 @@ bool Isolate::use_optimizer() {\n }\n \n bool Isolate::NeedsDetailedOptimizedCodeLineInfo() const {\n-  return NeedsSourcePositionsForProfiling() || FLAG_detailed_line_info;\n+  return NeedsSourcePositionsForProfiling() ||\n+         detailed_source_positions_for_profiling();\n }\n \n bool Isolate::NeedsSourcePositionsForProfiling() const {"
        },
        {
            "sha": "c25f143cf8ebc6c3137adc6da7eb9b2334cb7930",
            "filename": "deps/v8/src/isolate.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fisolate.h",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Fsrc%2Fisolate.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.h?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -540,7 +540,8 @@ typedef std::vector<HeapObject*> DebugObjectCache;\n   V(int, last_console_context_id, 0)                                          \\\n   V(v8_inspector::V8Inspector*, inspector, nullptr)                           \\\n   V(bool, next_v8_call_is_safe_for_termination, false)                        \\\n-  V(bool, only_terminate_in_safe_scope, false)\n+  V(bool, only_terminate_in_safe_scope, false)                                \\\n+  V(bool, detailed_source_positions_for_profiling, FLAG_detailed_line_info)\n \n #define THREAD_LOCAL_TOP_ACCESSOR(type, name)                        \\\n   inline void set_##name(type v) { thread_local_top_.name##_ = v; }  \\"
        },
        {
            "sha": "e08bec375e4a7448fb700887677a3de64e6ec0b2",
            "filename": "deps/v8/test/cctest/test-cpu-profiler.cc",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d08800799f487c2ab02cf567dca2e4ecfb589b63/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc?ref=d08800799f487c2ab02cf567dca2e4ecfb589b63",
            "patch": "@@ -40,6 +40,7 @@\n #include \"src/objects-inl.h\"\n #include \"src/profiler/cpu-profiler-inl.h\"\n #include \"src/profiler/profiler-listener.h\"\n+#include \"src/source-position-table.h\"\n #include \"src/utils.h\"\n #include \"test/cctest/cctest.h\"\n #include \"test/cctest/profiler-extension.h\"\n@@ -2544,6 +2545,61 @@ TEST(MultipleProfilers) {\n   profiler2->StopProfiling(\"2\");\n }\n \n+int GetSourcePositionEntryCount(i::Isolate* isolate, const char* source) {\n+  i::Handle<i::JSFunction> function = i::Handle<i::JSFunction>::cast(\n+      v8::Utils::OpenHandle(*CompileRun(source)));\n+  if (function->IsInterpreted()) return -1;\n+  i::Handle<i::Code> code(function->code(), isolate);\n+  i::SourcePositionTableIterator iterator(\n+      ByteArray::cast(code->source_position_table()));\n+  int count = 0;\n+  while (!iterator.done()) {\n+    count++;\n+    iterator.Advance();\n+  }\n+  return count;\n+}\n+\n+UNINITIALIZED_TEST(DetailedSourcePositionAPI) {\n+  i::FLAG_detailed_line_info = false;\n+  i::FLAG_allow_natives_syntax = true;\n+  v8::Isolate::CreateParams create_params;\n+  create_params.array_buffer_allocator = CcTest::array_buffer_allocator();\n+  v8::Isolate* isolate = v8::Isolate::New(create_params);\n+\n+  const char* source =\n+      \"function fib(i) {\"\n+      \"  if (i <= 1) return 1; \"\n+      \"  return fib(i - 1) +\"\n+      \"         fib(i - 2);\"\n+      \"}\"\n+      \"fib(5);\"\n+      \"%OptimizeFunctionOnNextCall(fib);\"\n+      \"fib(5);\"\n+      \"fib\";\n+  {\n+    v8::Isolate::Scope isolate_scope(isolate);\n+    v8::HandleScope handle_scope(isolate);\n+    v8::Local<v8::Context> context = v8::Context::New(isolate);\n+    v8::Context::Scope context_scope(context);\n+    i::Isolate* i_isolate = reinterpret_cast<i::Isolate*>(isolate);\n+\n+    CHECK(!i_isolate->NeedsDetailedOptimizedCodeLineInfo());\n+\n+    int non_detailed_positions = GetSourcePositionEntryCount(i_isolate, source);\n+\n+    v8::CpuProfiler::UseDetailedSourcePositionsForProfiling(isolate);\n+    CHECK(i_isolate->NeedsDetailedOptimizedCodeLineInfo());\n+\n+    int detailed_positions = GetSourcePositionEntryCount(i_isolate, source);\n+\n+    CHECK((non_detailed_positions == -1 && detailed_positions == -1) ||\n+          non_detailed_positions < detailed_positions);\n+  }\n+\n+  isolate->Dispose();\n+}\n+\n }  // namespace test_cpu_profiler\n }  // namespace internal\n }  // namespace v8"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 72,
        "deletions": 3
    }
}