{
    "author": "cjihrig",
    "message": "fs: expose copy-on-write flags for fs.copyFile()\n\nThis commit exposes the UV_FS_COPYFILE_FICLONE and\nUV_FS_COPYFILE_FICLONE_FORCE flags added in libuv 1.20.0.\n\nFixes: https://github.com/nodejs/node/issues/19152\nPR-URL: https://github.com/nodejs/node/pull/19759\nFixes: https://github.com/nodejs/node/issues/19152\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Santiago Gimeno <santiago.gimeno@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a16d88d9e9a6581e463082549823189aba25ca76",
    "files": [
        {
            "sha": "c9adb5b16af0015a9a53254f93ee0cb04966e147",
            "filename": "doc/api/fs.md",
            "status": "modified",
            "additions": 64,
            "deletions": 6,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/a16d88d9e9a6581e463082549823189aba25ca76/doc%2Fapi%2Ffs.md",
            "raw_url": "https://github.com/nodejs/node/raw/a16d88d9e9a6581e463082549823189aba25ca76/doc%2Fapi%2Ffs.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ffs.md?ref=a16d88d9e9a6581e463082549823189aba25ca76",
            "patch": "@@ -1175,8 +1175,18 @@ operation. If an error occurs after the destination file has been opened for\n writing, Node.js will attempt to remove the destination.\n \n `flags` is an optional integer that specifies the behavior\n-of the copy operation. The only supported flag is `fs.constants.COPYFILE_EXCL`,\n-which causes the copy operation to fail if `dest` already exists.\n+of the copy operation. It is possible to create a mask consisting of the bitwise\n+OR of two or more values (e.g.\n+`fs.constants.COPYFILE_EXCL | fs.constants.COPYFILE_FICLONE`).\n+\n+* `fs.constants.COPYFILE_EXCL` - The copy operation will fail if `dest` already\n+exists.\n+* `fs.constants.COPYFILE_FICLONE` - The copy operation will attempt to create a\n+copy-on-write reflink. If the platform does not support copy-on-write, then a\n+fallback copy mechanism is used.\n+* `fs.constants.COPYFILE_FICLONE_FORCE` - The copy operation will attempt to\n+create a copy-on-write reflink. If the platform does not support copy-on-write,\n+then the operation will fail.\n \n Example:\n \n@@ -1216,8 +1226,18 @@ atomicity of the copy operation. If an error occurs after the destination file\n has been opened for writing, Node.js will attempt to remove the destination.\n \n `flags` is an optional integer that specifies the behavior\n-of the copy operation. The only supported flag is `fs.constants.COPYFILE_EXCL`,\n-which causes the copy operation to fail if `dest` already exists.\n+of the copy operation. It is possible to create a mask consisting of the bitwise\n+OR of two or more values (e.g.\n+`fs.constants.COPYFILE_EXCL | fs.constants.COPYFILE_FICLONE`).\n+\n+* `fs.constants.COPYFILE_EXCL` - The copy operation will fail if `dest` already\n+exists.\n+* `fs.constants.COPYFILE_FICLONE` - The copy operation will attempt to create a\n+copy-on-write reflink. If the platform does not support copy-on-write, then a\n+fallback copy mechanism is used.\n+* `fs.constants.COPYFILE_FICLONE_FORCE` - The copy operation will attempt to\n+create a copy-on-write reflink. If the platform does not support copy-on-write,\n+then the operation will fail.\n \n Example:\n \n@@ -3814,8 +3834,18 @@ error occurs after the destination file has been opened for writing, Node.js\n will attempt to remove the destination.\n \n `flags` is an optional integer that specifies the behavior\n-of the copy operation. The only supported flag is `fs.constants.COPYFILE_EXCL`,\n-which causes the copy operation to fail if `dest` already exists.\n+of the copy operation. It is possible to create a mask consisting of the bitwise\n+OR of two or more values (e.g.\n+`fs.constants.COPYFILE_EXCL | fs.constants.COPYFILE_FICLONE`).\n+\n+* `fs.constants.COPYFILE_EXCL` - The copy operation will fail if `dest` already\n+exists.\n+* `fs.constants.COPYFILE_FICLONE` - The copy operation will attempt to create a\n+copy-on-write reflink. If the platform does not support copy-on-write, then a\n+fallback copy mechanism is used.\n+* `fs.constants.COPYFILE_FICLONE_FORCE` - The copy operation will attempt to\n+create a copy-on-write reflink. If the platform does not support copy-on-write,\n+then the operation will fail.\n \n Example:\n \n@@ -4449,6 +4479,34 @@ The following constants are meant for use with [`fs.access()`][].\n   </tr>\n </table>\n \n+### File Copy Constants\n+\n+The following constants are meant for use with [`fs.copyFile()`][].\n+\n+<table>\n+  <tr>\n+    <th>Constant</th>\n+    <th>Description</th>\n+  </tr>\n+  <tr>\n+    <td><code>COPYFILE_EXCL</code></td>\n+    <td>If present, the copy operation will fail with an error if the\n+    destination path already exists.</td>\n+  </tr>\n+  <tr>\n+    <td><code>COPYFILE_FICLONE</code></td>\n+    <td>If present, the copy operation will attempt to create a\n+    copy-on-write reflink. If the underlying platform does not support\n+    copy-on-write, then a fallback copy mechanism is used.</td>\n+  </tr>\n+  <tr>\n+    <td><code>COPYFILE_FICLONE_FORCE</code></td>\n+    <td>If present, the copy operation will attempt to create a\n+    copy-on-write reflink. If the underlying platform does not support\n+    copy-on-write, then the operation will fail with an error.</td>\n+  </tr>\n+</table>\n+\n ### File Open Constants\n \n The following constants are meant for use with `fs.open()`."
        },
        {
            "sha": "780940b4f43b1bb34822681e9840cd3a283a793f",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/a16d88d9e9a6581e463082549823189aba25ca76/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/a16d88d9e9a6581e463082549823189aba25ca76/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=a16d88d9e9a6581e463082549823189aba25ca76",
            "patch": "@@ -1916,7 +1916,15 @@ fs.mkdtempSync = function(prefix, options) {\n \n // Define copyFile() flags.\n Object.defineProperties(fs.constants, {\n-  COPYFILE_EXCL: { enumerable: true, value: constants.UV_FS_COPYFILE_EXCL }\n+  COPYFILE_EXCL: { enumerable: true, value: constants.UV_FS_COPYFILE_EXCL },\n+  COPYFILE_FICLONE: {\n+    enumerable: true,\n+    value: constants.UV_FS_COPYFILE_FICLONE\n+  },\n+  COPYFILE_FICLONE_FORCE: {\n+    enumerable: true,\n+    value: constants.UV_FS_COPYFILE_FICLONE_FORCE\n+  }\n });\n \n "
        },
        {
            "sha": "8f119a27ba8218c8f9f627cdb2e36f8685f5f372",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/a16d88d9e9a6581e463082549823189aba25ca76/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a16d88d9e9a6581e463082549823189aba25ca76/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=a16d88d9e9a6581e463082549823189aba25ca76",
            "patch": "@@ -1314,6 +1314,8 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   // Define libuv constants.\n   NODE_DEFINE_CONSTANT(os_constants, UV_UDP_REUSEADDR);\n   NODE_DEFINE_CONSTANT(fs_constants, UV_FS_COPYFILE_EXCL);\n+  NODE_DEFINE_CONSTANT(fs_constants, UV_FS_COPYFILE_FICLONE);\n+  NODE_DEFINE_CONSTANT(fs_constants, UV_FS_COPYFILE_FICLONE_FORCE);\n \n   os_constants->Set(OneByteString(isolate, \"dlopen\"), dlopen_constants);\n   os_constants->Set(OneByteString(isolate, \"errno\"), err_constants);"
        },
        {
            "sha": "6e5d6c9403e79550536df57a7fec0a7f218c1ad3",
            "filename": "test/parallel/test-fs-copyfile.js",
            "status": "modified",
            "additions": 32,
            "deletions": 2,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/a16d88d9e9a6581e463082549823189aba25ca76/test%2Fparallel%2Ftest-fs-copyfile.js",
            "raw_url": "https://github.com/nodejs/node/raw/a16d88d9e9a6581e463082549823189aba25ca76/test%2Fparallel%2Ftest-fs-copyfile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-copyfile.js?ref=a16d88d9e9a6581e463082549823189aba25ca76",
            "patch": "@@ -8,7 +8,14 @@ const uv = process.binding('uv');\n const path = require('path');\n const src = fixtures.path('a.js');\n const dest = path.join(tmpdir.path, 'copyfile.out');\n-const { COPYFILE_EXCL, UV_FS_COPYFILE_EXCL } = fs.constants;\n+const {\n+  COPYFILE_EXCL,\n+  COPYFILE_FICLONE,\n+  COPYFILE_FICLONE_FORCE,\n+  UV_FS_COPYFILE_EXCL,\n+  UV_FS_COPYFILE_FICLONE,\n+  UV_FS_COPYFILE_FICLONE_FORCE\n+} = fs.constants;\n \n function verify(src, dest) {\n   const srcData = fs.readFileSync(src, 'utf8');\n@@ -25,8 +32,14 @@ tmpdir.refresh();\n \n // Verify that flags are defined.\n assert.strictEqual(typeof COPYFILE_EXCL, 'number');\n+assert.strictEqual(typeof COPYFILE_FICLONE, 'number');\n+assert.strictEqual(typeof COPYFILE_FICLONE_FORCE, 'number');\n assert.strictEqual(typeof UV_FS_COPYFILE_EXCL, 'number');\n+assert.strictEqual(typeof UV_FS_COPYFILE_FICLONE, 'number');\n+assert.strictEqual(typeof UV_FS_COPYFILE_FICLONE_FORCE, 'number');\n assert.strictEqual(COPYFILE_EXCL, UV_FS_COPYFILE_EXCL);\n+assert.strictEqual(COPYFILE_FICLONE, UV_FS_COPYFILE_FICLONE);\n+assert.strictEqual(COPYFILE_FICLONE_FORCE, UV_FS_COPYFILE_FICLONE_FORCE);\n \n // Verify that files are overwritten when no flags are provided.\n fs.writeFileSync(dest, '', 'utf8');\n@@ -38,9 +51,26 @@ verify(src, dest);\n fs.copyFileSync(src, dest, 0);\n verify(src, dest);\n \n+// Verify that UV_FS_COPYFILE_FICLONE can be used.\n+fs.unlinkSync(dest);\n+fs.copyFileSync(src, dest, UV_FS_COPYFILE_FICLONE);\n+verify(src, dest);\n+\n+// Verify that COPYFILE_FICLONE_FORCE can be used.\n+try {\n+  fs.unlinkSync(dest);\n+  fs.copyFileSync(src, dest, COPYFILE_FICLONE_FORCE);\n+  verify(src, dest);\n+} catch (err) {\n+  assert.strictEqual(err.syscall, 'copyfile');\n+  assert(err.code === 'ENOTSUP' || err.code === 'ENOTTY' ||\n+    err.code === 'ENOSYS');\n+  assert.strictEqual(err.path, src);\n+  assert.strictEqual(err.dest, dest);\n+}\n \n // Copies asynchronously.\n-fs.unlinkSync(dest);\n+tmpdir.refresh(); // Don't use unlinkSync() since the last test may fail.\n fs.copyFile(src, dest, common.mustCall((err) => {\n   assert.ifError(err);\n   verify(src, dest);"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 107,
        "deletions": 9
    }
}