{
    "author": "joyeecheung",
    "message": "errors: move error creation helpers to errors.js\n\nThis commit moves error creation helpers scattered around\nunder lib/ into lib/internal/errors.js in the hope of being clearer\nabout the differences of errors that we throw into the user land.\n\n- Move util._errnoException and util._exceptionWithHostPort\n  into internal/errors.js and simplify their logic so it's\n  clearer what the properties these helpers create.\n- Move the errnoException helper in dns.js to internal/errors.js\n  into internal/errors.js and rename it to dnsException. Simplify\n  it's logic so it no longer calls errnoException and skips\n  the unnecessary argument checks.\n\nPR-URL: https://github.com/nodejs/node/pull/18546\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
    "files": [
        {
            "sha": "bed6129b47be11391aaca6d58155740f0eef28e7",
            "filename": "lib/dgram.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fdgram.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fdgram.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdgram.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -45,8 +45,8 @@ const SEND_BUFFER = false;\n // Lazily loaded\n var cluster = null;\n \n-const errnoException = util._errnoException;\n-const exceptionWithHostPort = util._exceptionWithHostPort;\n+const errnoException = errors.errnoException;\n+const exceptionWithHostPort = errors.exceptionWithHostPort;\n \n \n function lookup4(lookup, address, callback) {"
        },
        {
            "sha": "51c144f4e394eb15886f0acbfcb0afeb8d3c6f08",
            "filename": "lib/dns.js",
            "status": "modified",
            "additions": 8,
            "deletions": 39,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fdns.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fdns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdns.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -21,17 +21,10 @@\n \n 'use strict';\n \n-const util = require('util');\n-\n const cares = process.binding('cares_wrap');\n const { isIP, isIPv4, isLegalPort } = require('internal/net');\n const { customPromisifyArgs } = require('internal/util');\n const errors = require('internal/errors');\n-const {\n-  UV_EAI_MEMORY,\n-  UV_EAI_NODATA,\n-  UV_EAI_NONAME\n-} = process.binding('uv');\n \n const {\n   GetAddrInfoReqWrap,\n@@ -40,36 +33,12 @@ const {\n   ChannelWrap,\n } = cares;\n \n-function errnoException(err, syscall, hostname) {\n-  // FIXME(bnoordhuis) Remove this backwards compatibility nonsense and pass\n-  // the true error to the user. ENOTFOUND is not even a proper POSIX error!\n-  if (err === UV_EAI_MEMORY ||\n-      err === UV_EAI_NODATA ||\n-      err === UV_EAI_NONAME) {\n-    err = 'ENOTFOUND';\n-  }\n-  var ex = null;\n-  if (typeof err === 'string') {  // c-ares error code.\n-    const errHost = hostname ? ` ${hostname}` : '';\n-    ex = new Error(`${syscall} ${err}${errHost}`);\n-    ex.code = err;\n-    ex.errno = err;\n-    ex.syscall = syscall;\n-  } else {\n-    ex = util._errnoException(err, syscall);\n-  }\n-  if (hostname) {\n-    ex.hostname = hostname;\n-  }\n-  return ex;\n-}\n-\n const IANA_DNS_PORT = 53;\n-\n+const dnsException = errors.dnsException;\n \n function onlookup(err, addresses) {\n   if (err) {\n-    return this.callback(errnoException(err, 'getaddrinfo', this.hostname));\n+    return this.callback(dnsException(err, 'getaddrinfo', this.hostname));\n   }\n   if (this.family) {\n     this.callback(null, addresses[0], this.family);\n@@ -81,7 +50,7 @@ function onlookup(err, addresses) {\n \n function onlookupall(err, addresses) {\n   if (err) {\n-    return this.callback(errnoException(err, 'getaddrinfo', this.hostname));\n+    return this.callback(dnsException(err, 'getaddrinfo', this.hostname));\n   }\n \n   var family = this.family;\n@@ -161,7 +130,7 @@ function lookup(hostname, options, callback) {\n \n   var err = cares.getaddrinfo(req, hostname, family, hints, verbatim);\n   if (err) {\n-    process.nextTick(callback, errnoException(err, 'getaddrinfo', hostname));\n+    process.nextTick(callback, dnsException(err, 'getaddrinfo', hostname));\n     return {};\n   }\n   return req;\n@@ -173,7 +142,7 @@ Object.defineProperty(lookup, customPromisifyArgs,\n \n function onlookupservice(err, host, service) {\n   if (err)\n-    return this.callback(errnoException(err, 'getnameinfo', this.host));\n+    return this.callback(dnsException(err, 'getnameinfo', this.host));\n \n   this.callback(null, host, service);\n }\n@@ -202,7 +171,7 @@ function lookupService(host, port, callback) {\n   req.oncomplete = onlookupservice;\n \n   var err = cares.getnameinfo(req, host, port);\n-  if (err) throw errnoException(err, 'getnameinfo', host);\n+  if (err) throw dnsException(err, 'getnameinfo', host);\n   return req;\n }\n \n@@ -215,7 +184,7 @@ function onresolve(err, result, ttls) {\n     result = result.map((address, index) => ({ address, ttl: ttls[index] }));\n \n   if (err)\n-    this.callback(errnoException(err, this.bindingName, this.hostname));\n+    this.callback(dnsException(err, this.bindingName, this.hostname));\n   else\n     this.callback(null, result);\n }\n@@ -253,7 +222,7 @@ function resolver(bindingName) {\n     req.oncomplete = onresolve;\n     req.ttl = !!(options && options.ttl);\n     var err = this._handle[bindingName](req, name);\n-    if (err) throw errnoException(err, bindingName);\n+    if (err) throw dnsException(err, bindingName);\n     return req;\n   }\n   Object.defineProperty(query, 'name', { value: bindingName });"
        },
        {
            "sha": "04d3d0a5bd4357db82be18f02a7ec81b1306eac5",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -62,7 +62,7 @@ const { kMaxLength } = require('buffer');\n const isWindows = process.platform === 'win32';\n \n const DEBUG = process.env.NODE_DEBUG && /fs/.test(process.env.NODE_DEBUG);\n-const errnoException = util._errnoException;\n+const errnoException = errors.errnoException;\n \n let truncateWarn = true;\n "
        },
        {
            "sha": "ac2b75f24575b871e5ca468400c58f6b36d9a400",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -29,7 +29,7 @@ const {\n   UV_ESRCH\n } = process.binding('uv');\n \n-const errnoException = util._errnoException;\n+const errnoException = errors.errnoException;\n const { SocketListSend, SocketListReceive } = SocketList;\n \n const MAX_HANDLE_RETRANSMISSIONS = 3;"
        },
        {
            "sha": "c07920ae5d01ed588a64e5cd5db51293d147c9e2",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 126,
            "deletions": 5,
            "changes": 131,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -18,7 +18,12 @@ var green = '';\n var red = '';\n var white = '';\n \n-const { errmap } = process.binding('uv');\n+const {\n+  errmap,\n+  UV_EAI_MEMORY,\n+  UV_EAI_NODATA,\n+  UV_EAI_NONAME\n+} = process.binding('uv');\n const { kMaxLength } = process.binding('buffer');\n const { defineProperty } = Object;\n \n@@ -33,6 +38,14 @@ function lazyUtil() {\n   return util_;\n }\n \n+var internalUtil = null;\n+function lazyInternalUtil() {\n+  if (!internalUtil) {\n+    internalUtil = require('internal/util');\n+  }\n+  return internalUtil;\n+}\n+\n function makeNodeError(Base) {\n   return class NodeError extends Base {\n     constructor(key, ...args) {\n@@ -356,10 +369,15 @@ function E(sym, val) {\n   messages.set(sym, typeof val === 'function' ? val : String(val));\n }\n \n-// This creates an error compatible with errors produced in UVException\n-// using the context collected in CollectUVExceptionInfo\n-// The goal is to migrate them to ERR_* errors later when\n-// compatibility is not a concern\n+/**\n+ * This creates an error compatible with errors produced in the C++\n+ * function UVException using a context object with data assembled in C++.\n+ * The goal is to migrate them to ERR_* errors later when compatibility is\n+ * not a concern.\n+ *\n+ * @param {Object} ctx\n+ * @returns {Error}\n+ */\n function uvException(ctx) {\n   const err = new Error();\n \n@@ -389,7 +407,110 @@ function uvException(ctx) {\n   return err;\n }\n \n+/**\n+ * This used to be util._errnoException().\n+ *\n+ * @param {number} err - A libuv error number\n+ * @param {string} syscall\n+ * @param {string} [original]\n+ * @returns {Error}\n+ */\n+function errnoException(err, syscall, original) {\n+  // TODO(joyeecheung): We have to use the type-checked\n+  // getSystemErrorName(err) to guard against invalid arguments from users.\n+  // This can be replaced with [ code ] = errmap.get(err) when this method\n+  // is no longer exposed to user land.\n+  const code = lazyUtil().getSystemErrorName(err);\n+  const message = original ?\n+    `${syscall} ${code} ${original}` : `${syscall} ${code}`;\n+\n+  const ex = new Error(message);\n+  // TODO(joyeecheung): errno is supposed to err, like in uvException\n+  ex.code = ex.errno = code;\n+  ex.syscall = syscall;\n+\n+  Error.captureStackTrace(ex, errnoException);\n+  return ex;\n+}\n+\n+/**\n+ * This used to be util._exceptionWithHostPort().\n+ *\n+ * @param {number} err - A libuv error number\n+ * @param {string} syscall\n+ * @param {string} address\n+ * @param {number} [port]\n+ * @param {string} [additional]\n+ * @returns {Error}\n+ */\n+function exceptionWithHostPort(err, syscall, address, port, additional) {\n+  // TODO(joyeecheung): We have to use the type-checked\n+  // getSystemErrorName(err) to guard against invalid arguments from users.\n+  // This can be replaced with [ code ] = errmap.get(err) when this method\n+  // is no longer exposed to user land.\n+  const code = lazyUtil().getSystemErrorName(err);\n+  let details = '';\n+  if (port && port > 0) {\n+    details = ` ${address}:${port}`;\n+  } else if (address) {\n+    details = ` ${address}`;\n+  }\n+  if (additional) {\n+    details += ` - Local (${additional})`;\n+  }\n+\n+  const ex = new Error(`${syscall} ${code}${details}`);\n+  // TODO(joyeecheung): errno is supposed to err, like in uvException\n+  ex.code = ex.errno = code;\n+  ex.syscall = syscall;\n+  ex.address = address;\n+  if (port) {\n+    ex.port = port;\n+  }\n+\n+  Error.captureStackTrace(ex, exceptionWithHostPort);\n+  return ex;\n+}\n+\n+/**\n+ * @param {number|string} err - A libuv error number or a c-ares error code\n+ * @param {string} syscall\n+ * @param {string} [hostname]\n+ * @returns {Error}\n+ */\n+function dnsException(err, syscall, hostname) {\n+  const ex = new Error();\n+  // FIXME(bnoordhuis) Remove this backwards compatibility nonsense and pass\n+  // the true error to the user. ENOTFOUND is not even a proper POSIX error!\n+  if (err === UV_EAI_MEMORY ||\n+      err === UV_EAI_NODATA ||\n+      err === UV_EAI_NONAME) {\n+    err = 'ENOTFOUND';  // Fabricated error name.\n+  }\n+  if (typeof err === 'string') {  // c-ares error code.\n+    const errHost = hostname ? ` ${hostname}` : '';\n+    ex.message = `${syscall} ${err}${errHost}`;\n+    // TODO(joyeecheung): errno is supposed to be a number, like in uvException\n+    ex.code = ex.errno = err;\n+    ex.syscall = syscall;\n+  } else {  // libuv error number\n+    const code = lazyInternalUtil().getSystemErrorName(err);\n+    ex.message = `${syscall} ${code}`;\n+    // TODO(joyeecheung): errno is supposed to be err, like in uvException\n+    ex.code = ex.errno = code;\n+    ex.syscall = syscall;\n+  }\n+  if (hostname) {\n+    ex.hostname = hostname;\n+  }\n+  Error.captureStackTrace(ex, dnsException);\n+  return ex;\n+}\n+\n module.exports = exports = {\n+  dnsException,\n+  errnoException,\n+  exceptionWithHostPort,\n   uvException,\n   message,\n   Error: makeNodeError(Error),"
        },
        {
            "sha": "5f811ca8af403ae7ff4f2386140256cdb85befcd",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -1631,7 +1631,7 @@ class Http2Stream extends Duplex {\n     req.async = false;\n     const err = createWriteReq(req, handle, data, encoding);\n     if (err)\n-      throw util._errnoException(err, 'write', req.error);\n+      throw errors.errnoException(err, 'write', req.error);\n     trackWriteState(this, req.bytes);\n   }\n \n@@ -1674,7 +1674,7 @@ class Http2Stream extends Duplex {\n     }\n     const err = handle.writev(req, chunks);\n     if (err)\n-      throw util._errnoException(err, 'write', req.error);\n+      throw errors.errnoException(err, 'write', req.error);\n     trackWriteState(this, req.bytes);\n   }\n "
        },
        {
            "sha": "776129a140fe68b8e8320ec2d3299a8299f17381",
            "filename": "lib/internal/process.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fprocess.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Finternal%2Fprocess.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -170,7 +170,7 @@ function setupKillAndExit() {\n     }\n \n     if (err)\n-      throw util._errnoException(err, 'kill');\n+      throw errors.errnoException(err, 'kill');\n \n     return true;\n   };\n@@ -200,7 +200,7 @@ function setupSignalHandlers() {\n       const err = wrap.start(signum);\n       if (err) {\n         wrap.close();\n-        throw util._errnoException(err, 'uv_signal_start');\n+        throw errors.errnoException(err, 'uv_signal_start');\n       }\n \n       signalWraps[type] = wrap;"
        },
        {
            "sha": "5d99b00662d49d60d3e1da92382b6dd8a18dc7e3",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -59,8 +59,8 @@ const kLastWriteQueueSize = Symbol('lastWriteQueueSize');\n // reasons it's lazy loaded.\n var cluster = null;\n \n-const errnoException = util._errnoException;\n-const exceptionWithHostPort = util._exceptionWithHostPort;\n+const errnoException = errors.errnoException;\n+const exceptionWithHostPort = errors.exceptionWithHostPort;\n \n const {\n   kTimeout,"
        },
        {
            "sha": "79e61e981b5a071d59f592828e0c29df351a4b5b",
            "filename": "lib/tty.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Ftty.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Ftty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftty.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -21,7 +21,7 @@\n \n 'use strict';\n \n-const { inherits, _errnoException, _extend } = require('util');\n+const { inherits, _extend } = require('util');\n const net = require('net');\n const { TTY, isTTY } = process.binding('tty_wrap');\n const errors = require('internal/errors');\n@@ -178,7 +178,7 @@ WriteStream.prototype._refreshSize = function() {\n   const winSize = new Array(2);\n   const err = this._handle.getWindowSize(winSize);\n   if (err) {\n-    this.emit('error', _errnoException(err, 'getWindowSize'));\n+    this.emit('error', errors.errnoException(err, 'getWindowSize'));\n     return;\n   }\n   const [newCols, newRows] = winSize;"
        },
        {
            "sha": "e13f5b8b80009eb66ad59324977f4da1bc6906bb",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 2,
            "deletions": 36,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=c0762c2f54f80b92f2f5e0f9af51f4c048c53e4f",
            "patch": "@@ -1058,40 +1058,6 @@ function error(...args) {\n   }\n }\n \n-function _errnoException(err, syscall, original) {\n-  const name = getSystemErrorName(err);\n-  var message = `${syscall} ${name}`;\n-  if (original)\n-    message += ` ${original}`;\n-  const e = new Error(message);\n-  e.code = e.errno = name;\n-  e.syscall = syscall;\n-  return e;\n-}\n-\n-function _exceptionWithHostPort(err,\n-                                syscall,\n-                                address,\n-                                port,\n-                                additional) {\n-  var details;\n-  if (port && port > 0) {\n-    details = `${address}:${port}`;\n-  } else {\n-    details = address;\n-  }\n-\n-  if (additional) {\n-    details += ` - Local (${additional})`;\n-  }\n-  var ex = exports._errnoException(err, syscall, details);\n-  ex.address = address;\n-  if (port) {\n-    ex.port = port;\n-  }\n-  return ex;\n-}\n-\n function callbackifyOnRejected(reason, cb) {\n   // `!reason` guard inspired by bluebird (Ref: https://goo.gl/t5IS6M).\n   // Because `null` is a special error value in callbacks which means \"no error\n@@ -1152,8 +1118,8 @@ function getSystemErrorName(err) {\n \n // Keep the `exports =` so that various functions can still be monkeypatched\n module.exports = exports = {\n-  _errnoException,\n-  _exceptionWithHostPort,\n+  _errnoException: errors.errnoException,\n+  _exceptionWithHostPort: errors.exceptionWithHostPort,\n   _extend,\n   callbackify,\n   debuglog,"
        }
    ],
    "stats": {
        "total": 240,
        "additions": 148,
        "deletions": 92
    }
}