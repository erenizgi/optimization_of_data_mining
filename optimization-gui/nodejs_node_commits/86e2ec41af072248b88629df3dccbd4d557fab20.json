{
    "author": "davedoesdev",
    "message": "net: check for close on stream, not parent\n\n'close' event isn't emitted on a TLS connection if it's been written to\n(but 'end' and 'finish' events are).\n\nPR-URL: https://github.com/nodejs/node/pull/25026\nFixes: https://github.com/nodejs/node/issues/24984\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "86e2ec41af072248b88629df3dccbd4d557fab20",
    "files": [
        {
            "sha": "0577dd3c9fe0c7038074a8d564dd050d4687fb7f",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/86e2ec41af072248b88629df3dccbd4d557fab20/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/86e2ec41af072248b88629df3dccbd4d557fab20/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=86e2ec41af072248b88629df3dccbd4d557fab20",
            "patch": "@@ -368,8 +368,8 @@ Socket.prototype._final = function(cb) {\n };\n \n \n-function afterShutdown(status, handle) {\n-  var self = handle[owner_symbol];\n+function afterShutdown(status) {\n+  var self = this.handle[owner_symbol];\n \n   debug('afterShutdown destroyed=%j', self.destroyed,\n         self._readableState);"
        },
        {
            "sha": "31ebc897b14758720d5b88c11eb0ed829a745352",
            "filename": "test/parallel/test-tls-close-event-after-write.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/86e2ec41af072248b88629df3dccbd4d557fab20/test%2Fparallel%2Ftest-tls-close-event-after-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/86e2ec41af072248b88629df3dccbd4d557fab20/test%2Fparallel%2Ftest-tls-close-event-after-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-close-event-after-write.js?ref=86e2ec41af072248b88629df3dccbd4d557fab20",
            "patch": "@@ -0,0 +1,41 @@\n+'use strict';\n+const common = require('../common');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+// Issue #24984\n+// 'close' event isn't emitted on a TLS connection if it's been written to\n+// (but 'end' and 'finish' events are). Without a fix, this test won't exit.\n+\n+const tls = require('tls');\n+const fixtures = require('../common/fixtures');\n+let cconn = null;\n+let sconn = null;\n+\n+function test() {\n+  if (cconn && sconn) {\n+    cconn.resume();\n+    sconn.resume();\n+    sconn.end(Buffer.alloc(1024 * 1024));\n+    cconn.end();\n+  }\n+}\n+\n+const server = tls.createServer({\n+  key: fixtures.readKey('agent1-key.pem'),\n+  cert: fixtures.readKey('agent1-cert.pem')\n+}, function(c) {\n+  c.on('close', function() {\n+    server.close();\n+  });\n+  sconn = c;\n+  test();\n+}).listen(0, common.mustCall(function() {\n+  tls.connect(this.address().port, {\n+    rejectUnauthorized: false\n+  }, common.mustCall(function() {\n+    cconn = this;\n+    test();\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 43,
        "deletions": 2
    }
}