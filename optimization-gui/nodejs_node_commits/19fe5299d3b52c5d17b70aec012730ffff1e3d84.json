{
    "author": "bnoordhuis",
    "message": "crypto: fix UB in computing max message size\n\nBefore this commit it computed `(1<<(8*(15-iv_len)))-1` for `iv_len>=11`\nand that reduces to `(1<<32)-1` for `iv_len==11`.  Left-shifting past\nthe sign bit and overflowing a signed integral type are both undefined\nbehaviors.\n\nThis commit switches to fixed values and restricts the `iv_len==11`\ncase to `INT_MAX`, as was already the case for all `iv_len<=10`.\n\nPR-URL: https://github.com/nodejs/node/pull/21462\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "19fe5299d3b52c5d17b70aec012730ffff1e3d84",
    "files": [
        {
            "sha": "a8ffd7087020aa04dd8c635dfd79f7018c090da2",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/19fe5299d3b52c5d17b70aec012730ffff1e3d84/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/19fe5299d3b52c5d17b70aec012730ffff1e3d84/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=19fe5299d3b52c5d17b70aec012730ffff1e3d84",
            "patch": "@@ -39,7 +39,6 @@\n \n #include <errno.h>\n #include <limits.h>  // INT_MAX\n-#include <math.h>\n #include <string.h>\n \n #include <algorithm>\n@@ -2800,13 +2799,11 @@ bool CipherBase::InitAuthenticated(const char* cipher_type, int iv_len,\n \n     auth_tag_len_ = auth_tag_len;\n \n-    // The message length is restricted to 2 ^ (8 * (15 - iv_len)) - 1 bytes.\n+    // Restrict the message length to min(INT_MAX, 2^(8*(15-iv_len))-1) bytes.\n     CHECK(iv_len >= 7 && iv_len <= 13);\n-    if (iv_len >= static_cast<int>(15.5 - log2(INT_MAX + 1.) / 8)) {\n-      max_message_size_ = (1 << (8 * (15 - iv_len))) - 1;\n-    } else {\n-      max_message_size_ = INT_MAX;\n-    }\n+    max_message_size_ = INT_MAX;\n+    if (iv_len == 12) max_message_size_ = 16777215;\n+    if (iv_len == 13) max_message_size_ = 65535;\n   } else {\n     CHECK_EQ(mode, EVP_CIPH_GCM_MODE);\n "
        },
        {
            "sha": "a4fe105b7edbe70b68a0a7a51177c478a06358f0",
            "filename": "test/parallel/test-crypto-authenticated.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/19fe5299d3b52c5d17b70aec012730ffff1e3d84/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "raw_url": "https://github.com/nodejs/node/raw/19fe5299d3b52c5d17b70aec012730ffff1e3d84/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-authenticated.js?ref=19fe5299d3b52c5d17b70aec012730ffff1e3d84",
            "patch": "@@ -1016,3 +1016,13 @@ for (const test of TEST_CASES) {\n   assert.strictEqual(decrypt.update('807022', 'hex', 'hex'), 'abcdef');\n   assert.strictEqual(decrypt.final('hex'), '');\n }\n+\n+// Test that an IV length of 11 does not overflow max_message_size_.\n+{\n+  const key = 'x'.repeat(16);\n+  const iv = Buffer.from('112233445566778899aabb', 'hex');\n+  const options = { authTagLength: 8 };\n+  const encrypt = crypto.createCipheriv('aes-128-ccm', key, iv, options);\n+  encrypt.update('boom');  // Should not throw 'Message exceeds maximum size'.\n+  encrypt.final();\n+}"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 14,
        "deletions": 7
    }
}