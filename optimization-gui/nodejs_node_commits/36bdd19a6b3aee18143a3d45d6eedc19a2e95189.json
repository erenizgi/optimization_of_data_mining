{
    "author": "danbev",
    "message": "src: add CheckOptions to Options classes\n\nThis commit adds a CheckOptions function that the options classes can\noptionally implement to check that options specified are correct\n(dependencies between options are met or options that are mutually\nexclusive).\n\nIn the process of doing this the error pointer passed to Parse was\nchanged to be of type vector so that potentially multiple options check\nfailures can be reported.\n\nPR-URL: https://github.com/nodejs/node/pull/22943\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "36bdd19a6b3aee18143a3d45d6eedc19a2e95189",
    "files": [
        {
            "sha": "953ac31eef5e6e6e8aa06b5790456eaecb3a1ad2",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 27,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=36bdd19a6b3aee18143a3d45d6eedc19a2e95189",
            "patch": "@@ -2460,7 +2460,7 @@ void ProcessArgv(std::vector<std::string>* args,\n                  bool is_env) {\n   // Parse a few arguments which are specific to Node.\n   std::vector<std::string> v8_args;\n-  std::string error;\n+  std::vector<std::string> errors{};\n \n   {\n     // TODO(addaleax): The mutex here should ideally be held during the\n@@ -2472,11 +2472,13 @@ void ProcessArgv(std::vector<std::string>* args,\n         &v8_args,\n         per_process_opts.get(),\n         is_env ? kAllowedInEnvironment : kDisallowedInEnvironment,\n-        &error);\n+        &errors);\n   }\n \n-  if (!error.empty()) {\n-    fprintf(stderr, \"%s: %s\\n\", args->at(0).c_str(), error.c_str());\n+  if (!errors.empty()) {\n+    for (auto const& error : errors) {\n+      fprintf(stderr, \"%s: %s\\n\", args->at(0).c_str(), error.c_str());\n+    }\n     exit(9);\n   }\n \n@@ -2493,30 +2495,7 @@ void ProcessArgv(std::vector<std::string>* args,\n   for (const std::string& cve : per_process_opts->security_reverts)\n     Revert(cve.c_str());\n \n-  // TODO(addaleax): Move this validation to the option parsers.\n   auto env_opts = per_process_opts->per_isolate->per_env;\n-  if (!env_opts->userland_loader.empty() &&\n-      !env_opts->experimental_modules) {\n-    fprintf(stderr, \"%s: --loader requires --experimental-modules be enabled\\n\",\n-            args->at(0).c_str());\n-    exit(9);\n-  }\n-\n-  if (env_opts->syntax_check_only && env_opts->has_eval_string) {\n-    fprintf(stderr, \"%s: either --check or --eval can be used, not both\\n\",\n-            args->at(0).c_str());\n-    exit(9);\n-  }\n-\n-#if HAVE_OPENSSL\n-  if (per_process_opts->use_openssl_ca && per_process_opts->use_bundled_ca) {\n-    fprintf(stderr, \"%s: either --use-openssl-ca or --use-bundled-ca can be \"\n-                    \"used, not both\\n\",\n-            args->at(0).c_str());\n-    exit(9);\n-  }\n-#endif\n-\n   if (std::find(v8_args.begin(), v8_args.end(),\n                 \"--abort-on-uncaught-exception\") != v8_args.end() ||\n       std::find(v8_args.begin(), v8_args.end(),"
        },
        {
            "sha": "1d1eda54751a8f32a04bc4315a06e11d523e48a4",
            "filename": "src/node_options-inl.h",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options-inl.h?ref=36bdd19a6b3aee18143a3d45d6eedc19a2e95189",
            "patch": "@@ -270,7 +270,7 @@ void OptionsParser<Options>::Parse(\n     std::vector<std::string>* const v8_args,\n     Options* const options,\n     OptionEnvvarSettings required_env_settings,\n-    std::string* const error) {\n+    std::vector<std::string>* const errors) {\n   ArgsInfo args(orig_args, exec_args);\n \n   // The first entry is the process name. Make sure it ends up in the V8 argv,\n@@ -279,7 +279,7 @@ void OptionsParser<Options>::Parse(\n   if (v8_args->empty())\n     v8_args->push_back(args.program_name());\n \n-  while (!args.empty() && error->empty()) {\n+  while (!args.empty() && errors->empty()) {\n     if (args.first().size() <= 1 || args.first()[0] != '-') break;\n \n     // We know that we're either going to consume this\n@@ -288,7 +288,7 @@ void OptionsParser<Options>::Parse(\n \n     if (arg == \"--\") {\n       if (required_env_settings == kAllowedInEnvironment)\n-        *error = NotAllowedInEnvErr(\"--\");\n+        errors->push_back(NotAllowedInEnvErr(\"--\"));\n       break;\n     }\n \n@@ -357,7 +357,7 @@ void OptionsParser<Options>::Parse(\n     if ((it == options_.end() ||\n          it->second.env_setting == kDisallowedInEnvironment) &&\n         required_env_settings == kAllowedInEnvironment) {\n-      *error = NotAllowedInEnvErr(original_name);\n+      errors->push_back(NotAllowedInEnvErr(original_name));\n       break;\n     }\n \n@@ -379,7 +379,7 @@ void OptionsParser<Options>::Parse(\n         value = arg.substr(equals_index + 1);\n         if (value.empty()) {\n         missing_argument:\n-          *error = RequiresArgumentErr(original_name);\n+          errors->push_back(RequiresArgumentErr(original_name));\n           break;\n         }\n       } else {\n@@ -413,7 +413,7 @@ void OptionsParser<Options>::Parse(\n         break;\n       case kHostPort:\n         Lookup<HostPort>(info.field, options)\n-            ->Update(SplitHostPort(value, error));\n+            ->Update(SplitHostPort(value, errors));\n         break;\n       case kNoOp:\n         break;\n@@ -424,6 +424,7 @@ void OptionsParser<Options>::Parse(\n         UNREACHABLE();\n     }\n   }\n+  options->CheckOptions(errors);\n }\n \n }  // namespace options_parser"
        },
        {
            "sha": "156ea11fe91ef08b141b4629e0776add33c1dc7d",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 5,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=36bdd19a6b3aee18143a3d45d6eedc19a2e95189",
            "patch": "@@ -16,6 +16,32 @@ using v8::Undefined;\n using v8::Value;\n \n namespace node {\n+\n+void PerProcessOptions::CheckOptions(std::vector<std::string>* errors) {\n+#if HAVE_OPENSSL\n+  if (use_openssl_ca && use_bundled_ca) {\n+    errors->push_back(\"either --use-openssl-ca or --use-bundled-ca can be \"\n+                      \"used, not both\");\n+  }\n+#endif\n+  per_isolate->CheckOptions(errors);\n+}\n+\n+void PerIsolateOptions::CheckOptions(std::vector<std::string>* errors) {\n+  per_env->CheckOptions(errors);\n+}\n+\n+void EnvironmentOptions::CheckOptions(std::vector<std::string>* errors) {\n+  if (!userland_loader.empty() && !experimental_modules) {\n+    errors->push_back(\"--loader requires --experimental-modules be enabled\");\n+  }\n+\n+  if (syntax_check_only && has_eval_string) {\n+    errors->push_back(\"either --check or --eval can be used, not both\");\n+  }\n+  debug_options->CheckOptions(errors);\n+}\n+\n namespace options_parser {\n \n // XXX: If you add an option here, please also add it to doc/node.1 and\n@@ -305,18 +331,20 @@ inline std::string RemoveBrackets(const std::string& host) {\n     return host;\n }\n \n-inline int ParseAndValidatePort(const std::string& port, std::string* error) {\n+inline int ParseAndValidatePort(const std::string& port,\n+                                std::vector<std::string>* errors) {\n   char* endptr;\n   errno = 0;\n   const long result = strtol(port.c_str(), &endptr, 10);  // NOLINT(runtime/int)\n   if (errno != 0 || *endptr != '\\0'||\n       (result != 0 && result < 1024) || result > 65535) {\n-    *error = \"Port must be 0 or in range 1024 to 65535.\";\n+    errors->push_back(\" must be 0 or in range 1024 to 65535.\");\n   }\n   return static_cast<int>(result);\n }\n \n-HostPort SplitHostPort(const std::string& arg, std::string* error) {\n+HostPort SplitHostPort(const std::string& arg,\n+                      std::vector<std::string>* errors) {\n   // remove_brackets only works if no port is specified\n   // so if it has an effect only an IPv6 address was specified.\n   std::string host = RemoveBrackets(arg);\n@@ -332,11 +360,11 @@ HostPort SplitHostPort(const std::string& arg, std::string* error) {\n         return HostPort { arg, -1 };\n       }\n     }\n-    return HostPort { \"\", ParseAndValidatePort(arg, error) };\n+    return HostPort { \"\", ParseAndValidatePort(arg, errors) };\n   }\n   // Host and port found:\n   return HostPort { RemoveBrackets(arg.substr(0, colon)),\n-                    ParseAndValidatePort(arg.substr(colon + 1), error) };\n+                    ParseAndValidatePort(arg.substr(colon + 1), errors) };\n }\n \n // Usage: Either:"
        },
        {
            "sha": "506db25dec2efab70bc2004e6ebc2079a65b9498",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/36bdd19a6b3aee18143a3d45d6eedc19a2e95189/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=36bdd19a6b3aee18143a3d45d6eedc19a2e95189",
            "patch": "@@ -21,11 +21,16 @@ struct HostPort {\n   }\n };\n \n+class Options {\n+ public:\n+  virtual void CheckOptions(std::vector<std::string>* errors) {}\n+};\n+\n // These options are currently essentially per-Environment, but it can be nice\n // to keep them separate since they are a group of options applying to a very\n // specific part of Node. It might also make more sense for them to be\n // per-Isolate, rather than per-Environment.\n-class DebugOptions {\n+class DebugOptions : public Options {\n  public:\n   bool inspector_enabled = false;\n   bool deprecated_debug = false;\n@@ -57,7 +62,7 @@ class DebugOptions {\n   }\n };\n \n-class EnvironmentOptions {\n+class EnvironmentOptions : public Options {\n  public:\n   std::shared_ptr<DebugOptions> debug_options { new DebugOptions() };\n   bool abort_on_uncaught_exception = false;\n@@ -91,17 +96,19 @@ class EnvironmentOptions {\n   std::vector<std::string> user_argv;\n \n   inline DebugOptions* get_debug_options();\n+  void CheckOptions(std::vector<std::string>* errors);\n };\n \n-class PerIsolateOptions {\n+class PerIsolateOptions : public Options {\n  public:\n   std::shared_ptr<EnvironmentOptions> per_env { new EnvironmentOptions() };\n   bool track_heap_objects = false;\n \n   inline EnvironmentOptions* get_per_env_options();\n+  void CheckOptions(std::vector<std::string>* errors);\n };\n \n-class PerProcessOptions {\n+class PerProcessOptions : public Options {\n  public:\n   std::shared_ptr<PerIsolateOptions> per_isolate { new PerIsolateOptions() };\n \n@@ -139,13 +146,15 @@ class PerProcessOptions {\n #endif\n \n   inline PerIsolateOptions* get_per_isolate_options();\n+  void CheckOptions(std::vector<std::string>* errors);\n };\n \n // The actual options parser, as opposed to the structs containing them:\n \n namespace options_parser {\n \n-HostPort SplitHostPort(const std::string& arg, std::string* error);\n+HostPort SplitHostPort(const std::string& arg,\n+    std::vector<std::string>* errors);\n void GetOptions(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n enum OptionEnvvarSettings {\n@@ -255,7 +264,7 @@ class OptionsParser {\n                      std::vector<std::string>* const v8_args,\n                      Options* const options,\n                      OptionEnvvarSettings required_env_settings,\n-                     std::string* const error);\n+                     std::vector<std::string>* const errors);\n \n  private:\n   // We support the wide variety of different option types by remembering"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 61,
        "deletions": 44
    }
}