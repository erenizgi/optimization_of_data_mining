{
    "author": "unknown",
    "message": "n-api: finalize during second-pass callback\n\nCalling into the engine from a weak callback is unsafe, however, the\nengine offers a way to attach a second-pass weak callback which gets\ncalled when it is safe to call into JavaScript. This moves the point\nat which the N-API finalize callback gets called to this latter point.\n\nFixes: https://github.com/nodejs/node/issues/25927\nPR-URL: https://github.com/nodejs/node/pull/25992\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "6edf88284b2ef522d2f073e66fa32e9cbe6fafd2",
    "files": [
        {
            "sha": "287142e26589071015e70683726bb7b58e1231e4",
            "filename": "src/js_native_api_v8.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/6edf88284b2ef522d2f073e66fa32e9cbe6fafd2/src%2Fjs_native_api_v8.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6edf88284b2ef522d2f073e66fa32e9cbe6fafd2/src%2Fjs_native_api_v8.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_native_api_v8.cc?ref=6edf88284b2ef522d2f073e66fa32e9cbe6fafd2",
            "patch": "@@ -281,10 +281,25 @@ class Reference : private Finalizer {\n   }\n \n  private:\n+  // The N-API finalizer callback may make calls into the engine. V8's heap is\n+  // not in a consistent state during the weak callback, and therefore it does\n+  // not support calls back into it. However, it provides a mechanism for adding\n+  // a finalizer which may make calls back into the engine by allowing us to\n+  // attach such a second-pass finalizer from the first pass finalizer. Thus,\n+  // we do that here to ensure that the N-API finalizer callback is free to call\n+  // into the engine.\n   static void FinalizeCallback(const v8::WeakCallbackInfo<Reference>& data) {\n     Reference* reference = data.GetParameter();\n+\n+    // The reference must be reset during the first pass.\n     reference->_persistent.Reset();\n \n+    data.SetSecondPassCallback(SecondPassCallback);\n+  }\n+\n+  static void SecondPassCallback(const v8::WeakCallbackInfo<Reference>& data) {\n+    Reference* reference = data.GetParameter();\n+\n     napi_env env = reference->_env;\n \n     if (reference->_finalize_callback != nullptr) {"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 15,
        "deletions": 0
    }
}