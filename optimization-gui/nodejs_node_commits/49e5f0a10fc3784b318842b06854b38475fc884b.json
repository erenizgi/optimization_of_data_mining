{
    "author": "santigimeno",
    "message": "test: fix test-net-socket-constructor\n\nSo it doesn't fail when creating a socket whose `fd` is already\nbeing watched. Test that functionality now inside a cluster\nworker.\n\nRefs: https://github.com/libuv/libuv/pull/1851\nRefs: https://github.com/libuv/libuv/issues/1897\nPR-URL: https://github.com/nodejs/node/pull/21466\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "49e5f0a10fc3784b318842b06854b38475fc884b",
    "files": [
        {
            "sha": "90b0907f488a9a3bc18f52acf31742d6a4a09828",
            "filename": "test/parallel/test-net-socket-constructor.js",
            "status": "modified",
            "additions": 33,
            "deletions": 19,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/49e5f0a10fc3784b318842b06854b38475fc884b/test%2Fparallel%2Ftest-net-socket-constructor.js",
            "raw_url": "https://github.com/nodejs/node/raw/49e5f0a10fc3784b318842b06854b38475fc884b/test%2Fparallel%2Ftest-net-socket-constructor.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-socket-constructor.js?ref=49e5f0a10fc3784b318842b06854b38475fc884b",
            "patch": "@@ -2,6 +2,7 @@\n \n const common = require('../common');\n const assert = require('assert');\n+const cluster = require('cluster');\n const net = require('net');\n \n common.expectsError(() => {\n@@ -25,27 +26,40 @@ function test(sock, readable, writable) {\n   assert.strictEqual(socket.writable, writable);\n }\n \n-test(undefined, false, false);\n+if (cluster.isMaster) {\n+  test(undefined, false, false);\n \n-const server = net.createServer(common.mustCall((socket) => {\n-  test(socket, true, true);\n-  test({ handle: socket._handle }, false, false);\n-  test({ handle: socket._handle, readable: true, writable: true }, true, true);\n-  if (socket._handle.fd >= 0) {\n-    test(socket._handle.fd, false, false);\n-    test({ fd: socket._handle.fd }, false, false);\n-    test({ fd: socket._handle.fd, readable: true, writable: true }, true, true);\n-  }\n+  const server = net.createServer(common.mustCall((socket) => {\n+    socket.unref();\n+    test(socket, true, true);\n+    test({ handle: socket._handle }, false, false);\n+    test({ handle: socket._handle, readable: true, writable: true },\n+         true, true);\n+    server.close();\n+  }));\n \n-  server.close();\n-}));\n+  server.listen(common.mustCall(() => {\n+    const { port } = server.address();\n+    const socket = net.connect(port, common.mustCall(() => {\n+      test(socket, true, true);\n+      socket.end();\n+    }));\n \n-server.listen(common.mustCall(() => {\n-  const { port } = server.address();\n-  const socket = net.connect(port, common.mustCall(() => {\n-    test(socket, true, true);\n-    socket.end();\n+    test(socket, false, true);\n   }));\n \n-  test(socket, false, true);\n-}));\n+  cluster.setupMaster({\n+    stdio: ['pipe', 'pipe', 'pipe', 'ipc', 'pipe', 'pipe', 'pipe']\n+  });\n+\n+  const worker = cluster.fork();\n+  worker.on('exit', common.mustCall((code, signal) => {\n+    assert.strictEqual(code, 0);\n+    assert.strictEqual(signal, null);\n+  }));\n+} else {\n+  test(4, false, false);\n+  test({ fd: 5 }, false, false);\n+  test({ fd: 6, readable: true, writable: true }, true, true);\n+  process.disconnect();\n+}"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 33,
        "deletions": 19
    }
}