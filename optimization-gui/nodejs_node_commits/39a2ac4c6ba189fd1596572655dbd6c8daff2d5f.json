{
    "author": "joyeecheung",
    "message": "process: move process.features initialization into node.js\n\nUse `internalBinding('config')` to shim the legacy\n`process.features`.\n\nPR-URL: https://github.com/nodejs/node/pull/25239\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>",
    "sha": "39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
    "files": [
        {
            "sha": "c709635a7555125ff804606bb9eec2cd1e20405b",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
            "patch": "@@ -270,6 +270,24 @@ function startup() {\n     'process.assert() is deprecated. Please use the `assert` module instead.',\n     'DEP0100');\n \n+  // TODO(joyeecheung): this property has not been well-maintained, should we\n+  // deprecate it in favor of a better API?\n+  const { isDebugBuild, hasOpenSSL } = internalBinding('config');\n+  Object.defineProperty(process, 'features', {\n+    enumerable: true,\n+    writable: false,\n+    configurable: false,\n+    value: {\n+      debug: isDebugBuild,\n+      uv: true,\n+      ipv6: true,  // TODO(bnoordhuis) ping libuv\n+      tls_alpn: hasOpenSSL,\n+      tls_sni: hasOpenSSL,\n+      tls_ocsp: hasOpenSSL,\n+      tls: hasOpenSSL\n+    }\n+  });\n+\n   const perf = internalBinding('performance');\n   const {\n     NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,"
        },
        {
            "sha": "edd1ca3cd19d34a27a17c52b76d561bf907ca31f",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 44,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
            "patch": "@@ -801,49 +801,6 @@ static void OnMessage(Local<Message> message, Local<Value> error) {\n   }\n }\n \n-static Local<Object> GetFeatures(Environment* env) {\n-  EscapableHandleScope scope(env->isolate());\n-\n-  Local<Object> obj = Object::New(env->isolate());\n-#if defined(DEBUG) && DEBUG\n-  Local<Value> debug = True(env->isolate());\n-#else\n-  Local<Value> debug = False(env->isolate());\n-#endif  // defined(DEBUG) && DEBUG\n-\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"debug\"),\n-           debug).FromJust();\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"uv\"),\n-           True(env->isolate())).FromJust();\n-  // TODO(bnoordhuis) ping libuv\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"ipv6\"),\n-           True(env->isolate())).FromJust();\n-\n-#ifdef HAVE_OPENSSL\n-  Local<Boolean> have_openssl = True(env->isolate());\n-#else\n-  Local<Boolean> have_openssl = False(env->isolate());\n-#endif\n-\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"tls_alpn\"),\n-           have_openssl).FromJust();\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"tls_sni\"),\n-           have_openssl).FromJust();\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"tls_ocsp\"),\n-           have_openssl).FromJust();\n-  obj->Set(env->context(),\n-           FIXED_ONE_BYTE_STRING(env->isolate(), \"tls\"),\n-           have_openssl).FromJust();\n-\n-  return scope.Escape(obj);\n-}\n-\n void SetupProcessObject(Environment* env,\n                         const std::vector<std::string>& args,\n                         const std::vector<std::string>& exec_args) {\n@@ -964,7 +921,6 @@ void SetupProcessObject(Environment* env,\n \n   READONLY_PROPERTY(process, \"pid\",\n                     Integer::New(env->isolate(), uv_os_getpid()));\n-  READONLY_PROPERTY(process, \"features\", GetFeatures(env));\n \n   CHECK(process->SetAccessor(env->context(),\n                              FIXED_ONE_BYTE_STRING(env->isolate(), \"ppid\"),"
        },
        {
            "sha": "7204e2465621159ca0592430802856fbe3d12f54",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
            "patch": "@@ -26,6 +26,18 @@ static void Initialize(Local<Object> target,\n   Environment* env = Environment::GetCurrent(context);\n   Isolate* isolate = env->isolate();\n \n+#if defined(DEBUG) && DEBUG\n+  READONLY_TRUE_PROPERTY(target, \"isDebugBuild\");\n+#else\n+  READONLY_FALSE_PROPERTY(target, \"isDebugBuild\");\n+#endif  // defined(DEBUG) && DEBUG\n+\n+#if HAVE_OPENSSL\n+  READONLY_TRUE_PROPERTY(target, \"hasOpenSSL\");\n+#else\n+  READONLY_FALSE_PROPERTY(target, \"hasOpenSSL\");\n+#endif  // HAVE_OPENSSL\n+\n #ifdef NODE_FIPS_MODE\n   READONLY_TRUE_PROPERTY(target, \"fipsMode\");\n   // TODO(addaleax): Use options parser variable instead."
        },
        {
            "sha": "2db87c18b0d3df3aa7e9104cb72750f49d7f568d",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
            "patch": "@@ -546,8 +546,11 @@ inline v8::MaybeLocal<v8::Value> ToV8Value(v8::Local<v8::Context> context,\n         .FromJust();                                                           \\\n   } while (0)\n \n+#define READONLY_FALSE_PROPERTY(obj, name)                                     \\\n+  READONLY_PROPERTY(obj, name, v8::False(isolate))\n+\n #define READONLY_TRUE_PROPERTY(obj, name)                                      \\\n-  READONLY_PROPERTY(obj, name, True(isolate))\n+  READONLY_PROPERTY(obj, name, v8::True(isolate))\n \n #define READONLY_STRING_PROPERTY(obj, name, str)                               \\\n   READONLY_PROPERTY(obj, name, ToV8Value(context, str).ToLocalChecked())"
        },
        {
            "sha": "7752cc53b2a1ca629507f87c22d13898f74b609a",
            "filename": "test/parallel/test-process-features.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/test%2Fparallel%2Ftest-process-features.js",
            "raw_url": "https://github.com/nodejs/node/raw/39a2ac4c6ba189fd1596572655dbd6c8daff2d5f/test%2Fparallel%2Ftest-process-features.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-features.js?ref=39a2ac4c6ba189fd1596572655dbd6c8daff2d5f",
            "patch": "@@ -0,0 +1,20 @@\n+'use strict';\n+\n+require('../common');\n+const assert = require('assert');\n+\n+const keys = new Set(Object.keys(process.features));\n+\n+assert.deepStrictEqual(keys, new Set([\n+  'debug',\n+  'uv',\n+  'ipv6',\n+  'tls_alpn',\n+  'tls_sni',\n+  'tls_ocsp',\n+  'tls'\n+]));\n+\n+for (const key of keys) {\n+  assert.strictEqual(typeof process.features[key], 'boolean');\n+}"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 54,
        "deletions": 45
    }
}