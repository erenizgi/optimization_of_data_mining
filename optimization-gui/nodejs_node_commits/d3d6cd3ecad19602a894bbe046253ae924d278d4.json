{
    "author": "gireeshpunathil",
    "message": "src: improve SSL version extraction logic\n\nThe openssl version as defined in ssl libraries is complex.\nThe current logic to extract the major.minor.patch format\nuses C semantics to loop through the text and search for\nspecific patterns. Use C++ string to tidy it up.\n\nPR-URL: https://github.com/nodejs/node/pull/23050\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "d3d6cd3ecad19602a894bbe046253ae924d278d4",
    "files": [
        {
            "sha": "f703b4abf6a49866186662c103bdc19e2e914ec8",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 38,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=d3d6cd3ecad19602a894bbe046253ae924d278d4",
            "patch": "@@ -232,24 +232,7 @@ class NodeTraceStateObserver :\n     trace_process->SetString(\"napi\", node_napi_version);\n \n #if HAVE_OPENSSL\n-    // Stupid code to slice out the version string.\n-    {  // NOLINT(whitespace/braces)\n-      size_t i, j, k;\n-      int c;\n-      for (i = j = 0, k = sizeof(OPENSSL_VERSION_TEXT) - 1; i < k; ++i) {\n-        c = OPENSSL_VERSION_TEXT[i];\n-        if ('0' <= c && c <= '9') {\n-          for (j = i + 1; j < k; ++j) {\n-            c = OPENSSL_VERSION_TEXT[j];\n-            if (c == ' ')\n-              break;\n-          }\n-          break;\n-        }\n-      }\n-      trace_process->SetString(\"openssl\",\n-                              std::string(&OPENSSL_VERSION_TEXT[i], j - i));\n-    }\n+    trace_process->SetString(\"openssl\", crypto::GetOpenSSLVersion());\n #endif\n     trace_process->EndDictionary();\n \n@@ -1762,26 +1745,10 @@ void SetupProcessObject(Environment* env,\n       FIXED_ONE_BYTE_STRING(env->isolate(), node_napi_version));\n \n #if HAVE_OPENSSL\n-  // Stupid code to slice out the version string.\n-  {  // NOLINT(whitespace/braces)\n-    size_t i, j, k;\n-    int c;\n-    for (i = j = 0, k = sizeof(OPENSSL_VERSION_TEXT) - 1; i < k; ++i) {\n-      c = OPENSSL_VERSION_TEXT[i];\n-      if ('0' <= c && c <= '9') {\n-        for (j = i + 1; j < k; ++j) {\n-          c = OPENSSL_VERSION_TEXT[j];\n-          if (c == ' ')\n-            break;\n-        }\n-        break;\n-      }\n-    }\n-    READONLY_PROPERTY(\n-        versions,\n-        \"openssl\",\n-        OneByteString(env->isolate(), &OPENSSL_VERSION_TEXT[i], j - i));\n-  }\n+  READONLY_PROPERTY(\n+      versions,\n+      \"openssl\",\n+      OneByteString(env->isolate(), crypto::GetOpenSSLVersion().c_str()));\n #endif\n \n   // process.arch"
        },
        {
            "sha": "96f4cf2ba7076ded819ed7771104f6f9d020bfed",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=d3d6cd3ecad19602a894bbe046253ae924d278d4",
            "patch": "@@ -5734,6 +5734,21 @@ void Initialize(Local<Object> target,\n #endif  // OPENSSL_NO_SCRYPT\n }\n \n+constexpr int search(const char* s, int n, int c) {\n+  return *s == c ? n : search(s + 1, n + 1, c);\n+}\n+\n+std::string GetOpenSSLVersion() {\n+  // sample openssl version string format\n+  // for reference: \"OpenSSL 1.1.0i 14 Aug 2018\"\n+  char buf[128];\n+  const int start = search(OPENSSL_VERSION_TEXT, 0, ' ') + 1;\n+  const int end = search(OPENSSL_VERSION_TEXT + start, start, ' ') + 1;\n+  const int len = end - start;\n+  snprintf(buf, len, \"%.*s\\n\", len, &OPENSSL_VERSION_TEXT[start]);\n+  return std::string(buf);\n+}\n+\n }  // namespace crypto\n }  // namespace node\n "
        },
        {
            "sha": "f4afd2fdaf575806fe33302dc609c3c537fd3800",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/d3d6cd3ecad19602a894bbe046253ae924d278d4/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=d3d6cd3ecad19602a894bbe046253ae924d278d4",
            "patch": "@@ -93,6 +93,7 @@ extern int VerifyCallback(int preverify_ok, X509_STORE_CTX* ctx);\n extern void UseExtraCaCerts(const std::string& file);\n \n void InitCryptoOnce();\n+std::string GetOpenSSLVersion();\n \n class SecureContext : public BaseObject {\n  public:"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 21,
        "deletions": 38
    }
}