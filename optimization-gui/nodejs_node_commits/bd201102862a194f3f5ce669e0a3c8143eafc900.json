{
    "author": "addaleax",
    "message": "src: refactor `BaseObject` internal field management\n\n- Instead of storing a pointer whose type refers to the specific\n  subclass of `BaseObject`, just store a `BaseObject*` directly.\n  This means in particular that one can cast to classes along\n  the way of the inheritance chain without issues, and that\n  `BaseObject*` no longer needs to be the first superclass\n  in the case of multiple inheritance.\n\n  In particular, this renders hack-y solutions to this problem (like\n  ddc19be6de1ba263d9c175b2760696e7b9918b25) obsolete and addresses\n  a `TODO` comment of mine.\n\n- Move wrapping/unwrapping methods to the `BaseObject` class.\n  We use these almost exclusively for `BaseObject`s, and I hope\n  that this gives a better idea of how (and for what) these are used\n  in our code.\n\n- Perform initialization/deinitialization of the internal field\n  in the `BaseObject*` constructor/destructor. This makes the code\n  a bit more obviously correct, avoids explicit calls for this\n  in subclass constructors, and in particular allows us to avoid\n  crash situations when we previously called `ClearWrap()`\n  during GC.\n\n  This also means that we enforce that the object passed to the\n  `BaseObject` constructor needs to have an internal field.\n  This is the only reason for the test change.\n\n- Change the signature of `MakeWeak()` to not require a pointer\n  argument. Previously, this would always have been the same\n  as `this`, and no other value made sense. Also, the parameter\n  was something that I personally found somewhat confusing\n  when becoming familiar with Nodeâ€™s code.\n\n- Add a `TODO` comment that motivates switching to real inheritance\n  for the JS types we expose from the native side. This patch\n  brings us a lot closer to being able to do that.\n\n- Some less significant drive-by cleanup.\n\nSince we *effectively* already store the `BaseObject*` pointer\nanyway since ddc19be6de1ba263d9c175b2760696e7b9918b25, I do not\nthink that this is going to have any impact on diagnostic tooling.\n\nFixes: https://github.com/nodejs/node/issues/18897\nPR-URL: https://github.com/nodejs/node/pull/20455\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "bd201102862a194f3f5ce669e0a3c8143eafc900",
    "files": [
        {
            "sha": "f7a6d4e68dd4834e2e2f7617dfb33900d5a280bd",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -123,8 +123,8 @@ RetainedObjectInfo* WrapperInfo(uint16_t class_id, Local<Value> wrapper) {\n   Local<Object> object = wrapper.As<Object>();\n   CHECK_GT(object->InternalFieldCount(), 0);\n \n-  AsyncWrap* wrap = Unwrap<AsyncWrap>(object);\n-  if (wrap == nullptr) return nullptr;  // ClearWrap() already called.\n+  AsyncWrap* wrap;\n+  ASSIGN_OR_RETURN_UNWRAP(&wrap, object, nullptr);\n \n   return new RetainedAsyncInfo(class_id, wrap);\n }\n@@ -231,7 +231,7 @@ class PromiseWrap : public AsyncWrap {\n  public:\n   PromiseWrap(Environment* env, Local<Object> object, bool silent)\n       : AsyncWrap(env, object, PROVIDER_PROMISE, -1, silent) {\n-    MakeWeak(this);\n+    MakeWeak();\n   }\n   size_t self_size() const override { return sizeof(*this); }\n "
        },
        {
            "sha": "11ba1c88da048642d70fd656dd44258198f26ac8",
            "filename": "src/base_object-inl.h",
            "status": "modified",
            "additions": 57,
            "deletions": 21,
            "changes": 78,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fbase_object-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fbase_object-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object-inl.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -31,54 +31,90 @@\n \n namespace node {\n \n-inline BaseObject::BaseObject(Environment* env, v8::Local<v8::Object> handle)\n+BaseObject::BaseObject(Environment* env, v8::Local<v8::Object> handle)\n     : persistent_handle_(env->isolate(), handle),\n       env_(env) {\n   CHECK_EQ(false, handle.IsEmpty());\n-  // The zero field holds a pointer to the handle. Immediately set it to\n-  // nullptr in case it's accessed by the user before construction is complete.\n-  if (handle->InternalFieldCount() > 0)\n-    handle->SetAlignedPointerInInternalField(0, nullptr);\n+  CHECK_GT(handle->InternalFieldCount(), 0);\n+  handle->SetAlignedPointerInInternalField(0, static_cast<void*>(this));\n }\n \n \n-inline Persistent<v8::Object>& BaseObject::persistent() {\n+BaseObject::~BaseObject() {\n+  if (persistent_handle_.IsEmpty()) {\n+    // This most likely happened because the weak callback below cleared it.\n+    return;\n+  }\n+\n+  {\n+    v8::HandleScope handle_scope(env_->isolate());\n+    object()->SetAlignedPointerInInternalField(0, nullptr);\n+  }\n+}\n+\n+\n+Persistent<v8::Object>& BaseObject::persistent() {\n   return persistent_handle_;\n }\n \n \n-inline v8::Local<v8::Object> BaseObject::object() {\n+v8::Local<v8::Object> BaseObject::object() {\n   return PersistentToLocal(env_->isolate(), persistent_handle_);\n }\n \n \n-inline Environment* BaseObject::env() const {\n+Environment* BaseObject::env() const {\n   return env_;\n }\n \n \n-template <typename Type>\n-inline void BaseObject::WeakCallback(\n-    const v8::WeakCallbackInfo<Type>& data) {\n-  delete data.GetParameter();\n+BaseObject* BaseObject::FromJSObject(v8::Local<v8::Object> obj) {\n+  CHECK_GT(obj->InternalFieldCount(), 0);\n+  return static_cast<BaseObject*>(obj->GetAlignedPointerFromInternalField(0));\n }\n \n \n-template <typename Type>\n-inline void BaseObject::MakeWeak(Type* ptr) {\n-  v8::HandleScope scope(env_->isolate());\n-  v8::Local<v8::Object> handle = object();\n-  CHECK_GT(handle->InternalFieldCount(), 0);\n-  Wrap(handle, ptr);\n-  persistent_handle_.SetWeak<Type>(ptr, WeakCallback<Type>,\n-                                   v8::WeakCallbackType::kParameter);\n+template <typename T>\n+T* BaseObject::FromJSObject(v8::Local<v8::Object> object) {\n+  return static_cast<T*>(FromJSObject(object));\n }\n \n \n-inline void BaseObject::ClearWeak() {\n+void BaseObject::MakeWeak() {\n+  persistent_handle_.SetWeak(\n+      this,\n+      [](const v8::WeakCallbackInfo<BaseObject>& data) {\n+        BaseObject* obj = data.GetParameter();\n+        // Clear the persistent handle so that ~BaseObject() doesn't attempt\n+        // to mess with internal fields, since the JS object may have\n+        // transitioned into an invalid state.\n+        // Refs: https://github.com/nodejs/node/issues/18897\n+        obj->persistent_handle_.Reset();\n+        delete obj;\n+      }, v8::WeakCallbackType::kParameter);\n+}\n+\n+\n+void BaseObject::ClearWeak() {\n   persistent_handle_.ClearWeak();\n }\n \n+\n+v8::Local<v8::FunctionTemplate>\n+BaseObject::MakeLazilyInitializedJSTemplate(Environment* env) {\n+  auto constructor = [](const v8::FunctionCallbackInfo<v8::Value>& args) {\n+#ifdef DEBUG\n+    CHECK(args.IsConstructCall());\n+    CHECK_GT(args.This()->InternalFieldCount(), 0);\n+#endif\n+    args.This()->SetAlignedPointerInInternalField(0, nullptr);\n+  };\n+\n+  v8::Local<v8::FunctionTemplate> t = env->NewFunctionTemplate(constructor);\n+  t->InstanceTemplate()->SetInternalFieldCount(1);\n+  return t;\n+}\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "7d8281238b1c1d08eec7be3e7fc4d4bd9e58e7ec",
            "filename": "src/base_object.h",
            "status": "modified",
            "additions": 38,
            "deletions": 12,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fbase_object.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fbase_object.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -26,15 +26,18 @@\n \n #include \"node_persistent.h\"\n #include \"v8.h\"\n+#include <type_traits>  // std::remove_reference\n \n namespace node {\n \n class Environment;\n \n class BaseObject {\n  public:\n+  // Associates this object with `handle`. It uses the 0th internal field for\n+  // that, and in particular aborts if there is no such field.\n   inline BaseObject(Environment* env, v8::Local<v8::Object> handle);\n-  virtual ~BaseObject() = default;\n+  virtual inline ~BaseObject();\n \n   // Returns the wrapped object.  Returns an empty handle when\n   // persistent.IsEmpty() is true.\n@@ -44,23 +47,30 @@ class BaseObject {\n \n   inline Environment* env() const;\n \n-  // The handle_ must have an internal field count > 0, and the first\n-  // index is reserved for a pointer to this class. This is an\n-  // implicit requirement, but Node does not have a case where it's\n-  // required that MakeWeak() be called and the internal field not\n-  // be set.\n-  template <typename Type>\n-  inline void MakeWeak(Type* ptr);\n+  // Get a BaseObject* pointer, or subclass pointer, for the JS object that\n+  // was also passed to the `BaseObject()` constructor initially.\n+  // This may return `nullptr` if the C++ object has not been constructed yet,\n+  // e.g. when the JS object used `MakeLazilyInitializedJSTemplate`.\n+  static inline BaseObject* FromJSObject(v8::Local<v8::Object> object);\n+  template <typename T>\n+  static inline T* FromJSObject(v8::Local<v8::Object> object);\n \n+  // Make the `Persistent` a weak reference and, `delete` this object once\n+  // the JS object has been garbage collected.\n+  inline void MakeWeak();\n+\n+  // Undo `MakeWeak()`, i.e. turn this into a strong reference.\n   inline void ClearWeak();\n \n+  // Utility to create a FunctionTemplate with one internal field (used for\n+  // the `BaseObject*` pointer) and a constructor that initializes that field\n+  // to `nullptr`.\n+  static inline v8::Local<v8::FunctionTemplate> MakeLazilyInitializedJSTemplate(\n+      Environment* env);\n+\n  private:\n   BaseObject();\n \n-  template <typename Type>\n-  static inline void WeakCallback(\n-      const v8::WeakCallbackInfo<Type>& data);\n-\n   // persistent_handle_ needs to be at a fixed offset from the start of the\n   // class because it is used by src/node_postmortem_metadata.cc to calculate\n   // offsets and generate debug symbols for BaseObject, which assumes that the\n@@ -71,6 +81,22 @@ class BaseObject {\n   Environment* env_;\n };\n \n+\n+// Global alias for FromJSObject() to avoid churn.\n+template <typename T>\n+inline T* Unwrap(v8::Local<v8::Object> obj) {\n+  return BaseObject::FromJSObject<T>(obj);\n+}\n+\n+\n+#define ASSIGN_OR_RETURN_UNWRAP(ptr, obj, ...)                                \\\n+  do {                                                                        \\\n+    *ptr = static_cast<typename std::remove_reference<decltype(*ptr)>::type>( \\\n+        BaseObject::FromJSObject(obj));                                       \\\n+    if (*ptr == nullptr)                                                      \\\n+      return __VA_ARGS__;                                                     \\\n+  } while (0)\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "4df47d75d43ba83582629e96b4616a66003a45c2",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 27,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -187,7 +187,7 @@ ChannelWrap::ChannelWrap(Environment* env,\n     is_servers_default_(true),\n     library_inited_(false),\n     active_query_count_(0) {\n-  MakeWeak<ChannelWrap>(this);\n+  MakeWeak();\n \n   Setup();\n }\n@@ -205,7 +205,6 @@ class GetAddrInfoReqWrap : public ReqWrap<uv_getaddrinfo_t> {\n   GetAddrInfoReqWrap(Environment* env,\n                      Local<Object> req_wrap_obj,\n                      bool verbatim);\n-  ~GetAddrInfoReqWrap();\n \n   size_t self_size() const override { return sizeof(*this); }\n   bool verbatim() const { return verbatim_; }\n@@ -219,30 +218,19 @@ GetAddrInfoReqWrap::GetAddrInfoReqWrap(Environment* env,\n                                        bool verbatim)\n     : ReqWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_GETADDRINFOREQWRAP)\n     , verbatim_(verbatim) {\n-  Wrap(req_wrap_obj, this);\n-}\n-\n-GetAddrInfoReqWrap::~GetAddrInfoReqWrap() {\n-  ClearWrap(object());\n }\n \n \n class GetNameInfoReqWrap : public ReqWrap<uv_getnameinfo_t> {\n  public:\n   GetNameInfoReqWrap(Environment* env, Local<Object> req_wrap_obj);\n-  ~GetNameInfoReqWrap();\n \n   size_t self_size() const override { return sizeof(*this); }\n };\n \n GetNameInfoReqWrap::GetNameInfoReqWrap(Environment* env,\n                                        Local<Object> req_wrap_obj)\n     : ReqWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_GETNAMEINFOREQWRAP) {\n-  Wrap(req_wrap_obj, this);\n-}\n-\n-GetNameInfoReqWrap::~GetNameInfoReqWrap() {\n-  ClearWrap(object());\n }\n \n \n@@ -587,8 +575,6 @@ class QueryWrap : public AsyncWrap {\n   QueryWrap(ChannelWrap* channel, Local<Object> req_wrap_obj)\n       : AsyncWrap(channel->env(), req_wrap_obj, AsyncWrap::PROVIDER_QUERYWRAP),\n         channel_(channel) {\n-    Wrap(req_wrap_obj, this);\n-\n     // Make sure the channel object stays alive during the query lifetime.\n     req_wrap_obj->Set(env()->context(),\n                       env()->channel_string(),\n@@ -597,7 +583,6 @@ class QueryWrap : public AsyncWrap {\n \n   ~QueryWrap() override {\n     CHECK_EQ(false, persistent().IsEmpty());\n-    ClearWrap(object());\n   }\n \n   // Subclasses should implement the appropriate Send method.\n@@ -2143,32 +2128,24 @@ void Initialize(Local<Object> target,\n   target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"AI_V4MAPPED\"),\n               Integer::New(env->isolate(), AI_V4MAPPED));\n \n-  auto is_construct_call_callback =\n-      [](const FunctionCallbackInfo<Value>& args) {\n-    CHECK(args.IsConstructCall());\n-    ClearWrap(args.This());\n-  };\n   Local<FunctionTemplate> aiw =\n-      FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n-  aiw->InstanceTemplate()->SetInternalFieldCount(1);\n+      BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, aiw);\n   Local<String> addrInfoWrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"GetAddrInfoReqWrap\");\n   aiw->SetClassName(addrInfoWrapString);\n   target->Set(addrInfoWrapString, aiw->GetFunction());\n \n   Local<FunctionTemplate> niw =\n-      FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n-  niw->InstanceTemplate()->SetInternalFieldCount(1);\n+      BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, niw);\n   Local<String> nameInfoWrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"GetNameInfoReqWrap\");\n   niw->SetClassName(nameInfoWrapString);\n   target->Set(nameInfoWrapString, niw->GetFunction());\n \n   Local<FunctionTemplate> qrw =\n-      FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n-  qrw->InstanceTemplate()->SetInternalFieldCount(1);\n+      BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, qrw);\n   Local<String> queryWrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"QueryReqWrap\");"
        },
        {
            "sha": "dacdf72da7c494bbce46fc53e980f110698385a7",
            "filename": "src/connect_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnect_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnect_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fconnect_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -13,12 +13,6 @@ using v8::Object;\n ConnectWrap::ConnectWrap(Environment* env,\n     Local<Object> req_wrap_obj,\n     AsyncWrap::ProviderType provider) : ReqWrap(env, req_wrap_obj, provider) {\n-  Wrap(req_wrap_obj, this);\n-}\n-\n-\n-ConnectWrap::~ConnectWrap() {\n-  ClearWrap(object());\n }\n \n }  // namespace node"
        },
        {
            "sha": "80eae7f9bb8290f8f31b8035d9a34af841307e05",
            "filename": "src/connect_wrap.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnect_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnect_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fconnect_wrap.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -15,7 +15,6 @@ class ConnectWrap : public ReqWrap<uv_connect_t> {\n   ConnectWrap(Environment* env,\n               v8::Local<v8::Object> req_wrap_obj,\n               AsyncWrap::ProviderType provider);\n-  ~ConnectWrap();\n \n   size_t self_size() const override { return sizeof(*this); }\n };"
        },
        {
            "sha": "afb168c614aa975197d582263997a77647984329",
            "filename": "src/connection_wrap.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnection_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fconnection_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fconnection_wrap.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -29,7 +29,6 @@ class ConnectionWrap : public LibuvStreamWrap {\n   UVType handle_;\n };\n \n-\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "ed74f36719db79737130150024e6a5ef111194e1",
            "filename": "src/fs_event_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ffs_event_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ffs_event_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ffs_event_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -131,7 +131,7 @@ void FSEventWrap::New(const FunctionCallbackInfo<Value>& args) {\n void FSEventWrap::Start(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  FSEventWrap* wrap = Unwrap<FSEventWrap>(args.Holder());\n+  FSEventWrap* wrap = Unwrap<FSEventWrap>(args.This());\n   CHECK_NE(wrap, nullptr);\n   CHECK(!wrap->initialized_);\n "
        },
        {
            "sha": "49bf0c55bea0a18682f38ff401b18cf6da695a48",
            "filename": "src/handle_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fhandle_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fhandle_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -93,7 +93,6 @@ HandleWrap::HandleWrap(Environment* env,\n       handle_(handle) {\n   handle_->data = this;\n   HandleScope scope(env->isolate());\n-  Wrap(object, this);\n   env->handle_wrap_queue()->PushBack(this);\n }\n \n@@ -114,7 +113,6 @@ void HandleWrap::OnClose(uv_handle_t* handle) {\n   if (have_close_callback)\n     wrap->MakeCallback(env->onclose_string(), 0, nullptr);\n \n-  ClearWrap(wrap->object());\n   delete wrap;\n }\n "
        },
        {
            "sha": "ae353defe8079d9c0c047dd41973e763409b3106",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -64,7 +64,6 @@ class JSBindingsConnection : public AsyncWrap {\n                        Local<Function> callback)\n                        : AsyncWrap(env, wrap, PROVIDER_INSPECTORJSBINDING),\n                          callback_(env->isolate(), callback) {\n-    Wrap(wrap, this);\n     Agent* inspector = env->inspector_agent();\n     session_ = inspector->Connect(std::unique_ptr<JSBindingsSessionDelegate>(\n         new JSBindingsSessionDelegate(env, this)));\n@@ -83,9 +82,6 @@ class JSBindingsConnection : public AsyncWrap {\n \n   void Disconnect() {\n     session_.reset();\n-    if (!persistent().IsEmpty()) {\n-      ClearWrap(object());\n-    }\n     delete this;\n   }\n "
        },
        {
            "sha": "2293d8cf203d07ef2e9cbb6b3b90359daa0e74d7",
            "filename": "src/js_stream.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fjs_stream.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fjs_stream.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -24,12 +24,7 @@ using v8::Value;\n JSStream::JSStream(Environment* env, Local<Object> obj)\n     : AsyncWrap(env, obj, AsyncWrap::PROVIDER_JSSTREAM),\n       StreamBase(env) {\n-  node::Wrap(obj, this);\n-  MakeWeak<JSStream>(this);\n-}\n-\n-\n-JSStream::~JSStream() {\n+  MakeWeak();\n }\n \n "
        },
        {
            "sha": "b47a91a653ba7e23155a2bb0729845c86a47b6df",
            "filename": "src/js_stream.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fjs_stream.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fjs_stream.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -16,8 +16,6 @@ class JSStream : public AsyncWrap, public StreamBase {\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context);\n \n-  ~JSStream();\n-\n   bool IsAlive() override;\n   bool IsClosing() override;\n   int ReadStart() override;"
        },
        {
            "sha": "71f1acdaf676886b6ab1062b00ef33cc74c4912a",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -158,7 +158,6 @@ void ModuleWrap::New(const FunctionCallbackInfo<Value>& args) {\n   obj->context_.Reset(isolate, context);\n \n   env->module_map.emplace(module->GetIdentityHash(), obj);\n-  Wrap(that, obj);\n \n   that->SetIntegrityLevel(context, IntegrityLevel::kFrozen);\n   args.GetReturnValue().Set(that);"
        },
        {
            "sha": "4db82d4d7ca3e9f8e9f352ef2008555bba5201f4",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -885,7 +885,7 @@ class ContextifyScript : public BaseObject {\n \n   ContextifyScript(Environment* env, Local<Object> object)\n       : BaseObject(env, object) {\n-    MakeWeak<ContextifyScript>(this);\n+    MakeWeak();\n   }\n };\n "
        },
        {
            "sha": "4b6eee55745f47e88de8603fd9ad56c10a52aa82",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -4690,7 +4690,6 @@ class PBKDF2Request : public AsyncWrap {\n         keylen_(keylen),\n         key_(node::Malloc(keylen)),\n         iter_(iter) {\n-    Wrap(object, this);\n   }\n \n   ~PBKDF2Request() override {\n@@ -4705,8 +4704,6 @@ class PBKDF2Request : public AsyncWrap {\n     free(key_);\n     key_ = nullptr;\n     keylen_ = 0;\n-\n-    ClearWrap(object());\n   }\n \n   uv_work_t* work_req() {\n@@ -4868,11 +4865,6 @@ class RandomBytesRequest : public AsyncWrap {\n         size_(size),\n         data_(data),\n         free_mode_(free_mode) {\n-    Wrap(object, this);\n-  }\n-\n-  ~RandomBytesRequest() override {\n-    ClearWrap(object());\n   }\n \n   uv_work_t* work_req() {"
        },
        {
            "sha": "6f34eae35912521c15ee859332cc94e96c0921ef",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -175,7 +175,7 @@ class SecureContext : public BaseObject {\n         ctx_(nullptr),\n         cert_(nullptr),\n         issuer_(nullptr) {\n-    MakeWeak<SecureContext>(this);\n+    MakeWeak();\n     env->isolate()->AdjustAmountOfExternalAllocatedMemory(kExternalSize);\n   }\n \n@@ -403,7 +403,7 @@ class CipherBase : public BaseObject {\n         auth_tag_set_(false),\n         auth_tag_len_(kNoAuthTagLength),\n         pending_auth_failed_(false) {\n-    MakeWeak<CipherBase>(this);\n+    MakeWeak();\n   }\n \n  private:\n@@ -434,7 +434,7 @@ class Hmac : public BaseObject {\n   Hmac(Environment* env, v8::Local<v8::Object> wrap)\n       : BaseObject(env, wrap),\n         ctx_(nullptr) {\n-    MakeWeak<Hmac>(this);\n+    MakeWeak();\n   }\n \n  private:\n@@ -459,7 +459,7 @@ class Hash : public BaseObject {\n       : BaseObject(env, wrap),\n         mdctx_(nullptr),\n         finalized_(false) {\n-    MakeWeak<Hash>(this);\n+    MakeWeak();\n   }\n \n  private:\n@@ -514,7 +514,7 @@ class Sign : public SignBase {\n   static void SignFinal(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n   Sign(Environment* env, v8::Local<v8::Object> wrap) : SignBase(env, wrap) {\n-    MakeWeak<Sign>(this);\n+    MakeWeak();\n   }\n };\n \n@@ -537,7 +537,7 @@ class Verify : public SignBase {\n   static void VerifyFinal(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n   Verify(Environment* env, v8::Local<v8::Object> wrap) : SignBase(env, wrap) {\n-    MakeWeak<Verify>(this);\n+    MakeWeak();\n   }\n };\n \n@@ -605,7 +605,7 @@ class DiffieHellman : public BaseObject {\n         initialised_(false),\n         verifyError_(0),\n         dh(nullptr) {\n-    MakeWeak<DiffieHellman>(this);\n+    MakeWeak();\n   }\n \n  private:\n@@ -641,7 +641,7 @@ class ECDH : public BaseObject {\n       : BaseObject(env, wrap),\n         key_(key),\n         group_(EC_KEY_get0_group(key_)) {\n-    MakeWeak<ECDH>(this);\n+    MakeWeak();\n     CHECK_NE(group_, nullptr);\n   }\n "
        },
        {
            "sha": "97b957eed66b31779b38dc024655a3328dadfee9",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -99,7 +99,7 @@ FileHandle::FileHandle(Environment* env, int fd, Local<Object> obj)\n                 AsyncWrap::PROVIDER_FILEHANDLE),\n       StreamBase(env),\n       fd_(fd) {\n-  MakeWeak<FileHandle>(this);\n+  MakeWeak();\n   v8::PropertyAttribute attr =\n       static_cast<v8::PropertyAttribute>(v8::ReadOnly | v8::DontDelete);\n   object()->DefineOwnProperty(env->context(),"
        },
        {
            "sha": "03e41097d5f12e7ff28c70beeaa3cd4a8e465a19",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -28,11 +28,6 @@ class FSReqBase : public ReqWrap<uv_fs_t> {\n \n   FSReqBase(Environment* env, Local<Object> req, AsyncWrap::ProviderType type)\n       : ReqWrap(env, req, type) {\n-    Wrap(object(), this);\n-  }\n-\n-  virtual ~FSReqBase() {\n-    ClearWrap(object());\n   }\n \n   void Init(const char* syscall,\n@@ -249,10 +244,10 @@ class FileHandle : public AsyncWrap, public StreamBase {\n                   env->fdclose_constructor_template()\n                       ->NewInstance(env->context()).ToLocalChecked(),\n                   AsyncWrap::PROVIDER_FILEHANDLECLOSEREQ) {\n-      Wrap(object(), this);\n       promise_.Reset(env->isolate(), promise);\n       ref_.Reset(env->isolate(), ref);\n     }\n+\n     ~CloseReq() {\n       uv_fs_req_cleanup(req());\n       promise_.Reset();"
        },
        {
            "sha": "3563013da3e089f13ab9c5325123bc8334a634e2",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -244,11 +244,6 @@ Http2Session::Http2Settings::Http2Settings(\n   Init();\n }\n \n-Http2Session::Http2Settings::~Http2Settings() {\n-  if (!object().IsEmpty())\n-    ClearWrap(object());\n-}\n-\n // Generates a Buffer that contains the serialized payload of a SETTINGS\n // frame. This can be used, for instance, to create the Base64-encoded\n // content of an Http2-Settings header field.\n@@ -458,7 +453,7 @@ Http2Session::Http2Session(Environment* env,\n                            nghttp2_session_type type)\n     : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_HTTP2SESSION),\n       session_type_(type) {\n-  MakeWeak<Http2Session>(this);\n+  MakeWeak();\n   statistics_.start_time = uv_hrtime();\n \n   // Capture the configuration options for this session\n@@ -1668,7 +1663,7 @@ Http2Stream::Http2Stream(\n                    session_(session),\n                    id_(id),\n                    current_headers_category_(category) {\n-  MakeWeak<Http2Stream>(this);\n+  MakeWeak();\n   statistics_.start_time = uv_hrtime();\n \n   // Limit the number of header pairs\n@@ -2615,11 +2610,6 @@ Http2Session::Http2Ping::Http2Ping(\n           session_(session),\n           startTime_(uv_hrtime()) { }\n \n-Http2Session::Http2Ping::~Http2Ping() {\n-  if (!object().IsEmpty())\n-    ClearWrap(object());\n-}\n-\n void Http2Session::Http2Ping::Send(uint8_t* payload) {\n   uint8_t data[8];\n   if (payload == nullptr) {"
        },
        {
            "sha": "f4ac926bb544526c3d3523e16bdeb20044c61594",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -1148,7 +1148,6 @@ class Http2StreamPerformanceEntry : public PerformanceEntry {\n class Http2Session::Http2Ping : public AsyncWrap {\n  public:\n   explicit Http2Ping(Http2Session* session);\n-  ~Http2Ping();\n \n   size_t self_size() const override { return sizeof(*this); }\n \n@@ -1169,7 +1168,6 @@ class Http2Session::Http2Settings : public AsyncWrap {\n  public:\n   explicit Http2Settings(Environment* env);\n   explicit Http2Settings(Http2Session* session);\n-  ~Http2Settings();\n \n   size_t self_size() const override { return sizeof(*this); }\n "
        },
        {
            "sha": "d6f9b110c3af345beb32446ae566ca0736147a90",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -151,16 +151,10 @@ class Parser : public AsyncWrap, public StreamListener {\n       : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_HTTPPARSER),\n         current_buffer_len_(0),\n         current_buffer_data_(nullptr) {\n-    Wrap(object(), this);\n     Init(type);\n   }\n \n \n-  ~Parser() override {\n-    ClearWrap(object());\n-  }\n-\n-\n   size_t self_size() const override {\n     return sizeof(*this);\n   }"
        },
        {
            "sha": "5dd30a254ab96979d3d767dd3759e741c327050c",
            "filename": "src/node_i18n.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_i18n.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_i18n.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_i18n.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -259,7 +259,7 @@ class ConverterObject : public BaseObject, Converter {\n                   BaseObject(env, wrap),\n                   Converter(converter, sub),\n                   ignoreBOM_(ignoreBOM) {\n-    MakeWeak<ConverterObject>(this);\n+    MakeWeak();\n \n     switch (ucnv_getType(converter)) {\n       case UCNV_UTF8:"
        },
        {
            "sha": "e5ea575ebc598172572abc337a7045f3ec1237e1",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -244,9 +244,10 @@ v8::Local<v8::Object> AddressToJS(\n \n template <typename T, int (*F)(const typename T::HandleType*, sockaddr*, int*)>\n void GetSockOrPeerName(const v8::FunctionCallbackInfo<v8::Value>& args) {\n-  T* const wrap = Unwrap<T>(args.Holder());\n-  if (wrap == nullptr)\n-    return args.GetReturnValue().Set(UV_EBADF);\n+  T* wrap;\n+  ASSIGN_OR_RETURN_UNWRAP(&wrap,\n+                          args.Holder(),\n+                          args.GetReturnValue().Set(UV_EBADF));\n   CHECK(args[0]->IsObject());\n   sockaddr_storage storage;\n   int addrlen = sizeof(storage);"
        },
        {
            "sha": "520b350199245ab9fea0afe3f654ba4b1241b3a0",
            "filename": "src/node_serdes.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_serdes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_serdes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_serdes.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -86,7 +86,7 @@ class DeserializerContext : public BaseObject,\n SerializerContext::SerializerContext(Environment* env, Local<Object> wrap)\n   : BaseObject(env, wrap),\n     serializer_(env->isolate(), this) {\n-  MakeWeak<SerializerContext>(this);\n+  MakeWeak();\n }\n \n void SerializerContext::ThrowDataCloneError(Local<String> message) {\n@@ -274,7 +274,7 @@ DeserializerContext::DeserializerContext(Environment* env,\n     deserializer_(env->isolate(), data_, length_, this) {\n   object()->Set(env->context(), env->buffer_string(), buffer).FromJust();\n \n-  MakeWeak<DeserializerContext>(this);\n+  MakeWeak();\n }\n \n MaybeLocal<Object> DeserializerContext::ReadHostObject(Isolate* isolate) {"
        },
        {
            "sha": "a2cfb1088c9d254fd73a137bd0f239dc0c3271ed",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -83,8 +83,7 @@ static void Delete(uv_handle_t* handle) {\n StatWatcher::StatWatcher(Environment* env, Local<Object> wrap)\n     : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_STATWATCHER),\n       watcher_(new uv_fs_poll_t) {\n-  MakeWeak<StatWatcher>(this);\n-  Wrap(wrap, this);\n+  MakeWeak();\n   uv_fs_poll_init(env->event_loop(), watcher_);\n   watcher_->data = static_cast<void*>(this);\n }\n@@ -191,7 +190,7 @@ void StatWatcher::Stop(const FunctionCallbackInfo<Value>& args) {\n \n void StatWatcher::Stop() {\n   uv_fs_poll_stop(watcher_);\n-  MakeWeak<StatWatcher>(this);\n+  MakeWeak();\n }\n \n "
        },
        {
            "sha": "0c0699f7be9e1f9bfc4ddf61e014196eae5f13ad",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -37,7 +37,7 @@ class NodeCategorySet : public BaseObject {\n                   Local<Object> wrap,\n                   std::set<std::string> categories) :\n         BaseObject(env, wrap), categories_(categories) {\n-    MakeWeak<NodeCategorySet>(this);\n+    MakeWeak();\n   }\n \n   bool enabled_ = false;"
        },
        {
            "sha": "67cea2e715f8697ab74586893dbc104088cbe067",
            "filename": "src/node_wrap.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_wrap.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -33,6 +33,8 @@\n \n namespace node {\n \n+// TODO(addaleax): Use real inheritance for the JS object templates to avoid\n+// this unnecessary case switching.\n #define WITH_GENERIC_UV_STREAM(env, obj, BODY, ELSE)                          \\\n     do {                                                                      \\\n       if (env->tcp_constructor_template().IsEmpty() == false &&               \\"
        },
        {
            "sha": "ec447638e2ae6292b111b86330f7ba391a07b233",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -89,8 +89,6 @@ class ZCtx : public AsyncWrap {\n         refs_(0),\n         gzip_id_bytes_read_(0),\n         write_result_(nullptr) {\n-    MakeWeak<ZCtx>(this);\n-    Wrap(wrap, this);\n   }\n \n \n@@ -662,7 +660,7 @@ class ZCtx : public AsyncWrap {\n   void Unref() {\n     CHECK_GT(refs_, 0);\n     if (--refs_ == 0) {\n-      MakeWeak<ZCtx>(this);\n+      MakeWeak();\n     }\n   }\n "
        },
        {
            "sha": "da7cb9e3ab55ba6ed98cc60295197d3788b8feff",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -102,12 +102,7 @@ void PipeWrap::Initialize(Local<Object> target,\n   env->set_pipe_constructor_template(t);\n \n   // Create FunctionTemplate for PipeConnectWrap.\n-  auto constructor = [](const FunctionCallbackInfo<Value>& args) {\n-    CHECK(args.IsConstructCall());\n-    ClearWrap(args.This());\n-  };\n-  auto cwt = FunctionTemplate::New(env->isolate(), constructor);\n-  cwt->InstanceTemplate()->SetInternalFieldCount(1);\n+  auto cwt = BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, cwt);\n   Local<String> wrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"PipeConnectWrap\");"
        },
        {
            "sha": "cfe0de0872df4ac51f4d9dc8422ad010245d17fb",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 13,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -243,12 +243,6 @@ SimpleShutdownWrap<OtherBase>::SimpleShutdownWrap(\n     OtherBase(stream->stream_env(),\n               req_wrap_obj,\n               AsyncWrap::PROVIDER_SHUTDOWNWRAP) {\n-  Wrap(req_wrap_obj, static_cast<AsyncWrap*>(this));\n-}\n-\n-template <typename OtherBase>\n-SimpleShutdownWrap<OtherBase>::~SimpleShutdownWrap() {\n-  ClearWrap(static_cast<AsyncWrap*>(this)->object());\n }\n \n inline ShutdownWrap* StreamBase::CreateShutdownWrap(\n@@ -264,12 +258,6 @@ SimpleWriteWrap<OtherBase>::SimpleWriteWrap(\n     OtherBase(stream->stream_env(),\n               req_wrap_obj,\n               AsyncWrap::PROVIDER_WRITEWRAP) {\n-  Wrap(req_wrap_obj, static_cast<AsyncWrap*>(this));\n-}\n-\n-template <typename OtherBase>\n-SimpleWriteWrap<OtherBase>::~SimpleWriteWrap() {\n-  ClearWrap(static_cast<AsyncWrap*>(this)->object());\n }\n \n inline WriteWrap* StreamBase::CreateWriteWrap(\n@@ -460,7 +448,7 @@ inline void StreamReq::ResetObject(v8::Local<v8::Object> obj) {\n #ifdef DEBUG\n   CHECK_GT(obj->InternalFieldCount(), StreamReq::kStreamReqField);\n #endif\n-  ClearWrap(obj);\n+  obj->SetAlignedPointerInInternalField(0, nullptr);  // BaseObject field.\n   obj->SetAlignedPointerInInternalField(StreamReq::kStreamReqField, nullptr);\n }\n "
        },
        {
            "sha": "3708ffe7b65c0d0ed34bba5c4df38c4eb031eded",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -286,12 +286,6 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n   uv_stream_t* send_handle = nullptr;\n \n   if (IsIPCPipe() && !send_handle_obj.IsEmpty()) {\n-    // TODO(addaleax): This relies on the fact that HandleWrap comes first\n-    // as a superclass of each individual subclass.\n-    // There are similar assumptions in other places in the code base.\n-    // A better idea would be having all BaseObject's internal pointers\n-    // refer to the BaseObject* itself; this would require refactoring\n-    // throughout the code base but makes Node rely much less on C++ quirks.\n     HandleWrap* wrap;\n     ASSIGN_OR_RETURN_UNWRAP(&wrap, send_handle_obj, UV_EINVAL);\n     send_handle = reinterpret_cast<uv_stream_t*>(wrap->GetHandle());"
        },
        {
            "sha": "b91cf7df6cf8c416dd84e84d389b0da97854f593",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -350,7 +350,6 @@ class SimpleShutdownWrap : public ShutdownWrap, public OtherBase {\n  public:\n   SimpleShutdownWrap(StreamBase* stream,\n                      v8::Local<v8::Object> req_wrap_obj);\n-  ~SimpleShutdownWrap();\n \n   AsyncWrap* GetAsyncWrap() override { return this; }\n   size_t self_size() const override { return sizeof(*this); }\n@@ -361,7 +360,6 @@ class SimpleWriteWrap : public WriteWrap, public OtherBase {\n  public:\n   SimpleWriteWrap(StreamBase* stream,\n                   v8::Local<v8::Object> req_wrap_obj);\n-  ~SimpleWriteWrap();\n \n   AsyncWrap* GetAsyncWrap() override { return this; }\n   size_t self_size() const override { return sizeof(*this) + StorageSize(); }"
        },
        {
            "sha": "617a0129cfea07b41e521dc1bb99cca9b351b6f5",
            "filename": "src/stream_pipe.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_pipe.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fstream_pipe.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_pipe.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -17,7 +17,7 @@ StreamPipe::StreamPipe(StreamBase* source,\n                        StreamBase* sink,\n                        Local<Object> obj)\n     : AsyncWrap(source->stream_env(), obj, AsyncWrap::PROVIDER_STREAMPIPE) {\n-  MakeWeak(this);\n+  MakeWeak();\n \n   CHECK_NE(sink, nullptr);\n   CHECK_NE(source, nullptr);"
        },
        {
            "sha": "3ccd157159c2874966da9e47115c1f20ab63391f",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -26,7 +26,6 @@\n #include \"handle_wrap.h\"\n #include \"node_buffer.h\"\n #include \"node_internals.h\"\n-#include \"node_wrap.h\"\n #include \"connect_wrap.h\"\n #include \"stream_base-inl.h\"\n #include \"stream_wrap.h\"\n@@ -117,12 +116,8 @@ void TCPWrap::Initialize(Local<Object> target,\n   env->set_tcp_constructor_template(t);\n \n   // Create FunctionTemplate for TCPConnectWrap.\n-  auto constructor = [](const FunctionCallbackInfo<Value>& args) {\n-    CHECK(args.IsConstructCall());\n-    ClearWrap(args.This());\n-  };\n-  auto cwt = FunctionTemplate::New(env->isolate(), constructor);\n-  cwt->InstanceTemplate()->SetInternalFieldCount(1);\n+  Local<FunctionTemplate> cwt =\n+      BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, cwt);\n   Local<String> wrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"TCPConnectWrap\");"
        },
        {
            "sha": "88377a3e1b88cc642a39156c378dd1792311ff4a",
            "filename": "src/timer_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftimer_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftimer_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftimer_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -115,7 +115,8 @@ class TimerWrap : public HandleWrap {\n   }\n \n   static void Start(const FunctionCallbackInfo<Value>& args) {\n-    TimerWrap* wrap = Unwrap<TimerWrap>(args.Holder());\n+    TimerWrap* wrap;\n+    ASSIGN_OR_RETURN_UNWRAP(&wrap, args.Holder());\n \n     CHECK(HandleWrap::IsAlive(wrap));\n \n@@ -125,7 +126,8 @@ class TimerWrap : public HandleWrap {\n   }\n \n   static void Stop(const FunctionCallbackInfo<Value>& args) {\n-    TimerWrap* wrap = Unwrap<TimerWrap>(args.Holder());\n+    TimerWrap* wrap;\n+    ASSIGN_OR_RETURN_UNWRAP(&wrap, args.Holder());\n \n     CHECK(HandleWrap::IsAlive(wrap));\n "
        },
        {
            "sha": "3764e2f3c93d4cbb4723ce83403c57012a7b48fb",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -68,8 +68,7 @@ TLSWrap::TLSWrap(Environment* env,\n       shutdown_(false),\n       cycle_depth_(0),\n       eof_(false) {\n-  node::Wrap(object(), this);\n-  MakeWeak(this);\n+  MakeWeak();\n \n   // sc comes from an Unwrap. Make sure it was assigned.\n   CHECK_NE(sc, nullptr);\n@@ -873,16 +872,9 @@ void TLSWrap::Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"wrap\", TLSWrap::Wrap);\n \n-  auto constructor = [](const FunctionCallbackInfo<Value>& args) {\n-    CHECK(args.IsConstructCall());\n-    args.This()->SetAlignedPointerInInternalField(0, nullptr);\n-  };\n-\n+  Local<FunctionTemplate> t = BaseObject::MakeLazilyInitializedJSTemplate(env);\n   Local<String> tlsWrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"TLSWrap\");\n-\n-  auto t = env->NewFunctionTemplate(constructor);\n-  t->InstanceTemplate()->SetInternalFieldCount(1);\n   t->SetClassName(tlsWrapString);\n \n   Local<FunctionTemplate> get_write_queue_size ="
        },
        {
            "sha": "414fe07eab6da80ba44d1c74f3cd4d17d85cd7ce",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 15,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -53,7 +53,6 @@ using AsyncHooks = Environment::AsyncHooks;\n class SendWrap : public ReqWrap<uv_udp_send_t> {\n  public:\n   SendWrap(Environment* env, Local<Object> req_wrap_obj, bool have_callback);\n-  ~SendWrap();\n   inline bool have_callback() const;\n   size_t msg_size;\n   size_t self_size() const override { return sizeof(*this); }\n@@ -67,12 +66,6 @@ SendWrap::SendWrap(Environment* env,\n                    bool have_callback)\n     : ReqWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_UDPSENDWRAP),\n       have_callback_(have_callback) {\n-  Wrap(req_wrap_obj, this);\n-}\n-\n-\n-SendWrap::~SendWrap() {\n-  ClearWrap(object());\n }\n \n \n@@ -81,12 +74,6 @@ inline bool SendWrap::have_callback() const {\n }\n \n \n-static void NewSendWrap(const FunctionCallbackInfo<Value>& args) {\n-  CHECK(args.IsConstructCall());\n-  ClearWrap(args.This());\n-}\n-\n-\n UDPWrap::UDPWrap(Environment* env, Local<Object> object)\n     : HandleWrap(env,\n                  object,\n@@ -153,8 +140,7 @@ void UDPWrap::Initialize(Local<Object> target,\n \n   // Create FunctionTemplate for SendWrap\n   Local<FunctionTemplate> swt =\n-      FunctionTemplate::New(env->isolate(), NewSendWrap);\n-  swt->InstanceTemplate()->SetInternalFieldCount(1);\n+      BaseObject::MakeLazilyInitializedJSTemplate(env);\n   AsyncWrap::AddWrapMethods(env, swt);\n   Local<String> sendWrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"SendWrap\");"
        },
        {
            "sha": "41a22c97efd9c09472246c54c6cf1a35decba5e4",
            "filename": "src/util-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Futil-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Futil-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil-inl.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -217,25 +217,6 @@ inline v8::Local<v8::String> OneByteString(v8::Isolate* isolate,\n                                     length).ToLocalChecked();\n }\n \n-template <typename TypeName>\n-void Wrap(v8::Local<v8::Object> object, TypeName* pointer) {\n-  CHECK_EQ(false, object.IsEmpty());\n-  CHECK_GT(object->InternalFieldCount(), 0);\n-  object->SetAlignedPointerInInternalField(0, pointer);\n-}\n-\n-void ClearWrap(v8::Local<v8::Object> object) {\n-  Wrap<void>(object, nullptr);\n-}\n-\n-template <typename TypeName>\n-TypeName* Unwrap(v8::Local<v8::Object> object) {\n-  CHECK_EQ(false, object.IsEmpty());\n-  CHECK_GT(object->InternalFieldCount(), 0);\n-  void* pointer = object->GetAlignedPointerFromInternalField(0);\n-  return static_cast<TypeName*>(pointer);\n-}\n-\n void SwapBytes16(char* data, size_t nbytes) {\n   CHECK_EQ(nbytes % 2, 0);\n "
        },
        {
            "sha": "133899008fb7cef1a22084b4fb8cb269eb4c331b",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -35,7 +35,6 @@\n #include <string.h>\n \n #include <functional>  // std::function\n-#include <type_traits>  // std::remove_reference\n \n namespace node {\n \n@@ -84,8 +83,6 @@ NO_RETURN void Abort();\n NO_RETURN void Assert(const char* const (*args)[4]);\n void DumpBacktrace(FILE* fp);\n \n-template <typename T> using remove_reference = std::remove_reference<T>;\n-\n #define FIXED_ONE_BYTE_STRING(isolate, string)                                \\\n   (node::OneByteString((isolate), (string), sizeof(string) - 1))\n \n@@ -135,14 +132,6 @@ template <typename T> using remove_reference = std::remove_reference<T>;\n \n #define UNREACHABLE() ABORT()\n \n-#define ASSIGN_OR_RETURN_UNWRAP(ptr, obj, ...)                                \\\n-  do {                                                                        \\\n-    *ptr =                                                                    \\\n-        Unwrap<typename node::remove_reference<decltype(**ptr)>::type>(obj);  \\\n-    if (*ptr == nullptr)                                                      \\\n-      return __VA_ARGS__;                                                     \\\n-  } while (0)\n-\n // TAILQ-style intrusive list node.\n template <typename T>\n class ListNode;\n@@ -250,13 +239,6 @@ inline v8::Local<v8::String> OneByteString(v8::Isolate* isolate,\n                                            const unsigned char* data,\n                                            int length = -1);\n \n-inline void Wrap(v8::Local<v8::Object> object, void* pointer);\n-\n-inline void ClearWrap(v8::Local<v8::Object> object);\n-\n-template <typename TypeName>\n-inline TypeName* Unwrap(v8::Local<v8::Object> object);\n-\n // Swaps bytes in place. nbytes is the number of bytes to swap and must be a\n // multiple of the word size (checked by function).\n inline void SwapBytes16(char* data, size_t nbytes);"
        },
        {
            "sha": "f69df3ed227717475af4b610381e71a2830b79b9",
            "filename": "test/cctest/test_node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/bd201102862a194f3f5ce669e0a3c8143eafc900/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd201102862a194f3f5ce669e0a3c8143eafc900/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_node_postmortem_metadata.cc?ref=bd201102862a194f3f5ce669e0a3c8143eafc900",
            "patch": "@@ -72,7 +72,11 @@ TEST_F(DebugSymbolsTest, BaseObjectPersistentHandle) {\n   const Argv argv;\n   Env env{handle_scope, argv};\n \n-  v8::Local<v8::Object> object = v8::Object::New(isolate_);\n+  v8::Local<v8::ObjectTemplate> obj_templ = v8::ObjectTemplate::New(isolate_);\n+  obj_templ->SetInternalFieldCount(1);\n+\n+  v8::Local<v8::Object> object =\n+      obj_templ->NewInstance(env.context()).ToLocalChecked();\n   node::BaseObject obj(*env, object);\n \n   auto expected = reinterpret_cast<uintptr_t>(&obj.persistent());"
        }
    ],
    "stats": {
        "total": 391,
        "additions": 147,
        "deletions": 244
    }
}