{
    "author": "mscdex",
    "message": "tls: throw error on bad ciphers option\n\nPR-URL: https://github.com/nodejs/node/pull/21557\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d",
    "files": [
        {
            "sha": "31abeec6f3d7d8eb9e433326d8c2054b8cfb188a",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d",
            "patch": "@@ -904,7 +904,13 @@ void SecureContext::SetCiphers(const FunctionCallbackInfo<Value>& args) {\n   THROW_AND_RETURN_IF_NOT_STRING(env, args[0], \"Ciphers\");\n \n   const node::Utf8Value ciphers(args.GetIsolate(), args[0]);\n-  SSL_CTX_set_cipher_list(sc->ctx_.get(), *ciphers);\n+  if (!SSL_CTX_set_cipher_list(sc->ctx_.get(), *ciphers)) {\n+    unsigned long err = ERR_get_error();  // NOLINT(runtime/int)\n+    if (!err) {\n+      return env->ThrowError(\"Failed to set ciphers\");\n+    }\n+    return ThrowCryptoError(env, err);\n+  }\n }\n \n "
        },
        {
            "sha": "2aef1adcc38c1fb1ddda83d25ff1f469ad9f51d2",
            "filename": "test/parallel/test-tls-handshake-error.js",
            "status": "modified",
            "additions": 7,
            "deletions": 12,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fparallel%2Ftest-tls-handshake-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fparallel%2Ftest-tls-handshake-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-handshake-error.js?ref=a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d",
            "patch": "@@ -16,17 +16,12 @@ const server = tls.createServer({\n   rejectUnauthorized: true\n }, function(c) {\n }).listen(0, common.mustCall(function() {\n-  const c = tls.connect({\n-    port: this.address().port,\n-    ciphers: 'RC4'\n-  }, common.mustNotCall());\n+  assert.throws(() => {\n+    tls.connect({\n+      port: this.address().port,\n+      ciphers: 'RC4'\n+    }, common.mustNotCall());\n+  }, /no cipher match/i);\n \n-  c.on('error', common.mustCall(function(err) {\n-    assert.notStrictEqual(err.code, 'ECONNRESET');\n-  }));\n-\n-  c.on('close', common.mustCall(function(err) {\n-    assert.ok(err);\n-    server.close();\n-  }));\n+  server.close();\n }));"
        },
        {
            "sha": "5ef08dda041f010016fb1220f1dc7336bfb1571e",
            "filename": "test/parallel/test-tls-set-ciphers-error.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fparallel%2Ftest-tls-set-ciphers-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fparallel%2Ftest-tls-set-ciphers-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-set-ciphers-error.js?ref=a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+const common = require('../common');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const tls = require('tls');\n+const fixtures = require('../common/fixtures');\n+\n+{\n+  const options = {\n+    key: fixtures.readKey('agent2-key.pem'),\n+    cert: fixtures.readKey('agent2-cert.pem'),\n+    ciphers: 'aes256-sha'\n+  };\n+  assert.throws(() => tls.createServer(options, common.mustNotCall()),\n+                /no cipher match/i);\n+  options.ciphers = 'FOOBARBAZ';\n+  assert.throws(() => tls.createServer(options, common.mustNotCall()),\n+                /no cipher match/i);\n+}"
        },
        {
            "sha": "291747aea77b49e8daef4eaf4abbc386bbbba8dd",
            "filename": "test/sequential/test-tls-connect.js",
            "status": "modified",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fsequential%2Ftest-tls-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d/test%2Fsequential%2Ftest-tls-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-tls-connect.js?ref=a15ea5d7ca1cf0f48ce1f2be62b1cd446a50b06d",
            "patch": "@@ -50,15 +50,12 @@ const tls = require('tls');\n   const cert = fixtures.readSync('test_cert.pem');\n   const key = fixtures.readSync('test_key.pem');\n \n-  const conn = tls.connect({\n-    cert: cert,\n-    key: key,\n-    port: common.PORT,\n-    ciphers: 'rick-128-roll'\n-  }, common.mustNotCall());\n-\n-  conn.on(\n-    'error',\n-    common.mustCall((e) => { assert.strictEqual(e.code, 'ECONNREFUSED'); })\n-  );\n+  assert.throws(() => {\n+    tls.connect({\n+      cert: cert,\n+      key: key,\n+      port: common.PORT,\n+      ciphers: 'rick-128-roll'\n+    }, common.mustNotCall());\n+  }, /no cipher match/i);\n }"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 44,
        "deletions": 24
    }
}