{
    "author": "RomainLanz",
    "message": "src: refactor deprecated v8::String::NewFromTwoByte call\n\nPR-URL: https://github.com/nodejs/node/pull/23803\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "added1b0c5ad82ed47921bea00f05aad85548a62",
    "files": [
        {
            "sha": "600f85b8044671420c464808c5ef17667e1b0de7",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/added1b0c5ad82ed47921bea00f05aad85548a62/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/added1b0c5ad82ed47921bea00f05aad85548a62/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=added1b0c5ad82ed47921bea00f05aad85548a62",
            "patch": "@@ -1,5 +1,6 @@\n #include \"node.h\"\n #include \"node_internals.h\"\n+#include \"node_errors.h\"\n #include \"base_object.h\"\n #include \"base_object-inl.h\"\n #include \"env-inl.h\"\n@@ -626,8 +627,13 @@ void EnvGetter(Local<Name> property,\n   if ((result > 0 || GetLastError() == ERROR_SUCCESS) &&\n       result < arraysize(buffer)) {\n     const uint16_t* two_byte_buffer = reinterpret_cast<const uint16_t*>(buffer);\n-    Local<String> rc = String::NewFromTwoByte(isolate, two_byte_buffer);\n-    return info.GetReturnValue().Set(rc);\n+    v8::MaybeLocal<String> rc = String::NewFromTwoByte(\n+        isolate, two_byte_buffer, v8::NewStringType::kNormal);\n+    if (rc.IsEmpty()) {\n+      isolate->ThrowException(ERR_STRING_TOO_LONG(isolate));\n+      return;\n+    }\n+    return info.GetReturnValue().Set(rc.ToLocalChecked());\n   }\n #endif\n }\n@@ -768,10 +774,17 @@ void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n     }\n     const uint16_t* two_byte_buffer = reinterpret_cast<const uint16_t*>(p);\n     const size_t two_byte_buffer_len = s - p;\n-    argv[idx] = String::NewFromTwoByte(isolate,\n-                                       two_byte_buffer,\n-                                       String::kNormalString,\n-                                       two_byte_buffer_len);\n+    v8::MaybeLocal<String> rc =\n+        String::NewFromTwoByte(isolate,\n+                               two_byte_buffer,\n+                               v8::NewStringType::kNormal,\n+                               two_byte_buffer_len);\n+    if (rc.IsEmpty()) {\n+      isolate->ThrowException(ERR_STRING_TOO_LONG(isolate));\n+      FreeEnvironmentStringsW(environment);\n+      return;\n+    }\n+    argv[idx] = rc.ToLocalChecked();\n     if (++idx >= arraysize(argv)) {\n       fn->Call(ctx, envarr, idx, argv).ToLocalChecked();\n       idx = 0;"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
    }
}