{
    "author": "yhwang",
    "message": "test: shared lib build doesn't handle SIGPIPE\n\nFor shared lib build, we leave the signal handling for embedding users.\nIn these two test cases:\n- `parallel/test-process-external-stdio-close-spawn`\n- `parallel/test-process-external-stdio-close`\n\nThe pipe is used for stdout and is destroied before child process uses\nit for logging. So the node executble that uses shared lib build\nreceives SIGPIPE and the child process ends.\n\nThis change ignores the SIGPIPE in node_main.cc for shared lib case.\n\nRefs: https://github.com/nodejs/node/issues/18535\n\nSigned-off-by: Yihong Wang <yh.wang@ibm.com>\n\nPR-URL: https://github.com/nodejs/node/pull/19211\nRefs: https://github.com/nodejs/node/issues/18535\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>",
    "sha": "ffd618bd5cde77e19ab6458eaf454c4df71dd638",
    "files": [
        {
            "sha": "5efe2323599cff61cb7e2edad17385e9b00bd10c",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 3,
            "deletions": 17,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/ffd618bd5cde77e19ab6458eaf454c4df71dd638/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/ffd618bd5cde77e19ab6458eaf454c4df71dd638/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=ffd618bd5cde77e19ab6458eaf454c4df71dd638",
            "patch": "@@ -203,6 +203,9 @@\n       'sources': [\n         'src/node_main.cc'\n       ],\n+      'includes': [\n+        'node.gypi'\n+      ],\n       'include_dirs': [\n         'src',\n         'deps/v8/include',\n@@ -220,9 +223,6 @@\n         }],\n         [ 'node_intermediate_lib_type==\"static_library\" and '\n             'node_shared==\"false\"', {\n-          'includes': [\n-            'node.gypi'\n-          ],\n           'xcode_settings': {\n             'OTHER_LDFLAGS': [\n               '-Wl,-force_load,<(PRODUCT_DIR)/<(STATIC_LIB_PREFIX)'\n@@ -469,22 +469,8 @@\n               ],\n             }],\n           ],\n-          'defines!': [\n-            'NODE_PLATFORM=\"win\"',\n-          ],\n-          'defines': [\n-            'FD_SETSIZE=1024',\n-            # we need to use node's preferred \"win32\" rather than gyp's preferred \"win\"\n-            'NODE_PLATFORM=\"win32\"',\n-            # Stop <windows.h> from defining macros that conflict with\n-            # std::min() and std::max().  We don't use <windows.h> (much)\n-            # but we still inherit it from uv.h.\n-            'NOMINMAX',\n-            '_UNICODE=1',\n-          ],\n           'libraries': [ '-lpsapi.lib' ]\n         }, { # POSIX\n-          'defines': [ '__POSIX__' ],\n           'sources': [ 'src/backtrace_posix.cc' ],\n         }],\n         [ 'node_use_etw==\"true\"', {"
        },
        {
            "sha": "ac043dac2423ca0d36f586a0af01d4c296a01104",
            "filename": "node.gypi",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/ffd618bd5cde77e19ab6458eaf454c4df71dd638/node.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/ffd618bd5cde77e19ab6458eaf454c4df71dd638/node.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gypi?ref=ffd618bd5cde77e19ab6458eaf454c4df71dd638",
            "patch": "@@ -37,6 +37,24 @@\n         'NODE_SHARED_MODE',\n       ],\n     }],\n+    [ 'OS==\"win\"', {\n+      'defines!': [\n+        'NODE_PLATFORM=\"win\"',\n+      ],\n+      'defines': [\n+        'FD_SETSIZE=1024',\n+        # we need to use node's preferred \"win32\" rather than gyp's preferred \"win\"\n+        'NODE_PLATFORM=\"win32\"',\n+        # Stop <windows.h> from defining macros that conflict with\n+        # std::min() and std::max().  We don't use <windows.h> (much)\n+        # but we still inherit it from uv.h.\n+        'NOMINMAX',\n+        '_UNICODE=1',\n+      ],\n+    }, { # POSIX\n+      'defines': [ '__POSIX__' ],\n+    }],\n+\n     [ 'node_enable_d8==\"true\"', {\n       'dependencies': [ 'deps/v8/src/d8.gyp:d8' ],\n     }],"
        },
        {
            "sha": "8907c47ae0ea4c868c2ddb965a1c772def010aaf",
            "filename": "src/node_main.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/ffd618bd5cde77e19ab6458eaf454c4df71dd638/src%2Fnode_main.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ffd618bd5cde77e19ab6458eaf454c4df71dd638/src%2Fnode_main.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_main.cc?ref=ffd618bd5cde77e19ab6458eaf454c4df71dd638",
            "patch": "@@ -82,12 +82,30 @@ int wmain(int argc, wchar_t *wargv[]) {\n #endif  // __LP64__\n extern char** environ;\n #endif  // __linux__\n+#if defined(__POSIX__) && defined(NODE_SHARED_MODE)\n+#include <string.h>\n+#include <signal.h>\n+#endif\n \n namespace node {\n   extern bool linux_at_secure;\n }  // namespace node\n \n int main(int argc, char *argv[]) {\n+#if defined(__POSIX__) && defined(NODE_SHARED_MODE)\n+  // In node::PlatformInit(), we squash all signal handlers for non-shared lib\n+  // build. In order to run test cases against shared lib build, we also need\n+  // to do the same thing for shared lib build here, but only for SIGPIPE for\n+  // now. If node::PlatformInit() is moved to here, then this section could be\n+  // removed.\n+  {\n+    struct sigaction act;\n+    memset(&act, 0, sizeof(act));\n+    act.sa_handler = SIG_IGN;\n+    sigaction(SIGPIPE, &act, nullptr);\n+  }\n+#endif\n+\n #if defined(__linux__)\n   char** envp = environ;\n   while (*envp++ != nullptr) {}"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 39,
        "deletions": 17
    }
}