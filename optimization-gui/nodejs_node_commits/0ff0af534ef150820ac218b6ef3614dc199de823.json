{
    "author": "addaleax",
    "message": "worker: throw for duplicates in transfer list\n\nThrow a `DataCloneError` exception when encountering duplicate\n`ArrayBuffer`s or `MessagePort`s in the transfer list.\n\nFixes: https://github.com/nodejs/node/issues/25786\n\nPR-URL: https://github.com/nodejs/node/pull/25815\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "0ff0af534ef150820ac218b6ef3614dc199de823",
    "files": [
        {
            "sha": "6e8e3e8ad76e033613d51b9ed7961200f4db301f",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/0ff0af534ef150820ac218b6ef3614dc199de823/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ff0af534ef150820ac218b6ef3614dc199de823/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=0ff0af534ef150820ac218b6ef3614dc199de823",
            "patch": "@@ -289,6 +289,15 @@ Maybe<bool> Message::Serialize(Environment* env,\n         // take ownership of its memory, copying the buffer will have to do.\n         if (!ab->IsNeuterable() || ab->IsExternal())\n           continue;\n+        if (std::find(array_buffers.begin(), array_buffers.end(), ab) !=\n+            array_buffers.end()) {\n+          ThrowDataCloneException(\n+              env,\n+              FIXED_ONE_BYTE_STRING(\n+                  env->isolate(),\n+                  \"Transfer list contains duplicate ArrayBuffer\"));\n+          return Nothing<bool>();\n+        }\n         // We simply use the array index in the `array_buffers` list as the\n         // ID that we write into the serialized buffer.\n         uint32_t id = array_buffers.size();\n@@ -314,6 +323,15 @@ Maybe<bool> Message::Serialize(Environment* env,\n                   \"MessagePort in transfer list is already detached\"));\n           return Nothing<bool>();\n         }\n+        if (std::find(delegate.ports_.begin(), delegate.ports_.end(), port) !=\n+            delegate.ports_.end()) {\n+          ThrowDataCloneException(\n+              env,\n+              FIXED_ONE_BYTE_STRING(\n+                  env->isolate(),\n+                  \"Transfer list contains duplicate MessagePort\"));\n+          return Nothing<bool>();\n+        }\n         delegate.ports_.push_back(port);\n         continue;\n       }\n@@ -601,6 +619,7 @@ void MessagePort::OnClose() {\n }\n \n std::unique_ptr<MessagePortData> MessagePort::Detach() {\n+  CHECK(data_);\n   Mutex::ScopedLock lock(data_->mutex_);\n   data_->owner_ = nullptr;\n   return std::move(data_);"
        },
        {
            "sha": "c893556d8d2c4887d838d5ac3ad504667cfd38fc",
            "filename": "test/parallel/test-worker-message-port-transfer-duplicate.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/0ff0af534ef150820ac218b6ef3614dc199de823/test%2Fparallel%2Ftest-worker-message-port-transfer-duplicate.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ff0af534ef150820ac218b6ef3614dc199de823/test%2Fparallel%2Ftest-worker-message-port-transfer-duplicate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-transfer-duplicate.js?ref=0ff0af534ef150820ac218b6ef3614dc199de823",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { MessageChannel } = require('worker_threads');\n+\n+// Test that passing duplicate transferrables in the transfer list throws\n+// DataCloneError exceptions.\n+\n+{\n+  const { port1, port2 } = new MessageChannel();\n+  port2.once('message', common.mustNotCall());\n+\n+  const port3 = new MessageChannel().port1;\n+  assert.throws(() => {\n+    port1.postMessage(port3, [port3, port3]);\n+  }, /^DataCloneError: Transfer list contains duplicate MessagePort$/);\n+  port1.close();\n+}\n+\n+{\n+  const { port1, port2 } = new MessageChannel();\n+  port2.once('message', common.mustNotCall());\n+\n+  const buf = new Uint8Array(10);\n+  assert.throws(() => {\n+    port1.postMessage(buf, [buf.buffer, buf.buffer]);\n+  }, /^DataCloneError: Transfer list contains duplicate ArrayBuffer$/);\n+  port1.close();\n+}"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 48,
        "deletions": 0
    }
}