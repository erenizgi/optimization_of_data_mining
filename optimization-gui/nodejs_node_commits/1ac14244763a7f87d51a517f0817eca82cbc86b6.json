{
    "author": "addaleax",
    "message": "http: align parser with StreamBase interface changes\n\nThe `StreamBase` interface changed, so that `OnStreamRead()`\nand `OnStreamAlloc()` are not guaranteed to be emitted in the\nsame tick any more.\n\nThis means that, while it isn’t causing any trouble right now,\nwe should not assume that it’s safe to return a static buffer\nin the HTTP parser’s `OnStreamAlloc()` method.\n\nPR-URL: https://github.com/nodejs/node/pull/18936\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "1ac14244763a7f87d51a517f0817eca82cbc86b6",
    "files": [
        {
            "sha": "3fe57f808cfec7d926dc44074a5279cf9fe19348",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=1ac14244763a7f87d51a517f0817eca82cbc86b6",
            "patch": "@@ -469,6 +469,14 @@ inline void Environment::set_http_parser_buffer(char* buffer) {\n   http_parser_buffer_ = buffer;\n }\n \n+inline bool Environment::http_parser_buffer_in_use() const {\n+  return http_parser_buffer_in_use_;\n+}\n+\n+inline void Environment::set_http_parser_buffer_in_use(bool in_use) {\n+  http_parser_buffer_in_use_ = in_use;\n+}\n+\n inline http2::http2_state* Environment::http2_state() const {\n   return http2_state_.get();\n }"
        },
        {
            "sha": "4b874677935edbfe9db228c7ada2d925c0b2defc",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=1ac14244763a7f87d51a517f0817eca82cbc86b6",
            "patch": "@@ -646,6 +646,8 @@ class Environment {\n \n   inline char* http_parser_buffer() const;\n   inline void set_http_parser_buffer(char* buffer);\n+  inline bool http_parser_buffer_in_use() const;\n+  inline void set_http_parser_buffer_in_use(bool in_use);\n \n   inline http2::http2_state* http2_state() const;\n   inline void set_http2_state(std::unique_ptr<http2::http2_state> state);\n@@ -828,6 +830,7 @@ class Environment {\n   double* heap_space_statistics_buffer_ = nullptr;\n \n   char* http_parser_buffer_;\n+  bool http_parser_buffer_in_use_ = false;\n   std::unique_ptr<http2::http2_state> http2_state_;\n \n   // stat fields contains twice the number of entries because `fs.StatWatcher`"
        },
        {
            "sha": "8ab13e073409299f978812fa45f12d2279ece27c",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=1ac14244763a7f87d51a517f0817eca82cbc86b6",
            "patch": "@@ -525,6 +525,14 @@ class Parser : public AsyncWrap, public StreamListener {\n   static const size_t kAllocBufferSize = 64 * 1024;\n \n   uv_buf_t OnStreamAlloc(size_t suggested_size) override {\n+    // For most types of streams, OnStreamRead will be immediately after\n+    // OnStreamAlloc, and will consume all data, so using a static buffer for\n+    // reading is more efficient. For other streams, just use the default\n+    // allocator, which uses Malloc().\n+    if (env()->http_parser_buffer_in_use())\n+      return StreamListener::OnStreamAlloc(suggested_size);\n+    env()->set_http_parser_buffer_in_use(true);\n+\n     if (env()->http_parser_buffer() == nullptr)\n       env()->set_http_parser_buffer(new char[kAllocBufferSize]);\n \n@@ -534,6 +542,15 @@ class Parser : public AsyncWrap, public StreamListener {\n \n   void OnStreamRead(ssize_t nread, const uv_buf_t& buf) override {\n     HandleScope scope(env()->isolate());\n+    // Once we’re done here, either indicate that the HTTP parser buffer\n+    // is free for re-use, or free() the data if it didn’t come from there\n+    // in the first place.\n+    OnScopeLeave on_scope_leave([&]() {\n+      if (buf.base == env()->http_parser_buffer())\n+        env()->set_http_parser_buffer_in_use(false);\n+      else\n+        free(buf.base);\n+    });\n \n     if (nread < 0) {\n       PassReadErrorToPreviousListener(nread);"
        },
        {
            "sha": "e871fc63a5c46a22641c7f932a0fb4140038e7a4",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/1ac14244763a7f87d51a517f0817eca82cbc86b6/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=1ac14244763a7f87d51a517f0817eca82cbc86b6",
            "patch": "@@ -436,6 +436,14 @@ class BufferValue : public MaybeStackBuffer<char> {\n template <typename T> inline void USE(T&&) {}\n }  // namespace node\n \n+// Run a function when exiting the current scope.\n+struct OnScopeLeave {\n+  std::function<void()> fn_;\n+\n+  explicit OnScopeLeave(std::function<void()> fn) : fn_(fn) {}\n+  ~OnScopeLeave() { fn_(); }\n+};\n+\n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #endif  // SRC_UTIL_H_"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 36,
        "deletions": 0
    }
}