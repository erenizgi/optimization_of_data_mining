{
    "author": "addaleax",
    "message": "http2: send error text in case of ALPN mismatch\n\nSend a human-readable HTTP/1 response in case of an unexpected\nALPN protocol. This helps with debugging this condition,\nsince previously the only result of it would be a closed socket.\n\nPR-URL: https://github.com/nodejs/node/pull/18986\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "d1bc6f0780c272cfea520c5df66fc4edb7122841",
    "files": [
        {
            "sha": "42a95903107307ad348b9b745ca2e4e498574ad8",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/d1bc6f0780c272cfea520c5df66fc4edb7122841/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1bc6f0780c272cfea520c5df66fc4edb7122841/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=d1bc6f0780c272cfea520c5df66fc4edb7122841",
            "patch": "@@ -2499,8 +2499,17 @@ function connectionListener(socket) {\n       return httpConnectionListener.call(this, socket);\n     }\n     // Let event handler deal with the socket\n-    if (!this.emit('unknownProtocol', socket))\n-      socket.destroy();\n+    debug(`Unknown protocol from ${socket.remoteAddress}:${socket.remotePort}`);\n+    if (!this.emit('unknownProtocol', socket)) {\n+      // We don't know what to do, so let's just tell the other side what's\n+      // going on in a format that they *might* understand.\n+      socket.end('HTTP/1.0 403 Forbidden\\r\\n' +\n+                 'Content-Type: text/plain\\r\\n\\r\\n' +\n+                 'Unknown ALPN Protocol, expected `h2` to be available.\\n' +\n+                 'If this is a HTTP request: The server was not ' +\n+                 'configured with the `allowHTTP1` option or a ' +\n+                 'listener for the `unknownProtocol` event.\\n');\n+    }\n     return;\n   }\n "
        },
        {
            "sha": "5d9a7e17103e56c7b2e375af19093db2b82a0692",
            "filename": "test/parallel/test-http2-https-fallback.js",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/d1bc6f0780c272cfea520c5df66fc4edb7122841/test%2Fparallel%2Ftest-http2-https-fallback.js",
            "raw_url": "https://github.com/nodejs/node/raw/d1bc6f0780c272cfea520c5df66fc4edb7122841/test%2Fparallel%2Ftest-http2-https-fallback.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-https-fallback.js?ref=d1bc6f0780c272cfea520c5df66fc4edb7122841",
            "patch": "@@ -6,7 +6,7 @@ const fixtures = require('../common/fixtures');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n-const { strictEqual } = require('assert');\n+const { strictEqual, ok } = require('assert');\n const { createSecureContext } = require('tls');\n const { createSecureServer, connect } = require('http2');\n const { get } = require('https');\n@@ -131,10 +131,17 @@ function onSession(session) {\n \n     // HTTP/1.1 client\n     get(Object.assign(parse(origin), clientOptions), common.mustNotCall())\n-      .on('error', common.mustCall(cleanup));\n+      .on('error', common.mustCall(cleanup))\n+      .end();\n \n     // Incompatible ALPN TLS client\n+    let text = '';\n     tls(Object.assign({ port, ALPNProtocols: ['fake'] }, clientOptions))\n-      .on('error', common.mustCall(cleanup));\n+      .setEncoding('utf8')\n+      .on('data', (chunk) => text += chunk)\n+      .on('end', common.mustCall(() => {\n+        ok(/Unknown ALPN Protocol, expected `h2` to be available/.test(text));\n+        cleanup();\n+      }));\n   }));\n }"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 21,
        "deletions": 5
    }
}