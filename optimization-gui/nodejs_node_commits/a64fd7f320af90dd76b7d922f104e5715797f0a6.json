{
    "author": "targos",
    "message": "src: use String::Write{OneByte,Utf8} with isolate\n\nPR-URL: https://github.com/nodejs/node/pull/22531\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a64fd7f320af90dd76b7d922f104e5715797f0a6",
    "files": [
        {
            "sha": "2c8fc7231f8daa28bb5ae5a7f146a8002a7035ce",
            "filename": "benchmark/napi/function_args/binding.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/benchmark%2Fnapi%2Ffunction_args%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/benchmark%2Fnapi%2Ffunction_args%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnapi%2Ffunction_args%2Fbinding.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -21,7 +21,7 @@ void CallWithString(const FunctionCallbackInfo<Value>& args) {\n     Local<String> str = args[0].As<String>();\n     const int32_t length = str->Utf8Length() + 1;\n     char* buf = new char[length];\n-    str->WriteUtf8(buf, length);\n+    str->WriteUtf8(args.GetIsolate(), buf, length);\n     delete [] buf;\n   }\n }"
        },
        {
            "sha": "8ccadab3061cd70bab981ebd328446b33c654905",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -2362,9 +2362,12 @@ napi_status napi_get_value_string_latin1(napi_env env,\n     CHECK_ARG(env, result);\n     *result = val.As<v8::String>()->Length();\n   } else {\n-    int copied = val.As<v8::String>()->WriteOneByte(\n-      reinterpret_cast<uint8_t*>(buf), 0, bufsize - 1,\n-      v8::String::NO_NULL_TERMINATION);\n+    int copied =\n+        val.As<v8::String>()->WriteOneByte(env->isolate,\n+                                           reinterpret_cast<uint8_t*>(buf),\n+                                           0,\n+                                           bufsize - 1,\n+                                           v8::String::NO_NULL_TERMINATION);\n \n     buf[copied] = '\\0';\n     if (result != nullptr) {\n@@ -2399,8 +2402,11 @@ napi_status napi_get_value_string_utf8(napi_env env,\n     *result = val.As<v8::String>()->Utf8Length();\n   } else {\n     int copied = val.As<v8::String>()->WriteUtf8(\n-      buf, bufsize - 1, nullptr, v8::String::REPLACE_INVALID_UTF8 |\n-      v8::String::NO_NULL_TERMINATION);\n+        env->isolate,\n+        buf,\n+        bufsize - 1,\n+        nullptr,\n+        v8::String::REPLACE_INVALID_UTF8 | v8::String::NO_NULL_TERMINATION);\n \n     buf[copied] = '\\0';\n     if (result != nullptr) {\n@@ -2435,9 +2441,11 @@ napi_status napi_get_value_string_utf16(napi_env env,\n     // V8 assumes UTF-16 length is the same as the number of characters.\n     *result = val.As<v8::String>()->Length();\n   } else {\n-    int copied = val.As<v8::String>()->Write(\n-      reinterpret_cast<uint16_t*>(buf), 0, bufsize - 1,\n-      v8::String::NO_NULL_TERMINATION);\n+    int copied = val.As<v8::String>()->Write(env->isolate,\n+                                             reinterpret_cast<uint16_t*>(buf),\n+                                             0,\n+                                             bufsize - 1,\n+                                             v8::String::NO_NULL_TERMINATION);\n \n     buf[copied] = '\\0';\n     if (result != nullptr) {"
        },
        {
            "sha": "95ffaa1993fb95a92c725424766d92c55f0a3027",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 14,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -806,15 +806,16 @@ int64_t IndexOfOffset(size_t length,\n }\n \n void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n+\n   CHECK(args[1]->IsString());\n   CHECK(args[2]->IsNumber());\n   CHECK(args[4]->IsBoolean());\n \n-  enum encoding enc = ParseEncoding(args.GetIsolate(),\n-                                    args[3],\n-                                    UTF8);\n+  enum encoding enc = ParseEncoding(isolate, args[3], UTF8);\n \n-  THROW_AND_RETURN_UNLESS_BUFFER(Environment::GetCurrent(args), args[0]);\n+  THROW_AND_RETURN_UNLESS_BUFFER(env, args[0]);\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n \n   Local<String> needle = args[1].As<String>();\n@@ -826,8 +827,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n   const size_t haystack_length = (enc == UCS2) ?\n       ts_obj_length &~ 1 : ts_obj_length;  // NOLINT(whitespace/operators)\n \n-  const size_t needle_length =\n-      StringBytes::Size(args.GetIsolate(), needle, enc);\n+  const size_t needle_length = StringBytes::Size(isolate, needle, enc);\n \n   int64_t opt_offset = IndexOfOffset(haystack_length,\n                                      offset_i64,\n@@ -857,7 +857,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n   size_t result = haystack_length;\n \n   if (enc == UCS2) {\n-    String::Value needle_value(args.GetIsolate(), needle);\n+    String::Value needle_value(isolate, needle);\n     if (*needle_value == nullptr)\n       return args.GetReturnValue().Set(-1);\n \n@@ -867,7 +867,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n \n     if (IsBigEndian()) {\n       StringBytes::InlineDecoder decoder;\n-      decoder.Decode(Environment::GetCurrent(args), needle, args[3], UCS2);\n+      decoder.Decode(env, needle, args[3], UCS2);\n       const uint16_t* decoded_string =\n           reinterpret_cast<const uint16_t*>(decoder.out());\n \n@@ -890,7 +890,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n     }\n     result *= 2;\n   } else if (enc == UTF8) {\n-    String::Utf8Value needle_value(args.GetIsolate(), needle);\n+    String::Utf8Value needle_value(isolate, needle);\n     if (*needle_value == nullptr)\n       return args.GetReturnValue().Set(-1);\n \n@@ -906,7 +906,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n       return args.GetReturnValue().Set(-1);\n     }\n     needle->WriteOneByte(\n-        needle_data, 0, needle_length, String::NO_NULL_TERMINATION);\n+        isolate, needle_data, 0, needle_length, String::NO_NULL_TERMINATION);\n \n     result = SearchString(reinterpret_cast<const uint8_t*>(haystack),\n                           haystack_length,\n@@ -1057,18 +1057,20 @@ void Swap64(const FunctionCallbackInfo<Value>& args) {\n // Used in TextEncoder.prototype.encode.\n static void EncodeUtf8String(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n   CHECK_GE(args.Length(), 1);\n   CHECK(args[0]->IsString());\n \n   Local<String> str = args[0].As<String>();\n   size_t length = str->Utf8Length();\n   char* data = node::UncheckedMalloc(length);\n-  str->WriteUtf8(data,\n-                 -1,   // We are certain that `data` is sufficiently large\n+  str->WriteUtf8(isolate,\n+                 data,\n+                 -1,  // We are certain that `data` is sufficiently large\n                  nullptr,\n                  String::NO_NULL_TERMINATION | String::REPLACE_INVALID_UTF8);\n-  auto array_buf = ArrayBuffer::New(env->isolate(), data, length,\n-                                    ArrayBufferCreationMode::kInternalized);\n+  auto array_buf = ArrayBuffer::New(\n+      isolate, data, length, ArrayBufferCreationMode::kInternalized);\n   auto array = Uint8Array::New(array_buf, 0, length);\n   args.GetReturnValue().Set(array);\n }"
        },
        {
            "sha": "4d47291acead5719809ec6660112618d5c6979da",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -381,10 +381,12 @@ Headers::Headers(Isolate* isolate,\n   nghttp2_nv* const nva = reinterpret_cast<nghttp2_nv*>(start);\n \n   CHECK_LE(header_contents + header_string_len, *buf_ + buf_.length());\n-  CHECK_EQ(header_string.As<String>()\n-              ->WriteOneByte(reinterpret_cast<uint8_t*>(header_contents),\n-                             0, header_string_len,\n-                             String::NO_NULL_TERMINATION),\n+  CHECK_EQ(header_string.As<String>()->WriteOneByte(\n+               isolate,\n+               reinterpret_cast<uint8_t*>(header_contents),\n+               0,\n+               header_string_len,\n+               String::NO_NULL_TERMINATION),\n            header_string_len);\n \n   size_t n = 0;\n@@ -2633,8 +2635,8 @@ void Http2Session::AltSvc(const FunctionCallbackInfo<Value>& args) {\n \n   MaybeStackBuffer<uint8_t> origin(origin_len);\n   MaybeStackBuffer<uint8_t> value(value_len);\n-  origin_str->WriteOneByte(*origin);\n-  value_str->WriteOneByte(*value);\n+  origin_str->WriteOneByte(env->isolate(), *origin);\n+  value_str->WriteOneByte(env->isolate(), *value);\n \n   session->AltSvc(id, *origin, origin_len, *value, value_len);\n }"
        },
        {
            "sha": "c106571a4683017a7625174921aa1652ec929f31",
            "filename": "src/string_bytes.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fstring_bytes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fstring_bytes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_bytes.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -257,8 +257,8 @@ static size_t hex_decode(char* buf,\n   return i;\n }\n \n-\n-size_t StringBytes::WriteUCS2(char* buf,\n+size_t StringBytes::WriteUCS2(Isolate* isolate,\n+                              char* buf,\n                               size_t buflen,\n                               Local<String> str,\n                               int flags,\n@@ -273,7 +273,7 @@ size_t StringBytes::WriteUCS2(char* buf,\n   size_t nchars;\n   size_t alignment = reinterpret_cast<uintptr_t>(dst) % sizeof(*dst);\n   if (alignment == 0) {\n-    nchars = str->Write(dst, 0, max_chars, flags);\n+    nchars = str->Write(isolate, dst, 0, max_chars, flags);\n     *chars_written = nchars;\n     return nchars * sizeof(*dst);\n   }\n@@ -283,14 +283,15 @@ size_t StringBytes::WriteUCS2(char* buf,\n   CHECK_EQ(reinterpret_cast<uintptr_t>(aligned_dst) % sizeof(*dst), 0);\n \n   // Write all but the last char\n-  nchars = str->Write(aligned_dst, 0, max_chars - 1, flags);\n+  nchars = str->Write(isolate, aligned_dst, 0, max_chars - 1, flags);\n \n   // Shift everything to unaligned-left\n   memmove(dst, aligned_dst, nchars * sizeof(*dst));\n \n   // One more char to be written\n   uint16_t last;\n-  if (nchars == max_chars - 1 && str->Write(&last, nchars, 1, flags) != 0) {\n+  if (nchars == max_chars - 1 &&\n+      str->Write(isolate, &last, nchars, 1, flags) != 0) {\n     memcpy(buf + nchars * sizeof(*dst), &last, sizeof(last));\n     nchars++;\n   }\n@@ -329,20 +330,20 @@ size_t StringBytes::Write(Isolate* isolate,\n         memcpy(buf, ext->data(), nbytes);\n       } else {\n         uint8_t* const dst = reinterpret_cast<uint8_t*>(buf);\n-        nbytes = str->WriteOneByte(dst, 0, buflen, flags);\n+        nbytes = str->WriteOneByte(isolate, dst, 0, buflen, flags);\n       }\n       *chars_written = nbytes;\n       break;\n \n     case BUFFER:\n     case UTF8:\n-      nbytes = str->WriteUtf8(buf, buflen, chars_written, flags);\n+      nbytes = str->WriteUtf8(isolate, buf, buflen, chars_written, flags);\n       break;\n \n     case UCS2: {\n       size_t nchars;\n \n-      nbytes = WriteUCS2(buf, buflen, str, flags, &nchars);\n+      nbytes = WriteUCS2(isolate, buf, buflen, str, flags, &nchars);\n       *chars_written = static_cast<int>(nchars);\n \n       // Node's \"ucs2\" encoding wants LE character data stored in"
        },
        {
            "sha": "5f5fcd9fa0f05ebce8d231ca34c67ea4e4427920",
            "filename": "src/string_bytes.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fstring_bytes.h",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Fstring_bytes.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_bytes.h?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -112,7 +112,8 @@ class StringBytes {\n                                           v8::Local<v8::Value>* error);\n \n  private:\n-  static size_t WriteUCS2(char* buf,\n+  static size_t WriteUCS2(v8::Isolate* isolate,\n+                          char* buf,\n                           size_t buflen,\n                           v8::Local<v8::String> str,\n                           int flags,"
        },
        {
            "sha": "c36ea5169d331352800d24e72ed706551d999265",
            "filename": "src/util.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Futil.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a64fd7f320af90dd76b7d922f104e5715797f0a6/src%2Futil.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.cc?ref=a64fd7f320af90dd76b7d922f104e5715797f0a6",
            "patch": "@@ -45,7 +45,8 @@ static void MakeUtf8String(Isolate* isolate,\n   target->AllocateSufficientStorage(storage);\n   const int flags =\n       String::NO_NULL_TERMINATION | String::REPLACE_INVALID_UTF8;\n-  const int length = string->WriteUtf8(target->out(), storage, 0, flags);\n+  const int length =\n+      string->WriteUtf8(isolate, target->out(), storage, 0, flags);\n   target->SetLengthAndZeroTerminate(length);\n }\n \n@@ -71,7 +72,7 @@ TwoByteValue::TwoByteValue(Isolate* isolate, Local<Value> value) {\n   AllocateSufficientStorage(storage);\n \n   const int flags = String::NO_NULL_TERMINATION;\n-  const int length = string->Write(out(), 0, storage, flags);\n+  const int length = string->Write(isolate, out(), 0, storage, flags);\n   SetLengthAndZeroTerminate(length);\n }\n "
        }
    ],
    "stats": {
        "total": 95,
        "additions": 55,
        "deletions": 40
    }
}