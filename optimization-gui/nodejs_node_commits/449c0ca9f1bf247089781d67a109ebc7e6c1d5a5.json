{
    "author": "addaleax",
    "message": "n-api: make per-`Context`-ness of `napi_env` explicit\n\nBecause instances of `napi_env` are created on a per-global-object\nbasis and because since most N-API functions refer to builtin JS\nobjects, `napi_env` is essentially in 1:1 correspondence with\n`v8::Context`.\n\nThis was not clear from the implementation by itself, but has\nemerged from conversations with the N-API team.\n\nThis patch changes the `napi_env` implementation to:\n\n- Actually store the `v8::Context` it represents.\n- Provide more direct access to the `node::Environment`\n  to which the `Context` belongs.\n- Do not store the `uv_loop_t*` explicitly, since it can be\n  inferred from the `node::Environment` and we actually\n  have an N-API method for that.\n- Replace calls to `isolate->GetCurrentContext()` with\n  the more appropriate `napi_env` `Context`.\n- Implement a better (although not perfect) way of cleaning\n  up `napi_env` instances.\n\nPR-URL: https://github.com/nodejs/node/pull/23689\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "449c0ca9f1bf247089781d67a109ebc7e6c1d5a5",
    "files": [
        {
            "sha": "c92175c75fea0a092aeb6d2b294bdc8015c2337f",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 86,
            "deletions": 98,
            "changes": 184,
            "blob_url": "https://github.com/nodejs/node/blob/449c0ca9f1bf247089781d67a109ebc7e6c1d5a5/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/449c0ca9f1bf247089781d67a109ebc7e6c1d5a5/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=449c0ca9f1bf247089781d67a109ebc7e6c1d5a5",
            "patch": "@@ -18,16 +18,32 @@ static\n napi_status napi_clear_last_error(napi_env env);\n \n struct napi_env__ {\n-  explicit napi_env__(v8::Isolate* _isolate, uv_loop_t* _loop)\n-      : isolate(_isolate),\n-        last_error(),\n-        loop(_loop) {}\n-  v8::Isolate* isolate;\n+  explicit napi_env__(v8::Local<v8::Context> context)\n+      : isolate(context->GetIsolate()),\n+        context_persistent(isolate, context) {\n+    CHECK_EQ(isolate, context->GetIsolate());\n+    CHECK_NOT_NULL(node_env());\n+  }\n+\n+  v8::Isolate* const isolate;  // Shortcut for context()->GetIsolate()\n+  node::Persistent<v8::Context> context_persistent;\n+\n+  inline v8::Local<v8::Context> context() const {\n+    return StrongPersistentToLocal(context_persistent);\n+  }\n+\n+  inline node::Environment* node_env() const {\n+    return node::Environment::GetCurrent(context());\n+  }\n+\n+  inline void Ref() { refs++; }\n+  inline void Unref() { if (--refs == 0) delete this; }\n+\n   node::Persistent<v8::Value> last_exception;\n   napi_extended_error_info last_error;\n   int open_handle_scopes = 0;\n   int open_callback_scopes = 0;\n-  uv_loop_t* loop = nullptr;\n+  int refs = 1;\n };\n \n #define NAPI_PRIVATE_KEY(context, suffix) \\\n@@ -720,10 +736,6 @@ v8::Local<v8::Value> CreateAccessorCallbackData(napi_env env,\n   return cbdata;\n }\n \n-static void DeleteEnv(napi_env env, void* data, void* hint) {\n-  delete env;\n-}\n-\n static\n napi_env GetEnv(v8::Local<v8::Context> context) {\n   napi_env result;\n@@ -742,17 +754,26 @@ napi_env GetEnv(v8::Local<v8::Context> context) {\n   if (value->IsExternal()) {\n     result = static_cast<napi_env>(value.As<v8::External>()->Value());\n   } else {\n-    result = new napi_env__(isolate, node::GetCurrentEventLoop(isolate));\n+    result = new napi_env__(context);\n     auto external = v8::External::New(isolate, result);\n \n     // We must also stop hard if the result of assigning the env to the global\n     // is either nothing or false.\n     CHECK(global->SetPrivate(context, NAPI_PRIVATE_KEY(context, env), external)\n         .FromJust());\n \n-    // Create a self-destructing reference to external that will get rid of the\n-    // napi_env when external goes out of scope.\n-    Reference::New(result, external, 0, true, DeleteEnv, nullptr, nullptr);\n+    // TODO(addaleax): There was previously code that tried to delete the\n+    // napi_env when its v8::Context was garbage collected;\n+    // However, as long as N-API addons using this napi_env are in place,\n+    // the Context needs to be accessible and alive.\n+    // Ideally, weâ€™d want an on-addon-unload hook that takes care of this\n+    // once all N-API addons using this napi_env are unloaded.\n+    // For now, a per-Environment cleanup hook is the best we can do.\n+    result->node_env()->AddCleanupHook(\n+        [](void* arg) {\n+          static_cast<napi_env>(arg)->Unref();\n+        },\n+        static_cast<void*>(result));\n   }\n \n   return result;\n@@ -774,8 +795,7 @@ napi_status Unwrap(napi_env env,\n     CHECK_ARG(env, result);\n   }\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Value> value = v8impl::V8LocalValueFromJsValue(js_object);\n   RETURN_STATUS_IF_FALSE(env, value->IsObject(), napi_invalid_arg);\n@@ -808,7 +828,7 @@ napi_status ConcludeDeferred(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   node::Persistent<v8::Value>* deferred_ref =\n       NodePersistentFromJsDeferred(deferred);\n   v8::Local<v8::Value> v8_deferred =\n@@ -853,10 +873,12 @@ class ThreadSafeFunction : public node::AsyncResource {\n       handles_closing(false) {\n     ref.Reset(env->isolate, func);\n     node::AddEnvironmentCleanupHook(env->isolate, Cleanup, this);\n+    env->Ref();\n   }\n \n   ~ThreadSafeFunction() {\n     node::RemoveEnvironmentCleanupHook(env->isolate, Cleanup, this);\n+    env->Unref();\n   }\n \n   // These methods can be called from any thread.\n@@ -935,18 +957,21 @@ class ThreadSafeFunction : public node::AsyncResource {\n   // These methods must only be called from the loop thread.\n \n   napi_status Init() {\n+    uv_loop_t* loop = nullptr;\n+    CHECK_EQ(napi_get_uv_event_loop(env, &loop), napi_ok);\n+\n     ThreadSafeFunction* ts_fn = this;\n \n-    if (uv_async_init(env->loop, &async, AsyncCb) == 0) {\n+    if (uv_async_init(loop, &async, AsyncCb) == 0) {\n       if (max_queue_size > 0) {\n         cond.reset(new node::ConditionVariable);\n       }\n       if ((max_queue_size == 0 || cond.get() != nullptr) &&\n-          uv_idle_init(env->loop, &idle) == 0) {\n+          uv_idle_init(loop, &idle) == 0) {\n         return napi_ok;\n       }\n \n-      NodeEnv()->CloseHandle(\n+      env->node_env()->CloseHandle(\n           reinterpret_cast<uv_handle_t*>(&async),\n           [](uv_handle_t* handle) -> void {\n             ThreadSafeFunction* ts_fn =\n@@ -1035,15 +1060,6 @@ class ThreadSafeFunction : public node::AsyncResource {\n     }\n   }\n \n-  node::Environment* NodeEnv() {\n-    // Grabbing the Node.js environment requires a handle scope because it\n-    // looks up fields on the current context.\n-    v8::HandleScope scope(env->isolate);\n-    node::Environment* node_env = node::Environment::GetCurrent(env->isolate);\n-    CHECK_NOT_NULL(node_env);\n-    return node_env;\n-  }\n-\n   void MaybeStartIdle() {\n     if (uv_idle_start(&idle, IdleCb) != 0) {\n       v8::HandleScope scope(env->isolate);\n@@ -1079,13 +1095,13 @@ class ThreadSafeFunction : public node::AsyncResource {\n       return;\n     }\n     handles_closing = true;\n-    NodeEnv()->CloseHandle(\n+    env->node_env()->CloseHandle(\n         reinterpret_cast<uv_handle_t*>(&async),\n         [](uv_handle_t* handle) -> void {\n           ThreadSafeFunction* ts_fn =\n               node::ContainerOf(&ThreadSafeFunction::async,\n                                 reinterpret_cast<uv_async_t*>(handle));\n-          ts_fn->NodeEnv()->CloseHandle(\n+          ts_fn->env->node_env()->CloseHandle(\n               reinterpret_cast<uv_handle_t*>(&ts_fn->idle),\n               [](uv_handle_t* handle) -> void {\n                 ThreadSafeFunction* ts_fn =\n@@ -1175,8 +1191,7 @@ napi_status Wrap(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, js_object);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Value> value = v8impl::V8LocalValueFromJsValue(js_object);\n   RETURN_STATUS_IF_FALSE(env, value->IsObject(), napi_invalid_arg);\n@@ -1211,7 +1226,7 @@ napi_status Wrap(napi_env env,\n \n   if (wrap_type == retrievable) {\n     CHECK(obj->SetPrivate(context, NAPI_PRIVATE_KEY(context, wrapper),\n-          v8::External::New(isolate, reference)).FromJust());\n+          v8::External::New(env->isolate, reference)).FromJust());\n   }\n \n   return GET_RETURN_STATUS(env);\n@@ -1418,7 +1433,7 @@ napi_status napi_create_function(napi_env env,\n \n   RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n \n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::MaybeLocal<v8::Function> maybe_function =\n       v8::Function::New(context,\n                         v8impl::FunctionCallbackWrapper::Invoke,\n@@ -1518,7 +1533,7 @@ napi_status napi_define_class(napi_env env,\n     }\n   }\n \n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   *result = v8impl::JsValueFromV8LocalValue(\n       scope.Escape(tpl->GetFunction(context).ToLocalChecked()));\n \n@@ -1550,8 +1565,7 @@ napi_status napi_get_property_names(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n   CHECK_TO_OBJECT(env, context, obj, object);\n \n@@ -1572,8 +1586,7 @@ napi_status napi_set_property(napi_env env,\n   CHECK_ARG(env, key);\n   CHECK_ARG(env, value);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1595,8 +1608,7 @@ napi_status napi_has_property(napi_env env,\n   CHECK_ARG(env, result);\n   CHECK_ARG(env, key);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1618,8 +1630,7 @@ napi_status napi_get_property(napi_env env,\n   CHECK_ARG(env, key);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Value> k = v8impl::V8LocalValueFromJsValue(key);\n   v8::Local<v8::Object> obj;\n \n@@ -1641,8 +1652,7 @@ napi_status napi_delete_property(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, key);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Value> k = v8impl::V8LocalValueFromJsValue(key);\n   v8::Local<v8::Object> obj;\n \n@@ -1663,8 +1673,7 @@ napi_status napi_has_own_property(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, key);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1684,8 +1693,7 @@ napi_status napi_set_named_property(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, value);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1708,8 +1716,7 @@ napi_status napi_has_named_property(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1732,8 +1739,7 @@ napi_status napi_get_named_property(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Name> key;\n   CHECK_NEW_FROM_UTF8(env, key, utf8name);\n@@ -1758,8 +1764,7 @@ napi_status napi_set_element(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, value);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1779,8 +1784,7 @@ napi_status napi_has_element(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1800,8 +1804,7 @@ napi_status napi_get_element(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1820,8 +1823,7 @@ napi_status napi_delete_element(napi_env env,\n                                 bool* result) {\n   NAPI_PREAMBLE(env);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n \n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1843,8 +1845,7 @@ napi_status napi_define_properties(napi_env env,\n     CHECK_ARG(env, properties);\n   }\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Object> obj;\n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -1965,8 +1966,7 @@ napi_status napi_get_prototype(napi_env env,\n   NAPI_PREAMBLE(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Object> obj;\n   CHECK_TO_OBJECT(env, context, obj, object);\n@@ -2141,7 +2141,7 @@ napi_status napi_create_bigint_words(napi_env env,\n   CHECK_ARG(env, words);\n   CHECK_ARG(env, result);\n \n-  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   if (word_count > INT_MAX) {\n     napi_throw_range_error(env, nullptr, \"Maximum BigInt size exceeded\");\n@@ -2202,7 +2202,7 @@ static napi_status set_error_code(napi_env env,\n                                   const char* code_cstring) {\n   if ((code != nullptr) || (code_cstring != nullptr)) {\n     v8::Isolate* isolate = env->isolate;\n-    v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+    v8::Local<v8::Context> context = env->context();\n     v8::Local<v8::Object> err_object = error.As<v8::Object>();\n \n     v8::Local<v8::Value> code_value = v8impl::V8LocalValueFromJsValue(code);\n@@ -2435,8 +2435,7 @@ napi_status napi_call_function(napi_env env,\n     CHECK_ARG(env, argv);\n   }\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Value> v8recv = v8impl::V8LocalValueFromJsValue(recv);\n \n@@ -2461,11 +2460,7 @@ napi_status napi_get_global(napi_env env, napi_value* result) {\n   CHECK_ENV(env);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  // TODO(ianhall): what if we need the global object from a different\n-  // context in the same isolate?\n-  // Should napi_env be the current context rather than the current isolate?\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   *result = v8impl::JsValueFromV8LocalValue(context->Global());\n \n   return napi_clear_last_error(env);\n@@ -2857,8 +2852,7 @@ napi_status napi_coerce_to_object(napi_env env,\n   CHECK_ARG(env, value);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Object> obj;\n   CHECK_TO_OBJECT(env, context, obj, value);\n \n@@ -2873,8 +2867,7 @@ napi_status napi_coerce_to_bool(napi_env env,\n   CHECK_ARG(env, value);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Boolean> b;\n \n   CHECK_TO_BOOL(env, context, b, value);\n@@ -2890,8 +2883,7 @@ napi_status napi_coerce_to_number(napi_env env,\n   CHECK_ARG(env, value);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::Number> num;\n \n   CHECK_TO_NUMBER(env, context, num, value);\n@@ -2907,8 +2899,7 @@ napi_status napi_coerce_to_string(napi_env env,\n   CHECK_ARG(env, value);\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n   v8::Local<v8::String> str;\n \n   CHECK_TO_STRING(env, context, str, value);\n@@ -3169,7 +3160,7 @@ napi_status napi_open_callback_scope(napi_env env,\n   CHECK_ENV(env);\n   CHECK_ARG(env, result);\n \n-  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   node::async_context* node_async_context =\n       reinterpret_cast<node::async_context*>(async_context_handle);\n@@ -3212,8 +3203,7 @@ napi_status napi_new_instance(napi_env env,\n   }\n   CHECK_ARG(env, result);\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Function> ctor;\n   CHECK_TO_FUNCTION(env, ctor, constructor);\n@@ -3238,8 +3228,7 @@ napi_status napi_instanceof(napi_env env,\n   *result = false;\n \n   v8::Local<v8::Object> ctor;\n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   CHECK_TO_OBJECT(env, context, ctor, constructor);\n \n@@ -3269,7 +3258,7 @@ napi_status napi_async_init(napi_env env,\n   CHECK_ARG(env, result);\n \n   v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Object> v8_resource;\n   if (async_resource != nullptr) {\n@@ -3319,8 +3308,7 @@ napi_status napi_make_callback(napi_env env,\n     CHECK_ARG(env, argv);\n   }\n \n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Object> v8recv;\n   CHECK_TO_OBJECT(env, context, v8recv, recv);\n@@ -3336,7 +3324,7 @@ napi_status napi_make_callback(napi_env env,\n   }\n \n   v8::MaybeLocal<v8::Value> callback_result = node::MakeCallback(\n-      isolate, v8recv, v8func, argc,\n+      env->isolate, v8recv, v8func, argc,\n       reinterpret_cast<v8::Local<v8::Value>*>(const_cast<napi_value*>(argv)),\n       *node_async_context);\n \n@@ -3848,7 +3836,7 @@ class Work : public node::AsyncResource, public node::ThreadPoolWork {\n     : AsyncResource(env->isolate,\n                     async_resource,\n                     *v8::String::Utf8Value(env->isolate, async_resource_name)),\n-      ThreadPoolWork(node::Environment::GetCurrent(env->isolate)),\n+      ThreadPoolWork(env->node_env()),\n       _env(env),\n       _data(data),\n       _execute(execute),\n@@ -3935,7 +3923,7 @@ napi_status napi_create_async_work(napi_env env,\n   CHECK_ARG(env, execute);\n   CHECK_ARG(env, result);\n \n-  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   v8::Local<v8::Object> resource;\n   if (async_resource != nullptr) {\n@@ -3968,7 +3956,7 @@ napi_status napi_delete_async_work(napi_env env, napi_async_work work) {\n napi_status napi_get_uv_event_loop(napi_env env, uv_loop_t** loop) {\n   CHECK_ENV(env);\n   CHECK_ARG(env, loop);\n-  *loop = env->loop;\n+  *loop = env->node_env()->event_loop();\n   return napi_clear_last_error(env);\n }\n \n@@ -4007,7 +3995,7 @@ napi_status napi_create_promise(napi_env env,\n   CHECK_ARG(env, deferred);\n   CHECK_ARG(env, promise);\n \n-  auto maybe = v8::Promise::Resolver::New(env->isolate->GetCurrentContext());\n+  auto maybe = v8::Promise::Resolver::New(env->context());\n   CHECK_MAYBE_EMPTY(env, maybe, napi_generic_failure);\n \n   auto v8_resolver = maybe.ToLocalChecked();\n@@ -4056,7 +4044,7 @@ napi_status napi_run_script(napi_env env,\n     return napi_set_last_error(env, napi_string_expected);\n   }\n \n-  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> context = env->context();\n \n   auto maybe_script = v8::Script::Compile(context,\n       v8::Local<v8::String>::Cast(v8_script));\n@@ -4093,7 +4081,7 @@ napi_create_threadsafe_function(napi_env env,\n   v8::Local<v8::Function> v8_func;\n   CHECK_TO_FUNCTION(env, v8_func, func);\n \n-  v8::Local<v8::Context> v8_context = env->isolate->GetCurrentContext();\n+  v8::Local<v8::Context> v8_context = env->context();\n \n   v8::Local<v8::Object> v8_resource;\n   if (async_resource == nullptr) {"
        }
    ],
    "stats": {
        "total": 184,
        "additions": 86,
        "deletions": 98
    }
}