{
    "author": "joyeecheung",
    "message": "test: improve WPT runner name matching\n\nThis patch:\n\n- Support wildcards(*) in WPT runner name matching (needed by e.g.\n  encoding where all the tests requires i18n support in the build)\n- Print failure reasons when encountering an expected failure\n- Fix a bug in copyGlobalsFromObject (previously it copies\n  properties from `global` instead of the given `obj`)\n\nPreviously an expected failure is printed as\n\n```\n[EXPECTED_FAILURE] response.formData() with input: %61+%4d%4D=\n```\n\nNow it is printed as\n\n```\n[EXPECTED_FAILURE] response.formData() with input: %61+%4d%4D=\nmissing Request and Response\n```\n\nPR-URL: https://github.com/nodejs/node/pull/24826\nRefs: https://github.com/nodejs/node/issues/24823\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Daijiro Wachi <daijiro.wachi@gmail.com>",
    "sha": "b5202546fcd64293cce94a4ba4b98f9d8ca1aee6",
    "files": [
        {
            "sha": "2a25a22af537101febd75a89379862737533c8bb",
            "filename": "test/common/wpt.js",
            "status": "modified",
            "additions": 99,
            "deletions": 40,
            "changes": 139,
            "blob_url": "https://github.com/nodejs/node/blob/b5202546fcd64293cce94a4ba4b98f9d8ca1aee6/test%2Fcommon%2Fwpt.js",
            "raw_url": "https://github.com/nodejs/node/raw/b5202546fcd64293cce94a4ba4b98f9d8ca1aee6/test%2Fcommon%2Fwpt.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fwpt.js?ref=b5202546fcd64293cce94a4ba4b98f9d8ca1aee6",
            "patch": "@@ -66,20 +66,92 @@ class ResourceLoader {\n   }\n }\n \n+class StatusRule {\n+  constructor(key, value, pattern = undefined) {\n+    this.key = key;\n+    this.requires = value.requires || [];\n+    this.fail = value.fail;\n+    this.skip = value.skip;\n+    if (pattern) {\n+      this.pattern = this.transformPattern(pattern);\n+    }\n+    // TODO(joyeecheung): implement this\n+    this.scope = value.scope;\n+    this.comment = value.comment;\n+  }\n+\n+  /**\n+   * Transform a filename pattern into a RegExp\n+   * @param {string} pattern\n+   * @returns {RegExp}\n+   */\n+  transformPattern(pattern) {\n+    const result = pattern.replace(/[-/\\\\^$+?.()|[\\]{}]/g, '\\\\$&');\n+    return new RegExp(result.replace('*', '.*'));\n+  }\n+}\n+\n+class StatusRuleSet {\n+  constructor() {\n+    // We use two sets of rules to speed up matching\n+    this.exactMatch = {};\n+    this.patternMatch = [];\n+  }\n+\n+  /**\n+   * @param {object} rules\n+   */\n+  addRules(rules) {\n+    for (const key of Object.keys(rules)) {\n+      if (key.includes('*')) {\n+        this.patternMatch.push(new StatusRule(key, rules[key], key));\n+      } else {\n+        this.exactMatch[key] = new StatusRule(key, rules[key]);\n+      }\n+    }\n+  }\n+\n+  match(file) {\n+    const result = [];\n+    const exact = this.exactMatch[file];\n+    if (exact) {\n+      result.push(exact);\n+    }\n+    for (const item of this.patternMatch) {\n+      if (item.pattern.test(file)) {\n+        result.push(item);\n+      }\n+    }\n+    return result;\n+  }\n+}\n+\n class WPTTest {\n   /**\n    * @param {string} mod\n    * @param {string} filename\n-   * @param {string[]} requires\n-   * @param {string | undefined} failReason\n-   * @param {string | undefined} skipReason\n+   * @param {StatusRule[]} rules\n    */\n-  constructor(mod, filename, requires, failReason, skipReason) {\n+  constructor(mod, filename, rules) {\n     this.module = mod; // name of the WPT module, e.g. 'url'\n     this.filename = filename;  // name of the test file\n-    this.requires = requires;\n-    this.failReason = failReason;\n-    this.skipReason = skipReason;\n+\n+    this.requires = new Set();\n+    this.failReasons = [];\n+    this.skipReasons = [];\n+    for (const item of rules) {\n+      if (item.requires.length) {\n+        for (const req of item.requires) {\n+          this.requires.add(req);\n+        }\n+      }\n+      if (item.fail) {\n+        this.failReasons.push(item.fail);\n+      }\n+      if (item.skip) {\n+        this.skipReasons.push(item.skip);\n+      }\n+    }\n   }\n \n   getAbsolutePath() {\n@@ -90,54 +162,37 @@ class WPTTest {\n     return fs.readFileSync(this.getAbsolutePath(), 'utf8');\n   }\n \n-  shouldSkip() {\n-    return this.failReason || this.skipReason;\n-  }\n-\n   requireIntl() {\n-    return this.requires.includes('intl');\n+    return this.requires.has('intl');\n   }\n }\n \n class StatusLoader {\n   constructor(path) {\n     this.path = path;\n     this.loaded = false;\n-    this.status = null;\n+    this.rules = new StatusRuleSet();\n     /** @type {WPTTest[]} */\n     this.tests = [];\n   }\n \n-  loadTest(file) {\n-    let requires = [];\n-    let failReason;\n-    let skipReason;\n-    if (this.status[file]) {\n-      requires = this.status[file].requires || [];\n-      failReason = this.status[file].fail;\n-      skipReason = this.status[file].skip;\n-    }\n-    return new WPTTest(this.path, file, requires,\n-                       failReason, skipReason);\n-  }\n-\n   load() {\n     const dir = path.join(__dirname, '..', 'wpt');\n     const statusFile = path.join(dir, 'status', `${this.path}.json`);\n     const result = JSON.parse(fs.readFileSync(statusFile, 'utf8'));\n-    this.status = result;\n+    this.rules.addRules(result);\n \n     const list = fs.readdirSync(fixtures.path('wpt', this.path));\n \n     for (const file of list) {\n-      this.tests.push(this.loadTest(file));\n+      if (!(/\\.\\w+\\.js$/.test(file))) {\n+        continue;\n+      }\n+      const match = this.rules.match(file);\n+      this.tests.push(new WPTTest(this.path, file, match));\n     }\n     this.loaded = true;\n   }\n-\n-  get jsTests() {\n-    return this.tests.filter((test) => test.filename.endsWith('.js'));\n-  }\n }\n \n const PASSED = 1;\n@@ -156,7 +211,7 @@ class WPTRunner {\n     this.status = new StatusLoader(path);\n     this.status.load();\n     this.tests = new Map(\n-      this.status.jsTests.map((item) => [item.filename, item])\n+      this.status.tests.map((item) => [item.filename, item])\n     );\n \n     this.results = new Map();\n@@ -171,7 +226,10 @@ class WPTRunner {\n    */\n   copyGlobalsFromObject(obj, names) {\n     for (const name of names) {\n-      const desc = Object.getOwnPropertyDescriptor(global, name);\n+      const desc = Object.getOwnPropertyDescriptor(obj, name);\n+      if (!desc) {\n+        assert.fail(`${name} does not exist on the object`);\n+      }\n       this.globals.set(name, desc);\n     }\n   }\n@@ -328,8 +386,9 @@ class WPTRunner {\n       for (const item of items) {\n         switch (item.type) {\n           case FAILED: {\n-            if (test.failReason) {\n+            if (test.failReasons.length) {\n               console.log(`[EXPECTED_FAILURE] ${item.test.name}`);\n+              console.log(test.failReasons.join('; '));\n             } else {\n               console.log(`[UNEXPECTED_FAILURE] ${item.test.name}`);\n               unexpectedFailures.push([title, filename, item]);\n@@ -386,10 +445,10 @@ class WPTRunner {\n     });\n   }\n \n-  skip(filename, reason) {\n+  skip(filename, reasons) {\n     this.addResult(filename, {\n       type: SKIPPED,\n-      reason\n+      reason: reasons.join('; ')\n     });\n   }\n \n@@ -435,13 +494,13 @@ class WPTRunner {\n     const queue = [];\n     for (const test of this.tests.values()) {\n       const filename = test.filename;\n-      if (test.skipReason) {\n-        this.skip(filename, test.skipReason);\n+      if (test.skipReasons.length > 0) {\n+        this.skip(filename, test.skipReasons);\n         continue;\n       }\n \n       if (!common.hasIntl && test.requireIntl()) {\n-        this.skip(filename, 'missing Intl');\n+        this.skip(filename, [ 'missing Intl' ]);\n         continue;\n       }\n "
        }
    ],
    "stats": {
        "total": 139,
        "additions": 99,
        "deletions": 40
    }
}