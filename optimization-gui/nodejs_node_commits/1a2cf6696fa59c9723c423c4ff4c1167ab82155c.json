{
    "author": "AndreasMadsen",
    "message": "async_hooks: remove promise object from resource\n\nWhile it doesn't make any difference now. In the future PromiseHooks\ncould be refactored to provide an asyncId instead of the promise object.\nThat would make escape analysis on promises possible.\n\nEscape analysis on promises could lead to a more efficient destroy hook,\nif provide by PromiseHooks as well. But at the very least would allow\nthe destroy hook to be emitted earlier. The destroy hook not being\nemitted on promises frequent enough is a known and reported issue.\nSee https://github.com/nodejs/node/issues/14446 and\nhttps://github.com/Jeff-Lewis/cls-hooked/issues/11.\n\nWhile all this is speculation for now, it all depends on the promise\nobject not being a part of the PromiseWrap resource object.\n\nRef: https://github.com/nodejs/node/issues/14446\nRef: https://github.com/nodejs/diagnostics/issues/188\n\nPR-URL: https://github.com/nodejs/node/pull/23443\nRefs: https://github.com/nodejs/node/issues/14446\nRefs: https://github.com/nodejs/diagnostics/issues/188\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: George Adams <george.adams@uk.ibm.com>",
    "sha": "1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
    "files": [
        {
            "sha": "4fc070c974deec60b68096ccdfdc79e7285e2cbf",
            "filename": "doc/api/async_hooks.md",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/doc%2Fapi%2Fasync_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/doc%2Fapi%2Fasync_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fasync_hooks.md?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -301,8 +301,7 @@ currently not considered public, but using the Embedder API, users can provide\n and document their own resource objects. For example, such a resource object\n could contain the SQL query being executed.\n \n-In the case of Promises, the `resource` object will have `promise` property\n-that refers to the `Promise` that is being initialized, and an\n+In the case of Promises, the `resource` object will have an\n `isChainedPromise` property, set to `true` if the promise has a parent promise,\n and `false` otherwise. For example, in the case of `b = a.then(handler)`, `a` is\n considered a parent `Promise` of `b`. Here, `b` is considered a chained promise."
        },
        {
            "sha": "0caeb624b4129917e41ee1ce969c750e9cf9bc8f",
            "filename": "lib/domain.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/lib%2Fdomain.js",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/lib%2Fdomain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdomain.js?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -55,13 +55,6 @@ const asyncHook = createHook({\n       // if this operation is created while in a domain, let's mark it\n       pairing.set(asyncId, process.domain);\n       resource.domain = process.domain;\n-      if (resource.promise !== undefined &&\n-          resource.promise instanceof Promise) {\n-        // resource.promise instanceof Promise make sure that the\n-        // promise comes from the same context\n-        // see https://github.com/nodejs/node/issues/15673\n-        resource.promise.domain = process.domain;\n-      }\n     }\n   },\n   before(asyncId) {"
        },
        {
            "sha": "17636ceb31c27d738a50acd9d4b335f12376ad8a",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 14,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -185,16 +185,13 @@ class PromiseWrap : public AsyncWrap {\n   SET_MEMORY_INFO_NAME(PromiseWrap)\n   SET_SELF_SIZE(PromiseWrap)\n \n-  static constexpr int kPromiseField = 1;\n-  static constexpr int kIsChainedPromiseField = 2;\n-  static constexpr int kInternalFieldCount = 3;\n+  static constexpr int kIsChainedPromiseField = 1;\n+  static constexpr int kInternalFieldCount = 2;\n \n   static PromiseWrap* New(Environment* env,\n                           Local<Promise> promise,\n                           PromiseWrap* parent_wrap,\n                           bool silent);\n-  static void GetPromise(Local<String> property,\n-                         const PropertyCallbackInfo<Value>& info);\n   static void getIsChainedPromise(Local<String> property,\n                                   const PropertyCallbackInfo<Value>& info);\n };\n@@ -205,7 +202,6 @@ PromiseWrap* PromiseWrap::New(Environment* env,\n                               bool silent) {\n   Local<Object> object = env->promise_wrap_template()\n                             ->NewInstance(env->context()).ToLocalChecked();\n-  object->SetInternalField(PromiseWrap::kPromiseField, promise);\n   object->SetInternalField(PromiseWrap::kIsChainedPromiseField,\n                            parent_wrap != nullptr ?\n                               v8::True(env->isolate()) :\n@@ -215,11 +211,6 @@ PromiseWrap* PromiseWrap::New(Environment* env,\n   return new PromiseWrap(env, object, silent);\n }\n \n-void PromiseWrap::GetPromise(Local<String> property,\n-                             const PropertyCallbackInfo<Value>& info) {\n-  info.GetReturnValue().Set(info.Holder()->GetInternalField(kPromiseField));\n-}\n-\n void PromiseWrap::getIsChainedPromise(Local<String> property,\n                                       const PropertyCallbackInfo<Value>& info) {\n   info.GetReturnValue().Set(\n@@ -315,9 +306,6 @@ static void SetupHooks(const FunctionCallbackInfo<Value>& args) {\n     Local<ObjectTemplate> promise_wrap_template = ctor->InstanceTemplate();\n     promise_wrap_template->SetInternalFieldCount(\n         PromiseWrap::kInternalFieldCount);\n-    promise_wrap_template->SetAccessor(\n-        FIXED_ONE_BYTE_STRING(env->isolate(), \"promise\"),\n-        PromiseWrap::GetPromise);\n     promise_wrap_template->SetAccessor(\n         FIXED_ONE_BYTE_STRING(env->isolate(), \"isChainedPromise\"),\n         PromiseWrap::getIsChainedPromise);"
        },
        {
            "sha": "47a259166ee1828c3f31a23c70663af548debeae",
            "filename": "test/parallel/test-async-hooks-promise-enable-disable.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-async-hooks-promise-enable-disable.js",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-async-hooks-promise-enable-disable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-async-hooks-promise-enable-disable.js?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -4,7 +4,6 @@ const common = require('../common');\n const assert = require('assert');\n const async_hooks = require('async_hooks');\n const EXPECTED_INITS = 2;\n-let p_resource = null;\n let p_er = null;\n let p_inits = 0;\n \n@@ -23,7 +22,6 @@ const mustCallInit = common.mustCall(function init(id, type, tid, resource) {\n   if (type !== 'PROMISE')\n     return;\n   p_inits++;\n-  p_resource = resource.promise;\n }, EXPECTED_INITS);\n \n const hook = async_hooks.createHook({\n@@ -36,7 +34,6 @@ new Promise(common.mustCall((res) => {\n })).then(common.mustCall((val) => {\n   hook.enable().enable();\n   const p = new Promise((res) => res(val));\n-  assert.strictEqual(p, p_resource);\n   hook.disable();\n   return p;\n })).then(common.mustCall((val2) => {"
        },
        {
            "sha": "637d287b506ba965576302f67422555142123fe6",
            "filename": "test/parallel/test-async-hooks-promise.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-async-hooks-promise.js",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-async-hooks-promise.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-async-hooks-promise.js?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -21,11 +21,9 @@ async_hooks.createHook({\n }).enable();\n \n const a = Promise.resolve(42);\n-const b = a.then(common.mustCall());\n+a.then(common.mustCall());\n \n assert.strictEqual(initCalls[0].triggerId, 1);\n assert.strictEqual(initCalls[0].resource.isChainedPromise, false);\n-assert.strictEqual(initCalls[0].resource.promise, a);\n assert.strictEqual(initCalls[1].triggerId, initCalls[0].id);\n assert.strictEqual(initCalls[1].resource.isChainedPromise, true);\n-assert.strictEqual(initCalls[1].resource.promise, b);"
        },
        {
            "sha": "704092522357fd6eb26662ad7e866977b03cafaa",
            "filename": "test/parallel/test-domain-promise.js",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-domain-promise.js",
            "raw_url": "https://github.com/nodejs/node/raw/1a2cf6696fa59c9723c423c4ff4c1167ab82155c/test%2Fparallel%2Ftest-domain-promise.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-domain-promise.js?ref=1a2cf6696fa59c9723c423c4ff4c1167ab82155c",
            "patch": "@@ -50,7 +50,6 @@ const vm = require('vm');\n   d2.run(common.mustCall(() => {\n     p.then(common.mustCall((v) => {\n       assert.strictEqual(process.domain, d2);\n-      assert.strictEqual(p.domain, d1);\n     }));\n   }));\n }\n@@ -64,9 +63,8 @@ const vm = require('vm');\n   }));\n \n   d2.run(common.mustCall(() => {\n-    p.then(p.domain.bind(common.mustCall((v) => {\n+    p.then(d1.bind(common.mustCall((v) => {\n       assert.strictEqual(process.domain, d1);\n-      assert.strictEqual(p.domain, d1);\n     })));\n   }));\n }\n@@ -83,7 +81,6 @@ const vm = require('vm');\n     d2.run(common.mustCall(() => {\n       p.then(common.mustCall((v) => {\n         assert.strictEqual(process.domain, d2);\n-        assert.strictEqual(p.domain, d1);\n       }));\n     }));\n   }));\n@@ -100,7 +97,6 @@ const vm = require('vm');\n   d2.run(common.mustCall(() => {\n     p.catch(common.mustCall((v) => {\n       assert.strictEqual(process.domain, d2);\n-      assert.strictEqual(p.domain, d1);\n     }));\n   }));\n }"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 5,
        "deletions": 34
    }
}