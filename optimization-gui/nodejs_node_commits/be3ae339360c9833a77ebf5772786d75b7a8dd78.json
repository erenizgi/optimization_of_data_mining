{
    "author": "BridgeAR",
    "message": "console: add `inspectOptions` option\n\nAdd an `inspectOptions` option to the `console` constructor. That\nway it's possible to define all inspection defaults for each\n`console` instance instead of relying on the `inspect()` defaults.\n\nPR-URL: https://github.com/nodejs/node/pull/24978\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "be3ae339360c9833a77ebf5772786d75b7a8dd78",
    "files": [
        {
            "sha": "cd229c0a0f81df08bf52bd0fdb38216b4b661bf6",
            "filename": "doc/api/console.md",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/be3ae339360c9833a77ebf5772786d75b7a8dd78/doc%2Fapi%2Fconsole.md",
            "raw_url": "https://github.com/nodejs/node/raw/be3ae339360c9833a77ebf5772786d75b7a8dd78/doc%2Fapi%2Fconsole.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fconsole.md?ref=be3ae339360c9833a77ebf5772786d75b7a8dd78",
            "patch": "@@ -88,6 +88,9 @@ changes:\n     pr-url: https://github.com/nodejs/node/pull/19372\n     description: The `Console` constructor now supports an `options` argument,\n                  and the `colorMode` option was introduced.\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/24978\n+    description: The `inspectOptions` option is introduced.\n -->\n \n * `options` {Object}\n@@ -98,8 +101,11 @@ changes:\n   * `colorMode` {boolean|string} Set color support for this `Console` instance.\n     Setting to `true` enables coloring while inspecting values, setting to\n     `'auto'` will make color support depend on the value of the `isTTY` property\n-    and the value returned by `getColorDepth()` on the respective stream.\n+    and the value returned by `getColorDepth()` on the respective stream. This\n+    option can not be used, if `inspectOptions.colors` is set as well.\n     **Default:** `'auto'`.\n+  * `inspectOptions` {Object} Specifies options that are passed along to\n+    [`util.inspect()`][].\n \n Creates a new `Console` with one or two writable stream instances. `stdout` is a\n writable stream to print log or info output. `stderr` is used for warning or"
        },
        {
            "sha": "a2ae4d32be21018af9f5ec0e235c2255c0775a01",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/be3ae339360c9833a77ebf5772786d75b7a8dd78/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/be3ae339360c9833a77ebf5772786d75b7a8dd78/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=be3ae339360c9833a77ebf5772786d75b7a8dd78",
            "patch": "@@ -1126,6 +1126,12 @@ is set for the `Http2Stream`.\n `http2.connect()` was passed a URL that uses any protocol other than `http:` or\n `https:`.\n \n+<a id=\"ERR_INCOMPATIBLE_OPTION_PAIR\"></a>\n+### ERR_INCOMPATIBLE_OPTION_PAIR\n+\n+An option pair is incompatible with each other and can not be used at the same\n+time.\n+\n <a id=\"ERR_INSPECTOR_ALREADY_CONNECTED\"></a>\n ### ERR_INSPECTOR_ALREADY_CONNECTED\n "
        },
        {
            "sha": "da54dd11a7e60b9bd013ca4d46a5cdb49812c13d",
            "filename": "lib/internal/console/constructor.js",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/be3ae339360c9833a77ebf5772786d75b7a8dd78/lib%2Finternal%2Fconsole%2Fconstructor.js",
            "raw_url": "https://github.com/nodejs/node/raw/be3ae339360c9833a77ebf5772786d75b7a8dd78/lib%2Finternal%2Fconsole%2Fconstructor.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fconsole%2Fconstructor.js?ref=be3ae339360c9833a77ebf5772786d75b7a8dd78",
            "patch": "@@ -10,6 +10,7 @@ const {\n     ERR_CONSOLE_WRITABLE_STREAM,\n     ERR_INVALID_ARG_TYPE,\n     ERR_INVALID_ARG_VALUE,\n+    ERR_INCOMPATIBLE_OPTION_PAIR,\n   },\n } = require('internal/errors');\n const { previewEntries } = internalBinding('util');\n@@ -54,6 +55,8 @@ const kBindStreamsLazy = Symbol('kBindStreamsLazy');\n const kUseStdout = Symbol('kUseStdout');\n const kUseStderr = Symbol('kUseStderr');\n \n+const optionsMap = new WeakMap();\n+\n function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n   // We have to test new.target here to see if this function is called\n   // with new, because we need to define a custom instanceof to accommodate\n@@ -74,7 +77,8 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n     stdout,\n     stderr = stdout,\n     ignoreErrors = true,\n-    colorMode = 'auto'\n+    colorMode = 'auto',\n+    inspectOptions\n   } = options;\n \n   if (!stdout || typeof stdout.write !== 'function') {\n@@ -87,6 +91,15 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n   if (typeof colorMode !== 'boolean' && colorMode !== 'auto')\n     throw new ERR_INVALID_ARG_VALUE('colorMode', colorMode);\n \n+  if (inspectOptions) {\n+    if (inspectOptions.colors !== undefined &&\n+        options.colorMode !== undefined) {\n+      throw new ERR_INCOMPATIBLE_OPTION_PAIR(\n+        'inspectOptions.color', 'colorMode');\n+    }\n+    optionsMap.set(this, inspectOptions);\n+  }\n+\n   // bind the prototype functions to this Console instance\n   var keys = Object.keys(Console.prototype);\n   for (var v = 0; v < keys.length; v++) {\n@@ -243,6 +256,14 @@ Console.prototype[kGetInspectOptions] = function(stream) {\n         stream.getColorDepth() > 2 : true);\n   }\n \n+  const options = optionsMap.get(this);\n+  if (options) {\n+    if (options.colors === undefined) {\n+      options.colors = color;\n+    }\n+    return options;\n+  }\n+\n   return color ? kColorInspectOptions : kNoColorInspectOptions;\n };\n "
        },
        {
            "sha": "174281f8a279056d313a6d2267685015b30ad83d",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/be3ae339360c9833a77ebf5772786d75b7a8dd78/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/be3ae339360c9833a77ebf5772786d75b7a8dd78/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=be3ae339360c9833a77ebf5772786d75b7a8dd78",
            "patch": "@@ -686,6 +686,8 @@ E('ERR_HTTP_INVALID_HEADER_VALUE',\n E('ERR_HTTP_INVALID_STATUS_CODE', 'Invalid status code: %s', RangeError);\n E('ERR_HTTP_TRAILER_INVALID',\n   'Trailers are invalid with this transfer encoding', Error);\n+E('ERR_INCOMPATIBLE_OPTION_PAIR',\n+  'Option \"%s\" can not be used in combination with option \"%s\"', TypeError);\n E('ERR_INSPECTOR_ALREADY_CONNECTED', '%s is already connected', Error);\n E('ERR_INSPECTOR_CLOSED', 'Session was closed', Error);\n E('ERR_INSPECTOR_NOT_AVAILABLE', 'Inspector is not available', Error);"
        },
        {
            "sha": "85a0e61e381170d702ed85fdaa217248fd098cbc",
            "filename": "test/parallel/test-console-tty-colors.js",
            "status": "modified",
            "additions": 29,
            "deletions": 4,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/be3ae339360c9833a77ebf5772786d75b7a8dd78/test%2Fparallel%2Ftest-console-tty-colors.js",
            "raw_url": "https://github.com/nodejs/node/raw/be3ae339360c9833a77ebf5772786d75b7a8dd78/test%2Fparallel%2Ftest-console-tty-colors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-console-tty-colors.js?ref=be3ae339360c9833a77ebf5772786d75b7a8dd78",
            "patch": "@@ -5,7 +5,7 @@ const util = require('util');\n const { Writable } = require('stream');\n const { Console } = require('console');\n \n-function check(isTTY, colorMode, expectedColorMode) {\n+function check(isTTY, colorMode, expectedColorMode, inspectOptions) {\n   const items = [\n     1,\n     { a: 2 },\n@@ -18,7 +18,8 @@ function check(isTTY, colorMode, expectedColorMode) {\n     write: common.mustCall((chunk, enc, cb) => {\n       assert.strictEqual(chunk.trim(),\n                          util.inspect(items[i++], {\n-                           colors: expectedColorMode\n+                           colors: expectedColorMode,\n+                           ...inspectOptions\n                          }));\n       cb();\n     }, items.length),\n@@ -31,7 +32,8 @@ function check(isTTY, colorMode, expectedColorMode) {\n   const testConsole = new Console({\n     stdout: stream,\n     ignoreErrors: false,\n-    colorMode\n+    colorMode,\n+    inspectOptions\n   });\n   for (const item of items) {\n     testConsole.log(item);\n@@ -40,12 +42,15 @@ function check(isTTY, colorMode, expectedColorMode) {\n \n check(true, 'auto', true);\n check(false, 'auto', false);\n+check(false, undefined, true, { colors: true, compact: false });\n+check(true, 'auto', true, { compact: false });\n+check(true, undefined, false, { colors: false });\n check(true, true, true);\n check(false, true, true);\n check(true, false, false);\n check(false, false, false);\n \n-// check invalid colorMode type\n+// Check invalid options.\n {\n   const stream = new Writable({\n     write: common.mustNotCall()\n@@ -67,4 +72,24 @@ check(false, false, false);\n       }\n     );\n   });\n+\n+  [true, false, 'auto'].forEach((colorMode) => {\n+    assert.throws(\n+      () => {\n+        new Console({\n+          stdout: stream,\n+          ignoreErrors: false,\n+          colorMode: colorMode,\n+          inspectOptions: {\n+            colors: false\n+          }\n+        });\n+      },\n+      {\n+        message: 'Option \"inspectOptions.color\" can not be used in ' +\n+                 'combination with option \"colorMode\"',\n+        code: 'ERR_INCOMPATIBLE_OPTION_PAIR'\n+      }\n+    );\n+  });\n }"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 66,
        "deletions": 6
    }
}