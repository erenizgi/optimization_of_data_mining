{
    "author": "joyeecheung",
    "message": "process: make internal/queue_microtask.js more self-contained\n\n- Instead of passing triggerFatalException through node.js,\n  simply put it on `internalBinding('util')` which has to be\n  loaded anyway.\n- Expose the implementation of `queueMicrotask` directly instead\n  of through an unnecessary factory function.\n\nPR-URL: https://github.com/nodejs/node/pull/25189\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "8a60be4f0fd6a8f6591b7d591e20960fc4372fe4",
    "files": [
        {
            "sha": "3c14d4851af308cff423ee4315097c2f10b220cc",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=8a60be4f0fd6a8f6591b7d591e20960fc4372fe4",
            "patch": "@@ -14,8 +14,7 @@\n \n // This file is compiled as if it's wrapped in a function with arguments\n // passed by node::LoadEnvironment()\n-/* global process, loaderExports, triggerFatalException */\n-/* global isMainThread */\n+/* global process, loaderExports, isMainThread */\n \n const { internalBinding, NativeModule } = loaderExports;\n \n@@ -605,12 +604,12 @@ function setupGlobalEncoding() {\n \n function setupQueueMicrotask() {\n   Object.defineProperty(global, 'queueMicrotask', {\n-    get: () => {\n+    get() {\n       process.emitWarning('queueMicrotask() is experimental.',\n                           'ExperimentalWarning');\n-      const { setupQueueMicrotask } =\n+      const { queueMicrotask } =\n         NativeModule.require('internal/queue_microtask');\n-      const queueMicrotask = setupQueueMicrotask(triggerFatalException);\n+\n       Object.defineProperty(global, 'queueMicrotask', {\n         value: queueMicrotask,\n         writable: true,\n@@ -619,7 +618,7 @@ function setupQueueMicrotask() {\n       });\n       return queueMicrotask;\n     },\n-    set: (v) => {\n+    set(v) {\n       Object.defineProperty(global, 'queueMicrotask', {\n         value: v,\n         writable: true,"
        },
        {
            "sha": "6ca0c1e144a92b9a78922ece1e20d58fafe64dc2",
            "filename": "lib/internal/queue_microtask.js",
            "status": "modified",
            "additions": 28,
            "deletions": 29,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/lib%2Finternal%2Fqueue_microtask.js",
            "raw_url": "https://github.com/nodejs/node/raw/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/lib%2Finternal%2Fqueue_microtask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fqueue_microtask.js?ref=8a60be4f0fd6a8f6591b7d591e20960fc4372fe4",
            "patch": "@@ -3,37 +3,36 @@\n const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n const { AsyncResource } = require('async_hooks');\n const { getDefaultTriggerAsyncId } = require('internal/async_hooks');\n-const { enqueueMicrotask } = internalBinding('util');\n+const {\n+  enqueueMicrotask,\n+  triggerFatalException\n+} = internalBinding('util');\n \n-const setupQueueMicrotask = (triggerFatalException) => {\n-  const queueMicrotask = (callback) => {\n-    if (typeof callback !== 'function') {\n-      throw new ERR_INVALID_ARG_TYPE('callback', 'function', callback);\n-    }\n+function queueMicrotask(callback) {\n+  if (typeof callback !== 'function') {\n+    throw new ERR_INVALID_ARG_TYPE('callback', 'function', callback);\n+  }\n \n-    const asyncResource = new AsyncResource('Microtask', {\n-      triggerAsyncId: getDefaultTriggerAsyncId(),\n-      requireManualDestroy: true,\n-    });\n+  const asyncResource = new AsyncResource('Microtask', {\n+    triggerAsyncId: getDefaultTriggerAsyncId(),\n+    requireManualDestroy: true,\n+  });\n \n-    enqueueMicrotask(() => {\n-      asyncResource.runInAsyncScope(() => {\n-        try {\n-          callback();\n-        } catch (error) {\n-          // TODO(devsnek) remove this if\n-          // https://bugs.chromium.org/p/v8/issues/detail?id=8326\n-          // is resolved such that V8 triggers the fatal exception\n-          // handler for microtasks\n-          triggerFatalException(error);\n-        } finally {\n-          asyncResource.emitDestroy();\n-        }\n-      });\n+  enqueueMicrotask(() => {\n+    asyncResource.runInAsyncScope(() => {\n+      try {\n+        callback();\n+      } catch (error) {\n+        // TODO(devsnek) remove this if\n+        // https://bugs.chromium.org/p/v8/issues/detail?id=8326\n+        // is resolved such that V8 triggers the fatal exception\n+        // handler for microtasks\n+        triggerFatalException(error);\n+      } finally {\n+        asyncResource.emitDestroy();\n+      }\n     });\n-  };\n-\n-  return queueMicrotask;\n-};\n+  });\n+}\n \n-module.exports = { setupQueueMicrotask };\n+module.exports = { queueMicrotask };"
        },
        {
            "sha": "bc359903be1b7a1696a554a7741699ce93ac3ab7",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=8a60be4f0fd6a8f6591b7d591e20960fc4372fe4",
            "patch": "@@ -1200,18 +1200,14 @@ void LoadEnvironment(Environment* env) {\n     return;\n   }\n \n-  // process, bootstrappers, loaderExports, triggerFatalException\n+  // process, loaderExports, isMainThread\n   std::vector<Local<String>> node_params = {\n       env->process_string(),\n       FIXED_ONE_BYTE_STRING(isolate, \"loaderExports\"),\n-      FIXED_ONE_BYTE_STRING(isolate, \"triggerFatalException\"),\n       FIXED_ONE_BYTE_STRING(isolate, \"isMainThread\")};\n   std::vector<Local<Value>> node_args = {\n       process,\n       loader_exports.ToLocalChecked(),\n-      env->NewFunctionTemplate(FatalException)\n-          ->GetFunction(context)\n-          .ToLocalChecked(),\n       Boolean::New(isolate, env->is_main_thread())};\n \n   if (ExecuteBootstrapper("
        },
        {
            "sha": "2bc210677567a38e70bd4a17a6c1102b3dc9f871",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8a60be4f0fd6a8f6591b7d591e20960fc4372fe4/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=8a60be4f0fd6a8f6591b7d591e20960fc4372fe4",
            "patch": "@@ -1,4 +1,5 @@\n #include \"node_internals.h\"\n+#include \"node_errors.h\"\n #include \"node_watchdog.h\"\n \n namespace node {\n@@ -221,7 +222,7 @@ void Initialize(Local<Object> target,\n                              WatchdogHasPendingSigint);\n \n   env->SetMethod(target, \"enqueueMicrotask\", EnqueueMicrotask);\n-\n+  env->SetMethod(target, \"triggerFatalException\", FatalException);\n   Local<Object> constants = Object::New(env->isolate());\n   NODE_DEFINE_CONSTANT(constants, ALL_PROPERTIES);\n   NODE_DEFINE_CONSTANT(constants, ONLY_WRITABLE);"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 36,
        "deletions": 41
    }
}