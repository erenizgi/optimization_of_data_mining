{
    "author": "TimothyGu",
    "message": "perf_hooks: fix timing\n\nFixes: https://github.com/nodejs/node/issues/17892\nFixes: https://github.com/nodejs/node/issues/17893\nFixes: https://github.com/nodejs/node/issues/18992\n\nPR-URL: https://github.com/nodejs/node/pull/18993\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "9256dbb6115021fb69d5ccc2af0f7e27b0601007",
    "files": [
        {
            "sha": "98cc41276a4122e018e1a359bdf4c37cdf7db353",
            "filename": "doc/api/perf_hooks.md",
            "status": "modified",
            "additions": 20,
            "deletions": 11,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/doc%2Fapi%2Fperf_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/doc%2Fapi%2Fperf_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fperf_hooks.md?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -181,7 +181,8 @@ added: v8.5.0\n \n * Returns: {number}\n \n-Returns the current high resolution millisecond timestamp.\n+Returns the current high resolution millisecond timestamp, where 0 represents\n+the start of the current `node` process.\n \n ### performance.timeOrigin\n <!-- YAML\n@@ -190,8 +191,8 @@ added: v8.5.0\n \n * {number}\n \n-The [`timeOrigin`][] specifies the high resolution millisecond timestamp from\n-which all performance metric durations are measured.\n+The [`timeOrigin`][] specifies the high resolution millisecond timestamp at\n+which the current `node` process began, measured in Unix time.\n \n ### performance.timerify(fn)\n <!-- YAML\n@@ -302,7 +303,8 @@ added: v8.5.0\n * {number}\n \n The high resolution millisecond timestamp at which the Node.js process\n-completed bootstrap.\n+completed bootstrapping. If bootstrapping has not yet finished, the property\n+has the value of -1.\n \n ### performanceNodeTiming.clusterSetupEnd\n <!-- YAML\n@@ -311,7 +313,8 @@ added: v8.5.0\n \n * {number}\n \n-The high resolution millisecond timestamp at which cluster processing ended.\n+The high resolution millisecond timestamp at which cluster processing ended. If\n+cluster processing has not yet ended, the property has the value of -1.\n \n ### performanceNodeTiming.clusterSetupStart\n <!-- YAML\n@@ -321,6 +324,7 @@ added: v8.5.0\n * {number}\n \n The high resolution millisecond timestamp at which cluster processing started.\n+If cluster processing has not yet started, the property has the value of -1.\n \n ### performanceNodeTiming.loopExit\n <!-- YAML\n@@ -330,7 +334,8 @@ added: v8.5.0\n * {number}\n \n The high resolution millisecond timestamp at which the Node.js event loop\n-exited.\n+exited. If the event loop has not yet exited, the property has the value of -1.\n+It can only have a value of not -1 in a handler of the [`'exit'`][] event.\n \n ### performanceNodeTiming.loopStart\n <!-- YAML\n@@ -340,7 +345,8 @@ added: v8.5.0\n * {number}\n \n The high resolution millisecond timestamp at which the Node.js event loop\n-started.\n+started. If the event loop has not yet started (e.g., in the first tick of the\n+main script), the property has the value of -1.\n \n ### performanceNodeTiming.moduleLoadEnd\n <!-- YAML\n@@ -395,8 +401,9 @@ added: v8.5.0\n \n * {number}\n \n-The high resolution millisecond timestamp at which third_party_main processing\n-ended.\n+The high resolution millisecond timestamp at which third\\_party\\_main\n+processing ended. If third\\_party\\_main processing has not yet ended, the\n+property has the value of -1.\n \n ### performanceNodeTiming.thirdPartyMainStart\n <!-- YAML\n@@ -405,8 +412,9 @@ added: v8.5.0\n \n * {number}\n \n-The high resolution millisecond timestamp at which third_party_main processing\n-started.\n+The high resolution millisecond timestamp at which third\\_party\\_main\n+processing started. If third\\_party\\_main processing has not yet started, the\n+property has the value of -1.\n \n ### performanceNodeTiming.v8Start\n <!-- YAML\n@@ -642,6 +650,7 @@ obs.observe({ entryTypes: ['function'], buffered: true });\n require('some-module');\n ```\n \n+[`'exit'`]: process.html#process_event_exit\n [`timeOrigin`]: https://w3c.github.io/hr-time/#dom-performance-timeorigin\n [Async Hooks]: async_hooks.html\n [W3C Performance Timeline]: https://w3c.github.io/performance-timeline/"
        },
        {
            "sha": "e4c2a985e4b2e3f5ab34d46f819a09c5bb7e8e23",
            "filename": "lib/perf_hooks.js",
            "status": "modified",
            "additions": 33,
            "deletions": 19,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/lib%2Fperf_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/lib%2Fperf_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fperf_hooks.js?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -8,6 +8,7 @@ const {\n   observerCounts,\n   setupObservers,\n   timeOrigin,\n+  timeOriginTimestamp,\n   timerify,\n   constants\n } = process.binding('performance');\n@@ -146,6 +147,13 @@ function now() {\n   return hr[0] * 1000 + hr[1] / 1e6;\n }\n \n+function getMilestoneTimestamp(milestoneIdx) {\n+  const ns = milestones[milestoneIdx];\n+  if (ns === -1)\n+    return ns;\n+  return ns / 1e6 - timeOrigin;\n+}\n+\n class PerformanceNodeTiming {\n   constructor() {}\n \n@@ -158,67 +166,72 @@ class PerformanceNodeTiming {\n   }\n \n   get startTime() {\n-    return timeOrigin;\n+    return 0;\n   }\n \n   get duration() {\n     return now() - timeOrigin;\n   }\n \n   get nodeStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_NODE_START];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_NODE_START);\n   }\n \n   get v8Start() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_V8_START];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_V8_START);\n   }\n \n   get environment() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_ENVIRONMENT];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_ENVIRONMENT);\n   }\n \n   get loopStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_LOOP_START];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_LOOP_START);\n   }\n \n   get loopExit() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_LOOP_EXIT];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_LOOP_EXIT);\n   }\n \n   get bootstrapComplete() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n   }\n \n   get thirdPartyMainStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_THIRD_PARTY_MAIN_START];\n+    return getMilestoneTimestamp(\n+      NODE_PERFORMANCE_MILESTONE_THIRD_PARTY_MAIN_START);\n   }\n \n   get thirdPartyMainEnd() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_THIRD_PARTY_MAIN_END];\n+    return getMilestoneTimestamp(\n+      NODE_PERFORMANCE_MILESTONE_THIRD_PARTY_MAIN_END);\n   }\n \n   get clusterSetupStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_CLUSTER_SETUP_START];\n+    return getMilestoneTimestamp(\n+      NODE_PERFORMANCE_MILESTONE_CLUSTER_SETUP_START);\n   }\n \n   get clusterSetupEnd() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_CLUSTER_SETUP_END];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_CLUSTER_SETUP_END);\n   }\n \n   get moduleLoadStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_START];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_START);\n   }\n \n   get moduleLoadEnd() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_END];\n+    return getMilestoneTimestamp(NODE_PERFORMANCE_MILESTONE_MODULE_LOAD_END);\n   }\n \n   get preloadModuleLoadStart() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_START];\n+    return getMilestoneTimestamp(\n+      NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_START);\n   }\n \n   get preloadModuleLoadEnd() {\n-    return milestones[NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_END];\n+    return getMilestoneTimestamp(\n+      NODE_PERFORMANCE_MILESTONE_PRELOAD_MODULE_LOAD_END);\n   }\n \n   [kInspect]() {\n@@ -467,11 +480,11 @@ class Performance extends PerformanceObserverEntryList {\n   }\n \n   get timeOrigin() {\n-    return timeOrigin;\n+    return timeOriginTimestamp;\n   }\n \n   now() {\n-    return now();\n+    return now() - timeOrigin;\n   }\n \n   mark(name) {\n@@ -550,8 +563,9 @@ class Performance extends PerformanceObserverEntryList {\n \n   [kInspect]() {\n     return {\n-      timeOrigin,\n-      nodeTiming\n+      maxEntries: this.maxEntries,\n+      nodeTiming: this.nodeTiming,\n+      timeOrigin: this.timeOrigin\n     };\n   }\n }"
        },
        {
            "sha": "bf9746e429d31c8e6dcb68ab142c1d404a598482",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -3,6 +3,10 @@\n \n #include <vector>\n \n+#ifdef __POSIX__\n+#include <sys/time.h>  // gettimeofday\n+#endif\n+\n namespace node {\n namespace performance {\n \n@@ -21,13 +25,38 @@ using v8::Object;\n using v8::String;\n using v8::Value;\n \n+// Microseconds in a second, as a float.\n+#define MICROS_PER_SEC 1e6\n+// Microseconds in a millisecond, as a float.\n+#define MICROS_PER_MILLIS 1e3\n+\n+// https://w3c.github.io/hr-time/#dfn-time-origin\n const uint64_t timeOrigin = PERFORMANCE_NOW();\n+// https://w3c.github.io/hr-time/#dfn-time-origin-timestamp\n+const double timeOriginTimestamp = GetCurrentTimeInMicroseconds();\n uint64_t performance_node_start;\n uint64_t performance_v8_start;\n \n uint64_t performance_last_gc_start_mark_ = 0;\n v8::GCType performance_last_gc_type_ = v8::GCType::kGCTypeAll;\n \n+double GetCurrentTimeInMicroseconds() {\n+#ifdef _WIN32\n+// The difference between the Unix Epoch and the Windows Epoch in 100-ns ticks.\n+#define TICKS_TO_UNIX_EPOCH 116444736000000000LL\n+  FILETIME ft;\n+  GetSystemTimeAsFileTime(&ft);\n+  uint64_t filetime_int = static_cast<uint64_t>(ft.dwHighDateTime) << 32 |\n+                          ft.dwLowDateTime;\n+  // FILETIME is measured in terms of 100 ns. Convert that to 1 us (1000 ns).\n+  return (filetime_int - TICKS_TO_UNIX_EPOCH) / 10.;\n+#else\n+  struct timeval tp;\n+  gettimeofday(&tp, nullptr);\n+  return MICROS_PER_SEC * tp.tv_sec + tp.tv_usec;\n+#endif\n+}\n+\n // Initialize the performance entry object properties\n inline void InitObject(const PerformanceEntry& entry, Local<Object> obj) {\n   Environment* env = entry.env();\n@@ -384,6 +413,12 @@ void Init(Local<Object> target,\n                             v8::Number::New(isolate, timeOrigin / 1e6),\n                             attr).ToChecked();\n \n+  target->DefineOwnProperty(\n+      context,\n+      FIXED_ONE_BYTE_STRING(isolate, \"timeOriginTimestamp\"),\n+      v8::Number::New(isolate, timeOriginTimestamp / MICROS_PER_MILLIS),\n+      attr).ToChecked();\n+\n   target->DefineOwnProperty(context,\n                             env->constants_string(),\n                             constants,"
        },
        {
            "sha": "0db99acd03e947b640b37ab4fdecc45c9b48d68b",
            "filename": "src/node_perf.h",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf.h",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.h?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -23,6 +23,10 @@ using v8::Local;\n using v8::Object;\n using v8::Value;\n \n+extern const uint64_t timeOrigin;\n+\n+double GetCurrentTimeInMicroseconds();\n+\n static inline PerformanceMilestone ToPerformanceMilestoneEnum(const char* str) {\n #define V(name, label)                                                        \\\n   if (strcmp(str, label) == 0) return NODE_PERFORMANCE_MILESTONE_##name;\n@@ -78,11 +82,11 @@ class PerformanceEntry {\n     return ToPerformanceEntryTypeEnum(type().c_str());\n   }\n \n-  double startTime() const { return startTime_ / 1e6; }\n+  double startTime() const { return startTimeNano() / 1e6; }\n \n   double duration() const { return durationNano() / 1e6; }\n \n-  uint64_t startTimeNano() const { return startTime_; }\n+  uint64_t startTimeNano() const { return startTime_ - timeOrigin; }\n \n   uint64_t durationNano() const { return endTime_ - startTime_; }\n "
        },
        {
            "sha": "7ff57359ba5cb8ac93bdd8ae91fee8a41a497843",
            "filename": "src/node_perf_common.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf_common.h",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/src%2Fnode_perf_common.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf_common.h?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -4,6 +4,7 @@\n #include \"node.h\"\n #include \"v8.h\"\n \n+#include <algorithm>\n #include <map>\n #include <string>\n \n@@ -76,7 +77,10 @@ class performance_state {\n       isolate,\n       offsetof(performance_state_internal, observers),\n       NODE_PERFORMANCE_ENTRY_TYPE_INVALID,\n-      root) {}\n+      root) {\n+    for (size_t i = 0; i < milestones.Length(); i++)\n+      milestones[i] = -1.;\n+  }\n \n   AliasedBuffer<uint8_t, v8::Uint8Array> root;\n   AliasedBuffer<double, v8::Float64Array> milestones;"
        },
        {
            "sha": "770ca7bf6407be7ed124c0e3c2893802fbda74cb",
            "filename": "test/parallel/test-performance.js",
            "status": "modified",
            "additions": 83,
            "deletions": 19,
            "changes": 102,
            "blob_url": "https://github.com/nodejs/node/blob/9256dbb6115021fb69d5ccc2af0f7e27b0601007/test%2Fparallel%2Ftest-performance.js",
            "raw_url": "https://github.com/nodejs/node/raw/9256dbb6115021fb69d5ccc2af0f7e27b0601007/test%2Fparallel%2Ftest-performance.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performance.js?ref=9256dbb6115021fb69d5ccc2af0f7e27b0601007",
            "patch": "@@ -7,6 +7,12 @@ const { performance } = require('perf_hooks');\n assert(performance);\n assert(performance.nodeTiming);\n assert.strictEqual(typeof performance.timeOrigin, 'number');\n+// Use a fairly large epsilon value, since we can only guarantee that the node\n+// process started up in 20 seconds.\n+assert(Math.abs(performance.timeOrigin - Date.now()) < 20000);\n+\n+const inited = performance.now();\n+assert(inited < 20000);\n \n {\n   const entries = performance.getEntries();\n@@ -104,23 +110,81 @@ assert.strictEqual(typeof performance.timeOrigin, 'number');\n assert.strictEqual(performance.nodeTiming.name, 'node');\n assert.strictEqual(performance.nodeTiming.entryType, 'node');\n \n-[\n-  'startTime',\n-  'duration',\n-  'nodeStart',\n-  'v8Start',\n-  'bootstrapComplete',\n-  'environment',\n-  'loopStart',\n-  'loopExit',\n-  'thirdPartyMainStart',\n-  'thirdPartyMainEnd',\n-  'clusterSetupStart',\n-  'clusterSetupEnd',\n-  'moduleLoadStart',\n-  'moduleLoadEnd',\n-  'preloadModuleLoadStart',\n-  'preloadModuleLoadEnd'\n-].forEach((i) => {\n-  assert.strictEqual(typeof performance.nodeTiming[i], 'number');\n+function checkNodeTiming(props) {\n+  for (const prop of Object.keys(props)) {\n+    if (props[prop].around !== undefined) {\n+      assert.strictEqual(typeof performance.nodeTiming[prop], 'number');\n+      const delta = performance.nodeTiming[prop] - props[prop].around;\n+      assert(Math.abs(delta) < 1000);\n+    } else {\n+      assert.strictEqual(performance.nodeTiming[prop], props[prop]);\n+    }\n+  }\n+}\n+\n+checkNodeTiming({\n+  name: 'node',\n+  entryType: 'node',\n+  startTime: 0,\n+  duration: { around: performance.now() },\n+  nodeStart: { around: 0 },\n+  v8Start: { around: 0 },\n+  bootstrapComplete: -1,\n+  environment: { around: 0 },\n+  loopStart: -1,\n+  loopExit: -1,\n+  thirdPartyMainStart: -1,\n+  thirdPartyMainEnd: -1,\n+  clusterSetupStart: -1,\n+  clusterSetupEnd: -1,\n+  moduleLoadStart: { around: inited },\n+  moduleLoadEnd: { around: inited },\n+  preloadModuleLoadStart: { around: inited },\n+  preloadModuleLoadEnd: { around: inited },\n+});\n+\n+setTimeout(() => {\n+  checkNodeTiming({\n+    name: 'node',\n+    entryType: 'node',\n+    startTime: 0,\n+    duration: { around: performance.now() },\n+    nodeStart: { around: 0 },\n+    v8Start: { around: 0 },\n+    bootstrapComplete: { around: inited },\n+    environment: { around: 0 },\n+    loopStart: { around: inited },\n+    loopExit: -1,\n+    thirdPartyMainStart: -1,\n+    thirdPartyMainEnd: -1,\n+    clusterSetupStart: -1,\n+    clusterSetupEnd: -1,\n+    moduleLoadStart: { around: inited },\n+    moduleLoadEnd: { around: inited },\n+    preloadModuleLoadStart: { around: inited },\n+    preloadModuleLoadEnd: { around: inited },\n+  });\n+}, 2000);\n+\n+process.on('exit', () => {\n+  checkNodeTiming({\n+    name: 'node',\n+    entryType: 'node',\n+    startTime: 0,\n+    duration: { around: performance.now() },\n+    nodeStart: { around: 0 },\n+    v8Start: { around: 0 },\n+    bootstrapComplete: { around: inited },\n+    environment: { around: 0 },\n+    loopStart: { around: inited },\n+    loopExit: { around: performance.now() },\n+    thirdPartyMainStart: -1,\n+    thirdPartyMainEnd: -1,\n+    clusterSetupStart: -1,\n+    clusterSetupEnd: -1,\n+    moduleLoadStart: { around: inited },\n+    moduleLoadEnd: { around: inited },\n+    preloadModuleLoadStart: { around: inited },\n+    preloadModuleLoadEnd: { around: inited },\n+  });\n });"
        }
    ],
    "stats": {
        "total": 234,
        "additions": 182,
        "deletions": 52
    }
}