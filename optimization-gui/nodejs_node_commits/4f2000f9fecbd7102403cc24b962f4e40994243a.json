{
    "author": "apapirovski",
    "message": "timers: call destroy on interval error\n\nWhen an interval callback throws an error, the destroy\nhook is never called due to a faulty if condition.\n\nPR-URL: https://github.com/nodejs/node/pull/20001\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "4f2000f9fecbd7102403cc24b962f4e40994243a",
    "files": [
        {
            "sha": "15700f5a1212ab7a55baff100d9f1165bf62e314",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/4f2000f9fecbd7102403cc24b962f4e40994243a/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/4f2000f9fecbd7102403cc24b962f4e40994243a/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=4f2000f9fecbd7102403cc24b962f4e40994243a",
            "patch": "@@ -292,7 +292,7 @@ function tryOnTimeout(timer, start) {\n     if (timerAsyncId !== null) {\n       if (!threw)\n         emitAfter(timerAsyncId);\n-      if (!timer._repeat && destroyHooksExist() &&\n+      if ((threw || !timer._repeat) && destroyHooksExist() &&\n           !timer._destroyed) {\n         emitDestroy(timerAsyncId);\n         timer._destroyed = true;"
        },
        {
            "sha": "a3434e134fab0291aa5d814c449ce3bb4b88164c",
            "filename": "test/async-hooks/test-timers.setInterval.js",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/4f2000f9fecbd7102403cc24b962f4e40994243a/test%2Fasync-hooks%2Ftest-timers.setInterval.js",
            "raw_url": "https://github.com/nodejs/node/raw/4f2000f9fecbd7102403cc24b962f4e40994243a/test%2Fasync-hooks%2Ftest-timers.setInterval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-timers.setInterval.js?ref=4f2000f9fecbd7102403cc24b962f4e40994243a",
            "patch": "@@ -0,0 +1,37 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const initHooks = require('./init-hooks');\n+const { checkInvocations } = require('./hook-checks');\n+const TIMEOUT = common.platformTimeout(100);\n+\n+const hooks = initHooks();\n+hooks.enable();\n+\n+setInterval(common.mustCall(ontimeout), TIMEOUT);\n+const as = hooks.activitiesOfTypes('Timeout');\n+assert.strictEqual(as.length, 1);\n+const t1 = as[0];\n+assert.strictEqual(t1.type, 'Timeout');\n+assert.strictEqual(typeof t1.uid, 'number');\n+assert.strictEqual(typeof t1.triggerAsyncId, 'number');\n+checkInvocations(t1, { init: 1 }, 't1: when timer installed');\n+\n+function ontimeout() {\n+  checkInvocations(t1, { init: 1, before: 1 }, 't1: when first timer fired');\n+\n+  throw new Error('setInterval Error');\n+}\n+\n+process.once('uncaughtException', common.mustCall((err) => {\n+  assert.strictEqual(err.message, 'setInterval Error');\n+}));\n+\n+process.on('exit', () => {\n+  hooks.disable();\n+  hooks.sanityCheck('Timeout');\n+\n+  checkInvocations(t1, { init: 1, before: 1, after: 1, destroy: 1 },\n+                   't1: when process exits');\n+});"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}