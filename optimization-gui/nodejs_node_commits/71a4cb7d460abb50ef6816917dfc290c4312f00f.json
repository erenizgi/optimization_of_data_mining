{
    "author": "addaleax",
    "message": "tracing: fix static destruction order issue\n\nSometimes, the `parallel/test-tracing-no-crash` would not work as\nexpected, at least on Windows, because there is a static destruction\nrace between tearing down the `NodeTraceWriter` instance and the\nper-process options struct. If the per-process options were destroyed\nbefore the `NodeTraceWriter`, the reference to the tracing filename\nwould be gone before opening the file was attempted.\n\nThis can be solved by creating a copy of the string when creating the\n`NodeTraceWriter` instance rather than taking a reference.\n\nFixes: https://github.com/nodejs/node/issues/22523\n\nPR-URL: https://github.com/nodejs/node/pull/24123\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "71a4cb7d460abb50ef6816917dfc290c4312f00f",
    "files": [
        {
            "sha": "a91176ad4905a9f6808ac191ddf58dd7edb847a5",
            "filename": "src/tracing/node_trace_writer.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/71a4cb7d460abb50ef6816917dfc290c4312f00f/src%2Ftracing%2Fnode_trace_writer.h",
            "raw_url": "https://github.com/nodejs/node/raw/71a4cb7d460abb50ef6816917dfc290c4312f00f/src%2Ftracing%2Fnode_trace_writer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.h?ref=71a4cb7d460abb50ef6816917dfc290c4312f00f",
            "patch": "@@ -61,7 +61,7 @@ class NodeTraceWriter : public AsyncTraceWriter {\n   int highest_request_id_completed_ = 0;\n   int total_traces_ = 0;\n   int file_num_ = 0;\n-  const std::string& log_file_pattern_;\n+  std::string log_file_pattern_;\n   std::ostringstream stream_;\n   std::unique_ptr<TraceWriter> json_trace_writer_;\n   bool exited_ = false;"
        },
        {
            "sha": "0ae402f5288cca5870fec18cc531eb16560781c8",
            "filename": "test/parallel/test-tracing-no-crash.js",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/71a4cb7d460abb50ef6816917dfc290c4312f00f/test%2Fparallel%2Ftest-tracing-no-crash.js",
            "raw_url": "https://github.com/nodejs/node/raw/71a4cb7d460abb50ef6816917dfc290c4312f00f/test%2Fparallel%2Ftest-tracing-no-crash.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tracing-no-crash.js?ref=71a4cb7d460abb50ef6816917dfc290c4312f00f",
            "patch": "@@ -8,7 +8,15 @@ function CheckNoSignalAndErrorCodeOne(code, signal) {\n   assert.strictEqual(code, 1);\n }\n \n-const child = spawn(process.execPath,\n-                    ['--trace-event-categories', 'madeup', '-e',\n-                     'throw new Error()'], { stdio: 'inherit' });\n+const child = spawn(process.execPath, [\n+  '--trace-event-categories', 'madeup', '-e', 'throw new Error()'\n+], { stdio: [ 'inherit', 'inherit', 'pipe' ] });\n child.on('exit', common.mustCall(CheckNoSignalAndErrorCodeOne));\n+\n+let stderr;\n+child.stderr.setEncoding('utf8');\n+child.stderr.on('data', (chunk) => stderr += chunk);\n+child.stderr.on('end', common.mustCall(() => {\n+  assert(stderr.includes('throw new Error()'), stderr);\n+  assert(!stderr.includes('Could not open trace file'), stderr);\n+}));"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 12,
        "deletions": 4
    }
}