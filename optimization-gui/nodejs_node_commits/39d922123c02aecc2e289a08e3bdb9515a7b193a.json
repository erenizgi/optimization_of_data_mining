{
    "author": "joyeecheung",
    "message": "lib: save primordials during bootstrap and use it in builtins\n\nThis patches changes the `safe_globals` internal module into a\nscript that gets run during bootstrap and saves JavaScript builtins\n(primordials) into an object that is available for all other builtin\nmodules to access lexically later.\n\nPR-URL: https://github.com/nodejs/node/pull/25816\nRefs: https://github.com/nodejs/node/issues/18795\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "39d922123c02aecc2e289a08e3bdb9515a7b193a",
    "files": [
        {
            "sha": "181fb9cead2090e683b5b18b24684570cd277770",
            "filename": "lib/.eslintrc.yaml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2F.eslintrc.yaml",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2F.eslintrc.yaml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F.eslintrc.yaml?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -46,3 +46,4 @@ globals:\n   DCHECK_LT: false\n   DCHECK_NE: false\n   internalBinding: false\n+  primordials: false"
        },
        {
            "sha": "8273b6f27fd0b3de5ce080d01bba83b0fae0f76e",
            "filename": "lib/internal/bootstrap/cache.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fcache.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -22,6 +22,7 @@ const cannotBeRequired = [\n \n   'internal/test/binding',\n \n+  'internal/bootstrap/primordials',\n   'internal/bootstrap/loaders',\n   'internal/bootstrap/node'\n ];"
        },
        {
            "sha": "1007b41069c723f53e9437285bb21d3dc72285d8",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 26,
            "deletions": 50,
            "changes": 76,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -40,33 +40,20 @@\n 'use strict';\n \n // This file is compiled as if it's wrapped in a function with arguments\n-// passed by node::LoadEnvironment()\n+// passed by node::RunBootstrapping()\n /* global process, getBinding, getLinkedBinding, getInternalBinding */\n-/* global debugBreak, experimentalModules, exposeInternals */\n+/* global experimentalModules, exposeInternals, primordials */\n \n-if (debugBreak)\n-  debugger; // eslint-disable-line no-debugger\n-\n-const {\n-  apply: ReflectApply,\n-  deleteProperty: ReflectDeleteProperty,\n-  get: ReflectGet,\n-  getOwnPropertyDescriptor: ReflectGetOwnPropertyDescriptor,\n-  has: ReflectHas,\n-  set: ReflectSet,\n-} = Reflect;\n const {\n-  prototype: {\n-    hasOwnProperty: ObjectHasOwnProperty,\n-  },\n-  create: ObjectCreate,\n-  defineProperty: ObjectDefineProperty,\n-  keys: ObjectKeys,\n-} = Object;\n+  Reflect,\n+  Object,\n+  ObjectPrototype,\n+  SafeSet\n+} = primordials;\n \n // Set up process.moduleLoadList.\n const moduleLoadList = [];\n-ObjectDefineProperty(process, 'moduleLoadList', {\n+Object.defineProperty(process, 'moduleLoadList', {\n   value: moduleLoadList,\n   configurable: true,\n   enumerable: true,\n@@ -78,7 +65,7 @@ ObjectDefineProperty(process, 'moduleLoadList', {\n // that are whitelisted for access via process.binding()... This is used\n // to provide a transition path for modules that are being moved over to\n // internalBinding.\n-const internalBindingWhitelist = [\n+const internalBindingWhitelist = new SafeSet([\n   'async_wrap',\n   'buffer',\n   'cares_wrap',\n@@ -108,20 +95,17 @@ const internalBindingWhitelist = [\n   'uv',\n   'v8',\n   'zlib'\n-];\n-// We will use a lazy loaded SafeSet in internalBindingWhitelistHas\n-// for checking existence in this list.\n-let internalBindingWhitelistSet;\n+]);\n \n // Set up process.binding() and process._linkedBinding().\n {\n-  const bindingObj = ObjectCreate(null);\n+  const bindingObj = Object.create(null);\n \n   process.binding = function binding(module) {\n     module = String(module);\n     // Deprecated specific process.binding() modules, but not all, allow\n     // selective fallback to internalBinding for the deprecated ones.\n-    if (internalBindingWhitelistHas(module)) {\n+    if (internalBindingWhitelist.has(module)) {\n       return internalBinding(module);\n     }\n     let mod = bindingObj[module];\n@@ -144,7 +128,7 @@ let internalBindingWhitelistSet;\n // Set up internalBinding() in the closure.\n let internalBinding;\n {\n-  const bindingObj = ObjectCreate(null);\n+  const bindingObj = Object.create(null);\n   internalBinding = function internalBinding(module) {\n     let mod = bindingObj[module];\n     if (typeof mod !== 'object') {\n@@ -245,8 +229,8 @@ NativeModule.requireWithFallbackInDeps = function(request) {\n };\n \n const getOwn = (target, property, receiver) => {\n-  return ReflectApply(ObjectHasOwnProperty, target, [property]) ?\n-    ReflectGet(target, property, receiver) :\n+  return Reflect.apply(ObjectPrototype.hasOwnProperty, target, [property]) ?\n+    Reflect.get(target, property, receiver) :\n     undefined;\n };\n \n@@ -255,12 +239,12 @@ const getOwn = (target, property, receiver) => {\n // as the entire namespace (module.exports) and wrapped in a proxy such\n // that APMs and other behavior are still left intact.\n NativeModule.prototype.proxifyExports = function() {\n-  this.exportKeys = ObjectKeys(this.exports);\n+  this.exportKeys = Object.keys(this.exports);\n \n   const update = (property, value) => {\n     if (this.reflect !== undefined &&\n-        ReflectApply(ObjectHasOwnProperty,\n-                     this.reflect.exports, [property]))\n+        Reflect.apply(ObjectPrototype.hasOwnProperty,\n+                      this.reflect.exports, [property]))\n       this.reflect.exports[property].set(value);\n   };\n \n@@ -269,12 +253,12 @@ NativeModule.prototype.proxifyExports = function() {\n     defineProperty: (target, prop, descriptor) => {\n       // Use `Object.defineProperty` instead of `Reflect.defineProperty`\n       // to throw the appropriate error if something goes wrong.\n-      ObjectDefineProperty(target, prop, descriptor);\n+      Object.defineProperty(target, prop, descriptor);\n       if (typeof descriptor.get === 'function' &&\n-          !ReflectHas(handler, 'get')) {\n+          !Reflect.has(handler, 'get')) {\n         handler.get = (target, prop, receiver) => {\n-          const value = ReflectGet(target, prop, receiver);\n-          if (ReflectApply(ObjectHasOwnProperty, target, [prop]))\n+          const value = Reflect.get(target, prop, receiver);\n+          if (Reflect.apply(ObjectPrototype.hasOwnProperty, target, [prop]))\n             update(prop, value);\n           return value;\n         };\n@@ -283,15 +267,15 @@ NativeModule.prototype.proxifyExports = function() {\n       return true;\n     },\n     deleteProperty: (target, prop) => {\n-      if (ReflectDeleteProperty(target, prop)) {\n+      if (Reflect.deleteProperty(target, prop)) {\n         update(prop, undefined);\n         return true;\n       }\n       return false;\n     },\n     set: (target, prop, value, receiver) => {\n-      const descriptor = ReflectGetOwnPropertyDescriptor(target, prop);\n-      if (ReflectSet(target, prop, value, receiver)) {\n+      const descriptor = Reflect.getOwnPropertyDescriptor(target, prop);\n+      if (Reflect.set(target, prop, value, receiver)) {\n         if (descriptor && typeof descriptor.set === 'function') {\n           for (const key of this.exportKeys) {\n             update(key, getOwn(target, key, receiver));\n@@ -319,7 +303,7 @@ NativeModule.prototype.compile = function() {\n       NativeModule.require;\n \n     const fn = compileFunction(id);\n-    fn(this.exports, requireFn, this, process, internalBinding);\n+    fn(this.exports, requireFn, this, process, internalBinding, primordials);\n \n     if (experimentalModules && this.canBeRequiredByUsers) {\n       this.proxifyExports();\n@@ -344,13 +328,5 @@ if (process.env.NODE_V8_COVERAGE) {\n   }\n }\n \n-function internalBindingWhitelistHas(name) {\n-  if (!internalBindingWhitelistSet) {\n-    const { SafeSet } = NativeModule.require('internal/safe_globals');\n-    internalBindingWhitelistSet = new SafeSet(internalBindingWhitelist);\n-  }\n-  return internalBindingWhitelistSet.has(name);\n-}\n-\n // This will be passed to internal/bootstrap/node.js.\n return loaderExports;"
        },
        {
            "sha": "2a97e74542a9644f12fcb213d188097a9c1cd306",
            "filename": "lib/internal/bootstrap/primordials.js",
            "status": "added",
            "additions": 84,
            "deletions": 0,
            "changes": 84,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Fprimordials.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fbootstrap%2Fprimordials.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fprimordials.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -0,0 +1,84 @@\n+'use strict';\n+\n+/* global breakAtBootstrap, primordials */\n+\n+// This file subclasses and stores the JS builtins that come from the VM\n+// so that Node.js's builtin modules do not need to later look these up from\n+// the global proxy, which can be mutated by users.\n+\n+// TODO(joyeecheung): we can restrict access to these globals in builtin\n+// modules through the JS linter, for example: ban access such as `Object`\n+// (which falls back to a lookup in the global proxy) in favor of\n+// `primordials.Object` where `primordials` is a lexical variable passed\n+// by the native module compiler.\n+\n+if (breakAtBootstrap) {\n+  debugger;  // eslint-disable-line no-debugger\n+}\n+\n+function copyProps(src, dest) {\n+  for (const key of Reflect.ownKeys(src)) {\n+    if (!Reflect.getOwnPropertyDescriptor(dest, key)) {\n+      Reflect.defineProperty(\n+        dest,\n+        key,\n+        Reflect.getOwnPropertyDescriptor(src, key));\n+    }\n+  }\n+}\n+\n+function makeSafe(unsafe, safe) {\n+  copyProps(unsafe.prototype, safe.prototype);\n+  copyProps(unsafe, safe);\n+  Object.setPrototypeOf(safe.prototype, null);\n+  Object.freeze(safe.prototype);\n+  Object.freeze(safe);\n+  return safe;\n+}\n+\n+// Subclass the constructors because we need to use their prototype\n+// methods later.\n+primordials.SafeMap = makeSafe(\n+  Map,\n+  class SafeMap extends Map {}\n+);\n+primordials.SafeWeakMap = makeSafe(\n+  WeakMap,\n+  class SafeWeakMap extends WeakMap {}\n+);\n+primordials.SafeSet = makeSafe(\n+  Set,\n+  class SafeSet extends Set {}\n+);\n+primordials.SafePromise = makeSafe(\n+  Promise,\n+  class SafePromise extends Promise {}\n+);\n+\n+// Create copies of the namespace objects\n+[\n+  'JSON',\n+  'Math',\n+  'Reflect'\n+].forEach((name) => {\n+  const target = primordials[name] = Object.create(null);\n+  copyProps(global[name], target);\n+});\n+\n+// Create copies of intrinsic objects\n+[\n+  'Array',\n+  'Date',\n+  'Function',\n+  'Object',\n+  'RegExp',\n+  'String'\n+].forEach((name) => {\n+  const target = primordials[name] = Object.create(null);\n+  copyProps(global[name], target);\n+  const proto = primordials[name + 'Prototype'] = Object.create(null);\n+  copyProps(global[name].prototype, proto);\n+});\n+\n+Object.setPrototypeOf(primordials, null);\n+Object.freeze(primordials);"
        },
        {
            "sha": "6b88f100c855887f69de29501637f1fd0f81d6c2",
            "filename": "lib/internal/error-serdes.js",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Ferror-serdes.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Ferror-serdes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferror-serdes.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -2,7 +2,13 @@\n \n const Buffer = require('buffer').Buffer;\n const { serialize, deserialize } = require('v8');\n-const { SafeSet } = require('internal/safe_globals');\n+const {\n+  SafeSet,\n+  Object,\n+  ObjectPrototype,\n+  FunctionPrototype,\n+  ArrayPrototype\n+} = primordials;\n \n const kSerializedError = 0;\n const kSerializedObject = 1;\n@@ -14,9 +20,9 @@ const GetOwnPropertyNames = Object.getOwnPropertyNames;\n const DefineProperty = Object.defineProperty;\n const Assign = Object.assign;\n const ObjectPrototypeToString =\n-    Function.prototype.call.bind(Object.prototype.toString);\n-const ForEach = Function.prototype.call.bind(Array.prototype.forEach);\n-const Call = Function.prototype.call.bind(Function.prototype.call);\n+    FunctionPrototype.call.bind(ObjectPrototype.toString);\n+const ForEach = FunctionPrototype.call.bind(ArrayPrototype.forEach);\n+const Call = FunctionPrototype.call.bind(FunctionPrototype.call);\n \n const errors = {\n   Error, TypeError, RangeError, URIError, SyntaxError, ReferenceError, EvalError"
        },
        {
            "sha": "e900babefd626101a3df29d994503c41b6524ea6",
            "filename": "lib/internal/modules/esm/module_job.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_job.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -1,7 +1,11 @@\n 'use strict';\n \n const { ModuleWrap } = internalBinding('module_wrap');\n-const { SafeSet, SafePromise } = require('internal/safe_globals');\n+const {\n+  SafeSet,\n+  SafePromise\n+} = primordials;\n+\n const { decorateErrorStack } = require('internal/util');\n const assert = require('assert');\n const resolvedPromise = SafePromise.resolve();"
        },
        {
            "sha": "1c1cd54a3d79ed9fb083c5d4e475f8d5f7dbf49a",
            "filename": "lib/internal/modules/esm/module_map.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_map.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_map.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fmodule_map.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -1,7 +1,9 @@\n 'use strict';\n \n const ModuleJob = require('internal/modules/esm/module_job');\n-const { SafeMap } = require('internal/safe_globals');\n+const {\n+  SafeMap\n+} = primordials;\n const debug = require('util').debuglog('esm');\n const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n const { validateString } = require('internal/validators');"
        },
        {
            "sha": "25552cff0e8f47ed9e7150b15acc29c32188b364",
            "filename": "lib/internal/modules/esm/translators.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Ftranslators.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -12,14 +12,19 @@ const createDynamicModule = require(\n   'internal/modules/esm/create_dynamic_module');\n const fs = require('fs');\n const { _makeLong } = require('path');\n-const { SafeMap } = require('internal/safe_globals');\n+const {\n+  SafeMap,\n+  JSON,\n+  FunctionPrototype,\n+  StringPrototype\n+} = primordials;\n const { URL } = require('url');\n const { debuglog, promisify } = require('util');\n const esmLoader = require('internal/process/esm_loader');\n \n const readFileAsync = promisify(fs.readFile);\n const readFileSync = fs.readFileSync;\n-const StringReplace = Function.call.bind(String.prototype.replace);\n+const StringReplace = FunctionPrototype.call.bind(StringPrototype.replace);\n const JsonParse = JSON.parse;\n \n const debug = debuglog('esm');"
        },
        {
            "sha": "f6adca125bdcb4db395efade7f751309d87a986d",
            "filename": "lib/internal/policy/manifest.js",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpolicy%2Fmanifest.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -6,16 +6,21 @@ const {\n } = require('internal/errors').codes;\n const debug = require('util').debuglog('policy');\n const SRI = require('internal/policy/sri');\n-const { SafeWeakMap } = require('internal/safe_globals');\n+const {\n+  SafeWeakMap,\n+  FunctionPrototype,\n+  Object,\n+  RegExpPrototype\n+} = primordials;\n const crypto = require('crypto');\n const { Buffer } = require('buffer');\n const { URL } = require('url');\n const { createHash, timingSafeEqual } = crypto;\n-const HashUpdate = Function.call.bind(crypto.Hash.prototype.update);\n-const HashDigest = Function.call.bind(crypto.Hash.prototype.digest);\n-const BufferEquals = Function.call.bind(Buffer.prototype.equals);\n-const BufferToString = Function.call.bind(Buffer.prototype.toString);\n-const RegExpTest = Function.call.bind(RegExp.prototype.test);\n+const HashUpdate = FunctionPrototype.call.bind(crypto.Hash.prototype.update);\n+const HashDigest = FunctionPrototype.call.bind(crypto.Hash.prototype.digest);\n+const BufferEquals = FunctionPrototype.call.bind(Buffer.prototype.equals);\n+const BufferToString = FunctionPrototype.call.bind(Buffer.prototype.toString);\n+const RegExpTest = FunctionPrototype.call.bind(RegExpPrototype.test);\n const { entries } = Object;\n const kIntegrities = new SafeWeakMap();\n const kReactions = new SafeWeakMap();"
        },
        {
            "sha": "109409d535495d4a3879e2b55435960fa8745b33",
            "filename": "lib/internal/safe_globals.js",
            "status": "removed",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/1d996f58af3067617a67c0af8f86f014ed4d139c/lib%2Finternal%2Fsafe_globals.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d996f58af3067617a67c0af8f86f014ed4d139c/lib%2Finternal%2Fsafe_globals.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fsafe_globals.js?ref=1d996f58af3067617a67c0af8f86f014ed4d139c",
            "patch": "@@ -1,25 +0,0 @@\n-'use strict';\n-\n-const copyProps = (unsafe, safe) => {\n-  for (const key of Reflect.ownKeys(unsafe)) {\n-    if (!Object.getOwnPropertyDescriptor(safe, key)) {\n-      Object.defineProperty(\n-        safe,\n-        key,\n-        Object.getOwnPropertyDescriptor(unsafe, key));\n-    }\n-  }\n-};\n-const makeSafe = (unsafe, safe) => {\n-  copyProps(unsafe.prototype, safe.prototype);\n-  copyProps(unsafe, safe);\n-  Object.setPrototypeOf(safe.prototype, null);\n-  Object.freeze(safe.prototype);\n-  Object.freeze(safe);\n-  return safe;\n-};\n-\n-exports.SafeMap = makeSafe(Map, class SafeMap extends Map {});\n-exports.SafeWeakMap = makeSafe(WeakMap, class SafeWeakMap extends WeakMap {});\n-exports.SafeSet = makeSafe(Set, class SafeSet extends Set {});\n-exports.SafePromise = makeSafe(Promise, class SafePromise extends Promise {});"
        },
        {
            "sha": "b947cbb6152b4b220839c09abe33c2502ee99bd2",
            "filename": "lib/internal/trace_events_async_hooks.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftrace_events_async_hooks.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -3,7 +3,7 @@\n const { trace } = internalBinding('trace_events');\n const async_wrap = internalBinding('async_wrap');\n const async_hooks = require('async_hooks');\n-const { SafeMap, SafeSet } = require('internal/safe_globals');\n+const { SafeMap, SafeSet } = primordials;\n \n // Use small letters such that chrome://tracing groups by the name.\n // The behavior is not only useful but the same as the events emitted using"
        },
        {
            "sha": "6840b4281f46f120a86f62f6c3cb2fda9732caef",
            "filename": "lib/internal/vm/source_text_module.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fvm%2Fsource_text_module.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Finternal%2Fvm%2Fsource_text_module.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvm%2Fsource_text_module.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -17,7 +17,7 @@ const {\n   customInspectSymbol,\n   emitExperimentalWarning\n } = require('internal/util');\n-const { SafePromise } = require('internal/safe_globals');\n+const { SafePromise } = primordials;\n const {\n   validateInt32,\n   validateUint32,"
        },
        {
            "sha": "0e02dbc13121015a0814d9000a59b8c3f7fed6c9",
            "filename": "lib/url.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Furl.js",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/lib%2Furl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Furl.js?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -23,7 +23,7 @@\n \n const { toASCII } = require('internal/idna');\n const { hexTable } = require('internal/querystring');\n-const { SafeSet } = require('internal/safe_globals');\n+const { SafeSet } = primordials;\n \n const {\n   ERR_INVALID_ARG_TYPE"
        },
        {
            "sha": "6b7cbe26f347135eac2ee017bea6a32fee257728",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -26,6 +26,7 @@\n     'node_intermediate_lib_type%': 'static_library',\n     'library_files': [\n       'lib/internal/per_context.js',\n+      'lib/internal/bootstrap/primordials.js',\n       'lib/internal/bootstrap/cache.js',\n       'lib/internal/bootstrap/loaders.js',\n       'lib/internal/bootstrap/node.js',\n@@ -149,7 +150,6 @@\n       'lib/internal/modules/esm/module_job.js',\n       'lib/internal/modules/esm/module_map.js',\n       'lib/internal/modules/esm/translators.js',\n-      'lib/internal/safe_globals.js',\n       'lib/internal/net.js',\n       'lib/internal/options.js',\n       'lib/internal/policy/manifest.js',"
        },
        {
            "sha": "f76fb14990c70cc5ad9b5f28dba0f06087bc7f25",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -256,6 +256,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(port2_string, \"port2\")                                                     \\\n   V(port_string, \"port\")                                                       \\\n   V(preference_string, \"preference\")                                           \\\n+  V(primordials_string, \"primordials\")                                         \\\n   V(priority_string, \"priority\")                                               \\\n   V(process_string, \"process\")                                                 \\\n   V(promise_string, \"promise\")                                                 \\\n@@ -366,6 +367,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(performance_entry_template, v8::Function)                                  \\\n   V(pipe_constructor_template, v8::FunctionTemplate)                           \\\n   V(process_object, v8::Object)                                                \\\n+  V(primordials, v8::Object)                                                   \\\n   V(promise_reject_callback, v8::Function)                                     \\\n   V(promise_wrap_template, v8::ObjectTemplate)                                 \\\n   V(sab_lifetimepartner_constructor_template, v8::FunctionTemplate)            \\"
        },
        {
            "sha": "8593daeefcfd35b0360605d9ad431328e8b65b68",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 29,
            "deletions": 11,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -259,18 +259,37 @@ MaybeLocal<Value> RunBootstrapping(Environment* env) {\n   global->Set(context, FIXED_ONE_BYTE_STRING(env->isolate(), \"global\"), global)\n       .FromJust();\n \n+  // Store primordials\n+  env->set_primordials(Object::New(isolate));\n+  std::vector<Local<String>> primordials_params = {\n+    FIXED_ONE_BYTE_STRING(isolate, \"breakAtBootstrap\"),\n+    env->primordials_string()\n+  };\n+  std::vector<Local<Value>> primordials_args = {\n+    Boolean::New(isolate,\n+                  env->options()->debug_options().break_node_first_line),\n+    env->primordials()\n+  };\n+  MaybeLocal<Value> primordials_ret =\n+      ExecuteBootstrapper(env,\n+                          \"internal/bootstrap/primordials\",\n+                          &primordials_params,\n+                          &primordials_args);\n+  if (primordials_ret.IsEmpty()) {\n+    return MaybeLocal<Value>();\n+  }\n+\n   // Create binding loaders\n   std::vector<Local<String>> loaders_params = {\n       env->process_string(),\n       FIXED_ONE_BYTE_STRING(isolate, \"getBinding\"),\n       FIXED_ONE_BYTE_STRING(isolate, \"getLinkedBinding\"),\n       FIXED_ONE_BYTE_STRING(isolate, \"getInternalBinding\"),\n-      // --inspect-brk-node\n-      FIXED_ONE_BYTE_STRING(isolate, \"debugBreak\"),\n       // --experimental-modules\n       FIXED_ONE_BYTE_STRING(isolate, \"experimentalModules\"),\n       // --expose-internals\n-      FIXED_ONE_BYTE_STRING(isolate, \"exposeInternals\")};\n+      FIXED_ONE_BYTE_STRING(isolate, \"exposeInternals\"),\n+      env->primordials_string()};\n   std::vector<Local<Value>> loaders_args = {\n       process,\n       env->NewFunctionTemplate(binding::GetBinding)\n@@ -282,12 +301,9 @@ MaybeLocal<Value> RunBootstrapping(Environment* env) {\n       env->NewFunctionTemplate(binding::GetInternalBinding)\n           ->GetFunction(context)\n           .ToLocalChecked(),\n-      Boolean::New(isolate,\n-                   env->options()->debug_options().break_node_first_line),\n-      Boolean::New(isolate,\n-                   env->options()->experimental_modules),\n-      Boolean::New(isolate,\n-                   env->options()->expose_internals)};\n+      Boolean::New(isolate, env->options()->experimental_modules),\n+      Boolean::New(isolate, env->options()->expose_internals),\n+      env->primordials()};\n \n   // Bootstrap internal loaders\n   MaybeLocal<Value> loader_exports = ExecuteBootstrapper(\n@@ -311,11 +327,13 @@ MaybeLocal<Value> RunBootstrapping(Environment* env) {\n   std::vector<Local<String>> node_params = {\n       env->process_string(),\n       FIXED_ONE_BYTE_STRING(isolate, \"loaderExports\"),\n-      FIXED_ONE_BYTE_STRING(isolate, \"isMainThread\")};\n+      FIXED_ONE_BYTE_STRING(isolate, \"isMainThread\"),\n+      env->primordials_string()};\n   std::vector<Local<Value>> node_args = {\n       process,\n       loader_exports_obj,\n-      Boolean::New(isolate, env->is_main_thread())};\n+      Boolean::New(isolate, env->is_main_thread()),\n+      env->primordials()};\n \n   MaybeLocal<Value> result = ExecuteBootstrapper(\n       env, \"internal/bootstrap/node\", &node_params, &node_args);"
        },
        {
            "sha": "662aad31d5d1590a2089f938cce32a56a8c9454d",
            "filename": "src/node_native_module.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fnode_native_module.cc",
            "raw_url": "https://github.com/nodejs/node/raw/39d922123c02aecc2e289a08e3bdb9515a7b193a/src%2Fnode_native_module.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.cc?ref=39d922123c02aecc2e289a08e3bdb9515a7b193a",
            "patch": "@@ -181,7 +181,8 @@ MaybeLocal<Function> NativeModuleLoader::CompileAsModule(Environment* env,\n                                            env->require_string(),\n                                            env->module_string(),\n                                            env->process_string(),\n-                                           env->internal_binding_string()};\n+                                           env->internal_binding_string(),\n+                                           env->primordials_string()};\n   return per_process::native_module_loader.LookupAndCompile(\n       env->context(), id, &parameters, env);\n }"
        }
    ],
    "stats": {
        "total": 290,
        "additions": 185,
        "deletions": 105
    }
}