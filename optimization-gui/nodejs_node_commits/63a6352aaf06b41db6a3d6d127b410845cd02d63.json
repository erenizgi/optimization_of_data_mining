{
    "author": "lundibundi",
    "message": "test: improve test-gc-http-client-connaborted\n\n* refactor out usage of 'function' for scoping\n* wait till server is up to start firing requests\n\nPR-URL: https://github.com/nodejs/node/pull/23193\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "63a6352aaf06b41db6a3d6d127b410845cd02d63",
    "files": [
        {
            "sha": "fa6bf20c176560b447830546a440b42b9c7f0673",
            "filename": "test/sequential/test-gc-http-client-connaborted.js",
            "status": "modified",
            "additions": 19,
            "deletions": 21,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/63a6352aaf06b41db6a3d6d127b410845cd02d63/test%2Fsequential%2Ftest-gc-http-client-connaborted.js",
            "raw_url": "https://github.com/nodejs/node/raw/63a6352aaf06b41db6a3d6d127b410845cd02d63/test%2Fsequential%2Ftest-gc-http-client-connaborted.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-gc-http-client-connaborted.js?ref=63a6352aaf06b41db6a3d6d127b410845cd02d63",
            "patch": "@@ -3,13 +3,9 @@\n // just like test-gc-http-client.js,\n // but aborting every connection that comes in.\n \n-require('../common');\n+const common = require('../common');\n const onGC = require('../common/ongc');\n \n-function serverHandler(req, res) {\n-  res.connection.destroy();\n-}\n-\n const http = require('http');\n const todo = 500;\n let done = 0;\n@@ -18,33 +14,35 @@ let countGC = 0;\n \n console.log(`We should do ${todo} requests`);\n \n+function serverHandler(req, res) {\n+  res.connection.destroy();\n+}\n+\n const server = http.createServer(serverHandler);\n-server.listen(0, getall);\n+server.listen(0, common.mustCall(() => {\n+  for (let i = 0; i < 10; i++)\n+    getall();\n+}));\n \n function getall() {\n   if (count >= todo)\n     return;\n \n-  (function() {\n-    function cb(res) {\n-      done += 1;\n-    }\n+  const req = http.get({\n+    hostname: 'localhost',\n+    pathname: '/',\n+    port: server.address().port\n+  }, cb).on('error', cb);\n \n-    const req = http.get({\n-      hostname: 'localhost',\n-      pathname: '/',\n-      port: server.address().port\n-    }, cb).on('error', cb);\n-\n-    count++;\n-    onGC(req, { ongc });\n-  })();\n+  count++;\n+  onGC(req, { ongc });\n \n   setImmediate(getall);\n }\n \n-for (let i = 0; i < 10; i++)\n-  getall();\n+function cb(res) {\n+  done += 1;\n+}\n \n function ongc() {\n   countGC++;"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 19,
        "deletions": 21
    }
}