{
    "author": "joyeecheung",
    "message": "buffer: reduce overhead of StringBytes::Encode for UCS2\n\nCurrently calling StringBytes::Encode on a UCS2 buffer\nresults in two copies of the buffer and the usage of\nstd::vector::assign makes the memory usage unpredictable,\nand therefore hard to test against.\n\nThis patch makes the memory usage more predictable by\nallocating the memory using node::UncheckedMalloc and\nhandles the memory allocation failure properly. Only\none copy of the buffer will be created and it will\nbe freed upon GC of the string.\n\nPR-URL: https://github.com/nodejs/node/pull/19798\nRefs: https://github.com/nodejs/node/pull/19739\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e5f8924064287c3e4d234fe23fcce5b2f10b6d18",
    "files": [
        {
            "sha": "624eb92b930c12855f8e703fad1f090674eff3b1",
            "filename": "src/string_bytes.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/e5f8924064287c3e4d234fe23fcce5b2f10b6d18/src%2Fstring_bytes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e5f8924064287c3e4d234fe23fcce5b2f10b6d18/src%2Fstring_bytes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_bytes.cc?ref=e5f8924064287c3e4d234fe23fcce5b2f10b6d18",
            "patch": "@@ -720,15 +720,19 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n   // Buffer, so we need to reorder on BE platforms.  See\n   // http://nodejs.org/api/buffer.html regarding Node's \"ucs2\"\n   // encoding specification\n-  std::vector<uint16_t> dst;\n   if (IsBigEndian()) {\n-    dst.assign(buf, buf + buflen);\n-    size_t nbytes = buflen * sizeof(dst[0]);\n-    SwapBytes16(reinterpret_cast<char*>(&dst[0]), nbytes);\n-    buf = &dst[0];\n+    uint16_t* dst = node::UncheckedMalloc<uint16_t>(buflen);\n+    if (dst == nullptr) {\n+      *error = SB_MALLOC_FAILED_ERROR;\n+      return MaybeLocal<Value>();\n+    }\n+    size_t nbytes = buflen * sizeof(uint16_t);\n+    memcpy(dst, buf, nbytes);\n+    SwapBytes16(reinterpret_cast<char*>(dst), nbytes);\n+    return ExternTwoByteString::New(isolate, dst, buflen, error);\n+  } else {\n+    return ExternTwoByteString::NewFromCopy(isolate, buf, buflen, error);\n   }\n-\n-  return ExternTwoByteString::NewFromCopy(isolate, buf, buflen, error);\n }\n \n MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 11,
        "deletions": 7
    }
}