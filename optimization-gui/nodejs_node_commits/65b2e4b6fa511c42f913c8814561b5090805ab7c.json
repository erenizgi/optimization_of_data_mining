{
    "author": "addaleax",
    "message": "test: improve statwatcher async_hooks test\n\nModify the `fs.watchFile()` async hooks test to be more\naccurate; currently, it relies on undocumented methods\nand the fact that they use `MakeCallback()` even though\nthere is always a JS stack below.\n\nPR-URL: https://github.com/nodejs/node/pull/21244\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "65b2e4b6fa511c42f913c8814561b5090805ab7c",
    "files": [
        {
            "sha": "92832a46803bd4d89e30a73080a26c1509a6c434",
            "filename": "test/async-hooks/test-statwatcher.js",
            "status": "modified",
            "additions": 33,
            "deletions": 15,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/65b2e4b6fa511c42f913c8814561b5090805ab7c/test%2Fasync-hooks%2Ftest-statwatcher.js",
            "raw_url": "https://github.com/nodejs/node/raw/65b2e4b6fa511c42f913c8814561b5090805ab7c/test%2Fasync-hooks%2Ftest-statwatcher.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-statwatcher.js?ref=65b2e4b6fa511c42f913c8814561b5090805ab7c",
            "patch": "@@ -1,21 +1,29 @@\n 'use strict';\n \n const common = require('../common');\n-const commonPath = require.resolve('../common');\n+const tmpdir = require('../common/tmpdir');\n const assert = require('assert');\n const initHooks = require('./init-hooks');\n const { checkInvocations } = require('./hook-checks');\n const fs = require('fs');\n+const path = require('path');\n \n if (!common.isMainThread)\n   common.skip('Worker bootstrapping works differently -> different async IDs');\n \n+tmpdir.refresh();\n+\n+const file1 = path.join(tmpdir.path, 'file1');\n+const file2 = path.join(tmpdir.path, 'file2');\n+fs.writeFileSync(file1, 'foo');\n+fs.writeFileSync(file2, 'bar');\n+\n const hooks = initHooks();\n hooks.enable();\n \n function onchange() {}\n // install first file watcher\n-fs.watchFile(__filename, onchange);\n+const w1 = fs.watchFile(file1, { interval: 10 }, onchange);\n \n let as = hooks.activitiesOfTypes('STATWATCHER');\n assert.strictEqual(as.length, 1);\n@@ -28,7 +36,7 @@ checkInvocations(statwatcher1, { init: 1 },\n                  'watcher1: when started to watch file');\n \n // install second file watcher\n-fs.watchFile(commonPath, onchange);\n+const w2 = fs.watchFile(file2, { interval: 10 }, onchange);\n as = hooks.activitiesOfTypes('STATWATCHER');\n assert.strictEqual(as.length, 2);\n \n@@ -41,19 +49,29 @@ checkInvocations(statwatcher1, { init: 1 },\n checkInvocations(statwatcher2, { init: 1 },\n                  'watcher2: when started to watch second file');\n \n-// remove first file watcher\n-fs.unwatchFile(__filename);\n-checkInvocations(statwatcher1, { init: 1, before: 1, after: 1 },\n-                 'watcher1: when unwatched first file');\n-checkInvocations(statwatcher2, { init: 1 },\n-                 'watcher2: when unwatched first file');\n+setTimeout(() => fs.writeFileSync(file1, 'foo++'),\n+           common.platformTimeout(100));\n+w1.once('change', common.mustCall(() => {\n+  setImmediate(() => {\n+    checkInvocations(statwatcher1, { init: 1, before: 1, after: 1 },\n+                     'watcher1: when unwatched first file');\n+    checkInvocations(statwatcher2, { init: 1 },\n+                     'watcher2: when unwatched first file');\n \n-// remove second file watcher\n-fs.unwatchFile(commonPath);\n-checkInvocations(statwatcher1, { init: 1, before: 1, after: 1 },\n-                 'watcher1: when unwatched second file');\n-checkInvocations(statwatcher2, { init: 1, before: 1, after: 1 },\n-                 'watcher2: when unwatched second file');\n+    setTimeout(() => fs.writeFileSync(file2, 'bar++'),\n+               common.platformTimeout(100));\n+    w2.once('change', common.mustCall(() => {\n+      setImmediate(() => {\n+        checkInvocations(statwatcher1, { init: 1, before: 1, after: 1 },\n+                         'watcher1: when unwatched second file');\n+        checkInvocations(statwatcher2, { init: 1, before: 1, after: 1 },\n+                         'watcher2: when unwatched second file');\n+        fs.unwatchFile(file1);\n+        fs.unwatchFile(file2);\n+      });\n+    }));\n+  });\n+}));\n \n process.on('exit', onexit);\n "
        }
    ],
    "stats": {
        "total": 48,
        "additions": 33,
        "deletions": 15
    }
}