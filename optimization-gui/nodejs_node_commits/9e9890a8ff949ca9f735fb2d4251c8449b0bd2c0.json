{
    "author": "addaleax",
    "message": "tools: improve valgrind support\n\n- Generate and use a list of suppressions that reduce noisiness for\n  known (non-)issues.\n- Use `--zero-fill-buffers` for tests, as they sometimes use\n  `Buffer.allocUnsafe()` and valgrind reports that as usage\n  of uninitialized memory.\n\nPR-URL: https://github.com/nodejs/node/pull/25498\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0",
    "files": [
        {
            "sha": "bfb67d36194190dd9e4702b836375fcf7765a1e8",
            "filename": "tools/run-valgrind.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0/tools%2Frun-valgrind.py",
            "raw_url": "https://github.com/nodejs/node/raw/9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0/tools%2Frun-valgrind.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Frun-valgrind.py?ref=9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0",
            "patch": "@@ -37,7 +37,9 @@\n VALGRIND_ARGUMENTS = [\n   'valgrind',\n   '--error-exitcode=1',\n-  '--smc-check=all',\n+  '--smc-check=all-non-file',\n+  '--suppressions=' + path.join(NODE_ROOT, 'tools', 'valgrind.supp'),\n+  '--gen-suppressions=all',\n ]\n \n if len(sys.argv) < 2:\n@@ -50,7 +52,8 @@\n   sys.exit(1)\n \n # Compute the command line.\n-command = VALGRIND_ARGUMENTS + [executable] + sys.argv[2:]\n+command = VALGRIND_ARGUMENTS + [executable, '--zero-fill-buffers']\n+command += sys.argv[2:]\n \n # Run valgrind.\n process = subprocess.Popen(command, stderr=subprocess.PIPE)"
        },
        {
            "sha": "420c9a5171cf2a99872a2cfe2997aae01d80e159",
            "filename": "tools/valgrind.supp",
            "status": "added",
            "additions": 106,
            "deletions": 0,
            "changes": 106,
            "blob_url": "https://github.com/nodejs/node/blob/9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0/tools%2Fvalgrind.supp",
            "raw_url": "https://github.com/nodejs/node/raw/9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0/tools%2Fvalgrind.supp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fvalgrind.supp?ref=9e9890a8ff949ca9f735fb2d4251c8449b0bd2c0",
            "patch": "@@ -0,0 +1,106 @@\n+{\n+   <PW_trace_event>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN4node12_GLOBAL__N_1L20PlatformWorkerThreadEPv\n+   ...\n+}\n+{\n+   <tracing_group>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v88platform7tracing17TracingController31GetCategoryGroupEnabledInternalEPKc\n+   ...\n+}\n+{\n+   <locker_is_active>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v86Locker8IsActiveEv\n+   ...\n+}\n+{\n+   <locker_initialize>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v86Locker10InitializeEPNS_7IsolateE\n+   ...\n+}\n+{\n+   <set_embedded_blob>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v88internal7Isolate15SetEmbeddedBlobEPKhj\n+   ...\n+}\n+{\n+   <set_stack_limits>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v88internal4Heap14SetStackLimitsEv\n+   ...\n+}\n+{\n+   <current_embedded_blob_size>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v88internal7Isolate23CurrentEmbeddedBlobSizeEv\n+   ...\n+}\n+{\n+   <current_embedded_blob>\n+   Helgrind:Race\n+   ...\n+   fun:_ZN2v88internal7Isolate19CurrentEmbeddedBlobEv\n+   ...\n+}\n+{\n+   <epoll_invalid_param>\n+   Memcheck:Param\n+   epoll_ctl(event)\n+   fun:epoll_ctl\n+   fun:uv__io_poll\n+   ...\n+   obj:/home/sqrt/src/node/master/out/Release/node\n+}\n+{\n+   <frame_ptr_ne>\n+   Memcheck:Cond\n+   ...\n+   fun:_ZN2v88internal9ExitFrame23GetStateForFramePointerEmPNS0_10StackFrame5StateE\n+   ...\n+}\n+{\n+   <debug_signal_thread_stack_storage>\n+   Memcheck:Leak\n+   match-leak-kinds: possible\n+   ...\n+   fun:pthread_create*\n+   fun:_ZN4node9inspector12_GLOBAL__N_1L23StartDebugSignalHandlerEv\n+   ...\n+}\n+{\n+   <copyfile_ioctl>\n+   Memcheck:Param\n+   ioctl(generic)\n+   fun:*\n+   fun:uv__fs_copyfile\n+   ...\n+}\n+{\n+   <epoll_pwait>\n+   Memcheck:Param\n+   epoll_pwait(sigmask)\n+   fun:*\n+   fun:uv__io_poll\n+   ...\n+}\n+{\n+   <platform_worker_threads_uv_loop_close_after_async_send>\n+   Helgrind:Race\n+   ...\n+   fun:uv_loop_close\n+   fun:_ZN4node18CheckedUvLoopCloseEP9uv_loop_s\n+   fun:_ZZN4node23WorkerThreadsTaskRunner20DelayedTaskScheduler5StartEvENUlPvE_4_FUNES2_\n+   ...\n+}"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 111,
        "deletions": 2
    }
}