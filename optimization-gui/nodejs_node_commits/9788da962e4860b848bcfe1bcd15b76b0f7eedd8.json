{
    "author": "apapirovski",
    "message": "src: do not persist fs_poll handle in stat_watcher\n\nInstead of relying on garbage collection to close the handle,\nmanage its state more explicitly.\n\nPR-URL: https://github.com/nodejs/node/pull/21093\nFixes: https://github.com/nodejs/node/issues/18190\nRefs: https://github.com/nodejs/node/pull/18307\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "9788da962e4860b848bcfe1bcd15b76b0f7eedd8",
    "files": [
        {
            "sha": "0409cfbfb5fac1099b2f768affc00d5c40404a0c",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/9788da962e4860b848bcfe1bcd15b76b0f7eedd8/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9788da962e4860b848bcfe1bcd15b76b0f7eedd8/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=9788da962e4860b848bcfe1bcd15b76b0f7eedd8",
            "patch": "@@ -77,19 +77,15 @@ void StatWatcher::Initialize(Environment* env, Local<Object> target) {\n \n StatWatcher::StatWatcher(Environment* env, Local<Object> wrap, bool use_bigint)\n     : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_STATWATCHER),\n-      watcher_(new uv_fs_poll_t),\n+      watcher_(nullptr),\n       use_bigint_(use_bigint) {\n   MakeWeak();\n-  uv_fs_poll_init(env->event_loop(), watcher_);\n-  watcher_->data = static_cast<void*>(this);\n }\n \n \n StatWatcher::~StatWatcher() {\n-  if (IsActive()) {\n+  if (IsActive())\n     Stop();\n-  }\n-  env()->CloseHandle(watcher_, [](uv_fs_poll_t* handle) { delete handle; });\n }\n \n \n@@ -123,7 +119,7 @@ void StatWatcher::New(const FunctionCallbackInfo<Value>& args) {\n }\n \n bool StatWatcher::IsActive() {\n-  return uv_is_active(reinterpret_cast<uv_handle_t*>(watcher_)) != 0;\n+  return watcher_ != nullptr;\n }\n \n void StatWatcher::IsActive(const v8::FunctionCallbackInfo<v8::Value>& args) {\n@@ -156,6 +152,9 @@ void StatWatcher::Start(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args[2]->IsUint32());\n   const uint32_t interval = args[2].As<Uint32>()->Value();\n \n+  wrap->watcher_ = new uv_fs_poll_t();\n+  CHECK_EQ(0, uv_fs_poll_init(wrap->env()->event_loop(), wrap->watcher_));\n+  wrap->watcher_->data = static_cast<void*>(wrap);\n   // Safe, uv_ref/uv_unref are idempotent.\n   if (persistent)\n     uv_ref(reinterpret_cast<uv_handle_t*>(wrap->watcher_));\n@@ -187,7 +186,8 @@ void StatWatcher::Stop(const FunctionCallbackInfo<Value>& args) {\n \n \n void StatWatcher::Stop() {\n-  uv_fs_poll_stop(watcher_);\n+  env()->CloseHandle(watcher_, [](uv_fs_poll_t* handle) { delete handle; });\n+  watcher_ = nullptr;\n   MakeWeak();\n }\n "
        }
    ],
    "stats": {
        "total": 16,
        "additions": 8,
        "deletions": 8
    }
}