{
    "author": "apapirovski",
    "message": "timers: add helper fn for async init\n\nThere are currently 3 places in Timers where the exact same code\nappears. Instead create a helper function that does the same job\nof setting asyncId & triggerAsyncId, as well as calling emitInit.\n\nPR-URL: https://github.com/nodejs/node/pull/18825\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "28f3ffba0fd732fb8faa49e02049dfb1ee5c5911",
    "files": [
        {
            "sha": "8c1a87a65f47258b180f27288aa580077eaf0f52",
            "filename": "lib/internal/timers.js",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/28f3ffba0fd732fb8faa49e02049dfb1ee5c5911/lib%2Finternal%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/28f3ffba0fd732fb8faa49e02049dfb1ee5c5911/lib%2Finternal%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftimers.js?ref=28f3ffba0fd732fb8faa49e02049dfb1ee5c5911",
            "patch": "@@ -24,6 +24,7 @@ module.exports = {\n   async_id_symbol,\n   trigger_async_id_symbol,\n   Timeout,\n+  initAsyncResource,\n   refreshFnSymbol,\n   setUnrefTimeout,\n   validateTimerDuration\n@@ -37,6 +38,14 @@ function getTimers() {\n   return timers;\n }\n \n+function initAsyncResource(resource, type) {\n+  const asyncId = resource[async_id_symbol] = newAsyncId();\n+  const triggerAsyncId =\n+    resource[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n+  if (initHooksExist())\n+    emitInit(asyncId, type, triggerAsyncId, resource);\n+}\n+\n // Timer constructor function.\n // The entire prototype is defined in lib/timers.js\n function Timeout(callback, after, args, isRepeat, isUnrefed) {\n@@ -66,14 +75,7 @@ function Timeout(callback, after, args, isRepeat, isUnrefed) {\n \n   this[unrefedSymbol] = isUnrefed;\n \n-  this[async_id_symbol] = newAsyncId();\n-  this[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-  if (initHooksExist()) {\n-    emitInit(this[async_id_symbol],\n-             'Timeout',\n-             this[trigger_async_id_symbol],\n-             this);\n-  }\n+  initAsyncResource(this, 'Timeout');\n }\n \n Timeout.prototype[refreshFnSymbol] = function refresh() {"
        },
        {
            "sha": "bc98718fdfac02c191ea245816c21b81a80506c4",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 3,
            "deletions": 20,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/28f3ffba0fd732fb8faa49e02049dfb1ee5c5911/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/28f3ffba0fd732fb8faa49e02049dfb1ee5c5911/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=28f3ffba0fd732fb8faa49e02049dfb1ee5c5911",
            "patch": "@@ -30,6 +30,7 @@ const {\n   async_id_symbol,\n   trigger_async_id_symbol,\n   Timeout,\n+  initAsyncResource,\n   validateTimerDuration\n } = require('internal/timers');\n const internalUtil = require('internal/util');\n@@ -39,12 +40,8 @@ const util = require('util');\n const errors = require('internal/errors');\n const debug = util.debuglog('timer');\n const {\n-  getDefaultTriggerAsyncId,\n-  newAsyncId,\n-  initHooksExist,\n   destroyHooksExist,\n   // The needed emit*() functions.\n-  emitInit,\n   emitBefore,\n   emitAfter,\n   emitDestroy\n@@ -188,14 +185,7 @@ function insert(item, unrefed, start) {\n \n   if (!item[async_id_symbol] || item._destroyed) {\n     item._destroyed = false;\n-    item[async_id_symbol] = newAsyncId();\n-    item[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-    if (initHooksExist()) {\n-      emitInit(item[async_id_symbol],\n-               'Timeout',\n-               item[trigger_async_id_symbol],\n-               item);\n-    }\n+    initAsyncResource(item, 'Timeout');\n   }\n \n   L.append(list, item);\n@@ -720,14 +710,7 @@ const Immediate = class Immediate {\n     this._destroyed = false;\n     this[kRefed] = false;\n \n-    this[async_id_symbol] = newAsyncId();\n-    this[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-    if (initHooksExist()) {\n-      emitInit(this[async_id_symbol],\n-               'Immediate',\n-               this[trigger_async_id_symbol],\n-               this);\n-    }\n+    initAsyncResource(this, 'Immediate');\n \n     this.ref();\n     immediateInfo[kCount]++;"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 13,
        "deletions": 28
    }
}