{
    "author": "bmeck",
    "message": "repl: refactor tests to not rely on timing\n\nTests relying on synchronous timing have been migrated to use events.\n\nPR-URL: https://github.com/nodejs/node/pull/17828\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "de848ac1e0483327a2ce8716c3f8567eaeacb660",
    "files": [
        {
            "sha": "76412c3b118a8cd08602fd952a7e67dee563dad6",
            "filename": "lib/internal/repl.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/lib%2Finternal%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/lib%2Finternal%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Frepl.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -8,7 +8,7 @@ const os = require('os');\n const util = require('util');\n const debug = util.debuglog('repl');\n module.exports = Object.create(REPL);\n-module.exports.createInternalRepl = createRepl;\n+module.exports.createInternalRepl = createInternalRepl;\n \n // XXX(chrisdickinson): The 15ms debounce value is somewhat arbitrary.\n // The debounce is to guard against code pasted into the REPL.\n@@ -19,7 +19,7 @@ function _writeToOutput(repl, message) {\n   repl._refreshLine();\n }\n \n-function createRepl(env, opts, cb) {\n+function createInternalRepl(env, opts, cb) {\n   if (typeof opts === 'function') {\n     cb = opts;\n     opts = null;"
        },
        {
            "sha": "2227953fa864685c4dc9b9c6926da950cfd73845",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 40,
            "deletions": 39,
            "changes": 79,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -109,6 +109,11 @@ writer.options = Object.assign({},\n \n exports._builtinLibs = internalModule.builtinLibs;\n \n+const sep = '\\u0000\\u0000\\u0000';\n+const regExMatcher = new RegExp(`^${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n+                                `${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n+                                `${sep}(.*)$`);\n+\n function REPLServer(prompt,\n                     stream,\n                     eval_,\n@@ -149,6 +154,7 @@ function REPLServer(prompt,\n   }\n \n   var self = this;\n+  replMap.set(self, self);\n \n   self._domain = dom || domain.create();\n   self.useGlobal = !!useGlobal;\n@@ -165,41 +171,6 @@ function REPLServer(prompt,\n   self.rli = this;\n \n   const savedRegExMatches = ['', '', '', '', '', '', '', '', '', ''];\n-  const sep = '\\u0000\\u0000\\u0000';\n-  const regExMatcher = new RegExp(`^${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n-                                  `${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n-                                  `${sep}(.*)$`);\n-\n-  eval_ = eval_ || defaultEval;\n-\n-  // Pause taking in new input, and store the keys in a buffer.\n-  const pausedBuffer = [];\n-  let paused = false;\n-  function pause() {\n-    paused = true;\n-  }\n-  function unpause() {\n-    if (!paused) return;\n-    paused = false;\n-    let entry;\n-    while (entry = pausedBuffer.shift()) {\n-      const [type, payload] = entry;\n-      switch (type) {\n-        case 'key': {\n-          const [d, key] = payload;\n-          self._ttyWrite(d, key);\n-          break;\n-        }\n-        case 'close':\n-          self.emit('exit');\n-          break;\n-      }\n-      if (paused) {\n-        break;\n-      }\n-    }\n-  }\n-\n   function defaultEval(code, context, file, cb) {\n     var err, result, script, wrappedErr;\n     var wrappedCmd = false;\n@@ -331,7 +302,6 @@ function REPLServer(prompt,\n \n       if (awaitPromise && !err) {\n         let sigintListener;\n-        pause();\n         let promise = result;\n         if (self.breakEvalOnSigint) {\n           const interrupt = new Promise((resolve, reject) => {\n@@ -350,7 +320,6 @@ function REPLServer(prompt,\n           prioritizedSigintQueue.delete(sigintListener);\n \n           finishExecution(undefined, result);\n-          unpause();\n         }, (err) => {\n           // Remove prioritized SIGINT listener if it was not called.\n           prioritizedSigintQueue.delete(sigintListener);\n@@ -360,7 +329,6 @@ function REPLServer(prompt,\n             Object.defineProperty(err, 'stack', { value: '' });\n           }\n \n-          unpause();\n           if (err && process.domain) {\n             debug('not recoverable, send to domain');\n             process.domain.emit('error', err);\n@@ -377,6 +345,36 @@ function REPLServer(prompt,\n     }\n   }\n \n+  eval_ = eval_ || defaultEval;\n+\n+  // Pause taking in new input, and store the keys in a buffer.\n+  const pausedBuffer = [];\n+  let paused = false;\n+  function pause() {\n+    paused = true;\n+  }\n+  function unpause() {\n+    if (!paused) return;\n+    paused = false;\n+    let entry;\n+    while (entry = pausedBuffer.shift()) {\n+      const [type, payload] = entry;\n+      switch (type) {\n+        case 'key': {\n+          const [d, key] = payload;\n+          self._ttyWrite(d, key);\n+          break;\n+        }\n+        case 'close':\n+          self.emit('exit');\n+          break;\n+      }\n+      if (paused) {\n+        break;\n+      }\n+    }\n+  }\n+\n   self.eval = self._domain.bind(eval_);\n \n   self._domain.on('error', function debugDomainError(e) {\n@@ -405,6 +403,7 @@ function REPLServer(prompt,\n     top.clearBufferedCommand();\n     top.lines.level = [];\n     top.displayPrompt();\n+    unpause();\n   });\n \n   if (!input && !output) {\n@@ -593,6 +592,7 @@ function REPLServer(prompt,\n     const evalCmd = self[kBufferedCommandSymbol] + cmd + '\\n';\n \n     debug('eval %j', evalCmd);\n+    pause();\n     self.eval(evalCmd, self.context, 'repl', finish);\n \n     function finish(e, ret) {\n@@ -605,6 +605,7 @@ function REPLServer(prompt,\n                                 '(Press Control-D to exit.)\\n');\n         self.clearBufferedCommand();\n         self.displayPrompt();\n+        unpause();\n         return;\n       }\n \n@@ -642,6 +643,7 @@ function REPLServer(prompt,\n \n       // Display prompt again\n       self.displayPrompt();\n+      unpause();\n     }\n   });\n \n@@ -724,7 +726,6 @@ exports.start = function(prompt,\n                             ignoreUndefined,\n                             replMode);\n   if (!exports.repl) exports.repl = repl;\n-  replMap.set(repl, repl);\n   return repl;\n };\n "
        },
        {
            "sha": "68f8402ddbfdaa796c073d8dddada5eee31506ca",
            "filename": "test/parallel/test-repl-autolibs.js",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-autolibs.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-autolibs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-autolibs.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -29,7 +29,22 @@ const repl = require('repl');\n common.globalCheck = false;\n \n const putIn = new common.ArrayStream();\n-repl.start('', putIn, null, true);\n+\n+\n+const replserver = repl.start('', putIn, null, true);\n+const callbacks = [];\n+const $eval = replserver.eval;\n+replserver.eval = function(code, context, file, cb) {\n+  const expected = callbacks.shift();\n+  return $eval.call(this, code, context, file, (...args) => {\n+    try {\n+      expected(cb, ...args);\n+    } catch (e) {\n+      console.error(e);\n+      process.exit(1);\n+    }\n+  });\n+};\n \n test1();\n \n@@ -48,6 +63,11 @@ function test1() {\n     }\n   };\n   assert(!gotWrite);\n+  callbacks.push(common.mustCall((cb, err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, require('fs'));\n+    cb(err, result);\n+  }));\n   putIn.run(['fs']);\n   assert(gotWrite);\n }\n@@ -66,6 +86,11 @@ function test2() {\n   const val = {};\n   global.url = val;\n   assert(!gotWrite);\n+  callbacks.push(common.mustCall((cb, err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, val);\n+    cb(err, result);\n+  }));\n   putIn.run(['url']);\n   assert(gotWrite);\n }"
        },
        {
            "sha": "90364cee694bb56e890bf229aefa1165c90413eb",
            "filename": "test/parallel/test-repl-context.js",
            "status": "modified",
            "additions": 42,
            "deletions": 25,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-context.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -27,40 +27,57 @@ function testContext(repl) {\n   repl.close();\n }\n \n-testContextSideEffects(repl.start({ input: stream, output: stream }));\n+const replserver = repl.start({ input: stream, output: stream });\n+const callbacks = [];\n+const $eval = replserver.eval;\n+replserver.eval = function(code, context, file, cb) {\n+  const expected = callbacks.shift();\n+  return $eval.call(this, code, context, file, (...args) => {\n+    try {\n+      expected(cb, ...args);\n+    } catch (e) {\n+      console.error(e);\n+      process.exit(1);\n+    }\n+  });\n+};\n+testContextSideEffects(replserver);\n \n function testContextSideEffects(server) {\n   assert.ok(!server.underscoreAssigned);\n   assert.strictEqual(server.lines.length, 0);\n \n   // an assignment to '_' in the repl server\n-  server.write('_ = 500;\\n');\n-  assert.ok(server.underscoreAssigned);\n-  assert.strictEqual(server.lines.length, 1);\n-  assert.strictEqual(server.lines[0], '_ = 500;');\n-  assert.strictEqual(server.last, 500);\n+  callbacks.push(common.mustCall((cb, ...args) => {\n+    assert.ok(server.underscoreAssigned);\n+    assert.strictEqual(server.last, 500);\n+    cb(...args);\n+    assert.strictEqual(server.lines.length, 1);\n+    assert.strictEqual(server.lines[0], '_ = 500;');\n \n-  // use the server to create a new context\n-  const context = server.createContext();\n+    // use the server to create a new context\n+    const context = server.createContext();\n \n-  // ensure that creating a new context does not\n-  // have side effects on the server\n-  assert.ok(server.underscoreAssigned);\n-  assert.strictEqual(server.lines.length, 1);\n-  assert.strictEqual(server.lines[0], '_ = 500;');\n-  assert.strictEqual(server.last, 500);\n+    // ensure that creating a new context does not\n+    // have side effects on the server\n+    assert.ok(server.underscoreAssigned);\n+    assert.strictEqual(server.lines.length, 1);\n+    assert.strictEqual(server.lines[0], '_ = 500;');\n+    assert.strictEqual(server.last, 500);\n \n-  // reset the server context\n-  server.resetContext();\n-  assert.ok(!server.underscoreAssigned);\n-  assert.strictEqual(server.lines.length, 0);\n+    // reset the server context\n+    server.resetContext();\n+    assert.ok(!server.underscoreAssigned);\n+    assert.strictEqual(server.lines.length, 0);\n \n-  // ensure that assigning to '_' in the new context\n-  // does not change the value in our server.\n-  assert.ok(!server.underscoreAssigned);\n-  vm.runInContext('_ = 1000;\\n', context);\n+    // ensure that assigning to '_' in the new context\n+    // does not change the value in our server.\n+    assert.ok(!server.underscoreAssigned);\n+    vm.runInContext('_ = 1000;\\n', context);\n \n-  assert.ok(!server.underscoreAssigned);\n-  assert.strictEqual(server.lines.length, 0);\n-  server.close();\n+    assert.ok(!server.underscoreAssigned);\n+    assert.strictEqual(server.lines.length, 0);\n+    server.close();\n+  }));\n+  server.write('_ = 500;\\n');\n }"
        },
        {
            "sha": "dd9ad5c1eb0e56a2693f0de2d87843d686aadc42",
            "filename": "test/parallel/test-repl-end-emits-exit.js",
            "status": "modified",
            "additions": 4,
            "deletions": 14,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-end-emits-exit.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-end-emits-exit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-end-emits-exit.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -21,10 +21,7 @@\n \n 'use strict';\n const common = require('../common');\n-const assert = require('assert');\n const repl = require('repl');\n-let terminalExit = 0;\n-let regularExit = 0;\n \n // Create a dummy stream that does nothing\n const stream = new common.ArrayStream();\n@@ -41,11 +38,10 @@ function testTerminalMode() {\n     stream.emit('data', '\\u0004');\n   });\n \n-  r1.on('exit', function() {\n+  r1.on('exit', common.mustCall(function() {\n     // should be fired from the simulated ^D keypress\n-    terminalExit++;\n     testRegularMode();\n-  });\n+  }));\n }\n \n function testRegularMode() {\n@@ -59,17 +55,11 @@ function testRegularMode() {\n     stream.emit('end');\n   });\n \n-  r2.on('exit', function() {\n+  r2.on('exit', common.mustCall(function() {\n     // should be fired from the simulated 'end' event\n-    regularExit++;\n-  });\n+  }));\n }\n \n-process.on('exit', function() {\n-  assert.strictEqual(terminalExit, 1);\n-  assert.strictEqual(regularExit, 1);\n-});\n-\n \n // start\n testTerminalMode();"
        },
        {
            "sha": "83311fd92cd67bbfd925948c721ac58138e32962",
            "filename": "test/parallel/test-repl-eval-scope.js",
            "status": "modified",
            "additions": 22,
            "deletions": 16,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-eval-scope.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-eval-scope.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-eval-scope.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -3,21 +3,27 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n-{\n-  const stream = new common.ArrayStream();\n-  const options = {\n-    eval: common.mustCall((cmd, context) => {\n-      assert.strictEqual(cmd, '.scope\\n');\n-      assert.deepStrictEqual(context, { animal: 'Sterrance' });\n-    }),\n-    input: stream,\n-    output: stream,\n-    terminal: true\n-  };\n+const exitTests = [];\n+process.on('exit', () => {\n+  for (const test of exitTests) test();\n+});\n+const CONTEXT = { animal: 'Sterrance' };\n+const stream = new common.ArrayStream();\n+const options = {\n+  eval: common.mustCall((cmd, context) => {\n+    // need to escape the domain\n+    exitTests.push(common.mustCall(() => {\n+      assert.strictEqual(cmd, '.scope');\n+      assert.ok(context === CONTEXT);\n+    }));\n+  }),\n+  input: stream,\n+  output: stream,\n+  terminal: true\n+};\n \n-  const r = repl.start(options);\n-  r.context = { animal: 'Sterrance' };\n+const r = repl.start(options);\n+r.context = CONTEXT;\n \n-  stream.emit('data', '\\t');\n-  stream.emit('.exit\\n');\n-}\n+stream.emit('data', '\\t');\n+stream.emit('.exit\\n');"
        },
        {
            "sha": "d7290a1583da583c9cf2510b8baa36a39e43fcfb",
            "filename": "test/parallel/test-repl-eval.js",
            "status": "modified",
            "additions": 25,
            "deletions": 25,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-eval.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-eval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-eval.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -3,31 +3,31 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n-{\n-  let evalCalledWithExpectedArgs = false;\n+const exitTests = [];\n+process.on('exit', () => {\n+  for (const test of exitTests) test();\n+});\n+const options = {\n+  eval: common.mustCall((cmd, context) => {\n+    // Assertions here will not cause the test to exit with an error code\n+    // so set a boolean that is checked later instead.\n+    exitTests.push(common.mustCall(() => {\n+      assert.strictEqual(cmd, 'function f() {}\\n');\n+      assert.strictEqual(context.foo, 'bar');\n+    }));\n+  })\n+};\n \n-  const options = {\n-    eval: common.mustCall((cmd, context) => {\n-      // Assertions here will not cause the test to exit with an error code\n-      // so set a boolean that is checked later instead.\n-      evalCalledWithExpectedArgs = (cmd === 'function f() {}\\n' &&\n-                                    context.foo === 'bar');\n-    })\n-  };\n+const r = repl.start(options);\n+r.context = { foo: 'bar' };\n \n-  const r = repl.start(options);\n-  r.context = { foo: 'bar' };\n-\n-  try {\n-    // Default preprocessor transforms\n-    //  function f() {}  to\n-    //  var f = function f() {}\n-    // Test to ensure that original input is preserved.\n-    // Reference: https://github.com/nodejs/node/issues/9743\n-    r.write('function f() {}\\n');\n-  } finally {\n-    r.write('.exit\\n');\n-  }\n-\n-  assert(evalCalledWithExpectedArgs);\n+try {\n+  // Default preprocessor transforms\n+  //  function f() {}  to\n+  //  var f = function f() {}\n+  // Test to ensure that original input is preserved.\n+  // Reference: https://github.com/nodejs/node/issues/9743\n+  r.write('function f() {}\\n');\n+} finally {\n+  r.write('.exit\\n');\n }"
        },
        {
            "sha": "bda40594a8876a601d4cfa768c67cfb949ce3bb2",
            "filename": "test/parallel/test-repl-function-definition-edge-case.js",
            "status": "modified",
            "additions": 43,
            "deletions": 28,
            "changes": 71,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -7,32 +7,47 @@ const stream = require('stream');\n \n common.globalCheck = false;\n \n-const r = initRepl();\n-\n-r.input.emit('data', 'function a() { return 42; } (1)\\n');\n-r.input.emit('data', 'a\\n');\n-r.input.emit('data', '.exit');\n-\n-const expected = '1\\n[Function: a]\\n';\n-const got = r.output.accumulator.join('');\n-assert.strictEqual(got, expected);\n-\n-function initRepl() {\n-  const input = new stream();\n-  input.write = input.pause = input.resume = () => {};\n-  input.readable = true;\n-\n-  const output = new stream();\n-  output.writable = true;\n-  output.accumulator = [];\n-\n-  output.write = (data) => output.accumulator.push(data);\n-\n-  return repl.start({\n-    input,\n-    output,\n-    useColors: false,\n-    terminal: false,\n-    prompt: ''\n+const input = new stream();\n+input.write = input.pause = input.resume = () => {};\n+input.readable = true;\n+\n+const output = new stream();\n+output.writable = true;\n+output.accumulator = [];\n+\n+output.write = (data) => output.accumulator.push(data);\n+\n+const replserver = repl.start({\n+  input,\n+  output,\n+  useColors: false,\n+  terminal: false,\n+  prompt: ''\n+});\n+const callbacks = [];\n+const $eval = replserver.eval;\n+replserver.eval = function(code, context, file, cb) {\n+  const expected = callbacks.shift();\n+  return $eval.call(this, code, context, file, (...args) => {\n+    try {\n+      expected(...args);\n+    } catch (e) {\n+      console.error(e);\n+      process.exit(1);\n+    }\n+    cb(...args);\n   });\n-}\n+};\n+\n+callbacks.push(common.mustCall((err, result) => {\n+  assert.ifError(err);\n+  assert.strictEqual(result, 1);\n+}));\n+replserver.input.emit('data', 'function a() { return 42; } (1)\\n');\n+callbacks.push(common.mustCall((err, result) => {\n+  assert.ifError(err);\n+  assert.strictEqual(typeof result, 'function');\n+  assert.strictEqual(result.toString(), 'function a() { return 42; }');\n+}));\n+replserver.input.emit('data', 'a\\n');\n+replserver.input.emit('data', '.exit');"
        },
        {
            "sha": "922aef3d493901ef55660e409b1e636bacbe4980",
            "filename": "test/parallel/test-repl-load-multiline.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-load-multiline.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-load-multiline.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-load-multiline.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -36,5 +36,7 @@ const r = repl.start({\n });\n \n r.write(`${command}\\n`);\n-assert.strictEqual(accum.replace(terminalCodeRegex, ''), expected);\n+r.on('exit', common.mustCall(() => {\n+  assert.strictEqual(accum.replace(terminalCodeRegex, ''), expected);\n+}));\n r.close();"
        },
        {
            "sha": "39d7ff88cce905a743228a629aace029502d31ae",
            "filename": "test/parallel/test-repl-mode.js",
            "status": "modified",
            "additions": 42,
            "deletions": 11,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-mode.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-mode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-mode.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -19,35 +19,49 @@ tests.forEach(function(test) {\n function testSloppyMode() {\n   const cli = initRepl(repl.REPL_MODE_SLOPPY);\n \n+  cli.callbacks.push(common.mustCall((err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, 3);\n+  }));\n   cli.input.emit('data', 'x = 3\\n');\n-  assert.strictEqual(cli.output.accumulator.join(''), '> 3\\n> ');\n-  cli.output.accumulator.length = 0;\n \n+  cli.callbacks.push(common.mustCall((err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, undefined);\n+  }));\n   cli.input.emit('data', 'let y = 3\\n');\n-  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function testStrictMode() {\n   const cli = initRepl(repl.REPL_MODE_STRICT);\n \n+  cli._domain.once('error', common.mustCall((err) => {\n+    assert.ok(err);\n+    assert.ok(/ReferenceError: x is not defined/.test(err.message));\n+  }));\n   cli.input.emit('data', 'x = 3\\n');\n-  assert.ok(/ReferenceError: x is not defined/.test(\n-    cli.output.accumulator.join('')));\n-  cli.output.accumulator.length = 0;\n \n+  cli.callbacks.push(common.mustCall((err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, undefined);\n+  }));\n   cli.input.emit('data', 'let y = 3\\n');\n-  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function testAutoMode() {\n   const cli = initRepl(repl.REPL_MODE_MAGIC);\n \n+  cli.callbacks.push(common.mustCall((err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, 3);\n+  }));\n   cli.input.emit('data', 'x = 3\\n');\n-  assert.strictEqual(cli.output.accumulator.join(''), '> 3\\n> ');\n-  cli.output.accumulator.length = 0;\n \n+  cli.callbacks.push(common.mustCall((err, result) => {\n+    assert.ifError(err);\n+    assert.strictEqual(result, undefined);\n+  }));\n   cli.input.emit('data', 'let y = 3\\n');\n-  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function initRepl(mode) {\n@@ -62,11 +76,28 @@ function initRepl(mode) {\n   output.accumulator = [];\n   output.writable = true;\n \n-  return repl.start({\n+  const replserver = repl.start({\n     input: input,\n     output: output,\n     useColors: false,\n     terminal: false,\n     replMode: mode\n   });\n+  const callbacks = [];\n+  const $eval = replserver.eval;\n+  replserver.eval = function(code, context, file, cb) {\n+    const expected = callbacks.shift();\n+    return $eval.call(this, code, context, file, (...args) => {\n+      console.log('EVAL RET', args);\n+      try {\n+        expected(...args);\n+      } catch (e) {\n+        console.error(e);\n+        process.exit(1);\n+      }\n+      cb(...args);\n+    });\n+  };\n+  replserver.callbacks = callbacks;\n+  return replserver;\n }"
        },
        {
            "sha": "9b78b0b1dc4d6debb631f47e477d3579c2090b02",
            "filename": "test/parallel/test-repl-null-thrown.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-null-thrown.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-null-thrown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-null-thrown.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -1,5 +1,5 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n const repl = require('repl');\n const assert = require('assert');\n const Stream = require('stream');\n@@ -18,7 +18,6 @@ const replserver = repl.start({\n replserver.emit('line', 'process.nextTick(() => { throw null; })');\n replserver.emit('line', '.exit');\n \n-setTimeout(() => {\n-  console.log(text);\n+replserver.on('exit', common.mustCall(() => {\n   assert(text.includes('Thrown: null'));\n-}, 0);\n+}));"
        },
        {
            "sha": "2748cfa780ee1648d6f4a5725a14ec9c7f8b19d7",
            "filename": "test/parallel/test-repl-null.js",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-null.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-null.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-null.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -1,9 +1,28 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n const repl = require('repl');\n const assert = require('assert');\n \n+const callbacks = [\n+  common.mustCall((err, value) => {\n+    assert.ifError(err);\n+    assert.strictEqual(value, undefined);\n+  })\n+];\n const replserver = new repl.REPLServer();\n+const $eval = replserver.eval;\n+replserver.eval = function(code, context, file, cb) {\n+  const expected = callbacks.shift();\n+  return $eval.call(this, code, context, file, (...args) => {\n+    try {\n+      expected(...args);\n+    } catch (e) {\n+      console.error(e);\n+      process.exit(1);\n+    }\n+    cb(...args);\n+  });\n+};\n \n replserver._inTemplateLiteral = true;\n "
        },
        {
            "sha": "0ca4039a5f8e36c1d9be2b0b4741607ac378a28d",
            "filename": "test/parallel/test-repl-pretty-custom-stack.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -22,7 +22,9 @@ function run({ command, expected }) {\n   });\n \n   r.write(`${command}\\n`);\n-  assert.strictEqual(accum, expected);\n+  r.on('exit', common.mustCall(() => {\n+    assert.strictEqual(accum, expected);\n+  }));\n   r.close();\n }\n "
        },
        {
            "sha": "55f37e1703e52d15321d44bf74226d8b8b247c17",
            "filename": "test/parallel/test-repl-pretty-stack.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-stack.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -22,7 +22,9 @@ function run({ command, expected }) {\n   });\n \n   r.write(`${command}\\n`);\n-  assert.strictEqual(accum, expected);\n+  r.on('exit', common.mustCall(() => {\n+    assert.strictEqual(accum, expected);\n+  }));\n   r.close();\n }\n "
        },
        {
            "sha": "c1767bbc4db03b1de9502616ee91923c35702c41",
            "filename": "test/parallel/test-repl-recoverable.js",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-recoverable.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-recoverable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-recoverable.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -4,14 +4,11 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n-let evalCount = 0;\n let recovered = false;\n let rendered = false;\n \n function customEval(code, context, file, cb) {\n-  evalCount++;\n-\n-  return cb(evalCount === 1 ? new repl.Recoverable() : null, true);\n+  return cb(!recovered ? new repl.Recoverable() : null, true);\n }\n \n const putIn = new common.ArrayStream();\n@@ -26,7 +23,7 @@ putIn.write = function(msg) {\n   }\n };\n \n-repl.start('', putIn, customEval);\n+repl.start('', putIn, common.mustCall(customEval, 2));\n \n // https://github.com/nodejs/node/issues/2939\n // Expose recoverable errors to the consumer.\n@@ -36,5 +33,4 @@ putIn.emit('data', '2\\n');\n process.on('exit', function() {\n   assert(recovered, 'REPL never recovered');\n   assert(rendered, 'REPL never rendered the result');\n-  assert.strictEqual(evalCount, 2);\n });"
        },
        {
            "sha": "ef25dbe015de887160934fca3b705d7a857d289a",
            "filename": "test/parallel/test-repl-throw-null-or-undefined.js",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -1,18 +1,20 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n \n // This test ensures that the repl does not\n // crash or emit error when throwing `null|undefined`\n // ie `throw null` or `throw undefined`\n \n-const assert = require('assert');\n const repl = require('repl');\n \n-const r = repl.start();\n+const replserver = repl.start();\n+const $eval = replserver.eval;\n+replserver.eval = function(code, context, file, cb) {\n+  return $eval.call(this, code, context, file,\n+                    common.mustNotCall(\n+                      'repl crashes/throw error on `throw null|undefined`'));\n+};\n+replserver.write('throw null\\n');\n+replserver.write('throw undefined\\n');\n \n-assert.doesNotThrow(() => {\n-  r.write('throw null\\n');\n-  r.write('throw undefined\\n');\n-}, TypeError, 'repl crashes/throw error on `throw null|undefined`');\n-\n-r.write('.exit\\n');\n+replserver.write('.exit\\n');"
        },
        {
            "sha": "1b22dcc7221a7ff0a4c3599b26daa0cd96855f1b",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 67,
            "deletions": 57,
            "changes": 124,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -28,20 +28,22 @@ function testSloppyMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  assertOutput(r.output, [\n-    'undefined',\n-    'undefined',\n-    'undefined',\n-    '10',\n-    '10',\n-    'Expression assignment to _ now disabled.',\n-    '20',\n-    '20',\n-    '30',\n-    '30',\n-    '40',\n-    '30'\n-  ]);\n+  r.on('exit', () => {\n+    assertOutput(r.output, [\n+      'undefined',\n+      'undefined',\n+      'undefined',\n+      '10',\n+      '10',\n+      'Expression assignment to _ now disabled.',\n+      '20',\n+      '20',\n+      '30',\n+      '30',\n+      '40',\n+      '30'\n+    ]);\n+  });\n }\n \n function testStrictMode() {\n@@ -61,20 +63,22 @@ function testStrictMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  assertOutput(r.output, [\n-    'undefined',\n-    'undefined',\n-    'undefined',\n-    'undefined',\n-    '20',\n-    '30',\n-    '30',\n-    'undefined',\n-    '30',\n-    'undefined',\n-    'undefined',\n-    '30'\n-  ]);\n+  r.on('exit', () => {\n+    assertOutput(r.output, [\n+      'undefined',\n+      'undefined',\n+      'undefined',\n+      'undefined',\n+      '20',\n+      '30',\n+      '30',\n+      'undefined',\n+      '30',\n+      'undefined',\n+      'undefined',\n+      '30'\n+    ]);\n+  });\n }\n \n function testMagicMode() {\n@@ -94,20 +98,22 @@ function testMagicMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  assertOutput(r.output, [\n-    'undefined',\n-    '10',\n-    '10',\n-    'undefined',\n-    '20',\n-    '30',\n-    '30',\n-    'undefined',\n-    '30',\n-    'undefined',\n-    '50',\n-    '30'\n-  ]);\n+  r.on('exit', () => {\n+    assertOutput(r.output, [\n+      'undefined',\n+      '10',\n+      '10',\n+      'undefined',\n+      '20',\n+      '30',\n+      '30',\n+      'undefined',\n+      '30',\n+      'undefined',\n+      '50',\n+      '30'\n+    ]);\n+  });\n }\n \n function testResetContext() {\n@@ -121,15 +127,17 @@ function testResetContext() {\n           _;           // expect 20\n           `);\n \n-  assertOutput(r.output, [\n-    'Expression assignment to _ now disabled.',\n-    '10',\n-    '10',\n-    'Clearing context...',\n-    '10',\n-    '20',\n-    '20'\n-  ]);\n+  r.on('exit', () => {\n+    assertOutput(r.output, [\n+      'Expression assignment to _ now disabled.',\n+      '10',\n+      '10',\n+      'Clearing context...',\n+      '10',\n+      '20',\n+      '20'\n+    ]);\n+  });\n }\n \n function testResetContextGlobal() {\n@@ -141,12 +149,14 @@ function testResetContextGlobal() {\n           _;           // remains 10\n           `);\n \n-  assertOutput(r.output, [\n-    'Expression assignment to _ now disabled.',\n-    '10',\n-    '10',\n-    '10',\n-  ]);\n+  r.on('exit', () => {\n+    assertOutput(r.output, [\n+      'Expression assignment to _ now disabled.',\n+      '10',\n+      '10',\n+      '10',\n+    ]);\n+  });\n \n   // delete globals leaked by REPL when `useGlobal` is `true`\n   delete global.module;"
        },
        {
            "sha": "75646a9c00aae7d8228282177687153e40b519ab",
            "filename": "test/parallel/test-repl-use-global.js",
            "status": "modified",
            "additions": 33,
            "deletions": 32,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-use-global.js",
            "raw_url": "https://github.com/nodejs/node/raw/de848ac1e0483327a2ce8716c3f8567eaeacb660/test%2Fparallel%2Ftest-repl-use-global.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-use-global.js?ref=de848ac1e0483327a2ce8716c3f8567eaeacb660",
            "patch": "@@ -7,13 +7,6 @@ const stream = require('stream');\n const repl = require('internal/repl');\n const assert = require('assert');\n \n-// Array of [useGlobal, expectedResult] pairs\n-const globalTestCases = [\n-  [false, 'undefined'],\n-  [true, '\\'tacos\\''],\n-  [undefined, 'undefined']\n-];\n-\n const globalTest = (useGlobal, cb, output) => (err, repl) => {\n   if (err)\n     return cb(err);\n@@ -26,26 +19,12 @@ const globalTest = (useGlobal, cb, output) => (err, repl) => {\n   global.lunch = 'tacos';\n   repl.write('global.lunch;\\n');\n   repl.close();\n-  delete global.lunch;\n-  cb(null, str.trim());\n-};\n-\n-// Test how the global object behaves in each state for useGlobal\n-for (const [option, expected] of globalTestCases) {\n-  runRepl(option, globalTest, common.mustCall((err, output) => {\n-    assert.ifError(err);\n-    assert.strictEqual(output, expected);\n+  repl.on('exit', common.mustCall(() => {\n+    delete global.lunch;\n+    cb(null, str.trim());\n   }));\n-}\n+};\n \n-// Test how shadowing the process object via `let`\n-// behaves in each useGlobal state. Note: we can't\n-// actually test the state when useGlobal is true,\n-// because the exception that's generated is caught\n-// (see below), but errors are printed, and the test\n-// suite is aware of it, causing a failure to be flagged.\n-//\n-const processTestCases = [false, undefined];\n const processTest = (useGlobal, cb, output) => (err, repl) => {\n   if (err)\n     return cb(err);\n@@ -57,15 +36,37 @@ const processTest = (useGlobal, cb, output) => (err, repl) => {\n   repl.write('let process;\\n');\n   repl.write('21 * 2;\\n');\n   repl.close();\n-  cb(null, str.trim());\n-};\n-\n-for (const option of processTestCases) {\n-  runRepl(option, processTest, common.mustCall((err, output) => {\n+  repl.on('exit', common.mustCall((err) => {\n     assert.ifError(err);\n-    assert.strictEqual(output, 'undefined\\n42');\n+    cb(null, str.trim());\n   }));\n-}\n+};\n+\n+// Array of [useGlobal, expectedResult, fn] pairs\n+const testCases = [\n+  // Test how the global object behaves in each state for useGlobal\n+  [false, 'undefined', globalTest],\n+  [true, '\\'tacos\\'', globalTest],\n+  [undefined, 'undefined', globalTest],\n+  // Test how shadowing the process object via `let`\n+  // behaves in each useGlobal state. Note: we can't\n+  // actually test the state when useGlobal is true,\n+  // because the exception that's generated is caught\n+  // (see below), but errors are printed, and the test\n+  // suite is aware of it, causing a failure to be flagged.\n+  [false, 'undefined\\n42', processTest]\n+];\n+\n+const next = common.mustCall(() => {\n+  if (testCases.length) {\n+    const [option, expected, runner] = testCases.shift();\n+    runRepl(option, runner, common.mustCall((err, output) => {\n+      assert.strictEqual(output, expected);\n+      next();\n+    }));\n+  }\n+}, testCases.length + 1);\n+next();\n \n function runRepl(useGlobal, testFunc, cb) {\n   const inputStream = new stream.PassThrough();"
        }
    ],
    "stats": {
        "total": 664,
        "additions": 391,
        "deletions": 273
    }
}