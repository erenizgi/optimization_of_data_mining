{
    "author": "apapirovski",
    "message": "util: fix isInsideNodeModules inside error\n\nWhen isInsideNodeModules gets called while already processing\nanother stack trace, V8 will not call prepareStackTrace again.\nThis used to cause Node.js to just crash â€” fix it by checking\nfor expected return type of the stack (Array).\n\nPR-URL: https://github.com/nodejs/node/pull/20266\nFixes: https://github.com/nodejs/node/issues/20258\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "16aee380a53bb839617bc2daf6c9b61564208906",
    "files": [
        {
            "sha": "071563a737815bdf37ad4981d6a95f060199884a",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/16aee380a53bb839617bc2daf6c9b61564208906/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/16aee380a53bb839617bc2daf6c9b61564208906/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=16aee380a53bb839617bc2daf6c9b61564208906",
            "patch": "@@ -356,16 +356,17 @@ function isInsideNodeModules() {\n \n   // Iterate over all stack frames and look for the first one not coming\n   // from inside Node.js itself:\n-  for (const frame of stack) {\n-    const filename = frame.getFileName();\n-    // If a filename does not start with / or contain \\,\n-    // it's likely from Node.js core.\n-    if (!/^\\/|\\\\/.test(filename))\n-      continue;\n-    return kNodeModulesRE.test(filename);\n+  if (Array.isArray(stack)) {\n+    for (const frame of stack) {\n+      const filename = frame.getFileName();\n+      // If a filename does not start with / or contain \\,\n+      // it's likely from Node.js core.\n+      if (!/^\\/|\\\\/.test(filename))\n+        continue;\n+      return kNodeModulesRE.test(filename);\n+    }\n   }\n-\n-  return false;  // This should be unreachable.\n+  return false;\n }\n \n "
        },
        {
            "sha": "46535e103b33eef4505e53ec5523a73c35e59eb1",
            "filename": "test/parallel/test-buffer-constructor-deprecation-error.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/16aee380a53bb839617bc2daf6c9b61564208906/test%2Fparallel%2Ftest-buffer-constructor-deprecation-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/16aee380a53bb839617bc2daf6c9b61564208906/test%2Fparallel%2Ftest-buffer-constructor-deprecation-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-constructor-deprecation-error.js?ref=16aee380a53bb839617bc2daf6c9b61564208906",
            "patch": "@@ -0,0 +1,17 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+const bufferWarning = 'Buffer() is deprecated due to security and usability ' +\n+                      'issues. Please use the Buffer.alloc(), ' +\n+                      'Buffer.allocUnsafe(), or Buffer.from() methods instead.';\n+\n+common.expectWarning('DeprecationWarning', bufferWarning, 'DEP0005');\n+\n+// This is used to make sure that a warning is only emitted once even though\n+// `new Buffer()` is called twice.\n+process.on('warning', common.mustCall());\n+\n+Error.prepareStackTrace = (err, trace) => new Buffer(10);\n+\n+new Error().stack;"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 27,
        "deletions": 9
    }
}