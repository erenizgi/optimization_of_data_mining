{
    "author": "addaleax",
    "message": "http2: fix memory leak when headers are not emitted\n\nWhen headers are not emitted to JS, e.g. because of an error\nbefore that could happen, we currently still have the vector of\npreviously received headers lying around, each one holding\na reference count of 1.\n\nTo fix the resulting memory leak, release them in the `Http2Stream`\ndestructor.\n\nAlso, clear the vector of headers once they have been emitted –\nthere’s not need to keep it around, wasting memory.\n\nPR-URL: https://github.com/nodejs/node/pull/21373\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc",
    "files": [
        {
            "sha": "572f9e1b69de8a498edf2ace5c50d0b36ec418ee",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc",
            "patch": "@@ -1127,8 +1127,7 @@ void Http2Session::HandleHeadersFrame(const nghttp2_frame* frame) {\n   if (stream->IsDestroyed())\n     return;\n \n-  nghttp2_header* headers = stream->headers();\n-  size_t count = stream->headers_count();\n+  std::vector<nghttp2_header> headers(stream->move_headers());\n \n   Local<String> name_str;\n   Local<String> value_str;\n@@ -1145,9 +1144,9 @@ void Http2Session::HandleHeadersFrame(const nghttp2_frame* frame) {\n   // this way for performance reasons (it's faster to generate and pass an\n   // array than it is to generate and pass the object).\n   size_t n = 0;\n-  while (count > 0) {\n+  while (n < headers.size()) {\n     size_t j = 0;\n-    while (count > 0 && j < arraysize(argv) / 2) {\n+    while (n < headers.size() && j < arraysize(argv) / 2) {\n       nghttp2_header item = headers[n++];\n       // The header name and value are passed as external one-byte strings\n       name_str =\n@@ -1156,7 +1155,6 @@ void Http2Session::HandleHeadersFrame(const nghttp2_frame* frame) {\n           ExternalHeader::New<false>(env(), item.value).ToLocalChecked();\n       argv[j * 2] = name_str;\n       argv[j * 2 + 1] = value_str;\n-      count--;\n       j++;\n     }\n     // For performance, we pass name and value pairs to array.protototype.push\n@@ -1710,6 +1708,11 @@ Http2Stream::Http2Stream(\n \n \n Http2Stream::~Http2Stream() {\n+  for (nghttp2_header& header : current_headers_) {\n+    nghttp2_rcbuf_decref(header.name);\n+    nghttp2_rcbuf_decref(header.value);\n+  }\n+\n   if (session_ == nullptr)\n     return;\n   Debug(this, \"tearing down stream\");"
        },
        {
            "sha": "db453c1087378f037553553e835d81bad0d8057a",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=7a2e2fb36defb85e6b3973f5d94590fc2bbc96cc",
            "patch": "@@ -592,18 +592,14 @@ class Http2Stream : public AsyncWrap,\n \n   bool AddHeader(nghttp2_rcbuf* name, nghttp2_rcbuf* value, uint8_t flags);\n \n-  inline nghttp2_header* headers() {\n-    return current_headers_.data();\n+  inline std::vector<nghttp2_header> move_headers() {\n+    return std::move(current_headers_);\n   }\n \n   inline nghttp2_headers_category headers_category() const {\n     return current_headers_category_;\n   }\n \n-  inline size_t headers_count() const {\n-    return current_headers_.size();\n-  }\n-\n   void StartHeaders(nghttp2_headers_category category);\n \n   // Required for StreamBase"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 10,
        "deletions": 11
    }
}