{
    "author": "devsnek",
    "message": "vm: add code generation options\n\nAdds options to a VM Context to disable code generation from strings\n(such as eval or new Function) and WASM code generation\n(WebAssembly.compile).\n\nPR-URL: https://github.com/nodejs/node/pull/19016\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "cb5f358ee7461f191db8c88e0af26023558f5232",
    "files": [
        {
            "sha": "b9ccf93b7beb674c4cbab9bd9e8a1158477c9553",
            "filename": "doc/api/vm.md",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/doc%2Fapi%2Fvm.md",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/doc%2Fapi%2Fvm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fvm.md?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -495,6 +495,14 @@ added: v0.3.1\n     value of the [`url.origin`][] property of a [`URL`][] object. Most notably,\n     this string should omit the trailing slash, as that denotes a path.\n     **Default:** `''`.\n+  * `contextCodeGeneration` {Object}\n+    * `strings` {boolean} If set to false any calls to `eval` or function\n+      constructors (`Function`, `GeneratorFunction`, etc) will throw an\n+      `EvalError`.\n+      **Default**: `true`.\n+    * `wasm` {boolean} If set to false any attempt to compile a WebAssembly\n+      module will throw a `WebAssembly.CompileError`.\n+      **Default**: `true`.\n \n First contextifies the given `sandbox`, runs the compiled code contained by\n the `vm.Script` object within the created sandbox, and returns the result.\n@@ -578,6 +586,14 @@ added: v0.3.1\n     the [`url.origin`][] property of a [`URL`][] object. Most notably, this\n     string should omit the trailing slash, as that denotes a path.\n     **Default:** `''`.\n+  * `codeGeneration` {Object}\n+    * `strings` {boolean} If set to false any calls to `eval` or function\n+      constructors (`Function`, `GeneratorFunction`, etc) will throw an\n+      `EvalError`.\n+      **Default**: `true`.\n+    * `wasm` {boolean} If set to false any attempt to compile a WebAssembly\n+      module will throw a `WebAssembly.CompileError`.\n+      **Default**: `true`.\n \n If given a `sandbox` object, the `vm.createContext()` method will [prepare\n that sandbox][contextified] so that it can be used in calls to"
        },
        {
            "sha": "5266dbd29fbf8ec1a6888884c0aded95bea39f7b",
            "filename": "lib/vm.js",
            "status": "modified",
            "additions": 35,
            "deletions": 2,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/lib%2Fvm.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/lib%2Fvm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fvm.js?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -84,14 +84,36 @@ function validateString(prop, propName) {\n     throw new ERR_INVALID_ARG_TYPE(propName, 'string', prop);\n }\n \n+function validateBool(prop, propName) {\n+  if (prop !== undefined && typeof prop !== 'boolean')\n+    throw new ERR_INVALID_ARG_TYPE(propName, 'boolean', prop);\n+}\n+\n+function validateObject(prop, propName) {\n+  if (prop !== undefined && (typeof prop !== 'object' || prop === null))\n+    throw new ERR_INVALID_ARG_TYPE(propName, 'Object', prop);\n+}\n+\n function getContextOptions(options) {\n   if (options) {\n+    validateObject(options.contextCodeGeneration,\n+                   'options.contextCodeGeneration');\n     const contextOptions = {\n       name: options.contextName,\n-      origin: options.contextOrigin\n+      origin: options.contextOrigin,\n+      codeGeneration: typeof options.contextCodeGeneration === 'object' ? {\n+        strings: options.contextCodeGeneration.strings,\n+        wasm: options.contextCodeGeneration.wasm,\n+      } : undefined,\n     };\n     validateString(contextOptions.name, 'options.contextName');\n     validateString(contextOptions.origin, 'options.contextOrigin');\n+    if (contextOptions.codeGeneration) {\n+      validateBool(contextOptions.codeGeneration.strings,\n+                   'options.contextCodeGeneration.strings');\n+      validateBool(contextOptions.codeGeneration.wasm,\n+                   'options.contextCodeGeneration.wasm');\n+    }\n     return contextOptions;\n   }\n   return {};\n@@ -109,10 +131,21 @@ function createContext(sandbox, options) {\n     if (typeof options !== 'object' || options === null) {\n       throw new ERR_INVALID_ARG_TYPE('options', 'object', options);\n     }\n+    validateObject(options.codeGeneration, 'options.codeGeneration');\n     options = {\n       name: options.name,\n-      origin: options.origin\n+      origin: options.origin,\n+      codeGeneration: typeof options.codeGeneration === 'object' ? {\n+        strings: options.codeGeneration.strings,\n+        wasm: options.codeGeneration.wasm,\n+      } : undefined,\n     };\n+    if (options.codeGeneration !== undefined) {\n+      validateBool(options.codeGeneration.strings,\n+                   'options.codeGeneration.strings');\n+      validateBool(options.codeGeneration.wasm,\n+                   'options.codeGeneration.wasm');\n+    }\n     if (options.name === undefined) {\n       options.name = `VM Context ${defaultContextNameIndex++}`;\n     } else if (typeof options.name !== 'string') {"
        },
        {
            "sha": "c03c753c37cf09ed19e92e4fc25b8c2f8b8fe642",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -28,6 +28,7 @@\n #include \"node_revert.h\"\n #include \"node_debug_options.h\"\n #include \"node_perf.h\"\n+#include \"node_context_data.h\"\n \n #if defined HAVE_PERFCTR\n #include \"node_counters.h\"\n@@ -4432,6 +4433,8 @@ Local<Context> NewContext(Isolate* isolate,\n   HandleScope handle_scope(isolate);\n   auto intl_key = FIXED_ONE_BYTE_STRING(isolate, \"Intl\");\n   auto break_iter_key = FIXED_ONE_BYTE_STRING(isolate, \"v8BreakIterator\");\n+  context->SetEmbedderData(\n+      ContextEmbedderIndex::kAllowWasmCodeGeneration, True(isolate));\n   Local<Value> intl_v;\n   if (context->Global()->Get(context, intl_key).ToLocal(&intl_v) &&\n       intl_v->IsObject()) {\n@@ -4509,6 +4512,13 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   return exit_code;\n }\n \n+bool AllowWasmCodeGenerationCallback(\n+    Local<Context> context, Local<String>) {\n+  Local<Value> wasm_code_gen =\n+    context->GetEmbedderData(ContextEmbedderIndex::kAllowWasmCodeGeneration);\n+  return wasm_code_gen->IsUndefined() || wasm_code_gen->IsTrue();\n+}\n+\n inline int Start(uv_loop_t* event_loop,\n                  int argc, const char* const* argv,\n                  int exec_argc, const char* const* exec_argv) {\n@@ -4527,6 +4537,7 @@ inline int Start(uv_loop_t* event_loop,\n   isolate->SetAbortOnUncaughtExceptionCallback(ShouldAbortOnUncaughtException);\n   isolate->SetMicrotasksPolicy(v8::MicrotasksPolicy::kExplicit);\n   isolate->SetFatalErrorHandler(OnFatalError);\n+  isolate->SetAllowWasmCodeGenerationCallback(AllowWasmCodeGenerationCallback);\n \n   {\n     Mutex::ScopedLock scoped_lock(node_isolate_mutex);"
        },
        {
            "sha": "522ce292d216845de8a595fa53cc12b3ef9275b0",
            "filename": "src/node_context_data.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_context_data.h",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_context_data.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_context_data.h?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -15,9 +15,14 @@ namespace node {\n #define NODE_CONTEXT_SANDBOX_OBJECT_INDEX 33\n #endif\n \n+#ifndef NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX\n+#define NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX 34\n+#endif\n+\n enum ContextEmbedderIndex {\n   kEnvironment = NODE_CONTEXT_EMBEDDER_DATA_INDEX,\n   kSandboxObject = NODE_CONTEXT_SANDBOX_OBJECT_INDEX,\n+  kAllowWasmCodeGeneration = NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX,\n };\n \n }  // namespace node"
        },
        {
            "sha": "a7f46f61269e2b6617e200ce8765a488ef587084",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -185,6 +185,30 @@ Local<Context> ContextifyContext::CreateV8Context(\n   CHECK(name->IsString());\n   Utf8Value name_val(env->isolate(), name);\n \n+  Local<Value> codegen = options_obj->Get(env->context(),\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"codeGeneration\"))\n+          .ToLocalChecked();\n+\n+  if (!codegen->IsUndefined()) {\n+    CHECK(codegen->IsObject());\n+    Local<Object> codegen_obj = codegen.As<Object>();\n+\n+    Local<Value> allow_code_gen_from_strings =\n+      codegen_obj->Get(env->context(),\n+          FIXED_ONE_BYTE_STRING(env->isolate(), \"strings\"))\n+      .ToLocalChecked();\n+    ctx->AllowCodeGenerationFromStrings(\n+        allow_code_gen_from_strings->IsUndefined() ||\n+            allow_code_gen_from_strings->IsTrue());\n+\n+    Local<Value> allow_wasm_code_gen = codegen_obj->Get(env->context(),\n+        FIXED_ONE_BYTE_STRING(env->isolate(), \"wasm\"))\n+      .ToLocalChecked();\n+    ctx->SetEmbedderData(ContextEmbedderIndex::kAllowWasmCodeGeneration,\n+        Boolean::New(env->isolate(), allow_wasm_code_gen->IsUndefined() ||\n+            allow_wasm_code_gen->IsTrue()));\n+  }\n+\n   ContextInfo info(*name_val);\n \n   Local<Value> origin ="
        },
        {
            "sha": "cf3e6452fd0f7ccd52ce89db6ad727a9dbd9a989",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -24,6 +24,9 @@ class ContextifyContext {\n       v8::Local<v8::Object> sandbox_obj, v8::Local<v8::Object> options_obj);\n   static void Init(Environment* env, v8::Local<v8::Object> target);\n \n+  static bool AllowWasmCodeGeneration(\n+      v8::Local<v8::Context> context, v8::Local<v8::String>);\n+\n   static ContextifyContext* ContextFromContextifiedSandbox(\n       Environment* env,\n       const v8::Local<v8::Object>& sandbox);"
        },
        {
            "sha": "ebafe30c076e018481c487e71fe7dd2c49492cef",
            "filename": "test/parallel/test-vm-codegen.js",
            "status": "added",
            "additions": 110,
            "deletions": 0,
            "changes": 110,
            "blob_url": "https://github.com/nodejs/node/blob/cb5f358ee7461f191db8c88e0af26023558f5232/test%2Fparallel%2Ftest-vm-codegen.js",
            "raw_url": "https://github.com/nodejs/node/raw/cb5f358ee7461f191db8c88e0af26023558f5232/test%2Fparallel%2Ftest-vm-codegen.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-codegen.js?ref=cb5f358ee7461f191db8c88e0af26023558f5232",
            "patch": "@@ -0,0 +1,110 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+const { createContext, runInContext, runInNewContext } = require('vm');\n+\n+const WASM_BYTES = Buffer.from(\n+  [0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00]);\n+\n+\n+function expectsError(fn, type) {\n+  try {\n+    fn();\n+    assert.fail('expected fn to error');\n+  } catch (err) {\n+    if (typeof type === 'string')\n+      assert.strictEqual(err.name, type);\n+    else\n+      assert(err instanceof type);\n+  }\n+}\n+\n+{\n+  const ctx = createContext({ WASM_BYTES });\n+  const test = 'eval(\"\"); new WebAssembly.Module(WASM_BYTES);';\n+  runInContext(test, ctx);\n+\n+  runInNewContext(test, { WASM_BYTES }, {\n+    contextCodeGeneration: undefined,\n+  });\n+}\n+\n+{\n+  const ctx = createContext({}, {\n+    codeGeneration: {\n+      strings: false,\n+    },\n+  });\n+\n+  const EvalError = runInContext('EvalError', ctx);\n+  expectsError(() => {\n+    runInContext('eval(\"x\")', ctx);\n+  }, EvalError);\n+}\n+\n+{\n+  const ctx = createContext({ WASM_BYTES }, {\n+    codeGeneration: {\n+      wasm: false,\n+    },\n+  });\n+\n+  const CompileError = runInContext('WebAssembly.CompileError', ctx);\n+  expectsError(() => {\n+    runInContext('new WebAssembly.Module(WASM_BYTES)', ctx);\n+  }, CompileError);\n+}\n+\n+expectsError(() => {\n+  runInNewContext('eval(\"x\")', {}, {\n+    contextCodeGeneration: {\n+      strings: false,\n+    },\n+  });\n+}, 'EvalError');\n+\n+expectsError(() => {\n+  runInNewContext('new WebAssembly.Module(WASM_BYTES)', { WASM_BYTES }, {\n+    contextCodeGeneration: {\n+      wasm: false,\n+    },\n+  });\n+}, 'CompileError');\n+\n+common.expectsError(() => {\n+  createContext({}, {\n+    codeGeneration: {\n+      strings: 0,\n+    },\n+  });\n+}, {\n+  code: 'ERR_INVALID_ARG_TYPE',\n+});\n+\n+common.expectsError(() => {\n+  runInNewContext('eval(\"x\")', {}, {\n+    contextCodeGeneration: {\n+      wasm: 1,\n+    },\n+  });\n+}, {\n+  code: 'ERR_INVALID_ARG_TYPE'\n+});\n+\n+common.expectsError(() => {\n+  createContext({}, {\n+    codeGeneration: 1,\n+  });\n+}, {\n+  code: 'ERR_INVALID_ARG_TYPE',\n+});\n+\n+common.expectsError(() => {\n+  createContext({}, {\n+    codeGeneration: null,\n+  });\n+}, {\n+  code: 'ERR_INVALID_ARG_TYPE',\n+});"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 204,
        "deletions": 2
    }
}