{
    "author": "hashseed",
    "message": "deps: V8: cherry-pick a440efb27f from upstream\n\nOriginal commit message:\n\n  [api] do not require source string for producing code cache.\n\n  The embedder should not need to keep track of the source string.\n\n  R=jgruber@chromium.org\n\n  Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n  Change-Id: Ie27df755a22fbcae7b6e87a435419d2d8f545558\n  Reviewed-on: https://chromium-review.googlesource.com/1013482\n  Reviewed-by: Jakob Gruber <jgruber@chromium.org>\n  Commit-Queue: Yang Guo <yangguo@chromium.org>\n  Cr-Commit-Position: refs/heads/master@{#52614}\n\nPR-URL: https://github.com/nodejs/node/pull/21022\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
    "files": [
        {
            "sha": "dbf49d11ce327979664743b7fe3047af0e41d020",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -27,7 +27,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.7',\n+    'v8_embedder_string': '-node.8',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "6fb5e50dbeed90118cbdcb7797a1b17a58b1c43e",
            "filename": "deps/v8/include/v8.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Finclude%2Fv8.h",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Finclude%2Fv8.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8.h?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -1578,6 +1578,9 @@ class V8_EXPORT ScriptCompiler {\n    * This will return nullptr if the script cannot be serialized. The\n    * CachedData returned by this function should be owned by the caller.\n    */\n+  static CachedData* CreateCodeCache(Local<UnboundScript> unbound_script);\n+\n+  // Deprecated.\n   static CachedData* CreateCodeCache(Local<UnboundScript> unbound_script,\n                                      Local<String> source);\n \n@@ -1587,6 +1590,9 @@ class V8_EXPORT ScriptCompiler {\n    * This will return nullptr if the script cannot be serialized. The\n    * CachedData returned by this function should be owned by the caller.\n    */\n+  static CachedData* CreateCodeCacheForFunction(Local<Function> function);\n+\n+  // Deprecated.\n   static CachedData* CreateCodeCacheForFunction(Local<Function> function,\n                                                 Local<String> source);\n "
        },
        {
            "sha": "e9a5ec69ec4a71082d58ff6af6a16acffec41594",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -2626,21 +2626,29 @@ uint32_t ScriptCompiler::CachedDataVersionTag() {\n \n ScriptCompiler::CachedData* ScriptCompiler::CreateCodeCache(\n     Local<UnboundScript> unbound_script, Local<String> source) {\n+  return CreateCodeCache(unbound_script);\n+}\n+\n+ScriptCompiler::CachedData* ScriptCompiler::CreateCodeCache(\n+    Local<UnboundScript> unbound_script) {\n   i::Handle<i::SharedFunctionInfo> shared =\n       i::Handle<i::SharedFunctionInfo>::cast(\n           Utils::OpenHandle(*unbound_script));\n-  i::Handle<i::String> source_str = Utils::OpenHandle(*source);\n   DCHECK(shared->is_toplevel());\n-  return i::CodeSerializer::Serialize(shared, source_str);\n+  return i::CodeSerializer::Serialize(shared);\n }\n \n ScriptCompiler::CachedData* ScriptCompiler::CreateCodeCacheForFunction(\n     Local<Function> function, Local<String> source) {\n+  return CreateCodeCacheForFunction(function);\n+}\n+\n+ScriptCompiler::CachedData* ScriptCompiler::CreateCodeCacheForFunction(\n+    Local<Function> function) {\n   i::Handle<i::SharedFunctionInfo> shared(\n       i::Handle<i::JSFunction>::cast(Utils::OpenHandle(*function))->shared());\n-  i::Handle<i::String> source_str = Utils::OpenHandle(*source);\n   CHECK(shared->is_wrapped());\n-  return i::CodeSerializer::Serialize(shared, source_str);\n+  return i::CodeSerializer::Serialize(shared);\n }\n \n MaybeLocal<Script> Script::Compile(Local<Context> context, Local<String> source,"
        },
        {
            "sha": "d9ae952c5c176eea3b5ea7f75503f18be2476c01",
            "filename": "deps/v8/src/d8.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fd8.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fd8.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fd8.cc?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -636,7 +636,7 @@ bool Shell::ExecuteString(Isolate* isolate, Local<String> source,\n         ShellOptions::CodeCacheOptions::kProduceCache) {\n       // Serialize and store it in memory for the next execution.\n       ScriptCompiler::CachedData* cached_data =\n-          ScriptCompiler::CreateCodeCache(script->GetUnboundScript(), source);\n+          ScriptCompiler::CreateCodeCache(script->GetUnboundScript());\n       StoreInCodeCache(isolate, source, cached_data);\n       delete cached_data;\n     }\n@@ -645,7 +645,7 @@ bool Shell::ExecuteString(Isolate* isolate, Local<String> source,\n         ShellOptions::CodeCacheOptions::kProduceCacheAfterExecute) {\n       // Serialize and store it in memory for the next execution.\n       ScriptCompiler::CachedData* cached_data =\n-          ScriptCompiler::CreateCodeCache(script->GetUnboundScript(), source);\n+          ScriptCompiler::CreateCodeCache(script->GetUnboundScript());\n       StoreInCodeCache(isolate, source, cached_data);\n       delete cached_data;\n     }"
        },
        {
            "sha": "823d8dc9af8b872af7c702ffe6cb20f35c26f96a",
            "filename": "deps/v8/src/snapshot/code-serializer.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -32,7 +32,7 @@ ScriptData::ScriptData(const byte* data, int length)\n \n // static\n ScriptCompiler::CachedData* CodeSerializer::Serialize(\n-    Handle<SharedFunctionInfo> info, Handle<String> source) {\n+    Handle<SharedFunctionInfo> info) {\n   Isolate* isolate = info->GetIsolate();\n   TRACE_EVENT_CALL_STATS_SCOPED(isolate, \"v8\", \"V8.Execute\");\n   HistogramTimerScope histogram_timer(isolate->counters()->compile_serialize());\n@@ -45,8 +45,7 @@ ScriptCompiler::CachedData* CodeSerializer::Serialize(\n   Handle<Script> script(Script::cast(info->script()), isolate);\n   if (FLAG_trace_serializer) {\n     PrintF(\"[Serializing from\");\n-    Object* script = info->script();\n-    Script::cast(script)->name()->ShortPrint();\n+    script->name()->ShortPrint();\n     PrintF(\"]\\n\");\n   }\n   // TODO(7110): Enable serialization of Asm modules once the AsmWasmData is\n@@ -55,10 +54,11 @@ ScriptCompiler::CachedData* CodeSerializer::Serialize(\n   if (isolate->debug()->is_loaded()) return nullptr;\n \n   // Serialize code object.\n+  Handle<String> source(String::cast(script->source()), isolate);\n   CodeSerializer cs(isolate, SerializedCodeData::SourceHash(source));\n   DisallowHeapAllocation no_gc;\n   cs.reference_map()->AddAttachedReference(*source);\n-  ScriptData* script_data = cs.Serialize(info);\n+  ScriptData* script_data = cs.SerializeSharedFunctionInfo(info);\n \n   if (FLAG_profile_deserialization) {\n     double ms = timer.Elapsed().InMillisecondsF();\n@@ -75,11 +75,12 @@ ScriptCompiler::CachedData* CodeSerializer::Serialize(\n   return result;\n }\n \n-ScriptData* CodeSerializer::Serialize(Handle<HeapObject> obj) {\n+ScriptData* CodeSerializer::SerializeSharedFunctionInfo(\n+    Handle<SharedFunctionInfo> info) {\n   DisallowHeapAllocation no_gc;\n \n   VisitRootPointer(Root::kHandleScope, nullptr,\n-                   Handle<Object>::cast(obj).location());\n+                   Handle<Object>::cast(info).location());\n   SerializeDeferredObjects();\n   Pad();\n "
        },
        {
            "sha": "f6b51bf9b1a0bc8ad914a477f4e504e347a7072e",
            "filename": "deps/v8/src/snapshot/code-serializer.h",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.h",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.h?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -45,10 +45,9 @@ class ScriptData {\n \n class CodeSerializer : public Serializer<> {\n  public:\n-  static ScriptCompiler::CachedData* Serialize(Handle<SharedFunctionInfo> info,\n-                                               Handle<String> source);\n+  static ScriptCompiler::CachedData* Serialize(Handle<SharedFunctionInfo> info);\n \n-  ScriptData* Serialize(Handle<HeapObject> obj);\n+  ScriptData* SerializeSharedFunctionInfo(Handle<SharedFunctionInfo> info);\n \n   V8_WARN_UNUSED_RESULT static MaybeHandle<SharedFunctionInfo> Deserialize(\n       Isolate* isolate, ScriptData* cached_data, Handle<String> source);"
        },
        {
            "sha": "4ebd93b86c5759a932600808cd66fd01fabd7f7f",
            "filename": "deps/v8/test/cctest/test-api.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -25485,8 +25485,7 @@ TEST(CodeCache) {\n         v8::ScriptCompiler::kNoCompileOptions;\n     v8::Local<v8::Script> script =\n         v8::ScriptCompiler::Compile(context, &source, option).ToLocalChecked();\n-    cache = v8::ScriptCompiler::CreateCodeCache(script->GetUnboundScript(),\n-                                                source_string);\n+    cache = v8::ScriptCompiler::CreateCodeCache(script->GetUnboundScript());\n   }\n   isolate1->Dispose();\n "
        },
        {
            "sha": "695bbbcfcba2038a94c1652c85d6b898813d242f",
            "filename": "deps/v8/test/cctest/test-serialize.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8d27477acf59b7a15b2cf78c957e3fd1dc3245f5/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-serialize.cc?ref=8d27477acf59b7a15b2cf78c957e3fd1dc3245f5",
            "patch": "@@ -1240,8 +1240,7 @@ static Handle<SharedFunctionInfo> CompileScriptAndProduceCache(\n           NOT_NATIVES_CODE)\n           .ToHandleChecked();\n   std::unique_ptr<ScriptCompiler::CachedData> cached_data(\n-      ScriptCompiler::CreateCodeCache(ToApiHandle<UnboundScript>(sfi),\n-                                      Utils::ToLocal(source)));\n+      ScriptCompiler::CreateCodeCache(ToApiHandle<UnboundScript>(sfi)));\n   uint8_t* buffer = NewArray<uint8_t>(cached_data->length);\n   MemCopy(buffer, cached_data->data, cached_data->length);\n   *script_data = new i::ScriptData(buffer, cached_data->length);\n@@ -1895,7 +1894,7 @@ v8::ScriptCompiler::CachedData* CompileRunAndProduceCache(\n             .ToLocalChecked();\n \n     if (cacheType != CodeCacheType::kAfterExecute) {\n-      cache = ScriptCompiler::CreateCodeCache(script, source_str);\n+      cache = ScriptCompiler::CreateCodeCache(script);\n     }\n \n     v8::Local<v8::Value> result = script->BindToCurrentContext()\n@@ -1907,7 +1906,7 @@ v8::ScriptCompiler::CachedData* CompileRunAndProduceCache(\n               .FromJust());\n \n     if (cacheType == CodeCacheType::kAfterExecute) {\n-      cache = ScriptCompiler::CreateCodeCache(script, source_str);\n+      cache = ScriptCompiler::CreateCodeCache(script);\n     }\n     CHECK(cache);\n   }\n@@ -2153,7 +2152,7 @@ TEST(CodeSerializerWithHarmonyScoping) {\n         v8::ScriptCompiler::CompileUnboundScript(\n             isolate1, &source, v8::ScriptCompiler::kNoCompileOptions)\n             .ToLocalChecked();\n-    cache = v8::ScriptCompiler::CreateCodeCache(script, source_str);\n+    cache = v8::ScriptCompiler::CreateCodeCache(script);\n     CHECK(cache);\n \n     v8::Local<v8::Value> result = script->BindToCurrentContext()\n@@ -2218,7 +2217,7 @@ TEST(Regress503552) {\n   heap::SimulateIncrementalMarking(isolate->heap());\n \n   v8::ScriptCompiler::CachedData* cache_data =\n-      CodeSerializer::Serialize(shared, source);\n+      CodeSerializer::Serialize(shared);\n   delete cache_data;\n }\n "
        }
    ],
    "stats": {
        "total": 60,
        "additions": 36,
        "deletions": 24
    }
}