{
    "author": "joyeecheung",
    "message": "lib: move setupAllowedFlags() into per_thread.js\n\nBecause most of its code (the getter) has nothing to do with\nthe actual bootstrapping and it is run per-thread.\n\nPR-URL: https://github.com/nodejs/node/pull/24704\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Christopher Hiller <boneskull@boneskull.com>",
    "sha": "36f483b79b56db9da62c15db4bb3293032ac2073",
    "files": [
        {
            "sha": "98d4b3c1d9c283f9b4a84eab932100f19b304753",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 124,
            "changes": 125,
            "blob_url": "https://github.com/nodejs/node/blob/36f483b79b56db9da62c15db4bb3293032ac2073/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/36f483b79b56db9da62c15db4bb3293032ac2073/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=36f483b79b56db9da62c15db4bb3293032ac2073",
            "patch": "@@ -223,7 +223,7 @@\n \n     perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n \n-    setupAllowedFlags();\n+    perThreadSetup.setupAllowedFlags();\n \n     startExecution();\n   }\n@@ -739,128 +739,5 @@\n     new vm.Script(source, { displayErrors: true, filename });\n   }\n \n-  function setupAllowedFlags() {\n-    // This builds process.allowedNodeEnvironmentFlags\n-    // from data in the config binding\n-\n-    const replaceUnderscoresRegex = /_/g;\n-    const leadingDashesRegex = /^--?/;\n-    const trailingValuesRegex = /=.*$/;\n-\n-    // Save references so user code does not interfere\n-    const replace = Function.call.bind(String.prototype.replace);\n-    const has = Function.call.bind(Set.prototype.has);\n-    const test = Function.call.bind(RegExp.prototype.test);\n-\n-    const get = () => {\n-      const {\n-        envSettings: { kAllowedInEnvironment }\n-      } = internalBinding('options');\n-      const { options, aliases } = NativeModule.require('internal/options');\n-\n-      const allowedNodeEnvironmentFlags = [];\n-      for (const [name, info] of options) {\n-        if (info.envVarSettings === kAllowedInEnvironment) {\n-          allowedNodeEnvironmentFlags.push(name);\n-        }\n-      }\n-\n-      for (const [ from, expansion ] of aliases) {\n-        let isAccepted = true;\n-        for (const to of expansion) {\n-          if (!to.startsWith('-') || to === '--') continue;\n-          const recursiveExpansion = aliases.get(to);\n-          if (recursiveExpansion) {\n-            if (recursiveExpansion[0] === to)\n-              recursiveExpansion.splice(0, 1);\n-            expansion.push(...recursiveExpansion);\n-            continue;\n-          }\n-          isAccepted = options.get(to).envVarSettings === kAllowedInEnvironment;\n-          if (!isAccepted) break;\n-        }\n-        if (isAccepted) {\n-          let canonical = from;\n-          if (canonical.endsWith('='))\n-            canonical = canonical.substr(0, canonical.length - 1);\n-          if (canonical.endsWith(' <arg>'))\n-            canonical = canonical.substr(0, canonical.length - 4);\n-          allowedNodeEnvironmentFlags.push(canonical);\n-        }\n-      }\n-\n-      const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n-\n-      // Save these for comparison against flags provided to\n-      // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n-      // Avoid interference w/ user code by flattening `Set.prototype` into\n-      // each object.\n-      const nodeFlags = Object.defineProperties(\n-        new Set(allowedNodeEnvironmentFlags.map(trimLeadingDashes)),\n-        Object.getOwnPropertyDescriptors(Set.prototype)\n-      );\n-\n-      class NodeEnvironmentFlagsSet extends Set {\n-        constructor(...args) {\n-          super(...args);\n-\n-          // the super constructor consumes `add`, but\n-          // disallow any future adds.\n-          this.add = () => this;\n-        }\n-\n-        delete() {\n-          // noop, `Set` API compatible\n-          return false;\n-        }\n-\n-        clear() {\n-          // noop\n-        }\n-\n-        has(key) {\n-          // This will return `true` based on various possible\n-          // permutations of a flag, including present/missing leading\n-          // dash(es) and/or underscores-for-dashes.\n-          // Strips any values after `=`, inclusive.\n-          // TODO(addaleax): It might be more flexible to run the option parser\n-          // on a dummy option set and see whether it rejects the argument or\n-          // not.\n-          if (typeof key === 'string') {\n-            key = replace(key, replaceUnderscoresRegex, '-');\n-            if (test(leadingDashesRegex, key)) {\n-              key = replace(key, trailingValuesRegex, '');\n-              return has(this, key);\n-            }\n-            return has(nodeFlags, key);\n-          }\n-          return false;\n-        }\n-      }\n-\n-      Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n-      Object.freeze(NodeEnvironmentFlagsSet.prototype);\n-\n-      return process.allowedNodeEnvironmentFlags = Object.freeze(\n-        new NodeEnvironmentFlagsSet(\n-          allowedNodeEnvironmentFlags\n-        ));\n-    };\n-\n-    Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n-      get,\n-      set(value) {\n-        Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n-          value,\n-          configurable: true,\n-          enumerable: true,\n-          writable: true\n-        });\n-      },\n-      enumerable: true,\n-      configurable: true\n-    });\n-  }\n-\n   startup();\n });"
        },
        {
            "sha": "952abda8b671471870db236906b1605a8f8afc00",
            "filename": "lib/internal/process/per_thread.js",
            "status": "modified",
            "additions": 125,
            "deletions": 0,
            "changes": 125,
            "blob_url": "https://github.com/nodejs/node/blob/36f483b79b56db9da62c15db4bb3293032ac2073/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/36f483b79b56db9da62c15db4bb3293032ac2073/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fper_thread.js?ref=36f483b79b56db9da62c15db4bb3293032ac2073",
            "patch": "@@ -234,7 +234,132 @@ function setupUncaughtExceptionCapture(exceptionHandlerState,\n   };\n }\n \n+const replaceUnderscoresRegex = /_/g;\n+const leadingDashesRegex = /^--?/;\n+const trailingValuesRegex = /=.*$/;\n+\n+// Save references so user code does not interfere\n+const replace = Function.call.bind(String.prototype.replace);\n+const has = Function.call.bind(Set.prototype.has);\n+const test = Function.call.bind(RegExp.prototype.test);\n+\n+// This builds the initial process.allowedNodeEnvironmentFlags\n+// from data in the config binding.\n+function buildAllowedFlags() {\n+  const {\n+    envSettings: { kAllowedInEnvironment }\n+  } = internalBinding('options');\n+  const { options, aliases } = require('internal/options');\n+\n+  const allowedNodeEnvironmentFlags = [];\n+  for (const [name, info] of options) {\n+    if (info.envVarSettings === kAllowedInEnvironment) {\n+      allowedNodeEnvironmentFlags.push(name);\n+    }\n+  }\n+\n+  for (const [ from, expansion ] of aliases) {\n+    let isAccepted = true;\n+    for (const to of expansion) {\n+      if (!to.startsWith('-') || to === '--') continue;\n+      const recursiveExpansion = aliases.get(to);\n+      if (recursiveExpansion) {\n+        if (recursiveExpansion[0] === to)\n+          recursiveExpansion.splice(0, 1);\n+        expansion.push(...recursiveExpansion);\n+        continue;\n+      }\n+      isAccepted = options.get(to).envVarSettings === kAllowedInEnvironment;\n+      if (!isAccepted) break;\n+    }\n+    if (isAccepted) {\n+      let canonical = from;\n+      if (canonical.endsWith('='))\n+        canonical = canonical.substr(0, canonical.length - 1);\n+      if (canonical.endsWith(' <arg>'))\n+        canonical = canonical.substr(0, canonical.length - 4);\n+      allowedNodeEnvironmentFlags.push(canonical);\n+    }\n+  }\n+\n+  const trimLeadingDashes = (flag) => replace(flag, leadingDashesRegex, '');\n+\n+  // Save these for comparison against flags provided to\n+  // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n+  // Avoid interference w/ user code by flattening `Set.prototype` into\n+  // each object.\n+  const nodeFlags = Object.defineProperties(\n+    new Set(allowedNodeEnvironmentFlags.map(trimLeadingDashes)),\n+    Object.getOwnPropertyDescriptors(Set.prototype)\n+  );\n+\n+  class NodeEnvironmentFlagsSet extends Set {\n+    constructor(...args) {\n+      super(...args);\n+\n+      // the super constructor consumes `add`, but\n+      // disallow any future adds.\n+      this.add = () => this;\n+    }\n+\n+    delete() {\n+      // noop, `Set` API compatible\n+      return false;\n+    }\n+\n+    clear() {\n+      // noop\n+    }\n+\n+    has(key) {\n+      // This will return `true` based on various possible\n+      // permutations of a flag, including present/missing leading\n+      // dash(es) and/or underscores-for-dashes.\n+      // Strips any values after `=`, inclusive.\n+      // TODO(addaleax): It might be more flexible to run the option parser\n+      // on a dummy option set and see whether it rejects the argument or\n+      // not.\n+      if (typeof key === 'string') {\n+        key = replace(key, replaceUnderscoresRegex, '-');\n+        if (test(leadingDashesRegex, key)) {\n+          key = replace(key, trailingValuesRegex, '');\n+          return has(this, key);\n+        }\n+        return has(nodeFlags, key);\n+      }\n+      return false;\n+    }\n+  }\n+\n+  Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n+  Object.freeze(NodeEnvironmentFlagsSet.prototype);\n+\n+  return process.allowedNodeEnvironmentFlags = Object.freeze(\n+    new NodeEnvironmentFlagsSet(\n+      allowedNodeEnvironmentFlags\n+    ));\n+}\n+\n+function setupAllowedFlags() {\n+  Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n+    get: buildAllowedFlags,\n+    set(value) {\n+      // If the user tries to set this to another value, override\n+      // this completely to that value.\n+      Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n+        value,\n+        configurable: true,\n+        enumerable: true,\n+        writable: true\n+      });\n+    },\n+    enumerable: true,\n+    configurable: true\n+  });\n+}\n+\n module.exports = {\n+  setupAllowedFlags,\n   setupAssert,\n   setupCpuUsage,\n   setupHrtime,"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 126,
        "deletions": 124
    }
}