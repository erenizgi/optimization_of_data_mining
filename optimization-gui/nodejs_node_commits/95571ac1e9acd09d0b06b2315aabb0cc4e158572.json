{
    "author": "addaleax",
    "message": "src: pass along errors from process obj instantiation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "95571ac1e9acd09d0b06b2315aabb0cc4e158572",
    "files": [
        {
            "sha": "78ed42f89af9fcdd89ca1043006a40cb0318d6c8",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 23,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -289,29 +289,10 @@ Environment::~Environment() {\n   }\n }\n \n-void Environment::Start(const std::vector<std::string>& args,\n-                        const std::vector<std::string>& exec_args,\n-                        bool start_profiler_idle_notifier) {\n+void Environment::Start(bool start_profiler_idle_notifier) {\n   HandleScope handle_scope(isolate());\n   Context::Scope context_scope(context());\n \n-  if (*TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n-      TRACING_CATEGORY_NODE1(environment)) != 0) {\n-    auto traced_value = tracing::TracedValue::Create();\n-    traced_value->BeginArray(\"args\");\n-    for (const std::string& arg : args)\n-      traced_value->AppendString(arg);\n-    traced_value->EndArray();\n-    traced_value->BeginArray(\"exec_args\");\n-    for (const std::string& arg : exec_args)\n-      traced_value->AppendString(arg);\n-    traced_value->EndArray();\n-    TRACE_EVENT_NESTABLE_ASYNC_BEGIN1(\n-      TRACING_CATEGORY_NODE1(environment),\n-      \"Environment\", this,\n-      \"args\", std::move(traced_value));\n-  }\n-\n   CHECK_EQ(0, uv_timer_init(event_loop(), timer_handle()));\n   uv_unref(reinterpret_cast<uv_handle_t*>(timer_handle()));\n \n@@ -346,14 +327,37 @@ void Environment::Start(const std::vector<std::string>& args,\n     StartProfilerIdleNotifier();\n   }\n \n-  Local<Object> process_object = CreateProcessObject(this, args, exec_args);\n-  set_process_object(process_object);\n-\n   static uv_once_t init_once = UV_ONCE_INIT;\n   uv_once(&init_once, InitThreadLocalOnce);\n   uv_key_set(&thread_local_env, this);\n }\n \n+MaybeLocal<Object> Environment::CreateProcessObject(\n+    const std::vector<std::string>& args,\n+    const std::vector<std::string>& exec_args) {\n+  if (*TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n+          TRACING_CATEGORY_NODE1(environment)) != 0) {\n+    auto traced_value = tracing::TracedValue::Create();\n+    traced_value->BeginArray(\"args\");\n+    for (const std::string& arg : args) traced_value->AppendString(arg);\n+    traced_value->EndArray();\n+    traced_value->BeginArray(\"exec_args\");\n+    for (const std::string& arg : exec_args) traced_value->AppendString(arg);\n+    traced_value->EndArray();\n+    TRACE_EVENT_NESTABLE_ASYNC_BEGIN1(TRACING_CATEGORY_NODE1(environment),\n+                                      \"Environment\",\n+                                      this,\n+                                      \"args\",\n+                                      std::move(traced_value));\n+  }\n+\n+  Local<Object> process_object =\n+      node::CreateProcessObject(this, args, exec_args)\n+          .FromMaybe(Local<Object>());\n+  set_process_object(process_object);\n+  return process_object;\n+}\n+\n void Environment::RegisterHandleCleanups() {\n   HandleCleanupCb close_and_finish = [](Environment* env, uv_handle_t* handle,\n                                         void* arg) {"
        },
        {
            "sha": "0d44c7741840595e26e34db902de8914779a3606",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -612,9 +612,10 @@ class Environment {\n               v8::Local<v8::Context> context);\n   ~Environment();\n \n-  void Start(const std::vector<std::string>& args,\n-             const std::vector<std::string>& exec_args,\n-             bool start_profiler_idle_notifier);\n+  void Start(bool start_profiler_idle_notifier);\n+  v8::MaybeLocal<v8::Object> CreateProcessObject(\n+      const std::vector<std::string>& args,\n+      const std::vector<std::string>& exec_args);\n \n   typedef void (*HandleCleanupCb)(Environment* env,\n                                   uv_handle_t* handle,"
        },
        {
            "sha": "881ace6e425a77f14607748247e2ab09cbfe2c54",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -1179,7 +1179,8 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   std::vector<std::string> args(argv, argv + argc);\n   std::vector<std::string> exec_args(exec_argv, exec_argv + exec_argc);\n   Environment* env = new Environment(isolate_data, context);\n-  env->Start(args, exec_args, per_process::v8_is_profiling);\n+  env->Start(per_process::v8_is_profiling);\n+  env->CreateProcessObject(args, exec_args);\n   return env;\n }\n \n@@ -1253,7 +1254,8 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n   Environment env(isolate_data, context);\n-  env.Start(args, exec_args, per_process::v8_is_profiling);\n+  env.Start(per_process::v8_is_profiling);\n+  env.CreateProcessObject(args, exec_args);\n \n #if HAVE_INSPECTOR && NODE_USE_V8_PLATFORM\n   CHECK(!env.inspector_agent()->IsListening());"
        },
        {
            "sha": "d994a2199a5202e6eae656aecd1bbdf65f80c90d",
            "filename": "src/node_env_var.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_env_var.cc",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_env_var.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_env_var.cc?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -17,6 +17,7 @@ using v8::EscapableHandleScope;\n using v8::Integer;\n using v8::Isolate;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Name;\n using v8::NamedPropertyHandlerConfiguration;\n using v8::NewStringType;\n@@ -209,15 +210,13 @@ static void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n   info.GetReturnValue().Set(envarr);\n }\n \n-Local<Object> CreateEnvVarProxy(Local<Context> context,\n-                                Isolate* isolate,\n-                                Local<Value> data) {\n+MaybeLocal<Object> CreateEnvVarProxy(Local<Context> context,\n+                                     Isolate* isolate,\n+                                     Local<Value> data) {\n   EscapableHandleScope scope(isolate);\n   Local<ObjectTemplate> env_proxy_template = ObjectTemplate::New(isolate);\n   env_proxy_template->SetHandler(NamedPropertyHandlerConfiguration(\n       EnvGetter, EnvSetter, EnvQuery, EnvDeleter, EnvEnumerator, data));\n-  Local<Object> env_proxy =\n-      env_proxy_template->NewInstance(context).ToLocalChecked();\n-  return scope.Escape(env_proxy);\n+  return scope.EscapeMaybe(env_proxy_template->NewInstance(context));\n }\n }  // namespace node"
        },
        {
            "sha": "452805ada314491a3d8016ae4ddb69617d9dd897",
            "filename": "src/node_process.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_process.h",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_process.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.h?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -7,9 +7,9 @@\n \n namespace node {\n \n-v8::Local<v8::Object> CreateEnvVarProxy(v8::Local<v8::Context> context,\n-                                        v8::Isolate* isolate,\n-                                        v8::Local<v8::Value> data);\n+v8::MaybeLocal<v8::Object> CreateEnvVarProxy(v8::Local<v8::Context> context,\n+                                             v8::Isolate* isolate,\n+                                             v8::Local<v8::Value> data);\n \n // Most of the time, it's best to use `console.error` to write\n // to the process.stderr stream.  However, in some cases, such as\n@@ -31,7 +31,7 @@ v8::Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                               const char* warning,\n                                               const char* deprecation_code);\n \n-v8::Local<v8::Object> CreateProcessObject(\n+v8::MaybeLocal<v8::Object> CreateProcessObject(\n     Environment* env,\n     const std::vector<std::string>& args,\n     const std::vector<std::string>& exec_args);"
        },
        {
            "sha": "c1f8806110ffef180d0749399cc6773fe219273d",
            "filename": "src/node_process_object.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_process_object.cc",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_process_object.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process_object.cc?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -19,6 +19,7 @@ using v8::Integer;\n using v8::Isolate;\n using v8::Just;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Name;\n using v8::NewStringType;\n using v8::None;\n@@ -66,19 +67,22 @@ static void GetParentProcessId(Local<Name> property,\n   info.GetReturnValue().Set(uv_os_getppid());\n }\n \n-Local<Object> CreateProcessObject(Environment* env,\n-                                  const std::vector<std::string>& args,\n-                                  const std::vector<std::string>& exec_args) {\n+MaybeLocal<Object> CreateProcessObject(\n+    Environment* env,\n+    const std::vector<std::string>& args,\n+    const std::vector<std::string>& exec_args) {\n   Isolate* isolate = env->isolate();\n   EscapableHandleScope scope(isolate);\n   Local<Context> context = env->context();\n \n   Local<FunctionTemplate> process_template = FunctionTemplate::New(isolate);\n   process_template->SetClassName(FIXED_ONE_BYTE_STRING(isolate, \"process\"));\n-  Local<Object> process = process_template->GetFunction(context)\n-                              .ToLocalChecked()\n-                              ->NewInstance(context)\n-                              .ToLocalChecked();\n+  Local<Function> process_ctor;\n+  Local<Object> process;\n+  if (!process_template->GetFunction(context).ToLocal(&process_ctor) ||\n+      !process_ctor->NewInstance(context).ToLocal(&process)) {\n+    return MaybeLocal<Object>();\n+  }\n \n   // process.title\n   auto title_string = FIXED_ONE_BYTE_STRING(env->isolate(), \"title\");\n@@ -145,11 +149,16 @@ Local<Object> CreateProcessObject(Environment* env,\n                ToV8Value(env->context(), exec_args)\n                    .ToLocalChecked()).FromJust();\n \n+  Local<Object> env_var_proxy;\n+  if (!CreateEnvVarProxy(context, isolate, env->as_external())\n+           .ToLocal(&env_var_proxy))\n+    return MaybeLocal<Object>();\n+\n   // process.env\n   process\n       ->Set(env->context(),\n             FIXED_ONE_BYTE_STRING(env->isolate(), \"env\"),\n-            CreateEnvVarProxy(context, isolate, env->as_external()))\n+            env_var_proxy)\n       .FromJust();\n \n   READONLY_PROPERTY(process, \"pid\","
        },
        {
            "sha": "e5ba438bc1501cff4a3c081c2fe801a6915c91b9",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/95571ac1e9acd09d0b06b2315aabb0cc4e158572/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=95571ac1e9acd09d0b06b2315aabb0cc4e158572",
            "patch": "@@ -132,9 +132,9 @@ Worker::Worker(Environment* env,\n     env_->set_worker_context(this);\n     env_->set_thread_id(thread_id_);\n \n-    env_->Start(std::vector<std::string>{},\n-                std::vector<std::string>{},\n-                env->profiler_idle_notifier_started());\n+    env_->Start(env->profiler_idle_notifier_started());\n+    env_->CreateProcessObject(std::vector<std::string>{},\n+                              std::vector<std::string>{});\n     // Done while on the parent thread\n     AddWorkerInspector(env, env_.get(), thread_id_, url_);\n   }"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 64,
        "deletions": 49
    }
}