{
    "author": "joyeecheung",
    "message": "tools: make apilinks building more robust\n\n1. Move the apilinks.json file into out/doc so it gets cleaned when\n  running `make docclean`\n2. When the apilinks.json generated is empty, throw a specific error\n  so it's easier to understand what's wrong\n3. Write to a file passed through CLI arguments instead writing to\n  stdout in apilinks.js so the build process is more robust in\n  the case of a bad binary\n\nPR-URL: https://github.com/nodejs/node/pull/25019\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "9190e4ecdf891892e479b0ef4b691252d4084806",
    "files": [
        {
            "sha": "9f6c76c61f7f2ddcf7205e41809e4fc33a59212d",
            "filename": "Makefile",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/9190e4ecdf891892e479b0ef4b691252d4084806/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/9190e4ecdf891892e479b0ef4b691252d4084806/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=9190e4ecdf891892e479b0ef4b691252d4084806",
            "patch": "@@ -692,16 +692,16 @@ out/doc/api/assets/%: doc/api_assets/% out/doc/api/assets\n \n run-npm-ci = $(PWD)/$(NPM) ci\n \n+LINK_DATA = out/doc/apilinks.json\n gen-api = tools/doc/generate.js --node-version=$(FULLVERSION) \\\n-\t\t--apilinks=out/apilinks.json $< --output-directory=out/doc/api\n-gen-apilink = tools/doc/apilinks.js $(wildcard lib/*.js) > $@\n+\t\t--apilinks=$(LINK_DATA) $< --output-directory=out/doc/api\n+gen-apilink = tools/doc/apilinks.js $(LINK_DATA) $(wildcard lib/*.js)\n \n-out/apilinks.json: $(wildcard lib/*.js) tools/doc/apilinks.js\n+$(LINK_DATA): $(wildcard lib/*.js) tools/doc/apilinks.js\n \t$(call available-node, $(gen-apilink))\n \n out/doc/api/%.json out/doc/api/%.html: doc/api/%.md tools/doc/generate.js \\\n-\ttools/doc/html.js tools/doc/json.js tools/doc/apilinks.js | \\\n-\tout/apilinks.json\n+\ttools/doc/html.js tools/doc/json.js tools/doc/apilinks.js | $(LINK_DATA)\n \t$(call available-node, $(gen-api))\n \n out/doc/api/all.html: $(apidocs_html) tools/doc/allhtml.js \\"
        },
        {
            "sha": "91de4b79f865f40fed58cded2ad7acdea626388e",
            "filename": "test/doctool/test-apilinks.js",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/9190e4ecdf891892e479b0ef4b691252d4084806/test%2Fdoctool%2Ftest-apilinks.js",
            "raw_url": "https://github.com/nodejs/node/raw/9190e4ecdf891892e479b0ef4b691252d4084806/test%2Fdoctool%2Ftest-apilinks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fdoctool%2Ftest-apilinks.js?ref=9190e4ecdf891892e479b0ef4b691252d4084806",
            "patch": "@@ -2,28 +2,31 @@\n \n require('../common');\n const fixtures = require('../common/fixtures');\n+const tmpdir = require('../common/tmpdir');\n const fs = require('fs');\n const assert = require('assert');\n const path = require('path');\n const { execFileSync } = require('child_process');\n \n const script = path.join(__dirname, '..', '..', 'tools', 'doc', 'apilinks.js');\n-\n const apilinks = fixtures.path('apilinks');\n+\n+tmpdir.refresh();\n+\n fs.readdirSync(apilinks).forEach((fixture) => {\n   if (!fixture.endsWith('.js')) return;\n-  const file = path.join(apilinks, fixture);\n-\n-  const expectedContent = fs.readFileSync(file + 'on', 'utf8');\n+  const input = path.join(apilinks, fixture);\n \n-  const output = execFileSync(\n+  const expectedContent = fs.readFileSync(`${input}on`, 'utf8');\n+  const outputPath = path.join(tmpdir.path, `${fixture}on`);\n+  execFileSync(\n     process.execPath,\n-    [script, file],\n+    [script, outputPath, input],\n     { encoding: 'utf-8' }\n   );\n \n   const expectedLinks = JSON.parse(expectedContent);\n-  const actualLinks = JSON.parse(output);\n+  const actualLinks = JSON.parse(fs.readFileSync(outputPath));\n \n   for (const [k, v] of Object.entries(expectedLinks)) {\n     assert.ok(k in actualLinks, `link not found: ${k}`);"
        },
        {
            "sha": "9c23ae55c59370770a16e961b189c79985171e8a",
            "filename": "tools/doc/apilinks.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9190e4ecdf891892e479b0ef4b691252d4084806/tools%2Fdoc%2Fapilinks.js",
            "raw_url": "https://github.com/nodejs/node/raw/9190e4ecdf891892e479b0ef4b691252d4084806/tools%2Fdoc%2Fapilinks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fapilinks.js?ref=9190e4ecdf891892e479b0ef4b691252d4084806",
            "patch": "@@ -47,7 +47,9 @@ const tag = execSync(`git describe --contains ${hash}`).split('\\n')[0] || hash;\n \n // Extract definitions from each file specified.\n const definition = {};\n-process.argv.slice(2).forEach((file) => {\n+const output = process.argv[2];\n+const inputs = process.argv.slice(3);\n+inputs.forEach((file) => {\n   const basename = path.basename(file, '.js');\n \n   // Parse source.\n@@ -206,4 +208,4 @@ process.argv.slice(2).forEach((file) => {\n   }\n });\n \n-console.log(JSON.stringify(definition, null, 2));\n+fs.writeFileSync(output, JSON.stringify(definition, null, 2), 'utf8');"
        },
        {
            "sha": "dd213a35a6bbc4be7f63a0ba031116e156059880",
            "filename": "tools/doc/generate.js",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/9190e4ecdf891892e479b0ef4b691252d4084806/tools%2Fdoc%2Fgenerate.js",
            "raw_url": "https://github.com/nodejs/node/raw/9190e4ecdf891892e479b0ef4b691252d4084806/tools%2Fdoc%2Fgenerate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fgenerate.js?ref=9190e4ecdf891892e479b0ef4b691252d4084806",
            "patch": "@@ -49,9 +49,12 @@ args.forEach(function(arg) {\n   } else if (arg.startsWith('--output-directory=')) {\n     outputDir = arg.replace(/^--output-directory=/, '');\n   } else if (arg.startsWith('--apilinks=')) {\n-    apilinks = JSON.parse(\n-      fs.readFileSync(arg.replace(/^--apilinks=/, ''), 'utf8')\n-    );\n+    const linkFile = arg.replace(/^--apilinks=/, '');\n+    const data = fs.readFileSync(linkFile, 'utf8');\n+    if (!data.trim()) {\n+      throw new Error(`${linkFile} is empty`);\n+    }\n+    apilinks = JSON.parse(data);\n   }\n });\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 25,
        "deletions": 17
    }
}