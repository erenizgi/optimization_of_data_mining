{
    "author": "addaleax",
    "message": "src: make handle onclose property a Symbol\n\nThis makes the property “more” hidden when exposing a `HandleWrap`\nas public API, e.g. for upcoming `MessagePort`s.\n\nPR-URL: https://github.com/nodejs/node/pull/20876\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "2e886e9f452e95a4761a3d85540ba561538b4438",
    "files": [
        {
            "sha": "5763b17aa08bc410707124d00d06126a0df90b35",
            "filename": "src/async_wrap-inl.h",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fasync_wrap-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fasync_wrap-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap-inl.h?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -65,6 +65,22 @@ inline v8::MaybeLocal<v8::Value> AsyncWrap::MakeCallback(\n     const v8::Local<v8::String> symbol,\n     int argc,\n     v8::Local<v8::Value>* argv) {\n+  return MakeCallback(symbol.As<v8::Name>(), argc, argv);\n+}\n+\n+\n+inline v8::MaybeLocal<v8::Value> AsyncWrap::MakeCallback(\n+    const v8::Local<v8::Symbol> symbol,\n+    int argc,\n+    v8::Local<v8::Value>* argv) {\n+  return MakeCallback(symbol.As<v8::Name>(), argc, argv);\n+}\n+\n+\n+inline v8::MaybeLocal<v8::Value> AsyncWrap::MakeCallback(\n+    const v8::Local<v8::Name> symbol,\n+    int argc,\n+    v8::Local<v8::Value>* argv) {\n   v8::Local<v8::Value> cb_v = object()->Get(symbol);\n   CHECK(cb_v->IsFunction());\n   return MakeCallback(cb_v.As<v8::Function>(), argc, argv);"
        },
        {
            "sha": "377702a8d6ef9c82bdfe69d9632ca78a21a3ee93",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -158,10 +158,18 @@ class AsyncWrap : public BaseObject {\n   v8::MaybeLocal<v8::Value> MakeCallback(const v8::Local<v8::Function> cb,\n                                          int argc,\n                                          v8::Local<v8::Value>* argv);\n+  inline v8::MaybeLocal<v8::Value> MakeCallback(\n+      const v8::Local<v8::Symbol> symbol,\n+      int argc,\n+      v8::Local<v8::Value>* argv);\n   inline v8::MaybeLocal<v8::Value> MakeCallback(\n       const v8::Local<v8::String> symbol,\n       int argc,\n       v8::Local<v8::Value>* argv);\n+  inline v8::MaybeLocal<v8::Value> MakeCallback(\n+      const v8::Local<v8::Name> symbol,\n+      int argc,\n+      v8::Local<v8::Value>* argv);\n   inline v8::MaybeLocal<v8::Value> MakeCallback(uint32_t index,\n                                                 int argc,\n                                                 v8::Local<v8::Value>* argv);"
        },
        {
            "sha": "35c7c4dc696ebd6b44ae4573afc0211a5aa350fe",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -17,6 +17,7 @@ using v8::Object;\n using v8::Promise;\n using v8::PromiseRejectEvent;\n using v8::PromiseRejectMessage;\n+using v8::String;\n using v8::Value;\n \n void SetupProcessObject(const FunctionCallbackInfo<Value>& args) {\n@@ -121,7 +122,7 @@ void SetupBootstrapObject(Environment* env,\n   BOOTSTRAP_METHOD(_setgroups, SetGroups);\n #endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n \n-  auto should_abort_on_uncaught_toggle =\n+  Local<String> should_abort_on_uncaught_toggle =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"_shouldAbortOnUncaughtToggle\");\n   CHECK(bootstrapper->Set(env->context(),\n                        should_abort_on_uncaught_toggle,\n@@ -130,4 +131,21 @@ void SetupBootstrapObject(Environment* env,\n }\n #undef BOOTSTRAP_METHOD\n \n+namespace symbols {\n+\n+void Initialize(Local<Object> target,\n+                Local<Value> unused,\n+                Local<Context> context) {\n+  Environment* env = Environment::GetCurrent(context);\n+#define V(PropertyName, StringValue)                                        \\\n+    target->Set(env->context(),                                             \\\n+               env->PropertyName()->Name(),                                 \\\n+               env->PropertyName()).FromJust();\n+  PER_ISOLATE_SYMBOL_PROPERTIES(V)\n+#undef V\n+}\n+\n+}  // namespace symbols\n }  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(symbols, node::symbols::Initialize)"
        },
        {
            "sha": "aadb81271cf5d41c809c0010f8869c3fb32ed692",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -706,6 +706,7 @@ bool Environment::CleanupHookCallback::Equal::operator()(\n }\n \n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n+#define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n #define V(TypeName, PropertyName)                                             \\\n   inline                                                                      \\\n@@ -714,21 +715,26 @@ bool Environment::CleanupHookCallback::Equal::operator()(\n     return const_cast<IsolateData*>(this)->PropertyName ## _.Get(isolate);    \\\n   }\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(VP)\n+  PER_ISOLATE_SYMBOL_PROPERTIES(VY)\n   PER_ISOLATE_STRING_PROPERTIES(VS)\n #undef V\n #undef VS\n+#undef VY\n #undef VP\n \n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n+#define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n #define V(TypeName, PropertyName)                                             \\\n   inline v8::Local<TypeName> Environment::PropertyName() const {              \\\n     return isolate_data()->PropertyName(isolate());                           \\\n   }\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(VP)\n+  PER_ISOLATE_SYMBOL_PROPERTIES(VY)\n   PER_ISOLATE_STRING_PROPERTIES(VS)\n #undef V\n #undef VS\n+#undef VY\n #undef VP\n \n #define V(PropertyName, TypeName)                                             \\"
        },
        {
            "sha": "cb514828d2cdc427f6a262785301b1880103a670",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -23,6 +23,7 @@ using v8::Private;\n using v8::StackFrame;\n using v8::StackTrace;\n using v8::String;\n+using v8::Symbol;\n using v8::Value;\n \n IsolateData::IsolateData(Isolate* isolate,\n@@ -59,6 +60,18 @@ IsolateData::IsolateData(Isolate* isolate,\n                 sizeof(StringValue) - 1).ToLocalChecked()));\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(V)\n #undef V\n+#define V(PropertyName, StringValue)                                        \\\n+    PropertyName ## _.Set(                                                  \\\n+        isolate,                                                            \\\n+        Symbol::New(                                                        \\\n+            isolate,                                                        \\\n+            String::NewFromOneByte(                                         \\\n+                isolate,                                                    \\\n+                reinterpret_cast<const uint8_t*>(StringValue),              \\\n+                v8::NewStringType::kInternalized,                           \\\n+                sizeof(StringValue) - 1).ToLocalChecked()));\n+  PER_ISOLATE_SYMBOL_PROPERTIES(V)\n+#undef V\n #define V(PropertyName, StringValue)                                        \\\n     PropertyName ## _.Set(                                                  \\\n         isolate,                                                            \\"
        },
        {
            "sha": "7a432eaa3d4ff0491a801349f9e04f0c6311c5d1",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -107,6 +107,11 @@ struct PackageConfig {\n   V(napi_env, \"node:napi:env\")                                                \\\n   V(napi_wrapper, \"node:napi:wrapper\")                                        \\\n \n+// Symbols are per-isolate primitives but Environment proxies them\n+// for the sake of convenience.\n+#define PER_ISOLATE_SYMBOL_PROPERTIES(V)                                      \\\n+  V(handle_onclose_symbol, \"handle_onclose\")                                  \\\n+\n // Strings are per-isolate primitives but Environment proxies them\n // for the sake of convenience.  Strings should be ASCII-only.\n #define PER_ISOLATE_STRING_PROPERTIES(V)                                      \\\n@@ -127,7 +132,6 @@ struct PackageConfig {\n   V(chunks_sent_since_last_write_string, \"chunksSentSinceLastWrite\")          \\\n   V(constants_string, \"constants\")                                            \\\n   V(oncertcb_string, \"oncertcb\")                                              \\\n-  V(onclose_string, \"_onclose\")                                               \\\n   V(code_string, \"code\")                                                      \\\n   V(cwd_string, \"cwd\")                                                        \\\n   V(dest_string, \"dest\")                                                      \\\n@@ -356,10 +360,12 @@ class IsolateData {\n   inline MultiIsolatePlatform* platform() const;\n \n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n+#define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n #define V(TypeName, PropertyName)                                             \\\n   inline v8::Local<TypeName> PropertyName(v8::Isolate* isolate) const;\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(VP)\n+  PER_ISOLATE_SYMBOL_PROPERTIES(VY)\n   PER_ISOLATE_STRING_PROPERTIES(VS)\n #undef V\n #undef VS\n@@ -370,10 +376,12 @@ class IsolateData {\n \n  private:\n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n+#define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n #define V(TypeName, PropertyName)                                             \\\n   v8::Eternal<TypeName> PropertyName ## _;\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(VP)\n+  PER_ISOLATE_SYMBOL_PROPERTIES(VY)\n   PER_ISOLATE_STRING_PROPERTIES(VS)\n #undef V\n #undef VS\n@@ -737,13 +745,16 @@ class Environment {\n   // Strings and private symbols are shared across shared contexts\n   // The getters simply proxy to the per-isolate primitive.\n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n+#define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)\n #define VS(PropertyName, StringValue) V(v8::String, PropertyName)\n #define V(TypeName, PropertyName)                                             \\\n   inline v8::Local<TypeName> PropertyName() const;\n   PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(VP)\n+  PER_ISOLATE_SYMBOL_PROPERTIES(VY)\n   PER_ISOLATE_STRING_PROPERTIES(VS)\n #undef V\n #undef VS\n+#undef VY\n #undef VP\n \n #define V(PropertyName, TypeName)                                             \\"
        },
        {
            "sha": "4c2a33aa84459d4d56188d131580f3969123ca1a",
            "filename": "src/handle_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fhandle_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fhandle_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.cc?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -76,7 +76,9 @@ void HandleWrap::Close(Local<Value> close_callback) {\n   state_ = kClosing;\n \n   if (!close_callback.IsEmpty() && close_callback->IsFunction()) {\n-    object()->Set(env()->context(), env()->onclose_string(), close_callback)\n+    object()->Set(env()->context(),\n+                  env()->handle_onclose_symbol(),\n+                  close_callback)\n         .FromMaybe(false);\n   }\n }\n@@ -121,9 +123,9 @@ void HandleWrap::OnClose(uv_handle_t* handle) {\n \n   wrap->OnClose();\n \n-  if (wrap->object()->Has(env->context(), env->onclose_string())\n+  if (wrap->object()->Has(env->context(), env->handle_onclose_symbol())\n       .FromMaybe(false)) {\n-    wrap->MakeCallback(env->onclose_string(), 0, nullptr);\n+    wrap->MakeCallback(env->handle_onclose_symbol(), 0, nullptr);\n   }\n }\n "
        },
        {
            "sha": "7bf4eaf1ecf86aab37177c0676600cea0e64aace",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/2e886e9f452e95a4761a3d85540ba561538b4438/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=2e886e9f452e95a4761a3d85540ba561538b4438",
            "patch": "@@ -125,6 +125,7 @@ struct sockaddr;\n     V(stream_pipe)                                                            \\\n     V(stream_wrap)                                                            \\\n     V(string_decoder)                                                         \\\n+    V(symbols)                                                                \\\n     V(tcp_wrap)                                                               \\\n     V(timer_wrap)                                                             \\\n     V(trace_events)                                                           \\"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 80,
        "deletions": 5
    }
}