{
    "author": "sameer-coder",
    "message": "cluster: add support for NODE_OPTIONS=\"--inspect\"\n\nWhen using cluster and --inspect as cli argument it is correctly\nhandled and each worker will use a different port, this was\nfixed by #13619. But when env var NODE_OPTIONS=\"--inspect\"\nis set this logic doesn't apply and the workers will fail as they\ntry to attach to the same port.\n\nFixes: https://github.com/nodejs/node/issues/19026\n\nPR-URL: https://github.com/nodejs/node/pull/19165\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "9b34ea6161a637d6be7a68b816df8f8479d7c4ee",
    "files": [
        {
            "sha": "8e4f9395da6643b6bdf07019fbdad8cd5a1dbb8d",
            "filename": "lib/internal/cluster/master.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/9b34ea6161a637d6be7a68b816df8f8479d7c4ee/lib%2Finternal%2Fcluster%2Fmaster.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b34ea6161a637d6be7a68b816df8f8479d7c4ee/lib%2Finternal%2Fcluster%2Fmaster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcluster%2Fmaster.js?ref=9b34ea6161a637d6be7a68b816df8f8479d7c4ee",
            "patch": "@@ -103,11 +103,14 @@ function createWorkerProcess(id, env) {\n   const workerEnv = util._extend({}, process.env);\n   const execArgv = cluster.settings.execArgv.slice();\n   const debugArgRegex = /--inspect(?:-brk|-port)?|--debug-port/;\n+  const nodeOptions = process.env.NODE_OPTIONS ?\n+    process.env.NODE_OPTIONS : '';\n \n   util._extend(workerEnv, env);\n   workerEnv.NODE_UNIQUE_ID = '' + id;\n \n-  if (execArgv.some((arg) => arg.match(debugArgRegex))) {\n+  if (execArgv.some((arg) => arg.match(debugArgRegex)) ||\n+      nodeOptions.match(debugArgRegex)) {\n     let inspectPort;\n     if ('inspectPort' in cluster.settings) {\n       if (typeof cluster.settings.inspectPort === 'function')"
        },
        {
            "sha": "05c7ec24b90d30afeefc9da955d044cc388e5e2c",
            "filename": "test/parallel/test-inspect-support-for-node_options.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/9b34ea6161a637d6be7a68b816df8f8479d7c4ee/test%2Fparallel%2Ftest-inspect-support-for-node_options.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b34ea6161a637d6be7a68b816df8f8479d7c4ee/test%2Fparallel%2Ftest-inspect-support-for-node_options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspect-support-for-node_options.js?ref=9b34ea6161a637d6be7a68b816df8f8479d7c4ee",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+const common = require('../common');\n+const cluster = require('cluster');\n+const assert = require('assert');\n+\n+common.skipIfInspectorDisabled();\n+\n+checkForInspectSupport('--inspect');\n+\n+function checkForInspectSupport(flag) {\n+\n+  const nodeOptions = JSON.stringify(flag);\n+  const numWorkers = 2;\n+  process.env.NODE_OPTIONS = flag;\n+\n+  if (cluster.isMaster) {\n+    for (let i = 0; i < numWorkers; i++) {\n+      cluster.fork();\n+    }\n+\n+    cluster.on('online', (worker) => {\n+      worker.disconnect();\n+    });\n+\n+    cluster.on('exit', common.mustCall((worker, code, signal) => {\n+      const errMsg = `For NODE_OPTIONS ${nodeOptions}, failed to start cluster`;\n+      assert.strictEqual(worker.exitedAfterDisconnect, true, errMsg);\n+    }, numWorkers));\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 34,
        "deletions": 1
    }
}