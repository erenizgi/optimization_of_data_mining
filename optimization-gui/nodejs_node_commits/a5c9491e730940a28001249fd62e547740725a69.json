{
    "author": "Trott",
    "message": "test: fix test-tls-securepair-client\n\ntest-tls-securepair-client has been failing for over a year but no one\nnoticed because pummel tests are almost never run.\n\nIn preparation for running pummel tests once a day in CI, fix\ntest-tls-securepair-client.\n\nPR-URL: https://github.com/nodejs/node/pull/25222\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a5c9491e730940a28001249fd62e547740725a69",
    "files": [
        {
            "sha": "eec65af8a101ed97013157edd93346a869ba63e3",
            "filename": "test/pummel/test-tls-securepair-client.js",
            "status": "modified",
            "additions": 14,
            "deletions": 11,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/a5c9491e730940a28001249fd62e547740725a69/test%2Fpummel%2Ftest-tls-securepair-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/a5c9491e730940a28001249fd62e547740725a69/test%2Fpummel%2Ftest-tls-securepair-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpummel%2Ftest-tls-securepair-client.js?ref=a5c9491e730940a28001249fd62e547740725a69",
            "patch": "@@ -29,6 +29,9 @@ if (!common.opensslCli)\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+if (common.isWindows)\n+  common.skip('test does not work on Windows'); // ...but it should!\n+\n const net = require('net');\n const assert = require('assert');\n const fixtures = require('../common/fixtures');\n@@ -54,14 +57,14 @@ function test2() {\n   test('keys/agent4-key.pem', 'keys/agent4-cert.pem', check);\n }\n \n-function test(keyfn, certfn, check, next) {\n-  const key = fixtures.readSync(keyfn).toString();\n-  const cert = fixtures.readSync(certfn).toString();\n+function test(keyPath, certPath, check, next) {\n+  const key = fixtures.readSync(keyPath).toString();\n+  const cert = fixtures.readSync(certPath).toString();\n \n   const server = spawn(common.opensslCli, ['s_server',\n                                            '-accept', common.PORT,\n-                                           '-cert', certfn,\n-                                           '-key', keyfn]);\n+                                           '-cert', fixtures.path(certPath),\n+                                           '-key', fixtures.path(keyPath)]);\n   server.stdout.pipe(process.stdout);\n   server.stderr.pipe(process.stdout);\n \n@@ -72,7 +75,7 @@ function test(keyfn, certfn, check, next) {\n   server.stdout.setEncoding('utf8');\n   server.stdout.on('data', function(s) {\n     serverStdoutBuffer += s;\n-    console.error(state);\n+    console.log(state);\n     switch (state) {\n       case 'WAIT-ACCEPT':\n         if (/ACCEPT/.test(serverStdoutBuffer)) {\n@@ -132,6 +135,11 @@ function test(keyfn, certfn, check, next) {\n \n     s.on('connect', function() {\n       console.log('client connected');\n+      setTimeout(function() {\n+        pair.cleartext.write('hello\\r\\n', function() {\n+          gotWriteCallback = true;\n+        });\n+      }, 500);\n     });\n \n     pair.on('secure', function() {\n@@ -141,11 +149,6 @@ function test(keyfn, certfn, check, next) {\n       console.log('client pair.cleartext.getCipher(): %j',\n                   pair.cleartext.getCipher());\n       if (check) check(pair);\n-      setTimeout(function() {\n-        pair.cleartext.write('hello\\r\\n', function() {\n-          gotWriteCallback = true;\n-        });\n-      }, 500);\n     });\n \n     pair.cleartext.on('data', function(d) {"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 14,
        "deletions": 11
    }
}