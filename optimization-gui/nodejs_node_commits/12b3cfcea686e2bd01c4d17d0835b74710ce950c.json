{
    "author": "cjihrig",
    "message": "process: stub unsupported worker methods\n\nSome process methods are not supported in workers. This commit\nadds stubs that throw more informative errors.\n\nPR-URL: https://github.com/nodejs/node/pull/25587\nFixes: https://github.com/nodejs/node/issues/25448\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "12b3cfcea686e2bd01c4d17d0835b74710ce950c",
    "files": [
        {
            "sha": "071b68903d56d0394780bf2d0d9276fcad7947c2",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -84,6 +84,8 @@ if (isMainThread) {\n } else {\n   const wrapped = workerThreadSetup.wrapProcessMethods(rawMethods);\n \n+  process.abort = workerThreadSetup.unavailable('process.abort()');\n+  process.chdir = workerThreadSetup.unavailable('process.chdir()');\n   process.umask = wrapped.umask;\n }\n \n@@ -148,6 +150,14 @@ if (credentials.implementsPosixCredentials) {\n     process.seteuid = wrapped.seteuid;\n     process.setgid = wrapped.setgid;\n     process.setuid = wrapped.setuid;\n+  } else {\n+    process.initgroups =\n+      workerThreadSetup.unavailable('process.initgroups()');\n+    process.setgroups = workerThreadSetup.unavailable('process.setgroups()');\n+    process.setegid = workerThreadSetup.unavailable('process.setegid()');\n+    process.seteuid = workerThreadSetup.unavailable('process.seteuid()');\n+    process.setgid = workerThreadSetup.unavailable('process.setgid()');\n+    process.setuid = workerThreadSetup.unavailable('process.setuid()');\n   }\n }\n \n@@ -174,8 +184,24 @@ if (config.hasInspector) {\n // This attaches some internal event listeners and creates:\n // process.send(), process.channel, process.connected,\n // process.disconnect()\n-if (isMainThread && process.env.NODE_CHANNEL_FD) {\n-  mainThreadSetup.setupChildProcessIpcChannel();\n+if (process.env.NODE_CHANNEL_FD) {\n+  if (ownsProcessState) {\n+    mainThreadSetup.setupChildProcessIpcChannel();\n+  } else {\n+    Object.defineProperty(process, 'channel', {\n+      enumerable: false,\n+      get: workerThreadSetup.unavailable('process.channel')\n+    });\n+\n+    Object.defineProperty(process, 'connected', {\n+      enumerable: false,\n+      get: workerThreadSetup.unavailable('process.connected')\n+    });\n+\n+    process.send = workerThreadSetup.unavailable('process.send()');\n+    process.disconnect =\n+      workerThreadSetup.unavailable('process.disconnect()');\n+  }\n }\n \n const browserGlobals = !process._noBrowserGlobals;"
        },
        {
            "sha": "2cc52cbf01b8cd6f6bbb720d18fe7c8149e39e24",
            "filename": "lib/internal/process/worker_thread_only.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fworker_thread_only.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -45,7 +45,17 @@ function wrapProcessMethods(binding) {\n   return { umask };\n }\n \n+function unavailable(name) {\n+  function unavailableInWorker() {\n+    throw new ERR_WORKER_UNSUPPORTED_OPERATION(name);\n+  }\n+\n+  unavailableInWorker.disabled = true;\n+  return unavailableInWorker;\n+}\n+\n module.exports = {\n   initializeWorkerStdio,\n+  unavailable,\n   wrapProcessMethods\n };"
        },
        {
            "sha": "b9e0630dab5ecaf82590b034b6d08ec5c4e1e445",
            "filename": "test/parallel/test-process-euid-egid.js",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-euid-egid.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-euid-egid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-euid-egid.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -3,16 +3,17 @@\n const common = require('../common');\n const assert = require('assert');\n \n-if (common.isWindows || !common.isMainThread) {\n-  if (common.isMainThread) {\n-    assert.strictEqual(process.geteuid, undefined);\n-    assert.strictEqual(process.getegid, undefined);\n-  }\n+if (common.isWindows) {\n+  assert.strictEqual(process.geteuid, undefined);\n+  assert.strictEqual(process.getegid, undefined);\n   assert.strictEqual(process.seteuid, undefined);\n   assert.strictEqual(process.setegid, undefined);\n   return;\n }\n \n+if (!common.isMainThread)\n+  return;\n+\n assert.throws(() => {\n   process.seteuid({});\n }, {"
        },
        {
            "sha": "f5e839b1d242afbf40824f31393264a83430e6f0",
            "filename": "test/parallel/test-process-initgroups.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-initgroups.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-initgroups.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-initgroups.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -2,11 +2,14 @@\n const common = require('../common');\n const assert = require('assert');\n \n-if (common.isWindows || !common.isMainThread) {\n+if (common.isWindows) {\n   assert.strictEqual(process.initgroups, undefined);\n   return;\n }\n \n+if (!common.isMainThread)\n+  return;\n+\n [undefined, null, true, {}, [], () => {}].forEach((val) => {\n   assert.throws(\n     () => {"
        },
        {
            "sha": "74de3e7a2562e726f32ac728b999e18cd5632628",
            "filename": "test/parallel/test-process-setgroups.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-setgroups.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-setgroups.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-setgroups.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -2,11 +2,14 @@\n const common = require('../common');\n const assert = require('assert');\n \n-if (common.isWindows || !common.isMainThread) {\n+if (common.isWindows) {\n   assert.strictEqual(process.setgroups, undefined);\n   return;\n }\n \n+if (!common.isMainThread)\n+  return;\n+\n assert.throws(\n   () => {\n     process.setgroups();"
        },
        {
            "sha": "49086792b9e7b15818c77bb13b38c0e7fa5d91bf",
            "filename": "test/parallel/test-process-uid-gid.js",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-uid-gid.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-process-uid-gid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-uid-gid.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -24,17 +24,18 @@ const common = require('../common');\n \n const assert = require('assert');\n \n-if (common.isWindows || !common.isMainThread) {\n-  // uid/gid functions are POSIX only, setters are main-thread only.\n-  if (common.isMainThread) {\n-    assert.strictEqual(process.getuid, undefined);\n-    assert.strictEqual(process.getgid, undefined);\n-  }\n+if (common.isWindows) {\n+  // uid/gid functions are POSIX only.\n+  assert.strictEqual(process.getuid, undefined);\n+  assert.strictEqual(process.getgid, undefined);\n   assert.strictEqual(process.setuid, undefined);\n   assert.strictEqual(process.setgid, undefined);\n   return;\n }\n \n+if (!common.isMainThread)\n+  return;\n+\n assert.throws(() => {\n   process.setuid({});\n }, {"
        },
        {
            "sha": "cc9eec4af677602708ee5a35da60198a3fa5cc6f",
            "filename": "test/parallel/test-worker-unsupported-things.js",
            "status": "modified",
            "additions": 24,
            "deletions": 10,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-worker-unsupported-things.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b3cfcea686e2bd01c4d17d0835b74710ce950c/test%2Fparallel%2Ftest-worker-unsupported-things.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-unsupported-things.js?ref=12b3cfcea686e2bd01c4d17d0835b74710ce950c",
            "patch": "@@ -1,9 +1,12 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-const { Worker, isMainThread, parentPort } = require('worker_threads');\n+const { Worker, parentPort } = require('worker_threads');\n \n-if (isMainThread) {\n+// Do not use isMainThread so that this test itself can be run inside a Worker.\n+if (!process.env.HAS_STARTED_WORKER) {\n+  process.env.HAS_STARTED_WORKER = 1;\n+  process.env.NODE_CHANNEL_FD = 'foo'; // Make worker think it has IPC.\n   const w = new Worker(__filename);\n   w.on('message', common.mustCall((message) => {\n     assert.strictEqual(message, true);\n@@ -21,14 +24,25 @@ if (isMainThread) {\n     assert.strictEqual(process.debugPort, before);\n   }\n \n-  assert.strictEqual('abort' in process, false);\n-  assert.strictEqual('chdir' in process, false);\n-  assert.strictEqual('setuid' in process, false);\n-  assert.strictEqual('seteuid' in process, false);\n-  assert.strictEqual('setgid' in process, false);\n-  assert.strictEqual('setegid' in process, false);\n-  assert.strictEqual('setgroups' in process, false);\n-  assert.strictEqual('initgroups' in process, false);\n+  const stubs = ['abort', 'chdir', 'send', 'disconnect'];\n+\n+  if (!common.isWindows) {\n+    stubs.push('setuid', 'seteuid', 'setgid',\n+               'setegid', 'setgroups', 'initgroups');\n+  }\n+\n+  stubs.forEach((fn) => {\n+    assert.strictEqual(process[fn].disabled, true);\n+    assert.throws(() => {\n+      process[fn]();\n+    }, { code: 'ERR_WORKER_UNSUPPORTED_OPERATION' });\n+  });\n+\n+  ['channel', 'connected'].forEach((fn) => {\n+    assert.throws(() => {\n+      process[fn];\n+    }, { code: 'ERR_WORKER_UNSUPPORTED_OPERATION' });\n+  });\n \n   assert.strictEqual('_startProfilerIdleNotifier' in process, false);\n   assert.strictEqual('_stopProfilerIdleNotifier' in process, false);"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 83,
        "deletions": 25
    }
}