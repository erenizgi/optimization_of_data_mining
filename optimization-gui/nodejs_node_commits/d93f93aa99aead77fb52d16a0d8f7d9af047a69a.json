{
    "author": "addaleax",
    "message": "dns: fix TTL value for AAAA replies to `resolveAny()`\n\nWe were previously reading from the wrong offset, namely\nthe one into the final results array, not the one for the\nAAAA results itself, which could have lead to reading\nuninitialized or out-of-bounds data.\n\nAlso, adjust the test accordingly; TTL values are not\nmodified by c-ares, but are only exposed for a subset\nof all DNS record types.\n\nPR-URL: https://github.com/nodejs/node/pull/25187\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "d93f93aa99aead77fb52d16a0d8f7d9af047a69a",
    "files": [
        {
            "sha": "9d7af47dcdbbaf794d2e109d56a68dc193002311",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d93f93aa99aead77fb52d16a0d8f7d9af047a69a/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d93f93aa99aead77fb52d16a0d8f7d9af047a69a/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=d93f93aa99aead77fb52d16a0d8f7d9af047a69a",
            "patch": "@@ -1265,14 +1265,16 @@ class QueryAnyWrap: public QueryWrap {\n     }\n \n     CHECK_EQ(aaaa_count, naddr6ttls);\n+    CHECK_EQ(ret->Length(), a_count + aaaa_count);\n     for (uint32_t i = a_count; i < ret->Length(); i++) {\n       Local<Object> obj = Object::New(env()->isolate());\n       obj->Set(context,\n                env()->address_string(),\n                ret->Get(context, i).ToLocalChecked()).FromJust();\n       obj->Set(context,\n                env()->ttl_string(),\n-               Integer::New(env()->isolate(), addr6ttls[i].ttl)).FromJust();\n+               Integer::New(env()->isolate(), addr6ttls[i - a_count].ttl))\n+          .FromJust();\n       obj->Set(context,\n                env()->type_string(),\n                env()->dns_aaaa_string()).FromJust();"
        },
        {
            "sha": "bb15b1a38b4ad3f130c0de3ae693422867dbac84",
            "filename": "test/parallel/test-dns-resolveany.js",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/d93f93aa99aead77fb52d16a0d8f7d9af047a69a/test%2Fparallel%2Ftest-dns-resolveany.js",
            "raw_url": "https://github.com/nodejs/node/raw/d93f93aa99aead77fb52d16a0d8f7d9af047a69a/test%2Fparallel%2Ftest-dns-resolveany.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-dns-resolveany.js?ref=d93f93aa99aead77fb52d16a0d8f7d9af047a69a",
            "patch": "@@ -53,8 +53,13 @@ server.bind(0, common.mustCall(async () => {\n }));\n \n function validateResults(res) {\n-  // Compare copies with ttl removed, c-ares fiddles with that value.\n-  assert.deepStrictEqual(\n-    res.map((r) => Object.assign({}, r, { ttl: null })),\n-    answers.map((r) => Object.assign({}, r, { ttl: null })));\n+  // TTL values are only provided for A and AAAA entries.\n+  assert.deepStrictEqual(res.map(maybeRedactTTL), answers.map(maybeRedactTTL));\n+}\n+\n+function maybeRedactTTL(r) {\n+  const ret = { ...r };\n+  if (!['A', 'AAAA'].includes(r.type))\n+    delete ret.ttl;\n+  return ret;\n }"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 12,
        "deletions": 5
    }
}