{
    "author": "lpinca",
    "message": "stream: make virtual methods errors consistent\n\nUse the same error code and always emit the error instead of\nthrowing it.\n\nPR-URL: https://github.com/nodejs/node/pull/18813\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: MichaÃ« Zasso <targos@protonmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
    "files": [
        {
            "sha": "9cb9c29b3651e242d50104e6c01c990061b7a9ea",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -616,7 +616,7 @@ OutgoingMessage.prototype.removeHeader = function removeHeader(name) {\n \n \n OutgoingMessage.prototype._implicitHeader = function _implicitHeader() {\n-  throw new ERR_METHOD_NOT_IMPLEMENTED('_implicitHeader()');\n+  this.emit('error', new ERR_METHOD_NOT_IMPLEMENTED('_implicitHeader()'));\n };\n \n Object.defineProperty(OutgoingMessage.prototype, 'headersSent', {"
        },
        {
            "sha": "9d475ab6eaa67346a538c31c3943cf0d761ea3c1",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -35,7 +35,7 @@ const { getHighWaterMark } = require('internal/streams/state');\n const {\n   ERR_INVALID_ARG_TYPE,\n   ERR_STREAM_PUSH_AFTER_EOF,\n-  ERR_STREAM_READ_NOT_IMPLEMENTED,\n+  ERR_METHOD_NOT_IMPLEMENTED,\n   ERR_STREAM_UNSHIFT_AFTER_END_EVENT\n } = require('internal/errors').codes;\n const ReadableAsyncIterator = require('internal/streams/async_iterator');\n@@ -568,7 +568,7 @@ function maybeReadMore_(stream, state) {\n // for virtual (non-string, non-buffer) streams, \"length\" is somewhat\n // arbitrary, and perhaps not very meaningful.\n Readable.prototype._read = function(n) {\n-  this.emit('error', new ERR_STREAM_READ_NOT_IMPLEMENTED());\n+  this.emit('error', new ERR_METHOD_NOT_IMPLEMENTED('_read()'));\n };\n \n Readable.prototype.pipe = function(dest, pipeOpts) {"
        },
        {
            "sha": "679f79b80dfb354f094fa2f901f8b2ba3545a75d",
            "filename": "lib/_stream_transform.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_transform.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_transform.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_transform.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -162,7 +162,7 @@ Transform.prototype.push = function(chunk, encoding) {\n // an error, then that'll put the hurt on the whole operation.  If you\n // never call cb(), then you'll never get another chunk.\n Transform.prototype._transform = function(chunk, encoding, cb) {\n-  throw new ERR_METHOD_NOT_IMPLEMENTED('_transform');\n+  cb(new ERR_METHOD_NOT_IMPLEMENTED('_transform()'));\n };\n \n Transform.prototype._write = function(chunk, encoding, cb) {"
        },
        {
            "sha": "5f9bf79ae41a26f12d28fb932e0011cdb847d89e",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -553,7 +553,7 @@ function clearBuffer(stream, state) {\n }\n \n Writable.prototype._write = function(chunk, encoding, cb) {\n-  cb(new ERR_METHOD_NOT_IMPLEMENTED('_write'));\n+  cb(new ERR_METHOD_NOT_IMPLEMENTED('_write()'));\n };\n \n Writable.prototype._writev = null;"
        },
        {
            "sha": "8ec72dd647b1b2c6d7d11782ece7dbaa718e57dc",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -849,7 +849,6 @@ E('ERR_STREAM_CANNOT_PIPE', 'Cannot pipe, not readable', Error);\n E('ERR_STREAM_DESTROYED', 'Cannot call %s after a stream was destroyed', Error);\n E('ERR_STREAM_NULL_VALUES', 'May not write null values to stream', TypeError);\n E('ERR_STREAM_PUSH_AFTER_EOF', 'stream.push() after EOF', Error);\n-E('ERR_STREAM_READ_NOT_IMPLEMENTED', '_read() is not implemented', Error);\n E('ERR_STREAM_UNSHIFT_AFTER_END_EVENT',\n   'stream.unshift() after end event', Error);\n E('ERR_STREAM_WRAP', 'Stream has StringDecoder set or is in objectMode', Error);"
        },
        {
            "sha": "f223bc5b9dc18044abded430c27a892642aef0b5",
            "filename": "test/parallel/test-http-outgoing-proto.js",
            "status": "modified",
            "additions": 10,
            "deletions": 15,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-http-outgoing-proto.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-http-outgoing-proto.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-outgoing-proto.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -7,14 +7,6 @@ const OutgoingMessage = http.OutgoingMessage;\n const ClientRequest = http.ClientRequest;\n const ServerResponse = http.ServerResponse;\n \n-common.expectsError(\n-  OutgoingMessage.prototype._implicitHeader,\n-  {\n-    code: 'ERR_METHOD_NOT_IMPLEMENTED',\n-    type: Error,\n-    message: 'The _implicitHeader() method is not implemented'\n-  }\n-);\n assert.strictEqual(\n   typeof ClientRequest.prototype._implicitHeader, 'function');\n assert.strictEqual(\n@@ -67,14 +59,17 @@ common.expectsError(() => {\n });\n \n // write\n-common.expectsError(() => {\n+{\n   const outgoingMessage = new OutgoingMessage();\n-  outgoingMessage.write();\n-}, {\n-  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n-  type: Error,\n-  message: 'The _implicitHeader() method is not implemented'\n-});\n+\n+  outgoingMessage.on('error', common.expectsError({\n+    code: 'ERR_METHOD_NOT_IMPLEMENTED',\n+    type: Error,\n+    message: 'The _implicitHeader() method is not implemented'\n+  }));\n+\n+  outgoingMessage.write('');\n+}\n \n assert(OutgoingMessage.prototype.write.call({ _header: 'test' }));\n "
        },
        {
            "sha": "973899b7a7844e2afe08b7335ea5af872c87f5ac",
            "filename": "test/parallel/test-stream-readable-with-unimplemented-_read.js",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-readable-with-unimplemented-_read.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-readable-with-unimplemented-_read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-with-unimplemented-_read.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -1,11 +1,14 @@\n 'use strict';\n const common = require('../common');\n-const stream = require('stream');\n \n-const readable = new stream.Readable();\n+const { Readable } = require('stream');\n \n-common.expectsError(() => readable.read(), {\n-  code: 'ERR_STREAM_READ_NOT_IMPLEMENTED',\n+const readable = new Readable();\n+\n+readable.on('error', common.expectsError({\n+  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n   type: Error,\n-  message: '_read() is not implemented'\n-});\n+  message: 'The _read() method is not implemented'\n+}));\n+\n+readable.read();"
        },
        {
            "sha": "d599e768386515df4fff07c78ca6143dec820970",
            "filename": "test/parallel/test-stream-transform-constructor-set-methods.js",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-transform-constructor-set-methods.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-transform-constructor-set-methods.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-transform-constructor-set-methods.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -4,6 +4,16 @@ const common = require('../common');\n const { strictEqual } = require('assert');\n const { Transform } = require('stream');\n \n+const t = new Transform();\n+\n+t.on('error', common.expectsError({\n+  type: Error,\n+  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n+  message: 'The _transform() method is not implemented'\n+}));\n+\n+t.end(Buffer.from('blerg'));\n+\n const _transform = common.mustCall((chunk, _, next) => {\n   next();\n });\n@@ -16,25 +26,15 @@ const _flush = common.mustCall((next) => {\n   next();\n });\n \n-const t = new Transform({\n+const t2 = new Transform({\n   transform: _transform,\n   flush: _flush,\n   final: _final\n });\n \n-strictEqual(t._transform, _transform);\n-strictEqual(t._flush, _flush);\n-strictEqual(t._final, _final);\n+strictEqual(t2._transform, _transform);\n+strictEqual(t2._flush, _flush);\n+strictEqual(t2._final, _final);\n \n-t.end(Buffer.from('blerg'));\n-t.resume();\n-\n-const t2 = new Transform({});\n-\n-common.expectsError(() => {\n-  t2.end(Buffer.from('blerg'));\n-}, {\n-  type: Error,\n-  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n-  message: 'The _transform method is not implemented'\n-});\n+t2.end(Buffer.from('blerg'));\n+t2.resume();"
        },
        {
            "sha": "13a8dc286021f2c208ea03c61178ac69bc7af098",
            "filename": "test/parallel/test-stream-writable-constructor-set-methods.js",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-writable-constructor-set-methods.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9794880e89dbbecbbd85e4ee0980ed9c7ac0971/test%2Fparallel%2Ftest-stream-writable-constructor-set-methods.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-writable-constructor-set-methods.js?ref=c9794880e89dbbecbbd85e4ee0980ed9c7ac0971",
            "patch": "@@ -4,6 +4,16 @@ const common = require('../common');\n const { strictEqual } = require('assert');\n const { Writable } = require('stream');\n \n+const w = new Writable();\n+\n+w.on('error', common.expectsError({\n+  type: Error,\n+  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n+  message: 'The _write() method is not implemented'\n+}));\n+\n+w.end(Buffer.from('blerg'));\n+\n const _write = common.mustCall((chunk, _, next) => {\n   next();\n });\n@@ -13,25 +23,15 @@ const _writev = common.mustCall((chunks, next) => {\n   next();\n });\n \n-const w = new Writable({ write: _write, writev: _writev });\n+const w2 = new Writable({ write: _write, writev: _writev });\n \n-strictEqual(w._write, _write);\n-strictEqual(w._writev, _writev);\n+strictEqual(w2._write, _write);\n+strictEqual(w2._writev, _writev);\n \n-w.write(Buffer.from('blerg'));\n+w2.write(Buffer.from('blerg'));\n \n-w.cork();\n-w.write(Buffer.from('blerg'));\n-w.write(Buffer.from('blerg'));\n-\n-w.end();\n-\n-const w2 = new Writable();\n-\n-w2.on('error', common.expectsError({\n-  type: Error,\n-  code: 'ERR_METHOD_NOT_IMPLEMENTED',\n-  message: 'The _write method is not implemented'\n-}));\n+w2.cork();\n+w2.write(Buffer.from('blerg'));\n+w2.write(Buffer.from('blerg'));\n \n-w2.end(Buffer.from('blerg'));\n+w2.end();"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 58,
        "deletions": 61
    }
}