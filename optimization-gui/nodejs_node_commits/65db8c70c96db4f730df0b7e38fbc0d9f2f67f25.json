{
    "author": "rvagg",
    "message": "build: extract error() function in configure\n\nPR-URL: https://github.com/nodejs/node/pull/20226\nFixes: https://github.com/nodejs/node/issues/19944\nRefs: https://github.com/nodejs/node/pull/20217\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Myles Borins <myles.borins@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "65db8c70c96db4f730df0b7e38fbc0d9f2f67f25",
    "files": [
        {
            "sha": "68feee6131973c7bda507cea2b722fd4632559b4",
            "filename": "configure",
            "status": "modified",
            "additions": 32,
            "deletions": 42,
            "changes": 74,
            "blob_url": "https://github.com/nodejs/node/blob/65db8c70c96db4f730df0b7e38fbc0d9f2f67f25/configure",
            "raw_url": "https://github.com/nodejs/node/raw/65db8c70c96db4f730df0b7e38fbc0d9f2f67f25/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=65db8c70c96db4f730df0b7e38fbc0d9f2f67f25",
            "patch": "@@ -573,6 +573,11 @@ options.prefix = os.path.expanduser(options.prefix or '')\n auto_downloads = nodedownload.parse(options.download_list)\n \n \n+def error(msg):\n+  prefix = '\\033[1m\\033[31mERROR\\033[0m' if os.isatty(1) else 'ERROR'\n+  print('%s: %s' % (prefix, msg))\n+  sys.exit(1)\n+\n def warn(msg):\n   warn.warned = True\n   prefix = '\\033[1m\\033[93mWARNING\\033[0m' if os.isatty(1) else 'WARNING'\n@@ -634,13 +639,11 @@ def get_version_helper(cc, regexp):\n     proc = subprocess.Popen(shlex.split(cc) + ['-v'], stdin=subprocess.PIPE,\n                             stderr=subprocess.PIPE, stdout=subprocess.PIPE)\n   except OSError:\n-    print('''Node.js configure error: No acceptable C compiler found!\n+    error('''No acceptable C compiler found!\n \n-        Please make sure you have a C compiler installed on your system and/or\n-        consider adjusting the CC environment variable if you installed\n-        it in a non-standard prefix.\n-        ''')\n-    sys.exit()\n+       Please make sure you have a C compiler installed on your system and/or\n+       consider adjusting the CC environment variable if you installed\n+       it in a non-standard prefix.''')\n \n   match = re.search(regexp, proc.communicate()[1])\n \n@@ -656,7 +659,7 @@ def get_nasm_version(asm):\n                             stdout=subprocess.PIPE)\n   except OSError:\n     warn('''No acceptable ASM compiler found!\n-         Please make sure you have installed nasm from http://www.nasm.us\n+         Please make sure you have installed NASM from http://www.nasm.us\n          and refer BUILDING.md.''')\n     return 0\n \n@@ -684,13 +687,11 @@ def get_gas_version(cc):\n                             stdin=subprocess.PIPE, stderr=subprocess.PIPE,\n                             stdout=subprocess.PIPE)\n   except OSError:\n-    print('''Node.js configure error: No acceptable C compiler found!\n+    error('''No acceptable C compiler found!\n \n-        Please make sure you have a C compiler installed on your system and/or\n-        consider adjusting the CC environment variable if you installed\n-        it in a non-standard prefix.\n-        ''')\n-    sys.exit()\n+       Please make sure you have a C compiler installed on your system and/or\n+       consider adjusting the CC environment variable if you installed\n+       it in a non-standard prefix.''')\n \n   match = re.match(r\"GNU assembler version ([2-9]\\.[0-9]+)\",\n                    proc.communicate()[1])\n@@ -750,13 +751,11 @@ def cc_macros(cc=None):\n                          stdout=subprocess.PIPE,\n                          stderr=subprocess.PIPE)\n   except OSError:\n-    print('''Node.js configure error: No acceptable C compiler found!\n+    error('''No acceptable C compiler found!\n \n-        Please make sure you have a C compiler installed on your system and/or\n-        consider adjusting the CC environment variable if you installed\n-        it in a non-standard prefix.\n-        ''')\n-    sys.exit()\n+       Please make sure you have a C compiler installed on your system and/or\n+       consider adjusting the CC environment variable if you installed\n+       it in a non-standard prefix.''')\n \n   p.stdin.write('\\n')\n   out = p.communicate()[0]\n@@ -1108,8 +1107,7 @@ def configure_openssl(o):\n     variables['openssl_no_asm'] = 1\n \n   if options.openssl_fips:\n-     print('Error: FIPS is not supported yet in this version')\n-     exit(1)\n+     error('FIPS is not supported in this version')\n   variables['openssl_fips'] = ''\n \n   if options.without_ssl:\n@@ -1178,9 +1176,8 @@ def configure_intl(o):\n   def icu_download(path):\n     # download ICU, if needed\n     if not os.access(options.download_path, os.W_OK):\n-      print('Error: cannot write to desired download path. ' \\\n-            'Either create it or verify permissions.')\n-      sys.exit(1)\n+      error('''Cannot write to desired download path.\n+        Either create it or verify permissions.''')\n     for icu in icus:\n       url = icu['url']\n       md5 = icu['md5']\n@@ -1219,8 +1216,7 @@ def configure_intl(o):\n   with_icu_source = options.with_icu_source\n   have_icu_path = bool(options.with_icu_path)\n   if have_icu_path and with_intl != 'none':\n-    print('Error: Cannot specify both --with-icu-path and --with-intl')\n-    sys.exit(1)\n+    error('Cannot specify both --with-icu-path and --with-intl')\n   elif have_icu_path:\n     # Chromium .gyp mode: --with-icu-path\n     o['variables']['v8_enable_i18n_support'] = 1\n@@ -1248,9 +1244,8 @@ def configure_intl(o):\n     o['variables']['v8_enable_i18n_support'] = 1\n     pkgicu = pkg_config('icu-i18n')\n     if pkgicu[0] is None:\n-      print('Error: could not load pkg-config data for \"icu-i18n\".')\n-      print('See above errors or the README.md.')\n-      sys.exit(1)\n+      error('''Could not load pkg-config data for \"icu-i18n\".\n+       See above errors or the README.md.''')\n     (libs, cflags, libpath) = pkgicu\n     # libpath provides linker path which may contain spaces\n     if libpath:\n@@ -1336,10 +1331,9 @@ def configure_intl(o):\n         os.rename(tmp_icu, icu_full_path)\n         shutil.rmtree(icu_tmp_path)\n       else:\n-        print('Error: --with-icu-source=%s did not result in an \"icu\" dir.' % \\\n-               with_icu_source)\n         shutil.rmtree(icu_tmp_path)\n-        sys.exit(1)\n+        error('--with-icu-source=%s did not result in an \"icu\" dir.' % \\\n+               with_icu_source)\n \n   # ICU mode. (icu-generic.gyp)\n   o['variables']['icu_gyp_path'] = 'tools/icu/icu-generic.gyp'\n@@ -1352,17 +1346,15 @@ def configure_intl(o):\n     if localzip:\n       nodedownload.unpack(localzip, icu_parent_path)\n   if not os.path.isdir(icu_full_path):\n-    print('Cannot build Intl without ICU in %s.' % icu_full_path)\n-    print('(Fix, or disable with \"--with-intl=none\" )')\n-    sys.exit(1)\n+    error('''Cannot build Intl without ICU in %s.\n+       Fix, or disable with \"--with-intl=none\"''' % icu_full_path)\n   else:\n     print('* Using ICU in %s' % icu_full_path)\n   # Now, what version of ICU is it? We just need the \"major\", such as 54.\n   # uvernum.h contains it as a #define.\n   uvernum_h = os.path.join(icu_full_path, 'source/common/unicode/uvernum.h')\n   if not os.path.isfile(uvernum_h):\n-    print('Error: could not load %s - is ICU installed?' % uvernum_h)\n-    sys.exit(1)\n+    error('Could not load %s - is ICU installed?' % uvernum_h)\n   icu_ver_major = None\n   matchVerExp = r'^\\s*#define\\s+U_ICU_VERSION_SHORT\\s+\"([^\"]*)\".*'\n   match_version = re.compile(matchVerExp)\n@@ -1371,8 +1363,7 @@ def configure_intl(o):\n     if m:\n       icu_ver_major = m.group(1)\n   if not icu_ver_major:\n-    print('Could not read U_ICU_VERSION_SHORT version from %s' % uvernum_h)\n-    sys.exit(1)\n+    error('Could not read U_ICU_VERSION_SHORT version from %s' % uvernum_h)\n   icu_endianness = sys.byteorder[0];\n   o['variables']['icu_ver_major'] = icu_ver_major\n   o['variables']['icu_endianness'] = icu_endianness\n@@ -1396,10 +1387,9 @@ def configure_intl(o):\n   # may be little-endian if from a icu-project.org tarball\n   o['variables']['icu_data_in'] = icu_data_in\n   if not os.path.isfile(icu_data_path):\n-    print('Error: ICU prebuilt data file %s does not exist.' % icu_data_path)\n-    print('See the README.md.')\n     # .. and we're not about to build it from .gyp!\n-    sys.exit(1)\n+    error('''ICU prebuilt data file %s does not exist.\n+       See the README.md.''' % icu_data_path)\n   # map from variable name to subdirs\n   icu_src = {\n     'stubdata': 'stubdata',"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 32,
        "deletions": 42
    }
}