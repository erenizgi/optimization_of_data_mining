{
    "author": "Trott",
    "message": "test: apply promises API to fourth appendFile test\n\nAdd tests for `fs.promises.appendFile()` to the last test\ncase in `test-fs-access`. (The previous test cases already have\npromises API versions.)\n\nPR-URL: https://github.com/nodejs/node/pull/21131\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "8530b58493c1da6c7bf21b4bb59824eda45521b2",
    "files": [
        {
            "sha": "4d8f66682ed634605c24d42707ec3455fc0a0996",
            "filename": "test/parallel/test-fs-append-file.js",
            "status": "modified",
            "additions": 36,
            "deletions": 30,
            "changes": 66,
            "blob_url": "https://github.com/nodejs/node/blob/8530b58493c1da6c7bf21b4bb59824eda45521b2/test%2Fparallel%2Ftest-fs-append-file.js",
            "raw_url": "https://github.com/nodejs/node/raw/8530b58493c1da6c7bf21b4bb59824eda45521b2/test%2Fparallel%2Ftest-fs-append-file.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-append-file.js?ref=8530b58493c1da6c7bf21b4bb59824eda45521b2",
            "patch": "@@ -38,8 +38,6 @@ const s = '南越国是前203年至前111年存在于岭南地区的一个国家\n           '历经五代君主。南越国是岭南地区的第一个有记载的政权国家，采用封建制和郡县制并存的制度，' +\n           '它的建立保证了秦末乱世岭南地区社会秩序的稳定，有效的改善了岭南地区落后的政治、##济现状。\\n';\n \n-let ncallbacks = 0;\n-\n tmpdir.refresh();\n \n const throwNextTick = (e) => { process.nextTick(() => { throw e; }); };\n@@ -178,42 +176,50 @@ const throwNextTick = (e) => { process.nextTick(() => { throw e; }); };\n     .catch(throwNextTick);\n }\n \n-// test that appendFile accepts file descriptors\n-const filename5 = join(tmpdir.path, 'append5.txt');\n-fs.writeFileSync(filename5, currentFileData);\n-\n-fs.open(filename5, 'a+', function(e, fd) {\n-  assert.ifError(e);\n-\n-  ncallbacks++;\n+// test that appendFile accepts file descriptors (callback API)\n+{\n+  const filename = join(tmpdir.path, 'append-descriptors.txt');\n+  fs.writeFileSync(filename, currentFileData);\n \n-  fs.appendFile(fd, s, function(e) {\n+  fs.open(filename, 'a+', common.mustCall((e, fd) => {\n     assert.ifError(e);\n \n-    ncallbacks++;\n-\n-    fs.close(fd, function(e) {\n+    fs.appendFile(fd, s, common.mustCall((e) => {\n       assert.ifError(e);\n \n-      ncallbacks++;\n-\n-      fs.readFile(filename5, function(e, buffer) {\n+      fs.close(fd, common.mustCall((e) => {\n         assert.ifError(e);\n \n-        ncallbacks++;\n-        assert.strictEqual(Buffer.byteLength(s) + currentFileData.length,\n-                           buffer.length);\n-      });\n-    });\n-  });\n-});\n+        fs.readFile(filename, common.mustCall((e, buffer) => {\n+          assert.ifError(e);\n+          assert.strictEqual(Buffer.byteLength(s) + currentFileData.length,\n+                             buffer.length);\n+        }));\n+      }));\n+    }));\n+  }));\n+}\n+\n+// test that appendFile accepts file descriptors (promises API)\n+{\n+  const filename = join(tmpdir.path, 'append-descriptors-promises.txt');\n+  fs.writeFileSync(filename, currentFileData);\n+\n+  let fd;\n+  fs.promises.open(filename, 'a+')\n+    .then(common.mustCall((fileDescriptor) => {\n+      fd = fileDescriptor;\n+      return fs.promises.appendFile(fd, s);\n+    }))\n+    .then(common.mustCall(() => fd.close()))\n+    .then(common.mustCall(() => fs.promises.readFile(filename)))\n+    .then(common.mustCall((buffer) => {\n+      assert.strictEqual(Buffer.byteLength(s) + currentFileData.length,\n+                         buffer.length);\n+    }))\n+    .catch(throwNextTick);\n+}\n \n assert.throws(\n   () => fs.appendFile(join(tmpdir.path, 'append6.txt'), console.log),\n   { code: 'ERR_INVALID_CALLBACK' });\n-\n-process.on('exit', function() {\n-  assert.strictEqual(ncallbacks, 4);\n-\n-  fs.unlinkSync(filename5);\n-});"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 36,
        "deletions": 30
    }
}