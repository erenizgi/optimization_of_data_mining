{
    "author": "joyeecheung",
    "message": "perf_hooks: only enable GC tracking when it's requested\n\nPreviously a GC prologue callback and a GC epilogue callback\nare always unconditionally enabled during bootstrap when\nthe `performance` binding is loaded, even when the user does\nnot use the performance timeline API to enable GC tracking.\nThis patch makes the callback addition conditional and only\nenables them when the user explicitly requests\n`observer.observe(['gc'])` to avoid the overhead.\n\nPR-URL: https://github.com/nodejs/node/pull/25853\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "475c43c1b006e186036817c364dfc24a4d12c44f",
    "files": [
        {
            "sha": "583ffb56cae5e3769664397fa27c39ce0c7d1830",
            "filename": "lib/perf_hooks.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/475c43c1b006e186036817c364dfc24a4d12c44f/lib%2Fperf_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/475c43c1b006e186036817c364dfc24a4d12c44f/lib%2Fperf_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fperf_hooks.js?ref=475c43c1b006e186036817c364dfc24a4d12c44f",
            "patch": "@@ -11,7 +11,8 @@ const {\n   timeOrigin,\n   timeOriginTimestamp,\n   timerify,\n-  constants\n+  constants,\n+  setupGarbageCollectionTracking\n } = internalBinding('performance');\n \n const {\n@@ -273,6 +274,8 @@ class PerformanceObserverEntryList {\n   }\n }\n \n+let gcTrackingIsEnabled = false;\n+\n class PerformanceObserver extends AsyncResource {\n   constructor(callback) {\n     if (typeof callback !== 'function') {\n@@ -334,6 +337,11 @@ class PerformanceObserver extends AsyncResource {\n     if (entryTypes.length === 0) {\n       throw new errors.ERR_VALID_PERFORMANCE_ENTRY_TYPE();\n     }\n+    if (entryTypes.includes(NODE_PERFORMANCE_ENTRY_TYPE_GC) &&\n+      !gcTrackingIsEnabled) {\n+      setupGarbageCollectionTracking();\n+      gcTrackingIsEnabled = true;\n+    }\n     this.disconnect();\n     this[kBuffer][kEntries] = [];\n     L.init(this[kBuffer][kEntries]);"
        },
        {
            "sha": "33dd1d2051872cfa021d9f47db5769134088409a",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/475c43c1b006e186036817c364dfc24a4d12c44f/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/475c43c1b006e186036817c364dfc24a4d12c44f/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=475c43c1b006e186036817c364dfc24a4d12c44f",
            "patch": "@@ -296,8 +296,10 @@ void MarkGarbageCollectionEnd(Isolate* isolate,\n                          entry);\n }\n \n+static void SetupGarbageCollectionTracking(\n+    const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n \n-inline void SetupGarbageCollectionTracking(Environment* env) {\n   env->isolate()->AddGCPrologueCallback(MarkGarbageCollectionStart,\n                                         static_cast<void*>(env));\n   env->isolate()->AddGCEpilogueCallback(MarkGarbageCollectionEnd,\n@@ -416,6 +418,8 @@ void Initialize(Local<Object> target,\n   env->SetMethod(target, \"markMilestone\", MarkMilestone);\n   env->SetMethod(target, \"setupObservers\", SetupPerformanceObservers);\n   env->SetMethod(target, \"timerify\", Timerify);\n+  env->SetMethod(\n+      target, \"setupGarbageCollectionTracking\", SetupGarbageCollectionTracking);\n \n   Local<Object> constants = Object::New(isolate);\n \n@@ -452,8 +456,6 @@ void Initialize(Local<Object> target,\n                             env->constants_string(),\n                             constants,\n                             attr).ToChecked();\n-\n-  SetupGarbageCollectionTracking(env);\n }\n \n }  // namespace performance"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 14,
        "deletions": 4
    }
}