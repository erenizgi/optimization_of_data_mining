{
    "author": "tniessen",
    "message": "crypto: do not allow multiple calls to setAuthTag\n\nCalling setAuthTag multiple times can result in hard to detect bugs\nsince to the user, it is unclear which invocation actually affected\nOpenSSL.\n\nPR-URL: https://github.com/nodejs/node/pull/22931\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>",
    "sha": "058c5b81cdbabe8989a194ba5d388f4c230f4af6",
    "files": [
        {
            "sha": "ecb0c8186c716b3d2e67fe30f2e59e7aaba2f26e",
            "filename": "doc/api/crypto.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/058c5b81cdbabe8989a194ba5d388f4c230f4af6/doc%2Fapi%2Fcrypto.md",
            "raw_url": "https://github.com/nodejs/node/raw/058c5b81cdbabe8989a194ba5d388f4c230f4af6/doc%2Fapi%2Fcrypto.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcrypto.md?ref=058c5b81cdbabe8989a194ba5d388f4c230f4af6",
            "patch": "@@ -445,7 +445,7 @@ is invalid according to [NIST SP 800-38D][] or does not match the value of the\n `authTagLength` option, `decipher.setAuthTag()` will throw an error.\n \n The `decipher.setAuthTag()` method must be called before\n-[`decipher.final()`][].\n+[`decipher.final()`][] and can only be called once.\n \n ### decipher.setAutoPadding([autoPadding])\n <!-- YAML"
        },
        {
            "sha": "4cf3ac5652bc0d68f313f99b86c5747e727477ef",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/058c5b81cdbabe8989a194ba5d388f4c230f4af6/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/058c5b81cdbabe8989a194ba5d388f4c230f4af6/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=058c5b81cdbabe8989a194ba5d388f4c230f4af6",
            "patch": "@@ -2894,14 +2894,11 @@ void CipherBase::SetAuthTag(const FunctionCallbackInfo<Value>& args) {\n \n   if (!cipher->ctx_ ||\n       !cipher->IsAuthenticatedMode() ||\n-      cipher->kind_ != kDecipher) {\n+      cipher->kind_ != kDecipher ||\n+      cipher->auth_tag_state_ != kAuthTagUnknown) {\n     return args.GetReturnValue().Set(false);\n   }\n \n-  // TODO(tniessen): Throw if the authentication tag has already been set.\n-  if (cipher->auth_tag_state_ == kAuthTagPassedToOpenSSL)\n-    return args.GetReturnValue().Set(true);\n-\n   unsigned int tag_len = Buffer::Length(args[0]);\n   const int mode = EVP_CIPHER_CTX_mode(cipher->ctx_.get());\n   bool is_valid;"
        },
        {
            "sha": "ec5c05cb120da7ccfff8eba0009d60a4a474a946",
            "filename": "test/parallel/test-crypto-authenticated.js",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/058c5b81cdbabe8989a194ba5d388f4c230f4af6/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "raw_url": "https://github.com/nodejs/node/raw/058c5b81cdbabe8989a194ba5d388f4c230f4af6/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-authenticated.js?ref=058c5b81cdbabe8989a194ba5d388f4c230f4af6",
            "patch": "@@ -589,3 +589,29 @@ for (const test of TEST_CASES) {\n     }\n   }\n }\n+\n+// Test that setAuthTag can only be called once.\n+{\n+  const plain = Buffer.from('Hello world', 'utf8');\n+  const key = Buffer.from('0123456789abcdef', 'utf8');\n+  const iv = Buffer.from('0123456789ab', 'utf8');\n+  const opts = { authTagLength: 8 };\n+\n+  for (const mode of ['gcm', 'ccm', 'ocb']) {\n+    const cipher = crypto.createCipheriv(`aes-128-${mode}`, key, iv, opts);\n+    const ciphertext = Buffer.concat([cipher.update(plain), cipher.final()]);\n+    const tag = cipher.getAuthTag();\n+\n+    const decipher = crypto.createDecipheriv(`aes-128-${mode}`, key, iv, opts);\n+    decipher.setAuthTag(tag);\n+    assert.throws(() => {\n+      decipher.setAuthTag(tag);\n+    }, errMessages.state);\n+    // Decryption should still work.\n+    const plaintext = Buffer.concat([\n+      decipher.update(ciphertext),\n+      decipher.final()\n+    ]);\n+    assert(plain.equals(plaintext));\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 29,
        "deletions": 6
    }
}