{
    "author": "bnoordhuis",
    "message": "src: handle TryCatch with empty message\n\nThis bug needs a test case with a high goldilocks factor to trigger\nbut the synopsis is that `v8::TryCatch::Message()` returns an empty\nhandle when the TryCatch is declared at a time when an exception is\nalready pending.\n\nWe now recompute the message inside `node::ReportException()` and\nall is well again.\n\nPR-URL: https://github.com/nodejs/node/pull/20708\nFixes: https://github.com/nodejs/node/issues/8854\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091",
    "files": [
        {
            "sha": "84b40f99e64d8eaaac7927e1c7fa4e76fa0f648b",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091",
            "patch": "@@ -1414,9 +1414,11 @@ static void ReportException(Environment* env,\n                             Local<Value> er,\n                             Local<Message> message) {\n   CHECK(!er.IsEmpty());\n-  CHECK(!message.IsEmpty());\n   HandleScope scope(env->isolate());\n \n+  if (message.IsEmpty())\n+    message = Exception::CreateMessage(env->isolate(), er);\n+\n   AppendExceptionLine(env, er, message, FATAL_ERROR);\n \n   Local<Value> trace_value;"
        },
        {
            "sha": "1ba4bc6438e2f97b78eada2ba49c6e964a9b4d62",
            "filename": "test/parallel/test-tls-handshake-exception.js",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091/test%2Fparallel%2Ftest-tls-handshake-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091/test%2Fparallel%2Ftest-tls-handshake-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-handshake-exception.js?ref=de4e0d7f6d2a52452043ffdcf13a6a3ce8f31091",
            "patch": "@@ -0,0 +1,57 @@\n+'use strict';\n+\n+// Verify that exceptions from a callback don't result in\n+// failed CHECKs when trying to print the exception message.\n+\n+// This test is convoluted because it needs to trigger a callback\n+// into JS land at just the right time when an exception is pending,\n+// and does so by exploiting a weakness in the streams infrastructure.\n+// I won't shed any tears if this test ever becomes invalidated.\n+\n+const common = require('../common');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+if (process.argv[2] === 'child') {\n+  const fixtures = require('../common/fixtures');\n+  const https = require('https');\n+  const net = require('net');\n+  const tls = require('tls');\n+  const { Duplex } = require('stream');\n+  const { mustCall } = common;\n+\n+  const cert = fixtures.readSync('test_cert.pem');\n+  const key = fixtures.readSync('test_key.pem');\n+\n+  net.createServer(mustCall(onplaintext)).listen(0, mustCall(onlisten));\n+\n+  function onlisten() {\n+    const { port } = this.address();\n+    https.get({ port, rejectUnauthorized: false });\n+  }\n+\n+  function onplaintext(c) {\n+    const d = new class extends Duplex {\n+      _read(n) {\n+        const data = c.read(n);\n+        if (data) d.push(data);\n+      }\n+      _write(...xs) {\n+        c.write(...xs);\n+      }\n+    }();\n+    c.on('data', d.push.bind(d));\n+\n+    const options = { key, cert };\n+    const fail = () => { throw new Error('eyecatcher'); };\n+    tls.createServer(options, mustCall(fail)).emit('connection', d);\n+  }\n+} else {\n+  const assert = require('assert');\n+  const { spawnSync } = require('child_process');\n+  const result = spawnSync(process.execPath, [__filename, 'child']);\n+  const stderr = result.stderr.toString();\n+  const ok = stderr.includes('Error: eyecatcher');\n+  assert(ok, stderr);\n+}"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 60,
        "deletions": 1
    }
}