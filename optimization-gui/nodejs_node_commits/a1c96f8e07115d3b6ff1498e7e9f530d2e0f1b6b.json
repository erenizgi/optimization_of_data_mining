{
    "author": "BridgeAR",
    "message": "assert: improve assert.throws\n\nThis switches the assert.throws output to the one used in strict mode\nif a error object is used for comparison. From now on it will show\nthe complete difference between two objects instead of only showing\nthe first failing property.\n\nIt also fixes detecting properties with a undefined value and fails\nin case the thrown error does not contain the value at all.\n\nPR-URL: https://github.com/nodejs/node/pull/19463\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
    "files": [
        {
            "sha": "2fc3cf33e80a18bd89ef90919766d9d7cd58a8c9",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 38,
            "deletions": 15,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
            "patch": "@@ -366,13 +366,38 @@ assert.notStrictEqual = function notStrictEqual(actual, expected, message) {\n   }\n };\n \n-function compareExceptionKey(actual, expected, key, msg) {\n-  if (!isDeepStrictEqual(actual[key], expected[key])) {\n+class Comparison {\n+  constructor(obj, keys) {\n+    for (const key of keys) {\n+      if (key in obj)\n+        this[key] = obj[key];\n+    }\n+  }\n+}\n+\n+function compareExceptionKey(actual, expected, key, message, keys) {\n+  if (!(key in actual) || !isDeepStrictEqual(actual[key], expected[key])) {\n+    if (!message) {\n+      // Create placeholder objects to create a nice output.\n+      const a = new Comparison(actual, keys);\n+      const b = new Comparison(expected, keys);\n+\n+      const tmpLimit = Error.stackTraceLimit;\n+      Error.stackTraceLimit = 0;\n+      const err = new AssertionError({\n+        actual: a,\n+        expected: b,\n+        operator: 'deepStrictEqual',\n+        stackStartFn: assert.throws,\n+        errorDiff: ERR_DIFF_EQUAL\n+      });\n+      Error.stackTraceLimit = tmpLimit;\n+      message = err.message;\n+    }\n     innerFail({\n-      actual: actual[key],\n-      expected: expected[key],\n-      message: msg || `${key}: expected ${inspect(expected[key])}, ` +\n-                      `not ${inspect(actual[key])}`,\n+      actual,\n+      expected,\n+      message,\n       operator: 'throws',\n       stackStartFn: assert.throws\n     });\n@@ -389,16 +414,14 @@ function expectedException(actual, expected, msg) {\n         'expected', ['Function', 'RegExp'], expected\n       );\n     }\n-    // The name and message could be non enumerable. Therefore test them\n-    // explicitly.\n-    if ('name' in expected) {\n-      compareExceptionKey(actual, expected, 'name', msg);\n-    }\n-    if ('message' in expected) {\n-      compareExceptionKey(actual, expected, 'message', msg);\n+    const keys = Object.keys(expected);\n+    // Special handle errors to make sure the name and the message are compared\n+    // as well.\n+    if (expected instanceof Error) {\n+      keys.push('name', 'message');\n     }\n-    for (const key of Object.keys(expected)) {\n-      compareExceptionKey(actual, expected, key, msg);\n+    for (const key of keys) {\n+      compareExceptionKey(actual, expected, key, msg, keys);\n     }\n     return true;\n   }"
        },
        {
            "sha": "71d06a461e149495ea4a4820332a5dbc9772b599",
            "filename": "test/message/assert_throws_stack.out",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fmessage%2Fassert_throws_stack.out",
            "raw_url": "https://github.com/nodejs/node/raw/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fmessage%2Fassert_throws_stack.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fassert_throws_stack.out?ref=a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
            "patch": "@@ -2,7 +2,13 @@ assert.js:*\n   throw new AssertionError(obj);\n   ^\n \n-AssertionError [ERR_ASSERTION]: bar: expected true, not undefined\n+AssertionError [ERR_ASSERTION]: Input A expected to deepStrictEqual input B:\n++ expected - actual\n+\n+- Comparison {}\n++ Comparison {\n++   bar: true\n++ }\n     at Object.<anonymous> (*assert_throws_stack.js:*:*)\n     at *\n     at *"
        },
        {
            "sha": "aab26d4272538ad546c240e48d03788bf3589f3e",
            "filename": "test/parallel/test-assert-fail-deprecation.js",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert-fail-deprecation.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert-fail-deprecation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-fail-deprecation.js?ref=a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
            "patch": "@@ -38,11 +38,7 @@ assert.throws(() => {\n   assert.fail(typeof 1, 'object', new TypeError('another custom message'));\n }, {\n   name: 'TypeError',\n-  message: 'another custom message',\n-  operator: undefined,\n-  actual: undefined,\n-  expected: undefined,\n-  code: undefined\n+  message: 'another custom message'\n });\n \n // No third arg (but a fourth arg)"
        },
        {
            "sha": "e8336e8f2169efa30cfb1974f2209f95b1c3aab0",
            "filename": "test/parallel/test-assert-fail.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert-fail.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert-fail.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-fail.js?ref=a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
            "patch": "@@ -33,8 +33,5 @@ assert.throws(() => {\n   assert.fail(new TypeError('custom message'));\n }, {\n   name: 'TypeError',\n-  message: 'custom message',\n-  operator: undefined,\n-  actual: undefined,\n-  expected: undefined\n+  message: 'custom message'\n });"
        },
        {
            "sha": "195d9bbc8013ca535f7073f139f024e8d71dc7dc",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 33,
            "deletions": 20,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=a1c96f8e07115d3b6ff1498e7e9f530d2e0f1b6b",
            "patch": "@@ -34,6 +34,12 @@ const { writeFileSync, unlinkSync } = require('fs');\n const { inspect } = require('util');\n const a = assert;\n \n+const colors = process.stdout.isTTY && process.stdout.getColorDepth() > 1;\n+const start = 'Input A expected to deepStrictEqual input B:';\n+const actExp = colors ?\n+  '\\u001b[32m+ expected\\u001b[39m \\u001b[31m- actual\\u001b[39m' :\n+  '+ expected - actual';\n+\n assert.ok(a.AssertionError.prototype instanceof Error,\n           'a.AssertionError instanceof Error');\n \n@@ -436,11 +442,6 @@ common.expectsError(\n   Error.stackTraceLimit = tmpLimit;\n \n   // Test error diffs.\n-  const colors = process.stdout.isTTY && process.stdout.getColorDepth() > 1;\n-  const start = 'Input A expected to deepStrictEqual input B:';\n-  const actExp = colors ?\n-    '\\u001b[32m+ expected\\u001b[39m \\u001b[31m- actual\\u001b[39m' :\n-    '+ expected - actual';\n   const plus = colors ? '\\u001b[32m+\\u001b[39m' : '+';\n   const minus = colors ? '\\u001b[31m-\\u001b[39m' : '-';\n   let message = [\n@@ -765,24 +766,32 @@ common.expectsError(\n   errObj.code = 404;\n   assert.throws(errFn, errObj);\n \n-  errObj.code = '404';\n-  common.expectsError(\n+  // Fail in case a expected property is undefined and not existent on the\n+  // error.\n+  errObj.foo = undefined;\n+  assert.throws(\n     () => assert.throws(errFn, errObj),\n     {\n       code: 'ERR_ASSERTION',\n-      type: assert.AssertionError,\n-      message: 'code: expected \\'404\\', not 404'\n+      name: 'AssertionError [ERR_ASSERTION]',\n+      message: `${start}\\n${actExp}\\n\\n` +\n+               \"  Comparison {\\n    name: 'TypeError',\\n\" +\n+               \"    message: 'Wrong value',\\n-   code: 404\\n\" +\n+               '+   code: 404,\\n+   foo: undefined\\n  }'\n     }\n   );\n \n-  errObj.code = 404;\n-  errObj.foo = 'bar';\n-  common.expectsError(\n+  // Show multiple wrong properties at the same time.\n+  errObj.code = '404';\n+  assert.throws(\n     () => assert.throws(errFn, errObj),\n     {\n       code: 'ERR_ASSERTION',\n-      type: assert.AssertionError,\n-      message: 'foo: expected \\'bar\\', not undefined'\n+      name: 'AssertionError [ERR_ASSERTION]',\n+      message: `${start}\\n${actExp}\\n\\n` +\n+               \"  Comparison {\\n    name: 'TypeError',\\n\" +\n+               \"    message: 'Wrong value',\\n-   code: 404\\n\" +\n+               \"+   code: '404',\\n+   foo: undefined\\n  }\"\n     }\n   );\n \n@@ -806,20 +815,24 @@ common.expectsError(\n   );\n \n   assert.throws(() => { throw new Error('e'); }, new Error('e'));\n-  common.expectsError(\n+  assert.throws(\n     () => assert.throws(() => { throw new TypeError('e'); }, new Error('e')),\n     {\n-      type: assert.AssertionError,\n+      name: 'AssertionError [ERR_ASSERTION]',\n       code: 'ERR_ASSERTION',\n-      message: \"name: expected 'Error', not 'TypeError'\"\n+      message: `${start}\\n${actExp}\\n\\n` +\n+               \"  Comparison {\\n-   name: 'TypeError',\\n+   name: 'Error',\" +\n+               \"\\n    message: 'e'\\n  }\"\n     }\n   );\n-  common.expectsError(\n+  assert.throws(\n     () => assert.throws(() => { throw new Error('foo'); }, new Error('')),\n     {\n-      type: assert.AssertionError,\n+      name: 'AssertionError [ERR_ASSERTION]',\n       code: 'ERR_ASSERTION',\n-      message: \"message: expected '', not 'foo'\"\n+      message: `${start}\\n${actExp}\\n\\n` +\n+               \"  Comparison {\\n    name: 'Error',\\n-   message: 'foo'\" +\n+               \"\\n+   message: ''\\n  }\"\n     }\n   );\n "
        }
    ],
    "stats": {
        "total": 125,
        "additions": 80,
        "deletions": 45
    }
}