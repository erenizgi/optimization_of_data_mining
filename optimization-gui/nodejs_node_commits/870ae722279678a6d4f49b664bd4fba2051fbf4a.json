{
    "author": "richardlau",
    "message": "tools: add eslint check for skipIfEslintMissing\n\nAdd a custom eslint rule to check for `common.skipIfEslintMissing()` to\nallow tests to run from source tarballs that do not include eslint.\n\nFix up rule tests that were failing the new check.\n\nRefs: https://github.com/nodejs/node/issues/20336\n\nPR-URL: https://github.com/nodejs/node/pull/20372\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "870ae722279678a6d4f49b664bd4fba2051fbf4a",
    "files": [
        {
            "sha": "7c90a5026b27d0f349b746b411954aead615f7a1",
            "filename": "test/.eslintrc.yaml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2F.eslintrc.yaml",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2F.eslintrc.yaml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2F.eslintrc.yaml?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -13,6 +13,7 @@ rules:\n   node-core/prefer-common-expectserror: error\n   node-core/prefer-common-mustnotcall: error\n   node-core/crypto-check: error\n+  node-core/eslint-check: error\n   node-core/inspector-check: error\n   node-core/number-isnan: error\n   ## common module is mandatory in tests"
        },
        {
            "sha": "07c0992d65e8d26b9a0eb7fa71f4a62194ee7117",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -494,7 +494,7 @@ exports.fileExists = function(pathname) {\n \n exports.skipIfEslintMissing = function() {\n   if (!exports.fileExists(\n-    path.join('..', '..', 'tools', 'node_modules', 'eslint')\n+    path.join(__dirname, '..', '..', 'tools', 'node_modules', 'eslint')\n   )) {\n     exports.skip('missing ESLint');\n   }"
        },
        {
            "sha": "3f2a5b3fd35c8faadbf6476872995a457e271de4",
            "filename": "test/parallel/test-eslint-alphabetize-errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-alphabetize-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-alphabetize-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-alphabetize-errors.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n-require('../common');\n+const common = require('../common');\n+common.skipIfEslintMissing();\n \n const RuleTester = require('../../tools/node_modules/eslint').RuleTester;\n const rule = require('../../tools/eslint-rules/alphabetize-errors');"
        },
        {
            "sha": "daa1a527673c1a030b2047a2bb6ae97a8d9957f8",
            "filename": "test/parallel/test-eslint-buffer-constructor.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-buffer-constructor.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-buffer-constructor.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-buffer-constructor.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n-require('../common');\n+const common = require('../common');\n+common.skipIfEslintMissing();\n \n const RuleTester = require('../../tools/node_modules/eslint').RuleTester;\n const rule = require('../../tools/eslint-rules/buffer-constructor');"
        },
        {
            "sha": "533b829e78a298135c9545fe646d0357b0a36b5b",
            "filename": "test/parallel/test-eslint-documented-errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-documented-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-documented-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-documented-errors.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n-require('../common');\n+const common = require('../common');\n+common.skipIfEslintMissing();\n \n const RuleTester = require('../../tools/node_modules/eslint').RuleTester;\n const rule = require('../../tools/eslint-rules/documented-errors');"
        },
        {
            "sha": "46e2a6a4a2ce47df2afe00b486fd7aa6ef2f068e",
            "filename": "test/parallel/test-eslint-eslint-check.js",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-eslint-check.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-eslint-check.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-eslint-check.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -0,0 +1,31 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+common.skipIfEslintMissing();\n+\n+const RuleTester = require('../../tools/node_modules/eslint').RuleTester;\n+const rule = require('../../tools/eslint-rules/eslint-check');\n+\n+const message = 'Please add a skipIfEslintMissing() call to allow this ' +\n+                'test to be skipped when Node.js is built ' +\n+                'from a source tarball.';\n+\n+new RuleTester().run('eslint-check', rule, {\n+  valid: [\n+    'foo;',\n+    'require(\"common\")\\n' +\n+      'common.skipIfEslintMissing();\\n' +\n+      'require(\"../../tools/node_modules/eslint\")'\n+  ],\n+  invalid: [\n+    {\n+      code: 'require(\"common\")\\n' +\n+            'require(\"../../tools/node_modules/eslint\").RuleTester',\n+      errors: [{ message }],\n+      output: 'require(\"common\")\\n' +\n+              'common.skipIfEslintMissing();\\n' +\n+              'require(\"../../tools/node_modules/eslint\").RuleTester'\n+    }\n+  ]\n+});"
        },
        {
            "sha": "ae71c004029771ea6bd4d356d240c8ef1a54d0e8",
            "filename": "test/parallel/test-eslint-inspector-check.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-inspector-check.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-inspector-check.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-inspector-check.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -1,12 +1,13 @@\n 'use strict';\n \n-require('../common');\n+const common = require('../common');\n+common.skipIfEslintMissing();\n \n const RuleTester = require('../../tools/node_modules/eslint').RuleTester;\n const rule = require('../../tools/eslint-rules/inspector-check');\n \n const message = 'Please add a skipIfInspectorDisabled() call to allow this ' +\n-                'test to be skippped when Node is built ' +\n+                'test to be skipped when Node is built ' +\n                 '\\'--without-inspector\\'.';\n \n new RuleTester().run('inspector-check', rule, {"
        },
        {
            "sha": "da17d44c7f600df3bac09b9a1afd81f1e081ac79",
            "filename": "test/parallel/test-eslint-require-buffer.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-require-buffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/test%2Fparallel%2Ftest-eslint-require-buffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-eslint-require-buffer.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -11,7 +11,7 @@ const ruleTester = new RuleTester({\n   env: { node: true }\n });\n \n-const message = \"Use const Buffer = require('buffer').Buffer; \" +\n+const message = \"Use const { Buffer } = require('buffer'); \" +\n                 'at the beginning of this file';\n \n const useStrict = '\\'use strict\\';\\n\\n';"
        },
        {
            "sha": "00a5234733ec05a319af24c1d024e8fad7054166",
            "filename": "tools/eslint-rules/eslint-check.js",
            "status": "added",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/tools%2Feslint-rules%2Feslint-check.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/tools%2Feslint-rules%2Feslint-check.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Feslint-rules%2Feslint-check.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -0,0 +1,60 @@\n+/**\n+ * @fileoverview Check that common.skipIfEslintMissing is used if\n+ *               the eslint module is required.\n+ */\n+'use strict';\n+\n+const utils = require('./rules-utils.js');\n+\n+//------------------------------------------------------------------------------\n+// Rule Definition\n+//------------------------------------------------------------------------------\n+const msg = 'Please add a skipIfEslintMissing() call to allow this test to ' +\n+            'be skipped when Node.js is built from a source tarball.';\n+\n+module.exports = function(context) {\n+  const missingCheckNodes = [];\n+  var commonModuleNode = null;\n+  var hasEslintCheck = false;\n+\n+  function testEslintUsage(context, node) {\n+    if (utils.isRequired(node, ['../../tools/node_modules/eslint'])) {\n+      missingCheckNodes.push(node);\n+    }\n+\n+    if (utils.isCommonModule(node)) {\n+      commonModuleNode = node;\n+    }\n+  }\n+\n+  function checkMemberExpression(context, node) {\n+    if (utils.usesCommonProperty(node, ['skipIfEslintMissing'])) {\n+      hasEslintCheck = true;\n+    }\n+  }\n+\n+  function reportIfMissing(context) {\n+    if (!hasEslintCheck) {\n+      missingCheckNodes.forEach((node) => {\n+        context.report({\n+          node,\n+          message: msg,\n+          fix: (fixer) => {\n+            if (commonModuleNode) {\n+              return fixer.insertTextAfter(\n+                commonModuleNode,\n+                '\\ncommon.skipIfEslintMissing();'\n+              );\n+            }\n+          }\n+        });\n+      });\n+    }\n+  }\n+\n+  return {\n+    'CallExpression': (node) => testEslintUsage(context, node),\n+    'MemberExpression': (node) => checkMemberExpression(context, node),\n+    'Program:exit': (node) => reportIfMissing(context, node)\n+  };\n+};"
        },
        {
            "sha": "189b023efc61953583ecc73a9ff4f514aeae9798",
            "filename": "tools/eslint-rules/inspector-check.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/870ae722279678a6d4f49b664bd4fba2051fbf4a/tools%2Feslint-rules%2Finspector-check.js",
            "raw_url": "https://github.com/nodejs/node/raw/870ae722279678a6d4f49b664bd4fba2051fbf4a/tools%2Feslint-rules%2Finspector-check.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Feslint-rules%2Finspector-check.js?ref=870ae722279678a6d4f49b664bd4fba2051fbf4a",
            "patch": "@@ -11,7 +11,7 @@ const utils = require('./rules-utils.js');\n // Rule Definition\n //------------------------------------------------------------------------------\n const msg = 'Please add a skipIfInspectorDisabled() call to allow this ' +\n-            'test to be skippped when Node is built \\'--without-inspector\\'.';\n+            'test to be skipped when Node is built \\'--without-inspector\\'.';\n \n module.exports = function(context) {\n   const missingCheckNodes = [];"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 104,
        "deletions": 8
    }
}