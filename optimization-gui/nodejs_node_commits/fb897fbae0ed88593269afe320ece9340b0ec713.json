{
    "author": "refack",
    "message": "src: refactor FillStatsArray\n\nPR-URL: https://github.com/nodejs/node/pull/23793\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "fb897fbae0ed88593269afe320ece9340b0ec713",
    "files": [
        {
            "sha": "f542a1eab1d1779612df6b5528590bbc05ed7546",
            "filename": "lib/internal/fs/watchers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/lib%2Finternal%2Ffs%2Fwatchers.js",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/lib%2Finternal%2Ffs%2Fwatchers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fwatchers.js?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -2,7 +2,7 @@\n \n const errors = require('internal/errors');\n const {\n-  kFsStatsFieldsLength,\n+  kFsStatsFieldsNumber,\n   StatWatcher: _StatWatcher\n } = process.binding('fs');\n const { FSEvent } = internalBinding('fs_event_wrap');\n@@ -48,7 +48,7 @@ function onchange(newStatus, stats) {\n \n   self[kOldStatus] = newStatus;\n   self.emit('change', getStatsFromBinding(stats),\n-            getStatsFromBinding(stats, kFsStatsFieldsLength));\n+            getStatsFromBinding(stats, kFsStatsFieldsNumber));\n }\n \n // FIXME(joyeecheung): this method is not documented."
        },
        {
            "sha": "79739e7d382991e6c4f7b01e7a3624ed3ceb9062",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -169,8 +169,8 @@ Environment::Environment(IsolateData* isolate_data,\n       trace_category_state_(isolate_, kTraceCategoryCount),\n       stream_base_state_(isolate_, StreamBase::kNumStreamBaseStateFields),\n       http_parser_buffer_(nullptr),\n-      fs_stats_field_array_(isolate_, kFsStatsFieldsLength * 2),\n-      fs_stats_field_bigint_array_(isolate_, kFsStatsFieldsLength * 2),\n+      fs_stats_field_array_(isolate_, kFsStatsBufferLength),\n+      fs_stats_field_bigint_array_(isolate_, kFsStatsBufferLength),\n       context_(context->GetIsolate(), context) {\n   // We'll be creating new objects so make sure we've entered the context.\n   v8::HandleScope handle_scope(isolate());"
        },
        {
            "sha": "af2dbd32a5a9c4e4552ad7b04dd55cdddf768f14",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -84,9 +84,12 @@ struct PackageConfig {\n \n // The number of items passed to push_values_to_array_function has diminishing\n // returns around 8. This should be used at all call sites using said function.\n-#ifndef NODE_PUSH_VAL_TO_ARRAY_MAX\n-#define NODE_PUSH_VAL_TO_ARRAY_MAX 8\n-#endif\n+constexpr size_t NODE_PUSH_VAL_TO_ARRAY_MAX = 8;\n+\n+// Stat fields buffers contain twice the number of entries in an uv_stat_t\n+// because `fs.StatWatcher` needs room to store 2 `fs.Stats` instances.\n+constexpr size_t kFsStatsFieldsNumber = 14;\n+constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n \n // PER_ISOLATE_* macros: We have a lot of per-isolate properties\n // and adding and maintaining their getters and setters by hand would be\n@@ -710,10 +713,6 @@ class Environment {\n   inline AliasedBuffer<uint64_t, v8::BigUint64Array>*\n       fs_stats_field_bigint_array();\n \n-  // stat fields contains twice the number of entries because `fs.StatWatcher`\n-  // needs room to store data for *two* `fs.Stats` instances.\n-  static const int kFsStatsFieldsLength = 14;\n-\n   inline std::vector<std::unique_ptr<fs::FileHandleReadWrap>>&\n       file_handle_read_wrap_freelist();\n "
        },
        {
            "sha": "920350f01a029782d682322fe6320f65cf88e123",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -426,7 +426,7 @@ void FSReqCallback::Reject(Local<Value> reject) {\n }\n \n void FSReqCallback::ResolveStat(const uv_stat_t* stat) {\n-  Resolve(node::FillGlobalStatsArray(env(), stat, use_bigint()));\n+  Resolve(FillGlobalStatsArray(env(), use_bigint(), stat));\n }\n \n void FSReqCallback::Resolve(Local<Value> value) {\n@@ -949,8 +949,8 @@ static void Stat(const FunctionCallbackInfo<Value>& args) {\n       return;  // error info is in ctx\n     }\n \n-    Local<Value> arr = node::FillGlobalStatsArray(env,\n-        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr), use_bigint);\n+    Local<Value> arr = FillGlobalStatsArray(env, use_bigint,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     args.GetReturnValue().Set(arr);\n   }\n }\n@@ -980,8 +980,8 @@ static void LStat(const FunctionCallbackInfo<Value>& args) {\n       return;  // error info is in ctx\n     }\n \n-    Local<Value> arr = node::FillGlobalStatsArray(env,\n-        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr), use_bigint);\n+    Local<Value> arr = FillGlobalStatsArray(env, use_bigint,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     args.GetReturnValue().Set(arr);\n   }\n }\n@@ -1010,8 +1010,8 @@ static void FStat(const FunctionCallbackInfo<Value>& args) {\n       return;  // error info is in ctx\n     }\n \n-    Local<Value> arr = node::FillGlobalStatsArray(env,\n-        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr), use_bigint);\n+    Local<Value> arr = FillGlobalStatsArray(env, use_bigint,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     args.GetReturnValue().Set(arr);\n   }\n }\n@@ -2237,8 +2237,8 @@ void Initialize(Local<Object> target,\n   env->SetMethod(target, \"mkdtemp\", Mkdtemp);\n \n   target->Set(context,\n-              FIXED_ONE_BYTE_STRING(isolate, \"kFsStatsFieldsLength\"),\n-              Integer::New(isolate, env->kFsStatsFieldsLength))\n+              FIXED_ONE_BYTE_STRING(isolate, \"kFsStatsFieldsNumber\"),\n+              Integer::New(isolate, kFsStatsFieldsNumber))\n         .FromJust();\n \n   target->Set(context,"
        },
        {
            "sha": "96f8221520bd33ab07909a5d6edf374570590b23",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 89,
            "deletions": 2,
            "changes": 91,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -148,6 +148,92 @@ class FSReqCallback : public FSReqBase {\n   DISALLOW_COPY_AND_ASSIGN(FSReqCallback);\n };\n \n+// Wordaround a GCC4.9 bug that C++14 N3652 was not implemented\n+// Refs: https://www.gnu.org/software/gcc/projects/cxx-status.html#cxx14\n+// Refs: https://isocpp.org/files/papers/N3652.html\n+#if __cpp_constexpr < 201304\n+#  define constexpr inline\n+#endif\n+\n+template <typename NativeT,\n+          // SFINAE limit NativeT to arithmetic types\n+          typename = std::enable_if<std::is_arithmetic<NativeT>::value>>\n+constexpr NativeT ToNative(uv_timespec_t ts) {\n+  // This template has exactly two specializations below.\n+  static_assert(std::is_arithmetic<NativeT>::value == false, \"Not implemented\");\n+  UNREACHABLE();\n+}\n+\n+template <>\n+constexpr double ToNative(uv_timespec_t ts) {\n+  // We need to do a static_cast since the original FS values are ulong.\n+  /* NOLINTNEXTLINE(runtime/int) */\n+  const auto u_sec = static_cast<unsigned long>(ts.tv_sec);\n+  const double full_sec = u_sec * 1000.0;\n+  /* NOLINTNEXTLINE(runtime/int) */\n+  const auto u_nsec = static_cast<unsigned long>(ts.tv_nsec);\n+  const double full_nsec = u_nsec / 1000'000.0;\n+  return full_sec + full_nsec;\n+}\n+\n+template <>\n+constexpr uint64_t ToNative(uv_timespec_t ts) {\n+  // We need to do a static_cast since the original FS values are ulong.\n+  /* NOLINTNEXTLINE(runtime/int) */\n+  const auto u_sec = static_cast<unsigned long>(ts.tv_sec);\n+  const auto full_sec = static_cast<uint64_t>(u_sec) * 1000UL;\n+  /* NOLINTNEXTLINE(runtime/int) */\n+  const auto u_nsec = static_cast<unsigned long>(ts.tv_nsec);\n+  const auto full_nsec = static_cast<uint64_t>(u_nsec) / 1000'000UL;\n+  return full_sec + full_nsec;\n+}\n+\n+#undef constexpr  // end N3652 bug workaround\n+\n+template <typename NativeT, typename V8T>\n+constexpr void FillStatsArray(AliasedBuffer<NativeT, V8T>* fields,\n+                              const uv_stat_t* s, const size_t offset = 0) {\n+  fields->SetValue(offset + 0, s->st_dev);\n+  fields->SetValue(offset + 1, s->st_mode);\n+  fields->SetValue(offset + 2, s->st_nlink);\n+  fields->SetValue(offset + 3, s->st_uid);\n+  fields->SetValue(offset + 4, s->st_gid);\n+  fields->SetValue(offset + 5, s->st_rdev);\n+#if defined(__POSIX__)\n+  fields->SetValue(offset + 6, s->st_blksize);\n+#else\n+  fields->SetValue(offset + 6, 0);\n+#endif\n+  fields->SetValue(offset + 7, s->st_ino);\n+  fields->SetValue(offset + 8, s->st_size);\n+#if defined(__POSIX__)\n+  fields->SetValue(offset + 9, s->st_blocks);\n+#else\n+  fields->SetValue(offset + 9, 0);\n+#endif\n+// Dates.\n+  fields->SetValue(offset + 10, ToNative<NativeT>(s->st_atim));\n+  fields->SetValue(offset + 11, ToNative<NativeT>(s->st_mtim));\n+  fields->SetValue(offset + 12, ToNative<NativeT>(s->st_ctim));\n+  fields->SetValue(offset + 13, ToNative<NativeT>(s->st_birthtim));\n+}\n+\n+inline Local<Value> FillGlobalStatsArray(Environment* env,\n+                                         const bool use_bigint,\n+                                         const uv_stat_t* s,\n+                                         const bool second = false) {\n+  const ptrdiff_t offset = second ? kFsStatsFieldsNumber : 0;\n+  if (use_bigint) {\n+    auto* const arr = env->fs_stats_field_bigint_array();\n+    FillStatsArray(arr, s, offset);\n+    return arr->GetJSArray();\n+  } else {\n+    auto* const arr = env->fs_stats_field_array();\n+    FillStatsArray(arr, s, offset);\n+    return arr->GetJSArray();\n+  }\n+}\n+\n template <typename NativeT = double, typename V8T = v8::Float64Array>\n class FSReqPromise : public FSReqBase {\n  public:\n@@ -157,7 +243,7 @@ class FSReqPromise : public FSReqBase {\n                       ->NewInstance(env->context()).ToLocalChecked(),\n                   AsyncWrap::PROVIDER_FSREQPROMISE,\n                   use_bigint),\n-        stats_field_array_(env->isolate(), env->kFsStatsFieldsLength) {\n+        stats_field_array_(env->isolate(), kFsStatsFieldsNumber) {\n     auto resolver = Promise::Resolver::New(env->context()).ToLocalChecked();\n     object()->Set(env->context(), env->promise_string(),\n                   resolver).FromJust();\n@@ -191,7 +277,8 @@ class FSReqPromise : public FSReqBase {\n   }\n \n   void ResolveStat(const uv_stat_t* stat) override {\n-    Resolve(node::FillStatsArray(&stats_field_array_, stat));\n+    FillStatsArray(&stats_field_array_, stat);\n+    Resolve(stats_field_array_.GetJSArray());\n   }\n \n   void SetReturnValue(const FunctionCallbackInfo<Value>& args) override {"
        },
        {
            "sha": "b3070198529b19c3e9283bbd7dcd3d93773aef25",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 0,
            "deletions": 52,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -32,7 +32,6 @@\n #include \"uv.h\"\n #include \"v8.h\"\n #include \"tracing/trace_event.h\"\n-#include \"node_perf_common.h\"\n #include \"node_api.h\"\n \n #include <stdint.h>\n@@ -308,57 +307,6 @@ v8::Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                               const char* warning,\n                                               const char* deprecation_code);\n \n-template <typename NativeT, typename V8T>\n-v8::Local<v8::Value> FillStatsArray(AliasedBuffer<NativeT, V8T>* fields_ptr,\n-                    const uv_stat_t* s, int offset = 0) {\n-  AliasedBuffer<NativeT, V8T>& fields = *fields_ptr;\n-  fields[offset + 0] = s->st_dev;\n-  fields[offset + 1] = s->st_mode;\n-  fields[offset + 2] = s->st_nlink;\n-  fields[offset + 3] = s->st_uid;\n-  fields[offset + 4] = s->st_gid;\n-  fields[offset + 5] = s->st_rdev;\n-#if defined(__POSIX__)\n-  fields[offset + 6] = s->st_blksize;\n-#else\n-  fields[offset + 6] = 0;\n-#endif\n-  fields[offset + 7] = s->st_ino;\n-  fields[offset + 8] = s->st_size;\n-#if defined(__POSIX__)\n-  fields[offset + 9] = s->st_blocks;\n-#else\n-  fields[offset + 9] = 0;\n-#endif\n-// Dates.\n-// NO-LINT because the fields are 'long' and we just want to cast to `unsigned`\n-#define X(idx, name)                                                    \\\n-  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n-  fields[offset + idx] = ((unsigned long)(s->st_##name.tv_sec) * 1e3) + \\\n-  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n-                ((unsigned long)(s->st_##name.tv_nsec) / 1e6);          \\\n-\n-  X(10, atim)\n-  X(11, mtim)\n-  X(12, ctim)\n-  X(13, birthtim)\n-#undef X\n-\n-  return fields_ptr->GetJSArray();\n-}\n-\n-inline v8::Local<v8::Value> FillGlobalStatsArray(Environment* env,\n-                                                 const uv_stat_t* s,\n-                                                 bool use_bigint = false,\n-                                                 int offset = 0) {\n-  if (use_bigint) {\n-    return node::FillStatsArray(\n-        env->fs_stats_field_bigint_array(), s, offset);\n-  } else {\n-    return node::FillStatsArray(env->fs_stats_field_array(), s, offset);\n-  }\n-}\n-\n void SetupBootstrapObject(Environment* env,\n                           v8::Local<v8::Object> bootstrapper);\n void SetupProcessObject(Environment* env,"
        },
        {
            "sha": "d586b52ede1ed54c220d3f3d78daa5358837841c",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fb897fbae0ed88593269afe320ece9340b0ec713/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=fb897fbae0ed88593269afe320ece9340b0ec713",
            "patch": "@@ -22,8 +22,8 @@\n #include \"node_stat_watcher.h\"\n #include \"node_internals.h\"\n #include \"async_wrap-inl.h\"\n-#include \"env-inl.h\"\n-#include \"util-inl.h\"\n+#include \"env.h\"\n+#include \"node_file.h\"\n \n #include <string.h>\n #include <stdlib.h>\n@@ -80,15 +80,10 @@ void StatWatcher::Callback(uv_fs_poll_t* handle,\n   HandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(env->context());\n \n-  Local<Value> arr = node::FillGlobalStatsArray(env, curr,\n-                                                wrap->use_bigint_);\n-  node::FillGlobalStatsArray(env, prev, wrap->use_bigint_,\n-                             env->kFsStatsFieldsLength);\n+  Local<Value> arr = fs::FillGlobalStatsArray(env, wrap->use_bigint_, curr);\n+  USE(fs::FillGlobalStatsArray(env, wrap->use_bigint_, prev, true));\n \n-  Local<Value> argv[2] {\n-    Integer::New(env->isolate(), status),\n-    arr\n-  };\n+  Local<Value> argv[2] = { Integer::New(env->isolate(), status), arr };\n   wrap->MakeCallback(env->onchange_string(), arraysize(argv), argv);\n }\n "
        }
    ],
    "stats": {
        "total": 197,
        "additions": 113,
        "deletions": 84
    }
}