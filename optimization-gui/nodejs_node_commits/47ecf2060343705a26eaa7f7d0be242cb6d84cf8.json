{
    "author": "Trott",
    "message": "test: remove magic numbers in test-gc-http-client-onerror\n\nRemove magic numbers (500, 10, 100) from the test. Instead, detect when\nGC has started and stop sending requests at that point.\n\nOn my laptop, this results in 16 or 20 requests per run instead of 500.\n\nFixes: https://github.com/nodejs/node/issues/23089\n\nPR-URL: https://github.com/nodejs/node/pull/24943\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "47ecf2060343705a26eaa7f7d0be242cb6d84cf8",
    "files": [
        {
            "sha": "30b272ed94aae93fe1d3249574fdaba2e679b757",
            "filename": "test/parallel/test-gc-http-client-onerror.js",
            "status": "modified",
            "additions": 30,
            "deletions": 23,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/47ecf2060343705a26eaa7f7d0be242cb6d84cf8/test%2Fparallel%2Ftest-gc-http-client-onerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/47ecf2060343705a26eaa7f7d0be242cb6d84cf8/test%2Fparallel%2Ftest-gc-http-client-onerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client-onerror.js?ref=47ecf2060343705a26eaa7f7d0be242cb6d84cf8",
            "patch": "@@ -6,45 +6,44 @@\n const common = require('../common');\n const onGC = require('../common/ongc');\n \n+const cpus = require('os').cpus().length;\n+\n function serverHandler(req, res) {\n   req.resume();\n   res.writeHead(200, { 'Content-Type': 'text/plain' });\n   res.end('Hello World\\n');\n }\n \n const http = require('http');\n-const todo = 500;\n+let createClients = true;\n let done = 0;\n let count = 0;\n let countGC = 0;\n \n-console.log(`We should do ${todo} requests`);\n-\n const server = http.createServer(serverHandler);\n server.listen(0, common.mustCall(() => {\n-  for (let i = 0; i < 10; i++)\n-    getall();\n+  for (let i = 0; i < cpus; i++)\n+    getAll();\n }));\n \n-function getall() {\n-  if (count >= todo)\n-    return;\n-\n-  const req = http.get({\n-    hostname: 'localhost',\n-    pathname: '/',\n-    port: server.address().port\n-  }, cb).on('error', onerror);\n+function getAll() {\n+  if (createClients) {\n+    const req = http.get({\n+      hostname: 'localhost',\n+      pathname: '/',\n+      port: server.address().port\n+    }, cb).on('error', onerror);\n \n-  count++;\n-  onGC(req, { ongc });\n+    count++;\n+    onGC(req, { ongc });\n \n-  setImmediate(getall);\n+    setImmediate(getAll);\n+  }\n }\n \n function cb(res) {\n   res.resume();\n-  done += 1;\n+  done++;\n }\n \n function onerror(err) {\n@@ -55,11 +54,19 @@ function ongc() {\n   countGC++;\n }\n \n-setInterval(status, 100).unref();\n+setImmediate(status);\n \n function status() {\n-  global.gc();\n-  console.log('Done: %d/%d', done, todo);\n-  console.log('Collected: %d/%d', countGC, count);\n-  if (countGC === todo) server.close();\n+  if (done > 0) {\n+    createClients = false;\n+    global.gc();\n+    console.log(`done/collected/total: ${done}/${countGC}/${count}`);\n+    if (countGC === count) {\n+      server.close();\n+    } else {\n+      setImmediate(status);\n+    }\n+  } else {\n+    setImmediate(status);\n+  }\n }"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 30,
        "deletions": 23
    }
}