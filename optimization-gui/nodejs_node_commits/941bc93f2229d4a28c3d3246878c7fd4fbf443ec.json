{
    "author": "Bamieh",
    "message": "test: wrap countdown callback in common.mustCall\n\nThis adds a implicit common.mustCall to the callback provided to\nthe countdown.\n\nPR-URL: https://github.com/nodejs/node/pull/18506\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
    "files": [
        {
            "sha": "f0bbe7d13dc1ee841132a003cff1632b4788a9bd",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -380,7 +380,7 @@ Synchronous version of `spawnPwd`.\n The `Countdown` module provides a simple countdown mechanism for tests that\n require a particular action to be taken after a given number of completed\n tasks (for instance, shutting down an HTTP server after a specific number of\n-requests).\n+requests). The Countdown will fail the test if the remainder did not reach 0.\n \n <!-- eslint-disable strict, required-modules -->\n ```js"
        },
        {
            "sha": "5fcb77c4ed66a0b941a5526d07496d0f7421a066",
            "filename": "test/common/countdown.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fcommon%2Fcountdown.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fcommon%2Fcountdown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fcountdown.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -4,13 +4,14 @@\n const assert = require('assert');\n const kLimit = Symbol('limit');\n const kCallback = Symbol('callback');\n+const common = require('./');\n \n class Countdown {\n   constructor(limit, cb) {\n     assert.strictEqual(typeof limit, 'number');\n     assert.strictEqual(typeof cb, 'function');\n     this[kLimit] = limit;\n-    this[kCallback] = cb;\n+    this[kCallback] = common.mustCall(cb);\n   }\n \n   dec() {"
        },
        {
            "sha": "f3bc34a73083344367e08b060e02b8205bd5e68d",
            "filename": "test/fixtures/failcounter.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Ffixtures%2Ffailcounter.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Ffixtures%2Ffailcounter.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Ffailcounter.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -0,0 +1,2 @@\n+const Countdown = require('../common/countdown');\n+new Countdown(2, () => {});"
        },
        {
            "sha": "6a1a2f1bbce98a87341bbb7c0703ca016eed2a84",
            "filename": "test/parallel/test-common-countdown.js",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-common-countdown.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-common-countdown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-common-countdown.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -3,13 +3,31 @@\n const common = require('../common');\n const assert = require('assert');\n const Countdown = require('../common/countdown');\n+const fixtures = require('../common/fixtures');\n+const { execFile } = require('child_process');\n \n let done = '';\n-\n-const countdown = new Countdown(2, common.mustCall(() => done = true));\n+const countdown = new Countdown(2, () => done = true);\n assert.strictEqual(countdown.remaining, 2);\n countdown.dec();\n assert.strictEqual(countdown.remaining, 1);\n countdown.dec();\n assert.strictEqual(countdown.remaining, 0);\n assert.strictEqual(done, true);\n+\n+const failFixtures = [\n+  [\n+    fixtures.path('failcounter.js'),\n+    'Mismatched <anonymous> function calls. Expected exactly 1, actual 0.',\n+  ]\n+];\n+\n+for (const p of failFixtures) {\n+  const [file, expected] = p;\n+  execFile(process.argv[0], [file], common.mustCall((ex, stdout, stderr) => {\n+    assert.ok(ex);\n+    assert.strictEqual(stderr, '');\n+    const firstLine = stdout.split('\\n').shift();\n+    assert.strictEqual(firstLine, expected);\n+  }));\n+}"
        },
        {
            "sha": "d209c82083e63940e56bafbf9635bacd295e8c1f",
            "filename": "test/parallel/test-http-after-connect.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-after-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-after-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-after-connect.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -32,7 +32,7 @@ const server = http.createServer(common.mustCall((req, res) => {\n   setTimeout(() => res.end(req.url), 50);\n }, 2));\n \n-const countdown = new Countdown(2, common.mustCall(() => server.close()));\n+const countdown = new Countdown(2, () => server.close());\n \n server.on('connect', common.mustCall((req, socket) => {\n   socket.write('HTTP/1.1 200 Connection established\\r\\n\\r\\n');"
        },
        {
            "sha": "39f4ebef5374c1c98691469a3658cdb7a522a63d",
            "filename": "test/parallel/test-http-agent-destroyed-socket.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -80,7 +80,7 @@ const server = http.createServer(common.mustCall((req, res) => {\n     assert(request1.socket.destroyed);\n     // assert not reusing the same socket, since it was destroyed.\n     assert.notStrictEqual(request1.socket, request2.socket);\n-    const countdown = new Countdown(2, common.mustCall(() => server.close()));\n+    const countdown = new Countdown(2, () => server.close());\n     request2.socket.on('close', common.mustCall(() => countdown.dec()));\n     response.on('end', common.mustCall(() => countdown.dec()));\n     response.resume();"
        },
        {
            "sha": "eb1c95d5200694d05c8bd3869cba21ca515395f9",
            "filename": "test/parallel/test-http-agent-maxsockets-regress-4050.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-maxsockets-regress-4050.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-maxsockets-regress-4050.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-maxsockets-regress-4050.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -17,7 +17,7 @@ const server = http.createServer(common.mustCall((req, res) => {\n   res.end('hello world');\n }, 6));\n \n-const countdown = new Countdown(6, common.mustCall(() => server.close()));\n+const countdown = new Countdown(6, () => server.close());\n \n function get(path, callback) {\n   return http.get({"
        },
        {
            "sha": "267f820e0435ebe080e65271210aebe0766ef6e3",
            "filename": "test/parallel/test-http-agent-maxsockets.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-maxsockets.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-agent-maxsockets.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-maxsockets.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -26,13 +26,13 @@ function get(path, callback) {\n   }, callback);\n }\n \n-const countdown = new Countdown(2, common.mustCall(() => {\n+const countdown = new Countdown(2, () => {\n   const freepool = agent.freeSockets[Object.keys(agent.freeSockets)[0]];\n   assert.strictEqual(freepool.length, 2,\n                      `expect keep 2 free sockets, but got ${freepool.length}`);\n   agent.destroy();\n   server.close();\n-}));\n+});\n \n function dec() {\n   process.nextTick(() => countdown.dec());"
        },
        {
            "sha": "f767189ea9d5933f1063df09911cb1989d953d04",
            "filename": "test/parallel/test-http-client-abort.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-client-abort.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-client-abort.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-abort.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -26,7 +26,7 @@ const Countdown = require('../common/countdown');\n \n const N = 8;\n \n-const countdown = new Countdown(N, common.mustCall(() => server.close()));\n+const countdown = new Countdown(N, () => server.close());\n \n const server = http.Server(common.mustCall((req, res) => {\n   res.writeHead(200);\n@@ -37,9 +37,9 @@ const server = http.Server(common.mustCall((req, res) => {\n server.listen(0, common.mustCall(() => {\n \n   const requests = [];\n-  const reqCountdown = new Countdown(N, common.mustCall(() => {\n+  const reqCountdown = new Countdown(N, () => {\n     requests.forEach((req) => req.abort());\n-  }));\n+  });\n \n   const options = { port: server.address().port };\n "
        },
        {
            "sha": "cb4e3ff08434dd1ae78f513a3115fb8b712d5f64",
            "filename": "test/parallel/test-http-client-parse-error.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-client-parse-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-client-parse-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-parse-error.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -25,7 +25,7 @@ const http = require('http');\n const net = require('net');\n const Countdown = require('../common/countdown');\n \n-const countdown = new Countdown(2, common.mustCall(() => server.close()));\n+const countdown = new Countdown(2, () => server.close());\n \n const payloads = [\n   'HTTP/1.1 302 Object Moved\\r\\nContent-Length: 0\\r\\n\\r\\nhi world',"
        },
        {
            "sha": "03e30b67e18b57a2975be0aeb9a0f72c97c4d32b",
            "filename": "test/parallel/test-http-exceptions.js",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-exceptions.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http-exceptions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-exceptions.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -21,7 +21,12 @@\n \n 'use strict';\n require('../common');\n+const Countdown = require('../common/countdown');\n const http = require('http');\n+const NUMBER_OF_EXCEPTIONS = 4;\n+const countdown = new Countdown(NUMBER_OF_EXCEPTIONS, () => {\n+  process.exit(0);\n+});\n \n const server = http.createServer(function(req, res) {\n   intentionally_not_defined(); // eslint-disable-line no-undef\n@@ -30,16 +35,16 @@ const server = http.createServer(function(req, res) {\n   res.end();\n });\n \n+function onUncaughtException(err) {\n+  console.log(`Caught an exception: ${err}`);\n+  if (err.name === 'AssertionError') throw err;\n+  countdown.dec();\n+}\n+\n+process.on('uncaughtException', onUncaughtException);\n+\n server.listen(0, function() {\n-  for (let i = 0; i < 4; i += 1) {\n+  for (let i = 0; i < NUMBER_OF_EXCEPTIONS; i += 1) {\n     http.get({ port: this.address().port, path: `/busy/${i}` });\n   }\n });\n-\n-let exception_count = 0;\n-\n-process.on('uncaughtException', function(err) {\n-  console.log(`Caught an exception: ${err}`);\n-  if (err.name === 'AssertionError') throw err;\n-  if (++exception_count === 4) process.exit(0);\n-});"
        },
        {
            "sha": "ff0c8baa14ccdb1d29f7644a04d43098dd3c6d47",
            "filename": "test/parallel/test-http2-no-more-streams.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http2-no-more-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http2-no-more-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-no-more-streams.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -23,10 +23,10 @@ server.listen(0, common.mustCall(() => {\n \n     assert.strictEqual(client.state.nextStreamID, nextID);\n \n-    const countdown = new Countdown(2, common.mustCall(() => {\n+    const countdown = new Countdown(2, () => {\n       server.close();\n       client.close();\n-    }));\n+    });\n \n     {\n       // This one will be ok"
        },
        {
            "sha": "4b59a5ebe859bc851a2877f1aaabfa338902e5ac",
            "filename": "test/parallel/test-http2-server-rst-stream.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-rst-stream.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -32,10 +32,10 @@ server.on('stream', (stream, headers) => {\n server.listen(0, common.mustCall(() => {\n   const client = http2.connect(`http://localhost:${server.address().port}`);\n \n-  const countdown = new Countdown(tests.length, common.mustCall(() => {\n+  const countdown = new Countdown(tests.length, () => {\n     client.close();\n     server.close();\n-  }));\n+  });\n \n   tests.forEach((test) => {\n     const req = client.request({"
        },
        {
            "sha": "2a6299952271e170ff65672605131b8ecdaaebf2",
            "filename": "test/parallel/test-performanceobserver.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-performanceobserver.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-performanceobserver.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performanceobserver.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -65,10 +65,10 @@ assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n     new PerformanceObserver(common.mustCall(callback, 3));\n \n   const countdown =\n-    new Countdown(3, common.mustCall(() => {\n+    new Countdown(3, () => {\n       observer.disconnect();\n       assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n-    }));\n+    });\n \n   function callback(list, obs) {\n     assert.strictEqual(obs, observer);"
        },
        {
            "sha": "5dceb386fdbdf4486e4fc9664995ae2171c3606a",
            "filename": "test/parallel/test-timers-socket-timeout-removes-other-socket-unref-timer.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-timers-socket-timeout-removes-other-socket-unref-timer.js",
            "raw_url": "https://github.com/nodejs/node/raw/941bc93f2229d4a28c3d3246878c7fd4fbf443ec/test%2Fparallel%2Ftest-timers-socket-timeout-removes-other-socket-unref-timer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-socket-timeout-removes-other-socket-unref-timer.js?ref=941bc93f2229d4a28c3d3246878c7fd4fbf443ec",
            "patch": "@@ -33,7 +33,7 @@ const server = net.createServer(function onClient(client) {\n });\n \n server.listen(0, common.localhostIPv4, common.mustCall(() => {\n-  const countdown = new Countdown(2, common.mustCall(() => server.close()));\n+  const countdown = new Countdown(2, () => server.close());\n \n   {\n     const client = net.connect({ port: server.address().port });"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 55,
        "deletions": 29
    }
}