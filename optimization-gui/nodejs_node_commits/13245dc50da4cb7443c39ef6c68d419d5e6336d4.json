{
    "author": "addaleax",
    "message": "fs: improve fs.watch ENOSPC error message\n\nProviding `No space left on device` is misleading in this case.\nReplace it with something that describes it more accurately.\n\nRefs: https://stackoverflow.com/questions/22475849/node-js-error-enospc/32600959\n\nPR-URL: https://github.com/nodejs/node/pull/21846\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "13245dc50da4cb7443c39ef6c68d419d5e6336d4",
    "files": [
        {
            "sha": "750c18bcd8bf2ce80e90b42edb9847349f4d3ccf",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/13245dc50da4cb7443c39ef6c68d419d5e6336d4/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/13245dc50da4cb7443c39ef6c68d419d5e6336d4/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=13245dc50da4cb7443c39ef6c68d419d5e6336d4",
            "patch": "@@ -249,7 +249,7 @@ function getMessage(key, args) {\n  */\n function uvException(ctx) {\n   const [ code, uvmsg ] = errmap.get(ctx.errno);\n-  let message = `${code}: ${uvmsg}, ${ctx.syscall}`;\n+  let message = `${code}: ${ctx.message || uvmsg}, ${ctx.syscall}`;\n \n   let path;\n   let dest;"
        },
        {
            "sha": "758fb4e69285ba9499cbb9a78528701380912ae9",
            "filename": "lib/internal/fs/watchers.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/13245dc50da4cb7443c39ef6c68d419d5e6336d4/lib%2Finternal%2Ffs%2Fwatchers.js",
            "raw_url": "https://github.com/nodejs/node/raw/13245dc50da4cb7443c39ef6c68d419d5e6336d4/lib%2Finternal%2Ffs%2Fwatchers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fwatchers.js?ref=13245dc50da4cb7443c39ef6c68d419d5e6336d4",
            "patch": "@@ -7,6 +7,7 @@ const {\n   StatWatcher: _StatWatcher\n } = process.binding('fs');\n const { FSEvent } = internalBinding('fs_event_wrap');\n+const { UV_ENOSPC } = internalBinding('uv');\n const { EventEmitter } = require('events');\n const {\n   getStatsFromBinding,\n@@ -165,7 +166,9 @@ FSWatcher.prototype.start = function(filename,\n     const error = errors.uvException({\n       errno: err,\n       syscall: 'watch',\n-      path: filename\n+      path: filename,\n+      message: err === UV_ENOSPC ?\n+        'System limit for number of file watchers reached' : ''\n     });\n     error.filename = filename;\n     throw error;"
        },
        {
            "sha": "f7af3be86c29f4996da144a122ae8a5bd57df3ae",
            "filename": "test/sequential/test-fs-watch-system-limit.js",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/13245dc50da4cb7443c39ef6c68d419d5e6336d4/test%2Fsequential%2Ftest-fs-watch-system-limit.js",
            "raw_url": "https://github.com/nodejs/node/raw/13245dc50da4cb7443c39ef6c68d419d5e6336d4/test%2Fsequential%2Ftest-fs-watch-system-limit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-fs-watch-system-limit.js?ref=13245dc50da4cb7443c39ef6c68d419d5e6336d4",
            "patch": "@@ -0,0 +1,51 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const child_process = require('child_process');\n+const stream = require('stream');\n+\n+if (!common.isLinux)\n+  common.skip('The fs watch limit is OS-dependent');\n+if (!common.enoughTestCpu)\n+  common.skip('This test is resource-intensive');\n+\n+const processes = [];\n+const gatherStderr = new stream.PassThrough();\n+gatherStderr.setEncoding('utf8');\n+gatherStderr.setMaxListeners(Infinity);\n+\n+let finished = false;\n+function spawnProcesses() {\n+  for (let i = 0; i < 10; ++i) {\n+    const proc = child_process.spawn(\n+      process.execPath,\n+      [ '-e',\n+        `process.chdir(${JSON.stringify(__dirname)});\n+        for (const file of fs.readdirSync('.'))\n+          fs.watch(file, () => {});`\n+      ], { stdio: ['inherit', 'inherit', 'pipe'] });\n+    proc.stderr.pipe(gatherStderr);\n+    processes.push(proc);\n+  }\n+\n+  setTimeout(() => {\n+    if (!finished && processes.length < 200)\n+      spawnProcesses();\n+  }, 100);\n+}\n+\n+spawnProcesses();\n+\n+let accumulated = '';\n+gatherStderr.on('data', common.mustCallAtLeast((chunk) => {\n+  accumulated += chunk;\n+  if (accumulated.includes('Error:') && !finished) {\n+    assert(\n+      accumulated.includes('ENOSPC: System limit for number ' +\n+                           'of file watchers reached'),\n+      accumulated);\n+    console.log(`done after ${processes.length} processes, cleaning up`);\n+    finished = true;\n+    processes.forEach((proc) => proc.kill());\n+  }\n+}, 1));"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 56,
        "deletions": 2
    }
}