{
    "author": "GeoffreyBooth",
    "message": "module: support multi-dot file extension\n\nSupport multi-dot file extensions like '.coffee.md' in Module.load.\n\nPR-URL: https://github.com/nodejs/node/pull/23416\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>",
    "sha": "22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668",
    "files": [
        {
            "sha": "4a5fc596c0511d87fe410e3e770db73ccecf190b",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668",
            "patch": "@@ -219,6 +219,22 @@ function tryExtensions(p, exts, isMain) {\n   return false;\n }\n \n+// find the longest (possibly multi-dot) extension registered in\n+// Module._extensions\n+function findLongestRegisteredExtension(filename) {\n+  const name = path.basename(filename);\n+  let currentExtension;\n+  let index;\n+  let startIndex = 0;\n+  while ((index = name.indexOf('.', startIndex)) !== -1) {\n+    startIndex = index + 1;\n+    if (index === 0) continue; // Skip dotfiles like .gitignore\n+    currentExtension = name.slice(index);\n+    if (Module._extensions[currentExtension]) return currentExtension;\n+  }\n+  return '.js';\n+}\n+\n var warned = false;\n Module._findPath = function(request, paths, isMain) {\n   if (path.isAbsolute(request)) {\n@@ -600,8 +616,7 @@ Module.prototype.load = function(filename) {\n   this.filename = filename;\n   this.paths = Module._nodeModulePaths(path.dirname(filename));\n \n-  var extension = path.extname(filename) || '.js';\n-  if (!Module._extensions[extension]) extension = '.js';\n+  var extension = findLongestRegisteredExtension(filename);\n   Module._extensions[extension](this, filename);\n   this.loaded = true;\n "
        },
        {
            "sha": "3a51e8725eec60ab196c43e8b94b8deaf4468156",
            "filename": "test/known_issues/test-module-deleted-extensions.js",
            "status": "removed",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/a03165a5fd5ab0325eec506e346f6ec5db46780d/test%2Fknown_issues%2Ftest-module-deleted-extensions.js",
            "raw_url": "https://github.com/nodejs/node/raw/a03165a5fd5ab0325eec506e346f6ec5db46780d/test%2Fknown_issues%2Ftest-module-deleted-extensions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-module-deleted-extensions.js?ref=a03165a5fd5ab0325eec506e346f6ec5db46780d",
            "patch": "@@ -1,18 +0,0 @@\n-'use strict';\n-// Refs: https://github.com/nodejs/node/issues/4778\n-const common = require('../common');\n-const assert = require('assert');\n-const fs = require('fs');\n-const path = require('path');\n-const tmpdir = require('../common/tmpdir');\n-const file = path.join(tmpdir.path, 'test-extensions.foo.bar');\n-\n-tmpdir.refresh();\n-fs.writeFileSync(file, '', 'utf8');\n-require.extensions['.foo.bar'] = (module, path) => {};\n-delete require.extensions['.foo.bar'];\n-require.extensions['.bar'] = common.mustCall((module, path) => {\n-  assert.strictEqual(module.id, file);\n-  assert.strictEqual(path, file);\n-});\n-require(path.join(tmpdir.path, 'test-extensions'));"
        },
        {
            "sha": "be17bc5d0255081374cb8a2b3f99bbdbb17df4a2",
            "filename": "test/parallel/test-module-multi-extensions.js",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/nodejs/node/blob/22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668/test%2Fparallel%2Ftest-module-multi-extensions.js",
            "raw_url": "https://github.com/nodejs/node/raw/22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668/test%2Fparallel%2Ftest-module-multi-extensions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-multi-extensions.js?ref=22f7d0a4bdf4e33cfb85be1f341b1f8cadf1b668",
            "patch": "@@ -0,0 +1,94 @@\n+'use strict';\n+\n+// Refs: https://github.com/nodejs/node/issues/4778\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+const Module = require('module');\n+const tmpdir = require('../common/tmpdir');\n+const file = path.join(tmpdir.path, 'test-extensions.foo.bar');\n+const dotfile = path.join(tmpdir.path, '.bar');\n+const dotfileWithExtension = path.join(tmpdir.path, '.foo.bar');\n+\n+tmpdir.refresh();\n+fs.writeFileSync(file, 'console.log(__filename);', 'utf8');\n+fs.writeFileSync(dotfile, 'console.log(__filename);', 'utf8');\n+fs.writeFileSync(dotfileWithExtension, 'console.log(__filename);', 'utf8');\n+\n+{\n+  require.extensions['.bar'] = common.mustNotCall();\n+  require.extensions['.foo.bar'] = common.mustCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  require(modulePath);\n+  require(file);\n+  delete require.cache[file];\n+  delete require.extensions['.bar'];\n+  delete require.extensions['.foo.bar'];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  require.extensions['.foo.bar'] = common.mustCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  require(modulePath);\n+  assert.throws(\n+    () => require(`${modulePath}.foo`),\n+    new Error(`Cannot find module '${modulePath}.foo'`)\n+  );\n+  require(`${modulePath}.foo.bar`);\n+  delete require.cache[file];\n+  delete require.extensions['.foo.bar'];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  const modulePath = path.join(tmpdir.path, 'test-extensions');\n+  assert.throws(\n+    () => require(modulePath),\n+    new Error(`Cannot find module '${modulePath}'`)\n+  );\n+  delete require.cache[file];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  require.extensions['.bar'] = common.mustNotCall();\n+  require.extensions['.foo.bar'] = common.mustCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions.foo');\n+  require(modulePath);\n+  delete require.cache[file];\n+  delete require.extensions['.bar'];\n+  delete require.extensions['.foo.bar'];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  require.extensions['.foo.bar'] = common.mustNotCall();\n+  const modulePath = path.join(tmpdir.path, 'test-extensions.foo');\n+  assert.throws(\n+    () => require(modulePath),\n+    new Error(`Cannot find module '${modulePath}'`)\n+  );\n+  delete require.extensions['.foo.bar'];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  require.extensions['.bar'] = common.mustNotCall();\n+  require(dotfile);\n+  delete require.cache[dotfile];\n+  delete require.extensions['.bar'];\n+  Module._pathCache = Object.create(null);\n+}\n+\n+{\n+  require.extensions['.bar'] = common.mustCall();\n+  require.extensions['.foo.bar'] = common.mustNotCall();\n+  require(dotfileWithExtension);\n+  delete require.cache[dotfileWithExtension];\n+  delete require.extensions['.bar'];\n+  delete require.extensions['.foo.bar'];\n+  Module._pathCache = Object.create(null);\n+}"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 111,
        "deletions": 20
    }
}