{
    "author": "jasnell",
    "message": "http2: some general code improvements\n\nPR-URL: https://github.com/nodejs/node/pull/19400\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "d74184c2fa356a0f1cda99803d26a768f23a18bf",
    "files": [
        {
            "sha": "523fda730d2a4aefdfd1b09042efa24f64b238a5",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 49,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/d74184c2fa356a0f1cda99803d26a768f23a18bf/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d74184c2fa356a0f1cda99803d26a768f23a18bf/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=d74184c2fa356a0f1cda99803d26a768f23a18bf",
            "patch": "@@ -595,9 +595,8 @@ void Http2Session::Close(uint32_t code, bool socket_closed) {\n     Http2Scope h2scope(this);\n     DEBUG_HTTP2SESSION2(this, \"terminating session with code %d\", code);\n     CHECK_EQ(nghttp2_session_terminate_session(session_, code), 0);\n-  } else {\n-    if (stream_ != nullptr)\n-      stream_->RemoveStreamListener(this);\n+  } else if (stream_ != nullptr) {\n+    stream_->RemoveStreamListener(this);\n   }\n \n   // If there are outstanding pings, those will need to be canceled, do\n@@ -688,10 +687,6 @@ ssize_t Http2Session::OnCallbackPadding(size_t frameLen,\n   Local<Context> context = env()->context();\n   Context::Scope context_scope(context);\n \n-#if defined(DEBUG) && DEBUG\n-  CHECK(object()->Has(context, env()->ongetpadding_string()).FromJust());\n-#endif\n-\n   AliasedBuffer<uint32_t, v8::Uint32Array>& buffer =\n       env()->http2_state()->padding_buffer;\n   buffer[PADDING_BUF_FRAME_LENGTH] = frameLen;\n@@ -760,18 +755,14 @@ int Http2Session::OnBeginHeadersCallback(nghttp2_session* handle,\n \n   Http2Stream* stream = session->FindStream(id);\n   if (stream == nullptr) {\n-    if (session->CanAddStream()) {\n-      new Http2Stream(session, id, frame->headers.cat);\n-    } else {\n+    if (!session->CanAddStream()) {\n       // Too many concurrent streams being opened\n       nghttp2_submit_rst_stream(**session, NGHTTP2_FLAG_NONE, id,\n                                 NGHTTP2_ENHANCE_YOUR_CALM);\n       return NGHTTP2_ERR_TEMPORAL_CALLBACK_FAILURE;\n     }\n-  } else {\n-    // If the stream has already been destroyed, ignore.\n-    if (stream->IsDestroyed())\n-      return 0;\n+    new Http2Stream(session, id, frame->headers.cat);\n+  } else if (!stream->IsDestroyed()) {\n     stream->StartHeaders(frame->headers.cat);\n   }\n   return 0;\n@@ -791,9 +782,7 @@ int Http2Session::OnHeaderCallback(nghttp2_session* handle,\n   Http2Stream* stream = session->FindStream(id);\n   CHECK_NE(stream, nullptr);\n   // If the stream has already been destroyed, ignore.\n-  if (stream->IsDestroyed())\n-    return 0;\n-  if (!stream->AddHeader(name, value, flags)) {\n+  if (!stream->IsDestroyed() && !stream->AddHeader(name, value, flags)) {\n     // This will only happen if the connected peer sends us more\n     // than the allowed number of header items at any given time\n     stream->SubmitRstStream(NGHTTP2_ENHANCE_YOUR_CALM);\n@@ -859,11 +848,8 @@ int Http2Session::OnInvalidFrame(nghttp2_session* handle,\n     HandleScope scope(isolate);\n     Local<Context> context = env->context();\n     Context::Scope context_scope(context);\n-\n-    Local<Value> argv[1] = {\n-      Integer::New(isolate, lib_error_code),\n-    };\n-    session->MakeCallback(env->error_string(), arraysize(argv), argv);\n+    Local<Value> arg = Integer::New(isolate, lib_error_code);\n+    session->MakeCallback(env->error_string(), 1, &arg);\n   }\n   return 0;\n }\n@@ -1071,11 +1057,8 @@ int Http2Session::OnNghttpError(nghttp2_session* handle,\n     HandleScope scope(isolate);\n     Local<Context> context = env->context();\n     Context::Scope context_scope(context);\n-\n-    Local<Value> argv[1] = {\n-      Integer::New(isolate, NGHTTP2_ERR_PROTO),\n-    };\n-    session->MakeCallback(env->error_string(), arraysize(argv), argv);\n+    Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n+    session->MakeCallback(env->error_string(), 1, &arg);\n   }\n   return 0;\n }\n@@ -1247,13 +1230,8 @@ void Http2Session::HandleDataFrame(const nghttp2_frame* frame) {\n   DEBUG_HTTP2SESSION2(this, \"handling data frame for stream %d\", id);\n   Http2Stream* stream = FindStream(id);\n \n-  // If the stream has already been destroyed, do nothing\n-  if (stream->IsDestroyed())\n-    return;\n-\n-  if (frame->hd.flags & NGHTTP2_FLAG_END_STREAM) {\n+  if (!stream->IsDestroyed() && frame->hd.flags & NGHTTP2_FLAG_END_STREAM)\n     stream->EmitRead(UV_EOF);\n-  }\n }\n \n \n@@ -1328,11 +1306,8 @@ void Http2Session::HandlePingFrame(const nghttp2_frame* frame) {\n       HandleScope scope(isolate);\n       Local<Context> context = env()->context();\n       Context::Scope context_scope(context);\n-\n-      Local<Value> argv[1] = {\n-        Integer::New(isolate, NGHTTP2_ERR_PROTO),\n-      };\n-      MakeCallback(env()->error_string(), arraysize(argv), argv);\n+      Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n+      MakeCallback(env()->error_string(), 1, &arg);\n     }\n   }\n }\n@@ -1360,11 +1335,8 @@ void Http2Session::HandleSettingsFrame(const nghttp2_frame* frame) {\n       HandleScope scope(isolate);\n       Local<Context> context = env()->context();\n       Context::Scope context_scope(context);\n-\n-      Local<Value> argv[1] = {\n-        Integer::New(isolate, NGHTTP2_ERR_PROTO),\n-      };\n-      MakeCallback(env()->error_string(), arraysize(argv), argv);\n+      Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n+      MakeCallback(env()->error_string(), 1, &arg);\n     }\n   } else {\n     // Otherwise, notify the session about a new settings\n@@ -1787,7 +1759,7 @@ int Http2Stream::DoShutdown(ShutdownWrap* req_wrap) {\n   {\n     Http2Scope h2scope(this);\n     flags_ |= NGHTTP2_STREAM_FLAG_SHUT;\n-    CHECK_NE(nghttp2_session_resume_data(session_->session(), id_),\n+    CHECK_NE(nghttp2_session_resume_data(**session_, id_),\n              NGHTTP2_ERR_NOMEM);\n     DEBUG_HTTP2STREAM(this, \"writable side shutdown\");\n   }\n@@ -1848,7 +1820,7 @@ int Http2Stream::SubmitResponse(nghttp2_nv* nva, size_t len, int options) {\n     options |= STREAM_OPTION_EMPTY_PAYLOAD;\n \n   Http2Stream::Provider::Stream prov(this, options);\n-  int ret = nghttp2_submit_response(session_->session(), id_, nva, len, *prov);\n+  int ret = nghttp2_submit_response(**session_, id_, nva, len, *prov);\n   CHECK_NE(ret, NGHTTP2_ERR_NOMEM);\n   return ret;\n }\n@@ -1859,7 +1831,7 @@ int Http2Stream::SubmitInfo(nghttp2_nv* nva, size_t len) {\n   CHECK(!this->IsDestroyed());\n   Http2Scope h2scope(this);\n   DEBUG_HTTP2STREAM2(this, \"sending %d informational headers\", len);\n-  int ret = nghttp2_submit_headers(session_->session(),\n+  int ret = nghttp2_submit_headers(**session_,\n                                    NGHTTP2_FLAG_NONE,\n                                    id_, nullptr,\n                                    nva, len, nullptr);\n@@ -1874,9 +1846,9 @@ int Http2Stream::SubmitPriority(nghttp2_priority_spec* prispec,\n   Http2Scope h2scope(this);\n   DEBUG_HTTP2STREAM(this, \"sending priority spec\");\n   int ret = silent ?\n-      nghttp2_session_change_stream_priority(session_->session(),\n+      nghttp2_session_change_stream_priority(**session_,\n                                              id_, prispec) :\n-      nghttp2_submit_priority(session_->session(),\n+      nghttp2_submit_priority(**session_,\n                               NGHTTP2_FLAG_NONE,\n                               id_, prispec);\n   CHECK_NE(ret, NGHTTP2_ERR_NOMEM);\n@@ -1926,7 +1898,7 @@ int Http2Stream::ReadStart() {\n \n   // Tell nghttp2 about our consumption of the data that was handed\n   // off to JS land.\n-  nghttp2_session_consume_stream(session_->session(),\n+  nghttp2_session_consume_stream(**session_,\n                                  id_,\n                                  inbound_consumed_data_while_paused_);\n   inbound_consumed_data_while_paused_ = 0;"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 21,
        "deletions": 49
    }
}