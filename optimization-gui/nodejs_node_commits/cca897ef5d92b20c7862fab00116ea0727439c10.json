{
    "author": "addaleax",
    "message": "inspector,vm: remove --eval wrapper\n\nReport the actual source code when running with `--eval` and\n`--inspect-brk`, by telling the vm module to break on the\nfirst line of the script being executed rather than wrapping\nthe source code in a function.\n\nPR-URL: https://github.com/nodejs/node/pull/25832\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "cca897ef5d92b20c7862fab00116ea0727439c10",
    "files": [
        {
            "sha": "a35feaacce28ff3b0cd05d9febc9206165c01f2e",
            "filename": "lib/internal/process/execution.js",
            "status": "modified",
            "additions": 17,
            "deletions": 13,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Finternal%2Fprocess%2Fexecution.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Finternal%2Fprocess%2Fexecution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fexecution.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -33,26 +33,30 @@ function tryGetCwd() {\n   }\n }\n \n-function evalScript(name, body, breakFristLine) {\n+function evalScript(name, body, breakFirstLine) {\n   const CJSModule = require('internal/modules/cjs/loader');\n-  if (breakFristLine) {\n-    const fn = `function() {\\n\\n${body};\\n\\n}`;\n-    body = `process.binding('inspector').callAndPauseOnStart(${fn}, {})`;\n-  }\n+  const { kVmBreakFirstLineSymbol } = require('internal/util');\n \n   const cwd = tryGetCwd();\n \n   const module = new CJSModule(name);\n   module.filename = path.join(cwd, name);\n   module.paths = CJSModule._nodeModulePaths(cwd);\n-  const script = `global.__filename = ${JSON.stringify(name)};\\n` +\n-                  'global.exports = exports;\\n' +\n-                  'global.module = module;\\n' +\n-                  'global.__dirname = __dirname;\\n' +\n-                  'global.require = require;\\n' +\n-                  'return require(\"vm\").runInThisContext(' +\n-                  `${JSON.stringify(body)}, { filename: ` +\n-                  `${JSON.stringify(name)}, displayErrors: true });\\n`;\n+  global.kVmBreakFirstLineSymbol = kVmBreakFirstLineSymbol;\n+  const script = `\n+    global.__filename = ${JSON.stringify(name)};\n+    global.exports = exports;\n+    global.module = module;\n+    global.__dirname = __dirname;\n+    global.require = require;\n+    const { kVmBreakFirstLineSymbol } = global;\n+    delete global.kVmBreakFirstLineSymbol;\n+    return require(\"vm\").runInThisContext(\n+      ${JSON.stringify(body)}, {\n+        filename: ${JSON.stringify(name)},\n+        displayErrors: true,\n+        [kVmBreakFirstLineSymbol]: ${!!breakFirstLine}\n+      });\\n`;\n   const result = module._compile(script, `${name}-wrapper`);\n   if (require('internal/options').getOptionValue('--print')) {\n     console.log(result);"
        },
        {
            "sha": "b3fdff27627fa8c4f97b9fad2e03482ee92bc08a",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -418,5 +418,6 @@ module.exports = {\n   // Used by the buffer module to capture an internal reference to the\n   // default isEncoding implementation, just in case userland overrides it.\n   kIsEncodingSymbol: Symbol('kIsEncodingSymbol'),\n-  kExpandStackSymbol: Symbol('kExpandStackSymbol')\n+  kExpandStackSymbol: Symbol('kExpandStackSymbol'),\n+  kVmBreakFirstLineSymbol: Symbol('kVmBreakFirstLineSymbol')\n };"
        },
        {
            "sha": "b2875d1e1134d8c15550bb52c4d31d636e947cec",
            "filename": "lib/vm.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Fvm.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/lib%2Fvm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fvm.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -38,6 +38,7 @@ const {\n   validateUint32,\n   validateString\n } = require('internal/validators');\n+const { kVmBreakFirstLineSymbol } = require('internal/util');\n const kParsingContext = Symbol('script parsing context');\n \n const ArrayForEach = Function.call.bind(Array.prototype.forEach);\n@@ -175,7 +176,8 @@ function getRunInContextArgs(options = {}) {\n \n   const {\n     displayErrors = true,\n-    breakOnSigint = false\n+    breakOnSigint = false,\n+    [kVmBreakFirstLineSymbol]: breakFirstLine = false,\n   } = options;\n \n   if (typeof displayErrors !== 'boolean') {\n@@ -189,7 +191,7 @@ function getRunInContextArgs(options = {}) {\n \n   return {\n     breakOnSigint,\n-    args: [timeout, displayErrors, breakOnSigint]\n+    args: [timeout, displayErrors, breakOnSigint, breakFirstLine]\n   };\n }\n "
        },
        {
            "sha": "952acfe06f4b85e28e4a0037eff1ad0bd9f29fca",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -795,7 +795,9 @@ void ContextifyScript::RunInThisContext(\n   TRACE_EVENT_NESTABLE_ASYNC_BEGIN0(\n       TRACING_CATEGORY_NODE2(vm, script), \"RunInThisContext\", wrapped_script);\n \n-  CHECK_EQ(args.Length(), 3);\n+  // TODO(addaleax): Use an options object or otherwise merge this with\n+  // RunInContext().\n+  CHECK_EQ(args.Length(), 4);\n \n   CHECK(args[0]->IsNumber());\n   int64_t timeout = args[0]->IntegerValue(env->context()).FromJust();\n@@ -806,8 +808,16 @@ void ContextifyScript::RunInThisContext(\n   CHECK(args[2]->IsBoolean());\n   bool break_on_sigint = args[2]->IsTrue();\n \n+  CHECK(args[3]->IsBoolean());\n+  bool break_on_first_line = args[3]->IsTrue();\n+\n   // Do the eval within this context\n-  EvalMachine(env, timeout, display_errors, break_on_sigint, args);\n+  EvalMachine(env,\n+              timeout,\n+              display_errors,\n+              break_on_sigint,\n+              break_on_first_line,\n+              args);\n \n   TRACE_EVENT_NESTABLE_ASYNC_END0(\n       TRACING_CATEGORY_NODE2(vm, script), \"RunInThisContext\", wrapped_script);\n@@ -819,7 +829,7 @@ void ContextifyScript::RunInContext(const FunctionCallbackInfo<Value>& args) {\n   ContextifyScript* wrapped_script;\n   ASSIGN_OR_RETURN_UNWRAP(&wrapped_script, args.Holder());\n \n-  CHECK_EQ(args.Length(), 4);\n+  CHECK_EQ(args.Length(), 5);\n \n   CHECK(args[0]->IsObject());\n   Local<Object> sandbox = args[0].As<Object>();\n@@ -843,12 +853,16 @@ void ContextifyScript::RunInContext(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args[3]->IsBoolean());\n   bool break_on_sigint = args[3]->IsTrue();\n \n+  CHECK(args[4]->IsBoolean());\n+  bool break_on_first_line = args[4]->IsTrue();\n+\n   // Do the eval within the context\n   Context::Scope context_scope(contextify_context->context());\n   EvalMachine(contextify_context->env(),\n               timeout,\n               display_errors,\n               break_on_sigint,\n+              break_on_first_line,\n               args);\n \n   TRACE_EVENT_NESTABLE_ASYNC_END0(\n@@ -859,6 +873,7 @@ bool ContextifyScript::EvalMachine(Environment* env,\n                                    const int64_t timeout,\n                                    const bool display_errors,\n                                    const bool break_on_sigint,\n+                                   const bool break_on_first_line,\n                                    const FunctionCallbackInfo<Value>& args) {\n   if (!env->can_call_into_js())\n     return false;\n@@ -874,6 +889,12 @@ bool ContextifyScript::EvalMachine(Environment* env,\n       PersistentToLocal::Default(env->isolate(), wrapped_script->script_);\n   Local<Script> script = unbound_script->BindToCurrentContext();\n \n+#if HAVE_INSPECTOR\n+  if (break_on_first_line) {\n+    env->inspector_agent()->PauseOnNextJavascriptStatement(\"Break on start\");\n+  }\n+#endif\n+\n   MaybeLocal<Value> result;\n   bool timed_out = false;\n   bool received_signal = false;"
        },
        {
            "sha": "71c4bfc0d61f5a05e2207dacf25ee9056f84bc7c",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -121,6 +121,7 @@ class ContextifyScript : public BaseObject {\n                           const int64_t timeout,\n                           const bool display_errors,\n                           const bool break_on_sigint,\n+                          const bool break_on_first_line,\n                           const v8::FunctionCallbackInfo<v8::Value>& args);\n \n   inline uint32_t id() { return id_; }"
        },
        {
            "sha": "85a612be212f1b595a2eb47c2e921f3b07b3a881",
            "filename": "test/sequential/test-inspector-async-hook-setup-at-inspect-brk.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-hook-setup-at-inspect-brk.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-hook-setup-at-inspect-brk.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-async-hook-setup-at-inspect-brk.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -14,13 +14,13 @@ setTimeout(() => {\n `;\n \n async function skipBreakpointAtStart(session) {\n-  await session.waitForBreakOnLine(3, '[eval]');\n+  await session.waitForBreakOnLine(1, '[eval]');\n   await session.send({ 'method': 'Debugger.resume' });\n }\n \n async function checkAsyncStackTrace(session) {\n   console.error('[test]', 'Verify basic properties of asyncStackTrace');\n-  const paused = await session.waitForBreakOnLine(4, '[eval]');\n+  const paused = await session.waitForBreakOnLine(2, '[eval]');\n   assert(paused.params.asyncStackTrace,\n          `${Object.keys(paused.params)} contains \"asyncStackTrace\" property`);\n   assert(paused.params.asyncStackTrace.description, 'Timeout');"
        },
        {
            "sha": "a6bbd2686cf41c5ceed9fce5f39a4aabdc9324ce",
            "filename": "test/sequential/test-inspector-async-stack-traces-promise-then.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-stack-traces-promise-then.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-stack-traces-promise-then.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-async-stack-traces-promise-then.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -31,18 +31,18 @@ async function runTests() {\n     { 'method': 'Runtime.runIfWaitingForDebugger' }\n   ]);\n \n-  await session.waitForBreakOnLine(2, '[eval]');\n+  await session.waitForBreakOnLine(0, '[eval]');\n   await session.send({ 'method': 'Debugger.resume' });\n \n   console.error('[test] Waiting for break1');\n-  debuggerPausedAt(await session.waitForBreakOnLine(6, '[eval]'),\n-                   'break1', 'runTest:5');\n+  debuggerPausedAt(await session.waitForBreakOnLine(4, '[eval]'),\n+                   'break1', 'runTest:3');\n \n   await session.send({ 'method': 'Debugger.resume' });\n \n   console.error('[test] Waiting for break2');\n-  debuggerPausedAt(await session.waitForBreakOnLine(9, '[eval]'),\n-                   'break2', 'runTest:8');\n+  debuggerPausedAt(await session.waitForBreakOnLine(7, '[eval]'),\n+                   'break2', 'runTest:6');\n \n   await session.runToCompletion();\n   assert.strictEqual((await instance.expectShutdown()).exitCode, 0);"
        },
        {
            "sha": "451cc14b1cac4c45fab21c77abbd5c1574ff7b77",
            "filename": "test/sequential/test-inspector-async-stack-traces-set-interval.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-stack-traces-set-interval.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-async-stack-traces-set-interval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-async-stack-traces-set-interval.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -10,13 +10,13 @@ const script = 'setInterval(() => { debugger; }, 50);';\n \n async function skipFirstBreakpoint(session) {\n   console.log('[test]', 'Skipping the first breakpoint in the eval script');\n-  await session.waitForBreakOnLine(2, '[eval]');\n+  await session.waitForBreakOnLine(0, '[eval]');\n   await session.send({ 'method': 'Debugger.resume' });\n }\n \n async function checkAsyncStackTrace(session) {\n   console.error('[test]', 'Verify basic properties of asyncStackTrace');\n-  const paused = await session.waitForBreakOnLine(2, '[eval]');\n+  const paused = await session.waitForBreakOnLine(0, '[eval]');\n   assert(paused.params.asyncStackTrace,\n          `${Object.keys(paused.params)} contains \"asyncStackTrace\" property`);\n   assert(paused.params.asyncStackTrace.description, 'Timeout');"
        },
        {
            "sha": "6d4fbbb474ecfdcc6bb75902079183070e8c579e",
            "filename": "test/sequential/test-inspector-break-e.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-break-e.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-break-e.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-break-e.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -14,7 +14,7 @@ async function runTests() {\n     { 'method': 'Debugger.enable' },\n     { 'method': 'Runtime.runIfWaitingForDebugger' }\n   ]);\n-  await session.waitForBreakOnLine(2, '[eval]');\n+  await session.waitForBreakOnLine(0, '[eval]');\n   await session.runToCompletion();\n   assert.strictEqual((await instance.expectShutdown()).exitCode, 0);\n }"
        },
        {
            "sha": "944829f59d6b952626e3521e87a39cae8ac8ba47",
            "filename": "test/sequential/test-inspector-scriptparsed-context.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-scriptparsed-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/cca897ef5d92b20c7862fab00116ea0727439c10/test%2Fsequential%2Ftest-inspector-scriptparsed-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-scriptparsed-context.js?ref=cca897ef5d92b20c7862fab00116ea0727439c10",
            "patch": "@@ -51,28 +51,28 @@ async function runTests() {\n     { 'method': 'Debugger.enable' },\n     { 'method': 'Runtime.runIfWaitingForDebugger' }\n   ]);\n-  await session.waitForBreakOnLine(4, '[eval]');\n+  await session.waitForBreakOnLine(2, '[eval]');\n \n   await session.send({ 'method': 'Runtime.enable' });\n   await getContext(session);\n   await session.send({ 'method': 'Debugger.resume' });\n   const childContext = await getContext(session);\n-  await session.waitForBreakOnLine(13, '[eval]');\n+  await session.waitForBreakOnLine(11, '[eval]');\n \n   console.error('[test]', 'Script is unbound');\n   await session.send({ 'method': 'Debugger.resume' });\n-  await session.waitForBreakOnLine(17, '[eval]');\n+  await session.waitForBreakOnLine(15, '[eval]');\n \n   console.error('[test]', 'vm.runInContext associates script with context');\n   await session.send({ 'method': 'Debugger.resume' });\n   await checkScriptContext(session, childContext);\n-  await session.waitForBreakOnLine(20, '[eval]');\n+  await session.waitForBreakOnLine(18, '[eval]');\n \n   console.error('[test]', 'vm.runInNewContext associates script with context');\n   await session.send({ 'method': 'Debugger.resume' });\n   const thirdContext = await getContext(session);\n   await checkScriptContext(session, thirdContext);\n-  await session.waitForBreakOnLine(23, '[eval]');\n+  await session.waitForBreakOnLine(21, '[eval]');\n \n   console.error('[test]', 'vm.runInNewContext can contain debugger statements');\n   await session.send({ 'method': 'Debugger.resume' });"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 63,
        "deletions": 34
    }
}