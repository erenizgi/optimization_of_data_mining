{
    "author": "BridgeAR",
    "message": "util: recover from maximum call stack size\n\nUsing util.inspect should still return values in case the maximum\ncall stack size is reached. This is important to inspect linked\nlists and similar.\n\nPR-URL: https://github.com/nodejs/node/pull/20725\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "b26506b95f7c9322710a884213ee61f27c28eeec",
    "files": [
        {
            "sha": "4a6988c87d0f93f8400484e5f06e87677f764416",
            "filename": "doc/api/util.md",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/b26506b95f7c9322710a884213ee61f27c28eeec/doc%2Fapi%2Futil.md",
            "raw_url": "https://github.com/nodejs/node/raw/b26506b95f7c9322710a884213ee61f27c28eeec/doc%2Fapi%2Futil.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Futil.md?ref=b26506b95f7c9322710a884213ee61f27c28eeec",
            "patch": "@@ -360,6 +360,10 @@ stream.write('With ES6');\n <!-- YAML\n added: v0.3.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/REPLACEME\n+    description: Inspecting linked lists and similar objects is now possible\n+                 up to the maximum call stack size.\n   - version: v10.0.0\n     pr-url: https://github.com/nodejs/node/pull/19259\n     description: The `WeakMap` and `WeakSet` entries can now be inspected\n@@ -388,8 +392,9 @@ changes:\n     properties will be included in the formatted result as well as [`WeakMap`][]\n     and [`WeakSet`][] entries. **Default:** `false`.\n   * `depth` {number} Specifies the number of times to recurse while formatting\n-    the `object`. This is useful for inspecting large complicated objects.\n-    To make it recurse indefinitely pass `null`. **Default:** `2`.\n+    the `object`. This is useful for inspecting large complicated objects. To\n+    make it recurse up to the maximum call stack size pass `Infinity` or `null`.\n+    **Default:** `2`.\n   * `colors` {boolean} If `true`, the output will be styled with ANSI color\n     codes. Colors are customizable, see [Customizing `util.inspect` colors][].\n     **Default:** `false`."
        },
        {
            "sha": "f24430d791f7c6e58d234e24d7f865366a64b788",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/b26506b95f7c9322710a884213ee61f27c28eeec/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/b26506b95f7c9322710a884213ee61f27c28eeec/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=b26506b95f7c9322710a884213ee61f27c28eeec",
            "patch": "@@ -701,14 +701,32 @@ function formatValue(ctx, value, recurseTimes) {\n   }\n \n   ctx.seen.push(value);\n-  const output = formatter(ctx, value, recurseTimes, keys);\n-\n+  let output;\n+  // This corresponds to a depth of at least 333 and likely 500.\n+  if (ctx.indentationLvl < 1000) {\n+    output = formatter(ctx, value, recurseTimes, keys);\n+  } else {\n+    try {\n+      output = formatter(ctx, value, recurseTimes, keys);\n+    } catch (err) {\n+      if (errors.isStackOverflowError(err)) {\n+        ctx.seen.pop();\n+        return ctx.stylize(\n+          `[${constructor || tag || 'Object'}: Inspection interrupted ` +\n+            'prematurely. Maximum call stack size exceeded.]',\n+          'special'\n+        );\n+      }\n+      throw err;\n+    }\n+  }\n   if (extra !== undefined)\n     output.unshift(extra);\n \n   for (var i = 0; i < symbols.length; i++) {\n     output.push(formatProperty(ctx, value, recurseTimes, symbols[i], 0));\n   }\n+\n   ctx.seen.pop();\n \n   return reduceToSingleString(ctx, output, base, braces);"
        },
        {
            "sha": "1f05f4987eeb418b46651f87c9de8241fd48bd24",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/b26506b95f7c9322710a884213ee61f27c28eeec/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/b26506b95f7c9322710a884213ee61f27c28eeec/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=b26506b95f7c9322710a884213ee61f27c28eeec",
            "patch": "@@ -1410,10 +1410,17 @@ util.inspect(process);\n   // Test that a long linked list can be inspected without throwing an error.\n   const list = {};\n   let head = list;\n-  // The real cutoff value is closer to 1400 stack frames as of May 2018,\n-  // but let's be generous here – even a linked listed of length 100k should be\n-  // inspectable in some way.\n+  // A linked list of length 100k should be inspectable in some way, even though\n+  // the real cutoff value is much lower than 100k.\n   for (let i = 0; i < 100000; i++)\n     head = head.next = {};\n-  util.inspect(list);\n+  assert.strictEqual(\n+    util.inspect(list),\n+    '{ next: { next: { next: [Object] } } }'\n+  );\n+  const longList = util.inspect(list, { depth: Infinity });\n+  const match = longList.match(/next/g);\n+  assert(match.length > 1000 && match.length < 10000);\n+  assert(longList.includes('[Object: Inspection interrupted ' +\n+    'prematurely. Maximum call stack size exceeded.]'));\n }"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}