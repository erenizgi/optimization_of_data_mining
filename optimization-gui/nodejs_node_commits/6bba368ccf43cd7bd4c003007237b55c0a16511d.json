{
    "author": "BridgeAR",
    "message": "util: fix sparse array inspection\n\nFor very special sparse arrays it was possible that util.inspect\nvisualized the entries not in the intended way.\n\nPR-URL: https://github.com/nodejs/node/pull/22283\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "6bba368ccf43cd7bd4c003007237b55c0a16511d",
    "files": [
        {
            "sha": "793aa3ca167db2f180cf2ac4e22a795e0ad949d8",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 18,
            "deletions": 22,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/6bba368ccf43cd7bd4c003007237b55c0a16511d/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/6bba368ccf43cd7bd4c003007237b55c0a16511d/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=6bba368ccf43cd7bd4c003007237b55c0a16511d",
            "patch": "@@ -971,33 +971,29 @@ function formatNamespaceObject(ctx, value, recurseTimes, keys) {\n function formatSpecialArray(ctx, value, recurseTimes, keys, maxLength, valLen) {\n   const output = [];\n   const keyLen = keys.length;\n-  let visibleLength = 0;\n   let i = 0;\n-  if (keyLen !== 0 && numberRegExp.test(keys[0])) {\n-    for (const key of keys) {\n-      if (visibleLength === maxLength)\n+  for (const key of keys) {\n+    if (output.length === maxLength)\n+      break;\n+    const index = +key;\n+    // Arrays can only have up to 2^32 - 1 entries\n+    if (index > 2 ** 32 - 2)\n+      break;\n+    if (`${i}` !== key) {\n+      if (!numberRegExp.test(key))\n         break;\n-      const index = +key;\n-      // Arrays can only have up to 2^32 - 1 entries\n-      if (index > 2 ** 32 - 2)\n+      const emptyItems = index - i;\n+      const ending = emptyItems > 1 ? 's' : '';\n+      const message = `<${emptyItems} empty item${ending}>`;\n+      output.push(ctx.stylize(message, 'undefined'));\n+      i = index;\n+      if (output.length === maxLength)\n         break;\n-      if (i !== index) {\n-        if (!numberRegExp.test(key))\n-          break;\n-        const emptyItems = index - i;\n-        const ending = emptyItems > 1 ? 's' : '';\n-        const message = `<${emptyItems} empty item${ending}>`;\n-        output.push(ctx.stylize(message, 'undefined'));\n-        i = index;\n-        if (++visibleLength === maxLength)\n-          break;\n-      }\n-      output.push(formatProperty(ctx, value, recurseTimes, key, 1));\n-      visibleLength++;\n-      i++;\n     }\n+    output.push(formatProperty(ctx, value, recurseTimes, key, 1));\n+    i++;\n   }\n-  if (i < valLen && visibleLength !== maxLength) {\n+  if (i < valLen && output.length !== maxLength) {\n     const len = valLen - i;\n     const ending = len > 1 ? 's' : '';\n     const message = `<${len} empty item${ending}>`;"
        },
        {
            "sha": "b7198a1023fd3844cb81b785bd5c945dd3051243",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/6bba368ccf43cd7bd4c003007237b55c0a16511d/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/6bba368ccf43cd7bd4c003007237b55c0a16511d/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=6bba368ccf43cd7bd4c003007237b55c0a16511d",
            "patch": "@@ -344,6 +344,19 @@ assert.strictEqual(\n                      \"[ <2 empty items>, '00': 1, '01': 2 ]\");\n   assert.strictEqual(util.inspect(arr2, { showHidden: true }),\n                      \"[ <2 empty items>, [length]: 2, '00': 1, '01': 2 ]\");\n+  delete arr2['00'];\n+  arr2[0] = 0;\n+  assert.strictEqual(util.inspect(arr2),\n+                     \"[ 0, <1 empty item>, '01': 2 ]\");\n+  assert.strictEqual(util.inspect(arr2, { showHidden: true }),\n+                     \"[ 0, <1 empty item>, [length]: 2, '01': 2 ]\");\n+  delete arr2['01'];\n+  arr2[2 ** 32 - 2] = 'max';\n+  arr2[2 ** 32 - 1] = 'too far';\n+  assert.strictEqual(\n+    util.inspect(arr2),\n+    \"[ 0, <4294967293 empty items>, 'max', '4294967295': 'too far' ]\"\n+  );\n \n   const arr3 = [];\n   arr3[-1] = -1;"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 31,
        "deletions": 22
    }
}