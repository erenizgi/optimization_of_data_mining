{
    "author": "tniessen",
    "message": "crypto: throw on invalid authentication tag length\n\nRefs: https://github.com/nodejs/node/issues/17523\n\nPR-URL: https://github.com/nodejs/node/pull/17825\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d81a7b4baae32efd63b8c9595c654502d64be4e3",
    "files": [
        {
            "sha": "1a1eca297b7a0765461c889147ffc43e092f51ae",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d81a7b4baae32efd63b8c9595c654502d64be4e3/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d81a7b4baae32efd63b8c9595c654502d64be4e3/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=d81a7b4baae32efd63b8c9595c654502d64be4e3",
            "patch": "@@ -2912,11 +2912,10 @@ void CipherBase::SetAuthTag(const FunctionCallbackInfo<Value>& args) {\n   const int mode = EVP_CIPHER_CTX_mode(cipher->ctx_);\n   if (mode == EVP_CIPH_GCM_MODE) {\n     if (tag_len > 16 || (tag_len < 12 && tag_len != 8 && tag_len != 4)) {\n-      char msg[125];\n+      char msg[50];\n       snprintf(msg, sizeof(msg),\n-          \"Permitting authentication tag lengths of %u bytes is deprecated. \"\n-          \"Valid GCM tag lengths are 4, 8, 12, 13, 14, 15, 16.\", tag_len);\n-      ProcessEmitDeprecationWarning(cipher->env(), msg, \"DEP0090\");\n+          \"Invalid GCM authentication tag length: %u\", tag_len);\n+      return cipher->env()->ThrowError(msg);\n     }\n   }\n "
        },
        {
            "sha": "df5ba0392395af462aa8fbd655a3168bc4d5b267",
            "filename": "test/parallel/test-crypto-authenticated.js",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/d81a7b4baae32efd63b8c9595c654502d64be4e3/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "raw_url": "https://github.com/nodejs/node/raw/d81a7b4baae32efd63b8c9595c654502d64be4e3/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-authenticated.js?ref=d81a7b4baae32efd63b8c9595c654502d64be4e3",
            "patch": "@@ -534,13 +534,8 @@ const expectedWarnings = common.hasFipsCrypto ?\n     ['Use Cipheriv for counter mode of aes-256-ccm', common.noWarnCode]\n   ];\n \n-const expectedDeprecationWarnings = [0, 1, 2, 6, 9, 10, 11, 17]\n-  .map((i) => [`Permitting authentication tag lengths of ${i} bytes is ` +\n-            'deprecated. Valid GCM tag lengths are 4, 8, 12, 13, 14, 15, 16.',\n-               'DEP0090']);\n-\n-expectedDeprecationWarnings.push(['crypto.DEFAULT_ENCODING is deprecated.',\n-                                  'DEP0091']);\n+const expectedDeprecationWarnings = ['crypto.DEFAULT_ENCODING is deprecated.',\n+                                     'DEP0091'];\n \n common.expectWarning({\n   Warning: expectedWarnings,\n@@ -719,13 +714,18 @@ for (const test of TEST_CASES) {\n }\n \n // GCM only supports specific authentication tag lengths, invalid lengths should\n-// produce warnings.\n+// throw.\n {\n-  for (const length of [0, 1, 2, 4, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17]) {\n-    const decrypt = crypto.createDecipheriv('aes-256-gcm',\n-                                            'FxLKsqdmv0E9xrQhp0b1ZgI0K7JFZJM8',\n-                                            'qkuZpJWCewa6Szih');\n-    decrypt.setAuthTag(Buffer.from('1'.repeat(length)));\n+  for (const length of [0, 1, 2, 6, 9, 10, 11, 17]) {\n+    common.expectsError(() => {\n+      const decrypt = crypto.createDecipheriv('aes-128-gcm',\n+                                              'FxLKsqdmv0E9xrQh',\n+                                              'qkuZpJWCewa6Szih');\n+      decrypt.setAuthTag(Buffer.from('1'.repeat(length)));\n+    }, {\n+      type: Error,\n+      message: `Invalid GCM authentication tag length: ${length}`\n+    });\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 16,
        "deletions": 17
    }
}