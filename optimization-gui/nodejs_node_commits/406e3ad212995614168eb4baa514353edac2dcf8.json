{
    "author": "gireeshpunathil",
    "message": "src: refactor crypto code with RAII cleanup\n\nuse more idiomatic expressions with RAII primitives,\ninstead of old style goto\n\nPR-URL: https://github.com/nodejs/node/pull/23014\n\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "406e3ad212995614168eb4baa514353edac2dcf8",
    "files": [
        {
            "sha": "4df0d934829a07d400d343dfab69d1087a118c83",
            "filename": "src/node_crypto_clienthello.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/406e3ad212995614168eb4baa514353edac2dcf8/src%2Fnode_crypto_clienthello.cc",
            "raw_url": "https://github.com/nodejs/node/raw/406e3ad212995614168eb4baa514353edac2dcf8/src%2Fnode_crypto_clienthello.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto_clienthello.cc?ref=406e3ad212995614168eb4baa514353edac2dcf8",
            "patch": "@@ -74,6 +74,12 @@ bool ClientHelloParser::ParseRecordHeader(const uint8_t* data, size_t avail) {\n \n void ClientHelloParser::ParseHeader(const uint8_t* data, size_t avail) {\n   ClientHello hello;\n+  bool failed = true;\n+\n+  OnScopeLeave cleanup([&]() {\n+    if (failed)\n+      End();\n+  });\n \n   // >= 5 + frame size bytes for frame parsing\n   if (body_offset_ + frame_len_ > avail)\n@@ -88,23 +94,23 @@ void ClientHelloParser::ParseHeader(const uint8_t* data, size_t avail) {\n   if (data[body_offset_ + 4] != 0x03 ||\n       data[body_offset_ + 5] < 0x01 ||\n       data[body_offset_ + 5] > 0x03) {\n-    goto fail;\n+    return;\n   }\n \n   if (data[body_offset_] == kClientHello) {\n     if (state_ == kTLSHeader) {\n       if (!ParseTLSClientHello(data, avail))\n-        goto fail;\n+        return;\n     } else {\n       // We couldn't get here, but whatever\n-      goto fail;\n+      return;\n     }\n \n     // Check if we overflowed (do not reply with any private data)\n     if (session_id_ == nullptr ||\n         session_size_ > 32 ||\n         session_id_ + session_size_ > data + avail) {\n-      goto fail;\n+      return;\n     }\n   }\n \n@@ -116,10 +122,8 @@ void ClientHelloParser::ParseHeader(const uint8_t* data, size_t avail) {\n   hello.servername_ = servername_;\n   hello.servername_size_ = static_cast<uint8_t>(servername_size_);\n   onhello_cb_(cb_arg_, hello);\n+  failed = false;\n   return;\n-\n- fail:\n-  End();\n }\n \n "
        }
    ],
    "stats": {
        "total": 18,
        "additions": 11,
        "deletions": 7
    }
}