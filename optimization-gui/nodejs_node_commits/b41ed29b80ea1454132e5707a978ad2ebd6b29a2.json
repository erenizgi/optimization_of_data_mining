{
    "author": "mscdex",
    "message": "stream: improve stream creation performance\n\nPR-URL: https://github.com/nodejs/node/pull/19401\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "b41ed29b80ea1454132e5707a978ad2ebd6b29a2",
    "files": [
        {
            "sha": "67187f91bd9cb128715fe7e42013291b97bbc4fd",
            "filename": "benchmark/streams/creation.js",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/benchmark%2Fstreams%2Fcreation.js",
            "raw_url": "https://github.com/nodejs/node/raw/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/benchmark%2Fstreams%2Fcreation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fstreams%2Fcreation.js?ref=b41ed29b80ea1454132e5707a978ad2ebd6b29a2",
            "patch": "@@ -0,0 +1,55 @@\n+'use strict';\n+const common = require('../common.js');\n+const Duplex = require('stream').Duplex;\n+const Readable = require('stream').Readable;\n+const Transform = require('stream').Transform;\n+const Writable = require('stream').Writable;\n+\n+const bench = common.createBenchmark(main, {\n+  n: [50e6],\n+  kind: ['duplex', 'readable', 'transform', 'writable']\n+});\n+\n+function main({ n, kind }) {\n+  var i = 0;\n+  switch (kind) {\n+    case 'duplex':\n+      new Duplex({});\n+      new Duplex();\n+\n+      bench.start();\n+      for (; i < n; ++i)\n+        new Duplex();\n+      bench.end(n);\n+      break;\n+    case 'readable':\n+      new Readable({});\n+      new Readable();\n+\n+      bench.start();\n+      for (; i < n; ++i)\n+        new Readable();\n+      bench.end(n);\n+      break;\n+    case 'writable':\n+      new Writable({});\n+      new Writable();\n+\n+      bench.start();\n+      for (; i < n; ++i)\n+        new Writable();\n+      bench.end(n);\n+      break;\n+    case 'transform':\n+      new Transform({});\n+      new Transform();\n+\n+      bench.start();\n+      for (; i < n; ++i)\n+        new Transform();\n+      bench.end(n);\n+      break;\n+    default:\n+      throw new Error('Invalid kind');\n+  }\n+}"
        },
        {
            "sha": "abfab0c8e2532161cff5c0a2e0fd63e812bcf71c",
            "filename": "benchmark/streams/transform-creation.js",
            "status": "removed",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/1c8149417a5dec9b2af056f306822b8a22a09706/benchmark%2Fstreams%2Ftransform-creation.js",
            "raw_url": "https://github.com/nodejs/node/raw/1c8149417a5dec9b2af056f306822b8a22a09706/benchmark%2Fstreams%2Ftransform-creation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fstreams%2Ftransform-creation.js?ref=1c8149417a5dec9b2af056f306822b8a22a09706",
            "patch": "@@ -1,21 +0,0 @@\n-'use strict';\n-const common = require('../common.js');\n-const Transform = require('stream').Transform;\n-const inherits = require('util').inherits;\n-\n-const bench = common.createBenchmark(main, {\n-  n: [1e6]\n-});\n-\n-function MyTransform() {\n-  Transform.call(this);\n-}\n-inherits(MyTransform, Transform);\n-MyTransform.prototype._transform = function() {};\n-\n-function main({ n }) {\n-  bench.start();\n-  for (var i = 0; i < n; ++i)\n-    new MyTransform();\n-  bench.end(n);\n-}"
        },
        {
            "sha": "434dabd88378be97b463a3959803d569e3c36268",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=b41ed29b80ea1454132e5707a978ad2ebd6b29a2",
            "patch": "@@ -64,15 +64,16 @@ function prependListener(emitter, event, fn) {\n     emitter._events[event] = [fn, emitter._events[event]];\n }\n \n-function ReadableState(options, stream) {\n+function ReadableState(options, stream, isDuplex) {\n   options = options || {};\n \n   // Duplex streams are both readable and writable, but share\n   // the same options object.\n   // However, some cases require setting options to different\n   // values for the readable and the writable sides of the duplex stream.\n   // These options can be provided separately as readableXXX and writableXXX.\n-  var isDuplex = stream instanceof Stream.Duplex;\n+  if (typeof isDuplex !== 'boolean')\n+    isDuplex = stream instanceof Stream.Duplex;\n \n   // object stream flag. Used to make read(n) ignore n and to\n   // make all the buffer merging and length checks go away\n@@ -142,7 +143,11 @@ function Readable(options) {\n   if (!(this instanceof Readable))\n     return new Readable(options);\n \n-  this._readableState = new ReadableState(options, this);\n+  // Checking for a Stream.Duplex instance is faster here instead of inside\n+  // the ReadableState constructor, at least with V8 6.5\n+  const isDuplex = (this instanceof Stream.Duplex);\n+\n+  this._readableState = new ReadableState(options, this, isDuplex);\n \n   // legacy\n   this.readable = true;"
        },
        {
            "sha": "5692cae19540080aa06afcd7f225dde033472cfc",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/b41ed29b80ea1454132e5707a978ad2ebd6b29a2/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=b41ed29b80ea1454132e5707a978ad2ebd6b29a2",
            "patch": "@@ -48,15 +48,16 @@ util.inherits(Writable, Stream);\n \n function nop() {}\n \n-function WritableState(options, stream) {\n+function WritableState(options, stream, isDuplex) {\n   options = options || {};\n \n   // Duplex streams are both readable and writable, but share\n   // the same options object.\n   // However, some cases require setting options to different\n   // values for the readable and the writable sides of the duplex stream.\n   // These options can be provided separately as readableXXX and writableXXX.\n-  var isDuplex = stream instanceof Stream.Duplex;\n+  if (typeof isDuplex !== 'boolean')\n+    isDuplex = stream instanceof Stream.Duplex;\n \n   // object stream flag to indicate whether or not this stream\n   // contains buffers or objects.\n@@ -201,12 +202,15 @@ function Writable(options) {\n   // Trying to use the custom `instanceof` for Writable here will also break the\n   // Node.js LazyTransform implementation, which has a non-trivial getter for\n   // `_writableState` that would lead to infinite recursion.\n-  if (!(realHasInstance.call(Writable, this)) &&\n-      !(this instanceof Stream.Duplex)) {\n+\n+  // Checking for a Stream.Duplex instance is faster here instead of inside\n+  // the WritableState constructor, at least with V8 6.5\n+  const isDuplex = (this instanceof Stream.Duplex);\n+\n+  if (!isDuplex && !realHasInstance.call(Writable, this))\n     return new Writable(options);\n-  }\n \n-  this._writableState = new WritableState(options, this);\n+  this._writableState = new WritableState(options, this, isDuplex);\n \n   // legacy.\n   this.writable = true;"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 73,
        "deletions": 30
    }
}