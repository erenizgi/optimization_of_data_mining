{
    "author": "starkwang",
    "message": "url: reduce deplicated codes in `autoEscapeStr`\n\nPR-URL: https://github.com/nodejs/node/pull/18613\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "3cef3e61d647d3dd2107087d876a3a02e0c3961e",
    "files": [
        {
            "sha": "83f626ccdadfe35eef31c22c4a9005954796e7ad",
            "filename": "benchmark/url/url-parse.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/3cef3e61d647d3dd2107087d876a3a02e0c3961e/benchmark%2Furl%2Furl-parse.js",
            "raw_url": "https://github.com/nodejs/node/raw/3cef3e61d647d3dd2107087d876a3a02e0c3961e/benchmark%2Furl%2Furl-parse.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Furl%2Furl-parse.js?ref=3cef3e61d647d3dd2107087d876a3a02e0c3961e",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+const common = require('../common.js');\n+const url = require('url');\n+\n+const inputs = {\n+  normal: 'http://foo.com/bar',\n+  escaped: 'https://foo.bar/{}^`/abcd'\n+};\n+\n+const bench = common.createBenchmark(main, {\n+  type: Object.keys(inputs),\n+  n: [1e7]\n+});\n+\n+function main({ type, n }) {\n+  const input = inputs[type] || '';\n+\n+  bench.start();\n+  for (var i = 0; i < n; i += 1)\n+    url.parse(input);\n+  bench.end(n);\n+}"
        },
        {
            "sha": "ab4b2b4647edd26d86a582aa23444babd00e726b",
            "filename": "lib/url.js",
            "status": "modified",
            "additions": 25,
            "deletions": 87,
            "changes": 112,
            "blob_url": "https://github.com/nodejs/node/blob/3cef3e61d647d3dd2107087d876a3a02e0c3961e/lib%2Furl.js",
            "raw_url": "https://github.com/nodejs/node/raw/3cef3e61d647d3dd2107087d876a3a02e0c3961e/lib%2Furl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Furl.js?ref=3cef3e61d647d3dd2107087d876a3a02e0c3961e",
            "patch": "@@ -439,101 +439,39 @@ function validateHostname(self, rest, hostname) {\n   }\n }\n \n+// Escaped characters. Use empty strings to fill up unused entries.\n+// Using Array is faster than Object/Map\n+const escapedCodes = [\n+  /*0 - 9*/ '', '', '', '', '', '', '', '', '', '%09',\n+  /*10 - 19*/ '%0A', '', '', '%0D', '', '', '', '', '', '',\n+  /*20 - 29*/ '', '', '', '', '', '', '', '', '', '',\n+  /*30 - 39*/ '', '', '%20', '', '%22', '', '', '', '', '%27',\n+  /*40 - 49*/ '', '', '', '', '', '', '', '', '', '',\n+  /*50 - 59*/ '', '', '', '', '', '', '', '', '', '',\n+  /*60 - 69*/ '%3C', '', '%3E', '', '', '', '', '', '', '',\n+  /*70 - 79*/ '', '', '', '', '', '', '', '', '', '',\n+  /*80 - 89*/ '', '', '', '', '', '', '', '', '', '',\n+  /*90 - 99*/ '', '', '%5C', '', '%5E', '', '%60', '', '', '',\n+  /*100 - 109*/ '', '', '', '', '', '', '', '', '', '',\n+  /*110 - 119*/ '', '', '', '', '', '', '', '', '', '',\n+  /*120 - 125*/ '', '', '', '%7B', '%7C', '%7D'\n+];\n+\n // Automatically escape all delimiters and unwise characters from RFC 2396.\n // Also escape single quotes in case of an XSS attack.\n // Return the escaped string.\n function autoEscapeStr(rest) {\n   var escaped = '';\n   var lastEscapedPos = 0;\n   for (var i = 0; i < rest.length; ++i) {\n-    // Manual switching is faster than using a Map/Object.\n     // `escaped` contains substring up to the last escaped character.\n-    switch (rest.charCodeAt(i)) {\n-      case 9:   // '\\t'\n-        // Concat if there are ordinary characters in the middle.\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%09';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 10:  // '\\n'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%0A';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 13:  // '\\r'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%0D';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 32:  // ' '\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%20';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 34:  // '\"'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%22';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 39:  // '\\''\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%27';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 60:  // '<'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%3C';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 62:  // '>'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%3E';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 92:  // '\\\\'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%5C';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 94:  // '^'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%5E';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 96:  // '`'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%60';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 123: // '{'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%7B';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 124: // '|'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%7C';\n-        lastEscapedPos = i + 1;\n-        break;\n-      case 125: // '}'\n-        if (i > lastEscapedPos)\n-          escaped += rest.slice(lastEscapedPos, i);\n-        escaped += '%7D';\n-        lastEscapedPos = i + 1;\n-        break;\n+    var escapedChar = escapedCodes[rest.charCodeAt(i)];\n+    if (escapedChar) {\n+      // Concat if there are ordinary characters in the middle.\n+      if (i > lastEscapedPos)\n+        escaped += rest.slice(lastEscapedPos, i);\n+      escaped += escapedChar;\n+      lastEscapedPos = i + 1;\n     }\n   }\n   if (lastEscapedPos === 0)  // Nothing has been escaped."
        }
    ],
    "stats": {
        "total": 134,
        "additions": 47,
        "deletions": 87
    }
}