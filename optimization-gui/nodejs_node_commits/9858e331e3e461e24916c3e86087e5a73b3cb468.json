{
    "author": "joyeecheung",
    "message": "test: initialize test/wpt to run URL and console .js tests\n\nThis patch:\n\n- Creates a new test suite `wpt` that can be used to run a subset\n  of Web Platform Tests\n- Adds a `WPTRunner` in `test/common/wpt.js` that can run the WPT\n  subset in `test/fixtures/wpt` with a vm and the WPT harness\n  while taking the status file in `test/wpt/status` into account.\n  Here we use a new format of status file (in JSON) to handle specific\n  requirements (like ICU requirements) in the tests and to handle\n  expected failures and TODOs.\n- Adds documentation on how the runner and the update automation works\n- Runs the WHATWG URL tests and the console tests with the new test\n  runner.\n\nWith this patch we eliminates the need of copy-pasting with manual\nmodifications to update a large chunk of our WPT subset previously\nmaintained in `test/parallel`. Now the tests run in `test/wpt` can\nbe automatically updated with `git node wpt` without modifications\nby the actual WPT harness instead of our home-grown mock.\n\nThere are still a few URL tests left that need to be migrated in the\nupstream to be placed in .js instead of .html - we currently still use\nthe legacy harness mock in the test files.\n\nPR-URL: https://github.com/nodejs/node/pull/24035\nRefs: https://github.com/nodejs/node/issues/23192\nReviewed-By: Daijiro Wachi <daijiro.wachi@gmail.com>",
    "sha": "9858e331e3e461e24916c3e86087e5a73b3cb468",
    "files": [
        {
            "sha": "e003341f70cf51618f003f206bd14d74a43a5e47",
            "filename": "Makefile",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -496,6 +496,9 @@ test-debug: test-build\n test-message: test-build\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) message\n \n+test-wpt: all\n+\t$(PYTHON) tools/test.py $(PARALLEL_ARGS) wpt\n+\n test-simple: | cctest bench-addons-build  # Depends on 'all'.\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) parallel sequential\n "
        },
        {
            "sha": "356c8531ec0c388b73506172c36dec8e10e9531b",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -772,12 +772,19 @@ Deletes and recreates the testing temporary directory.\n \n ## WPT Module\n \n-The wpt.js module is a port of parts of\n-[W3C testharness.js](https://github.com/w3c/testharness.js) for testing the\n-Node.js\n-[WHATWG URL API](https://nodejs.org/api/url.html#url_the_whatwg_url_api)\n-implementation with tests from\n-[W3C Web Platform Tests](https://github.com/w3c/web-platform-tests).\n+### harness\n+\n+A legacy port of [Web Platform Tests][] harness.\n+\n+See the source code for definitions. Please avoid using it in new\n+code - the current usage of this port in tests is being migrated to\n+the original WPT harness, see [the WPT tests README][].\n+\n+### Class: WPTRunner\n+\n+A driver class for running WPT with the WPT harness in a vm.\n+\n+See [the WPT tests README][] for details.\n \n \n [&lt;Array>]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array\n@@ -792,3 +799,5 @@ implementation with tests from\n [`hijackstdio.hijackStdErr()`]: #hijackstderrlistener\n [`hijackstdio.hijackStdOut()`]: #hijackstdoutlistener\n [internationalization]: https://github.com/nodejs/node/wiki/Intl\n+[Web Platform Tests]: https://github.com/web-platform-tests/wpt\n+[the WPT tests README]: ../wpt/README.md"
        },
        {
            "sha": "59dbe26d2abdcbc14ef54fb707a12c9ea7fc9f51",
            "filename": "test/common/wpt.js",
            "status": "modified",
            "additions": 426,
            "deletions": 1,
            "changes": 427,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fcommon%2Fwpt.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fcommon%2Fwpt.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fwpt.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -2,9 +2,17 @@\n 'use strict';\n \n const assert = require('assert');\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+const fs = require('fs');\n+const fsPromises = fs.promises;\n+const path = require('path');\n+const vm = require('vm');\n \n // https://github.com/w3c/testharness.js/blob/master/testharness.js\n-module.exports = {\n+// TODO: get rid of this half-baked harness in favor of the one\n+// pulled from WPT\n+const harnessMock = {\n   test: (fn, desc) => {\n     try {\n       fn();\n@@ -28,3 +36,420 @@ module.exports = {\n     assert.fail(`Reached unreachable code: ${desc}`);\n   }\n };\n+\n+class ResourceLoader {\n+  constructor(path) {\n+    this.path = path;\n+  }\n+\n+  fetch(url, asPromise = true) {\n+    // We need to patch this to load the WebIDL parser\n+    url = url.replace(\n+      '/resources/WebIDLParser.js',\n+      '/resources/webidl2/lib/webidl2.js'\n+    );\n+    const file = url.startsWith('/') ?\n+      fixtures.path('wpt', url) :\n+      fixtures.path('wpt', this.path, url);\n+    if (asPromise) {\n+      return fsPromises.readFile(file)\n+        .then((data) => {\n+          return {\n+            ok: true,\n+            json() { return JSON.parse(data.toString()); },\n+            text() { return data.toString(); }\n+          };\n+        });\n+    } else {\n+      return fs.readFileSync(file, 'utf8');\n+    }\n+  }\n+}\n+\n+class WPTTest {\n+  /**\n+   * @param {string} mod\n+   * @param {string} filename\n+   * @param {string[]} requires\n+   * @param {string | undefined} failReason\n+   * @param {string | undefined} skipReason\n+   */\n+  constructor(mod, filename, requires, failReason, skipReason) {\n+    this.module = mod; // name of the WPT module, e.g. 'url'\n+    this.filename = filename;  // name of the test file\n+    this.requires = requires;\n+    this.failReason = failReason;\n+    this.skipReason = skipReason;\n+  }\n+\n+  getAbsolutePath() {\n+    return fixtures.path('wpt', this.module, this.filename);\n+  }\n+\n+  getContent() {\n+    return fs.readFileSync(this.getAbsolutePath(), 'utf8');\n+  }\n+\n+  shouldSkip() {\n+    return this.failReason || this.skipReason;\n+  }\n+\n+  requireIntl() {\n+    return this.requires.includes('intl');\n+  }\n+}\n+\n+class StatusLoader {\n+  constructor(path) {\n+    this.path = path;\n+    this.loaded = false;\n+    this.status = null;\n+    /** @type {WPTTest[]} */\n+    this.tests = [];\n+  }\n+\n+  loadTest(file) {\n+    let requires = [];\n+    let failReason;\n+    let skipReason;\n+    if (this.status[file]) {\n+      requires = this.status[file].requires || [];\n+      failReason = this.status[file].fail;\n+      skipReason = this.status[file].skip;\n+    }\n+    return new WPTTest(this.path, file, requires,\n+                       failReason, skipReason);\n+  }\n+\n+  load() {\n+    const dir = path.join(__dirname, '..', 'wpt');\n+    const statusFile = path.join(dir, 'status', `${this.path}.json`);\n+    const result = JSON.parse(fs.readFileSync(statusFile, 'utf8'));\n+    this.status = result;\n+\n+    const list = fs.readdirSync(fixtures.path('wpt', this.path));\n+\n+    for (const file of list) {\n+      this.tests.push(this.loadTest(file));\n+    }\n+    this.loaded = true;\n+  }\n+\n+  get jsTests() {\n+    return this.tests.filter((test) => test.filename.endsWith('.js'));\n+  }\n+}\n+\n+const PASSED = 1;\n+const FAILED = 2;\n+const SKIPPED = 3;\n+\n+class WPTRunner {\n+  constructor(path) {\n+    this.path = path;\n+    this.resource = new ResourceLoader(path);\n+    this.sandbox = null;\n+    this.context = null;\n+\n+    this.globals = new Map();\n+\n+    this.status = new StatusLoader(path);\n+    this.status.load();\n+    this.tests = new Map(\n+      this.status.jsTests.map((item) => [item.filename, item])\n+    );\n+\n+    this.results = new Map();\n+    this.inProgress = new Set();\n+  }\n+\n+  /**\n+   * Specify that certain global descriptors from the object\n+   * should be defined in the vm\n+   * @param {object} obj\n+   * @param {string[]} names\n+   */\n+  copyGlobalsFromObject(obj, names) {\n+    for (const name of names) {\n+      const desc = Object.getOwnPropertyDescriptor(global, name);\n+      this.globals.set(name, desc);\n+    }\n+  }\n+\n+  /**\n+   * Specify that certain global descriptors should be defined in the vm\n+   * @param {string} name\n+   * @param {object} descriptor\n+   */\n+  defineGlobal(name, descriptor) {\n+    this.globals.set(name, descriptor);\n+  }\n+\n+  // TODO(joyeecheung): work with the upstream to port more tests in .html\n+  // to .js.\n+  runJsTests() {\n+    // TODO(joyeecheung): it's still under discussion whether we should leave\n+    // err.name alone. See https://github.com/nodejs/node/issues/20253\n+    const internalErrors = require('internal/errors');\n+    internalErrors.useOriginalName = true;\n+\n+    let queue = [];\n+\n+    // If the tests are run as `node test/wpt/test-something.js subset.any.js`,\n+    // only `subset.any.js` will be run by the runner.\n+    if (process.argv[2]) {\n+      const filename = process.argv[2];\n+      if (!this.tests.has(filename)) {\n+        throw new Error(`${filename} not found!`);\n+      }\n+      queue.push(this.tests.get(filename));\n+    } else {\n+      queue = this.buildQueue();\n+    }\n+\n+    this.inProgress = new Set(queue.map((item) => item.filename));\n+\n+    for (const test of queue) {\n+      const filename = test.filename;\n+      const content = test.getContent();\n+      const meta = test.title = this.getMeta(content);\n+\n+      const absolutePath = test.getAbsolutePath();\n+      const context = this.generateContext(test.filename);\n+      const code = this.mergeScripts(meta, content);\n+      try {\n+        vm.runInContext(code, context, {\n+          filename: absolutePath\n+        });\n+      } catch (err) {\n+        this.fail(filename, {\n+          name: '',\n+          message: err.message,\n+          stack: err.stack\n+        }, 'UNCAUGHT');\n+        this.inProgress.delete(filename);\n+      }\n+    }\n+    this.tryFinish();\n+  }\n+\n+  mock() {\n+    const resource = this.resource;\n+    const result = {\n+      // This is a mock, because at the moment fetch is not implemented\n+      // in Node.js, but some tests and harness depend on this to pull\n+      // resources.\n+      fetch(file) {\n+        return resource.fetch(file);\n+      },\n+      location: {},\n+      GLOBAL: {\n+        isWindow() { return false; }\n+      },\n+      Object\n+    };\n+\n+    return result;\n+  }\n+\n+  // Note: this is how our global space for the WPT test should look like\n+  getSandbox() {\n+    const result = this.mock();\n+    for (const [name, desc] of this.globals) {\n+      Object.defineProperty(result, name, desc);\n+    }\n+    return result;\n+  }\n+\n+  generateContext(filename) {\n+    const sandbox = this.sandbox = this.getSandbox();\n+    const context = this.context = vm.createContext(sandbox);\n+\n+    const harnessPath = fixtures.path('wpt', 'resources', 'testharness.js');\n+    const harness = fs.readFileSync(harnessPath, 'utf8');\n+    vm.runInContext(harness, context, {\n+      filename: harnessPath\n+    });\n+\n+    sandbox.add_result_callback(\n+      this.resultCallback.bind(this, filename)\n+    );\n+    sandbox.add_completion_callback(\n+      this.completionCallback.bind(this, filename)\n+    );\n+    sandbox.self = sandbox;\n+    // TODO(joyeecheung): we are not a window - work with the upstream to\n+    // add a new scope for us.\n+    sandbox.document = {};  // Pretend we are Window\n+    return context;\n+  }\n+\n+  resultCallback(filename, test) {\n+    switch (test.status) {\n+      case 1:\n+        this.fail(filename, test, 'FAILURE');\n+        break;\n+      case 2:\n+        this.fail(filename, test, 'TIMEOUT');\n+        break;\n+      case 3:\n+        this.fail(filename, test, 'INCOMPLETE');\n+        break;\n+      default:\n+        this.succeed(filename, test);\n+    }\n+  }\n+\n+  completionCallback(filename, tests, harnessStatus) {\n+    if (harnessStatus.status === 2) {\n+      assert.fail(`test harness timed out in ${filename}`);\n+    }\n+    this.inProgress.delete(filename);\n+    this.tryFinish();\n+  }\n+\n+  tryFinish() {\n+    if (this.inProgress.size > 0) {\n+      return;\n+    }\n+\n+    this.reportResults();\n+  }\n+\n+  reportResults() {\n+    const unexpectedFailures = [];\n+    for (const [filename, items] of this.results) {\n+      const test = this.tests.get(filename);\n+      let title = test.meta && test.meta.title;\n+      title = title ? `${filename} : ${title}` : filename;\n+      console.log(`---- ${title} ----`);\n+      for (const item of items) {\n+        switch (item.type) {\n+          case FAILED: {\n+            if (test.failReason) {\n+              console.log(`[EXPECTED_FAILURE] ${item.test.name}`);\n+            } else {\n+              console.log(`[UNEXPECTED_FAILURE] ${item.test.name}`);\n+              unexpectedFailures.push([title, filename, item]);\n+            }\n+            break;\n+          }\n+          case PASSED: {\n+            console.log(`[PASSED] ${item.test.name}`);\n+            break;\n+          }\n+          case SKIPPED: {\n+            console.log(`[SKIPPED] ${item.reason}`);\n+            break;\n+          }\n+        }\n+      }\n+    }\n+\n+    if (unexpectedFailures.length > 0) {\n+      for (const [title, filename, item] of unexpectedFailures) {\n+        console.log(`---- ${title} ----`);\n+        console.log(`[${item.reason}] ${item.test.name}`);\n+        console.log(item.test.message);\n+        console.log(item.test.stack);\n+        const command = `${process.execPath} ${process.execArgv}` +\n+                        ` ${require.main.filename} ${filename}`;\n+        console.log(`Command: ${command}\\n`);\n+      }\n+      assert.fail(`${unexpectedFailures.length} unexpected failures found`);\n+    }\n+  }\n+\n+  addResult(filename, item) {\n+    const result = this.results.get(filename);\n+    if (result) {\n+      result.push(item);\n+    } else {\n+      this.results.set(filename, [item]);\n+    }\n+  }\n+\n+  succeed(filename, test) {\n+    this.addResult(filename, {\n+      type: PASSED,\n+      test\n+    });\n+  }\n+\n+  fail(filename, test, reason) {\n+    this.addResult(filename, {\n+      type: FAILED,\n+      test,\n+      reason\n+    });\n+  }\n+\n+  skip(filename, reason) {\n+    this.addResult(filename, {\n+      type: SKIPPED,\n+      reason\n+    });\n+  }\n+\n+  getMeta(code) {\n+    const matches = code.match(/\\/\\/ META: .+/g);\n+    if (!matches) {\n+      return {};\n+    } else {\n+      const result = {};\n+      for (const match of matches) {\n+        const parts = match.match(/\\/\\/ META: ([^=]+?)=(.+)/);\n+        const key = parts[1];\n+        const value = parts[2];\n+        if (key === 'script') {\n+          if (result[key]) {\n+            result[key].push(value);\n+          } else {\n+            result[key] = [value];\n+          }\n+        } else {\n+          result[key] = value;\n+        }\n+      }\n+      return result;\n+    }\n+  }\n+\n+  mergeScripts(meta, content) {\n+    if (!meta.script) {\n+      return content;\n+    }\n+\n+    // only one script\n+    let result = '';\n+    for (const script of meta.script) {\n+      result += this.resource.fetch(script, false);\n+    }\n+\n+    return result + content;\n+  }\n+\n+  buildQueue() {\n+    const queue = [];\n+    for (const test of this.tests.values()) {\n+      const filename = test.filename;\n+      if (test.skipReason) {\n+        this.skip(filename, test.skipReason);\n+        continue;\n+      }\n+\n+      if (!common.hasIntl && test.requireIntl()) {\n+        this.skip(filename, 'missing Intl');\n+        continue;\n+      }\n+\n+      queue.push(test);\n+    }\n+    return queue;\n+  }\n+}\n+\n+module.exports = {\n+  harness: harnessMock,\n+  WPTRunner\n+};"
        },
        {
            "sha": "282679d7797f2a01e1dd1135bcfb5a829c406ffb",
            "filename": "test/parallel/test-whatwg-url-constructor.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-constructor.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-constructor.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-constructor.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -8,7 +8,7 @@ if (!common.hasIntl) {\n const fixtures = require('../common/fixtures');\n const { URL, URLSearchParams } = require('url');\n const { test, assert_equals, assert_true, assert_throws } =\n-  require('../common/wpt');\n+  require('../common/wpt').harness;\n \n const request = {\n   response: require("
        },
        {
            "sha": "49c3b065f957c6001e2db0230196271ee363ec28",
            "filename": "test/parallel/test-whatwg-url-custom-searchparams-sort.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-custom-searchparams-sort.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-custom-searchparams-sort.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-custom-searchparams-sort.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -4,9 +4,14 @@\n \n require('../common');\n const { URL, URLSearchParams } = require('url');\n-const { test, assert_array_equals } = require('../common/wpt');\n+const { test, assert_array_equals } = require('../common/wpt').harness;\n \n-// Test bottom-up iterative stable merge sort\n+// TODO(joyeecheung): upstream this to WPT, if possible - even\n+// just as a test for large inputs. Other implementations may\n+// have a similar cutoff anyway.\n+\n+// Test bottom-up iterative stable merge sort because we only use that\n+// algorithm to sort > 100 search params.\n const tests = [{ input: '', output: [] }];\n const pairs = [];\n for (let i = 10; i < 100; i++) {"
        },
        {
            "sha": "e10ebb9fe669689cd5745f8bc903aa66a7c5bc47",
            "filename": "test/parallel/test-whatwg-url-custom-setters.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-custom-setters.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-custom-setters.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-custom-setters.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -10,9 +10,10 @@ if (!common.hasIntl) {\n \n const assert = require('assert');\n const URL = require('url').URL;\n-const { test, assert_equals } = require('../common/wpt');\n+const { test, assert_equals } = require('../common/wpt').harness;\n const fixtures = require('../common/fixtures');\n \n+// TODO(joyeecheung): we should submit these to the upstream\n const additionalTestCases =\n   require(fixtures.path('url-setter-tests-additional.js'));\n "
        },
        {
            "sha": "5b1aa14cd07642dcbe5f1c18c93734862d0be3ed",
            "filename": "test/parallel/test-whatwg-url-origin.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-origin.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-origin.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-origin.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -7,7 +7,7 @@ if (!common.hasIntl) {\n \n const fixtures = require('../common/fixtures');\n const URL = require('url').URL;\n-const { test, assert_equals } = require('../common/wpt');\n+const { test, assert_equals } = require('../common/wpt').harness;\n \n const request = {\n   response: require("
        },
        {
            "sha": "13422bd77690ed478ab60696b962de94bcd51ec9",
            "filename": "test/parallel/test-whatwg-url-setters.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-setters.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-setters.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-setters.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -7,7 +7,7 @@ if (!common.hasIntl) {\n }\n \n const URL = require('url').URL;\n-const { test, assert_equals } = require('../common/wpt');\n+const { test, assert_equals } = require('../common/wpt').harness;\n const fixtures = require('../common/fixtures');\n \n const request = {"
        },
        {
            "sha": "4869ab3f1d3bd1075d4de3bcefd6bba903614178",
            "filename": "test/parallel/test-whatwg-url-toascii.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-toascii.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fparallel%2Ftest-whatwg-url-toascii.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-toascii.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -7,7 +7,7 @@ if (!common.hasIntl) {\n \n const fixtures = require('../common/fixtures');\n const { URL } = require('url');\n-const { test, assert_equals, assert_throws } = require('../common/wpt');\n+const { test, assert_equals, assert_throws } = require('../common/wpt').harness;\n \n const request = {\n   response: require("
        },
        {
            "sha": "1810a98c8dc982a6136df32814e18f34e3016d6a",
            "filename": "test/wpt/README.md",
            "status": "added",
            "additions": 171,
            "deletions": 0,
            "changes": 171,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2FREADME.md?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,171 @@\n+# Web Platform Tests\n+\n+The tests here are drivers for running the [Web Platform Tests][].\n+\n+See [`test/fixtures/wpt/README.md`][] for a hash of the last\n+updated WPT commit for each module being covered here.\n+\n+See the json files in [the `status` folder](./status) for prerequisites,\n+expected failures, and support status for specific tests in each module.\n+\n+Currently there are still some Web Platform Tests titled `test-whatwg-*`\n+under `test/parallel` that have not been migrated to be run with the\n+WPT harness and have automatic updates. There are also a few\n+`test-whatwg-*-custom-*` tests that may need to be upstreamed.\n+This folder covers the tests that have been migrated.\n+\n+<a id=\"add-tests\"></a>\n+## How to add tests for a new module\n+\n+### 1. Create a status file\n+\n+For example, to add the URL tests, add a `test/wpt/status/url.json` file.\n+\n+In the beginning, it's fine to leave an empty object `{}` in the file if\n+it's not yet clear how compliant the implementation is,\n+the requirements and expected failures can be figured out in a later step\n+when the tests are run for the first time.\n+\n+See [Format of a status JSON file](#status-format) for details.\n+\n+### 2. Pull the WPT files\n+\n+Use the [git node wpt][] command to download the WPT files into\n+`test/fixtures/wpt`. For example, to add URL tests:\n+\n+```text\n+$ cd /path/to/node/project\n+$ git node wpt url\n+```\n+\n+### 3. Create the test driver\n+\n+For example, for the URL tests, add a file `test/wpt/test-whatwg-url.js`:\n+\n+```js\n+'use strict';\n+\n+// This flag is required by the WPT Runner to patch the internals\n+// for the tests to run in a vm.\n+// Flags: --expose-internals\n+\n+require('../common');\n+const { WPTRunner } = require('../common/wpt');\n+\n+const runner = new WPTRunner('url');\n+\n+// Copy global descriptors from the global object\n+runner.copyGlobalsFromObject(global, ['URL', 'URLSearchParams']);\n+// Define any additional globals with descriptors\n+runner.defineGlobal('DOMException', {\n+  get() {\n+    return require('internal/domexception');\n+  }\n+});\n+\n+runner.runJsTests();\n+```\n+\n+This driver is capable of running the tests located in `test/fixtures/wpt/url`\n+with the WPT harness while taking the status file into account.\n+\n+### 4. Run the tests\n+\n+Run the test using `tools/test.py` and see if there are any failures.\n+For example, to run all the URL tests under `test/fixtures/wpt/url`:\n+\n+```text\n+$ tools/test.py wpt/test-whatwg-url\n+```\n+\n+To run a specific test in WPT, for example, `url/url-searchparams.any.js`,\n+pass the file name as argument to the corresponding test driver:\n+\n+```text\n+node --expose-internals test/wpt/test-whatwg-url.js url-searchparams.any.js\n+```\n+\n+If there are any failures, update the corresponding status file\n+(in this case, `test/wpt/status/url.json`) to make the test pass.\n+\n+For example, to mark `url/url-searchparams.any.js` as expected to fail,\n+add this to `test/wpt/status/url.json`:\n+\n+```json\n+  \"url-searchparams.any.js\": {\n+    \"fail\": \"explain why the test fails, ideally with links\"\n+  }\n+```\n+\n+See [Format of a status JSON file](#status-format) for details.\n+\n+### 5. Commit the changes and submit a Pull Request\n+\n+See [the contributing guide](../../CONTRIBUTING.md).\n+\n+## How to update tests for a module\n+\n+The tests can be updated in a way similar to how they are added.\n+Run Step 2 and Step 4 of [adding tests for a new module](#add-tests).\n+\n+The [git node wpt][] command maintains the status of the local\n+WPT subset, if no files are updated after running it for a module,\n+the local subset is up to date and there is no need to update them\n+until they are changed in the upstream.\n+\n+## How it works\n+\n+Note: currently this test suite only supports `.js` tests. There is\n+ongoing work in the upstream to properly split out the tests into files\n+that can be run in a shell environment like Node.js.\n+\n+### Getting the original test files and harness from WPT\n+\n+The original files and harness from WPT are downloaded and stored in\n+`test/fixtures/wpt`.\n+\n+The [git node wpt][] command automate this process while maintaining a map\n+containing the hash of the last updated commit for each module in\n+`test/fixtures/wpt/versions.json` and [`test/fixtures/wpt/README.md`][].\n+It also maintains the LICENSE file in `test/fixtures/wpt`.\n+\n+### Loading and running the tests\n+\n+Given a module, the `WPTRunner` class in [`test/common/wpt`](../common/wpt.js)\n+loads:\n+\n+- `.js` test files (for example, `test/common/wpt/url/*.js` for `url`)\n+- Status file (for example, `test/wpt/status/url.json` for `url`)\n+- The WPT harness\n+\n+Then, for each test, it creates a vm with the globals and mocks,\n+sets up the harness result hooks, loads the metadata in the test (including\n+loading extra resources), and runs all the tests in that vm,\n+skipping tests that cannot be run because of lack of dependency or\n+expected failures.\n+\n+<a id=\"status-format\"></a>\n+## Format of a status JSON file\n+\n+```text\n+{\n+  \"something.scope.js\": {  // the file name\n+    // Optional: If the requirement is not met, this test will be skipped\n+    \"requires\": [\"intl\"],  // currently only intl is supported\n+\n+    // Optional: the test will be skipped with the reason printed\n+    \"skip\": \"explain why we cannot run a test that's supposed to pass\",\n+\n+    // Optional: the test will be skipped with the reason printed\n+    \"fail\": \"explain why we the test is expected to fail\"\n+  }\n+}\n+```\n+\n+A test may have to be skipped because it depends on another irrelevant\n+Web API, or certain harness has not been ported in our test runner yet.\n+In that case it needs to be marked with `skip` instead of `fail`.\n+\n+[Web Platform Tests]: https://github.com/web-platform-tests/wpt\n+[git node wpt]: https://github.com/nodejs/node-core-utils/blob/master/docs/git-node.md#git-node-wpt\n+[`test/fixtures/wpt/README.md`]: ../fixtures/wpt/README.md"
        },
        {
            "sha": "9530295614211c5a5d2cd904456847463f906c27",
            "filename": "test/wpt/status/console.json",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fstatus%2Fconsole.json",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fstatus%2Fconsole.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Fstatus%2Fconsole.json?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"idlharness.any.js\": {\n+    \"fail\": \".table, .dir and .timeLog parameter lengths are wrong\"\n+  }\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "42b5f6fb1a1146c6fb14a6609b1879a607e37806",
            "filename": "test/wpt/status/url.json",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fstatus%2Furl.json",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fstatus%2Furl.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Fstatus%2Furl.json?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,15 @@\n+{\n+  \"toascii.window.js\": {\n+    \"requires\": [\"intl\"],\n+    \"skip\": \"TODO: port from .window.js\"\n+  },\n+  \"historical.any.js\": {\n+    \"requires\": [\"intl\"]\n+  },\n+  \"urlencoded-parser.any.js\": {\n+    \"fail\": \"missing Request and Response\"\n+  },\n+  \"idlharness.any.js\": {\n+    \"fail\": \"getter/setter names are wrong, etc.\"\n+  }\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "7b23fe8d3e619d594f04b9ab474ffbec1435034f",
            "filename": "test/wpt/test-whatwg-console.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftest-whatwg-console.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftest-whatwg-console.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Ftest-whatwg-console.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,13 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+\n+require('../common');\n+const { WPTRunner } = require('../common/wpt');\n+\n+const runner = new WPTRunner('console');\n+\n+// Copy global descriptors from the global object\n+runner.copyGlobalsFromObject(global, ['console']);\n+\n+runner.runJsTests();"
        },
        {
            "sha": "8734452940e84e78733394f904a98798b4ed3adc",
            "filename": "test/wpt/test-whatwg-url.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftest-whatwg-url.js",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftest-whatwg-url.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Ftest-whatwg-url.js?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,19 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+\n+require('../common');\n+const { WPTRunner } = require('../common/wpt');\n+\n+const runner = new WPTRunner('url');\n+\n+// Copy global descriptors from the global object\n+runner.copyGlobalsFromObject(global, ['URL', 'URLSearchParams']);\n+// Needed by urlsearchparams-constructor.any.js\n+runner.defineGlobal('DOMException', {\n+  get() {\n+    return require('internal/domexception');\n+  }\n+});\n+\n+runner.runJsTests();"
        },
        {
            "sha": "db235699ddfe57887b1a7f483111124843043693",
            "filename": "test/wpt/testcfg.py",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftestcfg.py",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Ftestcfg.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Ftestcfg.py?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,6 @@\n+import sys, os\n+sys.path.append(os.path.join(os.path.dirname(__file__), '..'))\n+import testpy\n+\n+def GetConfiguration(context, root):\n+  return testpy.ParallelTestConfiguration(context, root, 'wpt')"
        },
        {
            "sha": "de3b3024627a1b0ed15a51ceb4fa035d63c111e6",
            "filename": "test/wpt/wpt.status",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fwpt.status",
            "raw_url": "https://github.com/nodejs/node/raw/9858e331e3e461e24916c3e86087e5a73b3cb468/test%2Fwpt%2Fwpt.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Fwpt.status?ref=9858e331e3e461e24916c3e86087e5a73b3cb468",
            "patch": "@@ -0,0 +1,21 @@\n+prefix wpt\n+\n+# To mark a test as flaky, list the test name in the appropriate section\n+# below, without \".js\", followed by \": PASS,FLAKY\". Example:\n+# sample-test                        : PASS,FLAKY\n+\n+[true] # This section applies to all platforms\n+\n+[$system==win32]\n+\n+[$system==linux]\n+\n+[$system==macos]\n+\n+[$arch==arm || $arch==arm64]\n+\n+[$system==solaris] # Also applies to SmartOS\n+\n+[$system==freebsd]\n+\n+[$system==aix]"
        }
    ],
    "stats": {
        "total": 721,
        "additions": 707,
        "deletions": 14
    }
}