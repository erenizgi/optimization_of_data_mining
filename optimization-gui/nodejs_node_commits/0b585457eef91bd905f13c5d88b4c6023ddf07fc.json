{
    "author": "starkwang",
    "message": "http: reduce multiple output arrays into one\n\nNow we are using `output`, `outputEncodings` and `outputCallbacks`\nto hold pending data. Reducing them into one array `outputData`\ncan slightly improve performance and reduce some redundant codes.\n\nPR-URL: https://github.com/nodejs/node/pull/26004\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>",
    "sha": "0b585457eef91bd905f13c5d88b4c6023ddf07fc",
    "files": [
        {
            "sha": "93d07c4d7d04a54ef05038c4384e0f53344d7923",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/0b585457eef91bd905f13c5d88b4c6023ddf07fc/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/0b585457eef91bd905f13c5d88b4c6023ddf07fc/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=0b585457eef91bd905f13c5d88b4c6023ddf07fc",
            "patch": "@@ -374,10 +374,8 @@ function socketCloseListener() {\n   // Too bad.  That output wasn't getting written.\n   // This is pretty terrible that it doesn't raise an error.\n   // Fixed better in v0.10\n-  if (req.output)\n-    req.output.length = 0;\n-  if (req.outputEncodings)\n-    req.outputEncodings.length = 0;\n+  if (req.outputData)\n+    req.outputData.length = 0;\n \n   if (parser) {\n     parser.finish();"
        },
        {
            "sha": "bc974cff80fd01a611528b518c56e1dd574cbff5",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/0b585457eef91bd905f13c5d88b4c6023ddf07fc/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/0b585457eef91bd905f13c5d88b4c6023ddf07fc/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=0b585457eef91bd905f13c5d88b4c6023ddf07fc",
            "patch": "@@ -70,9 +70,7 @@ function OutgoingMessage() {\n \n   // Queue that holds all currently pending data, until the response will be\n   // assigned to the socket (until it will its turn in the HTTP pipeline).\n-  this.output = [];\n-  this.outputEncodings = [];\n-  this.outputCallbacks = [];\n+  this.outputData = [];\n \n   // `outputSize` is an approximate measure of how much data is queued on this\n   // response. `_onPendingData` will be invoked to update similar global\n@@ -220,14 +218,18 @@ OutgoingMessage.prototype._send = function _send(data, encoding, callback) {\n       data = this._header + data;\n     } else {\n       var header = this._header;\n-      if (this.output.length === 0) {\n-        this.output = [header];\n-        this.outputEncodings = ['latin1'];\n-        this.outputCallbacks = [null];\n+      if (this.outputData.length === 0) {\n+        this.outputData = [{\n+          data: header,\n+          encoding: 'latin1',\n+          callback: null\n+        }];\n       } else {\n-        this.output.unshift(header);\n-        this.outputEncodings.unshift('latin1');\n-        this.outputCallbacks.unshift(null);\n+        this.outputData.unshift({\n+          data: header,\n+          encoding: 'latin1',\n+          callback: null\n+        });\n       }\n       this.outputSize += header.length;\n       this._onPendingData(header.length);\n@@ -254,7 +256,7 @@ function _writeRaw(data, encoding, callback) {\n \n   if (conn && conn._httpMessage === this && conn.writable && !conn.destroyed) {\n     // There might be pending data in the this.output buffer.\n-    if (this.output.length) {\n+    if (this.outputData.length) {\n       this._flushOutput(conn);\n     } else if (!data.length) {\n       if (typeof callback === 'function') {\n@@ -273,9 +275,7 @@ function _writeRaw(data, encoding, callback) {\n     return conn.write(data, encoding, callback);\n   }\n   // Buffer, as long as we're not destroyed.\n-  this.output.push(data);\n-  this.outputEncodings.push(encoding);\n-  this.outputCallbacks.push(callback);\n+  this.outputData.push({ data, encoding, callback });\n   this.outputSize += data.length;\n   this._onPendingData(data.length);\n   return false;\n@@ -738,7 +738,7 @@ OutgoingMessage.prototype.end = function end(chunk, encoding, callback) {\n   // There is the first message on the outgoing queue, and we've sent\n   // everything to the socket.\n   debug('outgoing message end.');\n-  if (this.output.length === 0 &&\n+  if (this.outputData.length === 0 &&\n       this.connection &&\n       this.connection._httpMessage === this) {\n     this._finish();\n@@ -793,22 +793,19 @@ OutgoingMessage.prototype._flush = function _flush() {\n \n OutgoingMessage.prototype._flushOutput = function _flushOutput(socket) {\n   var ret;\n-  var outputLength = this.output.length;\n+  var outputLength = this.outputData.length;\n   if (outputLength <= 0)\n     return ret;\n \n-  var output = this.output;\n-  var outputEncodings = this.outputEncodings;\n-  var outputCallbacks = this.outputCallbacks;\n+  var outputData = this.outputData;\n   socket.cork();\n   for (var i = 0; i < outputLength; i++) {\n-    ret = socket.write(output[i], outputEncodings[i], outputCallbacks[i]);\n+    const { data, encoding, callback } = outputData[i];\n+    ret = socket.write(data, encoding, callback);\n   }\n   socket.uncork();\n \n-  this.output = [];\n-  this.outputEncodings = [];\n-  this.outputCallbacks = [];\n+  this.outputData = [];\n   this._onPendingData(-this.outputSize);\n   this.outputSize = 0;\n "
        },
        {
            "sha": "551cea19829d93596930589e1f30e3ad33d56fe3",
            "filename": "test/parallel/test-http-destroyed-socket-write2.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/0b585457eef91bd905f13c5d88b4c6023ddf07fc/test%2Fparallel%2Ftest-http-destroyed-socket-write2.js",
            "raw_url": "https://github.com/nodejs/node/raw/0b585457eef91bd905f13c5d88b4c6023ddf07fc/test%2Fparallel%2Ftest-http-destroyed-socket-write2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-destroyed-socket-write2.js?ref=0b585457eef91bd905f13c5d88b4c6023ddf07fc",
            "patch": "@@ -69,8 +69,7 @@ server.listen(0, function() {\n     }\n \n \n-    assert.strictEqual(req.output.length, 0);\n-    assert.strictEqual(req.outputEncodings.length, 0);\n+    assert.strictEqual(req.outputData.length, 0);\n     server.close();\n   }));\n "
        }
    ],
    "stats": {
        "total": 52,
        "additions": 23,
        "deletions": 29
    }
}