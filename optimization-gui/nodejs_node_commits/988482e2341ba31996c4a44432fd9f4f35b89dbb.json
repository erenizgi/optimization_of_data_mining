{
    "author": "lpinca",
    "message": "test: refactor test-http-agent-timeout-option\n\nFix flakyness caused by usage of a non-routable IP address.\n\nRefs: https://github.com/nodejs/node/pull/25488#issuecomment-459385146\n\nPR-URL: https://github.com/nodejs/node/pull/25854\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>",
    "sha": "988482e2341ba31996c4a44432fd9f4f35b89dbb",
    "files": [
        {
            "sha": "3c694a0ef7d2d243d0f3a97c6997e3e7c9354032",
            "filename": "test/parallel/test-http-agent-timeout-option.js",
            "status": "modified",
            "additions": 20,
            "deletions": 14,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/988482e2341ba31996c4a44432fd9f4f35b89dbb/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "raw_url": "https://github.com/nodejs/node/raw/988482e2341ba31996c4a44432fd9f4f35b89dbb/test%2Fparallel%2Ftest-http-agent-timeout-option.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-timeout-option.js?ref=988482e2341ba31996c4a44432fd9f4f35b89dbb",
            "patch": "@@ -1,23 +1,29 @@\n 'use strict';\n \n const { expectsError, mustCall } = require('../common');\n-const { Agent, get } = require('http');\n+const { Agent, get, createServer } = require('http');\n \n // Test that the `'timeout'` event is emitted on the `ClientRequest` instance\n // when the socket timeout set via the `timeout` option of the `Agent` expires.\n \n-const request = get({\n-  agent: new Agent({ timeout: 500 }),\n-  // Non-routable IP address to prevent the connection from being established.\n-  host: '192.0.2.1'\n-});\n-\n-request.on('error', expectsError({\n-  type: Error,\n-  code: 'ECONNRESET',\n-  message: 'socket hang up'\n+const server = createServer(mustCall(() => {\n+  // Never respond.\n }));\n \n-request.on('timeout', mustCall(() => {\n-  request.abort();\n-}));\n+server.listen(() => {\n+  const request = get({\n+    agent: new Agent({ timeout: 500 }),\n+    port: server.address().port\n+  });\n+\n+  request.on('error', expectsError({\n+    type: Error,\n+    code: 'ECONNRESET',\n+    message: 'socket hang up'\n+  }));\n+\n+  request.on('timeout', mustCall(() => {\n+    request.abort();\n+    server.close();\n+  }));\n+});"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 20,
        "deletions": 14
    }
}