{
    "author": "addaleax",
    "message": "repl: make last error available as `_error`\n\nThis is pretty useful when trying to inspect the last\nerror caught by a REPL, and is made to be analogous to `_`,\nwhich contains the last successful completion value.\n\nPR-URL: https://github.com/nodejs/node/pull/18919\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>\nReviewed-By: Vladimir de Turckheim <vlad2t@hotmail.com>\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: Tobias Nießen <tniessen@tnie.de>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Prince John Wesley <princejohnwesley@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>",
    "sha": "a8b5192fefe54b140ae923e749104b49c5d3be49",
    "files": [
        {
            "sha": "c868106f2f946a518cfecb220c62f8d881259755",
            "filename": "doc/api/repl.md",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/a8b5192fefe54b140ae923e749104b49c5d3be49/doc%2Fapi%2Frepl.md",
            "raw_url": "https://github.com/nodejs/node/raw/a8b5192fefe54b140ae923e749104b49c5d3be49/doc%2Fapi%2Frepl.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Frepl.md?ref=a8b5192fefe54b140ae923e749104b49c5d3be49",
            "patch": "@@ -142,6 +142,12 @@ global or scoped variable, the input `fs` will be evaluated on-demand as\n ```\n \n #### Assignment of the `_` (underscore) variable\n+<!-- YAML\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18919\n+    description: Added `_error` support.\n+-->\n \n The default evaluator will, by default, assign the result of the most recently\n evaluated expression to the special variable `_` (underscore).\n@@ -162,6 +168,17 @@ Expression assignment to _ now disabled.\n 4\n ```\n \n+Similarly, `_error` will refer to the last seen error, if there was any.\n+Explicitly setting `_error` to a value will disable this behavior.\n+\n+<!-- eslint-skip -->\n+```js\n+> throw new Error('foo');\n+Error: foo\n+> _error.message\n+'foo'\n+```\n+\n ### Custom Evaluation Functions\n \n When a new `repl.REPLServer` is created, a custom evaluation function may be"
        },
        {
            "sha": "4bcbd1a2db09f45774116bd74453112d44482f70",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/a8b5192fefe54b140ae923e749104b49c5d3be49/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/a8b5192fefe54b140ae923e749104b49c5d3be49/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=a8b5192fefe54b140ae923e749104b49c5d3be49",
            "patch": "@@ -156,6 +156,8 @@ function REPLServer(prompt,\n   self.replMode = replMode || exports.REPL_MODE_SLOPPY;\n   self.underscoreAssigned = false;\n   self.last = undefined;\n+  self.underscoreErrAssigned = false;\n+  self.lastError = undefined;\n   self.breakEvalOnSigint = !!breakEvalOnSigint;\n   self.editorMode = false;\n   // Context id for use with the inspector protocol.\n@@ -388,6 +390,8 @@ function REPLServer(prompt,\n       internalUtil.decorateErrorStack(e);\n     Error.prepareStackTrace = pstrace;\n     const isError = internalUtil.isError(e);\n+    if (!self.underscoreErrAssigned)\n+      self.lastError = e;\n     if (e instanceof SyntaxError && e.stack) {\n       // remove repl:line-number and stack trace\n       e.stack = e.stack\n@@ -796,6 +800,7 @@ REPLServer.prototype.createContext = function() {\n REPLServer.prototype.resetContext = function() {\n   this.context = this.createContext();\n   this.underscoreAssigned = false;\n+  this.underscoreErrAssigned = false;\n   this.lines = [];\n   this.lines.level = [];\n \n@@ -811,6 +816,19 @@ REPLServer.prototype.resetContext = function() {\n     }\n   });\n \n+  Object.defineProperty(this.context, '_error', {\n+    configurable: true,\n+    get: () => this.lastError,\n+    set: (value) => {\n+      this.lastError = value;\n+      if (!this.underscoreErrAssigned) {\n+        this.underscoreErrAssigned = true;\n+        this.outputStream.write(\n+          'Expression assignment to _error now disabled.\\n');\n+      }\n+    }\n+  });\n+\n   // Allow REPL extensions to extend the new context\n   this.emit('reset', this.context);\n };"
        },
        {
            "sha": "57929244ae437420aa2522e21d4a961b9952d73d",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/a8b5192fefe54b140ae923e749104b49c5d3be49/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/a8b5192fefe54b140ae923e749104b49c5d3be49/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=a8b5192fefe54b140ae923e749104b49c5d3be49",
            "patch": "@@ -10,6 +10,7 @@ testStrictMode();\n testResetContext();\n testResetContextGlobal();\n testMagicMode();\n+testError();\n \n function testSloppyMode() {\n   const r = initRepl(repl.REPL_MODE_SLOPPY);\n@@ -153,6 +154,73 @@ function testResetContextGlobal() {\n   delete global.require;\n }\n \n+function testError() {\n+  const r = initRepl(repl.REPL_MODE_STRICT);\n+\n+  r.write(`_error;                                // initial value undefined\n+           throw new Error('foo');                // throws error\n+           _error;                                // shows error\n+           fs.readdirSync('/nonexistent?');       // throws error, sync\n+           _error.code;                           // shows error code\n+           _error.syscall;                        // shows error syscall\n+           setImmediate(() => { throw new Error('baz'); }); undefined;\n+                                                  // throws error, async\n+           `);\n+\n+  setImmediate(() => {\n+    const lines = r.output.accum.trim().split('\\n');\n+    const expectedLines = [\n+      'undefined',\n+\n+      // The error, both from the original throw and the `_error` echo.\n+      'Error: foo',\n+      'Error: foo',\n+\n+      // The sync error, with individual property echoes\n+      /Error: ENOENT: no such file or directory, scandir '.*nonexistent.*'/,\n+      /fs\\.readdirSync/,\n+      \"'ENOENT'\",\n+      \"'scandir'\",\n+\n+      // Dummy 'undefined' from the explicit silencer + one from the comment\n+      'undefined',\n+      'undefined',\n+\n+      // The message from the original throw\n+      'Error: baz',\n+      /setImmediate/,\n+      /^    at/,\n+      /^    at/,\n+      /^    at/,\n+      /^    at/,\n+    ];\n+    for (const line of lines) {\n+      const expected = expectedLines.shift();\n+      if (typeof expected === 'string')\n+        assert.strictEqual(line, expected);\n+      else\n+        assert(expected.test(line), `${line} should match ${expected}`);\n+    }\n+    assert.strictEqual(expectedLines.length, 0);\n+\n+    // Reset output, check that '_error' is the asynchronously caught error.\n+    r.output.accum = '';\n+    r.write(`_error.message                 // show the message\n+             _error = 0;                    // disable auto-assignment\n+             throw new Error('quux');       // new error\n+             _error;                        // should not see the new error\n+             `);\n+\n+    assertOutput(r.output, [\n+      \"'baz'\",\n+      'Expression assignment to _error now disabled.',\n+      '0',\n+      'Error: quux',\n+      '0'\n+    ]);\n+  });\n+}\n+\n function initRepl(mode, useGlobal) {\n   const inputStream = new stream.PassThrough();\n   const outputStream = new stream.PassThrough();"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 103,
        "deletions": 0
    }
}