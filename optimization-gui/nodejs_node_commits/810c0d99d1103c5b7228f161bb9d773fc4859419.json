{
    "author": "codyhazelwood",
    "message": "src: use MallocedBuffer abstraction for buffers\n\nDrop `Free` and `std::unique_ptr` in favor of Node's `MallocedBuffer`\nfor `char[]` buffer memory mangement.\n\nPR-URL: https://github.com/nodejs/node/pull/23543\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "810c0d99d1103c5b7228f161bb9d773fc4859419",
    "files": [
        {
            "sha": "c6cce9c2d09ba9e7d5885b10cb9b361646d58060",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 15,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/810c0d99d1103c5b7228f161bb9d773fc4859419/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/810c0d99d1103c5b7228f161bb9d773fc4859419/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=810c0d99d1103c5b7228f161bb9d773fc4859419",
            "patch": "@@ -8,6 +8,7 @@\n #include \"env-inl.h\"\n #include \"js_stream.h\"\n #include \"string_bytes.h\"\n+#include \"util.h\"\n #include \"util-inl.h\"\n #include \"v8.h\"\n \n@@ -37,11 +38,6 @@ template int StreamBase::WriteString<LATIN1>(\n     const FunctionCallbackInfo<Value>& args);\n \n \n-struct Free {\n-  void operator()(char* ptr) const { free(ptr); }\n-};\n-\n-\n int StreamBase::ReadStartJS(const FunctionCallbackInfo<Value>& args) {\n   return ReadStart();\n }\n@@ -127,9 +123,9 @@ int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n     }\n   }\n \n-  std::unique_ptr<char[], Free> storage;\n+  MallocedBuffer<char> storage;\n   if (storage_size > 0)\n-    storage = std::unique_ptr<char[], Free>(Malloc(storage_size));\n+    storage = MallocedBuffer<char>(storage_size);\n \n   offset = 0;\n   if (!all_buffers) {\n@@ -145,7 +141,7 @@ int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n \n       // Write string\n       CHECK_LE(offset, storage_size);\n-      char* str_storage = storage.get() + offset;\n+      char* str_storage = storage.data + offset;\n       size_t str_size = storage_size - offset;\n \n       Local<String> string = chunk->ToString(env->context()).ToLocalChecked();\n@@ -164,7 +160,7 @@ int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n \n   StreamWriteResult res = Write(*bufs, count, nullptr, req_wrap_obj);\n   SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res);\n-  if (res.wrap != nullptr && storage) {\n+  if (res.wrap != nullptr && storage_size > 0) {\n     res.wrap->SetAllocatedStorage(storage.release(), storage_size);\n   }\n   return res.err;\n@@ -263,26 +259,26 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n     CHECK_EQ(count, 1);\n   }\n \n-  std::unique_ptr<char[], Free> data;\n+  MallocedBuffer<char> data;\n \n   if (try_write) {\n     // Copy partial data\n-    data = std::unique_ptr<char[], Free>(Malloc(buf.len));\n-    memcpy(data.get(), buf.base, buf.len);\n+    data = MallocedBuffer<char>(buf.len);\n+    memcpy(data.data, buf.base, buf.len);\n     data_size = buf.len;\n   } else {\n     // Write it\n-    data = std::unique_ptr<char[], Free>(Malloc(storage_size));\n+    data = MallocedBuffer<char>(storage_size);\n     data_size = StringBytes::Write(env->isolate(),\n-                                   data.get(),\n+                                   data.data,\n                                    storage_size,\n                                    string,\n                                    enc);\n   }\n \n   CHECK_LE(data_size, storage_size);\n \n-  buf = uv_buf_init(data.get(), data_size);\n+  buf = uv_buf_init(data.data, data_size);\n \n   uv_stream_t* send_handle = nullptr;\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 11,
        "deletions": 15
    }
}