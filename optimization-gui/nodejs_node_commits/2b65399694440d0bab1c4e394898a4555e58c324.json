{
    "author": "addaleax",
    "message": "http2: allow fully synchronous `_final()`\n\nHTTP/2 streams do not use the fact that the native\n`StreamBase::Shutdown()` is asynchronous by default and\nalways finish synchronously.\n\nAdding a status code for this scenario allows skipping an\nexpensive `MakeCallback()` C++/JS boundary crossing.\n\nPR-URL: https://github.com/nodejs/node/pull/25609\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "2b65399694440d0bab1c4e394898a4555e58c324",
    "files": [
        {
            "sha": "fc99b50eae21f2ce5fc82753c928ee1b66d91bab",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2b65399694440d0bab1c4e394898a4555e58c324/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b65399694440d0bab1c4e394898a4555e58c324/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=2b65399694440d0bab1c4e394898a4555e58c324",
            "patch": "@@ -1821,7 +1821,9 @@ class Http2Stream extends Duplex {\n       req.oncomplete = afterShutdown;\n       req.callback = cb;\n       req.handle = handle;\n-      handle.shutdown(req);\n+      const err = handle.shutdown(req);\n+      if (err === 1)  // synchronous finish\n+        return afterShutdown.call(req, 0);\n     } else {\n       cb();\n     }"
        },
        {
            "sha": "9eb7448c59a9b1d58cee79e94dff73cf24888911",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2b65399694440d0bab1c4e394898a4555e58c324/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b65399694440d0bab1c4e394898a4555e58c324/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=2b65399694440d0bab1c4e394898a4555e58c324",
            "patch": "@@ -362,7 +362,9 @@ Socket.prototype._final = function(cb) {\n   req.callback = cb;\n   var err = this._handle.shutdown(req);\n \n-  if (err)\n+  if (err === 1)  // synchronous finish\n+    return afterShutdown.call(req, 0);\n+  else if (err !== 0)\n     return this.destroy(errnoException(err, 'shutdown'));\n };\n "
        },
        {
            "sha": "ea60fb459ceff13b3ab417485a04902939d4ee1a",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/2b65399694440d0bab1c4e394898a4555e58c324/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2b65399694440d0bab1c4e394898a4555e58c324/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=2b65399694440d0bab1c4e394898a4555e58c324",
            "patch": "@@ -1948,8 +1948,7 @@ int Http2Stream::DoShutdown(ShutdownWrap* req_wrap) {\n              NGHTTP2_ERR_NOMEM);\n     Debug(this, \"writable side shutdown\");\n   }\n-  req_wrap->Done(0);\n-  return 0;\n+  return 1;\n }\n \n // Destroy the Http2Stream and render it unusable. Actual resources for the"
        },
        {
            "sha": "cde3343d624fa454d406ea568f3fb60a3a525ce8",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/2b65399694440d0bab1c4e394898a4555e58c324/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/2b65399694440d0bab1c4e394898a4555e58c324/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=2b65399694440d0bab1c4e394898a4555e58c324",
            "patch": "@@ -205,12 +205,16 @@ class StreamResource {\n   // All of these methods may return an error code synchronously.\n   // In that case, the finish callback should *not* be called.\n \n-  // Perform a shutdown operation, and call req_wrap->Done() when finished.\n+  // Perform a shutdown operation, and either call req_wrap->Done() when\n+  // finished and return 0, return 1 for synchronous success, or\n+  // a libuv error code for synchronous failures.\n   virtual int DoShutdown(ShutdownWrap* req_wrap) = 0;\n   // Try to write as much data as possible synchronously, and modify\n   // `*bufs` and `*count` accordingly. This is a no-op by default.\n+  // Return 0 for success and a libuv error code for failures.\n   virtual int DoTryWrite(uv_buf_t** bufs, size_t* count);\n-  // Perform a write of data, and call req_wrap->Done() when finished.\n+  // Perform a write of data, and either call req_wrap->Done() when finished\n+  // and return 0, or return a libuv error code for synchronous failures.\n   virtual int DoWrite(WriteWrap* w,\n                       uv_buf_t* bufs,\n                       size_t count,\n@@ -274,6 +278,8 @@ class StreamBase : public StreamResource {\n \n   // Shut down the current stream. This request can use an existing\n   // ShutdownWrap object (that was created in JS), or a new one will be created.\n+  // Returns 1 in case of a synchronous completion, 0 in case of asynchronous\n+  // completion, and a libuv error case in case of synchronous failure.\n   int Shutdown(v8::Local<v8::Object> req_wrap_obj = v8::Local<v8::Object>());\n \n   // Write data to the current stream. This request can use an existing"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 15,
        "deletions": 6
    }
}