{
    "author": "lpinca",
    "message": "test: fix test-http-dump-req-when-res-ends\n\nFix test-http-dump-req-when-res-ends and move it back to test/parallel/\n\nPR-URL: https://github.com/nodejs/node/pull/19866\nRefs: https://github.com/nodejs/node/pull/19823\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "96e82beac353c2607228590b49b3d232d33a64bf",
    "files": [
        {
            "sha": "718797fae1fe688bdc4fbb9dba91880b059d7004",
            "filename": "test/parallel/test-http-dump-req-when-res-ends.js",
            "status": "renamed",
            "additions": 16,
            "deletions": 26,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/96e82beac353c2607228590b49b3d232d33a64bf/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js",
            "raw_url": "https://github.com/nodejs/node/raw/96e82beac353c2607228590b49b3d232d33a64bf/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js?ref=96e82beac353c2607228590b49b3d232d33a64bf",
            "patch": "@@ -1,25 +1,24 @@\n 'use strict';\n \n-const common = require('../common');\n-const http = require('http');\n-const assert = require('assert');\n-const fs = require('fs');\n+const { mustCall } = require('../common');\n \n-let resEnd = null;\n+const fs = require('fs');\n+const http = require('http');\n+const { strictEqual } = require('assert');\n \n-const server = http.createServer(common.mustCall(function(req, res) {\n+const server = http.createServer(mustCall(function(req, res) {\n+  strictEqual(req.socket.listenerCount('data'), 1);\n+  req.socket.once('data', mustCall(function() {\n+    // Ensure that a chunk of data is received before calling `res.end()`.\n+    res.end('hello world');\n+  }));\n   // This checks if the request gets dumped\n   // resume will be triggered by res.end().\n-  req.on('resume', common.mustCall(function() {\n+  req.on('resume', mustCall(function() {\n     // There is no 'data' event handler anymore\n     // it gets automatically removed when dumping the request.\n-    assert.strictEqual(req.listenerCount('data'), 0);\n-\n-    req.on('data', common.mustCallAtLeast(function(d) {\n-      // Leaving the console.log explicitly, so that\n-      // we can know how many chunks we have received.\n-      console.log('data', d);\n-    }, 1));\n+    strictEqual(req.listenerCount('data'), 0);\n+    req.on('data', mustCall());\n   }));\n \n   // We explicitly pause the stream\n@@ -30,15 +29,9 @@ const server = http.createServer(common.mustCall(function(req, res) {\n \n   // Start sending the response.\n   res.flushHeaders();\n-\n-  resEnd = function() {\n-    setImmediate(function() {\n-      res.end('hello world');\n-    });\n-  };\n }));\n \n-server.listen(0, common.mustCall(function() {\n+server.listen(0, mustCall(function() {\n   const req = http.request({\n     method: 'POST',\n     port: server.address().port\n@@ -48,13 +41,10 @@ server.listen(0, common.mustCall(function() {\n   // for the body.\n   req.flushHeaders();\n \n-  req.on('response', common.mustCall(function(res) {\n+  req.on('response', mustCall(function(res) {\n     // Pipe the body as soon as we get the headers of the\n     // response back.\n-    const readFileStream = fs.createReadStream(__filename);\n-    readFileStream.on('end', resEnd);\n-\n-    readFileStream.pipe(req);\n+    fs.createReadStream(__filename).pipe(req);\n \n     res.resume();\n ",
            "previous_filename": "test/sequential/test-http-dump-req-when-res-ends.js"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 16,
        "deletions": 26
    }
}