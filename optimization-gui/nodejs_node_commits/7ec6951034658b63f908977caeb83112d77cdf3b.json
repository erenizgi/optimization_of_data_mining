{
    "author": "bnoordhuis",
    "message": "src: avoid common case heap allocation\n\nOptimize three functions that pass on (part of) their JS arguments to\nthe JS function they call by stack-allocating the storage in the common\ncase.\n\nPR-URL: https://github.com/nodejs/node/pull/21409\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "7ec6951034658b63f908977caeb83112d77cdf3b",
    "files": [
        {
            "sha": "104cd93b3cd9e0f57c9f475c04125a3d2734a025",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=7ec6951034658b63f908977caeb83112d77cdf3b",
            "patch": "@@ -131,11 +131,7 @@ void CallAndPauseOnStart(const FunctionCallbackInfo<v8::Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   CHECK_GT(args.Length(), 1);\n   CHECK(args[0]->IsFunction());\n-  std::vector<v8::Local<v8::Value>> call_args;\n-  for (int i = 2; i < args.Length(); i++) {\n-    call_args.push_back(args[i]);\n-  }\n-\n+  SlicedArguments call_args(args, /* start */ 2);\n   env->inspector_agent()->PauseOnNextJavascriptStatement(\"Break on start\");\n   v8::MaybeLocal<v8::Value> retval =\n       args[0].As<v8::Function>()->Call(env->context(), args[1],\n@@ -150,10 +146,7 @@ void InspectorConsoleCall(const FunctionCallbackInfo<Value>& info) {\n   HandleScope handle_scope(isolate);\n   Local<Context> context = isolate->GetCurrentContext();\n   CHECK_LT(2, info.Length());\n-  std::vector<Local<Value>> call_args;\n-  for (int i = 3; i < info.Length(); ++i) {\n-    call_args.push_back(info[i]);\n-  }\n+  SlicedArguments call_args(info, /* start */ 3);\n   Environment* env = Environment::GetCurrent(isolate);\n   if (InspectorEnabled(env)) {\n     Local<Value> inspector_method = info[0];"
        },
        {
            "sha": "cd791f8c059cafc171fb2821f267ed24df807b33",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=7ec6951034658b63f908977caeb83112d77cdf3b",
            "patch": "@@ -40,6 +40,7 @@\n #include <stdlib.h>\n \n #include <string>\n+#include <vector>\n \n // Custom constants used by both node_constants.cc and node_zlib.cc\n #define Z_MIN_WINDOWBITS 8\n@@ -315,6 +316,39 @@ class FatalTryCatch : public v8::TryCatch {\n   Environment* env_;\n };\n \n+class SlicedArguments {\n+ public:\n+  inline explicit SlicedArguments(\n+      const v8::FunctionCallbackInfo<v8::Value>& args,\n+      size_t start = 0);\n+  inline size_t size() const { return size_; }\n+  inline v8::Local<v8::Value>* data() { return data_; }\n+\n+ private:\n+  size_t size_;\n+  v8::Local<v8::Value>* data_;\n+  v8::Local<v8::Value> fixed_[64];\n+  std::vector<v8::Local<v8::Value>> dynamic_;\n+};\n+\n+SlicedArguments::SlicedArguments(\n+    const v8::FunctionCallbackInfo<v8::Value>& args,\n+    size_t start) : size_(0), data_(fixed_) {\n+  const size_t length = static_cast<size_t>(args.Length());\n+  if (start >= length) return;\n+  const size_t size = length - start;\n+\n+  if (size > arraysize(fixed_)) {\n+    dynamic_.resize(size);\n+    data_ = dynamic_.data();\n+  }\n+\n+  for (size_t i = 0; i < size; ++i)\n+    data_[i] = args[i + start];\n+\n+  size_ = size;\n+}\n+\n void ReportException(Environment* env,\n                      v8::Local<v8::Value> er,\n                      v8::Local<v8::Message> message);"
        },
        {
            "sha": "900fbb4c9db528dc3bcdce8822f0636aa06c62e1",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7ec6951034658b63f908977caeb83112d77cdf3b/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=7ec6951034658b63f908977caeb83112d77cdf3b",
            "patch": "@@ -1,8 +1,6 @@\n #include \"node_internals.h\"\n #include \"node_perf.h\"\n \n-#include <vector>\n-\n #ifdef __POSIX__\n #include <sys/time.h>  // gettimeofday\n #endif\n@@ -309,10 +307,7 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   Local<Function> fn = args.Data().As<Function>();\n   size_t count = args.Length();\n   size_t idx;\n-  std::vector<Local<Value>> call_args;\n-  for (size_t i = 0; i < count; ++i)\n-    call_args.push_back(args[i]);\n-\n+  SlicedArguments call_args(args);\n   Utf8Value name(isolate, GetName(fn));\n \n   uint64_t start;"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 37,
        "deletions": 15
    }
}