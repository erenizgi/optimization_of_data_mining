{
    "author": "yhwang",
    "message": "test: add lib path env when node_shared=true\n\nWhen building the node with `--shared` option, the major output is the\nshared library. However, we still build a node executable which links\nto the shared lib. It's for testing purpose. When testing with the\nexecutable, some test cases move/copy the executable, change the\nrelative path to the shared library and fail. Using lib path env would\nsolve the issue. However, in macOS, need to change the install name for\nthe shared library and use rpath in the executable. In AIX, `-brtl`\nlinker option rebinds the symbols in the executable and addon modules\ncould use them.\n\nSigned-off-by: Yihong Wang <yh.wang@ibm.com>\n\nPR-URL: https://github.com/nodejs/node/pull/18626\nRefs: https://github.com/nodejs/node/issues/18535\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "ec9e7922bb72ce17b453d345232a0e725883a470",
    "files": [
        {
            "sha": "8e41cc053d4a78618e9daf7f0c0d9f1ddc9c84b0",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/ec9e7922bb72ce17b453d345232a0e725883a470/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/ec9e7922bb72ce17b453d345232a0e725883a470/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=ec9e7922bb72ce17b453d345232a0e725883a470",
            "patch": "@@ -260,6 +260,11 @@\n             }],\n           ],\n         }],\n+        [ 'node_shared==\"true\"', {\n+          'xcode_settings': {\n+            'OTHER_LDFLAGS': [ '-Wl,-rpath,@loader_path', ],\n+          },\n+        }],\n         [ 'node_intermediate_lib_type==\"shared_library\" and OS==\"win\"', {\n           # On Windows, having the same name for both executable and shared\n           # lib causes filename collision. Need a different PRODUCT_NAME for\n@@ -416,6 +421,10 @@\n       'conditions': [\n         [ 'node_shared==\"true\" and node_module_version!=\"\" and OS!=\"win\"', {\n           'product_extension': '<(shlib_suffix)',\n+          'xcode_settings': {\n+            'LD_DYLIB_INSTALL_NAME':\n+              '@rpath/lib<(node_core_target_name).<(shlib_suffix)'\n+          },\n         }],\n         ['node_shared==\"true\" and OS==\"aix\"', {\n           'product_name': 'node_base',\n@@ -1130,6 +1139,9 @@\n             '<@(library_files)',\n             'common.gypi',\n           ],\n+          'direct_dependent_settings': {\n+            'ldflags': [ '-Wl,-brtl' ],\n+          },\n         },\n       ]\n     }], # end aix section"
        },
        {
            "sha": "7ff7518ac31e6d4bf42874238ed37becb6bfdce5",
            "filename": "test/common/shared-lib-util.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fcommon%2Fshared-lib-util.js",
            "raw_url": "https://github.com/nodejs/node/raw/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fcommon%2Fshared-lib-util.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fshared-lib-util.js?ref=ec9e7922bb72ce17b453d345232a0e725883a470",
            "patch": "@@ -0,0 +1,29 @@\n+/* eslint-disable required-modules */\n+'use strict';\n+const path = require('path');\n+\n+// If node executable is linked to shared lib, need to take care about the\n+// shared lib path.\n+exports.addLibraryPath = function(env) {\n+  if (!process.config.variables.node_shared) {\n+    return;\n+  }\n+\n+  env = env || process.env;\n+\n+  env.LD_LIBRARY_PATH =\n+    (env.LD_LIBRARY_PATH ? env.LD_LIBRARY_PATH + path.delimiter : '') +\n+    path.join(path.dirname(process.execPath), 'lib.target');\n+  // For AIX.\n+  env.LIBPATH =\n+    (env.LIBPATH ? env.LIBPATH + path.delimiter : '') +\n+    path.join(path.dirname(process.execPath), 'lib.target');\n+  // For Mac OSX.\n+  env.DYLD_LIBRARY_PATH =\n+    (env.DYLD_LIBRARY_PATH ? env.DYLD_LIBRARY_PATH + path.delimiter : '') +\n+    path.dirname(process.execPath);\n+  // For Windows.\n+  env.PATH =\n+    (env.PATH ? env.PATH + path.delimiter : '') +\n+    path.dirname(process.execPath);\n+};"
        },
        {
            "sha": "8b94ef62a93bc801ad785418ee5b0ba6de700dda",
            "filename": "test/parallel/test-child-process-fork-exec-path.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fparallel%2Ftest-child-process-fork-exec-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fparallel%2Ftest-child-process-fork-exec-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-fork-exec-path.js?ref=ec9e7922bb72ce17b453d345232a0e725883a470",
            "patch": "@@ -28,6 +28,9 @@ const tmpdir = require('../common/tmpdir');\n const msg = { test: 'this' };\n const nodePath = process.execPath;\n const copyPath = path.join(tmpdir.path, 'node-copy.exe');\n+const { addLibraryPath } = require('../common/shared-lib-util');\n+\n+addLibraryPath(process.env);\n \n if (process.env.FORK) {\n   assert(process.send);"
        },
        {
            "sha": "e82e6ad4b9dd45eebcac86082568dbdf6a4f5732",
            "filename": "test/parallel/test-module-loading-globalpaths.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fparallel%2Ftest-module-loading-globalpaths.js",
            "raw_url": "https://github.com/nodejs/node/raw/ec9e7922bb72ce17b453d345232a0e725883a470/test%2Fparallel%2Ftest-module-loading-globalpaths.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-loading-globalpaths.js?ref=ec9e7922bb72ce17b453d345232a0e725883a470",
            "patch": "@@ -6,6 +6,9 @@ const path = require('path');\n const fs = require('fs');\n const child_process = require('child_process');\n const pkgName = 'foo';\n+const { addLibraryPath } = require('../common/shared-lib-util');\n+\n+addLibraryPath(process.env);\n \n if (process.argv[2] === 'child') {\n   console.log(require(pkgName).string);"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 47,
        "deletions": 0
    }
}