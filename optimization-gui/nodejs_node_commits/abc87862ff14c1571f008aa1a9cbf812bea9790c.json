{
    "author": "addaleax",
    "message": "async_wrap: fix use-after-free for inspector session\n\nThis fixes the following condition:\n\n    $ python -u tools/run-valgrind.py ./node_g test/sequential/test-inspector-async-call-stack.js\n    [...]\n    ==10848== Invalid read of size 4\n    ==10848==    at 0x12F509E: node::AsyncWrap::provider_type() const (async_wrap-inl.h:34)\n    ==10848==    by 0x12E7642: node::AsyncWrap::EmitTraceEventAfter() (async_wrap.cc:208)\n    ==10848==    by 0x12F301B: node::AsyncWrap::MakeCallback(v8::Local<v8::Function>, int, v8::Local<v8::Value>*) (async_wrap.cc:724)\n    ==10848==    by 0x14516C6: node::inspector::(anonymous namespace)::JSBindingsConnection::OnMessage(v8::Local<v8::Value>) (inspector_js_api.cc:88)\n    ==10848==    by 0x14514F1: node::inspector::(anonymous namespace)::JSBindingsConnection::JSBindingsSessionDelegate::SendMessageToFrontend(v8_inspector::StringView const&) (inspector_js_api.cc:57)\n    ==10848==    by 0x14436AD: node::inspector::(anonymous namespace)::ChannelImpl::sendMessageToFrontend(v8_inspector::StringView const&) (inspector_agent.cc:232)\n    ==10848==    by 0x1443627: node::inspector::(anonymous namespace)::ChannelImpl::sendResponse(int, std::unique_ptr<v8_inspector::StringBuffer, std::default_delete<v8_inspector::StringBuffer> >) (inspector_agent.cc:221)\n    ==10848==    by 0x15C54EA: v8_inspector::V8InspectorSessionImpl::sendProtocolResponse(int, std::unique_ptr<v8_inspector::protocol::Serializable, std::default_delete<v8_inspector::protocol::Serializable> >) (v8-inspector-session-impl.cc:165)\n    ==10848==    by 0x14C1E81: v8_inspector::protocol::DispatcherBase::sendResponse(int, v8_inspector::protocol::DispatchResponse const&, std::unique_ptr<v8_inspector::protocol::DictionaryValue, std::default_delete<v8_inspector::protocol::DictionaryValue> >) (Protocol.cpp:660)\n    ==10848==    by 0x14C1F0A: v8_inspector::protocol::DispatcherBase::sendResponse(int, v8_inspector::protocol::DispatchResponse const&) (Protocol.cpp:665)\n    ==10848==    by 0x14E68E3: v8_inspector::protocol::Debugger::DispatcherImpl::setAsyncCallStackDepth(int, std::unique_ptr<v8_inspector::protocol::DictionaryValue, std::default_delete<v8_inspector::protocol::DictionaryValue> >, v8_inspector::protocol::ErrorSupport*) (Debugger.cpp:1353)\n    ==10848==    by 0x14E2D49: v8_inspector::protocol::Debugger::DispatcherImpl::dispatch(int, v8_inspector::String16 const&, std::unique_ptr<v8_inspector::protocol::DictionaryValue, std::default_delete<v8_inspector::protocol::DictionaryValue> >) (Debugger.cpp:920)\n    ==10848==  Address 0x64e6f88 is 24 bytes inside a block of size 80 free'd\n    ==10848==    at 0x4C3123B: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\n    ==10848==    by 0x14534F8: node::inspector::(anonymous namespace)::JSBindingsConnection::~JSBindingsConnection() (inspector_js_api.cc:34)\n    ==10848==    by 0x145187E: node::inspector::(anonymous namespace)::JSBindingsConnection::Disconnect() (inspector_js_api.cc:111)\n    ==10848==    by 0x14518C9: node::inspector::(anonymous namespace)::JSBindingsConnection::Disconnect(v8::FunctionCallbackInfo<v8::Value> const&) (inspector_js_api.cc:117)\n    ==10848==    by 0x166FF87: v8::internal::FunctionCallbackArguments::Call(void (*)(v8::FunctionCallbackInfo<v8::Value> const&)) (api-arguments.cc:26)\n    ==10848==    by 0x172F829: v8::internal::MaybeHandle<v8::internal::Object> v8::internal::(anonymous namespace)::HandleApiCallHelper<false>(v8::internal::Isolate*, v8::internal::Handle<v8::internal::HeapObject>, v8::internal::Handle<v8::internal::HeapObject>, v8::internal::Handle<v8::internal::FunctionTemplateInfo>, v8::internal::Handle<v8::internal::Object>, v8::internal::BuiltinArguments) (builtins-api.cc:112)\n    ==10848==    by 0x172D85C: v8::internal::Builtin_Impl_HandleApiCall(v8::internal::BuiltinArguments, v8::internal::Isolate*) (builtins-api.cc:142)\n    ==10848==    by 0x172D5F6: v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) (builtins-api.cc:130)\n    ==10848==    by 0x7895E1842C3: ???\n    ==10848==    by 0x7895E19B737: ???\n    ==10848==    by 0x7895E19B737: ???\n    ==10848==    by 0x7895E18F9C2: ???\n    ==10848==  Block was alloc'd at\n    ==10848==    at 0x4C3017F: operator new(unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\n    ==10848==    by 0x14517E8: node::inspector::(anonymous namespace)::JSBindingsConnection::New(v8::FunctionCallbackInfo<v8::Value> const&) (inspector_js_api.cc:103)\n    ==10848==    by 0x166FF87: v8::internal::FunctionCallbackArguments::Call(void (*)(v8::FunctionCallbackInfo<v8::Value> const&)) (api-arguments.cc:26)\n    ==10848==    by 0x172F113: v8::internal::MaybeHandle<v8::internal::Object> v8::internal::(anonymous namespace)::HandleApiCallHelper<true>(v8::internal::Isolate*, v8::internal::Handle<v8::internal::HeapObject>, v8::internal::Handle<v8::internal::HeapObject>, v8::internal::Handle<v8::internal::FunctionTemplateInfo>, v8::internal::Handle<v8::internal::Object>, v8::internal::BuiltinArguments) (builtins-api.cc:112)\n    ==10848==    by 0x172D748: v8::internal::Builtin_Impl_HandleApiCall(v8::internal::BuiltinArguments, v8::internal::Isolate*) (builtins-api.cc:138)\n    ==10848==    by 0x172D5F6: v8::internal::Builtin_HandleApiCall(int, v8::internal::Object**, v8::internal::Isolate*) (builtins-api.cc:130)\n    ==10848==    by 0x7895E1842C3: ???\n    ==10848==    by 0x7895E1930DC: ???\n    ==10848==    by 0x7895E293EAA: ???\n    ==10848==    by 0x7895E19B737: ???\n    ==10848==    by 0x7895E19B737: ???\n    ==10848==    by 0x7895E19B737: ???\n    [...]\n\nPR-URL: https://github.com/nodejs/node/pull/19381\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "abc87862ff14c1571f008aa1a9cbf812bea9790c",
    "files": [
        {
            "sha": "de24239dd95167acbe6caf3973e5823e62f9fa57",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/abc87862ff14c1571f008aa1a9cbf812bea9790c/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/abc87862ff14c1571f008aa1a9cbf812bea9790c/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=abc87862ff14c1571f008aa1a9cbf812bea9790c",
            "patch": "@@ -202,13 +202,13 @@ void AsyncWrap::EmitBefore(Environment* env, double async_id) {\n }\n \n \n-void AsyncWrap::EmitTraceEventAfter() {\n-  switch (provider_type()) {\n+void AsyncWrap::EmitTraceEventAfter(ProviderType type, double async_id) {\n+  switch (type) {\n #define V(PROVIDER)                                                           \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n       TRACE_EVENT_NESTABLE_ASYNC_END0(                                        \\\n         TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n-        #PROVIDER \"_CALLBACK\", static_cast<int64_t>(get_async_id()));         \\\n+        #PROVIDER \"_CALLBACK\", static_cast<int64_t>(async_id));               \\\n       break;\n     NODE_ASYNC_PROVIDER_TYPES(V)\n #undef V\n@@ -314,7 +314,7 @@ static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n     wrap->EmitTraceEventBefore();\n     AsyncWrap::EmitBefore(wrap->env(), wrap->get_async_id());\n   } else if (type == PromiseHookType::kAfter) {\n-    wrap->EmitTraceEventAfter();\n+    wrap->EmitTraceEventAfter(wrap->provider_type(), wrap->get_async_id());\n     AsyncWrap::EmitAfter(wrap->env(), wrap->get_async_id());\n     if (env->execution_async_id() == wrap->get_async_id()) {\n       // This condition might not be true if async_hooks was enabled during\n@@ -701,11 +701,14 @@ MaybeLocal<Value> AsyncWrap::MakeCallback(const Local<Function> cb,\n                                           Local<Value>* argv) {\n   EmitTraceEventBefore();\n \n+  ProviderType provider = provider_type();\n   async_context context { get_async_id(), get_trigger_async_id() };\n   MaybeLocal<Value> ret = InternalMakeCallback(\n       env(), object(), cb, argc, argv, context);\n \n-  EmitTraceEventAfter();\n+  // This is a static call with cached values because the `this` object may\n+  // no longer be alive at this point.\n+  EmitTraceEventAfter(provider, context.async_id);\n \n   return ret;\n }"
        },
        {
            "sha": "17017ab602c84a5c42f63c8851f7d59565b9ef3c",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/abc87862ff14c1571f008aa1a9cbf812bea9790c/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/abc87862ff14c1571f008aa1a9cbf812bea9790c/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=abc87862ff14c1571f008aa1a9cbf812bea9790c",
            "patch": "@@ -142,7 +142,7 @@ class AsyncWrap : public BaseObject {\n   static void EmitPromiseResolve(Environment* env, double async_id);\n \n   void EmitTraceEventBefore();\n-  void EmitTraceEventAfter();\n+  static void EmitTraceEventAfter(ProviderType type, double async_id);\n   void EmitTraceEventDestroy();\n \n "
        }
    ],
    "stats": {
        "total": 15,
        "additions": 9,
        "deletions": 6
    }
}