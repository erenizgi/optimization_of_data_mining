{
    "author": "addaleax",
    "message": "tools: allow input for TTY tests\n\nSince faking TTY input is not otherwise fake-able, we need\nsupport in the test runner for it.\n\nPR-URL: https://github.com/nodejs/node/pull/23053\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f",
    "files": [
        {
            "sha": "920789844583de5f238b10b7a546e56354795990",
            "filename": "test/pseudo-tty/testcfg.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f/test%2Fpseudo-tty%2Ftestcfg.py",
            "raw_url": "https://github.com/nodejs/node/raw/d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f/test%2Fpseudo-tty%2Ftestcfg.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftestcfg.py?ref=d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f",
            "patch": "@@ -35,10 +35,11 @@\n \n class TTYTestCase(test.TestCase):\n \n-  def __init__(self, path, file, expected, arch, mode, context, config):\n+  def __init__(self, path, file, expected, input, arch, mode, context, config):\n     super(TTYTestCase, self).__init__(context, path, arch, mode)\n     self.file = file\n     self.expected = expected\n+    self.input = input\n     self.config = config\n     self.arch = arch\n     self.mode = mode\n@@ -104,12 +105,16 @@ def GetSource(self):\n           + open(self.expected).read())\n \n   def RunCommand(self, command, env):\n+    input = None\n+    if self.input is not None and exists(self.input):\n+      input = open(self.input).read()\n     full_command = self.context.processor(command)\n     output = test.Execute(full_command,\n                      self.context,\n                      self.context.GetTimeout(self.mode),\n                      env,\n-                     True)\n+                     faketty=True,\n+                     input=input)\n     return test.TestOutput(self,\n                       full_command,\n                       output,\n@@ -139,11 +144,12 @@ def ListTests(self, current_path, path, arch, mode):\n       if self.Contains(path, test):\n         file_prefix = join(self.root, reduce(join, test[1:], \"\"))\n         file_path = file_prefix + \".js\"\n+        input_path = file_prefix + \".in\"\n         output_path = file_prefix + \".out\"\n         if not exists(output_path):\n           raise Exception(\"Could not find %s\" % output_path)\n         result.append(TTYTestCase(test, file_path, output_path,\n-                                      arch, mode, self.context, self))\n+                                  input_path, arch, mode, self.context, self))\n     return result\n \n   def GetBuildRequirements(self):"
        },
        {
            "sha": "c5c9fb53c07626c493343bf73da9517c959dcdf2",
            "filename": "tools/test.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f/tools%2Ftest.py",
            "raw_url": "https://github.com/nodejs/node/raw/d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f/tools%2Ftest.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Ftest.py?ref=d0fc382c4b18a7021d0a93194bc4b304ed6f7d6f",
            "patch": "@@ -705,12 +705,23 @@ def CheckedUnlink(name):\n       PrintError(\"os.unlink() \" + str(e))\n     break\n \n-def Execute(args, context, timeout=None, env={}, faketty=False, disable_core_files=False):\n+def Execute(args, context, timeout=None, env={}, faketty=False, disable_core_files=False, input=None):\n   if faketty:\n     import pty\n     (out_master, fd_out) = pty.openpty()\n     fd_in = fd_err = fd_out\n     pty_out = out_master\n+\n+    if input is not None:\n+      # Before writing input data, disable echo so the input doesn't show\n+      # up as part of the output.\n+      import termios\n+      attr = termios.tcgetattr(fd_in)\n+      attr[3] = attr[3] & ~termios.ECHO\n+      termios.tcsetattr(fd_in, termios.TCSADRAIN, attr)\n+\n+      os.write(pty_out, input)\n+      os.write(pty_out, '\\x04') # End-of-file marker (Ctrl+D)\n   else:\n     (fd_out, outname) = tempfile.mkstemp()\n     (fd_err, errname) = tempfile.mkstemp()"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 21,
        "deletions": 4
    }
}