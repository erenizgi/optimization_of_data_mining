{
    "author": "unknown",
    "message": "stream: add a test case for the underlying cause.\n\nThe original test case hides the underlying cause by using\n`PassThrough`. This change adds a test case for the underlying cause.\nThis makes it clearer and easier to be understood.\n\nRefs: https://github.com/nodejs/node/pull/18372\n\nPR-URL: https://github.com/nodejs/node/pull/18575\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "86c659ba61dd923439335b240d81b38cab407acc",
    "files": [
        {
            "sha": "13ee2b498c4b96d736dcfc0d5c8d2c5d7d3dae76",
            "filename": "test/parallel/test-stream-readable-no-unneeded-readable.js",
            "status": "modified",
            "additions": 52,
            "deletions": 29,
            "changes": 81,
            "blob_url": "https://github.com/nodejs/node/blob/86c659ba61dd923439335b240d81b38cab407acc/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/86c659ba61dd923439335b240d81b38cab407acc/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js?ref=86c659ba61dd923439335b240d81b38cab407acc",
            "patch": "@@ -2,38 +2,61 @@\n const common = require('../common');\n const { Readable, PassThrough } = require('stream');\n \n-const source = new Readable({\n-  read: () => {}\n-});\n+function test(r) {\n+  const wrapper = new Readable({\n+    read: () => {\n+      let data = r.read();\n \n-source.push('foo');\n-source.push('bar');\n-source.push(null);\n-\n-const pt = source.pipe(new PassThrough());\n-\n-const wrapper = new Readable({\n-  read: () => {\n-    let data = pt.read();\n-\n-    if (data) {\n-      wrapper.push(data);\n-      return;\n-    }\n-\n-    pt.once('readable', function() {\n-      data = pt.read();\n       if (data) {\n         wrapper.push(data);\n+        return;\n       }\n-      // else the end event should fire\n-    });\n-  }\n-});\n \n-pt.once('end', function() {\n-  wrapper.push(null);\n-});\n+      r.once('readable', function() {\n+        data = r.read();\n+        if (data) {\n+          wrapper.push(data);\n+        }\n+        // else the end event should fire\n+      });\n+    },\n+  });\n+\n+  r.once('end', function() {\n+    wrapper.push(null);\n+  });\n+\n+  wrapper.resume();\n+  wrapper.once('end', common.mustCall());\n+}\n+\n+{\n+  const source = new Readable({\n+    read: () => {}\n+  });\n+  source.push('foo');\n+  source.push('bar');\n+  source.push(null);\n+\n+  const pt = source.pipe(new PassThrough());\n+  test(pt);\n+}\n+\n+{\n+  // This is the underlying cause of the above test case.\n+  const pushChunks = ['foo', 'bar'];\n+  const r = new Readable({\n+    read: () => {\n+      const chunk = pushChunks.shift();\n+      if (chunk) {\n+        // synchronous call\n+        r.push(chunk);\n+      } else {\n+        // asynchronous call\n+        process.nextTick(() => r.push(null));\n+      }\n+    },\n+  });\n \n-wrapper.resume();\n-wrapper.once('end', common.mustCall());\n+  test(r);\n+}"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 52,
        "deletions": 29
    }
}