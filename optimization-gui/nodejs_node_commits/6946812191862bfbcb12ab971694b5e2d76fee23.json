{
    "author": "vsemozhetbyt",
    "message": "tools: modernize and optimize doc/addon-verify.js\n\nModernize:\n* Replace `var` with `const` / `let`.\n* Replace common functions with arrow functions.\n* Use destructuring.\n* Use `String.prototype.padStart()`, `String.prototype.endsWith()`.\n\nOptimize:\n* Reduce function calls.\n* Reduce intermediate variables.\n* Cache retrieved object properties.\n* Move RegExp declaration out of a cycle.\n* Simplify RegExps.\n* Replace RegExp with string when string suffices.\n* Remove conditions that cannot be false.\n* Replace for..in with `Object.keys().forEach()`.\n\nAlso, eliminate needlessly complicated function chains:\n* `ondone` callback only checks errors;\n* if there is an error, it is called once and throws, then script exits;\n* if there are no errors, it is noop;\n* so there is no need to wrap it into `once()` function\n* and there is no need to call it without errors;\n* we can eliminate it and replace with `throw` where an error occurs;\n* we can also replace `onprogress` callback with `console.log` in place;\n* at last, we can eliminate `waiting` counter and `once()` utility.\n\nThe new script produces results identical to the old ones.\n\nPR-URL: https://github.com/nodejs/node/pull/20188\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "6946812191862bfbcb12ab971694b5e2d76fee23",
    "files": [
        {
            "sha": "a3d1beb4b8e12e14f7a70c1ba237cd1ededadfc6",
            "filename": "tools/doc/addon-verify.js",
            "status": "modified",
            "additions": 37,
            "deletions": 61,
            "changes": 98,
            "blob_url": "https://github.com/nodejs/node/blob/6946812191862bfbcb12ab971694b5e2d76fee23/tools%2Fdoc%2Faddon-verify.js",
            "raw_url": "https://github.com/nodejs/node/raw/6946812191862bfbcb12ab971694b5e2d76fee23/tools%2Fdoc%2Faddon-verify.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Faddon-verify.js?ref=6946812191862bfbcb12ab971694b5e2d76fee23",
            "patch": "@@ -1,68 +1,52 @@\n 'use strict';\n \n-const fs = require('fs');\n-const path = require('path');\n-const marked = require('marked');\n+const { mkdir, readFileSync, writeFile } = require('fs');\n+const { resolve } = require('path');\n+const { lexer } = require('marked');\n \n-const rootDir = path.resolve(__dirname, '..', '..');\n-const doc = path.resolve(rootDir, 'doc', 'api', 'addons.md');\n-const verifyDir = path.resolve(rootDir, 'test', 'addons');\n+const rootDir = resolve(__dirname, '..', '..');\n+const doc = resolve(rootDir, 'doc', 'api', 'addons.md');\n+const verifyDir = resolve(rootDir, 'test', 'addons');\n \n-const contents = fs.readFileSync(doc).toString();\n-\n-const tokens = marked.lexer(contents);\n+const tokens = lexer(readFileSync(doc, 'utf8'));\n+const addons = {};\n let id = 0;\n-\n let currentHeader;\n-const addons = {};\n-tokens.forEach((token) => {\n-  if (token.type === 'heading' && token.text) {\n-    currentHeader = token.text;\n-    addons[currentHeader] = {\n-      files: {}\n-    };\n+\n+const validNames = /^\\/\\/\\s+(.*\\.(?:cc|h|js))[\\r\\n]/;\n+tokens.forEach(({ type, text }) => {\n+  if (type === 'heading') {\n+    currentHeader = text;\n+    addons[currentHeader] = { files: {} };\n   }\n-  if (token.type === 'code') {\n-    var match = token.text.match(/^\\/\\/\\s+(.*\\.(?:cc|h|js))[\\r\\n]/);\n+  if (type === 'code') {\n+    const match = text.match(validNames);\n     if (match !== null) {\n-      addons[currentHeader].files[match[1]] = token.text;\n+      addons[currentHeader].files[match[1]] = text;\n     }\n   }\n });\n-for (var header in addons) {\n-  verifyFiles(addons[header].files,\n-              header,\n-              console.log.bind(null, 'wrote'),\n-              function(err) { if (err) throw err; });\n-}\n \n-function once(fn) {\n-  var once = false;\n-  return function() {\n-    if (once)\n-      return;\n-    once = true;\n-    fn.apply(this, arguments);\n-  };\n-}\n+Object.keys(addons).forEach((header) => {\n+  verifyFiles(addons[header].files, header);\n+});\n+\n+function verifyFiles(files, blockName) {\n+  const fileNames = Object.keys(files);\n \n-function verifyFiles(files, blockName, onprogress, ondone) {\n   // Must have a .cc and a .js to be a valid test.\n-  if (!Object.keys(files).some((name) => /\\.cc$/.test(name)) ||\n-      !Object.keys(files).some((name) => /\\.js$/.test(name))) {\n+  if (!fileNames.some((name) => name.endsWith('.cc')) ||\n+      !fileNames.some((name) => name.endsWith('.js'))) {\n     return;\n   }\n \n-  blockName = blockName\n-    .toLowerCase()\n-    .replace(/\\s/g, '_')\n-    .replace(/[^a-z\\d_]/g, '');\n-  const dir = path.resolve(\n+  blockName = blockName.toLowerCase().replace(/\\s/g, '_').replace(/\\W/g, '');\n+  const dir = resolve(\n     verifyDir,\n-    `${(++id < 10 ? '0' : '') + id}_${blockName}`\n+    `${String(++id).padStart(2, '0')}_${blockName}`\n   );\n \n-  files = Object.keys(files).map(function(name) {\n+  files = fileNames.map((name) => {\n     if (name === 'test.js') {\n       files[name] = `'use strict';\n const common = require('../../common');\n@@ -73,42 +57,34 @@ ${files[name].replace(\n `;\n     }\n     return {\n-      path: path.resolve(dir, name),\n+      path: resolve(dir, name),\n       name: name,\n       content: files[name]\n     };\n   });\n \n   files.push({\n-    path: path.resolve(dir, 'binding.gyp'),\n+    path: resolve(dir, 'binding.gyp'),\n     content: JSON.stringify({\n       targets: [\n         {\n           target_name: 'addon',\n           defines: [ 'V8_DEPRECATION_WARNINGS=1' ],\n-          sources: files.map(function(file) {\n-            return file.name;\n-          })\n+          sources: files.map(({ name }) => name)\n         }\n       ]\n     })\n   });\n \n-  fs.mkdir(dir, function() {\n+  mkdir(dir, () => {\n     // Ignore errors.\n \n-    const done = once(ondone);\n-    var waiting = files.length;\n-    files.forEach(function(file) {\n-      fs.writeFile(file.path, file.content, function(err) {\n+    files.forEach(({ path, content }) => {\n+      writeFile(path, content, (err) => {\n         if (err)\n-          return done(err);\n-\n-        if (onprogress)\n-          onprogress(file.path);\n+          throw err;\n \n-        if (--waiting === 0)\n-          done();\n+        console.log(`Wrote ${path}`);\n       });\n     });\n   });"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 37,
        "deletions": 61
    }
}