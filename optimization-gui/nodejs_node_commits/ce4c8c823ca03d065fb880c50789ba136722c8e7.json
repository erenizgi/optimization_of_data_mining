{
    "author": "joyeecheung",
    "message": "fs: return stats to JS in sync methods\n\n- Reduce reference to the global `statValues` by returning\n  the changed stats array from the synchronous methods. Having\n  a local returned value also makes the future integration\n  of BigInt easier.\n- Also returns the filled array from node::FillGlobalStatsArray\n  and node::FillStatsArray in the C++ side.\n\nPR-URL: https://github.com/nodejs/node/pull/20167\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "ce4c8c823ca03d065fb880c50789ba136722c8e7",
    "files": [
        {
            "sha": "d71e31565fbad61274a0a38c63e8dbfe4845d0a7",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 32,
            "deletions": 31,
            "changes": 63,
            "blob_url": "https://github.com/nodejs/node/blob/ce4c8c823ca03d065fb880c50789ba136722c8e7/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/ce4c8c823ca03d065fb880c50789ba136722c8e7/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=ce4c8c823ca03d065fb880c50789ba136722c8e7",
            "patch": "@@ -57,7 +57,6 @@ const {\n   preprocessSymlinkDestination,\n   Stats,\n   getStatsFromBinding,\n-  getStatsFromGlobalBinding,\n   stringToFlags,\n   stringToSymlinkType,\n   toUnixTimestamp,\n@@ -158,10 +157,10 @@ function isFd(path) {\n \n fs.Stats = Stats;\n \n-function isFileType(fileType) {\n+function isFileType(stats, fileType) {\n   // Use stats array directly to avoid creating an fs.Stats instance just for\n   // our internal use.\n-  return (statValues[1/* mode */] & S_IFMT) === fileType;\n+  return (stats[1/* mode */] & S_IFMT) === fileType;\n }\n \n // Don't allow mode to accidentally be overwritten.\n@@ -330,15 +329,15 @@ function readFileAfterOpen(err, fd) {\n   binding.fstat(fd, req);\n }\n \n-function readFileAfterStat(err) {\n+function readFileAfterStat(err, stats) {\n   var context = this.context;\n \n   if (err)\n     return context.close(err);\n \n   var size;\n-  if (isFileType(S_IFREG))\n-    size = context.size = statValues[8];\n+  if (isFileType(stats, S_IFREG))\n+    size = context.size = stats[8];\n   else\n     size = context.size = 0;\n \n@@ -411,11 +410,12 @@ function readFileAfterClose(err) {\n \n function tryStatSync(fd, isUserFd) {\n   const ctx = {};\n-  binding.fstat(fd, undefined, ctx);\n+  const stats = binding.fstat(fd, undefined, ctx);\n   if (ctx.errno !== undefined && !isUserFd) {\n     fs.closeSync(fd);\n     throw errors.uvException(ctx);\n   }\n+  return stats;\n }\n \n function tryCreateBuffer(size, fd, isUserFd) {\n@@ -450,10 +450,10 @@ fs.readFileSync = function(path, options) {\n   var isUserFd = isFd(path); // file descriptor ownership\n   var fd = isUserFd ? path : fs.openSync(path, options.flag || 'r', 0o666);\n \n-  tryStatSync(fd, isUserFd);\n+  const stats = tryStatSync(fd, isUserFd);\n   var size;\n-  if (isFileType(S_IFREG))\n-    size = statValues[8];\n+  if (isFileType(stats, S_IFREG))\n+    size = stats[8];\n   else\n     size = 0;\n   var pos = 0;\n@@ -890,27 +890,29 @@ fs.stat = function(path, callback) {\n fs.fstatSync = function(fd) {\n   validateUint32(fd, 'fd');\n   const ctx = { fd };\n-  binding.fstat(fd, undefined, ctx);\n+  const stats = binding.fstat(fd, undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return getStatsFromGlobalBinding();\n+  return getStatsFromBinding(stats);\n };\n \n fs.lstatSync = function(path) {\n   path = getPathFromURL(path);\n   validatePath(path);\n   const ctx = { path };\n-  binding.lstat(pathModule.toNamespacedPath(path), undefined, ctx);\n+  const stats = binding.lstat(pathModule.toNamespacedPath(path),\n+                              undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return getStatsFromGlobalBinding();\n+  return getStatsFromBinding(stats);\n };\n \n fs.statSync = function(path) {\n   path = getPathFromURL(path);\n   validatePath(path);\n   const ctx = { path };\n-  binding.stat(pathModule.toNamespacedPath(path), undefined, ctx);\n+  const stats = binding.stat(pathModule.toNamespacedPath(path),\n+                             undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return getStatsFromGlobalBinding();\n+  return getStatsFromBinding(stats);\n };\n \n fs.readlink = function(path, options, callback) {\n@@ -1439,7 +1441,7 @@ function StatWatcher() {\n   this._handle.onchange = function(newStatus, stats) {\n     if (oldStatus === -1 &&\n         newStatus === -1 &&\n-        statValues[2/* new nlink */] === statValues[16/* old nlink */]) return;\n+        stats[2/* new nlink */] === stats[16/* old nlink */]) return;\n \n     oldStatus = newStatus;\n     self.emit('change', getStatsFromBinding(stats),\n@@ -1666,7 +1668,8 @@ fs.realpathSync = function realpathSync(p, options) {\n \n     // continue if not a symlink, break if a pipe/socket\n     if (knownHard[base] || (cache && cache.get(base) === base)) {\n-      if (isFileType(S_IFIFO) || isFileType(S_IFSOCK)) {\n+      if (isFileType(statValues, S_IFIFO) ||\n+          isFileType(statValues, S_IFSOCK)) {\n         break;\n       }\n       continue;\n@@ -1682,10 +1685,10 @@ fs.realpathSync = function realpathSync(p, options) {\n \n       var baseLong = pathModule.toNamespacedPath(base);\n       const ctx = { path: base };\n-      binding.lstat(baseLong, undefined, ctx);\n+      const stats = binding.lstat(baseLong, undefined, ctx);\n       handleErrorFromBinding(ctx);\n \n-      if (!isFileType(S_IFLNK)) {\n+      if (!isFileType(stats, S_IFLNK)) {\n         knownHard[base] = true;\n         if (cache) cache.set(base, base);\n         continue;\n@@ -1696,8 +1699,8 @@ fs.realpathSync = function realpathSync(p, options) {\n       var linkTarget = null;\n       var id;\n       if (!isWindows) {\n-        var dev = statValues[0].toString(32);\n-        var ino = statValues[7].toString(32);\n+        var dev = stats[0].toString(32);\n+        var ino = stats[7].toString(32);\n         id = `${dev}:${ino}`;\n         if (seenLinks[id]) {\n           linkTarget = seenLinks[id];\n@@ -1778,7 +1781,7 @@ fs.realpath = function realpath(p, options, callback) {\n \n   // On windows, check that the root exists. On unix there is no need.\n   if (isWindows && !knownHard[base]) {\n-    fs.lstat(base, function(err) {\n+    fs.lstat(base, function(err, stats) {\n       if (err) return callback(err);\n       knownHard[base] = true;\n       LOOP();\n@@ -1811,7 +1814,8 @@ fs.realpath = function realpath(p, options, callback) {\n \n     // continue if not a symlink, break if a pipe/socket\n     if (knownHard[base]) {\n-      if (isFileType(S_IFIFO) || isFileType(S_IFSOCK)) {\n+      if (isFileType(statValues, S_IFIFO) ||\n+          isFileType(statValues, S_IFSOCK)) {\n         return callback(null, encodeRealpathResult(p, options));\n       }\n       return process.nextTick(LOOP);\n@@ -1820,14 +1824,11 @@ fs.realpath = function realpath(p, options, callback) {\n     return fs.lstat(base, gotStat);\n   }\n \n-  function gotStat(err) {\n+  function gotStat(err, stats) {\n     if (err) return callback(err);\n \n-    // Use stats array directly to avoid creating an fs.Stats instance just for\n-    // our internal use.\n-\n     // if not a symlink, skip to the next path part\n-    if (!isFileType(S_IFLNK)) {\n+    if (!stats.isSymbolicLink()) {\n       knownHard[base] = true;\n       return process.nextTick(LOOP);\n     }\n@@ -1837,8 +1838,8 @@ fs.realpath = function realpath(p, options, callback) {\n     // dev/ino always return 0 on windows, so skip the check.\n     let id;\n     if (!isWindows) {\n-      var dev = statValues[0].toString(32);\n-      var ino = statValues[7].toString(32);\n+      var dev = stats.dev.toString(32);\n+      var ino = stats.ino.toString(32);\n       id = `${dev}:${ino}`;\n       if (seenLinks[id]) {\n         return gotTarget(null, seenLinks[id], base);"
        },
        {
            "sha": "0cfb89a9d3d084614e06321f1c3ae1613c299a2e",
            "filename": "lib/internal/fs.js",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/ce4c8c823ca03d065fb880c50789ba136722c8e7/lib%2Finternal%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/ce4c8c823ca03d065fb880c50789ba136722c8e7/lib%2Finternal%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs.js?ref=ce4c8c823ca03d065fb880c50789ba136722c8e7",
            "patch": "@@ -35,7 +35,6 @@ const {\n   UV_FS_SYMLINK_DIR,\n   UV_FS_SYMLINK_JUNCTION\n } = process.binding('constants').fs;\n-const { statValues } = process.binding('fs');\n \n const isWindows = process.platform === 'win32';\n \n@@ -217,10 +216,6 @@ function getStatsFromBinding(stats, offset = 0) {\n                    stats[12 + offset], stats[13 + offset]);\n }\n \n-function getStatsFromGlobalBinding(offset = 0) {\n-  return getStatsFromBinding(statValues, offset);\n-}\n-\n function stringToFlags(flags) {\n   if (typeof flags === 'number') {\n     return flags;\n@@ -442,7 +437,6 @@ module.exports = {\n   preprocessSymlinkDestination,\n   realpathCacheKey: Symbol('realpathCacheKey'),\n   getStatsFromBinding,\n-  getStatsFromGlobalBinding,\n   stringToFlags,\n   stringToSymlinkType,\n   Stats,"
        },
        {
            "sha": "89c53afc5b197e68af8a9b5140501eacd6d98ac3",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 11,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=ce4c8c823ca03d065fb880c50789ba136722c8e7",
            "patch": "@@ -410,8 +410,7 @@ void FSReqWrap::Reject(Local<Value> reject) {\n }\n \n void FSReqWrap::ResolveStat(const uv_stat_t* stat) {\n-  node::FillGlobalStatsArray(env(), stat);\n-  Resolve(env()->fs_stats_field_array()->GetJSArray());\n+  Resolve(node::FillGlobalStatsArray(env(), stat));\n }\n \n void FSReqWrap::Resolve(Local<Value> value) {\n@@ -832,10 +831,13 @@ static void Stat(const FunctionCallbackInfo<Value>& args) {\n     FS_SYNC_TRACE_BEGIN(stat);\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"stat\", uv_fs_stat, *path);\n     FS_SYNC_TRACE_END(stat);\n-    if (err == 0) {\n-      node::FillGlobalStatsArray(env,\n-          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    if (err != 0) {\n+      return;  // error info is in ctx\n     }\n+\n+    Local<Value> arr = node::FillGlobalStatsArray(env,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    args.GetReturnValue().Set(arr);\n   }\n }\n \n@@ -859,10 +861,13 @@ static void LStat(const FunctionCallbackInfo<Value>& args) {\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"lstat\", uv_fs_lstat,\n                        *path);\n     FS_SYNC_TRACE_END(lstat);\n-    if (err == 0) {\n-      node::FillGlobalStatsArray(env,\n-          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    if (err != 0) {\n+      return;  // error info is in ctx\n     }\n+\n+    Local<Value> arr = node::FillGlobalStatsArray(env,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    args.GetReturnValue().Set(arr);\n   }\n }\n \n@@ -885,10 +890,13 @@ static void FStat(const FunctionCallbackInfo<Value>& args) {\n     FS_SYNC_TRACE_BEGIN(fstat);\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"fstat\", uv_fs_fstat, fd);\n     FS_SYNC_TRACE_END(fstat);\n-    if (err == 0) {\n-      node::FillGlobalStatsArray(env,\n-          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    if (err != 0) {\n+      return;  // error info is in ctx\n     }\n+\n+    Local<Value> arr = node::FillGlobalStatsArray(env,\n+        static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+    args.GetReturnValue().Set(arr);\n   }\n }\n "
        },
        {
            "sha": "50047e330724fe5734282792268fc06aeed03b3d",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=ce4c8c823ca03d065fb880c50789ba136722c8e7",
            "patch": "@@ -313,7 +313,7 @@ v8::Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                               const char* deprecation_code);\n \n template <typename NativeT, typename V8T>\n-void FillStatsArray(AliasedBuffer<NativeT, V8T>* fields_ptr,\n+v8::Local<v8::Value> FillStatsArray(AliasedBuffer<NativeT, V8T>* fields_ptr,\n                     const uv_stat_t* s, int offset = 0) {\n   AliasedBuffer<NativeT, V8T>& fields = *fields_ptr;\n   fields[offset + 0] = s->st_dev;\n@@ -347,12 +347,14 @@ void FillStatsArray(AliasedBuffer<NativeT, V8T>* fields_ptr,\n   X(12, ctim)\n   X(13, birthtim)\n #undef X\n+\n+  return fields_ptr->GetJSArray();\n }\n \n-inline void FillGlobalStatsArray(Environment* env,\n-                                 const uv_stat_t* s,\n-                                 int offset = 0) {\n-  node::FillStatsArray(env->fs_stats_field_array(), s, offset);\n+inline v8::Local<v8::Value> FillGlobalStatsArray(Environment* env,\n+                                                 const uv_stat_t* s,\n+                                                 int offset = 0) {\n+  return node::FillStatsArray(env->fs_stats_field_array(), s, offset);\n }\n \n void SetupProcessObject(Environment* env,"
        },
        {
            "sha": "41683a0dc1d36c521933b11a5eb34864803c9ac8",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ce4c8c823ca03d065fb880c50789ba136722c8e7/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=ce4c8c823ca03d065fb880c50789ba136722c8e7",
            "patch": "@@ -108,12 +108,12 @@ void StatWatcher::Callback(uv_fs_poll_t* handle,\n   HandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(env->context());\n \n-  node::FillGlobalStatsArray(env, curr);\n+  Local<Value> arr = node::FillGlobalStatsArray(env, curr);\n   node::FillGlobalStatsArray(env, prev, env->kFsStatsFieldsLength);\n \n   Local<Value> argv[2] {\n     Integer::New(env->isolate(), status),\n-    env->fs_stats_field_array()->GetJSArray()\n+    arr\n   };\n   wrap->MakeCallback(env->onchange_string(), arraysize(argv), argv);\n }"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 60,
        "deletions": 55
    }
}