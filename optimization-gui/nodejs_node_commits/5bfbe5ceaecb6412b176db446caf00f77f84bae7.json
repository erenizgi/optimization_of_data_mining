{
    "author": "bnoordhuis",
    "message": "tls: drop NPN (next protocol negotiation) support\n\nNPN has been superseded by ALPN.  Chrome and Firefox removed support for\nNPN in 2016 and 2017 respectively to no ill effect.\n\nFixes: https://github.com/nodejs/node/issues/14602\nPR-URL: https://github.com/nodejs/node/pull/19403\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "5bfbe5ceaecb6412b176db446caf00f77f84bae7",
    "files": [
        {
            "sha": "d6d2589083bbcecea37cf0e716f84183ef35ba56",
            "filename": "deps/openssl/openssl.gypi",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/deps%2Fopenssl%2Fopenssl.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/deps%2Fopenssl%2Fopenssl.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fopenssl%2Fopenssl.gypi?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -1268,6 +1268,9 @@\n       # the real driver but that poses a security liability when an attacker\n       # is able to create a malicious DLL in one of the default search paths.\n       'OPENSSL_NO_HW',\n+\n+      # Disable NPN (Next Protocol Negotiation), superseded by ALPN.\n+      'OPENSSL_NO_NEXTPROTONEG',\n     ],\n     'openssl_default_defines_win': [\n       'MK1MF_BUILD',"
        },
        {
            "sha": "f90c2cfe2e3465fed5c35ae59320686d28fe646d",
            "filename": "doc/api/crypto.md",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/doc%2Fapi%2Fcrypto.md",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/doc%2Fapi%2Fcrypto.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcrypto.md?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -2412,10 +2412,6 @@ the `crypto`, `tls`, and `https` modules and are generally specific to OpenSSL.\n     <td><code>DH_NOT_SUITABLE_GENERATOR</code></td>\n     <td></td>\n   </tr>\n-  <tr>\n-    <td><code>NPN_ENABLED</code></td>\n-    <td></td>\n-  </tr>\n   <tr>\n     <td><code>ALPN_ENABLED</code></td>\n     <td></td>"
        },
        {
            "sha": "f519681c62a690acddd7be8976732e5640f7d80f",
            "filename": "doc/api/tls.md",
            "status": "modified",
            "additions": 12,
            "deletions": 40,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/doc%2Fapi%2Ftls.md",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/doc%2Fapi%2Ftls.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftls.md?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -104,22 +104,17 @@ not required and a default ECDHE curve will be used. The `ecdhCurve` property\n can be used when creating a TLS Server to specify the list of names of supported\n curves to use, see [`tls.createServer()`] for more info.\n \n-### ALPN, NPN, and SNI\n+### ALPN and SNI\n \n <!-- type=misc -->\n \n-ALPN (Application-Layer Protocol Negotiation Extension), NPN (Next\n-Protocol Negotiation) and, SNI (Server Name Indication) are TLS\n-handshake extensions:\n+ALPN (Application-Layer Protocol Negotiation Extension) and\n+SNI (Server Name Indication) are TLS handshake extensions:\n \n-* ALPN/NPN - Allows the use of one TLS server for multiple protocols (HTTP,\n-  SPDY, HTTP/2)\n+* ALPN - Allows the use of one TLS server for multiple protocols (HTTP, HTTP/2)\n * SNI - Allows the use of one TLS server for multiple hostnames with different\n   SSL certificates.\n \n-Use of ALPN is recommended over NPN. The NPN extension has never been\n-formally defined or documented and generally not recommended for use.\n-\n ### Client-initiated renegotiation attack mitigation\n \n <!-- type=misc -->\n@@ -332,12 +327,9 @@ server. If `tlsSocket.authorized` is `false`, then `socket.authorizationError`\n is set to describe how authorization failed. Note that depending on the settings\n of the TLS server, unauthorized connections may still be accepted.\n \n-The `tlsSocket.npnProtocol` and `tlsSocket.alpnProtocol` properties are strings\n-that contain the selected NPN and ALPN protocols, respectively. When both NPN\n-and ALPN extensions are received, ALPN takes precedence over NPN and the next\n-protocol is selected by ALPN.\n-\n-When ALPN has no selected protocol, `tlsSocket.alpnProtocol` returns `false`.\n+The `tlsSocket.alpnProtocol` property is a string that contains the selected\n+ALPN protocol. When ALPN has no selected protocol, `tlsSocket.alpnProtocol`\n+equals `false`.\n \n The `tlsSocket.servername` property is a string containing the server name\n requested via SNI.\n@@ -468,7 +460,6 @@ changes:\n      (`isServer` is true) may optionally set `requestCert` to true to request a\n      client certificate.\n   * `rejectUnauthorized`: Optional, see [`tls.createServer()`][]\n-  * `NPNProtocols`: Optional, see [`tls.createServer()`][]\n   * `ALPNProtocols`: Optional, see [`tls.createServer()`][]\n   * `SNICallback`: Optional, see [`tls.createServer()`][]\n   * `session` {Buffer} An optional `Buffer` instance containing a TLS session.\n@@ -509,9 +500,9 @@ regardless of whether or not the server's certificate has been authorized. It\n is the client's responsibility to check the `tlsSocket.authorized` property to\n determine if the server certificate was signed by one of the specified CAs. If\n `tlsSocket.authorized === false`, then the error can be found by examining the\n-`tlsSocket.authorizationError` property. If either ALPN or NPN was used,\n-the `tlsSocket.alpnProtocol` or `tlsSocket.npnProtocol` properties can be\n-checked to determine the negotiated protocol.\n+`tlsSocket.authorizationError` property. If ALPN was used, the\n+`tlsSocket.alpnProtocol` property can be checked to determine the negotiated\n+protocol.\n \n ### tlsSocket.address()\n <!-- YAML\n@@ -841,8 +832,7 @@ changes:\n     description: The `lookup` option is supported now.\n   - version: v8.0.0\n     pr-url: https://github.com/nodejs/node/pull/11984\n-    description: The `ALPNProtocols` and `NPNProtocols` options can\n-                 be `Uint8Array`s now.\n+    description: The `ALPNProtocols` option can be a `Uint8Array` now.\n   - version: v5.3.0, v4.7.0\n     pr-url: https://github.com/nodejs/node/pull/4246\n     description: The `secureContext` option is supported now.\n@@ -869,12 +859,6 @@ changes:\n     verified against the list of supplied CAs. An `'error'` event is emitted if\n     verification fails; `err.code` contains the OpenSSL error code. Defaults to\n     `true`.\n-  * `NPNProtocols` {string[]|Buffer[]|Uint8Array[]|Buffer|Uint8Array}\n-    An array of strings, `Buffer`s or `Uint8Array`s, or a single `Buffer` or\n-    `Uint8Array` containing supported NPN protocols. `Buffer`s should have the\n-    format `[len][name][len][name]...` e.g. `0x05hello0x05world`, where the\n-    first byte is the length of the next protocol name. Passing an array is\n-    usually much simpler, e.g. `['hello', 'world']`.\n   * `ALPNProtocols`: {string[]|Buffer[]|Uint8Array[]|Buffer|Uint8Array}\n     An array of strings, `Buffer`s or `Uint8Array`s, or a single `Buffer` or\n     `Uint8Array` containing the supported ALPN protocols. `Buffer`s should have\n@@ -1116,8 +1100,7 @@ changes:\n     description: The `options` parameter can now include `clientCertEngine`.\n   - version: v8.0.0\n     pr-url: https://github.com/nodejs/node/pull/11984\n-    description: The `ALPNProtocols` and `NPNProtocols` options can\n-                 be `Uint8Array`s now.\n+    description: The `ALPNProtocols` option can be a `Uint8Array` now.\n   - version: v5.0.0\n     pr-url: https://github.com/nodejs/node/pull/2564\n     description: ALPN options are supported now.\n@@ -1136,23 +1119,13 @@ changes:\n   * `rejectUnauthorized` {boolean} If not `false` the server will reject any\n     connection which is not authorized with the list of supplied CAs. This\n     option only has an effect if `requestCert` is `true`. Defaults to `true`.\n-  * `NPNProtocols` {string[]|Buffer[]|Uint8Array[]|Buffer|Uint8Array}\n-    An array of strings, `Buffer`s or `Uint8Array`s, or a single `Buffer` or\n-    `Uint8Array` containing supported NPN protocols. `Buffer`s should have the\n-    format `[len][name][len][name]...` e.g. `0x05hello0x05world`, where the\n-    first byte is the length of the next protocol name. Passing an array is\n-    usually much simpler, e.g. `['hello', 'world']`.\n-    (Protocols should be ordered by their priority.)\n   * `ALPNProtocols`: {string[]|Buffer[]|Uint8Array[]|Buffer|Uint8Array}\n     An array of strings, `Buffer`s or `Uint8Array`s, or a single `Buffer` or\n     `Uint8Array` containing the supported ALPN protocols. `Buffer`s should have\n     the format `[len][name][len][name]...` e.g. `0x05hello0x05world`, where the\n     first byte is the length of the next protocol name. Passing an array is\n     usually much simpler, e.g. `['hello', 'world']`.\n     (Protocols should be ordered by their priority.)\n-    When the server receives both NPN and ALPN extensions from the client,\n-    ALPN takes precedence over NPN and the server does not send an NPN\n-    extension to the client.\n   * `SNICallback(servername, cb)` {Function} A function that will be called if\n     the client supports SNI TLS extension. Two arguments will be passed when\n     called: `servername` and `cb`. `SNICallback` should invoke `cb(null, ctx)`,\n@@ -1333,7 +1306,6 @@ changes:\n   * `server` {net.Server} An optional [`net.Server`][] instance\n   * `requestCert`: Optional, see [`tls.createServer()`][]\n   * `rejectUnauthorized`: Optional, see [`tls.createServer()`][]\n-  * `NPNProtocols`: Optional, see [`tls.createServer()`][]\n   * `ALPNProtocols`: Optional, see [`tls.createServer()`][]\n   * `SNICallback`: Optional, see [`tls.createServer()`][]\n   * `session` {Buffer} An optional `Buffer` instance containing a TLS session."
        },
        {
            "sha": "2e6b2e8da559db6ef01541e9e5bd8d1d60c9305b",
            "filename": "lib/_tls_wrap.js",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/lib%2F_tls_wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/lib%2F_tls_wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_wrap.js?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -294,8 +294,6 @@ function initRead(tls, wrapped) {\n function TLSSocket(socket, opts) {\n   const tlsOptions = Object.assign({}, opts);\n \n-  if (tlsOptions.NPNProtocols)\n-    tls.convertNPNProtocols(tlsOptions.NPNProtocols, tlsOptions);\n   if (tlsOptions.ALPNProtocols)\n     tls.convertALPNProtocols(tlsOptions.ALPNProtocols, tlsOptions);\n \n@@ -306,7 +304,6 @@ function TLSSocket(socket, opts) {\n   this._controlReleased = false;\n   this._SNICallback = null;\n   this.servername = null;\n-  this.npnProtocol = null;\n   this.alpnProtocol = null;\n   this.authorized = false;\n   this.authorizationError = null;\n@@ -529,9 +526,6 @@ TLSSocket.prototype._init = function(socket, wrap) {\n     ssl.enableCertCb();\n   }\n \n-  if (process.features.tls_npn && options.NPNProtocols)\n-    ssl.setNPNProtocols(options.NPNProtocols);\n-\n   if (process.features.tls_alpn && options.ALPNProtocols) {\n     // keep reference in secureContext not to be GC-ed\n     ssl._secureContext.alpnBuffer = options.ALPNProtocols;\n@@ -630,10 +624,6 @@ TLSSocket.prototype._releaseControl = function() {\n };\n \n TLSSocket.prototype._finishInit = function() {\n-  if (process.features.tls_npn) {\n-    this.npnProtocol = this._handle.getNegotiatedProtocol();\n-  }\n-\n   if (process.features.tls_alpn) {\n     this.alpnProtocol = this._handle.getALPNNegotiatedProtocol();\n   }\n@@ -790,7 +780,6 @@ function tlsConnectionListener(rawSocket) {\n     requestCert: this.requestCert,\n     rejectUnauthorized: this.rejectUnauthorized,\n     handshakeTimeout: this[kHandshakeTimeout],\n-    NPNProtocols: this.NPNProtocols,\n     ALPNProtocols: this.ALPNProtocols,\n     SNICallback: this[kSNICallback] || SNICallback\n   });\n@@ -982,7 +971,6 @@ Server.prototype.setOptions = function(options) {\n   else\n     this.honorCipherOrder = true;\n   if (secureOptions) this.secureOptions = secureOptions;\n-  if (options.NPNProtocols) tls.convertNPNProtocols(options.NPNProtocols, this);\n   if (options.ALPNProtocols)\n     tls.convertALPNProtocols(options.ALPNProtocols, this);\n   if (options.sessionIdContext) {\n@@ -1149,7 +1137,6 @@ exports.connect = function(...args /* [port,] [host,] [options,] [cb] */) {\n     requestCert: true,\n     rejectUnauthorized: options.rejectUnauthorized !== false,\n     session: options.session,\n-    NPNProtocols: options.NPNProtocols,\n     ALPNProtocols: options.ALPNProtocols,\n     requestOCSP: options.requestOCSP\n   });"
        },
        {
            "sha": "4cca2fb9eeea88a7c1295b68b13cb357c34b5451",
            "filename": "lib/https.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/lib%2Fhttps.js",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/lib%2Fhttps.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttps.js?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -49,10 +49,6 @@ function Server(opts, requestListener) {\n   }\n   opts = util._extend({}, opts);\n \n-  if (process.features.tls_npn && !opts.NPNProtocols) {\n-    opts.NPNProtocols = ['http/1.1', 'http/1.0'];\n-  }\n-\n   if (process.features.tls_alpn && !opts.ALPNProtocols) {\n     // http/1.0 is not defined as Protocol IDs in IANA\n     // http://www.iana.org/assignments/tls-extensiontype-values"
        },
        {
            "sha": "97dd639bc5e4df2f49df7608313708eceae0d7bd",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -586,8 +586,8 @@\n             'mkssldef_flags': [\n               # Categories to export.\n               '-CAES,BF,BIO,DES,DH,DSA,EC,ECDH,ECDSA,ENGINE,EVP,HMAC,MD4,MD5,'\n-              'NEXTPROTONEG,PSK,RC2,RC4,RSA,SHA,SHA0,SHA1,SHA256,SHA512,SOCK,'\n-              'STDIO,TLSEXT,FP_API',\n+              'PSK,RC2,RC4,RSA,SHA,SHA0,SHA1,SHA256,SHA512,SOCK,STDIO,TLSEXT,'\n+              'FP_API',\n               # Defines.\n               '-DWIN32',\n               # Symbols to filter from the export list."
        },
        {
            "sha": "a688f7be505fa2f6ac182c35004163d38fbd79a2",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -103,8 +103,6 @@ struct PackageConfig {\n   V(contextify_context_private_symbol, \"node:contextify:context\")             \\\n   V(contextify_global_private_symbol, \"node:contextify:global\")               \\\n   V(decorated_private_symbol, \"node:decorated\")                               \\\n-  V(npn_buffer_private_symbol, \"node:npnBuffer\")                              \\\n-  V(selected_npn_buffer_private_symbol, \"node:selectedNpnBuffer\")             \\\n   V(napi_env, \"node:napi:env\")                                                \\\n   V(napi_wrapper, \"node:napi:wrapper\")                                        \\\n "
        },
        {
            "sha": "b5084331156bb633901fe3980951989b3cee6ca0",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -2824,13 +2824,6 @@ static Local<Object> GetFeatures(Environment* env) {\n   // TODO(bnoordhuis) ping libuv\n   obj->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"ipv6\"), True(env->isolate()));\n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-  Local<Boolean> tls_npn = True(env->isolate());\n-#else\n-  Local<Boolean> tls_npn = False(env->isolate());\n-#endif\n-  obj->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"tls_npn\"), tls_npn);\n-\n #ifdef TLSEXT_TYPE_application_layer_protocol_negotiation\n   Local<Boolean> tls_alpn = True(env->isolate());\n #else"
        },
        {
            "sha": "2eaf622da7d4c4e79a27ce78ce9d436031a25d40",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -971,11 +971,6 @@ void DefineOpenSSLConstants(Local<Object> target) {\n     NODE_DEFINE_CONSTANT(target, DH_NOT_SUITABLE_GENERATOR);\n #endif\n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-#define NPN_ENABLED 1\n-    NODE_DEFINE_CONSTANT(target, NPN_ENABLED);\n-#endif\n-\n #ifdef TLSEXT_TYPE_application_layer_protocol_negotiation\n #define ALPN_ENABLED 1\n     NODE_DEFINE_CONSTANT(target, ALPN_ENABLED);"
        },
        {
            "sha": "57dbe6861dc9cda43741b7573f633f695e61a68c",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 179,
            "changes": 182,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -81,7 +81,6 @@ using v8::DontDelete;\n using v8::EscapableHandleScope;\n using v8::Exception;\n using v8::External;\n-using v8::False;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n using v8::HandleScope;\n@@ -231,7 +230,7 @@ static X509_STORE* root_cert_store;\n // Just to generate static methods\n template void SSLWrap<TLSWrap>::AddMethods(Environment* env,\n                                            Local<FunctionTemplate> t);\n-template void SSLWrap<TLSWrap>::InitNPN(SecureContext* sc);\n+template void SSLWrap<TLSWrap>::ConfigureSecureContext(SecureContext* sc);\n template void SSLWrap<TLSWrap>::SetSNIContext(SecureContext* sc);\n template int SSLWrap<TLSWrap>::SetCACerts(SecureContext* sc);\n #if OPENSSL_VERSION_NUMBER < 0x10100000L\n@@ -253,21 +252,6 @@ template void SSLWrap<TLSWrap>::OnClientHello(\n     void* arg,\n     const ClientHelloParser::ClientHello& hello);\n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-template int SSLWrap<TLSWrap>::AdvertiseNextProtoCallback(\n-    SSL* s,\n-    const unsigned char** data,\n-    unsigned int* len,\n-    void* arg);\n-template int SSLWrap<TLSWrap>::SelectNextProtoCallback(\n-    SSL* s,\n-    unsigned char** out,\n-    unsigned char* outlen,\n-    const unsigned char* in,\n-    unsigned int inlen,\n-    void* arg);\n-#endif\n-\n #ifdef NODE__HAVE_TLSEXT_STATUS_CB\n template int SSLWrap<TLSWrap>::TLSExtStatusCallback(SSL* s, void* arg);\n #endif\n@@ -1593,31 +1577,13 @@ void SSLWrap<Base>::AddMethods(Environment* env, Local<FunctionTemplate> t) {\n   env->SetProtoMethod(t, \"setMaxSendFragment\", SetMaxSendFragment);\n #endif  // SSL_set_max_send_fragment\n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-  env->SetProtoMethod(t, \"getNegotiatedProtocol\", GetNegotiatedProto);\n-#endif  // OPENSSL_NO_NEXTPROTONEG\n-\n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-  env->SetProtoMethod(t, \"setNPNProtocols\", SetNPNProtocols);\n-#endif\n-\n   env->SetProtoMethod(t, \"getALPNNegotiatedProtocol\", GetALPNNegotiatedProto);\n   env->SetProtoMethod(t, \"setALPNProtocols\", SetALPNProtocols);\n }\n \n \n template <class Base>\n-void SSLWrap<Base>::InitNPN(SecureContext* sc) {\n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-  // Server should advertise NPN protocols\n-  SSL_CTX_set_next_protos_advertised_cb(sc->ctx_,\n-                                        AdvertiseNextProtoCallback,\n-                                        nullptr);\n-  // Client should select protocol from list of advertised\n-  // If server supports NPN\n-  SSL_CTX_set_next_proto_select_cb(sc->ctx_, SelectNextProtoCallback, nullptr);\n-#endif  // OPENSSL_NO_NEXTPROTONEG\n-\n+void SSLWrap<Base>::ConfigureSecureContext(SecureContext* sc) {\n #ifdef NODE__HAVE_TLSEXT_STATUS_CB\n   // OCSP stapling\n   SSL_CTX_set_tlsext_status_cb(sc->ctx_, TLSExtStatusCallback);\n@@ -2474,148 +2440,6 @@ void SSLWrap<Base>::GetProtocol(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-template <class Base>\n-int SSLWrap<Base>::AdvertiseNextProtoCallback(SSL* s,\n-                                              const unsigned char** data,\n-                                              unsigned int* len,\n-                                              void* arg) {\n-  Base* w = static_cast<Base*>(SSL_get_app_data(s));\n-  Environment* env = w->env();\n-  HandleScope handle_scope(env->isolate());\n-  Context::Scope context_scope(env->context());\n-\n-  auto npn_buffer =\n-      w->object()->GetPrivate(\n-          env->context(),\n-          env->npn_buffer_private_symbol()).ToLocalChecked();\n-\n-  if (npn_buffer->IsUndefined()) {\n-    // No initialization - no NPN protocols\n-    *data = reinterpret_cast<const unsigned char*>(\"\");\n-    *len = 0;\n-  } else {\n-    CHECK(Buffer::HasInstance(npn_buffer));\n-    *data = reinterpret_cast<const unsigned char*>(Buffer::Data(npn_buffer));\n-    *len = Buffer::Length(npn_buffer);\n-  }\n-\n-  return SSL_TLSEXT_ERR_OK;\n-}\n-\n-\n-template <class Base>\n-int SSLWrap<Base>::SelectNextProtoCallback(SSL* s,\n-                                           unsigned char** out,\n-                                           unsigned char* outlen,\n-                                           const unsigned char* in,\n-                                           unsigned int inlen,\n-                                           void* arg) {\n-  Base* w = static_cast<Base*>(SSL_get_app_data(s));\n-  Environment* env = w->env();\n-  HandleScope handle_scope(env->isolate());\n-  Context::Scope context_scope(env->context());\n-\n-  auto npn_buffer =\n-      w->object()->GetPrivate(\n-          env->context(),\n-          env->npn_buffer_private_symbol()).ToLocalChecked();\n-\n-  if (npn_buffer->IsUndefined()) {\n-    // We should at least select one protocol\n-    // If server is using NPN\n-    *out = reinterpret_cast<unsigned char*>(const_cast<char*>(\"http/1.1\"));\n-    *outlen = 8;\n-\n-    // set status: unsupported\n-    CHECK(\n-        w->object()->SetPrivate(\n-            env->context(),\n-            env->selected_npn_buffer_private_symbol(),\n-            False(env->isolate())).FromJust());\n-\n-    return SSL_TLSEXT_ERR_OK;\n-  }\n-\n-  CHECK(Buffer::HasInstance(npn_buffer));\n-  const unsigned char* npn_protos =\n-      reinterpret_cast<const unsigned char*>(Buffer::Data(npn_buffer));\n-  size_t len = Buffer::Length(npn_buffer);\n-\n-  int status = SSL_select_next_proto(out, outlen, in, inlen, npn_protos, len);\n-  Local<Value> result;\n-  switch (status) {\n-    case OPENSSL_NPN_UNSUPPORTED:\n-      result = Null(env->isolate());\n-      break;\n-    case OPENSSL_NPN_NEGOTIATED:\n-      result = OneByteString(env->isolate(), *out, *outlen);\n-      break;\n-    case OPENSSL_NPN_NO_OVERLAP:\n-      result = False(env->isolate());\n-      break;\n-    default:\n-      break;\n-  }\n-\n-  CHECK(\n-      w->object()->SetPrivate(\n-          env->context(),\n-          env->selected_npn_buffer_private_symbol(),\n-          result).FromJust());\n-\n-  return SSL_TLSEXT_ERR_OK;\n-}\n-\n-\n-template <class Base>\n-void SSLWrap<Base>::GetNegotiatedProto(\n-    const FunctionCallbackInfo<Value>& args) {\n-  Base* w;\n-  ASSIGN_OR_RETURN_UNWRAP(&w, args.Holder());\n-  Environment* env = w->env();\n-\n-  if (w->is_client()) {\n-    auto selected_npn_buffer =\n-        w->object()->GetPrivate(\n-            env->context(),\n-            env->selected_npn_buffer_private_symbol()).ToLocalChecked();\n-    args.GetReturnValue().Set(selected_npn_buffer);\n-    return;\n-  }\n-\n-  const unsigned char* npn_proto;\n-  unsigned int npn_proto_len;\n-\n-  SSL_get0_next_proto_negotiated(w->ssl_, &npn_proto, &npn_proto_len);\n-\n-  if (!npn_proto)\n-    return args.GetReturnValue().Set(false);\n-\n-  args.GetReturnValue().Set(\n-      OneByteString(args.GetIsolate(), npn_proto, npn_proto_len));\n-}\n-\n-\n-template <class Base>\n-void SSLWrap<Base>::SetNPNProtocols(const FunctionCallbackInfo<Value>& args) {\n-  Base* w;\n-  ASSIGN_OR_RETURN_UNWRAP(&w, args.Holder());\n-  Environment* env = w->env();\n-\n-  if (args.Length() < 1)\n-    return env->ThrowTypeError(\"NPN protocols argument is mandatory\");\n-\n-  THROW_AND_RETURN_IF_NOT_BUFFER(args[0], \"NPN protocols\");\n-\n-  CHECK(\n-      w->object()->SetPrivate(\n-          env->context(),\n-          env->npn_buffer_private_symbol(),\n-          args[0]).FromJust());\n-}\n-#endif  // OPENSSL_NO_NEXTPROTONEG\n-\n #ifdef TLSEXT_TYPE_application_layer_protocol_negotiation\n template <class Base>\n int SSLWrap<Base>::SelectALPNCallback(SSL* s,\n@@ -2883,7 +2707,7 @@ void SSLWrap<Base>::DestroySSL() {\n \n template <class Base>\n void SSLWrap<Base>::SetSNIContext(SecureContext* sc) {\n-  InitNPN(sc);\n+  ConfigureSecureContext(sc);\n   CHECK_EQ(SSL_set_SSL_CTX(ssl_, sc->ctx_), sc->ctx_);\n \n   SetCACerts(sc);"
        },
        {
            "sha": "c8cf558d6089c36c5969bebf8233f53e684f5bfe",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 1,
            "deletions": 17,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -249,7 +249,7 @@ class SSLWrap {\n   static const int64_t kExternalSize = 4448 + 1024 + 42 * 1024;\n #endif\n \n-  static void InitNPN(SecureContext* sc);\n+  static void ConfigureSecureContext(SecureContext* sc);\n   static void AddMethods(Environment* env, v8::Local<v8::FunctionTemplate> t);\n \n #if OPENSSL_VERSION_NUMBER < 0x10100000L\n@@ -295,22 +295,6 @@ class SSLWrap {\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n #endif  // SSL_set_max_send_fragment\n \n-#ifndef OPENSSL_NO_NEXTPROTONEG\n-  static void GetNegotiatedProto(\n-      const v8::FunctionCallbackInfo<v8::Value>& args);\n-  static void SetNPNProtocols(const v8::FunctionCallbackInfo<v8::Value>& args);\n-  static int AdvertiseNextProtoCallback(SSL* s,\n-                                        const unsigned char** data,\n-                                        unsigned int* len,\n-                                        void* arg);\n-  static int SelectNextProtoCallback(SSL* s,\n-                                     unsigned char** out,\n-                                     unsigned char* outlen,\n-                                     const unsigned char* in,\n-                                     unsigned int inlen,\n-                                     void* arg);\n-#endif  // OPENSSL_NO_NEXTPROTONEG\n-\n   static void GetALPNNegotiatedProto(\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void SetALPNProtocols(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "05154d6ff50ff5bbaf2cfbf41618196e46ed0182",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -135,7 +135,7 @@ void TLSWrap::InitSSL() {\n   }\n #endif  // SSL_CTRL_SET_TLSEXT_SERVERNAME_CB\n \n-  InitNPN(sc_);\n+  ConfigureSecureContext(sc_);\n \n   SSL_set_cert_cb(ssl_, SSLWrap<TLSWrap>::SSLCertCallback, this);\n "
        },
        {
            "sha": "063002840616fc825ebbdcad4e52c2f8ab20fe79",
            "filename": "test/parallel/test-https-argument-of-creating.js",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-https-argument-of-creating.js",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-https-argument-of-creating.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-argument-of-creating.js?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -12,12 +12,13 @@ const dftProtocol = {};\n \n // test for immutable `opts`\n {\n-  const opts = { foo: 'bar', NPNProtocols: [ 'http/1.1' ] };\n+  const opts = { foo: 'bar', ALPNProtocols: [ 'http/1.1' ] };\n   const server = https.createServer(opts);\n \n-  tls.convertNPNProtocols([ 'http/1.1' ], dftProtocol);\n-  assert.deepStrictEqual(opts, { foo: 'bar', NPNProtocols: [ 'http/1.1' ] });\n-  assert.strictEqual(server.NPNProtocols.compare(dftProtocol.NPNProtocols), 0);\n+  tls.convertALPNProtocols([ 'http/1.1' ], dftProtocol);\n+  assert.deepStrictEqual(opts, { foo: 'bar', ALPNProtocols: [ 'http/1.1' ] });\n+  assert.strictEqual(server.ALPNProtocols.compare(dftProtocol.ALPNProtocols),\n+                     0);\n }\n \n \n@@ -26,8 +27,9 @@ const dftProtocol = {};\n   const mustNotCall = common.mustNotCall();\n   const server = https.createServer(mustNotCall);\n \n-  tls.convertNPNProtocols([ 'http/1.1', 'http/1.0' ], dftProtocol);\n-  assert.strictEqual(server.NPNProtocols.compare(dftProtocol.NPNProtocols), 0);\n+  tls.convertALPNProtocols([ 'http/1.1' ], dftProtocol);\n+  assert.strictEqual(server.ALPNProtocols.compare(dftProtocol.ALPNProtocols),\n+                     0);\n   assert.strictEqual(server.listeners('request').length, 1);\n   assert.strictEqual(server.listeners('request')[0], mustNotCall);\n }\n@@ -37,6 +39,7 @@ const dftProtocol = {};\n {\n   const server = https.createServer();\n \n-  assert.strictEqual(server.NPNProtocols.compare(dftProtocol.NPNProtocols), 0);\n+  assert.strictEqual(server.ALPNProtocols.compare(dftProtocol.ALPNProtocols),\n+                     0);\n   assert.strictEqual(server.listeners('request').length, 0);\n }"
        },
        {
            "sha": "8b8ae3e5cf06581149d315a896db6f784a12c8a2",
            "filename": "test/parallel/test-tls-alpn-server-client.js",
            "status": "modified",
            "additions": 35,
            "deletions": 400,
            "changes": 435,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-tls-alpn-server-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-tls-alpn-server-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-alpn-server-client.js?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -4,9 +4,9 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n-if (!process.features.tls_alpn || !process.features.tls_npn) {\n+if (!process.features.tls_alpn) {\n   common.skip(\n-    'Skipping because node compiled without NPN or ALPN feature of OpenSSL.');\n+    'Skipping because node compiled without ALPN feature of OpenSSL.');\n }\n \n const assert = require('assert');\n@@ -21,9 +21,7 @@ const serverIP = common.localhostIPv4;\n \n function checkResults(result, expected) {\n   assert.strictEqual(result.server.ALPN, expected.server.ALPN);\n-  assert.strictEqual(result.server.NPN, expected.server.NPN);\n   assert.strictEqual(result.client.ALPN, expected.client.ALPN);\n-  assert.strictEqual(result.client.NPN, expected.client.NPN);\n }\n \n function runTest(clientsOptions, serverOptions, cb) {\n@@ -32,7 +30,7 @@ function runTest(clientsOptions, serverOptions, cb) {\n   const results = [];\n   let index = 0;\n   const server = tls.createServer(serverOptions, function(c) {\n-    results[index].server = { ALPN: c.alpnProtocol, NPN: c.npnProtocol };\n+    results[index].server = { ALPN: c.alpnProtocol };\n   });\n \n   server.listen(0, serverIP, function() {\n@@ -47,8 +45,7 @@ function runTest(clientsOptions, serverOptions, cb) {\n \n     results[index] = {};\n     const client = tls.connect(opt, function() {\n-      results[index].client = { ALPN: client.alpnProtocol,\n-                                NPN: client.npnProtocol };\n+      results[index].client = { ALPN: client.alpnProtocol };\n       client.destroy();\n       if (options.length) {\n         index++;\n@@ -62,471 +59,109 @@ function runTest(clientsOptions, serverOptions, cb) {\n \n }\n \n-// Server: ALPN/NPN, Client: ALPN/NPN\n+// Server: ALPN, Client: ALPN\n function Test1() {\n   const serverOptions = {\n     ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n   };\n \n   const clientsOptions = [{\n     ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n   }, {\n     ALPNProtocols: ['c', 'b', 'e'],\n-    NPNProtocols: ['c', 'b', 'e']\n   }, {\n     ALPNProtocols: ['first-priority-unsupported', 'x', 'y'],\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n   }];\n \n   runTest(clientsOptions, serverOptions, function(results) {\n     // 'a' is selected by ALPN\n     checkResults(results[0],\n-                 { server: { ALPN: 'a', NPN: false },\n-                   client: { ALPN: 'a', NPN: undefined } });\n+                 { server: { ALPN: 'a' },\n+                   client: { ALPN: 'a' } });\n     // 'b' is selected by ALPN\n     checkResults(results[1],\n-                 { server: { ALPN: 'b', NPN: false },\n-                   client: { ALPN: 'b', NPN: undefined } });\n+                 { server: { ALPN: 'b' },\n+                   client: { ALPN: 'b' } });\n     // nothing is selected by ALPN\n     checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n     // execute next test\n     Test2();\n   });\n }\n \n-// Server: ALPN/NPN, Client: ALPN\n+// Server: ALPN, Client: Nothing\n function Test2() {\n   const serverOptions = {\n     ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    ALPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by ALPN\n-    checkResults(results[0],\n-                 { server: { ALPN: 'a', NPN: false },\n-                   client: { ALPN: 'a', NPN: undefined } });\n-    // 'b' is selected by ALPN\n-    checkResults(results[1],\n-                 { server: { ALPN: 'b', NPN: false },\n-                   client: { ALPN: 'b', NPN: undefined } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test3();\n-  });\n-}\n-\n-// Server: ALPN/NPN, Client: NPN\n-function Test3() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    NPPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    NPPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by NPN\n-    checkResults(results[0],\n-                 { server: { ALPN: false, NPN: 'a' },\n-                   client: { ALPN: false, NPN: 'a' } });\n-    // nothing is selected by ALPN\n-    checkResults(results[1],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test4();\n-  });\n-}\n-\n-// Server: ALPN/NPN, Client: Nothing\n-function Test4() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n   };\n \n   const clientsOptions = [{}, {}, {}];\n \n   runTest(clientsOptions, serverOptions, function(results) {\n     // nothing is selected by ALPN\n     checkResults(results[0],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n     // nothing is selected by ALPN\n     checkResults(results[1],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test5();\n-  });\n-}\n-\n-// Server: ALPN, Client: ALPN/NPN\n-function Test5() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    ALPNProtocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e'],\n-    NPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y'],\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by ALPN\n-    checkResults(results[0], { server: { ALPN: 'a', NPN: false },\n-                               client: { ALPN: 'a', NPN: undefined } });\n-    // 'b' is selected by ALPN\n-    checkResults(results[1], { server: { ALPN: 'b', NPN: false },\n-                               client: { ALPN: 'b', NPN: undefined } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2], { server: { ALPN: false,\n-                                         NPN: 'first-priority-unsupported' },\n-                               client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test6();\n-  });\n-}\n-\n-// Server: ALPN, Client: ALPN\n-function Test6() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    ALPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by ALPN\n-    checkResults(results[0], { server: { ALPN: 'a', NPN: false },\n-                               client: { ALPN: 'a', NPN: undefined } });\n-    // 'b' is selected by ALPN\n-    checkResults(results[1], { server: { ALPN: 'b', NPN: false },\n-                               client: { ALPN: 'b', NPN: undefined } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test7();\n-  });\n-}\n-\n-// Server: ALPN, Client: NPN\n-function Test7() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    NPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected by ALPN\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'a' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected by ALPN\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'c' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected by ALPN\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test8();\n-  });\n-}\n-\n-// Server: ALPN, Client: Nothing\n-function Test8() {\n-  const serverOptions = {\n-    ALPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{}, {}, {}];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected by ALPN\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected by ALPN\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n     // nothing is selected by ALPN\n     checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test9();\n-  });\n-}\n-\n-// Server: NPN, Client: ALPN/NPN\n-function Test9() {\n-  const serverOptions = {\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    ALPNrotocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e'],\n-    NPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y'],\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by NPN\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'a' },\n-                               client: { ALPN: false, NPN: 'a' } });\n-    // 'b' is selected by NPN\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'b' },\n-                               client: { ALPN: false, NPN: 'b' } });\n-    // nothing is selected\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test10();\n-  });\n-}\n-\n-// Server: NPN, Client: ALPN\n-function Test10() {\n-  const serverOptions = {\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    ALPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[2], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n     // execute next test\n-    Test11();\n-  });\n-}\n-\n-// Server: NPN, Client: NPN\n-function Test11() {\n-  const serverOptions = {\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    NPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // 'a' is selected by NPN\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'a' },\n-                               client: { ALPN: false, NPN: 'a' } });\n-    // 'b' is selected by NPN\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'b' },\n-                               client: { ALPN: false, NPN: 'b' } });\n-    // nothing is selected\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test12();\n-  });\n-}\n-\n-// Server: NPN, Client: Nothing\n-function Test12() {\n-  const serverOptions = {\n-    NPNProtocols: ['a', 'b', 'c']\n-  };\n-\n-  const clientsOptions = [{}, {}, {}];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test13();\n+    Test3();\n   });\n }\n \n-// Server: Nothing, Client: ALPN/NPN\n-function Test13() {\n+// Server: Nothing, Client: ALPN\n+function Test3() {\n   const serverOptions = {};\n \n   const clientsOptions = [{\n     ALPNrotocols: ['a', 'b', 'c'],\n-    NPNProtocols: ['a', 'b', 'c']\n   }, {\n     ALPNProtocols: ['c', 'b', 'e'],\n-    NPNProtocols: ['c', 'b', 'e']\n   }, {\n     ALPNProtocols: ['first-priority-unsupported', 'x', 'y'],\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n   }];\n \n   runTest(clientsOptions, serverOptions, function(results) {\n     // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'a' },\n-                               client: { ALPN: false, NPN: false } });\n+    checkResults(results[0], { server: { ALPN: false },\n+                               client: { ALPN: false } });\n     // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'c' },\n-                               client: { ALPN: false, NPN: false } });\n+    checkResults(results[1], { server: { ALPN: false },\n+                               client: { ALPN: false } });\n     // nothing is selected\n     checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n     // execute next test\n-    Test14();\n-  });\n-}\n-\n-// Server: Nothing, Client: ALPN\n-function Test14() {\n-  const serverOptions = {};\n-\n-  const clientsOptions = [{\n-    ALPNrotocols: ['a', 'b', 'c']\n-  }, {\n-    ALPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    ALPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test15();\n-  });\n-}\n-\n-// Server: Nothing, Client: NPN\n-function Test15() {\n-  const serverOptions = {};\n-\n-  const clientsOptions = [{\n-    NPNProtocols: ['a', 'b', 'c']\n-  }, {\n-    NPNProtocols: ['c', 'b', 'e']\n-  }, {\n-    NPNProtocols: ['first-priority-unsupported', 'x', 'y']\n-  }];\n-\n-  runTest(clientsOptions, serverOptions, function(results) {\n-    // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'a' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'c' },\n-                               client: { ALPN: false, NPN: false } });\n-    // nothing is selected\n-    checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'first-priority-unsupported' },\n-                   client: { ALPN: false, NPN: false } });\n-    // execute next test\n-    Test16();\n+    Test4();\n   });\n }\n \n // Server: Nothing, Client: Nothing\n-function Test16() {\n+function Test4() {\n   const serverOptions = {};\n \n   const clientsOptions = [{}, {}, {}];\n \n   runTest(clientsOptions, serverOptions, function(results) {\n     // nothing is selected\n-    checkResults(results[0], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n+    checkResults(results[0], { server: { ALPN: false },\n+                               client: { ALPN: false } });\n     // nothing is selected\n-    checkResults(results[1], { server: { ALPN: false, NPN: 'http/1.1' },\n-                               client: { ALPN: false, NPN: false } });\n+    checkResults(results[1], { server: { ALPN: false },\n+                               client: { ALPN: false } });\n     // nothing is selected\n     checkResults(results[2],\n-                 { server: { ALPN: false, NPN: 'http/1.1' },\n-                   client: { ALPN: false, NPN: false } });\n+                 { server: { ALPN: false },\n+                   client: { ALPN: false } });\n   });\n }\n "
        },
        {
            "sha": "518e881f9c0c155d30860758728d4742be40e48b",
            "filename": "test/parallel/test-tls-npn-server-client.js",
            "status": "removed",
            "additions": 0,
            "deletions": 118,
            "changes": 118,
            "blob_url": "https://github.com/nodejs/node/blob/b3f23910a25613eb289fe4b338f83783a9f731b3/test%2Fparallel%2Ftest-tls-npn-server-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/b3f23910a25613eb289fe4b338f83783a9f731b3/test%2Fparallel%2Ftest-tls-npn-server-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-npn-server-client.js?ref=b3f23910a25613eb289fe4b338f83783a9f731b3",
            "patch": "@@ -1,118 +0,0 @@\n-// Copyright Joyent, Inc. and other Node contributors.\n-//\n-// Permission is hereby granted, free of charge, to any person obtaining a\n-// copy of this software and associated documentation files (the\n-// \"Software\"), to deal in the Software without restriction, including\n-// without limitation the rights to use, copy, modify, merge, publish,\n-// distribute, sublicense, and/or sell copies of the Software, and to permit\n-// persons to whom the Software is furnished to do so, subject to the\n-// following conditions:\n-//\n-// The above copyright notice and this permission notice shall be included\n-// in all copies or substantial portions of the Software.\n-//\n-// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n-// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n-// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n-// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n-// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n-// USE OR OTHER DEALINGS IN THE SOFTWARE.\n-\n-'use strict';\n-const common = require('../common');\n-if (!common.hasCrypto)\n-  common.skip('missing crypto');\n-\n-if (!process.features.tls_npn)\n-  common.skip('Skipping because node compiled without NPN feature of OpenSSL.');\n-\n-const assert = require('assert');\n-const tls = require('tls');\n-const fixtures = require('../common/fixtures');\n-\n-function loadPEM(n) {\n-  return fixtures.readKey(`${n}.pem`);\n-}\n-\n-const serverOptions = {\n-  key: loadPEM('agent2-key'),\n-  cert: loadPEM('agent2-cert'),\n-  crl: loadPEM('ca2-crl'),\n-  SNICallback: function(servername, cb) {\n-    cb(null, tls.createSecureContext({\n-      key: loadPEM('agent2-key'),\n-      cert: loadPEM('agent2-cert'),\n-      crl: loadPEM('ca2-crl'),\n-    }));\n-  },\n-  NPNProtocols: ['a', 'b', 'c']\n-};\n-\n-const clientsOptions = [{\n-  port: undefined,\n-  key: serverOptions.key,\n-  cert: serverOptions.cert,\n-  crl: serverOptions.crl,\n-  NPNProtocols: ['a', 'b', 'c'],\n-  rejectUnauthorized: false\n-}, {\n-  port: undefined,\n-  key: serverOptions.key,\n-  cert: serverOptions.cert,\n-  crl: serverOptions.crl,\n-  NPNProtocols: ['c', 'b', 'e'],\n-  rejectUnauthorized: false\n-}, {\n-  port: undefined,\n-  key: serverOptions.key,\n-  cert: serverOptions.cert,\n-  crl: serverOptions.crl,\n-  rejectUnauthorized: false\n-}, {\n-  port: undefined,\n-  key: serverOptions.key,\n-  cert: serverOptions.cert,\n-  crl: serverOptions.crl,\n-  NPNProtocols: ['first-priority-unsupported', 'x', 'y'],\n-  rejectUnauthorized: false\n-}];\n-\n-const serverResults = [];\n-const clientsResults = [];\n-\n-const server = tls.createServer(serverOptions, function(c) {\n-  serverResults.push(c.npnProtocol);\n-});\n-server.listen(0, startTest);\n-\n-function startTest() {\n-  function connectClient(options, callback) {\n-    options.port = server.address().port;\n-    const client = tls.connect(options, function() {\n-      clientsResults.push(client.npnProtocol);\n-      client.destroy();\n-\n-      callback();\n-    });\n-  }\n-\n-  connectClient(clientsOptions[0], function() {\n-    connectClient(clientsOptions[1], function() {\n-      connectClient(clientsOptions[2], function() {\n-        connectClient(clientsOptions[3], function() {\n-          server.close();\n-        });\n-      });\n-    });\n-  });\n-}\n-\n-process.on('exit', function() {\n-  assert.strictEqual(serverResults[0], clientsResults[0]);\n-  assert.strictEqual(serverResults[1], clientsResults[1]);\n-  assert.strictEqual(serverResults[2], 'http/1.1');\n-  assert.strictEqual(clientsResults[2], false);\n-  assert.strictEqual(serverResults[3], 'first-priority-unsupported');\n-  assert.strictEqual(clientsResults[3], false);\n-});"
        },
        {
            "sha": "edbc9f63cf362556f492771f39831af2fc8f49cc",
            "filename": "test/parallel/test-tls-socket-constructor-alpn-options-parsing.js",
            "status": "renamed",
            "additions": 6,
            "deletions": 23,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-tls-socket-constructor-alpn-options-parsing.js",
            "raw_url": "https://github.com/nodejs/node/raw/5bfbe5ceaecb6412b176db446caf00f77f84bae7/test%2Fparallel%2Ftest-tls-socket-constructor-alpn-options-parsing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-socket-constructor-alpn-options-parsing.js?ref=5bfbe5ceaecb6412b176db446caf00f77f84bae7",
            "patch": "@@ -1,7 +1,6 @@\n 'use strict';\n \n-// Test that TLSSocket can take arrays of strings for ALPNProtocols and\n-// NPNProtocols.\n+// Test that TLSSocket can take arrays of strings for ALPNProtocols.\n \n const common = require('../common');\n \n@@ -12,12 +11,8 @@ const tls = require('tls');\n \n new tls.TLSSocket(null, {\n   ALPNProtocols: ['http/1.1'],\n-  NPNProtocols: ['http/1.1']\n });\n \n-if (!process.features.tls_npn)\n-  common.skip('node compiled without NPN feature of OpenSSL');\n-\n if (!process.features.tls_alpn)\n   common.skip('node compiled without ALPN feature of OpenSSL');\n \n@@ -37,42 +32,30 @@ const server = net.createServer(common.mustCall((s) => {\n     key,\n     cert,\n     ALPNProtocols: ['http/1.1'],\n-    NPNProtocols: ['http/1.1']\n   });\n \n   tlsSocket.on('secure', common.mustCall(() => {\n     protocols.push({\n       alpnProtocol: tlsSocket.alpnProtocol,\n-      npnProtocol: tlsSocket.npnProtocol\n     });\n     tlsSocket.end();\n   }));\n-}, 2));\n+}));\n \n server.listen(0, common.mustCall(() => {\n   const alpnOpts = {\n     port: server.address().port,\n     rejectUnauthorized: false,\n     ALPNProtocols: ['h2', 'http/1.1']\n   };\n-  const npnOpts = {\n-    port: server.address().port,\n-    rejectUnauthorized: false,\n-    NPNProtocols: ['h2', 'http/1.1']\n-  };\n \n   tls.connect(alpnOpts, function() {\n     this.end();\n \n-    tls.connect(npnOpts, function() {\n-      this.end();\n-\n-      server.close();\n+    server.close();\n \n-      assert.deepStrictEqual(protocols, [\n-        { alpnProtocol: 'http/1.1', npnProtocol: false },\n-        { alpnProtocol: false, npnProtocol: 'http/1.1' }\n-      ]);\n-    });\n+    assert.deepStrictEqual(protocols, [\n+      { alpnProtocol: 'http/1.1' },\n+    ]);\n   });\n }));",
            "previous_filename": "test/parallel/test-tls-socket-constructor-alpn-npn-options-parsing.js"
        }
    ],
    "stats": {
        "total": 895,
        "additions": 73,
        "deletions": 822
    }
}