{
    "author": "jasnell",
    "message": "src: add tracing category macros\n\nAdds `TRACING_CATEGORY_NODE`, `TRACING_CATEGORY_NODE1` and\n`TRACING_CATEGORY_NODE2` helper macros for consistently building\ntrace event category strings. For instance,\n\n`TRACING_CATEGORY_NODE2(foo, bar)` would generate the category\nstring `node,node.foo,node.foo.bar`, such that...\n\n```\nTRACE_EVENT_NESTABLE_ASYNC_BEGIN0(\n    TRACING_CATEGORY_NODE2(foo, bar),\n    \"baz\", 1);\n```\n\nWould emit if trace events are enabled for categories: `node`,\n`node.foo`, or `node.foo.bar`.\n\nThis allows a natural scoping down of what trace events a user\nmay want to receive. Enabling the `node` category would receive\neverything Node.js produces.\n\nPR-URL: https://github.com/nodejs/node/pull/19155\nReviewed-By: Andreas Madsen <amwebdk@gmail.com>",
    "sha": "1dd9c9787bcf08db022ee63ce633fc9d497720e6",
    "files": [
        {
            "sha": "db38fe99adcc9cd3fa7034c1518e6716ed5dfe33",
            "filename": "lib/internal/trace_events_async_hooks.js",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftrace_events_async_hooks.js?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -15,6 +15,8 @@ const END_EVENT = 'e'.charCodeAt(0);\n // non-init events, use a map to manually map the asyncId to the type name.\n const typeMemory = new Map();\n \n+const trace_event_category = 'node,node.async_hooks';\n+\n // It is faster to emit trace_events directly from C++. Thus, this happens in\n // async_wrap.cc. However, events emitted from the JavaScript API or the\n // Embedder C++ API can't be emitted from async_wrap.cc. Thus they are\n@@ -27,7 +29,7 @@ const hook = async_hooks.createHook({\n     if (nativeProviders.has(type)) return;\n \n     typeMemory.set(asyncId, type);\n-    trace_events.emit(BEFORE_EVENT, 'node.async_hooks',\n+    trace_events.emit(BEFORE_EVENT, trace_event_category,\n                       type, asyncId,\n                       'triggerAsyncId', triggerAsyncId,\n                       'executionAsyncId', async_hooks.executionAsyncId());\n@@ -37,23 +39,23 @@ const hook = async_hooks.createHook({\n     const type = typeMemory.get(asyncId);\n     if (type === undefined) return;\n \n-    trace_events.emit(BEFORE_EVENT, 'node.async_hooks',\n+    trace_events.emit(BEFORE_EVENT, trace_event_category,\n                       type + '_CALLBACK', asyncId);\n   },\n \n   after(asyncId) {\n     const type = typeMemory.get(asyncId);\n     if (type === undefined) return;\n \n-    trace_events.emit(END_EVENT, 'node.async_hooks',\n+    trace_events.emit(END_EVENT, trace_event_category,\n                       type + '_CALLBACK', asyncId);\n   },\n \n   destroy(asyncId) {\n     const type = typeMemory.get(asyncId);\n     if (type === undefined) return;\n \n-    trace_events.emit(END_EVENT, 'node.async_hooks',\n+    trace_events.emit(END_EVENT, trace_event_category,\n                       type, asyncId);\n \n     // cleanup asyncId to type map\n@@ -63,7 +65,7 @@ const hook = async_hooks.createHook({\n \n \n exports.setup = function() {\n-  if (trace_events.categoryGroupEnabled('node.async_hooks')) {\n+  if (trace_events.categoryGroupEnabled(trace_event_category)) {\n     hook.enable();\n   }\n };"
        },
        {
            "sha": "239e607b05ab77e34db2a658c198808e29a2856b",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -179,7 +179,8 @@ void AsyncWrap::EmitTraceEventBefore() {\n   switch (provider_type()) {\n #define V(PROVIDER)                                                           \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n-      TRACE_EVENT_NESTABLE_ASYNC_BEGIN0(\"node.async_hooks\",                   \\\n+      TRACE_EVENT_NESTABLE_ASYNC_BEGIN0(                                      \\\n+        TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n         #PROVIDER \"_CALLBACK\", static_cast<int64_t>(get_async_id()));         \\\n       break;\n     NODE_ASYNC_PROVIDER_TYPES(V)\n@@ -207,7 +208,8 @@ void AsyncWrap::EmitTraceEventAfter() {\n   switch (provider_type()) {\n #define V(PROVIDER)                                                           \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n-      TRACE_EVENT_NESTABLE_ASYNC_END0(\"node.async_hooks\",                     \\\n+      TRACE_EVENT_NESTABLE_ASYNC_END0(                                        \\\n+        TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n         #PROVIDER \"_CALLBACK\", static_cast<int64_t>(get_async_id()));         \\\n       break;\n     NODE_ASYNC_PROVIDER_TYPES(V)\n@@ -631,7 +633,8 @@ void AsyncWrap::EmitTraceEventDestroy() {\n   switch (provider_type()) {\n   #define V(PROVIDER)                                                         \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n-      TRACE_EVENT_NESTABLE_ASYNC_END0(\"node.async_hooks\",                     \\\n+      TRACE_EVENT_NESTABLE_ASYNC_END0(                                        \\\n+        TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n         #PROVIDER, static_cast<int64_t>(get_async_id()));                     \\\n       break;\n     NODE_ASYNC_PROVIDER_TYPES(V)\n@@ -664,7 +667,8 @@ void AsyncWrap::AsyncReset(double execution_async_id, bool silent) {\n   switch (provider_type()) {\n #define V(PROVIDER)                                                           \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n-      TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(\"node.async_hooks\",                   \\\n+      TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(                                      \\\n+        TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n         #PROVIDER, static_cast<int64_t>(get_async_id()),                      \\\n         \"executionAsyncId\",                                                   \\\n         static_cast<int64_t>(env()->execution_async_id()),                    \\"
        },
        {
            "sha": "2faa6f93475ad73c1ed411b1c6563a0b8e036bcd",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -776,6 +776,15 @@ static inline const char *errno_string(int errorno) {\n #define NODE_MODULE_CONTEXT_AWARE_INTERNAL(modname, regfunc)                  \\\n   NODE_MODULE_CONTEXT_AWARE_CPP(modname, regfunc, nullptr, NM_F_INTERNAL)\n \n+#define TRACING_CATEGORY_NODE \"node\"\n+#define TRACING_CATEGORY_NODE1(one)                                           \\\n+    TRACING_CATEGORY_NODE \",\"                                                 \\\n+    TRACING_CATEGORY_NODE \".\" #one\n+#define TRACING_CATEGORY_NODE2(one, two)                                      \\\n+    TRACING_CATEGORY_NODE \",\"                                                 \\\n+    TRACING_CATEGORY_NODE \".\" #one \",\"                                        \\\n+    TRACING_CATEGORY_NODE \".\" #one \".\" #two\n+\n }  // namespace node\n \n "
        },
        {
            "sha": "8260d78c3296a5fa0d270805b9da730321a455a4",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -135,7 +135,8 @@ void Mark(const FunctionCallbackInfo<Value>& args) {\n   (*marks)[*name] = now;\n \n   TRACE_EVENT_COPY_MARK_WITH_TIMESTAMP(\n-      \"node.perf,node.perf.usertiming\", *name, now / 1000);\n+      TRACING_CATEGORY_NODE2(perf, usertiming),\n+      *name, now / 1000);\n \n   PerformanceEntry entry(env, *name, \"mark\", now, now);\n   Local<Object> obj = entry.ToObject();\n@@ -183,9 +184,11 @@ void Measure(const FunctionCallbackInfo<Value>& args) {\n     endTimestamp = startTimestamp;\n \n   TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n-      \"node.perf,node.perf.usertiming\", *name, *name, startTimestamp / 1000);\n+      TRACING_CATEGORY_NODE2(perf, usertiming),\n+      *name, *name, startTimestamp / 1000);\n   TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n-      \"node.perf,node.perf.usertiming\", *name, *name, endTimestamp / 1000);\n+      TRACING_CATEGORY_NODE2(perf, usertiming),\n+      *name, *name, endTimestamp / 1000);\n \n   PerformanceEntry entry(env, *name, \"measure\", startTimestamp, endTimestamp);\n   Local<Object> obj = entry.ToObject();\n@@ -301,13 +304,15 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   if (args.IsConstructCall()) {\n     start = PERFORMANCE_NOW();\n     TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n-        \"node.perf,node.perf.timerify\", *name, *name, start / 1000);\n+        TRACING_CATEGORY_NODE2(perf, timerify),\n+        *name, *name, start / 1000);\n     v8::MaybeLocal<Object> ret = fn->NewInstance(context,\n                                                  call_args.size(),\n                                                  call_args.data());\n     end = PERFORMANCE_NOW();\n     TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n-        \"node.perf,node.perf.timerify\", *name, *name, end / 1000);\n+        TRACING_CATEGORY_NODE2(perf, timerify),\n+        *name, *name, end / 1000);\n \n     if (ret.IsEmpty()) {\n       try_catch.ReThrow();\n@@ -317,14 +322,16 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   } else {\n     start = PERFORMANCE_NOW();\n     TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n-        \"node.perf,node.perf.timerify\", *name, *name, start / 1000);\n+        TRACING_CATEGORY_NODE2(perf, timerify),\n+        *name, *name, start / 1000);\n     v8::MaybeLocal<Value> ret = fn->Call(context,\n                                          args.This(),\n                                          call_args.size(),\n                                          call_args.data());\n     end = PERFORMANCE_NOW();\n     TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n-        \"node.perf,node.perf.timerify\", *name, *name, end / 1000);\n+        TRACING_CATEGORY_NODE2(perf, timerify),\n+        *name, *name, end / 1000);\n \n     if (ret.IsEmpty()) {\n       try_catch.ReThrow();"
        },
        {
            "sha": "51d0f3c5a265f15d302e0b47cd0d5cf91dc4e6ad",
            "filename": "test/parallel/test-trace-events-all.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-all.js",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-all.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-all.js?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -35,7 +35,7 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) => {\n       if (trace.pid !== proc.pid)\n         return false;\n-      if (trace.cat !== 'node.async_hooks')\n+      if (trace.cat !== 'node,node.async_hooks')\n         return false;\n       if (trace.name !== 'TIMERWRAP')\n         return false;\n@@ -47,7 +47,7 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) => {\n       if (trace.pid !== proc.pid)\n         return false;\n-      if (trace.cat !== 'node.async_hooks')\n+      if (trace.cat !== 'node,node.async_hooks')\n         return false;\n       if (trace.name !== 'Timeout')\n         return false;"
        },
        {
            "sha": "7fb11223c3141d4825d5f7afe990a13886f2d03e",
            "filename": "test/parallel/test-trace-events-async-hooks.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-async-hooks.js?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -37,7 +37,7 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) => {\n       if (trace.pid !== proc.pid)\n         return false;\n-      if (trace.cat !== 'node.async_hooks')\n+      if (trace.cat !== 'node,node.async_hooks')\n         return false;\n       if (trace.name !== 'TIMERWRAP')\n         return false;\n@@ -48,7 +48,7 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) => {\n       if (trace.pid !== proc.pid)\n         return false;\n-      if (trace.cat !== 'node.async_hooks')\n+      if (trace.cat !== 'node,node.async_hooks')\n         return false;\n       if (trace.name !== 'Timeout')\n         return false;"
        },
        {
            "sha": "57f886d272447ad6cba40a1e94f6bb0b8b17d4c9",
            "filename": "test/parallel/test-trace-events-perf.js",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/1dd9c9787bcf08db022ee63ce633fc9d497720e6/test%2Fparallel%2Ftest-trace-events-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-perf.js?ref=1dd9c9787bcf08db022ee63ce633fc9d497720e6",
            "patch": "@@ -26,12 +26,12 @@ if (process.argv[2] === 'child') {\n \n   const expectedMarks = ['A', 'B'];\n   const expectedBegins = [\n-    { cat: 'node.perf,node.perf.timerify', name: 'f' },\n-    { cat: 'node.perf,node.perf.usertiming', name: 'A to B' }\n+    { cat: 'node,node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node,node.perf,node.perf.usertiming', name: 'A to B' }\n   ];\n   const expectedEnds = [\n-    { cat: 'node.perf,node.perf.timerify', name: 'f' },\n-    { cat: 'node.perf,node.perf.usertiming', name: 'A to B' }\n+    { cat: 'node,node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node,node.perf,node.perf.usertiming', name: 'A to B' }\n   ];\n \n   const proc = cp.fork(__filename,\n@@ -60,8 +60,10 @@ if (process.argv[2] === 'child') {\n         assert.strictEqual(trace.pid, proc.pid);\n         switch (trace.ph) {\n           case 'R':\n-            assert.strictEqual(trace.cat, 'node.perf,node.perf.usertiming');\n-            assert.strictEqual(trace.name, expectedMarks.shift());\n+            assert.strictEqual(trace.cat,\n+                               'node,node.perf,node.perf.usertiming');\n+            assert.strictEqual(trace.name,\n+                               expectedMarks.shift());\n             break;\n           case 'b':\n             const expectedBegin = expectedBegins.shift();"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 50,
        "deletions": 26
    }
}