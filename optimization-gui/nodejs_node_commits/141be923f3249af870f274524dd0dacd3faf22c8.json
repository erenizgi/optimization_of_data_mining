{
    "author": "guybedford",
    "message": "module: skip preserveSymlinks for main\n\nPR-URL: https://github.com/nodejs/node/pull/19388\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "141be923f3249af870f274524dd0dacd3faf22c8",
    "files": [
        {
            "sha": "60516535e9ad0350cec6149b7cd5bb8bf9cfa7e7",
            "filename": "lib/internal/modules/esm/default_resolve.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/141be923f3249af870f274524dd0dacd3faf22c8/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "raw_url": "https://github.com/nodejs/node/raw/141be923f3249af870f274524dd0dacd3faf22c8/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js?ref=141be923f3249af870f274524dd0dacd3faf22c8",
            "patch": "@@ -69,7 +69,9 @@ function resolve(specifier, parentURL) {\n     throw e;\n   }\n \n-  if (!preserveSymlinks) {\n+  const isMain = parentURL === undefined;\n+\n+  if (!preserveSymlinks || isMain) {\n     const real = realpathSync(getPathFromURL(url), {\n       [internalFS.realpathCacheKey]: realpathCache\n     });\n@@ -83,7 +85,6 @@ function resolve(specifier, parentURL) {\n \n   let format = extensionFormatMap[ext];\n   if (!format) {\n-    const isMain = parentURL === undefined;\n     if (isMain)\n       format = 'cjs';\n     else"
        },
        {
            "sha": "f7631ef2e5bdcaaca2b72829303fb7eca8a51558",
            "filename": "test/es-module/test-esm-symlink-main.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/141be923f3249af870f274524dd0dacd3faf22c8/test%2Fes-module%2Ftest-esm-symlink-main.js",
            "raw_url": "https://github.com/nodejs/node/raw/141be923f3249af870f274524dd0dacd3faf22c8/test%2Fes-module%2Ftest-esm-symlink-main.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-symlink-main.js?ref=141be923f3249af870f274524dd0dacd3faf22c8",
            "patch": "@@ -0,0 +1,25 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const path = require('path');\n+const { spawn } = require('child_process');\n+const tmpdir = require('../common/tmpdir');\n+const fs = require('fs');\n+tmpdir.refresh();\n+\n+const realPath = path.resolve(__dirname, '../fixtures/es-modules/symlink.mjs');\n+const symlinkPath = path.resolve(tmpdir.path, 'symlink.js');\n+\n+try {\n+  fs.symlinkSync(realPath, symlinkPath);\n+} catch (err) {\n+  if (err.code !== 'EPERM') throw err;\n+  common.skip('insufficient privileges for symlinks');\n+}\n+\n+spawn(process.execPath,\n+      ['--experimental-modules', '--preserve-symlinks', symlinkPath],\n+      { stdio: 'inherit' }).on('exit', (code) => {\n+  assert.strictEqual(code, 0);\n+});"
        },
        {
            "sha": "8ce1299d1616bf4e29a03151fbd62a5bc833a26c",
            "filename": "test/fixtures/es-modules/symlink.mjs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/141be923f3249af870f274524dd0dacd3faf22c8/test%2Ffixtures%2Fes-modules%2Fsymlink.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/141be923f3249af870f274524dd0dacd3faf22c8/test%2Ffixtures%2Fes-modules%2Fsymlink.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Fsymlink.mjs?ref=141be923f3249af870f274524dd0dacd3faf22c8",
            "patch": "@@ -0,0 +1 @@\n+export var symlinked = true;"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 29,
        "deletions": 2
    }
}