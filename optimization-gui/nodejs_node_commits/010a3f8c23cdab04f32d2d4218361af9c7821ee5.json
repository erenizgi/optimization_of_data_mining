{
    "author": "joyeecheung",
    "message": "test: run code cache test by default and test generator\n\n- Add the code cache tests to the default test suite, and test\n  the bookkeeping when the binary is not built with the code cache.\n- Test the code cache generator to make sure we do not accidentally\n  break it - until we enable code cache in the CI.\n\nRefs: https://github.com/nodejs/node/issues/21563\nPR-URL: https://github.com/nodejs/node/pull/23855\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "010a3f8c23cdab04f32d2d4218361af9c7821ee5",
    "files": [
        {
            "sha": "972d89629c0a23db101208fe63f380bf09297f4a",
            "filename": "test/code-cache/test-code-cache-generator.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/010a3f8c23cdab04f32d2d4218361af9c7821ee5/test%2Fcode-cache%2Ftest-code-cache-generator.js",
            "raw_url": "https://github.com/nodejs/node/raw/010a3f8c23cdab04f32d2d4218361af9c7821ee5/test%2Fcode-cache%2Ftest-code-cache-generator.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache-generator.js?ref=010a3f8c23cdab04f32d2d4218361af9c7821ee5",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+// This test verifies that the binary is compiled with code cache and the\n+// cache is used when built in modules are compiled.\n+\n+const common = require('../common');\n+\n+const tmpdir = require('../common/tmpdir');\n+const { spawnSync } = require('child_process');\n+const assert = require('assert');\n+const path = require('path');\n+const fs = require('fs');\n+const readline = require('readline');\n+\n+const generator = path.join(\n+  __dirname, '..', '..', 'tools', 'generate_code_cache.js'\n+);\n+tmpdir.refresh();\n+const dest = path.join(tmpdir.path, 'cache.cc');\n+\n+// Run tools/generate_code_cache.js\n+const child = spawnSync(\n+  process.execPath,\n+  ['--expose-internals', generator, dest]\n+);\n+assert.ifError(child.error);\n+if (child.status !== 0) {\n+  console.log(child.stderr.toString());\n+  assert.strictEqual(child.status, 0);\n+}\n+\n+// Verifies that:\n+// - node::DefineCodeCache()\n+// - node::DefineCodeCacheHash()\n+// are defined in the generated code.\n+// See src/node_code_cache_stub.cc for explanations.\n+\n+const rl = readline.createInterface({\n+  input: fs.createReadStream(dest),\n+  crlfDelay: Infinity\n+});\n+\n+let hasCacheDef = false;\n+let hasHashDef = false;\n+\n+rl.on('line', common.mustCallAtLeast((line) => {\n+  if (line.includes('DefineCodeCache(')) {\n+    hasCacheDef = true;\n+  }\n+  if (line.includes('DefineCodeCacheHash(')) {\n+    hasHashDef = true;\n+  }\n+}, 2));\n+\n+rl.on('close', common.mustCall(() => {\n+  assert.ok(hasCacheDef);\n+  assert.ok(hasHashDef);\n+}));"
        },
        {
            "sha": "c1bfa80f4342f39759d9586095b6bb2c6b47a919",
            "filename": "test/code-cache/test-code-cache.js",
            "status": "modified",
            "additions": 30,
            "deletions": 16,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/010a3f8c23cdab04f32d2d4218361af9c7821ee5/test%2Fcode-cache%2Ftest-code-cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/010a3f8c23cdab04f32d2d4218361af9c7821ee5/test%2Fcode-cache%2Ftest-code-cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache.js?ref=010a3f8c23cdab04f32d2d4218361af9c7821ee5",
            "patch": "@@ -1,8 +1,9 @@\n 'use strict';\n \n // Flags: --expose-internals\n-// This test verifies that the binary is compiled with code cache and the\n-// cache is used when built in modules are compiled.\n+// This test verifies that if the binary is compiled with code cache,\n+// and the cache is used when built in modules are compiled.\n+// Otherwise, verifies that no cache is used when compiling builtins.\n \n require('../common');\n const assert = require('assert');\n@@ -18,23 +19,36 @@ const {\n   compiledWithoutCache\n } = require('internal/bootstrap/cache');\n \n-assert.strictEqual(\n-  typeof process.config.variables.node_code_cache_path,\n-  'string'\n-);\n-\n-assert.deepStrictEqual(compiledWithoutCache, []);\n-\n const loadedModules = process.moduleLoadList\n   .filter((m) => m.startsWith('NativeModule'))\n   .map((m) => m.replace('NativeModule ', ''));\n \n-for (const key of loadedModules) {\n-  assert(compiledWithCache.includes(key),\n-         `\"${key}\" should've been compiled with code cache`);\n-}\n+// The binary is not configured with code cache, verifies that the builtins\n+// are all compiled without cache and we are doing the bookkeeping right.\n+if (process.config.variables.node_code_cache_path === undefined) {\n+  assert.deepStrictEqual(compiledWithCache, []);\n+  assert.notStrictEqual(compiledWithoutCache.length, 0);\n+\n+  for (const key of loadedModules) {\n+    assert(compiledWithoutCache.includes(key),\n+           `\"${key}\" should not have been compiled with code cache`);\n+  }\n \n-for (const key of cachableBuiltins) {\n-  assert(isUint8Array(codeCache[key]) && codeCache[key].length > 0,\n-         `Code cache for \"${key}\" should've been generated`);\n+} else {\n+  // The binary is configured with code cache.\n+  assert.strictEqual(\n+    typeof process.config.variables.node_code_cache_path,\n+    'string'\n+  );\n+  assert.deepStrictEqual(compiledWithoutCache, []);\n+\n+  for (const key of loadedModules) {\n+    assert(compiledWithCache.includes(key),\n+           `\"${key}\" should've been compiled with code cache`);\n+  }\n+\n+  for (const key of cachableBuiltins) {\n+    assert(isUint8Array(codeCache[key]) && codeCache[key].length > 0,\n+           `Code cache for \"${key}\" should've been generated`);\n+  }\n }"
        },
        {
            "sha": "cd36119665304350c9d3c3a346b2d42418f8d30a",
            "filename": "tools/test.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/010a3f8c23cdab04f32d2d4218361af9c7821ee5/tools%2Ftest.py",
            "raw_url": "https://github.com/nodejs/node/raw/010a3f8c23cdab04f32d2d4218361af9c7821ee5/tools%2Ftest.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Ftest.py?ref=010a3f8c23cdab04f32d2d4218361af9c7821ee5",
            "patch": "@@ -1498,7 +1498,6 @@ def PrintCrashed(code):\n IGNORED_SUITES = [\n   'addons',\n   'addons-napi',\n-  'code-cache',\n   'doctool',\n   'internet',\n   'pummel',"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 88,
        "deletions": 17
    }
}