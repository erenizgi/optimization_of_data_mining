{
    "author": "bnoordhuis",
    "message": "crypto: DRY Diffie-Hellman initialization code\n\nPR-URL: https://github.com/nodejs/node/pull/23657\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "92d67fefe2fdbe0f526c1f24e5c896a9eeb5a9d4",
    "files": [
        {
            "sha": "dd961b86b49eb71c7b67d3e3bf73050005c1c032",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 60,
            "changes": 98,
            "blob_url": "https://github.com/nodejs/node/blob/92d67fefe2fdbe0f526c1f24e5c896a9eeb5a9d4/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/92d67fefe2fdbe0f526c1f24e5c896a9eeb5a9d4/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=92d67fefe2fdbe0f526c1f24e5c896a9eeb5a9d4",
            "patch": "@@ -61,6 +61,7 @@ using v8::DontDelete;\n using v8::EscapableHandleScope;\n using v8::Exception;\n using v8::External;\n+using v8::FunctionCallback;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n using v8::HandleScope;\n@@ -3923,67 +3924,44 @@ void PublicKeyCipher::Cipher(const FunctionCallbackInfo<Value>& args) {\n \n \n void DiffieHellman::Initialize(Environment* env, Local<Object> target) {\n-  Local<FunctionTemplate> t = env->NewFunctionTemplate(New);\n-\n-  const PropertyAttribute attributes =\n-      static_cast<PropertyAttribute>(v8::ReadOnly | v8::DontDelete);\n-\n-  t->InstanceTemplate()->SetInternalFieldCount(1);\n-\n-  env->SetProtoMethod(t, \"generateKeys\", GenerateKeys);\n-  env->SetProtoMethod(t, \"computeSecret\", ComputeSecret);\n-  env->SetProtoMethodNoSideEffect(t, \"getPrime\", GetPrime);\n-  env->SetProtoMethodNoSideEffect(t, \"getGenerator\", GetGenerator);\n-  env->SetProtoMethodNoSideEffect(t, \"getPublicKey\", GetPublicKey);\n-  env->SetProtoMethodNoSideEffect(t, \"getPrivateKey\", GetPrivateKey);\n-  env->SetProtoMethod(t, \"setPublicKey\", SetPublicKey);\n-  env->SetProtoMethod(t, \"setPrivateKey\", SetPrivateKey);\n-\n-  Local<FunctionTemplate> verify_error_getter_templ =\n-      FunctionTemplate::New(env->isolate(),\n-                            DiffieHellman::VerifyErrorGetter,\n-                            env->as_external(),\n-                            Signature::New(env->isolate(), t),\n-                            /* length */ 0,\n-                            ConstructorBehavior::kThrow,\n-                            SideEffectType::kHasNoSideEffect);\n-\n-  t->InstanceTemplate()->SetAccessorProperty(\n-      env->verify_error_string(),\n-      verify_error_getter_templ,\n-      Local<FunctionTemplate>(),\n-      attributes);\n-\n-  target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"DiffieHellman\"),\n-              t->GetFunction(env->context()).ToLocalChecked());\n-\n-  Local<FunctionTemplate> t2 = env->NewFunctionTemplate(DiffieHellmanGroup);\n-  t2->InstanceTemplate()->SetInternalFieldCount(1);\n-\n-  env->SetProtoMethod(t2, \"generateKeys\", GenerateKeys);\n-  env->SetProtoMethod(t2, \"computeSecret\", ComputeSecret);\n-  env->SetProtoMethodNoSideEffect(t2, \"getPrime\", GetPrime);\n-  env->SetProtoMethodNoSideEffect(t2, \"getGenerator\", GetGenerator);\n-  env->SetProtoMethodNoSideEffect(t2, \"getPublicKey\", GetPublicKey);\n-  env->SetProtoMethodNoSideEffect(t2, \"getPrivateKey\", GetPrivateKey);\n-\n-  Local<FunctionTemplate> verify_error_getter_templ2 =\n-      FunctionTemplate::New(env->isolate(),\n-                            DiffieHellman::VerifyErrorGetter,\n-                            env->as_external(),\n-                            Signature::New(env->isolate(), t2),\n-                            /* length */ 0,\n-                            ConstructorBehavior::kThrow,\n-                            SideEffectType::kHasNoSideEffect);\n-\n-  t2->InstanceTemplate()->SetAccessorProperty(\n-      env->verify_error_string(),\n-      verify_error_getter_templ2,\n-      Local<FunctionTemplate>(),\n-      attributes);\n+  auto make = [&] (Local<String> name, FunctionCallback callback) {\n+    Local<FunctionTemplate> t = env->NewFunctionTemplate(callback);\n+\n+    const PropertyAttribute attributes =\n+        static_cast<PropertyAttribute>(v8::ReadOnly | v8::DontDelete);\n+\n+    t->InstanceTemplate()->SetInternalFieldCount(1);\n+\n+    env->SetProtoMethod(t, \"generateKeys\", GenerateKeys);\n+    env->SetProtoMethod(t, \"computeSecret\", ComputeSecret);\n+    env->SetProtoMethodNoSideEffect(t, \"getPrime\", GetPrime);\n+    env->SetProtoMethodNoSideEffect(t, \"getGenerator\", GetGenerator);\n+    env->SetProtoMethodNoSideEffect(t, \"getPublicKey\", GetPublicKey);\n+    env->SetProtoMethodNoSideEffect(t, \"getPrivateKey\", GetPrivateKey);\n+    env->SetProtoMethod(t, \"setPublicKey\", SetPublicKey);\n+    env->SetProtoMethod(t, \"setPrivateKey\", SetPrivateKey);\n+\n+    Local<FunctionTemplate> verify_error_getter_templ =\n+        FunctionTemplate::New(env->isolate(),\n+                              DiffieHellman::VerifyErrorGetter,\n+                              env->as_external(),\n+                              Signature::New(env->isolate(), t),\n+                              /* length */ 0,\n+                              ConstructorBehavior::kThrow,\n+                              SideEffectType::kHasNoSideEffect);\n+\n+    t->InstanceTemplate()->SetAccessorProperty(\n+        env->verify_error_string(),\n+        verify_error_getter_templ,\n+        Local<FunctionTemplate>(),\n+        attributes);\n+\n+    target->Set(name, t->GetFunction(env->context()).ToLocalChecked());\n+  };\n \n-  target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"DiffieHellmanGroup\"),\n-              t2->GetFunction(env->context()).ToLocalChecked());\n+  make(FIXED_ONE_BYTE_STRING(env->isolate(), \"DiffieHellman\"), New);\n+  make(FIXED_ONE_BYTE_STRING(env->isolate(), \"DiffieHellmanGroup\"),\n+       DiffieHellmanGroup);\n }\n \n "
        }
    ],
    "stats": {
        "total": 98,
        "additions": 38,
        "deletions": 60
    }
}