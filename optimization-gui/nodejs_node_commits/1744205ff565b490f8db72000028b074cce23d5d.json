{
    "author": "jasnell",
    "message": "http: move process.binding('http_parser') to internalBinding\n\nRefs: https://github.com/nodejs/node/issues/22160\n\nPR-URL: https://github.com/nodejs/node/pull/22329\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "1744205ff565b490f8db72000028b074cce23d5d",
    "files": [
        {
            "sha": "087616f44e71d16842ce307d55fa37965807fd58",
            "filename": "benchmark/http/bench-parser.js",
            "status": "modified",
            "additions": 36,
            "deletions": 32,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/benchmark%2Fhttp%2Fbench-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/benchmark%2Fhttp%2Fbench-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp%2Fbench-parser.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -1,50 +1,54 @@\n 'use strict';\n \n const common = require('../common');\n-const HTTPParser = process.binding('http_parser').HTTPParser;\n-const REQUEST = HTTPParser.REQUEST;\n-const kOnHeaders = HTTPParser.kOnHeaders | 0;\n-const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;\n-const kOnBody = HTTPParser.kOnBody | 0;\n-const kOnMessageComplete = HTTPParser.kOnMessageComplete | 0;\n-const CRLF = '\\r\\n';\n \n const bench = common.createBenchmark(main, {\n   len: [4, 8, 16, 32],\n-  n: [1e5],\n+  n: [1e5]\n+}, {\n+  flags: ['--expose-internals', '--no-warnings']\n });\n \n function main({ len, n }) {\n-  var header = `GET /hello HTTP/1.1${CRLF}Content-Type: text/plain${CRLF}`;\n-\n-  for (var i = 0; i < len; i++) {\n-    header += `X-Filler${i}: ${Math.random().toString(36).substr(2)}${CRLF}`;\n+  const { internalBinding } = require('internal/test/binding');\n+  const { HTTPParser } = internalBinding('http_parser');\n+  const REQUEST = HTTPParser.REQUEST;\n+  const kOnHeaders = HTTPParser.kOnHeaders | 0;\n+  const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;\n+  const kOnBody = HTTPParser.kOnBody | 0;\n+  const kOnMessageComplete = HTTPParser.kOnMessageComplete | 0;\n+  const CRLF = '\\r\\n';\n+\n+  function processHeader(header, n) {\n+    const parser = newParser(REQUEST);\n+\n+    bench.start();\n+    for (var i = 0; i < n; i++) {\n+      parser.execute(header, 0, header.length);\n+      parser.reinitialize(REQUEST);\n+    }\n+    bench.end(n);\n   }\n-  header += CRLF;\n \n-  processHeader(Buffer.from(header), n);\n-}\n+  function newParser(type) {\n+    const parser = new HTTPParser(type);\n \n-function processHeader(header, n) {\n-  const parser = newParser(REQUEST);\n+    parser.headers = [];\n \n-  bench.start();\n-  for (var i = 0; i < n; i++) {\n-    parser.execute(header, 0, header.length);\n-    parser.reinitialize(REQUEST);\n-  }\n-  bench.end(n);\n-}\n+    parser[kOnHeaders] = function() { };\n+    parser[kOnHeadersComplete] = function() { };\n+    parser[kOnBody] = function() { };\n+    parser[kOnMessageComplete] = function() { };\n \n-function newParser(type) {\n-  const parser = new HTTPParser(type);\n+    return parser;\n+  }\n \n-  parser.headers = [];\n+  let header = `GET /hello HTTP/1.1${CRLF}Content-Type: text/plain${CRLF}`;\n \n-  parser[kOnHeaders] = function() { };\n-  parser[kOnHeadersComplete] = function() { };\n-  parser[kOnBody] = function() { };\n-  parser[kOnMessageComplete] = function() { };\n+  for (var i = 0; i < len; i++) {\n+    header += `X-Filler${i}: ${Math.random().toString(36).substr(2)}${CRLF}`;\n+  }\n+  header += CRLF;\n \n-  return parser;\n+  processHeader(Buffer.from(header), n);\n }"
        },
        {
            "sha": "372ac0f953ff516e11501f4b791bc11554701849",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -24,7 +24,8 @@\n const util = require('util');\n const net = require('net');\n const url = require('url');\n-const { HTTPParser } = process.binding('http_parser');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { HTTPParser } = internalBinding('http_parser');\n const assert = require('assert').ok;\n const {\n   _checkIsHttpToken: checkIsHttpToken,"
        },
        {
            "sha": "09f9aebe9b2ff2a4158ae307bc3d19a745db1fb8",
            "filename": "lib/_http_common.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_common.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -21,7 +21,8 @@\n \n 'use strict';\n \n-const { methods, HTTPParser } = process.binding('http_parser');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { methods, HTTPParser } = internalBinding('http_parser');\n \n const FreeList = require('internal/freelist');\n const { ondrain } = require('internal/http');"
        },
        {
            "sha": "6e1b2c90e5351db4365109aa20bbe7b3313da62a",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -23,7 +23,8 @@\n \n const util = require('util');\n const net = require('net');\n-const { HTTPParser } = process.binding('http_parser');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { HTTPParser } = internalBinding('http_parser');\n const assert = require('assert').ok;\n const {\n   parsers,"
        },
        {
            "sha": "e6c4da25b00d9bc621e6bb40cb8d7d11d30b3dcc",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -344,7 +344,7 @@\n     // that are whitelisted for access via process.binding()... this is used\n     // to provide a transition path for modules that are being moved over to\n     // internalBinding.\n-    const internalBindingWhitelist = new SafeSet(['uv']);\n+    const internalBindingWhitelist = new SafeSet(['uv', 'http_parser']);\n     process.binding = function binding(name) {\n       return internalBindingWhitelist.has(name) ?\n         internalBinding(name) :"
        },
        {
            "sha": "d212bbeaa7bca258ce027fc09c0d218d9a378b85",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -21,6 +21,8 @@ const dgram = require('dgram');\n const util = require('util');\n const assert = require('assert');\n \n+const { internalBinding } = require('internal/bootstrap/loaders');\n+\n const { Process } = process.binding('process_wrap');\n const { WriteWrap } = process.binding('stream_wrap');\n const { Pipe, constants: PipeConstants } = process.binding('pipe_wrap');\n@@ -32,12 +34,10 @@ const { owner_symbol } = require('internal/async_hooks').symbols;\n const { convertToValidSignal } = require('internal/util');\n const { isUint8Array } = require('internal/util/types');\n const spawn_sync = process.binding('spawn_sync');\n-const { HTTPParser } = process.binding('http_parser');\n+const { HTTPParser } = internalBinding('http_parser');\n const { freeParser } = require('_http_common');\n const { kStateSymbol } = require('internal/dgram');\n \n-const { internalBinding } = require('internal/bootstrap/loaders');\n-\n const {\n   UV_EACCES,\n   UV_EAGAIN,"
        },
        {
            "sha": "bab15a8c4bdf6ccba0e77d56c43bb28c9e9b316a",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -775,4 +775,4 @@ void Initialize(Local<Object> target,\n }  // anonymous namespace\n }  // namespace node\n \n-NODE_BUILTIN_MODULE_CONTEXT_AWARE(http_parser, node::Initialize)\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(http_parser, node::Initialize)"
        },
        {
            "sha": "71fccc0a8589214cb7d0e3b2fd6136f00b9f2c35",
            "filename": "test/async-hooks/test-httpparser.request.js",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fasync-hooks%2Ftest-httpparser.request.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fasync-hooks%2Ftest-httpparser.request.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-httpparser.request.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -1,3 +1,4 @@\n+// Flags: --expose-internals\n 'use strict';\n \n const common = require('../common');\n@@ -6,17 +7,21 @@ const tick = require('./tick');\n const initHooks = require('./init-hooks');\n const { checkInvocations } = require('./hook-checks');\n \n-const binding = process.binding('http_parser');\n-const HTTPParser = binding.HTTPParser;\n+const hooks = initHooks();\n+hooks.enable();\n+\n+// The hooks.enable() must come before require('internal/test/binding')\n+// because internal/test/binding schedules a process warning on nextTick.\n+// If this order is not preserved, the hooks check will fail because it\n+// will not be notified about the nextTick creation but will see the\n+// callback event.\n+const { internalBinding } = require('internal/test/binding');\n+const { HTTPParser } = internalBinding('http_parser');\n \n const REQUEST = HTTPParser.REQUEST;\n \n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;\n \n-const hooks = initHooks();\n-\n-hooks.enable();\n-\n const request = Buffer.from(\n   'GET /hello HTTP/1.1\\r\\n\\r\\n'\n );"
        },
        {
            "sha": "eea40b14d16b68c91708026aedf7c083594ab830",
            "filename": "test/async-hooks/test-httpparser.response.js",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fasync-hooks%2Ftest-httpparser.response.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fasync-hooks%2Ftest-httpparser.response.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-httpparser.response.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -1,3 +1,4 @@\n+// Flags: --expose-internals\n 'use strict';\n \n const common = require('../common');\n@@ -6,17 +7,22 @@ const tick = require('./tick');\n const initHooks = require('./init-hooks');\n const { checkInvocations } = require('./hook-checks');\n \n-const binding = process.binding('http_parser');\n-const HTTPParser = binding.HTTPParser;\n+const hooks = initHooks();\n+\n+hooks.enable();\n+\n+// The hooks.enable() must come before require('internal/test/binding')\n+// because internal/test/binding schedules a process warning on nextTick.\n+// If this order is not preserved, the hooks check will fail because it\n+// will not be notified about the nextTick creation but will see the\n+// callback event.\n+const { internalBinding } = require('internal/test/binding');\n+const { HTTPParser } = internalBinding('http_parser');\n \n const RESPONSE = HTTPParser.RESPONSE;\n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;\n const kOnBody = HTTPParser.kOnBody | 0;\n \n-const hooks = initHooks();\n-\n-hooks.enable();\n-\n const request = Buffer.from(\n   'HTTP/1.1 200 OK\\r\\n' +\n   'Content-Type: text/plain\\r\\n' +"
        },
        {
            "sha": "60151c6348814378cfe19c9ee1debbe598229407",
            "filename": "test/parallel/test-http-parser-bad-ref.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-http-parser-bad-ref.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-http-parser-bad-ref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser-bad-ref.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -2,11 +2,12 @@\n // Run this program with valgrind or efence with --expose_gc to expose the\n // problem.\n \n-// Flags: --expose_gc\n+// Flags: --expose_gc --expose-internals\n \n require('../common');\n const assert = require('assert');\n-const HTTPParser = process.binding('http_parser').HTTPParser;\n+const { internalBinding } = require('internal/test/binding');\n+const { HTTPParser } = internalBinding('http_parser');\n \n const kOnHeaders = HTTPParser.kOnHeaders | 0;\n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;"
        },
        {
            "sha": "0bdaa22b8ade5afae5cf638d8875654c0514e561",
            "filename": "test/parallel/test-http-parser.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-http-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-http-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -19,11 +19,14 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+// Flags: --expose-internals\n+\n 'use strict';\n const { mustCall, mustNotCall } = require('../common');\n const assert = require('assert');\n \n-const { methods, HTTPParser } = process.binding('http_parser');\n+const { internalBinding } = require('internal/test/binding');\n+const { methods, HTTPParser } = internalBinding('http_parser');\n const { REQUEST, RESPONSE } = HTTPParser;\n \n const kOnHeaders = HTTPParser.kOnHeaders | 0;"
        },
        {
            "sha": "bfb265a2994952600f66e75a6c8e83e1ae8010a7",
            "filename": "test/parallel/test-process-binding-internalbinding-whitelist.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-process-binding-internalbinding-whitelist.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fparallel%2Ftest-process-binding-internalbinding-whitelist.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-binding-internalbinding-whitelist.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -7,3 +7,4 @@ const assert = require('assert');\n // Assert that whitelisted internalBinding modules are accessible via\n // process.binding().\n assert(process.binding('uv'));\n+assert(process.binding('http_parser'));"
        },
        {
            "sha": "9ee32b646cd955e71ab03d04c603ae78c9cb0a2e",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -1,7 +1,8 @@\n 'use strict';\n-// Flags: --expose-gc\n+// Flags: --expose-gc --expose-internals\n \n const common = require('../common');\n+const { internalBinding } = require('internal/test/binding');\n const assert = require('assert');\n const fs = require('fs');\n const fsPromises = fs.promises;\n@@ -146,7 +147,7 @@ if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n \n \n {\n-  const HTTPParser = process.binding('http_parser').HTTPParser;\n+  const { HTTPParser } = internalBinding('http_parser');\n   testInitialized(new HTTPParser(), 'HTTPParser');\n }\n "
        },
        {
            "sha": "0950b84bbe093d3836edda0c57d4b9ad28180229",
            "filename": "test/sequential/test-http-regr-gh-2928.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1744205ff565b490f8db72000028b074cce23d5d/test%2Fsequential%2Ftest-http-regr-gh-2928.js",
            "raw_url": "https://github.com/nodejs/node/raw/1744205ff565b490f8db72000028b074cce23d5d/test%2Fsequential%2Ftest-http-regr-gh-2928.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-regr-gh-2928.js?ref=1744205ff565b490f8db72000028b074cce23d5d",
            "patch": "@@ -1,11 +1,13 @@\n // This test is designed to fail with a segmentation fault in Node.js 4.1.0 and\n // execute without issues in Node.js 4.1.1 and up.\n \n+// Flags: --expose-internals\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n const httpCommon = require('_http_common');\n-const HTTPParser = process.binding('http_parser').HTTPParser;\n+const { internalBinding } = require('internal/test/binding');\n+const { HTTPParser } = internalBinding('http_parser');\n const net = require('net');\n \n const COUNT = httpCommon.parsers.max + 1;"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 84,
        "deletions": 58
    }
}