{
    "author": "ronag",
    "message": "http: fix res emit close before user finish\n\nPR-URL: https://github.com/nodejs/node/pull/20941\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "8ce20aff2dbee80ca2739f37c36999e3906f5f06",
    "files": [
        {
            "sha": "3d5a1f8f6242f78cfa258e1160759f8a52a9e71e",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8ce20aff2dbee80ca2739f37c36999e3906f5f06/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ce20aff2dbee80ca2739f37c36999e3906f5f06/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=8ce20aff2dbee80ca2739f37c36999e3906f5f06",
            "patch": "@@ -562,7 +562,7 @@ function resOnFinish(req, res, socket, state, server) {\n \n   res.detachSocket(socket);\n   req.emit('close');\n-  res.emit('close');\n+  process.nextTick(emitCloseNT, res);\n \n   if (res._last) {\n     if (typeof socket.destroySoon === 'function') {\n@@ -585,6 +585,10 @@ function resOnFinish(req, res, socket, state, server) {\n   }\n }\n \n+function emitCloseNT(self) {\n+  self.emit('close');\n+}\n+\n // The following callback is issued after the headers have been read on a\n // new message. In this callback we setup the response object and pass it\n // to the user."
        },
        {
            "sha": "daba55f43427c2377dde374ecc9060aed6e5f299",
            "filename": "test/parallel/test-http-req-res-close.js",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/8ce20aff2dbee80ca2739f37c36999e3906f5f06/test%2Fparallel%2Ftest-http-req-res-close.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ce20aff2dbee80ca2739f37c36999e3906f5f06/test%2Fparallel%2Ftest-http-req-res-close.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-req-res-close.js?ref=8ce20aff2dbee80ca2739f37c36999e3906f5f06",
            "patch": "@@ -2,12 +2,21 @@\n \n const common = require('../common');\n const http = require('http');\n+const assert = require('assert');\n \n const server = http.Server(common.mustCall((req, res) => {\n+  let resClosed = false;\n+\n   res.end();\n-  res.on('finish', common.mustCall());\n-  res.on('close', common.mustCall());\n-  req.on('close', common.mustCall());\n+  res.on('finish', common.mustCall(() => {\n+    assert.strictEqual(resClosed, false);\n+  }));\n+  res.on('close', common.mustCall(() => {\n+    resClosed = true;\n+  }));\n+  req.on('close', common.mustCall(() => {\n+    assert.strictEqual(req._readableState.ended, true);\n+  }));\n   res.socket.on('close', () => server.close());\n }));\n "
        }
    ],
    "stats": {
        "total": 21,
        "additions": 17,
        "deletions": 4
    }
}