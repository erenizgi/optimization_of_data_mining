{
    "author": "addaleax",
    "message": "src: yield empty maybes for failed AsyncWrap::MakeCallback calls\n\nUse an empty `MaybeLocal<Value>` as the return value for\n`AsyncWrap::MakeCallback()` if an exception occurred,\nregardless of `MakeCallback` depth.\n\nUnfortunately, the public API can not make this switch without\na breaking change (and possibly some kind of deprecation/renaming).\n\nPR-URL: https://github.com/nodejs/node/pull/22078\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>",
    "sha": "45d0b4a300cbc845727fee75c59427cc343b1559",
    "files": [
        {
            "sha": "eca405dfc14124ece11511719c55b18b1a6aad52",
            "filename": "src/callback_scope.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fcallback_scope.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fcallback_scope.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcallback_scope.cc?ref=45d0b4a300cbc845727fee75c59427cc343b1559",
            "patch": "@@ -87,7 +87,7 @@ void InternalCallbackScope::Close() {\n     AsyncWrap::EmitAfter(env_, async_context_.async_id);\n   }\n \n-  if (IsInnerMakeCallback()) {\n+  if (env_->makecallback_depth() > 1) {\n     return;\n   }\n "
        },
        {
            "sha": "d65d7e7562f2861e55bf813717f2aab1c3f4c51d",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=45d0b4a300cbc845727fee75c59427cc343b1559",
            "patch": "@@ -218,8 +218,8 @@ inline Environment::AsyncCallbackScope::~AsyncCallbackScope() {\n   env_->makecallback_cntr_--;\n }\n \n-inline bool Environment::AsyncCallbackScope::in_makecallback() const {\n-  return env_->makecallback_cntr_ > 1;\n+inline size_t Environment::makecallback_depth() const {\n+  return makecallback_cntr_;\n }\n \n inline Environment::ImmediateInfo::ImmediateInfo(v8::Isolate* isolate)"
        },
        {
            "sha": "7a4804cdd4548103046e346a0b1d8c41704f31eb",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=45d0b4a300cbc845727fee75c59427cc343b1559",
            "patch": "@@ -499,14 +499,15 @@ class Environment {\n     AsyncCallbackScope() = delete;\n     explicit AsyncCallbackScope(Environment* env);\n     ~AsyncCallbackScope();\n-    inline bool in_makecallback() const;\n \n    private:\n     Environment* env_;\n \n     DISALLOW_COPY_AND_ASSIGN(AsyncCallbackScope);\n   };\n \n+  inline size_t makecallback_depth() const;\n+\n   class ImmediateInfo {\n    public:\n     inline AliasedBuffer<uint32_t, v8::Uint32Array>& fields();"
        },
        {
            "sha": "c562403379bf2275d3e928d18ca3451a1332ded2",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=45d0b4a300cbc845727fee75c59427cc343b1559",
            "patch": "@@ -757,7 +757,7 @@ MaybeLocal<Value> InternalMakeCallback(Environment* env,\n   CHECK(!recv.IsEmpty());\n   InternalCallbackScope scope(env, recv, asyncContext);\n   if (scope.Failed()) {\n-    return Undefined(env->isolate());\n+    return MaybeLocal<Value>();\n   }\n \n   Local<Function> domain_cb = env->domain_callback();\n@@ -772,15 +772,13 @@ MaybeLocal<Value> InternalMakeCallback(Environment* env,\n   }\n \n   if (ret.IsEmpty()) {\n-    // NOTE: For backwards compatibility with public API we return Undefined()\n-    // if the top level call threw.\n     scope.MarkAsFailed();\n-    return scope.IsInnerMakeCallback() ? ret : Undefined(env->isolate());\n+    return MaybeLocal<Value>();\n   }\n \n   scope.Close();\n   if (scope.Failed()) {\n-    return Undefined(env->isolate());\n+    return MaybeLocal<Value>();\n   }\n \n   return ret;\n@@ -832,8 +830,14 @@ MaybeLocal<Value> MakeCallback(Isolate* isolate,\n   // the two contexts need not be the same.\n   Environment* env = Environment::GetCurrent(callback->CreationContext());\n   Context::Scope context_scope(env->context());\n-  return InternalMakeCallback(env, recv, callback,\n-                              argc, argv, asyncContext);\n+  MaybeLocal<Value> ret = InternalMakeCallback(env, recv, callback,\n+                                               argc, argv, asyncContext);\n+  if (ret.IsEmpty() && env->makecallback_depth() == 0) {\n+    // This is only for legacy compatiblity and we may want to look into\n+    // removing/adjusting it.\n+    return Undefined(env->isolate());\n+  }\n+  return ret;\n }\n \n "
        },
        {
            "sha": "968d229f1001a734e4b13a28e7fed54a0e049899",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/45d0b4a300cbc845727fee75c59427cc343b1559/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=45d0b4a300cbc845727fee75c59427cc343b1559",
            "patch": "@@ -543,9 +543,6 @@ class InternalCallbackScope {\n \n   inline bool Failed() const { return failed_; }\n   inline void MarkAsFailed() { failed_ = true; }\n-  inline bool IsInnerMakeCallback() const {\n-    return callback_scope_.in_makecallback();\n-  }\n \n  private:\n   Environment* env_;"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 16,
        "deletions": 14
    }
}