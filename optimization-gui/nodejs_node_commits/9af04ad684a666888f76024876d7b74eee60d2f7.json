{
    "author": "mcollina",
    "message": "http2: improve compat performance\n\nThis bunch of commits help me improve the performance of a http2\nserver by 8-10%. The benchmarks reports several 1-2% improvements in\nvarious areas.\n\nPR-URL: https://github.com/nodejs/node/pull/25567\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "9af04ad684a666888f76024876d7b74eee60d2f7",
    "files": [
        {
            "sha": "5d06ccf31782570554e17b1b848dad833e6bd60a",
            "filename": "benchmark/http2/compat.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/9af04ad684a666888f76024876d7b74eee60d2f7/benchmark%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/9af04ad684a666888f76024876d7b74eee60d2f7/benchmark%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp2%2Fcompat.js?ref=9af04ad684a666888f76024876d7b74eee60d2f7",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+const common = require('../common.js');\n+const path = require('path');\n+const fs = require('fs');\n+const file = path.join(path.resolve(__dirname, '../fixtures'), 'alice.html');\n+\n+const bench = common.createBenchmark(main, {\n+  requests: [100, 1000, 5000],\n+  streams: [1, 10, 20, 40, 100, 200],\n+  clients: [2],\n+  benchmarker: ['h2load']\n+}, { flags: ['--no-warnings'] });\n+\n+function main({ requests, streams, clients }) {\n+  const http2 = require('http2');\n+  const server = http2.createServer();\n+  server.on('request', (req, res) => {\n+    const out = fs.createReadStream(file);\n+    res.setHeader('content-type', 'text/html');\n+    out.pipe(res);\n+    out.on('error', (err) => {\n+      res.destroy();\n+    });\n+  });\n+  server.listen(common.PORT, () => {\n+    bench.http({\n+      path: '/',\n+      requests,\n+      maxConcurrentStreams: streams,\n+      clients,\n+      threads: clients\n+    }, () => { server.close(); });\n+  });\n+}"
        },
        {
            "sha": "da88f4d880ad67e08ba22e7d28b59b02f1d0f424",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=9af04ad684a666888f76024876d7b74eee60d2f7",
            "patch": "@@ -18,18 +18,16 @@ const {\n   ERR_INVALID_HTTP_TOKEN\n } = require('internal/errors').codes;\n const { validateString } = require('internal/validators');\n-const { kSocket } = require('internal/http2/util');\n+const { kSocket, kRequest, kProxySocket } = require('internal/http2/util');\n \n const kBeginSend = Symbol('begin-send');\n const kState = Symbol('state');\n const kStream = Symbol('stream');\n-const kRequest = Symbol('request');\n const kResponse = Symbol('response');\n const kHeaders = Symbol('headers');\n const kRawHeaders = Symbol('rawHeaders');\n const kTrailers = Symbol('trailers');\n const kRawTrailers = Symbol('rawTrailers');\n-const kProxySocket = Symbol('proxySocket');\n const kSetHeader = Symbol('setHeader');\n const kAborted = Symbol('aborted');\n "
        },
        {
            "sha": "0a566ed9e672f15d4c53c480e9e1bbefcd41bd28",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 22,
            "deletions": 4,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=9af04ad684a666888f76024876d7b74eee60d2f7",
            "patch": "@@ -96,6 +96,8 @@ const {\n   getStreamState,\n   isPayloadMeaningless,\n   kSocket,\n+  kRequest,\n+  kProxySocket,\n   mapToHeaders,\n   NghttpError,\n   sessionName,\n@@ -117,6 +119,8 @@ const {\n const { kTimeout } = require('internal/timers');\n const { isArrayBufferView } = require('internal/util/types');\n \n+const hasOwnProperty = Object.prototype.hasOwnProperty;\n+\n const { FileHandle } = internalBinding('fs');\n const binding = internalBinding('http2');\n const {\n@@ -155,7 +159,6 @@ const kOwner = owner_symbol;\n const kOrigin = Symbol('origin');\n const kProceed = Symbol('proceed');\n const kProtocol = Symbol('protocol');\n-const kProxySocket = Symbol('proxy-socket');\n const kRemoteSettings = Symbol('remote-settings');\n const kSelectPadding = Symbol('select-padding');\n const kSentHeaders = Symbol('sent-headers');\n@@ -1622,6 +1625,10 @@ class Http2Stream extends Duplex {\n       endAfterHeaders: false\n     };\n \n+    // Fields used by the compat API to avoid megamorphisms.\n+    this[kRequest] = null;\n+    this[kProxySocket] = null;\n+\n     this.on('pause', streamOnPause);\n   }\n \n@@ -2001,9 +2008,20 @@ class Http2Stream extends Duplex {\n   }\n }\n \n-function processHeaders(headers) {\n-  assertIsObject(headers, 'headers');\n-  headers = Object.assign(Object.create(null), headers);\n+function processHeaders(oldHeaders) {\n+  assertIsObject(oldHeaders, 'headers');\n+  const headers = Object.create(null);\n+\n+  if (oldHeaders !== null && oldHeaders !== undefined) {\n+    const hop = hasOwnProperty.bind(oldHeaders);\n+    // This loop is here for performance reason. Do not change.\n+    for (var key in oldHeaders) {\n+      if (hop(key)) {\n+        headers[key] = oldHeaders[key];\n+      }\n+    }\n+  }\n+\n   const statusCode =\n     headers[HTTP2_HEADER_STATUS] =\n       headers[HTTP2_HEADER_STATUS] | 0 || HTTP_STATUS_OK;"
        },
        {
            "sha": "0a3faa23557a96d3e1c8c9b1212af1e940b5c2e1",
            "filename": "lib/internal/http2/util.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/9af04ad684a666888f76024876d7b74eee60d2f7/lib%2Finternal%2Fhttp2%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Futil.js?ref=9af04ad684a666888f76024876d7b74eee60d2f7",
            "patch": "@@ -10,6 +10,8 @@ const {\n } = require('internal/errors').codes;\n \n const kSocket = Symbol('socket');\n+const kProxySocket = Symbol('proxySocket');\n+const kRequest = Symbol('request');\n \n const {\n   NGHTTP2_SESSION_CLIENT,\n@@ -499,12 +501,12 @@ class NghttpError extends Error {\n   }\n }\n \n-function assertIsObject(value, name, types = 'Object') {\n+function assertIsObject(value, name, types) {\n   if (value !== undefined &&\n       (value === null ||\n        typeof value !== 'object' ||\n        Array.isArray(value))) {\n-    const err = new ERR_INVALID_ARG_TYPE(name, types, value);\n+    const err = new ERR_INVALID_ARG_TYPE(name, types || 'Object', value);\n     Error.captureStackTrace(err, assertIsObject);\n     throw err;\n   }\n@@ -592,6 +594,8 @@ module.exports = {\n   getStreamState,\n   isPayloadMeaningless,\n   kSocket,\n+  kProxySocket,\n+  kRequest,\n   mapToHeaders,\n   NghttpError,\n   sessionName,"
        },
        {
            "sha": "d126f90eef829e4325c5089177ea652eaa1247bb",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/9af04ad684a666888f76024876d7b74eee60d2f7/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9af04ad684a666888f76024876d7b74eee60d2f7/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=9af04ad684a666888f76024876d7b74eee60d2f7",
            "patch": "@@ -64,11 +64,29 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n   };\n   Local<FunctionTemplate> sw =\n       FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n-  sw->InstanceTemplate()->SetInternalFieldCount(StreamReq::kStreamReqField + 1);\n+  sw->InstanceTemplate()->SetInternalFieldCount(\n+      StreamReq::kStreamReqField + 1 + 3);\n   Local<String> wrapString =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"ShutdownWrap\");\n   sw->SetClassName(wrapString);\n+\n+  // we need to set handle and callback to null,\n+  // so that those fields are created and functions\n+  // do not become megamorphic\n+  // Fields:\n+  // - oncomplete\n+  // - callback\n+  // - handle\n+  sw->InstanceTemplate()->Set(\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"oncomplete\"),\n+      v8::Null(env->isolate()));\n+  sw->InstanceTemplate()->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"callback\"),\n+      v8::Null(env->isolate()));\n+  sw->InstanceTemplate()->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"handle\"),\n+      v8::Null(env->isolate()));\n+\n   sw->Inherit(AsyncWrap::GetConstructorTemplate(env));\n+\n   target->Set(env->context(),\n               wrapString,\n               sw->GetFunction(env->context()).ToLocalChecked()).FromJust();"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 83,
        "deletions": 10
    }
}