{
    "author": "BridgeAR",
    "message": "util: improve error inspection\n\nWhen inspecting errors with extra properties while setting the\ncompact option to false, it will now return:\n\n[Error: foo] {\n    at repl:1:5\n    at Script.runInThisContext (vm.js:89:20)\n  bla: true\n}\n\nInstead of:\n\nError: foo\n    at repl:1:5\n    at Script.runInThisContext (vm.js:91:20) {\n  bla: true\n}\n\nPR-URL: https://github.com/nodejs/node/pull/20802\nRefs: https://github.com/nodejs/node/issues/20253\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "c041a2ee5bc7c89d846a53e4873dd394c19ec4c4",
    "files": [
        {
            "sha": "27ad26d746055b06213f72c9cf39af12c060b978",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=c041a2ee5bc7c89d846a53e4873dd394c19ec4c4",
            "patch": "@@ -587,7 +587,8 @@ function formatValue(ctx, value, recurseTimes) {\n       // Make error with message first say the error\n       base = formatError(value);\n       // Wrap the error in brackets in case it has no stack trace.\n-      if (base.indexOf('\\n    at') === -1) {\n+      const stackStart = base.indexOf('\\n    at');\n+      if (stackStart === -1) {\n         base = `[${base}]`;\n       }\n       // The message and the stack have to be indented as well!\n@@ -597,6 +598,11 @@ function formatValue(ctx, value, recurseTimes) {\n       }\n       if (keyLength === 0)\n         return base;\n+\n+      if (ctx.compact === false && stackStart !== -1) {\n+        braces[0] += `${base.slice(stackStart)}`;\n+        base = `[${base.slice(0, stackStart)}]`;\n+      }\n     } else if (isAnyArrayBuffer(value)) {\n       // Fast path for ArrayBuffer and SharedArrayBuffer.\n       // Can't do the same for DataView because it has a non-primitive"
        },
        {
            "sha": "f7fe0bcea80ca0b4f9c11a5381dff7b210b269d8",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=c041a2ee5bc7c89d846a53e4873dd394c19ec4c4",
            "patch": "@@ -174,7 +174,7 @@ function testError() {\n \n       // The error, both from the original throw and the `_error` echo.\n       'Error: foo',\n-      'Error: foo',\n+      '[Error: foo]',\n \n       // The sync error, with individual property echoes\n       /Error: ENOENT: no such file or directory, scandir '.*nonexistent.*'/,"
        },
        {
            "sha": "347f5046a832b25361953ec0b6f4ca289edd9665",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 40,
            "deletions": 2,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/c041a2ee5bc7c89d846a53e4873dd394c19ec4c4/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=c041a2ee5bc7c89d846a53e4873dd394c19ec4c4",
            "patch": "@@ -519,11 +519,49 @@ assert.strictEqual(util.inspect(-5e-324), '-5e-324');\n   const tmp = Error.stackTraceLimit;\n   Error.stackTraceLimit = 0;\n   const err = new Error('foo');\n-  assert.strictEqual(util.inspect(err), '[Error: foo]');\n+  const err2 = new Error('foo\\nbar');\n+  assert.strictEqual(util.inspect(err, { compact: true }), '[Error: foo]');\n   assert(err.stack);\n   delete err.stack;\n   assert(!err.stack);\n-  assert.strictEqual(util.inspect(err), '[Error: foo]');\n+  assert.strictEqual(util.inspect(err, { compact: true }), '[Error: foo]');\n+  assert.strictEqual(\n+    util.inspect(err2, { compact: true }),\n+    '[Error: foo\\nbar]'\n+  );\n+\n+  err.bar = true;\n+  err2.bar = true;\n+\n+  assert.strictEqual(\n+    util.inspect(err, { compact: true }),\n+    '{ [Error: foo] bar: true }'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err2, { compact: true }),\n+    '{ [Error: foo\\nbar] bar: true }'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err, { compact: true, breakLength: 5 }),\n+    '{ [Error: foo]\\n  bar: true }'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err, { compact: true, breakLength: 1 }),\n+    '{ [Error: foo]\\n  bar:\\n   true }'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err2, { compact: true, breakLength: 5 }),\n+    '{ [Error: foo\\nbar]\\n  bar: true }'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err, { compact: false }),\n+    '[Error: foo] {\\n  bar: true\\n}'\n+  );\n+  assert.strictEqual(\n+    util.inspect(err2, { compact: false }),\n+    '[Error: foo\\nbar] {\\n  bar: true\\n}'\n+  );\n+\n   Error.stackTraceLimit = tmp;\n }\n "
        }
    ],
    "stats": {
        "total": 52,
        "additions": 48,
        "deletions": 4
    }
}