{
    "author": "prog1dev",
    "message": "src: free memory before re-setting URLHost value\n\nFixes: https://github.com/nodejs/node/issues/18302\n\nPR-URL: https://github.com/nodejs/node/pull/18357\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "36fd25fa0572403ff32645611e1993de25422182",
    "files": [
        {
            "sha": "cac2831af6ef7f1d0c32cb56c7c82c2e18789dac",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/36fd25fa0572403ff32645611e1993de25422182/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/36fd25fa0572403ff32645611e1993de25422182/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=36fd25fa0572403ff32645611e1993de25422182",
            "patch": "@@ -92,6 +92,16 @@ class URLHost {\n   Value value_;\n   HostType type_ = HostType::H_FAILED;\n \n+  inline void Reset() {\n+    using string = std::string;\n+    switch (type_) {\n+      case HostType::H_DOMAIN: value_.domain.~string(); break;\n+      case HostType::H_OPAQUE: value_.opaque.~string(); break;\n+      default: break;\n+    }\n+    type_ = HostType::H_FAILED;\n+  }\n+\n   // Setting the string members of the union with = is brittle because\n   // it relies on them being initialized to a state that requires no\n   // destruction of old data.\n@@ -101,23 +111,20 @@ class URLHost {\n   // These helpers are the easiest solution but we might want to consider\n   // just not forcing strings into an union.\n   inline void SetOpaque(std::string&& string) {\n+    Reset();\n     type_ = HostType::H_OPAQUE;\n     new(&value_.opaque) std::string(std::move(string));\n   }\n \n   inline void SetDomain(std::string&& string) {\n+    Reset();\n     type_ = HostType::H_DOMAIN;\n     new(&value_.domain) std::string(std::move(string));\n   }\n };\n \n URLHost::~URLHost() {\n-  using string = std::string;\n-  switch (type_) {\n-    case HostType::H_DOMAIN: value_.domain.~string(); break;\n-    case HostType::H_OPAQUE: value_.opaque.~string(); break;\n-    default: break;\n-  }\n+  Reset();\n }\n \n #define ARGS(XX)                                                              \\"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 13,
        "deletions": 6
    }
}