{
    "author": "mscdex",
    "message": "Revert \"stream: prevent 'end' to be emitted after 'error'\"\n\nThis reverts commit 08577906569a4c2de70ad2a861e2f8456cd8fcdd.\n\nPR-URL: https://github.com/nodejs/node/pull/20449\nFixes: https://github.com/nodejs/node/issues/20334\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
    "files": [
        {
            "sha": "8073e174cc586ffd765c10edeb1dbed0cd7af681",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 5,
            "deletions": 11,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -99,9 +99,6 @@ function ReadableState(options, stream, isDuplex) {\n   this.endEmitted = false;\n   this.reading = false;\n \n-  // Flipped if an 'error' is emitted.\n-  this.errorEmitted = false;\n-\n   // a flag to be able to tell if the event 'readable'/'data' is emitted\n   // immediately, or on a later tick.  We set this to true at first, because\n   // any actions that shouldn't happen until \"later\" should generally also\n@@ -1072,23 +1069,20 @@ function fromList(n, state) {\n function endReadable(stream) {\n   var state = stream._readableState;\n \n-  debug('endReadable', state.endEmitted, state.errorEmitted);\n-  if (!state.endEmitted && !state.errorEmitted) {\n+  debug('endReadable', state.endEmitted);\n+  if (!state.endEmitted) {\n     state.ended = true;\n     process.nextTick(endReadableNT, state, stream);\n   }\n }\n \n function endReadableNT(state, stream) {\n-  debug('endReadableNT', state.endEmitted, state.length, state.errorEmitted);\n+  debug('endReadableNT', state.endEmitted, state.length);\n \n   // Check that we didn't get one last unshift.\n   if (!state.endEmitted && state.length === 0) {\n+    state.endEmitted = true;\n     stream.readable = false;\n-\n-    if (!state.errorEmitted) {\n-      state.endEmitted = true;\n-      stream.emit('end');\n-    }\n+    stream.emit('end');\n   }\n }"
        },
        {
            "sha": "d21daf0541d33950db56b24057a087599f348275",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -424,22 +424,12 @@ function onwriteError(stream, state, sync, er, cb) {\n     // this can emit finish, and it will always happen\n     // after error\n     process.nextTick(finishMaybe, stream, state);\n-\n-    // needed for duplex, fixes https://github.com/nodejs/node/issues/6083\n-    if (stream._readableState) {\n-      stream._readableState.errorEmitted = true;\n-    }\n     stream._writableState.errorEmitted = true;\n     stream.emit('error', er);\n   } else {\n     // the caller expect this to happen before if\n     // it is async\n     cb(er);\n-\n-    // needed for duplex, fixes https://github.com/nodejs/node/issues/6083\n-    if (stream._readableState) {\n-      stream._readableState.errorEmitted = true;\n-    }\n     stream._writableState.errorEmitted = true;\n     stream.emit('error', er);\n     // this can emit finish, but finish must"
        },
        {
            "sha": "3a0383cc3cea70d886cbd2676acc878a8a0245f0",
            "filename": "lib/internal/streams/destroy.js",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fdestroy.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -8,14 +8,10 @@ function destroy(err, cb) {\n     this._writableState.destroyed;\n \n   if (readableDestroyed || writableDestroyed) {\n-    const readableErrored = this._readableState &&\n-      this._readableState.errorEmitted;\n-    const writableErrored = this._writableState &&\n-      this._writableState.errorEmitted;\n-\n     if (cb) {\n       cb(err);\n-    } else if (err && !readableErrored && !writableErrored) {\n+    } else if (err &&\n+               (!this._writableState || !this._writableState.errorEmitted)) {\n       process.nextTick(emitErrorNT, this, err);\n     }\n     return this;\n@@ -36,11 +32,6 @@ function destroy(err, cb) {\n   this._destroy(err || null, (err) => {\n     if (!cb && err) {\n       process.nextTick(emitErrorAndCloseNT, this, err);\n-\n-      if (this._readableState) {\n-        this._readableState.errorEmitted = true;\n-      }\n-\n       if (this._writableState) {\n         this._writableState.errorEmitted = true;\n       }\n@@ -74,7 +65,6 @@ function undestroy() {\n     this._readableState.reading = false;\n     this._readableState.ended = false;\n     this._readableState.endEmitted = false;\n-    this._readableState.errorEmitted = false;\n   }\n \n   if (this._writableState) {"
        },
        {
            "sha": "6238363511a7917cc24e07c6c240ba6ce3ed60a3",
            "filename": "test/parallel/test-http2-client-destroy.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-destroy.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -95,6 +95,7 @@ const Countdown = require('../common/countdown');\n     });\n \n     req.resume();\n+    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => server.close()));\n   }));\n }"
        },
        {
            "sha": "a75dc590c669a1eeb382f5575b01ee64c924b5fb",
            "filename": "test/parallel/test-http2-client-onconnect-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -101,6 +101,7 @@ function runTest(test) {\n     });\n   }\n \n+  req.on('end', common.mustCall());\n   req.on('close', common.mustCall(() => {\n     client.destroy();\n "
        },
        {
            "sha": "d834de5d11ebe7e9f3719fd05be8f16bc59545b1",
            "filename": "test/parallel/test-http2-client-stream-destroy-before-connect.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -45,4 +45,5 @@ server.listen(0, common.mustCall(() => {\n \n   req.on('response', common.mustNotCall());\n   req.resume();\n+  req.on('end', common.mustCall());\n }));"
        },
        {
            "sha": "8ee52a74ab4e81326c397a4d63b7dc20922cb95a",
            "filename": "test/parallel/test-http2-compat-serverresponse-destroy.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -63,6 +63,7 @@ server.listen(0, common.mustCall(() => {\n     req.on('close', common.mustCall(() => countdown.dec()));\n \n     req.resume();\n+    req.on('end', common.mustCall());\n   }\n \n   {\n@@ -77,5 +78,6 @@ server.listen(0, common.mustCall(() => {\n     req.on('close', common.mustCall(() => countdown.dec()));\n \n     req.resume();\n+    req.on('end', common.mustCall());\n   }\n }));"
        },
        {
            "sha": "b270d6cc6aff3108140c274e1322c9e95f73a939",
            "filename": "test/parallel/test-http2-max-concurrent-streams.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -45,6 +45,7 @@ server.listen(0, common.mustCall(() => {\n     req.on('aborted', common.mustCall());\n     req.on('response', common.mustNotCall());\n     req.resume();\n+    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => countdown.dec()));\n     req.on('error', common.expectsError({\n       code: 'ERR_HTTP2_STREAM_ERROR',"
        },
        {
            "sha": "c1ae37b9a36938e9208724641df91507c83fe87c",
            "filename": "test/parallel/test-http2-misused-pseudoheaders.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -41,6 +41,7 @@ server.listen(0, common.mustCall(() => {\n \n   req.on('response', common.mustCall());\n   req.resume();\n+  req.on('end', common.mustCall());\n   req.on('close', common.mustCall(() => {\n     server.close();\n     client.close();"
        },
        {
            "sha": "7d8ff4858fedbbe58ffff9ac2c7755f05b7859b8",
            "filename": "test/parallel/test-http2-multi-content-length.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-multi-content-length.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-multi-content-length.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-multi-content-length.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -53,6 +53,7 @@ server.listen(0, common.mustCall(() => {\n     // header to be set for non-payload bearing requests...\n     const req = client.request({ 'content-length': 1 });\n     req.resume();\n+    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => countdown.dec()));\n     req.on('error', common.expectsError({\n       code: 'ERR_HTTP2_STREAM_ERROR',"
        },
        {
            "sha": "21fcf790b449eb435d0ec80a446c0bd12ab849ac",
            "filename": "test/parallel/test-http2-respond-file-fd-invalid.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -40,7 +40,7 @@ server.listen(0, () => {\n   req.on('response', common.mustCall());\n   req.on('error', common.mustCall(errorCheck));\n   req.on('data', common.mustNotCall());\n-  req.on('close', common.mustCall(() => {\n+  req.on('end', common.mustCall(() => {\n     assert.strictEqual(req.rstCode, NGHTTP2_INTERNAL_ERROR);\n     client.close();\n     server.close();"
        },
        {
            "sha": "ad9eee0d59fecc94241be0bc0b1fc2740d96e08c",
            "filename": "test/parallel/test-http2-respond-nghttperrors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -87,7 +87,7 @@ function runTest(test) {\n   req.resume();\n   req.end();\n \n-  req.on('close', common.mustCall(() => {\n+  req.on('end', common.mustCall(() => {\n     client.close();\n \n     if (!tests.length) {"
        },
        {
            "sha": "3a671a3e36490aa2ad71f3165cbe99f2fa8ed217",
            "filename": "test/parallel/test-http2-respond-with-fd-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -95,7 +95,7 @@ function runTest(test) {\n   req.resume();\n   req.end();\n \n-  req.on('close', common.mustCall(() => {\n+  req.on('end', common.mustCall(() => {\n     client.close();\n \n     if (!tests.length) {"
        },
        {
            "sha": "33f224fc69a9d5d67b0e2e0793e09197961727c4",
            "filename": "test/parallel/test-http2-server-shutdown-before-respond.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -32,5 +32,5 @@ server.on('listening', common.mustCall(() => {\n   }));\n   req.resume();\n   req.on('data', common.mustNotCall());\n-  req.on('close', common.mustCall(() => server.close()));\n+  req.on('end', common.mustCall(() => server.close()));\n }));"
        },
        {
            "sha": "03afc1957b8af4f7e862cccf5b5252574ad0a0f4",
            "filename": "test/parallel/test-http2-server-socket-destroy.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-server-socket-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-http2-server-socket-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-socket-destroy.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -52,4 +52,5 @@ server.on('listening', common.mustCall(() => {\n \n   req.on('aborted', common.mustCall());\n   req.resume();\n+  req.on('end', common.mustCall());\n }));"
        },
        {
            "sha": "5a80ce5c3e49893a96554888bfe9e646f366b5cf",
            "filename": "test/parallel/test-stream-duplex-error-write.js",
            "status": "removed",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/5efbe4c1e8f9baf4251c40c52ca9452d8f7416ce/test%2Fparallel%2Ftest-stream-duplex-error-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/5efbe4c1e8f9baf4251c40c52ca9452d8f7416ce/test%2Fparallel%2Ftest-stream-duplex-error-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-duplex-error-write.js?ref=5efbe4c1e8f9baf4251c40c52ca9452d8f7416ce",
            "patch": "@@ -1,24 +0,0 @@\n-'use strict';\n-\n-const common = require('../common');\n-const { Duplex } = require('stream');\n-const { strictEqual } = require('assert');\n-\n-const duplex = new Duplex({\n-  write(chunk, enc, cb) {\n-    cb(new Error('kaboom'));\n-  },\n-  read() {\n-    this.push(null);\n-  }\n-});\n-\n-duplex.on('error', common.mustCall(function() {\n-  strictEqual(this._readableState.errorEmitted, true);\n-  strictEqual(this._writableState.errorEmitted, true);\n-}));\n-\n-duplex.on('end', common.mustNotCall());\n-\n-duplex.end('hello');\n-duplex.resume();"
        },
        {
            "sha": "026aa8ca1603b85fd2593ca43079b4367a9430eb",
            "filename": "test/parallel/test-stream-readable-destroy.js",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f6ab9f799925da836b6c106ed9a8b3d95a2935f/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-destroy.js?ref=8f6ab9f799925da836b6c106ed9a8b3d95a2935f",
            "patch": "@@ -189,18 +189,3 @@ const { inherits } = require('util');\n   read.push('hi');\n   read.on('data', common.mustNotCall());\n }\n-\n-{\n-  // double error case\n-  const read = new Readable({\n-    read() {}\n-  });\n-\n-  read.on('close', common.mustCall());\n-  read.on('error', common.mustCall());\n-\n-  read.destroy(new Error('kaboom 1'));\n-  read.destroy(new Error('kaboom 2'));\n-  assert.strictEqual(read._readableState.errorEmitted, true);\n-  assert.strictEqual(read.destroyed, true);\n-}"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 20,
        "deletions": 76
    }
}