{
    "author": "MylesBorins",
    "message": "deps: patch V8 to 6.6.346.27\n\nPR-URL: https://github.com/nodejs/node/pull/20480\nRefs: https://github.com/v8/v8/compare/6.6.346.24...6.6.346.27\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
    "files": [
        {
            "sha": "81f014cbd4b68d61a96c97ceb6d88d823648d568",
            "filename": "deps/v8/include/v8-version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Finclude%2Fv8-version.h",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Finclude%2Fv8-version.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-version.h?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -11,7 +11,7 @@\n #define V8_MAJOR_VERSION 6\n #define V8_MINOR_VERSION 6\n #define V8_BUILD_NUMBER 346\n-#define V8_PATCH_LEVEL 24\n+#define V8_PATCH_LEVEL 27\n \n // Use 1 for candidates and 0 otherwise.\n // (Boolean macro values are not supported by all preprocessors.)"
        },
        {
            "sha": "638c83f4270b959ecd6355d8398230da7009b43b",
            "filename": "deps/v8/src/keys.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Fsrc%2Fkeys.cc",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Fsrc%2Fkeys.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fkeys.cc?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -77,7 +77,14 @@ void KeyAccumulator::AddKey(Handle<Object> key, AddKeyConversion convert) {\n       Handle<String>::cast(key)->AsArrayIndex(&index)) {\n     key = isolate_->factory()->NewNumberFromUint(index);\n   }\n-  keys_ = OrderedHashSet::Add(keys(), key);\n+  Handle<OrderedHashSet> new_set = OrderedHashSet::Add(keys(), key);\n+  if (*new_set != *keys_) {\n+    // The keys_ Set is converted directly to a FixedArray in GetKeys which can\n+    // be left-trimmer. Hence the previous Set should not keep a pointer to the\n+    // new one.\n+    keys_->set(OrderedHashTableBase::kNextTableIndex, Smi::kZero);\n+    keys_ = new_set;\n+  }\n }\n \n void KeyAccumulator::AddKeys(Handle<FixedArray> array,"
        },
        {
            "sha": "915d4d9ead6b1f92c68e44cd99bdcac2ef09fc8a",
            "filename": "deps/v8/src/wasm/wasm-js.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 44,
            "changes": 87,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-js.cc",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-js.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-js.cc?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -330,42 +330,30 @@ MaybeLocal<Value> WebAssemblyInstantiateImpl(Isolate* isolate,\n   i::MaybeHandle<i::Object> instance_object;\n   {\n     ScheduledErrorThrower thrower(i_isolate, \"WebAssembly Instantiation\");\n+\n+    // TODO(ahaas): These checks on the module should not be necessary here They\n+    // are just a workaround for https://crbug.com/837417.\n+    i::Handle<i::Object> module_obj = Utils::OpenHandle(*module);\n+    if (!module_obj->IsWasmModuleObject()) {\n+      thrower.TypeError(\"Argument 0 must be a WebAssembly.Module object\");\n+      return {};\n+    }\n+\n     i::MaybeHandle<i::JSReceiver> maybe_imports =\n         GetValueAsImports(ffi, &thrower);\n     if (thrower.error()) return {};\n \n-    i::Handle<i::WasmModuleObject> module_obj =\n-        i::Handle<i::WasmModuleObject>::cast(\n-            Utils::OpenHandle(Object::Cast(*module)));\n     instance_object = i_isolate->wasm_engine()->SyncInstantiate(\n-        i_isolate, &thrower, module_obj, maybe_imports,\n-        i::MaybeHandle<i::JSArrayBuffer>());\n+        i_isolate, &thrower, i::Handle<i::WasmModuleObject>::cast(module_obj),\n+        maybe_imports, i::MaybeHandle<i::JSArrayBuffer>());\n   }\n \n   DCHECK_EQ(instance_object.is_null(), i_isolate->has_scheduled_exception());\n   if (instance_object.is_null()) return {};\n   return Utils::ToLocal(instance_object.ToHandleChecked());\n }\n \n-// Entered as internal implementation detail of sync and async instantiate.\n-// args[0] *must* be a WebAssembly.Module.\n-void WebAssemblyInstantiateImplCallback(\n-    const v8::FunctionCallbackInfo<v8::Value>& args) {\n-  DCHECK_GE(args.Length(), 1);\n-  v8::Isolate* isolate = args.GetIsolate();\n-  MicrotasksScope does_not_run_microtasks(isolate,\n-                                          MicrotasksScope::kDoNotRunMicrotasks);\n-\n-  HandleScope scope(args.GetIsolate());\n-  Local<Value> module = args[0];\n-  Local<Value> ffi = args.Data();\n-  Local<Value> instance;\n-  if (WebAssemblyInstantiateImpl(isolate, module, ffi).ToLocal(&instance)) {\n-    args.GetReturnValue().Set(instance);\n-  }\n-}\n-\n-void WebAssemblyInstantiateToPairCallback(\n+void WebAssemblyInstantiateCallback(\n     const v8::FunctionCallbackInfo<v8::Value>& args) {\n   DCHECK_GE(args.Length(), 1);\n   Isolate* isolate = args.GetIsolate();\n@@ -454,7 +442,7 @@ void WebAssemblyInstantiateStreaming(\n   DCHECK(!module_promise.IsEmpty());\n   Local<Value> data = args[1];\n   ASSIGN(Function, instantiate_impl,\n-         Function::New(context, WebAssemblyInstantiateToPairCallback, data));\n+         Function::New(context, WebAssemblyInstantiateCallback, data));\n   ASSIGN(Promise, result, module_promise->Then(context, instantiate_impl));\n   args.GetReturnValue().Set(result);\n }\n@@ -476,10 +464,12 @@ void WebAssemblyInstantiate(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   Local<Context> context = isolate->GetCurrentContext();\n \n   ASSIGN(Promise::Resolver, resolver, Promise::Resolver::New(context));\n-  Local<Promise> module_promise = resolver->GetPromise();\n-  args.GetReturnValue().Set(module_promise);\n+  Local<Promise> promise = resolver->GetPromise();\n+  args.GetReturnValue().Set(promise);\n \n   Local<Value> first_arg_value = args[0];\n+  // If args.Length < 2, this will be undefined - see FunctionCallbackInfo.\n+  Local<Value> ffi = args[1];\n   i::Handle<i::Object> first_arg = Utils::OpenHandle(*first_arg_value);\n   if (!first_arg->IsJSObject()) {\n     thrower.TypeError(\n@@ -490,26 +480,35 @@ void WebAssemblyInstantiate(const v8::FunctionCallbackInfo<v8::Value>& args) {\n     return;\n   }\n \n-  FunctionCallback instantiator = nullptr;\n   if (first_arg->IsWasmModuleObject()) {\n-    module_promise = resolver->GetPromise();\n-    if (!resolver->Resolve(context, first_arg_value).IsJust()) return;\n-    instantiator = WebAssemblyInstantiateImplCallback;\n-  } else {\n-    ASSIGN(Function, async_compile, Function::New(context, WebAssemblyCompile));\n-    ASSIGN(Value, async_compile_retval,\n-           async_compile->Call(context, args.Holder(), 1, &first_arg_value));\n-    module_promise = Local<Promise>::Cast(async_compile_retval);\n-    instantiator = WebAssemblyInstantiateToPairCallback;\n+    i::Handle<i::WasmModuleObject> module_obj =\n+        i::Handle<i::WasmModuleObject>::cast(first_arg);\n+    // If args.Length < 2, this will be undefined - see FunctionCallbackInfo.\n+    i::MaybeHandle<i::JSReceiver> maybe_imports =\n+        GetValueAsImports(ffi, &thrower);\n+\n+    if (thrower.error()) {\n+      auto maybe = resolver->Reject(context, Utils::ToLocal(thrower.Reify()));\n+      CHECK_IMPLIES(!maybe.FromMaybe(false),\n+                    i_isolate->has_scheduled_exception());\n+      return;\n+    }\n+\n+    i_isolate->wasm_engine()->AsyncInstantiate(\n+        i_isolate, Utils::OpenHandle(*promise), module_obj, maybe_imports);\n+    return;\n   }\n-  DCHECK(!module_promise.IsEmpty());\n-  DCHECK_NOT_NULL(instantiator);\n-  // If args.Length < 2, this will be undefined - see FunctionCallbackInfo.\n-  // We'll check for that in WebAssemblyInstantiateImpl.\n-  Local<Value> data = args[1];\n+\n+  // We did not get a WasmModuleObject as input, we first have to compile the\n+  // input.\n+  ASSIGN(Function, async_compile, Function::New(context, WebAssemblyCompile));\n+  ASSIGN(Value, async_compile_retval,\n+         async_compile->Call(context, args.Holder(), 1, &first_arg_value));\n+  promise = Local<Promise>::Cast(async_compile_retval);\n+  DCHECK(!promise.IsEmpty());\n   ASSIGN(Function, instantiate_impl,\n-         Function::New(context, instantiator, data));\n-  ASSIGN(Promise, result, module_promise->Then(context, instantiate_impl));\n+         Function::New(context, WebAssemblyInstantiateCallback, ffi));\n+  ASSIGN(Promise, result, promise->Then(context, instantiate_impl));\n   args.GetReturnValue().Set(result);\n }\n "
        },
        {
            "sha": "c4833232c4edfdbcc39432ac8467fa89e3db108d",
            "filename": "deps/v8/test/mjsunit/regress/regress-crbug-831984.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-crbug-831984.js",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-crbug-831984.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-crbug-831984.js?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -0,0 +1,10 @@\n+// Copyright 2018 the V8 project authors. All rights reserved.\n+// Use of this source code is governed by a BSD-style license that can be\n+// found in the LICENSE file.\n+\n+\n+let arr = [...Array(9000)];\n+for (let j = 0; j < 40; j++) {\n+  Reflect.ownKeys(arr).shift();\n+  Array(64386);\n+}"
        },
        {
            "sha": "b37dbea628de37f03e4b9e8659d7a38b422c5204",
            "filename": "deps/v8/test/mjsunit/regress/wasm/regress-836141.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-836141.js",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-836141.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-836141.js?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2018 the V8 project authors. All rights reserved.\n+// Use of this source code is governed by a BSD-style license that can be\n+// found in the LICENSE file.\n+\n+load('test/mjsunit/wasm/wasm-constants.js');\n+load('test/mjsunit/wasm/wasm-module-builder.js');\n+\n+const builder = new WasmModuleBuilder();\n+builder.addMemory(16, 32);\n+builder.addFunction(\"test\", kSig_i_v).addBody([\n+  kExprI32Const, 12,         // i32.const 0\n+]);\n+\n+let module = new WebAssembly.Module(builder.toBuffer());\n+module.then = () => {\n+  // Use setTimeout to get out of the promise chain.\n+  setTimeout(assertUnreachable);\n+};\n+\n+WebAssembly.instantiate(module);"
        },
        {
            "sha": "572139fac55825aa33c632e4d9291f90b1157202",
            "filename": "deps/v8/test/mjsunit/regress/wasm/regress-837417.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-837417.js",
            "raw_url": "https://github.com/nodejs/node/raw/17cb5ad2d238b0cef21c0b16ad42acf9be7524ba/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-837417.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fwasm%2Fregress-837417.js?ref=17cb5ad2d238b0cef21c0b16ad42acf9be7524ba",
            "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2018 the V8 project authors. All rights reserved.\n+// Use of this source code is governed by a BSD-style license that can be\n+// found in the LICENSE file.\n+\n+load('test/mjsunit/wasm/wasm-constants.js');\n+load('test/mjsunit/wasm/wasm-module-builder.js');\n+\n+const builder = new WasmModuleBuilder();\n+builder.addMemory(16, 32);\n+builder.addFunction(\"test\", kSig_i_v).addBody([\n+  kExprI32Const, 12,         // i32.const 0\n+]);\n+\n+WebAssembly.Module.prototype.then = resolve => resolve(\n+    String.fromCharCode(null, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41));\n+\n+// WebAssembly.instantiate should not actually throw a TypeError in this case.\n+// However, this is a workaround for\n+assertPromiseResult(\n+    WebAssembly.instantiate(builder.toBuffer()), assertUnreachable,\n+    exception => {\n+      assertInstanceof(exception, TypeError);\n+    });"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 105,
        "deletions": 46
    }
}