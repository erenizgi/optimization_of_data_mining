{
    "author": "unknown",
    "message": "n-api: back up env before finalize\n\nHeed the comment to not use fields of a Reference after calling its\nfinalize callback, because such a call may destroy the Reference.\n\nFixes: https://github.com/nodejs/node/issues/19673\nPR-URL: https://github.com/nodejs/node/pull/19718\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "1a5a19d6d475578eec355a8b3079b4a96fc77489",
    "files": [
        {
            "sha": "73c2e60d2926b2a5dfe3b1e0bb28773ef9ce9f7a",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1a5a19d6d475578eec355a8b3079b4a96fc77489/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1a5a19d6d475578eec355a8b3079b4a96fc77489/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=1a5a19d6d475578eec355a8b3079b4a96fc77489",
            "patch": "@@ -457,9 +457,10 @@ class Reference : private Finalizer {\n     // Check before calling the finalize callback, because the callback might\n     // delete it.\n     bool delete_self = reference->_delete_self;\n+    napi_env env = reference->_env;\n \n     if (reference->_finalize_callback != nullptr) {\n-      NAPI_CALL_INTO_MODULE_THROW(reference->_env,\n+      NAPI_CALL_INTO_MODULE_THROW(env,\n         reference->_finalize_callback(\n             reference->_env,\n             reference->_finalize_data,"
        },
        {
            "sha": "48e94f10ec48380e7f9480ef1ffaed3afbd29c61",
            "filename": "test/addons-napi/8_passing_wrapped/binding.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F8_passing_wrapped%2Fbinding.cc?ref=1a5a19d6d475578eec355a8b3079b4a96fc77489",
            "patch": "@@ -1,7 +1,9 @@\n #include \"myobject.h\"\n #include \"../common.h\"\n \n-napi_value CreateObject(napi_env env, napi_callback_info info) {\n+extern size_t finalize_count;\n+\n+static napi_value CreateObject(napi_env env, napi_callback_info info) {\n   size_t argc = 1;\n   napi_value args[1];\n   NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, nullptr, nullptr));\n@@ -12,7 +14,7 @@ napi_value CreateObject(napi_env env, napi_callback_info info) {\n   return instance;\n }\n \n-napi_value Add(napi_env env, napi_callback_info info) {\n+static napi_value Add(napi_env env, napi_callback_info info) {\n   size_t argc = 2;\n   napi_value args[2];\n   NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, nullptr, nullptr));\n@@ -29,12 +31,19 @@ napi_value Add(napi_env env, napi_callback_info info) {\n   return sum;\n }\n \n-napi_value Init(napi_env env, napi_value exports) {\n+static napi_value FinalizeCount(napi_env env, napi_callback_info info) {\n+  napi_value return_value;\n+  NAPI_CALL(env, napi_create_uint32(env, finalize_count, &return_value));\n+  return return_value;\n+}\n+\n+static napi_value Init(napi_env env, napi_value exports) {\n   MyObject::Init(env);\n \n   napi_property_descriptor desc[] = {\n     DECLARE_NAPI_PROPERTY(\"createObject\", CreateObject),\n     DECLARE_NAPI_PROPERTY(\"add\", Add),\n+    DECLARE_NAPI_PROPERTY(\"finalizeCount\", FinalizeCount),\n   };\n \n   NAPI_CALL(env,"
        },
        {
            "sha": "0c9ca90f52f8f3d33d523f68436870f0738b7c3a",
            "filename": "test/addons-napi/8_passing_wrapped/myobject.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Fmyobject.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Fmyobject.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F8_passing_wrapped%2Fmyobject.cc?ref=1a5a19d6d475578eec355a8b3079b4a96fc77489",
            "patch": "@@ -1,9 +1,14 @@\n #include \"myobject.h\"\n #include \"../common.h\"\n \n+size_t finalize_count = 0;\n+\n MyObject::MyObject() : env_(nullptr), wrapper_(nullptr) {}\n \n-MyObject::~MyObject() { napi_delete_reference(env_, wrapper_); }\n+MyObject::~MyObject() {\n+  finalize_count++;\n+  napi_delete_reference(env_, wrapper_);\n+}\n \n void MyObject::Destructor(\n   napi_env env, void* nativeObject, void* /*finalize_hint*/) {\n@@ -45,6 +50,11 @@ napi_value MyObject::New(napi_env env, napi_callback_info info) {\n   }\n \n   obj->env_ = env;\n+\n+  // It is important that the below call to napi_wrap() be such that we request\n+  // a reference to the wrapped object via the out-parameter, because this\n+  // ensures that we test the code path that deals with a reference that is\n+  // destroyed from its own finalizer.\n   NAPI_CALL(env, napi_wrap(env,\n                           _this,\n                           obj,"
        },
        {
            "sha": "7793133f7750ba63d32848ca079828da6d54d33b",
            "filename": "test/addons-napi/8_passing_wrapped/test.js",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/1a5a19d6d475578eec355a8b3079b4a96fc77489/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js?ref=1a5a19d6d475578eec355a8b3079b4a96fc77489",
            "patch": "@@ -1,9 +1,16 @@\n 'use strict';\n+// Flags: --expose-gc\n+\n const common = require('../../common');\n const assert = require('assert');\n const addon = require(`./build/${common.buildType}/binding`);\n \n-const obj1 = addon.createObject(10);\n+let obj1 = addon.createObject(10);\n const obj2 = addon.createObject(20);\n const result = addon.add(obj1, obj2);\n assert.strictEqual(result, 30);\n+\n+// Make sure the native destructor gets called.\n+obj1 = null;\n+global.gc();\n+assert.strictEqual(addon.finalizeCount(), 1);"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 33,
        "deletions": 6
    }
}