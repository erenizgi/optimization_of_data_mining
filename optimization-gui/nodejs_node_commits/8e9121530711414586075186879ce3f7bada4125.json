{
    "author": "ofrobots",
    "message": "test: add test to dynamic enablement of trace-events\n\nPR-URL: https://github.com/nodejs/node/pull/22114\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "8e9121530711414586075186879ce3f7bada4125",
    "files": [
        {
            "sha": "a32949f8ec599425bf52f85f2273c7d36e2812ff",
            "filename": "test/parallel/test-trace-events-dynamic-enable.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/8e9121530711414586075186879ce3f7bada4125/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js",
            "raw_url": "https://github.com/nodejs/node/raw/8e9121530711414586075186879ce3f7bada4125/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js?ref=8e9121530711414586075186879ce3f7bada4125",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+common.skipIfInspectorDisabled();\n+\n+const assert = require('assert');\n+const { performance } = require('perf_hooks');\n+const { Session } = require('inspector');\n+\n+const session = new Session();\n+\n+function post(message, data) {\n+  return new Promise((resolve, reject) => {\n+    session.post(message, data, (err, result) => {\n+      if (err)\n+        reject(new Error(JSON.stringify(err)));\n+      else\n+        resolve(result);\n+    });\n+  });\n+}\n+\n+async function test() {\n+  session.connect();\n+\n+  let traceNotification = null;\n+  let tracingComplete = false;\n+  session.on('NodeTracing.dataCollected', (n) => traceNotification = n);\n+  session.on('NodeTracing.tracingComplete', () => tracingComplete = true);\n+\n+  // Generate a node.perf event before tracing is enabled.\n+  performance.mark('mark1');\n+\n+  const traceConfig = { includedCategories: ['node.perf'] };\n+  await post('NodeTracing.start', { traceConfig });\n+\n+  // Generate a node.perf event after tracing is enabled. This should be the\n+  // mark event captured.\n+  performance.mark('mark2');\n+\n+  await post('NodeTracing.stop', { traceConfig });\n+\n+  performance.mark('mark3');\n+\n+  session.disconnect();\n+\n+  assert.ok(tracingComplete);\n+  assert.ok(traceNotification);\n+  assert.ok(traceNotification.data && traceNotification.data.value);\n+\n+  const events = traceNotification.data.value;\n+  const marks = events.filter((t) => null !== /node\\.perf\\.usertim/.exec(t.cat));\n+  assert.strictEqual(marks.length, 1);\n+  assert.strictEqual(marks[0].name, 'mark2');\n+}\n+\n+test();"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 58,
        "deletions": 0
    }
}