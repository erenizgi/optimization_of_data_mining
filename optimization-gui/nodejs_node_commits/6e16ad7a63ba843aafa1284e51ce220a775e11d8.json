{
    "author": "addaleax",
    "message": "zlib: fix memory leak for unused zlib instances\n\nAn oversight in an earlier commit led to a memory leak\nin the untypical situation that zlib instances are created\nbut never used, because zlib handles no longer started\nout their life as weak handles.\n\nThe bug was introduced in bd201102862a194f3f5ce669e0a3c8143eafc900.\n\nRefs: https://github.com/nodejs/node/pull/20455\n\nPR-URL: https://github.com/nodejs/node/pull/21607\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "6e16ad7a63ba843aafa1284e51ce220a775e11d8",
    "files": [
        {
            "sha": "8e30241f4e6d4508c8f2369436800c29c3056a31",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/6e16ad7a63ba843aafa1284e51ce220a775e11d8/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6e16ad7a63ba843aafa1284e51ce220a775e11d8/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=6e16ad7a63ba843aafa1284e51ce220a775e11d8",
            "patch": "@@ -90,6 +90,7 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n         refs_(0),\n         gzip_id_bytes_read_(0),\n         write_result_(nullptr) {\n+    MakeWeak();\n   }\n \n "
        },
        {
            "sha": "7a5a6728533e18ffd1b509bb000f48aeaed91620",
            "filename": "test/parallel/test-zlib-unused-weak.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/6e16ad7a63ba843aafa1284e51ce220a775e11d8/test%2Fparallel%2Ftest-zlib-unused-weak.js",
            "raw_url": "https://github.com/nodejs/node/raw/6e16ad7a63ba843aafa1284e51ce220a775e11d8/test%2Fparallel%2Ftest-zlib-unused-weak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-unused-weak.js?ref=6e16ad7a63ba843aafa1284e51ce220a775e11d8",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+// Flags: --expose-gc\n+require('../common');\n+const assert = require('assert');\n+const zlib = require('zlib');\n+\n+// Tests that native zlib handles start out their life as weak handles.\n+\n+const before = process.memoryUsage().external;\n+for (let i = 0; i < 100; ++i)\n+  zlib.createGzip();\n+const afterCreation = process.memoryUsage().external;\n+global.gc();\n+const afterGC = process.memoryUsage().external;\n+\n+assert((afterGC - before) / (afterCreation - before) <= 0.05,\n+       `Expected after-GC delta ${afterGC - before} to be less than 5 %` +\n+       ` of before-GC delta ${afterCreation - before}`);"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}