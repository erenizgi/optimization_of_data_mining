{
    "author": "unknown",
    "message": "inspector: report client-visible host and port\n\nNode instance may not know the real host and port user sees when\ndebug frontend connects through the SSH tunnel. This change fixes\n'/json/list' response by using the value client provided in the host\nheader.\n\nPR-URL: https://github.com/nodejs/node/pull/19664\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
    "files": [
        {
            "sha": "fa46c45decdd8cfb7d80b2615c03500dcb424c5c",
            "filename": "src/inspector_socket.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket.cc?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -495,12 +495,12 @@ class HttpHandler : public ProtocolHandler {\n         CancelHandshake();\n         return;\n       } else if (!event.upgrade) {\n-        delegate()->OnHttpGet(event.path);\n+        delegate()->OnHttpGet(event.host, event.path);\n       } else if (event.ws_key.empty()) {\n         CancelHandshake();\n         return;\n       } else {\n-        delegate()->OnSocketUpgrade(event.path, event.ws_key);\n+        delegate()->OnSocketUpgrade(event.host, event.path, event.ws_key);\n       }\n     }\n   }"
        },
        {
            "sha": "81b894f95cb88fa41805ebfc95f374a1dc0bef9e",
            "filename": "src/inspector_socket.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket.h",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket.h?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -17,8 +17,10 @@ class InspectorSocket {\n  public:\n   class Delegate {\n    public:\n-    virtual void OnHttpGet(const std::string& path) = 0;\n-    virtual void OnSocketUpgrade(const std::string& path,\n+    virtual void OnHttpGet(const std::string& host,\n+                           const std::string& path) = 0;\n+    virtual void OnSocketUpgrade(const std::string& host,\n+                                 const std::string& path,\n                                  const std::string& accept_key) = 0;\n     virtual void OnWsFrame(const std::vector<char>& frame) = 0;\n     virtual ~Delegate() {}"
        },
        {
            "sha": "edea483cfe0e640c5c6a7c512b950767a6c86431",
            "filename": "src/inspector_socket_server.cc",
            "status": "modified",
            "additions": 45,
            "deletions": 30,
            "changes": 75,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket_server.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket_server.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket_server.cc?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -16,33 +16,42 @@ namespace inspector {\n // depend on inspector_socket_server.h\n std::string FormatWsAddress(const std::string& host, int port,\n                             const std::string& target_id,\n-                            bool include_protocol) {\n+                            bool include_protocol);\n+namespace {\n+\n+static const uint8_t PROTOCOL_JSON[] = {\n+  #include \"v8_inspector_protocol_json.h\"  // NOLINT(build/include_order)\n+};\n+\n+void Escape(std::string* string) {\n+  for (char& c : *string) {\n+    c = (c == '\\\"' || c == '\\\\') ? '_' : c;\n+  }\n+}\n+\n+std::string FormatHostPort(const std::string& host, int port) {\n   // Host is valid (socket was bound) so colon means it's a v6 IP address\n   bool v6 = host.find(':') != std::string::npos;\n   std::ostringstream url;\n-  if (include_protocol)\n-    url << \"ws://\";\n   if (v6) {\n     url << '[';\n   }\n   url << host;\n   if (v6) {\n     url << ']';\n   }\n-  url << ':' << port << '/' << target_id;\n+  url << ':' << port;\n   return url.str();\n }\n \n-namespace {\n-\n-static const uint8_t PROTOCOL_JSON[] = {\n-  #include \"v8_inspector_protocol_json.h\"  // NOLINT(build/include_order)\n-};\n-\n-void Escape(std::string* string) {\n-  for (char& c : *string) {\n-    c = (c == '\\\"' || c == '\\\\') ? '_' : c;\n-  }\n+std::string FormatAddress(const std::string& host,\n+                          const std::string& target_id,\n+                          bool include_protocol) {\n+  std::ostringstream url;\n+  if (include_protocol)\n+    url << \"ws://\";\n+  url << host << '/' << target_id;\n+  return url.str();\n }\n \n std::string MapToString(const std::map<std::string, std::string>& object) {\n@@ -141,6 +150,11 @@ void SendProtocolJson(InspectorSocket* socket) {\n }\n }  // namespace\n \n+std::string FormatWsAddress(const std::string& host, int port,\n+                            const std::string& target_id,\n+                            bool include_protocol) {\n+  return FormatAddress(FormatHostPort(host, port), target_id, include_protocol);\n+}\n \n class Closer {\n  public:\n@@ -213,8 +227,8 @@ class SocketSession {\n     ~Delegate() {\n       server_->SessionTerminated(session_id_);\n     }\n-    void OnHttpGet(const std::string& path) override;\n-    void OnSocketUpgrade(const std::string& path,\n+    void OnHttpGet(const std::string& host, const std::string& path) override;\n+    void OnSocketUpgrade(const std::string& host, const std::string& path,\n                          const std::string& ws_key) override;\n     void OnWsFrame(const std::vector<char>& data) override;\n \n@@ -320,6 +334,7 @@ void InspectorSocketServer::SessionTerminated(int session_id) {\n }\n \n bool InspectorSocketServer::HandleGetRequest(int session_id,\n+                                             const std::string& host,\n                                              const std::string& path) {\n   SocketSession* session = Session(session_id);\n   InspectorSocket* socket = session->ws_socket();\n@@ -328,25 +343,20 @@ bool InspectorSocketServer::HandleGetRequest(int session_id,\n     return false;\n \n   if (MatchPathSegment(command, \"list\") || command[0] == '\\0') {\n-    SendListResponse(socket, session);\n+    SendListResponse(socket, host, session);\n     return true;\n   } else if (MatchPathSegment(command, \"protocol\")) {\n     SendProtocolJson(socket);\n     return true;\n   } else if (MatchPathSegment(command, \"version\")) {\n     SendVersionResponse(socket);\n     return true;\n-  } else if (const char* target_id = MatchPathSegment(command, \"activate\")) {\n-    if (TargetExists(target_id)) {\n-      SendHttpResponse(socket, \"Target activated\");\n-      return true;\n-    }\n-    return false;\n   }\n   return false;\n }\n \n void InspectorSocketServer::SendListResponse(InspectorSocket* socket,\n+                                             const std::string& host,\n                                              SocketSession* session) {\n   std::vector<std::map<std::string, std::string>> response;\n   for (const std::string& id : delegate_->GetTargetIds()) {\n@@ -371,15 +381,18 @@ void InspectorSocketServer::SendListResponse(InspectorSocket* socket,\n       }\n     }\n     if (!connected) {\n-      std::string host = socket->GetHost();\n-      int port = session->server_port();\n+      std::string detected_host = host;\n+      if (detected_host.empty()) {\n+        detected_host = FormatHostPort(socket->GetHost(),\n+                                       session->server_port());\n+      }\n       std::ostringstream frontend_url;\n       frontend_url << \"chrome-devtools://devtools/bundled\";\n       frontend_url << \"/inspector.html?experiments=true&v8only=true&ws=\";\n-      frontend_url << FormatWsAddress(host, port, id, false);\n+      frontend_url << FormatAddress(detected_host, id, false);\n       target_map[\"devtoolsFrontendUrl\"] += frontend_url.str();\n       target_map[\"webSocketDebuggerUrl\"] =\n-          FormatWsAddress(host, port, id, true);\n+          FormatAddress(detected_host, id, true);\n     }\n   }\n   SendHttpResponse(socket, MapsToString(response));\n@@ -531,12 +544,14 @@ void SocketSession::Send(const std::string& message) {\n   ws_socket_->Write(message.data(), message.length());\n }\n \n-void SocketSession::Delegate::OnHttpGet(const std::string& path) {\n-  if (!server_->HandleGetRequest(session_id_, path))\n+void SocketSession::Delegate::OnHttpGet(const std::string& host,\n+                                        const std::string& path) {\n+  if (!server_->HandleGetRequest(session_id_, host, path))\n     Session()->ws_socket()->CancelHandshake();\n }\n \n-void SocketSession::Delegate::OnSocketUpgrade(const std::string& path,\n+void SocketSession::Delegate::OnSocketUpgrade(const std::string& host,\n+                                              const std::string& path,\n                                               const std::string& ws_key) {\n   std::string id = path.empty() ? path : path.substr(1);\n   server_->SessionStarted(session_id_, id, ws_key);"
        },
        {
            "sha": "f6003c4c4b4d70f1483b23f90155ed3a930b7247",
            "filename": "src/inspector_socket_server.h",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket_server.h",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/src%2Finspector_socket_server.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket_server.h?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -67,7 +67,8 @@ class InspectorSocketServer {\n \n   // Session connection lifecycle\n   void Accept(int server_port, uv_stream_t* server_socket);\n-  bool HandleGetRequest(int session_id, const std::string& path);\n+  bool HandleGetRequest(int session_id, const std::string& host,\n+                        const std::string& path);\n   void SessionStarted(int session_id, const std::string& target_id,\n                       const std::string& ws_id);\n   void SessionTerminated(int session_id);\n@@ -77,7 +78,8 @@ class InspectorSocketServer {\n   SocketSession* Session(int session_id);\n \n  private:\n-  void SendListResponse(InspectorSocket* socket, SocketSession* session);\n+  void SendListResponse(InspectorSocket* socket, const std::string& host,\n+                        SocketSession* session);\n   bool TargetExists(const std::string& id);\n \n   enum class ServerState {kNew, kRunning, kStopping, kStopped};"
        },
        {
            "sha": "b96489db1f49d3b7f0fb8933ef79b195219223ef",
            "filename": "test/cctest/test_inspector_socket.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fcctest%2Ftest_inspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fcctest%2Ftest_inspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_inspector_socket.cc?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -112,11 +112,11 @@ class TestInspectorDelegate : public InspectorSocket::Delegate {\n     delegate = nullptr;\n   }\n \n-  void OnHttpGet(const std::string& path) override {\n+  void OnHttpGet(const std::string& host, const std::string& path) override {\n     process(kInspectorHandshakeHttpGet, path);\n   }\n \n-  void OnSocketUpgrade(const std::string& path,\n+  void OnSocketUpgrade(const std::string& host, const std::string& path,\n                        const std::string& ws_key) override {\n     ws_key_ = ws_key;\n     process(kInspectorHandshakeUpgraded, path);"
        },
        {
            "sha": "1bc16e3714cffadc124c312be5ab54928617350a",
            "filename": "test/common/inspector-helper.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fcommon%2Finspector-helper.js",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fcommon%2Finspector-helper.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Finspector-helper.js?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -365,10 +365,11 @@ class NodeInstance {\n     }\n   }\n \n-  httpGet(host, path) {\n+  httpGet(host, path, hostHeaderValue) {\n     console.log('[test]', `Testing ${path}`);\n+    const headers = hostHeaderValue ? { 'Host': hostHeaderValue } : null;\n     return this.portPromise.then((port) => new Promise((resolve, reject) => {\n-      const req = http.get({ host, port, path }, (res) => {\n+      const req = http.get({ host, port, path, headers }, (res) => {\n         let response = '';\n         res.setEncoding('utf8');\n         res"
        },
        {
            "sha": "f54ea16625d218cbf3504dca4bc8e7000552c0a4",
            "filename": "test/parallel/test-inspector-reported-host.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fparallel%2Ftest-inspector-reported-host.js",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fparallel%2Ftest-inspector-reported-host.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspector-reported-host.js?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -0,0 +1,22 @@\n+// Flags: --expose-internals\n+'use strict';\n+const common = require('../common');\n+\n+common.skipIfInspectorDisabled();\n+\n+const assert = require('assert');\n+const { NodeInstance } = require('../common/inspector-helper.js');\n+\n+common.crashOnUnhandledRejection();\n+\n+async function test() {\n+  const madeUpHost = '111.111.111.111:11111';\n+  const child = new NodeInstance(undefined, 'var a = 1');\n+  const response = await child.httpGet(null, '/json', madeUpHost);\n+  assert.ok(\n+    response[0].webSocketDebuggerUrl.startsWith(`ws://${madeUpHost}`),\n+    response[0].webSocketDebuggerUrl);\n+  child.kill();\n+}\n+\n+test();"
        },
        {
            "sha": "4e0315807b628aff5ece36be658b3dbeec56a82f",
            "filename": "test/sequential/test-inspector.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fsequential%2Ftest-inspector.js",
            "raw_url": "https://github.com/nodejs/node/raw/a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b/test%2Fsequential%2Ftest-inspector.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector.js?ref=a9a1f12b4212c0ea81a04bf2eb56efe6f8a4699b",
            "patch": "@@ -11,8 +11,9 @@ function checkListResponse(response) {\n   assert.strictEqual(1, response.length);\n   assert.ok(response[0].devtoolsFrontendUrl);\n   assert.ok(\n-    /ws:\\/\\/127\\.0\\.0\\.1:\\d+\\/[0-9A-Fa-f]{8}-/\n-      .test(response[0].webSocketDebuggerUrl));\n+    /ws:\\/\\/localhost:\\d+\\/[0-9A-Fa-f]{8}-/\n+      .test(response[0].webSocketDebuggerUrl),\n+    response[0].webSocketDebuggerUrl);\n }\n \n function checkVersion(response) {"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 85,
        "deletions": 42
    }
}