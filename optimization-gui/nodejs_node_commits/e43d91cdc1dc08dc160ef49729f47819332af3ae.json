{
    "author": "joyeecheung",
    "message": "process: split bootstrappers by threads that can run them\n\nThis patch split part of the bootstrappers into three files:\n\n- `lib/internal/process/main_thread_only.js`: contains bootstrappers\n  that can only be run in the main thread, including\n  - `setupStdio` for the main thread that sets up `process.stdin`,\n    `process.stdout`, `process.error` that may interact with external\n    resources, e.g. TTY/File/Pipe/TCP sockets\n  - `setupProcessMethods` that setup methods changing process-global\n    states, e.g. `process.chdir`, `process.umask`, `process.setuid`\n  - `setupSignalHandlers`\n  - `setupChildProcessIpcChannel` that setup `process.send` for\n    child processes.\n- `lib/internal/process/worker_thread_only.js`: contains bootstrappers\n  that can only be run in the worker threads, including\n  - `setupStdio` for the worker thread that are streams to be\n    manipulated or piped to the parent thread\n- `lib/internal/process/per_thread.js`: contains bootstrappers\n    that can be run in all threads, including:\n  - `setupAssert` for `process.assert`\n  - `setupCpuUsage` for `process.cpuUsage`\n  - `setupHrtime` for `process.hrtime` and `process.hrtime.bigint`\n  - `setupMemoryUsage` for `process.memoryUsage`\n  - `setupConfig` for `process.config`\n  - `setupKillAndExit` for `process.kill` and `process.exit`\n  - `setupRawDebug` for `process._rawDebug`\n  - `setupUncaughtExceptionCapture` for\n    `process.setUncaughtExceptionCaptureCallback` and\n    `process.hasUncaughtExceptionCaptureCallback`\n\nHopefully in the future we can sort more bootstrappers in\n`boostrap/node.js` into these three files and further group\nthem into functions that can be run before creating the\nsnapshot / after loading the snapshot.\n\nThis patch also moves most of the `isMainThread` conditionals\ninto the main bootstrapper instead of letting them scattered around\nspecial-casing different implementations.\n\nPR-URL: https://github.com/nodejs/node/pull/21378\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "e43d91cdc1dc08dc160ef49729f47819332af3ae",
    "files": [
        {
            "sha": "2d18b847874321607e1ce8a1ec505e3773e0f783",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 45,
            "deletions": 22,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -44,33 +44,57 @@\n \n     setupGlobalVariables();\n \n-    const _process = NativeModule.require('internal/process');\n-    _process.setupConfig(NativeModule._source);\n-    _process.setupSignalHandlers();\n-    _process.setupUncaughtExceptionCapture(exceptionHandlerState,\n-                                           _shouldAbortOnUncaughtToggle);\n+    // Bootstrappers for all threads, including worker threads and main thread\n+    const perThreadSetup = NativeModule.require('internal/process/per_thread');\n+    // Bootstrappers for the main thread only\n+    let mainThreadSetup;\n+    // Bootstrappers for the worker threads only\n+    let workerThreadSetup;\n+    if (isMainThread) {\n+      mainThreadSetup = NativeModule.require(\n+        'internal/process/main_thread_only'\n+      );\n+    } else {\n+      workerThreadSetup = NativeModule.require(\n+        'internal/process/worker_thread_only'\n+      );\n+    }\n+\n+    perThreadSetup.setupAssert();\n+    perThreadSetup.setupConfig(NativeModule._source);\n+\n+    if (isMainThread) {\n+      mainThreadSetup.setupSignalHandlers();\n+    }\n+\n+    perThreadSetup.setupUncaughtExceptionCapture(exceptionHandlerState,\n+                                                 _shouldAbortOnUncaughtToggle);\n+\n     NativeModule.require('internal/process/warning').setup();\n     NativeModule.require('internal/process/next_tick').setup(_setupNextTick,\n                                                              _setupPromises);\n-    NativeModule.require('internal/process/stdio').setup();\n-    NativeModule.require('internal/process/methods').setup(_chdir,\n-                                                           _umask,\n-                                                           _initgroups,\n-                                                           _setegid,\n-                                                           _seteuid,\n-                                                           _setgid,\n-                                                           _setuid,\n-                                                           _setgroups);\n+\n+    if (isMainThread) {\n+      mainThreadSetup.setupStdio();\n+      mainThreadSetup.setupProcessMethods(\n+        _chdir, _umask, _initgroups, _setegid, _seteuid,\n+        _setgid, _setuid, _setgroups\n+      );\n+    } else {\n+      workerThreadSetup.setupStdio();\n+    }\n \n     const perf = process.binding('performance');\n     const {\n       NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,\n     } = perf.constants;\n \n-    _process.setup_hrtime(_hrtime, _hrtimeBigInt);\n-    _process.setup_cpuUsage(_cpuUsage);\n-    _process.setupMemoryUsage(_memoryUsage);\n-    _process.setupKillAndExit();\n+    perThreadSetup.setupRawDebug(_rawDebug);\n+    perThreadSetup.setupHrtime(_hrtime, _hrtimeBigInt);\n+    perThreadSetup.setupCpuUsage(_cpuUsage);\n+    perThreadSetup.setupMemoryUsage(_memoryUsage);\n+    perThreadSetup.setupKillAndExit();\n+\n     if (global.__coverage__)\n       NativeModule.require('internal/process/write-coverage').setup();\n \n@@ -90,10 +114,9 @@\n       NativeModule.require('internal/inspector_async_hook').setup();\n     }\n \n-    if (isMainThread)\n-      _process.setupChannel();\n-\n-    _process.setupRawDebug(_rawDebug);\n+    if (isMainThread) {\n+      mainThreadSetup.setupChildProcessIpcChannel();\n+    }\n \n     const browserGlobals = !process._noBrowserGlobals;\n     if (browserGlobals) {"
        },
        {
            "sha": "058223cc557eab6a539ab113e5e36132d58700d2",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "renamed",
            "additions": 82,
            "deletions": 11,
            "changes": 93,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -1,24 +1,35 @@\n 'use strict';\n \n+// This file contains process bootstrappers that can only be\n+// run in the main thread\n+\n const {\n-  ERR_INVALID_ARG_TYPE,\n-  ERR_UNKNOWN_CREDENTIAL\n-} = require('internal/errors').codes;\n+  errnoException,\n+  codes: {\n+    ERR_INVALID_ARG_TYPE,\n+    ERR_UNKNOWN_CREDENTIAL\n+  }\n+} = require('internal/errors');\n const {\n   validateMode,\n   validateUint32\n } = require('internal/validators');\n+\n const {\n-  isMainThread\n-} = require('internal/worker');\n+  setupProcessStdio,\n+  getMainThreadStdio\n+} = require('internal/process/stdio');\n+\n+const assert = require('assert').strict;\n+\n+function setupStdio() {\n+  setupProcessStdio(getMainThreadStdio());\n+}\n \n+// Non-POSIX platforms like Windows don't have certain methods.\n+// Workers also lack these methods since they change process-global state.\n function setupProcessMethods(_chdir, _umask, _initgroups, _setegid,\n                              _seteuid, _setgid, _setuid, _setgroups) {\n-  // Non-POSIX platforms like Windows don't have certain methods.\n-  // Workers also lack these methods since they change process-global state.\n-  if (!isMainThread)\n-    return;\n-\n   if (_setgid !== undefined) {\n     setupPosixMethods(_initgroups, _setegid, _seteuid,\n                       _setgid, _setuid, _setgroups);\n@@ -105,4 +116,64 @@ function setupPosixMethods(_initgroups, _setegid, _seteuid,\n   }\n }\n \n-exports.setup = setupProcessMethods;\n+// Worker threads don't receive signals.\n+function setupSignalHandlers() {\n+  const constants = process.binding('constants').os.signals;\n+  const signalWraps = Object.create(null);\n+  let Signal;\n+\n+  function isSignal(event) {\n+    return typeof event === 'string' && constants[event] !== undefined;\n+  }\n+\n+  // Detect presence of a listener for the special signal types\n+  process.on('newListener', function(type) {\n+    if (isSignal(type) && signalWraps[type] === undefined) {\n+      if (Signal === undefined)\n+        Signal = process.binding('signal_wrap').Signal;\n+      const wrap = new Signal();\n+\n+      wrap.unref();\n+\n+      wrap.onsignal = process.emit.bind(process, type, type);\n+\n+      const signum = constants[type];\n+      const err = wrap.start(signum);\n+      if (err) {\n+        wrap.close();\n+        throw errnoException(err, 'uv_signal_start');\n+      }\n+\n+      signalWraps[type] = wrap;\n+    }\n+  });\n+\n+  process.on('removeListener', function(type) {\n+    if (signalWraps[type] !== undefined && this.listenerCount(type) === 0) {\n+      signalWraps[type].close();\n+      delete signalWraps[type];\n+    }\n+  });\n+}\n+\n+function setupChildProcessIpcChannel() {\n+  // If we were spawned with env NODE_CHANNEL_FD then load that up and\n+  // start parsing data from that stream.\n+  if (process.env.NODE_CHANNEL_FD) {\n+    const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n+    assert(fd >= 0);\n+\n+    // Make sure it's not accidentally inherited by child processes.\n+    delete process.env.NODE_CHANNEL_FD;\n+\n+    require('child_process')._forkChild(fd);\n+    assert(process.send);\n+  }\n+}\n+\n+module.exports = {\n+  setupStdio,\n+  setupProcessMethods,\n+  setupSignalHandlers,\n+  setupChildProcessIpcChannel\n+};",
            "previous_filename": "lib/internal/process/methods.js"
        },
        {
            "sha": "6da3bb8aca00f6a45b6ab9faed29626ea95fd20f",
            "filename": "lib/internal/process/per_thread.js",
            "status": "renamed",
            "additions": 17,
            "deletions": 75,
            "changes": 92,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fper_thread.js?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -1,5 +1,9 @@\n 'use strict';\n \n+// This files contains process bootstrappers that can be\n+// run when setting up each thread, including the main\n+// thread and the worker threads.\n+\n const {\n   errnoException,\n   codes: {\n@@ -14,19 +18,19 @@ const {\n } = require('internal/errors');\n const util = require('util');\n const constants = process.binding('constants').os.signals;\n-const assert = require('assert').strict;\n const { deprecate } = require('internal/util');\n-const { isMainThread } = require('internal/worker');\n \n-process.assert = deprecate(\n-  function(x, msg) {\n-    if (!x) throw new ERR_ASSERTION(msg || 'assertion error');\n-  },\n-  'process.assert() is deprecated. Please use the `assert` module instead.',\n-  'DEP0100');\n+function setupAssert() {\n+  process.assert = deprecate(\n+    function(x, msg) {\n+      if (!x) throw new ERR_ASSERTION(msg || 'assertion error');\n+    },\n+    'process.assert() is deprecated. Please use the `assert` module instead.',\n+    'DEP0100');\n+}\n \n // Set up the process.cpuUsage() function.\n-function setup_cpuUsage(_cpuUsage) {\n+function setupCpuUsage(_cpuUsage) {\n   // Create the argument array that will be passed to the native function.\n   const cpuValues = new Float64Array(2);\n \n@@ -90,7 +94,7 @@ function setup_cpuUsage(_cpuUsage) {\n // The 3 entries filled in by the original process.hrtime contains\n // the upper/lower 32 bits of the second part of the value,\n // and the remaining nanoseconds of the value.\n-function setup_hrtime(_hrtime, _hrtimeBigInt) {\n+function setupHrtime(_hrtime, _hrtimeBigInt) {\n   const hrValues = new Uint32Array(3);\n \n   process.hrtime = function hrtime(time) {\n@@ -193,67 +197,6 @@ function setupKillAndExit() {\n   };\n }\n \n-\n-function setupSignalHandlers() {\n-  if (!isMainThread) {\n-    // Worker threads don't receive signals.\n-    return;\n-  }\n-\n-  const signalWraps = Object.create(null);\n-  let Signal;\n-\n-  function isSignal(event) {\n-    return typeof event === 'string' && constants[event] !== undefined;\n-  }\n-\n-  // Detect presence of a listener for the special signal types\n-  process.on('newListener', function(type) {\n-    if (isSignal(type) && signalWraps[type] === undefined) {\n-      if (Signal === undefined)\n-        Signal = process.binding('signal_wrap').Signal;\n-      const wrap = new Signal();\n-\n-      wrap.unref();\n-\n-      wrap.onsignal = process.emit.bind(process, type, type);\n-\n-      const signum = constants[type];\n-      const err = wrap.start(signum);\n-      if (err) {\n-        wrap.close();\n-        throw errnoException(err, 'uv_signal_start');\n-      }\n-\n-      signalWraps[type] = wrap;\n-    }\n-  });\n-\n-  process.on('removeListener', function(type) {\n-    if (signalWraps[type] !== undefined && this.listenerCount(type) === 0) {\n-      signalWraps[type].close();\n-      delete signalWraps[type];\n-    }\n-  });\n-}\n-\n-\n-function setupChannel() {\n-  // If we were spawned with env NODE_CHANNEL_FD then load that up and\n-  // start parsing data from that stream.\n-  if (process.env.NODE_CHANNEL_FD) {\n-    const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n-    assert(fd >= 0);\n-\n-    // Make sure it's not accidentally inherited by child processes.\n-    delete process.env.NODE_CHANNEL_FD;\n-\n-    require('child_process')._forkChild(fd);\n-    assert(process.send);\n-  }\n-}\n-\n-\n function setupRawDebug(_rawDebug) {\n   process._rawDebug = function() {\n     _rawDebug(util.format.apply(null, arguments));\n@@ -288,13 +231,12 @@ function setupUncaughtExceptionCapture(exceptionHandlerState,\n }\n \n module.exports = {\n-  setup_cpuUsage,\n-  setup_hrtime,\n+  setupAssert,\n+  setupCpuUsage,\n+  setupHrtime,\n   setupMemoryUsage,\n   setupConfig,\n   setupKillAndExit,\n-  setupSignalHandlers,\n-  setupChannel,\n   setupRawDebug,\n   setupUncaughtExceptionCapture\n };",
            "previous_filename": "lib/internal/process.js"
        },
        {
            "sha": "6ee756640841178f7d61112f6b4a0d4fced294f6",
            "filename": "lib/internal/process/stdio.js",
            "status": "modified",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fstdio.js",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fstdio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fstdio.js?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -6,21 +6,17 @@ const {\n   ERR_UNKNOWN_STDIN_TYPE,\n   ERR_UNKNOWN_STREAM_TYPE\n } = require('internal/errors').codes;\n-const {\n-  isMainThread,\n-  workerStdio\n-} = require('internal/worker');\n \n-exports.setup = setupStdio;\n+exports.setupProcessStdio = setupProcessStdio;\n+exports.getMainThreadStdio = getMainThreadStdio;\n \n-function setupStdio() {\n+function getMainThreadStdio() {\n   var stdin;\n   var stdout;\n   var stderr;\n \n   function getStdout() {\n     if (stdout) return stdout;\n-    if (!isMainThread) return workerStdio.stdout;\n     stdout = createWritableStdioStream(1);\n     stdout.destroySoon = stdout.destroy;\n     stdout._destroy = function(er, cb) {\n@@ -36,7 +32,6 @@ function setupStdio() {\n \n   function getStderr() {\n     if (stderr) return stderr;\n-    if (!isMainThread) return workerStdio.stderr;\n     stderr = createWritableStdioStream(2);\n     stderr.destroySoon = stderr.destroy;\n     stderr._destroy = function(er, cb) {\n@@ -52,8 +47,6 @@ function setupStdio() {\n \n   function getStdin() {\n     if (stdin) return stdin;\n-    if (!isMainThread) return workerStdio.stdin;\n-\n     const tty_wrap = process.binding('tty_wrap');\n     const fd = 0;\n \n@@ -136,6 +129,14 @@ function setupStdio() {\n     return stdin;\n   }\n \n+  return {\n+    getStdout,\n+    getStderr,\n+    getStdin\n+  };\n+}\n+\n+function setupProcessStdio({ getStdout, getStdin, getStderr }) {\n   Object.defineProperty(process, 'stdout', {\n     configurable: true,\n     enumerable: true,"
        },
        {
            "sha": "834ba6078fca4446f7e8e15b8c1f5267b0ddfe9f",
            "filename": "lib/internal/process/worker_thread_only.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fworker_thread_only.js?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+\n+// This file contains process bootstrappers that can only be\n+// run in the worker thread.\n+\n+const {\n+  setupProcessStdio\n+} = require('internal/process/stdio');\n+\n+const {\n+  workerStdio\n+} = require('internal/worker');\n+\n+function setupStdio() {\n+  setupProcessStdio({\n+    getStdout: () => workerStdio.stdout,\n+    getStderr: () => workerStdio.stderr,\n+    getStdin: () => workerStdio.stdin\n+  });\n+}\n+\n+module.exports = {\n+  setupStdio\n+};"
        },
        {
            "sha": "b60302a29a3021b8167b11bd98133cd506b8314f",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/e43d91cdc1dc08dc160ef49729f47819332af3ae/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/e43d91cdc1dc08dc160ef49729f47819332af3ae/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=e43d91cdc1dc08dc160ef49729f47819332af3ae",
            "patch": "@@ -128,12 +128,13 @@\n       'lib/internal/os.js',\n       'lib/internal/priority_queue.js',\n       'lib/internal/process/esm_loader.js',\n-      'lib/internal/process/methods.js',\n+      'lib/internal/process/main_thread_only.js',\n       'lib/internal/process/next_tick.js',\n+      'lib/internal/process/per_thread.js',\n       'lib/internal/process/promises.js',\n       'lib/internal/process/stdio.js',\n       'lib/internal/process/warning.js',\n-      'lib/internal/process.js',\n+      'lib/internal/process/worker_thread_only.js',\n       'lib/internal/querystring.js',\n       'lib/internal/process/write-coverage.js',\n       'lib/internal/readline.js',"
        }
    ],
    "stats": {
        "total": 302,
        "additions": 182,
        "deletions": 120
    }
}