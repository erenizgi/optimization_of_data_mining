{
    "author": "cjihrig",
    "message": "process: allow reading umask in workers\n\nRefs: https://github.com/nodejs/node/issues/25448\nPR-URL: https://github.com/nodejs/node/pull/25526\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
    "files": [
        {
            "sha": "840ba9b85c12c28f0aedeb5147a182284e3bafd1",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -1926,6 +1926,11 @@ All attempts at serializing an uncaught exception from a worker thread failed.\n The pathname used for the main script of a worker has an\n unknown file extension.\n \n+<a id=\"ERR_WORKER_UNSUPPORTED_OPERATION\"></a>\n+### ERR_WORKER_UNSUPPORTED_OPERATION\n+\n+The requested functionality is not supported in worker threads.\n+\n <a id=\"ERR_ZLIB_INITIALIZATION_FAILED\"></a>\n ### ERR_ZLIB_INITIALIZATION_FAILED\n "
        },
        {
            "sha": "0ba97f851cce9f783ffc4b2dd3a18710b6035029",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -2007,7 +2007,8 @@ console.log(\n );\n ```\n \n-This feature is not available in [`Worker`][] threads.\n+[`Worker`][] threads are able to read the umask, however attempting to set the\n+umask will result in a thrown exception.\n \n ## process.uptime()\n <!-- YAML"
        },
        {
            "sha": "2112cb9ee17fe6173cb93b362220c8c3b674b338",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -82,6 +82,10 @@ function startup() {\n     process._startProfilerIdleNotifier =\n       rawMethods._startProfilerIdleNotifier;\n     process._stopProfilerIdleNotifier = rawMethods._stopProfilerIdleNotifier;\n+  } else {\n+    const wrapped = workerThreadSetup.wrapProcessMethods(rawMethods);\n+\n+    process.umask = wrapped.umask;\n   }\n \n   // Set up methods on the process object for all threads"
        },
        {
            "sha": "12b01ffb9b64f3e52235f853796991ffe571f6af",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -1001,4 +1001,6 @@ E('ERR_WORKER_UNSERIALIZABLE_ERROR',\n E('ERR_WORKER_UNSUPPORTED_EXTENSION',\n   'The worker script extension must be \".js\" or \".mjs\". Received \"%s\"',\n   TypeError);\n+E('ERR_WORKER_UNSUPPORTED_OPERATION',\n+  '%s is not supported in workers', TypeError);\n E('ERR_ZLIB_INITIALIZATION_FAILED', 'Initialization failed', Error);"
        },
        {
            "sha": "b29bc7a390d0e3ab5cb26596274b60c58f0958e1",
            "filename": "lib/internal/process/worker_thread_only.js",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/lib%2Finternal%2Fprocess%2Fworker_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fworker_thread_only.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -15,6 +15,10 @@ const {\n   WritableWorkerStdio\n } = require('internal/worker/io');\n \n+const {\n+  codes: { ERR_WORKER_UNSUPPORTED_OPERATION }\n+} = require('internal/errors');\n+\n let debuglog;\n function debug(...args) {\n   if (!debuglog) {\n@@ -118,8 +122,23 @@ function createWorkerFatalExeception(port) {\n   };\n }\n \n+// The execution of this function itself should not cause any side effects.\n+function wrapProcessMethods(binding) {\n+  function umask(mask) {\n+    // process.umask() is a read-only operation in workers.\n+    if (mask !== undefined) {\n+      throw new ERR_WORKER_UNSUPPORTED_OPERATION('Setting process.umask()');\n+    }\n+\n+    return binding.umask(mask);\n+  }\n+\n+  return { umask };\n+}\n+\n module.exports = {\n   initializeWorkerStdio,\n   createMessageHandler,\n-  createWorkerFatalExeception\n+  createWorkerFatalExeception,\n+  wrapProcessMethods\n };"
        },
        {
            "sha": "51758f05f6bc877e14732838aee7aeac2f8dc186",
            "filename": "src/node_process_methods.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/src%2Fnode_process_methods.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/src%2Fnode_process_methods.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process_methods.cc?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -50,6 +50,10 @@ using v8::Uint32;\n using v8::Uint32Array;\n using v8::Value;\n \n+namespace per_process {\n+Mutex umask_mutex;\n+}   // namespace per_process\n+\n // Microseconds in a second, as a float, used in CPUUsage() below\n #define MICROS_PER_SEC 1e6\n // used in Hrtime() below\n@@ -220,6 +224,7 @@ static void Umask(const FunctionCallbackInfo<Value>& args) {\n \n   CHECK_EQ(args.Length(), 1);\n   CHECK(args[0]->IsUndefined() || args[0]->IsUint32());\n+  Mutex::ScopedLock scoped_lock(per_process::umask_mutex);\n \n   if (args[0]->IsUndefined()) {\n     old = umask(0);\n@@ -396,9 +401,9 @@ static void InitializeProcessMethods(Local<Object> target,\n         target, \"_stopProfilerIdleNotifier\", StopProfilerIdleNotifier);\n     env->SetMethod(target, \"abort\", Abort);\n     env->SetMethod(target, \"chdir\", Chdir);\n-    env->SetMethod(target, \"umask\", Umask);\n   }\n \n+  env->SetMethod(target, \"umask\", Umask);\n   env->SetMethod(target, \"_rawDebug\", RawDebug);\n   env->SetMethod(target, \"memoryUsage\", MemoryUsage);\n   env->SetMethod(target, \"cpuUsage\", CPUUsage);"
        },
        {
            "sha": "72ad0c3b77f41e34d36ceaccfab7daae8d9a0df3",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -33,21 +33,20 @@ const {\n   bits,\n   hasIntl\n } = process.binding('config');\n+const { isMainThread } = require('worker_threads');\n \n // Some tests assume a umask of 0o022 so set that up front. Tests that need a\n // different umask will set it themselves.\n //\n-// process.umask() is not available in workers so we need to check for its\n-// existence.\n-if (process.umask)\n+// Workers can read, but not set the umask, so check that this is the main\n+// thread.\n+if (isMainThread)\n   process.umask(0o022);\n \n const noop = () => {};\n \n const hasCrypto = Boolean(process.versions.openssl);\n \n-const { isMainThread } = require('worker_threads');\n-\n // Check for flags. Skip this for workers (both, the `cluster` module and\n // `worker_threads`) and child processes.\n if (process.argv.length === 2 &&"
        },
        {
            "sha": "013322ed15ba46d2232c0f333ef857114351f399",
            "filename": "test/parallel/test-fs-write-file-sync.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-fs-write-file-sync.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-fs-write-file-sync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-write-file-sync.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -23,7 +23,7 @@\n const common = require('../common');\n \n if (!common.isMainThread)\n-  common.skip('process.umask is not available in Workers');\n+  common.skip('Setting process.umask is not supported in Workers');\n \n const assert = require('assert');\n const path = require('path');"
        },
        {
            "sha": "d599379761fd4063917b85fa631c8f4b25f4caa4",
            "filename": "test/parallel/test-process-umask-mask.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-process-umask-mask.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-process-umask-mask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-umask-mask.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -7,7 +7,7 @@ const common = require('../common');\n const assert = require('assert');\n \n if (!common.isMainThread)\n-  common.skip('process.umask is not available in Workers');\n+  common.skip('Setting process.umask is not supported in Workers');\n \n let mask;\n "
        },
        {
            "sha": "592463eca17a9d1cf41534363a1e05ffbf38ae79",
            "filename": "test/parallel/test-process-umask.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-process-umask.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6cd4e3e5976ce9edccdb13933028bdc95d43df4/test%2Fparallel%2Ftest-process-umask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-umask.js?ref=f6cd4e3e5976ce9edccdb13933028bdc95d43df4",
            "patch": "@@ -22,8 +22,15 @@\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n-if (!common.isMainThread)\n-  common.skip('process.umask is not available in Workers');\n+\n+if (!common.isMainThread) {\n+  assert.strictEqual(typeof process.umask(), 'number');\n+  assert.throws(() => {\n+    process.umask('0664');\n+  }, { code: 'ERR_WORKER_UNSUPPORTED_OPERATION' });\n+\n+  common.skip('Setting process.umask is not supported in Workers');\n+}\n \n // Note in Windows one can only set the \"user\" bits.\n let mask;"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 54,
        "deletions": 12
    }
}