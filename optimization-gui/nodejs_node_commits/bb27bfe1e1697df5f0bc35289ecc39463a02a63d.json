{
    "author": "apapirovski",
    "message": "process: JS fast path for bindings\n\nCurrently, both process.binding and internalBinding have to call into\nC++ regardless of whether the module has been cached or not. This\ncreates significant overhead to all binding calls and unfortunately\nthe rest of the codebase doesn't really optimize the amount of times\nthat bindings are required (as an example: 12 files require the\nasync_wrap binding).\n\nChanging all the usage of this function throughout the codebase would\nintroduce a lot of churn (and is kind of a hassle) so instead this PR\nintroduces a JS fast path for both functions for cases where the\nbinding has already been cached. While micro benchmarks are not super\nmeaningful here (it's not like we call binding that often...), this\ndoes speed up the cached call by 400%.\n\nIn addition, move moduleLoadList creation and management entirely into\nJS-land as it requires less code and is more efficient.\n\nPR-URL: https://github.com/nodejs/node/pull/18365\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "bb27bfe1e1697df5f0bc35289ecc39463a02a63d",
    "files": [
        {
            "sha": "f3f3264f353c248e0c46c5604682fd02e9474f58",
            "filename": "lib/internal/bootstrap_node.js",
            "status": "modified",
            "additions": 49,
            "deletions": 4,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/lib%2Finternal%2Fbootstrap_node.js",
            "raw_url": "https://github.com/nodejs/node/raw/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/lib%2Finternal%2Fbootstrap_node.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap_node.js?ref=bb27bfe1e1697df5f0bc35289ecc39463a02a63d",
            "patch": "@@ -21,9 +21,6 @@\n \n     setupProcessObject();\n \n-    internalBinding = process._internalBinding;\n-    delete process._internalBinding;\n-\n     // do this good and early, since it handles errors.\n     setupProcessFatal();\n \n@@ -246,6 +243,54 @@\n     perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n   }\n \n+  const moduleLoadList = [];\n+  Object.defineProperty(process, 'moduleLoadList', {\n+    value: moduleLoadList,\n+    configurable: true,\n+    enumerable: true,\n+    writable: false\n+  });\n+\n+  {\n+    const bindingObj = Object.create(null);\n+\n+    const getBinding = process.binding;\n+    process.binding = function binding(module) {\n+      module = String(module);\n+      let mod = bindingObj[module];\n+      if (typeof mod !== 'object') {\n+        mod = bindingObj[module] = getBinding(module);\n+        moduleLoadList.push(`Binding ${module}`);\n+      }\n+      return mod;\n+    };\n+\n+    const getLinkedBinding = process._linkedBinding;\n+    process._linkedBinding = function _linkedBinding(module) {\n+      module = String(module);\n+      let mod = bindingObj[module];\n+      if (typeof mod !== 'object')\n+        mod = bindingObj[module] = getLinkedBinding(module);\n+      return mod;\n+    };\n+  }\n+\n+  {\n+    const bindingObj = Object.create(null);\n+\n+    const getInternalBinding = process._internalBinding;\n+    delete process._internalBinding;\n+\n+    internalBinding = function internalBinding(module) {\n+      let mod = bindingObj[module];\n+      if (typeof mod !== 'object') {\n+        mod = bindingObj[module] = getInternalBinding(module);\n+        moduleLoadList.push(`Internal Binding ${module}`);\n+      }\n+      return mod;\n+    };\n+  }\n+\n   function setupProcessObject() {\n     process._setupProcessObject(pushValueToArray);\n \n@@ -550,7 +595,7 @@\n       throw err;\n     }\n \n-    process.moduleLoadList.push(`NativeModule ${id}`);\n+    moduleLoadList.push(`NativeModule ${id}`);\n \n     const nativeModule = new NativeModule(id);\n "
        },
        {
            "sha": "545a92ba17f47ca162db54dde272c32b16264c2f",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=bb27bfe1e1697df5f0bc35289ecc39463a02a63d",
            "patch": "@@ -328,18 +328,6 @@ inline Environment::Environment(IsolateData* isolate_data,\n   v8::Context::Scope context_scope(context);\n   set_as_external(v8::External::New(isolate(), this));\n \n-  v8::Local<v8::Primitive> null = v8::Null(isolate());\n-  v8::Local<v8::Object> binding_cache_object = v8::Object::New(isolate());\n-  CHECK(binding_cache_object->SetPrototype(context, null).FromJust());\n-  set_binding_cache_object(binding_cache_object);\n-\n-  v8::Local<v8::Object> internal_binding_cache_object =\n-      v8::Object::New(isolate());\n-  CHECK(internal_binding_cache_object->SetPrototype(context, null).FromJust());\n-  set_internal_binding_cache_object(internal_binding_cache_object);\n-\n-  set_module_load_list_array(v8::Array::New(isolate()));\n-\n   AssignToContext(context, ContextInfo(\"\"));\n \n   destroy_async_id_list_.reserve(512);"
        },
        {
            "sha": "d73be8156ecebf9bcb3ca97ac98d6f904af63b6a",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=bb27bfe1e1697df5f0bc35289ecc39463a02a63d",
            "patch": "@@ -274,8 +274,6 @@ class ModuleWrap;\n   V(async_hooks_after_function, v8::Function)                                 \\\n   V(async_hooks_promise_resolve_function, v8::Function)                       \\\n   V(async_hooks_binding, v8::Object)                                          \\\n-  V(binding_cache_object, v8::Object)                                         \\\n-  V(internal_binding_cache_object, v8::Object)                                \\\n   V(buffer_prototype_object, v8::Object)                                      \\\n   V(context, v8::Context)                                                     \\\n   V(domain_callback, v8::Function)                                            \\\n@@ -285,7 +283,6 @@ class ModuleWrap;\n   V(http2settings_constructor_template, v8::ObjectTemplate)                   \\\n   V(immediate_callback_function, v8::Function)                                \\\n   V(inspector_console_api_object, v8::Object)                                 \\\n-  V(module_load_list_array, v8::Array)                                        \\\n   V(pbkdf2_constructor_template, v8::ObjectTemplate)                          \\\n   V(pipe_constructor_template, v8::FunctionTemplate)                          \\\n   V(performance_entry_callback, v8::Function)                                 \\"
        },
        {
            "sha": "2e1d08f5b5d76d8f338e6950a398ee01945761c1",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 59,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bb27bfe1e1697df5f0bc35289ecc39463a02a63d/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=bb27bfe1e1697df5f0bc35289ecc39463a02a63d",
            "patch": "@@ -2460,22 +2460,6 @@ Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n }\n \n \n-static bool PullFromCache(Environment* env,\n-                          const FunctionCallbackInfo<Value>& args,\n-                          Local<String> module,\n-                          Local<Object> cache) {\n-  Local<Context> context = env->context();\n-  Local<Value> exports_v;\n-  Local<Object> exports;\n-  if (cache->Get(context, module).ToLocal(&exports_v) &&\n-      exports_v->IsObject() &&\n-      exports_v->ToObject(context).ToLocal(&exports)) {\n-    args.GetReturnValue().Set(exports);\n-    return true;\n-  }\n-  return false;\n-}\n-\n static Local<Object> InitModule(Environment* env,\n                                  node_module* mod,\n                                  Local<String> module) {\n@@ -2503,22 +2487,10 @@ static void ThrowIfNoSuchModule(Environment* env, const char* module_v) {\n static void Binding(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  Local<String> module;\n-  if (!args[0]->ToString(env->context()).ToLocal(&module)) return;\n-\n-  Local<Object> cache = env->binding_cache_object();\n-\n-  if (PullFromCache(env, args, module, cache))\n-    return;\n+  CHECK(args[0]->IsString());\n \n-  // Append a string to process.moduleLoadList\n-  char buf[1024];\n+  Local<String> module = args[0].As<String>();\n   node::Utf8Value module_v(env->isolate(), module);\n-  snprintf(buf, sizeof(buf), \"Binding %s\", *module_v);\n-\n-  Local<Array> modules = env->module_load_list_array();\n-  uint32_t l = modules->Length();\n-  modules->Set(l, OneByteString(env->isolate(), buf));\n \n   node_module* mod = get_builtin_module(*module_v);\n   Local<Object> exports;\n@@ -2535,50 +2507,31 @@ static void Binding(const FunctionCallbackInfo<Value>& args) {\n   } else {\n     return ThrowIfNoSuchModule(env, *module_v);\n   }\n-  cache->Set(module, exports);\n \n   args.GetReturnValue().Set(exports);\n }\n \n static void InternalBinding(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  Local<String> module;\n-  if (!args[0]->ToString(env->context()).ToLocal(&module)) return;\n-\n-  Local<Object> cache = env->internal_binding_cache_object();\n-\n-  if (PullFromCache(env, args, module, cache))\n-    return;\n+  CHECK(args[0]->IsString());\n \n-  // Append a string to process.moduleLoadList\n-  char buf[1024];\n+  Local<String> module = args[0].As<String>();\n   node::Utf8Value module_v(env->isolate(), module);\n-  snprintf(buf, sizeof(buf), \"Internal Binding %s\", *module_v);\n-\n-  Local<Array> modules = env->module_load_list_array();\n-  uint32_t l = modules->Length();\n-  modules->Set(l, OneByteString(env->isolate(), buf));\n \n   node_module* mod = get_internal_module(*module_v);\n   if (mod == nullptr) return ThrowIfNoSuchModule(env, *module_v);\n   Local<Object> exports = InitModule(env, mod, module);\n-  cache->Set(module, exports);\n \n   args.GetReturnValue().Set(exports);\n }\n \n static void LinkedBinding(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args.GetIsolate());\n \n-  Local<String> module_name;\n-  if (!args[0]->ToString(env->context()).ToLocal(&module_name)) return;\n-\n-  Local<Object> cache = env->binding_cache_object();\n-  Local<Value> exports_v = cache->Get(module_name);\n+  CHECK(args[0]->IsString());\n \n-  if (exports_v->IsObject())\n-    return args.GetReturnValue().Set(exports_v.As<Object>());\n+  Local<String> module_name = args[0].As<String>();\n \n   node::Utf8Value module_name_v(env->isolate(), module_name);\n   node_module* mod = get_linked_module(*module_name_v);\n@@ -2609,7 +2562,6 @@ static void LinkedBinding(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   auto effective_exports = module->Get(exports_prop);\n-  cache->Set(module_name, effective_exports);\n \n   args.GetReturnValue().Set(effective_exports);\n }\n@@ -2937,11 +2889,6 @@ void SetupProcessObject(Environment* env,\n                     \"version\",\n                     FIXED_ONE_BYTE_STRING(env->isolate(), NODE_VERSION));\n \n-  // process.moduleLoadList\n-  READONLY_PROPERTY(process,\n-                    \"moduleLoadList\",\n-                    env->module_load_list_array());\n-\n   // process.versions\n   Local<Object> versions = Object::New(env->isolate());\n   READONLY_PROPERTY(process, \"versions\", versions);"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 55,
        "deletions": 78
    }
}