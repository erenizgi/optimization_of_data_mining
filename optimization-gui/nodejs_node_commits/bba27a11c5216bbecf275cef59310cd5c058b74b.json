{
    "author": "joyeecheung",
    "message": "process: use common operations to define browser globals\n\nExtracts:\n\n- `exposeNamespace`: https://heycam.github.io/webidl/#es-namespaces\n- `exposeInterface`: https://heycam.github.io/webidl/#es-interfaces\n- `defineOperation`: https://heycam.github.io/webidl/#define-the-operations\n\ninto functions to define browser globals.\n\nPR-URL: https://github.com/nodejs/node/pull/26230\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "bba27a11c5216bbecf275cef59310cd5c058b74b",
    "files": [
        {
            "sha": "03d49b487a56bbd93e4afceb255c67f6c113d088",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 59,
            "deletions": 61,
            "changes": 120,
            "blob_url": "https://github.com/nodejs/node/blob/bba27a11c5216bbecf275cef59310cd5c058b74b/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/bba27a11c5216bbecf275cef59310cd5c058b74b/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=bba27a11c5216bbecf275cef59310cd5c058b74b",
            "patch": "@@ -182,11 +182,34 @@ if (config.hasInspector) {\n \n const browserGlobals = !process._noBrowserGlobals;\n if (browserGlobals) {\n-  setupGlobalTimeouts();\n-  setupGlobalConsole();\n-  setupGlobalURL();\n-  setupGlobalEncoding();\n+  // Override global console from the one provided by the VM\n+  // to the one implemented by Node.js\n+  // https://console.spec.whatwg.org/#console-namespace\n+  exposeNamespace(global, 'console', createGlobalConsole(global.console));\n+\n+  const { URL, URLSearchParams } = NativeModule.require('internal/url');\n+  // https://url.spec.whatwg.org/#url\n+  exposeInterface(global, 'URL', URL);\n+  // https://url.spec.whatwg.org/#urlsearchparams\n+  exposeInterface(global, 'URLSearchParams', URLSearchParams);\n+\n+  const { TextEncoder, TextDecoder } = NativeModule.require('util');\n+  // https://encoding.spec.whatwg.org/#textencoder\n+  exposeInterface(global, 'TextEncoder', TextEncoder);\n+  // https://encoding.spec.whatwg.org/#textdecoder\n+  exposeInterface(global, 'TextDecoder', TextDecoder);\n+\n+  // https://html.spec.whatwg.org/multipage/webappapis.html#windoworworkerglobalscope\n+  const timers = NativeModule.require('timers');\n+  defineOperation(global, 'clearInterval', timers.clearInterval);\n+  defineOperation(global, 'clearTimeout', timers.clearTimeout);\n+  defineOperation(global, 'setInterval', timers.setInterval);\n+  defineOperation(global, 'setTimeout', timers.setTimeout);\n   setupQueueMicrotask();\n+\n+  // Non-standard extensions:\n+  defineOperation(global, 'clearImmediate', timers.clearImmediate);\n+  defineOperation(global, 'setImmediate', timers.setImmediate);\n }\n \n setupDOMException();\n@@ -376,29 +399,9 @@ function setupBuffer() {\n   });\n }\n \n-function setupGlobalTimeouts() {\n-  const timers = NativeModule.require('timers');\n-  global.clearImmediate = timers.clearImmediate;\n-  global.clearInterval = timers.clearInterval;\n-  global.clearTimeout = timers.clearTimeout;\n-  global.setImmediate = timers.setImmediate;\n-  global.setInterval = timers.setInterval;\n-  global.setTimeout = timers.setTimeout;\n-}\n-\n-function setupGlobalConsole() {\n-  const consoleFromVM = global.console;\n+function createGlobalConsole(consoleFromVM) {\n   const consoleFromNode =\n     NativeModule.require('internal/console/global');\n-  // Override global console from the one provided by the VM\n-  // to the one implemented by Node.js\n-  Object.defineProperty(global, 'console', {\n-    configurable: true,\n-    enumerable: false,\n-    value: consoleFromNode,\n-    writable: true\n-  });\n-\n   if (config.hasInspector) {\n     const inspector = NativeModule.require('internal/util/inspector');\n     // This will be exposed by `require('inspector').console` later.\n@@ -410,42 +413,7 @@ function setupGlobalConsole() {\n     // Setup inspector command line API.\n     setConsoleExtensionInstaller(inspector.installConsoleExtensions);\n   }\n-}\n-\n-function setupGlobalURL() {\n-  const { URL, URLSearchParams } = NativeModule.require('internal/url');\n-  Object.defineProperties(global, {\n-    URL: {\n-      value: URL,\n-      writable: true,\n-      configurable: true,\n-      enumerable: false\n-    },\n-    URLSearchParams: {\n-      value: URLSearchParams,\n-      writable: true,\n-      configurable: true,\n-      enumerable: false\n-    }\n-  });\n-}\n-\n-function setupGlobalEncoding() {\n-  const { TextEncoder, TextDecoder } = NativeModule.require('util');\n-  Object.defineProperties(global, {\n-    TextEncoder: {\n-      value: TextEncoder,\n-      writable: true,\n-      configurable: true,\n-      enumerable: false\n-    },\n-    TextDecoder: {\n-      value: TextDecoder,\n-      writable: true,\n-      configurable: true,\n-      enumerable: false\n-    }\n-  });\n+  return consoleFromNode;\n }\n \n function setupQueueMicrotask() {\n@@ -483,3 +451,33 @@ function setupDOMException() {\n   const { registerDOMException } = internalBinding('messaging');\n   registerDOMException(DOMException);\n }\n+\n+// https://heycam.github.io/webidl/#es-namespaces\n+function exposeNamespace(target, name, namespaceObject) {\n+  Object.defineProperty(target, name, {\n+    writable: true,\n+    enumerable: false,\n+    configurable: true,\n+    value: namespaceObject\n+  });\n+}\n+\n+// https://heycam.github.io/webidl/#es-interfaces\n+function exposeInterface(target, name, interfaceObject) {\n+  Object.defineProperty(target, name, {\n+    writable: true,\n+    enumerable: false,\n+    configurable: true,\n+    value: interfaceObject\n+  });\n+}\n+\n+// https://heycam.github.io/webidl/#define-the-operations\n+function defineOperation(target, name, method) {\n+  Object.defineProperty(target, name, {\n+    writable: true,\n+    enumerable: true,\n+    configurable: true,\n+    value: method\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 59,
        "deletions": 61
    }
}