{
    "author": "devsnek",
    "message": "util: support inspecting namespaces of unevaluated modules\n\nPR-URL: https://github.com/nodejs/node/pull/20782\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "064057b7ad0ee6f76f43846b4f002072dafa1702",
    "files": [
        {
            "sha": "2ef7e4e54c5c6d8d38092fa0ac262fa2e939464b",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 42,
            "deletions": 11,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/064057b7ad0ee6f76f43846b4f002072dafa1702/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/064057b7ad0ee6f76f43846b4f002072dafa1702/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=064057b7ad0ee6f76f43846b4f002072dafa1702",
            "patch": "@@ -629,6 +629,9 @@ function formatValue(ctx, value, recurseTimes, ln) {\n       } else {\n         extra = '[items unknown]';\n       }\n+    } else if (types.isModuleNamespaceObject(value)) {\n+      braces[0] = `[${tag}] {`;\n+      formatter = formatNamespaceObject;\n     } else {\n       // Check boxed primitives other than string with valueOf()\n       // NOTE: `Date` has to be checked first!\n@@ -757,6 +760,15 @@ function formatObject(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n+function formatNamespaceObject(ctx, value, recurseTimes, keys) {\n+  const len = keys.length;\n+  const output = new Array(len);\n+  for (var i = 0; i < len; i++) {\n+    output[i] = formatNamespaceProperty(ctx, value, recurseTimes, keys[i]);\n+  }\n+  return output;\n+}\n+\n // The array is sparse and/or has extra keys\n function formatSpecialArray(ctx, value, recurseTimes, keys, maxLength, valLen) {\n   const output = [];\n@@ -980,8 +992,36 @@ function formatPromise(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n+function formatKey(ctx, key, enumerable) {\n+  if (typeof key === 'symbol') {\n+    return `[${ctx.stylize(key.toString(), 'symbol')}]`;\n+  }\n+  if (enumerable === false) {\n+    return `[${key}]`;\n+  }\n+  if (keyStrRegExp.test(key)) {\n+    return ctx.stylize(key, 'name');\n+  }\n+  return ctx.stylize(strEscape(key), 'string');\n+}\n+\n+function formatNamespaceProperty(ctx, ns, recurseTimes, key) {\n+  let value;\n+  try {\n+    value = formatValue(ctx, ns[key], recurseTimes, true);\n+  } catch (err) {\n+    if (err instanceof ReferenceError) {\n+      value = ctx.stylize('<uninitialized>', 'special');\n+    } else {\n+      throw err;\n+    }\n+  }\n+\n+  return `${formatKey(ctx, key)}: ${value}`;\n+}\n+\n function formatProperty(ctx, value, recurseTimes, key, array) {\n-  let name, str;\n+  let str;\n   const desc = Object.getOwnPropertyDescriptor(value, key) ||\n     { value: value[key], enumerable: true };\n   if (desc.value !== undefined) {\n@@ -1003,17 +1043,8 @@ function formatProperty(ctx, value, recurseTimes, key, array) {\n   if (array === 1) {\n     return str;\n   }\n-  if (typeof key === 'symbol') {\n-    name = `[${ctx.stylize(key.toString(), 'symbol')}]`;\n-  } else if (desc.enumerable === false) {\n-    name = `[${key}]`;\n-  } else if (keyStrRegExp.test(key)) {\n-    name = ctx.stylize(key, 'name');\n-  } else {\n-    name = ctx.stylize(strEscape(key), 'string');\n-  }\n \n-  return `${name}: ${str}`;\n+  return `${formatKey(ctx, key, desc.enumerable)}: ${str}`;\n }\n \n function reduceToSingleString(ctx, output, base, braces, addLn) {"
        },
        {
            "sha": "fddbcdb34697d90b97a50dc04aaac642b782e797",
            "filename": "test/parallel/test-util-inspect-namespace.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/064057b7ad0ee6f76f43846b4f002072dafa1702/test%2Fparallel%2Ftest-util-inspect-namespace.js",
            "raw_url": "https://github.com/nodejs/node/raw/064057b7ad0ee6f76f43846b4f002072dafa1702/test%2Fparallel%2Ftest-util-inspect-namespace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect-namespace.js?ref=064057b7ad0ee6f76f43846b4f002072dafa1702",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+\n+// Flags: --experimental-vm-modules\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+common.crashOnUnhandledRejection();\n+\n+const { Module } = require('vm');\n+const { inspect } = require('util');\n+\n+(async () => {\n+  const m = new Module('export const a = 1; export var b = 2');\n+  await m.link(() => 0);\n+  m.instantiate();\n+  assert.strictEqual(\n+    inspect(m.namespace),\n+    '[Module] { a: <uninitialized>, b: undefined }');\n+  await m.evaluate();\n+  assert.strictEqual(inspect(m.namespace), '[Module] { a: 1, b: 2 }');\n+})();"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 64,
        "deletions": 11
    }
}