{
    "author": "Fishrock123",
    "message": "timers: make timer.refresh() a public API\n\nOriginally added in\nbb5575aa75fd3071724d5eccde39a3041e1af57a\ndiscussions such as\nhttps://github.com/nodejs/node/issues/20261\nshow the usefulness of this API to the Node.js ecosystem.\n\nPR-URL: https://github.com/nodejs/node/pull/20298\n\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "46d335c380510fda68e62a4cdafa58e7e7b230a1",
    "files": [
        {
            "sha": "c573d2afdb9e21e75a98961810f72c09b110f2cb",
            "filename": "doc/api/timers.md",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/46d335c380510fda68e62a4cdafa58e7e7b230a1/doc%2Fapi%2Ftimers.md",
            "raw_url": "https://github.com/nodejs/node/raw/46d335c380510fda68e62a4cdafa58e7e7b230a1/doc%2Fapi%2Ftimers.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftimers.md?ref=46d335c380510fda68e62a4cdafa58e7e7b230a1",
            "patch": "@@ -74,6 +74,21 @@ When called, requests that the Node.js event loop *not* exit so long as the\n By default, all `Timeout` objects are \"ref'ed\", making it normally unnecessary\n to call `timeout.ref()` unless `timeout.unref()` had been called previously.\n \n+### timeout.refresh()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {Timeout} a reference to `timeout`\n+\n+Sets the timer's start time to the current time, and reschedules the timer to\n+call its callback at the previously specified duration adjusted to the current\n+time. This is useful for refreshing a timer without allocating a new\n+JavaScript object.\n+\n+Using this on a timer that has already called its callback will reactivate the\n+timer.\n+\n ### timeout.unref()\n <!-- YAML\n added: v0.9.1"
        },
        {
            "sha": "0efdf9c063bf359d317f5c7f7dce6631fa648aa0",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=46d335c380510fda68e62a4cdafa58e7e7b230a1",
            "patch": "@@ -107,8 +107,7 @@ const {\n const {\n   kTimeout,\n   setUnrefTimeout,\n-  validateTimerDuration,\n-  refreshFnSymbol\n+  validateTimerDuration\n } = require('internal/timers');\n const {\n   createWriteWrap,\n@@ -962,7 +961,7 @@ class Http2Session extends EventEmitter {\n   [kUpdateTimer]() {\n     if (this.destroyed)\n       return;\n-    if (this[kTimeout]) this[kTimeout][refreshFnSymbol]();\n+    if (this[kTimeout]) this[kTimeout].refresh();\n   }\n \n   // Sets the id of the next stream to be created by this Http2Session.\n@@ -1539,7 +1538,7 @@ class Http2Stream extends Duplex {\n     if (this.destroyed)\n       return;\n     if (this[kTimeout])\n-      this[kTimeout][refreshFnSymbol]();\n+      this[kTimeout].refresh();\n     if (this[kSession])\n       this[kSession][kUpdateTimer]();\n   }"
        },
        {
            "sha": "801fce1cc369fdf002bf4b227b825cceb9c76fd4",
            "filename": "lib/internal/timers.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Finternal%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Finternal%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftimers.js?ref=46d335c380510fda68e62a4cdafa58e7e7b230a1",
            "patch": "@@ -19,7 +19,6 @@ const {\n // Timeout values > TIMEOUT_MAX are set to 1.\n const TIMEOUT_MAX = 2 ** 31 - 1;\n \n-const refreshFnSymbol = Symbol('refresh()');\n const unrefedSymbol = Symbol('unrefed');\n \n module.exports = {\n@@ -29,7 +28,6 @@ module.exports = {\n   trigger_async_id_symbol,\n   Timeout,\n   initAsyncResource,\n-  refreshFnSymbol,\n   setUnrefTimeout,\n   validateTimerDuration\n };\n@@ -82,7 +80,7 @@ function Timeout(callback, after, args, isRepeat, isUnrefed) {\n   initAsyncResource(this, 'Timeout');\n }\n \n-Timeout.prototype[refreshFnSymbol] = function refresh() {\n+Timeout.prototype.refresh = function() {\n   if (this._handle) {\n     // Would be more ideal with uv_timer_again(), however that API does not\n     // cause libuv's sorted timers data structure (a binary heap at the time\n@@ -93,6 +91,8 @@ Timeout.prototype[refreshFnSymbol] = function refresh() {\n   } else {\n     getTimers().active(this);\n   }\n+\n+  return this;\n };\n \n function setUnrefTimeout(callback, after, arg1, arg2, arg3) {"
        },
        {
            "sha": "5537c472fe05e37f2ff0d94f44d78f10f1c8fd6d",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/46d335c380510fda68e62a4cdafa58e7e7b230a1/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=46d335c380510fda68e62a4cdafa58e7e7b230a1",
            "patch": "@@ -89,8 +89,7 @@ const exceptionWithHostPort = errors.exceptionWithHostPort;\n const {\n   kTimeout,\n   setUnrefTimeout,\n-  validateTimerDuration,\n-  refreshFnSymbol\n+  validateTimerDuration\n } = require('internal/timers');\n \n function noop() {}\n@@ -325,7 +324,7 @@ util.inherits(Socket, stream.Duplex);\n Socket.prototype._unrefTimer = function _unrefTimer() {\n   for (var s = this; s !== null; s = s._parent) {\n     if (s[kTimeout])\n-      s[kTimeout][refreshFnSymbol]();\n+      s[kTimeout].refresh();\n   }\n };\n "
        },
        {
            "sha": "2c47be8d8d15ae47e9d123ca8d9614ee87ee47b5",
            "filename": "test/parallel/test-timers-refresh.js",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/46d335c380510fda68e62a4cdafa58e7e7b230a1/test%2Fparallel%2Ftest-timers-refresh.js",
            "raw_url": "https://github.com/nodejs/node/raw/46d335c380510fda68e62a4cdafa58e7e7b230a1/test%2Fparallel%2Ftest-timers-refresh.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-refresh.js?ref=46d335c380510fda68e62a4cdafa58e7e7b230a1",
            "patch": "@@ -5,7 +5,7 @@\n const common = require('../common');\n \n const { strictEqual } = require('assert');\n-const { setUnrefTimeout, refreshFnSymbol } = require('internal/timers');\n+const { setUnrefTimeout } = require('internal/timers');\n \n // Schedule the unrefed cases first so that the later case keeps the event loop\n // active.\n@@ -27,7 +27,7 @@ const { setUnrefTimeout, refreshFnSymbol } = require('internal/timers');\n     strictEqual(called, false, 'unref()\\'d timer returned before check');\n   }), 1);\n \n-  timer[refreshFnSymbol]();\n+  strictEqual(timer.refresh(), timer);\n }\n \n // unref pooled timer\n@@ -41,7 +41,7 @@ const { setUnrefTimeout, refreshFnSymbol } = require('internal/timers');\n     strictEqual(called, false, 'unref pooled timer returned before check');\n   }), 1);\n \n-  timer[refreshFnSymbol]();\n+  strictEqual(timer.refresh(), timer);\n }\n \n // regular timer\n@@ -55,5 +55,22 @@ const { setUnrefTimeout, refreshFnSymbol } = require('internal/timers');\n     strictEqual(called, false, 'pooled timer returned before check');\n   }), 1);\n \n-  timer[refreshFnSymbol]();\n+  strictEqual(timer.refresh(), timer);\n+}\n+\n+// interval\n+{\n+  let called = 0;\n+  const timer = setInterval(common.mustCall(() => {\n+    called += 1;\n+    if (called === 2) {\n+      clearInterval(timer);\n+    }\n+  }, 2), 1);\n+\n+  setTimeout(common.mustCall(() => {\n+    strictEqual(called, 0, 'pooled timer returned before check');\n+  }), 1);\n+\n+  strictEqual(timer.refresh(), timer);\n }"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 44,
        "deletions": 14
    }
}