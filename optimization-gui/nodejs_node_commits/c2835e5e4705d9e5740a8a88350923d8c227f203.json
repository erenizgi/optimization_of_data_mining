{
    "author": "aks-",
    "message": "lib: merge stream code for http2 streams & net.Socket\n\nSquashed from:\n\n- lib: separate writev responsibilities from writeGeneric\n- lib: fix calling of cb twice\n- lib: extract streamId out of stream_base to caller\n- lib: add symbols instead of methods to hide impl details\n- lib: remove unneeded lines\n- lib: use Object.assign instead of apply\n- lib: rename mixin StreamBase to StreamSharedMethods\n- lib: use stream shared funcs as top level instead of\n  properties of prototypes\n- lib: mv lib/internal/stream_shared_methods.js\n  lib/internal/stream_base_commons.js\n- lib: add comment for readability\n- lib: refactor _writev in Http2Stream\n- lib: rephrase comment\n- lib: revert usage of const,let for perf reasons\n\nPR-URL: https://github.com/nodejs/node/pull/19527\nRefs: https://github.com/nodejs/node/issues/19060\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "c2835e5e4705d9e5740a8a88350923d8c227f203",
    "files": [
        {
            "sha": "8005d7941a6df33e117788ed9f70e56a9b512ba6",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 14,
            "deletions": 47,
            "changes": 61,
            "blob_url": "https://github.com/nodejs/node/blob/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=c2835e5e4705d9e5740a8a88350923d8c227f203",
            "patch": "@@ -12,14 +12,12 @@ const binding = process.binding('http2');\n const { FileHandle } = process.binding('fs');\n const { StreamPipe } = internalBinding('stream_pipe');\n const assert = require('assert');\n-const { Buffer } = require('buffer');\n const EventEmitter = require('events');\n const net = require('net');\n const tls = require('tls');\n const util = require('util');\n const fs = require('fs');\n const {\n-  errnoException,\n   codes: {\n     ERR_HTTP2_ALTSVC_INVALID_ORIGIN,\n     ERR_HTTP2_ALTSVC_LENGTH,\n@@ -107,8 +105,13 @@ const {\n   validateTimerDuration,\n   refreshFnSymbol\n } = require('internal/timers');\n+const {\n+  createWriteWrap,\n+  writeGeneric,\n+  writevGeneric\n+} = require('internal/stream_base_commons');\n \n-const { ShutdownWrap, WriteWrap } = process.binding('stream_wrap');\n+const { ShutdownWrap } = process.binding('stream_wrap');\n const { constants, nameForErrorCode } = binding;\n \n const NETServer = net.Server;\n@@ -1429,28 +1432,6 @@ class ClientHttp2Session extends Http2Session {\n   }\n }\n \n-function createWriteReq(req, handle, data, encoding) {\n-  switch (encoding) {\n-    case 'utf8':\n-    case 'utf-8':\n-      return handle.writeUtf8String(req, data);\n-    case 'ascii':\n-      return handle.writeAsciiString(req, data);\n-    case 'ucs2':\n-    case 'ucs-2':\n-    case 'utf16le':\n-    case 'utf-16le':\n-      return handle.writeUcs2String(req, data);\n-    case 'latin1':\n-    case 'binary':\n-      return handle.writeLatin1String(req, data);\n-    case 'buffer':\n-      return handle.writeBuffer(req, data);\n-    default:\n-      return handle.writeBuffer(req, Buffer.from(data, encoding));\n-  }\n-}\n-\n function trackWriteState(stream, bytes) {\n   const session = stream[kSession];\n   stream[kState].writeQueueSize += bytes;\n@@ -1674,16 +1655,12 @@ class Http2Stream extends Duplex {\n     if (!this.headersSent)\n       this[kProceed]();\n \n-    const handle = this[kHandle];\n-    const req = new WriteWrap();\n+    const req = createWriteWrap(this[kHandle], afterDoStreamWrite);\n     req.stream = this[kID];\n-    req.handle = handle;\n     req.callback = cb;\n-    req.oncomplete = afterDoStreamWrite;\n-    req.async = false;\n-    const err = createWriteReq(req, handle, data, encoding);\n-    if (err)\n-      return this.destroy(errnoException(err, 'write', req.error), cb);\n+\n+    writeGeneric(this, req, data, encoding, cb);\n+\n     trackWriteState(this, req.bytes);\n   }\n \n@@ -1711,22 +1688,12 @@ class Http2Stream extends Duplex {\n     if (!this.headersSent)\n       this[kProceed]();\n \n-    const handle = this[kHandle];\n-    const req = new WriteWrap();\n+    var req = createWriteWrap(this[kHandle], afterDoStreamWrite);\n     req.stream = this[kID];\n-    req.handle = handle;\n     req.callback = cb;\n-    req.oncomplete = afterDoStreamWrite;\n-    req.async = false;\n-    const chunks = new Array(data.length << 1);\n-    for (var i = 0; i < data.length; i++) {\n-      const entry = data[i];\n-      chunks[i * 2] = entry.chunk;\n-      chunks[i * 2 + 1] = entry.encoding;\n-    }\n-    const err = handle.writev(req, chunks);\n-    if (err)\n-      return this.destroy(errnoException(err, 'write', req.error), cb);\n+\n+    writevGeneric(this, req, data, cb);\n+\n     trackWriteState(this, req.bytes);\n   }\n "
        },
        {
            "sha": "d902a501524791e9368998c9c8a58c8eef39db35",
            "filename": "lib/internal/stream_base_commons.js",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/nodejs/node/blob/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Finternal%2Fstream_base_commons.js",
            "raw_url": "https://github.com/nodejs/node/raw/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Finternal%2Fstream_base_commons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstream_base_commons.js?ref=c2835e5e4705d9e5740a8a88350923d8c227f203",
            "patch": "@@ -0,0 +1,79 @@\n+'use strict';\n+\n+const { Buffer } = require('buffer');\n+const errors = require('internal/errors');\n+const { WriteWrap } = process.binding('stream_wrap');\n+\n+const errnoException = errors.errnoException;\n+\n+function handleWriteReq(req, data, encoding) {\n+  const { handle } = req;\n+\n+  switch (encoding) {\n+    case 'buffer':\n+      return handle.writeBuffer(req, data);\n+    case 'latin1':\n+    case 'binary':\n+      return handle.writeLatin1String(req, data);\n+    case 'utf8':\n+    case 'utf-8':\n+      return handle.writeUtf8String(req, data);\n+    case 'ascii':\n+      return handle.writeAsciiString(req, data);\n+    case 'ucs2':\n+    case 'ucs-2':\n+    case 'utf16le':\n+    case 'utf-16le':\n+      return handle.writeUcs2String(req, data);\n+    default:\n+      return handle.writeBuffer(req, Buffer.from(data, encoding));\n+  }\n+}\n+\n+function createWriteWrap(handle, oncomplete) {\n+  var req = new WriteWrap();\n+\n+  req.handle = handle;\n+  req.oncomplete = oncomplete;\n+  req.async = false;\n+\n+  return req;\n+}\n+\n+function writevGeneric(self, req, data, cb) {\n+  var allBuffers = data.allBuffers;\n+  var chunks;\n+  var i;\n+  if (allBuffers) {\n+    chunks = data;\n+    for (i = 0; i < data.length; i++)\n+      data[i] = data[i].chunk;\n+  } else {\n+    chunks = new Array(data.length << 1);\n+    for (i = 0; i < data.length; i++) {\n+      var entry = data[i];\n+      chunks[i * 2] = entry.chunk;\n+      chunks[i * 2 + 1] = entry.encoding;\n+    }\n+  }\n+  var err = req.handle.writev(req, chunks, allBuffers);\n+\n+  // Retain chunks\n+  if (err === 0) req._chunks = chunks;\n+\n+  if (err)\n+    return self.destroy(errnoException(err, 'write', req.error), cb);\n+}\n+\n+function writeGeneric(self, req, data, encoding, cb) {\n+  var err = handleWriteReq(req, data, encoding);\n+\n+  if (err)\n+    return self.destroy(errnoException(err, 'write', req.error), cb);\n+}\n+\n+module.exports = {\n+  createWriteWrap,\n+  writevGeneric,\n+  writeGeneric\n+};"
        },
        {
            "sha": "c9116fb1a80a8100cf7f6797c1d94d7da0d10eeb",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 14,
            "deletions": 60,
            "changes": 74,
            "blob_url": "https://github.com/nodejs/node/blob/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/c2835e5e4705d9e5740a8a88350923d8c227f203/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=c2835e5e4705d9e5740a8a88350923d8c227f203",
            "patch": "@@ -46,12 +46,17 @@ const { TCP, constants: TCPConstants } = process.binding('tcp_wrap');\n const { Pipe, constants: PipeConstants } = process.binding('pipe_wrap');\n const { TCPConnectWrap } = process.binding('tcp_wrap');\n const { PipeConnectWrap } = process.binding('pipe_wrap');\n-const { ShutdownWrap, WriteWrap } = process.binding('stream_wrap');\n+const { ShutdownWrap } = process.binding('stream_wrap');\n const {\n   newAsyncId,\n   defaultTriggerAsyncIdScope,\n   symbols: { async_id_symbol }\n } = require('internal/async_hooks');\n+const {\n+  createWriteWrap,\n+  writevGeneric,\n+  writeGeneric\n+} = require('internal/stream_base_commons');\n const errors = require('internal/errors');\n const {\n   ERR_INVALID_ADDRESS_FAMILY,\n@@ -740,38 +745,15 @@ Socket.prototype._writeGeneric = function(writev, data, encoding, cb) {\n     return false;\n   }\n \n-  var req = new WriteWrap();\n-  req.handle = this._handle;\n-  req.oncomplete = afterWrite;\n-  req.async = false;\n-  var err;\n-\n-  if (writev) {\n-    var allBuffers = data.allBuffers;\n-    var chunks;\n-    var i;\n-    if (allBuffers) {\n-      chunks = data;\n-      for (i = 0; i < data.length; i++)\n-        data[i] = data[i].chunk;\n-    } else {\n-      chunks = new Array(data.length << 1);\n-      for (i = 0; i < data.length; i++) {\n-        var entry = data[i];\n-        chunks[i * 2] = entry.chunk;\n-        chunks[i * 2 + 1] = entry.encoding;\n-      }\n-    }\n-    err = this._handle.writev(req, chunks, allBuffers);\n-\n-    // Retain chunks\n-    if (err === 0) req._chunks = chunks;\n-  } else {\n-    err = createWriteReq(req, this._handle, data, encoding);\n-  }\n+  var ret;\n+  var req = createWriteWrap(this._handle, afterWrite);\n+  if (writev)\n+    ret = writevGeneric(this, req, data, cb);\n+  else\n+    ret = writeGeneric(this, req, data, encoding, cb);\n \n-  if (err)\n-    return this.destroy(errnoException(err, 'write', req.error), cb);\n+  // Bail out if handle.write* returned an error\n+  if (ret) return ret;\n \n   this._bytesDispatched += req.bytes;\n \n@@ -794,34 +776,6 @@ Socket.prototype._write = function(data, encoding, cb) {\n   this._writeGeneric(false, data, encoding, cb);\n };\n \n-function createWriteReq(req, handle, data, encoding) {\n-  switch (encoding) {\n-    case 'latin1':\n-    case 'binary':\n-      return handle.writeLatin1String(req, data);\n-\n-    case 'buffer':\n-      return handle.writeBuffer(req, data);\n-\n-    case 'utf8':\n-    case 'utf-8':\n-      return handle.writeUtf8String(req, data);\n-\n-    case 'ascii':\n-      return handle.writeAsciiString(req, data);\n-\n-    case 'ucs2':\n-    case 'ucs-2':\n-    case 'utf16le':\n-    case 'utf-16le':\n-      return handle.writeUcs2String(req, data);\n-\n-    default:\n-      return handle.writeBuffer(req, Buffer.from(data, encoding));\n-  }\n-}\n-\n-\n protoGetter('bytesWritten', function bytesWritten() {\n   var bytes = this._bytesDispatched;\n   const state = this._writableState;"
        },
        {
            "sha": "23c6e339856ea933121f6544842c0c3a4cd64b35",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/c2835e5e4705d9e5740a8a88350923d8c227f203/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/c2835e5e4705d9e5740a8a88350923d8c227f203/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=c2835e5e4705d9e5740a8a88350923d8c227f203",
            "patch": "@@ -144,6 +144,7 @@\n       'lib/internal/v8_prof_polyfill.js',\n       'lib/internal/v8_prof_processor.js',\n       'lib/internal/vm/Module.js',\n+      'lib/internal/stream_base_commons.js',\n       'lib/internal/streams/lazy_transform.js',\n       'lib/internal/streams/async_iterator.js',\n       'lib/internal/streams/BufferList.js',"
        }
    ],
    "stats": {
        "total": 215,
        "additions": 108,
        "deletions": 107
    }
}