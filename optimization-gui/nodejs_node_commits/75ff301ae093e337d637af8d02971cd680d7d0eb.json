{
    "author": "danbev",
    "message": "src: make AsyncWrap constructors delegate\n\nCurrently, there is an AsyncWrap constructor that is only used by\nPromiseWrap. This constructor has a body which is very similar\nto the other AsyncWrap constructor.\n\nThis commit suggests updating the private constructor that is used\nby PromiseWrap and also have the second constructor delegate to this\none to avoid the code duplication.\n\nPR-URL: https://github.com/nodejs/node/pull/19366\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "75ff301ae093e337d637af8d02971cd680d7d0eb",
    "files": [
        {
            "sha": "90b532d73b8f061a3477e5dc3aba98a327a0c4d1",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 16,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/75ff301ae093e337d637af8d02971cd680d7d0eb/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/75ff301ae093e337d637af8d02971cd680d7d0eb/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=75ff301ae093e337d637af8d02971cd680d7d0eb",
            "patch": "@@ -228,7 +228,7 @@ void AsyncWrap::EmitAfter(Environment* env, double async_id) {\n class PromiseWrap : public AsyncWrap {\n  public:\n   PromiseWrap(Environment* env, Local<Object> object, bool silent)\n-      : AsyncWrap(env, object, silent) {\n+      : AsyncWrap(env, object, PROVIDER_PROMISE, -1, silent) {\n     MakeWeak(this);\n   }\n   size_t self_size() const override { return sizeof(*this); }\n@@ -582,32 +582,23 @@ AsyncWrap::AsyncWrap(Environment* env,\n                      Local<Object> object,\n                      ProviderType provider,\n                      double execution_async_id)\n-    : BaseObject(env, object),\n-      provider_type_(provider) {\n-  CHECK_NE(provider, PROVIDER_NONE);\n-  CHECK_GE(object->InternalFieldCount(), 1);\n+    : AsyncWrap(env, object, provider, execution_async_id, false) {}\n \n-  // Shift provider value over to prevent id collision.\n-  persistent().SetWrapperClassId(NODE_ASYNC_ID_OFFSET + provider);\n-\n-  // Use AsyncReset() call to execute the init() callbacks.\n-  AsyncReset(execution_async_id);\n-}\n-\n-\n-// This is specifically used by the PromiseWrap constructor.\n AsyncWrap::AsyncWrap(Environment* env,\n                      Local<Object> object,\n+                     ProviderType provider,\n+                     double execution_async_id,\n                      bool silent)\n     : BaseObject(env, object),\n-      provider_type_(PROVIDER_PROMISE) {\n+      provider_type_(provider) {\n+  CHECK_NE(provider, PROVIDER_NONE);\n   CHECK_GE(object->InternalFieldCount(), 1);\n \n   // Shift provider value over to prevent id collision.\n   persistent().SetWrapperClassId(NODE_ASYNC_ID_OFFSET + provider_type_);\n \n   // Use AsyncReset() call to execute the init() callbacks.\n-  AsyncReset(-1, silent);\n+  AsyncReset(execution_async_id, silent);\n }\n \n "
        },
        {
            "sha": "baaebb2a8b17d4d68201aff9811b6a0707ba086e",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/75ff301ae093e337d637af8d02971cd680d7d0eb/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/75ff301ae093e337d637af8d02971cd680d7d0eb/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=75ff301ae093e337d637af8d02971cd680d7d0eb",
            "patch": "@@ -185,8 +185,11 @@ class AsyncWrap : public BaseObject {\n  private:\n   friend class PromiseWrap;\n \n-  // This is specifically used by the PromiseWrap constructor.\n-  AsyncWrap(Environment* env, v8::Local<v8::Object> promise, bool silent);\n+  AsyncWrap(Environment* env,\n+            v8::Local<v8::Object> promise,\n+            ProviderType provider,\n+            double execution_async_id,\n+            bool silent);\n   inline AsyncWrap();\n   const ProviderType provider_type_;\n   // Because the values may be Reset(), cannot be made const."
        }
    ],
    "stats": {
        "total": 30,
        "additions": 12,
        "deletions": 18
    }
}