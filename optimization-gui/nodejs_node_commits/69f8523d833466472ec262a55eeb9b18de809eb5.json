{
    "author": "danbev",
    "message": "src: add extractPromiseWrap function\n\nCurrently PromiseHook extracts the PromiseWrap from a Local<Promise> in\ntwo places. This commit extracts that code into a function instead.\n\nPR-URL: https://github.com/nodejs/node/pull/19340\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "69f8523d833466472ec262a55eeb9b18de809eb5",
    "files": [
        {
            "sha": "599b4b8dcf9e2122b4f078c1bfc4768335e856e3",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/69f8523d833466472ec262a55eeb9b18de809eb5/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/69f8523d833466472ec262a55eeb9b18de809eb5/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=69f8523d833466472ec262a55eeb9b18de809eb5",
            "patch": "@@ -275,31 +275,28 @@ void PromiseWrap::getIsChainedPromise(Local<String> property,\n     info.Holder()->GetInternalField(kIsChainedPromiseField));\n }\n \n-static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n-                        Local<Value> parent, void* arg) {\n-  Environment* env = static_cast<Environment*>(arg);\n+static PromiseWrap* extractPromiseWrap(Local<Promise> promise) {\n   Local<Value> resource_object_value = promise->GetInternalField(0);\n-  PromiseWrap* wrap = nullptr;\n   if (resource_object_value->IsObject()) {\n-    Local<Object> resource_object = resource_object_value.As<Object>();\n-    wrap = Unwrap<PromiseWrap>(resource_object);\n+    return Unwrap<PromiseWrap>(resource_object_value.As<Object>());\n   }\n+  return nullptr;\n+}\n \n+static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n+                        Local<Value> parent, void* arg) {\n+  Environment* env = static_cast<Environment*>(arg);\n+  PromiseWrap* wrap = extractPromiseWrap(promise);\n   if (type == PromiseHookType::kInit || wrap == nullptr) {\n     bool silent = type != PromiseHookType::kInit;\n-    PromiseWrap* parent_wrap = nullptr;\n \n     // set parent promise's async Id as this promise's triggerAsyncId\n     if (parent->IsPromise()) {\n       // parent promise exists, current promise\n       // is a chained promise, so we set parent promise's id as\n       // current promise's triggerAsyncId\n       Local<Promise> parent_promise = parent.As<Promise>();\n-      Local<Value> parent_resource = parent_promise->GetInternalField(0);\n-      if (parent_resource->IsObject()) {\n-        parent_wrap = Unwrap<PromiseWrap>(parent_resource.As<Object>());\n-      }\n-\n+      PromiseWrap* parent_wrap = extractPromiseWrap(parent_promise);\n       if (parent_wrap == nullptr) {\n         parent_wrap = PromiseWrap::New(env, parent_promise, nullptr, true);\n       }"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 9,
        "deletions": 12
    }
}