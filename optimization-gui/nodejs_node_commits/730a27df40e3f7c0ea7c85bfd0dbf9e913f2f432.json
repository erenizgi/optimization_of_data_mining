{
    "author": "addaleax",
    "message": "src: pass along errors from http2 object creation\n\nPR-URL: https://github.com/nodejs/node/pull/25822\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>",
    "sha": "730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432",
    "files": [
        {
            "sha": "19c3e77fa76af8faab842854d33fce5a33b8c56a",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 71,
            "deletions": 54,
            "changes": 125,
            "blob_url": "https://github.com/nodejs/node/blob/730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432",
            "patch": "@@ -228,27 +228,18 @@ void Http2Session::Http2Settings::Init() {\n   count_ = n;\n }\n \n-Http2Session::Http2Settings::Http2Settings(Environment* env,\n-    Http2Session* session, uint64_t start_time)\n-        : AsyncWrap(env,\n-                    env->http2settings_constructor_template()\n-                        ->NewInstance(env->context())\n-                            .ToLocalChecked(),\n-                    PROVIDER_HTTP2SETTINGS),\n-          session_(session),\n-          startTime_(start_time) {\n-  Init();\n-}\n-\n-\n-Http2Session::Http2Settings::Http2Settings(Environment* env)\n-  : Http2Settings(env, nullptr, 0) {}\n-\n // The Http2Settings class is used to configure a SETTINGS frame that is\n // to be sent to the connected peer. The settings are set using a TypedArray\n // that is shared with the JavaScript side.\n-Http2Session::Http2Settings::Http2Settings(Http2Session* session)\n-  : Http2Settings(session->env(), session, uv_hrtime()) {}\n+Http2Session::Http2Settings::Http2Settings(Environment* env,\n+                                           Http2Session* session,\n+                                           Local<Object> obj,\n+                                           uint64_t start_time)\n+    : AsyncWrap(env, obj, PROVIDER_HTTP2SETTINGS),\n+      session_(session),\n+      startTime_(start_time) {\n+  Init();\n+}\n \n // Generates a Buffer that contains the serialized payload of a SETTINGS\n // frame. This can be used, for instance, to create the Base64-encoded\n@@ -918,13 +909,14 @@ int Http2Session::OnBeginHeadersCallback(nghttp2_session* handle,\n   // The common case is that we're creating a new stream. The less likely\n   // case is that we're receiving a set of trailers\n   if (LIKELY(stream == nullptr)) {\n-    if (UNLIKELY(!session->CanAddStream())) {\n+    if (UNLIKELY(!session->CanAddStream() ||\n+                 Http2Stream::New(session, id, frame->headers.cat) ==\n+                     nullptr)) {\n       // Too many concurrent streams being opened\n       nghttp2_submit_rst_stream(**session, NGHTTP2_FLAG_NONE, id,\n                                 NGHTTP2_ENHANCE_YOUR_CALM);\n       return NGHTTP2_ERR_TEMPORAL_CALLBACK_FAILURE;\n     }\n-    new Http2Stream(session, id, frame->headers.cat);\n   } else if (!stream->IsDestroyed()) {\n     stream->StartHeaders(frame->headers.cat);\n   }\n@@ -1771,7 +1763,7 @@ Http2Stream* Http2Session::SubmitRequest(\n   *ret = nghttp2_submit_request(session_, prispec, nva, len, *prov, nullptr);\n   CHECK_NE(*ret, NGHTTP2_ERR_NOMEM);\n   if (LIKELY(*ret > 0))\n-    stream = new Http2Stream(this, *ret, NGHTTP2_HCAT_HEADERS, options);\n+    stream = Http2Stream::New(this, *ret, NGHTTP2_HCAT_HEADERS, options);\n   return stream;\n }\n \n@@ -1857,20 +1849,30 @@ void Http2Session::Consume(Local<External> external) {\n   Debug(this, \"i/o stream consumed\");\n }\n \n-\n-Http2Stream::Http2Stream(\n-    Http2Session* session,\n-    int32_t id,\n-    nghttp2_headers_category category,\n-    int options) : AsyncWrap(session->env(),\n-                             session->env()->http2stream_constructor_template()\n-                                 ->NewInstance(session->env()->context())\n-                                     .ToLocalChecked(),\n-                             AsyncWrap::PROVIDER_HTTP2STREAM),\n-                   StreamBase(session->env()),\n-                   session_(session),\n-                   id_(id),\n-                   current_headers_category_(category) {\n+Http2Stream* Http2Stream::New(Http2Session* session,\n+                              int32_t id,\n+                              nghttp2_headers_category category,\n+                              int options) {\n+  Local<Object> obj;\n+  if (!session->env()\n+           ->http2stream_constructor_template()\n+           ->NewInstance(session->env()->context())\n+           .ToLocal(&obj)) {\n+    return nullptr;\n+  }\n+  return new Http2Stream(session, obj, id, category, options);\n+}\n+\n+Http2Stream::Http2Stream(Http2Session* session,\n+                         Local<Object> obj,\n+                         int32_t id,\n+                         nghttp2_headers_category category,\n+                         int options)\n+    : AsyncWrap(session->env(), obj, AsyncWrap::PROVIDER_HTTP2STREAM),\n+      StreamBase(session->env()),\n+      session_(session),\n+      id_(id),\n+      current_headers_category_(category) {\n   MakeWeak();\n   statistics_.start_time = uv_hrtime();\n \n@@ -2113,7 +2115,7 @@ Http2Stream* Http2Stream::SubmitPushPromise(nghttp2_nv* nva,\n   CHECK_NE(*ret, NGHTTP2_ERR_NOMEM);\n   Http2Stream* stream = nullptr;\n   if (*ret > 0)\n-    stream = new Http2Stream(session_, *ret, NGHTTP2_HCAT_HEADERS, options);\n+    stream = Http2Stream::New(session_, *ret, NGHTTP2_HCAT_HEADERS, options);\n \n   return stream;\n }\n@@ -2335,7 +2337,14 @@ void HttpErrorString(const FunctionCallbackInfo<Value>& args) {\n // output for an HTTP2-Settings header field.\n void PackSettings(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n-  Http2Session::Http2Settings settings(env);\n+  // TODO(addaleax): We should not be creating a full AsyncWrap for this.\n+  Local<Object> obj;\n+  if (!env->http2settings_constructor_template()\n+           ->NewInstance(env->context())\n+           .ToLocal(&obj)) {\n+    return;\n+  }\n+  Http2Session::Http2Settings settings(env, nullptr, obj);\n   args.GetReturnValue().Set(settings.Pack());\n }\n \n@@ -2464,7 +2473,7 @@ void Http2Session::Request(const FunctionCallbackInfo<Value>& args) {\n       session->Http2Session::SubmitRequest(*priority, *list, list.length(),\n                                            &ret, options);\n \n-  if (ret <= 0) {\n+  if (ret <= 0 || stream == nullptr) {\n     Debug(session, \"could not submit request: %s\", nghttp2_strerror(ret));\n     return args.GetReturnValue().Set(ret);\n   }\n@@ -2637,7 +2646,7 @@ void Http2Stream::PushPromise(const FunctionCallbackInfo<Value>& args) {\n   int32_t ret = 0;\n   Http2Stream* stream = parent->SubmitPushPromise(*list, list.length(),\n                                                   &ret, options);\n-  if (ret <= 0) {\n+  if (ret <= 0 || stream == nullptr) {\n     Debug(parent, \"failed to create push stream: %d\", ret);\n     return args.GetReturnValue().Set(ret);\n   }\n@@ -2772,9 +2781,15 @@ void Http2Session::Ping(const FunctionCallbackInfo<Value>& args) {\n     CHECK_EQ(Buffer::Length(args[0]), 8);\n   }\n \n-  Http2Session::Http2Ping* ping = new Http2Ping(session);\n-  Local<Object> obj = ping->object();\n-  obj->Set(env->context(), env->ondone_string(), args[1]).FromJust();\n+  Local<Object> obj;\n+  if (!env->http2ping_constructor_template()\n+           ->NewInstance(env->context())\n+           .ToLocal(&obj)) {\n+    return;\n+  }\n+  if (obj->Set(env->context(), env->ondone_string(), args[1]).IsNothing())\n+    return;\n+  Http2Session::Http2Ping* ping = new Http2Ping(session, obj);\n \n   // To prevent abuse, we strictly limit the number of unacknowledged PING\n   // frames that may be sent at any given time. This is configurable in the\n@@ -2798,10 +2813,17 @@ void Http2Session::Settings(const FunctionCallbackInfo<Value>& args) {\n   Http2Session* session;\n   ASSIGN_OR_RETURN_UNWRAP(&session, args.Holder());\n \n-  Http2Session::Http2Settings* settings = new Http2Settings(session);\n-  Local<Object> obj = settings->object();\n-  obj->Set(env->context(), env->ondone_string(), args[0]).FromJust();\n+  Local<Object> obj;\n+  if (!env->http2settings_constructor_template()\n+           ->NewInstance(env->context())\n+           .ToLocal(&obj)) {\n+    return;\n+  }\n+  if (obj->Set(env->context(), env->ondone_string(), args[0]).IsNothing())\n+    return;\n \n+  Http2Session::Http2Settings* settings =\n+      new Http2Settings(session->env(), session, obj, 0);\n   if (!session->AddSettings(settings)) {\n     settings->Done(false);\n     return args.GetReturnValue().Set(false);\n@@ -2848,15 +2870,10 @@ bool Http2Session::AddSettings(Http2Session::Http2Settings* settings) {\n   return true;\n }\n \n-Http2Session::Http2Ping::Http2Ping(\n-    Http2Session* session)\n-        : AsyncWrap(session->env(),\n-                    session->env()->http2ping_constructor_template()\n-                        ->NewInstance(session->env()->context())\n-                            .ToLocalChecked(),\n-                    AsyncWrap::PROVIDER_HTTP2PING),\n-          session_(session),\n-          startTime_(uv_hrtime()) { }\n+Http2Session::Http2Ping::Http2Ping(Http2Session* session, Local<Object> obj)\n+    : AsyncWrap(session->env(), obj, AsyncWrap::PROVIDER_HTTP2PING),\n+      session_(session),\n+      startTime_(uv_hrtime()) {}\n \n void Http2Session::Http2Ping::Send(uint8_t* payload) {\n   uint8_t data[8];"
        },
        {
            "sha": "fb90e3ed85111cd1930d1ede33970064e9c0ab8b",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=730a27df40e3f7c0ea7c85bfd0dbf9e913f2f432",
            "patch": "@@ -451,10 +451,11 @@ class Http2StreamListener : public StreamListener {\n class Http2Stream : public AsyncWrap,\n                     public StreamBase {\n  public:\n-  Http2Stream(Http2Session* session,\n-              int32_t id,\n-              nghttp2_headers_category category = NGHTTP2_HCAT_HEADERS,\n-              int options = 0);\n+  static Http2Stream* New(\n+      Http2Session* session,\n+      int32_t id,\n+      nghttp2_headers_category category = NGHTTP2_HCAT_HEADERS,\n+      int options = 0);\n   ~Http2Stream() override;\n \n   nghttp2_stream* operator*();\n@@ -611,6 +612,12 @@ class Http2Stream : public AsyncWrap,\n   Statistics statistics_ = {};\n \n  private:\n+  Http2Stream(Http2Session* session,\n+              v8::Local<v8::Object> obj,\n+              int32_t id,\n+              nghttp2_headers_category category,\n+              int options);\n+\n   Http2Session* session_ = nullptr;             // The Parent HTTP/2 Session\n   int32_t id_ = 0;                              // The Stream Identifier\n   int32_t code_ = NGHTTP2_NO_ERROR;             // The RST_STREAM code (if any)\n@@ -1076,7 +1083,7 @@ class Http2StreamPerformanceEntry : public PerformanceEntry {\n \n class Http2Session::Http2Ping : public AsyncWrap {\n  public:\n-  explicit Http2Ping(Http2Session* session);\n+  explicit Http2Ping(Http2Session* session, v8::Local<v8::Object> obj);\n \n   void MemoryInfo(MemoryTracker* tracker) const override {\n     tracker->TrackField(\"session\", session_);\n@@ -1100,8 +1107,10 @@ class Http2Session::Http2Ping : public AsyncWrap {\n // structs.\n class Http2Session::Http2Settings : public AsyncWrap {\n  public:\n-  explicit Http2Settings(Environment* env);\n-  explicit Http2Settings(Http2Session* session);\n+  Http2Settings(Environment* env,\n+                Http2Session* session,\n+                v8::Local<v8::Object> obj,\n+                uint64_t start_time = uv_hrtime());\n \n   void MemoryInfo(MemoryTracker* tracker) const override {\n     tracker->TrackField(\"session\", session_);\n@@ -1125,7 +1134,6 @@ class Http2Session::Http2Settings : public AsyncWrap {\n                      get_setting fn);\n \n  private:\n-  Http2Settings(Environment* env, Http2Session* session, uint64_t start_time);\n   void Init();\n   Http2Session* session_;\n   uint64_t startTime_;"
        }
    ],
    "stats": {
        "total": 149,
        "additions": 87,
        "deletions": 62
    }
}