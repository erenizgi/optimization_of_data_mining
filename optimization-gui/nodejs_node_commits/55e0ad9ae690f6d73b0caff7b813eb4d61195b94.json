{
    "author": "LakshmiSwethaG",
    "message": "test: add node-report tests\n\nOne test per each API, so that additional tests in future are modular.\ntest/common/report.js contain common functions  that tests leverage.\n\nPR-URL: https://github.com/nodejs/node/pull/22712\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <Michael_Dawson@ca.ibm.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>",
    "sha": "55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
    "files": [
        {
            "sha": "48c3f5a2e7e80ae30beb066af98ccf48581e4505",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -2233,6 +2233,12 @@ size.\n This `Error` is thrown when a read is attempted on a TTY `WriteStream`,\n such as `process.stdout.on('data')`.\n \n+<a id=\"ERR_SYNTHETIC\"></a>\n+#### ERR_SYNTHETIC\n+\n+An artifical error object used to capture call stack when diagnostic report\n+is produced.\n+\n \n [`'uncaughtException'`]: process.html#process_event_uncaughtexception\n [`--force-fips`]: cli.html#cli_force_fips"
        },
        {
            "sha": "f8d7aafeec164d4d2bd5efeeca04575112bc006f",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -709,7 +709,6 @@ E('ERR_INSPECTOR_CLOSED', 'Session was closed', Error);\n E('ERR_INSPECTOR_NOT_AVAILABLE', 'Inspector is not available', Error);\n E('ERR_INSPECTOR_NOT_CONNECTED', 'Session is not connected', Error);\n E('ERR_INVALID_ADDRESS_FAMILY', 'Invalid address family: %s', RangeError);\n-E('ERR_SYNTHETIC', 'JavaScript Callstack: %s', Error);\n E('ERR_INVALID_ARG_TYPE',\n   (name, expected, actual) => {\n     assert(typeof name === 'string', \"'name' must be a string\");\n@@ -924,6 +923,7 @@ E('ERR_STREAM_UNSHIFT_AFTER_END_EVENT',\n   'stream.unshift() after end event', Error);\n E('ERR_STREAM_WRAP', 'Stream has StringDecoder set or is in objectMode', Error);\n E('ERR_STREAM_WRITE_AFTER_END', 'write after end', Error);\n+E('ERR_SYNTHETIC', 'JavaScript Callstack: %s', Error);\n E('ERR_SYSTEM_ERROR', 'A system error occurred', SystemError);\n E('ERR_TLS_CERT_ALTNAME_INVALID',\n   'Hostname/IP does not match certificate\\'s altnames: %s', Error);"
        },
        {
            "sha": "e7df290c3e71b6b2951a7b0fe5fe0b708273541e",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -632,6 +632,12 @@ function skipIfInspectorDisabled() {\n   }\n }\n \n+function skipIfReportDisabled() {\n+  if (!process.config.variables.node_report) {\n+    skip('Node Report is disabled');\n+  }\n+}\n+\n function skipIf32Bits() {\n   if (bits < 64) {\n     skip('The tested feature is not available in 32bit builds');\n@@ -758,6 +764,7 @@ module.exports = {\n   skipIf32Bits,\n   skipIfEslintMissing,\n   skipIfInspectorDisabled,\n+  skipIfReportDisabled,\n   skipIfWorker,\n \n   get localhostIPv6() { return '::1'; },"
        },
        {
            "sha": "646660da4961f7925d50302e405a091a521355b3",
            "filename": "test/common/report.js",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fcommon%2Freport.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fcommon%2Freport.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Freport.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,43 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+\n+const REPORT_SECTIONS = [ 'header',\n+                          'javascriptStack',\n+                          'nativeStack',\n+                          'javascriptHeap',\n+                          'libuv',\n+                          'environmentVariables',\n+                          'sharedObjects' ];\n+\n+let tmppath = '';\n+\n+exports.findReports = (pid, path) => {\n+  // Default filenames are of the form\n+  // report.<date>.<time>.<pid>.<seq>.json\n+  tmppath = path;\n+  const format = '^report\\\\.\\\\d+\\\\.\\\\d+\\\\.' + pid + '\\\\.\\\\d+\\\\.json$';\n+  const filePattern = new RegExp(format);\n+  const files = fs.readdirSync(path);\n+  return files.filter((file) => filePattern.test(file));\n+};\n+\n+exports.validate = (report, options) => {\n+  const jtmp = path.join(tmppath, report);\n+  fs.readFile(jtmp, (err, data) => {\n+    this.validateContent(data, options);\n+  });\n+};\n+\n+\n+exports.validateContent = function validateContent(data, options) {\n+  const report = JSON.parse(data);\n+  const comp = Object.keys(report);\n+\n+  // Check all sections are present\n+  REPORT_SECTIONS.forEach((section) => {\n+    assert.ok(comp.includes(section));\n+  });\n+};"
        },
        {
            "sha": "178469412d11fdd10602c47e9b23a48f6db89036",
            "filename": "test/node-report/test-api-getreport.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-getreport.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-getreport.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-getreport.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,28 @@\n+'use strict';\n+\n+// Testcase for returning report as a string via API call\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+const assert = require('assert');\n+if (process.argv[2] === 'child') {\n+  console.log(process.report.getReport());\n+} else {\n+  const helper = require('../common/report.js');\n+  const spawnSync = require('child_process').spawnSync;\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+\n+  const args = ['--experimental-report', __filename, 'child'];\n+  const child = spawnSync(process.execPath, args, { cwd: tmpdir.path });\n+  const report_msg = 'Found report files';\n+  const std_msg = 'Found messages on stderr';\n+  assert.ok(child.stderr.toString().includes(\n+    `(node:${child.pid}) ExperimentalWarning: report is an` +\n+    ' experimental feature. This feature could change at any time'), std_msg);\n+  const reportFiles = helper.findReports(child.pid, tmpdir.path);\n+  assert.deepStrictEqual(reportFiles, [], report_msg);\n+  helper.validateContent(child.stdout, { pid: child.pid,\n+                                         commandline: process.execPath +\n+                                         ' ' + args.join(' ')\n+  });\n+}"
        },
        {
            "sha": "8b497e0663aa861b21861d36bc2c2cc7687fe2a2",
            "filename": "test/node-report/test-api-nohooks.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-nohooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-nohooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-nohooks.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+// Testcase to produce report via API call, using the no-hooks/no-signal\n+// interface - i.e. require('node-report/api')\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+if (process.argv[2] === 'child') {\n+  process.report.triggerReport();\n+} else {\n+  const helper = require('../common/report.js');\n+  const spawn = require('child_process').spawn;\n+  const assert = require('assert');\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+\n+  const child = spawn(process.execPath, ['--experimental-report',\n+                                         __filename, 'child'],\n+                      { cwd: tmpdir.path });\n+  child.on('exit', common.mustCall((code) => {\n+    const report_msg = 'No reports found';\n+    const process_msg = 'Process exited unexpectedly';\n+    assert.strictEqual(code, 0, process_msg + ':' + code);\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.strictEqual(reports.length, 1, report_msg);\n+    const report = reports[0];\n+    helper.validate(report, { pid: child.pid,\n+                              commandline: child.spawnargs.join(' ')\n+    });\n+  }));\n+}"
        },
        {
            "sha": "caac6c7e8676d53a074040574606a16089ae3c11",
            "filename": "test/node-report/test-api-pass-error.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-pass-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-pass-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-pass-error.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,33 @@\n+'use strict';\n+\n+// Testcase for passing an error object to the API call.\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+const assert = require('assert');\n+if (process.argv[2] === 'child') {\n+  try {\n+    throw new Error('Testing error handling');\n+  } catch {\n+    process.report.triggerReport();\n+  }\n+} else {\n+  const helper = require('../common/report.js');\n+  const spawn = require('child_process').spawn;\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const child = spawn(process.execPath, ['--experimental-report',\n+                                         __filename, 'child'],\n+                      { cwd: tmpdir.path });\n+  child.on('exit', common.mustCall((code) => {\n+    const report_msg = 'No reports found';\n+    const process_msg = 'Process exited unexpectedly';\n+    assert.strictEqual(code, 0, process_msg);\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.strictEqual(reports.length, 1, report_msg);\n+    const report = reports[0];\n+    helper.validate(report, { pid: child.pid,\n+                              commandline: child.spawnargs.join(' '),\n+                              expectedException: 'Testing error handling',\n+    });\n+  }));\n+}"
        },
        {
            "sha": "52f58b6e1355218f096f9f6bfa7ea44676c8947f",
            "filename": "test/node-report/test-api-uvhandles.js",
            "status": "added",
            "additions": 133,
            "deletions": 0,
            "changes": 133,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-uvhandles.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api-uvhandles.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-uvhandles.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,133 @@\n+'use strict';\n+\n+// Testcase to check reporting of uv handles.\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+if (process.argv[2] === 'child') {\n+  // Exit on loss of parent process\n+  const exit = () => process.exit(2);\n+  process.on('disconnect', exit);\n+\n+  const fs = require('fs');\n+  const http = require('http');\n+  const spawn = require('child_process').spawn;\n+\n+  // Watching files should result in fs_event/fs_poll uv handles.\n+  let watcher;\n+  try {\n+    watcher = fs.watch(__filename);\n+  } catch {\n+    // fs.watch() unavailable\n+  }\n+  fs.watchFile(__filename, () => {});\n+\n+  // Child should exist when this returns as child_process.pid must be set.\n+  const child_process = spawn(process.execPath,\n+                              ['-e', \"process.stdin.on('data', (x) => \" +\n+                                     'console.log(x.toString()));']);\n+\n+  const timeout = setInterval(() => {}, 1000);\n+  // Make sure the timer doesn't keep the test alive and let\n+  // us check we detect unref'd handles correctly.\n+  timeout.unref();\n+\n+  // Datagram socket for udp uv handles.\n+  const dgram = require('dgram');\n+  const udp_socket = dgram.createSocket('udp4');\n+  udp_socket.bind({});\n+\n+  // Simple server/connection to create tcp uv handles.\n+  const server = http.createServer((req, res) => {\n+    req.on('end', () => {\n+      // Generate the report while the connection is active.\n+      console.log(process.report.getReport());\n+      child_process.kill();\n+\n+      res.writeHead(200, { 'Content-Type': 'text/plain' });\n+      res.end();\n+\n+      // Tidy up to allow process to exit cleanly.\n+      server.close(() => {\n+        if (watcher) watcher.close();\n+        fs.unwatchFile(__filename);\n+        udp_socket.close();\n+        process.removeListener('disconnect', exit);\n+      });\n+    });\n+    req.resume();\n+  });\n+  server.listen(() => {\n+    const data = { pid: child_process.pid,\n+                   tcp_address: server.address(),\n+                   udp_address: udp_socket.address(),\n+                   skip_fs_watch: (watcher === undefined ?\n+                     'fs.watch() unavailable' :\n+                     false) };\n+    process.send(data);\n+    http.get({ port: server.address().port });\n+  });\n+} else {\n+  const helper = require('../common/report.js');\n+  const fork = require('child_process').fork;\n+  const assert = require('assert');\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const options = { encoding: 'utf8', silent: true, cwd: tmpdir.path };\n+  const child = fork('--experimental-report', [__filename, 'child'], options);\n+  let stderr = '';\n+  child.stderr.on('data', (chunk) => { stderr += chunk; });\n+  let stdout = '';\n+  const std_msg = 'Found messages in stderr unexpectedly: ';\n+  const report_msg = 'Report files were written: unexpectedly';\n+  child.stdout.on('data', (chunk) => { stdout += chunk; });\n+  child.on('exit', common.mustCall((code, signal) => {\n+    assert.deepStrictEqual(code, 0, 'Process exited unexpectedly with code' +\n+                           `${code}`);\n+    assert.deepStrictEqual(signal, null, 'Process should have exited cleanly,' +\n+                            ` but did not: ${signal}`);\n+    assert.ok(stderr.match(\n+      '(node:.*) ExperimentalWarning: report is an experimental' +\n+      ' feature. This feature could change at any time'),\n+              std_msg);\n+\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.deepStrictEqual(reports, [], report_msg, reports);\n+\n+    const report = JSON.parse(stdout);\n+    let fs = 0;\n+    let poll = 0;\n+    let process = 0;\n+    let timer = 0;\n+    let pipe = 0;\n+    let tcp = 0;\n+    let udp = 0;\n+    const fs_msg = 'fs_event not found';\n+    const poll_msg = 'poll_event not found';\n+    const process_msg = 'process event not found';\n+    const timer_msg = 'timer event not found';\n+    const pipe_msg = 'pipe event not found';\n+    const tcp_msg = 'tcp event not found';\n+    const udp_msg = 'udp event not found';\n+    for (const entry in report.libuv) {\n+      if (report.libuv[entry].type === 'fs_event') fs = 1;\n+      else if (report.libuv[entry].type === 'fs_poll') poll = 1;\n+      else if (report.libuv[entry].type === 'process') process = 1;\n+      else if (report.libuv[entry].type === 'timer') timer = 1;\n+      else if (report.libuv[entry].type === 'pipe') pipe = 1;\n+      else if (report.libuv[entry].type === 'tcp') tcp = 1;\n+      else if (report.libuv[entry].type === 'udp') udp = 1;\n+    }\n+    assert.deepStrictEqual(fs, 1, fs_msg);\n+    assert.deepStrictEqual(poll, 1, poll_msg);\n+    assert.deepStrictEqual(process, 1, process_msg);\n+    assert.deepStrictEqual(timer, 1, timer_msg);\n+    assert.deepStrictEqual(pipe, 1, pipe_msg);\n+    assert.deepStrictEqual(tcp, 1, tcp_msg);\n+    assert.deepStrictEqual(udp, 1, udp_msg);\n+\n+    // Common report tests.\n+    helper.validateContent(stdout, { pid: child.pid,\n+                                     commandline: child.spawnargs.join(' ')\n+    });\n+  }));\n+}"
        },
        {
            "sha": "9ffa66bb40c7b1aabcfefbeff97dd61fab19a88d",
            "filename": "test/node-report/test-api.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-api.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+// Testcase to produce report via API call\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+if (process.argv[2] === 'child') {\n+  process.report.triggerReport();\n+} else {\n+  const helper = require('../common/report.js');\n+  const spawn = require('child_process').spawn;\n+  const assert = require('assert');\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+\n+  const child = spawn(process.execPath,\n+                      ['--experimental-report', __filename, 'child'],\n+                      { cwd: tmpdir.path });\n+  child.on('exit', common.mustCall((code) => {\n+    const report_msg = 'No reports found';\n+    const process_msg = 'Process exited unexpectedly';\n+    assert.strictEqual(code, 0, process_msg + ':' + code);\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.strictEqual(reports.length, 1, report_msg);\n+    const report = reports[0];\n+    helper.validate(report, { pid: child.pid,\n+                              commandline: child.spawnargs.join(' ')\n+    });\n+  }));\n+}"
        },
        {
            "sha": "9e423ec29cd8ec4d2cb3ae249a54a037ccef478e",
            "filename": "test/node-report/test-exception.js",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-exception.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,44 @@\n+'use strict';\n+\n+// Testcase to produce report on uncaught exception\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+if (process.argv[2] === 'child') {\n+  function myException(request, response) {\n+    const m = '*** test-exception.js: throwing uncaught Error';\n+    throw new Error(m);\n+  }\n+\n+  myException();\n+\n+} else {\n+  const helper = require('../common/report.js');\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const spawn = require('child_process').spawn;\n+  const assert = require('assert');\n+\n+  const child = spawn(process.execPath,\n+                      ['--experimental-report',\n+                       '--diagnostic-report-uncaught-exception',\n+                       __filename, 'child'],\n+                      { cwd: tmpdir.path });\n+  // Capture stderr output from the child process\n+  let stderr = '';\n+  child.stderr.on('data', (chunk) => {\n+    stderr += chunk;\n+  });\n+  child.on('exit', common.mustCall((code) => {\n+    const report_msg = 'No reports found';\n+    const process_msg = 'Process exited unexpectedly';\n+    assert.strictEqual(code, 1, process_msg + ':' + code);\n+    assert.ok(new RegExp('myException').test(stderr),\n+              'Check for expected stack trace frame in stderr');\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.strictEqual(reports.length, 1, report_msg);\n+    const report = reports[0];\n+    helper.validate(report, { pid: child.pid,\n+                              commandline: child.spawnargs.join(' ')\n+    });\n+  }));\n+}"
        },
        {
            "sha": "3d830aa72f0f8d4f3e72e85372a87c651250d288",
            "filename": "test/node-report/test-fatal-error.js",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-fatal-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-fatal-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-fatal-error.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,44 @@\n+'use strict';\n+\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+const assert = require('assert');\n+// Testcase to produce report on fatal error (javascript heap OOM)\n+if (process.argv[2] === 'child') {\n+\n+  const list = [];\n+  while (true) {\n+    const record = new MyRecord();\n+    list.push(record);\n+  }\n+\n+  function MyRecord() {\n+    this.name = 'foo';\n+    this.id = 128;\n+    this.account = 98454324;\n+  }\n+} else {\n+  const helper = require('../common/report.js');\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const spawn = require('child_process').spawn;\n+  const args = ['--experimental-report',\n+                '--diagnostic-report-on-fatalerror',\n+                '--max-old-space-size=20',\n+                __filename,\n+                'child'];\n+  const child = spawn(process.execPath, args, { cwd: tmpdir.path });\n+  child.on('exit', common.mustCall((code) => {\n+    assert.notStrictEqual(code, 0, 'Process exited unexpectedly');\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.strictEqual(reports.length, 1);\n+    const report = reports[0];\n+    const options = { pid: child.pid };\n+    // Node.js currently overwrites the command line on AIX\n+    // https://github.com/nodejs/node/issues/10607\n+    if (!(common.isAIX || common.isSunOS)) {\n+      options.commandline = child.spawnargs.join(' ');\n+    }\n+    helper.validate(report, options);\n+  }));\n+}"
        },
        {
            "sha": "7368bb51c349c9da77699592a2cb7f9ae50b13a0",
            "filename": "test/node-report/test-signal.js",
            "status": "added",
            "additions": 80,
            "deletions": 0,
            "changes": 80,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-signal.js",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftest-signal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-signal.js?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,80 @@\n+'use strict';\n+// Testcase to produce report on signal interrupting a js busy-loop,\n+// showing it is interruptible.\n+const common = require('../common');\n+common.skipIfReportDisabled();\n+\n+if (common.isWindows) return common.skip('Unsupported on Windows.');\n+\n+if (process.argv[2] === 'child') {\n+  // Exit on loss of parent process\n+  const exit = () => process.exit(2);\n+  process.on('disconnect', exit);\n+\n+  function busyLoop() {\n+    setInterval(() => {\n+      const list = [];\n+      for (let i = 0; i < 1e3; i++) {\n+        for (let j = 0; j < 1000; j++) {\n+          list.push(new MyRecord());\n+        }\n+        for (let k = 0; k < 1000; k++) {\n+          list[k].id += 1;\n+          list[k].account += 2;\n+        }\n+        for (let l = 0; l < 1000; l++) {\n+          list.pop();\n+        }\n+      }\n+    }, 1000);\n+  }\n+\n+  function MyRecord() {\n+    this.name = 'foo';\n+    this.id = 128;\n+    this.account = 98454324;\n+  }\n+  process.send('child started', busyLoop);\n+\n+\n+} else {\n+  const helper = require('../common/report.js');\n+  const fork = require('child_process').fork;\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const assert = require('assert');\n+  if (common.isWindows) {\n+    assert.fail('Unsupported on Windows', { skip: true });\n+    return;\n+  }\n+  console.log(tmpdir.path);\n+  const options = { stdio: 'pipe', encoding: 'utf8', cwd: tmpdir.path };\n+  const child = fork('--experimental-report',\n+                     ['--diagnostic-report-on-signal', __filename, 'child'],\n+                     options);\n+  // Wait for child to indicate it is ready before sending signal\n+  child.on('message', () => child.kill('SIGUSR2'));\n+  let stderr = '';\n+  child.stderr.on('data', (chunk) => {\n+    stderr += chunk;\n+    // Terminate the child after the report has been written\n+    if (stderr.includes('Node.js report completed')) {\n+      child.kill('SIGTERM');\n+    }\n+  });\n+  child.on('exit', common.mustCall((code, signal) => {\n+    console.log('child exited');\n+    const report_msg = 'No reports found';\n+    const process_msg = 'Process exited unexpectedly';\n+    const signal_msg = 'Process exited with unexpected signal';\n+    assert.strictEqual(code, null, process_msg + ':' + code);\n+    assert.deepStrictEqual(signal, 'SIGTERM',\n+                           signal_msg + ':' + signal);\n+    const reports = helper.findReports(child.pid, tmpdir.path);\n+    assert.deepStrictEqual(reports.length, 1, report_msg);\n+    const report = reports[0];\n+    helper.validate(report, { pid: child.pid,\n+                              commandline: child.spawnargs.join(' ')\n+    });\n+  }));\n+}"
        },
        {
            "sha": "e5ea1f57a035b3c196e4cc719a11a2443ca22387",
            "filename": "test/node-report/testcfg.py",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftestcfg.py",
            "raw_url": "https://github.com/nodejs/node/raw/55e0ad9ae690f6d73b0caff7b813eb4d61195b94/test%2Fnode-report%2Ftestcfg.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftestcfg.py?ref=55e0ad9ae690f6d73b0caff7b813eb4d61195b94",
            "patch": "@@ -0,0 +1,6 @@\n+import sys, os\n+sys.path.append(os.path.join(os.path.dirname(__file__), '..'))\n+import testpy\n+\n+def GetConfiguration(context, root):\n+  return testpy.ParallelTestConfiguration(context, root, 'node-report')"
        }
    ],
    "stats": {
        "total": 485,
        "additions": 484,
        "deletions": 1
    }
}