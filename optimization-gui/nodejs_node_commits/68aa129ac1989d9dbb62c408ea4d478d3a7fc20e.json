{
    "author": "targos",
    "message": "deps: cherry-pick 907d7bc from upstream V8\n\nOriginal commit message:\n\n    [promise] Implement Swallowed Rejection Hook.\n\n    This extends the current Promise Rejection Hook with two new events\n\n      kPromiseRejectAfterResolved\n      kPromiseResolveAfterResolved\n\n    which are used to detect (and signal) misuse of the Promise constructor.\n    Specifically the common bug like\n\n      new Promise((res, rej) => {\n        res(1);\n        throw new Error(\"something\")\n      });\n\n    where the error is silently swallowed by the Promise constructor without\n    the user ever noticing can be caught via this hook.\n\n    Doc: https://goo.gl/2stLUY\n    Bug: v8:7919\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: I890a7e766cdd1be88db94844fb744f72823dba33\n    Reviewed-on: https://chromium-review.googlesource.com/1126099\n    Reviewed-by: Maya Lekova <mslekova@chromium.org>\n    Reviewed-by: Benedikt Meurer <bmeurer@chromium.org>\n    Reviewed-by: Yang Guo <yangguo@chromium.org>\n    Commit-Queue: Benedikt Meurer <bmeurer@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#54309}\n\nRefs: https://github.com/v8/v8/commit/907d7bcd18c13a04a14eea6699e54167494bf9f9\n\nPR-URL: https://github.com/nodejs/node/pull/21838\nRefs: https://github.com/nodejs/promises-debugging/issues/8\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>",
    "sha": "68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
    "files": [
        {
            "sha": "adad6f6b736c8f064f6eb92fd293c3d209e3d56c",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.9',\n+    'v8_embedder_string': '-node.10',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "2bacd1a48097a36ae9b3c0b66f2638d111856658",
            "filename": "deps/v8/include/v8.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Finclude%2Fv8.h",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Finclude%2Fv8.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8.h?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -6520,7 +6520,9 @@ typedef void (*PromiseHook)(PromiseHookType type, Local<Promise> promise,\n // --- Promise Reject Callback ---\n enum PromiseRejectEvent {\n   kPromiseRejectWithNoHandler = 0,\n-  kPromiseHandlerAddedAfterReject = 1\n+  kPromiseHandlerAddedAfterReject = 1,\n+  kPromiseRejectAfterResolved = 2,\n+  kPromiseResolveAfterResolved = 3,\n };\n \n class PromiseRejectMessage {"
        },
        {
            "sha": "aef9e40ac8435e8beb03201341783d573e4b744e",
            "filename": "deps/v8/src/builtins/builtins-promise-gen.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 6,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.cc?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -246,6 +246,8 @@ Node* PromiseBuiltinsAssembler::CreatePromiseResolvingFunctionsContext(\n   Node* const context =\n       CreatePromiseContext(native_context, kPromiseContextLength);\n   StoreContextElementNoWriteBarrier(context, kPromiseSlot, promise);\n+  StoreContextElementNoWriteBarrier(context, kAlreadyResolvedSlot,\n+                                    FalseConstant());\n   StoreContextElementNoWriteBarrier(context, kDebugEventSlot, debug_event);\n   return context;\n }\n@@ -736,17 +738,27 @@ TF_BUILTIN(PromiseCapabilityDefaultReject, PromiseBuiltinsAssembler) {\n   Node* const promise = LoadContextElement(context, kPromiseSlot);\n \n   // 3. Let alreadyResolved be F.[[AlreadyResolved]].\n+  Label if_already_resolved(this, Label::kDeferred);\n+  Node* const already_resolved =\n+      LoadContextElement(context, kAlreadyResolvedSlot);\n+\n   // 4. If alreadyResolved.[[Value]] is true, return undefined.\n-  // We use undefined as a marker for the [[AlreadyResolved]] state.\n-  ReturnIf(IsUndefined(promise), UndefinedConstant());\n+  GotoIf(IsTrue(already_resolved), &if_already_resolved);\n \n   // 5. Set alreadyResolved.[[Value]] to true.\n-  StoreContextElementNoWriteBarrier(context, kPromiseSlot, UndefinedConstant());\n+  StoreContextElementNoWriteBarrier(context, kAlreadyResolvedSlot,\n+                                    TrueConstant());\n \n   // 6. Return RejectPromise(promise, reason).\n   Node* const debug_event = LoadContextElement(context, kDebugEventSlot);\n   Return(CallBuiltin(Builtins::kRejectPromise, context, promise, reason,\n                      debug_event));\n+\n+  BIND(&if_already_resolved);\n+  {\n+    Return(CallRuntime(Runtime::kPromiseRejectAfterResolved, context, promise,\n+                       reason));\n+  }\n }\n \n // ES #sec-promise-resolve-functions\n@@ -758,16 +770,26 @@ TF_BUILTIN(PromiseCapabilityDefaultResolve, PromiseBuiltinsAssembler) {\n   Node* const promise = LoadContextElement(context, kPromiseSlot);\n \n   // 3. Let alreadyResolved be F.[[AlreadyResolved]].\n+  Label if_already_resolved(this, Label::kDeferred);\n+  Node* const already_resolved =\n+      LoadContextElement(context, kAlreadyResolvedSlot);\n+\n   // 4. If alreadyResolved.[[Value]] is true, return undefined.\n-  // We use undefined as a marker for the [[AlreadyResolved]] state.\n-  ReturnIf(IsUndefined(promise), UndefinedConstant());\n+  GotoIf(IsTrue(already_resolved), &if_already_resolved);\n \n   // 5. Set alreadyResolved.[[Value]] to true.\n-  StoreContextElementNoWriteBarrier(context, kPromiseSlot, UndefinedConstant());\n+  StoreContextElementNoWriteBarrier(context, kAlreadyResolvedSlot,\n+                                    TrueConstant());\n \n   // The rest of the logic (and the catch prediction) is\n   // encapsulated in the dedicated ResolvePromise builtin.\n   Return(CallBuiltin(Builtins::kResolvePromise, context, promise, resolution));\n+\n+  BIND(&if_already_resolved);\n+  {\n+    Return(CallRuntime(Runtime::kPromiseResolveAfterResolved, context, promise,\n+                       resolution));\n+  }\n }\n \n TF_BUILTIN(PromiseConstructorLazyDeoptContinuation, PromiseBuiltinsAssembler) {"
        },
        {
            "sha": "4954b383fecf175a8f7369949dcf13476a08a6d3",
            "filename": "deps/v8/src/builtins/builtins-promise-gen.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.h",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fbuiltins%2Fbuiltins-promise-gen.h?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -17,11 +17,12 @@ typedef compiler::CodeAssemblerState CodeAssemblerState;\n class PromiseBuiltinsAssembler : public CodeStubAssembler {\n  public:\n   enum PromiseResolvingFunctionContextSlot {\n-    // The promise which resolve/reject callbacks fulfill. If this is\n-    // undefined, then we've already visited this callback and it\n-    // should be a no-op.\n+    // The promise which resolve/reject callbacks fulfill.\n     kPromiseSlot = Context::MIN_CONTEXT_SLOTS,\n \n+    // Whether the callback was already invoked.\n+    kAlreadyResolvedSlot,\n+\n     // Whether to trigger a debug event or not. Used in catch\n     // prediction.\n     kDebugEventSlot,"
        },
        {
            "sha": "1bf59adb4aa7ea0ae6962056e6c6670cefd90199",
            "filename": "deps/v8/src/compiler/js-call-reducer.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -5406,6 +5406,10 @@ Reduction JSCallReducer::ReducePromiseConstructor(Node* node) {\n       graph()->NewNode(simplified()->StoreField(AccessBuilder::ForContextSlot(\n                            PromiseBuiltinsAssembler::kPromiseSlot)),\n                        promise_context, promise, effect, control);\n+  effect = graph()->NewNode(\n+      simplified()->StoreField(AccessBuilder::ForContextSlot(\n+          PromiseBuiltinsAssembler::kAlreadyResolvedSlot)),\n+      promise_context, jsgraph()->FalseConstant(), effect, control);\n   effect = graph()->NewNode(\n       simplified()->StoreField(AccessBuilder::ForContextSlot(\n           PromiseBuiltinsAssembler::kDebugEventSlot)),"
        },
        {
            "sha": "0e457df4d1a97d7b11aa63bfb41983cb1d3d234d",
            "filename": "deps/v8/src/isolate.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.cc?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -3872,10 +3872,9 @@ void Isolate::SetPromiseRejectCallback(PromiseRejectCallback callback) {\n void Isolate::ReportPromiseReject(Handle<JSPromise> promise,\n                                   Handle<Object> value,\n                                   v8::PromiseRejectEvent event) {\n-  DCHECK_EQ(v8::Promise::kRejected, promise->status());\n   if (promise_reject_callback_ == nullptr) return;\n   Handle<FixedArray> stack_trace;\n-  if (event == v8::kPromiseRejectWithNoHandler && value->IsJSObject()) {\n+  if (event != v8::kPromiseHandlerAddedAfterReject && value->IsJSObject()) {\n     stack_trace = GetDetailedStackTrace(Handle<JSObject>::cast(value));\n   }\n   promise_reject_callback_(v8::PromiseRejectMessage("
        },
        {
            "sha": "6c4f7d69eb7dbe02f3c85819ef01e98a14ba1088",
            "filename": "deps/v8/src/runtime/runtime-promise.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-promise.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-promise.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-promise.cc?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -38,6 +38,26 @@ RUNTIME_FUNCTION(Runtime_PromiseRejectEventFromStack) {\n   return isolate->heap()->undefined_value();\n }\n \n+RUNTIME_FUNCTION(Runtime_PromiseRejectAfterResolved) {\n+  DCHECK_EQ(2, args.length());\n+  HandleScope scope(isolate);\n+  CONVERT_ARG_HANDLE_CHECKED(JSPromise, promise, 0);\n+  CONVERT_ARG_HANDLE_CHECKED(Object, reason, 1);\n+  isolate->ReportPromiseReject(promise, reason,\n+                               v8::kPromiseRejectAfterResolved);\n+  return isolate->heap()->undefined_value();\n+}\n+\n+RUNTIME_FUNCTION(Runtime_PromiseResolveAfterResolved) {\n+  DCHECK_EQ(2, args.length());\n+  HandleScope scope(isolate);\n+  CONVERT_ARG_HANDLE_CHECKED(JSPromise, promise, 0);\n+  CONVERT_ARG_HANDLE_CHECKED(Object, resolution, 1);\n+  isolate->ReportPromiseReject(promise, resolution,\n+                               v8::kPromiseResolveAfterResolved);\n+  return isolate->heap()->undefined_value();\n+}\n+\n RUNTIME_FUNCTION(Runtime_PromiseRevokeReject) {\n   DCHECK_EQ(1, args.length());\n   HandleScope scope(isolate);"
        },
        {
            "sha": "382bac7d2a4766ee92459eb3f41cb75bf73e5e58",
            "filename": "deps/v8/src/runtime/runtime.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime.h",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime.h?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -432,7 +432,9 @@ namespace internal {\n   F(PromiseRevokeReject, 1, 1)         \\\n   F(PromiseStatus, 1, 1)               \\\n   F(RejectPromise, 3, 1)               \\\n-  F(ResolvePromise, 2, 1)\n+  F(ResolvePromise, 2, 1)              \\\n+  F(PromiseRejectAfterResolved, 2, 1)  \\\n+  F(PromiseResolveAfterResolved, 2, 1)\n \n #define FOR_EACH_INTRINSIC_PROXY(F)   \\\n   F(CheckProxyGetSetTrapResult, 2, 1) \\"
        },
        {
            "sha": "366b940d61eef33102c940386e5577cb92990bde",
            "filename": "deps/v8/test/cctest/test-api.cc",
            "status": "modified",
            "additions": 85,
            "deletions": 31,
            "changes": 116,
            "blob_url": "https://github.com/nodejs/node/blob/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68aa129ac1989d9dbb62c408ea4d478d3a7fc20e/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc?ref=68aa129ac1989d9dbb62c408ea4d478d3a7fc20e",
            "patch": "@@ -17700,6 +17700,8 @@ TEST(RethrowBogusErrorStackTrace) {\n v8::PromiseRejectEvent reject_event = v8::kPromiseRejectWithNoHandler;\n int promise_reject_counter = 0;\n int promise_revoke_counter = 0;\n+int promise_reject_after_resolved_counter = 0;\n+int promise_resolve_after_resolved_counter = 0;\n int promise_reject_msg_line_number = -1;\n int promise_reject_msg_column_number = -1;\n int promise_reject_line_number = -1;\n@@ -17709,40 +17711,56 @@ int promise_reject_frame_count = -1;\n void PromiseRejectCallback(v8::PromiseRejectMessage reject_message) {\n   v8::Local<v8::Object> global = CcTest::global();\n   v8::Local<v8::Context> context = CcTest::isolate()->GetCurrentContext();\n-  CHECK_EQ(v8::Promise::PromiseState::kRejected,\n+  CHECK_NE(v8::Promise::PromiseState::kPending,\n            reject_message.GetPromise()->State());\n-  if (reject_message.GetEvent() == v8::kPromiseRejectWithNoHandler) {\n-    promise_reject_counter++;\n-    global->Set(context, v8_str(\"rejected\"), reject_message.GetPromise())\n-        .FromJust();\n-    global->Set(context, v8_str(\"value\"), reject_message.GetValue()).FromJust();\n-    v8::Local<v8::Message> message = v8::Exception::CreateMessage(\n-        CcTest::isolate(), reject_message.GetValue());\n-    v8::Local<v8::StackTrace> stack_trace = message->GetStackTrace();\n-\n-    promise_reject_msg_line_number = message->GetLineNumber(context).FromJust();\n-    promise_reject_msg_column_number =\n-        message->GetStartColumn(context).FromJust() + 1;\n-\n-    if (!stack_trace.IsEmpty()) {\n-      promise_reject_frame_count = stack_trace->GetFrameCount();\n-      if (promise_reject_frame_count > 0) {\n-        CHECK(stack_trace->GetFrame(0)\n-                  ->GetScriptName()\n-                  ->Equals(context, v8_str(\"pro\"))\n-                  .FromJust());\n-        promise_reject_line_number = stack_trace->GetFrame(0)->GetLineNumber();\n-        promise_reject_column_number = stack_trace->GetFrame(0)->GetColumn();\n-      } else {\n-        promise_reject_line_number = -1;\n-        promise_reject_column_number = -1;\n+  switch (reject_message.GetEvent()) {\n+    case v8::kPromiseRejectWithNoHandler: {\n+      promise_reject_counter++;\n+      global->Set(context, v8_str(\"rejected\"), reject_message.GetPromise())\n+          .FromJust();\n+      global->Set(context, v8_str(\"value\"), reject_message.GetValue())\n+          .FromJust();\n+      v8::Local<v8::Message> message = v8::Exception::CreateMessage(\n+          CcTest::isolate(), reject_message.GetValue());\n+      v8::Local<v8::StackTrace> stack_trace = message->GetStackTrace();\n+\n+      promise_reject_msg_line_number =\n+          message->GetLineNumber(context).FromJust();\n+      promise_reject_msg_column_number =\n+          message->GetStartColumn(context).FromJust() + 1;\n+\n+      if (!stack_trace.IsEmpty()) {\n+        promise_reject_frame_count = stack_trace->GetFrameCount();\n+        if (promise_reject_frame_count > 0) {\n+          CHECK(stack_trace->GetFrame(0)\n+                    ->GetScriptName()\n+                    ->Equals(context, v8_str(\"pro\"))\n+                    .FromJust());\n+          promise_reject_line_number =\n+              stack_trace->GetFrame(0)->GetLineNumber();\n+          promise_reject_column_number = stack_trace->GetFrame(0)->GetColumn();\n+        } else {\n+          promise_reject_line_number = -1;\n+          promise_reject_column_number = -1;\n+        }\n       }\n+      break;\n+    }\n+    case v8::kPromiseHandlerAddedAfterReject: {\n+      promise_revoke_counter++;\n+      global->Set(context, v8_str(\"revoked\"), reject_message.GetPromise())\n+          .FromJust();\n+      CHECK(reject_message.GetValue().IsEmpty());\n+      break;\n+    }\n+    case v8::kPromiseRejectAfterResolved: {\n+      promise_reject_after_resolved_counter++;\n+      break;\n+    }\n+    case v8::kPromiseResolveAfterResolved: {\n+      promise_resolve_after_resolved_counter++;\n+      break;\n     }\n-  } else {\n-    promise_revoke_counter++;\n-    global->Set(context, v8_str(\"revoked\"), reject_message.GetPromise())\n-        .FromJust();\n-    CHECK(reject_message.GetValue().IsEmpty());\n   }\n }\n \n@@ -17765,6 +17783,8 @@ v8::Local<v8::Value> RejectValue() {\n void ResetPromiseStates() {\n   promise_reject_counter = 0;\n   promise_revoke_counter = 0;\n+  promise_reject_after_resolved_counter = 0;\n+  promise_resolve_after_resolved_counter = 0;\n   promise_reject_msg_line_number = -1;\n   promise_reject_msg_column_number = -1;\n   promise_reject_line_number = -1;\n@@ -17990,6 +18010,40 @@ TEST(PromiseRejectCallback) {\n   CHECK_EQ(0, promise_revoke_counter);\n   CHECK(RejectValue()->Equals(env.local(), v8_str(\"sss\")).FromJust());\n \n+  ResetPromiseStates();\n+\n+  // Swallowed exceptions in the Promise constructor.\n+  CompileRun(\n+      \"var v0 = new Promise(\\n\"\n+      \"  function(res, rej) {\\n\"\n+      \"    res(1);\\n\"\n+      \"    throw new Error();\\n\"\n+      \"  }\\n\"\n+      \");\\n\");\n+  CHECK(!GetPromise(\"v0\")->HasHandler());\n+  CHECK_EQ(0, promise_reject_counter);\n+  CHECK_EQ(0, promise_revoke_counter);\n+  CHECK_EQ(1, promise_reject_after_resolved_counter);\n+  CHECK_EQ(0, promise_resolve_after_resolved_counter);\n+\n+  ResetPromiseStates();\n+\n+  // Duplication resolve.\n+  CompileRun(\n+      \"var r;\\n\"\n+      \"var y0 = new Promise(\\n\"\n+      \"  function(res, rej) {\\n\"\n+      \"    r = res;\\n\"\n+      \"    throw new Error();\\n\"\n+      \"  }\\n\"\n+      \");\\n\"\n+      \"r(1);\\n\");\n+  CHECK(!GetPromise(\"y0\")->HasHandler());\n+  CHECK_EQ(1, promise_reject_counter);\n+  CHECK_EQ(0, promise_revoke_counter);\n+  CHECK_EQ(0, promise_reject_after_resolved_counter);\n+  CHECK_EQ(1, promise_resolve_after_resolved_counter);\n+\n   // Test stack frames.\n   env->GetIsolate()->SetCaptureStackTraceForUncaughtExceptions(true);\n "
        }
    ],
    "stats": {
        "total": 194,
        "additions": 149,
        "deletions": 45
    }
}