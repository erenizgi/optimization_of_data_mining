{
    "author": "mhdawson",
    "message": "n-api: add missing exception checking\n\nAdd checks for a pending exception in napi_make_callback\nafter the callback has been invoked.  If there is a pending\nexception then we need to avoid checking the result as that\nwill not be able to complete properly.\n\nAdd additional checks to the unit test for napi_make_callback\nto catch this case.\n\nPR-URL: https://github.com/nodejs/node/pull/19362\nFixes: https://github.com/nodejs/node-addon-api/issues/235\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "6a5a9ad62decfc7a5a41e362484dc0e56c648e67",
    "files": [
        {
            "sha": "2ee241badfda97f3bef4efa8bbc3dbf9a77f05c5",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/6a5a9ad62decfc7a5a41e362484dc0e56c648e67/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6a5a9ad62decfc7a5a41e362484dc0e56c648e67/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=6a5a9ad62decfc7a5a41e362484dc0e56c648e67",
            "patch": "@@ -2801,11 +2801,15 @@ napi_status napi_make_callback(napi_env env,\n       isolate, v8recv, v8func, argc,\n       reinterpret_cast<v8::Local<v8::Value>*>(const_cast<napi_value*>(argv)),\n       *node_async_context);\n-  CHECK_MAYBE_EMPTY(env, callback_result, napi_generic_failure);\n \n-  if (result != nullptr) {\n-    *result = v8impl::JsValueFromV8LocalValue(\n-        callback_result.ToLocalChecked());\n+  if (try_catch.HasCaught()) {\n+    return napi_set_last_error(env, napi_pending_exception);\n+  } else {\n+    CHECK_MAYBE_EMPTY(env, callback_result, napi_generic_failure);\n+    if (result != nullptr) {\n+      *result = v8impl::JsValueFromV8LocalValue(\n+          callback_result.ToLocalChecked());\n+    }\n   }\n \n   return GET_RETURN_STATUS(env);"
        },
        {
            "sha": "bfe9a457d237c8adbe93f9dca6bad69b9c0546c1",
            "filename": "test/addons-napi/test_make_callback_recurse/binding.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/6a5a9ad62decfc7a5a41e362484dc0e56c648e67/test%2Faddons-napi%2Ftest_make_callback_recurse%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6a5a9ad62decfc7a5a41e362484dc0e56c648e67/test%2Faddons-napi%2Ftest_make_callback_recurse%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_make_callback_recurse%2Fbinding.cc?ref=6a5a9ad62decfc7a5a41e362484dc0e56c648e67",
            "patch": "@@ -13,9 +13,22 @@ napi_value MakeCallback(napi_env env, napi_callback_info info) {\n   napi_value recv = args[0];\n   napi_value func = args[1];\n \n-  napi_make_callback(env, nullptr /* async_context */,\n+  napi_status status = napi_make_callback(env, nullptr /* async_context */,\n     recv, func, 0 /* argc */, nullptr /* argv */, nullptr /* result */);\n \n+  bool isExceptionPending;\n+  NAPI_CALL(env, napi_is_exception_pending(env, &isExceptionPending));\n+  if (isExceptionPending && !(status == napi_pending_exception)) {\n+    // if there is an exception pending we don't expect any\n+    // other error\n+    napi_value pending_error;\n+    status = napi_get_and_clear_last_exception(env, &pending_error);\n+    NAPI_CALL(env,\n+      napi_throw_error((env),\n+                        nullptr,\n+                        \"error when only pending exception expected\"));\n+  }\n+\n   return recv;\n }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 22,
        "deletions": 5
    }
}