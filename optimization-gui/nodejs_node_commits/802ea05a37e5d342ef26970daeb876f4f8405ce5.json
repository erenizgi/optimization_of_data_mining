{
    "author": "ZYSzys",
    "message": "net,http2: merge setTimeout code\n\nPR-URL: https://github.com/nodejs/node/pull/25084\nRefs: https://github.com/nodejs/node/issues/19060\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "802ea05a37e5d342ef26970daeb876f4f8405ce5",
    "files": [
        {
            "sha": "b78ecaf5eebf9ff7f5116cf97aea8d1f13d01871",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 5,
            "deletions": 36,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=802ea05a37e5d342ef26970daeb876f4f8405ce5",
            "patch": "@@ -110,13 +110,11 @@ const {\n   onStreamRead,\n   kAfterAsyncWrite,\n   kMaybeDestroy,\n-  kUpdateTimer\n+  kUpdateTimer,\n+  kSession,\n+  setStreamTimeout\n } = require('internal/stream_base_commons');\n-const {\n-  kTimeout,\n-  setUnrefTimeout,\n-  validateTimerDuration\n-} = require('internal/timers');\n+const { kTimeout } = require('internal/timers');\n const { isArrayBufferView } = require('internal/util/types');\n \n const { FileHandle } = internalBinding('fs');\n@@ -163,7 +161,6 @@ const kSelectPadding = Symbol('select-padding');\n const kSentHeaders = Symbol('sent-headers');\n const kSentTrailers = Symbol('sent-trailers');\n const kServer = Symbol('server');\n-const kSession = Symbol('session');\n const kState = Symbol('state');\n const kType = Symbol('type');\n const kWriteGeneric = Symbol('write-generic');\n@@ -2546,35 +2543,7 @@ const setTimeout = {\n   configurable: true,\n   enumerable: true,\n   writable: true,\n-  value: function(msecs, callback) {\n-    if (this.destroyed)\n-      return;\n-\n-    // Type checking identical to timers.enroll()\n-    msecs = validateTimerDuration(msecs);\n-\n-    // Attempt to clear an existing timer lear in both cases -\n-    //  even if it will be rescheduled we don't want to leak an existing timer.\n-    clearTimeout(this[kTimeout]);\n-\n-    if (msecs === 0) {\n-      if (callback !== undefined) {\n-        if (typeof callback !== 'function')\n-          throw new ERR_INVALID_CALLBACK();\n-        this.removeListener('timeout', callback);\n-      }\n-    } else {\n-      this[kTimeout] = setUnrefTimeout(this._onTimeout.bind(this), msecs);\n-      if (this[kSession]) this[kSession][kUpdateTimer]();\n-\n-      if (callback !== undefined) {\n-        if (typeof callback !== 'function')\n-          throw new ERR_INVALID_CALLBACK();\n-        this.once('timeout', callback);\n-      }\n-    }\n-    return this;\n-  }\n+  value: setStreamTimeout\n };\n Object.defineProperty(Http2Stream.prototype, 'setTimeout', setTimeout);\n Object.defineProperty(Http2Session.prototype, 'setTimeout', setTimeout);"
        },
        {
            "sha": "6de03c09d83d1be0f41170157ef473e2fffc0c91",
            "filename": "lib/internal/stream_base_commons.js",
            "status": "modified",
            "additions": 46,
            "deletions": 1,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Finternal%2Fstream_base_commons.js",
            "raw_url": "https://github.com/nodejs/node/raw/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Finternal%2Fstream_base_commons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstream_base_commons.js?ref=802ea05a37e5d342ef26970daeb876f4f8405ce5",
            "patch": "@@ -11,12 +11,23 @@ const {\n   streamBaseState\n } = internalBinding('stream_wrap');\n const { UV_EOF } = internalBinding('uv');\n-const { errnoException } = require('internal/errors');\n+const {\n+  codes: {\n+    ERR_INVALID_CALLBACK\n+  },\n+  errnoException\n+} = require('internal/errors');\n const { owner_symbol } = require('internal/async_hooks').symbols;\n+const {\n+  kTimeout,\n+  setUnrefTimeout,\n+  validateTimerDuration\n+} = require('internal/timers');\n \n const kMaybeDestroy = Symbol('kMaybeDestroy');\n const kUpdateTimer = Symbol('kUpdateTimer');\n const kAfterAsyncWrite = Symbol('kAfterAsyncWrite');\n+const kSession = Symbol('session');\n \n function handleWriteReq(req, data, encoding) {\n   const { handle } = req;\n@@ -178,6 +189,38 @@ function onStreamRead(arrayBuffer) {\n   }\n }\n \n+function setStreamTimeout(msecs, callback) {\n+  if (this.destroyed)\n+    return;\n+\n+  this.timeout = msecs;\n+\n+  // Type checking identical to timers.enroll()\n+  msecs = validateTimerDuration(msecs);\n+\n+  // Attempt to clear an existing timer in both cases -\n+  //  even if it will be rescheduled we don't want to leak an existing timer.\n+  clearTimeout(this[kTimeout]);\n+\n+  if (msecs === 0) {\n+    if (callback !== undefined) {\n+      if (typeof callback !== 'function')\n+        throw new ERR_INVALID_CALLBACK();\n+      this.removeListener('timeout', callback);\n+    }\n+  } else {\n+    this[kTimeout] = setUnrefTimeout(this._onTimeout.bind(this), msecs);\n+    if (this[kSession]) this[kSession][kUpdateTimer]();\n+\n+    if (callback !== undefined) {\n+      if (typeof callback !== 'function')\n+        throw new ERR_INVALID_CALLBACK();\n+      this.once('timeout', callback);\n+    }\n+  }\n+  return this;\n+}\n+\n module.exports = {\n   createWriteWrap,\n   writevGeneric,\n@@ -186,4 +229,6 @@ module.exports = {\n   kAfterAsyncWrite,\n   kMaybeDestroy,\n   kUpdateTimer,\n+  kSession,\n+  setStreamTimeout\n };"
        },
        {
            "sha": "1cea5bf6ced0f0c27cc1330fb3b74ff7a41e740e",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 4,
            "deletions": 28,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/802ea05a37e5d342ef26970daeb876f4f8405ce5/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=802ea05a37e5d342ef26970daeb876f4f8405ce5",
            "patch": "@@ -63,7 +63,8 @@ const {\n   writeGeneric,\n   onStreamRead,\n   kAfterAsyncWrite,\n-  kUpdateTimer\n+  kUpdateTimer,\n+  setStreamTimeout\n } = require('internal/stream_base_commons');\n const {\n   codes: {\n@@ -89,11 +90,7 @@ const kLastWriteQueueSize = Symbol('lastWriteQueueSize');\n let cluster;\n let dns;\n \n-const {\n-  kTimeout,\n-  setUnrefTimeout,\n-  validateTimerDuration\n-} = require('internal/timers');\n+const { kTimeout } = require('internal/timers');\n \n function noop() {}\n \n@@ -405,28 +402,7 @@ function writeAfterFIN(chunk, encoding, cb) {\n   }\n }\n \n-Socket.prototype.setTimeout = function(msecs, callback) {\n-  this.timeout = msecs;\n-  // Type checking identical to timers.enroll()\n-  msecs = validateTimerDuration(msecs);\n-\n-  // Attempt to clear an existing timer in both cases -\n-  //  even if it will be rescheduled we don't want to leak an existing timer.\n-  clearTimeout(this[kTimeout]);\n-\n-  if (msecs === 0) {\n-    if (callback) {\n-      this.removeListener('timeout', callback);\n-    }\n-  } else {\n-    this[kTimeout] = setUnrefTimeout(this._onTimeout.bind(this), msecs);\n-\n-    if (callback) {\n-      this.once('timeout', callback);\n-    }\n-  }\n-  return this;\n-};\n+Socket.prototype.setTimeout = setStreamTimeout;\n \n \n Socket.prototype._onTimeout = function() {"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 55,
        "deletions": 65
    }
}