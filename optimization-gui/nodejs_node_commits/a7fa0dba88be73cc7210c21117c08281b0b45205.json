{
    "author": "ryzokuken",
    "message": "net,http2: refactor _write and _writev\n\nRefactor writable part (the _write and _writev functions) in net.Socket\nand http2.Http2Stream classes.\nAlso involves adding a generic \"WriteGeneric\" method to the Http2Stream\nclass based on net.Socket._writeGeneric, but behind a symbol.\n\nPR-URL: https://github.com/nodejs/node/pull/20643\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "a7fa0dba88be73cc7210c21117c08281b0b45205",
    "files": [
        {
            "sha": "fbccbf0d84997760ed01b8ccd9acf8f3c718ee31",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 15,
            "deletions": 32,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/a7fa0dba88be73cc7210c21117c08281b0b45205/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7fa0dba88be73cc7210c21117c08281b0b45205/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=a7fa0dba88be73cc7210c21117c08281b0b45205",
            "patch": "@@ -146,6 +146,7 @@ const kSession = Symbol('session');\n const kState = Symbol('state');\n const kType = Symbol('type');\n const kUpdateTimer = Symbol('update-timer');\n+const kWriteGeneric = Symbol('write-generic');\n \n const kDefaultSocketTimeout = 2 * 60 * 1000;\n \n@@ -1657,13 +1658,16 @@ class Http2Stream extends Duplex {\n                 'bug in Node.js');\n   }\n \n-  _write(data, encoding, cb) {\n+  [kWriteGeneric](writev, data, encoding, cb) {\n     // When the Http2Stream is first created, it is corked until the\n     // handle and the stream ID is assigned. However, if the user calls\n     // uncork() before that happens, the Duplex will attempt to pass\n     // writes through. Those need to be queued up here.\n     if (this.pending) {\n-      this.once('ready', this._write.bind(this, data, encoding, cb));\n+      this.once(\n+        'ready',\n+        this[kWriteGeneric].bind(this, writev, data, encoding, cb)\n+      );\n       return;\n     }\n \n@@ -1683,41 +1687,20 @@ class Http2Stream extends Duplex {\n     const req = createWriteWrap(this[kHandle], afterDoStreamWrite);\n     req.stream = this[kID];\n \n-    writeGeneric(this, req, data, encoding, cb);\n+    if (writev)\n+      writevGeneric(this, req, data, cb);\n+    else\n+      writeGeneric(this, req, data, encoding, cb);\n \n     trackWriteState(this, req.bytes);\n   }\n \n-  _writev(data, cb) {\n-    // When the Http2Stream is first created, it is corked until the\n-    // handle and the stream ID is assigned. However, if the user calls\n-    // uncork() before that happens, the Duplex will attempt to pass\n-    // writes through. Those need to be queued up here.\n-    if (this.pending) {\n-      this.once('ready', this._writev.bind(this, data, cb));\n-      return;\n-    }\n-\n-    // If the stream has been destroyed, there's nothing else we can do\n-    // because the handle has been destroyed. This should only be an\n-    // issue if a write occurs before the 'ready' event in the case where\n-    // the duplex is uncorked before the stream is ready to go. In that\n-    // case, drop the data on the floor. An error should have already been\n-    // emitted.\n-    if (this.destroyed)\n-      return;\n-\n-    this[kUpdateTimer]();\n-\n-    if (!this.headersSent)\n-      this[kProceed]();\n-\n-    var req = createWriteWrap(this[kHandle], afterDoStreamWrite);\n-    req.stream = this[kID];\n-\n-    writevGeneric(this, req, data, cb);\n+  _write(data, encoding, cb) {\n+    this[kWriteGeneric](false, data, encoding, cb);\n+  }\n \n-    trackWriteState(this, req.bytes);\n+  _writev(data, cb) {\n+    this[kWriteGeneric](true, data, '', cb);\n   }\n \n   _final(cb) {"
        },
        {
            "sha": "92b04838b6178dc86d9894cdc5bedb59ed3047bb",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a7fa0dba88be73cc7210c21117c08281b0b45205/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7fa0dba88be73cc7210c21117c08281b0b45205/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=a7fa0dba88be73cc7210c21117c08281b0b45205",
            "patch": "@@ -744,13 +744,13 @@ Socket.prototype._writeGeneric = function(writev, data, encoding, cb) {\n   this._pendingData = null;\n   this._pendingEncoding = '';\n \n-  this._unrefTimer();\n-\n   if (!this._handle) {\n     this.destroy(new ERR_SOCKET_CLOSED(), cb);\n     return false;\n   }\n \n+  this._unrefTimer();\n+\n   var req = createWriteWrap(this._handle, afterWrite);\n   if (writev)\n     writevGeneric(this, req, data, cb);"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 17,
        "deletions": 34
    }
}