{
    "author": "BridgeAR",
    "message": "assert: do not read Node.js modules\n\nPrevent reading a Node.js module. That could theoretically lead to\nfalse errors being thrown otherwise.\n\nPR-URL: https://github.com/nodejs/node/pull/18322\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "3e910fb8f7bc42cfd9f114260322265d0ec00278",
    "files": [
        {
            "sha": "a6447278f0c59ea76ac8ec90b4ecfd0c65d760ad",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 61,
            "deletions": 49,
            "changes": 110,
            "blob_url": "https://github.com/nodejs/node/blob/3e910fb8f7bc42cfd9f114260322265d0ec00278/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/3e910fb8f7bc42cfd9f114260322265d0ec00278/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=3e910fb8f7bc42cfd9f114260322265d0ec00278",
            "patch": "@@ -25,13 +25,13 @@ const {\n   isDeepEqual,\n   isDeepStrictEqual\n } = require('internal/util/comparisons');\n-const { AssertionError, TypeError } = require('internal/errors');\n+const { AssertionError, TypeError, errorCache } = require('internal/errors');\n const { openSync, closeSync, readSync } = require('fs');\n const { parseExpressionAt } = require('internal/deps/acorn/dist/acorn');\n const { inspect } = require('util');\n const { EOL } = require('os');\n+const nativeModule = require('native_module');\n \n-const codeCache = new Map();\n // Escape control characters but not \\n and \\t to keep the line breaks and\n // indentation intact.\n // eslint-disable-next-line no-control-regex\n@@ -146,6 +146,60 @@ function getBuffer(fd, assertLine) {\n   return buffers;\n }\n \n+function getErrMessage(call) {\n+  const filename = call.getFileName();\n+  const line = call.getLineNumber() - 1;\n+  const column = call.getColumnNumber() - 1;\n+  const identifier = `${filename}${line}${column}`;\n+\n+  if (errorCache.has(identifier)) {\n+    return errorCache.get(identifier);\n+  }\n+\n+  // Skip Node.js modules!\n+  if (filename.endsWith('.js') && nativeModule.exists(filename.slice(0, -3))) {\n+    errorCache.set(identifier, undefined);\n+    return;\n+  }\n+\n+  var fd;\n+  try {\n+    fd = openSync(filename, 'r', 0o666);\n+    const buffers = getBuffer(fd, line);\n+    const code = Buffer.concat(buffers).toString('utf8');\n+    const nodes = parseExpressionAt(code, column);\n+    // Node type should be \"CallExpression\" and some times\n+    // \"SequenceExpression\".\n+    const node = nodes.type === 'CallExpression' ? nodes : nodes.expressions[0];\n+    const name = node.callee.name;\n+    // Calling `ok` with .apply or .call is uncommon but we use a simple\n+    // safeguard nevertheless.\n+    if (name !== 'apply' && name !== 'call') {\n+    // Only use `assert` and `assert.ok` to reference the \"real API\" and\n+    // not user defined function names.\n+      const ok = name === 'ok' ? '.ok' : '';\n+      const args = node.arguments;\n+      var message = code\n+        .slice(args[0].start, args[args.length - 1].end)\n+        .replace(escapeSequencesRegExp, escapeFn);\n+      message = 'The expression evaluated to a falsy value:' +\n+        `${EOL}${EOL}  assert${ok}(${message})${EOL}`;\n+    }\n+    // Make sure to always set the cache! No matter if the message is\n+    // undefined or not\n+    errorCache.set(identifier, message);\n+\n+    return message;\n+\n+  } catch (e) {\n+  // Invalidate cache to prevent trying to read this part again.\n+    errorCache.set(identifier, undefined);\n+  } finally {\n+    if (fd !== undefined)\n+      closeSync(fd);\n+  }\n+}\n+\n function innerOk(args, fn) {\n   var [value, message] = args;\n \n@@ -168,54 +222,12 @@ function innerOk(args, fn) {\n       const call = err.stack[0];\n       Error.prepareStackTrace = tmpPrepare;\n \n-      const filename = call.getFileName();\n-      const line = call.getLineNumber() - 1;\n-      const column = call.getColumnNumber() - 1;\n-      const identifier = `${filename}${line}${column}`;\n+      // TODO(BridgeAR): fix the \"generatedMessage property\"\n+      // Since this is actually a generated message, it has to be\n+      // determined differently from now on.\n \n-      if (codeCache.has(identifier)) {\n-        message = codeCache.get(identifier);\n-      } else {\n-        var fd;\n-        try {\n-          fd = openSync(filename, 'r', 0o666);\n-          const buffers = getBuffer(fd, line);\n-          const code = Buffer.concat(buffers).toString('utf8');\n-          const nodes = parseExpressionAt(code, column);\n-          // Node type should be \"CallExpression\" and some times\n-          // \"SequenceExpression\".\n-          const node = nodes.type === 'CallExpression' ?\n-            nodes :\n-            nodes.expressions[0];\n-          // TODO: fix the \"generatedMessage property\"\n-          // Since this is actually a generated message, it has to be\n-          // determined differently from now on.\n-\n-          const name = node.callee.name;\n-          // Calling `ok` with .apply or .call is uncommon but we use a simple\n-          // safeguard nevertheless.\n-          if (name !== 'apply' && name !== 'call') {\n-            // Only use `assert` and `assert.ok` to reference the \"real API\" and\n-            // not user defined function names.\n-            const ok = name === 'ok' ? '.ok' : '';\n-            const args = node.arguments;\n-            message = code\n-              .slice(args[0].start, args[args.length - 1].end)\n-              .replace(escapeSequencesRegExp, escapeFn);\n-            message = 'The expression evaluated to a falsy value:' +\n-              `${EOL}${EOL}  assert${ok}(${message})${EOL}`;\n-          }\n-          // Make sure to always set the cache! No matter if the message is\n-          // undefined or not\n-          codeCache.set(identifier, message);\n-        } catch (e) {\n-          // Invalidate cache to prevent trying to read this part again.\n-          codeCache.set(identifier, undefined);\n-        } finally {\n-          if (fd !== undefined)\n-            closeSync(fd);\n-        }\n-      }\n+      // Make sure it would be \"null\" in case that is used.\n+      message = getErrMessage(call) || message;\n     }\n     innerFail({\n       actual: value,"
        },
        {
            "sha": "a41df135407341a09c1f020bc208acdf202a328f",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3e910fb8f7bc42cfd9f114260322265d0ec00278/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/3e910fb8f7bc42cfd9f114260322265d0ec00278/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=3e910fb8f7bc42cfd9f114260322265d0ec00278",
            "patch": "@@ -398,7 +398,8 @@ module.exports = exports = {\n   URIError: makeNodeError(URIError),\n   AssertionError,\n   SystemError,\n-  E // This is exported only to facilitate testing.\n+  E, // This is exported only to facilitate testing.\n+  errorCache: new Map() // This is in here only to facilitate testing.\n };\n \n // To declare an error message, use the E(sym, val) function above. The sym"
        },
        {
            "sha": "e4784e0688173f5285bc219c8eb8c1047e857e02",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/3e910fb8f7bc42cfd9f114260322265d0ec00278/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/3e910fb8f7bc42cfd9f114260322265d0ec00278/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=3e910fb8f7bc42cfd9f114260322265d0ec00278",
            "patch": "@@ -19,13 +19,18 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+// Flags: --expose-internals\n+\n 'use strict';\n \n /* eslint-disable prefer-common-expectserror */\n \n const common = require('../common');\n const assert = require('assert');\n const { EOL } = require('os');\n+const EventEmitter = require('events');\n+const { errorCache } = require('internal/errors');\n+const { writeFileSync, unlinkSync } = require('fs');\n const a = assert;\n \n function makeBlock(f) {\n@@ -1019,6 +1024,38 @@ common.expectsError(\n   }\n );\n \n+// Do not try to check Node.js modules.\n+{\n+  const e = new EventEmitter();\n+\n+  e.on('hello', assert);\n+\n+  let threw = false;\n+  try {\n+    e.emit('hello', false);\n+  } catch (err) {\n+    const frames = err.stack.split('\\n');\n+    const [, filename, line, column] = frames[1].match(/\\((.+):(\\d+):(\\d+)\\)/);\n+    // Reset the cache to check again\n+    errorCache.delete(`${filename}${line - 1}${column - 1}`);\n+    const data = `${'\\n'.repeat(line - 1)}${' '.repeat(column - 1)}` +\n+                 'ok(failed(badly));';\n+    try {\n+      writeFileSync(filename, data);\n+      assert.throws(\n+        () => e.emit('hello', false),\n+        {\n+          message: 'false == true'\n+        }\n+      );\n+      threw = true;\n+    } finally {\n+      unlinkSync(filename);\n+    }\n+  }\n+  assert(threw);\n+}\n+\n common.expectsError(\n   // eslint-disable-next-line no-restricted-syntax\n   () => assert.throws(() => {}, 'Error message', 'message'),"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 100,
        "deletions": 50
    }
}