{
    "author": "helloshuangzi",
    "message": "src: add public API to create isolate and context\n\nPR-URL: https://github.com/nodejs/node/pull/20639\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "963cb3a49ca79427512886334222e8f878aaeba8",
    "files": [
        {
            "sha": "71b130a63fc0c921cd41fd0544ddf0c0b33b5c3f",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 45,
            "deletions": 13,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=963cb3a49ca79427512886334222e8f878aaeba8",
            "patch": "@@ -4439,10 +4439,21 @@ int EmitExit(Environment* env) {\n }\n \n \n+ArrayBufferAllocator* CreateArrayBufferAllocator() {\n+  return new ArrayBufferAllocator();\n+}\n+\n+\n+void FreeArrayBufferAllocator(ArrayBufferAllocator* allocator) {\n+  delete allocator;\n+}\n+\n+\n IsolateData* CreateIsolateData(Isolate* isolate, uv_loop_t* loop) {\n   return new IsolateData(isolate, loop, nullptr);\n }\n \n+\n IsolateData* CreateIsolateData(\n     Isolate* isolate,\n     uv_loop_t* loop,\n@@ -4451,6 +4462,15 @@ IsolateData* CreateIsolateData(\n }\n \n \n+IsolateData* CreateIsolateData(\n+    Isolate* isolate,\n+    uv_loop_t* loop,\n+    MultiIsolatePlatform* platform,\n+    ArrayBufferAllocator* allocator) {\n+  return new IsolateData(isolate, loop, platform, allocator->zero_fill_field());\n+}\n+\n+\n void FreeIsolateData(IsolateData* isolate_data) {\n   delete isolate_data;\n }\n@@ -4594,26 +4614,35 @@ bool AllowWasmCodeGenerationCallback(\n   return wasm_code_gen->IsUndefined() || wasm_code_gen->IsTrue();\n }\n \n-inline int Start(uv_loop_t* event_loop,\n-                 int argc, const char* const* argv,\n-                 int exec_argc, const char* const* exec_argv) {\n+Isolate* NewIsolate(ArrayBufferAllocator* allocator) {\n   Isolate::CreateParams params;\n-  ArrayBufferAllocator allocator;\n-  params.array_buffer_allocator = &allocator;\n+  params.array_buffer_allocator = allocator;\n #ifdef NODE_ENABLE_VTUNE_PROFILING\n   params.code_event_handler = vTune::GetVtuneCodeEventHandler();\n #endif\n \n-  Isolate* const isolate = Isolate::New(params);\n+  Isolate* isolate = Isolate::New(params);\n   if (isolate == nullptr)\n-    return 12;  // Signal internal error.\n+    return nullptr;\n \n   isolate->AddMessageListener(OnMessage);\n   isolate->SetAbortOnUncaughtExceptionCallback(ShouldAbortOnUncaughtException);\n   isolate->SetMicrotasksPolicy(v8::MicrotasksPolicy::kExplicit);\n   isolate->SetFatalErrorHandler(OnFatalError);\n   isolate->SetAllowWasmCodeGenerationCallback(AllowWasmCodeGenerationCallback);\n \n+  return isolate;\n+}\n+\n+inline int Start(uv_loop_t* event_loop,\n+                 int argc, const char* const* argv,\n+                 int exec_argc, const char* const* exec_argv) {\n+  std::unique_ptr<ArrayBufferAllocator, decltype(&FreeArrayBufferAllocator)>\n+      allocator(CreateArrayBufferAllocator(), &FreeArrayBufferAllocator);\n+  Isolate* const isolate = NewIsolate(allocator.get());\n+  if (isolate == nullptr)\n+    return 12;  // Signal internal error.\n+\n   {\n     Mutex::ScopedLock scoped_lock(node_isolate_mutex);\n     CHECK_EQ(node_isolate, nullptr);\n@@ -4625,15 +4654,18 @@ inline int Start(uv_loop_t* event_loop,\n     Locker locker(isolate);\n     Isolate::Scope isolate_scope(isolate);\n     HandleScope handle_scope(isolate);\n-    IsolateData isolate_data(\n-        isolate,\n-        event_loop,\n-        v8_platform.Platform(),\n-        allocator.zero_fill_field());\n+    std::unique_ptr<IsolateData, decltype(&FreeIsolateData)> isolate_data(\n+        CreateIsolateData(\n+            isolate,\n+            event_loop,\n+            v8_platform.Platform(),\n+            allocator.get()),\n+        &FreeIsolateData);\n     if (track_heap_objects) {\n       isolate->GetHeapProfiler()->StartTrackingHeapObjects(true);\n     }\n-    exit_code = Start(isolate, &isolate_data, argc, argv, exec_argc, exec_argv);\n+    exit_code =\n+        Start(isolate, isolate_data.get(), argc, argv, exec_argc, exec_argv);\n   }\n \n   {"
        },
        {
            "sha": "44c89afdb7134c9b6a1b6c4abd786b23aec33a91",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=963cb3a49ca79427512886334222e8f878aaeba8",
            "patch": "@@ -214,6 +214,11 @@ NODE_EXTERN void Init(int* argc,\n                       int* exec_argc,\n                       const char*** exec_argv);\n \n+class ArrayBufferAllocator;\n+\n+NODE_EXTERN ArrayBufferAllocator* CreateArrayBufferAllocator();\n+NODE_EXTERN void FreeArrayBufferAllocator(ArrayBufferAllocator* allocator);\n+\n class IsolateData;\n class Environment;\n \n@@ -229,16 +234,33 @@ class MultiIsolatePlatform : public v8::Platform {\n   virtual void UnregisterIsolate(IsolateData* isolate_data) = 0;\n };\n \n+// Creates a new isolate with Node.js-specific settings.\n+NODE_EXTERN v8::Isolate* NewIsolate(ArrayBufferAllocator* allocator);\n+\n+// Creates a new context with Node.js-specific tweaks.  Currently, it removes\n+// the `v8BreakIterator` property from the global `Intl` object if present.\n+// See https://github.com/nodejs/node/issues/14909 for more info.\n+NODE_EXTERN v8::Local<v8::Context> NewContext(\n+    v8::Isolate* isolate,\n+    v8::Local<v8::ObjectTemplate> object_template =\n+        v8::Local<v8::ObjectTemplate>());\n+\n // If `platform` is passed, it will be used to register new Worker instances.\n // It can be `nullptr`, in which case creating new Workers inside of\n // Environments that use this `IsolateData` will not work.\n+// TODO(helloshuangzi): switch to default parameters.\n NODE_EXTERN IsolateData* CreateIsolateData(\n     v8::Isolate* isolate,\n     struct uv_loop_s* loop);\n NODE_EXTERN IsolateData* CreateIsolateData(\n     v8::Isolate* isolate,\n     struct uv_loop_s* loop,\n     MultiIsolatePlatform* platform);\n+NODE_EXTERN IsolateData* CreateIsolateData(\n+    v8::Isolate* isolate,\n+    struct uv_loop_s* loop,\n+    MultiIsolatePlatform* platform,\n+    ArrayBufferAllocator* allocator);\n NODE_EXTERN void FreeIsolateData(IsolateData* isolate_data);\n \n NODE_EXTERN Environment* CreateEnvironment(IsolateData* isolate_data,"
        },
        {
            "sha": "1ba56458b194c2caeba53972114753b6d338e334",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/963cb3a49ca79427512886334222e8f878aaeba8/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=963cb3a49ca79427512886334222e8f878aaeba8",
            "patch": "@@ -232,14 +232,6 @@ inline v8::Local<TypeName> PersistentToLocal(\n     v8::Isolate* isolate,\n     const Persistent<TypeName>& persistent);\n \n-// Creates a new context with Node.js-specific tweaks.  Currently, it removes\n-// the `v8BreakIterator` property from the global `Intl` object if present.\n-// See https://github.com/nodejs/node/issues/14909 for more info.\n-v8::Local<v8::Context> NewContext(\n-    v8::Isolate* isolate,\n-    v8::Local<v8::ObjectTemplate> object_template =\n-        v8::Local<v8::ObjectTemplate>());\n-\n // Convert a struct sockaddr to a { address: '1.2.3.4', port: 1234 } JS object.\n // Sets address and port properties on the info object and returns it.\n // If |info| is omitted, a new object is returned."
        }
    ],
    "stats": {
        "total": 88,
        "additions": 67,
        "deletions": 21
    }
}