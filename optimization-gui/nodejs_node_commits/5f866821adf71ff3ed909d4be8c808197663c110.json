{
    "author": "Fishrock123",
    "message": "test: add stdio checks to cp-exec-maxBuffer\n\nExpands this test case to check what happens to stdout/stderr when\nmaxBuffer is exceeded.\n\nAlso changes how cases are checked so that assertion stacks are\ntracable to their test case, aka 'make it actually debuggable'.\n\nPR-URL: https://github.com/nodejs/node/pull/24951\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "5f866821adf71ff3ed909d4be8c808197663c110",
    "files": [
        {
            "sha": "569efb5deba699eb494005b489d9b782c53c1868",
            "filename": "test/parallel/test-child-process-exec-maxBuffer.js",
            "status": "modified",
            "additions": 35,
            "deletions": 12,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/5f866821adf71ff3ed909d4be8c808197663c110/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/5f866821adf71ff3ed909d4be8c808197663c110/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js?ref=5f866821adf71ff3ed909d4be8c808197663c110",
            "patch": "@@ -3,12 +3,11 @@ const common = require('../common');\n const assert = require('assert');\n const cp = require('child_process');\n \n-function checkFactory(streamName) {\n-  return common.mustCall((err) => {\n-    assert.strictEqual(err.message, `${streamName} maxBuffer length exceeded`);\n-    assert(err instanceof RangeError);\n-    assert.strictEqual(err.code, 'ERR_CHILD_PROCESS_STDIO_MAXBUFFER');\n-  });\n+function runChecks(err, stdio, streamName, expected) {\n+  assert.strictEqual(err.message, `${streamName} maxBuffer length exceeded`);\n+  assert(err instanceof RangeError);\n+  assert.strictEqual(err.code, 'ERR_CHILD_PROCESS_STDIO_MAXBUFFER');\n+  assert.deepStrictEqual(stdio[streamName], expected);\n }\n \n {\n@@ -25,21 +24,39 @@ function checkFactory(streamName) {\n {\n   const cmd = 'echo \"hello world\"';\n \n-  cp.exec(cmd, { maxBuffer: 5 }, checkFactory('stdout'));\n+  cp.exec(\n+    cmd,\n+    { maxBuffer: 5 },\n+    common.mustCall((err, stdout, stderr) => {\n+      runChecks(err, { stdout, stderr }, 'stdout', '');\n+    })\n+  );\n }\n \n const unicode = '中文测试'; // length = 4, byte length = 12\n \n {\n   const cmd = `\"${process.execPath}\" -e \"console.log('${unicode}');\"`;\n \n-  cp.exec(cmd, { maxBuffer: 10 }, checkFactory('stdout'));\n+  cp.exec(\n+    cmd,\n+    { maxBuffer: 10 },\n+    common.mustCall((err, stdout, stderr) => {\n+      runChecks(err, { stdout, stderr }, 'stdout', '');\n+    })\n+  );\n }\n \n {\n   const cmd = `\"${process.execPath}\" -e \"console.error('${unicode}');\"`;\n \n-  cp.exec(cmd, { maxBuffer: 10 }, checkFactory('stderr'));\n+  cp.exec(\n+    cmd,\n+    { maxBuffer: 3 },\n+    common.mustCall((err, stdout, stderr) => {\n+      runChecks(err, { stdout, stderr }, 'stderr', '');\n+    })\n+  );\n }\n \n {\n@@ -48,7 +65,10 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n   const child = cp.exec(\n     cmd,\n     { encoding: null, maxBuffer: 10 },\n-    checkFactory('stdout'));\n+    common.mustCall((err, stdout, stderr) => {\n+      runChecks(err, { stdout, stderr }, 'stdout', '');\n+    })\n+  );\n \n   child.stdout.setEncoding('utf-8');\n }\n@@ -58,8 +78,11 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n \n   const child = cp.exec(\n     cmd,\n-    { encoding: null, maxBuffer: 10 },\n-    checkFactory('stderr'));\n+    { encoding: null, maxBuffer: 3 },\n+    common.mustCall((err, stdout, stderr) => {\n+      runChecks(err, { stdout, stderr }, 'stderr', '');\n+    })\n+  );\n \n   child.stderr.setEncoding('utf-8');\n }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 35,
        "deletions": 12
    }
}