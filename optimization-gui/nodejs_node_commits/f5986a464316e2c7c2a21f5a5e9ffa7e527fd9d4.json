{
    "author": "ofrobots",
    "message": "src: trace_event: secondary storage for metadata\n\nMetadata trace-events should be held in secondary storage so that they\ncan be periodically reemitted. This change establishes the secondary\nstorage and ensures that events are reemitted on each flush.\n\nPR-URL: https://github.com/nodejs/node/pull/20900\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
    "files": [
        {
            "sha": "048538324c34ca4bf4edf8092d359addf38f3134",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -271,9 +271,9 @@ static struct {\n #if NODE_USE_V8_PLATFORM\n   void Initialize(int thread_pool_size) {\n     tracing_agent_.reset(new tracing::Agent());\n+    node::tracing::TraceEventHelper::SetAgent(tracing_agent_.get());\n     auto controller = tracing_agent_->GetTracingController();\n     controller->AddTraceStateObserver(new NodeTraceStateObserver(controller));\n-    tracing::TraceEventHelper::SetTracingController(controller);\n     StartTracingAgent();\n     // Tracing must be initialized before platform threads are created.\n     platform_ = new NodePlatform(thread_pool_size, controller);\n@@ -2763,7 +2763,7 @@ MultiIsolatePlatform* GetMainThreadMultiIsolatePlatform() {\n \n MultiIsolatePlatform* CreatePlatform(\n     int thread_pool_size,\n-    TracingController* tracing_controller) {\n+    node::tracing::TracingController* tracing_controller) {\n   return new NodePlatform(thread_pool_size, tracing_controller);\n }\n "
        },
        {
            "sha": "372a76fabe8a8559aa846c1966bf4d29451ac4cb",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -14,7 +14,7 @@ using v8::Local;\n using v8::Object;\n using v8::Platform;\n using v8::Task;\n-using v8::TracingController;\n+using node::tracing::TracingController;\n \n namespace {\n "
        },
        {
            "sha": "441322a325b3c2e47c2bb2c87503b92e7ac5b2f6",
            "filename": "src/node_platform.h",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode_platform.h",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Fnode_platform.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.h?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -11,6 +11,7 @@\n #include \"libplatform/libplatform.h\"\n #include \"node.h\"\n #include \"node_mutex.h\"\n+#include \"tracing/agent.h\"\n #include \"uv.h\"\n \n namespace node {\n@@ -124,7 +125,8 @@ class WorkerThreadsTaskRunner {\n \n class NodePlatform : public MultiIsolatePlatform {\n  public:\n-  NodePlatform(int thread_pool_size, v8::TracingController* tracing_controller);\n+  NodePlatform(int thread_pool_size,\n+               node::tracing::TracingController* tracing_controller);\n   virtual ~NodePlatform() {}\n \n   void DrainTasks(v8::Isolate* isolate) override;\n@@ -142,7 +144,7 @@ class NodePlatform : public MultiIsolatePlatform {\n   bool IdleTasksEnabled(v8::Isolate* isolate) override;\n   double MonotonicallyIncreasingTime() override;\n   double CurrentClockTimeMillis() override;\n-  v8::TracingController* GetTracingController() override;\n+  node::tracing::TracingController* GetTracingController() override;\n   bool FlushForegroundTasks(v8::Isolate* isolate) override;\n \n   void RegisterIsolate(v8::Isolate* isolate, uv_loop_t* loop) override;\n@@ -158,7 +160,7 @@ class NodePlatform : public MultiIsolatePlatform {\n   std::unordered_map<v8::Isolate*,\n                      std::shared_ptr<PerIsolatePlatformData>> per_isolate_;\n \n-  v8::TracingController* tracing_controller_;\n+  node::tracing::TracingController* tracing_controller_;\n   std::shared_ptr<WorkerThreadsTaskRunner> worker_thread_task_runner_;\n };\n "
        },
        {
            "sha": "103df55da5236e9e9609e968e10fe6b26657b08a",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -1,6 +1,7 @@\n #include \"tracing/agent.h\"\n \n #include <string>\n+#include \"trace_event.h\"\n #include \"tracing/node_trace_buffer.h\"\n #include \"debug_utils.h\"\n #include \"env-inl.h\"\n@@ -207,9 +208,35 @@ void Agent::AppendTraceEvent(TraceObject* trace_event) {\n }\n \n void Agent::Flush(bool blocking) {\n+  for (const auto& event : metadata_events_)\n+    AppendTraceEvent(event.get());\n+\n   for (const auto& id_writer : writers_)\n     id_writer.second->Flush(blocking);\n }\n \n+void TracingController::AddMetadataEvent(\n+    const unsigned char* category_group_enabled,\n+    const char* name,\n+    int num_args,\n+    const char** arg_names,\n+    const unsigned char* arg_types,\n+    const uint64_t* arg_values,\n+    std::unique_ptr<v8::ConvertableToTraceFormat>* convertable_values,\n+    unsigned int flags) {\n+  std::unique_ptr<TraceObject> trace_event(new TraceObject);\n+  trace_event->Initialize(\n+      TRACE_EVENT_PHASE_METADATA, category_group_enabled, name,\n+      node::tracing::kGlobalScope,  // scope\n+      node::tracing::kNoId,         // id\n+      node::tracing::kNoId,         // bind_id\n+      num_args, arg_names, arg_types, arg_values, convertable_values,\n+      TRACE_EVENT_FLAG_NONE,\n+      CurrentTimestampMicroseconds(),\n+      CurrentCpuTimestampMicroseconds());\n+  node::tracing::TraceEventHelper::GetAgent()->AddMetadataEvent(\n+      std::move(trace_event));\n+}\n+\n }  // namespace tracing\n }  // namespace node"
        },
        {
            "sha": "db5e2a6bfd049fe0755d3925e141cd2ddb07b746",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -7,6 +7,7 @@\n #include \"util.h\"\n #include \"node_mutex.h\"\n \n+#include <list>\n #include <set>\n #include <string>\n #include <unordered_map>\n@@ -34,6 +35,15 @@ class TracingController : public v8::platform::tracing::TracingController {\n   int64_t CurrentTimestampMicroseconds() override {\n     return uv_hrtime() / 1000;\n   }\n+  void AddMetadataEvent(\n+      const unsigned char* category_group_enabled,\n+      const char* name,\n+      int num_args,\n+      const char** arg_names,\n+      const unsigned char* arg_types,\n+      const uint64_t* arg_values,\n+      std::unique_ptr<v8::ConvertableToTraceFormat>* convertable_values,\n+      unsigned int flags);\n };\n \n class AgentWriterHandle {\n@@ -93,6 +103,10 @@ class Agent {\n \n   // Writes to all writers registered through AddClient().\n   void AppendTraceEvent(TraceObject* trace_event);\n+\n+  void AddMetadataEvent(std::unique_ptr<TraceObject> event) {\n+    metadata_events_.push_back(std::move(event));\n+  }\n   // Flushes all writers registered through AddClient().\n   void Flush(bool blocking);\n \n@@ -131,6 +145,7 @@ class Agent {\n   ConditionVariable initialize_writer_condvar_;\n   uv_async_t initialize_writer_async_;\n   std::set<AsyncTraceWriter*> to_be_initialized_;\n+  std::list<std::unique_ptr<TraceObject>> metadata_events_;\n };\n \n void AgentWriterHandle::reset() {"
        },
        {
            "sha": "9232c34c4ca322d0c63d257e7f10334183b8325c",
            "filename": "src/tracing/trace_event.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Ftrace_event.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Ftrace_event.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.cc?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -3,14 +3,18 @@\n namespace node {\n namespace tracing {\n \n-v8::TracingController* g_controller = nullptr;\n+Agent* g_agent = nullptr;\n \n-void TraceEventHelper::SetTracingController(v8::TracingController* controller) {\n-  g_controller = controller;\n+void TraceEventHelper::SetAgent(Agent* agent) {\n+  g_agent = agent;\n }\n \n-v8::TracingController* TraceEventHelper::GetTracingController() {\n-  return g_controller;\n+Agent* TraceEventHelper::GetAgent() {\n+  return g_agent;\n+}\n+\n+TracingController* TraceEventHelper::GetTracingController() {\n+  return g_agent->GetTracingController();\n }\n \n }  // namespace tracing"
        },
        {
            "sha": "d5d4befb14600a29035507e0f139c8036349e0ba",
            "filename": "src/tracing/trace_event.h",
            "status": "modified",
            "additions": 27,
            "deletions": 13,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Ftrace_event.h",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/src%2Ftracing%2Ftrace_event.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.h?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -310,8 +310,9 @@ const uint64_t kNoId = 0;\n \n class TraceEventHelper {\n  public:\n-  static v8::TracingController* GetTracingController();\n-  static void SetTracingController(v8::TracingController* controller);\n+  static TracingController* GetTracingController();\n+  static Agent* GetAgent();\n+  static void SetAgent(Agent* agent);\n };\n \n // TraceID encapsulates an ID that can either be an integer or pointer. Pointers\n@@ -487,6 +488,26 @@ static V8_INLINE uint64_t AddTraceEventWithTimestampImpl(\n       arg_names, arg_types, arg_values, arg_convertables, flags, timestamp);\n }\n \n+static V8_INLINE void AddMetadataEventImpl(\n+    const uint8_t* category_group_enabled, const char* name, int32_t num_args,\n+    const char** arg_names, const uint8_t* arg_types,\n+    const uint64_t* arg_values, unsigned int flags) {\n+  std::unique_ptr<v8::ConvertableToTraceFormat> arg_convertibles[2];\n+  if (num_args > 0 && arg_types[0] == TRACE_VALUE_TYPE_CONVERTABLE) {\n+    arg_convertibles[0].reset(reinterpret_cast<v8::ConvertableToTraceFormat*>(\n+        static_cast<intptr_t>(arg_values[0])));\n+  }\n+  if (num_args > 1 && arg_types[1] == TRACE_VALUE_TYPE_CONVERTABLE) {\n+    arg_convertibles[1].reset(reinterpret_cast<v8::ConvertableToTraceFormat*>(\n+        static_cast<intptr_t>(arg_values[1])));\n+  }\n+  node::tracing::TracingController* controller =\n+      node::tracing::TraceEventHelper::GetTracingController();\n+  return controller->AddMetadataEvent(\n+      category_group_enabled, name, num_args, arg_names, arg_types, arg_values,\n+      arg_convertibles, flags);\n+}\n+\n // Define SetTraceValue for each allowed type. It stores the type and\n // value in the return arguments. This allows this API to avoid declaring any\n // structures so that it is portable to third_party libraries.\n@@ -632,23 +653,16 @@ static V8_INLINE uint64_t AddTraceEventWithTimestamp(\n }\n \n template <class ARG1_TYPE>\n-static V8_INLINE uint64_t AddMetadataEvent(\n+static V8_INLINE void AddMetadataEvent(\n     const uint8_t* category_group_enabled, const char* name,\n     const char* arg1_name, ARG1_TYPE&& arg1_val) {\n   const int num_args = 1;\n   uint8_t arg_type;\n   uint64_t arg_value;\n   SetTraceValue(std::forward<ARG1_TYPE>(arg1_val), &arg_type, &arg_value);\n-  // TODO(ofrobots): It would be good to add metadata events to a separate\n-  // buffer so that they can be periodically reemitted. For now, we have a\n-  // single buffer, so we just add them to the main buffer.\n-  return TRACE_EVENT_API_ADD_TRACE_EVENT(\n-      TRACE_EVENT_PHASE_METADATA,\n-      category_group_enabled, name,\n-      node::tracing::kGlobalScope,  // scope\n-      node::tracing::kNoId,         // id\n-      node::tracing::kNoId,         // bind_id\n-      num_args, &arg1_name, &arg_type, &arg_value, TRACE_EVENT_FLAG_NONE);\n+  AddMetadataEventImpl(\n+      category_group_enabled, name, num_args, &arg1_name, &arg_type, &arg_value,\n+      TRACE_EVENT_FLAG_NONE);\n }\n \n // Used by TRACE_EVENTx macros. Do not use directly."
        },
        {
            "sha": "f13481824734fb58137aea5390a67683d0d74633",
            "filename": "test/cctest/node_test_fixture.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fcctest%2Fnode_test_fixture.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fcctest%2Fnode_test_fixture.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.cc?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -3,4 +3,4 @@\n ArrayBufferUniquePtr NodeTestFixture::allocator{nullptr, nullptr};\n uv_loop_t NodeTestFixture::current_loop;\n NodePlatformUniquePtr NodeTestFixture::platform;\n-TracingControllerUniquePtr NodeTestFixture::tracing_controller;\n+TracingAgentUniquePtr NodeTestFixture::tracing_agent;"
        },
        {
            "sha": "f4c97b05027895e8bed850bcc7c9f90f775f0d0e",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -55,21 +55,20 @@ struct Argv {\n \n using ArrayBufferUniquePtr = std::unique_ptr<node::ArrayBufferAllocator,\n       decltype(&node::FreeArrayBufferAllocator)>;\n-using TracingControllerUniquePtr = std::unique_ptr<v8::TracingController>;\n+using TracingAgentUniquePtr = std::unique_ptr<node::tracing::Agent>;\n using NodePlatformUniquePtr = std::unique_ptr<node::NodePlatform>;\n \n class NodeTestFixture : public ::testing::Test {\n  protected:\n   static ArrayBufferUniquePtr allocator;\n-  static TracingControllerUniquePtr tracing_controller;\n+  static TracingAgentUniquePtr tracing_agent;\n   static NodePlatformUniquePtr platform;\n   static uv_loop_t current_loop;\n   v8::Isolate* isolate_;\n \n   static void SetUpTestCase() {\n-    tracing_controller.reset(new v8::TracingController());\n-    node::tracing::TraceEventHelper::SetTracingController(\n-        tracing_controller.get());\n+    tracing_agent.reset(new node::tracing::Agent());\n+    node::tracing::TraceEventHelper::SetAgent(tracing_agent.get());\n     CHECK_EQ(0, uv_loop_init(&current_loop));\n     platform.reset(static_cast<node::NodePlatform*>(\n           node::InitializeV8Platform(4)));"
        },
        {
            "sha": "645dcb2764a1be632ce46c78547809231d969191",
            "filename": "test/parallel/test-trace-events-dynamic-enable.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js",
            "raw_url": "https://github.com/nodejs/node/raw/f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-dynamic-enable.js?ref=f5986a464316e2c7c2a21f5a5e9ffa7e527fd9d4",
            "patch": "@@ -25,9 +25,12 @@ function post(message, data) {\n async function test() {\n   session.connect();\n \n-  let traceNotification = null;\n+  const events = [];\n   let tracingComplete = false;\n-  session.on('NodeTracing.dataCollected', (n) => traceNotification = n);\n+  session.on('NodeTracing.dataCollected', (n) => {\n+    assert.ok(n && n.data && n.data.value);\n+    events.push(...n.data.value);  // append the events.\n+  });\n   session.on('NodeTracing.tracingComplete', () => tracingComplete = true);\n \n   // Generate a node.perf event before tracing is enabled.\n@@ -47,10 +50,7 @@ async function test() {\n   session.disconnect();\n \n   assert.ok(tracingComplete);\n-  assert.ok(traceNotification);\n-  assert.ok(traceNotification.data && traceNotification.data.value);\n \n-  const events = traceNotification.data.value;\n   const marks = events.filter((t) => null !== /node\\.perf\\.usertim/.exec(t.cat));\n   assert.strictEqual(marks.length, 1);\n   assert.strictEqual(marks[0].name, 'mark2');"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 96,
        "deletions": 35
    }
}