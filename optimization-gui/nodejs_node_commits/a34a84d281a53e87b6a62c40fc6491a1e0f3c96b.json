{
    "author": "addaleax",
    "message": "src: simplify InspectorConsoleCall\n\nInstead of a JS object, set the is-in-console-call flag as\na boolean in C++.\n\nPR-URL: https://github.com/nodejs/node/pull/26168\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>",
    "sha": "a34a84d281a53e87b6a62c40fc6491a1e0f3c96b",
    "files": [
        {
            "sha": "579f93d540faa3e4d2fa6f85917ca14e163eb202",
            "filename": "lib/internal/util/inspector.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/lib%2Finternal%2Futil%2Finspector.js",
            "raw_url": "https://github.com/nodejs/node/raw/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/lib%2Finternal%2Futil%2Finspector.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil%2Finspector.js?ref=a34a84d281a53e87b6a62c40fc6491a1e0f3c96b",
            "patch": "@@ -33,7 +33,6 @@ function installConsoleExtensions(commandLineApi) {\n \n // Wrap a console implemented by Node.js with features from the VM inspector\n function wrapConsole(consoleFromNode, consoleFromVM) {\n-  const config = {};\n   const { consoleCall } = internalBinding('inspector');\n   for (const key of Object.keys(consoleFromVM)) {\n     // If global console has the same method as inspector console,\n@@ -42,8 +41,7 @@ function wrapConsole(consoleFromNode, consoleFromVM) {\n     if (consoleFromNode.hasOwnProperty(key)) {\n       consoleFromNode[key] = consoleCall.bind(consoleFromNode,\n                                               consoleFromVM[key],\n-                                              consoleFromNode[key],\n-                                              config);\n+                                              consoleFromNode[key]);\n     } else {\n       // Add additional console APIs from the inspector\n       consoleFromNode[key] = consoleFromVM[key];"
        },
        {
            "sha": "1f66380cf4ca823742af467648c38ae379f5d050",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=a34a84d281a53e87b6a62c40fc6491a1e0f3c96b",
            "patch": "@@ -404,6 +404,16 @@ inline void Environment::TryLoadAddon(\n   }\n }\n \n+#if HAVE_INSPECTOR\n+inline bool Environment::is_in_inspector_console_call() const {\n+  return is_in_inspector_console_call_;\n+}\n+\n+inline void Environment::set_is_in_inspector_console_call(bool value) {\n+  is_in_inspector_console_call_ = value;\n+}\n+#endif\n+\n inline Environment::AsyncHooks* Environment::async_hooks() {\n   return &async_hooks_;\n }"
        },
        {
            "sha": "d765c7bf529010feb91a47a244d7384445acb918",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=a34a84d281a53e87b6a62c40fc6491a1e0f3c96b",
            "patch": "@@ -870,6 +870,9 @@ class Environment {\n   inline inspector::Agent* inspector_agent() const {\n     return inspector_agent_.get();\n   }\n+\n+  inline bool is_in_inspector_console_call() const;\n+  inline void set_is_in_inspector_console_call(bool value);\n #endif\n \n   typedef ListHead<HandleWrap, &HandleWrap::handle_wrap_queue_> HandleWrapQueue;\n@@ -1039,6 +1042,7 @@ class Environment {\n \n #if HAVE_INSPECTOR\n   std::unique_ptr<inspector::Agent> inspector_agent_;\n+  bool is_in_inspector_console_call_ = false;\n #endif\n \n   // handle_wrap_queue_ and req_wrap_queue_ needs to be at a fixed offset from"
        },
        {
            "sha": "c2e80d93fd944ac72ee11fcefc51b0a9c9dc9f40",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 17,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a34a84d281a53e87b6a62c40fc6491a1e0f3c96b/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=a34a84d281a53e87b6a62c40fc6491a1e0f3c96b",
            "patch": "@@ -149,31 +149,22 @@ void InspectorConsoleCall(const FunctionCallbackInfo<Value>& info) {\n   Environment* env = Environment::GetCurrent(info);\n   Isolate* isolate = env->isolate();\n   Local<Context> context = isolate->GetCurrentContext();\n-  CHECK_LT(2, info.Length());\n-  SlicedArguments call_args(info, /* start */ 3);\n+  CHECK_GE(info.Length(), 2);\n+  SlicedArguments call_args(info, /* start */ 2);\n   if (InspectorEnabled(env)) {\n     Local<Value> inspector_method = info[0];\n     CHECK(inspector_method->IsFunction());\n-    Local<Value> config_value = info[2];\n-    CHECK(config_value->IsObject());\n-    Local<Object> config_object = config_value.As<Object>();\n-    Local<String> in_call_key = FIXED_ONE_BYTE_STRING(isolate, \"in_call\");\n-    bool has_in_call;\n-    if (!config_object->Has(context, in_call_key).To(&has_in_call))\n-      return;\n-    if (!has_in_call) {\n-      if (config_object->Set(context,\n-                             in_call_key,\n-                             v8::True(isolate)).IsNothing() ||\n+    if (!env->is_in_inspector_console_call()) {\n+      env->set_is_in_inspector_console_call(true);\n+      MaybeLocal<Value> ret =\n           inspector_method.As<Function>()->Call(context,\n                                                 info.Holder(),\n                                                 call_args.length(),\n-                                                call_args.out()).IsEmpty()) {\n+                                                call_args.out());\n+      env->set_is_in_inspector_console_call(false);\n+      if (ret.IsEmpty())\n         return;\n-      }\n     }\n-    if (config_object->Delete(context, in_call_key).IsNothing())\n-      return;\n   }\n \n   Local<Value> node_method = info[1];"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 23,
        "deletions": 20
    }
}