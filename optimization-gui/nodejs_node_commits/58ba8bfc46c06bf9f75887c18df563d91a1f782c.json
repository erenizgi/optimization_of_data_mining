{
    "author": "addaleax",
    "message": "worker: pre-allocate thread id\n\nAllocate a thread id before actually creating the Environment instance.\n\nPR-URL: https://github.com/nodejs/node/pull/26011\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "58ba8bfc46c06bf9f75887c18df563d91a1f782c",
    "files": [
        {
            "sha": "94fe595ac596caeda1f9e8114008bee7e581d4fa",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=58ba8bfc46c06bf9f75887c18df563d91a1f782c",
            "patch": "@@ -169,9 +169,14 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n \n static std::atomic<uint64_t> next_thread_id{0};\n \n+uint64_t Environment::AllocateThreadId() {\n+  return next_thread_id++;\n+}\n+\n Environment::Environment(IsolateData* isolate_data,\n                          Local<Context> context,\n-                         Flags flags)\n+                         Flags flags,\n+                         uint64_t thread_id)\n     : isolate_(context->GetIsolate()),\n       isolate_data_(isolate_data),\n       immediate_info_(context->GetIsolate()),\n@@ -181,7 +186,7 @@ Environment::Environment(IsolateData* isolate_data,\n       trace_category_state_(isolate_, kTraceCategoryCount),\n       stream_base_state_(isolate_, StreamBase::kNumStreamBaseStateFields),\n       flags_(flags),\n-      thread_id_(next_thread_id++),\n+      thread_id_(thread_id == kNoThreadId ? AllocateThreadId() : thread_id),\n       fs_stats_field_array_(isolate_, kFsStatsBufferLength),\n       fs_stats_field_bigint_array_(isolate_, kFsStatsBufferLength),\n       context_(context->GetIsolate(), context) {"
        },
        {
            "sha": "0228b2d9d02a5f2cca6f3112789b345b9f2773c1",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=58ba8bfc46c06bf9f75887c18df563d91a1f782c",
            "patch": "@@ -618,7 +618,8 @@ class Environment {\n \n   Environment(IsolateData* isolate_data,\n               v8::Local<v8::Context> context,\n-              Flags flags = Flags());\n+              Flags flags = Flags(),\n+              uint64_t thread_id = kNoThreadId);\n   ~Environment();\n \n   void Start(bool start_profiler_idle_notifier);\n@@ -763,6 +764,9 @@ class Environment {\n   inline bool has_run_bootstrapping_code() const;\n   inline void set_has_run_bootstrapping_code(bool has_run_bootstrapping_code);\n \n+  static uint64_t AllocateThreadId();\n+  static constexpr uint64_t kNoThreadId = -1;\n+\n   inline bool is_main_thread() const;\n   inline bool owns_process_state() const;\n   inline bool owns_inspector() const;"
        },
        {
            "sha": "36b4106d137eb580361dceaf217bc41bda8c40a7",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/58ba8bfc46c06bf9f75887c18df563d91a1f782c/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=58ba8bfc46c06bf9f75887c18df563d91a1f782c",
            "patch": "@@ -71,7 +71,8 @@ Worker::Worker(Environment* env,\n                Local<Object> wrap,\n                const std::string& url,\n                std::shared_ptr<PerIsolateOptions> per_isolate_opts)\n-    : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_WORKER), url_(url) {\n+    : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_WORKER), url_(url),\n+      thread_id_(Environment::AllocateThreadId()) {\n   Debug(this, \"Creating new worker instance at %p\", static_cast<void*>(this));\n \n   // Set up everything that needs to be set up in the parent environment.\n@@ -114,11 +115,11 @@ Worker::Worker(Environment* env,\n     Context::Scope context_scope(context);\n \n     // TODO(addaleax): Use CreateEnvironment(), or generally another public API.\n-    env_.reset(new Environment(isolate_data_.get(), context));\n+    env_.reset(new Environment(\n+        isolate_data_.get(), context, Flags::kNoFlags, thread_id_));\n     CHECK_NOT_NULL(env_);\n     env_->set_abort_on_uncaught_exception(false);\n     env_->set_worker_context(this);\n-    thread_id_ = env_->thread_id();\n \n     env_->Start(env->profiler_idle_notifier_started());\n     env_->ProcessCliArgs(std::vector<std::string>{},"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 16,
        "deletions": 6
    }
}