{
    "author": "joyeecheung",
    "message": "test: split encoding tests where some cases can be run without ICU\n\nSplit the following tests:\n\n- `test-whatwg-encoding-textdecoder-utf16-surrogates.js`\n- `test-whatwg-encoding-textdecoder-ignorebom.js`\n- `test-whatwg-encoding-textdecoder-streaming.js`\n\nEach into two files: one that can be run without ICU and one that has\nto be run with ICU. The latter can be replaced with WPT later.\n\nPR-URL: https://github.com/nodejs/node/pull/25155\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
    "files": [
        {
            "sha": "9f6368dcd5e93f8e17a43c0a736bea2aee78c9b0",
            "filename": "test/parallel/test-whatwg-encoding-custom-textdecoder-ignorebom.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-ignorebom.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-ignorebom.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-ignorebom.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+// From: https://github.com/w3c/web-platform-tests/blob/7f567fa29c/encoding/textdecoder-ignorebom.html\n+// This is the part that can be run without ICU\n+\n+require('../common');\n+\n+const assert = require('assert');\n+\n+const cases = [\n+  {\n+    encoding: 'utf-8',\n+    bytes: [0xEF, 0xBB, 0xBF, 0x61, 0x62, 0x63]\n+  },\n+  {\n+    encoding: 'utf-16le',\n+    bytes: [0xFF, 0xFE, 0x61, 0x00, 0x62, 0x00, 0x63, 0x00]\n+  }\n+];\n+\n+cases.forEach((testCase) => {\n+  const BOM = '\\uFEFF';\n+  let decoder = new TextDecoder(testCase.encoding, { ignoreBOM: true });\n+  const bytes = new Uint8Array(testCase.bytes);\n+  assert.strictEqual(decoder.decode(bytes), `${BOM}abc`);\n+  decoder = new TextDecoder(testCase.encoding, { ignoreBOM: false });\n+  assert.strictEqual(decoder.decode(bytes), 'abc');\n+  decoder = new TextDecoder(testCase.encoding);\n+  assert.strictEqual(decoder.decode(bytes), 'abc');\n+});"
        },
        {
            "sha": "5484929326254dc7708eb6d01063407829df01ac",
            "filename": "test/parallel/test-whatwg-encoding-custom-textdecoder-streaming.js",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-streaming.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-streaming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-streaming.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -0,0 +1,38 @@\n+'use strict';\n+\n+// From: https://github.com/w3c/web-platform-tests/blob/fa9436d12c/encoding/textdecoder-streaming.html\n+// This is the part that can be run without ICU\n+\n+require('../common');\n+\n+const assert = require('assert');\n+\n+const string =\n+  '\\x00123ABCabc\\x80\\xFF\\u0100\\u1000\\uFFFD\\uD800\\uDC00\\uDBFF\\uDFFF';\n+const octets = {\n+  'utf-8': [\n+    0x00, 0x31, 0x32, 0x33, 0x41, 0x42, 0x43, 0x61, 0x62, 0x63, 0xc2, 0x80,\n+    0xc3, 0xbf, 0xc4, 0x80, 0xe1, 0x80, 0x80, 0xef, 0xbf, 0xbd, 0xf0, 0x90,\n+    0x80, 0x80, 0xf4, 0x8f, 0xbf, 0xbf],\n+  'utf-16le': [\n+    0x00, 0x00, 0x31, 0x00, 0x32, 0x00, 0x33, 0x00, 0x41, 0x00, 0x42, 0x00,\n+    0x43, 0x00, 0x61, 0x00, 0x62, 0x00, 0x63, 0x00, 0x80, 0x00, 0xFF, 0x00,\n+    0x00, 0x01, 0x00, 0x10, 0xFD, 0xFF, 0x00, 0xD8, 0x00, 0xDC, 0xFF, 0xDB,\n+    0xFF, 0xDF]\n+};\n+\n+Object.keys(octets).forEach((encoding) => {\n+  for (let len = 1; len <= 5; ++len) {\n+    const encoded = octets[encoding];\n+    const decoder = new TextDecoder(encoding);\n+    let out = '';\n+    for (let i = 0; i < encoded.length; i += len) {\n+      const sub = [];\n+      for (let j = i; j < encoded.length && j < i + len; ++j)\n+        sub.push(encoded[j]);\n+      out += decoder.decode(new Uint8Array(sub), { stream: true });\n+    }\n+    out += decoder.decode();\n+    assert.strictEqual(out, string);\n+  }\n+});"
        },
        {
            "sha": "3af83e01b0450d50afa60ffc77b6af19220b737f",
            "filename": "test/parallel/test-whatwg-encoding-custom-textdecoder-utf16-surrogates.js",
            "status": "renamed",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-utf16-surrogates.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-utf16-surrogates.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-custom-textdecoder-utf16-surrogates.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n // From: https://github.com/w3c/web-platform-tests/blob/39a67e2fff/encoding/textdecoder-utf16-surrogates.html\n+// With the twist that we specifically test for Node.js error codes\n \n const common = require('../common');\n \n@@ -43,7 +44,7 @@ const bad = [\n ];\n \n bad.forEach((t) => {\n-\n+  // TODO(joyeecheung): remove this when WPT is ported\n   assert.strictEqual(\n     new TextDecoder(t.encoding).decode(new Uint8Array(t.input)),\n     t.expected);",
            "previous_filename": "test/parallel/test-whatwg-encoding-textdecoder-utf16-surrogates.js"
        },
        {
            "sha": "7421965c9fb5178972cb27604ef584ae0576b941",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-ignorebom.js",
            "status": "modified",
            "additions": 7,
            "deletions": 10,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -1,34 +1,31 @@\n 'use strict';\n \n // From: https://github.com/w3c/web-platform-tests/blob/7f567fa29c/encoding/textdecoder-ignorebom.html\n+// TODO(joyeecheung): replace this with WPT\n \n const common = require('../common');\n \n+if (!common.hasIntl)\n+  common.skip('missing Intl');\n+\n const assert = require('assert');\n \n const cases = [\n   {\n     encoding: 'utf-8',\n-    bytes: [0xEF, 0xBB, 0xBF, 0x61, 0x62, 0x63],\n-    skipNoIntl: false\n+    bytes: [0xEF, 0xBB, 0xBF, 0x61, 0x62, 0x63]\n   },\n   {\n     encoding: 'utf-16le',\n-    bytes: [0xFF, 0xFE, 0x61, 0x00, 0x62, 0x00, 0x63, 0x00],\n-    skipNoIntl: false\n+    bytes: [0xFF, 0xFE, 0x61, 0x00, 0x62, 0x00, 0x63, 0x00]\n   },\n   {\n     encoding: 'utf-16be',\n-    bytes: [0xFE, 0xFF, 0x00, 0x61, 0x00, 0x62, 0x00, 0x63],\n-    skipNoIntl: true\n+    bytes: [0xFE, 0xFF, 0x00, 0x61, 0x00, 0x62, 0x00, 0x63]\n   }\n ];\n \n cases.forEach((testCase) => {\n-  if (testCase.skipNoIntl && !common.hasIntl) {\n-    console.log(`skipping ${testCase.encoding} because missing Intl`);\n-    return; // skipping\n-  }\n   const BOM = '\\uFEFF';\n   let decoder = new TextDecoder(testCase.encoding, { ignoreBOM: true });\n   const bytes = new Uint8Array(testCase.bytes);"
        },
        {
            "sha": "acc39a74e5cf56c50f0daf2743ac0bc38e67a446",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-streaming.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -1,9 +1,13 @@\n 'use strict';\n \n // From: https://github.com/w3c/web-platform-tests/blob/fa9436d12c/encoding/textdecoder-streaming.html\n+// TODO(joyeecheung): replace this with WPT\n \n const common = require('../common');\n \n+if (!common.hasIntl)\n+  common.skip('missing Intl');\n+\n const assert = require('assert');\n \n const string ="
        },
        {
            "sha": "453b49e5b92730a44b6b013ca6fe7743e353ef39",
            "filename": "test/parallel/test-whatwg-encoding-textencoder-utf16-surrogates.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js?ref=2b91c2b5ee01114e8ea435cb6e8211f9bf2f2f0a",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n // From: https://github.com/w3c/web-platform-tests/blob/fa9436d12c/encoding/textencoder-utf16-surrogates.html\n+// TODO(joyeecheung): replace this with WPT\n \n require('../common');\n "
        }
    ],
    "stats": {
        "total": 93,
        "additions": 82,
        "deletions": 11
    }
}