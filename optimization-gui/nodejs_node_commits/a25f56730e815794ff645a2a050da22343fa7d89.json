{
    "author": "BridgeAR",
    "message": "assert: detect faulty throws usage\n\nOne of the biggest downsides to the `assert.throws` API is that it\ndoes not check for the error message in case that is used as second\nargument. It will instead be used in case no error is thrown.\n\nThis improves the situation by checking the actual error message\nagainst the provided one and throws an error in case they are\nidentical. It is very unlikely that the user wants to use that error\nmessage as information instead of checking against that message.\n\nPR-URL: https://github.com/nodejs/node/pull/19867\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a25f56730e815794ff645a2a050da22343fa7d89",
    "files": [
        {
            "sha": "49834414decffe10d492df04660de826fb90199a",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/a25f56730e815794ff645a2a050da22343fa7d89/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/a25f56730e815794ff645a2a050da22343fa7d89/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=a25f56730e815794ff645a2a050da22343fa7d89",
            "patch": "@@ -586,6 +586,14 @@ found [here][online].\n <a id=\"nodejs-error-codes\"></a>\n ## Node.js Error Codes\n \n+<a id=\"ERR_AMBIGUOUS_ARGUMENT\"></a>\n+### ERR_AMBIGUOUS_ARGUMENT\n+\n+This is triggered by the `assert` module in case e.g.,\n+`assert.throws(fn, message)` is used in a way that the message is the thrown\n+error message. This is ambiguous because the message is not verifying the error\n+message and will only be thrown in case no error is thrown.\n+\n <a id=\"ERR_ARG_NOT_ITERABLE\"></a>\n ### ERR_ARG_NOT_ITERABLE\n "
        },
        {
            "sha": "0a505d553a405c5615aa173deb924540cfb350f9",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/a25f56730e815794ff645a2a050da22343fa7d89/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/a25f56730e815794ff645a2a050da22343fa7d89/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=a25f56730e815794ff645a2a050da22343fa7d89",
            "patch": "@@ -29,6 +29,7 @@ const {\n   AssertionError,\n   errorCache,\n   codes: {\n+    ERR_AMBIGUOUS_ARGUMENT,\n     ERR_INVALID_ARG_TYPE\n   }\n } = require('internal/errors');\n@@ -470,6 +471,19 @@ function expectsError(stackStartFn, actual, error, message) {\n                                      ['Object', 'Error', 'Function', 'RegExp'],\n                                      error);\n     }\n+    if (typeof actual === 'object' && actual !== null) {\n+      if (actual.message === error) {\n+        throw new ERR_AMBIGUOUS_ARGUMENT(\n+          'error/message',\n+          `The error message \"${actual.message}\" is identical to the message.`\n+        );\n+      }\n+    } else if (actual === error) {\n+      throw new ERR_AMBIGUOUS_ARGUMENT(\n+        'error/message',\n+        `The error \"${actual}\" is identical to the message.`\n+      );\n+    }\n     message = error;\n     error = null;\n   }"
        },
        {
            "sha": "c8be91796ec249f671c017529f188b0f9ab0216c",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/a25f56730e815794ff645a2a050da22343fa7d89/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/a25f56730e815794ff645a2a050da22343fa7d89/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=a25f56730e815794ff645a2a050da22343fa7d89",
            "patch": "@@ -640,6 +640,7 @@ module.exports = exports = {\n //\n // Note: Node.js specific errors must begin with the prefix ERR_\n \n+E('ERR_AMBIGUOUS_ARGUMENT', 'The \"%s\" argument is ambiguous. %s', TypeError);\n E('ERR_ARG_NOT_ITERABLE', '%s must be iterable', TypeError);\n E('ERR_ASSERTION', '%s', Error);\n E('ERR_ASYNC_CALLBACK', '%s must be a function', TypeError);"
        },
        {
            "sha": "c06155160495bc46ca00eb412b29a7fd2abb551e",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/a25f56730e815794ff645a2a050da22343fa7d89/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/a25f56730e815794ff645a2a050da22343fa7d89/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=a25f56730e815794ff645a2a050da22343fa7d89",
            "patch": "@@ -836,3 +836,32 @@ common.expectsError(\n     }\n   );\n }\n+\n+assert.throws(\n+  () => a.throws(\n+    // eslint-disable-next-line no-throw-literal\n+    () => { throw 'foo'; },\n+    'foo'\n+  ),\n+  {\n+    code: 'ERR_AMBIGUOUS_ARGUMENT',\n+    message: 'The \"error/message\" argument is ambiguous. ' +\n+             'The error \"foo\" is identical to the message.'\n+  }\n+);\n+\n+assert.throws(\n+  () => a.throws(\n+    () => { throw new TypeError('foo'); },\n+    'foo'\n+  ),\n+  {\n+    code: 'ERR_AMBIGUOUS_ARGUMENT',\n+    message: 'The \"error/message\" argument is ambiguous. ' +\n+             'The error message \"foo\" is identical to the message.'\n+  }\n+);\n+\n+// Should not throw.\n+// eslint-disable-next-line no-restricted-syntax, no-throw-literal\n+assert.throws(() => { throw null; }, 'foo');"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 52,
        "deletions": 0
    }
}