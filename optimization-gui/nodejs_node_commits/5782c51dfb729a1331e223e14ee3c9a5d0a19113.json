{
    "author": "trivikr",
    "message": "test: http2 stream.respond() error checks\n\nPR-URL: https://github.com/nodejs/node/pull/18861\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "5782c51dfb729a1331e223e14ee3c9a5d0a19113",
    "files": [
        {
            "sha": "656a27df26edb533516d432239e60e617884c675",
            "filename": "test/parallel/test-http2-respond-errors.js",
            "status": "modified",
            "additions": 67,
            "deletions": 81,
            "changes": 148,
            "blob_url": "https://github.com/nodejs/node/blob/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-respond-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-respond-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-errors.js?ref=5782c51dfb729a1331e223e14ee3c9a5d0a19113",
            "patch": "@@ -5,95 +5,81 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n const http2 = require('http2');\n-const {\n-  constants,\n-  Http2Stream,\n-  nghttp2ErrorString\n-} = process.binding('http2');\n-const { NghttpError } = require('internal/http2/util');\n-\n-// tests error handling within respond\n-// - every other NGHTTP2 error from binding (should emit stream error)\n-\n-const specificTestKeys = [];\n-\n-const specificTests = [];\n-\n-const genericTests = Object.getOwnPropertyNames(constants)\n-  .filter((key) => (\n-    key.indexOf('NGHTTP2_ERR') === 0 && specificTestKeys.indexOf(key) < 0\n-  ))\n-  .map((key) => ({\n-    ngError: constants[key],\n-    error: {\n-      code: 'ERR_HTTP2_ERROR',\n-      type: NghttpError,\n-      name: 'Error [ERR_HTTP2_ERROR]',\n-      message: nghttp2ErrorString(constants[key])\n-    },\n-    type: 'stream'\n-  }));\n-\n-\n-const tests = specificTests.concat(genericTests);\n-\n-let currentError;\n-\n-// mock submitResponse because we only care about testing error handling\n-Http2Stream.prototype.respond = () => currentError.ngError;\n+const { Http2Stream } = process.binding('http2');\n+\n+const types = {\n+  boolean: true,\n+  function: () => {},\n+  number: 1,\n+  object: {},\n+  array: [],\n+  null: null,\n+  symbol: Symbol('test')\n+};\n \n const server = http2.createServer();\n-server.on('stream', common.mustCall((stream, headers) => {\n-  const errorMustCall = common.expectsError(currentError.error);\n-  const errorMustNotCall = common.mustNotCall(\n-    `${currentError.error.code} should emit on ${currentError.type}`\n-  );\n-\n-  if (currentError.type === 'stream') {\n-    stream.session.on('error', errorMustNotCall);\n-    stream.on('error', errorMustCall);\n-    stream.on('error', common.mustCall(() => {\n-      stream.destroy();\n-    }));\n-  } else {\n-    stream.session.once('error', errorMustCall);\n-    stream.on('error', errorMustNotCall);\n-  }\n \n-  stream.respond();\n-}, tests.length));\n+Http2Stream.prototype.respond = () => 1;\n+server.on('stream', common.mustCall((stream) => {\n \n-server.listen(0, common.mustCall(() => runTest(tests.shift())));\n+  // Check for all possible TypeError triggers on options.getTrailers\n+  Object.entries(types).forEach(([type, value]) => {\n+    if (type === 'function') {\n+      return;\n+    }\n \n-function runTest(test) {\n-  const port = server.address().port;\n-  const url = `http://localhost:${port}`;\n-  const headers = {\n-    ':path': '/',\n-    ':method': 'POST',\n-    ':scheme': 'http',\n-    ':authority': `localhost:${port}`\n-  };\n+    common.expectsError(\n+      () => stream.respond({\n+        'content-type': 'text/plain'\n+      }, {\n+        ['getTrailers']: value\n+      }),\n+      {\n+        type: TypeError,\n+        code: 'ERR_INVALID_OPT_VALUE',\n+        message: `The value \"${String(value)}\" is invalid ` +\n+                  'for option \"getTrailers\"'\n+      }\n+    );\n+  });\n+\n+  // Send headers\n+  stream.respond({\n+    'content-type': 'text/plain'\n+  }, {\n+    ['getTrailers']: () => common.mustCall()\n+  });\n+\n+  // Should throw if headers already sent\n+  common.expectsError(\n+    () => stream.respond(),\n+    {\n+      type: Error,\n+      code: 'ERR_HTTP2_HEADERS_SENT',\n+      message: 'Response has already been initiated.'\n+    }\n+  );\n \n-  const client = http2.connect(url);\n-  const req = client.request(headers);\n-  req.on('error', common.expectsError({\n-    code: 'ERR_HTTP2_STREAM_ERROR',\n-    type: Error,\n-    message: 'Stream closed with error code 2'\n-  }));\n+  // Should throw if stream already destroyed\n+  stream.destroy();\n+  common.expectsError(\n+    () => stream.respond(),\n+    {\n+      type: Error,\n+      code: 'ERR_HTTP2_INVALID_STREAM',\n+      message: 'The stream has been destroyed'\n+    }\n+  );\n+}));\n \n-  currentError = test;\n-  req.resume();\n-  req.end();\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  const req = client.request();\n \n   req.on('end', common.mustCall(() => {\n     client.close();\n-\n-    if (!tests.length) {\n-      server.close();\n-    } else {\n-      runTest(tests.shift());\n-    }\n+    server.close();\n   }));\n-}\n+  req.resume();\n+  req.end();\n+}));"
        },
        {
            "sha": "5ec953c54423608ab0abb4da78476d386afaf586",
            "filename": "test/parallel/test-http2-respond-nghttperrors.js",
            "status": "added",
            "additions": 99,
            "deletions": 0,
            "changes": 99,
            "blob_url": "https://github.com/nodejs/node/blob/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js?ref=5782c51dfb729a1331e223e14ee3c9a5d0a19113",
            "patch": "@@ -0,0 +1,99 @@\n+'use strict';\n+// Flags: --expose-internals\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const http2 = require('http2');\n+const {\n+  constants,\n+  Http2Stream,\n+  nghttp2ErrorString\n+} = process.binding('http2');\n+const { NghttpError } = require('internal/http2/util');\n+\n+// tests error handling within respond\n+// - every other NGHTTP2 error from binding (should emit stream error)\n+\n+const specificTestKeys = [];\n+\n+const specificTests = [];\n+\n+const genericTests = Object.getOwnPropertyNames(constants)\n+  .filter((key) => (\n+    key.indexOf('NGHTTP2_ERR') === 0 && specificTestKeys.indexOf(key) < 0\n+  ))\n+  .map((key) => ({\n+    ngError: constants[key],\n+    error: {\n+      code: 'ERR_HTTP2_ERROR',\n+      type: NghttpError,\n+      name: 'Error [ERR_HTTP2_ERROR]',\n+      message: nghttp2ErrorString(constants[key])\n+    },\n+    type: 'stream'\n+  }));\n+\n+\n+const tests = specificTests.concat(genericTests);\n+\n+let currentError;\n+\n+// mock submitResponse because we only care about testing error handling\n+Http2Stream.prototype.respond = () => currentError.ngError;\n+\n+const server = http2.createServer();\n+server.on('stream', common.mustCall((stream, headers) => {\n+  const errorMustCall = common.expectsError(currentError.error);\n+  const errorMustNotCall = common.mustNotCall(\n+    `${currentError.error.code} should emit on ${currentError.type}`\n+  );\n+\n+  if (currentError.type === 'stream') {\n+    stream.session.on('error', errorMustNotCall);\n+    stream.on('error', errorMustCall);\n+    stream.on('error', common.mustCall(() => {\n+      stream.destroy();\n+    }));\n+  } else {\n+    stream.session.once('error', errorMustCall);\n+    stream.on('error', errorMustNotCall);\n+  }\n+\n+  stream.respond();\n+}, tests.length));\n+\n+server.listen(0, common.mustCall(() => runTest(tests.shift())));\n+\n+function runTest(test) {\n+  const port = server.address().port;\n+  const url = `http://localhost:${port}`;\n+  const headers = {\n+    ':path': '/',\n+    ':method': 'POST',\n+    ':scheme': 'http',\n+    ':authority': `localhost:${port}`\n+  };\n+\n+  const client = http2.connect(url);\n+  const req = client.request(headers);\n+  req.on('error', common.expectsError({\n+    code: 'ERR_HTTP2_STREAM_ERROR',\n+    type: Error,\n+    message: 'Stream closed with error code 2'\n+  }));\n+\n+  currentError = test;\n+  req.resume();\n+  req.end();\n+\n+  req.on('end', common.mustCall(() => {\n+    client.close();\n+\n+    if (!tests.length) {\n+      server.close();\n+    } else {\n+      runTest(tests.shift());\n+    }\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 247,
        "additions": 166,
        "deletions": 81
    }
}