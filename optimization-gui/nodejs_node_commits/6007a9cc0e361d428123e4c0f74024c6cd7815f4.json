{
    "author": "princjef",
    "message": "https: add extra options to Agent#getName()\n\nAdds the remaining options from tls.createSecureContext() to the\nstring generated by Agent#getName(). This allows https.request() to\naccept the options and generate unique sockets appropriately.\n\nPR-URL: https://github.com/nodejs/node/pull/16402\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "6007a9cc0e361d428123e4c0f74024c6cd7815f4",
    "files": [
        {
            "sha": "58e62ccced47286898708059022de4a5cfb15e36",
            "filename": "doc/api/https.md",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/6007a9cc0e361d428123e4c0f74024c6cd7815f4/doc%2Fapi%2Fhttps.md",
            "raw_url": "https://github.com/nodejs/node/raw/6007a9cc0e361d428123e4c0f74024c6cd7815f4/doc%2Fapi%2Fhttps.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttps.md?ref=6007a9cc0e361d428123e4c0f74024c6cd7815f4",
            "patch": "@@ -12,7 +12,7 @@ separate module.\n added: v0.4.5\n -->\n \n-An Agent object for HTTPS similar to [`http.Agent`][].  See [`https.request()`][]\n+An [`Agent`][] object for HTTPS similar to [`http.Agent`][].  See [`https.request()`][]\n for more information.\n \n ## Class: https.Server\n@@ -168,9 +168,10 @@ changes:\n \n Makes a request to a secure web server.\n \n-The following additional `options` from [`tls.connect()`][] are also accepted\n-when using a custom [`Agent`][]: `ca`, `cert`, `ciphers`, `clientCertEngine`,\n-`key`, `passphrase`, `pfx`, `rejectUnauthorized`, `secureProtocol`, `servername`\n+The following additional `options` from [`tls.connect()`][] are also accepted:\n+`ca`, `cert`, `ciphers`, `clientCertEngine`, `crl`, `dhparam`, `ecdhCurve`,\n+`honorCipherOrder`, `key`, `passphrase`, `pfx`, `rejectUnauthorized`,\n+`secureOptions`, `secureProtocol`, `servername`, `sessionIdContext`\n \n `options` can be an object, a string, or a [`URL`][] object. If `options` is a\n string, it is automatically parsed with [`url.parse()`][]. If it is a [`URL`][]\n@@ -220,7 +221,7 @@ const req = https.request(options, (res) => {\n });\n ```\n \n-Alternatively, opt out of connection pooling by not using an `Agent`.\n+Alternatively, opt out of connection pooling by not using an [`Agent`][].\n \n Example:\n "
        },
        {
            "sha": "84ddeb5036a90094a5c0b56285e92c1c4a6496fe",
            "filename": "lib/https.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/6007a9cc0e361d428123e4c0f74024c6cd7815f4/lib%2Fhttps.js",
            "raw_url": "https://github.com/nodejs/node/raw/6007a9cc0e361d428123e4c0f74024c6cd7815f4/lib%2Fhttps.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttps.js?ref=6007a9cc0e361d428123e4c0f74024c6cd7815f4",
            "patch": "@@ -194,6 +194,30 @@ Agent.prototype.getName = function getName(options) {\n   if (options.secureProtocol)\n     name += options.secureProtocol;\n \n+  name += ':';\n+  if (options.crl)\n+    name += options.crl;\n+\n+  name += ':';\n+  if (options.honorCipherOrder !== undefined)\n+    name += options.honorCipherOrder;\n+\n+  name += ':';\n+  if (options.ecdhCurve)\n+    name += options.ecdhCurve;\n+\n+  name += ':';\n+  if (options.dhparam)\n+    name += options.dhparam;\n+\n+  name += ':';\n+  if (options.secureOptions !== undefined)\n+    name += options.secureOptions;\n+\n+  name += ':';\n+  if (options.sessionIdContext)\n+    name += options.sessionIdContext;\n+\n   return name;\n };\n "
        },
        {
            "sha": "8d10524d902ca7af0a122908a5b444c505f293df",
            "filename": "test/parallel/test-https-agent-additional-options.js",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/nodejs/node/blob/6007a9cc0e361d428123e4c0f74024c6cd7815f4/test%2Fparallel%2Ftest-https-agent-additional-options.js",
            "raw_url": "https://github.com/nodejs/node/raw/6007a9cc0e361d428123e4c0f74024c6cd7815f4/test%2Fparallel%2Ftest-https-agent-additional-options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-agent-additional-options.js?ref=6007a9cc0e361d428123e4c0f74024c6cd7815f4",
            "patch": "@@ -0,0 +1,87 @@\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const crypto = require('crypto');\n+const https = require('https');\n+const fixtures = require('../common/fixtures');\n+\n+const options = {\n+  key: fixtures.readKey('agent1-key.pem'),\n+  cert: fixtures.readKey('agent1-cert.pem'),\n+  ca: fixtures.readKey('ca1-cert.pem')\n+};\n+\n+const server = https.Server(options, function(req, res) {\n+  res.writeHead(200);\n+  res.end('hello world\\n');\n+});\n+\n+function getBaseOptions(port) {\n+  return {\n+    path: '/',\n+    port: port,\n+    ca: options.ca,\n+    rejectUnautorized: true,\n+    servername: 'agent1',\n+  };\n+}\n+\n+const updatedValues = new Map([\n+  ['dhparam', fixtures.readKey('dh2048.pem')],\n+  ['ecdhCurve', 'secp384r1'],\n+  ['honorCipherOrder', true],\n+  ['secureOptions', crypto.constants.SSL_OP_CIPHER_SERVER_PREFERENCE],\n+  ['secureProtocol', 'TLSv1_method'],\n+  ['sessionIdContext', 'sessionIdContext'],\n+]);\n+\n+function variations(iter, port, cb) {\n+  const { done, value } = iter.next();\n+  if (done) {\n+    return common.mustCall(cb);\n+  } else {\n+    const [key, val] = value;\n+    return common.mustCall(function(res) {\n+      res.resume();\n+      https.globalAgent.once('free', common.mustCall(function() {\n+        https.get(\n+          Object.assign({}, getBaseOptions(port), { [key]: val }),\n+          variations(iter, port, cb)\n+        );\n+      }));\n+    });\n+  }\n+}\n+\n+server.listen(0, common.mustCall(function() {\n+  const port = this.address().port;\n+  const globalAgent = https.globalAgent;\n+  globalAgent.keepAlive = true;\n+  https.get(getBaseOptions(port), variations(\n+    updatedValues.entries(),\n+    port,\n+    common.mustCall(function(res) {\n+      res.resume();\n+      globalAgent.once('free', common.mustCall(function() {\n+        // Verify that different keep-alived connections are created\n+        // for the base call and each variation\n+        const keys = Object.keys(globalAgent.freeSockets);\n+        assert.strictEqual(keys.length, 1 + updatedValues.size);\n+        let i = 1;\n+        for (const [, value] of updatedValues) {\n+          assert.ok(\n+            keys[i].startsWith(value.toString() + ':') ||\n+            keys[i].endsWith(':' + value.toString()) ||\n+            keys[i].includes(':' + value.toString() + ':')\n+          );\n+          i++;\n+        }\n+        globalAgent.destroy();\n+        server.close();\n+      }));\n+    })\n+  ));\n+}));"
        },
        {
            "sha": "c29e09731df0b204b90409cbccb083ab7ef4666f",
            "filename": "test/parallel/test-https-agent-getname.js",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/6007a9cc0e361d428123e4c0f74024c6cd7815f4/test%2Fparallel%2Ftest-https-agent-getname.js",
            "raw_url": "https://github.com/nodejs/node/raw/6007a9cc0e361d428123e4c0f74024c6cd7815f4/test%2Fparallel%2Ftest-https-agent-getname.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-agent-getname.js?ref=6007a9cc0e361d428123e4c0f74024c6cd7815f4",
            "patch": "@@ -12,7 +12,7 @@ const agent = new https.Agent();\n // empty options\n assert.strictEqual(\n   agent.getName({}),\n-  'localhost:::::::::::'\n+  'localhost:::::::::::::::::'\n );\n \n // pass all options arguments\n@@ -23,13 +23,21 @@ const options = {\n   ca: 'ca',\n   cert: 'cert',\n   ciphers: 'ciphers',\n+  crl: [Buffer.from('c'), Buffer.from('r'), Buffer.from('l')],\n+  dhparam: 'dhparam',\n+  ecdhCurve: 'ecdhCurve',\n+  honorCipherOrder: false,\n   key: 'key',\n   pfx: 'pfx',\n   rejectUnauthorized: false,\n+  secureOptions: 0,\n+  secureProtocol: 'secureProtocol',\n   servername: 'localhost',\n+  sessionIdContext: 'sessionIdContext'\n };\n \n assert.strictEqual(\n   agent.getName(options),\n-  '0.0.0.0:443:192.168.1.1:ca:cert::ciphers:key:pfx:false:localhost:'\n+  '0.0.0.0:443:192.168.1.1:ca:cert::ciphers:key:pfx:false:localhost:' +\n+    'secureProtocol:c,r,l:false:ecdhCurve:dhparam:0:sessionIdContext'\n );"
        },
        {
            "sha": "82554952e8446ba5814d04ffbbd7e6c9be2097c8",
            "filename": "test/parallel/test-https-agent-secure-protocol.js",
            "status": "removed",
            "additions": 0,
            "deletions": 57,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/b8f47b27571f8d763f811f017be3fb37d466c4fc/test%2Fparallel%2Ftest-https-agent-secure-protocol.js",
            "raw_url": "https://github.com/nodejs/node/raw/b8f47b27571f8d763f811f017be3fb37d466c4fc/test%2Fparallel%2Ftest-https-agent-secure-protocol.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-agent-secure-protocol.js?ref=b8f47b27571f8d763f811f017be3fb37d466c4fc",
            "patch": "@@ -1,57 +0,0 @@\n-'use strict';\n-const common = require('../common');\n-if (!common.hasCrypto)\n-  common.skip('missing crypto');\n-\n-const assert = require('assert');\n-const https = require('https');\n-const fixtures = require('../common/fixtures');\n-\n-const options = {\n-  key: fixtures.readKey('agent1-key.pem'),\n-  cert: fixtures.readKey('agent1-cert.pem'),\n-  ca: fixtures.readKey('ca1-cert.pem')\n-};\n-\n-const server = https.Server(options, function(req, res) {\n-  res.writeHead(200);\n-  res.end('hello world\\n');\n-});\n-\n-server.listen(0, common.mustCall(function() {\n-  const port = this.address().port;\n-  const globalAgent = https.globalAgent;\n-  globalAgent.keepAlive = true;\n-  https.get({\n-    path: '/',\n-    port: port,\n-    ca: options.ca,\n-    rejectUnauthorized: true,\n-    servername: 'agent1',\n-    secureProtocol: 'SSLv23_method'\n-  }, common.mustCall(function(res) {\n-    res.resume();\n-    globalAgent.once('free', common.mustCall(function() {\n-      https.get({\n-        path: '/',\n-        port: port,\n-        ca: options.ca,\n-        rejectUnauthorized: true,\n-        servername: 'agent1',\n-        secureProtocol: 'TLSv1_method'\n-      }, common.mustCall(function(res) {\n-        res.resume();\n-        globalAgent.once('free', common.mustCall(function() {\n-          // Verify that two keep-alive connections are created\n-          // due to the different secureProtocol settings:\n-          const keys = Object.keys(globalAgent.freeSockets);\n-          assert.strictEqual(keys.length, 2);\n-          assert.ok(keys[0].includes(':SSLv23_method'));\n-          assert.ok(keys[1].includes(':TLSv1_method'));\n-          globalAgent.destroy();\n-          server.close();\n-        }));\n-      }));\n-    }));\n-  }));\n-}));"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 127,
        "deletions": 64
    }
}