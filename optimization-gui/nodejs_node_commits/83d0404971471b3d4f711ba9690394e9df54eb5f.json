{
    "author": "Trott",
    "message": "repl: do not swallow errors in nested REPLs\n\nFor tab completion, a REPLServer instance will sometimes create another\nREPLServer instance. If a callback is sent to the `.complete()` function\nand that callback throws an error, it will be swallowed by the nested\nREPLs domain. Re-throw the error so that processes don't silently exit\nwithout any indication of an error (including a status code).\n\nFixes: https://github.com/nodejs/node/issues/21586\n\nPR-URL: https://github.com/nodejs/node/pull/23004\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "83d0404971471b3d4f711ba9690394e9df54eb5f",
    "files": [
        {
            "sha": "72328a1d0f7e04f957d18de1655b6d30b2dd0f27",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/83d0404971471b3d4f711ba9690394e9df54eb5f/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/83d0404971471b3d4f711ba9690394e9df54eb5f/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=83d0404971471b3d4f711ba9690394e9df54eb5f",
            "patch": "@@ -1002,6 +1002,7 @@ function complete(line, callback) {\n     // all this is only profitable if the nested REPL\n     // does not have a bufferedCommand\n     if (!magic[kBufferedCommandSymbol]) {\n+      magic._domain.on('error', (err) => { throw err; });\n       return magic.complete(line, callback);\n     }\n   }"
        },
        {
            "sha": "832734a22a502492e355ae54070e4424908b2a43",
            "filename": "test/fixtures/repl-tab-completion-nested-repls.js",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Ffixtures%2Frepl-tab-completion-nested-repls.js",
            "raw_url": "https://github.com/nodejs/node/raw/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Ffixtures%2Frepl-tab-completion-nested-repls.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Frepl-tab-completion-nested-repls.js?ref=83d0404971471b3d4f711ba9690394e9df54eb5f",
            "patch": "@@ -0,0 +1,50 @@\n+// Tab completion sometimes uses a separate REPL instance under the hood.\n+// That REPL instance has its own domain. Make sure domain errors trickle back\n+// up to the main REPL.\n+//\n+// Ref: https://github.com/nodejs/node/issues/21586\n+\n+'use strict';\n+\n+const { Stream } = require('stream');\n+const { inherits } = require('util');\n+function noop() {}\n+\n+// A stream to push an array into a REPL\n+function ArrayStream() {\n+  this.run = function(data) {\n+    data.forEach((line) => {\n+      this.emit('data', `${line}\\n`);\n+    });\n+  };\n+}\n+\n+inherits(ArrayStream, Stream);\n+ArrayStream.prototype.readable = true;\n+ArrayStream.prototype.writable = true;\n+ArrayStream.prototype.pause = noop;\n+ArrayStream.prototype.resume = noop;\n+ArrayStream.prototype.write = noop;\n+\n+const repl = require('repl');\n+\n+const putIn = new ArrayStream();\n+const testMe = repl.start('', putIn);\n+\n+// Some errors are passed to the domain, but do not callback\n+testMe._domain.on('error', function(err) {\n+  throw err;\n+});\n+\n+// Nesting of structures causes REPL to use a nested REPL for completion.\n+putIn.run([\n+  'var top = function() {',\n+  'r = function test (',\n+  ' one, two) {',\n+  'var inner = {',\n+  ' one:1',\n+  '};'\n+]);\n+\n+// In Node.js 10.11.0, this next line will terminate the repl silently...\n+testMe.complete('inner.o', () => { throw new Error('fhqwhgads'); });"
        },
        {
            "sha": "36547e8d9fb5be8aa565dcf5042c9d3f48ea5cba",
            "filename": "test/parallel/test-repl-tab-complete-nested-repls.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Fparallel%2Ftest-repl-tab-complete-nested-repls.js",
            "raw_url": "https://github.com/nodejs/node/raw/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Fparallel%2Ftest-repl-tab-complete-nested-repls.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-tab-complete-nested-repls.js?ref=83d0404971471b3d4f711ba9690394e9df54eb5f",
            "patch": "@@ -0,0 +1,21 @@\n+// Tab completion sometimes uses a separate REPL instance under the hood.\n+// That REPL instance has its own domain. Make sure domain errors trickle back\n+// up to the main REPL.\n+//\n+// Ref: https://github.com/nodejs/node/issues/21586\n+\n+'use strict';\n+\n+require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+\n+const testFile = fixtures.path('repl-tab-completion-nested-repls.js');\n+const result = spawnSync(process.execPath, [testFile]);\n+\n+// The spawned process will fail. In Node.js 10.11.0, it will fail silently. The\n+// test here is to make sure that the error information bubbles up to the\n+// calling process.\n+assert.ok(result.status, 'testFile swallowed its error');"
        },
        {
            "sha": "378072ecb8c3e736808892859483f1b5d81248b2",
            "filename": "test/parallel/test-repl-tab-complete.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Fparallel%2Ftest-repl-tab-complete.js",
            "raw_url": "https://github.com/nodejs/node/raw/83d0404971471b3d4f711ba9690394e9df54eb5f/test%2Fparallel%2Ftest-repl-tab-complete.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-tab-complete.js?ref=83d0404971471b3d4f711ba9690394e9df54eb5f",
            "patch": "@@ -154,9 +154,8 @@ putIn.run([\n   ' one:1',\n   '};'\n ]);\n-// See: https://github.com/nodejs/node/issues/21586\n-// testMe.complete('inner.o', getNoResultsFunction());\n testMe.complete('inner.o', common.mustCall(function(error, data) {\n+  assert.deepStrictEqual(data, works);\n }));\n \n putIn.run(['.clear']);"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 73,
        "deletions": 2
    }
}