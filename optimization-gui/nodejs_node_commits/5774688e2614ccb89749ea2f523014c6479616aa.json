{
    "author": "illBeRoy",
    "message": "lib: support overriding http\\s.globalAgent\n\nOverriding `require('http[s]').globalAgent` is now respected by\nconsequent requests.\n\nIn order to achieve that, the following changes were made:\n\n1. Implmentation in `http`: `module.exports.globalAgent` is now defined\nthrough `Object.defineProperty`. Its getter and setter return \\ set\n`require('_http_agent').globalAgent`.\n\n2. Implementation in `https`: the https `globalAgent` is not the same\nas `_http_agent`, and is defined in `https` module itself. Therefore,\nthe fix here was to simply use `module.exports.globalAgent` to support\nmutation.\n\n3. According tests were added for both `http` and `https`, where in\nboth we create a server, set the default agent to a newly created\ninstance and make a request to that server. We then assert that the\ngiven instance was actually used by inspecting its sockets property.\n\nFixes: https://github.com/nodejs/node/issues/23281\n\nPR-URL: https://github.com/nodejs/node/pull/25170\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "5774688e2614ccb89749ea2f523014c6479616aa",
    "files": [
        {
            "sha": "5f2fe6dc68f57158c0cf2ca3ca8b94cff92e5872",
            "filename": "lib/http.js",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/5774688e2614ccb89749ea2f523014c6479616aa/lib%2Fhttp.js",
            "raw_url": "https://github.com/nodejs/node/raw/5774688e2614ccb89749ea2f523014c6479616aa/lib%2Fhttp.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttp.js?ref=5774688e2614ccb89749ea2f523014c6479616aa",
            "patch": "@@ -21,7 +21,7 @@\n \n 'use strict';\n \n-const { Agent, globalAgent } = require('_http_agent');\n+const httpAgent = require('_http_agent');\n const { ClientRequest } = require('_http_client');\n const { methods } = require('_http_common');\n const { IncomingMessage } = require('_http_incoming');\n@@ -52,9 +52,8 @@ module.exports = {\n   _connectionListener,\n   METHODS: methods.slice().sort(),\n   STATUS_CODES,\n-  Agent,\n+  Agent: httpAgent.Agent,\n   ClientRequest,\n-  globalAgent,\n   IncomingMessage,\n   OutgoingMessage,\n   Server,\n@@ -76,3 +75,14 @@ Object.defineProperty(module.exports, 'maxHeaderSize', {\n     return maxHeaderSize;\n   }\n });\n+\n+Object.defineProperty(module.exports, 'globalAgent', {\n+  configurable: true,\n+  enumerable: true,\n+  get() {\n+    return httpAgent.globalAgent;\n+  },\n+  set(value) {\n+    httpAgent.globalAgent = value;\n+  }\n+});"
        },
        {
            "sha": "9ac4cfd0d3873a0d1604e10a05372541db429f92",
            "filename": "lib/https.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5774688e2614ccb89749ea2f523014c6479616aa/lib%2Fhttps.js",
            "raw_url": "https://github.com/nodejs/node/raw/5774688e2614ccb89749ea2f523014c6479616aa/lib%2Fhttps.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttps.js?ref=5774688e2614ccb89749ea2f523014c6479616aa",
            "patch": "@@ -296,7 +296,7 @@ function request(...args) {\n     Object.assign(options, args.shift());\n   }\n \n-  options._defaultAgent = globalAgent;\n+  options._defaultAgent = module.exports.globalAgent;\n   args.unshift(options);\n \n   return new ClientRequest(...args);"
        },
        {
            "sha": "c36c9d26a8dd63858ae5834bf12b9a5adc7c4a33",
            "filename": "test/parallel/test-http-client-override-global-agent.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/5774688e2614ccb89749ea2f523014c6479616aa/test%2Fparallel%2Ftest-http-client-override-global-agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/5774688e2614ccb89749ea2f523014c6479616aa/test%2Fparallel%2Ftest-http-client-override-global-agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-override-global-agent.js?ref=5774688e2614ccb89749ea2f523014c6479616aa",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const http = require('http');\n+\n+const server = http.Server(common.mustCall((req, res) => {\n+  res.writeHead(200);\n+  res.end('Hello, World!');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const agent = new http.Agent();\n+  const name = agent.getName({ port: server.address().port });\n+  http.globalAgent = agent;\n+\n+  makeRequest();\n+  assert(agent.sockets.hasOwnProperty(name)); // agent has indeed been used\n+}));\n+\n+function makeRequest() {\n+  const req = http.get({\n+    port: server.address().port\n+  });\n+  req.on('close', () =>\n+    server.close());\n+}"
        },
        {
            "sha": "12b5ae596bc83701deda1f56b94995b552c4b82d",
            "filename": "test/parallel/test-https-client-override-global-agent.js",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/5774688e2614ccb89749ea2f523014c6479616aa/test%2Fparallel%2Ftest-https-client-override-global-agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/5774688e2614ccb89749ea2f523014c6479616aa/test%2Fparallel%2Ftest-https-client-override-global-agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-client-override-global-agent.js?ref=5774688e2614ccb89749ea2f523014c6479616aa",
            "patch": "@@ -0,0 +1,38 @@\n+'use strict';\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+const assert = require('assert');\n+const https = require('https');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+// Disable strict server certificate validation by the client\n+process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';\n+\n+const options = {\n+  key: fixtures.readKey('agent1-key.pem'),\n+  cert: fixtures.readKey('agent1-cert.pem')\n+};\n+\n+const server = https.Server(options, common.mustCall((req, res) => {\n+  res.writeHead(200);\n+  res.end('Hello, World!');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const agent = new https.Agent();\n+  const name = agent.getName({ port: server.address().port });\n+  https.globalAgent = agent;\n+\n+  makeRequest();\n+  assert(agent.sockets.hasOwnProperty(name)); // agent has indeed been used\n+}));\n+\n+function makeRequest() {\n+  const req = https.get({\n+    port: server.address().port\n+  });\n+  req.on('close', () =>\n+    server.close());\n+}"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 78,
        "deletions": 4
    }
}