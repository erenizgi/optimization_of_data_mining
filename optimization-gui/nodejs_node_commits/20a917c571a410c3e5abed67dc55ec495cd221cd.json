{
    "author": "refack",
    "message": "build: move optimizing link directives to node.exe target\n\n* ASCIIbetize directives\n* Merge duplicate directives from 'conditions'\n\nPR-URL: https://github.com/nodejs/node/pull/25931\nReviewed-By: Jo√£o Reis <reis@janeasystems.com>",
    "sha": "20a917c571a410c3e5abed67dc55ec495cd221cd",
    "files": [
        {
            "sha": "3736ec5af135fa23ae35722dc67c8444c73b9ac6",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 34,
            "deletions": 90,
            "changes": 124,
            "blob_url": "https://github.com/nodejs/node/blob/20a917c571a410c3e5abed67dc55ec495cd221cd/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/20a917c571a410c3e5abed67dc55ec495cd221cd/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=20a917c571a410c3e5abed67dc55ec495cd221cd",
            "patch": "@@ -137,13 +137,17 @@\n       'Debug': {\n         'variables': {\n           'v8_enable_handle_zapping': 1,\n+          'conditions': [\n+            ['node_shared != \"true\"', {\n+              'MSVC_runtimeType': 1,    # MultiThreadedDebug (/MTd)\n+            }, {\n+              'MSVC_runtimeType': 3,    # MultiThreadedDebugDLL (/MDd)\n+            }],\n+          ],\n         },\n         'defines': [ 'DEBUG', '_DEBUG', 'V8_ENABLE_CHECKS' ],\n         'cflags': [ '-g', '-O0' ],\n         'conditions': [\n-          ['target_arch==\"x64\"', {\n-            'msvs_configuration_platform': 'x64',\n-          }],\n           ['OS==\"aix\"', {\n             'cflags': [ '-gxcoff' ],\n             'ldflags': [ '-Wl,-bbigtoc' ],\n@@ -152,31 +156,14 @@\n             'cflags': [ '-fPIE' ],\n             'ldflags': [ '-fPIE', '-pie' ]\n           }],\n-          ['node_shared==\"true\"', {\n-            'msvs_settings': {\n-             'VCCLCompilerTool': {\n-               'RuntimeLibrary': 3, # MultiThreadedDebugDLL (/MDd)\n-             }\n-            }\n-          }],\n-          ['node_shared==\"false\"', {\n-            'msvs_settings': {\n-              'VCCLCompilerTool': {\n-                'RuntimeLibrary': 1 # MultiThreadedDebug (/MTd)\n-              }\n-            }\n-          }]\n         ],\n         'msvs_settings': {\n           'VCCLCompilerTool': {\n-            'Optimization': 0, # /Od, no optimization\n+            'BasicRuntimeChecks': 3,        # /RTC1\n             'MinimalRebuild': 'false',\n             'OmitFramePointers': 'false',\n-            'BasicRuntimeChecks': 3, # /RTC1\n-            'MultiProcessorCompilation': 'true',\n-            'AdditionalOptions': [\n-              '/bigobj', # prevent error C1128 in VS2015\n-            ],\n+            'Optimization': 0,              # /Od, no optimization\n+            'RuntimeLibrary': '<(MSVC_runtimeType)',\n           },\n           'VCLinkerTool': {\n             'LinkIncremental': 2, # enable incremental linking\n@@ -189,12 +176,19 @@\n       'Release': {\n         'variables': {\n           'v8_enable_handle_zapping': 0,\n+          'pgo_generate': ' -fprofile-generate ',\n+          'pgo_use': ' -fprofile-use -fprofile-correction ',\n+          'lto': ' -flto=4 -fuse-linker-plugin -ffat-lto-objects ',\n+          'conditions': [\n+            ['node_shared != \"true\"', {\n+              'MSVC_runtimeType': 0    # MultiThreaded (/MT)\n+            }, {\n+              'MSVC_runtimeType': 2   # MultiThreadedDLL (/MD)\n+            }],\n+          ],\n         },\n         'cflags': [ '-O3' ],\n         'conditions': [\n-          ['target_arch==\"x64\"', {\n-            'msvs_configuration_platform': 'x64',\n-          }],\n           ['OS==\"solaris\"', {\n             # pull in V8's postmortem metadata\n             'ldflags': [ '-Wl,-z,allextract' ]\n@@ -203,11 +197,6 @@\n             'cflags': [ '-fno-omit-frame-pointer' ],\n           }],\n           ['OS==\"linux\"', {\n-            'variables': {\n-              'pgo_generate': ' -fprofile-generate ',\n-              'pgo_use': ' -fprofile-use -fprofile-correction ',\n-              'lto': ' -flto=4 -fuse-linker-plugin -ffat-lto-objects ',\n-            },\n             'conditions': [\n               ['enable_pgo_generate==\"true\"', {\n                 'cflags': ['<(pgo_generate)'],\n@@ -227,62 +216,17 @@\n             'cflags': [ '-fPIE' ],\n             'ldflags': [ '-fPIE', '-pie' ]\n           }],\n-          ['node_shared==\"true\"', {\n-            'msvs_settings': {\n-             'VCCLCompilerTool': {\n-               'RuntimeLibrary': 2 # MultiThreadedDLL (/MD)\n-             }\n-            }\n-          }],\n-          ['node_shared==\"false\"', {\n-            'msvs_settings': {\n-              'VCCLCompilerTool': {\n-                'RuntimeLibrary': 0 # MultiThreaded (/MT)\n-              }\n-            }\n-          }],\n-          ['node_with_ltcg==\"true\"', {\n-            'msvs_settings': {\n-              'VCCLCompilerTool': {\n-                'WholeProgramOptimization': 'true' # /GL, whole program optimization, needed for LTCG\n-              },\n-              'VCLibrarianTool': {\n-                'AdditionalOptions': [\n-                  '/LTCG:INCREMENTAL', # link time code generation\n-                ]\n-              },\n-              'VCLinkerTool': {\n-                'OptimizeReferences': 2, # /OPT:REF\n-                'EnableCOMDATFolding': 2, # /OPT:ICF\n-                'LinkIncremental': 1, # disable incremental linking\n-                'AdditionalOptions': [\n-                  '/LTCG:INCREMENTAL', # incremental link-time code generation\n-                ]\n-              }\n-            }\n-          }, {\n-            'msvs_settings': {\n-              'VCCLCompilerTool': {\n-                'WholeProgramOptimization': 'false'\n-              },\n-              'VCLinkerTool': {\n-                'LinkIncremental': 2 # enable incremental linking\n-              }\n-            }\n-          }]\n         ],\n         'msvs_settings': {\n           'VCCLCompilerTool': {\n-            'Optimization': 3, # /Ox, full optimization\n-            'FavorSizeOrSpeed': 1, # /Ot, favor speed over size\n-            'InlineFunctionExpansion': 2, # /Ob2, inline anything eligible\n-            'OmitFramePointers': 'true',\n             'EnableFunctionLevelLinking': 'true',\n             'EnableIntrinsicFunctions': 'true',\n+            'FavorSizeOrSpeed': 1,          # /Ot, favor speed over size\n+            'InlineFunctionExpansion': 2,   # /Ob2, inline anything eligible\n+            'OmitFramePointers': 'true',\n+            'Optimization': 3,              # /Ox, full optimization\n+            'RuntimeLibrary': '<(MSVC_runtimeType)',\n             'RuntimeTypeInfo': 'false',\n-            'MultiProcessorCompilation': 'true',\n-            'AdditionalOptions': [\n-            ],\n           }\n         }\n       }\n@@ -301,13 +245,14 @@\n     'cflags!': ['-Werror'],\n     'msvs_settings': {\n       'VCCLCompilerTool': {\n-        'StringPooling': 'true', # pool string literals\n-        'DebugInformationFormat': 1, # /Z7 embed info in .obj files\n-        'WarningLevel': 3,\n         'BufferSecurityCheck': 'true',\n+        'DebugInformationFormat': 1, # /Z7 embed info in .obj files\n         'ExceptionHandling': 0, # /EHsc\n+        'MultiProcessorCompilation': 'true',\n+        'StringPooling': 'true', # pool string literals\n         'SuppressStartupBanner': 'true',\n         'WarnAsError': 'false',\n+        'WarningLevel': 3,       # /W3\n       },\n       'VCLinkerTool': {\n         'conditions': [\n@@ -329,11 +274,6 @@\n           }],\n         ],\n         'GenerateDebugInformation': 'true',\n-        'GenerateMapFile': 'true', # /MAP\n-        'MapExports': 'true', # /MAPINFO:EXPORTS\n-        'RandomizedBaseAddress': 2, # enable ASLR\n-        'DataExecutionPrevention': 2, # enable DEP\n-        'AllowIsolation': 'true',\n         'SuppressStartupBanner': 'true',\n       },\n     },\n@@ -351,7 +291,12 @@\n     # - \"C4244: conversion from 'type1' to 'type2', possible loss of data\"\n     #   Ususaly safe. Disable for `dep`, enable for `src`\n     'msvs_disabled_warnings': [4351, 4355, 4800, 4251, 4275, 4244, 4267],\n+    'msvs_cygwin_shell': 0, # prevent actions from trying to use cygwin\n+\n     'conditions': [\n+      [ 'target_arch==\"x64\"', {\n+        'msvs_configuration_platform': 'x64',\n+      }],\n       ['asan == 1 and OS != \"mac\"', {\n         'cflags+': [\n           '-fno-omit-frame-pointer',\n@@ -380,7 +325,6 @@\n         ],\n       }],\n       ['OS == \"win\"', {\n-        'msvs_cygwin_shell': 0, # prevent actions from trying to use cygwin\n         'defines': [\n           'WIN32',\n           # we don't really want VC++ warning us about"
        },
        {
            "sha": "d0a715b91e1dbe3b34fb2303596973808132fe8a",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 40,
            "deletions": 2,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/20a917c571a410c3e5abed67dc55ec495cd221cd/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/20a917c571a410c3e5abed67dc55ec495cd221cd/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=20a917c571a410c3e5abed67dc55ec495cd221cd",
            "patch": "@@ -266,6 +266,16 @@\n       ],\n       'dependencies': [ 'deps/histogram/histogram.gyp:histogram' ],\n \n+      'msvs_settings': {\n+        'VCLinkerTool': {\n+          'GenerateMapFile': 'true', # /MAP\n+          'MapExports': 'true', # /MAPINFO:EXPORTS\n+          'RandomizedBaseAddress': 2, # enable ASLR\n+          'DataExecutionPrevention': 2, # enable DEP\n+          'AllowIsolation': 'true',\n+        },\n+      },\n+\n       # - \"C4244: conversion from 'type1' to 'type2', possible loss of data\"\n       #   Ususaly safe. Disable for `dep`, enable for `src`\n       'msvs_disabled_warnings!': [4244],\n@@ -281,8 +291,7 @@\n         }, {\n           'dependencies': [ '<(node_lib_target_name)' ],\n         }],\n-        [ 'node_intermediate_lib_type==\"static_library\" and '\n-            'node_shared==\"false\"', {\n+        [ 'node_intermediate_lib_type==\"static_library\" and node_shared==\"false\"', {\n           'xcode_settings': {\n             'OTHER_LDFLAGS': [\n               '-Wl,-force_load,<(PRODUCT_DIR)/<(STATIC_LIB_PREFIX)'\n@@ -348,6 +357,35 @@\n             }],\n           ],\n         }],\n+        ['node_with_ltcg==\"true\"', {\n+          'msvs_settings': {\n+            'VCCLCompilerTool': {\n+              'WholeProgramOptimization': 'true'   # /GL, whole program optimization, needed for LTCG\n+            },\n+            'VCLibrarianTool': {\n+              'AdditionalOptions': [\n+                '/LTCG:INCREMENTAL',               # link time code generation\n+              ],\n+            },\n+            'VCLinkerTool': {\n+              'OptimizeReferences': 2,             # /OPT:REF\n+              'EnableCOMDATFolding': 2,            # /OPT:ICF\n+              'LinkIncremental': 1,                # disable incremental linking\n+              'AdditionalOptions': [\n+                '/LTCG:INCREMENTAL',               # incremental link-time code generation\n+              ],\n+            }\n+          }\n+        }, {\n+          'msvs_settings': {\n+            'VCCLCompilerTool': {\n+              'WholeProgramOptimization': 'false'\n+            },\n+            'VCLinkerTool': {\n+              'LinkIncremental': 2                 # enable incremental linking\n+            },\n+          },\n+        }]\n       ],\n     }, # node_core_target_name\n     {"
        }
    ],
    "stats": {
        "total": 166,
        "additions": 74,
        "deletions": 92
    }
}