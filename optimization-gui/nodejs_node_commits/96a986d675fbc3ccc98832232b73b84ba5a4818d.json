{
    "author": "cjihrig",
    "message": "tls: support changing credentials dynamically\n\nThis commit adds a setSecureContext() method to TLS servers. In\norder to maintain backwards compatibility, the method takes the\noptions needed to create a new SecureContext, rather than an\ninstance of SecureContext.\n\nFixes: https://github.com/nodejs/node/issues/4464\nRefs: https://github.com/nodejs/node/issues/10349\nRefs: https://github.com/nodejs/help/issues/603\nRefs: https://github.com/nodejs/node/issues/15115\nPR-URL: https://github.com/nodejs/node/pull/23644\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "96a986d675fbc3ccc98832232b73b84ba5a4818d",
    "files": [
        {
            "sha": "f9a313f914849074ccc42ccf95503a6327cd6a38",
            "filename": "doc/api/tls.md",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/96a986d675fbc3ccc98832232b73b84ba5a4818d/doc%2Fapi%2Ftls.md",
            "raw_url": "https://github.com/nodejs/node/raw/96a986d675fbc3ccc98832232b73b84ba5a4818d/doc%2Fapi%2Ftls.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftls.md?ref=96a986d675fbc3ccc98832232b73b84ba5a4818d",
            "patch": "@@ -411,6 +411,18 @@ encryption/decryption of the [TLS Session Tickets][].\n Starts the server listening for encrypted connections.\n This method is identical to [`server.listen()`][] from [`net.Server`][].\n \n+### server.setSecureContext(options)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `options` {Object} An object containing any of the possible properties from\n+  the [`tls.createSecureContext()`][] `options` arguments (e.g. `key`, `cert`,\n+  `ca`, etc).\n+\n+The `server.setSecureContext()` method replaces the secure context of an\n+existing server. Existing connections to the server are not interrupted.\n+\n ### server.setTicketKeys(keys)\n <!-- YAML\n added: v3.0.0"
        },
        {
            "sha": "aa8b66b7155b3e0bb443ee9f46a9b41a703f98bb",
            "filename": "lib/_tls_wrap.js",
            "status": "modified",
            "additions": 114,
            "deletions": 24,
            "changes": 138,
            "blob_url": "https://github.com/nodejs/node/blob/96a986d675fbc3ccc98832232b73b84ba5a4818d/lib%2F_tls_wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/96a986d675fbc3ccc98832232b73b84ba5a4818d/lib%2F_tls_wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_wrap.js?ref=96a986d675fbc3ccc98832232b73b84ba5a4818d",
            "patch": "@@ -833,22 +833,11 @@ function Server(options, listener) {\n   // Handle option defaults:\n   this.setOptions(options);\n \n-  this._sharedCreds = tls.createSecureContext({\n-    pfx: this.pfx,\n-    key: this.key,\n-    passphrase: this.passphrase,\n-    cert: this.cert,\n-    clientCertEngine: this.clientCertEngine,\n-    ca: this.ca,\n-    ciphers: this.ciphers,\n-    ecdhCurve: this.ecdhCurve,\n-    dhparam: this.dhparam,\n-    secureProtocol: this.secureProtocol,\n-    secureOptions: this.secureOptions,\n-    honorCipherOrder: this.honorCipherOrder,\n-    crl: this.crl,\n-    sessionIdContext: this.sessionIdContext\n-  });\n+  // setSecureContext() overlaps with setOptions() quite a bit. setOptions()\n+  // is an undocumented API that was probably never intended to be exposed\n+  // publicly. Unfortunately, it would be a breaking change to just remove it,\n+  // and there is at least one test that depends on it.\n+  this.setSecureContext(options);\n \n   this[kHandshakeTimeout] = options.handshakeTimeout || (120 * 1000);\n   this[kSNICallback] = options.SNICallback;\n@@ -863,14 +852,6 @@ function Server(options, listener) {\n       'options.SNICallback', 'function', options.SNICallback);\n   }\n \n-  if (this.sessionTimeout) {\n-    this._sharedCreds.context.setSessionTimeout(this.sessionTimeout);\n-  }\n-\n-  if (this.ticketKeys) {\n-    this._sharedCreds.context.setTicketKeys(this.ticketKeys);\n-  }\n-\n   // constructor call\n   net.Server.call(this, tlsConnectionListener);\n \n@@ -886,6 +867,115 @@ exports.createServer = function createServer(options, listener) {\n };\n \n \n+Server.prototype.setSecureContext = function(options) {\n+  if (options === null || typeof options !== 'object')\n+    throw new ERR_INVALID_ARG_TYPE('options', 'Object', options);\n+\n+  if (options.pfx)\n+    this.pfx = options.pfx;\n+  else\n+    this.pfx = undefined;\n+\n+  if (options.key)\n+    this.key = options.key;\n+  else\n+    this.key = undefined;\n+\n+  if (options.passphrase)\n+    this.passphrase = options.passphrase;\n+  else\n+    this.passphrase = undefined;\n+\n+  if (options.cert)\n+    this.cert = options.cert;\n+  else\n+    this.cert = undefined;\n+\n+  if (options.clientCertEngine)\n+    this.clientCertEngine = options.clientCertEngine;\n+  else\n+    this.clientCertEngine = undefined;\n+\n+  if (options.ca)\n+    this.ca = options.ca;\n+  else\n+    this.ca = undefined;\n+\n+  if (options.secureProtocol)\n+    this.secureProtocol = options.secureProtocol;\n+  else\n+    this.secureProtocol = undefined;\n+\n+  if (options.crl)\n+    this.crl = options.crl;\n+  else\n+    this.crl = undefined;\n+\n+  if (options.ciphers)\n+    this.ciphers = options.ciphers;\n+  else\n+    this.ciphers = undefined;\n+\n+  if (options.ecdhCurve !== undefined)\n+    this.ecdhCurve = options.ecdhCurve;\n+  else\n+    this.ecdhCurve = undefined;\n+\n+  if (options.dhparam)\n+    this.dhparam = options.dhparam;\n+  else\n+    this.dhparam = undefined;\n+\n+  if (options.honorCipherOrder !== undefined)\n+    this.honorCipherOrder = !!options.honorCipherOrder;\n+  else\n+    this.honorCipherOrder = true;\n+\n+  const secureOptions = options.secureOptions || 0;\n+\n+  if (secureOptions)\n+    this.secureOptions = secureOptions;\n+  else\n+    this.secureOptions = undefined;\n+\n+  if (options.sessionIdContext) {\n+    this.sessionIdContext = options.sessionIdContext;\n+  } else {\n+    this.sessionIdContext = crypto.createHash('sha1')\n+                                  .update(process.argv.join(' '))\n+                                  .digest('hex')\n+                                  .slice(0, 32);\n+  }\n+\n+  this._sharedCreds = tls.createSecureContext({\n+    pfx: this.pfx,\n+    key: this.key,\n+    passphrase: this.passphrase,\n+    cert: this.cert,\n+    clientCertEngine: this.clientCertEngine,\n+    ca: this.ca,\n+    ciphers: this.ciphers,\n+    ecdhCurve: this.ecdhCurve,\n+    dhparam: this.dhparam,\n+    secureProtocol: this.secureProtocol,\n+    secureOptions: this.secureOptions,\n+    honorCipherOrder: this.honorCipherOrder,\n+    crl: this.crl,\n+    sessionIdContext: this.sessionIdContext\n+  });\n+\n+  if (this.sessionTimeout)\n+    this._sharedCreds.context.setSessionTimeout(this.sessionTimeout);\n+\n+  if (options.ticketKeys) {\n+    this.ticketKeys = options.ticketKeys;\n+    this.setTicketKeys(this.ticketKeys);\n+  } else {\n+    this.setTicketKeys(this.getTicketKeys());\n+  }\n+};\n+\n+\n Server.prototype._getServerData = function() {\n   return {\n     ticketKeys: this.getTicketKeys().toString('hex')"
        },
        {
            "sha": "51ab3af10b540e67325bd86183299145e3b0b7c1",
            "filename": "test/parallel/test-tls-set-secure-context.js",
            "status": "added",
            "additions": 88,
            "deletions": 0,
            "changes": 88,
            "blob_url": "https://github.com/nodejs/node/blob/96a986d675fbc3ccc98832232b73b84ba5a4818d/test%2Fparallel%2Ftest-tls-set-secure-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/96a986d675fbc3ccc98832232b73b84ba5a4818d/test%2Fparallel%2Ftest-tls-set-secure-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-set-secure-context.js?ref=96a986d675fbc3ccc98832232b73b84ba5a4818d",
            "patch": "@@ -0,0 +1,88 @@\n+'use strict';\n+const common = require('../common');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const https = require('https');\n+const fixtures = require('../common/fixtures');\n+const credentialOptions = [\n+  {\n+    key: fixtures.readKey('agent1-key.pem'),\n+    cert: fixtures.readKey('agent1-cert.pem'),\n+    ca: fixtures.readKey('ca1-cert.pem')\n+  },\n+  {\n+    key: fixtures.readKey('agent2-key.pem'),\n+    cert: fixtures.readKey('agent2-cert.pem'),\n+    ca: fixtures.readKey('ca2-cert.pem')\n+  }\n+];\n+let requestsCount = 0;\n+let firstResponse;\n+\n+const server = https.createServer(credentialOptions[0], (req, res) => {\n+  requestsCount++;\n+\n+  if (requestsCount === 1) {\n+    firstResponse = res;\n+    firstResponse.write('multi-');\n+    return;\n+  } else if (requestsCount === 3) {\n+    firstResponse.write('success-');\n+  }\n+\n+  res.end('success');\n+});\n+\n+server.listen(0, common.mustCall(async () => {\n+  const { port } = server.address();\n+  const firstRequest = makeRequest(port);\n+\n+  assert.strictEqual(await makeRequest(port), 'success');\n+\n+  server.setSecureContext(credentialOptions[1]);\n+  firstResponse.write('request-');\n+  await assert.rejects(async () => {\n+    await makeRequest(port);\n+  }, /^Error: self signed certificate$/);\n+\n+  server.setSecureContext(credentialOptions[0]);\n+  assert.strictEqual(await makeRequest(port), 'success');\n+\n+  server.setSecureContext(credentialOptions[1]);\n+  firstResponse.end('fun!');\n+  await assert.rejects(async () => {\n+    await makeRequest(port);\n+  }, /^Error: self signed certificate$/);\n+\n+  assert.strictEqual(await firstRequest, 'multi-request-success-fun!');\n+  server.close();\n+}));\n+\n+function makeRequest(port) {\n+  return new Promise((resolve, reject) => {\n+    const options = {\n+      rejectUnauthorized: true,\n+      ca: credentialOptions[0].ca,\n+      servername: 'agent1'\n+    };\n+\n+    https.get(`https://localhost:${port}`, options, (res) => {\n+      let response = '';\n+\n+      res.setEncoding('utf8');\n+\n+      res.on('data', (chunk) => {\n+        response += chunk;\n+      });\n+\n+      res.on('end', common.mustCall(() => {\n+        resolve(response);\n+      }));\n+    }).on('error', (err) => {\n+      reject(err);\n+    });\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 238,
        "additions": 214,
        "deletions": 24
    }
}