{
    "author": "addaleax",
    "message": "test: check TTY mode reset on exit\n\nBefore PR 20592, closing all handles associated with the main\nevent loop would also mean that `uv_tty_reset_mode()`\ncanâ€™t function properly because the corresponding FDs have\nalready been closed.\n\nAdd regression tests for this condition.\n\nRefs: https://github.com/nodejs/node/issues/21020\nRefs: https://github.com/nodejs/node/pull/20592\n\nPR-URL: https://github.com/nodejs/node/pull/21027\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f",
    "files": [
        {
            "sha": "b6857eaebbdf60a33cc79754e1b00ff3ac334f2f",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset-process-exit.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.js?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+require('../common');\n+const child_process = require('child_process');\n+\n+// Tests that exiting through process.exit() resets the TTY mode.\n+\n+child_process.spawnSync(process.execPath, [\n+  '-e', 'process.stdin.setRawMode(true); process.exit(0)'\n+], { stdio: 'inherit' });\n+\n+const { stdout } = child_process.spawnSync('stty', {\n+  stdio: ['inherit', 'pipe', 'inherit'],\n+  encoding: 'utf8'\n+});\n+\n+if (stdout.match(/-echo\\b/)) {\n+  console.log(stdout);\n+}"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset-process-exit.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.out",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-process-exit.out?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f"
        },
        {
            "sha": "f953a01331c050c34965dbe9b565cfd719200a0f",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset-signal.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.js?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+const common = require('../common');\n+const child_process = require('child_process');\n+\n+// Tests that exiting through a catchable signal resets the TTY mode.\n+\n+const proc = child_process.spawn(process.execPath, [\n+  '-e', 'process.stdin.setRawMode(true); console.log(\"Y\"); while(true) {}'\n+], { stdio: ['inherit', 'pipe', 'inherit'] });\n+\n+proc.stdout.on('data', common.mustCall(() => {\n+  proc.kill('SIGINT');\n+}));\n+\n+proc.on('exit', common.mustCall(() => {\n+  const { stdout } = child_process.spawnSync('stty', {\n+    stdio: ['inherit', 'pipe', 'inherit'],\n+    encoding: 'utf8'\n+  });\n+\n+  if (stdout.match(/-echo\\b/)) {\n+    console.log(stdout);\n+  }\n+}));"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset-signal.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.out",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset-signal.out?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f"
        },
        {
            "sha": "ab8f1125bfc6024d4441362f0c802e5daf475695",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.js",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.js?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f",
            "patch": "@@ -0,0 +1,19 @@\n+'use strict';\n+require('../common');\n+const child_process = require('child_process');\n+\n+// Tests that exiting through normal means resets the TTY mode.\n+// Refs: https://github.com/nodejs/node/issues/21020\n+\n+child_process.spawnSync(process.execPath, [\n+  '-e', 'process.stdin.setRawMode(true)'\n+], { stdio: 'inherit' });\n+\n+const { stdout } = child_process.spawnSync('stty', {\n+  stdio: ['inherit', 'pipe', 'inherit'],\n+  encoding: 'utf8'\n+});\n+\n+if (stdout.match(/-echo\\b/)) {\n+  console.log(stdout);\n+}"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-set-raw-mode-reset.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.out",
            "raw_url": "https://github.com/nodejs/node/raw/7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-set-raw-mode-reset.out?ref=7c8eec0648d1d53dd8ade9d69c4dbbbf2d025a8f"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 61,
        "deletions": 0
    }
}