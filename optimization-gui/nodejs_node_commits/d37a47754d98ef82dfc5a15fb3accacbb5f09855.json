{
    "author": "addaleax",
    "message": "test: add gc tracking to common API\n\nPR-URL: https://github.com/nodejs/node/pull/21794\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d37a47754d98ef82dfc5a15fb3accacbb5f09855",
    "files": [
        {
            "sha": "41cc88aca10f59189b16cfd1b34adb49c891e905",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=d37a47754d98ef82dfc5a15fb3accacbb5f09855",
            "patch": "@@ -322,6 +322,21 @@ otherwise.\n ### noWarnCode\n See `common.expectWarning()` for usage.\n \n+### onGC(target, listener)\n+* `target` [&lt;Object>]\n+* `listener` [&lt;Object>]\n+  * `ongc` [&lt;Function>]\n+\n+Installs a GC listener for the collection of `target`.\n+\n+This uses `async_hooks` for GC tracking. This means that it enables\n+`async_hooks` tracking, which may affect the test functionality. It also\n+means that between a `global.gc()` call and the listener being invoked\n+a full `setImmediate()` invocation passes.\n+\n+`listener` is an object to make it easier to use a closure; the target object\n+should not be in scope when `listener.ongc()` is created.\n+\n ### opensslCli\n * [&lt;boolean>]\n "
        },
        {
            "sha": "1df37db54be493c3838bcbcc5d797c75fa424b17",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=d37a47754d98ef82dfc5a15fb3accacbb5f09855",
            "patch": "@@ -882,3 +882,30 @@ exports.isCPPSymbolsNotMapped = exports.isWindows ||\n                                 exports.isAIX ||\n                                 exports.isLinuxPPCBE ||\n                                 exports.isFreeBSD;\n+\n+const gcTrackerMap = new WeakMap();\n+const gcTrackerTag = 'NODE_TEST_COMMON_GC_TRACKER';\n+\n+exports.onGC = function(obj, gcListener) {\n+  const async_hooks = require('async_hooks');\n+\n+  const onGcAsyncHook = async_hooks.createHook({\n+    init: exports.mustCallAtLeast(function(id, type, trigger, resource) {\n+      if (this.trackedId === undefined) {\n+        assert.strictEqual(type, gcTrackerTag);\n+        this.trackedId = id;\n+      }\n+    }),\n+    destroy(id) {\n+      assert.notStrictEqual(this.trackedId, -1);\n+      if (id === this.trackedId) {\n+        this.gcListener.ongc();\n+        onGcAsyncHook.disable();\n+      }\n+    }\n+  }).enable();\n+  onGcAsyncHook.gcListener = gcListener;\n+\n+  gcTrackerMap.set(obj, new async_hooks.AsyncResource(gcTrackerTag));\n+  obj = null;\n+};"
        },
        {
            "sha": "210b1d6d5f49eac5ab4e7474f5b5e4137e8bbfd7",
            "filename": "test/parallel/test-common-gc.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fparallel%2Ftest-common-gc.js",
            "raw_url": "https://github.com/nodejs/node/raw/d37a47754d98ef82dfc5a15fb3accacbb5f09855/test%2Fparallel%2Ftest-common-gc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-common-gc.js?ref=d37a47754d98ef82dfc5a15fb3accacbb5f09855",
            "patch": "@@ -0,0 +1,15 @@\n+'use strict';\n+// Flags: --expose-gc\n+const common = require('../common');\n+\n+{\n+  const gcListener = { ongc: common.mustCall() };\n+  common.onGC({}, gcListener);\n+  global.gc();\n+}\n+\n+{\n+  const gcListener = { ongc: common.mustNotCall() };\n+  common.onGC(process, gcListener);\n+  global.gc();\n+}"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 57,
        "deletions": 0
    }
}