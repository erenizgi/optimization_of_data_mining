{
    "author": "addaleax",
    "message": "cli: normalize `_` → `-` when parsing options\n\nThis allows for option syntax similar to V8’s one, e.g.\n`--no_warnings` has the same effect as `--no-warnings`.\n\nPR-URL: https://github.com/nodejs/node/pull/23020\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "0227635315c3aa1c31e6814325822a1e4306372e",
    "files": [
        {
            "sha": "9c6195aa4e2f9e242b117f795dcd3501fb10f3e8",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -21,6 +21,18 @@ Execute without arguments to start the [REPL][].\n _For more info about `node inspect`, please see the [debugger][] documentation._\n \n ## Options\n+<!-- YAML\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/23020\n+    description: Underscores instead of dashes are now allowed for\n+                 Node.js options as well, in addition to V8 options.\n+-->\n+\n+All options, including V8 options, allow words to be separated by both\n+dashes (`-`) or underscores (`_`).\n+\n+For example, `--pending-deprecation` is equivalent to `--pending_deprecation`.\n \n ### `-`\n <!-- YAML\n@@ -390,11 +402,6 @@ added: v0.1.3\n \n Print V8 command line options.\n \n-V8 options allow words to be separated by both dashes (`-`) or\n-underscores (`_`).\n-\n-For example, `--stack-trace-limit` is equivalent to `--stack_trace_limit`.\n-\n ### `--v8-pool-size=num`\n <!-- YAML\n added: v5.10.0"
        },
        {
            "sha": "65986337c3875c0abab6733fad06952aa9724046",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 12,
            "deletions": 31,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -742,7 +742,7 @@\n     // This builds process.allowedNodeEnvironmentFlags\n     // from data in the config binding\n \n-    const replaceDashesRegex = /-/g;\n+    const replaceUnderscoresRegex = /_/g;\n     const leadingDashesRegex = /^--?/;\n     const trailingValuesRegex = /=.*$/;\n \n@@ -754,20 +754,14 @@\n     const get = () => {\n       const {\n         getOptions,\n-        types: { kV8Option },\n         envSettings: { kAllowedInEnvironment }\n       } = internalBinding('options');\n       const { options, aliases } = getOptions();\n \n-      const allowedV8EnvironmentFlags = [];\n       const allowedNodeEnvironmentFlags = [];\n       for (const [name, info] of options) {\n         if (info.envVarSettings === kAllowedInEnvironment) {\n-          if (info.type === kV8Option) {\n-            allowedV8EnvironmentFlags.push(name);\n-          } else {\n-            allowedNodeEnvironmentFlags.push(name);\n-          }\n+          allowedNodeEnvironmentFlags.push(name);\n         }\n       }\n \n@@ -801,11 +795,9 @@\n       // process.allowedNodeEnvironmentFlags.has() which lack leading dashes.\n       // Avoid interference w/ user code by flattening `Set.prototype` into\n       // each object.\n-      const [nodeFlags, v8Flags] = [\n-        allowedNodeEnvironmentFlags, allowedV8EnvironmentFlags\n-      ].map((flags) => Object.defineProperties(\n-        new Set(flags.map(trimLeadingDashes)),\n-        Object.getOwnPropertyDescriptors(Set.prototype))\n+      const nodeFlags = Object.defineProperties(\n+        new Set(allowedNodeEnvironmentFlags.map(trimLeadingDashes)),\n+        Object.getOwnPropertyDescriptors(Set.prototype)\n       );\n \n       class NodeEnvironmentFlagsSet extends Set {\n@@ -829,29 +821,18 @@\n         has(key) {\n           // This will return `true` based on various possible\n           // permutations of a flag, including present/missing leading\n-          // dash(es) and/or underscores-for-dashes in the case of V8-specific\n-          // flags.  Strips any values after `=`, inclusive.\n+          // dash(es) and/or underscores-for-dashes.\n+          // Strips any values after `=`, inclusive.\n           // TODO(addaleax): It might be more flexible to run the option parser\n           // on a dummy option set and see whether it rejects the argument or\n           // not.\n           if (typeof key === 'string') {\n-            key = replace(key, trailingValuesRegex, '');\n+            key = replace(key, replaceUnderscoresRegex, '-');\n             if (test(leadingDashesRegex, key)) {\n-              return has(this, key) ||\n-                    has(v8Flags,\n-                        replace(\n-                          replace(\n-                            key,\n-                            leadingDashesRegex,\n-                            ''\n-                          ),\n-                          replaceDashesRegex,\n-                          '_'\n-                        )\n-                    );\n+              key = replace(key, trailingValuesRegex, '');\n+              return has(this, key);\n             }\n-            return has(nodeFlags, key) ||\n-                  has(v8Flags, replace(key, replaceDashesRegex, '_'));\n+            return has(nodeFlags, key);\n           }\n           return false;\n         }\n@@ -862,7 +843,7 @@\n \n       return process.allowedNodeEnvironmentFlags = Object.freeze(\n         new NodeEnvironmentFlagsSet(\n-          allowedNodeEnvironmentFlags.concat(allowedV8EnvironmentFlags)\n+          allowedNodeEnvironmentFlags\n         ));\n     };\n "
        },
        {
            "sha": "277121036e519df84aae310d63d350c05e15db52",
            "filename": "src/node_options-inl.h",
            "status": "modified",
            "additions": 6,
            "deletions": 13,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/src%2Fnode_options-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/src%2Fnode_options-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options-inl.h?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -307,6 +307,12 @@ void OptionsParser<Options>::Parse(\n     if (equals_index != std::string::npos)\n       original_name += '=';\n \n+    // Normalize by replacing `_` with `-` in options.\n+    for (std::string::size_type i = 2; i < name.size(); ++i) {\n+      if (name[i] == '_')\n+        name[i] = '-';\n+    }\n+\n     {\n       auto it = aliases_.end();\n       // Expand aliases:\n@@ -341,19 +347,6 @@ void OptionsParser<Options>::Parse(\n \n     auto it = options_.find(name);\n \n-    if (it == options_.end()) {\n-      // We would assume that this is a V8 option if neither we nor any child\n-      // parser knows about it, so we convert - to _ for\n-      // canonicalization (since V8 accepts both) and look up again in order\n-      // to find a match.\n-      // TODO(addaleax): Make the canonicalization unconditional, i.e. allow\n-      // both - and _ in Node's own options as well.\n-      std::string::size_type index = 2;  // Start after initial '--'.\n-      while ((index = name.find('-', index + 1)) != std::string::npos)\n-        name[index] = '_';\n-      it = options_.find(name);\n-    }\n-\n     if ((it == options_.end() ||\n          it->second.env_setting == kDisallowedInEnvironment) &&\n         required_env_settings == kAllowedInEnvironment) {"
        },
        {
            "sha": "4951679994a2433ec029133bf4c6f077ee04398b",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -102,8 +102,6 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {\n             &EnvironmentOptions::experimental_worker,\n             kAllowedInEnvironment);\n   AddOption(\"--expose-internals\", \"\", &EnvironmentOptions::expose_internals);\n-  // TODO(addaleax): Remove this when adding -/_ canonicalization to the parser.\n-  AddAlias(\"--expose_internals\", \"--expose-internals\");\n   AddOption(\"--loader\",\n             \"(with --experimental-modules) use the specified file as a \"\n             \"custom loader\",\n@@ -204,15 +202,15 @@ PerIsolateOptionsParser::PerIsolateOptionsParser() {\n             kAllowedInEnvironment);\n \n   // Explicitly add some V8 flags to mark them as allowed in NODE_OPTIONS.\n-  AddOption(\"--abort_on_uncaught_exception\",\n+  AddOption(\"--abort-on-uncaught-exception\",\n             \"aborting instead of exiting causes a core file to be generated \"\n             \"for analysis\",\n             V8Option{},\n             kAllowedInEnvironment);\n-  AddOption(\"--max_old_space_size\", \"\", V8Option{}, kAllowedInEnvironment);\n-  AddOption(\"--perf_basic_prof\", \"\", V8Option{}, kAllowedInEnvironment);\n-  AddOption(\"--perf_prof\", \"\", V8Option{}, kAllowedInEnvironment);\n-  AddOption(\"--stack_trace_limit\", \"\", V8Option{}, kAllowedInEnvironment);\n+  AddOption(\"--max-old-space-size\", \"\", V8Option{}, kAllowedInEnvironment);\n+  AddOption(\"--perf-basic-prof\", \"\", V8Option{}, kAllowedInEnvironment);\n+  AddOption(\"--perf-prof\", \"\", V8Option{}, kAllowedInEnvironment);\n+  AddOption(\"--stack-trace-limit\", \"\", V8Option{}, kAllowedInEnvironment);\n \n   Insert(&EnvironmentOptionsParser::instance,\n          &PerIsolateOptions::get_per_env_options);"
        },
        {
            "sha": "733e5cd7c7b977fe25bc3abffe7f56a2a510bdda",
            "filename": "test/parallel/test-cli-node-options-disallowed.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-cli-node-options-disallowed.js",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-cli-node-options-disallowed.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cli-node-options-disallowed.js?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -29,7 +29,6 @@ disallow('--interactive');\n disallow('-i');\n disallow('--v8-options');\n disallow('--');\n-disallow('--no_warnings'); // Node options don't allow '_' instead of '-'.\n \n function disallow(opt) {\n   const env = Object.assign({}, process.env, { NODE_OPTIONS: opt });"
        },
        {
            "sha": "4ff63009a7a1e383298ba3f5afdef2c3417a4203",
            "filename": "test/parallel/test-cli-node-options.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-cli-node-options.js",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-cli-node-options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-cli-node-options.js?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -19,6 +19,7 @@ expect(`-r ${printA}`, 'A\\nB\\n');\n expect(`-r ${printA} -r ${printA}`, 'A\\nB\\n');\n expect('--no-deprecation', 'B\\n');\n expect('--no-warnings', 'B\\n');\n+expect('--no_warnings', 'B\\n');\n expect('--trace-warnings', 'B\\n');\n expect('--redirect-warnings=_', 'B\\n');\n expect('--trace-deprecation', 'B\\n');"
        },
        {
            "sha": "bb11d84bcc0aec4124048e562111c16aa05f5ef5",
            "filename": "test/parallel/test-pending-deprecation.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-pending-deprecation.js",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-pending-deprecation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-pending-deprecation.js?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -36,6 +36,14 @@ switch (process.argv[2]) {\n       assert.strictEqual(code, 0, message('--pending-deprecation'));\n     }));\n \n+    // Test the --pending_deprecation command line switch.\n+    fork(__filename, ['switch'], {\n+      execArgv: ['--pending_deprecation'],\n+      silent: true\n+    }).on('exit', common.mustCall((code) => {\n+      assert.strictEqual(code, 0, message('--pending_deprecation'));\n+    }));\n+\n     // Test the NODE_PENDING_DEPRECATION environment var.\n     fork(__filename, ['env'], {\n       env: Object.assign({}, process.env, { NODE_PENDING_DEPRECATION: 1 }),"
        },
        {
            "sha": "ddd8d894eabcb1708d5ed63e9edf47b475c5328c",
            "filename": "test/parallel/test-process-env-allowed-flags.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "raw_url": "https://github.com/nodejs/node/raw/0227635315c3aa1c31e6814325822a1e4306372e/test%2Fparallel%2Ftest-process-env-allowed-flags.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-allowed-flags.js?ref=0227635315c3aa1c31e6814325822a1e4306372e",
            "patch": "@@ -19,10 +19,10 @@ require('../common');\n   ].concat(process.config.variables.v8_enable_inspector ? [\n     '--inspect-brk',\n     'inspect-brk',\n+    '--inspect_brk',\n   ] : []);\n \n   const badFlags = [\n-    '--inspect_brk',\n     'INSPECT-BRK',\n     '--INSPECT-BRK',\n     '--r',"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 45,
        "deletions": 58
    }
}