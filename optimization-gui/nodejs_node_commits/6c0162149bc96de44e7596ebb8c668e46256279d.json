{
    "author": "joyeecheung",
    "message": "src: move arch, platform and release into node_metadata.cc\n\nMove definitions of more metadata into node_metadata{.h, .cc}\nso the data can be reused and easily inspected in C++.\n\nPR-URL: https://github.com/nodejs/node/pull/25293\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "6c0162149bc96de44e7596ebb8c668e46256279d",
    "files": [
        {
            "sha": "0b496da4a273bcce4ac27f575bd14a3f344c1b9e",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 47,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=6c0162149bc96de44e7596ebb8c668e46256279d",
            "patch": "@@ -168,8 +168,10 @@ class NodeTraceStateObserver :\n       TRACE_EVENT_METADATA1(\"__metadata\", \"process_name\",\n                             \"name\", TRACE_STR_COPY(name_buffer));\n     }\n-    TRACE_EVENT_METADATA1(\"__metadata\", \"version\",\n-                          \"node\", NODE_VERSION_STRING);\n+    TRACE_EVENT_METADATA1(\"__metadata\",\n+                          \"version\",\n+                          \"node\",\n+                          per_process::metadata.versions.node.c_str());\n     TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\",\n                           \"name\", \"JavaScriptMainThread\");\n \n@@ -184,13 +186,15 @@ class NodeTraceStateObserver :\n \n     trace_process->EndDictionary();\n \n-    trace_process->SetString(\"arch\", NODE_ARCH);\n-    trace_process->SetString(\"platform\", NODE_PLATFORM);\n+    trace_process->SetString(\"arch\", per_process::metadata.arch.c_str());\n+    trace_process->SetString(\"platform\",\n+                             per_process::metadata.platform.c_str());\n \n     trace_process->BeginDictionary(\"release\");\n-    trace_process->SetString(\"name\", NODE_RELEASE);\n+    trace_process->SetString(\"name\",\n+                             per_process::metadata.release.name.c_str());\n #if NODE_VERSION_IS_LTS\n-    trace_process->SetString(\"lts\", NODE_VERSION_LTS_CODENAME);\n+    trace_process->SetString(\"lts\", per_process::metadata.release.lts.c_str());\n #endif\n     trace_process->EndDictionary();\n     TRACE_EVENT_METADATA1(\"__metadata\", \"node\",\n@@ -839,54 +843,29 @@ void SetupProcessObject(Environment* env,\n #undef V\n \n   // process.arch\n-  READONLY_PROPERTY(process, \"arch\", OneByteString(env->isolate(), NODE_ARCH));\n+  READONLY_STRING_PROPERTY(process, \"arch\", per_process::metadata.arch);\n \n   // process.platform\n-  READONLY_PROPERTY(process,\n-                    \"platform\",\n-                    OneByteString(env->isolate(), NODE_PLATFORM));\n+  READONLY_STRING_PROPERTY(process, \"platform\", per_process::metadata.platform);\n \n   // process.release\n   Local<Object> release = Object::New(env->isolate());\n   READONLY_PROPERTY(process, \"release\", release);\n-  READONLY_PROPERTY(release, \"name\",\n-                    OneByteString(env->isolate(), NODE_RELEASE));\n-\n+  READONLY_STRING_PROPERTY(release, \"name\", per_process::metadata.release.name);\n #if NODE_VERSION_IS_LTS\n-  READONLY_PROPERTY(release, \"lts\",\n-                    OneByteString(env->isolate(), NODE_VERSION_LTS_CODENAME));\n-#endif\n-\n-// if this is a release build and no explicit base has been set\n-// substitute the standard release download URL\n-#ifndef NODE_RELEASE_URLBASE\n-# if NODE_VERSION_IS_RELEASE\n-#  define NODE_RELEASE_URLBASE \"https://nodejs.org/download/release/\"\n-# endif\n-#endif\n-\n-#if defined(NODE_RELEASE_URLBASE)\n-#  define NODE_RELEASE_URLPFX NODE_RELEASE_URLBASE \"v\" NODE_VERSION_STRING \"/\"\n-#  define NODE_RELEASE_URLFPFX NODE_RELEASE_URLPFX \"node-v\" NODE_VERSION_STRING\n-\n-  READONLY_PROPERTY(release,\n-                    \"sourceUrl\",\n-                    OneByteString(env->isolate(),\n-                    NODE_RELEASE_URLFPFX \".tar.gz\"));\n-  READONLY_PROPERTY(release,\n-                    \"headersUrl\",\n-                    OneByteString(env->isolate(),\n-                    NODE_RELEASE_URLFPFX \"-headers.tar.gz\"));\n-#  ifdef _WIN32\n-  READONLY_PROPERTY(release,\n-                    \"libUrl\",\n-                    OneByteString(env->isolate(),\n-                    strcmp(NODE_ARCH, \"ia32\") ? NODE_RELEASE_URLPFX \"win-\"\n-                                                NODE_ARCH \"/node.lib\"\n-                                              : NODE_RELEASE_URLPFX\n-                                                \"win-x86/node.lib\"));\n-#  endif\n-#endif\n+  READONLY_STRING_PROPERTY(release, \"lts\", per_process::metadata.release.lts);\n+#endif  // NODE_VERSION_IS_LTS\n+\n+#ifdef NODE_HAS_RELEASE_URLS\n+  READONLY_STRING_PROPERTY(\n+      release, \"sourceUrl\", per_process::metadata.release.source_url);\n+  READONLY_STRING_PROPERTY(\n+      release, \"headersUrl\", per_process::metadata.release.headers_url);\n+#ifdef _WIN32\n+  READONLY_STRING_PROPERTY(\n+      release, \"libUrl\", per_process::metadata.release.lib_url);\n+#endif  // _WIN32\n+#endif  // NODE_HAS_RELEASE_URLS\n \n   // process.argv\n   process->Set(env->context(),"
        },
        {
            "sha": "602115ad4f25900d9d9a2d8256e4f08f585c8cf8",
            "filename": "src/node_metadata.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.cc?ref=6c0162149bc96de44e7596ebb8c668e46256279d",
            "patch": "@@ -90,4 +90,26 @@ Metadata::Versions::Versions() {\n #endif  // NODE_HAVE_I18N_SUPPORT\n }\n \n+Metadata::Release::Release() : name(NODE_RELEASE) {\n+#if NODE_VERSION_IS_LTS\n+  lts = NODE_VERSION_LTS_CODENAME;\n+#endif  // NODE_VERSION_IS_LTS\n+\n+#ifdef NODE_HAS_RELEASE_URLS\n+#define NODE_RELEASE_URLPFX NODE_RELEASE_URLBASE \"v\" NODE_VERSION_STRING \"/\"\n+#define NODE_RELEASE_URLFPFX NODE_RELEASE_URLPFX \"node-v\" NODE_VERSION_STRING\n+\n+  source_url = NODE_RELEASE_URLFPFX \".tar.gz\";\n+  headers_url = NODE_RELEASE_URLFPFX \"-headers.tar.gz\";\n+#ifdef _WIN32\n+  lib_url = strcmp(NODE_ARCH, \"ia32\") ? NODE_RELEASE_URLPFX \"win-\" NODE_ARCH\n+                                                           \"/node.lib\"\n+                                     : NODE_RELEASE_URLPFX \"win-x86/node.lib\";\n+#endif  // _WIN32\n+\n+#endif  // NODE_HAS_RELEASE_URLS\n+}\n+\n+Metadata::Metadata() : arch(NODE_ARCH), platform(NODE_PLATFORM) {}\n+\n }  // namespace node"
        },
        {
            "sha": "c6f379f085de03daa37c3cdb3d52fd0a7ae1db8d",
            "filename": "src/node_metadata.h",
            "status": "modified",
            "additions": 34,
            "deletions": 1,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode_metadata.h",
            "raw_url": "https://github.com/nodejs/node/raw/6c0162149bc96de44e7596ebb8c668e46256279d/src%2Fnode_metadata.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.h?ref=6c0162149bc96de44e7596ebb8c668e46256279d",
            "patch": "@@ -4,9 +4,22 @@\n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #include <string>\n+#include \"node_version.h\"\n \n namespace node {\n \n+// if this is a release build and no explicit base has been set\n+// substitute the standard release download URL\n+#ifndef NODE_RELEASE_URLBASE\n+#if NODE_VERSION_IS_RELEASE\n+#define NODE_RELEASE_URLBASE \"https://nodejs.org/download/release/\"\n+#endif  // NODE_VERSION_IS_RELEASE\n+#endif  // NODE_RELEASE_URLBASE\n+\n+#if defined(NODE_RELEASE_URLBASE)\n+#define NODE_HAS_RELEASE_URLS\n+#endif\n+\n #define NODE_VERSIONS_KEYS_BASE(V)                                             \\\n   V(node)                                                                      \\\n   V(v8)                                                                        \\\n@@ -43,7 +56,7 @@ namespace node {\n \n class Metadata {\n  public:\n-  Metadata() = default;\n+  Metadata();\n   Metadata(Metadata&) = delete;\n   Metadata(Metadata&&) = delete;\n   Metadata operator=(Metadata&) = delete;\n@@ -63,7 +76,27 @@ class Metadata {\n #undef V\n   };\n \n+  struct Release {\n+    Release();\n+\n+    std::string name;\n+#if NODE_VERSION_IS_LTS\n+    std::string lts;\n+#endif  // NODE_VERSION_IS_LTS\n+\n+#ifdef NODE_HAS_RELEASE_URLS\n+    std::string source_url;\n+    std::string headers_url;\n+#ifdef _WIN32\n+    std::string lib_url;\n+#endif  // _WIN32\n+#endif  // NODE_HAS_RELEASE_URLS\n+  };\n+\n   Versions versions;\n+  const Release release;\n+  const std::string arch;\n+  const std::string platform;\n };\n \n // Per-process global"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 82,
        "deletions": 48
    }
}