{
    "author": "cjihrig",
    "message": "test: fix flaky test\n\nThis commit fixes test-tls-set-secure-context.js. The test was\nmaking one long lasting HTTP connection, followed by a number of\nshorter lived connections. However, it was possible that the\nconnections were not received in the desired order. This commit\nensures that the long lasting connection is established before\nmaking any other connections.\n\nPR-URL: https://github.com/nodejs/node/pull/23811\nFixes: https://github.com/nodejs/node/issues/23807\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "b794f581b1475bccfe0606ab0fda49500bd58b6c",
    "files": [
        {
            "sha": "f8857701c68b3c94c42849bc5bf8aeef483908ae",
            "filename": "test/parallel/test-tls-set-secure-context.js",
            "status": "modified",
            "additions": 36,
            "deletions": 23,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/b794f581b1475bccfe0606ab0fda49500bd58b6c/test%2Fparallel%2Ftest-tls-set-secure-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/b794f581b1475bccfe0606ab0fda49500bd58b6c/test%2Fparallel%2Ftest-tls-set-secure-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-set-secure-context.js?ref=b794f581b1475bccfe0606ab0fda49500bd58b6c",
            "patch": "@@ -4,6 +4,10 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+// This test verifies the behavior of the tls setSecureContext() method.\n+// It also verifies that existing connections are not disrupted when the\n+// secure context is changed.\n+\n const assert = require('assert');\n const https = require('https');\n const fixtures = require('../common/fixtures');\n@@ -19,54 +23,63 @@ const credentialOptions = [\n     ca: fixtures.readKey('ca2-cert.pem')\n   }\n ];\n-let requestsCount = 0;\n let firstResponse;\n \n const server = https.createServer(credentialOptions[0], (req, res) => {\n-  requestsCount++;\n+  const id = +req.headers.id;\n \n-  if (requestsCount === 1) {\n+  if (id === 1) {\n     firstResponse = res;\n     firstResponse.write('multi-');\n     return;\n-  } else if (requestsCount === 3) {\n+  } else if (id === 4) {\n     firstResponse.write('success-');\n   }\n \n   res.end('success');\n });\n \n-server.listen(0, common.mustCall(async () => {\n+server.listen(0, common.mustCall(() => {\n   const { port } = server.address();\n-  const firstRequest = makeRequest(port);\n+  const firstRequest = makeRequest(port, 1);\n+\n+  async function makeRemainingRequests() {\n+    // Wait until the first request is guaranteed to have been handled.\n+    if (!firstResponse) {\n+      return setImmediate(makeRemainingRequests);\n+    }\n \n-  assert.strictEqual(await makeRequest(port), 'success');\n+    assert.strictEqual(await makeRequest(port, 2), 'success');\n \n-  server.setSecureContext(credentialOptions[1]);\n-  firstResponse.write('request-');\n-  await assert.rejects(async () => {\n-    await makeRequest(port);\n-  }, /^Error: self signed certificate$/);\n+    server.setSecureContext(credentialOptions[1]);\n+    firstResponse.write('request-');\n+    await assert.rejects(async () => {\n+      await makeRequest(port, 3);\n+    }, /^Error: self signed certificate$/);\n \n-  server.setSecureContext(credentialOptions[0]);\n-  assert.strictEqual(await makeRequest(port), 'success');\n+    server.setSecureContext(credentialOptions[0]);\n+    assert.strictEqual(await makeRequest(port, 4), 'success');\n \n-  server.setSecureContext(credentialOptions[1]);\n-  firstResponse.end('fun!');\n-  await assert.rejects(async () => {\n-    await makeRequest(port);\n-  }, /^Error: self signed certificate$/);\n+    server.setSecureContext(credentialOptions[1]);\n+    firstResponse.end('fun!');\n+    await assert.rejects(async () => {\n+      await makeRequest(port, 5);\n+    }, /^Error: self signed certificate$/);\n+\n+    assert.strictEqual(await firstRequest, 'multi-request-success-fun!');\n+    server.close();\n+  }\n \n-  assert.strictEqual(await firstRequest, 'multi-request-success-fun!');\n-  server.close();\n+  makeRemainingRequests();\n }));\n \n-function makeRequest(port) {\n+function makeRequest(port, id) {\n   return new Promise((resolve, reject) => {\n     const options = {\n       rejectUnauthorized: true,\n       ca: credentialOptions[0].ca,\n-      servername: 'agent1'\n+      servername: 'agent1',\n+      headers: { id }\n     };\n \n     https.get(`https://localhost:${port}`, options, (res) => {"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 36,
        "deletions": 23
    }
}