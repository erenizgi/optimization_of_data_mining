{
    "author": "addaleax",
    "message": "src: refactor default trace writer out of agent\n\nThe agent code is supposed to manage multiple writers/clients.\nAdding the default writer into the mix breaks that encapsulation.\nInstead, manage default options through a separate \"virtual\"\ndefault client handle, and keep the file writer management\nall to the actual users.\n\nPR-URL: https://github.com/nodejs/node/pull/21867\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "620e46c8b59b6269784ebba42b23f23897eeedb9",
    "files": [
        {
            "sha": "c38e37f786374d89aecca39798c6d7697d078d37",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -325,8 +325,8 @@ inline v8::Isolate* Environment::isolate() const {\n   return isolate_;\n }\n \n-inline tracing::Agent* Environment::tracing_agent() const {\n-  return tracing_agent_;\n+inline tracing::AgentWriterHandle* Environment::tracing_agent_writer() const {\n+  return tracing_agent_writer_;\n }\n \n inline Environment* Environment::from_timer_handle(uv_timer_t* handle) {"
        },
        {
            "sha": "244c6d8be37685a99fc39c693214d44dc0a962d2",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -105,10 +105,10 @@ void InitThreadLocalOnce() {\n \n Environment::Environment(IsolateData* isolate_data,\n                          Local<Context> context,\n-                         tracing::Agent* tracing_agent)\n+                         tracing::AgentWriterHandle* tracing_agent_writer)\n     : isolate_(context->GetIsolate()),\n       isolate_data_(isolate_data),\n-      tracing_agent_(tracing_agent),\n+      tracing_agent_writer_(tracing_agent_writer),\n       immediate_info_(context->GetIsolate()),\n       tick_info_(context->GetIsolate()),\n       timer_base_(uv_now(isolate_data->event_loop())),"
        },
        {
            "sha": "91ae7824281cb7f49382017cca98f55981c43304",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -55,7 +55,7 @@ class performance_state;\n }\n \n namespace tracing {\n-class Agent;\n+class AgentWriterHandle;\n }\n \n namespace worker {\n@@ -587,7 +587,7 @@ class Environment {\n \n   Environment(IsolateData* isolate_data,\n               v8::Local<v8::Context> context,\n-              tracing::Agent* tracing_agent);\n+              tracing::AgentWriterHandle* tracing_agent_writer);\n   ~Environment();\n \n   void Start(int argc,\n@@ -625,7 +625,7 @@ class Environment {\n   inline bool profiler_idle_notifier_started() const;\n \n   inline v8::Isolate* isolate() const;\n-  inline tracing::Agent* tracing_agent() const;\n+  inline tracing::AgentWriterHandle* tracing_agent_writer() const;\n   inline uv_loop_t* event_loop() const;\n   inline uint32_t watched_providers() const;\n \n@@ -879,7 +879,7 @@ class Environment {\n \n   v8::Isolate* const isolate_;\n   IsolateData* const isolate_data_;\n-  tracing::Agent* const tracing_agent_;\n+  tracing::AgentWriterHandle* const tracing_agent_writer_;\n   uv_timer_t timer_handle_;\n   uv_check_t immediate_check_handle_;\n   uv_idle_t immediate_idle_handle_;"
        },
        {
            "sha": "6e962b289ab36f2e702fff5df8af99c42518c3e6",
            "filename": "src/inspector/tracing_agent.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Finspector%2Ftracing_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Finspector%2Ftracing_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector%2Ftracing_agent.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -74,10 +74,11 @@ DispatchResponse TracingAgent::start(\n   if (categories_set.empty())\n     return DispatchResponse::Error(\"At least one category should be enabled\");\n \n-  trace_writer_ = env_->tracing_agent()->AddClient(\n+  trace_writer_ = env_->tracing_agent_writer()->agent()->AddClient(\n       categories_set,\n       std::unique_ptr<InspectorTraceWriter>(\n-          new InspectorTraceWriter(frontend_.get())));\n+          new InspectorTraceWriter(frontend_.get())),\n+      tracing::Agent::kIgnoreDefaultCategories);\n   return DispatchResponse::OK();\n }\n "
        },
        {
            "sha": "a7b7f45b30a843b7692eadf9987150be759aa8a2",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -61,6 +61,7 @@\n #include \"req_wrap-inl.h\"\n #include \"string_bytes.h\"\n #include \"tracing/agent.h\"\n+#include \"tracing/node_trace_writer.h\"\n #include \"util.h\"\n #include \"uv.h\"\n #if NODE_USE_V8_PLATFORM\n@@ -427,17 +428,24 @@ static struct {\n #endif  // HAVE_INSPECTOR\n \n   void StartTracingAgent() {\n-    tracing_file_writer_ = tracing_agent_->AddClient(\n-        trace_enabled_categories,\n-        new tracing::NodeTraceWriter(trace_file_pattern));\n+    if (trace_enabled_categories.empty()) {\n+      tracing_file_writer_ = tracing_agent_->DefaultHandle();\n+    } else {\n+      tracing_file_writer_ = tracing_agent_->AddClient(\n+          ParseCommaSeparatedSet(trace_enabled_categories),\n+          std::unique_ptr<tracing::AsyncTraceWriter>(\n+              new tracing::NodeTraceWriter(trace_file_pattern,\n+                                           tracing_agent_->loop())),\n+          tracing::Agent::kUseDefaultCategories);\n+    }\n   }\n \n   void StopTracingAgent() {\n     tracing_file_writer_.reset();\n   }\n \n-  tracing::Agent* GetTracingAgent() const {\n-    return tracing_agent_.get();\n+  tracing::AgentWriterHandle* GetTracingAgentWriter() {\n+    return &tracing_file_writer_;\n   }\n \n   NodePlatform* Platform() {\n@@ -466,7 +474,9 @@ static struct {\n   }\n   void StopTracingAgent() {}\n \n-  tracing::Agent* GetTracingAgent() const { return nullptr; }\n+  tracing::AgentWriterHandle* GetTracingAgentWriter() {\n+    return nullptr;\n+  }\n \n   NodePlatform* Platform() {\n     return nullptr;\n@@ -3590,7 +3600,7 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   HandleScope handle_scope(isolate);\n   Context::Scope context_scope(context);\n   auto env = new Environment(isolate_data, context,\n-                             v8_platform.GetTracingAgent());\n+                             v8_platform.GetTracingAgentWriter());\n   env->Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n   return env;\n }\n@@ -3649,7 +3659,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   HandleScope handle_scope(isolate);\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n-  Environment env(isolate_data, context, v8_platform.GetTracingAgent());\n+  Environment env(isolate_data, context, v8_platform.GetTracingAgentWriter());\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n   const char* path = argc > 1 ? argv[1] : nullptr;"
        },
        {
            "sha": "d59b92555795fbf0e49904db2eae48d529474a62",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -58,7 +58,7 @@ void NodeCategorySet::New(const FunctionCallbackInfo<Value>& args) {\n     if (!*val) return;\n     categories.emplace(*val);\n   }\n-  CHECK_NOT_NULL(env->tracing_agent());\n+  CHECK_NOT_NULL(env->tracing_agent_writer());\n   new NodeCategorySet(env, args.This(), std::move(categories));\n }\n \n@@ -69,7 +69,7 @@ void NodeCategorySet::Enable(const FunctionCallbackInfo<Value>& args) {\n   CHECK_NOT_NULL(category_set);\n   const auto& categories = category_set->GetCategories();\n   if (!category_set->enabled_ && !categories.empty()) {\n-    env->tracing_agent()->Enable(categories);\n+    env->tracing_agent_writer()->Enable(categories);\n     category_set->enabled_ = true;\n   }\n }\n@@ -81,14 +81,15 @@ void NodeCategorySet::Disable(const FunctionCallbackInfo<Value>& args) {\n   CHECK_NOT_NULL(category_set);\n   const auto& categories = category_set->GetCategories();\n   if (category_set->enabled_ && !categories.empty()) {\n-    env->tracing_agent()->Disable(categories);\n+    env->tracing_agent_writer()->Disable(categories);\n     category_set->enabled_ = false;\n   }\n }\n \n void GetEnabledCategories(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n-  std::string categories = env->tracing_agent()->GetEnabledCategories();\n+  std::string categories =\n+      env->tracing_agent_writer()->agent()->GetEnabledCategories();\n   if (!categories.empty()) {\n     args.GetReturnValue().Set(\n       String::NewFromUtf8(env->isolate(),"
        },
        {
            "sha": "641c476c1d8df757bc862b6857d00f609bc8acbd",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 53,
            "changes": 97,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -1,23 +1,24 @@\n #include \"tracing/agent.h\"\n \n-#include <sstream>\n #include <string>\n #include \"tracing/node_trace_buffer.h\"\n-#include \"tracing/node_trace_writer.h\"\n \n namespace node {\n namespace tracing {\n \n-namespace {\n-\n-class ScopedSuspendTracing {\n+class Agent::ScopedSuspendTracing {\n  public:\n-  ScopedSuspendTracing(TracingController* controller, Agent* agent)\n-                       : controller_(controller), agent_(agent) {\n-    controller->StopTracing();\n+  ScopedSuspendTracing(TracingController* controller, Agent* agent,\n+                       bool do_suspend = true)\n+    : controller_(controller), agent_(do_suspend ? agent : nullptr) {\n+    if (do_suspend) {\n+      CHECK(agent_->started_);\n+      controller->StopTracing();\n+    }\n   }\n \n   ~ScopedSuspendTracing() {\n+    if (agent_ == nullptr) return;\n     TraceConfig* config = agent_->CreateTraceConfig();\n     if (config != nullptr) {\n       controller_->StartTracing(config);\n@@ -29,8 +30,10 @@ class ScopedSuspendTracing {\n   Agent* agent_;\n };\n \n+namespace {\n+\n std::set<std::string> flatten(\n-    const std::unordered_map<int, std::set<std::string>>& map) {\n+    const std::unordered_map<int, std::multiset<std::string>>& map) {\n   std::set<std::string> result;\n   for (const auto& id_value : map)\n     result.insert(id_value.second.begin(), id_value.second.end());\n@@ -43,18 +46,17 @@ using v8::platform::tracing::TraceConfig;\n using v8::platform::tracing::TraceWriter;\n using std::string;\n \n-Agent::Agent(const std::string& log_file_pattern)\n-    : log_file_pattern_(log_file_pattern) {\n+Agent::Agent() {\n   tracing_controller_ = new TracingController();\n   tracing_controller_->Initialize(nullptr);\n+\n+  CHECK_EQ(uv_loop_init(&tracing_loop_), 0);\n }\n \n void Agent::Start() {\n   if (started_)\n     return;\n \n-  CHECK_EQ(uv_loop_init(&tracing_loop_), 0);\n-\n   NodeTraceBuffer* trace_buffer_ = new NodeTraceBuffer(\n       NodeTraceBuffer::kBufferChunks, this, &tracing_loop_);\n   tracing_controller_->Initialize(trace_buffer_);\n@@ -71,18 +73,30 @@ void Agent::Start() {\n \n AgentWriterHandle Agent::AddClient(\n     const std::set<std::string>& categories,\n-    std::unique_ptr<AsyncTraceWriter> writer) {\n+    std::unique_ptr<AsyncTraceWriter> writer,\n+    enum UseDefaultCategoryMode mode) {\n   Start();\n+\n+  const std::set<std::string>* use_categories = &categories;\n+\n+  std::set<std::string> categories_with_default;\n+  if (mode == kUseDefaultCategories) {\n+    categories_with_default.insert(categories.begin(), categories.end());\n+    categories_with_default.insert(categories_[kDefaultHandleId].begin(),\n+                                   categories_[kDefaultHandleId].end());\n+    use_categories = &categories_with_default;\n+  }\n+\n   ScopedSuspendTracing suspend(tracing_controller_, this);\n   int id = next_writer_id_++;\n   writers_[id] = std::move(writer);\n-  categories_[id] = categories;\n+  categories_[id] = { use_categories->begin(), use_categories->end() };\n \n   return AgentWriterHandle(this, id);\n }\n \n-void Agent::Stop() {\n-  file_writer_.reset();\n+AgentWriterHandle Agent::DefaultHandle() {\n+  return AgentWriterHandle(this, kDefaultHandleId);\n }\n \n void Agent::StopTracing() {\n@@ -99,54 +113,30 @@ void Agent::StopTracing() {\n }\n \n void Agent::Disconnect(int client) {\n+  if (client == kDefaultHandleId) return;\n   ScopedSuspendTracing suspend(tracing_controller_, this);\n   writers_.erase(client);\n   categories_.erase(client);\n }\n \n-void Agent::Enable(const std::string& categories) {\n+void Agent::Enable(int id, const std::set<std::string>& categories) {\n   if (categories.empty())\n     return;\n-  std::set<std::string> categories_set;\n-  std::istringstream category_list(categories);\n-  while (category_list.good()) {\n-    std::string category;\n-    getline(category_list, category, ',');\n-    categories_set.emplace(std::move(category));\n-  }\n-  Enable(categories_set);\n-}\n \n-void Agent::Enable(const std::set<std::string>& categories) {\n-  if (categories.empty())\n-    return;\n-\n-  file_writer_categories_.insert(categories.begin(), categories.end());\n-  std::set<std::string> full_list(file_writer_categories_.begin(),\n-                                  file_writer_categories_.end());\n-  if (file_writer_.empty()) {\n-    // Ensure background thread is running\n-    Start();\n-    std::unique_ptr<NodeTraceWriter> writer(\n-        new NodeTraceWriter(log_file_pattern_, &tracing_loop_));\n-    file_writer_ = AddClient(full_list, std::move(writer));\n-  } else {\n-    ScopedSuspendTracing suspend(tracing_controller_, this);\n-    categories_[file_writer_.id_] = full_list;\n-  }\n+  ScopedSuspendTracing suspend(tracing_controller_, this,\n+                               id != kDefaultHandleId);\n+  categories_[id].insert(categories.begin(), categories.end());\n }\n \n-void Agent::Disable(const std::set<std::string>& categories) {\n+void Agent::Disable(int id, const std::set<std::string>& categories) {\n+  ScopedSuspendTracing suspend(tracing_controller_, this,\n+                               id != kDefaultHandleId);\n+  std::multiset<std::string>& writer_categories = categories_[id];\n   for (const std::string& category : categories) {\n-    auto it = file_writer_categories_.find(category);\n-    if (it != file_writer_categories_.end())\n-      file_writer_categories_.erase(it);\n+    auto it = writer_categories.find(category);\n+    if (it != writer_categories.end())\n+      writer_categories.erase(it);\n   }\n-  if (file_writer_.empty())\n-    return;\n-  ScopedSuspendTracing suspend(tracing_controller_, this);\n-  categories_[file_writer_.id_] = { file_writer_categories_.begin(),\n-                                    file_writer_categories_.end() };\n }\n \n TraceConfig* Agent::CreateTraceConfig() const {\n@@ -178,5 +168,6 @@ void Agent::Flush(bool blocking) {\n   for (const auto& id_writer : writers_)\n     id_writer.second->Flush(blocking);\n }\n+\n }  // namespace tracing\n }  // namespace node"
        },
        {
            "sha": "b62dc5fe5bc9d5fde9c6cdf50c7b2718fdf4c4d9",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 35,
            "deletions": 12,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -44,6 +44,11 @@ class AgentWriterHandle {\n   inline bool empty() const { return agent_ == nullptr; }\n   inline void reset();\n \n+  inline void Enable(const std::set<std::string>& categories);\n+  inline void Disable(const std::set<std::string>& categories);\n+\n+  inline Agent* agent() { return agent_; }\n+\n  private:\n   inline AgentWriterHandle(Agent* agent, int id) : agent_(agent), id_(id) {}\n \n@@ -58,19 +63,23 @@ class AgentWriterHandle {\n \n class Agent {\n  public:\n-  explicit Agent(const std::string& log_file_pattern);\n-  void Stop();\n+  Agent();\n \n   TracingController* GetTracingController() { return tracing_controller_; }\n \n+  enum UseDefaultCategoryMode {\n+    kUseDefaultCategories,\n+    kIgnoreDefaultCategories\n+  };\n+\n   // Destroying the handle disconnects the client\n   AgentWriterHandle AddClient(const std::set<std::string>& categories,\n-                              std::unique_ptr<AsyncTraceWriter> writer);\n-\n-  // These 3 methods operate on a \"default\" client, e.g. the file writer\n-  void Enable(const std::string& categories);\n-  void Enable(const std::set<std::string>& categories);\n-  void Disable(const std::set<std::string>& categories);\n+                              std::unique_ptr<AsyncTraceWriter> writer,\n+                              enum UseDefaultCategoryMode mode);\n+  // A handle that is only used for managing the default categories\n+  // (which can then implicitly be used through using `USE_DEFAULT_CATEGORIES`\n+  // when adding a client later).\n+  AgentWriterHandle DefaultHandle();\n \n   // Returns a comma-separated list of enabled categories.\n   std::string GetEnabledCategories() const;\n@@ -82,6 +91,9 @@ class Agent {\n \n   TraceConfig* CreateTraceConfig() const;\n \n+  // TODO(addaleax): This design is broken and inherently thread-unsafe.\n+  inline uv_loop_t* loop() { return &tracing_loop_; }\n+\n  private:\n   friend class AgentWriterHandle;\n \n@@ -91,19 +103,22 @@ class Agent {\n   void StopTracing();\n   void Disconnect(int client);\n \n-  const std::string& log_file_pattern_;\n+  void Enable(int id, const std::set<std::string>& categories);\n+  void Disable(int id, const std::set<std::string>& categories);\n+\n   uv_thread_t thread_;\n   uv_loop_t tracing_loop_;\n+\n   bool started_ = false;\n+  class ScopedSuspendTracing;\n \n   // Each individual Writer has one id.\n   int next_writer_id_ = 1;\n+  enum { kDefaultHandleId = -1 };\n   // These maps store the original arguments to AddClient(), by id.\n-  std::unordered_map<int, std::set<std::string>> categories_;\n+  std::unordered_map<int, std::multiset<std::string>> categories_;\n   std::unordered_map<int, std::unique_ptr<AsyncTraceWriter>> writers_;\n   TracingController* tracing_controller_ = nullptr;\n-  AgentWriterHandle file_writer_;\n-  std::multiset<std::string> file_writer_categories_;\n };\n \n void AgentWriterHandle::reset() {\n@@ -124,6 +139,14 @@ AgentWriterHandle::AgentWriterHandle(AgentWriterHandle&& other) {\n   *this = std::move(other);\n }\n \n+void AgentWriterHandle::Enable(const std::set<std::string>& categories) {\n+  if (agent_ != nullptr) agent_->Enable(id_, categories);\n+}\n+\n+void AgentWriterHandle::Disable(const std::set<std::string>& categories) {\n+  if (agent_ != nullptr) agent_->Disable(id_, categories);\n+}\n+\n }  // namespace tracing\n }  // namespace node\n "
        },
        {
            "sha": "66be18eae2d150318f856841070cbd6d2047ea1e",
            "filename": "src/util.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Futil.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Futil.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.cc?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -24,6 +24,7 @@\n #include \"node_internals.h\"\n #include \"uv.h\"\n #include <stdio.h>\n+#include <sstream>\n \n namespace node {\n \n@@ -118,4 +119,17 @@ void GetHumanReadableProcessName(char (*name)[1024]) {\n   snprintf(*name, sizeof(*name), \"%s[%d]\", title, uv_os_getpid());\n }\n \n+std::set<std::string> ParseCommaSeparatedSet(const std::string& in) {\n+  std::set<std::string> out;\n+  if (in.empty())\n+    return out;\n+  std::istringstream in_stream(in);\n+  while (in_stream.good()) {\n+    std::string item;\n+    getline(in_stream, item, ',');\n+    out.emplace(std::move(item));\n+  }\n+  return out;\n+}\n+\n }  // namespace node"
        },
        {
            "sha": "a9fce79ebeaec18f41714bfebc2144676b4149e7",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/620e46c8b59b6269784ebba42b23f23897eeedb9/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=620e46c8b59b6269784ebba42b23f23897eeedb9",
            "patch": "@@ -36,6 +36,7 @@\n \n #include <string>\n #include <functional>  // std::function\n+#include <set>\n \n namespace node {\n \n@@ -476,6 +477,8 @@ struct FunctionDeleter {\n template <typename T, void (*function)(T*)>\n using DeleteFnPtr = typename FunctionDeleter<T, function>::Pointer;\n \n+std::set<std::string> ParseCommaSeparatedSet(const std::string& in);\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        }
    ],
    "stats": {
        "total": 217,
        "additions": 130,
        "deletions": 87
    }
}