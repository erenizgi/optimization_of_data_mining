{
    "author": "cjihrig",
    "message": "cluster: use Map to track handles in master\n\nPR-URL: https://github.com/nodejs/node/pull/23125\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "847037eaeddbb4ad493a6686f61f8b2d03266ff2",
    "files": [
        {
            "sha": "2eead0b8a3a70a2eb0ced590ab7209c0d21e58ae",
            "filename": "lib/internal/cluster/master.js",
            "status": "modified",
            "additions": 16,
            "deletions": 17,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/847037eaeddbb4ad493a6686f61f8b2d03266ff2/lib%2Finternal%2Fcluster%2Fmaster.js",
            "raw_url": "https://github.com/nodejs/node/raw/847037eaeddbb4ad493a6686f61f8b2d03266ff2/lib%2Finternal%2Fcluster%2Fmaster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcluster%2Fmaster.js?ref=847037eaeddbb4ad493a6686f61f8b2d03266ff2",
            "patch": "@@ -148,20 +148,18 @@ function removeWorker(worker) {\n   delete cluster.workers[worker.id];\n \n   if (keys(cluster.workers).length === 0) {\n-    assert(keys(handles).length === 0, 'Resource leak detected.');\n+    assert(handles.size === 0, 'Resource leak detected.');\n     intercom.emit('disconnect');\n   }\n }\n \n function removeHandlesForWorker(worker) {\n   assert(worker);\n \n-  for (var key in handles) {\n-    const handle = handles[key];\n-\n+  handles.forEach((handle, key) => {\n     if (handle.remove(worker))\n-      delete handles[key];\n-  }\n+      handles.delete(key);\n+  });\n }\n \n cluster.fork = function(env) {\n@@ -277,7 +275,7 @@ function queryServer(worker, message) {\n \n   const key = `${message.address}:${message.port}:${message.addressType}:` +\n               `${message.fd}:${message.index}`;\n-  var handle = handles[key];\n+  var handle = handles.get(key);\n \n   if (handle === undefined) {\n     let address = message.address;\n@@ -302,12 +300,13 @@ function queryServer(worker, message) {\n       constructor = SharedHandle;\n     }\n \n-    handles[key] = handle = new constructor(key,\n-                                            address,\n-                                            message.port,\n-                                            message.addressType,\n-                                            message.fd,\n-                                            message.flags);\n+    handle = new constructor(key,\n+                             address,\n+                             message.port,\n+                             message.addressType,\n+                             message.fd,\n+                             message.flags);\n+    handles.set(key, handle);\n   }\n \n   if (!handle.data)\n@@ -319,11 +318,11 @@ function queryServer(worker, message) {\n       errno: errno,\n       key: key,\n       ack: message.seq,\n-      data: handles[key].data\n+      data: handles.get(key).data\n     }, reply);\n \n     if (errno)\n-      delete handles[key];  // Gives other workers a chance to retry.\n+      handles.delete(key);  // Gives other workers a chance to retry.\n \n     send(worker, reply, handle);\n   });\n@@ -346,10 +345,10 @@ function listening(worker, message) {\n // removed by a prior call to removeHandlesForWorker() so guard against that.\n function close(worker, message) {\n   const key = message.key;\n-  const handle = handles[key];\n+  const handle = handles.get(key);\n \n   if (handle && handle.remove(worker))\n-    delete handles[key];\n+    handles.delete(key);\n }\n \n function send(worker, message, handle, cb) {"
        },
        {
            "sha": "c3e14cbb53a7213119d23e61a3a18055027ebc8f",
            "filename": "lib/internal/cluster/utils.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/847037eaeddbb4ad493a6686f61f8b2d03266ff2/lib%2Finternal%2Fcluster%2Futils.js",
            "raw_url": "https://github.com/nodejs/node/raw/847037eaeddbb4ad493a6686f61f8b2d03266ff2/lib%2Finternal%2Fcluster%2Futils.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcluster%2Futils.js?ref=847037eaeddbb4ad493a6686f61f8b2d03266ff2",
            "patch": "@@ -4,7 +4,7 @@ const util = require('util');\n module.exports = {\n   sendHelper,\n   internal,\n-  handles: {} // Used in tests.\n+  handles: new Map() // Used in tests.\n };\n \n const callbacks = new Map();"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 17,
        "deletions": 18
    }
}