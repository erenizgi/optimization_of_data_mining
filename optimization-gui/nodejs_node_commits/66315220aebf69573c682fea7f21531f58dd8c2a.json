{
    "author": "bnoordhuis",
    "message": "src: clean up process.dlopen()\n\nMove some code around and clean up the DLib helper class as prep work\nfor a follow-up commit.\n\nPR-URL: https://github.com/nodejs/node/pull/18934\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Matheus Marchini <matheus@sthima.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "66315220aebf69573c682fea7f21531f58dd8c2a",
    "files": [
        {
            "sha": "6d082caacf98dcb598dc5e9e52a6d86329adcac8",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 61,
            "deletions": 53,
            "changes": 114,
            "blob_url": "https://github.com/nodejs/node/blob/66315220aebf69573c682fea7f21531f58dd8c2a/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/66315220aebf69573c682fea7f21531f58dd8c2a/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=66315220aebf69573c682fea7f21531f58dd8c2a",
            "patch": "@@ -2147,46 +2147,62 @@ node_module* get_linked_module(const char* name) {\n }\n \n struct DLib {\n-  std::string filename_;\n-  std::string errmsg_;\n-  void* handle_;\n-  int flags_;\n-\n #ifdef __POSIX__\n   static const int kDefaultFlags = RTLD_LAZY;\n+#else\n+  static const int kDefaultFlags = 0;\n+#endif\n \n-  bool Open() {\n-    handle_ = dlopen(filename_.c_str(), flags_);\n-    if (handle_ != nullptr)\n-      return true;\n-    errmsg_ = dlerror();\n-    return false;\n-  }\n+  inline DLib(const char* filename, int flags)\n+      : filename_(filename), flags_(flags), handle_(nullptr) {}\n \n-  void Close() {\n-    if (handle_ != nullptr)\n-      dlclose(handle_);\n-  }\n-#else  // !__POSIX__\n-  static const int kDefaultFlags = 0;\n+  inline bool Open();\n+  inline void Close();\n+\n+  const std::string filename_;\n+  const int flags_;\n+  std::string errmsg_;\n+  void* handle_;\n+#ifndef __POSIX__\n   uv_lib_t lib_;\n+#endif\n \n-  bool Open() {\n-    int ret = uv_dlopen(filename_.c_str(), &lib_);\n-    if (ret == 0) {\n-      handle_ = static_cast<void*>(lib_.handle);\n-      return true;\n-    }\n-    errmsg_ = uv_dlerror(&lib_);\n-    uv_dlclose(&lib_);\n-    return false;\n-  }\n+  DISALLOW_COPY_AND_ASSIGN(DLib);\n+};\n+\n+\n+#ifdef __POSIX__\n+bool DLib::Open() {\n+  handle_ = dlopen(filename_.c_str(), flags_);\n+  if (handle_ != nullptr)\n+    return true;\n+  errmsg_ = dlerror();\n+  return false;\n+}\n \n-  void Close() {\n-    uv_dlclose(&lib_);\n+void DLib::Close() {\n+  if (handle_ == nullptr) return;\n+  dlclose(handle_);\n+  handle_ = nullptr;\n+}\n+#else  // !__POSIX__\n+bool DLib::Open() {\n+  int ret = uv_dlopen(filename_.c_str(), &lib_);\n+  if (ret == 0) {\n+    handle_ = static_cast<void*>(lib_.handle);\n+    return true;\n   }\n+  errmsg_ = uv_dlerror(&lib_);\n+  uv_dlclose(&lib_);\n+  return false;\n+}\n+\n+void DLib::Close() {\n+  if (handle_ == nullptr) return;\n+  uv_dlclose(&lib_);\n+  handle_ = nullptr;\n+}\n #endif  // !__POSIX__\n-};\n \n // DLOpen is process.dlopen(module, filename, flags).\n // Used to load 'module.node' dynamically shared objects.\n@@ -2196,6 +2212,7 @@ struct DLib {\n // cache that's a plain C list or hash table that's shared across contexts?\n static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n+  auto context = env->context();\n \n   CHECK_EQ(modpending, nullptr);\n \n@@ -2205,16 +2222,21 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   int32_t flags = DLib::kDefaultFlags;\n-  if (args.Length() > 2 && !args[2]->Int32Value(env->context()).To(&flags)) {\n+  if (args.Length() > 2 && !args[2]->Int32Value(context).To(&flags)) {\n     return env->ThrowTypeError(\"flag argument must be an integer.\");\n   }\n \n-  Local<Object> module =\n-      args[0]->ToObject(env->context()).ToLocalChecked();  // Cast\n+  Local<Object> module;\n+  Local<Object> exports;\n+  Local<Value> exports_v;\n+  if (!args[0]->ToObject(context).ToLocal(&module) ||\n+      !module->Get(context, env->exports_string()).ToLocal(&exports_v) ||\n+      !exports_v->ToObject(context).ToLocal(&exports)) {\n+    return;  // Exception pending.\n+  }\n+\n   node::Utf8Value filename(env->isolate(), args[1]);  // Cast\n-  DLib dlib;\n-  dlib.filename_ = *filename;\n-  dlib.flags_ = flags;\n+  DLib dlib(*filename, flags);\n   bool is_opened = dlib.Open();\n \n   // Objects containing v14 or later modules will have registered themselves\n@@ -2229,7 +2251,7 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n #ifdef _WIN32\n     // Windows needs to add the filename into the error message\n     errmsg = String::Concat(errmsg,\n-                            args[1]->ToString(env->context()).ToLocalChecked());\n+                            args[1]->ToString(context).ToLocalChecked());\n #endif  // _WIN32\n     env->isolate()->ThrowException(Exception::Error(errmsg));\n     return;\n@@ -2276,22 +2298,8 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n   mp->nm_link = modlist_addon;\n   modlist_addon = mp;\n \n-  Local<String> exports_string = env->exports_string();\n-  MaybeLocal<Value> maybe_exports =\n-      module->Get(env->context(), exports_string);\n-\n-  if (maybe_exports.IsEmpty() ||\n-      maybe_exports.ToLocalChecked()->ToObject(env->context()).IsEmpty()) {\n-    dlib.Close();\n-    return;\n-  }\n-\n-  Local<Object> exports =\n-      maybe_exports.ToLocalChecked()->ToObject(env->context())\n-          .FromMaybe(Local<Object>());\n-\n   if (mp->nm_context_register_func != nullptr) {\n-    mp->nm_context_register_func(exports, module, env->context(), mp->nm_priv);\n+    mp->nm_context_register_func(exports, module, context, mp->nm_priv);\n   } else if (mp->nm_register_func != nullptr) {\n     mp->nm_register_func(exports, module, mp->nm_priv);\n   } else {"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 61,
        "deletions": 53
    }
}