{
    "author": "addaleax",
    "message": "src: pass along errors from KeyObject instantiation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "620209628af6c8489300abe5c5b7bee69509ab35",
    "files": [
        {
            "sha": "be6f22a1ac7153e2fec4d761b12fc5ddd23f3264",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 17,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/620209628af6c8489300abe5c5b7bee69509ab35/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/620209628af6c8489300abe5c5b7bee69509ab35/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=620209628af6c8489300abe5c5b7bee69509ab35",
            "patch": "@@ -3329,15 +3329,18 @@ Local<Function> KeyObject::Initialize(Environment* env, Local<Object> target) {\n   return function;\n }\n \n-Local<Object> KeyObject::Create(Environment* env,\n-                                KeyType key_type,\n-                                const ManagedEVPPKey& pkey) {\n+MaybeLocal<Object> KeyObject::Create(Environment* env,\n+                                     KeyType key_type,\n+                                     const ManagedEVPPKey& pkey) {\n   CHECK_NE(key_type, kKeyTypeSecret);\n   Local<Value> type = Integer::New(env->isolate(), key_type);\n-  Local<Object> obj =\n-      env->crypto_key_object_constructor()->NewInstance(env->context(),\n-                                                        1, &type)\n-      .ToLocalChecked();\n+  Local<Object> obj;\n+  if (!env->crypto_key_object_constructor()\n+           ->NewInstance(env->context(), 1, &type)\n+           .ToLocal(&obj)) {\n+    return MaybeLocal<Object>();\n+  }\n+\n   KeyObject* key = Unwrap<KeyObject>(obj);\n   CHECK(key);\n   if (key_type == kKeyTypePublic)\n@@ -5825,24 +5828,22 @@ class GenerateKeyPairJob : public CryptoJob {\n     if (public_key_encoding_.output_key_object_) {\n       // Note that this has the downside of containing sensitive data of the\n       // private key.\n-      *pubkey = KeyObject::Create(env, kKeyTypePublic, pkey_);\n+      if (!KeyObject::Create(env, kKeyTypePublic, pkey_).ToLocal(pubkey))\n+        return false;\n     } else {\n-      MaybeLocal<Value> maybe_pubkey =\n-          WritePublicKey(env, pkey_.get(), public_key_encoding_);\n-      if (maybe_pubkey.IsEmpty())\n+      if (!WritePublicKey(env, pkey_.get(), public_key_encoding_)\n+               .ToLocal(pubkey))\n         return false;\n-      *pubkey = maybe_pubkey.ToLocalChecked();\n     }\n \n     // Now do the same for the private key.\n     if (private_key_encoding_.output_key_object_) {\n-      *privkey = KeyObject::Create(env, kKeyTypePrivate, pkey_);\n+      if (!KeyObject::Create(env, kKeyTypePrivate, pkey_).ToLocal(privkey))\n+        return false;\n     } else {\n-      MaybeLocal<Value> maybe_privkey =\n-          WritePrivateKey(env, pkey_.get(), private_key_encoding_);\n-      if (maybe_privkey.IsEmpty())\n+      if (!WritePrivateKey(env, pkey_.get(), private_key_encoding_)\n+               .ToLocal(privkey))\n         return false;\n-      *privkey = maybe_privkey.ToLocalChecked();\n     }\n \n     return true;"
        },
        {
            "sha": "7c346a6c1435d1523538b99f9b475579e565ae72",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/620209628af6c8489300abe5c5b7bee69509ab35/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/620209628af6c8489300abe5c5b7bee69509ab35/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=620209628af6c8489300abe5c5b7bee69509ab35",
            "patch": "@@ -442,9 +442,9 @@ class KeyObject : public BaseObject {\n   static v8::Local<v8::Function> Initialize(Environment* env,\n                                             v8::Local<v8::Object> target);\n \n-  static v8::Local<v8::Object> Create(Environment* env,\n-                                      KeyType type,\n-                                      const ManagedEVPPKey& pkey);\n+  static v8::MaybeLocal<v8::Object> Create(Environment* env,\n+                                           KeyType type,\n+                                           const ManagedEVPPKey& pkey);\n \n   // TODO(tniessen): track the memory used by OpenSSL types\n   SET_NO_MEMORY_INFO()"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 21,
        "deletions": 20
    }
}