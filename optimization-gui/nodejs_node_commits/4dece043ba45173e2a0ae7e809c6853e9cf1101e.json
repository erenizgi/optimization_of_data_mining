{
    "author": "bzoz",
    "message": "win, build: generate .sln only when necessary\n\nWhen generating sln, store flags passed to configure. Next time, if\nnode.sln exists and configure flags match those stored, skip building\n.sln files.\n\nAdds projgen vcbuild option to force .sln regeneration.\n\nPR-URL: https://github.com/nodejs/node/pull/21284\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "4dece043ba45173e2a0ae7e809c6853e9cf1101e",
    "files": [
        {
            "sha": "af5c1a28e5f75e26a1f3d5b56d3087412c1c52d0",
            "filename": "vcbuild.bat",
            "status": "modified",
            "additions": 30,
            "deletions": 3,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/4dece043ba45173e2a0ae7e809c6853e9cf1101e/vcbuild.bat",
            "raw_url": "https://github.com/nodejs/node/raw/4dece043ba45173e2a0ae7e809c6853e9cf1101e/vcbuild.bat",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/vcbuild.bat?ref=4dece043ba45173e2a0ae7e809c6853e9cf1101e",
            "patch": "@@ -17,6 +17,7 @@ set target=Build\n set target_arch=x64\n set target_env=\n set noprojgen=\n+set projgen=\n set nobuild=\n set sign=\n set nosnapshot=\n@@ -67,6 +68,7 @@ if /i \"%1\"==\"x86\"           set target_arch=x86&goto arg-ok\n if /i \"%1\"==\"x64\"           set target_arch=x64&goto arg-ok\n if /i \"%1\"==\"vs2017\"        set target_env=vs2017&goto arg-ok\n if /i \"%1\"==\"noprojgen\"     set noprojgen=1&goto arg-ok\n+if /i \"%1\"==\"projgen\"       set projgen=1&goto arg-ok\n if /i \"%1\"==\"nobuild\"       set nobuild=1&goto arg-ok\n if /i \"%1\"==\"nosign\"        set \"sign=\"&echo Note: vcbuild no longer signs by default. \"nosign\" is redundant.&goto arg-ok\n if /i \"%1\"==\"sign\"          set sign=1&goto arg-ok\n@@ -147,6 +149,7 @@ if defined build_release (\n   set licensertf=1\n   set download_arg=\"--download=all\"\n   set i18n_arg=small-icu\n+  set projgen=1\n )\n \n :: assign path to node_exe\n@@ -252,16 +255,36 @@ goto build-doc\n \n :msbuild-found\n \n+set project_generated=\n :project-gen\n @rem Skip project generation if requested.\n if defined noprojgen goto msbuild\n-\n+if defined projgen goto run-configure\n+if not exist node.sln goto run-configure\n+if not exist .gyp_configure_stamp goto run-configure\n+echo %configure_flags% > .tmp_gyp_configure_stamp\n+where /R . /T *.gyp? >> .tmp_gyp_configure_stamp\n+fc .gyp_configure_stamp .tmp_gyp_configure_stamp >NUL 2>&1\n+if errorlevel 1 goto run-configure\n+\n+:skip-configure\n+del .tmp_gyp_configure_stamp\n+echo Reusing solution generated with %configure_flags%\n+goto msbuild\n+\n+:run-configure\n+del .tmp_gyp_configure_stamp\n+del .gyp_configure_stamp\n @rem Generate the VS project.\n echo configure %configure_flags%\n+echo %configure_flags%> .used_configure_flags\n python configure %configure_flags%\n if errorlevel 1 goto create-msvs-files-failed\n if not exist node.sln goto create-msvs-files-failed\n+set project_generated=1\n echo Project files generated.\n+echo %configure_flags% > .gyp_configure_stamp\n+where /R . /T *.gyp? >> .gyp_configure_stamp\n \n :msbuild\n @rem Skip build if requested.\n@@ -274,7 +297,10 @@ set \"msbplatform=Win32\"\n if \"%target_arch%\"==\"x64\" set \"msbplatform=x64\"\n if \"%target%\"==\"Build\" if defined no_cctest set target=node\n msbuild node.sln %msbcpu% /t:%target% /p:Configuration=%config% /p:Platform=%msbplatform% /clp:NoSummary;NoItemAndPropertyList;Verbosity=minimal /nologo\n-if errorlevel 1 goto exit\n+if errorlevel 1 (\n+  if not defined project_generated echo Building Node with reused solution failed. To regenerate project files use \"vcbuild projgen\"\n+  goto exit\n+)\n if \"%target%\" == \"Clean\" goto exit\n \n :sign\n@@ -626,10 +652,11 @@ goto exit\n \n :create-msvs-files-failed\n echo Failed to create vc project files.\n+del .used_configure_flags\n goto exit\n \n :help\n-echo vcbuild.bat [debug/release] [msi] [doc] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci/lint-md] [lint-md-build] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n+echo vcbuild.bat [debug/release] [msi] [doc] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [projgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci/lint-md] [lint-md-build] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n echo Examples:\n echo   vcbuild.bat                          : builds release build\n echo   vcbuild.bat debug                    : builds debug build"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 30,
        "deletions": 3
    }
}