{
    "author": "BridgeAR",
    "message": "assert: improve loose assertion message\n\nSo far the error message from a loose assertion is not always very\ninformative and could be misleading. This is fixed by:\n\n* showing more from the actual error message\n* having a better error description\n* not using custom inspection\n* inspecting a higher depth\n* inspecting the full array instead of up to 100 entries\n\nPR-URL: https://github.com/nodejs/node/pull/22155\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "1d859ef53224c982aee659d0e17b1e5747b19fa0",
    "files": [
        {
            "sha": "d151efe3df86ced652ecfa091a2f7b239bab8309",
            "filename": "lib/internal/assert.js",
            "status": "modified",
            "additions": 34,
            "deletions": 13,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/1d859ef53224c982aee659d0e17b1e5747b19fa0/lib%2Finternal%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d859ef53224c982aee659d0e17b1e5747b19fa0/lib%2Finternal%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fassert.js?ref=1d859ef53224c982aee659d0e17b1e5747b19fa0",
            "patch": "@@ -12,9 +12,13 @@ let white = '';\n \n const kReadableOperator = {\n   deepStrictEqual: 'Expected inputs to be strictly deep-equal:',\n-  notDeepStrictEqual: 'Expected \"actual\" not to be strictly deep-equal to:',\n   strictEqual: 'Expected inputs to be strictly equal:',\n+  deepEqual: 'Expected inputs to be loosely deep-equal:',\n+  equal: 'Expected inputs to be loosely equal:',\n+  notDeepStrictEqual: 'Expected \"actual\" not to be strictly deep-equal to:',\n   notStrictEqual: 'Expected \"actual\" to be strictly unequal to:',\n+  notDeepEqual: 'Expected \"actual\" not to be loosely deep-equal to:',\n+  notEqual: 'Expected \"actual\" to be loosely unequal to:',\n   notIdentical: 'Inputs identical but not reference equal:',\n };\n \n@@ -50,7 +54,7 @@ function inspectValue(val) {\n       // Assert does not detect proxies currently.\n       showProxy: false\n     }\n-  ).split('\\n');\n+  );\n }\n \n function createErrDiff(actual, expected, operator) {\n@@ -59,8 +63,9 @@ function createErrDiff(actual, expected, operator) {\n   let lastPos = 0;\n   let end = '';\n   let skipped = false;\n-  const actualLines = inspectValue(actual);\n-  const expectedLines = inspectValue(expected);\n+  const actualInspected = inspectValue(actual);\n+  const actualLines = actualInspected.split('\\n');\n+  const expectedLines = inspectValue(expected).split('\\n');\n   const msg = kReadableOperator[operator] +\n         `\\n${green}+ actual${white} ${red}- expected${white}`;\n   const skippedMsg = ` ${blue}...${white} Lines skipped`;\n@@ -126,7 +131,7 @@ function createErrDiff(actual, expected, operator) {\n   // E.g., assert.deepStrictEqual({ a: Symbol() }, { a: Symbol() })\n   if (maxLines === 0) {\n     // We have to get the result again. The lines were all removed before.\n-    const actualLines = inspectValue(actual);\n+    const actualLines = actualInspected.split('\\n');\n \n     // Only remove lines in case it makes sense to collapse those.\n     // TODO: Accept env to always show the full error.\n@@ -268,7 +273,7 @@ class AssertionError extends Error {\n         operator === 'notStrictEqual') {\n         // In case the objects are equal but the operator requires unequal, show\n         // the first object and say A equals B\n-        const res = inspectValue(actual);\n+        const res = inspectValue(actual).split('\\n');\n         const base = kReadableOperator[operator];\n \n         // Only remove lines in case it makes sense to collapse those.\n@@ -287,13 +292,29 @@ class AssertionError extends Error {\n           super(`${base}\\n\\n${res.join('\\n')}\\n`);\n         }\n       } else {\n-        let res = inspect(actual);\n-        let other = inspect(expected);\n-        if (res.length > 128)\n-          res = `${res.slice(0, 125)}...`;\n-        if (other.length > 128)\n-          other = `${other.slice(0, 125)}...`;\n-        super(`${res} ${operator} ${other}`);\n+        let res = inspectValue(actual);\n+        let other = '';\n+        const knownOperators = kReadableOperator[operator];\n+        if (operator === 'notDeepEqual' || operator === 'notEqual') {\n+          res = `${kReadableOperator[operator]}\\n\\n${res}`;\n+          if (res.length > 1024) {\n+            res = `${res.slice(0, 1021)}...`;\n+          }\n+        } else {\n+          other = `${inspectValue(expected)}`;\n+          if (res.length > 512) {\n+            res = `${res.slice(0, 509)}...`;\n+          }\n+          if (other.length > 512) {\n+            other = `${other.slice(0, 509)}...`;\n+          }\n+          if (operator === 'deepEqual' || operator === 'equal') {\n+            res = `${knownOperators}\\n\\n${res}\\n\\nshould equal\\n\\n`;\n+          } else {\n+            other = ` ${operator} ${other}`;\n+          }\n+        }\n+        super(`${res}${other}`);\n       }\n     }\n "
        },
        {
            "sha": "2cc158ec9bccbe54a4c27d1ed37c4fd035b29841",
            "filename": "test/parallel/test-assert-deep.js",
            "status": "modified",
            "additions": 54,
            "deletions": 97,
            "changes": 151,
            "blob_url": "https://github.com/nodejs/node/blob/1d859ef53224c982aee659d0e17b1e5747b19fa0/test%2Fparallel%2Ftest-assert-deep.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d859ef53224c982aee659d0e17b1e5747b19fa0/test%2Fparallel%2Ftest-assert-deep.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-deep.js?ref=1d859ef53224c982aee659d0e17b1e5747b19fa0",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n \n-const common = require('../common');\n+require('../common');\n const assert = require('assert');\n const util = require('util');\n const { AssertionError } = assert;\n@@ -16,18 +16,23 @@ if (process.stdout.isTTY)\n // Template tag function turning an error message into a RegExp\n // for assert.throws()\n function re(literals, ...values) {\n-  let result = literals[0];\n-  const escapeRE = /[\\\\^$.*+?()[\\]{}|=!<>:-]/g;\n+  let result = 'Expected inputs to be loosely deep-equal:\\n\\n';\n   for (const [i, value] of values.entries()) {\n-    const str = util.inspect(value);\n+    const str = util.inspect(value, {\n+      compact: false,\n+      depth: 1000,\n+      customInspect: false,\n+      maxArrayLength: Infinity,\n+      breakLength: Infinity\n+    });\n     // Need to escape special characters.\n-    result += str.replace(escapeRE, '\\\\$&');\n+    result += str;\n     result += literals[i + 1];\n   }\n-  return common.expectsError({\n+  return {\n     code: 'ERR_ASSERTION',\n-    message: new RegExp(`^${result}$`)\n-  });\n+    message: result\n+  };\n }\n \n // The following deepEqual tests might seem very weird.\n@@ -173,13 +178,6 @@ assert.throws(\n   }\n }\n \n-common.expectsError(() => {\n-  assert.deepEqual(new Set([{ a: 0 }]), new Set([{ a: 1 }]));\n-}, {\n-  code: 'ERR_ASSERTION',\n-  message: /^Set { { a: 0 } } deepEqual Set { { a: 1 } }$/\n-});\n-\n function assertDeepAndStrictEqual(a, b) {\n   assert.deepEqual(a, b);\n   assert.deepStrictEqual(a, b);\n@@ -189,13 +187,19 @@ function assertDeepAndStrictEqual(a, b) {\n }\n \n function assertNotDeepOrStrict(a, b, err) {\n-  assert.throws(() => assert.deepEqual(a, b), err || re`${a} deepEqual ${b}`);\n+  assert.throws(\n+    () => assert.deepEqual(a, b),\n+    err || re`${a}\\n\\nshould equal\\n\\n${b}`\n+  );\n   assert.throws(\n     () => assert.deepStrictEqual(a, b),\n     err || { code: 'ERR_ASSERTION' }\n   );\n \n-  assert.throws(() => assert.deepEqual(b, a), err || re`${b} deepEqual ${a}`);\n+  assert.throws(\n+    () => assert.deepEqual(b, a),\n+    err || re`${b}\\n\\nshould equal\\n\\n${a}`\n+  );\n   assert.throws(\n     () => assert.deepStrictEqual(b, a),\n     err || { code: 'ERR_ASSERTION' }\n@@ -225,6 +229,7 @@ assertNotDeepOrStrict(new Set([1, 2, 3]), new Set([1, 2, 3, 4]));\n assertNotDeepOrStrict(new Set([1, 2, 3, 4]), new Set([1, 2, 3]));\n assertDeepAndStrictEqual(new Set(['1', '2', '3']), new Set(['1', '2', '3']));\n assertDeepAndStrictEqual(new Set([[1, 2], [3, 4]]), new Set([[3, 4], [1, 2]]));\n+assertNotDeepOrStrict(new Set([{ a: 0 }]), new Set([{ a: 1 }]));\n \n {\n   const a = [ 1, 2 ];\n@@ -626,41 +631,16 @@ assert.throws(\n \n assert.notDeepEqual(new Date(), new Date(2000, 3, 14));\n \n-assert.deepEqual(/a/, /a/);\n-assert.deepEqual(/a/g, /a/g);\n-assert.deepEqual(/a/i, /a/i);\n-assert.deepEqual(/a/m, /a/m);\n-assert.deepEqual(/a/igm, /a/igm);\n-assert.throws(() => assert.deepEqual(/ab/, /a/),\n-              {\n-                code: 'ERR_ASSERTION',\n-                name: 'AssertionError [ERR_ASSERTION]',\n-                message: '/ab/ deepEqual /a/'\n-              });\n-assert.throws(() => assert.deepEqual(/a/g, /a/),\n-              {\n-                code: 'ERR_ASSERTION',\n-                name: 'AssertionError [ERR_ASSERTION]',\n-                message: '/a/g deepEqual /a/'\n-              });\n-assert.throws(() => assert.deepEqual(/a/i, /a/),\n-              {\n-                code: 'ERR_ASSERTION',\n-                name: 'AssertionError [ERR_ASSERTION]',\n-                message: '/a/i deepEqual /a/'\n-              });\n-assert.throws(() => assert.deepEqual(/a/m, /a/),\n-              {\n-                code: 'ERR_ASSERTION',\n-                name: 'AssertionError [ERR_ASSERTION]',\n-                message: '/a/m deepEqual /a/'\n-              });\n-assert.throws(() => assert.deepEqual(/a/igm, /a/im),\n-              {\n-                code: 'ERR_ASSERTION',\n-                name: 'AssertionError [ERR_ASSERTION]',\n-                message: '/a/gim deepEqual /a/im'\n-              });\n+assertDeepAndStrictEqual(/a/, /a/);\n+assertDeepAndStrictEqual(/a/g, /a/g);\n+assertDeepAndStrictEqual(/a/i, /a/i);\n+assertDeepAndStrictEqual(/a/m, /a/m);\n+assertDeepAndStrictEqual(/a/igm, /a/igm);\n+assertNotDeepOrStrict(/ab/, /a/);\n+assertNotDeepOrStrict(/a/g, /a/);\n+assertNotDeepOrStrict(/a/i, /a/);\n+assertNotDeepOrStrict(/a/m, /a/);\n+assertNotDeepOrStrict(/a/igm, /a/im);\n \n {\n   const re1 = /a/g;\n@@ -720,23 +700,32 @@ nameBuilder2.prototype = Object;\n nb2 = new nameBuilder2('Ryan', 'Dahl');\n assert.deepEqual(nb1, nb2);\n \n-// Primitives and object.\n-assert.throws(() => assert.deepEqual(null, {}), AssertionError);\n-assert.throws(() => assert.deepEqual(undefined, {}), AssertionError);\n-assert.throws(() => assert.deepEqual('a', ['a']), AssertionError);\n-assert.throws(() => assert.deepEqual('a', { 0: 'a' }), AssertionError);\n-assert.throws(() => assert.deepEqual(1, {}), AssertionError);\n-assert.throws(() => assert.deepEqual(true, {}), AssertionError);\n-assert.throws(() => assert.deepEqual(Symbol(), {}), AssertionError);\n+// Primitives\n+assertNotDeepOrStrict(null, {});\n+assertNotDeepOrStrict(undefined, {});\n+assertNotDeepOrStrict('a', ['a']);\n+assertNotDeepOrStrict('a', { 0: 'a' });\n+assertNotDeepOrStrict(1, {});\n+assertNotDeepOrStrict(true, {});\n+assertNotDeepOrStrict(Symbol(), {});\n+assertNotDeepOrStrict(Symbol(), Symbol());\n+\n+assertOnlyDeepEqual(4, '4');\n+assertOnlyDeepEqual(true, 1);\n+\n+{\n+  const s = Symbol();\n+  assertDeepAndStrictEqual(s, s);\n+}\n \n // Primitive wrappers and object.\n-assert.deepEqual(new String('a'), ['a']);\n-assert.deepEqual(new String('a'), { 0: 'a' });\n-assert.deepEqual(new Number(1), {});\n-assert.deepEqual(new Boolean(true), {});\n+assertOnlyDeepEqual(new String('a'), ['a']);\n+assertOnlyDeepEqual(new String('a'), { 0: 'a' });\n+assertOnlyDeepEqual(new Number(1), {});\n+assertOnlyDeepEqual(new Boolean(true), {});\n \n // Same number of keys but different key names.\n-assert.throws(() => assert.deepEqual({ a: 1 }, { b: 1 }), AssertionError);\n+assertNotDeepOrStrict({ a: 1 }, { b: 1 });\n \n assert.deepStrictEqual(new Date(2000, 3, 14), new Date(2000, 3, 14));\n \n@@ -757,11 +746,6 @@ assert.throws(\n \n assert.notDeepStrictEqual(new Date(), new Date(2000, 3, 14));\n \n-assert.deepStrictEqual(/a/, /a/);\n-assert.deepStrictEqual(/a/g, /a/g);\n-assert.deepStrictEqual(/a/i, /a/i);\n-assert.deepStrictEqual(/a/m, /a/m);\n-assert.deepStrictEqual(/a/igm, /a/igm);\n assert.throws(\n   () => assert.deepStrictEqual(/ab/, /a/),\n   {\n@@ -871,33 +855,6 @@ obj2 = new Constructor2('Ryan', 'Dahl');\n \n assert.deepStrictEqual(obj1, obj2);\n \n-// primitives\n-assert.throws(() => assert.deepStrictEqual(4, '4'), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(true, 1), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(Symbol(), Symbol()),\n-              AssertionError);\n-\n-const s = Symbol();\n-assert.deepStrictEqual(s, s);\n-\n-// Primitives and object.\n-assert.throws(() => assert.deepStrictEqual(null, {}), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(undefined, {}), AssertionError);\n-assert.throws(() => assert.deepStrictEqual('a', ['a']), AssertionError);\n-assert.throws(() => assert.deepStrictEqual('a', { 0: 'a' }), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(1, {}), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(true, {}), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(Symbol(), {}), AssertionError);\n-\n-// Primitive wrappers and object.\n-assert.throws(() => assert.deepStrictEqual(new String('a'), ['a']),\n-              AssertionError);\n-assert.throws(() => assert.deepStrictEqual(new String('a'), { 0: 'a' }),\n-              AssertionError);\n-assert.throws(() => assert.deepStrictEqual(new Number(1), {}), AssertionError);\n-assert.throws(() => assert.deepStrictEqual(new Boolean(true), {}),\n-              AssertionError);\n-\n // Check extra properties on errors.\n {\n   const a = new TypeError('foo');"
        }
    ],
    "stats": {
        "total": 198,
        "additions": 88,
        "deletions": 110
    }
}