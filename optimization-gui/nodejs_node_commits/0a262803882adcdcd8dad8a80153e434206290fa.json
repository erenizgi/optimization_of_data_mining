{
    "author": "Fishrock123",
    "message": "test: really test the ttywrap bits of getasyncid\n\nFollow-up from https://github.com/nodejs/node/pull/18800\n\nCode that tries to exercise tty fds must be placed in `/pseudo-tty/`.\n\nPR-URL: https://github.com/nodejs/node/pull/18886\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "0a262803882adcdcd8dad8a80153e434206290fa",
    "files": [
        {
            "sha": "d931a7fdb060cb67292d72f6169925329fa98db4",
            "filename": "test/pseudo-tty/test-async-wrap-getasyncid-tty.js",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.js",
            "raw_url": "https://github.com/nodejs/node/raw/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.js?ref=0a262803882adcdcd8dad8a80153e434206290fa",
            "patch": "@@ -0,0 +1,43 @@\n+'use strict';\n+\n+// see also test/sequential/test-async-wrap-getasyncid.js\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const tty_wrap = process.binding('tty_wrap');\n+const { TTYWRAP } = process.binding('async_wrap').Providers;\n+const providers = { TTYWRAP };\n+\n+// Make sure that the TTYWRAP Provider is tested.\n+{\n+  const hooks = require('async_hooks').createHook({\n+    init(id, type) {\n+      if (type === 'NONE')\n+        throw new Error('received a provider type of NONE');\n+      delete providers[type];\n+    },\n+  }).enable();\n+  process.on('beforeExit', common.mustCall(() => {\n+    process.removeAllListeners('uncaughtException');\n+    hooks.disable();\n+\n+    const objKeys = Object.keys(providers);\n+    if (objKeys.length > 0)\n+      process._rawDebug(objKeys);\n+    assert.strictEqual(objKeys.length, 0);\n+  }));\n+}\n+\n+function testInitialized(req, ctor_name) {\n+  assert.strictEqual(typeof req.getAsyncId, 'function');\n+  assert(Number.isSafeInteger(req.getAsyncId()));\n+  assert(req.getAsyncId() > 0);\n+  assert.strictEqual(req.constructor.name, ctor_name);\n+}\n+\n+{\n+  const ttyFd = common.getTTYfd();\n+\n+  const handle = new tty_wrap.TTY(ttyFd, false);\n+  testInitialized(handle, 'TTY');\n+}"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-async-wrap-getasyncid-tty.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.out",
            "raw_url": "https://github.com/nodejs/node/raw/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-async-wrap-getasyncid-tty.out?ref=0a262803882adcdcd8dad8a80153e434206290fa"
        },
        {
            "sha": "bb0ad3d0ef4bd3e08adddef3d46dfd654efc3834",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 8,
            "deletions": 42,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/0a262803882adcdcd8dad8a80153e434206290fa/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=0a262803882adcdcd8dad8a80153e434206290fa",
            "patch": "@@ -26,16 +26,20 @@ common.crashOnUnhandledRejection();\n     hooks.disable();\n     delete providers.NONE;  // Should never be used.\n \n+    // See test/pseudo-tty/test-async-wrap-getasyncid-tty.js\n+    // Requires an 'actual' tty fd to be available.\n+    delete providers.TTYWRAP;\n+\n     // TODO(jasnell): Test for these\n     delete providers.HTTP2SESSION;\n     delete providers.HTTP2STREAM;\n     delete providers.HTTP2PING;\n     delete providers.HTTP2SETTINGS;\n \n-    const obj_keys = Object.keys(providers);\n-    if (obj_keys.length > 0)\n-      process._rawDebug(obj_keys);\n-    assert.strictEqual(obj_keys.length, 0);\n+    const objKeys = Object.keys(providers);\n+    if (objKeys.length > 0)\n+      process._rawDebug(objKeys);\n+    assert.strictEqual(objKeys.length, 0);\n   }));\n }\n \n@@ -256,44 +260,6 @@ if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n     tls_wrap.wrap(tcp._externalStream, credentials.context, true), 'TLSWrap');\n }\n \n-\n-{\n-  // Do our best to grab a tty fd.\n-  function getTTYfd() {\n-    const tty = require('tty');\n-    let ttyFd = [0, 1, 2].find(tty.isatty);\n-    if (ttyFd === undefined) {\n-      try {\n-        ttyFd = fs.openSync('/dev/tty');\n-      } catch (e) {\n-        // There aren't any tty fd's available to use.\n-        return -1;\n-      }\n-    }\n-    return ttyFd;\n-  }\n-\n-  const ttyFd = getTTYfd();\n-  if (ttyFd >= 0) {\n-    const tty_wrap = process.binding('tty_wrap');\n-    // fd may still be invalid, so guard against it.\n-    const handle = (() => {\n-      try {\n-        return new tty_wrap.TTY(ttyFd, false);\n-      } catch (e) {\n-        return null;\n-      }\n-    })();\n-    if (handle !== null)\n-      testInitialized(handle, 'TTY');\n-    else\n-      delete providers.TTYWRAP;\n-  } else {\n-    delete providers.TTYWRAP;\n-  }\n-}\n-\n-\n {\n   const binding = process.binding('udp_wrap');\n   const handle = new binding.UDP();"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 51,
        "deletions": 42
    }
}