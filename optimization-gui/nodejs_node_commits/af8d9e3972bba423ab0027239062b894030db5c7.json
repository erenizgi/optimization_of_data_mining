{
    "author": "indutny",
    "message": "http: fix header limit errors and test for llhttp\n\nRef: https://github.com/nodejs-private/node-private/pull/143\nPR-URL: https://github.com/nodejs-private/node-private/pull/149\nReviewed-By: Rod Vagg <rod@vagg.org>",
    "sha": "af8d9e3972bba423ab0027239062b894030db5c7",
    "files": [
        {
            "sha": "e24f378e3f24e017dbee0449dd3203a01302b488",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 11,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/af8d9e3972bba423ab0027239062b894030db5c7/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/af8d9e3972bba423ab0027239062b894030db5c7/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=af8d9e3972bba423ab0027239062b894030db5c7",
            "patch": "@@ -30,7 +30,7 @@\n #include \"v8.h\"\n \n #include <stdlib.h>  // free()\n-#include <string.h>  // strdup()\n+#include <string.h>  // strdup(), strchr()\n \n #include \"http_parser_adaptor.h\"\n \n@@ -367,7 +367,7 @@ class Parser : public AsyncWrap, public StreamListener {\n     if (r.IsEmpty()) {\n       got_exception_ = true;\n #ifdef NODE_EXPERIMENTAL_HTTP\n-      llhttp_set_error_reason(&parser_, \"JS Exception\");\n+      llhttp_set_error_reason(&parser_, \"HPE_JS_EXCEPTION:JS Exception\");\n #endif  /* NODE_EXPERIMENTAL_HTTP */\n       return HPE_USER;\n     }\n@@ -395,7 +395,7 @@ class Parser : public AsyncWrap, public StreamListener {\n \n     if (r.IsEmpty()) {\n       got_exception_ = true;\n-      return HPE_USER;\n+      return -1;\n     }\n \n     return 0;\n@@ -712,13 +712,23 @@ class Parser : public AsyncWrap, public StreamListener {\n                env()->bytes_parsed_string(),\n                nread_obj).FromJust();\n #ifdef NODE_EXPERIMENTAL_HTTP\n-      obj->Set(env()->context(),\n-               env()->code_string(),\n-               OneByteString(env()->isolate(),\n-                             llhttp_errno_name(err))).FromJust();\n-      obj->Set(env()->context(),\n-               env()->reason_string(),\n-               OneByteString(env()->isolate(), parser_.reason)).FromJust();\n+      const char* errno_reason = llhttp_get_error_reason(&parser_);\n+\n+      Local<String> code;\n+      Local<String> reason;\n+      if (err == HPE_USER) {\n+        const char* colon = strchr(errno_reason, ':');\n+        CHECK_NE(colon, nullptr);\n+        code = OneByteString(env()->isolate(), errno_reason,\n+                             colon - errno_reason);\n+        reason = OneByteString(env()->isolate(), colon + 1);\n+      } else {\n+        code = OneByteString(env()->isolate(), llhttp_errno_name(err));\n+        reason = OneByteString(env()->isolate(), errno_reason);\n+      }\n+\n+      obj->Set(env()->context(), env()->code_string(), code).FromJust();\n+      obj->Set(env()->context(), env()->reason_string(), reason).FromJust();\n #else  /* !NODE_EXPERIMENTAL_HTTP */\n       obj->Set(env()->context(),\n                env()->code_string(),\n@@ -790,7 +800,7 @@ class Parser : public AsyncWrap, public StreamListener {\n #ifdef NODE_EXPERIMENTAL_HTTP\n     header_nread_ += len;\n     if (header_nread_ >= kMaxHeaderSize) {\n-      llhttp_set_error_reason(&parser_, \"Headers overflow\");\n+      llhttp_set_error_reason(&parser_, \"HPE_HEADER_OVERFLOW:Header overflow\");\n       return HPE_USER;\n     }\n #endif  /* NODE_EXPERIMENTAL_HTTP */"
        },
        {
            "sha": "5ca27a0d17fc79ed737189d2505535ccaade1f10",
            "filename": "test/sequential/test-http-max-http-headers.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/af8d9e3972bba423ab0027239062b894030db5c7/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/af8d9e3972bba423ab0027239062b894030db5c7/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-max-http-headers.js?ref=af8d9e3972bba423ab0027239062b894030db5c7",
            "patch": "@@ -25,6 +25,15 @@ function finished(client, callback) {\n }\n \n function fillHeaders(headers, currentSize, valid = false) {\n+  // llhttp counts actual header name/value sizes, excluding the whitespace and\n+  // stripped chars.\n+  if (process.versions.hasOwnProperty('llhttp')) {\n+    // OK, Content-Length, 0, X-CRASH, aaa...\n+    headers += 'a'.repeat(MAX - currentSize);\n+  } else {\n+    headers += 'a'.repeat(MAX - headers.length - 3);\n+  }\n+\n   // Generate valid headers\n   if (valid) {\n     // TODO(mcollina): understand why -9 is needed instead of -1"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 30,
        "deletions": 11
    }
}