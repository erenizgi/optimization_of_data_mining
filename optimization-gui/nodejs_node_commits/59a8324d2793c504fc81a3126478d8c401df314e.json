{
    "author": "addaleax",
    "message": "src: refactor win32 `DebugProcess()` to use RAII cleanup\n\nPrefer more idiomatic C++ cleanup code over `goto`.\n\nPR-URL: https://github.com/nodejs/node/pull/22981\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Bartosz Sosnowski <bartosz@janeasystems.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>",
    "sha": "59a8324d2793c504fc81a3126478d8c401df314e",
    "files": [
        {
            "sha": "ca22288ca06839aa769969cf4424e79fb04cf77a",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 21,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/59a8324d2793c504fc81a3126478d8c401df314e/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/59a8324d2793c504fc81a3126478d8c401df314e/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=59a8324d2793c504fc81a3126478d8c401df314e",
            "patch": "@@ -2266,17 +2266,29 @@ static int GetDebugSignalHandlerMappingName(DWORD pid, wchar_t* buf,\n static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Isolate* isolate = args.GetIsolate();\n+\n+  if (args.Length() != 1) {\n+    env->ThrowError(\"Invalid number of arguments.\");\n+    return;\n+  }\n+\n   HANDLE process = nullptr;\n   HANDLE thread = nullptr;\n   HANDLE mapping = nullptr;\n   wchar_t mapping_name[32];\n   LPTHREAD_START_ROUTINE* handler = nullptr;\n   DWORD pid = 0;\n \n-  if (args.Length() != 1) {\n-    env->ThrowError(\"Invalid number of arguments.\");\n-    goto out;\n-  }\n+  OnScopeLeave cleanup([&]() {\n+    if (process != nullptr)\n+      CloseHandle(process);\n+    if (thread != nullptr)\n+      CloseHandle(thread);\n+    if (handler != nullptr)\n+      UnmapViewOfFile(handler);\n+    if (mapping != nullptr)\n+      CloseHandle(mapping);\n+  });\n \n   CHECK(args[0]->IsNumber());\n   pid = args[0].As<Integer>()->Value();\n@@ -2289,22 +2301,22 @@ static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n   if (process == nullptr) {\n     isolate->ThrowException(\n         WinapiErrnoException(isolate, GetLastError(), \"OpenProcess\"));\n-    goto out;\n+    return;\n   }\n \n   if (GetDebugSignalHandlerMappingName(pid,\n                                        mapping_name,\n                                        arraysize(mapping_name)) < 0) {\n     env->ThrowErrnoException(errno, \"sprintf\");\n-    goto out;\n+    return;\n   }\n \n   mapping = OpenFileMappingW(FILE_MAP_READ, FALSE, mapping_name);\n   if (mapping == nullptr) {\n     isolate->ThrowException(WinapiErrnoException(isolate,\n                                              GetLastError(),\n                                              \"OpenFileMappingW\"));\n-    goto out;\n+    return;\n   }\n \n   handler = reinterpret_cast<LPTHREAD_START_ROUTINE*>(\n@@ -2316,7 +2328,7 @@ static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n   if (handler == nullptr || *handler == nullptr) {\n     isolate->ThrowException(\n         WinapiErrnoException(isolate, GetLastError(), \"MapViewOfFile\"));\n-    goto out;\n+    return;\n   }\n \n   thread = CreateRemoteThread(process,\n@@ -2330,26 +2342,16 @@ static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n     isolate->ThrowException(WinapiErrnoException(isolate,\n                                                  GetLastError(),\n                                                  \"CreateRemoteThread\"));\n-    goto out;\n+    return;\n   }\n \n   // Wait for the thread to terminate\n   if (WaitForSingleObject(thread, INFINITE) != WAIT_OBJECT_0) {\n     isolate->ThrowException(WinapiErrnoException(isolate,\n                                                  GetLastError(),\n                                                  \"WaitForSingleObject\"));\n-    goto out;\n-  }\n-\n- out:\n-  if (process != nullptr)\n-    CloseHandle(process);\n-  if (thread != nullptr)\n-    CloseHandle(thread);\n-  if (handler != nullptr)\n-    UnmapViewOfFile(handler);\n-  if (mapping != nullptr)\n-    CloseHandle(mapping);\n+    return;\n+  }\n }\n #endif  // _WIN32\n "
        }
    ],
    "stats": {
        "total": 44,
        "additions": 23,
        "deletions": 21
    }
}