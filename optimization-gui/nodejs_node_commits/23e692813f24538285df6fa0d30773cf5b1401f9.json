{
    "author": "danbev",
    "message": "test: skip test that use --tls-v1.x flags\n\nCurrently, configuring --without-ssl will cause the following test to\nfail:\n\n=== release test-https-agent-additional-options ===\nPath: parallel/test-https-agent-additional-options\nout/Release/node: bad option: --tls-v1.1\nCommand: out/Release/node --tls-v1.1\n  /node/test/parallel/test-https-agent-additional-options.js\n\n=== release test-https-agent-session-eviction ===\nPath: parallel/test-https-agent-session-eviction\nout/Release/node: bad option: --tls-v1.0\n\nCommand: out/Release/node --tls-v1.0\n  /node/test/parallel/test-https-agent-session-eviction.js\n\nThis commit adds a check for the --tls-v.x flags and skips them if node\nwas built without crypto support.\n\nPR-URL: https://github.com/nodejs/node/pull/24376\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>",
    "sha": "23e692813f24538285df6fa0d30773cf5b1401f9",
    "files": [
        {
            "sha": "7ba9674d7d6e576cbe55b2cd4f7efc94c4b062f9",
            "filename": "test/testpy/__init__.py",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/23e692813f24538285df6fa0d30773cf5b1401f9/test%2Ftestpy%2F__init__.py",
            "raw_url": "https://github.com/nodejs/node/raw/23e692813f24538285df6fa0d30773cf5b1401f9/test%2Ftestpy%2F__init__.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ftestpy%2F__init__.py?ref=23e692813f24538285df6fa0d30773cf5b1401f9",
            "patch": "@@ -61,7 +61,7 @@ def GetCommand(self):\n     source = open(self.file).read()\n     flags_match = FLAGS_PATTERN.search(source)\n     if flags_match:\n-      flag = flags_match.group(1).strip().split()\n+      flags = flags_match.group(1).strip().split()\n       # The following block reads config.gypi to extract the v8_enable_inspector\n       # value. This is done to check if the inspector is disabled in which case\n       # the '--inspect' flag cannot be passed to the node process as it will\n@@ -71,13 +71,17 @@ def GetCommand(self):\n       # inspector related tests). Also, if there is no ssl support the options\n       # '--use-bundled-ca' and '--use-openssl-ca' will also cause a similar\n       # failure so such tests are also skipped.\n-      if ('--inspect' in flag[0] or \\\n-          '--use-bundled-ca' in flag[0] or \\\n-          '--use-openssl-ca' in flag[0]) and \\\n-          self.context.v8_enable_inspector == 0:\n-        print('Skipping as node was configured --without-ssl')\n+      if (any(flag.startswith('--inspect') for flag in flags) and\n+          not self.context.v8_enable_inspector):\n+        print('Skipping as node was compiled without inspector support')\n+      elif (('--use-bundled-ca' in flags or\n+          '--use-openssl-ca' in flags or\n+          '--tls-v1.0' in flags or\n+          '--tls-v1.1' in flags) and\n+          not self.context.node_has_crypto):\n+        print('Skipping as node was compiled without crypto support')\n       else:\n-        result += flag\n+        result += flags\n     files_match = FILES_PATTERN.search(source);\n     additional_files = []\n     if files_match:"
        },
        {
            "sha": "67b8cb917e0db6ee24ceb0df7ed505b2e9af50d0",
            "filename": "tools/test.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/23e692813f24538285df6fa0d30773cf5b1401f9/tools%2Ftest.py",
            "raw_url": "https://github.com/nodejs/node/raw/23e692813f24538285df6fa0d30773cf5b1401f9/tools%2Ftest.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Ftest.py?ref=23e692813f24538285df6fa0d30773cf5b1401f9",
            "patch": "@@ -907,6 +907,7 @@ def __init__(self, workspace, buildspace, verbose, vm, args, expect_fail,\n     self.repeat = repeat\n     self.abort_on_timeout = abort_on_timeout\n     self.v8_enable_inspector = True\n+    self.node_has_crypto = True\n \n   def GetVm(self, arch, mode):\n     if arch == 'none':\n@@ -1632,9 +1633,14 @@ def Main():\n \n   # We want to skip the inspector tests if node was built without the inspector.\n   has_inspector = Execute([vm,\n-      \"-p\", \"process.config.variables.v8_enable_inspector\"], context)\n-  if has_inspector.stdout.rstrip() == \"0\":\n-      context.v8_enable_inspector = False\n+      '-p', 'process.config.variables.v8_enable_inspector'], context)\n+  if has_inspector.stdout.rstrip() == '0':\n+    context.v8_enable_inspector = False\n+\n+  has_crypto = Execute([vm,\n+      '-p', 'process.versions.openssl'], context)\n+  if has_crypto.stdout.rstrip() == 'undefined':\n+    context.node_has_crypto = False\n \n   if options.cat:\n     visited = set()"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 20,
        "deletions": 10
    }
}