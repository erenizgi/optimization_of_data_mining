{
    "author": "ronag",
    "message": "http: added aborted property to request\n\nPR-URL: https://github.com/nodejs/node/pull/20094\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "d5e363b77ebaf1caf67cd7528224b651c86815c1",
    "files": [
        {
            "sha": "d3e495ea3df5a3c42a68c87fdf404660c41b7ec6",
            "filename": "doc/api/http.md",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/doc%2Fapi%2Fhttp.md",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/doc%2Fapi%2Fhttp.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp.md?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -1483,7 +1483,7 @@ following additional events, methods, and properties.\n added: v0.3.8\n -->\n \n-Emitted when the request has been aborted and the network socket has closed.\n+Emitted when the request has been aborted.\n \n ### Event: 'close'\n <!-- YAML\n@@ -1493,6 +1493,16 @@ added: v0.4.2\n Indicates that the underlying connection was closed.\n Just like `'end'`, this event occurs only once per response.\n \n+### message.aborted\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {boolean}\n+\n+The `message.aborted` property will be `true` if the request has\n+been aborted.\n+\n ### message.destroy([error])\n <!-- YAML\n added: v0.3.0"
        },
        {
            "sha": "c47d4c7e573ae7cb4235e189afbd793bfe84d5ac",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -2417,6 +2417,16 @@ added: v8.4.0\n Indicates that the underlying [`Http2Stream`][] was closed.\n Just like `'end'`, this event occurs only once per response.\n \n+#### request.aborted\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {boolean}\n+\n+The `request.aborted` property will be `true` if the request has\n+been aborted.\n+\n #### request.destroy([error])\n <!-- YAML\n added: v8.4.0"
        },
        {
            "sha": "04880182dace9129f908f7f2d4b80994a8c03a94",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -279,6 +279,7 @@ ClientRequest.prototype.abort = function abort() {\n   if (!this.aborted) {\n     process.nextTick(emitAbortNT.bind(this));\n   }\n+\n   // Mark as aborting so we can avoid sending queued request data\n   // This is used as a truthy flag elsewhere. The use of Date.now is for\n   // debugging purposes only.\n@@ -330,7 +331,10 @@ function socketCloseListener() {\n   var parser = socket.parser;\n   if (req.res && req.res.readable) {\n     // Socket closed before we emitted 'end' below.\n-    if (!req.res.complete) req.res.emit('aborted');\n+    if (!req.res.complete) {\n+      req.res.aborted = true;\n+      req.res.emit('aborted');\n+    }\n     var res = req.res;\n     res.on('end', function() {\n       res.emit('close');"
        },
        {
            "sha": "23ac4d54be1ec5a3f6eb017bb76ed5c4be7dd47e",
            "filename": "lib/_http_incoming.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_incoming.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_incoming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_incoming.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -54,6 +54,8 @@ function IncomingMessage(socket) {\n \n   this.readable = true;\n \n+  this.aborted = false;\n+\n   this.upgrade = null;\n \n   // request (server) only"
        },
        {
            "sha": "9c8b5cb8fbfe8e0fb37997c4d783b08b55dfb504",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -440,6 +440,7 @@ function socketOnClose(socket, state) {\n function abortIncoming(incoming) {\n   while (incoming.length) {\n     var req = incoming.shift();\n+    req.aborted = true;\n     req.emit('aborted');\n     req.emit('close');\n   }"
        },
        {
            "sha": "d2aaa8838e2cbcbd63b690db54195e0c5bb9dedf",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -31,6 +31,7 @@ const kTrailers = Symbol('trailers');\n const kRawTrailers = Symbol('rawTrailers');\n const kProxySocket = Symbol('proxySocket');\n const kSetHeader = Symbol('setHeader');\n+const kAborted = Symbol('aborted');\n \n const {\n   HTTP2_HEADER_AUTHORITY,\n@@ -137,6 +138,7 @@ function onStreamDrain() {\n function onStreamAbortedRequest() {\n   const request = this[kRequest];\n   if (request !== undefined && request[kState].closed === false) {\n+    request[kAborted] = true;\n     request.emit('aborted');\n   }\n }\n@@ -233,6 +235,7 @@ class Http2ServerRequest extends Readable {\n     this[kTrailers] = {};\n     this[kRawTrailers] = [];\n     this[kStream] = stream;\n+    this[kAborted] = false;\n     stream[kProxySocket] = null;\n     stream[kRequest] = this;\n \n@@ -248,6 +251,10 @@ class Http2ServerRequest extends Readable {\n     this.on('resume', onRequestResume);\n   }\n \n+  get aborted() {\n+    return this[kAborted];\n+  }\n+\n   get complete() {\n     return this._readableState.ended ||\n            this[kState].closed ||"
        },
        {
            "sha": "c3d7e4641f45019156e85a86a7b9d9c421995238",
            "filename": "test/parallel/test-http-aborted.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/test%2Fparallel%2Ftest-http-aborted.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/test%2Fparallel%2Ftest-http-aborted.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-aborted.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+\n+const common = require('../common');\n+const http = require('http');\n+const assert = require('assert');\n+\n+const server = http.createServer(common.mustCall(function(req, res) {\n+  req.on('aborted', common.mustCall(function() {\n+    assert.strictEqual(this.aborted, true);\n+    server.close();\n+  }));\n+  assert.strictEqual(req.aborted, false);\n+  res.write('hello');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const req = http.get({\n+    port: server.address().port,\n+    headers: { connection: 'keep-alive' }\n+  }, common.mustCall((res) => {\n+    res.on('aborted', common.mustCall(() => {\n+      assert.strictEqual(res.aborted, true);\n+    }));\n+    req.abort();\n+  }));\n+}));"
        },
        {
            "sha": "01caf95f98688ae2b097cb00acd0d5eeb35e7f64",
            "filename": "test/parallel/test-http2-compat-aborted.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/d5e363b77ebaf1caf67cd7528224b651c86815c1/test%2Fparallel%2Ftest-http2-compat-aborted.js",
            "raw_url": "https://github.com/nodejs/node/raw/d5e363b77ebaf1caf67cd7528224b651c86815c1/test%2Fparallel%2Ftest-http2-compat-aborted.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-aborted.js?ref=d5e363b77ebaf1caf67cd7528224b651c86815c1",
            "patch": "@@ -0,0 +1,27 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const h2 = require('http2');\n+const assert = require('assert');\n+\n+\n+const server = h2.createServer(common.mustCall(function(req, res) {\n+  req.on('aborted', common.mustCall(function() {\n+    assert.strictEqual(this.aborted, true);\n+  }));\n+  assert.strictEqual(req.aborted, false);\n+  res.write('hello');\n+  server.close();\n+}));\n+\n+server.listen(0, common.mustCall(function() {\n+  const url = `http://localhost:${server.address().port}`;\n+  const client = h2.connect(url, common.mustCall(() => {\n+    const request = client.request();\n+    request.on('data', common.mustCall((chunk) => {\n+      client.destroy();\n+    }));\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 89,
        "deletions": 2
    }
}