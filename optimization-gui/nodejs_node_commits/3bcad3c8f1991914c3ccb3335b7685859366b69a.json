{
    "author": "addaleax",
    "message": "src: cleanup per-isolate state on platform on isolate unregister\n\nClean up once all references to an `Isolate*` are gone from the\n`NodePlatform`, rather than waiting for the `PerIsolatePlatformData`\nstruct to be deleted since there may be cyclic references between\nthat struct and the individual tasks.\n\nPR-URL: https://github.com/nodejs/node/pull/20876\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "3bcad3c8f1991914c3ccb3335b7685859366b69a",
    "files": [
        {
            "sha": "6fc83950d3083ee1ac085ef2114082f1d3eee67b",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/3bcad3c8f1991914c3ccb3335b7685859366b69a/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3bcad3c8f1991914c3ccb3335b7685859366b69a/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=3bcad3c8f1991914c3ccb3335b7685859366b69a",
            "patch": "@@ -82,12 +82,14 @@ void PerIsolatePlatformData::PostIdleTask(std::unique_ptr<v8::IdleTask> task) {\n }\n \n void PerIsolatePlatformData::PostTask(std::unique_ptr<Task> task) {\n+  CHECK_NE(flush_tasks_, nullptr);\n   foreground_tasks_.Push(std::move(task));\n   uv_async_send(flush_tasks_);\n }\n \n void PerIsolatePlatformData::PostDelayedTask(\n     std::unique_ptr<Task> task, double delay_in_seconds) {\n+  CHECK_NE(flush_tasks_, nullptr);\n   std::unique_ptr<DelayedTask> delayed(new DelayedTask());\n   delayed->task = std::move(task);\n   delayed->platform_data = shared_from_this();\n@@ -97,13 +99,21 @@ void PerIsolatePlatformData::PostDelayedTask(\n }\n \n PerIsolatePlatformData::~PerIsolatePlatformData() {\n+  Shutdown();\n+}\n+\n+void PerIsolatePlatformData::Shutdown() {\n+  if (flush_tasks_ == nullptr)\n+    return;\n+\n   while (FlushForegroundTasksInternal()) {}\n   CancelPendingDelayedTasks();\n \n   uv_close(reinterpret_cast<uv_handle_t*>(flush_tasks_),\n            [](uv_handle_t* handle) {\n     delete reinterpret_cast<uv_async_t*>(handle);\n   });\n+  flush_tasks_ = nullptr;\n }\n \n void PerIsolatePlatformData::ref() {\n@@ -144,6 +154,7 @@ void NodePlatform::UnregisterIsolate(IsolateData* isolate_data) {\n   std::shared_ptr<PerIsolatePlatformData> existing = per_isolate_[isolate];\n   CHECK(existing);\n   if (existing->unref() == 0) {\n+    existing->Shutdown();\n     per_isolate_.erase(isolate);\n   }\n }"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 11,
        "deletions": 0
    }
}