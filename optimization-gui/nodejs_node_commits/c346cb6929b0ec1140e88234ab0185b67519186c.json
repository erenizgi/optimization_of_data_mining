{
    "author": "unknown",
    "message": "benchmark: add tls benchmark for legacy SecurePair\n\nPR-URL: https://github.com/nodejs/node/pull/20344\nRefs: https://github.com/nodejs/node/issues/20263\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "c346cb6929b0ec1140e88234ab0185b67519186c",
    "files": [
        {
            "sha": "ed678b9060983e2d970f81c13ad2300fc2e86679",
            "filename": "benchmark/tls/secure-pair.js",
            "status": "added",
            "additions": 105,
            "deletions": 0,
            "changes": 105,
            "blob_url": "https://github.com/nodejs/node/blob/c346cb6929b0ec1140e88234ab0185b67519186c/benchmark%2Ftls%2Fsecure-pair.js",
            "raw_url": "https://github.com/nodejs/node/raw/c346cb6929b0ec1140e88234ab0185b67519186c/benchmark%2Ftls%2Fsecure-pair.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Ftls%2Fsecure-pair.js?ref=c346cb6929b0ec1140e88234ab0185b67519186c",
            "patch": "@@ -0,0 +1,105 @@\n+'use strict';\n+const common = require('../common.js');\n+const bench = common.createBenchmark(main, {\n+  dur: [5],\n+  securing: ['SecurePair', 'TLSSocket'],\n+  size: [2, 1024, 1024 * 1024]\n+});\n+\n+const fs = require('fs');\n+const tls = require('tls');\n+const net = require('net');\n+const path = require('path');\n+\n+const cert_dir = path.resolve(__dirname, '../../test/fixtures');\n+const REDIRECT_PORT = 28347;\n+\n+function main({ dur, size, securing }) {\n+  const chunk = Buffer.alloc(size, 'b');\n+\n+  const options = {\n+    key: fs.readFileSync(`${cert_dir}/test_key.pem`),\n+    cert: fs.readFileSync(`${cert_dir}/test_cert.pem`),\n+    ca: [ fs.readFileSync(`${cert_dir}/test_ca.pem`) ],\n+    ciphers: 'AES256-GCM-SHA384',\n+    isServer: true,\n+    requestCert: true,\n+    rejectUnauthorized: true,\n+  };\n+\n+  const server = net.createServer(onRedirectConnection);\n+  server.listen(REDIRECT_PORT, () => {\n+    const proxy = net.createServer(onProxyConnection);\n+    proxy.listen(common.PORT, () => {\n+      const clientOptions = {\n+        port: common.PORT,\n+        ca: options.ca,\n+        key: options.key,\n+        cert: options.cert,\n+        isServer: false,\n+        rejectUnauthorized: false,\n+      };\n+      const conn = tls.connect(clientOptions, () => {\n+        setTimeout(() => {\n+          const mbits = (received * 8) / (1024 * 1024);\n+          bench.end(mbits);\n+          if (conn)\n+            conn.destroy();\n+          server.close();\n+          proxy.close();\n+        }, dur * 1000);\n+        bench.start();\n+        conn.on('drain', write);\n+        write();\n+      });\n+      conn.on('error', (e) => {\n+        throw new Error(`Client error: ${e}`);\n+      });\n+\n+      function write() {\n+        while (false !== conn.write(chunk));\n+      }\n+    });\n+  });\n+\n+  function onProxyConnection(conn) {\n+    const client = net.connect(REDIRECT_PORT, () => {\n+      switch (securing) {\n+        case 'SecurePair':\n+          securePair(conn, client);\n+          break;\n+        case 'TLSSocket':\n+          secureTLSSocket(conn, client);\n+          break;\n+        default:\n+          throw new Error('Invalid securing method');\n+      }\n+    });\n+  }\n+\n+  function securePair(conn, client) {\n+    const serverCtx = tls.createSecureContext(options);\n+    const serverPair = tls.createSecurePair(serverCtx, true, true, false);\n+    conn.pipe(serverPair.encrypted);\n+    serverPair.encrypted.pipe(conn);\n+    serverPair.on('error', (error) => {\n+      throw new Error(`Pair error: ${error}`);\n+    });\n+    serverPair.cleartext.pipe(client);\n+  }\n+\n+  function secureTLSSocket(conn, client) {\n+    const serverSocket = new tls.TLSSocket(conn, options);\n+    serverSocket.on('error', (e) => {\n+      throw new Error(`Socket error: ${e}`);\n+    });\n+    serverSocket.pipe(client);\n+  }\n+\n+  let received = 0;\n+  function onRedirectConnection(conn) {\n+    conn.on('data', (chunk) => {\n+      received += chunk.length;\n+    });\n+  }\n+}"
        },
        {
            "sha": "40c14af8302bdb5a90ab9b5a31a8f805162f6282",
            "filename": "test/sequential/test-benchmark-tls.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/c346cb6929b0ec1140e88234ab0185b67519186c/test%2Fsequential%2Ftest-benchmark-tls.js",
            "raw_url": "https://github.com/nodejs/node/raw/c346cb6929b0ec1140e88234ab0185b67519186c/test%2Fsequential%2Ftest-benchmark-tls.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-benchmark-tls.js?ref=c346cb6929b0ec1140e88234ab0185b67519186c",
            "patch": "@@ -20,6 +20,7 @@ runBenchmark('tls',\n                'dur=0.1',\n                'n=1',\n                'size=2',\n+               'securing=SecurePair',\n                'type=asc'\n              ],\n              {"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 106,
        "deletions": 0
    }
}