{
    "author": "unknown",
    "message": "module: add --preserve-symlinks-main\n\nAdd `--preserve-symlinks-main` option which behaves like\n`--preserve-symlinks` but for `require.main`.\n\nPR-URL: https://github.com/nodejs/node/pull/19911\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "236596590ce5746c66a36bee9ca81203553bd7a2",
    "files": [
        {
            "sha": "d76c49615c9bca906bd39bfc9b2bef4e333b404d",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -217,6 +217,29 @@ are linked from more than one location in the dependency tree (Node.js would\n see those as two separate modules and would attempt to load the module multiple\n times, causing an exception to be thrown).\n \n+The `--preserve-symlinks` flag does not apply to the main module, which allows\n+`node --preserve-symlinks node_module/.bin/<foo>` to work.  To apply the same\n+behavior for the main module, also use `--preserve-symlinks-main`.\n+\n+### `--preserve-symlinks-main`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Instructs the module loader to preserve symbolic links when resolving and\n+caching the main module (`require.main`).\n+\n+This flag exists so that the main module can be opted-in to the same behavior\n+that `--preserve-symlinks` gives to all other imports; they are separate flags,\n+however, for backward compatibility with older Node.js versions.\n+\n+Note that `--preserve-symlinks-main` does not imply `--preserve-symlinks`; it\n+is expected that `--preserve-symlinks-main` will be used in addition to\n+`--preserve-symlinks` when it is not desirable to follow symlinks before\n+resolving relative paths.\n+\n+See `--preserve-symlinks` for more information.\n+\n ### `--prof-process`\n <!-- YAML\n added: v5.2.0"
        },
        {
            "sha": "f22e475d8465f270385226869cf93502fa38e492",
            "filename": "doc/node.1",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/doc%2Fnode.1",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/doc%2Fnode.1",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fnode.1?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -143,7 +143,10 @@ Among other uses, this can be used to enable FIPS-compliant crypto if Node.js is\n Emit pending deprecation warnings.\n .\n .It Fl -preserve-symlinks\n-Instructs the module loader to preserve symbolic links when resolving and caching modules.\n+Instructs the module loader to preserve symbolic links when resolving and caching modules other than the main module.\n+.\n+.It F1 -preserve-symlinks-main\n+Instructs the module loader to preserve symbolic links when resolving and caching the main module.\n .\n .It Fl -prof-process\n Process V8 profiler output generated using the V8 option"
        },
        {
            "sha": "022f58d27e286840cd39543ed71f80055da9b633",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -42,6 +42,7 @@ const {\n   stripShebang\n } = require('internal/modules/cjs/helpers');\n const preserveSymlinks = !!process.binding('config').preserveSymlinks;\n+const preserveSymlinksMain = !!process.binding('config').preserveSymlinksMain;\n const experimentalModules = !!process.binding('config').experimentalModules;\n \n const {\n@@ -239,7 +240,21 @@ Module._findPath = function(request, paths, isMain) {\n     var rc = stat(basePath);\n     if (!trailingSlash) {\n       if (rc === 0) {  // File.\n-        if (preserveSymlinks && !isMain) {\n+        if (!isMain) {\n+          if (preserveSymlinks) {\n+            filename = path.resolve(basePath);\n+          } else {\n+            filename = toRealPath(basePath);\n+          }\n+        } else if (preserveSymlinksMain) {\n+          // For the main module, we use the preserveSymlinksMain flag instead\n+          // mainly for backward compatibility, as the preserveSymlinks flag\n+          // historically has not applied to the main module.  Most likely this\n+          // was intended to keep .bin/ binaries working, as following those\n+          // symlinks is usually required for the imports in the corresponding\n+          // files to resolve; that said, in some use cases following symlinks\n+          // causes bigger problems which is why the preserveSymlinksMain option\n+          // is needed.\n           filename = path.resolve(basePath);\n         } else {\n           filename = toRealPath(basePath);"
        },
        {
            "sha": "b573ce4e8d9e5af09ef9fedbfc0f8e6bcbb00840",
            "filename": "lib/internal/modules/esm/default_resolve.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fesm%2Fdefault_resolve.js?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -7,6 +7,7 @@ const { NativeModule, internalBinding } = require('internal/bootstrap/loaders');\n const { extname } = require('path');\n const { realpathSync } = require('fs');\n const preserveSymlinks = !!process.binding('config').preserveSymlinks;\n+const preserveSymlinksMain = !!process.binding('config').preserveSymlinksMain;\n const {\n   ERR_MISSING_MODULE,\n   ERR_MODULE_RESOLUTION_LEGACY,\n@@ -71,7 +72,7 @@ function resolve(specifier, parentURL) {\n \n   const isMain = parentURL === undefined;\n \n-  if (!preserveSymlinks || isMain) {\n+  if (isMain ? !preserveSymlinksMain : !preserveSymlinks) {\n     const real = realpathSync(getPathFromURL(url), {\n       [internalFS.realpathCacheKey]: realpathCache\n     });"
        },
        {
            "sha": "141846f6a1d76714255bf3cc73425b42dc2d77d0",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -237,6 +237,11 @@ bool trace_warnings = false;\n // that is used by lib/module.js\n bool config_preserve_symlinks = false;\n \n+// Set in node.cc by ParseArgs when --preserve-symlinks-main is used.\n+// Used in node_config.cc to set a constant on process.binding('config')\n+// that is used by lib/module.js\n+bool config_preserve_symlinks_main = false;\n+\n // Set in node.cc by ParseArgs when --experimental-modules is used.\n // Used in node_config.cc to set a constant on process.binding('config')\n // that is used by lib/module.js\n@@ -3529,6 +3534,8 @@ static void PrintHelp() {\n          \"  --pending-deprecation      emit pending deprecation warnings\\n\"\n #if defined(NODE_HAVE_I18N_SUPPORT)\n          \"  --preserve-symlinks        preserve symbolic links when resolving\\n\"\n+         \"  --preserve-symlinks-main   preserve symbolic links when resolving\\n\"\n+         \"                             the main module\\n\"\n #endif\n          \"  --prof-process             process v8 profiler output generated\\n\"\n          \"                             using --prof\\n\"\n@@ -3579,7 +3586,6 @@ static void PrintHelp() {\n          \"  -r, --require              module to preload (option can be \"\n          \"repeated)\\n\"\n          \"  -v, --version              print Node.js version\\n\"\n-\n          \"\\n\"\n          \"Environment variables:\\n\"\n          \"NODE_DEBUG                   ','-separated list of core modules\\n\"\n@@ -3842,6 +3848,8 @@ static void ParseArgs(int* argc,\n       Revert(cve);\n     } else if (strcmp(arg, \"--preserve-symlinks\") == 0) {\n       config_preserve_symlinks = true;\n+    } else if (strcmp(arg, \"--preserve-symlinks-main\") == 0) {\n+      config_preserve_symlinks_main = true;\n     } else if (strcmp(arg, \"--experimental-modules\") == 0) {\n       config_experimental_modules = true;\n       new_v8_argv[new_v8_argc] = \"--harmony-dynamic-import\";\n@@ -4286,6 +4294,12 @@ void Init(int* argc,\n         SafeGetenv(\"NODE_PRESERVE_SYMLINKS\", &text) && text[0] == '1';\n   }\n \n+  {\n+    std::string text;\n+    config_preserve_symlinks_main =\n+        SafeGetenv(\"NODE_PRESERVE_SYMLINKS_MAIN\", &text) && text[0] == '1';\n+  }\n+\n   if (config_warning_file.empty())\n     SafeGetenv(\"NODE_REDIRECT_WARNINGS\", &config_warning_file);\n "
        },
        {
            "sha": "603d55491a259b446a0f9aee1bedbc06ecfabf28",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -72,6 +72,8 @@ static void Initialize(Local<Object> target,\n \n   if (config_preserve_symlinks)\n     READONLY_BOOLEAN_PROPERTY(\"preserveSymlinks\");\n+  if (config_preserve_symlinks_main)\n+    READONLY_BOOLEAN_PROPERTY(\"preserveSymlinksMain\");\n \n   if (config_experimental_modules) {\n     READONLY_BOOLEAN_PROPERTY(\"experimentalModules\");"
        },
        {
            "sha": "c10369c5631dd63fdb8c02a31f85013650794818",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -173,6 +173,11 @@ extern std::string openssl_config;\n // that is used by lib/module.js\n extern bool config_preserve_symlinks;\n \n+// Set in node.cc by ParseArgs when --preserve-symlinks-main is used.\n+// Used in node_config.cc to set a constant on process.binding('config')\n+// that is used by lib/module.js\n+extern bool config_preserve_symlinks_main;\n+\n // Set in node.cc by ParseArgs when --experimental-modules is used.\n // Used in node_config.cc to set a constant on process.binding('config')\n // that is used by lib/module.js"
        },
        {
            "sha": "fbca5dce743674297aba08414f8fdd663e2bdb08",
            "filename": "test/es-module/test-esm-preserve-symlinks-main.js",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/236596590ce5746c66a36bee9ca81203553bd7a2/test%2Fes-module%2Ftest-esm-preserve-symlinks-main.js",
            "raw_url": "https://github.com/nodejs/node/raw/236596590ce5746c66a36bee9ca81203553bd7a2/test%2Fes-module%2Ftest-esm-preserve-symlinks-main.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-preserve-symlinks-main.js?ref=236596590ce5746c66a36bee9ca81203553bd7a2",
            "patch": "@@ -0,0 +1,57 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { spawn } = require('child_process');\n+const assert = require('assert');\n+const path = require('path');\n+const fs = require('fs');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+const tmpDir = tmpdir.path;\n+\n+fs.mkdirSync(path.join(tmpDir, 'nested'));\n+fs.mkdirSync(path.join(tmpDir, 'nested2'));\n+\n+const entry = path.join(tmpDir, 'nested', 'entry.js');\n+const entry_link_absolute_path = path.join(tmpDir, 'link.js');\n+const submodule = path.join(tmpDir, 'nested2', 'submodule.js');\n+const submodule_link_absolute_path = path.join(tmpDir, 'submodule_link.js');\n+\n+fs.writeFileSync(entry, `\n+const assert = require('assert');\n+\n+// this import only resolves with --preserve-symlinks-main set\n+require('./submodule_link.js');\n+`);\n+fs.writeFileSync(submodule, '');\n+\n+try {\n+  fs.symlinkSync(entry, entry_link_absolute_path);\n+  fs.symlinkSync(submodule, submodule_link_absolute_path);\n+} catch (err) {\n+  if (err.code !== 'EPERM') throw err;\n+  common.skip('insufficient privileges for symlinks');\n+}\n+\n+function doTest(flags, done) {\n+  // invoke the main file via a symlink.  In this case --preserve-symlinks-main\n+  // dictates that it'll resolve relative imports in the main file relative to\n+  // the symlink, and not relative to the symlink target; the file structure set\n+  // up above requires this to not crash when loading ./submodule_link.js\n+  spawn(process.execPath,\n+        flags.concat([\n+          '--preserve-symlinks',\n+          '--preserve-symlinks-main', entry_link_absolute_path\n+        ]),\n+        { stdio: 'inherit' }).on('exit', (code) => {\n+    assert.strictEqual(code, 0);\n+    done();\n+  });\n+}\n+\n+// first test the commonjs module loader\n+doTest([], () => {\n+  // now test the new loader\n+  doTest(['--experimental-modules'], () => {});\n+});"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 124,
        "deletions": 4
    }
}