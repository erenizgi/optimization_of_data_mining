{
    "author": "devsnek",
    "message": "napi: add bigint support\n\nPR-URL: https://github.com/nodejs/node/pull/21226\nReviewed-By: Gabriel Schulhof <gabriel.schulhof@intel.com>\nReviewed-By: Kyle Farnung <kfarnung@microsoft.com>",
    "sha": "1849a2b2e98c093e27d781bd5040f76a22e8f977",
    "files": [
        {
            "sha": "5fbe4bb07469c28c6ec370fd4c8438dd5f83fd42",
            "filename": "doc/api/n-api.md",
            "status": "modified",
            "additions": 162,
            "deletions": 2,
            "changes": 164,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/doc%2Fapi%2Fn-api.md",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/doc%2Fapi%2Fn-api.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fn-api.md?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -113,10 +113,9 @@ typedef enum {\n   napi_escape_called_twice,\n   napi_handle_scope_mismatch,\n   napi_callback_scope_mismatch,\n-#ifdef NAPI_EXPERIMENTAL\n   napi_queue_full,\n   napi_closing,\n-#endif  // NAPI_EXPERIMENTAL\n+  napi_bigint_expected,\n } napi_status;\n ```\n If additional information is required upon an API returning a failed status,\n@@ -1225,6 +1224,7 @@ typedef enum {\n   napi_object,\n   napi_function,\n   napi_external,\n+  napi_bigint,\n } napi_valuetype;\n ```\n \n@@ -1250,6 +1250,8 @@ typedef enum {\n   napi_uint32_array,\n   napi_float32_array,\n   napi_float64_array,\n+  napi_bigint64_array,\n+  napi_biguint64_array,\n } napi_typedarray_type;\n ```\n \n@@ -1691,6 +1693,78 @@ This API is used to convert from the C `double` type to the JavaScript\n The JavaScript `Number` type is described in\n [Section 6.1.6][] of the ECMAScript Language Specification.\n \n+#### napi_create_bigint_int64\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_create_bigint_int64(napi_env env,\n+                                     int64_t value,\n+                                     napi_value* result);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] value`: Integer value to be represented in JavaScript.\n+- `[out] result`: A `napi_value` representing a JavaScript `BigInt`.\n+\n+Returns `napi_ok` if the API succeeded.\n+\n+This API converts the C `int64_t` type to the JavaScript `BigInt` type.\n+\n+#### napi_create_bigint_uint64\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_create_bigint_uint64(napi_env env,\n+                                      uint64_t vaue,\n+                                      napi_value* result);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] value`: Unsigned integer value to be represented in JavaScript.\n+- `[out] result`: A `napi_value` representing a JavaScript `BigInt`.\n+\n+Returns `napi_ok` if the API succeeded.\n+\n+This API converts the C `uint64_t` type to the JavaScript `BigInt` type.\n+\n+#### napi_create_bigint_words\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_create_bigint_words(napi_env env,\n+                                     int sign_bit,\n+                                     size_t word_count,\n+                                     const uint64_t* words,\n+                                     napi_value* result);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] sign_bit`: Determines if the resulting `BigInt` will be positive or\n+  negative.\n+- `[in] word_count`: The length of the `words` array.\n+- `[in] words`: An array of `uint64_t` little-endian 64-bit words.\n+- `[out] result`: A `napi_value` representing a JavaScript `BigInt`.\n+\n+Returns `napi_ok` if the API succeeded.\n+\n+This API converts an array of unsigned 64-bit words into a single `BigInt`\n+value.\n+\n+The resulting `BigInt` is calculated as: (–1)<sup>`sign_bit`</sup> (`words[0]`\n+× (2<sup>64</sup>)<sup>0</sup> + `words[1]` × (2<sup>64</sup>)<sup>1</sup> + …)\n+\n #### napi_create_string_latin1\n <!-- YAML\n added: v8.0.0\n@@ -1975,6 +2049,92 @@ in it returns `napi_number_expected`.\n This API returns the C double primitive equivalent of the given JavaScript\n `Number`.\n \n+#### napi_get_value_bigint_int64\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_get_value_bigint_int64(napi_env env,\n+                                        napi_value value,\n+                                        int64_t* result,\n+                                        bool* lossless);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under\n+- `[in] value`: `napi_value` representing JavaScript `BigInt`.\n+- `[out] result`: C `int64_t` primitive equivalent of the given JavaScript\n+  `BigInt`.\n+- `[out] lossless`: Indicates whether the `BigInt` value was converted\n+  losslessly.\n+\n+Returns `napi_ok` if the API succeeded. If a non-`BigInt` is passed in it\n+returns `napi_bigint_expected`.\n+\n+This API returns the C `int64_t` primitive equivalent of the given JavaScript\n+`BigInt`. If needed it will truncate the value, setting `lossless` to `false`.\n+\n+\n+#### napi_get_value_bigint_uint64\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_get_value_bigint_uint64(napi_env env,\n+                                        napi_value value,\n+                                        uint64_t* result,\n+                                        bool* lossless);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] value`: `napi_value` representing JavaScript `BigInt`.\n+- `[out] result`: C `uint64_t` primitive equivalent of the given JavaScript\n+  `BigInt`.\n+- `[out] lossless`: Indicates whether the `BigInt` value was converted\n+  losslessly.\n+\n+Returns `napi_ok` if the API succeeded. If a non-`BigInt` is passed in it\n+returns `napi_bigint_expected`.\n+\n+This API returns the C `uint64_t` primitive equivalent of the given JavaScript\n+`BigInt`. If needed it will truncate the value, setting `lossless` to `false`.\n+\n+\n+#### napi_get_value_bigint_words\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+> Stability: 1 - Experimental\n+\n+```C\n+napi_status napi_get_value_bigint_words(napi_env env,\n+                                        napi_value value,\n+                                        size_t* word_count,\n+                                        int* sign_bit,\n+                                        uint64_t* words);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] value`: `napi_value` representing JavaScript `BigInt`.\n+- `[out] sign_bit`: Integer representing if the JavaScript `BigInt` is positive\n+   or negative.\n+- `[in/out] word_count`: Must be initialized to the length of the `words`\n+   array. Upon return, it will be set to the actual number of words that\n+   would be needed to store this `BigInt`.\n+- `[out] words`: Pointer to a pre-allocated 64-bit word array.\n+\n+Returns `napi_ok` if the API succeeded.\n+\n+This API converts a single `BigInt` value into a sign bit, 64-bit little-endian\n+array, and the number of elements in the array. `sign_bit` and `words` may be\n+both set to `NULL`, in order to get only `word_count`.\n+\n #### napi_get_value_external\n <!-- YAML\n added: v8.0.0"
        },
        {
            "sha": "ad0796570a4c14f4ce2e4c5e48cfc84d00930885",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 135,
            "deletions": 2,
            "changes": 137,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -926,7 +926,8 @@ const char* error_messages[] = {nullptr,\n                                 \"Invalid handle scope usage\",\n                                 \"Invalid callback scope usage\",\n                                 \"Thread-safe function queue is full\",\n-                                \"Thread-safe function handle is closing\"\n+                                \"Thread-safe function handle is closing\",\n+                                \"A bigint was expected\",\n };\n \n static inline napi_status napi_clear_last_error(napi_env env) {\n@@ -958,7 +959,7 @@ napi_status napi_get_last_error_info(napi_env env,\n   // We don't have a napi_status_last as this would result in an ABI\n   // change each time a message was added.\n   static_assert(\n-      node::arraysize(error_messages) == napi_closing + 1,\n+      node::arraysize(error_messages) == napi_bigint_expected + 1,\n       \"Count of error messages must match count of error values\");\n   CHECK_LE(env->last_error.error_code, napi_callback_scope_mismatch);\n \n@@ -1713,6 +1714,58 @@ napi_status napi_create_int64(napi_env env,\n   return napi_clear_last_error(env);\n }\n \n+napi_status napi_create_bigint_int64(napi_env env,\n+                                     int64_t value,\n+                                     napi_value* result) {\n+  CHECK_ENV(env);\n+  CHECK_ARG(env, result);\n+\n+  *result = v8impl::JsValueFromV8LocalValue(\n+      v8::BigInt::New(env->isolate, value));\n+\n+  return napi_clear_last_error(env);\n+}\n+\n+napi_status napi_create_bigint_uint64(napi_env env,\n+                                      uint64_t value,\n+                                      napi_value* result) {\n+  CHECK_ENV(env);\n+  CHECK_ARG(env, result);\n+\n+  *result = v8impl::JsValueFromV8LocalValue(\n+      v8::BigInt::NewFromUnsigned(env->isolate, value));\n+\n+  return napi_clear_last_error(env);\n+}\n+\n+napi_status napi_create_bigint_words(napi_env env,\n+                                     int sign_bit,\n+                                     size_t word_count,\n+                                     const uint64_t* words,\n+                                     napi_value* result) {\n+  NAPI_PREAMBLE(env);\n+  CHECK_ARG(env, words);\n+  CHECK_ARG(env, result);\n+\n+  v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n+\n+  if (word_count > INT_MAX) {\n+    napi_throw_range_error(env, nullptr, \"Maximum BigInt size exceeded\");\n+    return napi_set_last_error(env, napi_pending_exception);\n+  }\n+\n+  v8::MaybeLocal<v8::BigInt> b = v8::BigInt::NewFromWords(\n+      context, sign_bit, word_count, words);\n+\n+  if (try_catch.HasCaught()) {\n+    return napi_set_last_error(env, napi_pending_exception);\n+  } else {\n+    CHECK_MAYBE_EMPTY(env, b, napi_generic_failure);\n+    *result = v8impl::JsValueFromV8LocalValue(b.ToLocalChecked());\n+    return napi_clear_last_error(env);\n+  }\n+}\n+\n napi_status napi_get_boolean(napi_env env, bool value, napi_value* result) {\n   CHECK_ENV(env);\n   CHECK_ARG(env, result);\n@@ -1878,6 +1931,8 @@ napi_status napi_typeof(napi_env env,\n \n   if (v->IsNumber()) {\n     *result = napi_number;\n+  } else if (v->IsBigInt()) {\n+    *result = napi_bigint;\n   } else if (v->IsString()) {\n     *result = napi_string;\n   } else if (v->IsFunction()) {\n@@ -2201,6 +2256,72 @@ napi_status napi_get_value_int64(napi_env env,\n   return napi_clear_last_error(env);\n }\n \n+napi_status napi_get_value_bigint_int64(napi_env env,\n+                                        napi_value value,\n+                                        int64_t* result,\n+                                        bool* lossless) {\n+  CHECK_ENV(env);\n+  CHECK_ARG(env, value);\n+  CHECK_ARG(env, result);\n+  CHECK_ARG(env, lossless);\n+\n+  v8::Local<v8::Value> val = v8impl::V8LocalValueFromJsValue(value);\n+\n+  RETURN_STATUS_IF_FALSE(env, val->IsBigInt(), napi_bigint_expected);\n+\n+  *result = val.As<v8::BigInt>()->Int64Value(lossless);\n+\n+  return napi_clear_last_error(env);\n+}\n+\n+napi_status napi_get_value_bigint_uint64(napi_env env,\n+                                         napi_value value,\n+                                         uint64_t* result,\n+                                         bool* lossless) {\n+  CHECK_ENV(env);\n+  CHECK_ARG(env, value);\n+  CHECK_ARG(env, result);\n+  CHECK_ARG(env, lossless);\n+\n+  v8::Local<v8::Value> val = v8impl::V8LocalValueFromJsValue(value);\n+\n+  RETURN_STATUS_IF_FALSE(env, val->IsBigInt(), napi_bigint_expected);\n+\n+  *result = val.As<v8::BigInt>()->Uint64Value(lossless);\n+\n+  return napi_clear_last_error(env);\n+}\n+\n+napi_status napi_get_value_bigint_words(napi_env env,\n+                                        napi_value value,\n+                                        int* sign_bit,\n+                                        size_t* word_count,\n+                                        uint64_t* words) {\n+  CHECK_ENV(env);\n+  CHECK_ARG(env, value);\n+  CHECK_ARG(env, word_count);\n+\n+  v8::Local<v8::Value> val = v8impl::V8LocalValueFromJsValue(value);\n+\n+  RETURN_STATUS_IF_FALSE(env, val->IsBigInt(), napi_bigint_expected);\n+\n+  v8::Local<v8::BigInt> big = val.As<v8::BigInt>();\n+\n+  int word_count_int = *word_count;\n+\n+  if (sign_bit == nullptr && words == nullptr) {\n+    word_count_int = big->WordCount();\n+  } else {\n+    CHECK_ARG(env, sign_bit);\n+    CHECK_ARG(env, words);\n+    big->ToWordsArray(sign_bit, &word_count_int, words);\n+  }\n+\n+  *word_count = word_count_int;\n+\n+  return napi_clear_last_error(env);\n+}\n+\n napi_status napi_get_value_bool(napi_env env, napi_value value, bool* result) {\n   // Omit NAPI_PREAMBLE and GET_RETURN_STATUS because V8 calls here cannot throw\n   // JS exceptions.\n@@ -3139,6 +3260,14 @@ napi_status napi_create_typedarray(napi_env env,\n       CREATE_TYPED_ARRAY(\n           env, Float64Array, 8, buffer, byte_offset, length, typedArray);\n       break;\n+    case napi_bigint64_array:\n+      CREATE_TYPED_ARRAY(\n+          env, BigInt64Array, 8, buffer, byte_offset, length, typedArray);\n+      break;\n+    case napi_biguint64_array:\n+      CREATE_TYPED_ARRAY(\n+          env, BigUint64Array, 8, buffer, byte_offset, length, typedArray);\n+      break;\n     default:\n       return napi_set_last_error(env, napi_invalid_arg);\n   }\n@@ -3181,6 +3310,10 @@ napi_status napi_get_typedarray_info(napi_env env,\n       *type = napi_float32_array;\n     } else if (value->IsFloat64Array()) {\n       *type = napi_float64_array;\n+    } else if (value->IsBigInt64Array()) {\n+      *type = napi_bigint64_array;\n+    } else if (value->IsBigUint64Array()) {\n+      *type = napi_biguint64_array;\n     }\n   }\n "
        },
        {
            "sha": "1b2a392a0a0b1c90ded828c116dbef82c04bf955",
            "filename": "src/node_api.h",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api.h",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.h?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -671,6 +671,30 @@ napi_unref_threadsafe_function(napi_env env, napi_threadsafe_function func);\n NAPI_EXTERN napi_status\n napi_ref_threadsafe_function(napi_env env, napi_threadsafe_function func);\n \n+NAPI_EXTERN napi_status napi_create_bigint_int64(napi_env env,\n+                                                 int64_t value,\n+                                                 napi_value* result);\n+NAPI_EXTERN napi_status napi_create_bigint_uint64(napi_env env,\n+                                                  uint64_t value,\n+                                                  napi_value* result);\n+NAPI_EXTERN napi_status napi_create_bigint_words(napi_env env,\n+                                                 int sign_bit,\n+                                                 size_t word_count,\n+                                                 const uint64_t* words,\n+                                                 napi_value* result);\n+NAPI_EXTERN napi_status napi_get_value_bigint_int64(napi_env env,\n+                                                    napi_value value,\n+                                                    int64_t* result,\n+                                                    bool* lossless);\n+NAPI_EXTERN napi_status napi_get_value_bigint_uint64(napi_env env,\n+                                                     napi_value value,\n+                                                     uint64_t* result,\n+                                                     bool* lossless);\n+NAPI_EXTERN napi_status napi_get_value_bigint_words(napi_env env,\n+                                                    napi_value value,\n+                                                    int* sign_bit,\n+                                                    size_t* word_count,\n+                                                    uint64_t* words);\n #endif  // NAPI_EXPERIMENTAL\n \n EXTERN_C_END"
        },
        {
            "sha": "10215d9aa3a0ffc4d297f2a4e5ac754ac5ecb8aa",
            "filename": "src/node_api_types.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api_types.h",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/src%2Fnode_api_types.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api_types.h?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -46,6 +46,7 @@ typedef enum {\n   napi_object,\n   napi_function,\n   napi_external,\n+  napi_bigint,\n } napi_valuetype;\n \n typedef enum {\n@@ -58,6 +59,8 @@ typedef enum {\n   napi_uint32_array,\n   napi_float32_array,\n   napi_float64_array,\n+  napi_bigint64_array,\n+  napi_biguint64_array,\n } napi_typedarray_type;\n \n typedef enum {\n@@ -78,6 +81,7 @@ typedef enum {\n   napi_callback_scope_mismatch,\n   napi_queue_full,\n   napi_closing,\n+  napi_bigint_expected,\n } napi_status;\n \n #ifdef NAPI_EXPERIMENTAL"
        },
        {
            "sha": "1b9f75bab4f737b6e0783ccd935966d792eb1faa",
            "filename": "test/addons-napi/test_bigint/binding.gyp",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_bigint%2Fbinding.gyp?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"targets\": [\n+    {\n+      \"target_name\": \"test_bigint\",\n+      \"sources\": [ \"test_bigint.c\" ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "b92c810459321bf77c38e1eeede13722712a7979",
            "filename": "test/addons-napi/test_bigint/test.js",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_bigint%2Ftest.js?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -0,0 +1,45 @@\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const {\n+  IsLossless,\n+  TestInt64,\n+  TestUint64,\n+  TestWords,\n+  CreateTooBigBigInt,\n+} = require(`./build/${common.buildType}/test_bigint`);\n+\n+[\n+  0n,\n+  -0n,\n+  1n,\n+  -1n,\n+  100n,\n+  2121n,\n+  -1233n,\n+  986583n,\n+  -976675n,\n+  98765432213456789876546896323445679887645323232436587988766545658n,\n+  -4350987086545760976737453646576078997096876957864353245245769809n,\n+].forEach((num) => {\n+  if (num > -(2n ** 63n) && num < 2n ** 63n) {\n+    assert.strictEqual(TestInt64(num), num);\n+    assert.strictEqual(IsLossless(num, true), true);\n+  } else {\n+    assert.strictEqual(IsLossless(num, true), false);\n+  }\n+\n+  if (num >= 0 && num < 2n ** 64n) {\n+    assert.strictEqual(TestUint64(num), num);\n+    assert.strictEqual(IsLossless(num, false), true);\n+  } else {\n+    assert.strictEqual(IsLossless(num, false), false);\n+  }\n+\n+  assert.strictEqual(num, TestWords(num));\n+});\n+\n+assert.throws(CreateTooBigBigInt, {\n+  name: 'RangeError',\n+  message: 'Maximum BigInt size exceeded',\n+});"
        },
        {
            "sha": "e3516628e88b3531962cf30cada202ff7ee110cd",
            "filename": "test/addons-napi/test_bigint/test_bigint.c",
            "status": "added",
            "additions": 142,
            "deletions": 0,
            "changes": 142,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Ftest_bigint.c",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_bigint%2Ftest_bigint.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_bigint%2Ftest_bigint.c?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -0,0 +1,142 @@\n+#define NAPI_EXPERIMENTAL\n+\n+#include <inttypes.h>\n+#include <stdio.h>\n+#include <node_api.h>\n+#include \"../common.h\"\n+\n+static napi_value IsLossless(napi_env env, napi_callback_info info) {\n+  size_t argc = 2;\n+  napi_value args[2];\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, &args, NULL, NULL));\n+\n+  bool is_signed;\n+  NAPI_CALL(env, napi_get_value_bool(env, args[1], &is_signed));\n+\n+  bool lossless;\n+\n+  if (is_signed) {\n+    int64_t input;\n+    NAPI_CALL(env, napi_get_value_bigint_int64(env, args[0], &input, &lossless));\n+  } else {\n+    uint64_t input;\n+    NAPI_CALL(env, napi_get_value_bigint_uint64(env, args[0], &input, &lossless));\n+  }\n+\n+  napi_value output;\n+  NAPI_CALL(env, napi_get_boolean(env, lossless, &output));\n+\n+  return output;\n+}\n+\n+static napi_value TestInt64(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value args[1];\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, NULL, NULL));\n+\n+  NAPI_ASSERT(env, argc >= 1, \"Wrong number of arguments\");\n+\n+  napi_valuetype valuetype0;\n+  NAPI_CALL(env, napi_typeof(env, args[0], &valuetype0));\n+\n+  NAPI_ASSERT(env, valuetype0 == napi_bigint,\n+      \"Wrong type of arguments. Expects a bigint as first argument.\");\n+\n+  int64_t input;\n+  bool lossless;\n+  NAPI_CALL(env, napi_get_value_bigint_int64(env, args[0], &input, &lossless));\n+\n+  napi_value output;\n+  NAPI_CALL(env, napi_create_bigint_int64(env, input, &output));\n+\n+  return output;\n+}\n+\n+static napi_value TestUint64(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value args[1];\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, NULL, NULL));\n+\n+  NAPI_ASSERT(env, argc >= 1, \"Wrong number of arguments\");\n+\n+  napi_valuetype valuetype0;\n+  NAPI_CALL(env, napi_typeof(env, args[0], &valuetype0));\n+\n+  NAPI_ASSERT(env, valuetype0 == napi_bigint,\n+      \"Wrong type of arguments. Expects a bigint as first argument.\");\n+\n+  uint64_t input;\n+  bool lossless;\n+  NAPI_CALL(env, napi_get_value_bigint_uint64(\n+        env, args[0], &input, &lossless));\n+\n+  napi_value output;\n+  NAPI_CALL(env, napi_create_bigint_uint64(env, input, &output));\n+\n+  return output;\n+}\n+\n+static napi_value TestWords(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value args[1];\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, NULL, NULL));\n+\n+  NAPI_ASSERT(env, argc >= 1, \"Wrong number of arguments\");\n+\n+  napi_valuetype valuetype0;\n+  NAPI_CALL(env, napi_typeof(env, args[0], &valuetype0));\n+\n+  NAPI_ASSERT(env, valuetype0 == napi_bigint,\n+      \"Wrong type of arguments. Expects a bigint as first argument.\");\n+\n+  size_t expected_word_count;\n+  NAPI_CALL(env, napi_get_value_bigint_words(\n+        env, args[0], NULL, &expected_word_count, NULL));\n+\n+  int sign_bit;\n+  size_t word_count = 10;\n+  uint64_t words[10];\n+\n+  NAPI_CALL(env, napi_get_value_bigint_words(\n+        env, args[0], &sign_bit, &word_count, &words));\n+\n+  NAPI_ASSERT(env, word_count == expected_word_count,\n+      \"word counts do not match\");\n+\n+  napi_value output;\n+  NAPI_CALL(env, napi_create_bigint_words(\n+        env, sign_bit, word_count, words, &output));\n+\n+  return output;\n+}\n+\n+// throws RangeError\n+static napi_value CreateTooBigBigInt(napi_env env, napi_callback_info info) {\n+  int sign_bit = 0;\n+  size_t word_count = SIZE_MAX;\n+  uint64_t words[10];\n+\n+  napi_value output;\n+\n+  NAPI_CALL(env, napi_create_bigint_words(\n+        env, sign_bit, word_count, words, &output));\n+\n+  return output;\n+}\n+\n+static napi_value Init(napi_env env, napi_value exports) {\n+  napi_property_descriptor descriptors[] = {\n+    DECLARE_NAPI_PROPERTY(\"IsLossless\", IsLossless),\n+    DECLARE_NAPI_PROPERTY(\"TestInt64\", TestInt64),\n+    DECLARE_NAPI_PROPERTY(\"TestUint64\", TestUint64),\n+    DECLARE_NAPI_PROPERTY(\"TestWords\", TestWords),\n+    DECLARE_NAPI_PROPERTY(\"CreateTooBigBigInt\", CreateTooBigBigInt),\n+  };\n+\n+  NAPI_CALL(env, napi_define_properties(\n+      env, exports, sizeof(descriptors) / sizeof(*descriptors), descriptors));\n+\n+  return exports;\n+}\n+\n+NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)"
        },
        {
            "sha": "2a8cf18feb866cf9ce6d689181e941481a1944c8",
            "filename": "test/addons-napi/test_typedarray/test.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_typedarray%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/1849a2b2e98c093e27d781bd5040f76a22e8f977/test%2Faddons-napi%2Ftest_typedarray%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_typedarray%2Ftest.js?ref=1849a2b2e98c093e27d781bd5040f76a22e8f977",
            "patch": "@@ -42,7 +42,7 @@ assert.strictEqual(externalResult[2], 2);\n const buffer = new ArrayBuffer(128);\n const arrayTypes = [ Int8Array, Uint8Array, Uint8ClampedArray, Int16Array,\n                      Uint16Array, Int32Array, Uint32Array, Float32Array,\n-                     Float64Array ];\n+                     Float64Array, BigInt64Array, BigUint64Array ];\n \n arrayTypes.forEach((currentType) => {\n   const template = Reflect.construct(currentType, buffer);\n@@ -64,7 +64,8 @@ arrayTypes.forEach((currentType) => {\n });\n \n const nonByteArrayTypes = [ Int16Array, Uint16Array, Int32Array, Uint32Array,\n-                            Float32Array, Float64Array ];\n+                            Float32Array, Float64Array,\n+                            BigInt64Array, BigUint64Array ];\n nonByteArrayTypes.forEach((currentType) => {\n   const template = Reflect.construct(currentType, buffer);\n   assert.throws(() => {"
        }
    ],
    "stats": {
        "total": 529,
        "additions": 523,
        "deletions": 6
    }
}