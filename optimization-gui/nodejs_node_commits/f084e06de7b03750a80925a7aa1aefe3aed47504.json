{
    "author": "devsnek",
    "message": "src: use custom TryCatch subclass\n\nPR-URL: https://github.com/nodejs/node/pull/24751\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "f084e06de7b03750a80925a7aa1aefe3aed47504",
    "files": [
        {
            "sha": "2c9aa3cb88422056126b98bb1737813f0033dd60",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -58,6 +58,7 @@ using v8::WeakCallbackInfo;\n using v8::WeakCallbackType;\n \n using AsyncHooks = node::Environment::AsyncHooks;\n+using TryCatchScope = node::errors::TryCatchScope;\n \n namespace node {\n \n@@ -91,7 +92,7 @@ struct AsyncWrapObject : public AsyncWrap {\n static void DestroyAsyncIdsCallback(Environment* env, void* data) {\n   Local<Function> fn = env->async_hooks_destroy_function();\n \n-  FatalTryCatch try_catch(env);\n+  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);\n \n   do {\n     std::vector<double> destroy_async_id_list;\n@@ -127,7 +128,7 @@ void Emit(Environment* env, double async_id, AsyncHooks::Fields type,\n \n   HandleScope handle_scope(env->isolate());\n   Local<Value> async_id_value = Number::New(env->isolate(), async_id);\n-  FatalTryCatch try_catch(env);\n+  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);\n   USE(fn->Call(env->context(), Undefined(env->isolate()), 1, &async_id_value));\n }\n \n@@ -673,7 +674,7 @@ void AsyncWrap::EmitAsyncInit(Environment* env,\n     object,\n   };\n \n-  FatalTryCatch try_catch(env);\n+  TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);\n   USE(init_fn->Call(env->context(), object, arraysize(argv), argv));\n }\n \n@@ -776,7 +777,7 @@ Local<Object> AsyncWrap::GetOwner(Environment* env, Local<Object> obj) {\n   EscapableHandleScope handle_scope(env->isolate());\n   CHECK(!obj.IsEmpty());\n \n-  TryCatch ignore_exceptions(env->isolate());\n+  TryCatchScope ignore_exceptions(env);\n   while (true) {\n     Local<Value> owner;\n     if (!obj->Get(env->context(),"
        },
        {
            "sha": "bdb3c1ea247e214c0d9ef13a201734e1638ca4d1",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -1,6 +1,7 @@\n #include \"async_wrap.h\"\n #include \"node_buffer.h\"\n #include \"node_context_data.h\"\n+#include \"node_errors.h\"\n #include \"node_file.h\"\n #include \"node_internals.h\"\n #include \"node_native_module.h\"\n@@ -15,6 +16,7 @@\n \n namespace node {\n \n+using errors::TryCatchScope;\n using v8::Context;\n using v8::EmbedderGraph;\n using v8::External;\n@@ -36,7 +38,6 @@ using v8::StackTrace;\n using v8::String;\n using v8::Symbol;\n using v8::TracingController;\n-using v8::TryCatch;\n using v8::Undefined;\n using v8::Value;\n using worker::Worker;\n@@ -156,7 +157,7 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n   Local<Function> cb = env_->trace_category_state_function();\n   if (cb.IsEmpty())\n     return;\n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env_);\n   try_catch.SetVerbose(true);\n   cb->Call(env_->context(), Undefined(isolate),\n            0, nullptr).ToLocalChecked();\n@@ -577,7 +578,7 @@ void Environment::RunAndClearNativeImmediates() {\n     std::vector<NativeImmediateCallback> list;\n     native_immediate_callbacks_.swap(list);\n     auto drain_list = [&]() {\n-      TryCatch try_catch(isolate());\n+      TryCatchScope try_catch(this);\n       for (auto it = list.begin(); it != list.end(); ++it) {\n #ifdef DEBUG\n         v8::SealHandleScope seal_handle_scope(isolate());\n@@ -642,7 +643,7 @@ void Environment::RunTimers(uv_timer_t* handle) {\n   // impossible for us to end up in an infinite loop due to how the JS-side\n   // is structured.\n   do {\n-    TryCatch try_catch(env->isolate());\n+    TryCatchScope try_catch(env);\n     try_catch.SetVerbose(true);\n     ret = cb->Call(env->context(), process, 1, &arg);\n   } while (ret.IsEmpty() && env->can_call_into_js());"
        },
        {
            "sha": "31e15ec308326b395230fc221340267d34fb9035",
            "filename": "src/js_stream.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fjs_stream.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fjs_stream.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -3,12 +3,15 @@\n #include \"async_wrap.h\"\n #include \"env-inl.h\"\n #include \"node_buffer.h\"\n+#include \"node_errors.h\"\n #include \"node_internals.h\"\n #include \"stream_base-inl.h\"\n #include \"v8.h\"\n \n namespace node {\n \n+using errors::TryCatchScope;\n+\n using v8::Array;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n@@ -18,7 +21,6 @@ using v8::Int32;\n using v8::Local;\n using v8::Object;\n using v8::String;\n-using v8::TryCatch;\n using v8::Value;\n \n \n@@ -42,7 +44,7 @@ bool JSStream::IsAlive() {\n bool JSStream::IsClosing() {\n   HandleScope scope(env()->isolate());\n   Context::Scope context_scope(env()->context());\n-  TryCatch try_catch(env()->isolate());\n+  TryCatchScope try_catch(env());\n   Local<Value> value;\n   if (!MakeCallback(env()->isclosing_string(), 0, nullptr).ToLocal(&value)) {\n     if (!try_catch.HasTerminated())\n@@ -56,7 +58,7 @@ bool JSStream::IsClosing() {\n int JSStream::ReadStart() {\n   HandleScope scope(env()->isolate());\n   Context::Scope context_scope(env()->context());\n-  TryCatch try_catch(env()->isolate());\n+  TryCatchScope try_catch(env());\n   Local<Value> value;\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onreadstart_string(), 0, nullptr).ToLocal(&value) ||\n@@ -71,7 +73,7 @@ int JSStream::ReadStart() {\n int JSStream::ReadStop() {\n   HandleScope scope(env()->isolate());\n   Context::Scope context_scope(env()->context());\n-  TryCatch try_catch(env()->isolate());\n+  TryCatchScope try_catch(env());\n   Local<Value> value;\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onreadstop_string(), 0, nullptr).ToLocal(&value) ||\n@@ -91,7 +93,7 @@ int JSStream::DoShutdown(ShutdownWrap* req_wrap) {\n     req_wrap->object()\n   };\n \n-  TryCatch try_catch(env()->isolate());\n+  TryCatchScope try_catch(env());\n   Local<Value> value;\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onshutdown_string(),\n@@ -126,7 +128,7 @@ int JSStream::DoWrite(WriteWrap* w,\n     bufs_arr\n   };\n \n-  TryCatch try_catch(env()->isolate());\n+  TryCatchScope try_catch(env());\n   Local<Value> value;\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onwrite_string(),"
        },
        {
            "sha": "9a3c1cb2e2c26eb3f28fa7b0ed2119334476dcc5",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -14,6 +14,8 @@\n namespace node {\n namespace loader {\n \n+using errors::TryCatchScope;\n+\n using node::contextify::ContextifyContext;\n using node::url::URL;\n using node::url::URL_FLAGS_FAILED;\n@@ -40,7 +42,6 @@ using v8::Promise;\n using v8::ScriptCompiler;\n using v8::ScriptOrigin;\n using v8::String;\n-using v8::TryCatch;\n using v8::Undefined;\n using v8::Value;\n \n@@ -135,7 +136,7 @@ void ModuleWrap::New(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   Environment::ShouldNotAbortOnUncaughtScope no_abort_scope(env);\n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env);\n   Local<Module> module;\n \n   Local<PrimitiveArray> host_defined_options =\n@@ -244,7 +245,7 @@ void ModuleWrap::Instantiate(const FunctionCallbackInfo<Value>& args) {\n   ASSIGN_OR_RETURN_UNWRAP(&obj, args.This());\n   Local<Context> context = obj->context_.Get(isolate);\n   Local<Module> module = obj->module_.Get(isolate);\n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env);\n   Maybe<bool> ok = module->InstantiateModule(context, ResolveCallback);\n \n   // clear resolve cache on instantiate\n@@ -279,7 +280,7 @@ void ModuleWrap::Evaluate(const FunctionCallbackInfo<Value>& args) {\n   bool break_on_sigint = args[1]->IsTrue();\n \n   Environment::ShouldNotAbortOnUncaughtScope no_abort_scope(env);\n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env);\n \n   bool timed_out = false;\n   bool received_signal = false;"
        },
        {
            "sha": "975373baa6c56d978a9c242be46fe7da0218431a",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -116,6 +116,7 @@ typedef int mode_t;\n \n namespace node {\n \n+using errors::TryCatchScope;\n using native_module::NativeModuleLoader;\n using options_parser::kAllowedInEnvironment;\n using options_parser::kDisallowedInEnvironment;\n@@ -154,7 +155,6 @@ using v8::SealHandleScope;\n using v8::SideEffectType;\n using v8::String;\n using v8::TracingController;\n-using v8::TryCatch;\n using v8::Undefined;\n using v8::V8;\n using v8::Value;\n@@ -746,7 +746,7 @@ static MaybeLocal<Value> ExecuteString(Environment* env,\n                                        Local<String> source,\n                                        Local<String> filename) {\n   EscapableHandleScope scope(env->isolate());\n-  TryCatch try_catch(env->isolate());\n+  TryCatchScope try_catch(env);\n \n   // try_catch must be nonverbose to disable FatalException() handler,\n   // we will handle exceptions ourself.\n@@ -1341,7 +1341,7 @@ static MaybeLocal<Function> GetBootstrapper(\n     Local<String> script_name) {\n   EscapableHandleScope scope(env->isolate());\n \n-  TryCatch try_catch(env->isolate());\n+  TryCatchScope try_catch(env);\n \n   // Disable verbose mode to stop FatalException() handler from trying\n   // to handle the exception. Errors this early in the start-up phase\n@@ -1386,7 +1386,7 @@ static bool ExecuteBootstrapper(Environment* env, Local<Function> bootstrapper,\n void LoadEnvironment(Environment* env) {\n   HandleScope handle_scope(env->isolate());\n \n-  TryCatch try_catch(env->isolate());\n+  TryCatchScope try_catch(env);\n   // Disable verbose mode to stop FatalException() handler from trying\n   // to handle the exception. Errors this early in the start-up phase\n   // are not safe to ignore."
        },
        {
            "sha": "f12d5e7d66724ca9b215f19da721f738119e34f5",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -31,6 +31,8 @@\n namespace node {\n namespace contextify {\n \n+using errors::TryCatchScope;\n+\n using v8::Array;\n using v8::ArrayBuffer;\n using v8::ArrayBufferView;\n@@ -63,7 +65,6 @@ using v8::ScriptCompiler;\n using v8::ScriptOrigin;\n using v8::String;\n using v8::Symbol;\n-using v8::TryCatch;\n using v8::Uint32;\n using v8::UnboundScript;\n using v8::Value;\n@@ -245,7 +246,7 @@ void ContextifyContext::MakeContext(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args[4]->IsBoolean());\n   options.allow_code_gen_wasm = args[4].As<Boolean>();\n \n-  TryCatch try_catch(env->isolate());\n+  TryCatchScope try_catch(env);\n   ContextifyContext* context = new ContextifyContext(env, sandbox, options);\n \n   if (try_catch.HasCaught()) {\n@@ -705,7 +706,7 @@ void ContextifyScript::New(const FunctionCallbackInfo<Value>& args) {\n   if (source.GetCachedData() != nullptr)\n     compile_options = ScriptCompiler::kConsumeCodeCache;\n \n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env);\n   Environment::ShouldNotAbortOnUncaughtScope no_abort_scope(env);\n   Context::Scope scope(parsing_context);\n \n@@ -863,7 +864,7 @@ bool ContextifyScript::EvalMachine(Environment* env,\n         \"Script methods can only be called on script instances.\");\n     return false;\n   }\n-  TryCatch try_catch(env->isolate());\n+  TryCatchScope try_catch(env);\n   ContextifyScript* wrapped_script;\n   ASSIGN_OR_RETURN_UNWRAP(&wrapped_script, args.Holder(), false);\n   Local<UnboundScript> unbound_script =\n@@ -1012,7 +1013,7 @@ void ContextifyContext::CompileFunction(\n     options = ScriptCompiler::kConsumeCodeCache;\n   }\n \n-  TryCatch try_catch(isolate);\n+  TryCatchScope try_catch(env);\n   Context::Scope scope(parsing_context);\n \n   // Read context extensions from buffer"
        },
        {
            "sha": "9884a62741031642ff31a8b6b4b5c3dc6f1309cc",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -3,9 +3,10 @@\n \n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n-#include \"node_internals.h\"\n-#include \"node_context_data.h\"\n #include \"base_object-inl.h\"\n+#include \"node_context_data.h\"\n+#include \"node_errors.h\"\n+#include \"node_internals.h\"\n \n namespace node {\n namespace contextify {"
        },
        {
            "sha": "b7f7f59e70ef6245292c11e933a2fb9296467826",
            "filename": "src/node_errors.cc",
            "status": "modified",
            "additions": 48,
            "deletions": 42,
            "changes": 90,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_errors.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_errors.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -3,6 +3,7 @@\n #include \"node_internals.h\"\n \n namespace node {\n+\n using v8::Context;\n using v8::Exception;\n using v8::Function;\n@@ -20,7 +21,6 @@ using v8::Number;\n using v8::Object;\n using v8::ScriptOrigin;\n using v8::String;\n-using v8::TryCatch;\n using v8::Undefined;\n using v8::Value;\n \n@@ -258,45 +258,10 @@ void ReportException(Environment* env,\n #endif\n }\n \n-void ReportException(Environment* env, const TryCatch& try_catch) {\n+void ReportException(Environment* env, const v8::TryCatch& try_catch) {\n   ReportException(env, try_catch.Exception(), try_catch.Message());\n }\n \n-void DecorateErrorStack(Environment* env, const TryCatch& try_catch) {\n-  Local<Value> exception = try_catch.Exception();\n-\n-  if (!exception->IsObject()) return;\n-\n-  Local<Object> err_obj = exception.As<Object>();\n-\n-  if (IsExceptionDecorated(env, err_obj)) return;\n-\n-  AppendExceptionLine(env, exception, try_catch.Message(), CONTEXTIFY_ERROR);\n-  Local<Value> stack = err_obj->Get(env->context(),\n-                                    env->stack_string()).ToLocalChecked();\n-  MaybeLocal<Value> maybe_value =\n-      err_obj->GetPrivate(env->context(), env->arrow_message_private_symbol());\n-\n-  Local<Value> arrow;\n-  if (!(maybe_value.ToLocal(&arrow) && arrow->IsString())) {\n-    return;\n-  }\n-\n-  if (stack.IsEmpty() || !stack->IsString()) {\n-    return;\n-  }\n-\n-  Local<String> decorated_stack = String::Concat(\n-      env->isolate(),\n-      String::Concat(env->isolate(),\n-                     arrow.As<String>(),\n-                     FIXED_ONE_BYTE_STRING(env->isolate(), \"\\n\")),\n-      stack.As<String>());\n-  err_obj->Set(env->context(), env->stack_string(), decorated_stack).FromJust();\n-  err_obj->SetPrivate(\n-      env->context(), env->decorated_private_symbol(), True(env->isolate()));\n-}\n-\n void PrintErrorString(const char* format, ...) {\n   va_list ap;\n   va_start(ap, format);\n@@ -347,14 +312,54 @@ void OnFatalError(const char* location, const char* message) {\n   ABORT();\n }\n \n-FatalTryCatch::~FatalTryCatch() {\n-  if (HasCaught()) {\n+namespace errors {\n+\n+TryCatchScope::~TryCatchScope() {\n+  if (HasCaught() && mode_ == CatchMode::kFatal) {\n     HandleScope scope(env_->isolate());\n-    ReportException(env_, *this);\n+    ReportException(env_, Exception(), Message());\n     exit(7);\n   }\n }\n \n+}  // namespace errors\n+\n+void DecorateErrorStack(Environment* env,\n+                        const errors::TryCatchScope& try_catch) {\n+  Local<Value> exception = try_catch.Exception();\n+\n+  if (!exception->IsObject()) return;\n+\n+  Local<Object> err_obj = exception.As<Object>();\n+\n+  if (IsExceptionDecorated(env, err_obj)) return;\n+\n+  AppendExceptionLine(env, exception, try_catch.Message(), CONTEXTIFY_ERROR);\n+  Local<Value> stack =\n+      err_obj->Get(env->context(), env->stack_string()).ToLocalChecked();\n+  MaybeLocal<Value> maybe_value =\n+      err_obj->GetPrivate(env->context(), env->arrow_message_private_symbol());\n+\n+  Local<Value> arrow;\n+  if (!(maybe_value.ToLocal(&arrow) && arrow->IsString())) {\n+    return;\n+  }\n+\n+  if (stack.IsEmpty() || !stack->IsString()) {\n+    return;\n+  }\n+\n+  Local<String> decorated_stack = String::Concat(\n+      env->isolate(),\n+      String::Concat(env->isolate(),\n+                     arrow.As<String>(),\n+                     FIXED_ONE_BYTE_STRING(env->isolate(), \"\\n\")),\n+      stack.As<String>());\n+  err_obj->Set(env->context(), env->stack_string(), decorated_stack).FromJust();\n+  err_obj->SetPrivate(\n+      env->context(), env->decorated_private_symbol(), True(env->isolate()));\n+}\n+\n void FatalException(Isolate* isolate,\n                     Local<Value> error,\n                     Local<Message> message) {\n@@ -374,7 +379,7 @@ void FatalException(Isolate* isolate,\n     ReportException(env, error, message);\n     exit(6);\n   } else {\n-    TryCatch fatal_try_catch(isolate);\n+    errors::TryCatchScope fatal_try_catch(env);\n \n     // Do not call FatalException when _fatalException handler throws\n     fatal_try_catch.SetVerbose(false);\n@@ -389,6 +394,7 @@ void FatalException(Isolate* isolate,\n       // The fatal exception function threw, so we must exit\n       ReportException(env, fatal_try_catch);\n       exit(7);\n+\n     } else if (caught.ToLocalChecked()->IsFalse()) {\n       ReportException(env, error, message);\n \n@@ -405,7 +411,7 @@ void FatalException(Isolate* isolate,\n   }\n }\n \n-void FatalException(Isolate* isolate, const TryCatch& try_catch) {\n+void FatalException(Isolate* isolate, const v8::TryCatch& try_catch) {\n   // If we try to print out a termination exception, we'd just get 'null',\n   // so just crashing here with that information seems like a better idea,\n   // and in particular it seems like we should handle terminations at the call"
        },
        {
            "sha": "7638ff4251f95e733e50bf5c60704576b9fc1c59",
            "filename": "src/node_errors.h",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_errors.h",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_errors.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.h?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -14,8 +14,6 @@\n \n namespace node {\n \n-void DecorateErrorStack(Environment* env, const v8::TryCatch& try_catch);\n-\n enum ErrorHandlingMode { CONTEXTIFY_ERROR, FATAL_ERROR, MODULE_ERROR };\n void AppendExceptionLine(Environment* env,\n                          v8::Local<v8::Value> er,\n@@ -167,6 +165,35 @@ inline v8::Local<v8::Value> ERR_STRING_TOO_LONG(v8::Isolate* isolate) {\n                                               prefix \" must be a string\");   \\\n   } while (0)\n \n+namespace errors {\n+\n+class TryCatchScope : public v8::TryCatch {\n+ public:\n+  enum class CatchMode { kNormal, kFatal };\n+\n+  explicit TryCatchScope(Environment* env, CatchMode mode = CatchMode::kNormal)\n+      : v8::TryCatch(env->isolate()), env_(env), mode_(mode) {}\n+  ~TryCatchScope();\n+\n+  // Since the dtor is not virtual we need to make sure no one creates\n+  // object of it in the free store that might be held by polymorphic pointers.\n+  void* operator new(std::size_t count) = delete;\n+  void* operator new[](std::size_t count) = delete;\n+  TryCatchScope(TryCatchScope&) = delete;\n+  TryCatchScope(TryCatchScope&&) = delete;\n+  TryCatchScope operator=(TryCatchScope&) = delete;\n+  TryCatchScope operator=(TryCatchScope&&) = delete;\n+\n+ private:\n+  Environment* env_;\n+  CatchMode mode_;\n+};\n+\n+}  // namespace errors\n+\n+void DecorateErrorStack(Environment* env,\n+                        const errors::TryCatchScope& try_catch);\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "d5dba61ae4cc84c2ff8e387558cb948cee7d5537",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f084e06de7b03750a80925a7aa1aefe3aed47504/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=f084e06de7b03750a80925a7aa1aefe3aed47504",
            "patch": "@@ -11,6 +11,8 @@\n \n namespace node {\n \n+using errors::TryCatchScope;\n+\n using v8::Array;\n using v8::Context;\n using v8::Function;\n@@ -25,7 +27,6 @@ using v8::NewStringType;\n using v8::Null;\n using v8::Object;\n using v8::String;\n-using v8::TryCatch;\n using v8::Undefined;\n using v8::Value;\n \n@@ -2406,7 +2407,7 @@ const Local<Value> URL::ToObject(Environment* env) const {\n \n   MaybeLocal<Value> ret;\n   {\n-    FatalTryCatch try_catch(env);\n+    TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);\n \n     // The SetURLConstructor method must have been called already to\n     // set the constructor function used below. SetURLConstructor is"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 116,
        "deletions": 75
    }
}