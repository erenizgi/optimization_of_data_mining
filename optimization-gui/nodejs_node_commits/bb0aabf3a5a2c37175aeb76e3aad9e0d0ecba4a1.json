{
    "author": "unknown",
    "message": "inspector: check Host header for local connections\n\nPR-URL: https://github.com/nodejs-private/node-private/pull/102/\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>",
    "sha": "bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1",
    "files": [
        {
            "sha": "191ed5b0e5bd0de87f9871fcf27370d8166b4e00",
            "filename": "src/inspector_socket.cc",
            "status": "modified",
            "additions": 90,
            "deletions": 30,
            "changes": 120,
            "blob_url": "https://github.com/nodejs/node/blob/bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1/src%2Finspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1/src%2Finspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket.cc?ref=bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1",
            "patch": "@@ -8,8 +8,8 @@\n \n #include \"openssl/sha.h\"  // Sha-1 hash\n \n+#include <map>\n #include <string.h>\n-#include <vector>\n \n #define ACCEPT_KEY_LENGTH base64_encoded_size(20)\n #define BUFFER_GROWTH_CHUNK_SIZE 1024\n@@ -63,7 +63,7 @@ class ProtocolHandler {\n   virtual void Write(const std::vector<char> data) = 0;\n   virtual void CancelHandshake() = 0;\n \n-  std::string GetHost();\n+  std::string GetHost() const;\n \n   InspectorSocket* inspector() {\n     return inspector_;\n@@ -160,6 +160,48 @@ static void generate_accept_string(const std::string& client_key,\n   node::base64_encode(hash, sizeof(hash), *buffer, sizeof(*buffer));\n }\n \n+static bool IsOneOf(const std::string& host,\n+                    const std::vector<std::string>& hosts) {\n+  for (const std::string& candidate : hosts) {\n+    if (node::StringEqualNoCase(host.data(), candidate.data()))\n+      return true;\n+  }\n+  return false;\n+}\n+\n+static std::string TrimPort(const std::string& host) {\n+  size_t last_colon_pos = host.rfind(\":\");\n+  if (last_colon_pos == std::string::npos)\n+    return host;\n+  size_t bracket = host.rfind(\"]\");\n+  if (bracket == std::string::npos || last_colon_pos > bracket)\n+    return host.substr(0, last_colon_pos);\n+  return host;\n+}\n+\n+static bool IsIPAddress(const std::string& host) {\n+  if (host.length() >= 4 && host.front() == '[' && host.back() == ']')\n+    return true;\n+  int quads = 0;\n+  for (char c : host) {\n+    if (c == '.')\n+      quads++;\n+    else if (!isdigit(c))\n+      return false;\n+  }\n+  return quads == 3;\n+}\n+\n+// This is a value coming from the interface, it can only be IPv4 or IPv6\n+// address string.\n+static bool IsIPv4Localhost(const std::string& host) {\n+  std::string v6_tunnel_prefix = \"::ffff:\";\n+  if (host.substr(0, v6_tunnel_prefix.length()) == v6_tunnel_prefix)\n+    return IsIPv4Localhost(host.substr(v6_tunnel_prefix.length()));\n+  std::string localhost_net = \"127.\";\n+  return host.substr(0, localhost_net.length()) == localhost_net;\n+}\n+\n // Constants for hybi-10 frame format.\n \n typedef int OpCode;\n@@ -298,7 +340,6 @@ static ws_decode_result decode_frame_hybi17(const std::vector<char>& buffer,\n   return closed ? FRAME_CLOSE : FRAME_OK;\n }\n \n-\n // WS protocol\n class WsHandler : public ProtocolHandler {\n  public:\n@@ -400,17 +441,16 @@ class WsHandler : public ProtocolHandler {\n // HTTP protocol\n class HttpEvent {\n  public:\n-  HttpEvent(const std::string& path, bool upgrade,\n-            bool isGET, const std::string& ws_key) : path(path),\n-                                                     upgrade(upgrade),\n-                                                     isGET(isGET),\n-                                                     ws_key(ws_key) { }\n+  HttpEvent(const std::string& path, bool upgrade, bool isGET,\n+            const std::string& ws_key, const std::string& host)\n+            : path(path), upgrade(upgrade), isGET(isGET), ws_key(ws_key),\n+              host(host) { }\n \n   std::string path;\n   bool upgrade;\n   bool isGET;\n   std::string ws_key;\n-  std::string current_header_;\n+  std::string host;\n };\n \n class HttpHandler : public ProtocolHandler {\n@@ -472,18 +512,17 @@ class HttpHandler : public ProtocolHandler {\n     std::vector<HttpEvent> events;\n     std::swap(events, events_);\n     for (const HttpEvent& event : events) {\n-      bool shouldContinue = event.isGET && !event.upgrade;\n-      if (!event.isGET) {\n+      if (!IsAllowedHost(event.host) || !event.isGET) {\n         CancelHandshake();\n+        return;\n       } else if (!event.upgrade) {\n         delegate()->OnHttpGet(event.path);\n       } else if (event.ws_key.empty()) {\n         CancelHandshake();\n+        return;\n       } else {\n         delegate()->OnSocketUpgrade(event.path, event.ws_key);\n       }\n-      if (!shouldContinue)\n-        return;\n     }\n   }\n \n@@ -504,16 +543,9 @@ class HttpHandler : public ProtocolHandler {\n   }\n \n   static int OnHeaderValue(http_parser* parser, const char* at, size_t length) {\n-    static const char SEC_WEBSOCKET_KEY_HEADER[] = \"Sec-WebSocket-Key\";\n     HttpHandler* handler = From(parser);\n     handler->parsing_value_ = true;\n-    if (handler->current_header_.size() ==\n-            sizeof(SEC_WEBSOCKET_KEY_HEADER) - 1 &&\n-        node::StringEqualNoCaseN(handler->current_header_.data(),\n-                                 SEC_WEBSOCKET_KEY_HEADER,\n-                                 sizeof(SEC_WEBSOCKET_KEY_HEADER) - 1)) {\n-      handler->ws_key_.append(at, length);\n-    }\n+    handler->headers_[handler->current_header_].append(at, length);\n     return 0;\n   }\n \n@@ -540,23 +572,53 @@ class HttpHandler : public ProtocolHandler {\n   static int OnMessageComplete(http_parser* parser) {\n     // Event needs to be fired after the parser is done.\n     HttpHandler* handler = From(parser);\n-    handler->events_.push_back(HttpEvent(handler->path_, parser->upgrade,\n-                                         parser->method == HTTP_GET,\n-                                         handler->ws_key_));\n+    handler->events_.push_back(\n+        HttpEvent(handler->path_, parser->upgrade, parser->method == HTTP_GET,\n+                  handler->HeaderValue(\"Sec-WebSocket-Key\"),\n+                  handler->HeaderValue(\"Host\")));\n     handler->path_ = \"\";\n-    handler->ws_key_ = \"\";\n     handler->parsing_value_ = false;\n+    handler->headers_.clear();\n     handler->current_header_ = \"\";\n-\n     return 0;\n   }\n \n+  std::string HeaderValue(const std::string& header) const {\n+    bool header_found = false;\n+    std::string value;\n+    for (const auto& header_value : headers_) {\n+      if (node::StringEqualNoCaseN(header_value.first.data(), header.data(),\n+                                   header.length())) {\n+        if (header_found)\n+          return \"\";\n+        value = header_value.second;\n+        header_found = true;\n+      }\n+    }\n+    return value;\n+  }\n+\n+  bool IsAllowedHost(const std::string& host_with_port) const {\n+    std::string host = TrimPort(host_with_port);\n+    if (host.empty())\n+      return false;\n+    if (IsIPAddress(host))\n+       return true;\n+    std::string socket_host = GetHost();\n+    if (IsIPv4Localhost(socket_host)) {\n+      return IsOneOf(host, { \"localhost\" });\n+    } else if (socket_host == \"::1\") {\n+      return IsOneOf(host, { \"localhost\", \"localhost6\" });\n+    }\n+    return true;\n+  }\n+\n   bool parsing_value_;\n   http_parser parser_;\n   http_parser_settings parser_settings;\n   std::vector<HttpEvent> events_;\n   std::string current_header_;\n-  std::string ws_key_;\n+  std::map<std::string, std::string> headers_;\n   std::string path_;\n };\n \n@@ -579,7 +641,7 @@ InspectorSocket::Delegate* ProtocolHandler::delegate() {\n   return tcp_->delegate();\n }\n \n-std::string ProtocolHandler::GetHost() {\n+std::string ProtocolHandler::GetHost() const {\n   char ip[INET6_ADDRSTRLEN];\n   sockaddr_storage addr;\n   int len = sizeof(addr);\n@@ -622,8 +684,6 @@ TcpHolder::Pointer TcpHolder::Accept(\n   if (err == 0) {\n     return { result, DisconnectAndDispose };\n   } else {\n-    fprintf(stderr, \"[%s:%d@%s]\\n\", __FILE__, __LINE__, __FUNCTION__);\n-\n     delete result;\n     return { nullptr, nullptr };\n   }"
        },
        {
            "sha": "ae6e1231c4c3a1f119d52deafb369dec12799f01",
            "filename": "test/cctest/test_inspector_socket.cc",
            "status": "modified",
            "additions": 39,
            "deletions": 8,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1/test%2Fcctest%2Ftest_inspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1/test%2Fcctest%2Ftest_inspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_inspector_socket.cc?ref=bb0aabf3a5a2c37175aeb76e3aad9e0d0ecba4a1",
            "patch": "@@ -205,7 +205,7 @@ struct read_expects {\n };\n \n static const char HANDSHAKE_REQ[] = \"GET /ws/path HTTP/1.1\\r\\n\"\n-                                    \"Host: localhost:9222\\r\\n\"\n+                                    \"Host: localhost:9229\\r\\n\"\n                                     \"Upgrade: websocket\\r\\n\"\n                                     \"Connection: Upgrade\\r\\n\"\n                                     \"Sec-WebSocket-Key: aaa==\\r\\n\"\n@@ -504,7 +504,7 @@ TEST_F(InspectorSocketTest, ExtraTextBeforeRequest) {\n \n TEST_F(InspectorSocketTest, RequestWithoutKey) {\n   const char BROKEN_REQUEST[] = \"GET / HTTP/1.1\\r\\n\"\n-                                \"Host: localhost:9222\\r\\n\"\n+                                \"Host: localhost:9229\\r\\n\"\n                                 \"Upgrade: websocket\\r\\n\"\n                                 \"Connection: Upgrade\\r\\n\"\n                                 \"Sec-WebSocket-Version: 13\\r\\n\\r\\n\";\n@@ -619,24 +619,23 @@ TEST_F(InspectorSocketTest, ReportsHttpGet) {\n   delegate->SetDelegate(ReportsHttpGet_handshake);\n \n   const char GET_REQ[] = \"GET /some/path HTTP/1.1\\r\\n\"\n-                         \"Host: localhost:9222\\r\\n\"\n+                         \"Host: localhost:9229\\r\\n\"\n                          \"Sec-WebSocket-Key: aaa==\\r\\n\"\n                          \"Sec-WebSocket-Version: 13\\r\\n\\r\\n\";\n   send_in_chunks(GET_REQ, sizeof(GET_REQ) - 1);\n \n   expect_nothing_on_client();\n-\n   const char WRITE_REQUEST[] = \"GET /respond/withtext HTTP/1.1\\r\\n\"\n-                               \"Host: localhost:9222\\r\\n\\r\\n\";\n+                               \"Host: localhost:9229\\r\\n\\r\\n\";\n   send_in_chunks(WRITE_REQUEST, sizeof(WRITE_REQUEST) - 1);\n \n   expect_on_client(TEST_SUCCESS, sizeof(TEST_SUCCESS) - 1);\n   const char GET_REQS[] = \"GET /some/path2 HTTP/1.1\\r\\n\"\n-                          \"Host: localhost:9222\\r\\n\"\n+                          \"Host: localhost:9229\\r\\n\"\n                           \"Sec-WebSocket-Key: aaa==\\r\\n\"\n                           \"Sec-WebSocket-Version: 13\\r\\n\\r\\n\"\n                           \"GET /close HTTP/1.1\\r\\n\"\n-                          \"Host: localhost:9222\\r\\n\"\n+                          \"Host: localhost:9229\\r\\n\"\n                           \"Sec-WebSocket-Key: aaa==\\r\\n\"\n                           \"Sec-WebSocket-Version: 13\\r\\n\\r\\n\";\n   send_in_chunks(GET_REQS, sizeof(GET_REQS) - 1);\n@@ -696,7 +695,7 @@ static void GetThenHandshake_handshake(enum inspector_handshake_event state,\n TEST_F(InspectorSocketTest, GetThenHandshake) {\n   delegate->SetDelegate(GetThenHandshake_handshake);\n   const char WRITE_REQUEST[] = \"GET /respond/withtext HTTP/1.1\\r\\n\"\n-                               \"Host: localhost:9222\\r\\n\\r\\n\";\n+                               \"Host: localhost:9229\\r\\n\\r\\n\";\n   send_in_chunks(WRITE_REQUEST, sizeof(WRITE_REQUEST) - 1);\n \n   expect_on_client(TEST_SUCCESS, sizeof(TEST_SUCCESS) - 1);\n@@ -826,4 +825,36 @@ TEST_F(InspectorSocketTest, NoCloseResponseFromClient) {\n   delegate->WaitForDispose();\n }\n \n+static bool delegate_called = false;\n+\n+void shouldnt_be_called(enum inspector_handshake_event state,\n+                        const std::string& path, bool* cont) {\n+  delegate_called = true;\n+}\n+\n+void expect_failure_no_delegate(const std::string& request) {\n+  delegate->SetDelegate(shouldnt_be_called);\n+  delegate_called = false;\n+  send_in_chunks(request.c_str(), request.length());\n+  expect_handshake_failure();\n+  SPIN_WHILE(delegate != nullptr);\n+  ASSERT_FALSE(delegate_called);\n+}\n+\n+TEST_F(InspectorSocketTest, HostCheckedForGET) {\n+  const char GET_REQUEST[] = \"GET /respond/withtext HTTP/1.1\\r\\n\"\n+                             \"Host: notlocalhost:9229\\r\\n\\r\\n\";\n+  expect_failure_no_delegate(GET_REQUEST);\n+}\n+\n+TEST_F(InspectorSocketTest, HostCheckedForUPGRADE) {\n+  const char UPGRADE_REQUEST[] = \"GET /ws/path HTTP/1.1\\r\\n\"\n+                                 \"Host: nonlocalhost:9229\\r\\n\"\n+                                 \"Upgrade: websocket\\r\\n\"\n+                                 \"Connection: Upgrade\\r\\n\"\n+                                 \"Sec-WebSocket-Key: aaa==\\r\\n\"\n+                                 \"Sec-WebSocket-Version: 13\\r\\n\\r\\n\";\n+  expect_failure_no_delegate(UPGRADE_REQUEST);\n+}\n+\n }  // anonymous namespace"
        }
    ],
    "stats": {
        "total": 167,
        "additions": 129,
        "deletions": 38
    }
}