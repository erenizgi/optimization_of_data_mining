{
    "author": "addaleax",
    "message": "http2: fix endless loop when writing empty string\n\nPR-URL: https://github.com/nodejs/node/pull/18924\nFixes: https://github.com/nodejs/node/issues/18169\nRefs: https://github.com/nodejs/node/pull/18673\nRefs: https://github.com/nodejs/node/blob/v9.5.0/src/node_http2.cc#L1481-L1484\nRefs: https://github.com/nodejs/node/blob/v9.5.0/lib/_http_outgoing.js#L659-L661\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Khaidi Chu <i@2333.moe>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "9bc333cae7d03b7ec584c7c7633b114a4468bccd",
    "files": [
        {
            "sha": "f1454aa11e58e993845bdcef09c53d16674266c2",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/9bc333cae7d03b7ec584c7c7633b114a4468bccd/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9bc333cae7d03b7ec584c7c7633b114a4468bccd/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=9bc333cae7d03b7ec584c7c7633b114a4468bccd",
            "patch": "@@ -2184,6 +2184,17 @@ ssize_t Http2Stream::Provider::Stream::OnRead(nghttp2_session* handle,\n \n   size_t amount = 0;          // amount of data being sent in this data frame.\n \n+  // Remove all empty chunks from the head of the queue.\n+  // This is done here so that .write('', cb) is still a meaningful way to\n+  // find out when the HTTP2 stream wants to consume data, and because the\n+  // StreamBase API allows empty input chunks.\n+  while (!stream->queue_.empty() && stream->queue_.front().buf.len == 0) {\n+    WriteWrap* finished = stream->queue_.front().req_wrap;\n+    stream->queue_.pop();\n+    if (finished != nullptr)\n+      finished->Done(0);\n+  }\n+\n   if (!stream->queue_.empty()) {\n     DEBUG_HTTP2SESSION2(session, \"stream %d has pending outbound data\", id);\n     amount = std::min(stream->available_outbound_length_, length);\n@@ -2197,7 +2208,8 @@ ssize_t Http2Stream::Provider::Stream::OnRead(nghttp2_session* handle,\n     }\n   }\n \n-  if (amount == 0 && stream->IsWritable() && stream->queue_.empty()) {\n+  if (amount == 0 && stream->IsWritable()) {\n+    CHECK(stream->queue_.empty());\n     DEBUG_HTTP2SESSION2(session, \"deferring stream %d\", id);\n     return NGHTTP2_ERR_DEFERRED;\n   }"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 13,
        "deletions": 1
    }
}