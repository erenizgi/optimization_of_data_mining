{
    "author": "addaleax",
    "message": "src: include cwd in chdir error message\n\nInclude the current working directory in the error\nmessage for a failing `process.chdir()` since that is\nusually information relevant for debugging.\n\nThis is semver-major because it moves properties\nof the error message object.\n\nInspired by https://github.com/nodejs/help/issues/1355.\n\nPR-URL: https://github.com/nodejs/node/pull/21526\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "cf37945b121d23c044cd04ac79cd5ab312a34cbe",
    "files": [
        {
            "sha": "020f132f825e009fba913177ea69d4b29d84f07b",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/cf37945b121d23c044cd04ac79cd5ab312a34cbe/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/cf37945b121d23c044cd04ac79cd5ab312a34cbe/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=cf37945b121d23c044cd04ac79cd5ab312a34cbe",
            "patch": "@@ -47,6 +47,13 @@ using v8::Value;\n // used in Hrtime() below\n #define NANOS_PER_SEC 1000000000\n \n+#ifdef _WIN32\n+/* MAX_PATH is in characters, not bytes. Make sure we have enough headroom. */\n+#define CHDIR_BUFSIZE (MAX_PATH * 4)\n+#else\n+#define CHDIR_BUFSIZE (PATH_MAX)\n+#endif\n+\n void Abort(const FunctionCallbackInfo<Value>& args) {\n   Abort();\n }\n@@ -59,8 +66,14 @@ void Chdir(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args[0]->IsString());\n   Utf8Value path(env->isolate(), args[0]);\n   int err = uv_chdir(*path);\n-  if (err)\n-    return env->ThrowUVException(err, \"chdir\", nullptr, *path, nullptr);\n+  if (err) {\n+    // Also include the original working directory, since that will usually\n+    // be helpful information when debugging a `chdir()` failure.\n+    char buf[CHDIR_BUFSIZE];\n+    size_t cwd_len = sizeof(buf);\n+    uv_cwd(buf, &cwd_len);\n+    return env->ThrowUVException(err, \"chdir\", nullptr, buf, *path);\n+  }\n }\n \n // CPUUsage use libuv's uv_getrusage() this-process resource usage accessor,\n@@ -93,13 +106,7 @@ void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n \n void Cwd(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n-#ifdef _WIN32\n-  /* MAX_PATH is in characters, not bytes. Make sure we have enough headroom. */\n-  char buf[MAX_PATH * 4];\n-#else\n-  char buf[PATH_MAX];\n-#endif\n-\n+  char buf[CHDIR_BUFSIZE];\n   size_t cwd_len = sizeof(buf);\n   int err = uv_cwd(buf, &cwd_len);\n   if (err)"
        },
        {
            "sha": "3dca040a2f716cab637a743b6afba6cd9f03f44a",
            "filename": "test/parallel/test-process-chdir-errormessage.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/cf37945b121d23c044cd04ac79cd5ab312a34cbe/test%2Fparallel%2Ftest-process-chdir-errormessage.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf37945b121d23c044cd04ac79cd5ab312a34cbe/test%2Fparallel%2Ftest-process-chdir-errormessage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-chdir-errormessage.js?ref=cf37945b121d23c044cd04ac79cd5ab312a34cbe",
            "patch": "@@ -11,6 +11,9 @@ common.expectsError(\n   {\n     type: Error,\n     code: 'ENOENT',\n-    message: \"ENOENT: no such file or directory, chdir 'does-not-exist'\",\n+    message: /ENOENT: no such file or directory, chdir .+ -> 'does-not-exist'/,\n+    path: process.cwd(),\n+    syscall: 'chdir',\n+    dest: 'does-not-exist'\n   }\n );"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 20,
        "deletions": 10
    }
}