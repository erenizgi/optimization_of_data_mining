{
    "author": "unknown",
    "message": "http: add options to http.createServer()\n\nThis adds the optional options argument to `http.createServer()`.\nIt contains two options: the `IncomingMessage` and `ServerReponse`\noption.\n\nPR-URL: https://github.com/nodejs/node/pull/15752\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>",
    "sha": "a899576c977aef32d85074ac09d511e4590e28d7",
    "files": [
        {
            "sha": "5659bb2edab3934cc0a7004bb742f64e0743472f",
            "filename": "doc/api/http.md",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/doc%2Fapi%2Fhttp.md",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/doc%2Fapi%2Fhttp.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp.md?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -1663,10 +1663,20 @@ A collection of all the standard HTTP response status codes, and the\n short description of each.  For example, `http.STATUS_CODES[404] === 'Not\n Found'`.\n \n-## http.createServer([requestListener])\n+## http.createServer([options][, requestListener])\n <!-- YAML\n added: v0.1.13\n--->\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/15752\n+    description: The `options` argument is supported now.\n+-->\n+- `options` {Object}\n+  * `IncomingMessage` {http.IncomingMessage} Specifies the IncomingMessage class\n+    to be used. Useful for extending the original `IncomingMessage`. Defaults\n+    to: `IncomingMessage`\n+  * `ServerResponse` {http.ServerResponse} Specifies the ServerResponse class to\n+    be used. Useful for extending the original `ServerResponse`. Defaults to:\n+    `ServerResponse`\n - `requestListener` {Function}\n \n * Returns: {http.Server}"
        },
        {
            "sha": "c1daf77dbf461707dd86d2e33b9f304576443848",
            "filename": "doc/api/https.md",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/doc%2Fapi%2Fhttps.md",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/doc%2Fapi%2Fhttps.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttps.md?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -65,7 +65,8 @@ See [`http.Server#keepAliveTimeout`][].\n <!-- YAML\n added: v0.3.4\n -->\n-- `options` {Object} Accepts `options` from [`tls.createServer()`][] and [`tls.createSecureContext()`][].\n+- `options` {Object} Accepts `options` from [`tls.createServer()`][],\n+ [`tls.createSecureContext()`][] and [`http.createServer()`][].\n - `requestListener` {Function} A listener to be added to the `request` event.\n \n Example:\n@@ -256,6 +257,7 @@ const req = https.request(options, (res) => {\n [`http.Server#setTimeout()`]: http.html#http_server_settimeout_msecs_callback\n [`http.Server#timeout`]: http.html#http_server_timeout\n [`http.Server`]: http.html#http_class_http_server\n+[`http.createServer()`]: http.html#httpcreateserveroptions-requestlistener\n [`http.close()`]: http.html#http_server_close_callback\n [`http.get()`]: http.html#http_http_get_options_callback\n [`http.request()`]: http.html#http_http_request_options_callback"
        },
        {
            "sha": "a7e8b0c59b8854dea7f284c3a3dbc5c5ef9f128e",
            "filename": "lib/_http_common.js",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/lib%2F_http_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/lib%2F_http_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_common.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -34,6 +34,7 @@ const {\n \n const debug = require('util').debuglog('http');\n \n+const kIncomingMessage = Symbol('IncomingMessage');\n const kOnHeaders = HTTPParser.kOnHeaders | 0;\n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;\n const kOnBody = HTTPParser.kOnBody | 0;\n@@ -73,7 +74,11 @@ function parserOnHeadersComplete(versionMajor, versionMinor, headers, method,\n     parser._url = '';\n   }\n \n-  parser.incoming = new IncomingMessage(parser.socket);\n+  // Parser is also used by http client\n+  var ParserIncomingMessage = parser.socket && parser.socket.server ?\n+    parser.socket.server[kIncomingMessage] : IncomingMessage;\n+\n+  parser.incoming = new ParserIncomingMessage(parser.socket);\n   parser.incoming.httpVersionMajor = versionMajor;\n   parser.incoming.httpVersionMinor = versionMinor;\n   parser.incoming.httpVersion = `${versionMajor}.${versionMinor}`;\n@@ -300,5 +305,6 @@ module.exports = {\n   freeParser,\n   httpSocketSetup,\n   methods,\n-  parsers\n+  parsers,\n+  kIncomingMessage\n };"
        },
        {
            "sha": "111a8525c47d6297d47e2a34eee54b948c86d049",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -33,6 +33,7 @@ const {\n   continueExpression,\n   chunkExpression,\n   httpSocketSetup,\n+  kIncomingMessage,\n   _checkInvalidHeaderChar: checkInvalidHeaderChar\n } = require('_http_common');\n const { OutgoingMessage } = require('_http_outgoing');\n@@ -41,9 +42,12 @@ const {\n   defaultTriggerAsyncIdScope,\n   getOrSetAsyncId\n } = require('internal/async_hooks');\n+const { IncomingMessage } = require('_http_incoming');\n const errors = require('internal/errors');\n const Buffer = require('buffer').Buffer;\n \n+const kServerResponse = Symbol('ServerResponse');\n+\n const STATUS_CODES = {\n   100: 'Continue',\n   101: 'Switching Protocols',\n@@ -263,9 +267,19 @@ function writeHead(statusCode, reason, obj) {\n // Docs-only deprecated: DEP0063\n ServerResponse.prototype.writeHeader = ServerResponse.prototype.writeHead;\n \n+function Server(options, requestListener) {\n+  if (!(this instanceof Server)) return new Server(options, requestListener);\n+\n+  if (typeof options === 'function') {\n+    requestListener = options;\n+    options = {};\n+  } else if (options == null || typeof options === 'object') {\n+    options = util._extend({}, options);\n+  }\n+\n+  this[kIncomingMessage] = options.IncomingMessage || IncomingMessage;\n+  this[kServerResponse] = options.ServerResponse || ServerResponse;\n \n-function Server(requestListener) {\n-  if (!(this instanceof Server)) return new Server(requestListener);\n   net.Server.call(this, { allowHalfOpen: true });\n \n   if (requestListener) {\n@@ -587,7 +601,7 @@ function parserOnIncoming(server, socket, state, req, keepAlive) {\n     }\n   }\n \n-  var res = new ServerResponse(req);\n+  var res = new server[kServerResponse](req);\n   res._onPendingData = updateOutgoingData.bind(undefined, socket, state);\n \n   res.shouldKeepAlive = keepAlive;\n@@ -690,5 +704,6 @@ module.exports = {\n   STATUS_CODES,\n   Server,\n   ServerResponse,\n-  _connectionListener: connectionListener\n+  _connectionListener: connectionListener,\n+  kServerResponse\n };"
        },
        {
            "sha": "741ce84d2f88208465c20443e11addaf0b3ecf86",
            "filename": "lib/https.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/lib%2Fhttps.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/lib%2Fhttps.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttps.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -36,6 +36,9 @@ const { inherits } = util;\n const debug = util.debuglog('https');\n const { urlToOptions, searchParamsSymbol } = require('internal/url');\n const errors = require('internal/errors');\n+const { IncomingMessage, ServerResponse } = require('http');\n+const { kIncomingMessage } = require('_http_common');\n+const { kServerResponse } = require('_http_server');\n \n function Server(opts, requestListener) {\n   if (!(this instanceof Server)) return new Server(opts, requestListener);\n@@ -57,6 +60,9 @@ function Server(opts, requestListener) {\n     opts.ALPNProtocols = ['http/1.1'];\n   }\n \n+  this[kIncomingMessage] = opts.IncomingMessage || IncomingMessage;\n+  this[kServerResponse] = opts.ServerResponse || ServerResponse;\n+\n   tls.Server.call(this, opts, _connectionListener);\n \n   this.httpAllowHalfOpen = false;"
        },
        {
            "sha": "a4bfa1b7646fc6716d21aff3aeff16f7677a228d",
            "filename": "test/parallel/test-http-server-options-incoming-message.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-http-server-options-incoming-message.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-http-server-options-incoming-message.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-server-options-incoming-message.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -0,0 +1,41 @@\n+'use strict';\n+\n+/**\n+ * This test covers http.Server({ IncomingMessage }) option:\n+ * With IncomingMessage option the server should use\n+ * the new class for creating req Object instead of the default\n+ * http.IncomingMessage.\n+ */\n+const common = require('../common');\n+const assert = require('assert');\n+const http = require('http');\n+\n+class MyIncomingMessage extends http.IncomingMessage {\n+  getUserAgent() {\n+    return this.headers['user-agent'] || 'unknown';\n+  }\n+}\n+\n+const server = http.Server({\n+  IncomingMessage: MyIncomingMessage\n+}, common.mustCall(function(req, res) {\n+  assert.strictEqual(req.getUserAgent(), 'node-test');\n+  res.statusCode = 200;\n+  res.end();\n+}));\n+server.listen();\n+\n+server.on('listening', function makeRequest() {\n+  http.get({\n+    port: this.address().port,\n+    headers: {\n+      'User-Agent': 'node-test'\n+    }\n+  }, (res) => {\n+    assert.strictEqual(res.statusCode, 200);\n+    res.on('end', () => {\n+      server.close();\n+    });\n+    res.resume();\n+  });\n+});"
        },
        {
            "sha": "f5adf39bed6d16e00edcac6a8b14e11a97c5685d",
            "filename": "test/parallel/test-http-server-options-server-response.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-http-server-options-server-response.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-http-server-options-server-response.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-server-options-server-response.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+/**\n+ * This test covers http.Server({ ServerResponse }) option:\n+ * With ServerResponse option the server should use\n+ * the new class for creating res Object instead of the default\n+ * http.ServerResponse.\n+ */\n+const common = require('../common');\n+const assert = require('assert');\n+const http = require('http');\n+\n+class MyServerResponse extends http.ServerResponse {\n+  status(code) {\n+    return this.writeHead(code, { 'Content-Type': 'text/plain' });\n+  }\n+}\n+\n+const server = http.Server({\n+  ServerResponse: MyServerResponse\n+}, common.mustCall(function(req, res) {\n+  res.status(200);\n+  res.end();\n+}));\n+server.listen();\n+\n+server.on('listening', function makeRequest() {\n+  http.get({ port: this.address().port }, (res) => {\n+    assert.strictEqual(res.statusCode, 200);\n+    res.on('end', () => {\n+      server.close();\n+    });\n+    res.resume();\n+  });\n+});"
        },
        {
            "sha": "102ee56751b8005088777452b308b99be9fcd1b5",
            "filename": "test/parallel/test-https-server-options-incoming-message.js",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-https-server-options-incoming-message.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-https-server-options-incoming-message.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-server-options-incoming-message.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -0,0 +1,51 @@\n+'use strict';\n+\n+/**\n+ * This test covers http.Server({ IncomingMessage }) option:\n+ * With IncomingMessage option the server should use\n+ * the new class for creating req Object instead of the default\n+ * http.IncomingMessage.\n+ */\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const http = require('http');\n+const https = require('https');\n+\n+class MyIncomingMessage extends http.IncomingMessage {\n+  getUserAgent() {\n+    return this.headers['user-agent'] || 'unknown';\n+  }\n+}\n+\n+const server = https.createServer({\n+  key: fixtures.readKey('agent1-key.pem'),\n+  cert: fixtures.readKey('agent1-cert.pem'),\n+  ca: fixtures.readKey('ca1-cert.pem'),\n+  IncomingMessage: MyIncomingMessage\n+}, common.mustCall(function(req, res) {\n+  assert.strictEqual(req.getUserAgent(), 'node-test');\n+  res.statusCode = 200;\n+  res.end();\n+}));\n+server.listen();\n+\n+server.on('listening', function makeRequest() {\n+  https.get({\n+    port: this.address().port,\n+    rejectUnauthorized: false,\n+    headers: {\n+      'User-Agent': 'node-test'\n+    }\n+  }, (res) => {\n+    assert.strictEqual(res.statusCode, 200);\n+    res.on('end', () => {\n+      server.close();\n+    });\n+    res.resume();\n+  });\n+});"
        },
        {
            "sha": "8745415f8b659688893ead5f5b2299bbefb2b02f",
            "filename": "test/parallel/test-https-server-options-server-response.js",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-https-server-options-server-response.js",
            "raw_url": "https://github.com/nodejs/node/raw/a899576c977aef32d85074ac09d511e4590e28d7/test%2Fparallel%2Ftest-https-server-options-server-response.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-server-options-server-response.js?ref=a899576c977aef32d85074ac09d511e4590e28d7",
            "patch": "@@ -0,0 +1,47 @@\n+'use strict';\n+\n+/**\n+ * This test covers http.Server({ ServerResponse }) option:\n+ * With ServerResponse option the server should use\n+ * the new class for creating res Object instead of the default\n+ * http.ServerResponse.\n+ */\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const http = require('http');\n+const https = require('https');\n+\n+class MyServerResponse extends http.ServerResponse {\n+  status(code) {\n+    return this.writeHead(code, { 'Content-Type': 'text/plain' });\n+  }\n+}\n+\n+const server = https.createServer({\n+  key: fixtures.readKey('agent1-key.pem'),\n+  cert: fixtures.readKey('agent1-cert.pem'),\n+  ca: fixtures.readKey('ca1-cert.pem'),\n+  ServerResponse: MyServerResponse\n+}, common.mustCall(function(req, res) {\n+  res.status(200);\n+  res.end();\n+}));\n+server.listen();\n+\n+server.on('listening', function makeRequest() {\n+  https.get({\n+    port: this.address().port,\n+    rejectUnauthorized: false\n+  }, (res) => {\n+    assert.strictEqual(res.statusCode, 200);\n+    res.on('end', () => {\n+      server.close();\n+    });\n+    res.resume();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 222,
        "deletions": 9
    }
}