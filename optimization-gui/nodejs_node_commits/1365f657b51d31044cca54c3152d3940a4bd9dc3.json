{
    "author": "addaleax",
    "message": "src: improve StreamBase read throughput\n\nImprove performance by providing JS with the raw ingridients\nfor the read data, i.e. an `ArrayBuffer` + offset + length\nfields, instead of creating `Buffer` instances in C++ land.\n\nPR-URL: https://github.com/nodejs/node/pull/23797\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1365f657b51d31044cca54c3152d3940a4bd9dc3",
    "files": [
        {
            "sha": "116cf57a23439313fbbfd62b99fa37bbb81e9173",
            "filename": "benchmark/net/tcp-raw-c2s.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-c2s.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-c2s.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-c2s.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -46,15 +46,15 @@ function main({ dur, len, type }) {\n       process.exit(0);\n     }, dur * 1000);\n \n-    clientHandle.onread = function(nread, buffer) {\n+    clientHandle.onread = function(buffer) {\n       // we're not expecting to ever get an EOF from the client.\n       // just lots of data forever.\n-      if (nread < 0)\n-        fail(nread, 'read');\n+      if (!buffer)\n+        fail('read');\n \n       // don't slice the buffer.  the point of this is to isolate, not\n       // simulate real traffic.\n-      bytes += buffer.length;\n+      bytes += buffer.byteLength;\n     };\n \n     clientHandle.readStart();"
        },
        {
            "sha": "7144c237af21b42aa5b084fdc997b3380ba7c6b9",
            "filename": "benchmark/net/tcp-raw-pipe.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-pipe.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -43,15 +43,15 @@ function main({ dur, len, type }) {\n     if (err)\n       fail(err, 'connect');\n \n-    clientHandle.onread = function(nread, buffer) {\n+    clientHandle.onread = function(buffer) {\n       // we're not expecting to ever get an EOF from the client.\n       // just lots of data forever.\n-      if (nread < 0)\n-        fail(nread, 'read');\n+      if (!buffer)\n+        fail('read');\n \n       const writeReq = new WriteWrap();\n       writeReq.async = false;\n-      err = clientHandle.writeBuffer(writeReq, buffer);\n+      err = clientHandle.writeBuffer(writeReq, Buffer.from(buffer));\n \n       if (err)\n         fail(err, 'write');\n@@ -89,11 +89,11 @@ function main({ dur, len, type }) {\n   if (err)\n     fail(err, 'connect');\n \n-  clientHandle.onread = function(nread, buffer) {\n-    if (nread < 0)\n-      fail(nread, 'read');\n+  clientHandle.onread = function(buffer) {\n+    if (!buffer)\n+      fail('read');\n \n-    bytes += buffer.length;\n+    bytes += buffer.byteLength;\n   };\n \n   connectReq.oncomplete = function(err) {"
        },
        {
            "sha": "fbb7d2520cfe3b4ea2c80eeeac2d91bb38e9eec7",
            "filename": "benchmark/net/tcp-raw-s2c.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-s2c.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/benchmark%2Fnet%2Ftcp-raw-s2c.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-s2c.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -109,15 +109,15 @@ function main({ dur, len, type }) {\n \n     connectReq.oncomplete = function() {\n       var bytes = 0;\n-      clientHandle.onread = function(nread, buffer) {\n+      clientHandle.onread = function(buffer) {\n         // we're not expecting to ever get an EOF from the client.\n         // just lots of data forever.\n-        if (nread < 0)\n-          fail(nread, 'read');\n+        if (!buffer)\n+          fail('read');\n \n         // don't slice the buffer.  the point of this is to isolate, not\n         // simulate real traffic.\n-        bytes += buffer.length;\n+        bytes += buffer.byteLength;\n       };\n \n       clientHandle.readStart();"
        },
        {
            "sha": "74d69de0dcdeee5b90a58a7787dbcef43c2bb437",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -22,7 +22,12 @@ const util = require('util');\n const assert = require('assert');\n \n const { Process } = internalBinding('process_wrap');\n-const { WriteWrap } = internalBinding('stream_wrap');\n+const {\n+  WriteWrap,\n+  kReadBytesOrError,\n+  kArrayBufferOffset,\n+  streamBaseState\n+} = internalBinding('stream_wrap');\n const { Pipe, constants: PipeConstants } = internalBinding('pipe_wrap');\n const { TCP } = internalBinding('tcp_wrap');\n const { TTY } = internalBinding('tty_wrap');\n@@ -486,11 +491,13 @@ function setupChannel(target, channel) {\n   var pendingHandle = null;\n   channel.buffering = false;\n   channel.pendingHandle = null;\n-  channel.onread = function(nread, pool) {\n+  channel.onread = function(arrayBuffer) {\n     const recvHandle = channel.pendingHandle;\n     channel.pendingHandle = null;\n-    // TODO(bnoordhuis) Check that nread > 0.\n-    if (pool) {\n+    if (arrayBuffer) {\n+      const nread = streamBaseState[kReadBytesOrError];\n+      const offset = streamBaseState[kArrayBufferOffset];\n+      const pool = new Uint8Array(arrayBuffer, offset, nread);\n       if (recvHandle)\n         pendingHandle = recvHandle;\n "
        },
        {
            "sha": "ded26644c590d5cd2ac0f715efab13eef001f1f6",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -120,7 +120,11 @@ const { isArrayBufferView } = require('internal/util/types');\n \n const { FileHandle } = process.binding('fs');\n const binding = internalBinding('http2');\n-const { ShutdownWrap } = internalBinding('stream_wrap');\n+const {\n+  ShutdownWrap,\n+  kReadBytesOrError,\n+  streamBaseState\n+} = internalBinding('stream_wrap');\n const { UV_EOF } = internalBinding('uv');\n \n const { StreamPipe } = internalBinding('stream_pipe');\n@@ -2043,7 +2047,8 @@ function onFileUnpipe() {\n \n // This is only called once the pipe has returned back control, so\n // it only has to handle errors and End-of-File.\n-function onPipedFileHandleRead(err) {\n+function onPipedFileHandleRead() {\n+  const err = streamBaseState[kReadBytesOrError];\n   if (err < 0 && err !== UV_EOF) {\n     this.stream.close(NGHTTP2_INTERNAL_ERROR);\n   }"
        },
        {
            "sha": "870b5b3e3b01a2dfe3a5c352629d53d0e63b7e2e",
            "filename": "lib/internal/stream_base_commons.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fstream_base_commons.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/lib%2Finternal%2Fstream_base_commons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstream_base_commons.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -1,7 +1,13 @@\n 'use strict';\n \n const { Buffer } = require('buffer');\n-const { WriteWrap } = internalBinding('stream_wrap');\n+const { FastBuffer } = require('internal/buffer');\n+const {\n+  WriteWrap,\n+  kReadBytesOrError,\n+  kArrayBufferOffset,\n+  streamBaseState\n+} = internalBinding('stream_wrap');\n const { UV_EOF } = internalBinding('uv');\n const { errnoException } = require('internal/errors');\n const { owner_symbol } = require('internal/async_hooks').symbols;\n@@ -84,13 +90,17 @@ function afterWriteDispatched(self, req, err, cb) {\n   }\n }\n \n-function onStreamRead(nread, buf) {\n+function onStreamRead(arrayBuffer) {\n+  const nread = streamBaseState[kReadBytesOrError];\n+\n   const handle = this;\n   const stream = this[owner_symbol];\n \n   stream[kUpdateTimer]();\n \n   if (nread > 0 && !stream.destroyed) {\n+    const offset = streamBaseState[kArrayBufferOffset];\n+    const buf = new FastBuffer(arrayBuffer, offset, nread);\n     if (!stream.push(buf)) {\n       handle.reading = false;\n       if (!stream.destroyed) {"
        },
        {
            "sha": "9d369d492c1cd1d95a18f8fedebd1a5ca5d66687",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -446,6 +446,11 @@ Environment::trace_category_state() {\n   return trace_category_state_;\n }\n \n+inline AliasedBuffer<int32_t, v8::Int32Array>&\n+Environment::stream_base_state() {\n+  return stream_base_state_;\n+}\n+\n inline uint32_t Environment::get_next_module_id() {\n   return module_id_counter_++;\n }"
        },
        {
            "sha": "9d8fd967a406a68eebeda903a979da8dd2790a2b",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -158,6 +158,7 @@ Environment::Environment(IsolateData* isolate_data,\n       makecallback_cntr_(0),\n       should_abort_on_uncaught_toggle_(isolate_, 1),\n       trace_category_state_(isolate_, kTraceCategoryCount),\n+      stream_base_state_(isolate_, StreamBase::kNumStreamBaseStateFields),\n       http_parser_buffer_(nullptr),\n       fs_stats_field_array_(isolate_, kFsStatsFieldsLength * 2),\n       fs_stats_field_bigint_array_(isolate_, kFsStatsFieldsLength * 2),"
        },
        {
            "sha": "a85058f895a4d8f39a17eb02c314edab8f220a2c",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -668,6 +668,7 @@ class Environment {\n   should_abort_on_uncaught_toggle();\n \n   inline AliasedBuffer<uint8_t, v8::Uint8Array>& trace_category_state();\n+  inline AliasedBuffer<int32_t, v8::Int32Array>& stream_base_state();\n \n   // The necessary API for async_hooks.\n   inline double new_async_id();\n@@ -951,6 +952,8 @@ class Environment {\n   AliasedBuffer<uint8_t, v8::Uint8Array> trace_category_state_;\n   std::unique_ptr<TrackingTraceStateObserver> trace_state_observer_;\n \n+  AliasedBuffer<int32_t, v8::Int32Array> stream_base_state_;\n+\n   std::unique_ptr<performance::performance_state> performance_state_;\n   std::unordered_map<std::string, uint64_t> performance_marks_;\n "
        },
        {
            "sha": "ce5523a9d22aa89079a21e52e6519c563d427502",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -1256,10 +1256,7 @@ void Http2StreamListener::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n   CHECK_LE(offset, session->stream_buf_.len);\n   CHECK_LE(offset + buf.len, session->stream_buf_.len);\n \n-  Local<Object> buffer =\n-      Buffer::New(env, session->stream_buf_ab_, offset, nread).ToLocalChecked();\n-\n-  stream->CallJSOnreadMethod(nread, buffer);\n+  stream->CallJSOnreadMethod(nread, session->stream_buf_ab_, offset);\n }\n \n "
        },
        {
            "sha": "57713d5eaf30d34ef36b74a23fa5737f6d1dbcd7",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 8,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -17,6 +17,7 @@\n namespace node {\n \n using v8::Array;\n+using v8::ArrayBuffer;\n using v8::Boolean;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n@@ -303,17 +304,29 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-void StreamBase::CallJSOnreadMethod(ssize_t nread, Local<Object> buf) {\n+void StreamBase::CallJSOnreadMethod(ssize_t nread,\n+                                    Local<ArrayBuffer> ab,\n+                                    size_t offset) {\n   Environment* env = env_;\n \n+#ifdef DEBUG\n+  CHECK_EQ(static_cast<int32_t>(nread), nread);\n+  CHECK_EQ(static_cast<int32_t>(offset), offset);\n+\n+  if (ab.IsEmpty()) {\n+    CHECK_EQ(offset, 0);\n+    CHECK_LE(nread, 0);\n+  } else {\n+    CHECK_GE(nread, 0);\n+  }\n+#endif\n+  env->stream_base_state()[kReadBytesOrError] = nread;\n+  env->stream_base_state()[kArrayBufferOffset] = offset;\n+\n   Local<Value> argv[] = {\n-    Integer::New(env->isolate(), nread),\n-    buf\n+    ab.IsEmpty() ? Undefined(env->isolate()).As<Value>() : ab.As<Value>()\n   };\n \n-  if (argv[1].IsEmpty())\n-    argv[1] = Undefined(env->isolate());\n-\n   AsyncWrap* wrap = GetAsyncWrap();\n   CHECK_NOT_NULL(wrap);\n   wrap->MakeCallback(env->onread_string(), arraysize(argv), argv);\n@@ -366,14 +379,18 @@ void EmitToJSStreamListener::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n   if (nread <= 0)  {\n     free(buf.base);\n     if (nread < 0)\n-      stream->CallJSOnreadMethod(nread, Local<Object>());\n+      stream->CallJSOnreadMethod(nread, Local<ArrayBuffer>());\n     return;\n   }\n \n   CHECK_LE(static_cast<size_t>(nread), buf.len);\n   char* base = Realloc(buf.base, nread);\n \n-  Local<Object> obj = Buffer::New(env, base, nread).ToLocalChecked();\n+  Local<ArrayBuffer> obj = ArrayBuffer::New(\n+      env->isolate(),\n+      base,\n+      nread,\n+      v8::ArrayBufferCreationMode::kInternalized);  // Transfer ownership to V8.\n   stream->CallJSOnreadMethod(nread, obj);\n }\n "
        },
        {
            "sha": "039009e07257b6ef4310609e69991f6563aafc76",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -264,7 +264,9 @@ class StreamBase : public StreamResource {\n   virtual bool IsIPCPipe();\n   virtual int GetFD();\n \n-  void CallJSOnreadMethod(ssize_t nread, v8::Local<v8::Object> buf);\n+  void CallJSOnreadMethod(ssize_t nread,\n+                          v8::Local<v8::ArrayBuffer> ab,\n+                          size_t offset = 0);\n \n   // This is named `stream_env` to avoid name clashes, because a lot of\n   // subclasses are also `BaseObject`s.\n@@ -326,12 +328,20 @@ class StreamBase : public StreamResource {\n       const v8::FunctionCallbackInfo<v8::Value>& args)>\n   static void JSMethod(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n+  // Internal, used only in StreamBase methods + env.cc.\n+  enum StreamBaseStateFields {\n+    kReadBytesOrError,\n+    kArrayBufferOffset,\n+    kNumStreamBaseStateFields\n+  };\n+\n  private:\n   Environment* env_;\n   EmitToJSStreamListener default_listener_;\n \n   friend class WriteWrap;\n   friend class ShutdownWrap;\n+  friend class Environment;  // For kNumStreamBaseStateFields.\n };\n \n "
        },
        {
            "sha": "a3c45b940a53eba5cd91238de718c410661417b4",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -80,6 +80,11 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n   target->Set(writeWrapString,\n               ww->GetFunction(env->context()).ToLocalChecked());\n   env->set_write_wrap_template(ww->InstanceTemplate());\n+\n+  NODE_DEFINE_CONSTANT(target, kReadBytesOrError);\n+  NODE_DEFINE_CONSTANT(target, kArrayBufferOffset);\n+  target->Set(context, FIXED_ONE_BYTE_STRING(env->isolate(), \"streamBaseState\"),\n+              env->stream_base_state().GetJSArray()).FromJust();\n }\n \n "
        },
        {
            "sha": "b488f16510f7cffe1334f24efcbc5bc3db833bbe",
            "filename": "test/parallel/test-net-end-close.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-net-end-close.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-net-end-close.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-end-close.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -6,11 +6,15 @@ const net = require('net');\n \n const { internalBinding } = require('internal/test/binding');\n const { UV_EOF } = internalBinding('uv');\n+const { streamBaseState, kReadBytesOrError } = internalBinding('stream_wrap');\n \n const s = new net.Socket({\n   handle: {\n     readStart: function() {\n-      setImmediate(() => this.onread(UV_EOF, null));\n+      setImmediate(() => {\n+        streamBaseState[kReadBytesOrError] = UV_EOF;\n+        this.onread();\n+      });\n     },\n     close: (cb) => setImmediate(cb)\n   },"
        },
        {
            "sha": "ef9075e9158229d7467941d99d77c6829ec33649",
            "filename": "test/parallel/test-process-wrap.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-process-wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-process-wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-wrap.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -44,11 +44,10 @@ p.onexit = function(exitCode, signal) {\n   processExited = true;\n };\n \n-pipe.onread = function(err, b, off, len) {\n+pipe.onread = function(arrayBuffer) {\n   assert.ok(processExited);\n-  if (b) {\n+  if (arrayBuffer) {\n     gotPipeData = true;\n-    console.log('read %d', len);\n   } else {\n     gotPipeEOF = true;\n     pipe.close();"
        },
        {
            "sha": "72981b683ccea3f49c15a9e244f47eab41321c4c",
            "filename": "test/parallel/test-tcp-wrap-listen.js",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-tcp-wrap-listen.js",
            "raw_url": "https://github.com/nodejs/node/raw/1365f657b51d31044cca54c3152d3940a4bd9dc3/test%2Fparallel%2Ftest-tcp-wrap-listen.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tcp-wrap-listen.js?ref=1365f657b51d31044cca54c3152d3940a4bd9dc3",
            "patch": "@@ -5,7 +5,12 @@ const assert = require('assert');\n \n const { internalBinding } = require('internal/test/binding');\n const { TCP, constants: TCPConstants } = internalBinding('tcp_wrap');\n-const { WriteWrap } = internalBinding('stream_wrap');\n+const {\n+  WriteWrap,\n+  kReadBytesOrError,\n+  kArrayBufferOffset,\n+  streamBaseState\n+} = internalBinding('stream_wrap');\n \n const server = new TCP(TCPConstants.SOCKET);\n \n@@ -30,8 +35,11 @@ server.onconnection = (err, client) => {\n \n   client.readStart();\n   client.pendingWrites = [];\n-  client.onread = common.mustCall((err, buffer) => {\n-    if (buffer) {\n+  client.onread = common.mustCall((arrayBuffer) => {\n+    if (arrayBuffer) {\n+      const offset = streamBaseState[kArrayBufferOffset];\n+      const nread = streamBaseState[kReadBytesOrError];\n+      const buffer = Buffer.from(arrayBuffer, offset, nread);\n       assert.ok(buffer.length > 0);\n \n       assert.strictEqual(client.writeQueueSize, 0);"
        }
    ],
    "stats": {
        "total": 159,
        "additions": 115,
        "deletions": 44
    }
}