{
    "author": "joyeecheung",
    "message": "fs: throw futimesSync errors in JS\n\nPR-URL: https://github.com/nodejs/node/pull/19041\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "49dd80935c68ce26dd56d0c0ec59c37c2d92dd10",
    "files": [
        {
            "sha": "2dcfb25348fe8c4cbf4c0824fda565689b2eacf1",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=49dd80935c68ce26dd56d0c0ec59c37c2d92dd10",
            "patch": "@@ -1183,7 +1183,9 @@ fs.futimesSync = function(fd, atime, mtime) {\n   validateUint32(fd, 'fd');\n   atime = toUnixTimestamp(atime, 'atime');\n   mtime = toUnixTimestamp(mtime, 'mtime');\n-  binding.futimes(fd, atime, mtime);\n+  const ctx = {};\n+  binding.futimes(fd, atime, mtime, undefined, ctx);\n+  handleErrorFromBinding(ctx);\n };\n \n function writeAll(fd, isUserFd, buffer, offset, length, position, callback) {"
        },
        {
            "sha": "dc9027cd5d9c9e82bc32c8f4a798afe62d7478ad",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=49dd80935c68ce26dd56d0c0ec59c37c2d92dd10",
            "patch": "@@ -1622,20 +1622,27 @@ static void UTimes(const FunctionCallbackInfo<Value>& args) {\n static void FUTimes(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n+  const int argc = args.Length();\n+  CHECK_GE(argc, 3);\n+\n   CHECK(args[0]->IsInt32());\n+  const int fd = args[0].As<Int32>()->Value();\n+\n   CHECK(args[1]->IsNumber());\n-  CHECK(args[2]->IsNumber());\n+  const double atime = args[1].As<Number>()->Value();\n \n-  const int fd = args[0]->Int32Value();\n-  const double atime = static_cast<double>(args[1]->NumberValue());\n-  const double mtime = static_cast<double>(args[2]->NumberValue());\n+  CHECK(args[2]->IsNumber());\n+  const double mtime = args[2].As<Number>()->Value();\n \n   FSReqBase* req_wrap = GetReqWrap(env, args[3]);\n-  if (req_wrap != nullptr) {\n+  if (req_wrap != nullptr) {  // futimes(fd, atime, mtime, req)\n     AsyncCall(env, req_wrap, args, \"futime\", UTF8, AfterNoArgs,\n               uv_fs_futime, fd, atime, mtime);\n-  } else {\n-    SYNC_CALL(futime, 0, fd, atime, mtime);\n+  } else {  // futimes(fd, atime, mtime, undefined, ctx)\n+    CHECK_EQ(argc, 5);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[4], &req_wrap, \"futime\",\n+             uv_fs_futime, fd, atime, mtime);\n   }\n }\n "
        },
        {
            "sha": "61e51585a028c2ff14d2a5a62571c7ac1bd98ccd",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/49dd80935c68ce26dd56d0c0ec59c37c2d92dd10/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=49dd80935c68ce26dd56d0c0ec59c37c2d92dd10",
            "patch": "@@ -811,3 +811,24 @@ if (!common.isWindows) {\n     );\n   });\n }\n+\n+\n+// futimes\n+if (!common.isAIX) {\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, futime');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'futime');\n+    return true;\n+  };\n+\n+  common.runWithInvalidFD((fd) => {\n+    fs.futimes(fd, new Date(), new Date(), common.mustCall(validateError));\n+\n+    assert.throws(\n+      () => fs.futimesSync(fd, new Date(), new Date()),\n+      validateError\n+    );\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}