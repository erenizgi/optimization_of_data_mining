{
    "author": "oyyd",
    "message": "test: add a test for `tls.Socket` with `allowHalfOpen`\n\nThis test ensures that a tls client socket using `StreamWrap` with\n`allowHalfOpen` option won't hang.\n\nPR-URL: https://github.com/nodejs/node/pull/23866\nRefs: https://github.com/nodejs/node/pull/23654\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "aa82a21c3aa706036451775e7e0a9a487e2bf922",
    "files": [
        {
            "sha": "c184e902b426855488d87d4de1919bd4c564bb51",
            "filename": "test/parallel/test-tls-net-socket-keepalive.js",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/aa82a21c3aa706036451775e7e0a9a487e2bf922/test%2Fparallel%2Ftest-tls-net-socket-keepalive.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa82a21c3aa706036451775e7e0a9a487e2bf922/test%2Fparallel%2Ftest-tls-net-socket-keepalive.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-net-socket-keepalive.js?ref=aa82a21c3aa706036451775e7e0a9a487e2bf922",
            "patch": "@@ -0,0 +1,53 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const fixtures = require('../common/fixtures');\n+const tls = require('tls');\n+const net = require('net');\n+\n+// This test ensures that when tls sockets are created with `allowHalfOpen`,\n+// they won't hang.\n+const key = fixtures.readKey('agent1-key.pem');\n+const cert = fixtures.readKey('agent1-cert.pem');\n+const ca = fixtures.readKey('ca1-cert.pem');\n+const options = {\n+  key,\n+  cert,\n+  ca: [ca],\n+};\n+\n+const server = tls.createServer(options, common.mustCall((conn) => {\n+  conn.write('hello');\n+  conn.on('data', common.mustCall());\n+  conn.end();\n+})).listen(0, common.mustCall(() => {\n+  const netSocket = new net.Socket({\n+    allowHalfOpen: true,\n+  });\n+\n+  const socket = tls.connect({\n+    socket: netSocket,\n+    rejectUnauthorized: false,\n+  });\n+\n+  const { port, address } = server.address();\n+\n+  // Doing `net.Socket.connect()` after `tls.connect()` will make tls module\n+  // wrap the socket in StreamWrap.\n+  netSocket.connect({\n+    port,\n+    address,\n+  });\n+\n+  socket.on('end', common.mustCall());\n+  socket.on('data', common.mustCall());\n+  socket.on('close', common.mustCall(() => {\n+    server.close();\n+  }));\n+\n+  socket.write('hello');\n+  socket.end();\n+}));"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 53,
        "deletions": 0
    }
}