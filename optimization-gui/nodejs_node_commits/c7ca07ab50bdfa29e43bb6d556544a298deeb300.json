{
    "author": "unknown",
    "message": "stream: avoid writeAfterEnd() while ending\n\nCalling `writable.end()` will probably synchronously call\n`writable.write()`, in such a situation the `state.ended`\nis false and `writable.write()` doesn't trigger `writeAfterEnd()`.\n\nPR-URL: https://github.com/nodejs/node/pull/18170\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "c7ca07ab50bdfa29e43bb6d556544a298deeb300",
    "files": [
        {
            "sha": "154c87bf5c72618966795659c879b19de38dbbde",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c7ca07ab50bdfa29e43bb6d556544a298deeb300/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/c7ca07ab50bdfa29e43bb6d556544a298deeb300/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=c7ca07ab50bdfa29e43bb6d556544a298deeb300",
            "patch": "@@ -273,7 +273,7 @@ Writable.prototype.write = function(chunk, encoding, cb) {\n   if (typeof cb !== 'function')\n     cb = nop;\n \n-  if (state.ended)\n+  if (state.ending)\n     writeAfterEnd(this, cb);\n   else if (isBuf || validChunk(this, state, chunk, cb)) {\n     state.pendingcb++;"
        },
        {
            "sha": "c0bb60f925cfd8cfb5f3eafc1d7af571bfdd2649",
            "filename": "test/parallel/test-stream-writable-write-writev-finish.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/c7ca07ab50bdfa29e43bb6d556544a298deeb300/test%2Fparallel%2Ftest-stream-writable-write-writev-finish.js",
            "raw_url": "https://github.com/nodejs/node/raw/c7ca07ab50bdfa29e43bb6d556544a298deeb300/test%2Fparallel%2Ftest-stream-writable-write-writev-finish.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-writable-write-writev-finish.js?ref=c7ca07ab50bdfa29e43bb6d556544a298deeb300",
            "patch": "@@ -154,3 +154,27 @@ const stream = require('stream');\n   };\n   rs.pipe(ws);\n }\n+\n+{\n+  const w = new stream.Writable();\n+  w._write = (chunk, encoding, cb) => {\n+    process.nextTick(cb);\n+  };\n+  w.on('error', common.mustCall());\n+  w.on('prefinish', () => {\n+    w.write(\"shouldn't write in prefinish listener\");\n+  });\n+  w.end();\n+}\n+\n+{\n+  const w = new stream.Writable();\n+  w._write = (chunk, encoding, cb) => {\n+    process.nextTick(cb);\n+  };\n+  w.on('error', common.mustCall());\n+  w.on('finish', () => {\n+    w.write(\"should't write in finish listener\");\n+  });\n+  w.end();\n+}"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 25,
        "deletions": 1
    }
}