{
    "author": "oyyd",
    "message": "tls: load NODE_EXTRA_CA_CERTS at startup\n\nThis commit makes node load extra certificates at startup instead\nof first use.\n\nPR-URL: https://github.com/nodejs/node/pull/23354\nFixes: https://github.com/nodejs/node/issues/20434\nRefs: https://github.com/nodejs/node/issues/20432\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "87719d792b855e4278dbd3ca209592d83e80ac37",
    "files": [
        {
            "sha": "bd8d9e0325546bf232e350978864cdb0a089fe65",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 34,
            "deletions": 21,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/87719d792b855e4278dbd3ca209592d83e80ac37/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/87719d792b855e4278dbd3ca209592d83e80ac37/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=87719d792b855e4278dbd3ca209592d83e80ac37",
            "patch": "@@ -116,10 +116,10 @@ static const char* const root_certs[] = {\n \n static const char system_cert_path[] = NODE_OPENSSL_SYSTEM_CERT_PATH;\n \n-static std::string extra_root_certs_file;  // NOLINT(runtime/string)\n-\n static X509_STORE* root_cert_store;\n \n+static bool extra_root_certs_loaded = false;\n+\n // Just to generate static methods\n template void SSLWrap<TLSWrap>::AddMethods(Environment* env,\n                                            Local<FunctionTemplate> t);\n@@ -832,11 +832,6 @@ void SecureContext::AddCRL(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-void UseExtraCaCerts(const std::string& file) {\n-  extra_root_certs_file = file;\n-}\n-\n-\n static unsigned long AddCertsFromFile(  // NOLINT(runtime/int)\n     X509_STORE* store,\n     const char* file) {\n@@ -863,30 +858,44 @@ static unsigned long AddCertsFromFile(  // NOLINT(runtime/int)\n   return err;\n }\n \n-void SecureContext::AddRootCerts(const FunctionCallbackInfo<Value>& args) {\n-  SecureContext* sc;\n-  ASSIGN_OR_RETURN_UNWRAP(&sc, args.Holder());\n+\n+void UseExtraCaCerts(const std::string& file) {\n   ClearErrorOnReturn clear_error_on_return;\n \n-  if (!root_cert_store) {\n+  if (root_cert_store == nullptr) {\n     root_cert_store = NewRootCertStore();\n \n-    if (!extra_root_certs_file.empty()) {\n+    if (!file.empty()) {\n       unsigned long err = AddCertsFromFile(  // NOLINT(runtime/int)\n                                            root_cert_store,\n-                                           extra_root_certs_file.c_str());\n+                                           file.c_str());\n       if (err) {\n-        // We do not call back into JS after this line anyway, so ignoring\n-        // the return value of ProcessEmitWarning does not affect how a\n-        // possible exception would be propagated.\n-        ProcessEmitWarning(sc->env(),\n-                           \"Ignoring extra certs from `%s`, \"\n-                           \"load failed: %s\\n\",\n-                           extra_root_certs_file.c_str(),\n-                           ERR_error_string(err, nullptr));\n+        fprintf(stderr,\n+                \"Warning: Ignoring extra certs from `%s`, load failed: %s\\n\",\n+                file.c_str(),\n+                ERR_error_string(err, nullptr));\n+      } else {\n+        extra_root_certs_loaded = true;\n       }\n     }\n   }\n+}\n+\n+\n+static void IsExtraRootCertsFileLoaded(\n+    const FunctionCallbackInfo<Value>& args) {\n+  return args.GetReturnValue().Set(extra_root_certs_loaded);\n+}\n+\n+\n+void SecureContext::AddRootCerts(const FunctionCallbackInfo<Value>& args) {\n+  SecureContext* sc;\n+  ASSIGN_OR_RETURN_UNWRAP(&sc, args.Holder());\n+  ClearErrorOnReturn clear_error_on_return;\n+\n+  if (root_cert_store == nullptr) {\n+    root_cert_store = NewRootCertStore();\n+  }\n \n   // Increment reference count so global store is not deleted along with CTX.\n   X509_STORE_up_ref(root_cert_store);\n@@ -5624,6 +5633,7 @@ void SetFipsCrypto(const FunctionCallbackInfo<Value>& args) {\n }\n #endif /* NODE_FIPS_MODE */\n \n+\n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n                 Local<Context> context,\n@@ -5644,6 +5654,9 @@ void Initialize(Local<Object> target,\n   env->SetMethodNoSideEffect(target, \"certVerifySpkac\", VerifySpkac);\n   env->SetMethodNoSideEffect(target, \"certExportPublicKey\", ExportPublicKey);\n   env->SetMethodNoSideEffect(target, \"certExportChallenge\", ExportChallenge);\n+  // Exposed for testing purposes only.\n+  env->SetMethodNoSideEffect(target, \"isExtraRootCertsFileLoaded\",\n+                             IsExtraRootCertsFileLoaded);\n \n   env->SetMethodNoSideEffect(target, \"ECDHConvertKey\", ConvertKey);\n #ifndef OPENSSL_NO_ENGINE"
        },
        {
            "sha": "fa97d7c0c6103fe747f92d2581c315feaaf16354",
            "filename": "test/parallel/test-tls-env-extra-ca-file-load.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/87719d792b855e4278dbd3ca209592d83e80ac37/test%2Fparallel%2Ftest-tls-env-extra-ca-file-load.js",
            "raw_url": "https://github.com/nodejs/node/raw/87719d792b855e4278dbd3ca209592d83e80ac37/test%2Fparallel%2Ftest-tls-env-extra-ca-file-load.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-env-extra-ca-file-load.js?ref=87719d792b855e4278dbd3ca209592d83e80ac37",
            "patch": "@@ -0,0 +1,40 @@\n+'use strict';\n+// Flags: --expose-internals\n+\n+const common = require('../common');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const tls = require('tls');\n+const fixtures = require('../common/fixtures');\n+const { internalBinding } = require('internal/test/binding');\n+const binding = internalBinding('crypto');\n+\n+const { fork } = require('child_process');\n+\n+// This test ensures that extra certificates are loaded at startup.\n+if (process.argv[2] !== 'child') {\n+  if (process.env.CHILD_USE_EXTRA_CA_CERTS === 'yes') {\n+    assert.strictEqual(binding.isExtraRootCertsFileLoaded(), true);\n+  } else if (process.env.CHILD_USE_EXTRA_CA_CERTS === 'no') {\n+    assert.strictEqual(binding.isExtraRootCertsFileLoaded(), false);\n+    tls.createServer({});\n+    assert.strictEqual(binding.isExtraRootCertsFileLoaded(), false);\n+  }\n+} else {\n+  const NODE_EXTRA_CA_CERTS = fixtures.path('keys', 'ca1-cert.pem');\n+  const extendsEnv = (obj) => Object.assign({}, process.env, obj);\n+\n+  [\n+    extendsEnv({ CHILD_USE_EXTRA_CA_CERTS: 'yes', NODE_EXTRA_CA_CERTS }),\n+    extendsEnv({ CHILD_USE_EXTRA_CA_CERTS: 'no' }),\n+  ].forEach((processEnv) => {\n+    fork(__filename, ['child'], { env: processEnv })\n+    .on('exit', common.mustCall((status) => {\n+      // client did not succeed in connecting\n+      assert.strictEqual(status, 0);\n+    }));\n+  });\n+}"
        },
        {
            "sha": "06399c5d239fc629c6026104ce69ffccc8b18c96",
            "filename": "test/parallel/test-tls-env-extra-ca-no-crypto.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/87719d792b855e4278dbd3ca209592d83e80ac37/test%2Fparallel%2Ftest-tls-env-extra-ca-no-crypto.js",
            "raw_url": "https://github.com/nodejs/node/raw/87719d792b855e4278dbd3ca209592d83e80ac37/test%2Fparallel%2Ftest-tls-env-extra-ca-no-crypto.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-env-extra-ca-no-crypto.js?ref=87719d792b855e4278dbd3ca209592d83e80ac37",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+const assert = require('assert');\n+const { fork } = require('child_process');\n+\n+// This test ensures that trying to load extra certs won't throw even when\n+// there is no crypto support, i.e., built with \"./configure --without-ssl\".\n+if (process.argv[2] === 'child') {\n+  // exit\n+} else {\n+  const NODE_EXTRA_CA_CERTS = fixtures.path('keys', 'ca1-cert.pem');\n+\n+  fork(\n+    __filename,\n+    ['child'],\n+    { env: Object.assign({}, process.env, { NODE_EXTRA_CA_CERTS }) },\n+  ).on('exit', common.mustCall(function(status) {\n+    // client did not succeed in connecting\n+    assert.strictEqual(status, 0);\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 96,
        "deletions": 21
    }
}