{
    "author": "addaleax",
    "message": "src: remove static variables from string_search\n\nThese variables can as well be stack-allocated. This avoids\nrelying on global state that is not protected by mutexes.\n\nThanks to Stephen Belanger for reviewing this change in its original PR.\n\nRefs: https://github.com/ayojs/ayo/pull/82\n\nPR-URL: https://github.com/nodejs/node/pull/20541\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "945da6d22d109b17597c2c3bc8ea7d25a12db904",
    "files": [
        {
            "sha": "aeb558d5662fefd47689030d0573f681c0fcfda5",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/945da6d22d109b17597c2c3bc8ea7d25a12db904/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/945da6d22d109b17597c2c3bc8ea7d25a12db904/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=945da6d22d109b17597c2c3bc8ea7d25a12db904",
            "patch": "@@ -346,7 +346,6 @@\n         'src/spawn_sync.cc',\n         'src/string_bytes.cc',\n         'src/string_decoder.cc',\n-        'src/string_search.cc',\n         'src/stream_base.cc',\n         'src/stream_pipe.cc',\n         'src/stream_wrap.cc',"
        },
        {
            "sha": "326fba7c4abf058a5c5b8b312b307942adf799db",
            "filename": "src/string_search.cc",
            "status": "removed",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/60349bbe0d90a91d66aa4ad71c4c2b0d3b08d54c/src%2Fstring_search.cc",
            "raw_url": "https://github.com/nodejs/node/raw/60349bbe0d90a91d66aa4ad71c4c2b0d3b08d54c/src%2Fstring_search.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_search.cc?ref=60349bbe0d90a91d66aa4ad71c4c2b0d3b08d54c",
            "patch": "@@ -1,11 +0,0 @@\n-#include \"string_search.h\"\n-\n-namespace node {\n-namespace stringsearch {\n-\n-int StringSearchBase::kBadCharShiftTable[kUC16AlphabetSize];\n-int StringSearchBase::kGoodSuffixShiftTable[kBMMaxShift + 1];\n-int StringSearchBase::kSuffixTable[kBMMaxShift + 1];\n-\n-}  // namespace stringsearch\n-}  // namespace node"
        },
        {
            "sha": "9c090da247aec8a6d5b2a8d46ce24d7d0be63230",
            "filename": "src/string_search.h",
            "status": "modified",
            "additions": 9,
            "deletions": 29,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/945da6d22d109b17597c2c3bc8ea7d25a12db904/src%2Fstring_search.h",
            "raw_url": "https://github.com/nodejs/node/raw/945da6d22d109b17597c2c3bc8ea7d25a12db904/src%2Fstring_search.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_search.h?ref=945da6d22d109b17597c2c3bc8ea7d25a12db904",
            "patch": "@@ -80,12 +80,12 @@ class StringSearchBase {\n   static const int kBMMinPatternLength = 8;\n \n   // Store for the BoyerMoore(Horspool) bad char shift table.\n-  static int kBadCharShiftTable[kUC16AlphabetSize];\n+  int bad_char_shift_table_[kUC16AlphabetSize];\n   // Store for the BoyerMoore good suffix shift table.\n-  static int kGoodSuffixShiftTable[kBMMaxShift + 1];\n+  int good_suffix_shift_table_[kBMMaxShift + 1];\n   // Table used temporarily while building the BoyerMoore good suffix\n   // shift table.\n-  static int kSuffixTable[kBMMaxShift + 1];\n+  int suffix_table_[kBMMaxShift + 1];\n };\n \n template <typename Char>\n@@ -152,26 +152,6 @@ class StringSearch : private StringSearchBase {\n     return bad_char_occurrence[equiv_class];\n   }\n \n-  // Store for the BoyerMoore(Horspool) bad char shift table.\n-  // Return a table covering the last kBMMaxShift+1 positions of\n-  // pattern.\n-  int* bad_char_table() { return kBadCharShiftTable; }\n-\n-  // Store for the BoyerMoore good suffix shift table.\n-  int* good_suffix_shift_table() {\n-    // Return biased pointer that maps the range  [start_..pattern_.length()\n-    // to the kGoodSuffixShiftTable array.\n-    return kGoodSuffixShiftTable - start_;\n-  }\n-\n-  // Table used temporarily while building the BoyerMoore good suffix\n-  // shift table.\n-  int* suffix_table() {\n-    // Return biased pointer that maps the range  [start_..pattern_.length()\n-    // to the kSuffixTable array.\n-    return kSuffixTable - start_;\n-  }\n-\n   // The pattern to search for.\n   Vector pattern_;\n   // Pointer to implementation of the search.\n@@ -345,8 +325,8 @@ size_t StringSearch<Char>::BoyerMooreSearch(\n   // Only preprocess at most kBMMaxShift last characters of pattern.\n   size_t start = start_;\n \n-  int* bad_char_occurrence = bad_char_table();\n-  int* good_suffix_shift = good_suffix_shift_table();\n+  int* bad_char_occurrence = bad_char_shift_table_;\n+  int* good_suffix_shift = good_suffix_shift_table_ - start_;\n \n   Char last_char = pattern_[pattern_length - 1];\n   size_t index = start_index;\n@@ -397,8 +377,8 @@ void StringSearch<Char>::PopulateBoyerMooreTable() {\n \n   // Biased tables so that we can use pattern indices as table indices,\n   // even if we only cover the part of the pattern from offset start.\n-  int* shift_table = good_suffix_shift_table();\n-  int* suffix_table = this->suffix_table();\n+  int* shift_table = good_suffix_shift_table_ - start_;\n+  int* suffix_table = suffix_table_ - start_;\n \n   // Initialize table.\n   for (size_t i = start; i < pattern_length; i++) {\n@@ -462,7 +442,7 @@ size_t StringSearch<Char>::BoyerMooreHorspoolSearch(\n     size_t start_index) {\n   const size_t subject_length = subject.length();\n   const size_t pattern_length = pattern_.length();\n-  int* char_occurrences = bad_char_table();\n+  int* char_occurrences = bad_char_shift_table_;\n   int64_t badness = -pattern_length;\n \n   // How bad we are doing without a good-suffix table.\n@@ -511,7 +491,7 @@ template <typename Char>\n void StringSearch<Char>::PopulateBoyerMooreHorspoolTable() {\n   const size_t pattern_length = pattern_.length();\n \n-  int* bad_char_occurrence = bad_char_table();\n+  int* bad_char_occurrence = bad_char_shift_table_;\n \n   // Only preprocess at most kBMMaxShift last characters of pattern.\n   const size_t start = start_;"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 9,
        "deletions": 41
    }
}