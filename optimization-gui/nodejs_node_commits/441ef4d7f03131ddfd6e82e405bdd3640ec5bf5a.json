{
    "author": "addaleax",
    "message": "n-api: do not call into JS when that is not allowed\n\nCheck whether calling into JS is allowed before doing so.\n\nPR-URL: https://github.com/nodejs/node/pull/26127\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
    "files": [
        {
            "sha": "094fc4afcc044c36c24970318d6c700726ad6522",
            "filename": "src/js_native_api_v8.h",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/src%2Fjs_native_api_v8.h",
            "raw_url": "https://github.com/nodejs/node/raw/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/src%2Fjs_native_api_v8.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_native_api_v8.h?ref=441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
            "patch": "@@ -11,6 +11,7 @@ struct napi_env__ {\n         context_persistent(isolate, context) {\n     CHECK_EQ(isolate, context->GetIsolate());\n   }\n+  virtual ~napi_env__() {}\n   v8::Isolate* const isolate;  // Shortcut for context()->GetIsolate()\n   v8impl::Persistent<v8::Context> context_persistent;\n \n@@ -21,6 +22,8 @@ struct napi_env__ {\n   inline void Ref() { refs++; }\n   inline void Unref() { if ( --refs == 0) delete this; }\n \n+  virtual bool can_call_into_js() const { return true; }\n+\n   v8impl::Persistent<v8::Value> last_exception;\n   napi_extended_error_info last_error;\n   int open_handle_scopes = 0;\n@@ -68,11 +71,12 @@ napi_status napi_set_last_error(napi_env env, napi_status error_code,\n   RETURN_STATUS_IF_FALSE((env), !((maybe).IsEmpty()), (status))\n \n // NAPI_PREAMBLE is not wrapped in do..while: try_catch must have function scope\n-#define NAPI_PREAMBLE(env)                                       \\\n-  CHECK_ENV((env));                                              \\\n-  RETURN_STATUS_IF_FALSE((env), (env)->last_exception.IsEmpty(), \\\n-                         napi_pending_exception);                \\\n-  napi_clear_last_error((env));                                  \\\n+#define NAPI_PREAMBLE(env)                                          \\\n+  CHECK_ENV((env));                                                 \\\n+  RETURN_STATUS_IF_FALSE((env),                                     \\\n+      (env)->last_exception.IsEmpty() && (env)->can_call_into_js(), \\\n+      napi_pending_exception);                                      \\\n+  napi_clear_last_error((env));                                     \\\n   v8impl::TryCatch try_catch((env))\n \n #define CHECK_TO_TYPE(env, type, context, result, src, status)                \\"
        },
        {
            "sha": "010fb3fe0ff840fb26d76aad50f7541d7bcad8fc",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
            "patch": "@@ -12,9 +12,14 @@ struct node_napi_env__ : public napi_env__ {\n       napi_env__(context) {\n     CHECK_NOT_NULL(node_env());\n   }\n+\n   inline node::Environment* node_env() const {\n     return node::Environment::GetCurrent(context());\n   }\n+\n+  bool can_call_into_js() const override {\n+    return node_env()->can_call_into_js();\n+  }\n };\n \n typedef node_napi_env__* node_napi_env;"
        },
        {
            "sha": "3a9465c7454148027f933aef89459b88772dd1ff",
            "filename": "test/node-api/test_worker_terminate/binding.gyp",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-api%2Ftest_worker_terminate%2Fbinding.gyp?ref=441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"targets\": [\n+    {\n+      \"target_name\": \"test_worker_terminate\",\n+      \"sources\": [ \"test_worker_terminate.c\" ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "2bfaab8e8eb0a9bf29d90c671b0576712a746627",
            "filename": "test/node-api/test_worker_terminate/test.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-api%2Ftest_worker_terminate%2Ftest.js?ref=441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
            "patch": "@@ -0,0 +1,23 @@\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const { Worker, isMainThread, workerData } = require('worker_threads');\n+\n+if (isMainThread) {\n+  const counter = new Int32Array(new SharedArrayBuffer(4));\n+  const worker = new Worker(__filename, { workerData: { counter } });\n+  worker.on('exit', common.mustCall(() => {\n+    assert.strictEqual(counter[0], 1);\n+  }));\n+  worker.on('error', common.mustNotCall());\n+} else {\n+  const { Test } = require(`./build/${common.buildType}/test_worker_terminate`);\n+\n+  const { counter } = workerData;\n+  // Test() tries to call a function twice and asserts that the second call does\n+  // not work because of a pending exception.\n+  Test(() => {\n+    Atomics.add(counter, 0, 1);\n+    process.exit();\n+  });\n+}"
        },
        {
            "sha": "a88d936293e2a84a4e41a3a52b750823ab11739f",
            "filename": "test/node-api/test_worker_terminate/test_worker_terminate.c",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Ftest_worker_terminate.c",
            "raw_url": "https://github.com/nodejs/node/raw/441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a/test%2Fnode-api%2Ftest_worker_terminate%2Ftest_worker_terminate.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-api%2Ftest_worker_terminate%2Ftest_worker_terminate.c?ref=441ef4d7f03131ddfd6e82e405bdd3640ec5bf5a",
            "patch": "@@ -0,0 +1,39 @@\n+#include <stdio.h>\n+#include <node_api.h>\n+#include <assert.h>\n+#include \"../../js-native-api/common.h\"\n+\n+napi_value Test(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value recv;\n+  napi_value argv[1];\n+  napi_status status;\n+\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, argv, &recv, NULL));\n+  NAPI_ASSERT(env, argc >= 1, \"Not enough arguments, expected 1.\");\n+\n+  napi_valuetype t;\n+  NAPI_CALL(env, napi_typeof(env, argv[0], &t));\n+  NAPI_ASSERT(env, t == napi_function,\n+      \"Wrong first argument, function expected.\");\n+\n+  status = napi_call_function(env, recv, argv[0], 0, NULL, NULL);\n+  assert(status == napi_ok);\n+  status = napi_call_function(env, recv, argv[0], 0, NULL, NULL);\n+  assert(status == napi_pending_exception);\n+\n+  return NULL;\n+}\n+\n+napi_value Init(napi_env env, napi_value exports) {\n+  napi_property_descriptor properties[] = {\n+    DECLARE_NAPI_PROPERTY(\"Test\", Test)\n+  };\n+\n+  NAPI_CALL(env, napi_define_properties(\n+      env, exports, sizeof(properties) / sizeof(*properties), properties));\n+\n+  return exports;\n+}\n+\n+NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 84,
        "deletions": 5
    }
}