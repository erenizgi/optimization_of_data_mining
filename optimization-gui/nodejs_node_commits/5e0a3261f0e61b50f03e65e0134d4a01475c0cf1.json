{
    "author": "thefourtheye",
    "message": "tools: make test.py Python 3 compatible\n\nPR-URL: https://github.com/nodejs/node/pull/25767\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: cclauss <cclauss@me.com>\nReviewed-By: gengjiawen <technicalcute@gmail.com>",
    "sha": "5e0a3261f0e61b50f03e65e0134d4a01475c0cf1",
    "files": [
        {
            "sha": "6f0e71a3d470a6ea03dd045b35acb6399f2d4760",
            "filename": "tools/test.py",
            "status": "modified",
            "additions": 22,
            "deletions": 15,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/5e0a3261f0e61b50f03e65e0134d4a01475c0cf1/tools%2Ftest.py",
            "raw_url": "https://github.com/nodejs/node/raw/5e0a3261f0e61b50f03e65e0134d4a01475c0cf1/tools%2Ftest.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Ftest.py?ref=5e0a3261f0e61b50f03e65e0134d4a01475c0cf1",
            "patch": "@@ -68,6 +68,12 @@ def cmp(x, y):  # Python 3\n except NameError:\n   xrange = range    # Python 3\n \n+try:\n+  from urllib.parse import unquote    # Python 3\n+except ImportError:\n+  from urllib import unquote          # Python 2\n+\n+\n logger = logging.getLogger('testrunner')\n skip_regex = re.compile(r'# SKIP\\S*\\s+(.*)', re.IGNORECASE)\n \n@@ -119,7 +125,7 @@ def Run(self, tasks):\n     # Spawn N-1 threads and then use this thread as the last one.\n     # That way -j1 avoids threading altogether which is a nice fallback\n     # in case of threading problems.\n-    for i in xrange(tasks - 1):\n+    for i in range(tasks - 1):\n       thread = threading.Thread(target=self.RunSingle, args=[True, i + 1])\n       threads.append(thread)\n       thread.start()\n@@ -755,7 +761,7 @@ def Execute(args, context, timeout=None, env={}, faketty=False, disable_core_fil\n     del env_copy[\"NODE_PATH\"]\n \n   # Extend environment\n-  for key, value in env.iteritems():\n+  for key, value in env.items():\n     env_copy[key] = value\n \n   preexec_fn = None\n@@ -808,7 +814,7 @@ def __init__(self, context, root, section):\n   def Contains(self, path, file):\n     if len(path) > len(file):\n       return False\n-    for i in xrange(len(path)):\n+    for i in range(len(path)):\n       if not path[i].match(NormalizePath(file[i])):\n         return False\n     return True\n@@ -1263,7 +1269,7 @@ def GetOutcomes(self, env, defs):\n   def Contains(self, path):\n     if len(self.path) > len(path):\n       return False\n-    for i in xrange(len(self.path)):\n+    for i in range(len(self.path)):\n       if not self.path[i].match(path[i]):\n         return False\n     return True\n@@ -1330,7 +1336,7 @@ def BuildOptions():\n       help='write test output to file. NOTE: this only applies the tap progress indicator')\n   result.add_option(\"-p\", \"--progress\",\n       help=\"The style of progress indicator (verbose, dots, color, mono, tap)\",\n-      choices=PROGRESS_INDICATORS.keys(), default=\"mono\")\n+      choices=list(PROGRESS_INDICATORS.keys()), default=\"mono\")\n   result.add_option(\"--report\", help=\"Print a summary of the tests to be run\",\n       default=False, action=\"store_true\")\n   result.add_option(\"-s\", \"--suite\", help=\"A test suite\",\n@@ -1403,15 +1409,15 @@ def ProcessOptions(options):\n   options.mode = options.mode.split(',')\n   options.run = options.run.split(',')\n   # Split at commas and filter out all the empty strings.\n-  options.skip_tests = filter(bool, options.skip_tests.split(','))\n+  options.skip_tests = [test for test in options.skip_tests.split(',') if test]\n   if options.run == [\"\"]:\n     options.run = None\n   elif len(options.run) != 2:\n     print(\"The run argument must be two comma-separated integers.\")\n     return False\n   else:\n     try:\n-      options.run = map(int, options.run)\n+      options.run = [int(level) for level in options.run]\n     except ValueError:\n       print(\"Could not parse the integers from the run argument.\")\n       return False\n@@ -1479,10 +1485,9 @@ def ExpandCommand(args):\n       return args\n     return ExpandCommand\n   else:\n-    pos = value.find('@')\n-    import urllib\n-    prefix = urllib.unquote(value[:pos]).split()\n-    suffix = urllib.unquote(value[pos+1:]).split()\n+    prefix, _, suffix = value.partition('@')\n+    prefix = unquote(prefix).split()\n+    suffix = unquote(suffix).split()\n     def ExpandCommand(args):\n       return prefix + args + suffix\n     return ExpandCommand\n@@ -1531,8 +1536,8 @@ def PrintCrashed(code):\n \n def ArgsToTestPaths(test_root, args, suites):\n   if len(args) == 0 or 'default' in args:\n-    def_suites = filter(lambda s: s not in IGNORED_SUITES, suites)\n-    args = filter(lambda a: a != 'default', args) + def_suites\n+    def_suites = [s for s in suites if s not in IGNORED_SUITES]\n+    args = [a for a in args if a != 'default'] + def_suites\n   subsystem_regex = re.compile(r'^[a-zA-Z-]*$')\n   check = lambda arg: subsystem_regex.match(arg) and (arg not in suites)\n   mapped_args = [\"*/test*-%s-*\" % arg if check(arg) else arg for arg in args]\n@@ -1699,7 +1704,9 @@ def should_keep(case):\n     else:\n       return True\n \n-  cases_to_run = filter(should_keep, all_cases)\n+  cases_to_run = [\n+    test_case for test_case in all_cases if should_keep(test_case)\n+  ]\n \n   if options.report:\n     print(REPORT_TEMPLATE % {\n@@ -1716,7 +1723,7 @@ def should_keep(case):\n     # can be different in different machines\n     cases_to_run.sort(key=lambda c: (c.arch, c.mode, c.file))\n     cases_to_run = [ cases_to_run[i] for i\n-                     in xrange(options.run[0],\n+                     in range(options.run[0],\n                                len(cases_to_run),\n                                options.run[1]) ]\n   if len(cases_to_run) == 0:"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 22,
        "deletions": 15
    }
}