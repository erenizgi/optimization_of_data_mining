{
    "author": "addaleax",
    "message": "test: refactor test-net-connect-memleak, move to parallel\n\nThis enables the test to run as part of the regular test suite.\n\nPR-URL: https://github.com/nodejs/node/pull/21794\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d06142af36f7907d20f84986cdd3b4e71c51c20b",
    "files": [
        {
            "sha": "afcc61f173509faf3ad836b118b791419f6a862d",
            "filename": "test/parallel/test-net-connect-memleak.js",
            "status": "renamed",
            "additions": 23,
            "deletions": 23,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/d06142af36f7907d20f84986cdd3b4e71c51c20b/test%2Fparallel%2Ftest-net-connect-memleak.js",
            "raw_url": "https://github.com/nodejs/node/raw/d06142af36f7907d20f84986cdd3b4e71c51c20b/test%2Fparallel%2Ftest-net-connect-memleak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-connect-memleak.js?ref=d06142af36f7907d20f84986cdd3b4e71c51c20b",
            "patch": "@@ -26,32 +26,32 @@ const common = require('../common');\n const assert = require('assert');\n const net = require('net');\n \n-console.log('Run this test with --expose-gc');\n-assert.strictEqual(\n-  typeof global.gc,\n-  'function'\n-);\n-net.createServer(function() {}).listen(common.PORT);\n-\n-let before = 0;\n+// Test that the implicit listener for an 'connect' event on net.Sockets is\n+// added using `once()`, i.e. can be gc'ed once that event has occurred.\n+\n+const server = net.createServer(common.mustCall()).listen(0);\n+\n+let collected = false;\n+const gcListener = { ongc() { collected = true; } };\n+\n {\n-  // 2**26 == 64M entries\n-  global.gc();\n-  const junk = new Array(2 ** 26).fill(0);\n-  before = process.memoryUsage().rss;\n+  const gcObject = {};\n+  common.onGC(gcObject, gcListener);\n \n-  net.createConnection(common.PORT, '127.0.0.1', function() {\n-    assert.notStrictEqual(junk.length, 0);  // keep reference alive\n-    setTimeout(done, 10);\n-    global.gc();\n-  });\n+  const sock = net.createConnection(\n+    server.address().port,\n+    common.mustCall(() => {\n+      assert.strictEqual(gcObject, gcObject); // keep reference alive\n+      assert.strictEqual(collected, false);\n+      setImmediate(done, sock);\n+    }));\n }\n \n-function done() {\n+function done(sock) {\n   global.gc();\n-  const after = process.memoryUsage().rss;\n-  const reclaimed = (before - after) / 1024;\n-  console.log('%d kB reclaimed', reclaimed);\n-  assert(reclaimed > 128 * 1024);  // It's around 256 MB on x64.\n-  process.exit();\n+  setImmediate(() => {\n+    assert.strictEqual(collected, true);\n+    sock.end();\n+    server.close();\n+  });\n }",
            "previous_filename": "test/pummel/test-net-connect-memleak.js"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}