{
    "author": "mcollina",
    "message": "http2: make compat writeHead not crash if the stream is destroyed\n\nFixes: https://github.com/nodejs/node/issues/24470\n\nPR-URL: https://github.com/nodejs/node/pull/24723\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "32fed93aee30be5401ff99cfde3360ce037e294a",
    "files": [
        {
            "sha": "adf6b1da628881b8fdfa6393f8fe6f810cb5f2e7",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/32fed93aee30be5401ff99cfde3360ce037e294a/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/32fed93aee30be5401ff99cfde3360ce037e294a/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=32fed93aee30be5401ff99cfde3360ce037e294a",
            "patch": "@@ -568,6 +568,11 @@ class Http2ServerResponse extends Stream {\n     if (this[kStream].headersSent)\n       throw new ERR_HTTP2_HEADERS_SENT();\n \n+    // If the stream is destroyed, we return false,\n+    // like require('http').\n+    if (this.stream.destroyed)\n+      return false;\n+\n     if (typeof statusMessage === 'string')\n       statusMessageWarn();\n "
        },
        {
            "sha": "4576119ee7d435f77769154539547247bb01c468",
            "filename": "test/parallel/test-http2-compat-write-head-destroyed.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/32fed93aee30be5401ff99cfde3360ce037e294a/test%2Fparallel%2Ftest-http2-compat-write-head-destroyed.js",
            "raw_url": "https://github.com/nodejs/node/raw/32fed93aee30be5401ff99cfde3360ce037e294a/test%2Fparallel%2Ftest-http2-compat-write-head-destroyed.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-write-head-destroyed.js?ref=32fed93aee30be5401ff99cfde3360ce037e294a",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const http2 = require('http2');\n+\n+// Check that writeHead, write and end do not crash in compatibility mode\n+\n+const server = http2.createServer(common.mustCall((req, res) => {\n+  // destroy the stream first\n+  req.stream.destroy();\n+\n+  res.writeHead(200);\n+  res.write('hello ');\n+  res.end('world');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+\n+  const req = client.request();\n+  req.on('response', common.mustNotCall());\n+  req.on('close', common.mustCall((arg) => {\n+    client.close();\n+    server.close();\n+  }));\n+  req.resume();\n+}));"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}