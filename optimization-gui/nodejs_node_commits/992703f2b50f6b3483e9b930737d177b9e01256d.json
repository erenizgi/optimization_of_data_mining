{
    "author": "bnoordhuis",
    "message": "src: prevent persistent handle resource leaks\n\nReplace v8::Persistent with node::Persistent, a specialization that\nresets the persistent handle on destruction.  Prevents accidental\nresource leaks when forgetting to call .Reset() manually.\n\nI'm fairly confident this commit fixes a number of resource leaks that\nhave gone undiagnosed so far.\n\nPR-URL: https://github.com/nodejs/node/pull/18656\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "992703f2b50f6b3483e9b930737d177b9e01256d",
    "files": [
        {
            "sha": "f0e51d7a84af3604874eca42934d96094568c52a",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -371,9 +371,10 @@\n         'src/node_internals.h',\n         'src/node_javascript.h',\n         'src/node_mutex.h',\n-        'src/node_platform.h',\n         'src/node_perf.h',\n         'src/node_perf_common.h',\n+        'src/node_persistent.h',\n+        'src/node_platform.h',\n         'src/node_root_certs.h',\n         'src/node_version.h',\n         'src/node_watchdog.h',"
        },
        {
            "sha": "c23535f094d3368bf94dfac9420c1b778be40d4d",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -409,8 +409,8 @@ static void DisablePromiseHook(const FunctionCallbackInfo<Value>& args) {\n class DestroyParam {\n  public:\n   double asyncId;\n-  v8::Persistent<Object> target;\n-  v8::Persistent<Object> propBag;\n+  Persistent<Object> target;\n+  Persistent<Object> propBag;\n };\n \n "
        },
        {
            "sha": "6720bd6d886e1b481d35f1dd031da8749ec56206",
            "filename": "src/base_object-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fbase_object-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fbase_object-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object-inl.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -47,7 +47,7 @@ inline BaseObject::~BaseObject() {\n }\n \n \n-inline v8::Persistent<v8::Object>& BaseObject::persistent() {\n+inline Persistent<v8::Object>& BaseObject::persistent() {\n   return persistent_handle_;\n }\n "
        },
        {
            "sha": "0640f91cbf5b889cb4a2d749d40a090a7315b232",
            "filename": "src/base_object.h",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fbase_object.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fbase_object.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -24,6 +24,7 @@\n \n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n+#include \"node_persistent.h\"\n #include \"v8.h\"\n \n namespace node {\n@@ -39,12 +40,7 @@ class BaseObject {\n   // persistent.IsEmpty() is true.\n   inline v8::Local<v8::Object> object();\n \n-  // The parent class is responsible for calling .Reset() on destruction\n-  // when the persistent handle is strong because there is no way for\n-  // BaseObject to know when the handle goes out of scope.\n-  // Weak handles have been reset by the time the destructor runs but\n-  // calling .Reset() again is harmless.\n-  inline v8::Persistent<v8::Object>& persistent();\n+  inline Persistent<v8::Object>& persistent();\n \n   inline Environment* env() const;\n \n@@ -71,7 +67,7 @@ class BaseObject {\n   // position of members in memory are predictable. For more information please\n   // refer to `doc/guides/node-postmortem-support.md`\n   friend int GenDebugSymbols();\n-  v8::Persistent<v8::Object> persistent_handle_;\n+  Persistent<v8::Object> persistent_handle_;\n   Environment* env_;\n };\n "
        },
        {
            "sha": "2aec83f50372d24b20b6ae385d340c3f41bf79e6",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -550,8 +550,8 @@ void Environment::CreateImmediate(native_immediate_callback cb,\n   native_immediate_callbacks_.push_back({\n     cb,\n     data,\n-    std::unique_ptr<v8::Persistent<v8::Object>>(obj.IsEmpty() ?\n-        nullptr : new v8::Persistent<v8::Object>(isolate_, obj)),\n+    std::unique_ptr<Persistent<v8::Object>>(obj.IsEmpty() ?\n+        nullptr : new Persistent<v8::Object>(isolate_, obj)),\n     ref\n   });\n   immediate_info()->count_inc(1);"
        },
        {
            "sha": "dab9aec9970790634371de95b4f2d2498ade61b3",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -847,7 +847,7 @@ class Environment {\n   struct NativeImmediateCallback {\n     native_immediate_callback cb_;\n     void* data_;\n-    std::unique_ptr<v8::Persistent<v8::Object>> keep_alive_;\n+    std::unique_ptr<Persistent<v8::Object>> keep_alive_;\n     bool refed_;\n   };\n   std::vector<NativeImmediateCallback> native_immediate_callbacks_;\n@@ -858,8 +858,7 @@ class Environment {\n                              v8::Local<v8::Promise> promise,\n                              v8::Local<v8::Value> parent);\n \n-#define V(PropertyName, TypeName)                                             \\\n-  v8::Persistent<TypeName> PropertyName ## _;\n+#define V(PropertyName, TypeName) Persistent<TypeName> PropertyName ## _;\n   ENVIRONMENT_STRONG_PERSISTENT_PROPERTIES(V)\n #undef V\n "
        },
        {
            "sha": "e143d316d2e6fa49c59a1be42feec556360d5ba2",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -30,7 +30,6 @@ using v8::HandleScope;\n using v8::Isolate;\n using v8::Local;\n using v8::Object;\n-using v8::Persistent;\n using v8::String;\n using v8::Value;\n "
        },
        {
            "sha": "56fb407930fac5c8681ea4a95d3f08ac1f2aef28",
            "filename": "src/inspector_agent.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_agent.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_agent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -97,7 +97,7 @@ class Agent {\n \n  private:\n   void ToggleAsyncHook(v8::Isolate* isolate,\n-                       const v8::Persistent<v8::Function>& fn);\n+                       const Persistent<v8::Function>& fn);\n \n   node::Environment* parent_env_;\n   std::unique_ptr<NodeInspectorClient> client_;\n@@ -109,8 +109,8 @@ class Agent {\n \n   bool pending_enable_async_hook_;\n   bool pending_disable_async_hook_;\n-  v8::Persistent<v8::Function> enable_async_hook_function_;\n-  v8::Persistent<v8::Function> disable_async_hook_function_;\n+  Persistent<v8::Function> enable_async_hook_function_;\n+  Persistent<v8::Function> disable_async_hook_function_;\n };\n \n }  // namespace inspector"
        },
        {
            "sha": "9a4857f1a10cab7e99b15075fc0172d5a094a365",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -19,7 +19,6 @@ using v8::Local;\n using v8::MaybeLocal;\n using v8::NewStringType;\n using v8::Object;\n-using v8::Persistent;\n using v8::String;\n using v8::Value;\n "
        },
        {
            "sha": "3969e2a37878fcf2203b77bd2caaf3a7c7c2c0de",
            "filename": "src/module_wrap.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fmodule_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fmodule_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -62,11 +62,11 @@ class ModuleWrap : public BaseObject {\n   static ModuleWrap* GetFromModule(node::Environment*, v8::Local<v8::Module>);\n \n \n-  v8::Persistent<v8::Module> module_;\n-  v8::Persistent<v8::String> url_;\n+  Persistent<v8::Module> module_;\n+  Persistent<v8::String> url_;\n   bool linked_ = false;\n-  std::unordered_map<std::string, v8::Persistent<v8::Promise>> resolve_cache_;\n-  v8::Persistent<v8::Context> context_;\n+  std::unordered_map<std::string, Persistent<v8::Promise>> resolve_cache_;\n+  Persistent<v8::Context> context_;\n };\n \n }  // namespace loader"
        },
        {
            "sha": "7b0e110579b65b9711fe09bddb975a5a7884c4ac",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -38,10 +38,10 @@ struct napi_env__ {\n     accessor_data_template.Reset();\n   }\n   v8::Isolate* isolate;\n-  v8::Persistent<v8::Value> last_exception;\n-  v8::Persistent<v8::ObjectTemplate> wrap_template;\n-  v8::Persistent<v8::ObjectTemplate> function_data_template;\n-  v8::Persistent<v8::ObjectTemplate> accessor_data_template;\n+  node::Persistent<v8::Value> last_exception;\n+  node::Persistent<v8::ObjectTemplate> wrap_template;\n+  node::Persistent<v8::ObjectTemplate> function_data_template;\n+  node::Persistent<v8::ObjectTemplate> accessor_data_template;\n   napi_extended_error_info last_error;\n   int open_handle_scopes = 0;\n   int open_callback_scopes = 0;\n@@ -274,13 +274,13 @@ static_assert(sizeof(v8::Local<v8::Value>) == sizeof(napi_value),\n   \"Cannot convert between v8::Local<v8::Value> and napi_value\");\n \n static\n-napi_deferred JsDeferredFromV8Persistent(v8::Persistent<v8::Value>* local) {\n+napi_deferred JsDeferredFromNodePersistent(node::Persistent<v8::Value>* local) {\n   return reinterpret_cast<napi_deferred>(local);\n }\n \n static\n-v8::Persistent<v8::Value>* V8PersistentFromJsDeferred(napi_deferred local) {\n-  return reinterpret_cast<v8::Persistent<v8::Value>*>(local);\n+node::Persistent<v8::Value>* NodePersistentFromJsDeferred(napi_deferred local) {\n+  return reinterpret_cast<node::Persistent<v8::Value>*>(local);\n }\n \n static\n@@ -360,7 +360,7 @@ class Finalizer {\n   void* _finalize_hint;\n };\n \n-// Wrapper around v8::Persistent that implements reference counting.\n+// Wrapper around node::Persistent that implements reference counting.\n class Reference : private Finalizer {\n  private:\n   Reference(napi_env env,\n@@ -470,7 +470,7 @@ class Reference : private Finalizer {\n     }\n   }\n \n-  v8::Persistent<v8::Value> _persistent;\n+  node::Persistent<v8::Value> _persistent;\n   uint32_t _refcount;\n   bool _delete_self;\n };\n@@ -846,8 +846,8 @@ napi_status ConcludeDeferred(napi_env env,\n   CHECK_ARG(env, result);\n \n   v8::Local<v8::Context> context = env->isolate->GetCurrentContext();\n-  v8::Persistent<v8::Value>* deferred_ref =\n-      V8PersistentFromJsDeferred(deferred);\n+  node::Persistent<v8::Value>* deferred_ref =\n+      NodePersistentFromJsDeferred(deferred);\n   v8::Local<v8::Value> v8_deferred =\n       v8::Local<v8::Value>::New(env->isolate, *deferred_ref);\n \n@@ -3493,10 +3493,10 @@ napi_status napi_create_promise(napi_env env,\n   CHECK_MAYBE_EMPTY(env, maybe, napi_generic_failure);\n \n   auto v8_resolver = maybe.ToLocalChecked();\n-  auto v8_deferred = new v8::Persistent<v8::Value>();\n+  auto v8_deferred = new node::Persistent<v8::Value>();\n   v8_deferred->Reset(env->isolate, v8_resolver);\n \n-  *deferred = v8impl::JsDeferredFromV8Persistent(v8_deferred);\n+  *deferred = v8impl::JsDeferredFromNodePersistent(v8_deferred);\n   *promise = v8impl::JsValueFromV8LocalValue(v8_resolver->GetPromise());\n   return GET_RETURN_STATUS(env);\n }"
        },
        {
            "sha": "c511562b8027b6556f0a5da23c65521646aac317",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -78,7 +78,6 @@ using v8::Local;\n using v8::Maybe;\n using v8::MaybeLocal;\n using v8::Object;\n-using v8::Persistent;\n using v8::String;\n using v8::Uint32Array;\n using v8::Uint8Array;"
        },
        {
            "sha": "6966fac6f6326b62120c88e1aaaff6b1eb82e291",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -48,7 +48,6 @@ using v8::NamedPropertyHandlerConfiguration;\n using v8::Nothing;\n using v8::Object;\n using v8::ObjectTemplate;\n-using v8::Persistent;\n using v8::PropertyAttribute;\n using v8::PropertyCallbackInfo;\n using v8::PropertyDescriptor;"
        },
        {
            "sha": "5c38c5d363d55fff97307b997acd57a01e05799c",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -15,7 +15,7 @@ class ContextifyContext {\n   enum { kSandboxObjectIndex = 1 };\n \n   Environment* const env_;\n-  v8::Persistent<v8::Context> context_;\n+  Persistent<v8::Context> context_;\n \n  public:\n   ContextifyContext(Environment* env,"
        },
        {
            "sha": "1ae744d6afc5c878b0f2b585af65285b45d63ed7",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -100,7 +100,6 @@ using v8::MaybeLocal;\n using v8::Null;\n using v8::Object;\n using v8::ObjectTemplate;\n-using v8::Persistent;\n using v8::PropertyAttribute;\n using v8::ReadOnly;\n using v8::Signature;"
        },
        {
            "sha": "1c17dc108198f81666c4fb8a7efd0cf02d305dd8",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -353,11 +353,11 @@ class SSLWrap {\n   ClientHelloParser hello_parser_;\n \n #ifdef NODE__HAVE_TLSEXT_STATUS_CB\n-  v8::Persistent<v8::Object> ocsp_response_;\n+  Persistent<v8::Object> ocsp_response_;\n #endif  // NODE__HAVE_TLSEXT_STATUS_CB\n \n #ifdef SSL_CTRL_SET_TLSEXT_SERVERNAME_CB\n-  v8::Persistent<v8::Value> sni_context_;\n+  Persistent<v8::Value> sni_context_;\n #endif\n \n   friend class SecureContext;"
        },
        {
            "sha": "a65b9f0e5fcca98410d730797418305e32bc6c3f",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -14,7 +14,6 @@ using v8::HandleScope;\n using v8::Local;\n using v8::MaybeLocal;\n using v8::Object;\n-using v8::Persistent;\n using v8::Promise;\n using v8::Undefined;\n using v8::Value;"
        },
        {
            "sha": "140826bb7c5ebd2274524d220601c51cbb4e3702",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -25,6 +25,7 @@\n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #include \"node.h\"\n+#include \"node_persistent.h\"\n #include \"util-inl.h\"\n #include \"env-inl.h\"\n #include \"uv.h\"\n@@ -215,7 +216,7 @@ class Environment;\n template <class TypeName>\n inline v8::Local<TypeName> PersistentToLocal(\n     v8::Isolate* isolate,\n-    const v8::Persistent<TypeName>& persistent);\n+    const Persistent<TypeName>& persistent);\n \n // Creates a new context with Node.js-specific tweaks.  Currently, it removes\n // the `v8BreakIterator` property from the global `Intl` object if present."
        },
        {
            "sha": "762842dd4bd373fe8422942ac491d57a676d8c81",
            "filename": "src/node_persistent.h",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_persistent.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_persistent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_persistent.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -0,0 +1,30 @@\n+#ifndef SRC_NODE_PERSISTENT_H_\n+#define SRC_NODE_PERSISTENT_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include \"v8.h\"\n+\n+namespace node {\n+\n+template <typename T>\n+struct ResetInDestructorPersistentTraits {\n+  static const bool kResetInDestructor = true;\n+  template <typename S, typename M>\n+  // Disallow copy semantics by leaving this unimplemented.\n+  inline static void Copy(\n+      const v8::Persistent<S, M>&,\n+      v8::Persistent<T, ResetInDestructorPersistentTraits<T>>*);\n+};\n+\n+// v8::Persistent does not reset the object slot in its destructor.  That is\n+// acknowledged as a flaw in the V8 API and expected to change in the future\n+// but for now node::Persistent is the easier and safer alternative.\n+template <typename T>\n+using Persistent = v8::Persistent<T, ResetInDestructorPersistentTraits<T>>;\n+\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#endif  // SRC_NODE_PERSISTENT_H_"
        },
        {
            "sha": "388630d507a4331c030f8ea6e8e44d129ece7076",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -46,7 +46,6 @@ using v8::HandleScope;\n using v8::Local;\n using v8::Number;\n using v8::Object;\n-using v8::Persistent;\n using v8::String;\n using v8::Uint32Array;\n using v8::Value;"
        },
        {
            "sha": "c864feb9270b52bd62959999db39b2eea838f227",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 8,
            "deletions": 18,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -225,8 +225,8 @@ inline StreamWriteResult StreamBase::Write(\n   return StreamWriteResult { async, err, req_wrap };\n }\n \n-template<typename OtherBase, bool kResetPersistent>\n-SimpleShutdownWrap<OtherBase, kResetPersistent>::SimpleShutdownWrap(\n+template <typename OtherBase>\n+SimpleShutdownWrap<OtherBase>::SimpleShutdownWrap(\n     StreamBase* stream,\n     v8::Local<v8::Object> req_wrap_obj)\n   : ShutdownWrap(stream, req_wrap_obj),\n@@ -236,23 +236,18 @@ SimpleShutdownWrap<OtherBase, kResetPersistent>::SimpleShutdownWrap(\n   Wrap(req_wrap_obj, static_cast<AsyncWrap*>(this));\n }\n \n-template<typename OtherBase, bool kResetPersistent>\n-SimpleShutdownWrap<OtherBase, kResetPersistent>::~SimpleShutdownWrap() {\n+template <typename OtherBase>\n+SimpleShutdownWrap<OtherBase>::~SimpleShutdownWrap() {\n   ClearWrap(static_cast<AsyncWrap*>(this)->object());\n-  if (kResetPersistent) {\n-    auto& persistent = static_cast<AsyncWrap*>(this)->persistent();\n-    CHECK_EQ(persistent.IsEmpty(), false);\n-    persistent.Reset();\n-  }\n }\n \n inline ShutdownWrap* StreamBase::CreateShutdownWrap(\n     v8::Local<v8::Object> object) {\n   return new SimpleShutdownWrap<AsyncWrap>(this, object);\n }\n \n-template<typename OtherBase, bool kResetPersistent>\n-SimpleWriteWrap<OtherBase, kResetPersistent>::SimpleWriteWrap(\n+template <typename OtherBase>\n+SimpleWriteWrap<OtherBase>::SimpleWriteWrap(\n     StreamBase* stream,\n     v8::Local<v8::Object> req_wrap_obj)\n   : WriteWrap(stream, req_wrap_obj),\n@@ -262,14 +257,9 @@ SimpleWriteWrap<OtherBase, kResetPersistent>::SimpleWriteWrap(\n   Wrap(req_wrap_obj, static_cast<AsyncWrap*>(this));\n }\n \n-template<typename OtherBase, bool kResetPersistent>\n-SimpleWriteWrap<OtherBase, kResetPersistent>::~SimpleWriteWrap() {\n+template <typename OtherBase>\n+SimpleWriteWrap<OtherBase>::~SimpleWriteWrap() {\n   ClearWrap(static_cast<AsyncWrap*>(this)->object());\n-  if (kResetPersistent) {\n-    auto& persistent = static_cast<AsyncWrap*>(this)->persistent();\n-    CHECK_EQ(persistent.IsEmpty(), false);\n-    persistent.Reset();\n-  }\n }\n \n inline WriteWrap* StreamBase::CreateWriteWrap("
        },
        {
            "sha": "8af05059f49e4715af231f37116c7ae567177b56",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -322,7 +322,7 @@ class StreamBase : public StreamResource {\n // `OtherBase` must have a constructor that matches the `AsyncWrap`\n // constructorsâ€™s (Environment*, Local<Object>, AsyncWrap::Provider) signature\n // and be a subclass of `AsyncWrap`.\n-template <typename OtherBase, bool kResetPersistentOnDestroy = true>\n+template <typename OtherBase>\n class SimpleShutdownWrap : public ShutdownWrap, public OtherBase {\n  public:\n   SimpleShutdownWrap(StreamBase* stream,\n@@ -333,7 +333,7 @@ class SimpleShutdownWrap : public ShutdownWrap, public OtherBase {\n   size_t self_size() const override { return sizeof(*this); }\n };\n \n-template <typename OtherBase, bool kResetPersistentOnDestroy = true>\n+template <typename OtherBase>\n class SimpleWriteWrap : public WriteWrap, public OtherBase {\n  public:\n   SimpleWriteWrap(StreamBase* stream,"
        },
        {
            "sha": "27fe48d1165c7509333db497995147930399d9f5",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -264,8 +264,8 @@ void LibuvStreamWrap::SetBlocking(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(uv_stream_set_blocking(wrap->stream(), enable));\n }\n \n-typedef SimpleShutdownWrap<ReqWrap<uv_shutdown_t>, false> LibuvShutdownWrap;\n-typedef SimpleWriteWrap<ReqWrap<uv_write_t>, false> LibuvWriteWrap;\n+typedef SimpleShutdownWrap<ReqWrap<uv_shutdown_t>> LibuvShutdownWrap;\n+typedef SimpleWriteWrap<ReqWrap<uv_write_t>> LibuvWriteWrap;\n \n ShutdownWrap* LibuvStreamWrap::CreateShutdownWrap(Local<Object> object) {\n   return new LibuvShutdownWrap(this, object);"
        },
        {
            "sha": "d07cfea9227fbe76105f34a44c0fc06dd6ad6d1e",
            "filename": "src/util-inl.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Futil-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Futil-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil-inl.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -168,7 +168,7 @@ inline ContainerOfHelper<Inner, Outer> ContainerOf(Inner Outer::*field,\n template <class TypeName>\n inline v8::Local<TypeName> PersistentToLocal(\n     v8::Isolate* isolate,\n-    const v8::Persistent<TypeName>& persistent) {\n+    const Persistent<TypeName>& persistent) {\n   if (persistent.IsWeak()) {\n     return WeakPersistentToLocal(isolate, persistent);\n   } else {\n@@ -178,15 +178,15 @@ inline v8::Local<TypeName> PersistentToLocal(\n \n template <class TypeName>\n inline v8::Local<TypeName> StrongPersistentToLocal(\n-    const v8::Persistent<TypeName>& persistent) {\n+    const Persistent<TypeName>& persistent) {\n   return *reinterpret_cast<v8::Local<TypeName>*>(\n-      const_cast<v8::Persistent<TypeName>*>(&persistent));\n+      const_cast<Persistent<TypeName>*>(&persistent));\n }\n \n template <class TypeName>\n inline v8::Local<TypeName> WeakPersistentToLocal(\n     v8::Isolate* isolate,\n-    const v8::Persistent<TypeName>& persistent) {\n+    const Persistent<TypeName>& persistent) {\n   return v8::Local<TypeName>::New(isolate, persistent);\n }\n "
        },
        {
            "sha": "7c679952d5fb1f107f74ab83570fa9640fd66528",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/992703f2b50f6b3483e9b930737d177b9e01256d/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=992703f2b50f6b3483e9b930737d177b9e01256d",
            "patch": "@@ -24,6 +24,7 @@\n \n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n+#include \"node_persistent.h\"\n #include \"v8.h\"\n \n #include <assert.h>\n@@ -218,7 +219,7 @@ inline ContainerOfHelper<Inner, Outer> ContainerOf(Inner Outer::*field,\n template <class TypeName>\n inline v8::Local<TypeName> PersistentToLocal(\n     v8::Isolate* isolate,\n-    const v8::Persistent<TypeName>& persistent);\n+    const Persistent<TypeName>& persistent);\n \n // Unchecked conversion from a non-weak Persistent<T> to Local<TLocal<T>,\n // use with care!\n@@ -227,12 +228,12 @@ inline v8::Local<TypeName> PersistentToLocal(\n // scope, it will destroy the reference to the object.\n template <class TypeName>\n inline v8::Local<TypeName> StrongPersistentToLocal(\n-    const v8::Persistent<TypeName>& persistent);\n+    const Persistent<TypeName>& persistent);\n \n template <class TypeName>\n inline v8::Local<TypeName> WeakPersistentToLocal(\n     v8::Isolate* isolate,\n-    const v8::Persistent<TypeName>& persistent);\n+    const Persistent<TypeName>& persistent);\n \n // Convenience wrapper around v8::String::NewFromOneByte().\n inline v8::Local<v8::String> OneByteString(v8::Isolate* isolate,"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 87,
        "deletions": 76
    }
}