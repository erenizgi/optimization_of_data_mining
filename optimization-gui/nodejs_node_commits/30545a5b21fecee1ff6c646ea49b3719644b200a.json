{
    "author": "addaleax",
    "message": "src: use struct as arguments to node::Assert\n\nThis just makes the code a bit more obvious (subjectively).\n\nPR-URL: https://github.com/nodejs/node/pull/25869\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "30545a5b21fecee1ff6c646ea49b3719644b200a",
    "files": [
        {
            "sha": "ab608f96dd0bc1791d1c86b68e3c0d3f864e9cce",
            "filename": "src/node_errors.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 12,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/30545a5b21fecee1ff6c646ea49b3719644b200a/src%2Fnode_errors.cc",
            "raw_url": "https://github.com/nodejs/node/raw/30545a5b21fecee1ff6c646ea49b3719644b200a/src%2Fnode_errors.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.cc?ref=30545a5b21fecee1ff6c646ea49b3719644b200a",
            "patch": "@@ -166,23 +166,17 @@ void AppendExceptionLine(Environment* env,\n   ABORT_NO_BACKTRACE();\n }\n \n-[[noreturn]] void Assert(const char* const (*args)[4]) {\n-  auto filename = (*args)[0];\n-  auto linenum = (*args)[1];\n-  auto message = (*args)[2];\n-  auto function = (*args)[3];\n-\n+[[noreturn]] void Assert(const AssertionInfo& info) {\n   char name[1024];\n   GetHumanReadableProcessName(&name);\n \n   fprintf(stderr,\n-          \"%s: %s:%s:%s%s Assertion `%s' failed.\\n\",\n+          \"%s: %s:%s%s Assertion `%s' failed.\\n\",\n           name,\n-          filename,\n-          linenum,\n-          function,\n-          *function ? \":\" : \"\",\n-          message);\n+          info.file_line,\n+          info.function,\n+          *info.function ? \":\" : \"\",\n+          info.message);\n   fflush(stderr);\n \n   Abort();"
        },
        {
            "sha": "b199476aa246bf53549aef1ef3f714aa425c7358",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/30545a5b21fecee1ff6c646ea49b3719644b200a/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/30545a5b21fecee1ff6c646ea49b3719644b200a/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=30545a5b21fecee1ff6c646ea49b3719644b200a",
            "patch": "@@ -85,10 +85,15 @@ extern bool v8_initialized;\n // whether V8 is initialized.\n void LowMemoryNotification();\n \n-// The slightly odd function signature for Assert() is to ease\n-// instruction cache pressure in calls from CHECK.\n+// The reason that Assert() takes a struct argument instead of individual\n+// const char*s is to ease instruction cache pressure in calls from CHECK.\n+struct AssertionInfo {\n+  const char* file_line;  // filename:line\n+  const char* message;\n+  const char* function;\n+};\n+[[noreturn]] void Assert(const AssertionInfo& info);\n [[noreturn]] void Abort();\n-[[noreturn]] void Assert(const char* const (*args)[4]);\n void DumpBacktrace(FILE* fp);\n \n #define DISALLOW_COPY_AND_ASSIGN(TypeName)                                    \\\n@@ -120,9 +125,12 @@ void DumpBacktrace(FILE* fp);\n #define CHECK(expr)                                                           \\\n   do {                                                                        \\\n     if (UNLIKELY(!(expr))) {                                                  \\\n-      static const char* const args[] = { __FILE__, STRINGIFY(__LINE__),      \\\n-                                          #expr, PRETTY_FUNCTION_NAME };      \\\n-      node::Assert(&args);                                                    \\\n+      /* Make sure that this struct does not end up in inline code, but    */ \\\n+      /* rather in a read-only data section when modifying this code.      */ \\\n+      static const node::AssertionInfo args = {                               \\\n+        __FILE__ \":\" STRINGIFY(__LINE__), #expr, PRETTY_FUNCTION_NAME         \\\n+      };                                                                      \\\n+      node::Assert(args);                                                     \\\n     }                                                                         \\\n   } while (0)\n "
        }
    ],
    "stats": {
        "total": 38,
        "additions": 20,
        "deletions": 18
    }
}