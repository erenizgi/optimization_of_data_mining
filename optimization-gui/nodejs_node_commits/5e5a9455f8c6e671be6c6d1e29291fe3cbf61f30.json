{
    "author": "jasnell",
    "message": "doc, test: document and test vm timeout escapes\n\nUsing `process.nextTick()`, `Promise`, or `queueMicrotask()`, it\nis possible to escape the `timeout` set when running code with\n`vm.runInContext()`, `vm.runInThisContext()`, and\n`vm.runInNewContext()`.\n\nThis documents the issue and adds three known_issues tests.\n\nRefs: https://github.com/nodejs/node/issues/3020\nPR-URL: https://github.com/nodejs/node/pull/23743\nRefs: https://github.com/nodejs/node/issues/3020\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30",
    "files": [
        {
            "sha": "842ae3b81a01deb419cc3c6055b6cdec29811a15",
            "filename": "doc/api/vm.md",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/doc%2Fapi%2Fvm.md",
            "raw_url": "https://github.com/nodejs/node/raw/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/doc%2Fapi%2Fvm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fvm.md?ref=5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30",
            "patch": "@@ -962,6 +962,38 @@ within which it can operate. The process of creating the V8 Context and\n associating it with the `sandbox` object is what this document refers to as\n \"contextifying\" the `sandbox`.\n \n+## Timeout limitations when using process.nextTick(), Promises, and queueMicrotask()\n+\n+Because of the internal mechanics of how the `process.nextTick()` queue and\n+the microtask queue that underlies Promises are implemented within V8 and\n+Node.js, it is possible for code running within a context to \"escape\" the\n+`timeout` set using `vm.runInContext()`, `vm.runInNewContext()`, and\n+`vm.runInThisContext()`.\n+\n+For example, the following code executed by `vm.runInNewContext()` with a\n+timeout of 5 milliseconds schedules an infinite loop to run after a promise\n+resolves. The scheduled loop is never interrupted by the timeout:\n+\n+```js\n+const vm = require('vm');\n+\n+function loop() {\n+  while (1) console.log(Date.now());\n+}\n+\n+vm.runInNewContext(\n+  'Promise.resolve().then(loop);',\n+  { loop, console },\n+  { timeout: 5 }\n+);\n+```\n+\n+This issue also occurs when the `loop()` call is scheduled using\n+the `process.nextTick()` and `queueMicrotask()` functions.\n+\n+This issue occurs because all contexts share the same microtask and nextTick\n+queues.\n+\n [`Error`]: errors.html#errors_class_error\n [`ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING`]: errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING\n [`URL`]: url.html#url_class_url"
        },
        {
            "sha": "8afe2fb8cebb158246851c4fda2022690e8f0b71",
            "filename": "test/known_issues/test-vm-timeout-escape-nexttick.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js?ref=5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30",
            "patch": "@@ -0,0 +1,41 @@\n+'use strict';\n+\n+// https://github.com/nodejs/node/issues/3020\n+// Promises, nextTick, and queueMicrotask allow code to escape the timeout\n+// set for runInContext, runInNewContext, and runInThisContext\n+\n+require('../common');\n+const assert = require('assert');\n+const vm = require('vm');\n+\n+const NS_PER_MS = 1000000n;\n+\n+const hrtime = process.hrtime.bigint;\n+const nextTick = process.nextTick;\n+\n+function loop() {\n+  const start = hrtime();\n+  while (1) {\n+    const current = hrtime();\n+    const span = (current - start) / NS_PER_MS;\n+    if (span >= 100n) {\n+      throw new Error(\n+        `escaped timeout at ${span} milliseconds!`);\n+    }\n+  }\n+}\n+\n+assert.throws(() => {\n+  vm.runInNewContext(\n+    'nextTick(loop); loop();',\n+    {\n+      hrtime,\n+      nextTick,\n+      loop\n+    },\n+    { timeout: 5 }\n+  );\n+}, {\n+  code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+  message: 'Script execution timed out after 5ms'\n+});"
        },
        {
            "sha": "4452c83cd182e3dbcad962e47485ad631709ce99",
            "filename": "test/known_issues/test-vm-timeout-escape-promise.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-promise.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-promise.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-vm-timeout-escape-promise.js?ref=5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+\n+// https://github.com/nodejs/node/issues/3020\n+// Promises, nextTick, and queueMicrotask allow code to escape the timeout\n+// set for runInContext, runInNewContext, and runInThisContext\n+\n+require('../common');\n+const assert = require('assert');\n+const vm = require('vm');\n+\n+const NS_PER_MS = 1000000n;\n+\n+const hrtime = process.hrtime.bigint;\n+\n+function loop() {\n+  const start = hrtime();\n+  while (1) {\n+    const current = hrtime();\n+    const span = (current - start) / NS_PER_MS;\n+    if (span >= 100n) {\n+      throw new Error(\n+        `escaped timeout at ${span} milliseconds!`);\n+    }\n+  }\n+}\n+\n+assert.throws(() => {\n+  vm.runInNewContext(\n+    'Promise.resolve().then(loop); loop();',\n+    {\n+      hrtime,\n+      loop\n+    },\n+    { timeout: 5 }\n+  );\n+}, {\n+  code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+  message: 'Script execution timed out after 5ms'\n+});"
        },
        {
            "sha": "8de33bc24ddcdc981956a4d006f6bf08f0bf81a1",
            "filename": "test/known_issues/test-vm-timeout-escape-queuemicrotask.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-queuemicrotask.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30/test%2Fknown_issues%2Ftest-vm-timeout-escape-queuemicrotask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-vm-timeout-escape-queuemicrotask.js?ref=5e5a9455f8c6e671be6c6d1e29291fe3cbf61f30",
            "patch": "@@ -0,0 +1,40 @@\n+'use strict';\n+\n+// https://github.com/nodejs/node/issues/3020\n+// Promises, nextTick, and queueMicrotask allow code to escape the timeout\n+// set for runInContext, runInNewContext, and runInThisContext\n+\n+require('../common');\n+const assert = require('assert');\n+const vm = require('vm');\n+\n+const NS_PER_MS = 1000000n;\n+\n+const hrtime = process.hrtime.bigint;\n+\n+function loop() {\n+  const start = hrtime();\n+  while (1) {\n+    const current = hrtime();\n+    const span = (current - start) / NS_PER_MS;\n+    if (span >= 100n) {\n+      throw new Error(\n+        `escaped timeout at ${span} milliseconds!`);\n+    }\n+  }\n+}\n+\n+assert.throws(() => {\n+  vm.runInNewContext(\n+    'queueMicrotask(loop); loop();',\n+    {\n+      hrtime,\n+      queueMicrotask,\n+      loop\n+    },\n+    { timeout: 5 }\n+  );\n+}, {\n+  code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+  message: 'Script execution timed out after 5ms'\n+});"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 152,
        "deletions": 0
    }
}