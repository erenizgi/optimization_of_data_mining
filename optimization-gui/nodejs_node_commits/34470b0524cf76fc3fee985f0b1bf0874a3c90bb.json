{
    "author": "joyeecheung",
    "message": "process: setup signal handler in prepareMainThreadExecution\n\nBecause this is only necessary in the main thread.\nAlso removes the rearming of signal events since no\nsignal event handlers should be created during the execution\nof node.js now that we've made the creation of stdout and stderr\nstreams lazy - this has been demonstrated in the test coverage.\n\nPR-URL: https://github.com/nodejs/node/pull/26227\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "34470b0524cf76fc3fee985f0b1bf0874a3c90bb",
    "files": [
        {
            "sha": "0dc34be96e19338eadfd233bff448c23328f3432",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=34470b0524cf76fc3fee985f0b1bf0874a3c90bb",
            "patch": "@@ -282,36 +282,15 @@ if (process.env.NODE_V8_COVERAGE) {\n   };\n }\n \n-// Worker threads don't receive signals.\n-if (isMainThread) {\n-  const {\n-    isSignal,\n-    startListeningIfSignal,\n-    stopListeningIfSignal\n-  } = mainThreadSetup.createSignalHandlers();\n-  process.on('newListener', startListeningIfSignal);\n-  process.on('removeListener', stopListeningIfSignal);\n-  // re-arm pre-existing signal event registrations\n-  // with this signal wrap capabilities.\n-  const signalEvents = process.eventNames().filter(isSignal);\n-  for (const ev of signalEvents) {\n-    process.emit('newListener', ev);\n-  }\n-}\n-\n if (getOptionValue('--experimental-report')) {\n   const {\n     config,\n-    handleSignal,\n     report,\n     syncConfig\n   } = NativeModule.require('internal/process/report');\n   process.report = report;\n   // Download the CLI / ENV config into JS land.\n   syncConfig(config, false);\n-  if (config.events.includes('signal')) {\n-    process.on(config.signal, handleSignal);\n-  }\n }\n \n function setupProcessObject() {"
        },
        {
            "sha": "57f7420d6c20276ae1204fe371de4c89dcde5de5",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=34470b0524cf76fc3fee985f0b1bf0874a3c90bb",
            "patch": "@@ -8,6 +8,9 @@ let traceEventsAsyncHook;\n function prepareMainThreadExecution() {\n   setupTraceCategoryState();\n \n+  // Only main thread receives signals.\n+  setupSignalHandlers();\n+\n   // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n   // spawned by our child_process module, then initialize IPC.\n   // This attaches some internal event listeners and creates:\n@@ -28,6 +31,28 @@ function prepareMainThreadExecution() {\n   loadPreloadModules();\n }\n \n+function setupSignalHandlers() {\n+  const {\n+    createSignalHandlers\n+  } = require('internal/process/main_thread_only');\n+  const {\n+    startListeningIfSignal,\n+    stopListeningIfSignal\n+  } = createSignalHandlers();\n+  process.on('newListener', startListeningIfSignal);\n+  process.on('removeListener', stopListeningIfSignal);\n+\n+  if (getOptionValue('--experimental-report')) {\n+    const {\n+      config,\n+      handleSignal\n+    } = require('internal/process/report');\n+    if (config.events.includes('signal')) {\n+      process.on(config.signal, handleSignal);\n+    }\n+  }\n+}\n+\n function setupTraceCategoryState() {\n   const {\n     asyncHooksEnabledInitial,"
        },
        {
            "sha": "24a7b02520fa57db9578312e334fd61665736a74",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/34470b0524cf76fc3fee985f0b1bf0874a3c90bb/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=34470b0524cf76fc3fee985f0b1bf0874a3c90bb",
            "patch": "@@ -144,7 +144,6 @@ function createSignalHandlers() {\n   }\n \n   return {\n-    isSignal,\n     startListeningIfSignal,\n     stopListeningIfSignal\n   };"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 25,
        "deletions": 22
    }
}