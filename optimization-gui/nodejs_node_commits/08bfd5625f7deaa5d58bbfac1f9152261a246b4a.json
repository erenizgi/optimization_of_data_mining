{
    "author": "joyeecheung",
    "message": "process: remove pushValueToArray in EnvEnumerator\n\nInstead of calling into JS from C++ to push values into an array,\nuse the new Array::New API that takes a pointer and a length\ndirectly.\n\nPR-URL: https://github.com/nodejs/node/pull/24264\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "08bfd5625f7deaa5d58bbfac1f9152261a246b4a",
    "files": [
        {
            "sha": "74b2b64f3458e163f5b2130ca7242ac8288c5c57",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 30,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/08bfd5625f7deaa5d58bbfac1f9152261a246b4a/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/08bfd5625f7deaa5d58bbfac1f9152261a246b4a/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=08bfd5625f7deaa5d58bbfac1f9152261a246b4a",
            "patch": "@@ -730,40 +730,29 @@ void EnvDeleter(Local<Name> property,\n void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n   Environment* env = Environment::GetCurrent(info);\n   Isolate* isolate = env->isolate();\n-  Local<Context> ctx = env->context();\n-  Local<Function> fn = env->push_values_to_array_function();\n-  Local<Value> argv[NODE_PUSH_VAL_TO_ARRAY_MAX];\n-  size_t idx = 0;\n \n   Mutex::ScopedLock lock(environ_mutex);\n+  Local<Array> envarr;\n+  int env_size = 0;\n #ifdef __POSIX__\n-  int size = 0;\n-  while (environ[size])\n-    size++;\n-\n-  Local<Array> envarr = Array::New(isolate);\n+  while (environ[env_size]) {\n+    env_size++;\n+  }\n+  std::vector<Local<Value>> env_v(env_size);\n \n-  for (int i = 0; i < size; ++i) {\n+  for (int i = 0; i < env_size; ++i) {\n     const char* var = environ[i];\n     const char* s = strchr(var, '=');\n     const int length = s ? s - var : strlen(var);\n-    argv[idx] = String::NewFromUtf8(isolate,\n-                                    var,\n-                                    v8::NewStringType::kNormal,\n-                                    length).ToLocalChecked();\n-    if (++idx >= arraysize(argv)) {\n-      fn->Call(ctx, envarr, idx, argv).ToLocalChecked();\n-      idx = 0;\n-    }\n-  }\n-  if (idx > 0) {\n-    fn->Call(ctx, envarr, idx, argv).ToLocalChecked();\n+    env_v[i] =\n+        String::NewFromUtf8(isolate, var, v8::NewStringType::kNormal, length)\n+            .ToLocalChecked();\n   }\n #else  // _WIN32\n+  std::vector<Local<Value>> env_v;\n   WCHAR* environment = GetEnvironmentStringsW();\n   if (environment == nullptr)\n     return;  // This should not happen.\n-  Local<Array> envarr = Array::New(isolate);\n   WCHAR* p = environment;\n   while (*p) {\n     WCHAR* s;\n@@ -789,19 +778,13 @@ void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n       FreeEnvironmentStringsW(environment);\n       return;\n     }\n-    argv[idx] = rc.ToLocalChecked();\n-    if (++idx >= arraysize(argv)) {\n-      fn->Call(ctx, envarr, idx, argv).ToLocalChecked();\n-      idx = 0;\n-    }\n+    env_v.push_back(rc.ToLocalChecked());\n     p = s + wcslen(s) + 1;\n   }\n-  if (idx > 0) {\n-    fn->Call(ctx, envarr, idx, argv).ToLocalChecked();\n-  }\n   FreeEnvironmentStringsW(environment);\n #endif\n \n+  envarr = Array::New(isolate, env_v.data(), env_v.size());\n   info.GetReturnValue().Set(envarr);\n }\n "
        },
        {
            "sha": "51cc637d06e5c4215f82328115c5eb5c364fefa6",
            "filename": "test/parallel/test-process-env.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/08bfd5625f7deaa5d58bbfac1f9152261a246b4a/test%2Fparallel%2Ftest-process-env.js",
            "raw_url": "https://github.com/nodejs/node/raw/08bfd5625f7deaa5d58bbfac1f9152261a246b4a/test%2Fparallel%2Ftest-process-env.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env.js?ref=08bfd5625f7deaa5d58bbfac1f9152261a246b4a",
            "patch": "@@ -91,6 +91,7 @@ assert.strictEqual(5, date.getHours());\n // case-sensitive on other platforms.\n process.env.TEST = 'test';\n assert.strictEqual(process.env.TEST, 'test');\n+\n // Check both mixed case and lower case, to avoid any regressions that might\n // simply convert input to lower case.\n if (common.isWindows) {\n@@ -100,3 +101,8 @@ if (common.isWindows) {\n   assert.strictEqual(process.env.test, undefined);\n   assert.strictEqual(process.env.teST, undefined);\n }\n+\n+{\n+  const keys = Object.keys(process.env);\n+  assert.ok(keys.length > 0);\n+}"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 19,
        "deletions": 30
    }
}