{
    "author": "devsnek",
    "message": "src: standardise context embedder indices\n\nPR-URL: https://github.com/nodejs/node/pull/19135\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Matheus Marchini <matheus@sthima.com>",
    "sha": "c9b4de55c061ecb8d64cda9e36821c21f8150925",
    "files": [
        {
            "sha": "89a321a92003a7fd0f6e82f6be44387e0ca92898",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -31,6 +31,7 @@\n #include \"uv.h\"\n #include \"v8.h\"\n #include \"node_perf_common.h\"\n+#include \"node_context_data.h\"\n \n #include <stddef.h>\n #include <stdint.h>\n@@ -283,7 +284,8 @@ inline void Environment::TickInfo::set_has_thrown(bool state) {\n \n inline void Environment::AssignToContext(v8::Local<v8::Context> context,\n                                          const ContextInfo& info) {\n-  context->SetAlignedPointerInEmbedderData(kContextEmbedderDataIndex, this);\n+  context->SetAlignedPointerInEmbedderData(\n+      ContextEmbedderIndex::kEnvironment, this);\n #if HAVE_INSPECTOR\n   inspector_agent()->ContextCreated(context, info);\n #endif  // HAVE_INSPECTOR\n@@ -295,7 +297,8 @@ inline Environment* Environment::GetCurrent(v8::Isolate* isolate) {\n \n inline Environment* Environment::GetCurrent(v8::Local<v8::Context> context) {\n   return static_cast<Environment*>(\n-      context->GetAlignedPointerFromEmbedderData(kContextEmbedderDataIndex));\n+      context->GetAlignedPointerFromEmbedderData(\n+          ContextEmbedderIndex::kEnvironment));\n }\n \n inline Environment* Environment::GetCurrent(\n@@ -368,8 +371,8 @@ inline Environment::~Environment() {\n   inspector_agent_.reset();\n #endif\n \n-  context()->SetAlignedPointerInEmbedderData(kContextEmbedderDataIndex,\n-                                             nullptr);\n+  context()->SetAlignedPointerInEmbedderData(\n+      ContextEmbedderIndex::kEnvironment, nullptr);\n \n   delete[] heap_statistics_buffer_;\n   delete[] heap_space_statistics_buffer_;"
        },
        {
            "sha": "27e72f35d12bce6a21e91c1b61ad4086b9e8793c",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -75,14 +75,6 @@ struct PackageConfig {\n };\n }  // namespace loader\n \n-// Pick an index that's hopefully out of the way when we're embedded inside\n-// another application. Performance-wise or memory-wise it doesn't matter:\n-// Context::SetAlignedPointerInEmbedderData() is backed by a FixedArray,\n-// worst case we pay a one-time penalty for resizing the array.\n-#ifndef NODE_CONTEXT_EMBEDDER_DATA_INDEX\n-#define NODE_CONTEXT_EMBEDDER_DATA_INDEX 32\n-#endif\n-\n // The number of items passed to push_values_to_array_function has diminishing\n // returns around 8. This should be used at all call sites using said function.\n #ifndef NODE_PUSH_VAL_TO_ARRAY_MAX\n@@ -730,8 +722,6 @@ class Environment {\n   inline HandleWrapQueue* handle_wrap_queue() { return &handle_wrap_queue_; }\n   inline ReqWrapQueue* req_wrap_queue() { return &req_wrap_queue_; }\n \n-  static const int kContextEmbedderDataIndex = NODE_CONTEXT_EMBEDDER_DATA_INDEX;\n-\n   void AddPromiseHook(promise_hook_func fn, void* arg);\n   bool RemovePromiseHook(promise_hook_func fn, void* arg);\n   bool EmitNapiWarning();"
        },
        {
            "sha": "9d3145bb800b59f2e00e60a25601eb8d5082a009",
            "filename": "src/node_context_data.h",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_context_data.h",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_context_data.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_context_data.h?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -0,0 +1,25 @@\n+#ifndef SRC_NODE_CONTEXT_DATA_H_\n+#define SRC_NODE_CONTEXT_DATA_H_\n+\n+namespace node {\n+\n+// Pick an index that's hopefully out of the way when we're embedded inside\n+// another application. Performance-wise or memory-wise it doesn't matter:\n+// Context::SetAlignedPointerInEmbedderData() is backed by a FixedArray,\n+// worst case we pay a one-time penalty for resizing the array.\n+#ifndef NODE_CONTEXT_EMBEDDER_DATA_INDEX\n+#define NODE_CONTEXT_EMBEDDER_DATA_INDEX 32\n+#endif\n+\n+#ifndef NODE_CONTEXT_SANDBOX_OBJECT_INDEX\n+#define NODE_CONTEXT_SANDBOX_OBJECT_INDEX 33\n+#endif\n+\n+enum ContextEmbedderIndex {\n+  kEnvironment = NODE_CONTEXT_EMBEDDER_DATA_INDEX,\n+  kSandboxObject = NODE_CONTEXT_SANDBOX_OBJECT_INDEX,\n+};\n+\n+}  // namespace node\n+\n+#endif  // SRC_NODE_CONTEXT_DATA_H_"
        },
        {
            "sha": "d267a5180ff6555a6dad8d324ff516d42c101a57",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -23,6 +23,7 @@\n #include \"node_watchdog.h\"\n #include \"base_object-inl.h\"\n #include \"node_contextify.h\"\n+#include \"node_context_data.h\"\n \n namespace node {\n namespace contextify {\n@@ -173,7 +174,7 @@ Local<Context> ContextifyContext::CreateV8Context(\n   // embedder data field. However, we cannot hold a reference to a v8::Context\n   // directly in an Object, we instead hold onto the new context's global\n   // object instead (which then has a reference to the context).\n-  ctx->SetEmbedderData(kSandboxObjectIndex, sandbox_obj);\n+  ctx->SetEmbedderData(ContextEmbedderIndex::kSandboxObject, sandbox_obj);\n   sandbox_obj->SetPrivate(env->context(),\n                           env->contextify_global_private_symbol(),\n                           ctx->Global());"
        },
        {
            "sha": "b25e1a75d4f26cadb7353f5424a521ca5425e936",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -4,16 +4,13 @@\n #include \"node_internals.h\"\n #include \"node_watchdog.h\"\n #include \"base_object-inl.h\"\n+#include \"node_context_data.h\"\n \n namespace node {\n namespace contextify {\n \n class ContextifyContext {\n  protected:\n-  // V8 reserves the first field in context objects for the debugger. We use the\n-  // second field to hold a reference to the sandbox object.\n-  enum { kSandboxObjectIndex = 1 };\n-\n   Environment* const env_;\n   Persistent<v8::Context> context_;\n \n@@ -45,7 +42,7 @@ class ContextifyContext {\n \n   inline v8::Local<v8::Object> sandbox() const {\n     return v8::Local<v8::Object>::Cast(\n-        context()->GetEmbedderData(kSandboxObjectIndex));\n+        context()->GetEmbedderData(ContextEmbedderIndex::kSandboxObject));\n   }\n \n  private:"
        },
        {
            "sha": "93bf5a4dd7d8f42a511a7a11a11d82f3c0c9e7e6",
            "filename": "src/node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/src%2Fnode_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_postmortem_metadata.cc?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -4,6 +4,7 @@\n #include \"util-inl.h\"\n #include \"req_wrap.h\"\n #include \"v8abbr.h\"\n+#include \"node_context_data.h\"\n \n #define NODEDBG_SYMBOL(Name)  nodedbg_ ## Name\n \n@@ -34,7 +35,7 @@\n   V(ListNode_ReqWrap, next_, uintptr_t, ListNode<ReqWrap<uv_req_t>>::next_)\n \n extern \"C\" {\n-int nodedbg_const_Environment__kContextEmbedderDataIndex__int;\n+int nodedbg_const_ContextEmbedderIndex__kEnvironment__int;\n uintptr_t nodedbg_offset_ExternalString__data__uintptr_t;\n \n #define V(Class, Member, Type, Accessor)                                      \\\n@@ -46,8 +47,8 @@ uintptr_t nodedbg_offset_ExternalString__data__uintptr_t;\n namespace node {\n \n int GenDebugSymbols() {\n-  nodedbg_const_Environment__kContextEmbedderDataIndex__int =\n-      Environment::kContextEmbedderDataIndex;\n+  nodedbg_const_ContextEmbedderIndex__kEnvironment__int =\n+      ContextEmbedderIndex::kEnvironment;\n \n   nodedbg_offset_ExternalString__data__uintptr_t = NODE_OFF_EXTSTR_DATA;\n "
        },
        {
            "sha": "335f3e85812547a9293897e78722df12348079af",
            "filename": "test/cctest/test_node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/c9b4de55c061ecb8d64cda9e36821c21f8150925/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c9b4de55c061ecb8d64cda9e36821c21f8150925/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_node_postmortem_metadata.cc?ref=c9b4de55c061ecb8d64cda9e36821c21f8150925",
            "patch": "@@ -13,7 +13,7 @@ extern uintptr_t\n extern uintptr_t\n     nodedbg_offset_Environment__handle_wrap_queue___Environment_HandleWrapQueue;\n extern int debug_symbols_generated;\n-extern int nodedbg_const_Environment__kContextEmbedderDataIndex__int;\n+extern int nodedbg_const_ContextEmbedderIndex__kEnvironment__int;\n extern uintptr_t\n     nodedbg_offset_Environment_HandleWrapQueue__head___ListNode_HandleWrap;\n extern uintptr_t\n@@ -56,10 +56,10 @@ class TestReqWrap : public node::ReqWrap<uv_req_t> {\n                                 node::AsyncWrap::PROVIDER_TIMERWRAP) {}\n };\n \n-TEST_F(DebugSymbolsTest, ContextEmbedderDataIndex) {\n-  int kContextEmbedderDataIndex = node::Environment::kContextEmbedderDataIndex;\n-  EXPECT_EQ(nodedbg_const_Environment__kContextEmbedderDataIndex__int,\n-            kContextEmbedderDataIndex);\n+TEST_F(DebugSymbolsTest, ContextEmbedderEnvironmentIndex) {\n+  int kEnvironmentIndex = node::ContextEmbedderIndex::kEnvironment;\n+  EXPECT_EQ(nodedbg_const_ContextEmbedderIndex__kEnvironment__int,\n+            kEnvironmentIndex);\n }\n \n TEST_F(DebugSymbolsTest, ExternalStringDataOffset) {"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 45,
        "deletions": 28
    }
}