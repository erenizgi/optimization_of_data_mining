{
    "author": "maclover7",
    "message": "src: extract common Bind method\n\n`TCPWrap::Bind` and `TCPWrap::Bind6` share a large amount of\nfunctionality, so a common `Bind` was extracted to remove duplication.\n\nPR-URL: https://github.com/nodejs/node/pull/22315\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Fedor Indutny <fedor.indutny@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4",
    "files": [
        {
            "sha": "dac621ec879e5cc9859afc0a97a9d9b0cdad1bfb",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4",
            "patch": "@@ -225,40 +225,28 @@ void TCPWrap::Open(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(err);\n }\n \n-\n-void TCPWrap::Bind(const FunctionCallbackInfo<Value>& args) {\n+template <typename T>\n+void TCPWrap::Bind(\n+    const FunctionCallbackInfo<Value>& args,\n+    int family,\n+    std::function<int(const char* ip_address, int port, T* addr)> uv_ip_addr) {\n   TCPWrap* wrap;\n   ASSIGN_OR_RETURN_UNWRAP(&wrap,\n                           args.Holder(),\n                           args.GetReturnValue().Set(UV_EBADF));\n   Environment* env = wrap->env();\n   node::Utf8Value ip_address(env->isolate(), args[0]);\n   int port;\n+  unsigned int flags = 0;\n   if (!args[1]->Int32Value(env->context()).To(&port)) return;\n-  sockaddr_in addr;\n-  int err = uv_ip4_addr(*ip_address, port, &addr);\n-  if (err == 0) {\n-    err = uv_tcp_bind(&wrap->handle_,\n-                      reinterpret_cast<const sockaddr*>(&addr),\n-                      0);\n+  if (family == AF_INET6 &&\n+      !args[2]->Uint32Value(env->context()).To(&flags)) {\n+    return;\n   }\n-  args.GetReturnValue().Set(err);\n-}\n \n+  T addr;\n+  int err = uv_ip_addr(*ip_address, port, &addr);\n \n-void TCPWrap::Bind6(const FunctionCallbackInfo<Value>& args) {\n-  TCPWrap* wrap;\n-  ASSIGN_OR_RETURN_UNWRAP(&wrap,\n-                          args.Holder(),\n-                          args.GetReturnValue().Set(UV_EBADF));\n-  Environment* env = wrap->env();\n-  node::Utf8Value ip6_address(env->isolate(), args[0]);\n-  int port;\n-  unsigned int flags;\n-  if (!args[1]->Int32Value(env->context()).To(&port)) return;\n-  if (!args[2]->Uint32Value(env->context()).To(&flags)) return;\n-  sockaddr_in6 addr;\n-  int err = uv_ip6_addr(*ip6_address, port, &addr);\n   if (err == 0) {\n     err = uv_tcp_bind(&wrap->handle_,\n                       reinterpret_cast<const sockaddr*>(&addr),\n@@ -267,6 +255,15 @@ void TCPWrap::Bind6(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(err);\n }\n \n+void TCPWrap::Bind(const FunctionCallbackInfo<Value>& args) {\n+  Bind<sockaddr_in>(args, AF_INET, uv_ip4_addr);\n+}\n+\n+\n+void TCPWrap::Bind6(const FunctionCallbackInfo<Value>& args) {\n+  Bind<sockaddr_in6>(args, AF_INET6, uv_ip6_addr);\n+}\n+\n \n void TCPWrap::Listen(const FunctionCallbackInfo<Value>& args) {\n   TCPWrap* wrap;"
        },
        {
            "sha": "db269f6528163950ec17b05a6267f5732e0f8437",
            "filename": "src/tcp_wrap.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4/src%2Ftcp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4/src%2Ftcp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.h?ref=4b96a2a73b8117218c82e4dbbc491c81fd1b1fa4",
            "patch": "@@ -80,6 +80,11 @@ class TCPWrap : public ConnectionWrap<TCPWrap, uv_tcp_t> {\n   static void Connect(const v8::FunctionCallbackInfo<v8::Value>& args,\n       std::function<int(const char* ip_address, T* addr)> uv_ip_addr);\n   static void Open(const v8::FunctionCallbackInfo<v8::Value>& args);\n+  template <typename T>\n+  static void Bind(\n+      const v8::FunctionCallbackInfo<v8::Value>& args,\n+      int family,\n+      std::function<int(const char* ip_address, int port, T* addr)> uv_ip_addr);\n \n #ifdef _WIN32\n   static void SetSimultaneousAccepts("
        }
    ],
    "stats": {
        "total": 48,
        "additions": 25,
        "deletions": 23
    }
}