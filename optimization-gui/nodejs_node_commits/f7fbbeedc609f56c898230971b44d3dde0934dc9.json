{
    "author": "apapirovski",
    "message": "http: relax requirements on upgrade listener\n\nThe http spec does not say anything about Upgrade headers making\nprotocol switch mandatory but Node.js implements them as if they\nare. Relax the requirements to only destroy the socket if no\nupgrade listener exists on the client when status code is 101.\n\nPR-URL: https://github.com/nodejs/node/pull/19981\nFixes: https://github.com/nodejs/node/issues/11552\nRefs: https://tools.ietf.org/html/rfc7230#section-6.7\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "f7fbbeedc609f56c898230971b44d3dde0934dc9",
    "files": [
        {
            "sha": "700dce3b94f660158ebaa6d77056ddcee9b0201d",
            "filename": "doc/api/http.md",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/doc%2Fapi%2Fhttp.md",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/doc%2Fapi%2Fhttp.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp.md?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -471,8 +471,9 @@ added: v0.1.94\n * `head` {Buffer}\n \n Emitted each time a server responds to a request with an upgrade. If this\n-event is not being listened for, clients receiving an upgrade header will have\n-their connections closed.\n+event is not being listened for and the response status code is 101 Switching\n+Protocols, clients receiving an upgrade header will have their connections\n+closed.\n \n A client server pair demonstrating how to listen for the `'upgrade'` event.\n \n@@ -886,16 +887,20 @@ per connection (in the case of HTTP Keep-Alive connections).\n ### Event: 'upgrade'\n <!-- YAML\n added: v0.1.94\n+changes:\n+  - version: REPLACEME\n+    pr-url: REPLACEME\n+    description: Not listening to this event no longer causes the socket\n+                 to be destroyed if a client sends an Upgrade header.\n -->\n \n * `request` {http.IncomingMessage} Arguments for the HTTP request, as it is in\n   the [`'request'`][] event\n * `socket` {net.Socket} Network socket between the server and client\n * `head` {Buffer} The first packet of the upgraded stream (may be empty)\n \n-Emitted each time a client requests an HTTP upgrade. If this event is not\n-listened for, then clients requesting an upgrade will have their connections\n-closed.\n+Emitted each time a client requests an HTTP upgrade. Listening to this event\n+is optional and clients cannot insist on a protocol change.\n \n After this event is emitted, the request's socket will not have a `'data'`\n event listener, meaning it will need to be bound in order to handle data"
        },
        {
            "sha": "c3ef9de20498dfc56020e6b6ed939b7304d4034a",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -426,7 +426,7 @@ function socketOnData(d) {\n     req.socket._hadError = true;\n     req.emit('error', ret);\n   } else if (parser.incoming && parser.incoming.upgrade) {\n-    // Upgrade or CONNECT\n+    // Upgrade (if status code 101) or CONNECT\n     var bytesParsed = ret;\n     var res = parser.incoming;\n     req.res = res;\n@@ -453,7 +453,7 @@ function socketOnData(d) {\n       req.emit(eventName, res, socket, bodyHead);\n       req.emit('close');\n     } else {\n-      // Got Upgrade header or CONNECT method, but have no handler.\n+      // Requested Upgrade or used CONNECT method, but have no handler.\n       socket.destroy();\n     }\n   } else if (parser.incoming && parser.incoming.complete &&\n@@ -492,6 +492,10 @@ function parserOnIncomingClient(res, shouldKeepAlive) {\n   }\n   req.res = res;\n \n+  // Skip body and treat as Upgrade.\n+  if (res.upgrade)\n+    return 2;\n+\n   // Responses to CONNECT request is handled as Upgrade.\n   const method = req.method;\n   if (method === 'CONNECT') {"
        },
        {
            "sha": "bc65443eb3c8454ecdfdd00b6a1046edb62d721d",
            "filename": "lib/_http_common.js",
            "status": "modified",
            "additions": 1,
            "deletions": 13,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_common.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -83,6 +83,7 @@ function parserOnHeadersComplete(versionMajor, versionMinor, headers, method,\n   parser.incoming.httpVersionMinor = versionMinor;\n   parser.incoming.httpVersion = `${versionMajor}.${versionMinor}`;\n   parser.incoming.url = url;\n+  parser.incoming.upgrade = upgrade;\n \n   var n = headers.length;\n \n@@ -101,19 +102,6 @@ function parserOnHeadersComplete(versionMajor, versionMinor, headers, method,\n     parser.incoming.statusMessage = statusMessage;\n   }\n \n-  if (upgrade && parser.outgoing !== null && !parser.outgoing.upgrading) {\n-    // The client made non-upgrade request, and server is just advertising\n-    // supported protocols.\n-    //\n-    // See RFC7230 Section 6.7\n-    upgrade = false;\n-  }\n-\n-  parser.incoming.upgrade = upgrade;\n-\n-  if (upgrade)\n-    return 2;  // Skip body and treat as Upgrade.\n-\n   return parser.onIncoming(parser.incoming, shouldKeepAlive);\n }\n "
        },
        {
            "sha": "b62dea4a24dd2f77373da45a680a70412012058d",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -98,7 +98,6 @@ function OutgoingMessage() {\n   this.writable = true;\n \n   this._last = false;\n-  this.upgrading = false;\n   this.chunkedEncoding = false;\n   this.shouldKeepAlive = true;\n   this.useChunkedEncodingByDefault = true;\n@@ -304,7 +303,6 @@ function _storeHeader(firstLine, headers) {\n   // in the case of response it is: 'HTTP/1.1 200 OK\\r\\n'\n   var state = {\n     connection: false,\n-    connUpgrade: false,\n     contLen: false,\n     te: false,\n     date: false,\n@@ -366,10 +364,6 @@ function _storeHeader(firstLine, headers) {\n     }\n   }\n \n-  // Are we upgrading the connection?\n-  if (state.connUpgrade && state.upgrade)\n-    this.upgrading = true;\n-\n   // Date header\n   if (this.sendDate && !state.date) {\n     state.header += 'Date: ' + utcDate() + CRLF;\n@@ -460,8 +454,6 @@ function matchConnValue(self, state, value) {\n   while (m) {\n     if (m[0].length === 5)\n       sawClose = true;\n-    else\n-      state.connUpgrade = true;\n     m = RE_CONN_VALUES.exec(value);\n   }\n   if (sawClose)"
        },
        {
            "sha": "a8389dbda62f0dfccf113c0314a9d9c71a733d5c",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -530,14 +530,14 @@ function onParserExecuteCommon(server, socket, parser, state, ret, d) {\n     parser = null;\n \n     var eventName = req.method === 'CONNECT' ? 'connect' : 'upgrade';\n-    if (server.listenerCount(eventName) > 0) {\n+    if (eventName === 'upgrade' || server.listenerCount(eventName) > 0) {\n       debug('SERVER have listener for %s', eventName);\n       var bodyHead = d.slice(bytesParsed, d.length);\n \n       socket.readableFlowing = null;\n       server.emit(eventName, req, socket, bodyHead);\n     } else {\n-      // Got upgrade header or CONNECT method, but have no handler.\n+      // Got CONNECT method, but have no handler.\n       socket.destroy();\n     }\n   }\n@@ -592,6 +592,13 @@ function resOnFinish(req, res, socket, state, server) {\n function parserOnIncoming(server, socket, state, req, keepAlive) {\n   resetSocketTimeout(server, socket, state);\n \n+  if (req.upgrade) {\n+    req.upgrade = req.method === 'CONNECT' ||\n+                  server.listenerCount('upgrade') > 0;\n+    if (req.upgrade)\n+      return 2;\n+  }\n+\n   state.incoming.push(req);\n \n   // If the writable end isn't consuming, then stop reading"
        },
        {
            "sha": "6d033ba36a5d6054b7bdf6d3aeeb732a60564cee",
            "filename": "test/parallel/test-http-upgrade-advertise.js",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/test%2Fparallel%2Ftest-http-upgrade-advertise.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/test%2Fparallel%2Ftest-http-upgrade-advertise.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-upgrade-advertise.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -8,7 +8,9 @@ const tests = [\n   { headers: {}, expected: 'regular' },\n   { headers: { upgrade: 'h2c' }, expected: 'regular' },\n   { headers: { connection: 'upgrade' }, expected: 'regular' },\n-  { headers: { connection: 'upgrade', upgrade: 'h2c' }, expected: 'upgrade' }\n+  { headers: { connection: 'upgrade', upgrade: 'h2c' }, expected: 'upgrade' },\n+  { headers: { connection: 'upgrade', upgrade: 'h2c' }, expected: 'destroy' },\n+  { headers: { connection: 'upgrade', upgrade: 'h2c' }, expected: 'regular' },\n ];\n \n function fire() {\n@@ -32,10 +34,17 @@ function fire() {\n     done('regular');\n   });\n \n-  req.on('upgrade', function onUpgrade(res, socket) {\n-    socket.destroy();\n-    done('upgrade');\n-  });\n+  if (test.expected === 'destroy') {\n+    req.on('socket', () => req.socket.on('close', () => {\n+      server.removeAllListeners('upgrade');\n+      done('destroy');\n+    }));\n+  } else {\n+    req.on('upgrade', function onUpgrade(res, socket) {\n+      socket.destroy();\n+      done('upgrade');\n+    });\n+  }\n \n   req.end();\n }"
        },
        {
            "sha": "d8a193c6edb4eccc6d1942d423614de18821140c",
            "filename": "test/parallel/test-http-upgrade-server.js",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f7fbbeedc609f56c898230971b44d3dde0934dc9/test%2Fparallel%2Ftest-http-upgrade-server.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7fbbeedc609f56c898230971b44d3dde0934dc9/test%2Fparallel%2Ftest-http-upgrade-server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-upgrade-server.js?ref=f7fbbeedc609f56c898230971b44d3dde0934dc9",
            "patch": "@@ -121,8 +121,6 @@ function test_upgrade_with_listener() {\n /*-----------------------------------------------\n   connection: Upgrade, no listener\n -----------------------------------------------*/\n-let test_upgrade_no_listener_ended = false;\n-\n function test_upgrade_no_listener() {\n   const conn = net.createConnection(server.address().port);\n   conn.setEncoding('utf8');\n@@ -135,8 +133,9 @@ function test_upgrade_no_listener() {\n              '\\r\\n');\n   });\n \n-  conn.on('end', function() {\n-    test_upgrade_no_listener_ended = true;\n+  conn.once('data', (data) => {\n+    assert.strictEqual(typeof data, 'string');\n+    assert.strictEqual(data.substr(0, 12), 'HTTP/1.1 200');\n     conn.end();\n   });\n \n@@ -182,5 +181,4 @@ server.listen(0, function() {\n process.on('exit', function() {\n   assert.strictEqual(3, requests_recv);\n   assert.strictEqual(3, requests_sent);\n-  assert.ok(test_upgrade_no_listener_ended);\n });"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 43,
        "deletions": 40
    }
}