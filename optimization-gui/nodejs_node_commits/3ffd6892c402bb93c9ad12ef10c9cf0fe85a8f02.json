{
    "author": "rubys",
    "message": "tools: convert addon-verify to remark\n\nThis is the last use of the remark *module*. tools/remark-cli and\ntools/remark-preset-lint-node remain.\n\nPR-URL: https://github.com/nodejs/node/pull/21978\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02",
    "files": [
        {
            "sha": "ae6a08b2cc64758893e7af520c0a0156965df3ff",
            "filename": "tools/doc/addon-verify.js",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Faddon-verify.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Faddon-verify.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Faddon-verify.js?ref=3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02",
            "patch": "@@ -1,28 +1,38 @@\n 'use strict';\n \n-const { mkdir, readFileSync, writeFile } = require('fs');\n+// doc/api/addons.md has a bunch of code.  Extract it for verification\n+// that the C++ code compiles and the js code runs.\n+// Add .gyp files which will be used to compile the C++ code.\n+// Modify the require paths in the js code to pull from the build tree.\n+// Triggered from the build-addons target in the Makefile and vcbuild.bat.\n+\n+const { mkdir, writeFile } = require('fs');\n const { resolve } = require('path');\n-const { lexer } = require('marked');\n+const vfile = require('to-vfile');\n+const unified = require('unified');\n+const remarkParse = require('remark-parse');\n \n const rootDir = resolve(__dirname, '..', '..');\n const doc = resolve(rootDir, 'doc', 'api', 'addons.md');\n const verifyDir = resolve(rootDir, 'test', 'addons');\n \n-const tokens = lexer(readFileSync(doc, 'utf8'));\n+const file = vfile.readSync(doc, 'utf8');\n+const tree = unified().use(remarkParse).parse(file);\n const addons = {};\n let id = 0;\n let currentHeader;\n \n const validNames = /^\\/\\/\\s+(.*\\.(?:cc|h|js))[\\r\\n]/;\n-tokens.forEach(({ type, text }) => {\n-  if (type === 'heading') {\n-    currentHeader = text;\n+tree.children.forEach((node) => {\n+  if (node.type === 'heading') {\n+    currentHeader = file.contents.slice(\n+      node.children[0].position.start.offset,\n+      node.position.end.offset);\n     addons[currentHeader] = { files: {} };\n-  }\n-  if (type === 'code') {\n-    const match = text.match(validNames);\n+  } else if (node.type === 'code') {\n+    const match = node.value.match(validNames);\n     if (match !== null) {\n-      addons[currentHeader].files[match[1]] = text;\n+      addons[currentHeader].files[match[1]] = node.value;\n     }\n   }\n });"
        },
        {
            "sha": "c688e60c1577c8c4a601eb176dcd4acb136565e7",
            "filename": "tools/doc/package-lock.json",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Fpackage-lock.json",
            "raw_url": "https://github.com/nodejs/node/raw/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Fpackage-lock.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fpackage-lock.json?ref=3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02",
            "patch": "@@ -339,11 +339,6 @@\n       \"resolved\": \"https://registry.npmjs.org/markdown-table/-/markdown-table-0.4.0.tgz\",\n       \"integrity\": \"sha1-iQwsGzv+g/sA5BKbjkz+ZFJw+dE=\"\n     },\n-    \"marked\": {\n-      \"version\": \"0.4.0\",\n-      \"resolved\": \"https://registry.npmjs.org/marked/-/marked-0.4.0.tgz\",\n-      \"integrity\": \"sha512-tMsdNBgOsrUophCAFQl0XPe6Zqk/uy9gnue+jIIKhykO51hxyu6uNx7zBPy0+y/WKYVZZMspV9YeXLNdKk+iYw==\"\n-    },\n     \"mdast-util-definitions\": {\n       \"version\": \"1.2.2\",\n       \"resolved\": \"https://registry.npmjs.org/mdast-util-definitions/-/mdast-util-definitions-1.2.2.tgz\",\n@@ -591,6 +586,15 @@\n         \"is-hexadecimal\": \"^1.0.0\"\n       }\n     },\n+    \"to-vfile\": {\n+      \"version\": \"5.0.0\",\n+      \"resolved\": \"https://registry.npmjs.org/to-vfile/-/to-vfile-5.0.0.tgz\",\n+      \"integrity\": \"sha512-sUeBtb4i09pNIzPtl/PMW20Xfe/NK82oV0IehtmoX/+PhIdvc6JHMRnmC4fjCIcy0LOwcNqB8iRMtTBzXHVbng==\",\n+      \"requires\": {\n+        \"is-buffer\": \"^2.0.0\",\n+        \"vfile\": \"^3.0.0\"\n+      }\n+    },\n     \"trim\": {\n       \"version\": \"0.0.1\",\n       \"resolved\": \"https://registry.npmjs.org/trim/-/trim-0.0.1.tgz\","
        },
        {
            "sha": "41ae87889d36e4df30e951e62fb5cff94c0820b7",
            "filename": "tools/doc/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Fpackage.json",
            "raw_url": "https://github.com/nodejs/node/raw/3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02/tools%2Fdoc%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fpackage.json?ref=3ffd6892c402bb93c9ad12ef10c9cf0fe85a8f02",
            "patch": "@@ -7,12 +7,12 @@\n     \"node\": \">=6\"\n   },\n   \"dependencies\": {\n-    \"marked\": \"^0.4.0\",\n     \"rehype-raw\": \"^2.0.0\",\n     \"rehype-stringify\": \"^3.0.0\",\n     \"remark-html\": \"^7.0.0\",\n     \"remark-parse\": \"^5.0.0\",\n     \"remark-rehype\": \"^3.0.0\",\n+    \"to-vfile\": \"^5.0.0\",\n     \"unified\": \"^7.0.0\",\n     \"unist-util-find\": \"^1.0.1\",\n     \"unist-util-select\": \"^1.5.0\","
        }
    ],
    "stats": {
        "total": 46,
        "additions": 30,
        "deletions": 16
    }
}