{
    "author": "addaleax",
    "message": "src: add PrintLibuvHandleInformation debug helper\n\nThis function is not only helpful for debugging crashes,\nbut can also be used as an ad-hoc debugging statement.\n\nPR-URL: https://github.com/nodejs/node/pull/25905\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "46d9573c682bbd8abe759cc2b76e2cf996cb7bcc",
    "files": [
        {
            "sha": "434c9853c02a2e87f0daf2d5e0976d4d5edda579",
            "filename": "src/debug_utils.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 12,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/src%2Fdebug_utils.cc",
            "raw_url": "https://github.com/nodejs/node/raw/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/src%2Fdebug_utils.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fdebug_utils.cc?ref=46d9573c682bbd8abe759cc2b76e2cf996cb7bcc",
            "patch": "@@ -282,20 +282,36 @@ void DumpBacktrace(FILE* fp) {\n void CheckedUvLoopClose(uv_loop_t* loop) {\n   if (uv_loop_close(loop) == 0) return;\n \n-  auto sym_ctx = NativeSymbolDebuggingContext::New();\n+  PrintLibuvHandleInformation(loop, stderr);\n+\n+  fflush(stderr);\n+  // Finally, abort.\n+  CHECK(0 && \"uv_loop_close() while having open handles\");\n+}\n \n-  fprintf(stderr, \"uv loop at [%p] has active handles\\n\", loop);\n+void PrintLibuvHandleInformation(uv_loop_t* loop, FILE* stream) {\n+  struct Info {\n+    std::unique_ptr<NativeSymbolDebuggingContext> ctx;\n+    FILE* stream;\n+  };\n+\n+  Info info { NativeSymbolDebuggingContext::New(), stream };\n+\n+  fprintf(stream, \"uv loop at [%p] has %d active handles\\n\",\n+          loop, loop->active_handles);\n \n   uv_walk(loop, [](uv_handle_t* handle, void* arg) {\n-    auto sym_ctx = static_cast<NativeSymbolDebuggingContext*>(arg);\n+    Info* info = static_cast<Info*>(arg);\n+    NativeSymbolDebuggingContext* sym_ctx = info->ctx.get();\n+    FILE* stream = info->stream;\n \n-    fprintf(stderr, \"[%p] %s\\n\", handle, uv_handle_type_name(handle->type));\n+    fprintf(stream, \"[%p] %s\\n\", handle, uv_handle_type_name(handle->type));\n \n     void* close_cb = reinterpret_cast<void*>(handle->close_cb);\n-    fprintf(stderr, \"\\tClose callback: %p %s\\n\",\n+    fprintf(stream, \"\\tClose callback: %p %s\\n\",\n         close_cb, sym_ctx->LookupSymbol(close_cb).Display().c_str());\n \n-    fprintf(stderr, \"\\tData: %p %s\\n\",\n+    fprintf(stream, \"\\tData: %p %s\\n\",\n         handle->data, sym_ctx->LookupSymbol(handle->data).Display().c_str());\n \n     // We are also interested in the first field of what `handle->data`\n@@ -309,14 +325,10 @@ void CheckedUvLoopClose(uv_loop_t* loop) {\n       first_field = *reinterpret_cast<void**>(handle->data);\n \n     if (first_field != nullptr) {\n-      fprintf(stderr, \"\\t(First field): %p %s\\n\",\n+      fprintf(stream, \"\\t(First field): %p %s\\n\",\n           first_field, sym_ctx->LookupSymbol(first_field).Display().c_str());\n     }\n-  }, sym_ctx.get());\n-\n-  fflush(stderr);\n-  // Finally, abort.\n-  CHECK(0 && \"uv_loop_close() while having open handles\");\n+  }, &info);\n }\n \n std::vector<std::string> NativeSymbolDebuggingContext::GetLoadedLibraries() {"
        },
        {
            "sha": "05a9370e562f8271ef813f91441b4f2b9edb923d",
            "filename": "src/debug_utils.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/src%2Fdebug_utils.h",
            "raw_url": "https://github.com/nodejs/node/raw/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/src%2Fdebug_utils.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fdebug_utils.h?ref=46d9573c682bbd8abe759cc2b76e2cf996cb7bcc",
            "patch": "@@ -119,6 +119,7 @@ class NativeSymbolDebuggingContext {\n // about giving information on currently existing handles, if there are any,\n // but still aborts the process.\n void CheckedUvLoopClose(uv_loop_t* loop);\n+void PrintLibuvHandleInformation(uv_loop_t* loop, FILE* stream);\n \n }  // namespace node\n "
        },
        {
            "sha": "0bfb6cdb94b72da2fb5976e9bc2b48916286391b",
            "filename": "test/abort/test-addon-uv-handle-leak.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/test%2Fabort%2Ftest-addon-uv-handle-leak.js",
            "raw_url": "https://github.com/nodejs/node/raw/46d9573c682bbd8abe759cc2b76e2cf996cb7bcc/test%2Fabort%2Ftest-addon-uv-handle-leak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fabort%2Ftest-addon-uv-handle-leak.js?ref=46d9573c682bbd8abe759cc2b76e2cf996cb7bcc",
            "patch": "@@ -89,7 +89,7 @@ if (process.argv[2] === 'child') {\n \n     switch (state) {\n       case 'initial':\n-        assert(/^uv loop at \\[.+\\] has active handles$/.test(line), line);\n+        assert(/^uv loop at \\[.+\\] has \\d+ active handles$/.test(line), line);\n         state = 'handle-start';\n         break;\n       case 'handle-start':"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 26,
        "deletions": 13
    }
}