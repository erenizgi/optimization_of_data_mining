{
    "author": "addaleax",
    "message": "src: pass along errors from perf obj instantiation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "77fa310949cf926bf7befffff32616cb1ba1c41b",
    "files": [
        {
            "sha": "5b172dfee78e8796ddb146637761c8c2bd679955",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=77fa310949cf926bf7befffff32616cb1ba1c41b",
            "patch": "@@ -697,7 +697,8 @@ void Http2Stream::EmitStatistics() {\n     }\n     buffer[IDX_STREAM_STATS_SENTBYTES] = entry->sent_bytes();\n     buffer[IDX_STREAM_STATS_RECEIVEDBYTES] = entry->received_bytes();\n-    entry->Notify(entry->ToObject());\n+    Local<Object> obj;\n+    if (entry->ToObject().ToLocal(&obj)) entry->Notify(obj);\n   }, static_cast<void*>(entry));\n }\n \n@@ -726,7 +727,8 @@ void Http2Session::EmitStatistics() {\n     buffer[IDX_SESSION_STATS_DATA_RECEIVED] = entry->data_received();\n     buffer[IDX_SESSION_STATS_MAX_CONCURRENT_STREAMS] =\n         entry->max_concurrent_streams();\n-    entry->Notify(entry->ToObject());\n+    Local<Object> obj;\n+    if (entry->ToObject().ToLocal(&obj)) entry->Notify(obj);\n   }, static_cast<void*>(entry));\n }\n "
        },
        {
            "sha": "9c0091d2bc9070163d1ad195db5cd06e99e8bd65",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 11,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=77fa310949cf926bf7befffff32616cb1ba1c41b",
            "patch": "@@ -20,6 +20,7 @@ using v8::HandleScope;\n using v8::Integer;\n using v8::Isolate;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Name;\n using v8::NewStringType;\n using v8::Number;\n@@ -102,10 +103,13 @@ inline void InitObject(const PerformanceEntry& entry, Local<Object> obj) {\n }\n \n // Create a new PerformanceEntry object\n-const Local<Object> PerformanceEntry::ToObject() const {\n-  Local<Object> obj =\n-      env_->performance_entry_template()\n-          ->NewInstance(env_->context()).ToLocalChecked();\n+MaybeLocal<Object> PerformanceEntry::ToObject() const {\n+  Local<Object> obj;\n+  if (!env_->performance_entry_template()\n+           ->NewInstance(env_->context())\n+           .ToLocal(&obj)) {\n+    return MaybeLocal<Object>();\n+  }\n   InitObject(*this, obj);\n   return obj;\n }\n@@ -154,7 +158,8 @@ void Mark(const FunctionCallbackInfo<Value>& args) {\n       *name, now / 1000);\n \n   PerformanceEntry entry(env, *name, \"mark\", now, now);\n-  Local<Object> obj = entry.ToObject();\n+  Local<Object> obj;\n+  if (!entry.ToObject().ToLocal(&obj)) return;\n   PerformanceEntry::Notify(env, entry.kind(), obj);\n   args.GetReturnValue().Set(obj);\n }\n@@ -217,7 +222,8 @@ void Measure(const FunctionCallbackInfo<Value>& args) {\n       *name, *name, endTimestamp / 1000);\n \n   PerformanceEntry entry(env, *name, \"measure\", startTimestamp, endTimestamp);\n-  Local<Object> obj = entry.ToObject();\n+  Local<Object> obj;\n+  if (!entry.ToObject().ToLocal(&obj)) return;\n   PerformanceEntry::Notify(env, entry.kind(), obj);\n   args.GetReturnValue().Set(obj);\n }\n@@ -242,14 +248,16 @@ void SetupPerformanceObservers(const FunctionCallbackInfo<Value>& args) {\n \n // Creates a GC Performance Entry and passes it to observers\n void PerformanceGCCallback(Environment* env, void* ptr) {\n-  GCPerformanceEntry* entry = static_cast<GCPerformanceEntry*>(ptr);\n+  std::unique_ptr<GCPerformanceEntry> entry{\n+      static_cast<GCPerformanceEntry*>(ptr)};\n   HandleScope scope(env->isolate());\n   Local<Context> context = env->context();\n \n   AliasedBuffer<uint32_t, Uint32Array>& observers =\n       env->performance_state()->observers;\n   if (observers[NODE_PERFORMANCE_ENTRY_TYPE_GC]) {\n-    Local<Object> obj = entry->ToObject();\n+    Local<Object> obj;\n+    if (!entry->ToObject().ToLocal(&obj)) return;\n     PropertyAttribute attr =\n         static_cast<PropertyAttribute>(ReadOnly | DontDelete);\n     obj->DefineOwnProperty(context,\n@@ -258,8 +266,6 @@ void PerformanceGCCallback(Environment* env, void* ptr) {\n                            attr).FromJust();\n     PerformanceEntry::Notify(env, entry->kind(), obj);\n   }\n-\n-  delete entry;\n }\n \n // Marks the start of a GC cycle\n@@ -359,7 +365,8 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n     return;\n \n   PerformanceEntry entry(env, *name, \"function\", start, end);\n-  Local<Object> obj = entry.ToObject();\n+  Local<Object> obj;\n+  if (!entry.ToObject().ToLocal(&obj)) return;\n   for (idx = 0; idx < count; idx++)\n     obj->Set(context, idx, args[idx]).FromJust();\n   PerformanceEntry::Notify(env, entry.kind(), obj);"
        },
        {
            "sha": "56140bd62dee5154e69a3d6eeb741e4bea851d8f",
            "filename": "src/node_perf.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_perf.h",
            "raw_url": "https://github.com/nodejs/node/raw/77fa310949cf926bf7befffff32616cb1ba1c41b/src%2Fnode_perf.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.h?ref=77fa310949cf926bf7befffff32616cb1ba1c41b",
            "patch": "@@ -75,7 +75,7 @@ class PerformanceEntry {\n \n   virtual ~PerformanceEntry() { }\n \n-  virtual const Local<Object> ToObject() const;\n+  virtual v8::MaybeLocal<Object> ToObject() const;\n \n   Environment* env() const { return env_; }\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 23,
        "deletions": 14
    }
}