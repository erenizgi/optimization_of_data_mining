{
    "author": "BridgeAR",
    "message": "util: show Weak(Set|Map) entries in inspect\n\nThis adds support for WeakMap and WeakSet entries in `util.inspect`.\nThe output is limited to a maximum entry length of `maxArrayLength`.\n\nPR-URL: https://github.com/nodejs/node/pull/19259\nFixes: https://github.com/nodejs/node/issues/19001:\nReviewed-By: Yosuke Furukawa <yosuke.furukawa@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1029dd36861d7ab592d4e219362706d2c161839a",
    "files": [
        {
            "sha": "9253d46351d3f41433d061063b9b6f0b1ffac152",
            "filename": "doc/api/util.md",
            "status": "modified",
            "additions": 32,
            "deletions": 5,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/1029dd36861d7ab592d4e219362706d2c161839a/doc%2Fapi%2Futil.md",
            "raw_url": "https://github.com/nodejs/node/raw/1029dd36861d7ab592d4e219362706d2c161839a/doc%2Fapi%2Futil.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Futil.md?ref=1029dd36861d7ab592d4e219362706d2c161839a",
            "patch": "@@ -345,6 +345,9 @@ stream.write('With ES6');\n <!-- YAML\n added: v0.3.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19259\n+    description: WeakMap and WeakSet entries can now be inspected as well.\n   - version: REPLACEME\n     pr-url: https://github.com/nodejs/node/pull/17907\n     description: The `depth` default changed to Infinity.\n@@ -369,7 +372,8 @@ changes:\n * `object` {any} Any JavaScript primitive or Object.\n * `options` {Object}\n   * `showHidden` {boolean} If `true`, the `object`'s non-enumerable symbols and\n-    properties will be included in the formatted result. Defaults to `false`.\n+    properties will be included in the formatted result as well as [`WeakMap`][]\n+    and [`WeakSet`][] entries. Defaults to `false`.\n   * `colors` {boolean} If `true`, the output will be styled with ANSI color\n     codes. Defaults to `false`. Colors are customizable, see\n     [Customizing `util.inspect` colors][].\n@@ -378,10 +382,14 @@ changes:\n   * `showProxy` {boolean} If `true`, then objects and functions that are\n     `Proxy` objects will be introspected to show their `target` and `handler`\n     objects. Defaults to `false`.\n-  * `maxArrayLength` {number} Specifies the maximum number of array and\n-    `TypedArray` elements to include when formatting. Defaults to `100`. Set to\n-    `null` or `Infinity` to show all array elements. Set to `0` or negative to\n-    show no array elements.\n+    <!--\n+    TODO(BridgeAR): Deprecate `maxArrayLength` and replace it with\n+                    `maxEntries`.\n+    -->\n+  * `maxArrayLength` {number} Specifies the maximum number of `Array`,\n+    [`TypedArray`][], [`WeakMap`][] and [`WeakSet`][] elements to include when\n+    formatting. Defaults to `100`. Set to `null` or `Infinity` to show all\n+    elements. Set to `0` or negative to show no elements.\n   * `breakLength` {number} The length at which an object's keys are split\n     across multiple lines. Set to `Infinity` to format an object as a single\n     line. Defaults to 60 for legacy compatibility.\n@@ -501,6 +509,25 @@ console.log(util.inspect(o, { compact: false, breakLength: 80 }));\n // chunks.\n ```\n \n+Using the `showHidden` option allows to inspect [`WeakMap`][] and [`WeakSet`][]\n+entries. If there are more entries than `maxArrayLength`, there is no guarantee\n+which entries are displayed. That means retrieving the same ['WeakSet'][]\n+entries twice might actually result in a different output. Besides this any item\n+might be collected at any point of time by the garbage collector if there is no\n+strong reference left to that object. Therefore there is no guarantee to get a\n+reliable output.\n+\n+```js\n+const { inspect } = require('util');\n+\n+const obj = { a: 1 };\n+const obj2 = { b: 2 };\n+const weakSet = new WeakSet([obj, obj2]);\n+\n+console.log(inspect(weakSet, { showHidden: true }));\n+// WeakSet { { a: 1 }, { b: 2 } }\n+```\n+\n Please note that `util.inspect()` is a synchronous method that is mainly\n intended as a debugging tool. Some input values can have a significant\n performance overhead that can block the event loop. Use this function"
        },
        {
            "sha": "01efe6f32900d4516b8daa52b75f82d4a2831375",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=1029dd36861d7ab592d4e219362706d2c161839a",
            "patch": "@@ -473,6 +473,8 @@\n     const v8 = NativeModule.require('internal/v8');\n     v8.previewMapIterator(new Map().entries());\n     v8.previewSetIterator(new Set().entries());\n+    v8.previewWeakMap(new WeakMap(), 1);\n+    v8.previewWeakSet(new WeakSet(), 1);\n     // Disable --allow_natives_syntax again unless it was explicitly\n     // specified on the command line.\n     const re = /^--allow[-_]natives[-_]syntax$/;"
        },
        {
            "sha": "3102b45a2d403262e1cfe123f2d27c8f62f11ddc",
            "filename": "lib/internal/v8.js",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Finternal%2Fv8.js",
            "raw_url": "https://github.com/nodejs/node/raw/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Finternal%2Fv8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fv8.js?ref=1029dd36861d7ab592d4e219362706d2c161839a",
            "patch": "@@ -17,7 +17,23 @@ function previewSetIterator(it) {\n   return %SetIteratorClone(it);\n }\n \n+// Retrieve all WeakMap instance key / value pairs up to `max`. `max` limits the\n+// number of key / value pairs returned. Make sure it is a positive number,\n+// otherwise V8 aborts. Passing through `0` returns all elements.\n+function previewWeakMap(weakMap, max) {\n+  return %GetWeakMapEntries(weakMap, max);\n+}\n+\n+// Retrieve all WeakSet instance values up to `max`. `max` limits the\n+// number of key / value pairs returned. Make sure it is a positive number,\n+// otherwise V8 aborts. Passing through `0` returns all elements.\n+function previewWeakSet(weakSet, max) {\n+  return %GetWeakSetValues(weakSet, max);\n+}\n+\n module.exports = {\n   previewMapIterator,\n-  previewSetIterator\n+  previewSetIterator,\n+  previewWeakMap,\n+  previewWeakSet\n };"
        },
        {
            "sha": "a9be7cbda4f2a0af3e7812c9e4cd1e51a8e64578",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 67,
            "deletions": 1,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/1029dd36861d7ab592d4e219362706d2c161839a/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=1029dd36861d7ab592d4e219362706d2c161839a",
            "patch": "@@ -32,7 +32,9 @@ const { isBuffer } = require('buffer').Buffer;\n \n const {\n   previewMapIterator,\n-  previewSetIterator\n+  previewSetIterator,\n+  previewWeakMap,\n+  previewWeakSet\n } = require('internal/v8');\n \n const {\n@@ -54,6 +56,8 @@ const {\n   isPromise,\n   isSet,\n   isSetIterator,\n+  isWeakMap,\n+  isWeakSet,\n   isRegExp,\n   isDate,\n   isTypedArray\n@@ -291,6 +295,8 @@ function inspect(value, opts) {\n     colors: inspectDefaultOptions.colors,\n     customInspect: inspectDefaultOptions.customInspect,\n     showProxy: inspectDefaultOptions.showProxy,\n+    // TODO(BridgeAR): Deprecate `maxArrayLength` and replace it with\n+    // `maxEntries`.\n     maxArrayLength: inspectDefaultOptions.maxArrayLength,\n     breakLength: inspectDefaultOptions.breakLength,\n     indentationLvl: 0,\n@@ -328,6 +334,8 @@ Object.defineProperty(inspect, 'defaultOptions', {\n     if (options === null || typeof options !== 'object') {\n       throw new ERR_INVALID_ARG_TYPE('options', 'Object', options);\n     }\n+    // TODO(BridgeAR): Add input validation and make sure `defaultOptions` are\n+    // not configurable.\n     return _extend(inspectDefaultOptions, options);\n   }\n });\n@@ -465,6 +473,7 @@ function formatValue(ctx, value, recurseTimes, ln) {\n   let braces;\n   let noIterator = true;\n   let raw;\n+  let extra;\n \n   // Iterators and the rest are split to reduce checks\n   if (value[Symbol.iterator]) {\n@@ -562,6 +571,20 @@ function formatValue(ctx, value, recurseTimes, ln) {\n     } else if (isPromise(value)) {\n       braces[0] = `${prefix}{`;\n       formatter = formatPromise;\n+    } else if (isWeakSet(value)) {\n+      braces[0] = `${prefix}{`;\n+      if (ctx.showHidden) {\n+        formatter = formatWeakSet;\n+      } else {\n+        extra = '[items unknown]';\n+      }\n+    } else if (isWeakMap(value)) {\n+      braces[0] = `${prefix}{`;\n+      if (ctx.showHidden) {\n+        formatter = formatWeakMap;\n+      } else {\n+        extra = '[items unknown]';\n+      }\n     } else {\n       // Check boxed primitives other than string with valueOf()\n       // NOTE: `Date` has to be checked first!\n@@ -616,6 +639,9 @@ function formatValue(ctx, value, recurseTimes, ln) {\n   ctx.seen.push(value);\n   const output = formatter(ctx, value, recurseTimes, keys);\n \n+  if (extra !== undefined)\n+    output.unshift(extra);\n+\n   for (var i = 0; i < symbols.length; i++) {\n     output.push(formatProperty(ctx, value, recurseTimes, symbols[i], 0));\n   }\n@@ -839,6 +865,46 @@ function formatMap(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n+function formatWeakSet(ctx, value, recurseTimes, keys) {\n+  const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n+  const entries = previewWeakSet(value, maxArrayLength + 1);\n+  const maxLength = Math.min(maxArrayLength, entries.length);\n+  let output = new Array(maxLength);\n+  for (var i = 0; i < maxLength; ++i)\n+    output[i] = formatValue(ctx, entries[i], recurseTimes);\n+  // Sort all entries to have a halfway reliable output (if more entries than\n+  // retrieved ones exist, we can not reliably return the same output).\n+  output = output.sort();\n+  if (entries.length > maxArrayLength)\n+    output.push('... more items');\n+  for (i = 0; i < keys.length; i++)\n+    output.push(formatProperty(ctx, value, recurseTimes, keys[i], 0));\n+  return output;\n+}\n+\n+function formatWeakMap(ctx, value, recurseTimes, keys) {\n+  const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n+  const entries = previewWeakMap(value, maxArrayLength + 1);\n+  // Entries exist as [key1, val1, key2, val2, ...]\n+  const remainder = entries.length / 2 > maxArrayLength;\n+  const len = entries.length / 2 - (remainder ? 1 : 0);\n+  const maxLength = Math.min(maxArrayLength, len);\n+  let output = new Array(maxLength);\n+  for (var i = 0; i < len; i++) {\n+    const pos = i * 2;\n+    output[i] = `${formatValue(ctx, entries[pos], recurseTimes)} => ` +\n+      formatValue(ctx, entries[pos + 1], recurseTimes);\n+  }\n+  // Sort all entries to have a halfway reliable output (if more entries than\n+  // retrieved ones exist, we can not reliably return the same output).\n+  output = output.sort();\n+  if (remainder > 0)\n+    output.push('... more items');\n+  for (i = 0; i < keys.length; i++)\n+    output.push(formatProperty(ctx, value, recurseTimes, keys[i], 0));\n+  return output;\n+}\n+\n function formatCollectionIterator(preview, ctx, value, recurseTimes, keys) {\n   const output = [];\n   for (const entry of preview(value)) {"
        },
        {
            "sha": "bdf446412126c0712a3c23d12a9337876cc9e751",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/1029dd36861d7ab592d4e219362706d2c161839a/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/1029dd36861d7ab592d4e219362706d2c161839a/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=1029dd36861d7ab592d4e219362706d2c161839a",
            "patch": "@@ -1351,3 +1351,51 @@ util.inspect(process);\n   expect = '{\\n  a: \\'12 45 78 01 34 \\' +\\n    \\'67 90 23\\'\\n}';\n   assert.strictEqual(out, expect);\n }\n+\n+{ // Test WeakMap\n+  const obj = {};\n+  const arr = [];\n+  const weakMap = new WeakMap([[obj, arr], [arr, obj]]);\n+  let out = util.inspect(weakMap, { showHidden: true });\n+  let expect = 'WeakMap { [ [length]: 0 ] => {}, {} => [ [length]: 0 ] }';\n+  assert.strictEqual(out, expect);\n+\n+  out = util.inspect(weakMap);\n+  expect = 'WeakMap { [items unknown] }';\n+  assert.strictEqual(out, expect);\n+\n+  out = util.inspect(weakMap, { maxArrayLength: 0, showHidden: true });\n+  expect = 'WeakMap { ... more items }';\n+  assert.strictEqual(out, expect);\n+\n+  weakMap.extra = true;\n+  out = util.inspect(weakMap, { maxArrayLength: 1, showHidden: true });\n+  // It is not possible to determine the output reliable.\n+  expect = 'WeakMap { [ [length]: 0 ] => {}, ... more items, extra: true }';\n+  const expectAlt = 'WeakMap { {} => [ [length]: 0 ], ... more items, ' +\n+                    'extra: true }';\n+  assert(out === expect || out === expectAlt);\n+}\n+\n+{ // Test WeakSet\n+  const weakSet = new WeakSet([{}, [1]]);\n+  let out = util.inspect(weakSet, { showHidden: true });\n+  let expect = 'WeakSet { [ 1, [length]: 1 ], {} }';\n+  assert.strictEqual(out, expect);\n+\n+  out = util.inspect(weakSet);\n+  expect = 'WeakSet { [items unknown] }';\n+  assert.strictEqual(out, expect);\n+\n+  out = util.inspect(weakSet, { maxArrayLength: -2, showHidden: true });\n+  expect = 'WeakSet { ... more items }';\n+  assert.strictEqual(out, expect);\n+\n+  weakSet.extra = true;\n+  out = util.inspect(weakSet, { maxArrayLength: 1, showHidden: true });\n+  // It is not possible to determine the output reliable.\n+  expect = 'WeakSet { {}, ... more items, extra: true }';\n+  const expectAlt = 'WeakSet { [ 1, [length]: 1 ], ... more items, ' +\n+                    'extra: true }';\n+  assert(out === expect || out === expectAlt);\n+}"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 166,
        "deletions": 7
    }
}