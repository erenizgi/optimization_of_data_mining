{
    "author": "BridgeAR",
    "message": "lib: require a callback for end-of-stream\n\nMake the callback mandatory as mostly done in all other Node.js\ncallback APIs so users explicitly have to decide what to do in error\ncases.\n\nThis also documents the options for `Stream.finished()`.\n\nWhen originally implemented it was missed that Stream.finished() has\nan optional options object.\n\nPR-URL: https://github.com/nodejs/node/pull/21058\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Mathias Buus <mathiasbuus@gmail.com>",
    "sha": "36468ca92862f2e1bc086be7e5e12ec8e012982b",
    "files": [
        {
            "sha": "f8180fa020321b282ae6d3eef634ec2e586029b2",
            "filename": "doc/api/stream.md",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/36468ca92862f2e1bc086be7e5e12ec8e012982b/doc%2Fapi%2Fstream.md",
            "raw_url": "https://github.com/nodejs/node/raw/36468ca92862f2e1bc086be7e5e12ec8e012982b/doc%2Fapi%2Fstream.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fstream.md?ref=36468ca92862f2e1bc086be7e5e12ec8e012982b",
            "patch": "@@ -1294,12 +1294,21 @@ implementors should not override this method, but instead implement\n [`readable._destroy()`][readable-_destroy].\n The default implementation of `_destroy()` for `Transform` also emit `'close'`.\n \n-### stream.finished(stream, callback)\n+### stream.finished(stream[, options], callback)\n <!-- YAML\n added: v10.0.0\n -->\n \n * `stream` {Stream} A readable and/or writable stream.\n+* `options` {Object}\n+  * `error` {boolean} If set to `false`, then a call to `emit('error', err)` is\n+    not treated as finished. **Default**: `true`.\n+  * `readable` {boolean} When set to `false`, the callback will be called when\n+    the stream ends even though the stream might still be readable.\n+    **Default**: `true`.\n+  * `writable` {boolean} When set to `false`, the callback will be called when\n+    the stream ends even though the stream might still be writable.\n+    **Default**: `true`.\n * `callback` {Function} A callback function that takes an optional error\n   argument.\n \n@@ -2438,7 +2447,7 @@ contain multi-byte characters.\n [zlib]: zlib.html\n [hwm-gotcha]: #stream_highwatermark_discrepancy_after_calling_readable_setencoding\n [pipeline]: #stream_stream_pipeline_streams_callback\n-[finished]: #stream_stream_finished_stream_callback\n+[finished]: #stream_stream_finished_stream_options_callback\n [stream-_flush]: #stream_transform_flush_callback\n [stream-_read]: #stream_readable_read_size_1\n [stream-_transform]: #stream_transform_transform_chunk_encoding_callback"
        },
        {
            "sha": "8bbd4827b23a3ab41e337b266173970e2e9977b5",
            "filename": "lib/internal/streams/end-of-stream.js",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/36468ca92862f2e1bc086be7e5e12ec8e012982b/lib%2Finternal%2Fstreams%2Fend-of-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/36468ca92862f2e1bc086be7e5e12ec8e012982b/lib%2Finternal%2Fstreams%2Fend-of-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fend-of-stream.js?ref=36468ca92862f2e1bc086be7e5e12ec8e012982b",
            "patch": "@@ -4,11 +4,10 @@\n 'use strict';\n \n const {\n+  ERR_INVALID_ARG_TYPE,\n   ERR_STREAM_PREMATURE_CLOSE\n } = require('internal/errors').codes;\n \n-function noop() {}\n-\n function isRequest(stream) {\n   return stream.setHeader && typeof stream.abort === 'function';\n }\n@@ -23,10 +22,19 @@ function once(callback) {\n }\n \n function eos(stream, opts, callback) {\n-  if (typeof opts === 'function') return eos(stream, null, opts);\n-  if (!opts) opts = {};\n+  if (arguments.length === 2) {\n+    callback = opts;\n+    opts = {};\n+  } else if (opts == null) {\n+    opts = {};\n+  } else if (typeof opts !== 'object') {\n+    throw new ERR_INVALID_ARG_TYPE('opts', 'object', opts);\n+  }\n+  if (typeof callback !== 'function') {\n+    throw new ERR_INVALID_ARG_TYPE('callback', 'function', callback);\n+  }\n \n-  callback = once(callback || noop);\n+  callback = once(callback);\n \n   const ws = stream._writableState;\n   const rs = stream._readableState;"
        },
        {
            "sha": "2d7eefc494623b3770e6a3b0bd8470f721eda9d0",
            "filename": "test/parallel/test-stream-finished.js",
            "status": "modified",
            "additions": 36,
            "deletions": 2,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/36468ca92862f2e1bc086be7e5e12ec8e012982b/test%2Fparallel%2Ftest-stream-finished.js",
            "raw_url": "https://github.com/nodejs/node/raw/36468ca92862f2e1bc086be7e5e12ec8e012982b/test%2Fparallel%2Ftest-stream-finished.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-finished.js?ref=36468ca92862f2e1bc086be7e5e12ec8e012982b",
            "patch": "@@ -91,8 +91,8 @@ const { promisify } = require('util');\n {\n   const rs = fs.createReadStream('file-does-not-exist');\n \n-  finished(rs, common.mustCall((err) => {\n-    assert.strictEqual(err.code, 'ENOENT');\n+  finished(rs, common.expectsError({\n+    code: 'ENOENT'\n   }));\n }\n \n@@ -119,3 +119,37 @@ const { promisify } = require('util');\n   rs.push(null);\n   rs.resume();\n }\n+\n+// Test faulty input values and options.\n+{\n+  const rs = new Readable({\n+    read() {}\n+  });\n+\n+  assert.throws(\n+    () => finished(rs, 'foo'),\n+    {\n+      name: /ERR_INVALID_ARG_TYPE/,\n+      message: /callback/\n+    }\n+  );\n+  assert.throws(\n+    () => finished(rs, 'foo', () => {}),\n+    {\n+      name: /ERR_INVALID_ARG_TYPE/,\n+      message: /opts/\n+    }\n+  );\n+  assert.throws(\n+    () => finished(rs, {}, 'foo'),\n+    {\n+      name: /ERR_INVALID_ARG_TYPE/,\n+      message: /callback/\n+    }\n+  );\n+\n+  finished(rs, null, common.mustCall());\n+\n+  rs.push(null);\n+  rs.resume();\n+}"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 60,
        "deletions": 9
    }
}