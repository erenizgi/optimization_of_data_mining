{
    "author": "Trott",
    "message": "test: refactor test-http-expect-continue\n\nUse common.mustCall() where appropriate. Remove some logic that is not\nrequired when common.mustCall() is used (incrementor/decrementor to make\nsure everything is called the same number of times).\n\nPR-URL: https://github.com/nodejs/node/pull/19625\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "ffe3f9a182141503395cc4c8da87aa1da9f20038",
    "files": [
        {
            "sha": "7d910f0778e88a7935846b6f0a211035ea25d693",
            "filename": "test/parallel/test-http-expect-continue.js",
            "status": "modified",
            "additions": 20,
            "deletions": 27,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/ffe3f9a182141503395cc4c8da87aa1da9f20038/test%2Fparallel%2Ftest-http-expect-continue.js",
            "raw_url": "https://github.com/nodejs/node/raw/ffe3f9a182141503395cc4c8da87aa1da9f20038/test%2Fparallel%2Ftest-http-expect-continue.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-expect-continue.js?ref=ffe3f9a182141503395cc4c8da87aa1da9f20038",
            "patch": "@@ -20,70 +20,63 @@\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n 'use strict';\n-require('../common');\n+const common = require('../common');\n const assert = require('assert');\n const http = require('http');\n \n-let outstanding_reqs = 0;\n const test_req_body = 'some stuff...\\n';\n const test_res_body = 'other stuff!\\n';\n let sent_continue = false;\n let got_continue = false;\n \n-function handler(req, res) {\n-  assert.strictEqual(sent_continue, true,\n-                     'Full response sent before 100 Continue');\n+const handler = common.mustCall((req, res) => {\n+  assert.ok(sent_continue, 'Full response sent before 100 Continue');\n   console.error('Server sending full response...');\n   res.writeHead(200, {\n     'Content-Type': 'text/plain',\n     'ABCD': '1'\n   });\n   res.end(test_res_body);\n-}\n+});\n \n-const server = http.createServer(handler);\n-server.on('checkContinue', function(req, res) {\n+const server = http.createServer();\n+server.on('checkContinue', common.mustCall((req, res) => {\n   console.error('Server got Expect: 100-continue...');\n   res.writeContinue();\n   sent_continue = true;\n   setTimeout(function() {\n     handler(req, res);\n   }, 100);\n-});\n+}));\n server.listen(0);\n \n \n-server.on('listening', function() {\n+server.on('listening', common.mustCall(() => {\n   const req = http.request({\n-    port: this.address().port,\n+    port: server.address().port,\n     method: 'POST',\n     path: '/world',\n     headers: { 'Expect': '100-continue' }\n   });\n   console.error('Client sending request...');\n-  outstanding_reqs++;\n   let body = '';\n-  req.on('continue', function() {\n+  req.on('continue', common.mustCall(() => {\n     console.error('Client got 100 Continue...');\n     got_continue = true;\n     req.end(test_req_body);\n-  });\n-  req.on('response', function(res) {\n-    assert.strictEqual(got_continue, true,\n-                       'Full response received before 100 Continue');\n+  }));\n+  req.on('response', common.mustCall((res) => {\n+    assert.ok(got_continue, 'Full response received before 100 Continue');\n     assert.strictEqual(200, res.statusCode,\n                        `Final status code was ${res.statusCode}, not 200.`);\n     res.setEncoding('utf8');\n     res.on('data', function(chunk) { body += chunk; });\n-    res.on('end', function() {\n+    res.on('end', common.mustCall(() => {\n       console.error('Got full response.');\n-      assert.strictEqual(body, test_res_body, 'Response body doesn\\'t match.');\n+      assert.strictEqual(body, test_res_body);\n       assert.ok('abcd' in res.headers, 'Response headers missing.');\n-      outstanding_reqs--;\n-      if (outstanding_reqs === 0) {\n-        server.close();\n-        process.exit();\n-      }\n-    });\n-  });\n-});\n+      server.close();\n+      process.exit();\n+    }));\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 20,
        "deletions": 27
    }
}