{
    "author": "mcollina",
    "message": "http: prevent slowloris with keepalive connections\n\nFixes: https://github.com/nodejs-private/security/issues/214\nPR-URL: https://github.com/nodejs-private/node-private/pull/158\nReviewed-By: Rod Vagg <rod@vagg.org>\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "667b31be954f3e97bdc19f1235c3625e627b3136",
    "files": [
        {
            "sha": "02cd7a81a9cc0b748c387a156f60117680ccf8e8",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/667b31be954f3e97bdc19f1235c3625e627b3136/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/667b31be954f3e97bdc19f1235c3625e627b3136/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=667b31be954f3e97bdc19f1235c3625e627b3136",
            "patch": "@@ -622,6 +622,10 @@ function emitCloseNT(self) {\n function parserOnIncoming(server, socket, state, req, keepAlive) {\n   resetSocketTimeout(server, socket, state);\n \n+  if (server.keepAliveTimeout > 0) {\n+    req.on('end', resetHeadersTimeoutOnReqEnd);\n+  }\n+\n   // Set to zero to communicate that we have finished parsing.\n   socket.parser.parsingHeadersStart = 0;\n \n@@ -745,6 +749,17 @@ function socketOnWrap(ev, fn) {\n   return res;\n }\n \n+function resetHeadersTimeoutOnReqEnd() {\n+  debug('resetHeadersTimeoutOnReqEnd');\n+\n+  const parser = this.socket.parser;\n+  // Parser can be null if the socket was destroyed\n+  // in that case, there is nothing to do.\n+  if (parser !== null) {\n+    parser.parsingHeadersStart = nowDate();\n+  }\n+}\n+\n module.exports = {\n   STATUS_CODES,\n   Server,"
        },
        {
            "sha": "5552f33f77e3c27ec0e410f523242d9263e1f337",
            "filename": "test/parallel/test-http-slow-headers-keepalive.js",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/667b31be954f3e97bdc19f1235c3625e627b3136/test%2Fparallel%2Ftest-http-slow-headers-keepalive.js",
            "raw_url": "https://github.com/nodejs/node/raw/667b31be954f3e97bdc19f1235c3625e627b3136/test%2Fparallel%2Ftest-http-slow-headers-keepalive.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-slow-headers-keepalive.js?ref=667b31be954f3e97bdc19f1235c3625e627b3136",
            "patch": "@@ -0,0 +1,51 @@\n+'use strict';\n+\n+const common = require('../common');\n+const http = require('http');\n+const net = require('net');\n+const { finished } = require('stream');\n+\n+const headers =\n+  'GET / HTTP/1.1\\r\\n' +\n+  'Host: localhost\\r\\n' +\n+  'Connection: keep-alive' +\n+  'Agent: node\\r\\n';\n+\n+let sendCharEvery = 1000;\n+\n+const server = http.createServer(common.mustCall((req, res) => {\n+  res.writeHead(200);\n+  res.end();\n+}));\n+\n+// Pass a REAL env variable to shortening up the default\n+// value which is 40s otherwise this is useful for manual\n+// testing\n+if (!process.env.REAL) {\n+  sendCharEvery = common.platformTimeout(10);\n+  server.headersTimeout = 2 * sendCharEvery;\n+}\n+\n+server.once('timeout', common.mustCall((socket) => {\n+  socket.destroy();\n+}));\n+\n+server.listen(0, () => {\n+  const client = net.connect(server.address().port);\n+  client.write(headers);\n+  // finish the first request\n+  client.write('\\r\\n');\n+  // second request\n+  client.write(headers);\n+  client.write('X-CRASH: ');\n+\n+  const interval = setInterval(() => {\n+    client.write('a');\n+  }, sendCharEvery);\n+\n+  client.resume();\n+  finished(client, common.mustCall((err) => {\n+    clearInterval(interval);\n+    server.close();\n+  }));\n+});"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 66,
        "deletions": 0
    }
}