{
    "author": "monkingxue",
    "message": "repl: add friendly tips about how to exit repl\n\nImitate python repl, when the user enters 'exit' or 'quit',\nno longer prompt 'Reference Error', but\nprompts 'To exit, press ^D or type .exit'.\nIf the user defines variables named 'exit' or 'quit' ,\nonly the value of the variables are output\n\nPR-URL: https://github.com/nodejs/node/pull/20617\nFixes: https://github.com/nodejs/node/issues/19021\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "9aa4ec43fce7fd9166459c98f347760cf450a350",
    "files": [
        {
            "sha": "928e7c6d69cfaeb79fd76024146ca4dc3235f9c7",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/9aa4ec43fce7fd9166459c98f347760cf450a350/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/9aa4ec43fce7fd9166459c98f347760cf450a350/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=9aa4ec43fce7fd9166459c98f347760cf450a350",
            "patch": "@@ -215,9 +215,15 @@ function REPLServer(prompt,\n \n   function defaultEval(code, context, file, cb) {\n     var err, result, script, wrappedErr;\n+    var isExitCommand = false;\n     var wrappedCmd = false;\n     var awaitPromise = false;\n     var input = code;\n+    var trimmedCommand = code.trim();\n+\n+    if (trimmedCommand === 'exit' || trimmedCommand === 'quit') {\n+      isExitCommand = true;\n+    }\n \n     if (/^\\s*\\{/.test(code) && /\\}\\s*$/.test(code)) {\n       // It's confusing for `{ a : 1 }` to be interpreted as a block\n@@ -313,10 +319,16 @@ function REPLServer(prompt,\n             breakOnSigint: self.breakEvalOnSigint\n           };\n \n+          const localContext = self.useGlobal ? global : self.context;\n+          if (isExitCommand && !localContext.hasOwnProperty(trimmedCommand)) {\n+            self.outputStream.write('(To exit, press ^D or type .exit)\\n');\n+            return self.displayPrompt();\n+          }\n+\n           if (self.useGlobal) {\n             result = script.runInThisContext(scriptOptions);\n           } else {\n-            result = script.runInContext(context, scriptOptions);\n+            result = script.runInContext(localContext, scriptOptions);\n           }\n         } finally {\n           if (self.breakEvalOnSigint) {\n@@ -332,12 +344,10 @@ function REPLServer(prompt,\n         }\n       } catch (e) {\n         err = e;\n-\n         if (err && err.code === 'ERR_SCRIPT_EXECUTION_INTERRUPTED') {\n-          // The stack trace for this case is not very useful anyway.\n+        // The stack trace for this case is not very useful anyway.\n           Object.defineProperty(err, 'stack', { value: '' });\n         }\n-\n         if (process.domain) {\n           debug('not recoverable, send to domain');\n           process.domain.emit('error', err);"
        },
        {
            "sha": "b9c92c3cd63bc08e1a86751e643fdb744ac97594",
            "filename": "test/parallel/test-repl.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/9aa4ec43fce7fd9166459c98f347760cf450a350/test%2Fparallel%2Ftest-repl.js",
            "raw_url": "https://github.com/nodejs/node/raw/9aa4ec43fce7fd9166459c98f347760cf450a350/test%2Fparallel%2Ftest-repl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl.js?ref=9aa4ec43fce7fd9166459c98f347760cf450a350",
            "patch": "@@ -132,6 +132,29 @@ const strictModeTests = [\n   }\n ];\n \n+const friendlyExitTests = [\n+  {\n+    send: 'exit',\n+    expect: '(To exit, press ^D or type .exit)'\n+  },\n+  {\n+    send: 'quit',\n+    expect: '(To exit, press ^D or type .exit)'\n+  },\n+  {\n+    send: 'quit = 1',\n+    expect: '1'\n+  },\n+  {\n+    send: 'quit',\n+    expect: '1'\n+  },\n+  {\n+    send: 'exit',\n+    expect: '(To exit, press ^D or type .exit)'\n+  },\n+];\n+\n const errorTests = [\n   // Uncaught error throws and prints out\n   {\n@@ -742,6 +765,7 @@ const tcpTests = [\n     const [ socket, replServer ] = await startUnixRepl();\n \n     await runReplTests(socket, prompt_unix, unixTests);\n+    await runReplTests(socket, prompt_unix, friendlyExitTests);\n     await runReplTests(socket, prompt_unix, errorTests);\n     replServer.replMode = repl.REPL_MODE_STRICT;\n     await runReplTests(socket, prompt_unix, strictModeTests);"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 38,
        "deletions": 4
    }
}