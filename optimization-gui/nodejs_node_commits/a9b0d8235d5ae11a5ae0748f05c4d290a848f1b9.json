{
    "author": "addaleax",
    "message": "src: access `ContextifyContext*` more directly in property cbs\n\nPR-URL: https://github.com/nodejs/node/pull/20455\nFixes: https://github.com/nodejs/node/issues/18897\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9",
    "files": [
        {
            "sha": "651e147617f43678192402bf861640c535e92115",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9",
            "patch": "@@ -121,7 +121,7 @@ Local<Value> ContextifyContext::CreateDataWrapper(Environment* env) {\n   if (wrapper.IsEmpty())\n     return scope.Escape(Local<Value>::New(env->isolate(), Local<Value>()));\n \n-  Wrap(wrapper, this);\n+  wrapper->SetAlignedPointerInInternalField(0, this);\n   return scope.Escape(wrapper);\n }\n \n@@ -291,12 +291,19 @@ ContextifyContext* ContextifyContext::ContextFromContextifiedSandbox(\n   return nullptr;\n }\n \n+// static\n+template <typename T>\n+ContextifyContext* ContextifyContext::Get(const PropertyCallbackInfo<T>& args) {\n+  Local<Value> data = args.Data();\n+  return static_cast<ContextifyContext*>(\n+      data.As<Object>()->GetAlignedPointerFromInternalField(0));\n+}\n+\n // static\n void ContextifyContext::PropertyGetterCallback(\n     Local<Name> property,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -325,8 +332,7 @@ void ContextifyContext::PropertySetterCallback(\n     Local<Name> property,\n     Local<Value> value,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -386,8 +392,7 @@ void ContextifyContext::PropertySetterCallback(\n void ContextifyContext::PropertyDescriptorCallback(\n     Local<Name> property,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -409,8 +414,7 @@ void ContextifyContext::PropertyDefinerCallback(\n     Local<Name> property,\n     const PropertyDescriptor& desc,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -472,8 +476,7 @@ void ContextifyContext::PropertyDefinerCallback(\n void ContextifyContext::PropertyDeleterCallback(\n     Local<Name> property,\n     const PropertyCallbackInfo<Boolean>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -492,8 +495,7 @@ void ContextifyContext::PropertyDeleterCallback(\n // static\n void ContextifyContext::PropertyEnumeratorCallback(\n     const PropertyCallbackInfo<Array>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -506,8 +508,7 @@ void ContextifyContext::PropertyEnumeratorCallback(\n void ContextifyContext::IndexedPropertyGetterCallback(\n     uint32_t index,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -522,8 +523,7 @@ void ContextifyContext::IndexedPropertySetterCallback(\n     uint32_t index,\n     Local<Value> value,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -537,8 +537,7 @@ void ContextifyContext::IndexedPropertySetterCallback(\n void ContextifyContext::IndexedPropertyDescriptorCallback(\n     uint32_t index,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -553,8 +552,7 @@ void ContextifyContext::IndexedPropertyDefinerCallback(\n     uint32_t index,\n     const PropertyDescriptor& desc,\n     const PropertyCallbackInfo<Value>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())\n@@ -568,8 +566,7 @@ void ContextifyContext::IndexedPropertyDefinerCallback(\n void ContextifyContext::IndexedPropertyDeleterCallback(\n     uint32_t index,\n     const PropertyCallbackInfo<Boolean>& args) {\n-  ContextifyContext* ctx;\n-  ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Data().As<Object>());\n+  ContextifyContext* ctx = ContextifyContext::Get(args);\n \n   // Still initializing\n   if (ctx->context_.IsEmpty())"
        },
        {
            "sha": "70ce091af3b58e96a8fc7c71e8b2af104e4769c6",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=a9b0d8235d5ae11a5ae0748f05c4d290a848f1b9",
            "patch": "@@ -55,6 +55,9 @@ class ContextifyContext {\n         context()->GetEmbedderData(ContextEmbedderIndex::kSandboxObject));\n   }\n \n+  template <typename T>\n+  static ContextifyContext* Get(const v8::PropertyCallbackInfo<T>& args);\n+\n  private:\n   static void MakeContext(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void IsContext(const v8::FunctionCallbackInfo<v8::Value>& args);"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}