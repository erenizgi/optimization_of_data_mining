{
    "author": "Trott",
    "message": "test: replace s_client in test-https-ci-reneg-attack\n\nReplace `s_client` in test-https-ci-reneg-attack with built-in\nclient calling `tls.renegotiate()`. This also fixes the currently-broken\ntest. (It is broken due to a change in behavior in a\nrecently-updated-in-core version of `s_client`.)\n\nPR-URL: https://github.com/nodejs/node/pull/25720\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "43c2a13c9334dad4b1f911dfcb455e8f8a9e4611",
    "files": [
        {
            "sha": "592dd6827320a125b52127c0f11d4201e29b565c",
            "filename": "test/pummel/test-https-ci-reneg-attack.js",
            "status": "modified",
            "additions": 34,
            "deletions": 38,
            "changes": 72,
            "blob_url": "https://github.com/nodejs/node/blob/43c2a13c9334dad4b1f911dfcb455e8f8a9e4611/test%2Fpummel%2Ftest-https-ci-reneg-attack.js",
            "raw_url": "https://github.com/nodejs/node/raw/43c2a13c9334dad4b1f911dfcb455e8f8a9e4611/test%2Fpummel%2Ftest-https-ci-reneg-attack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpummel%2Ftest-https-ci-reneg-attack.js?ref=43c2a13c9334dad4b1f911dfcb455e8f8a9e4611",
            "patch": "@@ -28,7 +28,6 @@ if (!common.opensslCli)\n   common.skip('node compiled without OpenSSL CLI.');\n \n const assert = require('assert');\n-const spawn = require('child_process').spawn;\n const tls = require('tls');\n const https = require('https');\n const fixtures = require('../common/fixtures');\n@@ -63,50 +62,47 @@ function test(next) {\n   });\n \n   server.listen(0, function() {\n-    const cmd = `s_client -connect 127.0.0.1:${server.address().port}`;\n-    const args = cmd.split(' ');\n-    const child = spawn(common.opensslCli, args);\n-\n-    child.stdout.resume();\n-    child.stderr.resume();\n+    const agent = https.Agent({\n+      keepAlive: true,\n+    });\n \n-    // Count handshakes, start the attack after the initial handshake is done\n-    let handshakes = 0;\n+    let client;\n     let renegs = 0;\n \n-    child.stderr.on('data', function(data) {\n-      handshakes += ((String(data)).match(/verify return:1/g) || []).length;\n-      if (handshakes === 2) spam();\n-      renegs += ((String(data)).match(/RENEGOTIATING/g) || []).length;\n-    });\n+    const options = {\n+      rejectUnauthorized: false,\n+      agent\n+    };\n \n-    child.on('exit', function() {\n-      assert.strictEqual(renegs, tls.CLIENT_RENEG_LIMIT + 1);\n-      server.close();\n-      process.nextTick(next);\n-    });\n+    const { port } = server.address();\n+\n+    https.get(`https://localhost:${port}/`, options, (res) => {\n+      client = res.socket;\n \n-    let closed = false;\n-    child.stdin.on('error', function(err) {\n-      switch (err.code) {\n-        case 'ECONNRESET':\n-        case 'EPIPE':\n-          break;\n-        default:\n-          assert.strictEqual(err.code, 'ECONNRESET');\n-          break;\n+      client.on('close', function(hadErr) {\n+        assert.strictEqual(hadErr, false);\n+        assert.strictEqual(renegs, tls.CLIENT_RENEG_LIMIT + 1);\n+        server.close();\n+        process.nextTick(next);\n+      });\n+\n+      client.on('error', function(err) {\n+        console.log('CLIENT ERR', err);\n+        throw err;\n+      });\n+\n+      spam();\n+\n+      // simulate renegotiation attack\n+      function spam() {\n+        client.renegotiate({}, (err) => {\n+          assert.ifError(err);\n+          assert.ok(renegs <= tls.CLIENT_RENEG_LIMIT);\n+          setImmediate(spam);\n+        });\n+        renegs++;\n       }\n-      closed = true;\n-    });\n-    child.stdin.on('close', function() {\n-      closed = true;\n     });\n \n-    // simulate renegotiation attack\n-    function spam() {\n-      if (closed) return;\n-      child.stdin.write('R\\n');\n-      setTimeout(spam, 50);\n-    }\n   });\n }"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 34,
        "deletions": 38
    }
}