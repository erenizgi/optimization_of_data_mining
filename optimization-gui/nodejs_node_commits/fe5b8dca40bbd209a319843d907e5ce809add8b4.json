{
    "author": "tniessen",
    "message": "crypto: fix zero byte allocation assertion failure\n\nWhen an empty string was passed, malloc might have returned a nullptr\ndepending on the platform, causing an assertion failure. This change\nmakes private key parsing behave as public key parsing does, causing\na BIO error instead that can be caught in JS.\n\nFixes: https://github.com/nodejs/node/issues/25247\n\nPR-URL: https://github.com/nodejs/node/pull/25248\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "fe5b8dca40bbd209a319843d907e5ce809add8b4",
    "files": [
        {
            "sha": "c18432b6205105cf94c59ed1a88b4be591a60ab0",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/fe5b8dca40bbd209a319843d907e5ce809add8b4/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fe5b8dca40bbd209a319843d907e5ce809add8b4/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=fe5b8dca40bbd209a319843d907e5ce809add8b4",
            "patch": "@@ -2696,7 +2696,7 @@ static bool IsSupportedAuthenticatedMode(const EVP_CIPHER_CTX* ctx) {\n template <typename T>\n static T* MallocOpenSSL(size_t count) {\n   void* mem = OPENSSL_malloc(MultiplyWithOverflowCheck(count, sizeof(T)));\n-  CHECK_NOT_NULL(mem);\n+  CHECK_IMPLIES(mem == nullptr, count == 0);\n   return static_cast<T*>(mem);\n }\n \n@@ -2854,7 +2854,8 @@ static EVPKeyPointer ParsePrivateKey(const PrivateKeyEncodingConfig& config,\n \n   if (config.format_ == kKeyFormatPEM) {\n     BIOPointer bio(BIO_new_mem_buf(key, key_len));\n-    CHECK(bio);\n+    if (!bio)\n+      return pkey;\n \n     char* pass = const_cast<char*>(config.passphrase_.get());\n     pkey.reset(PEM_read_bio_PrivateKey(bio.get(),\n@@ -2869,7 +2870,8 @@ static EVPKeyPointer ParsePrivateKey(const PrivateKeyEncodingConfig& config,\n       pkey.reset(d2i_PrivateKey(EVP_PKEY_RSA, nullptr, &p, key_len));\n     } else if (config.type_.ToChecked() == kKeyEncodingPKCS8) {\n       BIOPointer bio(BIO_new_mem_buf(key, key_len));\n-      CHECK(bio);\n+      if (!bio)\n+        return pkey;\n       char* pass = const_cast<char*>(config.passphrase_.get());\n       pkey.reset(d2i_PKCS8PrivateKey_bio(bio.get(),\n                                          nullptr,"
        },
        {
            "sha": "8a28ac996084a5944d0d9c77e3cd06248ccadbb5",
            "filename": "test/parallel/test-crypto-key-objects.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/fe5b8dca40bbd209a319843d907e5ce809add8b4/test%2Fparallel%2Ftest-crypto-key-objects.js",
            "raw_url": "https://github.com/nodejs/node/raw/fe5b8dca40bbd209a319843d907e5ce809add8b4/test%2Fparallel%2Ftest-crypto-key-objects.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-key-objects.js?ref=fe5b8dca40bbd209a319843d907e5ce809add8b4",
            "patch": "@@ -105,3 +105,10 @@ const privatePem = fixtures.readSync('test_rsa_privkey.pem', 'ascii');\n     }\n   }\n }\n+\n+{\n+  // This should not cause a crash: https://github.com/nodejs/node/issues/25247\n+  assert.throws(() => {\n+    createPrivateKey({ key: '' });\n+  }, /null/);\n+}"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}