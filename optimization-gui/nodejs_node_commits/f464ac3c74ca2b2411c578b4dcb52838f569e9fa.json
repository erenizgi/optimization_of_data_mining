{
    "author": "ryzokuken",
    "message": "src: remove calls to deprecated v8 functions (IntegerValue)\n\nRemove all calls to deprecated v8 functions (here:\nValue::IntegerValue) inside the code (src directory only).\n\nCo-authored-by: MichaÃ«l Zasso <targos@protonmail.com>\n\nPR-URL: https://github.com/nodejs/node/pull/22129\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
    "files": [
        {
            "sha": "d1ce0ce1af38704bd03114db0bb5f2ff7d40f948",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -2395,11 +2395,10 @@ void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n     return env->ThrowError(\"Invalid number of arguments.\");\n   }\n \n-  pid_t pid;\n-  int r;\n+  CHECK(args[0]->IsNumber());\n+  pid_t pid = args[0].As<Integer>()->Value();\n+  int r = kill(pid, SIGUSR1);\n \n-  pid = args[0]->IntegerValue();\n-  r = kill(pid, SIGUSR1);\n   if (r != 0) {\n     return env->ThrowErrnoException(errno, \"kill\");\n   }\n@@ -2417,7 +2416,6 @@ static int GetDebugSignalHandlerMappingName(DWORD pid, wchar_t* buf,\n static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Isolate* isolate = args.GetIsolate();\n-  DWORD pid;\n   HANDLE process = nullptr;\n   HANDLE thread = nullptr;\n   HANDLE mapping = nullptr;\n@@ -2429,7 +2427,8 @@ static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n     goto out;\n   }\n \n-  pid = (DWORD) args[0]->IntegerValue();\n+  CHECK(args[0]->IsNumber());\n+  DWORD pid = args[0].As<Integer>()->Value();\n \n   process = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION |\n                             PROCESS_VM_OPERATION | PROCESS_VM_WRITE |"
        },
        {
            "sha": "465c42047911b017e15a50eee56fa8f3ddbb2410",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -173,7 +173,8 @@ inline MUST_USE_RESULT bool ParseArrayIndex(Local<Value> arg,\n     return true;\n   }\n \n-  int64_t tmp_i = arg->IntegerValue();\n+  CHECK(arg->IsNumber());\n+  int64_t tmp_i = arg.As<Integer>()->Value();\n \n   if (tmp_i < 0)\n     return false;\n@@ -769,7 +770,7 @@ void IndexOfString(const FunctionCallbackInfo<Value>& args) {\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n \n   Local<String> needle = args[1].As<String>();\n-  int64_t offset_i64 = args[2]->IntegerValue();\n+  int64_t offset_i64 = args[2].As<Integer>()->Value();\n   bool is_forward = args[4]->IsTrue();\n \n   const char* haystack = ts_obj_data;\n@@ -885,7 +886,7 @@ void IndexOfBuffer(const FunctionCallbackInfo<Value>& args) {\n   THROW_AND_RETURN_UNLESS_BUFFER(Environment::GetCurrent(args), args[1]);\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n   SPREAD_BUFFER_ARG(args[1], buf);\n-  int64_t offset_i64 = args[2]->IntegerValue();\n+  int64_t offset_i64 = args[2].As<Integer>()->Value();\n   bool is_forward = args[4]->IsTrue();\n \n   const char* haystack = ts_obj_data;\n@@ -955,7 +956,7 @@ void IndexOfNumber(const FunctionCallbackInfo<Value>& args) {\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n \n   uint32_t needle = args[1].As<Uint32>()->Value();\n-  int64_t offset_i64 = args[2]->IntegerValue();\n+  int64_t offset_i64 = args[2].As<Integer>()->Value();\n   bool is_forward = args[3]->IsTrue();\n \n   int64_t opt_offset = IndexOfOffset(ts_obj_length, offset_i64, 1, is_forward);"
        },
        {
            "sha": "0ebebec5d2437a59bffdd885f3968f87903f8e94",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -985,15 +985,16 @@ void SecureContext::SetDHParam(const FunctionCallbackInfo<Value>& args) {\n void SecureContext::SetOptions(const FunctionCallbackInfo<Value>& args) {\n   SecureContext* sc;\n   ASSIGN_OR_RETURN_UNWRAP(&sc, args.Holder());\n+  int64_t val;\n \n-  if (args.Length() != 1 || !args[0]->IntegerValue()) {\n+  if (args.Length() != 1 ||\n+      !args[0]->IntegerValue(args.GetIsolate()->GetCurrentContext()).To(&val)) {\n     return THROW_ERR_INVALID_ARG_TYPE(\n         sc->env(), \"Options must be an integer value\");\n   }\n \n-  SSL_CTX_set_options(\n-      sc->ctx_.get(),\n-      static_cast<long>(args[0]->IntegerValue()));  // NOLINT(runtime/int)\n+  SSL_CTX_set_options(sc->ctx_.get(),\n+                      static_cast<long>(val));  // NOLINT(runtime/int)\n }\n \n "
        },
        {
            "sha": "07dd800b256abb06de499492b27ef56907bfc7f3",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -289,12 +289,16 @@ class Parser : public AsyncWrap, public StreamListener {\n     MaybeLocal<Value> head_response =\n         MakeCallback(cb.As<Function>(), arraysize(argv), argv);\n \n-    if (head_response.IsEmpty()) {\n+    int64_t val;\n+\n+    if (head_response.IsEmpty() || !head_response.ToLocalChecked()\n+                                        ->IntegerValue(env()->context())\n+                                        .To(&val)) {\n       got_exception_ = true;\n       return -1;\n     }\n \n-    return head_response.ToLocalChecked()->IntegerValue();\n+    return val;\n   }\n \n "
        },
        {
            "sha": "2841595c1f186bec5a802bec6aa31c0ef77886b6",
            "filename": "src/process_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fprocess_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fprocess_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fprocess_wrap.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -132,8 +132,9 @@ class ProcessWrap : public HandleWrap {\n         options->stdio[i].data.stream = stream;\n       } else {\n         Local<String> fd_key = env->fd_string();\n-        int fd = static_cast<int>(\n-            stdio->Get(context, fd_key).ToLocalChecked()->IntegerValue());\n+        Local<Value> fd_value = stdio->Get(context, fd_key).ToLocalChecked();\n+        CHECK(fd_value->IsNumber());\n+        int fd = static_cast<int>(fd_value.As<Integer>()->Value());\n         options->stdio[i].flags = UV_INHERIT_FD;\n         options->stdio[i].data.fd = fd;\n       }"
        },
        {
            "sha": "d8080319aa904cf84b75d1236809058a2a685dfb",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -207,7 +207,10 @@ void TCPWrap::Open(const FunctionCallbackInfo<Value>& args) {\n   ASSIGN_OR_RETURN_UNWRAP(&wrap,\n                           args.Holder(),\n                           args.GetReturnValue().Set(UV_EBADF));\n-  int fd = static_cast<int>(args[0]->IntegerValue());\n+  int64_t val;\n+  if (!args[0]->IntegerValue(args.GetIsolate()->GetCurrentContext()).To(&val))\n+    return;\n+  int fd = static_cast<int>(val);\n   int err = uv_tcp_open(&wrap->handle_, fd);\n \n   if (err == 0)"
        },
        {
            "sha": "8005eeb9ff76e2544bdaa872ea727a0b96204939",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f464ac3c74ca2b2411c578b4dcb52838f569e9fa/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=f464ac3c74ca2b2411c578b4dcb52838f569e9fa",
            "patch": "@@ -215,7 +215,8 @@ void UDPWrap::Open(const FunctionCallbackInfo<Value>& args) {\n   ASSIGN_OR_RETURN_UNWRAP(&wrap,\n                           args.Holder(),\n                           args.GetReturnValue().Set(UV_EBADF));\n-  int fd = static_cast<int>(args[0]->IntegerValue());\n+  CHECK(args[0]->IsNumber());\n+  int fd = static_cast<int>(args[0].As<Integer>()->Value());\n   int err = uv_udp_open(&wrap->handle_, fd);\n \n   args.GetReturnValue().Set(err);"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 30,
        "deletions": 20
    }
}