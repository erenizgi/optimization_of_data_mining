{
    "author": "addaleax",
    "message": "src: pass along errors from PromiseWrap instantiation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "55569759b32b61a94c57283e2030e737ae06c860",
    "files": [
        {
            "sha": "193fec7ca7087a2e8279bd0c7820d937f404686b",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/55569759b32b61a94c57283e2030e737ae06c860/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/55569759b32b61a94c57283e2030e737ae06c860/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=55569759b32b61a94c57283e2030e737ae06c860",
            "patch": "@@ -201,15 +201,15 @@ PromiseWrap* PromiseWrap::New(Environment* env,\n                               Local<Promise> promise,\n                               PromiseWrap* parent_wrap,\n                               bool silent) {\n-  Local<Object> object = env->promise_wrap_template()\n-                            ->NewInstance(env->context()).ToLocalChecked();\n-  object->SetInternalField(PromiseWrap::kIsChainedPromiseField,\n-                           parent_wrap != nullptr ?\n-                              v8::True(env->isolate()) :\n-                              v8::False(env->isolate()));\n+  Local<Object> obj;\n+  if (!env->promise_wrap_template()->NewInstance(env->context()).ToLocal(&obj))\n+    return nullptr;\n+  obj->SetInternalField(PromiseWrap::kIsChainedPromiseField,\n+                        parent_wrap != nullptr ? v8::True(env->isolate())\n+                                               : v8::False(env->isolate()));\n   CHECK_EQ(promise->GetAlignedPointerFromInternalField(0), nullptr);\n-  promise->SetInternalField(0, object);\n-  return new PromiseWrap(env, object, silent);\n+  promise->SetInternalField(0, obj);\n+  return new PromiseWrap(env, obj, silent);\n }\n \n void PromiseWrap::getIsChainedPromise(Local<String> property,\n@@ -242,6 +242,7 @@ static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n       PromiseWrap* parent_wrap = extractPromiseWrap(parent_promise);\n       if (parent_wrap == nullptr) {\n         parent_wrap = PromiseWrap::New(env, parent_promise, nullptr, true);\n+        if (parent_wrap == nullptr) return;\n       }\n \n       AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent_wrap);\n@@ -251,7 +252,8 @@ static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n     }\n   }\n \n-  CHECK_NOT_NULL(wrap);\n+  if (wrap == nullptr) return;\n+\n   if (type == PromiseHookType::kBefore) {\n     env->async_hooks()->push_async_ids(\n       wrap->get_async_id(), wrap->get_trigger_async_id());"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 11,
        "deletions": 9
    }
}