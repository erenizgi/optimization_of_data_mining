{
    "author": "dbkaplun",
    "message": "console: don't swallow call stack exceeded errors\n\nFixes test/parallel/test-console-no-swallow-stack-exceeded.js\n\nPR-URL: https://github.com/nodejs/node/pull/19423\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "d49661bb80dd6d9c012dc718bcec45c89fe2e3e1",
    "files": [
        {
            "sha": "d70a6b30b7298c5bcdb0e28a8553c52d9ce826e1",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 5,
            "deletions": 12,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=d49661bb80dd6d9c012dc718bcec45c89fe2e3e1",
            "patch": "@@ -21,15 +21,16 @@\n \n 'use strict';\n \n-const { ERR_CONSOLE_WRITABLE_STREAM } = require('internal/errors').codes;\n+const {\n+  isStackOverflowError,\n+  codes: { ERR_CONSOLE_WRITABLE_STREAM },\n+} = require('internal/errors');\n const util = require('util');\n const kCounts = Symbol('counts');\n \n // Track amount of indentation required via `console.group()`.\n const kGroupIndent = Symbol('groupIndent');\n \n-let MAX_STACK_MESSAGE;\n-\n function Console(stdout, stderr, ignoreErrors = true) {\n   if (!(this instanceof Console)) {\n     return new Console(stdout, stderr, ignoreErrors);\n@@ -113,17 +114,9 @@ function write(ignoreErrors, stream, string, errorhandler, groupIndent) {\n \n     stream.write(string, errorhandler);\n   } catch (e) {\n-    if (MAX_STACK_MESSAGE === undefined) {\n-      try {\n-        // eslint-disable-next-line no-unused-vars\n-        function a() { a(); }\n-      } catch (err) {\n-        MAX_STACK_MESSAGE = err.message;\n-      }\n-    }\n     // console is a debugging utility, so it swallowing errors is not desirable\n     // even in edge cases such as low stack space.\n-    if (e.message === MAX_STACK_MESSAGE && e.name === 'RangeError')\n+    if (isStackOverflowError(e))\n       throw e;\n     // Sorry, there's no proper way to pass along the error here.\n   } finally {"
        },
        {
            "sha": "16b4cd2416f37f81ffd38a2aad38b6e983c5eed8",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=d49661bb80dd6d9c012dc718bcec45c89fe2e3e1",
            "patch": "@@ -569,11 +569,33 @@ function dnsException(err, syscall, hostname) {\n   return ex;\n }\n \n+let MAX_STACK_MESSAGE;\n+/**\n+ * Returns true if `err` is a `RangeError` with an engine-specific message.\n+ * \"Maximum call stack size exceeded\" in V8.\n+ *\n+ * @param {Error} err\n+ * @returns {boolean}\n+ */\n+function isStackOverflowError(err) {\n+  if (MAX_STACK_MESSAGE === undefined) {\n+    try {\n+      function overflowStack() { overflowStack(); }\n+      overflowStack();\n+    } catch (err) {\n+      MAX_STACK_MESSAGE = err.message;\n+    }\n+  }\n+\n+  return err.name === 'RangeError' && err.message === MAX_STACK_MESSAGE;\n+}\n+\n module.exports = exports = {\n   dnsException,\n   errnoException,\n   exceptionWithHostPort,\n   uvException,\n+  isStackOverflowError,\n   message,\n   AssertionError,\n   SystemError,"
        },
        {
            "sha": "f36ba4857e363b924653ef539248fb1cf44d9123",
            "filename": "test/parallel/test-console-no-swallow-stack-overflow.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/test%2Fparallel%2Ftest-console-no-swallow-stack-overflow.js",
            "raw_url": "https://github.com/nodejs/node/raw/d49661bb80dd6d9c012dc718bcec45c89fe2e3e1/test%2Fparallel%2Ftest-console-no-swallow-stack-overflow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-console-no-swallow-stack-overflow.js?ref=d49661bb80dd6d9c012dc718bcec45c89fe2e3e1",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+const common = require('../common');\n+const { Console } = require('console');\n+const { Writable } = require('stream');\n+\n+for (const method of ['dir', 'log', 'warn']) {\n+  common.expectsError(() => {\n+    const out = new Writable({\n+      write: common.mustCall(function write(...args) {\n+        // Exceeds call stack.\n+        return write(...args);\n+      }),\n+    });\n+    const c = new Console(out, out, true);\n+\n+    c[method]('Hello, world!');\n+  }, { name: 'RangeError' });\n+}"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 45,
        "deletions": 12
    }
}