{
    "author": "addaleax",
    "message": "src: use offset calc. instead of `req->data` in node_file\n\nA small refactor – this removes one layer of pointer indirection.\n(The performance gain is likely negligible, the main point here\nbeing that this encapsulates libuv request management a bit more.)\n\nPR-URL: https://github.com/nodejs/node/pull/21839\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nießen <tniessen@tnie.de>\nReviewed-By: Jon Moss <me@jonathanmoss.me>",
    "sha": "2d32a7e90a510044330d55c599ad6c59e92779f5",
    "files": [
        {
            "sha": "8414a22ad4cd5fa72a94726d617149dbfc3aded5",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/2d32a7e90a510044330d55c599ad6c59e92779f5/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2d32a7e90a510044330d55c599ad6c59e92779f5/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=2d32a7e90a510044330d55c599ad6c59e92779f5",
            "patch": "@@ -221,7 +221,7 @@ inline MaybeLocal<Promise> FileHandle::ClosePromise() {\n     closing_ = true;\n     CloseReq* req = new CloseReq(env(), promise, object());\n     auto AfterClose = uv_fs_callback_t{[](uv_fs_t* req) {\n-      CloseReq* close = static_cast<CloseReq*>(req->data);\n+      CloseReq* close = CloseReq::from_req(req);\n       CHECK_NOT_NULL(close);\n       close->file_handle()->AfterClose();\n       Isolate* isolate = close->env()->isolate();\n@@ -475,15 +475,15 @@ bool FSReqAfterScope::Proceed() {\n }\n \n void AfterNoArgs(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed())\n     req_wrap->Resolve(Undefined(req_wrap->env()->isolate()));\n }\n \n void AfterStat(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed()) {\n@@ -492,15 +492,15 @@ void AfterStat(uv_fs_t* req) {\n }\n \n void AfterInteger(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed())\n     req_wrap->Resolve(Integer::New(req_wrap->env()->isolate(), req->result));\n }\n \n void AfterOpenFileHandle(uv_fs_t* req) {\n-  FSReqWrap* req_wrap = static_cast<FSReqWrap*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed()) {\n@@ -510,7 +510,7 @@ void AfterOpenFileHandle(uv_fs_t* req) {\n }\n \n void AfterStringPath(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   MaybeLocal<Value> link;\n@@ -529,7 +529,7 @@ void AfterStringPath(uv_fs_t* req) {\n }\n \n void AfterStringPtr(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   MaybeLocal<Value> link;\n@@ -548,7 +548,7 @@ void AfterStringPtr(uv_fs_t* req) {\n }\n \n void AfterScanDir(uv_fs_t* req) {\n-  FSReqBase* req_wrap = static_cast<FSReqBase*>(req->data);\n+  FSReqBase* req_wrap = FSReqBase::from_req(req);\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed()) {"
        },
        {
            "sha": "141d1d42d744a241f731b825370e0999ae14ec53",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2d32a7e90a510044330d55c599ad6c59e92779f5/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/2d32a7e90a510044330d55c599ad6c59e92779f5/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=2d32a7e90a510044330d55c599ad6c59e92779f5",
            "patch": "@@ -68,6 +68,10 @@ class FSReqBase : public ReqWrap<uv_fs_t> {\n \n   bool use_bigint() const { return use_bigint_; }\n \n+  static FSReqBase* from_req(uv_fs_t* req) {\n+    return static_cast<FSReqBase*>(ReqWrap::from_req(req));\n+  }\n+\n  private:\n   enum encoding encoding_ = UTF8;\n   bool has_data_ = false;\n@@ -284,6 +288,10 @@ class FileHandle : public AsyncWrap, public StreamBase {\n \n     void Reject(Local<Value> reason);\n \n+    static CloseReq* from_req(uv_fs_t* req) {\n+      return static_cast<CloseReq*>(ReqWrap::from_req(req));\n+    }\n+\n    private:\n     Persistent<Promise> promise_;\n     Persistent<Value> ref_;"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 16,
        "deletions": 8
    }
}