{
    "author": "jasnell",
    "message": "http2: add ping event\n\nAdd a `Http2Session` event whenever a non-ack `PING` is received.\n\nFixes: https://github.com/nodejs/node/issues/18514\n\nPR-URL: https://github.com/nodejs/node/pull/23009\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "a0c1326257b9679b056d8611ccdee2d6757b0bf0",
    "files": [
        {
            "sha": "698f1bf2d87e589a9cab6e59f502c80f732cabfa",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/a0c1326257b9679b056d8611ccdee2d6757b0bf0/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/a0c1326257b9679b056d8611ccdee2d6757b0bf0/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=a0c1326257b9679b056d8611ccdee2d6757b0bf0",
            "patch": "@@ -222,6 +222,16 @@ session.on('localSettings', (settings) => {\n });\n ```\n \n+#### Event: 'ping'\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `payload` {Buffer} The `PING` frame 8-byte payload\n+\n+The `'ping'` event is emitted whenever a `PING` frame is received from the\n+connected peer.\n+\n #### Event: 'remoteSettings'\n <!-- YAML\n added: v8.4.0"
        },
        {
            "sha": "d5ea26374fcaeca801415179874ff007baa9ce43",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/a0c1326257b9679b056d8611ccdee2d6757b0bf0/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/a0c1326257b9679b056d8611ccdee2d6757b0bf0/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=a0c1326257b9679b056d8611ccdee2d6757b0bf0",
            "patch": "@@ -346,6 +346,15 @@ function submitRstStream(code) {\n   }\n }\n \n+function onPing(payload) {\n+  const session = this[kOwner];\n+  if (session.destroyed)\n+    return;\n+  session[kUpdateTimer]();\n+  debug(`Http2Session ${sessionName(session[kType])}: new ping received`);\n+  session.emit('ping', payload);\n+}\n+\n // Called when the stream is closed either by sending or receiving an\n // RST_STREAM frame, or through a natural end-of-stream.\n // If the writable and readable sides of the stream are still open at this\n@@ -821,6 +830,7 @@ function setupHandle(socket, type, options) {\n   handle.error = onSessionInternalError;\n   handle.onpriority = onPriority;\n   handle.onsettings = onSettings;\n+  handle.onping = onPing;\n   handle.onheaders = onSessionHeaders;\n   handle.onframeerror = onFrameError;\n   handle.ongoawaydata = onGoawayData;"
        },
        {
            "sha": "504bb5db2f44548a5785ac27ca51d8f17b94e836",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/a0c1326257b9679b056d8611ccdee2d6757b0bf0/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/a0c1326257b9679b056d8611ccdee2d6757b0bf0/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=a0c1326257b9679b056d8611ccdee2d6757b0bf0",
            "patch": "@@ -229,6 +229,7 @@ struct PackageConfig {\n   V(onread_string, \"onread\")                                                  \\\n   V(onreadstart_string, \"onreadstart\")                                        \\\n   V(onreadstop_string, \"onreadstop\")                                          \\\n+  V(onping_string, \"onping\")                                                  \\\n   V(onsettings_string, \"onsettings\")                                          \\\n   V(onshutdown_string, \"onshutdown\")                                          \\\n   V(onsignal_string, \"onsignal\")                                              \\"
        },
        {
            "sha": "7dc695ba797b1f8691651044e79dc22d57a0d3a1",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/a0c1326257b9679b056d8611ccdee2d6757b0bf0/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a0c1326257b9679b056d8611ccdee2d6757b0bf0/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=a0c1326257b9679b056d8611ccdee2d6757b0bf0",
            "patch": "@@ -1457,6 +1457,11 @@ void Http2Session::HandleOriginFrame(const nghttp2_frame* frame) {\n \n // Called by OnFrameReceived when a complete PING frame has been received.\n void Http2Session::HandlePingFrame(const nghttp2_frame* frame) {\n+  Isolate* isolate = env()->isolate();\n+  HandleScope scope(isolate);\n+  Local<Context> context = env()->context();\n+  Context::Scope context_scope(context);\n+  Local<Value> arg;\n   bool ack = frame->hd.flags & NGHTTP2_FLAG_ACK;\n   if (ack) {\n     Http2Ping* ping = PopPing();\n@@ -1468,13 +1473,15 @@ void Http2Session::HandlePingFrame(const nghttp2_frame* frame) {\n       // receive an unsolicited PING ack on a connection. Either the peer\n       // is buggy or malicious, and we're not going to tolerate such\n       // nonsense.\n-      Isolate* isolate = env()->isolate();\n-      HandleScope scope(isolate);\n-      Local<Context> context = env()->context();\n-      Context::Scope context_scope(context);\n-      Local<Value> arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n+      arg = Integer::New(isolate, NGHTTP2_ERR_PROTO);\n       MakeCallback(env()->error_string(), 1, &arg);\n     }\n+  } else {\n+    // Notify the session that a ping occurred\n+    arg = Buffer::Copy(env(),\n+                       reinterpret_cast<const char*>(frame->ping.opaque_data),\n+                       8).ToLocalChecked();\n+    MakeCallback(env()->onping_string(), 1, &arg);\n   }\n }\n "
        },
        {
            "sha": "134a94ddb8f5824d0951d44d7e11adfca5d2ec99",
            "filename": "test/parallel/test-http2-onping.js",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/a0c1326257b9679b056d8611ccdee2d6757b0bf0/test%2Fparallel%2Ftest-http2-onping.js",
            "raw_url": "https://github.com/nodejs/node/raw/a0c1326257b9679b056d8611ccdee2d6757b0bf0/test%2Fparallel%2Ftest-http2-onping.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-onping.js?ref=a0c1326257b9679b056d8611ccdee2d6757b0bf0",
            "patch": "@@ -0,0 +1,48 @@\n+'use strict';\n+\n+const {\n+  hasCrypto,\n+  mustCall,\n+  skip\n+} = require('../common');\n+if (!hasCrypto)\n+  skip('missing crypto');\n+\n+const {\n+  deepStrictEqual\n+} = require('assert');\n+const {\n+  createServer,\n+  connect\n+} = require('http2');\n+\n+const check = Buffer.from([ 1, 2, 3, 4, 5, 6, 7, 8 ]);\n+\n+const server = createServer();\n+server.on('stream', mustCall((stream) => {\n+  stream.respond();\n+  stream.end('ok');\n+}));\n+server.on('session', mustCall((session) => {\n+  session.on('ping', mustCall((payload) => {\n+    deepStrictEqual(check, payload);\n+  }));\n+  session.ping(check, mustCall());\n+}));\n+server.listen(0, mustCall(() => {\n+  const client = connect(`http://localhost:${server.address().port}`);\n+\n+  client.on('ping', mustCall((payload) => {\n+    deepStrictEqual(check, payload);\n+  }));\n+  client.on('connect', mustCall(() => {\n+    client.ping(check, mustCall());\n+  }));\n+\n+  const req = client.request();\n+  req.resume();\n+  req.on('close', mustCall(() => {\n+    client.close();\n+    server.close();\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 81,
        "deletions": 5
    }
}