{
    "author": "apapirovski",
    "message": "http2: safer Http2Session destructor\n\nIt's hypothetically (and with certain V8 flags) possible for the session\nto be garbage collected before all the streams are. In that case, trying\nto remove the stream from the session will lead to a segfault due to\nattempting to access no longer valid memory. Fix this by unsetting the\nsession on any streams still around when destroying.\n\nPR-URL: https://github.com/nodejs/node/pull/21194\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>",
    "sha": "083139d440f9e06e7d1f0eff331886117b5165a8",
    "files": [
        {
            "sha": "a4190679232bd32921b56b062fafcdfdf35c2096",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/083139d440f9e06e7d1f0eff331886117b5165a8/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/083139d440f9e06e7d1f0eff331886117b5165a8/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=083139d440f9e06e7d1f0eff331886117b5165a8",
            "patch": "@@ -499,6 +499,8 @@ Http2Session::Http2Session(Environment* env,\n Http2Session::~Http2Session() {\n   CHECK_EQ(flags_ & SESSION_STATE_HAS_SCOPE, 0);\n   Debug(this, \"freeing nghttp2 session\");\n+  for (const auto& stream : streams_)\n+    stream.second->session_ = nullptr;\n   nghttp2_session_del(session_);\n }\n \n@@ -1706,11 +1708,11 @@ Http2Stream::Http2Stream(\n \n \n Http2Stream::~Http2Stream() {\n+  if (session_ == nullptr)\n+    return;\n   Debug(this, \"tearing down stream\");\n-  if (session_ != nullptr) {\n-    session_->RemoveStream(this);\n-    session_ = nullptr;\n-  }\n+  session_->RemoveStream(this);\n+  session_ = nullptr;\n }\n \n std::string Http2Stream::diagnostic_name() const {\n@@ -1785,7 +1787,8 @@ void Http2Stream::Destroy() {\n     // We can destroy the stream now if there are no writes for it\n     // already on the socket. Otherwise, we'll wait for the garbage collector\n     // to take care of cleaning up.\n-    if (!stream->session()->HasWritesOnSocketForStream(stream))\n+    if (stream->session() == nullptr ||\n+        !stream->session()->HasWritesOnSocketForStream(stream))\n       delete stream;\n   }, this, this->object());\n "
        }
    ],
    "stats": {
        "total": 13,
        "additions": 8,
        "deletions": 5
    }
}