{
    "author": "addaleax",
    "message": "src: fix `--prof-process` CLI argument handling\n\nMake sure that options after `--prof-process` are not treated\nas Node.js options.\n\nFixes: https://github.com/nodejs/node/issues/22786\n\nPR-URL: https://github.com/nodejs/node/pull/22790\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Bryan English <bryan@bryanenglish.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "23f8b0251335f46aaf54b45e9370b374c1c238d2",
    "files": [
        {
            "sha": "7af3a8ad4ade07a96d512140d938a547548fb788",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/23f8b0251335f46aaf54b45e9370b374c1c238d2/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/23f8b0251335f46aaf54b45e9370b374c1c238d2/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=23f8b0251335f46aaf54b45e9370b374c1c238d2",
            "patch": "@@ -694,9 +694,11 @@\n       for (const [ from, expansion ] of aliases) {\n         let isAccepted = true;\n         for (const to of expansion) {\n-          if (!to.startsWith('-')) continue;\n+          if (!to.startsWith('-') || to === '--') continue;\n           const recursiveExpansion = aliases.get(to);\n           if (recursiveExpansion) {\n+            if (recursiveExpansion[0] === to)\n+              recursiveExpansion.splice(0, 1);\n             expansion.push(...recursiveExpansion);\n             continue;\n           }"
        },
        {
            "sha": "8027ee677c1e124510217e3cfc1210959a082f44",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/23f8b0251335f46aaf54b45e9370b374c1c238d2/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/23f8b0251335f46aaf54b45e9370b374c1c238d2/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=23f8b0251335f46aaf54b45e9370b374c1c238d2",
            "patch": "@@ -108,6 +108,8 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {\n   AddOption(\"--prof-process\",\n             \"process V8 profiler output generated using --prof\",\n             &EnvironmentOptions::prof_process);\n+  // Options after --prof-process are passed through to the prof processor.\n+  AddAlias(\"--prof-process\", { \"--prof-process\", \"--\" });\n   AddOption(\"--redirect-warnings\",\n             \"write warnings to file instead of stderr\",\n             &EnvironmentOptions::redirect_warnings,"
        },
        {
            "sha": "606dbd03c8f6c473af09b2dbf359b4ead9e88014",
            "filename": "test/parallel/test-tick-processor-arguments.js",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/23f8b0251335f46aaf54b45e9370b374c1c238d2/test%2Fparallel%2Ftest-tick-processor-arguments.js",
            "raw_url": "https://github.com/nodejs/node/raw/23f8b0251335f46aaf54b45e9370b374c1c238d2/test%2Fparallel%2Ftest-tick-processor-arguments.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tick-processor-arguments.js?ref=23f8b0251335f46aaf54b45e9370b374c1c238d2",
            "patch": "@@ -0,0 +1,34 @@\n+'use strict';\n+const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n+const fs = require('fs');\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+\n+if (!common.isMainThread)\n+  common.skip('chdir not available in workers');\n+if (!common.enoughTestMem)\n+  common.skip('skipped due to memory requirements');\n+if (common.isAIX)\n+  common.skip('does not work on AIX');\n+\n+tmpdir.refresh();\n+process.chdir(tmpdir.path);\n+\n+// Generate log file.\n+spawnSync(process.execPath, [ '--prof', '-p', '42' ]);\n+\n+const logfile = fs.readdirSync('.').filter((name) => name.endsWith('.log'))[0];\n+assert(logfile);\n+\n+// Make sure that the --preprocess argument is passed through correctly,\n+// as an example flag listed in deps/v8/tools/tickprocessor.js.\n+// Any of the other flags there should work for this test too, if --preprocess\n+// is ever removed.\n+const { stdout } = spawnSync(\n+  process.execPath,\n+  [ '--prof-process', '--preprocess', logfile ],\n+  { encoding: 'utf8' });\n+\n+// Make sure that the result is valid JSON.\n+JSON.parse(stdout);"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 39,
        "deletions": 1
    }
}