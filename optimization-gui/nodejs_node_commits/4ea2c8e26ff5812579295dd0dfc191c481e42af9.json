{
    "author": "unknown",
    "message": "fs: update read to work with any TypedArray/DataView\n\nPR-URL: https://github.com/nodejs/node/pull/22150\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "4ea2c8e26ff5812579295dd0dfc191c481e42af9",
    "files": [
        {
            "sha": "ee5b0a7d9dce383d11f004749296f4e5f3c6ac0a",
            "filename": "doc/api/fs.md",
            "status": "modified",
            "additions": 33,
            "deletions": 8,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/4ea2c8e26ff5812579295dd0dfc191c481e42af9/doc%2Fapi%2Ffs.md",
            "raw_url": "https://github.com/nodejs/node/raw/4ea2c8e26ff5812579295dd0dfc191c481e42af9/doc%2Fapi%2Ffs.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ffs.md?ref=4ea2c8e26ff5812579295dd0dfc191c481e42af9",
            "patch": "@@ -2345,6 +2345,10 @@ this API: [`fs.open()`][].\n <!-- YAML\n added: v0.0.2\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `buffer` parameter can now be any `TypedArray`, or a\n+                 `DataView`.\n   - version: v7.4.0\n     pr-url: https://github.com/nodejs/node/pull/10382\n     description: The `buffer` parameter can now be a `Uint8Array`.\n@@ -2354,7 +2358,7 @@ changes:\n -->\n \n * `fd` {integer}\n-* `buffer` {Buffer|Uint8Array}\n+* `buffer` {Buffer|TypedArray|DataView}\n * `offset` {integer}\n * `length` {integer}\n * `position` {integer}\n@@ -2624,13 +2628,17 @@ the link path returned will be passed as a `Buffer` object.\n <!-- YAML\n added: v0.1.21\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `buffer` parameter can now be any `TypedArray` or a\n+                 `DataView`.\n   - version: v6.0.0\n     pr-url: https://github.com/nodejs/node/pull/4518\n     description: The `length` parameter can now be `0`.\n -->\n \n * `fd` {integer}\n-* `buffer` {Buffer|Uint8Array}\n+* `buffer` {Buffer|TypedArray|DataView}\n * `offset` {integer}\n * `length` {integer}\n * `position` {integer}\n@@ -3354,6 +3362,10 @@ This happens when:\n <!-- YAML\n added: v0.0.2\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `buffer` parameter can now be any `TypedArray` or a\n+                 `DataView`\n   - version: v10.0.0\n     pr-url: https://github.com/nodejs/node/pull/12562\n     description: The `callback` parameter is no longer optional. Not passing\n@@ -3371,14 +3383,14 @@ changes:\n -->\n \n * `fd` {integer}\n-* `buffer` {Buffer|Uint8Array}\n+* `buffer` {Buffer|TypedArray|DataView}\n * `offset` {integer}\n * `length` {integer}\n * `position` {integer}\n * `callback` {Function}\n   * `err` {Error}\n   * `bytesWritten` {integer}\n-  * `buffer` {Buffer|Uint8Array}\n+  * `buffer` {Buffer|TypedArray|DataView}\n \n Write `buffer` to the file specified by `fd`.\n \n@@ -3453,6 +3465,10 @@ the end of the file.\n <!-- YAML\n added: v0.1.29\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `data` parameter can now be any `TypedArray` or a\n+                 `DataView`.\n   - version: v10.0.0\n     pr-url: https://github.com/nodejs/node/pull/12562\n     description: The `callback` parameter is no longer optional. Not passing\n@@ -3470,7 +3486,7 @@ changes:\n -->\n \n * `file` {string|Buffer|URL|integer} filename or file descriptor\n-* `data` {string|Buffer|Uint8Array}\n+* `data` {string|Buffer|TypedArray|DataView}\n * `options` {Object|string}\n   * `encoding` {string|null} **Default:** `'utf8'`\n   * `mode` {integer} **Default:** `0o666`\n@@ -3486,7 +3502,8 @@ The `encoding` option is ignored if `data` is a buffer.\n Example:\n \n ```js\n-fs.writeFile('message.txt', 'Hello Node.js', (err) => {\n+const data = new Uint8Array(Buffer.from('Hello Node.js'));\n+fs.writeFile('message.txt', data, (err) => {\n   if (err) throw err;\n   console.log('The file has been saved!');\n });\n@@ -3511,6 +3528,10 @@ automatically.\n <!-- YAML\n added: v0.1.29\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `data` parameter can now be any `TypedArray` or a\n+                 `DataView`.\n   - version: v7.4.0\n     pr-url: https://github.com/nodejs/node/pull/10382\n     description: The `data` parameter can now be a `Uint8Array`.\n@@ -3520,7 +3541,7 @@ changes:\n -->\n \n * `file` {string|Buffer|URL|integer} filename or file descriptor\n-* `data` {string|Buffer|Uint8Array}\n+* `data` {string|Buffer|TypedArray|DataView}\n * `options` {Object|string}\n   * `encoding` {string|null} **Default:** `'utf8'`\n   * `mode` {integer} **Default:** `0o666`\n@@ -3535,6 +3556,10 @@ this API: [`fs.writeFile()`][].\n <!-- YAML\n added: v0.1.21\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/22150\n+    description: The `buffer` parameter can now be any `TypedArray` or a\n+                 `DataView`.\n   - version: v7.4.0\n     pr-url: https://github.com/nodejs/node/pull/10382\n     description: The `buffer` parameter can now be a `Uint8Array`.\n@@ -3544,7 +3569,7 @@ changes:\n -->\n \n * `fd` {integer}\n-* `buffer` {Buffer|Uint8Array}\n+* `buffer` {Buffer|TypedArray|DataView}\n * `offset` {integer}\n * `length` {integer}\n * `position` {integer}"
        },
        {
            "sha": "e1fb2c022f8c6897794e6ee1f5392da5898aec96",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/4ea2c8e26ff5812579295dd0dfc191c481e42af9/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/4ea2c8e26ff5812579295dd0dfc191c481e42af9/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=4ea2c8e26ff5812579295dd0dfc191c481e42af9",
            "patch": "@@ -41,7 +41,7 @@ const {\n \n const { _extend } = require('util');\n const pathModule = require('path');\n-const { isUint8Array } = require('internal/util/types');\n+const { isArrayBufferView } = require('internal/util/types');\n const binding = process.binding('fs');\n const { Buffer, kMaxLength } = require('buffer');\n const errors = require('internal/errors');\n@@ -458,12 +458,12 @@ function read(fd, buffer, offset, length, position, callback) {\n     });\n   }\n \n-  if (buffer.length === 0) {\n+  if (buffer.byteLength === 0) {\n     throw new ERR_INVALID_ARG_VALUE('buffer', buffer,\n                                     'is empty and cannot be written');\n   }\n \n-  validateOffsetLengthRead(offset, length, buffer.length);\n+  validateOffsetLengthRead(offset, length, buffer.byteLength);\n \n   if (!Number.isSafeInteger(position))\n     position = -1;\n@@ -493,12 +493,12 @@ function readSync(fd, buffer, offset, length, position) {\n     return 0;\n   }\n \n-  if (buffer.length === 0) {\n+  if (buffer.byteLength === 0) {\n     throw new ERR_INVALID_ARG_VALUE('buffer', buffer,\n                                     'is empty and cannot be written');\n   }\n \n-  validateOffsetLengthRead(offset, length, buffer.length);\n+  validateOffsetLengthRead(offset, length, buffer.byteLength);\n \n   if (!Number.isSafeInteger(position))\n     position = -1;\n@@ -525,7 +525,7 @@ function write(fd, buffer, offset, length, position, callback) {\n   const req = new FSReqCallback();\n   req.oncomplete = wrapper;\n \n-  if (isUint8Array(buffer)) {\n+  if (isArrayBufferView(buffer)) {\n     callback = maybeCallback(callback || position || length || offset);\n     if (typeof offset !== 'number')\n       offset = 0;\n@@ -563,13 +563,13 @@ function writeSync(fd, buffer, offset, length, position) {\n   validateUint32(fd, 'fd');\n   const ctx = {};\n   let result;\n-  if (isUint8Array(buffer)) {\n+  if (isArrayBufferView(buffer)) {\n     if (position === undefined)\n       position = null;\n     if (typeof offset !== 'number')\n       offset = 0;\n     if (typeof length !== 'number')\n-      length = buffer.length - offset;\n+      length = buffer.byteLength - offset;\n     validateOffsetLengthWrite(offset, length, buffer.byteLength);\n     result = binding.writeBuffer(fd, buffer, offset, length, position,\n                                  undefined, ctx);\n@@ -1189,11 +1189,11 @@ function writeFile(path, data, options, callback) {\n   });\n \n   function writeFd(fd, isUserFd) {\n-    const buffer = isUint8Array(data) ?\n+    const buffer = isArrayBufferView(data) ?\n       data : Buffer.from('' + data, options.encoding || 'utf8');\n     const position = /a/.test(flag) ? null : 0;\n \n-    writeAll(fd, isUserFd, buffer, 0, buffer.length, position, callback);\n+    writeAll(fd, isUserFd, buffer, 0, buffer.byteLength, position, callback);\n   }\n }\n \n@@ -1204,11 +1204,11 @@ function writeFileSync(path, data, options) {\n   const isUserFd = isFd(path); // file descriptor ownership\n   const fd = isUserFd ? path : fs.openSync(path, flag, options.mode);\n \n-  if (!isUint8Array(data)) {\n+  if (!isArrayBufferView(data)) {\n     data = Buffer.from('' + data, options.encoding || 'utf8');\n   }\n   let offset = 0;\n-  let length = data.length;\n+  let length = data.byteLength;\n   let position = /a/.test(flag) ? null : 0;\n   try {\n     while (length > 0) {"
        },
        {
            "sha": "acc566e37bb4bffc5f5c8af622a87b6266e8d0a7",
            "filename": "lib/internal/fs/utils.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4ea2c8e26ff5812579295dd0dfc191c481e42af9/lib%2Finternal%2Ffs%2Futils.js",
            "raw_url": "https://github.com/nodejs/node/raw/4ea2c8e26ff5812579295dd0dfc191c481e42af9/lib%2Finternal%2Ffs%2Futils.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Futils.js?ref=4ea2c8e26ff5812579295dd0dfc191c481e42af9",
            "patch": "@@ -9,7 +9,7 @@ const {\n   ERR_INVALID_OPT_VALUE_ENCODING,\n   ERR_OUT_OF_RANGE\n } = require('internal/errors').codes;\n-const { isUint8Array } = require('internal/util/types');\n+const { isUint8Array, isArrayBufferView } = require('internal/util/types');\n const pathModule = require('path');\n const util = require('util');\n const kType = Symbol('type');\n@@ -394,9 +394,10 @@ function toUnixTimestamp(time, name = 'time') {\n }\n \n function validateBuffer(buffer) {\n-  if (!isUint8Array(buffer)) {\n+  if (!isArrayBufferView(buffer)) {\n     const err = new ERR_INVALID_ARG_TYPE('buffer',\n-                                         ['Buffer', 'Uint8Array'], buffer);\n+                                         ['Buffer', 'TypedArray', 'DataView'],\n+                                         buffer);\n     Error.captureStackTrace(err, validateBuffer);\n     throw err;\n   }"
        },
        {
            "sha": "d75464ce0ab1f3c92fb9383f5528ca408cf303d1",
            "filename": "test/parallel/test-fs-read-type.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/4ea2c8e26ff5812579295dd0dfc191c481e42af9/test%2Fparallel%2Ftest-fs-read-type.js",
            "raw_url": "https://github.com/nodejs/node/raw/4ea2c8e26ff5812579295dd0dfc191c481e42af9/test%2Fparallel%2Ftest-fs-read-type.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-read-type.js?ref=4ea2c8e26ff5812579295dd0dfc191c481e42af9",
            "patch": "@@ -15,8 +15,8 @@ assert.throws(\n   {\n     code: 'ERR_INVALID_ARG_TYPE',\n     name: 'TypeError [ERR_INVALID_ARG_TYPE]',\n-    message: 'The \"buffer\" argument must be one of type Buffer or Uint8Array.' +\n-             ' Received type number'\n+    message: 'The \"buffer\" argument must be one of type Buffer, TypedArray, ' +\n+             'or DataView. Received type number'\n   }\n );\n \n@@ -70,8 +70,8 @@ assert.throws(\n   {\n     code: 'ERR_INVALID_ARG_TYPE',\n     name: 'TypeError [ERR_INVALID_ARG_TYPE]',\n-    message: 'The \"buffer\" argument must be one of type Buffer or Uint8Array.' +\n-             ' Received type number'\n+    message: 'The \"buffer\" argument must be one of type Buffer, TypedArray, ' +\n+             'or DataView. Received type number'\n   }\n );\n "
        },
        {
            "sha": "e9bd9fe9a7a540a31eae4e7d0ecb573923fbb39d",
            "filename": "test/parallel/test-fs-write-file-typedarrays.js",
            "status": "renamed",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/4ea2c8e26ff5812579295dd0dfc191c481e42af9/test%2Fparallel%2Ftest-fs-write-file-typedarrays.js",
            "raw_url": "https://github.com/nodejs/node/raw/4ea2c8e26ff5812579295dd0dfc191c481e42af9/test%2Fparallel%2Ftest-fs-write-file-typedarrays.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-write-file-typedarrays.js?ref=4ea2c8e26ff5812579295dd0dfc191c481e42af9",
            "patch": "@@ -17,13 +17,27 @@ const s = '南越国是前203年至前111年存在于岭南地区的一个国家\n           '历经五代君主。南越国是岭南地区的第一个有记载的政权国家，采用封建制和郡县制并存的制度，' +\n           '它的建立保证了秦末乱世岭南地区社会秩序的稳定，有效的改善了岭南地区落后的政治、##济现状。\\n';\n \n-const input = Uint8Array.from(Buffer.from(s, 'utf8'));\n+// The length of the buffer should be a multiple of 8\n+// as required by common.getArrayBufferViews()\n+const inputBuffer = Buffer.from(s.repeat(8), 'utf8');\n \n-fs.writeFileSync(filename, input);\n-assert.strictEqual(fs.readFileSync(filename, 'utf8'), s);\n+for (const expectView of common.getArrayBufferViews(inputBuffer)) {\n+  console.log('Sync test for ', expectView[Symbol.toStringTag]);\n+  fs.writeFileSync(filename, expectView);\n+  assert.strictEqual(\n+    fs.readFileSync(filename, 'utf8'),\n+    inputBuffer.toString('utf8')\n+  );\n+}\n \n-fs.writeFile(filename, input, common.mustCall((e) => {\n-  assert.ifError(e);\n+for (const expectView of common.getArrayBufferViews(inputBuffer)) {\n+  console.log('Async test for ', expectView[Symbol.toStringTag]);\n+  fs.writeFile(filename, expectView, common.mustCall((e) => {\n+    assert.ifError(e);\n \n-  assert.strictEqual(fs.readFileSync(filename, 'utf8'), s);\n-}));\n+    fs.readFile(filename, 'utf8', common.mustCall((err, data) => {\n+      assert.ifError(err);\n+      assert.strictEqual(data, inputBuffer.toString('utf8'));\n+    }));\n+  }));\n+}",
            "previous_filename": "test/parallel/test-fs-write-file-uint8array.js"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 74,
        "deletions": 34
    }
}