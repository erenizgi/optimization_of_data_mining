{
    "author": "TimothyGu",
    "message": "src: set HAS_USERNAME/PASSWORD more strictly\n\nFixes: https://github.com/nodejs/node/issues/24211\n\nPR-URL: https://github.com/nodejs/node/pull/24495\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Daijiro Wachi <daijiro.wachi@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "639f6411a76d010b1807fd1b6e78b8ba894a281e",
    "files": [
        {
            "sha": "39007f9523390fe23e78faf2866ea09ce0c5a375",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 8,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/639f6411a76d010b1807fd1b6e78b8ba894a281e/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/639f6411a76d010b1807fd1b6e78b8ba894a281e/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=639f6411a76d010b1807fd1b6e78b8ba894a281e",
            "patch": "@@ -1209,21 +1209,33 @@ inline url_data HarvestBase(Environment* env, Local<Object> base_obj) {\n       base_obj->Get(env->context(), env->scheme_string()).ToLocalChecked();\n   base.scheme = Utf8Value(env->isolate(), scheme).out();\n \n-  auto GetStr = [&](std::string url_data::* member,\n+  auto GetStr = [&](std::string url_data::*member,\n                     int flag,\n-                    Local<String> name) {\n+                    Local<String> name,\n+                    bool empty_as_present) {\n     Local<Value> value = base_obj->Get(env->context(), name).ToLocalChecked();\n     if (value->IsString()) {\n       Utf8Value utf8value(env->isolate(), value.As<String>());\n       (base.*member).assign(*utf8value, utf8value.length());\n-      base.flags |= flag;\n+      if (empty_as_present || value.As<String>()->Length() != 0) {\n+        base.flags |= flag;\n+      }\n     }\n   };\n-  GetStr(&url_data::username, URL_FLAGS_HAS_USERNAME, env->username_string());\n-  GetStr(&url_data::password, URL_FLAGS_HAS_PASSWORD, env->password_string());\n-  GetStr(&url_data::host, URL_FLAGS_HAS_HOST, env->host_string());\n-  GetStr(&url_data::query, URL_FLAGS_HAS_QUERY, env->query_string());\n-  GetStr(&url_data::fragment, URL_FLAGS_HAS_FRAGMENT, env->fragment_string());\n+  GetStr(&url_data::username,\n+         URL_FLAGS_HAS_USERNAME,\n+         env->username_string(),\n+         false);\n+  GetStr(&url_data::password,\n+         URL_FLAGS_HAS_PASSWORD,\n+         env->password_string(),\n+         false);\n+  GetStr(&url_data::host, URL_FLAGS_HAS_HOST, env->host_string(), true);\n+  GetStr(&url_data::query, URL_FLAGS_HAS_QUERY, env->query_string(), true);\n+  GetStr(&url_data::fragment,\n+         URL_FLAGS_HAS_FRAGMENT,\n+         env->fragment_string(),\n+         true);\n \n   Local<Value> port =\n       base_obj->Get(env->context(), env->port_string()).ToLocalChecked();"
        },
        {
            "sha": "9150b1561b7c77b2c53a14063380ed52b3766d7f",
            "filename": "test/parallel/test-whatwg-url-custom-deepequal.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/639f6411a76d010b1807fd1b6e78b8ba894a281e/test%2Fparallel%2Ftest-whatwg-url-custom-deepequal.js",
            "raw_url": "https://github.com/nodejs/node/raw/639f6411a76d010b1807fd1b6e78b8ba894a281e/test%2Fparallel%2Ftest-whatwg-url-custom-deepequal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-custom-deepequal.js?ref=639f6411a76d010b1807fd1b6e78b8ba894a281e",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+// This tests that the internal flags in URL objects are consistent, as manifest\n+// through assert libraries.\n+// See https://github.com/nodejs/node/issues/24211\n+\n+// Tests below are not from WPT.\n+\n+require('../common');\n+const assert = require('assert');\n+\n+assert.deepStrictEqual(\n+  new URL('./foo', 'https://example.com/'),\n+  new URL('https://example.com/foo')\n+);\n+assert.deepStrictEqual(\n+  new URL('./foo', 'https://user:pass@example.com/'),\n+  new URL('https://user:pass@example.com/foo')\n+);"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}