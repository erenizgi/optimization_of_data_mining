{
    "author": "addaleax",
    "message": "zlib: use `.bytesWritten` instead of `.bytesRead`\n\nThe introduction of `.bytesRead` to zlib streams was unfortunate,\nbecause other streams in Node.js core use the exact opposite naming\nof `.bytesRead` and `.bytesWritten`.\n\nWhile one could see how the original naming makes sense in\na `Transform` stream context, we should try to work towards more\nconsistent APIs in core for these things.\n\nThis introduces `zlib.bytesWritten` and documentation-only deprecates\n`zlib.bytesRead`.\n\nPR-URL: https://github.com/nodejs/node/pull/19414\nRefs: https://github.com/nodejs/node/issues/8874\nRefs: https://github.com/nodejs/node/pull/13088\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "49fd9c63d21c8c42a110996a6a68bf1fdcee12b4",
    "files": [
        {
            "sha": "6fd8d1d4f5ec816ddb8bf469228cdfa21a4b6ace",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=49fd9c63d21c8c42a110996a6a68bf1fdcee12b4",
            "patch": "@@ -979,6 +979,16 @@ Type: Runtime\n This was an undocumented helper function not intended for use outside Node.js\n core and obsoleted by the removal of NPN (Next Protocol Negotiation) support.\n \n+<a id=\"DEP0108\"></a>\n+### DEP0108: zlib.bytesRead\n+\n+Type: Documentation-only\n+\n+Deprecated alias for [`zlib.bytesWritten`][]. This original name was chosen\n+because it also made sense to interpret the value as the number of bytes\n+read by the engine, but is inconsistent with other streams in Node.js that\n+expose values under these names.\n+\n [`--pending-deprecation`]: cli.html#cli_pending_deprecation\n [`Buffer.allocUnsafeSlow(size)`]: buffer.html#buffer_class_method_buffer_allocunsafeslow_size\n [`Buffer.from(array)`]: buffer.html#buffer_class_method_buffer_from_array\n@@ -1058,6 +1068,7 @@ core and obsoleted by the removal of NPN (Next Protocol Negotiation) support.\n [`util.types`]: util.html#util_util_types\n [`util`]: util.html\n [`worker.exitedAfterDisconnect`]: cluster.html#cluster_worker_exitedafterdisconnect\n+[`zlib.bytesWritten`]: zlib.html#zlib_zlib_byteswritten\n [alloc]: buffer.html#buffer_class_method_buffer_alloc_size_fill_encoding\n [alloc_unsafe_size]: buffer.html#buffer_class_method_buffer_allocunsafe_size\n [from_arraybuffer]: buffer.html#buffer_class_method_buffer_from_arraybuffer_byteoffset_length"
        },
        {
            "sha": "0a554b40afeb5d50e33a28938945bccfdbf0d3f4",
            "filename": "doc/api/zlib.md",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/doc%2Fapi%2Fzlib.md",
            "raw_url": "https://github.com/nodejs/node/raw/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/doc%2Fapi%2Fzlib.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fzlib.md?ref=49fd9c63d21c8c42a110996a6a68bf1fdcee12b4",
            "patch": "@@ -400,13 +400,28 @@ class of the compressor/decompressor classes.\n ### zlib.bytesRead\n <!-- YAML\n added: v8.1.0\n+deprecated: REPLACEME\n -->\n \n+> Stability: 0 - Deprecated: Use [`zlib.bytesWritten`][] instead.\n+\n * {number}\n \n-The `zlib.bytesRead` property specifies the number of bytes read by the engine\n-before the bytes are processed (compressed or decompressed, as appropriate for\n-the derived class).\n+Deprecated alias for [`zlib.bytesWritten`][]. This original name was chosen\n+because it also made sense to interpret the value as the number of bytes\n+read by the engine, but is inconsistent with other streams in Node.js that\n+expose values under these names.\n+\n+### zlib.bytesWritten\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {number}\n+\n+The `zlib.bytesWritten` property specifies the number of bytes written to\n+the engine, before the bytes are processed (compressed or decompressed,\n+as appropriate for the derived class).\n \n ### zlib.close([callback])\n <!-- YAML\n@@ -763,7 +778,8 @@ Decompress a chunk of data with [Unzip][].\n [InflateRaw]: #zlib_class_zlib_inflateraw\n [Inflate]: #zlib_class_zlib_inflate\n [Memory Usage Tuning]: #zlib_memory_usage_tuning\n+[options]: #zlib_class_options\n [Unzip]: #zlib_class_zlib_unzip\n [`UV_THREADPOOL_SIZE`]: cli.html#cli_uv_threadpool_size_size\n-[options]: #zlib_class_options\n+[`zlib.bytesWritten`]: #zlib_zlib_byteswritten\n [zlib documentation]: https://zlib.net/manual.html#Constants"
        },
        {
            "sha": "a39e9c20eeb1bc886bce424eaf71e51b5b5c5d3f",
            "filename": "lib/zlib.js",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/lib%2Fzlib.js",
            "raw_url": "https://github.com/nodejs/node/raw/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/lib%2Fzlib.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fzlib.js?ref=49fd9c63d21c8c42a110996a6a68bf1fdcee12b4",
            "patch": "@@ -288,7 +288,7 @@ function Zlib(opts, mode) {\n     }\n   }\n   Transform.call(this, opts);\n-  this.bytesRead = 0;\n+  this.bytesWritten = 0;\n   this._handle = new binding.Zlib(mode);\n   this._handle.jsref = this; // Used by processCallback() and zlibOnError()\n   this._handle.onerror = zlibOnError;\n@@ -327,6 +327,21 @@ Object.defineProperty(Zlib.prototype, '_closed', {\n   }\n });\n \n+// `bytesRead` made sense as a name when looking from the zlib engine's\n+// perspective, but it is inconsistent with all other streams exposed by Node.js\n+// that have this concept, where it stands for the number of bytes read\n+// *from* the stream (that is, net.Socket/tls.Socket & file system streams).\n+Object.defineProperty(Zlib.prototype, 'bytesRead', {\n+  configurable: true,\n+  enumerable: true,\n+  get() {\n+    return this.bytesWritten;\n+  },\n+  set(value) {\n+    this.bytesWritten = value;\n+  }\n+});\n+\n Zlib.prototype.params = function params(level, strategy, callback) {\n   checkRangesOrGetDefault(level, 'level', Z_MIN_LEVEL, Z_MAX_LEVEL);\n   checkRangesOrGetDefault(strategy, 'strategy', Z_DEFAULT_STRATEGY, Z_FIXED);\n@@ -501,7 +516,7 @@ function processChunkSync(self, chunk, flushFlag) {\n     }\n   }\n \n-  self.bytesRead = inputRead;\n+  self.bytesWritten = inputRead;\n \n   if (nread >= kMaxLength) {\n     _close(self);\n@@ -558,8 +573,8 @@ function processCallback() {\n   var availOutAfter = state[0];\n   var availInAfter = state[1];\n \n-  var inDelta = (handle.availInBefore - availInAfter);\n-  self.bytesRead += inDelta;\n+  const inDelta = handle.availInBefore - availInAfter;\n+  self.bytesWritten += inDelta;\n \n   var have = handle.availOutBefore - availOutAfter;\n   if (have > 0) {"
        },
        {
            "sha": "493478e78d33d0f9a0aceced09c6134beb115e28",
            "filename": "test/parallel/test-zlib-bytes-read.js",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/test%2Fparallel%2Ftest-zlib-bytes-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/49fd9c63d21c8c42a110996a6a68bf1fdcee12b4/test%2Fparallel%2Ftest-zlib-bytes-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-bytes-read.js?ref=49fd9c63d21c8c42a110996a6a68bf1fdcee12b4",
            "patch": "@@ -33,13 +33,13 @@ for (const method of [\n   const comp = zlib[method[0]]();\n   comp.on('data', function(d) {\n     compData = Buffer.concat([compData, d]);\n-    assert.strictEqual(this.bytesRead, compWriter.size,\n+    assert.strictEqual(this.bytesWritten, compWriter.size,\n                        `Should get write size on ${method[0]} data.`);\n   });\n   comp.on('end', common.mustCall(function() {\n-    assert.strictEqual(this.bytesRead, compWriter.size,\n+    assert.strictEqual(this.bytesWritten, compWriter.size,\n                        `Should get write size on ${method[0]} end.`);\n-    assert.strictEqual(this.bytesRead, expectStr.length,\n+    assert.strictEqual(this.bytesWritten, expectStr.length,\n                        `Should get data size on ${method[0]} end.`);\n \n     {\n@@ -49,12 +49,12 @@ for (const method of [\n       const decomp = zlib[method[1]]();\n       decomp.on('data', function(d) {\n         decompData = Buffer.concat([decompData, d]);\n-        assert.strictEqual(this.bytesRead, decompWriter.size,\n+        assert.strictEqual(this.bytesWritten, decompWriter.size,\n                            `Should get write size on ${method[0]}/` +\n                            `${method[1]} data.`);\n       });\n       decomp.on('end', common.mustCall(function() {\n-        assert.strictEqual(this.bytesRead, compData.length,\n+        assert.strictEqual(this.bytesWritten, compData.length,\n                            `Should get compressed size on ${method[0]}/` +\n                            `${method[1]} end.`);\n         assert.strictEqual(decompData.toString(), expectStr,\n@@ -74,14 +74,16 @@ for (const method of [\n       const decomp = zlib[method[1]]();\n       decomp.on('data', function(d) {\n         decompData = Buffer.concat([decompData, d]);\n-        assert.strictEqual(this.bytesRead, decompWriter.size,\n+        assert.strictEqual(this.bytesWritten, decompWriter.size,\n                            `Should get write size on ${method[0]}/` +\n                            `${method[1]} data.`);\n       });\n       decomp.on('end', common.mustCall(function() {\n-        assert.strictEqual(this.bytesRead, compData.length,\n+        assert.strictEqual(this.bytesWritten, compData.length,\n                            `Should get compressed size on ${method[0]}/` +\n                            `${method[1]} end.`);\n+        // Checking legacy name.\n+        assert.strictEqual(this.bytesWritten, this.bytesRead);\n         assert.strictEqual(decompData.toString(), expectStr,\n                            `Should get original string on ${method[0]}/` +\n                            `${method[1]} end.`);"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 59,
        "deletions": 15
    }
}