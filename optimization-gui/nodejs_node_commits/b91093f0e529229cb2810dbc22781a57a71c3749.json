{
    "author": "addaleax",
    "message": "doc: add documentation for brotli support\n\nPR-URL: https://github.com/nodejs/node/pull/24938\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Jan Krems <jan.krems@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Myles Borins <myles.borins@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "b91093f0e529229cb2810dbc22781a57a71c3749",
    "files": [
        {
            "sha": "2b4c1ef3754e637199b5c62d46c2f6cca2f7e358",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/b91093f0e529229cb2810dbc22781a57a71c3749/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/b91093f0e529229cb2810dbc22781a57a71c3749/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=b91093f0e529229cb2810dbc22781a57a71c3749",
            "patch": "@@ -624,16 +624,16 @@ An attempt was made to register something that is not a function as an\n The type of an asynchronous resource was invalid. Note that users are also able\n to define their own types if using the public embedder API.\n \n+<a id=\"ERR_BROTLI_COMPRESSION_FAILED\"></a>\n+### ERR_BROTLI_COMPRESSION_FAILED\n+\n+Data passed to a Brotli stream was not successfully compressed.\n+\n <a id=\"ERR_BROTLI_INVALID_PARAM\"></a>\n ### ERR_BROTLI_INVALID_PARAM\n \n An invalid parameter key was passed during construction of a Brotli stream.\n \n-<a id=\"ERR_BROTLI_COMPRESSION_FAILED\">\n-### ERR_BROTLI_COMPRESSION_FAILED\n-\n-Data passed to a Brotli stream was not successfully compressed.\n-\n <a id=\"ERR_BUFFER_CONTEXT_NOT_AVAILABLE\"></a>\n ### ERR_BUFFER_CONTEXT_NOT_AVAILABLE\n "
        },
        {
            "sha": "cbf3ebd180f87b38f01096fad1c899f16951a22a",
            "filename": "doc/api/zlib.md",
            "status": "modified",
            "additions": 204,
            "deletions": 8,
            "changes": 212,
            "blob_url": "https://github.com/nodejs/node/blob/b91093f0e529229cb2810dbc22781a57a71c3749/doc%2Fapi%2Fzlib.md",
            "raw_url": "https://github.com/nodejs/node/raw/b91093f0e529229cb2810dbc22781a57a71c3749/doc%2Fapi%2Fzlib.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fzlib.md?ref=b91093f0e529229cb2810dbc22781a57a71c3749",
            "patch": "@@ -5,7 +5,7 @@\n > Stability: 2 - Stable\n \n The `zlib` module provides compression functionality implemented using Gzip and\n-Deflate/Inflate. It can be accessed using:\n+Deflate/Inflate, as well as Brotli. It can be accessed using:\n \n ```js\n const zlib = require('zlib');\n@@ -54,8 +54,8 @@ and/or unrecoverable and catastrophic memory fragmentation.\n \n ## Compressing HTTP requests and responses\n \n-The `zlib` module can be used to implement support for the `gzip` and `deflate`\n-content-encoding mechanisms defined by\n+The `zlib` module can be used to implement support for the `gzip`, `deflate`\n+and `br` content-encoding mechanisms defined by\n [HTTP](https://tools.ietf.org/html/rfc7230#section-4.2).\n \n The HTTP [`Accept-Encoding`][] header is used within an http request to identify\n@@ -76,12 +76,15 @@ const fs = require('fs');\n const request = http.get({ host: 'example.com',\n                            path: '/',\n                            port: 80,\n-                           headers: { 'Accept-Encoding': 'gzip,deflate' } });\n+                           headers: { 'Accept-Encoding': 'br,gzip,deflate' } });\n request.on('response', (response) => {\n   const output = fs.createWriteStream('example.com_index.html');\n \n   switch (response.headers['content-encoding']) {\n-    // Or, just use zlib.createUnzip() to handle both cases\n+    case 'br':\n+      response.pipe(zlib.createBrotliDecompress()).pipe(output);\n+      break;\n+    // Or, just use zlib.createUnzip() to handle both of the following cases:\n     case 'gzip':\n       response.pipe(zlib.createGunzip()).pipe(output);\n       break;\n@@ -117,6 +120,9 @@ http.createServer((request, response) => {\n   } else if (/\\bgzip\\b/.test(acceptEncoding)) {\n     response.writeHead(200, { 'Content-Encoding': 'gzip' });\n     raw.pipe(zlib.createGzip()).pipe(response);\n+  } else if (/\\bbr\\b/.test(acceptEncoding)) {\n+    response.writeHead(200, { 'Content-Encoding': 'br' });\n+    raw.pipe(zlib.createBrotliCompress()).pipe(response);\n   } else {\n     response.writeHead(200, {});\n     raw.pipe(response);\n@@ -136,6 +142,7 @@ const buffer = Buffer.from('eJzT0yMA', 'base64');\n \n zlib.unzip(\n   buffer,\n+  // For Brotli, the equivalent is zlib.constants.BROTLI_OPERATION_FLUSH.\n   { finishFlush: zlib.constants.Z_SYNC_FLUSH },\n   (err, buffer) => {\n     if (!err) {\n@@ -156,6 +163,8 @@ decompressed result is valid.\n \n <!--type=misc-->\n \n+### For zlib-based streams\n+\n From `zlib/zconf.h`, modified to Node.js's usage:\n \n The memory requirements for deflate are (in bytes):\n@@ -194,6 +203,16 @@ fewer calls to `zlib` because it will be able to process more data on\n each `write` operation. So, this is another factor that affects the\n speed, at the cost of memory usage.\n \n+### For Brotli-based streams\n+\n+There are equivalents to the zlib options for Brotli-based streams, although\n+these options have different ranges than the zlib ones:\n+\n+- zlib’s `level` option matches Brotli’s `BROTLI_PARAM_QUALITY` option.\n+- zlib’s `windowBits` option matches Brotli’s `BROTLI_PARAM_LGWIN` option.\n+\n+See [below][Brotli parameters] for more details on Brotli-specific options.\n+\n ## Flushing\n \n Calling [`.flush()`][] on a compression stream will make `zlib` return as much\n@@ -231,6 +250,8 @@ added: v0.5.8\n \n <!--type=misc-->\n \n+### zlib constants\n+\n All of the constants defined in `zlib.h` are also defined on\n `require('zlib').constants`. In the normal course of operations, it will not be\n necessary to use these constants. They are documented so that their presence is\n@@ -281,6 +302,77 @@ Compression strategy.\n * `zlib.constants.Z_FIXED`\n * `zlib.constants.Z_DEFAULT_STRATEGY`\n \n+### Brotli constants\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+There are several options and other constants available for Brotli-based\n+streams:\n+\n+#### Flush operations\n+\n+The following values are valid flush operations for Brotli-based streams:\n+\n+* `zlib.constants.BROTLI_OPERATION_PROCESS` (default for all operations)\n+* `zlib.constants.BROTLI_OPERATION_FLUSH` (default when calling `.flush()`)\n+* `zlib.constants.BROTLI_OPERATION_FINISH` (default for the last chunk)\n+* `zlib.constants.BROTLI_OPERATION_EMIT_METADATA`\n+  * This particular operation may be hard to use in a Node.js context,\n+     as the streaming layer makes it hard to know which data will end up\n+     in this frame. Also, there is currently no way to consume this data through\n+     the Node.js API.\n+\n+#### Compressor options\n+\n+There are several options that can be set on Brotli encoders, affecting\n+compression efficiency and speed. Both the keys and the values can be accessed\n+as properties of the `zlib.constants` object.\n+\n+The most important options are:\n+\n+* `BROTLI_PARAM_MODE`\n+  * `BROTLI_MODE_GENERIC` (default)\n+  * `BROTLI_MODE_TEXT`, adjusted for UTF-8 text\n+  * `BROTLI_MODE_FONT`, adjusted for WOFF 2.0 fonts\n+* `BROTLI_PARAM_QUALITY`\n+  * Ranges from `BROTLI_MIN_QUALITY` to `BROTLI_MAX_QUALITY`,\n+    with a default of `BROTLI_DEFAULT_QUALITY`.\n+* `BROTLI_PARAM_SIZE_HINT`\n+  * Integer value representing the expected input size;\n+    defaults to `0` for an unknown input size.\n+\n+The following flags can be set for advanced control over the compression\n+algorithm and memory usage tuning:\n+\n+* `BROTLI_PARAM_LGWIN`\n+  * Ranges from `BROTLI_MIN_WINDOW_BITS` to `BROTLI_MAX_WINDOW_BITS`,\n+    with a default of `BROTLI_DEFAULT_WINDOW`, or up to\n+    `BROTLI_LARGE_MAX_WINDOW_BITS` if the `BROTLI_PARAM_LARGE_WINDOW` flag\n+    is set.\n+* `BROTLI_PARAM_LGBLOCK`\n+  * Ranges from `BROTLI_MIN_INPUT_BLOCK_BITS` to `BROTLI_MAX_INPUT_BLOCK_BITS`.\n+* `BROTLI_PARAM_DISABLE_LITERAL_CONTEXT_MODELING`\n+  * Boolean flag that decreases compression ratio in favour of\n+    decompression speed.\n+* `BROTLI_PARAM_LARGE_WINDOW`\n+  * Boolean flag enabling “Large Window Brotli” mode (not compatible with the\n+    Brotli format as standardized in [RFC 7932][]).\n+* `BROTLI_PARAM_NPOSTFIX`\n+  * Ranges from `0` to `BROTLI_MAX_NPOSTFIX`.\n+* `BROTLI_PARAM_NDIRECT`\n+  * Ranges from `0` to `15 << NPOSTFIX` in steps of `1 << NPOSTFIX`.\n+\n+#### Decompressor options\n+\n+These advanced options are available for controlling decompression:\n+\n+* `BROTLI_DECODER_PARAM_DISABLE_RING_BUFFER_REALLOCATION`\n+  * Boolean flag that affects internal memory allocation patterns.\n+* `BROTLI_DECODER_PARAM_LARGE_WINDOW`\n+  * Boolean flag enabling “Large Window Brotli” mode (not compatible with the\n+    Brotli format as standardized in [RFC 7932][]).\n+\n ## Class: Options\n <!-- YAML\n added: v0.11.1\n@@ -298,7 +390,7 @@ changes:\n \n <!--type=misc-->\n \n-Each class takes an `options` object. All options are optional.\n+Each zlib-based class takes an `options` object. All options are optional.\n \n Note that some options are only relevant when compressing, and are\n ignored by the decompression classes.\n@@ -317,6 +409,47 @@ ignored by the decompression classes.\n See the description of `deflateInit2` and `inflateInit2` at\n <https://zlib.net/manual.html#Advanced> for more information on these.\n \n+## Class: BrotliOptions\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+<!--type=misc-->\n+\n+Each Brotli-based class takes an `options` object. All options are optional.\n+\n+* `flush` {integer} **Default:** `zlib.constants.BROTLI_OPERATION_PROCESS`\n+* `finishFlush` {integer} **Default:** `zlib.constants.BROTLI_OPERATION_FINISH`\n+* `chunkSize` {integer} **Default:** `16 * 1024`\n+* `params` {Object} Key-value object containing indexed [Brotli parameters][].\n+\n+For example:\n+\n+```js\n+const stream = zlib.createBrotliCompress({\n+  chunkSize: 32 * 1024,\n+  params: {\n+    [zlib.constants.BROTLI_PARAM_MODE]: zlib.constants.BROTLI_MODE_TEXT,\n+    [zlib.constants.BROTLI_PARAM_QUALITY]: 4,\n+    [zlib.constants.BROTLI_PARAM_SIZE_HINT]: fs.statSync(inputFile).size\n+  }\n+});\n+```\n+\n+## Class: zlib.BrotliCompress\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Compress data using the Brotli algorithm.\n+\n+## Class: zlib.BrotliDecompress\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Decompress data using the Brotli algorithm.\n+\n ## Class: zlib.Deflate\n <!-- YAML\n added: v0.5.8\n@@ -389,9 +522,13 @@ added: v0.5.8\n Decompress either a Gzip- or Deflate-compressed stream by auto-detecting\n the header.\n \n-## Class: zlib.Zlib\n+## Class: zlib.ZlibBase\n <!-- YAML\n added: v0.5.8\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/24939\n+    description: This class was renamed from `Zlib` to `ZlibBase`.\n -->\n \n Not exported by the `zlib` module. It is documented here because it is the base\n@@ -440,7 +577,8 @@ Close the underlying handle.\n added: v0.5.8\n -->\n \n-* `kind` **Default:** `zlib.constants.Z_FULL_FLUSH`\n+* `kind` **Default:** `zlib.constants.Z_FULL_FLUSH` for zlib-based streams,\n+  `zlib.constants.BROTLI_OPERATION_FLUSH` for Brotli-based streams.\n * `callback` {Function}\n \n Flush pending data. Don't call this frivolously, premature flushes negatively\n@@ -460,6 +598,8 @@ added: v0.11.4\n * `strategy` {integer}\n * `callback` {Function}\n \n+This function is only available for zlib-based streams, i.e. not Brotli.\n+\n Dynamically update the compression level and compression strategy.\n Only applicable to deflate algorithm.\n \n@@ -478,6 +618,24 @@ added: v7.0.0\n \n Provides an object enumerating Zlib-related constants.\n \n+## zlib.createBrotliCompress([options])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `options` {brotli options}\n+\n+Creates and returns a new [`BrotliCompress`][] object.\n+\n+## zlib.createBrotliDecompress([options])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `options` {brotli options}\n+\n+Creates and returns a new [`BrotliDecompress`][] object.\n+\n ## zlib.createDeflate([options])\n <!-- YAML\n added: v0.5.8\n@@ -560,6 +718,40 @@ with `callback(error, result)`.\n Every method has a `*Sync` counterpart, which accept the same arguments, but\n without a callback.\n \n+### zlib.brotliCompress(buffer[, options], callback)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `buffer` {Buffer|TypedArray|DataView|ArrayBuffer|string}\n+* `options` {brotli options}\n+* `callback` {Function}\n+\n+### zlib.brotliCompressSync(buffer[, options])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `buffer` {Buffer|TypedArray|DataView|ArrayBuffer|string}\n+* `options` {brotli options}\n+\n+Compress a chunk of data with [`BrotliCompress`][].\n+\n+### zlib.brotliDecompress(buffer[, options], callback)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `buffer` {Buffer|TypedArray|DataView|ArrayBuffer|string}\n+* `options` {brotli options}\n+* `callback` {Function}\n+\n+### zlib.brotliDecompressSync(buffer[, options])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `buffer` {Buffer|TypedArray|DataView|ArrayBuffer|string}\n+* `options` {brotli options}\n+\n+Decompress a chunk of data with [`BrotliDecompress`][].\n+\n ### zlib.deflate(buffer[, options], callback)\n <!-- YAML\n added: v0.6.0\n@@ -832,6 +1024,8 @@ Decompress a chunk of data with [`Unzip`][].\n [`.flush()`]: #zlib_zlib_flush_kind_callback\n [`Accept-Encoding`]: https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3\n [`ArrayBuffer`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\n+[`BrotliCompress`]: #zlib_class_zlib_brotlicompress\n+[`BrotliDecompress`]: #zlib_class_zlib_brotlidecompress\n [`Buffer`]: buffer.html#buffer_class_buffer\n [`Content-Encoding`]: https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11\n [`DataView`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView\n@@ -845,6 +1039,8 @@ Decompress a chunk of data with [`Unzip`][].\n [`Unzip`]: #zlib_class_zlib_unzip\n [`stream.Transform`]: stream.html#stream_class_stream_transform\n [`zlib.bytesWritten`]: #zlib_zlib_byteswritten\n+[Brotli parameters]: #zlib_brotli_constants\n [Memory Usage Tuning]: #zlib_memory_usage_tuning\n+[RFC 7932]: https://www.rfc-editor.org/rfc/rfc7932.txt\n [pool size]: cli.html#cli_uv_threadpool_size_size\n [zlib documentation]: https://zlib.net/manual.html#Constants"
        },
        {
            "sha": "44ebb0b572c8551df6eeec94a0d1e440846c59a0",
            "filename": "tools/doc/type-parser.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b91093f0e529229cb2810dbc22781a57a71c3749/tools%2Fdoc%2Ftype-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/b91093f0e529229cb2810dbc22781a57a71c3749/tools%2Fdoc%2Ftype-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Ftype-parser.js?ref=b91093f0e529229cb2810dbc22781a57a71c3749",
            "patch": "@@ -38,6 +38,8 @@ const customTypesMap = {\n   'AsyncHook': 'async_hooks.html#async_hooks_async_hooks_createhook_callbacks',\n   'AsyncResource': 'async_hooks.html#async_hooks_class_asyncresource',\n \n+  'brotli options': 'zlib.html#zlib_class_brotlioptions',\n+\n   'Buffer': 'buffer.html#buffer_class_buffer',\n \n   'ChildProcess': 'child_process.html#child_process_class_childprocess',"
        }
    ],
    "stats": {
        "total": 224,
        "additions": 211,
        "deletions": 13
    }
}