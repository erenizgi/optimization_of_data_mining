{
    "author": "bnoordhuis",
    "message": "deps: cherry-pick 46c4979e86 from upstream v8\n\nOriginal commit message:\n\n    Use wider types for max_old_space_size and co.\n\n    Make --max_old_space_size and friends work with values >= 2**31.\n    Such values did not work reliably (or sometimes not all) due to\n    signed integer overflow in size computations, which is UB.\n\n    Fixes https://github.com/nodejs/node/issues/18786.\n\n    Bug: chromium:814138\n    Cq-Include-Trybots: master.tryserver.chromium.linux:linux_chromium_rel_ng\n    Change-Id: Ibe23cef2417fd5b4a727022b8b0d4b50f1417182\n    Reviewed-on: https://chromium-review.googlesource.com/927063\n    Commit-Queue: Ben Noordhuis <info@bnoordhuis.nl>\n    Reviewed-by: Michael Lippautz <mlippautz@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#51433}\n\nPR-URL: https://github.com/nodejs/node/pull/18920\nFixes: https://github.com/nodejs/node/issues/18786\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "13cb056e4cfce7419148eb089205735fb12bcd9f",
    "files": [
        {
            "sha": "a3aeff7e03d480dbf0f708e3a9e6b283f82094e2",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -27,7 +27,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.3',\n+    'v8_embedder_string': '-node.4',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "856be6368ba9c6feb5c0f958b4c92d3a6bdb3d56",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -911,8 +911,7 @@ void ResourceConstraints::ConfigureDefaults(uint64_t physical_memory,\n                                             uint64_t virtual_memory_limit) {\n   set_max_semi_space_size_in_kb(\n       i::Heap::ComputeMaxSemiSpaceSize(physical_memory));\n-  set_max_old_space_size(\n-      static_cast<int>(i::Heap::ComputeMaxOldGenerationSize(physical_memory)));\n+  set_max_old_space_size(i::Heap::ComputeMaxOldGenerationSize(physical_memory));\n   set_max_zone_pool_size(i::AccountingAllocator::kMaxPoolSize);\n \n   if (virtual_memory_limit > 0 && i::kRequiresCodeRange) {\n@@ -927,7 +926,9 @@ void ResourceConstraints::ConfigureDefaults(uint64_t physical_memory,\n void SetResourceConstraints(i::Isolate* isolate,\n                             const ResourceConstraints& constraints) {\n   size_t semi_space_size = constraints.max_semi_space_size_in_kb();\n-  int old_space_size = constraints.max_old_space_size();\n+  size_t old_space_size =\n+      static_cast<size_t>(\n+          static_cast<unsigned int>(constraints.max_old_space_size()));\n   size_t code_range_size = constraints.code_range_size();\n   size_t max_pool_size = constraints.max_zone_pool_size();\n   if (semi_space_size != 0 || old_space_size != 0 || code_range_size != 0) {"
        },
        {
            "sha": "d81ececa2ae75d682adfe18c3324a1b67112ee0f",
            "filename": "deps/v8/src/flag-definitions.h",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fflag-definitions.h",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fflag-definitions.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fflag-definitions.h?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -161,13 +161,15 @@ struct MaybeBoolFlag {\n #define DEFINE_INT(nam, def, cmt) FLAG(INT, int, nam, def, cmt)\n #define DEFINE_UINT(nam, def, cmt) FLAG(UINT, unsigned int, nam, def, cmt)\n #define DEFINE_FLOAT(nam, def, cmt) FLAG(FLOAT, double, nam, def, cmt)\n+#define DEFINE_SIZE_T(nam, def, cmt) FLAG(SIZE_T, size_t, nam, def, cmt)\n #define DEFINE_STRING(nam, def, cmt) FLAG(STRING, const char*, nam, def, cmt)\n #define DEFINE_ARGS(nam, cmt) \\\n   FLAG(ARGS, JSArguments, nam, {0 COMMA nullptr}, cmt)\n \n #define DEFINE_ALIAS_BOOL(alias, nam) FLAG_ALIAS(BOOL, bool, alias, nam)\n #define DEFINE_ALIAS_INT(alias, nam) FLAG_ALIAS(INT, int, alias, nam)\n #define DEFINE_ALIAS_FLOAT(alias, nam) FLAG_ALIAS(FLOAT, double, alias, nam)\n+#define DEFINE_ALIAS_SIZE_T(alias, nam) FLAG_ALIAS(SIZE_T, size_t, alias, nam)\n #define DEFINE_ALIAS_STRING(alias, nam) \\\n   FLAG_ALIAS(STRING, const char*, alias, nam)\n #define DEFINE_ALIAS_ARGS(alias, nam) FLAG_ALIAS(ARGS, JSArguments, alias, nam)\n@@ -580,18 +582,18 @@ DEFINE_INT(generic_ic_threshold, 30,\n DEFINE_INT(self_opt_count, 130, \"call count before self-optimization\")\n \n // Garbage collections flags.\n-DEFINE_INT(min_semi_space_size, 0,\n-           \"min size of a semi-space (in MBytes), the new space consists of two\"\n-           \"semi-spaces\")\n-DEFINE_INT(max_semi_space_size, 0,\n-           \"max size of a semi-space (in MBytes), the new space consists of two\"\n-           \"semi-spaces\")\n+DEFINE_SIZE_T(min_semi_space_size, 0,\n+              \"min size of a semi-space (in MBytes), the new space consists of \"\n+              \"two semi-spaces\")\n+DEFINE_SIZE_T(max_semi_space_size, 0,\n+              \"max size of a semi-space (in MBytes), the new space consists of \"\n+              \"two semi-spaces\")\n DEFINE_INT(semi_space_growth_factor, 2, \"factor by which to grow the new space\")\n DEFINE_BOOL(experimental_new_space_growth_heuristic, false,\n             \"Grow the new space based on the percentage of survivors instead \"\n             \"of their absolute value.\")\n-DEFINE_INT(max_old_space_size, 0, \"max size of the old space (in Mbytes)\")\n-DEFINE_INT(initial_old_space_size, 0, \"initial old space size (in Mbytes)\")\n+DEFINE_SIZE_T(max_old_space_size, 0, \"max size of the old space (in Mbytes)\")\n+DEFINE_SIZE_T(initial_old_space_size, 0, \"initial old space size (in Mbytes)\")\n DEFINE_BOOL(gc_global, false, \"always perform global GCs\")\n DEFINE_INT(gc_interval, -1, \"garbage collect after <n> allocations\")\n DEFINE_INT(retain_maps_for_n_gc, 2,"
        },
        {
            "sha": "a51a4e7d71e47da8db3f3c1ff8cd36c237efeacb",
            "filename": "deps/v8/src/flags.cc",
            "status": "modified",
            "additions": 52,
            "deletions": 15,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fflags.cc",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fflags.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fflags.cc?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -5,6 +5,7 @@\n #include \"src/flags.h\"\n \n #include <cctype>\n+#include <cerrno>\n #include <cstdlib>\n #include <sstream>\n \n@@ -39,6 +40,7 @@ struct Flag {\n     TYPE_INT,\n     TYPE_UINT,\n     TYPE_FLOAT,\n+    TYPE_SIZE_T,\n     TYPE_STRING,\n     TYPE_ARGS\n   };\n@@ -81,6 +83,11 @@ struct Flag {\n     return reinterpret_cast<double*>(valptr_);\n   }\n \n+  size_t* size_t_variable() const {\n+    DCHECK(type_ == TYPE_SIZE_T);\n+    return reinterpret_cast<size_t*>(valptr_);\n+  }\n+\n   const char* string_value() const {\n     DCHECK(type_ == TYPE_STRING);\n     return *reinterpret_cast<const char**>(valptr_);\n@@ -119,6 +126,11 @@ struct Flag {\n     return *reinterpret_cast<const double*>(defptr_);\n   }\n \n+  size_t size_t_default() const {\n+    DCHECK(type_ == TYPE_SIZE_T);\n+    return *reinterpret_cast<const size_t*>(defptr_);\n+  }\n+\n   const char* string_default() const {\n     DCHECK(type_ == TYPE_STRING);\n     return *reinterpret_cast<const char* const *>(defptr_);\n@@ -142,6 +154,8 @@ struct Flag {\n         return *uint_variable() == uint_default();\n       case TYPE_FLOAT:\n         return *float_variable() == float_default();\n+      case TYPE_SIZE_T:\n+        return *size_t_variable() == size_t_default();\n       case TYPE_STRING: {\n         const char* str1 = string_value();\n         const char* str2 = string_default();\n@@ -173,6 +187,9 @@ struct Flag {\n       case TYPE_FLOAT:\n         *float_variable() = float_default();\n         break;\n+      case TYPE_SIZE_T:\n+        *size_t_variable() = size_t_default();\n+        break;\n       case TYPE_STRING:\n         set_string_value(string_default(), false);\n         break;\n@@ -201,6 +218,8 @@ static const char* Type2String(Flag::FlagType type) {\n     case Flag::TYPE_UINT:\n       return \"uint\";\n     case Flag::TYPE_FLOAT: return \"float\";\n+    case Flag::TYPE_SIZE_T:\n+      return \"size_t\";\n     case Flag::TYPE_STRING: return \"string\";\n     case Flag::TYPE_ARGS: return \"arguments\";\n   }\n@@ -227,6 +246,9 @@ std::ostream& operator<<(std::ostream& os, const Flag& flag) {  // NOLINT\n     case Flag::TYPE_FLOAT:\n       os << *flag.float_variable();\n       break;\n+    case Flag::TYPE_SIZE_T:\n+      os << *flag.size_t_variable();\n+      break;\n     case Flag::TYPE_STRING: {\n       const char* str = flag.string_value();\n       os << (str ? str : \"nullptr\");\n@@ -358,6 +380,27 @@ static Flag* FindFlag(const char* name) {\n   return nullptr;\n }\n \n+template <typename T>\n+bool TryParseUnsigned(Flag* flag, const char* arg, const char* value,\n+                      char** endp, T* out_val) {\n+  // We do not use strtoul because it accepts negative numbers.\n+  // Rejects values >= 2**63 when T is 64 bits wide but that\n+  // seems like an acceptable trade-off.\n+  uint64_t max = static_cast<uint64_t>(std::numeric_limits<T>::max());\n+  errno = 0;\n+  int64_t val = static_cast<int64_t>(strtoll(value, endp, 10));\n+  if (val < 0 || static_cast<uint64_t>(val) > max || errno != 0) {\n+    PrintF(stderr,\n+           \"Error: Value for flag %s of type %s is out of bounds \"\n+           \"[0-%\" PRIu64\n+           \"]\\n\"\n+           \"Try --help for options\\n\",\n+           arg, Type2String(flag->type()), max);\n+    return false;\n+  }\n+  *out_val = static_cast<T>(val);\n+  return true;\n+}\n \n // static\n int FlagList::SetFlagsFromCommandLine(int* argc,\n@@ -422,27 +465,21 @@ int FlagList::SetFlagsFromCommandLine(int* argc,\n         case Flag::TYPE_INT:\n           *flag->int_variable() = static_cast<int>(strtol(value, &endp, 10));\n           break;\n-        case Flag::TYPE_UINT: {\n-          // We do not use strtoul because it accepts negative numbers.\n-          int64_t val = static_cast<int64_t>(strtoll(value, &endp, 10));\n-          if (val < 0 || val > std::numeric_limits<unsigned int>::max()) {\n-            PrintF(stderr,\n-                   \"Error: Value for flag %s of type %s is out of bounds \"\n-                   \"[0-%\" PRIu64\n-                   \"]\\n\"\n-                   \"Try --help for options\\n\",\n-                   arg, Type2String(flag->type()),\n-                   static_cast<uint64_t>(\n-                       std::numeric_limits<unsigned int>::max()));\n+        case Flag::TYPE_UINT:\n+          if (!TryParseUnsigned(flag, arg, value, &endp,\n+                                flag->uint_variable())) {\n             return_code = j;\n-            break;\n           }\n-          *flag->uint_variable() = static_cast<unsigned int>(val);\n           break;\n-        }\n         case Flag::TYPE_FLOAT:\n           *flag->float_variable() = strtod(value, &endp);\n           break;\n+        case Flag::TYPE_SIZE_T:\n+          if (!TryParseUnsigned(flag, arg, value, &endp,\n+                                flag->size_t_variable())) {\n+            return_code = j;\n+          }\n+          break;\n         case Flag::TYPE_STRING:\n           flag->set_string_value(value ? StrDup(value) : nullptr, true);\n           break;"
        },
        {
            "sha": "5aed117903653d52194088ec9e1627960b51f979",
            "filename": "deps/v8/src/heap/heap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fheap%2Fheap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fheap%2Fheap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fheap%2Fheap.cc?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -5095,8 +5095,8 @@ bool Heap::ConfigureHeap(size_t max_semi_space_size_in_kb,\n \n   // The new space size must be a power of two to support single-bit testing\n   // for containment.\n-  max_semi_space_size_ = base::bits::RoundUpToPowerOfTwo32(\n-      static_cast<uint32_t>(max_semi_space_size_));\n+  max_semi_space_size_ = static_cast<size_t>(base::bits::RoundUpToPowerOfTwo64(\n+      static_cast<uint64_t>(max_semi_space_size_)));\n \n   if (max_semi_space_size_ == kMaxSemiSpaceSizeInKB * KB) {\n     // Start with at least 1*MB semi-space on machines with a lot of memory."
        },
        {
            "sha": "72d74c9715a3312bdfe4bdf883e10e1d60237590",
            "filename": "deps/v8/src/heap/heap.h",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fheap%2Fheap.h",
            "raw_url": "https://github.com/nodejs/node/raw/13cb056e4cfce7419148eb089205735fb12bcd9f/deps%2Fv8%2Fsrc%2Fheap%2Fheap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fheap%2Fheap.h?ref=13cb056e4cfce7419148eb089205735fb12bcd9f",
            "patch": "@@ -626,15 +626,15 @@ class Heap {\n #endif\n \n   // Semi-space size needs to be a multiple of page size.\n-  static const int kMinSemiSpaceSizeInKB =\n+  static const size_t kMinSemiSpaceSizeInKB =\n       1 * kPointerMultiplier * ((1 << kPageSizeBits) / KB);\n-  static const int kMaxSemiSpaceSizeInKB =\n+  static const size_t kMaxSemiSpaceSizeInKB =\n       16 * kPointerMultiplier * ((1 << kPageSizeBits) / KB);\n \n   // The old space size has to be a multiple of Page::kPageSize.\n   // Sizes are in MB.\n-  static const int kMinOldGenerationSize = 128 * kPointerMultiplier;\n-  static const int kMaxOldGenerationSize = 1024 * kPointerMultiplier;\n+  static const size_t kMinOldGenerationSize = 128 * kPointerMultiplier;\n+  static const size_t kMaxOldGenerationSize = 1024 * kPointerMultiplier;\n \n   static const int kTraceRingBufferSize = 512;\n   static const int kStacktraceBufferSize = 512;\n@@ -1372,10 +1372,10 @@ class Heap {\n   size_t MaxOldGenerationSize() { return max_old_generation_size_; }\n \n   static size_t ComputeMaxOldGenerationSize(uint64_t physical_memory) {\n-    const int old_space_physical_memory_factor = 4;\n-    int computed_size =\n-        static_cast<int>(physical_memory / i::MB /\n-                         old_space_physical_memory_factor * kPointerMultiplier);\n+    const size_t old_space_physical_memory_factor = 4;\n+    size_t computed_size = static_cast<size_t>(\n+        physical_memory / i::MB / old_space_physical_memory_factor *\n+        kPointerMultiplier);\n     return Max(Min(computed_size, kMaxOldGenerationSize),\n                kMinOldGenerationSize);\n   }\n@@ -1387,11 +1387,11 @@ class Heap {\n     uint64_t capped_physical_memory =\n         Max(Min(physical_memory, max_physical_memory), min_physical_memory);\n     // linearly scale max semi-space size: (X-A)/(B-A)*(D-C)+C\n-    int semi_space_size_in_kb =\n-        static_cast<int>(((capped_physical_memory - min_physical_memory) *\n-                          (kMaxSemiSpaceSizeInKB - kMinSemiSpaceSizeInKB)) /\n-                             (max_physical_memory - min_physical_memory) +\n-                         kMinSemiSpaceSizeInKB);\n+    size_t semi_space_size_in_kb =\n+        static_cast<size_t>(((capped_physical_memory - min_physical_memory) *\n+                             (kMaxSemiSpaceSizeInKB - kMinSemiSpaceSizeInKB)) /\n+                                (max_physical_memory - min_physical_memory) +\n+                            kMinSemiSpaceSizeInKB);\n     return RoundUp(semi_space_size_in_kb, (1 << kPageSizeBits) / KB);\n   }\n "
        }
    ],
    "stats": {
        "total": 124,
        "additions": 82,
        "deletions": 42
    }
}