{
    "author": "apapirovski",
    "message": "timers: add hasRef method to Timeout & Immediate\n\nProvide a way to check whether the current timer or immediate is refed.\n\nPR-URL: https://github.com/nodejs/node/pull/20898\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "48a2568f411cf09999b7e82992d15142ce9a45b0",
    "files": [
        {
            "sha": "b86a49a932ec1c0e93e9cb8fb33f3c3b1140bb91",
            "filename": "doc/api/timers.md",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/48a2568f411cf09999b7e82992d15142ce9a45b0/doc%2Fapi%2Ftimers.md",
            "raw_url": "https://github.com/nodejs/node/raw/48a2568f411cf09999b7e82992d15142ce9a45b0/doc%2Fapi%2Ftimers.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftimers.md?ref=48a2568f411cf09999b7e82992d15142ce9a45b0",
            "patch": "@@ -23,6 +23,15 @@ running as long as the immediate is active. The `Immediate` object returned by\n [`setImmediate()`][] exports both `immediate.ref()` and `immediate.unref()`\n functions that can be used to control this default behavior.\n \n+### immediate.hasRef()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {boolean}\n+\n+If true, the `Immediate` object will keep the Node.js event loop active.\n+\n ### immediate.ref()\n <!-- YAML\n added: v9.7.0\n@@ -61,6 +70,15 @@ timer is active. Each of the `Timeout` objects returned by these functions\n export both `timeout.ref()` and `timeout.unref()` functions that can be used to\n control this default behavior.\n \n+### timeout.hasRef()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {boolean}\n+\n+If true, the `Timeout` object will keep the Node.js event loop active.\n+\n ### timeout.ref()\n <!-- YAML\n added: v0.9.1"
        },
        {
            "sha": "5ae0e6a5ad4fd4c9a127846113d0c74f3f63a9f0",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/48a2568f411cf09999b7e82992d15142ce9a45b0/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/48a2568f411cf09999b7e82992d15142ce9a45b0/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=48a2568f411cf09999b7e82992d15142ce9a45b0",
            "patch": "@@ -547,6 +547,10 @@ Timeout.prototype.ref = function() {\n   return this;\n };\n \n+Timeout.prototype.hasRef = function() {\n+  return !!this[kRefed];\n+};\n+\n Timeout.prototype.close = function() {\n   clearTimeout(this);\n   return this;\n@@ -622,7 +626,7 @@ function processImmediate() {\n     count++;\n     if (immediate[kRefed])\n       refCount++;\n-    immediate[kRefed] = undefined;\n+    immediate[kRefed] = null;\n \n     tryOnImmediate(immediate, tail, count, refCount);\n \n@@ -713,6 +717,10 @@ const Immediate = class Immediate {\n     }\n     return this;\n   }\n+\n+  hasRef() {\n+    return !!this[kRefed];\n+  }\n };\n \n function setImmediate(callback, arg1, arg2, arg3) {\n@@ -761,7 +769,7 @@ exports.clearImmediate = function clearImmediate(immediate) {\n \n   if (immediate[kRefed] && --immediateInfo[kRefCount] === 0)\n     toggleImmediateRef(false);\n-  immediate[kRefed] = undefined;\n+  immediate[kRefed] = null;\n \n   if (destroyHooksExist()) {\n     emitDestroy(immediate[async_id_symbol]);"
        },
        {
            "sha": "ecb26682c1e1bb438466e1b82bc3b5a673153963",
            "filename": "test/parallel/test-timers-immediate-unref.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/48a2568f411cf09999b7e82992d15142ce9a45b0/test%2Fparallel%2Ftest-timers-immediate-unref.js",
            "raw_url": "https://github.com/nodejs/node/raw/48a2568f411cf09999b7e82992d15142ce9a45b0/test%2Fparallel%2Ftest-timers-immediate-unref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-immediate-unref.js?ref=48a2568f411cf09999b7e82992d15142ce9a45b0",
            "patch": "@@ -3,6 +3,14 @@\n const common = require('../common');\n const Countdown = require('../common/countdown');\n \n+const assert = require('assert');\n+\n+const immediate = setImmediate(() => {});\n+assert.strictEqual(immediate.hasRef(), true);\n+immediate.unref();\n+assert.strictEqual(immediate.hasRef(), false);\n+clearImmediate(immediate);\n+\n // This immediate should execute as it was unrefed and refed again.\n // It also confirms that unref/ref are chainable.\n setImmediate(common.mustCall(firstStep)).ref().unref().unref().ref();"
        },
        {
            "sha": "35615d111ada54b89d6e5fce1bf3357bb383a4e3",
            "filename": "test/parallel/test-timers-unref.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/48a2568f411cf09999b7e82992d15142ce9a45b0/test%2Fparallel%2Ftest-timers-unref.js",
            "raw_url": "https://github.com/nodejs/node/raw/48a2568f411cf09999b7e82992d15142ce9a45b0/test%2Fparallel%2Ftest-timers-unref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-unref.js?ref=48a2568f411cf09999b7e82992d15142ce9a45b0",
            "patch": "@@ -23,15 +23,21 @@\n \n const common = require('../common');\n \n+const assert = require('assert');\n+\n let unref_interval = false;\n let unref_timer = false;\n let checks = 0;\n \n const LONG_TIME = 10 * 1000;\n const SHORT_TIME = 100;\n \n+const timer = setTimeout(() => {}, 10);\n+assert.strictEqual(timer.hasRef(), true);\n // Should not throw.\n-setTimeout(() => {}, 10).unref().ref().unref();\n+timer.unref().ref().unref();\n+assert.strictEqual(timer.hasRef(), false);\n+\n setInterval(() => {}, 10).unref().ref().unref();\n \n setInterval(common.mustNotCall('Interval should not fire'), LONG_TIME).unref();"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 43,
        "deletions": 3
    }
}