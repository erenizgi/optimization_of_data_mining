{
    "author": "joyeecheung",
    "message": "process: simplify the setup of async hooks trace events\n\n- Remove `trace_category_state` from `Environment` - since this is\n  only accessed in the bootstrap process and later in the\n  trace category update handler, we could just pass the initial\n  values into JS land via the trace_events binding, and pass\n  the dynamic values directly to the handler later, instead of\n  accessing them out-of-band via the AliasedBuffer.\n- Instead of creating the hooks directly in\n  `trace_events_async_hooks.js`, export the hook factory and\n  create the hooks in trace category state toggle.\n\nPR-URL: https://github.com/nodejs/node/pull/26062\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "c435f069ebb3b8a1c6fb0d983db7f1b799715627",
    "files": [
        {
            "sha": "556c6ba39e51f6f05537471b9fae1e3dc515fff2",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "modified",
            "additions": 18,
            "deletions": 20,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -1,6 +1,9 @@\n 'use strict';\n \n const { getOptionValue } = require('internal/options');\n+// Lazy load internal/trace_events_async_hooks only if the async_hooks\n+// trace event category is enabled.\n+let traceEventsAsyncHook;\n \n function prepareMainThreadExecution() {\n   setupTraceCategoryState();\n@@ -27,32 +30,27 @@ function prepareMainThreadExecution() {\n \n function setupTraceCategoryState() {\n   const {\n-    traceCategoryState,\n+    asyncHooksEnabledInitial,\n     setTraceCategoryStateUpdateHandler\n   } = internalBinding('trace_events');\n-  const kCategoryAsyncHooks = 0;\n-  let traceEventsAsyncHook;\n-\n-  function toggleTraceCategoryState() {\n-    // Dynamically enable/disable the traceEventsAsyncHook\n-    const asyncHooksEnabled = !!traceCategoryState[kCategoryAsyncHooks];\n-\n-    if (asyncHooksEnabled) {\n-      // Lazy load internal/trace_events_async_hooks only if the async_hooks\n-      // trace event category is enabled.\n-      if (!traceEventsAsyncHook) {\n-        traceEventsAsyncHook = require('internal/trace_events_async_hooks');\n-      }\n-      traceEventsAsyncHook.enable();\n-    } else if (traceEventsAsyncHook) {\n-      traceEventsAsyncHook.disable();\n-    }\n-  }\n \n-  toggleTraceCategoryState();\n+  toggleTraceCategoryState(asyncHooksEnabledInitial);\n   setTraceCategoryStateUpdateHandler(toggleTraceCategoryState);\n }\n \n+// Dynamically enable/disable the traceEventsAsyncHook\n+function toggleTraceCategoryState(asyncHooksEnabled) {\n+  if (asyncHooksEnabled) {\n+    if (!traceEventsAsyncHook) {\n+      traceEventsAsyncHook =\n+        require('internal/trace_events_async_hooks').createHook();\n+    }\n+    traceEventsAsyncHook.enable();\n+  } else if (traceEventsAsyncHook) {\n+    traceEventsAsyncHook.disable();\n+  }\n+}\n+\n // In general deprecations are intialized wherever the APIs are implemented,\n // this is used to deprecate APIs implemented in C++ where the deprecation\n // utitlities are not easily accessible."
        },
        {
            "sha": "05bb7b85644915a31bc9df9a50b148a277e283b6",
            "filename": "lib/internal/trace_events_async_hooks.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftrace_events_async_hooks.js?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -83,4 +83,4 @@ function createHook() {\n   };\n }\n \n-module.exports = createHook();\n+exports.createHook = createHook;"
        },
        {
            "sha": "aca817605673fdc90b90f77508c2b1931a3100c9",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -455,11 +455,6 @@ Environment::should_abort_on_uncaught_toggle() {\n   return should_abort_on_uncaught_toggle_;\n }\n \n-inline AliasedBuffer<uint8_t, v8::Uint8Array>&\n-Environment::trace_category_state() {\n-  return trace_category_state_;\n-}\n-\n inline AliasedBuffer<int32_t, v8::Int32Array>&\n Environment::stream_base_state() {\n   return stream_base_state_;"
        },
        {
            "sha": "01aee464406628b0a62f47997ffc165728d47bac",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -21,6 +21,7 @@\n namespace node {\n \n using errors::TryCatchScope;\n+using v8::Boolean;\n using v8::Context;\n using v8::EmbedderGraph;\n using v8::External;\n@@ -152,9 +153,8 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n     return;\n   }\n \n-  env_->trace_category_state()[0] =\n-      *TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n-          TRACING_CATEGORY_NODE1(async_hooks));\n+  bool async_hooks_enabled = (*(TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n+                                 TRACING_CATEGORY_NODE1(async_hooks)))) != 0;\n \n   Isolate* isolate = env_->isolate();\n   HandleScope handle_scope(isolate);\n@@ -163,8 +163,9 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n     return;\n   TryCatchScope try_catch(env_);\n   try_catch.SetVerbose(true);\n-  cb->Call(env_->context(), Undefined(isolate),\n-           0, nullptr).ToLocalChecked();\n+  Local<Value> args[] = {Boolean::New(isolate, async_hooks_enabled)};\n+  cb->Call(env_->context(), Undefined(isolate), arraysize(args), args)\n+      .ToLocalChecked();\n }\n \n static std::atomic<uint64_t> next_thread_id{0};\n@@ -183,7 +184,6 @@ Environment::Environment(IsolateData* isolate_data,\n       tick_info_(context->GetIsolate()),\n       timer_base_(uv_now(isolate_data->event_loop())),\n       should_abort_on_uncaught_toggle_(isolate_, 1),\n-      trace_category_state_(isolate_, kTraceCategoryCount),\n       stream_base_state_(isolate_, StreamBase::kNumStreamBaseStateFields),\n       flags_(flags),\n       thread_id_(thread_id == kNoThreadId ? AllocateThreadId() : thread_id),"
        },
        {
            "sha": "5f578dd54a9a7fdc382e3369482add7711f9a161",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -707,7 +707,6 @@ class Environment {\n   inline AliasedBuffer<uint32_t, v8::Uint32Array>&\n   should_abort_on_uncaught_toggle();\n \n-  inline AliasedBuffer<uint8_t, v8::Uint8Array>& trace_category_state();\n   inline AliasedBuffer<int32_t, v8::Int32Array>& stream_base_state();\n \n   // The necessary API for async_hooks.\n@@ -1022,8 +1021,6 @@ class Environment {\n   AliasedBuffer<uint32_t, v8::Uint32Array> should_abort_on_uncaught_toggle_;\n   int should_not_abort_scope_counter_ = 0;\n \n-  // Attached to a Uint8Array that tracks the state of trace category\n-  AliasedBuffer<uint8_t, v8::Uint8Array> trace_category_state_;\n   std::unique_ptr<TrackingTraceStateObserver> trace_state_observer_;\n \n   AliasedBuffer<int32_t, v8::Int32Array> stream_base_state_;"
        },
        {
            "sha": "5e30df41c4f4fa18a3ce5fb6495969b54f169af9",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c435f069ebb3b8a1c6fb0d983db7f1b799715627/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=c435f069ebb3b8a1c6fb0d983db7f1b799715627",
            "patch": "@@ -1,6 +1,7 @@\n #include \"base_object-inl.h\"\n #include \"env.h\"\n #include \"node.h\"\n+#include \"node_internals.h\"\n #include \"node_v8_platform-inl.h\"\n #include \"tracing/agent.h\"\n \n@@ -10,6 +11,7 @@\n namespace node {\n \n using v8::Array;\n+using v8::Boolean;\n using v8::Context;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n@@ -148,9 +150,14 @@ void NodeCategorySet::Initialize(Local<Object> target,\n   target->Set(context, trace,\n               binding->Get(context, trace).ToLocalChecked()).FromJust();\n \n-  target->Set(context,\n-              FIXED_ONE_BYTE_STRING(env->isolate(), \"traceCategoryState\"),\n-              env->trace_category_state().GetJSArray()).FromJust();\n+  // Initial value of async hook trace events\n+  bool async_hooks_enabled = (*(TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n+                                 TRACING_CATEGORY_NODE1(async_hooks)))) != 0;\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"asyncHooksEnabledInitial\"),\n+            Boolean::New(env->isolate(), async_hooks_enabled))\n+      .FromJust();\n }\n \n }  // namespace node"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 35,
        "deletions": 38
    }
}