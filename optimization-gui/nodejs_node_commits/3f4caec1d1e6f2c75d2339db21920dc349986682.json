{
    "author": "addaleax",
    "message": "src: re-integrate headers into node.h\n\nAlternative to https://github.com/nodejs/node/pull/20938\n(clean revert) and https://github.com/nodejs/node/pull/20925\n(adding the headers to the release tarball).\n\nThe changes to `src/node.h` are a clean revert in the\nsame ways as https://github.com/nodejs/node/pull/20938 does it,\nthe difference being that the new `.cc` files are kept here.\n\nThis has the advantage of not being another large diff that\nother PRs will have to rebase against, especially since\nthe split into `callback_scope.cc` and `exceptions.cc` is\nsomething that we want to keep in the long run.\n\nThis essentialy implements bnoordhuisâ€™s suggestion from\nhttps://github.com/nodejs/node/pull/20925.\n\nPR-URL: https://github.com/nodejs/node/pull/20939\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "3f4caec1d1e6f2c75d2339db21920dc349986682",
    "files": [
        {
            "sha": "f1dc3997b76e47f41a9474ea0f0f0800b209c39d",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3f4caec1d1e6f2c75d2339db21920dc349986682/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/3f4caec1d1e6f2c75d2339db21920dc349986682/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=3f4caec1d1e6f2c75d2339db21920dc349986682",
            "patch": "@@ -372,12 +372,10 @@\n         'src/async_wrap-inl.h',\n         'src/base_object.h',\n         'src/base_object-inl.h',\n-        'src/callback_scope.h',\n         'src/connection_wrap.h',\n         'src/connect_wrap.h',\n         'src/env.h',\n         'src/env-inl.h',\n-        'src/exceptions.h',\n         'src/handle_wrap.h',\n         'src/js_stream.h',\n         'src/module_wrap.h',"
        },
        {
            "sha": "5e7a27cf01fc202c290b11ed0bb31dd6495916be",
            "filename": "src/callback_scope.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fcallback_scope.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fcallback_scope.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcallback_scope.cc?ref=3f4caec1d1e6f2c75d2339db21920dc349986682",
            "patch": "@@ -1,5 +1,4 @@\n #include \"node.h\"\n-#include \"callback_scope.h\"\n #include \"async_wrap.h\"\n #include \"async_wrap-inl.h\"\n #include \"env.h\""
        },
        {
            "sha": "7f199aaea228d4efad2e3f1bf1a2d9382c5170e9",
            "filename": "src/callback_scope.h",
            "status": "removed",
            "additions": 0,
            "deletions": 47,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fcallback_scope.h",
            "raw_url": "https://github.com/nodejs/node/raw/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fcallback_scope.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcallback_scope.h?ref=f96ef5574c6cb00f8d3076b93bc5b88bab9543ac",
            "patch": "@@ -1,47 +0,0 @@\n-#ifndef SRC_CALLBACK_SCOPE_H_\n-#define SRC_CALLBACK_SCOPE_H_\n-\n-#include \"core.h\"\n-#include \"v8.h\"\n-\n-namespace node {\n-\n-typedef double async_id;\n-struct async_context {\n-  ::node::async_id async_id;\n-  ::node::async_id trigger_async_id;\n-};\n-\n-class InternalCallbackScope;\n-\n-/* This class works like `MakeCallback()` in that it sets up a specific\n- * asyncContext as the current one and informs the async_hooks and domains\n- * modules that this context is currently active.\n- *\n- * `MakeCallback()` is a wrapper around this class as well as\n- * `Function::Call()`. Either one of these mechanisms needs to be used for\n- * top-level calls into JavaScript (i.e. without any existing JS stack).\n- *\n- * This object should be stack-allocated to ensure that it is contained in a\n- * valid HandleScope.\n- */\n-class NODE_EXTERN CallbackScope {\n- public:\n-  CallbackScope(v8::Isolate* isolate,\n-                v8::Local<v8::Object> resource,\n-                async_context asyncContext);\n-  ~CallbackScope();\n-\n- private:\n-  InternalCallbackScope* private_;\n-  v8::TryCatch try_catch_;\n-\n-  void operator=(const CallbackScope&) = delete;\n-  void operator=(CallbackScope&&) = delete;\n-  CallbackScope(const CallbackScope&) = delete;\n-  CallbackScope(CallbackScope&&) = delete;\n-};\n-\n-}  // namespace node\n-\n-#endif  // SRC_CALLBACK_SCOPE_H_"
        },
        {
            "sha": "0dbce4f3f8f6f9d264f711dee1883313641bae10",
            "filename": "src/core.h",
            "status": "removed",
            "additions": 0,
            "deletions": 44,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fcore.h",
            "raw_url": "https://github.com/nodejs/node/raw/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fcore.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcore.h?ref=f96ef5574c6cb00f8d3076b93bc5b88bab9543ac",
            "patch": "@@ -1,44 +0,0 @@\n-#ifndef SRC_CORE_H_\n-#define SRC_CORE_H_\n-\n-#ifdef _WIN32\n-# ifndef BUILDING_NODE_EXTENSION\n-#   define NODE_EXTERN __declspec(dllexport)\n-# else\n-#   define NODE_EXTERN __declspec(dllimport)\n-# endif\n-#else\n-# define NODE_EXTERN /* nothing */\n-#endif\n-\n-#define NODE_MAKE_VERSION(major, minor, patch)                                \\\n-  ((major) * 0x1000 + (minor) * 0x100 + (patch))\n-\n-#ifdef __clang__\n-# define NODE_CLANG_AT_LEAST(major, minor, patch)                             \\\n-  (NODE_MAKE_VERSION(major, minor, patch) <=                                  \\\n-      NODE_MAKE_VERSION(__clang_major__, __clang_minor__, __clang_patchlevel__))\n-#else\n-# define NODE_CLANG_AT_LEAST(major, minor, patch) (0)\n-#endif\n-\n-#ifdef __GNUC__\n-# define NODE_GNUC_AT_LEAST(major, minor, patch)                              \\\n-  (NODE_MAKE_VERSION(major, minor, patch) <=                                  \\\n-      NODE_MAKE_VERSION(__GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__))\n-#else\n-# define NODE_GNUC_AT_LEAST(major, minor, patch) (0)\n-#endif\n-\n-#if NODE_CLANG_AT_LEAST(2, 9, 0) || NODE_GNUC_AT_LEAST(4, 5, 0)\n-# define NODE_DEPRECATED(message, declarator)                                 \\\n-    __attribute__((deprecated(message))) declarator\n-#elif defined(_MSC_VER)\n-# define NODE_DEPRECATED(message, declarator)                                 \\\n-    __declspec(deprecated) declarator\n-#else\n-# define NODE_DEPRECATED(message, declarator)                                 \\\n-    declarator\n-#endif\n-\n-#endif  // SRC_CORE_H_"
        },
        {
            "sha": "1bcc7651a28d2c0ce047f46c18f2b85cbd37676a",
            "filename": "src/exceptions.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fexceptions.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fexceptions.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fexceptions.cc?ref=3f4caec1d1e6f2c75d2339db21920dc349986682",
            "patch": "@@ -2,7 +2,6 @@\n #include \"node_internals.h\"\n #include \"env.h\"\n #include \"env-inl.h\"\n-#include \"exceptions.h\"\n #include \"util.h\"\n #include \"util-inl.h\"\n #include \"v8.h\""
        },
        {
            "sha": "8a4a8ce99e876d56f2cc05bbe20dfda26e1dbd29",
            "filename": "src/exceptions.h",
            "status": "removed",
            "additions": 0,
            "deletions": 76,
            "changes": 76,
            "blob_url": "https://github.com/nodejs/node/blob/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fexceptions.h",
            "raw_url": "https://github.com/nodejs/node/raw/f96ef5574c6cb00f8d3076b93bc5b88bab9543ac/src%2Fexceptions.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fexceptions.h?ref=f96ef5574c6cb00f8d3076b93bc5b88bab9543ac",
            "patch": "@@ -1,76 +0,0 @@\n-#ifndef SRC_EXCEPTIONS_H_\n-#define SRC_EXCEPTIONS_H_\n-\n-#include \"core.h\"\n-#include \"v8.h\"\n-\n-namespace node {\n-\n-NODE_EXTERN v8::Local<v8::Value> ErrnoException(v8::Isolate* isolate,\n-                                                int errorno,\n-                                                const char* syscall = nullptr,\n-                                                const char* message = nullptr,\n-                                                const char* path = nullptr);\n-NODE_EXTERN v8::Local<v8::Value> UVException(v8::Isolate* isolate,\n-                                             int errorno,\n-                                             const char* syscall = nullptr,\n-                                             const char* message = nullptr,\n-                                             const char* path = nullptr);\n-NODE_EXTERN v8::Local<v8::Value> UVException(v8::Isolate* isolate,\n-                                             int errorno,\n-                                             const char* syscall,\n-                                             const char* message,\n-                                             const char* path,\n-                                             const char* dest);\n-\n-NODE_DEPRECATED(\n-    \"Use ErrnoException(isolate, ...)\",\n-    inline v8::Local<v8::Value> ErrnoException(\n-        int errorno,\n-        const char* syscall = nullptr,\n-        const char* message = nullptr,\n-        const char* path = nullptr) {\n-  return ErrnoException(v8::Isolate::GetCurrent(),\n-                        errorno,\n-                        syscall,\n-                        message,\n-                        path);\n-})\n-\n-inline v8::Local<v8::Value> UVException(int errorno,\n-                                        const char* syscall = nullptr,\n-                                        const char* message = nullptr,\n-                                        const char* path = nullptr) {\n-  return UVException(v8::Isolate::GetCurrent(),\n-                     errorno,\n-                     syscall,\n-                     message,\n-                     path);\n-}\n-\n-#ifdef _WIN32\n-NODE_EXTERN v8::Local<v8::Value> WinapiErrnoException(\n-    v8::Isolate* isolate,\n-    int errorno,\n-    const char *syscall = nullptr,\n-    const char *msg = \"\",\n-    const char *path = nullptr);\n-\n-NODE_DEPRECATED(\n-    \"Use WinapiErrnoException(isolate, ...)\",\n-    inline v8::Local<v8::Value> WinapiErrnoException(\n-        int errorno,\n-        const char *syscall = nullptr,\n-        const char *msg = \"\",\n-        const char *path = nullptr) {\n-  return WinapiErrnoException(v8::Isolate::GetCurrent(),\n-                              errorno,\n-                              syscall,\n-                              msg,\n-                              path);\n-})\n-#endif\n-\n-}  // namespace node\n-\n-#endif  // SRC_EXCEPTIONS_H_"
        },
        {
            "sha": "44c89afdb7134c9b6a1b6c4abd786b23aec33a91",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 137,
            "deletions": 3,
            "changes": 140,
            "blob_url": "https://github.com/nodejs/node/blob/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/3f4caec1d1e6f2c75d2339db21920dc349986682/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=3f4caec1d1e6f2c75d2339db21920dc349986682",
            "patch": "@@ -22,6 +22,16 @@\n #ifndef SRC_NODE_H_\n #define SRC_NODE_H_\n \n+#ifdef _WIN32\n+# ifndef BUILDING_NODE_EXTENSION\n+#   define NODE_EXTERN __declspec(dllexport)\n+# else\n+#   define NODE_EXTERN __declspec(dllimport)\n+# endif\n+#else\n+# define NODE_EXTERN /* nothing */\n+#endif\n+\n #ifdef BUILDING_NODE_EXTENSION\n # undef BUILDING_V8_SHARED\n # undef BUILDING_UV_SHARED\n@@ -50,12 +60,39 @@\n # define SIGKILL         9\n #endif\n \n-#include \"core.h\"  // NOLINT(build/include_order)\n #include \"v8.h\"  // NOLINT(build/include_order)\n #include \"v8-platform.h\"  // NOLINT(build/include_order)\n #include \"node_version.h\"  // NODE_MODULE_VERSION\n-#include \"callback_scope.h\"\n-#include \"exceptions.h\"\n+\n+#define NODE_MAKE_VERSION(major, minor, patch)                                \\\n+  ((major) * 0x1000 + (minor) * 0x100 + (patch))\n+\n+#ifdef __clang__\n+# define NODE_CLANG_AT_LEAST(major, minor, patch)                             \\\n+  (NODE_MAKE_VERSION(major, minor, patch) <=                                  \\\n+      NODE_MAKE_VERSION(__clang_major__, __clang_minor__, __clang_patchlevel__))\n+#else\n+# define NODE_CLANG_AT_LEAST(major, minor, patch) (0)\n+#endif\n+\n+#ifdef __GNUC__\n+# define NODE_GNUC_AT_LEAST(major, minor, patch)                              \\\n+  (NODE_MAKE_VERSION(major, minor, patch) <=                                  \\\n+      NODE_MAKE_VERSION(__GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__))\n+#else\n+# define NODE_GNUC_AT_LEAST(major, minor, patch) (0)\n+#endif\n+\n+#if NODE_CLANG_AT_LEAST(2, 9, 0) || NODE_GNUC_AT_LEAST(4, 5, 0)\n+# define NODE_DEPRECATED(message, declarator)                                 \\\n+    __attribute__((deprecated(message))) declarator\n+#elif defined(_MSC_VER)\n+# define NODE_DEPRECATED(message, declarator)                                 \\\n+    __declspec(deprecated) declarator\n+#else\n+# define NODE_DEPRECATED(message, declarator)                                 \\\n+    declarator\n+#endif\n \n // Forward-declare libuv loop\n struct uv_loop_s;\n@@ -69,6 +106,47 @@ class TracingController;\n // terminally confused when it's done in node_internals.h\n namespace node {\n \n+NODE_EXTERN v8::Local<v8::Value> ErrnoException(v8::Isolate* isolate,\n+                                                int errorno,\n+                                                const char* syscall = nullptr,\n+                                                const char* message = nullptr,\n+                                                const char* path = nullptr);\n+NODE_EXTERN v8::Local<v8::Value> UVException(v8::Isolate* isolate,\n+                                             int errorno,\n+                                             const char* syscall = nullptr,\n+                                             const char* message = nullptr,\n+                                             const char* path = nullptr);\n+NODE_EXTERN v8::Local<v8::Value> UVException(v8::Isolate* isolate,\n+                                             int errorno,\n+                                             const char* syscall,\n+                                             const char* message,\n+                                             const char* path,\n+                                             const char* dest);\n+\n+NODE_DEPRECATED(\"Use ErrnoException(isolate, ...)\",\n+                inline v8::Local<v8::Value> ErrnoException(\n+      int errorno,\n+      const char* syscall = nullptr,\n+      const char* message = nullptr,\n+      const char* path = nullptr) {\n+  return ErrnoException(v8::Isolate::GetCurrent(),\n+                        errorno,\n+                        syscall,\n+                        message,\n+                        path);\n+})\n+\n+inline v8::Local<v8::Value> UVException(int errorno,\n+                                        const char* syscall = nullptr,\n+                                        const char* message = nullptr,\n+                                        const char* path = nullptr) {\n+  return UVException(v8::Isolate::GetCurrent(),\n+                     errorno,\n+                     syscall,\n+                     message,\n+                     path);\n+}\n+\n /*\n  * These methods need to be called in a HandleScope.\n  *\n@@ -373,6 +451,26 @@ NODE_DEPRECATED(\"Use DecodeWrite(isolate, ...)\",\n   return DecodeWrite(v8::Isolate::GetCurrent(), buf, buflen, val, encoding);\n })\n \n+#ifdef _WIN32\n+NODE_EXTERN v8::Local<v8::Value> WinapiErrnoException(\n+    v8::Isolate* isolate,\n+    int errorno,\n+    const char *syscall = nullptr,\n+    const char *msg = \"\",\n+    const char *path = nullptr);\n+\n+NODE_DEPRECATED(\"Use WinapiErrnoException(isolate, ...)\",\n+                inline v8::Local<v8::Value> WinapiErrnoException(int errorno,\n+    const char *syscall = nullptr,  const char *msg = \"\",\n+    const char *path = nullptr) {\n+  return WinapiErrnoException(v8::Isolate::GetCurrent(),\n+                              errorno,\n+                              syscall,\n+                              msg,\n+                              path);\n+})\n+#endif\n+\n const char *signo_string(int errorno);\n \n \n@@ -495,6 +593,12 @@ typedef void (*promise_hook_func) (v8::PromiseHookType type,\n                                    v8::Local<v8::Value> parent,\n                                    void* arg);\n \n+typedef double async_id;\n+struct async_context {\n+  ::node::async_id async_id;\n+  ::node::async_id trigger_async_id;\n+};\n+\n /* Registers an additional v8::PromiseHook wrapper. This API exists because V8\n  * itself supports only a single PromiseHook. */\n NODE_EXTERN void AddPromiseHook(v8::Isolate* isolate,\n@@ -543,6 +647,36 @@ NODE_EXTERN async_context EmitAsyncInit(v8::Isolate* isolate,\n NODE_EXTERN void EmitAsyncDestroy(v8::Isolate* isolate,\n                                   async_context asyncContext);\n \n+class InternalCallbackScope;\n+\n+/* This class works like `MakeCallback()` in that it sets up a specific\n+ * asyncContext as the current one and informs the async_hooks and domains\n+ * modules that this context is currently active.\n+ *\n+ * `MakeCallback()` is a wrapper around this class as well as\n+ * `Function::Call()`. Either one of these mechanisms needs to be used for\n+ * top-level calls into JavaScript (i.e. without any existing JS stack).\n+ *\n+ * This object should be stack-allocated to ensure that it is contained in a\n+ * valid HandleScope.\n+ */\n+class NODE_EXTERN CallbackScope {\n+ public:\n+  CallbackScope(v8::Isolate* isolate,\n+                v8::Local<v8::Object> resource,\n+                async_context asyncContext);\n+  ~CallbackScope();\n+\n+ private:\n+  InternalCallbackScope* private_;\n+  v8::TryCatch try_catch_;\n+\n+  void operator=(const CallbackScope&) = delete;\n+  void operator=(CallbackScope&&) = delete;\n+  CallbackScope(const CallbackScope&) = delete;\n+  CallbackScope(CallbackScope&&) = delete;\n+};\n+\n /* An API specific to emit before/after callbacks is unnecessary because\n  * MakeCallback will automatically call them for you.\n  *"
        }
    ],
    "stats": {
        "total": 311,
        "additions": 137,
        "deletions": 174
    }
}