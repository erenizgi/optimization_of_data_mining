{
    "author": "joyeecheung",
    "message": "fs: throw errors from fs.fdatasyncSync in JS\n\nPR-URL: https://github.com/nodejs/node/pull/18348\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f5e287ba208b8d9eed3c850577ff9a46d9935d9a",
    "files": [
        {
            "sha": "49e550fe3d794a38e348ba1654f5bd340af89cb4",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=f5e287ba208b8d9eed3c850577ff9a46d9935d9a",
            "patch": "@@ -1029,7 +1029,11 @@ fs.fdatasync = function(fd, callback) {\n \n fs.fdatasyncSync = function(fd) {\n   validateUint32(fd, 'fd');\n-  return binding.fdatasync(fd);\n+  const ctx = {};\n+  binding.fdatasync(fd, undefined, ctx);\n+  if (ctx.errno !== undefined) {\n+    throw new errors.uvException(ctx);\n+  }\n };\n \n fs.fsync = function(fd, callback) {"
        },
        {
            "sha": "6188da24488fd98abdaed565109054527a5f882f",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=f5e287ba208b8d9eed3c850577ff9a46d9935d9a",
            "patch": "@@ -735,16 +735,21 @@ static void FTruncate(const FunctionCallbackInfo<Value>& args) {\n static void Fdatasync(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  CHECK(args[0]->IsInt32());\n+  const int argc = args.Length();\n+  CHECK_GE(argc, 2);\n \n-  int fd = args[0]->Int32Value();\n+  CHECK(args[0]->IsInt32());\n+  const int fd = args[0]->As<Int32>()->Value();\n \n-  if (args[1]->IsObject()) {\n-    CHECK_EQ(args.Length(), 2);\n+  if (args[1]->IsObject()) {  // fdatasync(fd, req)\n+    CHECK_EQ(argc, 2);\n     AsyncCall(env, args, \"fdatasync\", UTF8, AfterNoArgs,\n               uv_fs_fdatasync, fd);\n-  } else {\n-    SYNC_CALL(fdatasync, 0, fd)\n+  } else {  // fdatasync(fd, undefined, ctx)\n+    CHECK_EQ(argc, 3);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[2], &req_wrap, \"fdatasync\",\n+             uv_fs_fdatasync, fd);\n   }\n }\n "
        },
        {
            "sha": "116c8537242e73514875dc9d65a6907a10755f91",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/f5e287ba208b8d9eed3c850577ff9a46d9935d9a/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=f5e287ba208b8d9eed3c850577ff9a46d9935d9a",
            "patch": "@@ -482,3 +482,24 @@ function re(literals, ...values) {\n     validateError\n   );\n }\n+\n+// fdatasync\n+{\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, fdatasync');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'fdatasync');\n+    return true;\n+  };\n+\n+  const fd = fs.openSync(existingFile, 'r');\n+  fs.closeSync(fd);\n+\n+  fs.fdatasync(fd, common.mustCall(validateError));\n+\n+  assert.throws(\n+    () => fs.fdatasyncSync(fd),\n+    validateError\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 37,
        "deletions": 7
    }
}