{
    "author": "hekike",
    "message": "http2: add http fallback options to .createServer\n\nThis adds the Http1IncomingMessage and Http1ServerReponse options\nto http2.createServer().\n\nPR-URL: https://github.com/nodejs/node/pull/15752\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>",
    "sha": "f6e1466352e00e40da4f4c3e8b14d40752890374",
    "files": [
        {
            "sha": "3e62108048ee060387fd46fdd2711967f2519022",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/f6e1466352e00e40da4f4c3e8b14d40752890374/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/f6e1466352e00e40da4f4c3e8b14d40752890374/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=f6e1466352e00e40da4f4c3e8b14d40752890374",
            "patch": "@@ -1655,6 +1655,10 @@ changes:\n     pr-url: https://github.com/nodejs/node/pull/16676\n     description: Added the `maxHeaderListPairs` option with a default limit of\n                  128 header pairs.\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/15752\n+    description: Added the `Http1IncomingMessage` and `Http1ServerResponse`\n+                 option.\n -->\n \n * `options` {Object}\n@@ -1698,12 +1702,18 @@ changes:\n   * `peerMaxConcurrentStreams` {number} Sets the maximum number of concurrent\n     streams for the remote peer as if a SETTINGS frame had been received. Will\n     be overridden if the remote peer sets its own value for.\n-    `maxConcurrentStreams`. **Default** `100`\n+    `maxConcurrentStreams`. **Default:** `100`\n   * `selectPadding` {Function} When `options.paddingStrategy` is equal to\n     `http2.constants.PADDING_STRATEGY_CALLBACK`, provides the callback function\n     used to determine the padding. See [Using options.selectPadding][].\n   * `settings` {HTTP2 Settings Object} The initial settings to send to the\n     remote peer upon connection.\n+  * `Http1IncomingMessage` {http.IncomingMessage} Specifies the IncomingMessage\n+    class to used for HTTP/1 fallback. Useful for extending the original\n+    `http.IncomingMessage`. **Default:** `http.IncomingMessage`\n+  * `Http1ServerResponse` {http.ServerResponse} Specifies the ServerResponse\n+    class to used for HTTP/1 fallback. Useful for extending the original\n+    `http.ServerResponse`. **Default:** `http.ServerResponse`\n * `onRequestHandler` {Function} See [Compatibility API][]\n * Returns: {Http2Server}\n "
        },
        {
            "sha": "f735e2fcc92f62406cb37c78f8dfd86f04f53405",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f6e1466352e00e40da4f4c3e8b14d40752890374/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6e1466352e00e40da4f4c3e8b14d40752890374/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=f6e1466352e00e40da4f4c3e8b14d40752890374",
            "patch": "@@ -5,6 +5,7 @@\n require('internal/util').assertCrypto();\n \n const { async_id_symbol } = process.binding('async_wrap');\n+const http = require('http');\n const binding = process.binding('http2');\n const assert = require('assert');\n const { Buffer } = require('buffer');\n@@ -68,6 +69,8 @@ const NETServer = net.Server;\n const TLSServer = tls.Server;\n \n const kInspect = require('internal/util').customInspectSymbol;\n+const { kIncomingMessage } = require('_http_common');\n+const { kServerResponse } = require('_http_server');\n \n const kAlpnProtocol = Symbol('alpnProtocol');\n const kAuthority = Symbol('authority');\n@@ -2453,8 +2456,11 @@ function connectionListener(socket) {\n \n   if (socket.alpnProtocol === false || socket.alpnProtocol === 'http/1.1') {\n     // Fallback to HTTP/1.1\n-    if (options.allowHTTP1 === true)\n+    if (options.allowHTTP1 === true) {\n+      socket.server[kIncomingMessage] = options.Http1IncomingMessage;\n+      socket.server[kServerResponse] = options.Http1ServerResponse;\n       return httpConnectionListener.call(this, socket);\n+    }\n     // Let event handler deal with the socket\n     if (!this.emit('unknownProtocol', socket))\n       socket.destroy();\n@@ -2485,6 +2491,13 @@ function initializeOptions(options) {\n   options.allowHalfOpen = true;\n   assertIsObject(options.settings, 'options.settings');\n   options.settings = Object.assign({}, options.settings);\n+\n+  // Used only with allowHTTP1\n+  options.Http1IncomingMessage = options.Http1IncomingMessage ||\n+    http.IncomingMessage;\n+  options.Http1ServerResponse = options.Http1ServerResponse ||\n+    http.ServerResponse;\n+\n   return options;\n }\n "
        },
        {
            "sha": "20e2b122a24e8c3e3d0c841b443648b86723bef7",
            "filename": "test/parallel/test-http2-https-fallback-http-server-options.js",
            "status": "added",
            "additions": 90,
            "deletions": 0,
            "changes": 90,
            "blob_url": "https://github.com/nodejs/node/blob/f6e1466352e00e40da4f4c3e8b14d40752890374/test%2Fparallel%2Ftest-http2-https-fallback-http-server-options.js",
            "raw_url": "https://github.com/nodejs/node/raw/f6e1466352e00e40da4f4c3e8b14d40752890374/test%2Fparallel%2Ftest-http2-https-fallback-http-server-options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-https-fallback-http-server-options.js?ref=f6e1466352e00e40da4f4c3e8b14d40752890374",
            "patch": "@@ -0,0 +1,90 @@\n+// Flags: --expose-http2\n+'use strict';\n+\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const url = require('url');\n+const tls = require('tls');\n+const http2 = require('http2');\n+const https = require('https');\n+const http = require('http');\n+\n+const key = fixtures.readKey('agent8-key.pem');\n+const cert = fixtures.readKey('agent8-cert.pem');\n+const ca = fixtures.readKey('fake-startcom-root-cert.pem');\n+\n+function onRequest(request, response) {\n+  const { socket: { alpnProtocol } } = request.httpVersion === '2.0' ?\n+    request.stream.session : request;\n+  response.status(200);\n+  response.end(JSON.stringify({\n+    alpnProtocol,\n+    httpVersion: request.httpVersion,\n+    userAgent: request.getUserAgent()\n+  }));\n+}\n+\n+class MyIncomingMessage extends http.IncomingMessage {\n+  getUserAgent() {\n+    return this.headers['user-agent'] || 'unknown';\n+  }\n+}\n+\n+class MyServerResponse extends http.ServerResponse {\n+  status(code) {\n+    return this.writeHead(code, { 'Content-Type': 'application/json' });\n+  }\n+}\n+\n+// HTTP/2 & HTTP/1.1 server\n+{\n+  const server = http2.createSecureServer(\n+    {\n+      cert,\n+      key, allowHTTP1: true,\n+      Http1IncomingMessage: MyIncomingMessage,\n+      Http1ServerResponse: MyServerResponse\n+    },\n+    common.mustCall(onRequest, 1)\n+  );\n+\n+  server.listen(0);\n+\n+  server.on('listening', common.mustCall(() => {\n+    const { port } = server.address();\n+    const origin = `https://localhost:${port}`;\n+\n+    // HTTP/1.1 client\n+    https.get(\n+      Object.assign(url.parse(origin), {\n+        secureContext: tls.createSecureContext({ ca }),\n+        headers: { 'User-Agent': 'node-test' }\n+      }),\n+      common.mustCall((response) => {\n+        assert.strictEqual(response.statusCode, 200);\n+        assert.strictEqual(response.statusMessage, 'OK');\n+        assert.strictEqual(\n+          response.headers['content-type'],\n+          'application/json'\n+        );\n+\n+        response.setEncoding('utf8');\n+        let raw = '';\n+        response.on('data', (chunk) => { raw += chunk; });\n+        response.on('end', common.mustCall(() => {\n+          const { alpnProtocol, httpVersion, userAgent } = JSON.parse(raw);\n+          assert.strictEqual(alpnProtocol, false);\n+          assert.strictEqual(httpVersion, '1.1');\n+          assert.strictEqual(userAgent, 'node-test');\n+\n+          server.close();\n+        }));\n+      })\n+    );\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 115,
        "deletions": 2
    }
}