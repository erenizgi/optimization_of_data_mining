{
    "author": "joyeecheung",
    "message": "fs: throw errors from fs.readlinkSync in JS\n\nPR-URL: https://github.com/nodejs/node/pull/18348\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "09da11e5e1a5578d583df3e7f18ecd9b6dd5caab",
    "files": [
        {
            "sha": "b200f8d4c412e7d2e3461c3ff4e5557055f90ad8",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/09da11e5e1a5578d583df3e7f18ecd9b6dd5caab/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/09da11e5e1a5578d583df3e7f18ecd9b6dd5caab/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=09da11e5e1a5578d583df3e7f18ecd9b6dd5caab",
            "patch": "@@ -1163,7 +1163,13 @@ fs.readlinkSync = function(path, options) {\n   handleError((path = getPathFromURL(path)));\n   nullCheck(path);\n   validatePath(path, 'oldPath');\n-  return binding.readlink(pathModule.toNamespacedPath(path), options.encoding);\n+  const ctx = { path };\n+  const result = binding.readlink(pathModule.toNamespacedPath(path),\n+                                  options.encoding, undefined, ctx);\n+  if (ctx.errno !== undefined) {\n+    throw new errors.uvException(ctx);\n+  }\n+  return result;\n };\n \n function preprocessSymlinkDestination(path, type, linkPath) {\n@@ -1982,7 +1988,10 @@ fs.realpathSync = function realpathSync(p, options) {\n         if (ctx.errno !== undefined) {\n           throw new errors.uvException(ctx);\n         }\n-        linkTarget = binding.readlink(baseLong);\n+        linkTarget = binding.readlink(baseLong, undefined, undefined, ctx);\n+        if (ctx.errno !== undefined) {\n+          throw new errors.uvException(ctx);\n+        }\n       }\n       resolvedLink = pathModule.resolve(previous, linkTarget);\n "
        },
        {
            "sha": "e193b53c73861e924e22eba3468e6339ba5a10fc",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/09da11e5e1a5578d583df3e7f18ecd9b6dd5caab/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/09da11e5e1a5578d583df3e7f18ecd9b6dd5caab/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=09da11e5e1a5578d583df3e7f18ecd9b6dd5caab",
            "patch": "@@ -648,32 +648,39 @@ static void Link(const FunctionCallbackInfo<Value>& args) {\n static void ReadLink(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  const int argc = args.Length();\n-\n-  CHECK_GE(argc, 1);\n+  int argc = args.Length();\n+  CHECK_GE(argc, 3);\n \n   BufferValue path(env->isolate(), args[0]);\n   CHECK_NE(*path, nullptr);\n \n   const enum encoding encoding = ParseEncoding(env->isolate(), args[1], UTF8);\n \n   if (args[2]->IsObject()) {  // readlink(path, encoding, req)\n-    CHECK_EQ(args.Length(), 3);\n+    CHECK_EQ(argc, 3);\n     AsyncCall(env, args, \"readlink\", encoding, AfterStringPtr,\n               uv_fs_readlink, *path);\n-  } else {\n-    SYNC_CALL(readlink, *path, *path)\n-    const char* link_path = static_cast<const char*>(SYNC_REQ.ptr);\n+  } else {  // readlink(path, encoding, undefined, ctx)\n+    CHECK_EQ(argc, 4);\n+    fs_req_wrap req_wrap;\n+    int err = SyncCall(env, args[3], &req_wrap, \"readlink\",\n+                       uv_fs_readlink, *path);\n+    if (err) {\n+      return;  // syscall failed, no need to continue, error info is in ctx\n+    }\n+    const char* link_path = static_cast<const char*>(req_wrap.req.ptr);\n \n     Local<Value> error;\n     MaybeLocal<Value> rc = StringBytes::Encode(env->isolate(),\n                                                link_path,\n                                                encoding,\n                                                &error);\n     if (rc.IsEmpty()) {\n-      env->isolate()->ThrowException(error);\n+      Local<Object> ctx = args[3].As<Object>();\n+      ctx->Set(env->context(), env->error_string(), error).FromJust();\n       return;\n     }\n+\n     args.GetReturnValue().Set(rc.ToLocalChecked());\n   }\n }"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 26,
        "deletions": 10
    }
}