{
    "author": "jasnell",
    "message": "trace_events: adds a new trace_events api\n\nRemoves the requirement to use `--trace-events-enabled` to enable\ntrace events. Tracing is enabled automatically if there are any\nenabled categories.\n\nAdds a new `trace_events` module with an API for enabling/disabling\ntrace events at runtime without a command line flag.\n\n```js\nconst trace_events = require('trace_events');\nconst categories = [ 'node.perf', 'node.async_hooks' ];\nconst tracing = trace_events.createTracing({ categories });\ntracing.enable();\n// do stuff\ntracing.disable();\n```\n\nMultiple `Tracing` objects may exist and be enabled at any point\nin time. The enabled trace event categories is the union of all\nenabled `Tracing` objects and the `--trace-event-categories`\nflag.\n\nPR-URL: https://github.com/nodejs/node/pull/19803\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "5c27e44488aa1c00248297204ff3484c24ff3ae7",
    "files": [
        {
            "sha": "9b487b50a5503124085a0cf84f6f054b0c89c67d",
            "filename": "doc/api/_toc.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2F_toc.md",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2F_toc.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2F_toc.md?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -46,7 +46,7 @@\n * [String Decoder](string_decoder.html)\n * [Timers](timers.html)\n * [TLS/SSL](tls.html)\n-* [Tracing](tracing.html)\n+* [Trace Events](tracing.html)\n * [TTY](tty.html)\n * [UDP/Datagram](dgram.html)\n * [URL](url.html)"
        },
        {
            "sha": "84a74c51e050935519fcd4095e779c663f42048e",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -1550,6 +1550,18 @@ socket, which is only valid from a client.\n \n An attempt was made to renegotiate TLS on a socket instance with TLS disabled.\n \n+<a id=\"ERR_TRACE_EVENTS_CATEGORY_REQUIRED\"></a>\n+### ERR_TRACE_EVENTS_CATEGORY_REQUIRED\n+\n+The `trace_events.createTracing()` method requires at least one trace event\n+category.\n+\n+<a id=\"ERR_TRACE_EVENTS_UNAVAILABLE\"></a>\n+### ERR_TRACE_EVENTS_UNAVAILABLE\n+\n+The `trace_events` module could not be loaded because Node.js was compiled with\n+the `--without-v8-platform` flag.\n+\n <a id=\"ERR_TRANSFORM_ALREADY_TRANSFORMING\"></a>\n ### ERR_TRANSFORM_ALREADY_TRANSFORMING\n "
        },
        {
            "sha": "e07320a0163284bfce3fb9a3116c6fb439f97a8e",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 153,
            "deletions": 9,
            "changes": 162,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -1,16 +1,15 @@\n-# Tracing\n+# Trace Events\n \n <!--introduced_in=v7.7.0-->\n \n+> Stability: 1 - Experimental\n+\n Trace Event provides a mechanism to centralize tracing information generated by\n V8, Node.js core, and userspace code.\n \n-Tracing can be enabled by passing the `--trace-events-enabled` flag when\n-starting a Node.js application.\n-\n-The set of categories for which traces are recorded can be specified using the\n-`--trace-event-categories` flag followed by a list of comma separated category\n-names.\n+Tracing can be enabled with the `--trace-event-categories` command-line flag\n+or by using the trace_events module. The `--trace-event-categories` flag accepts\n+a list of comma-separated category names.\n \n The available categories are:\n \n@@ -27,7 +26,32 @@ The available categories are:\n By default the `node`, `node.async_hooks`, and `v8` categories are enabled.\n \n ```txt\n-node --trace-events-enabled --trace-event-categories v8,node,node.async_hooks server.js\n+node --trace-event-categories v8,node,node.async_hooks server.js\n+```\n+\n+Prior versions of Node.js required the use of the `--trace-events-enabled`\n+flag to enable trace events. This requirement has been removed. However, the\n+`--trace-events-enabled` flag *may* still be used and will enable the\n+`node`, `node.async_hooks`, and `v8` trace event categories by default.\n+\n+```txt\n+node --trace-events-enabled\n+\n+// is equivalent to\n+\n+node --trace-event-categories v8,node,node.async_hooks\n+```\n+\n+Alternatively, trace events may be enabled using the `trace_events` module:\n+\n+```js\n+const trace_events = require('trace_events');\n+const tracing = trace_events.createTracing({ categories: ['node.perf'] });\n+tracing.enable();  // Enable trace event capture for the 'node.perf' category\n+\n+// do work\n+\n+tracing.disable();  // Disable trace event capture for the 'node.perf' category\n ```\n \n Running Node.js with tracing enabled will produce log files that can be opened\n@@ -40,12 +64,132 @@ be specified with `--trace-event-file-pattern` that accepts a template\n string that supports `${rotation}` and `${pid}`. For example:\n \n ```txt\n-node --trace-events-enabled --trace-event-file-pattern '${pid}-${rotation}.log' server.js\n+node --trace-event-categories v8 --trace-event-file-pattern '${pid}-${rotation}.log' server.js\n ```\n \n Starting with Node.js 10.0.0, the tracing system uses the same time source\n as the one used by `process.hrtime()`\n however the trace-event timestamps are expressed in microseconds,\n unlike `process.hrtime()` which returns nanoseconds.\n \n+## The `trace_events` module\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+### `Tracing` object\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+The `Tracing` object is used to enable or disable tracing for sets of\n+categories. Instances are created using the `trace_events.createTracing()`\n+method.\n+\n+When created, the `Tracing` object is disabled. Calling the\n+`tracing.enable()` method adds the categories to the set of enabled trace event\n+categories. Calling `tracing.disable()` will remove the categories from the\n+set of enabled trace event categories.\n+\n+#### `tracing.categories`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {string}\n+\n+A comma-separated list of the trace event categories covered by this\n+`Tracing` object.\n+\n+#### `tracing.disable()`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Disables this `Tracing` object.\n+\n+Only trace event categories *not* covered by other enabled `Tracing` objects\n+and *not* specified by the `--trace-event-categories` flag will be disabled.\n+\n+```js\n+const trace_events = require('trace_events');\n+const t1 = trace_events.createTracing({ categories: ['node', 'v8'] });\n+const t2 = trace_events.createTracing({ categories: ['node.perf', 'node'] });\n+t1.enable();\n+t2.enable();\n+\n+// Prints 'node,node.perf,v8'\n+console.log(trace_events.getEnabledCategories());\n+\n+t2.disable(); // will only disable emission of the 'node.perf' category\n+\n+// Prints 'node,v8'\n+console.log(trace_events.getEnabledCategories());\n+```\n+\n+#### `tracing.enable()`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Enables this `Tracing` object for the set of categories covered by the\n+`Tracing` object.\n+\n+#### `tracing.enabled`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {boolean} `true` only if the `Tracing` object has been enabled.\n+\n+### `trace_events.createTracing(options)`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `options` {Object}\n+  * `categories` {string[]} An array of trace category names. Values included\n+    in the array are coerced to a string when possible. An error will be\n+    thrown if the value cannot be coerced.\n+* Returns: {Tracing}.\n+\n+Creates and returns a `Tracing` object for the given set of `categories`.\n+\n+```js\n+const trace_events = require('trace_events');\n+const categories = ['node.perf', 'node.async_hooks'];\n+const tracing = trace_events.createTracing({ categories });\n+tracing.enable();\n+// do stuff\n+tracing.disable();\n+```\n+\n+### `trace_events.getEnabledCategories()`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {string}\n+\n+Returns a comma-separated list of all currently-enabled trace event\n+categories. The current set of enabled trace event categories is determined\n+by the *union* of all currently-enabled `Tracing` objects and any categories\n+enabled using the `--trace-event-categories` flag.\n+\n+Given the file `test.js` below, the command\n+`node --trace-event-categories node.perf test.js` will print\n+`'node.async_hooks,node.perf'` to the console.\n+\n+```js\n+const trace_events = require('trace_events');\n+const t1 = trace_events.createTracing({ categories: ['node.async_hooks'] });\n+const t2 = trace_events.createTracing({ categories: ['node.perf'] });\n+const t3 = trace_events.createTracing({ categories: ['v8'] });\n+\n+t1.enable();\n+t2.enable();\n+\n+console.log(trace_events.getEnabledCategories());\n+```\n+\n [Performance API]: perf_hooks.html"
        },
        {
            "sha": "4823f0b65cb6ea648a3923a430d5ec2ebe13e028",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -984,6 +984,9 @@ E('ERR_TLS_REQUIRED_SERVER_NAME',\n E('ERR_TLS_SESSION_ATTACK', 'TLS session renegotiation attack detected', Error);\n E('ERR_TLS_SNI_FROM_SERVER',\n   'Cannot issue SNI from a TLS server-side socket', Error);\n+E('ERR_TRACE_EVENTS_CATEGORY_REQUIRED',\n+  'At least one category is required', TypeError);\n+E('ERR_TRACE_EVENTS_UNAVAILABLE', 'Trace events are unavailable', Error);\n E('ERR_TRANSFORM_ALREADY_TRANSFORMING',\n   'Calling transform done when still transforming', Error);\n "
        },
        {
            "sha": "60346c5841c7dfab1d17745e99c8fedfc945bfce",
            "filename": "lib/internal/modules/cjs/helpers.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Fhelpers.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -101,7 +101,8 @@ const builtinLibs = [\n   'assert', 'async_hooks', 'buffer', 'child_process', 'cluster', 'crypto',\n   'dgram', 'dns', 'domain', 'events', 'fs', 'http', 'http2', 'https', 'net',\n   'os', 'path', 'perf_hooks', 'punycode', 'querystring', 'readline', 'repl',\n-  'stream', 'string_decoder', 'tls', 'tty', 'url', 'util', 'v8', 'vm', 'zlib'\n+  'stream', 'string_decoder', 'tls', 'trace_events', 'tty', 'url', 'util',\n+  'v8', 'vm', 'zlib'\n ];\n \n if (typeof process.binding('inspector').open === 'function') {"
        },
        {
            "sha": "45015c8a63add0bf24c75830a332f4fa19d70a32",
            "filename": "lib/trace_events.js",
            "status": "added",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Ftrace_events.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/lib%2Ftrace_events.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftrace_events.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -0,0 +1,89 @@\n+'use strict';\n+\n+const { hasTracing } = process.binding('config');\n+const kHandle = Symbol('handle');\n+const kEnabled = Symbol('enabled');\n+const kCategories = Symbol('categories');\n+\n+const kMaxTracingCount = 10;\n+\n+const {\n+  ERR_TRACE_EVENTS_CATEGORY_REQUIRED,\n+  ERR_TRACE_EVENTS_UNAVAILABLE,\n+  ERR_INVALID_ARG_TYPE\n+} = require('internal/errors').codes;\n+\n+if (!hasTracing)\n+  throw new ERR_TRACE_EVENTS_UNAVAILABLE();\n+\n+const { CategorySet, getEnabledCategories } = process.binding('trace_events');\n+const { customInspectSymbol } = require('internal/util');\n+const { format } = require('util');\n+\n+const enabledTracingObjects = new Set();\n+\n+class Tracing {\n+  constructor(categories) {\n+    this[kHandle] = new CategorySet(categories);\n+    this[kCategories] = categories;\n+    this[kEnabled] = false;\n+  }\n+\n+  enable() {\n+    if (!this[kEnabled]) {\n+      this[kEnabled] = true;\n+      this[kHandle].enable();\n+      enabledTracingObjects.add(this);\n+      if (enabledTracingObjects.size > kMaxTracingCount) {\n+        process.emitWarning(\n+          'Possible trace_events memory leak detected. There are more than ' +\n+          `${kMaxTracingCount} enabled Tracing objects.`\n+        );\n+      }\n+    }\n+  }\n+\n+  disable() {\n+    if (this[kEnabled]) {\n+      this[kEnabled] = false;\n+      this[kHandle].disable();\n+      enabledTracingObjects.delete(this);\n+    }\n+  }\n+\n+  get enabled() {\n+    return this[kEnabled];\n+  }\n+\n+  get categories() {\n+    return this[kCategories].join(',');\n+  }\n+\n+  [customInspectSymbol](depth, opts) {\n+    const obj = {\n+      enabled: this.enabled,\n+      categories: this.categories\n+    };\n+    return `Tracing ${format(obj)}`;\n+  }\n+}\n+\n+function createTracing(options) {\n+  if (typeof options !== 'object' || options == null)\n+    throw new ERR_INVALID_ARG_TYPE('options', 'object', options);\n+\n+  if (!Array.isArray(options.categories)) {\n+    throw new ERR_INVALID_ARG_TYPE('options.categories', 'string[]',\n+                                   options.categories);\n+  }\n+\n+  if (options.categories.length <= 0)\n+    throw new ERR_TRACE_EVENTS_CATEGORY_REQUIRED();\n+\n+  return new Tracing(options.categories);\n+}\n+\n+module.exports = {\n+  createTracing,\n+  getEnabledCategories\n+};"
        },
        {
            "sha": "15475f689e3295a237e2f1ac8913bf415a5d2466",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -73,6 +73,7 @@\n       'lib/tls.js',\n       'lib/_tls_common.js',\n       'lib/_tls_wrap.js',\n+      'lib/trace_events.js',\n       'lib/tty.js',\n       'lib/url.js',\n       'lib/util.js',"
        },
        {
            "sha": "fa241f9706ec654368faf37732e0c190bbb6d58a",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -32,6 +32,7 @@\n #include \"v8.h\"\n #include \"node_perf_common.h\"\n #include \"node_context_data.h\"\n+#include \"tracing/agent.h\"\n \n #include <stddef.h>\n #include <stdint.h>\n@@ -325,6 +326,10 @@ inline v8::Isolate* Environment::isolate() const {\n   return isolate_;\n }\n \n+inline tracing::Agent* Environment::tracing_agent() const {\n+  return tracing_agent_;\n+}\n+\n inline Environment* Environment::from_immediate_check_handle(\n     uv_check_t* handle) {\n   return ContainerOf(&Environment::immediate_check_handle_, handle);"
        },
        {
            "sha": "1f47ea21af21b882faf4deaf5de737a3da897bca",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -3,6 +3,7 @@\n #include \"node_buffer.h\"\n #include \"node_platform.h\"\n #include \"node_file.h\"\n+#include \"tracing/agent.h\"\n \n #include <stdio.h>\n #include <algorithm>\n@@ -87,9 +88,11 @@ void InitThreadLocalOnce() {\n }\n \n Environment::Environment(IsolateData* isolate_data,\n-                         Local<Context> context)\n+                         Local<Context> context,\n+                         tracing::Agent* tracing_agent)\n     : isolate_(context->GetIsolate()),\n       isolate_data_(isolate_data),\n+      tracing_agent_(tracing_agent),\n       immediate_info_(context->GetIsolate()),\n       tick_info_(context->GetIsolate()),\n       timer_base_(uv_now(isolate_data->event_loop())),"
        },
        {
            "sha": "af4470ad8632fe0853b2e3693fd211b2bc630af1",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -36,6 +36,7 @@\n #include \"v8.h\"\n #include \"node.h\"\n #include \"node_http2_state.h\"\n+#include \"tracing/agent.h\"\n \n #include <list>\n #include <stdint.h>\n@@ -553,7 +554,9 @@ class Environment {\n   static uv_key_t thread_local_env;\n   static inline Environment* GetThreadLocalEnv();\n \n-  Environment(IsolateData* isolate_data, v8::Local<v8::Context> context);\n+  Environment(IsolateData* isolate_data,\n+              v8::Local<v8::Context> context,\n+              tracing::Agent* tracing_agent);\n   ~Environment();\n \n   void Start(int argc,\n@@ -585,6 +588,7 @@ class Environment {\n   void StopProfilerIdleNotifier();\n \n   inline v8::Isolate* isolate() const;\n+  inline tracing::Agent* tracing_agent() const;\n   inline uv_loop_t* event_loop() const;\n   inline uint32_t watched_providers() const;\n \n@@ -780,6 +784,7 @@ class Environment {\n \n   v8::Isolate* const isolate_;\n   IsolateData* const isolate_data_;\n+  tracing::Agent* const tracing_agent_;\n   uv_check_t immediate_check_handle_;\n   uv_idle_t immediate_idle_handle_;\n   uv_prepare_t idle_prepare_handle_;"
        },
        {
            "sha": "099fba35a872d5113f5e398cbb20da31a74e9916",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 33,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -191,7 +191,6 @@ static node_module* modlist_builtin;\n static node_module* modlist_internal;\n static node_module* modlist_linked;\n static node_module* modlist_addon;\n-static bool trace_enabled = false;\n static std::string trace_enabled_categories;  // NOLINT(runtime/string)\n static std::string trace_file_pattern =  // NOLINT(runtime/string)\n   \"node_trace.${rotation}.log\";\n@@ -277,20 +276,12 @@ DebugOptions debug_options;\n static struct {\n #if NODE_USE_V8_PLATFORM\n   void Initialize(int thread_pool_size) {\n-    if (trace_enabled) {\n-      tracing_agent_.reset(new tracing::Agent(trace_file_pattern));\n-      platform_ = new NodePlatform(thread_pool_size,\n+    tracing_agent_.reset(new tracing::Agent(trace_file_pattern));\n+    platform_ = new NodePlatform(thread_pool_size,\n         tracing_agent_->GetTracingController());\n-      V8::InitializePlatform(platform_);\n-      tracing::TraceEventHelper::SetTracingController(\n+    V8::InitializePlatform(platform_);\n+    tracing::TraceEventHelper::SetTracingController(\n         tracing_agent_->GetTracingController());\n-    } else {\n-      tracing_agent_.reset(nullptr);\n-      platform_ = new NodePlatform(thread_pool_size, nullptr);\n-      V8::InitializePlatform(platform_);\n-      tracing::TraceEventHelper::SetTracingController(\n-        new v8::TracingController());\n-    }\n   }\n \n   void Dispose() {\n@@ -323,13 +314,17 @@ static struct {\n #endif  // HAVE_INSPECTOR\n \n   void StartTracingAgent() {\n-    tracing_agent_->Start(trace_enabled_categories);\n+    tracing_agent_->Enable(trace_enabled_categories);\n   }\n \n   void StopTracingAgent() {\n     tracing_agent_->Stop();\n   }\n \n+  tracing::Agent* GetTracingAgent() const {\n+    return tracing_agent_.get();\n+  }\n+\n   NodePlatform* Platform() {\n     return platform_;\n   }\n@@ -348,11 +343,15 @@ static struct {\n   }\n \n   void StartTracingAgent() {\n-    fprintf(stderr, \"Node compiled with NODE_USE_V8_PLATFORM=0, \"\n-                    \"so event tracing is not available.\\n\");\n+    if (!trace_enabled_categories.empty()) {\n+      fprintf(stderr, \"Node compiled with NODE_USE_V8_PLATFORM=0, \"\n+                      \"so event tracing is not available.\\n\");\n+    }\n   }\n   void StopTracingAgent() {}\n \n+  tracing::Agent* GetTracingAgent() const { return nullptr; }\n+\n   NodePlatform* Platform() {\n     return nullptr;\n   }\n@@ -1990,9 +1989,7 @@ static void WaitForInspectorDisconnect(Environment* env) {\n \n static void Exit(const FunctionCallbackInfo<Value>& args) {\n   WaitForInspectorDisconnect(Environment::GetCurrent(args));\n-  if (trace_enabled) {\n-    v8_platform.StopTracingAgent();\n-  }\n+  v8_platform.StopTracingAgent();\n   exit(args[0]->Int32Value());\n }\n \n@@ -3287,9 +3284,7 @@ void SetupProcessObject(Environment* env,\n \n void SignalExit(int signo) {\n   uv_tty_reset_mode();\n-  if (trace_enabled) {\n-    v8_platform.StopTracingAgent();\n-  }\n+  v8_platform.StopTracingAgent();\n #ifdef __FreeBSD__\n   // FreeBSD has a nasty bug, see RegisterSignalHandler for details\n   struct sigaction sa;\n@@ -3789,7 +3784,8 @@ static void ParseArgs(int* argc,\n     } else if (strcmp(arg, \"--no-force-async-hooks-checks\") == 0) {\n       no_force_async_hooks_checks = true;\n     } else if (strcmp(arg, \"--trace-events-enabled\") == 0) {\n-      trace_enabled = true;\n+      if (trace_enabled_categories.empty())\n+        trace_enabled_categories = \"v8,node,node.async_hooks\";\n     } else if (strcmp(arg, \"--trace-event-categories\") == 0) {\n       const char* categories = argv[index + 1];\n       if (categories == nullptr) {\n@@ -4422,7 +4418,8 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   Isolate* isolate = context->GetIsolate();\n   HandleScope handle_scope(isolate);\n   Context::Scope context_scope(context);\n-  auto env = new Environment(isolate_data, context);\n+  auto env = new Environment(isolate_data, context,\n+                             v8_platform.GetTracingAgent());\n   env->Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n   return env;\n }\n@@ -4471,7 +4468,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   HandleScope handle_scope(isolate);\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n-  Environment env(isolate_data, context);\n+  Environment env(isolate_data, context, v8_platform.GetTracingAgent());\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n   const char* path = argc > 1 ? argv[1] : nullptr;\n@@ -4628,19 +4625,13 @@ int Start(int argc, char** argv) {\n \n   v8_platform.Initialize(v8_thread_pool_size);\n   // Enable tracing when argv has --trace-events-enabled.\n-  if (trace_enabled) {\n-    fprintf(stderr, \"Warning: Trace event is an experimental feature \"\n-            \"and could change at any time.\\n\");\n-    v8_platform.StartTracingAgent();\n-  }\n+  v8_platform.StartTracingAgent();\n   V8::Initialize();\n   performance::performance_v8_start = PERFORMANCE_NOW();\n   v8_initialized = true;\n   const int exit_code =\n       Start(uv_default_loop(), argc, argv, exec_argc, exec_argv);\n-  if (trace_enabled) {\n-    v8_platform.StopTracingAgent();\n-  }\n+  v8_platform.StopTracingAgent();\n   v8_initialized = false;\n   V8::Dispose();\n "
        },
        {
            "sha": "055a9b0ae468878c1241760723eea72a075a9790",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -56,6 +56,10 @@ static void Initialize(Local<Object> target,\n   READONLY_BOOLEAN_PROPERTY(\"hasSmallICU\");\n #endif  // NODE_HAVE_SMALL_ICU\n \n+#if NODE_USE_V8_PLATFORM\n+  READONLY_BOOLEAN_PROPERTY(\"hasTracing\");\n+#endif\n+\n   target->DefineOwnProperty(\n       context,\n       FIXED_ONE_BYTE_STRING(isolate, \"icuDataDir\"),"
        },
        {
            "sha": "1e02048d1f0843d43949157bc19a87045808f227",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -1,15 +1,98 @@\n+#include \"node.h\"\n #include \"node_internals.h\"\n #include \"tracing/agent.h\"\n+#include \"env.h\"\n+#include \"base_object-inl.h\"\n+\n+#include <set>\n+#include <string>\n \n namespace node {\n \n+using v8::Array;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n+using v8::FunctionTemplate;\n using v8::Int32;\n using v8::Local;\n using v8::Object;\n+using v8::String;\n using v8::Value;\n \n+class NodeCategorySet : public BaseObject {\n+ public:\n+  ~NodeCategorySet() override {\n+    // Verify that the thing was properly disabled before gc\n+    CHECK_NE(enabled_, true);\n+  }\n+\n+  static void New(const FunctionCallbackInfo<Value>& args);\n+  static void Enable(const FunctionCallbackInfo<Value>& args);\n+  static void Disable(const FunctionCallbackInfo<Value>& args);\n+\n+  const std::set<std::string>& GetCategories() { return categories_; }\n+\n+ private:\n+  NodeCategorySet(Environment* env,\n+                  Local<Object> wrap,\n+                  std::set<std::string> categories) :\n+        BaseObject(env, wrap), categories_(categories) {\n+    MakeWeak<NodeCategorySet>(this);\n+  }\n+\n+  bool enabled_ = false;\n+  const std::set<std::string> categories_;\n+};\n+\n+void NodeCategorySet::New(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  std::set<std::string> categories;\n+  CHECK(args[0]->IsArray());\n+  Local<Array> cats = args[0].As<Array>();\n+  for (size_t n = 0; n < cats->Length(); n++) {\n+    Local<Value> category = cats->Get(env->context(), n).ToLocalChecked();\n+    Utf8Value val(env->isolate(), category);\n+    categories.emplace(*val);\n+  }\n+  CHECK_NE(env->tracing_agent(), nullptr);\n+  new NodeCategorySet(env, args.This(), categories);\n+}\n+\n+void NodeCategorySet::Enable(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  NodeCategorySet* category_set;\n+  ASSIGN_OR_RETURN_UNWRAP(&category_set, args.Holder());\n+  CHECK_NE(category_set, nullptr);\n+  auto categories = category_set->GetCategories();\n+  if (!category_set->enabled_ && !categories.empty()) {\n+    env->tracing_agent()->Enable(categories);\n+    category_set->enabled_ = true;\n+  }\n+}\n+\n+void NodeCategorySet::Disable(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  NodeCategorySet* category_set;\n+  ASSIGN_OR_RETURN_UNWRAP(&category_set, args.Holder());\n+  CHECK_NE(category_set, nullptr);\n+  auto categories = category_set->GetCategories();\n+  if (category_set->enabled_ && !categories.empty()) {\n+    env->tracing_agent()->Disable(categories);\n+    category_set->enabled_ = false;\n+  }\n+}\n+\n+void GetEnabledCategories(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  std::string categories = env->tracing_agent()->GetEnabledCategories();\n+  if (!categories.empty()) {\n+    args.GetReturnValue().Set(\n+      String::NewFromUtf8(env->isolate(),\n+                          categories.c_str(),\n+                          v8::NewStringType::kNormal).ToLocalChecked());\n+  }\n+}\n+\n // The tracing APIs require category groups to be pointers to long-lived\n // strings. Those strings are stored here.\n static std::unordered_set<std::string> categoryGroups;\n@@ -140,6 +223,16 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"emit\", Emit);\n   env->SetMethod(target, \"categoryGroupEnabled\", CategoryGroupEnabled);\n+  env->SetMethod(target, \"getEnabledCategories\", GetEnabledCategories);\n+\n+  Local<FunctionTemplate> category_set =\n+      env->NewFunctionTemplate(NodeCategorySet::New);\n+  category_set->InstanceTemplate()->SetInternalFieldCount(1);\n+  env->SetProtoMethod(category_set, \"enable\", NodeCategorySet::Enable);\n+  env->SetProtoMethod(category_set, \"disable\", NodeCategorySet::Disable);\n+\n+  target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"CategorySet\"),\n+              category_set->GetFunction());\n }\n \n }  // namespace node"
        },
        {
            "sha": "cd4c3c0df9398ee92fe806b1708f692c4ea0043f",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 83,
            "deletions": 30,
            "changes": 113,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -5,55 +5,40 @@\n #include \"tracing/node_trace_buffer.h\"\n #include \"tracing/node_trace_writer.h\"\n \n-#include \"env-inl.h\"\n-\n namespace node {\n namespace tracing {\n \n using v8::platform::tracing::TraceConfig;\n using std::string;\n \n-Agent::Agent(const std::string& log_file_pattern) {\n-  int err = uv_loop_init(&tracing_loop_);\n-  CHECK_EQ(err, 0);\n+Agent::Agent(const std::string& log_file_pattern)\n+    : log_file_pattern_(log_file_pattern) {\n+  tracing_controller_ = new TracingController();\n+  tracing_controller_->Initialize(nullptr);\n+}\n+\n+void Agent::Start() {\n+  if (started_)\n+    return;\n \n-  NodeTraceWriter* trace_writer = new NodeTraceWriter(\n-      log_file_pattern, &tracing_loop_);\n+  CHECK_EQ(uv_loop_init(&tracing_loop_), 0);\n+\n+  NodeTraceWriter* trace_writer =\n+      new NodeTraceWriter(log_file_pattern_, &tracing_loop_);\n   TraceBuffer* trace_buffer = new NodeTraceBuffer(\n       NodeTraceBuffer::kBufferChunks, trace_writer, &tracing_loop_);\n-  tracing_controller_ = new TracingController();\n   tracing_controller_->Initialize(trace_buffer);\n-}\n-\n-void Agent::Start(const string& enabled_categories) {\n-  TraceConfig* trace_config = new TraceConfig();\n-  if (!enabled_categories.empty()) {\n-    std::stringstream category_list(enabled_categories);\n-    while (category_list.good()) {\n-      std::string category;\n-      getline(category_list, category, ',');\n-      trace_config->AddIncludedCategory(category.c_str());\n-    }\n-  } else {\n-    trace_config->AddIncludedCategory(\"v8\");\n-    trace_config->AddIncludedCategory(\"node\");\n-    trace_config->AddIncludedCategory(\"node.async_hooks\");\n-  }\n \n   // This thread should be created *after* async handles are created\n   // (within NodeTraceWriter and NodeTraceBuffer constructors).\n   // Otherwise the thread could shut down prematurely.\n-  int err = uv_thread_create(&thread_, ThreadCb, this);\n-  CHECK_EQ(err, 0);\n-\n-  tracing_controller_->StartTracing(trace_config);\n+  CHECK_EQ(0, uv_thread_create(&thread_, ThreadCb, this));\n   started_ = true;\n }\n \n void Agent::Stop() {\n-  if (!started_) {\n+  if (!started_)\n     return;\n-  }\n   // Perform final Flush on TraceBuffer. We don't want the tracing controller\n   // to flush the buffer again on destruction of the V8::Platform.\n   tracing_controller_->StopTracing();\n@@ -70,5 +55,73 @@ void Agent::ThreadCb(void* arg) {\n   uv_run(&agent->tracing_loop_, UV_RUN_DEFAULT);\n }\n \n+void Agent::Enable(const std::string& categories) {\n+  if (!categories.empty()) {\n+    std::stringstream category_list(categories);\n+    while (category_list.good()) {\n+      std::string category;\n+      getline(category_list, category, ',');\n+      categories_.insert(category.c_str());\n+    }\n+    RestartTracing();\n+  }\n+}\n+\n+void Agent::Enable(const std::set<std::string>& categories) {\n+  if (!categories.empty()) {\n+    categories_.insert(categories.begin(), categories.end());\n+    RestartTracing();\n+  }\n+}\n+\n+void Agent::Disable(const std::set<std::string>& categories) {\n+  if (!categories.empty()) {\n+    for (auto category : categories) {\n+      auto pos = categories_.lower_bound(category);\n+      if (pos != categories_.end())\n+        categories_.erase(pos);\n+    }\n+    RestartTracing();\n+  }\n+}\n+\n+void Agent::RestartTracing() {\n+  static bool warned;\n+  if (!warned) {\n+    warned = true;\n+    fprintf(stderr, \"Warning: Trace event is an experimental feature \"\n+            \"and could change at any time.\\n\");\n+  }\n+  Start();  // Start the agent if it hasn't already been started\n+  tracing_controller_->StopTracing();\n+  auto config = CreateTraceConfig();\n+  if (config != nullptr)\n+    tracing_controller_->StartTracing(config);\n+}\n+\n+TraceConfig* Agent::CreateTraceConfig() {\n+  if (categories_.empty())\n+    return nullptr;\n+  TraceConfig* trace_config = new TraceConfig();\n+  for (auto category = categories_.begin();\n+       category != categories_.end();\n+       category = categories_.upper_bound(*category)) {\n+    trace_config->AddIncludedCategory(category->c_str());\n+  }\n+  return trace_config;\n+}\n+\n+std::string Agent::GetEnabledCategories() {\n+  std::string categories;\n+  for (auto category = categories_.begin();\n+       category != categories_.end();\n+       category = categories_.upper_bound(*category)) {\n+    if (!categories.empty())\n+      categories += ',';\n+    categories += *category;\n+  }\n+  return categories;\n+}\n+\n }  // namespace tracing\n }  // namespace node"
        },
        {
            "sha": "ca5fd35417fd0f08c2aa2ce2ee661a12da9eef5d",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -5,9 +5,14 @@\n #include \"uv.h\"\n #include \"v8.h\"\n \n+#include <set>\n+#include <string>\n+\n namespace node {\n namespace tracing {\n \n+using v8::platform::tracing::TraceConfig;\n+\n class TracingController : public v8::platform::tracing::TracingController {\n  public:\n   TracingController() : v8::platform::tracing::TracingController() {}\n@@ -20,17 +25,29 @@ class TracingController : public v8::platform::tracing::TracingController {\n class Agent {\n  public:\n   explicit Agent(const std::string& log_file_pattern);\n-  void Start(const std::string& enabled_categories);\n   void Stop();\n \n   TracingController* GetTracingController() { return tracing_controller_; }\n \n+  void Enable(const std::string& categories);\n+  void Enable(const std::set<std::string>& categories);\n+  void Disable(const std::set<std::string>& categories);\n+  std::string GetEnabledCategories();\n+\n  private:\n   static void ThreadCb(void* arg);\n \n+  void Start();\n+  void RestartTracing();\n+\n+  TraceConfig* CreateTraceConfig();\n+\n+  const std::string& log_file_pattern_;\n   uv_thread_t thread_;\n   uv_loop_t tracing_loop_;\n   bool started_ = false;\n+\n+  std::multiset<std::string> categories_;\n   TracingController* tracing_controller_ = nullptr;\n };\n "
        },
        {
            "sha": "7df3907f0e7174f64213a8559c5473694f93961b",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -30,6 +30,7 @@ const { exec, execSync, spawn, spawnSync } = require('child_process');\n const stream = require('stream');\n const util = require('util');\n const Timer = process.binding('timer_wrap').Timer;\n+const { hasTracing } = process.binding('config');\n const { fixturesDir } = require('./fixtures');\n const tmpdir = require('./tmpdir');\n \n@@ -201,6 +202,12 @@ Object.defineProperty(exports, 'hasCrypto', {\n   }\n });\n \n+Object.defineProperty(exports, 'hasTracing', {\n+  get: function() {\n+    return Boolean(hasTracing);\n+  }\n+});\n+\n Object.defineProperty(exports, 'hasFipsCrypto', {\n   get: function() {\n     return exports.hasCrypto && require('crypto').fips;"
        },
        {
            "sha": "f6e80af032a2cd85d77ea2dc2b95b79674ad2252",
            "filename": "test/parallel/test-module-cjs-helpers.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-module-cjs-helpers.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-module-cjs-helpers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-cjs-helpers.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -7,5 +7,5 @@ const { builtinLibs } = require('internal/modules/cjs/helpers');\n \n const hasInspector = process.config.variables.v8_enable_inspector === 1;\n \n-const expectedLibs = hasInspector ? 32 : 31;\n+const expectedLibs = hasInspector ? 33 : 32;\n assert.strictEqual(builtinLibs.length, expectedLibs);"
        },
        {
            "sha": "b4f7112d07ac7784048eae0d0793ce39166ead20",
            "filename": "test/parallel/test-trace-events-api.js",
            "status": "added",
            "additions": 164,
            "deletions": 0,
            "changes": 164,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-api.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-api.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-api.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -0,0 +1,164 @@\n+// Flags: --expose-gc --no-warnings\n+'use strict';\n+\n+const common = require('../common');\n+\n+if (!common.hasTracing)\n+  common.skip('missing trace events');\n+\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+const {\n+  createTracing,\n+  getEnabledCategories\n+} = require('trace_events');\n+\n+const isChild = process.argv[2] === 'child';\n+const enabledCategories = isChild ? 'foo' : undefined;\n+\n+assert.strictEqual(getEnabledCategories(), enabledCategories);\n+[1, 'foo', true, false, null, undefined].forEach((i) => {\n+  common.expectsError(() => createTracing(i), {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    type: TypeError\n+  });\n+  common.expectsError(() => createTracing({ categories: i }), {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    type: TypeError\n+  });\n+});\n+\n+common.expectsError(\n+  () => createTracing({ categories: [] }),\n+  {\n+    code: 'ERR_TRACE_EVENTS_CATEGORY_REQUIRED',\n+    type: TypeError\n+  }\n+);\n+\n+const tracing = createTracing({ categories: [ 'node.perf' ] });\n+\n+assert.strictEqual(tracing.categories, 'node.perf');\n+assert.strictEqual(tracing.enabled, false);\n+\n+assert.strictEqual(getEnabledCategories(), enabledCategories);\n+tracing.enable();\n+tracing.enable();  // purposefully enable twice to test calling twice\n+assert.strictEqual(tracing.enabled, true);\n+\n+assert.strictEqual(getEnabledCategories(),\n+                   isChild ? 'foo,node.perf' : 'node.perf');\n+\n+tracing.disable();\n+assert.strictEqual(tracing.enabled, false);\n+\n+const tracing2 = createTracing({ categories: [ 'foo' ] });\n+tracing2.enable();\n+assert.strictEqual(getEnabledCategories(), 'foo');\n+\n+tracing2.disable();\n+tracing2.disable();  // purposefully disable twice to test calling twice\n+assert.strictEqual(getEnabledCategories(), enabledCategories);\n+\n+if (isChild) {\n+  tracing.enable();\n+  const { performance } = require('perf_hooks');\n+\n+  // Will emit mark and measure trace events\n+  performance.mark('A');\n+  setTimeout(() => {\n+    performance.mark('B');\n+    performance.measure('A to B', 'A', 'B');\n+  }, 1);\n+\n+  // Intentional non-op, part of the test\n+  function f() {}\n+  const ff = performance.timerify(f);\n+  ff();  // Will emit a timerify trace event\n+} else {\n+\n+  // Test that enabled tracing references do not get garbage collected\n+  // until after they are disabled.\n+  {\n+    {\n+      let tracing3 = createTracing({ categories: [ 'abc' ] });\n+      tracing3.enable();\n+      assert.strictEqual(getEnabledCategories(), 'abc');\n+      tracing3 = undefined;\n+    }\n+    global.gc();\n+    assert.strictEqual(getEnabledCategories(), 'abc');\n+    // Not able to disable the thing after this point, however.\n+  }\n+\n+  {\n+    common.expectWarning(\n+      'Warning',\n+      'Possible trace_events memory leak detected. There are more than ' +\n+      '10 enabled Tracing objects.',\n+      common.noWarnCode);\n+    for (let n = 0; n < 10; n++) {\n+      const tracing = createTracing({ categories: [ `a${n}` ] });\n+      tracing.enable();\n+    }\n+  }\n+\n+  tmpdir.refresh();\n+  process.chdir(tmpdir.path);\n+\n+  const expectedMarks = ['A', 'B'];\n+  const expectedBegins = [\n+    { cat: 'node,node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node,node.perf,node.perf.usertiming', name: 'A to B' }\n+  ];\n+  const expectedEnds = [\n+    { cat: 'node,node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node,node.perf,node.perf.usertiming', name: 'A to B' }\n+  ];\n+\n+  const proc = cp.fork(__filename,\n+                       ['child'],\n+                       { execArgv: [ '--expose-gc',\n+                                     '--trace-event-categories',\n+                                     'foo' ] });\n+\n+  proc.once('exit', common.mustCall(() => {\n+    const file = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+    assert(common.fileExists(file));\n+    fs.readFile(file, common.mustCall((err, data) => {\n+      const traces = JSON.parse(data.toString()).traceEvents;\n+      assert.strictEqual(traces.length,\n+                         expectedMarks.length +\n+                         expectedBegins.length +\n+                         expectedEnds.length);\n+\n+      traces.forEach((trace) => {\n+        assert.strictEqual(trace.pid, proc.pid);\n+        switch (trace.ph) {\n+          case 'R':\n+            assert.strictEqual(trace.cat,\n+                               'node,node.perf,node.perf.usertiming');\n+            assert.strictEqual(trace.name,\n+                               expectedMarks.shift());\n+            break;\n+          case 'b':\n+            const expectedBegin = expectedBegins.shift();\n+            assert.strictEqual(trace.cat, expectedBegin.cat);\n+            assert.strictEqual(trace.name, expectedBegin.name);\n+            break;\n+          case 'e':\n+            const expectedEnd = expectedEnds.shift();\n+            assert.strictEqual(trace.cat, expectedEnd.cat);\n+            assert.strictEqual(trace.name, expectedEnd.name);\n+            break;\n+          default:\n+            assert.fail('Unexpected trace event phase');\n+        }\n+      });\n+    }));\n+  }));\n+}"
        },
        {
            "sha": "d3c5a0af5b8e50b33d23a810dec2fa7aab0051cf",
            "filename": "test/parallel/test-trace-events-async-hooks.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-async-hooks.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -13,8 +13,7 @@ tmpdir.refresh();\n process.chdir(tmpdir.path);\n \n const proc = cp.spawn(process.execPath,\n-                      [ '--trace-events-enabled',\n-                        '--trace-event-categories', 'node.async_hooks',\n+                      [ '--trace-event-categories', 'node.async_hooks',\n                         '-e', CODE ]);\n \n proc.once('exit', common.mustCall(() => {"
        },
        {
            "sha": "35fbfc3692a5d3c65d3078a7f3d7f5a339529657",
            "filename": "test/parallel/test-trace-events-binding.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-binding.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-binding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-binding.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -25,8 +25,7 @@ tmpdir.refresh();\n process.chdir(tmpdir.path);\n \n const proc = cp.spawn(process.execPath,\n-                      [ '--trace-events-enabled',\n-                        '--trace-event-categories', 'custom',\n+                      [ '--trace-event-categories', 'custom',\n                         '-e', CODE ]);\n \n proc.once('exit', common.mustCall(() => {"
        },
        {
            "sha": "a0bfcf123e72330508bc7f50cdbc2b2a35014c39",
            "filename": "test/parallel/test-trace-events-bootstrap.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-bootstrap.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -32,7 +32,6 @@ if (process.argv[2] === 'child') {\n   const proc = cp.fork(__filename,\n                        [ 'child' ], {\n                          execArgv: [\n-                           '--trace-events-enabled',\n                            '--trace-event-categories',\n                            'node.bootstrap'\n                          ]"
        },
        {
            "sha": "a98cb350371da941dbf2345632fb585afc84fca2",
            "filename": "test/parallel/test-trace-events-category-used.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-category-used.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -13,7 +13,7 @@ process.chdir(tmpdir.path);\n \n const procEnabled = cp.spawn(\n   process.execPath,\n-  [ '--trace-events-enabled', '--trace-event-categories', 'custom', '-e', CODE ]\n+  [ '--trace-event-categories', 'custom', '-e', CODE ]\n );\n let procEnabledOutput = '';\n \n@@ -25,7 +25,7 @@ procEnabled.once('exit', common.mustCall(() => {\n \n const procDisabled = cp.spawn(\n   process.execPath,\n-  [ '--trace-events-enabled', '--trace-event-categories', 'other', '-e', CODE ]\n+  [ '--trace-event-categories', 'other', '-e', CODE ]\n );\n let procDisabledOutput = '';\n "
        },
        {
            "sha": "6b60ce999ac118001a5b24358a60b2f59b795880",
            "filename": "test/parallel/test-trace-events-none.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-none.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-none.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-none.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -13,7 +13,7 @@ process.chdir(tmpdir.path);\n \n const proc_no_categories = cp.spawn(\n   process.execPath,\n-  [ '--trace-events-enabled', '--trace-event-categories', '\"\"', '-e', CODE ]\n+  [ '--trace-event-categories', '\"\"', '-e', CODE ]\n );\n \n proc_no_categories.once('exit', common.mustCall(() => {"
        },
        {
            "sha": "5758082b6efa43b5736c5c0249d471fbd7d5b589",
            "filename": "test/parallel/test-trace-events-perf.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/test%2Fparallel%2Ftest-trace-events-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-perf.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -39,7 +39,6 @@ if (process.argv[2] === 'child') {\n                          'child'\n                        ], {\n                          execArgv: [\n-                           '--trace-events-enabled',\n                            '--trace-event-categories',\n                            'node.perf'\n                          ]"
        },
        {
            "sha": "6314a4889f06e60175d67727dfef244363554c77",
            "filename": "tools/doc/type-parser.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5c27e44488aa1c00248297204ff3484c24ff3ae7/tools%2Fdoc%2Ftype-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/5c27e44488aa1c00248297204ff3484c24ff3ae7/tools%2Fdoc%2Ftype-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Ftype-parser.js?ref=5c27e44488aa1c00248297204ff3484c24ff3ae7",
            "patch": "@@ -114,6 +114,8 @@ const customTypesMap = {\n   'tls.Server': 'tls.html#tls_class_tls_server',\n   'tls.TLSSocket': 'tls.html#tls_class_tls_tlssocket',\n \n+  'Tracing': 'tracing.html#tracing_tracing_object',\n+\n   'URL': 'url.html#url_the_whatwg_url_api',\n   'URLSearchParams': 'url.html#url_class_urlsearchparams'\n };"
        }
    ],
    "stats": {
        "total": 764,
        "additions": 677,
        "deletions": 87
    }
}