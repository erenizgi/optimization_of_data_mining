{
    "author": "addaleax",
    "message": "process: provide dummy stdio for non-console Windows apps\n\nThe only known condition where we could not provide appropriate\nstdio streams so far were non-console Windows applications.\nSince this issue has come up a few times in our issue tracker now,\nswitch to providing dummy streams for these cases instead.\n\nIf there are other valid cases in which `uv_guess_handle` fails,\nand where there is a more sensible way to provide stdio,\nwe’ll probably still find out because the streams don’t work\nproperly either way.\n\nRefs: https://github.com/nodejs/help/issues/1251\n\nPR-URL: https://github.com/nodejs/node/pull/20640\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4",
    "files": [
        {
            "sha": "a766999e43d0fa50902f1fd21953b4cf9cae96a1",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 22,
            "deletions": 14,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4",
            "patch": "@@ -1795,20 +1795,6 @@ An attempt was made to load a module with an unknown or unsupported format.\n An invalid or unknown process signal was passed to an API expecting a valid\n signal (such as [`subprocess.kill()`][]).\n \n-<a id=\"ERR_UNKNOWN_STDIN_TYPE\"></a>\n-### ERR_UNKNOWN_STDIN_TYPE\n-\n-An attempt was made to launch a Node.js process with an unknown `stdin` file\n-type. This error is usually an indication of a bug within Node.js itself,\n-although it is possible for user code to trigger it.\n-\n-<a id=\"ERR_UNKNOWN_STREAM_TYPE\"></a>\n-### ERR_UNKNOWN_STREAM_TYPE\n-\n-An attempt was made to launch a Node.js process with an unknown `stdout` or\n-`stderr` file type. This error is usually an indication of a bug within Node.js\n-itself, although it is possible for user code to trigger it.\n-\n <a id=\"ERR_V8BREAKITERATOR\"></a>\n ### ERR_V8BREAKITERATOR\n \n@@ -2065,6 +2051,28 @@ kind of internal Node.js error that should not typically be triggered by user\n code. Instances of this error point to an internal bug within the Node.js\n binary itself.\n \n+<a id=\"ERR_UNKNOWN_STDIN_TYPE\"></a>\n+### ERR_UNKNOWN_STDIN_TYPE\n+<!-- YAML\n+added: v8.0.0\n+removed: REPLACEME\n+-->\n+\n+An attempt was made to launch a Node.js process with an unknown `stdin` file\n+type. This error is usually an indication of a bug within Node.js itself,\n+although it is possible for user code to trigger it.\n+\n+<a id=\"ERR_UNKNOWN_STREAM_TYPE\"></a>\n+### ERR_UNKNOWN_STREAM_TYPE\n+<!-- YAML\n+added: v8.0.0\n+removed: REPLACEME\n+-->\n+\n+An attempt was made to launch a Node.js process with an unknown `stdout` or\n+`stderr` file type. This error is usually an indication of a bug within Node.js\n+itself, although it is possible for user code to trigger it.\n+\n <a id=\"ERR_VALUE_OUT_OF_RANGE\"></a>\n ### ERR_VALUE_OUT_OF_RANGE\n <!-- YAML"
        },
        {
            "sha": "f497a0d6e4a0b82954336baeb058aa12f605a318",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4",
            "patch": "@@ -905,10 +905,7 @@ E('ERR_UNKNOWN_ENCODING', 'Unknown encoding: %s', TypeError);\n E('ERR_UNKNOWN_FILE_EXTENSION', 'Unknown file extension: %s', Error);\n E('ERR_UNKNOWN_MODULE_FORMAT', 'Unknown module format: %s', RangeError);\n E('ERR_UNKNOWN_SIGNAL', 'Unknown signal: %s', TypeError);\n-E('ERR_UNKNOWN_STDIN_TYPE', 'Unknown stdin file type', Error);\n \n-// This should probably be a `TypeError`.\n-E('ERR_UNKNOWN_STREAM_TYPE', 'Unknown stream file type', Error);\n E('ERR_V8BREAKITERATOR',\n   'Full ICU data not installed. See https://github.com/nodejs/node/wiki/Intl',\n   Error);"
        },
        {
            "sha": "224af28b0f52cb0c0dcfe4109d324872663d6c53",
            "filename": "lib/internal/process/stdio.js",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/lib%2Finternal%2Fprocess%2Fstdio.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/lib%2Finternal%2Fprocess%2Fstdio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fstdio.js?ref=ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4",
            "patch": "@@ -1,10 +1,5 @@\n 'use strict';\n \n-const {\n-  ERR_UNKNOWN_STDIN_TYPE,\n-  ERR_UNKNOWN_STREAM_TYPE\n-} = require('internal/errors').codes;\n-\n exports.setupProcessStdio = setupProcessStdio;\n exports.getMainThreadStdio = getMainThreadStdio;\n \n@@ -87,8 +82,11 @@ function getMainThreadStdio() {\n         break;\n \n       default:\n-        // Probably an error on in uv_guess_handle()\n-        throw new ERR_UNKNOWN_STDIN_TYPE();\n+        // Provide a dummy contentless input for e.g. non-console\n+        // Windows applications.\n+        const { Readable } = require('stream');\n+        stdin = new Readable({ read() {} });\n+        stdin.push(null);\n     }\n \n     // For supporting legacy API we put the FD here.\n@@ -123,6 +121,12 @@ function getMainThreadStdio() {\n     return stdin;\n   }\n \n+  exports.resetStdioForTesting = function() {\n+    stdin = undefined;\n+    stdout = undefined;\n+    stderr = undefined;\n+  };\n+\n   return {\n     getStdout,\n     getStderr,\n@@ -199,8 +203,14 @@ function createWritableStdioStream(fd) {\n       break;\n \n     default:\n-      // Probably an error on in uv_guess_handle()\n-      throw new ERR_UNKNOWN_STREAM_TYPE();\n+      // Provide a dummy black-hole output for e.g. non-console\n+      // Windows applications.\n+      const { Writable } = require('stream');\n+      stream = new Writable({\n+        write(buf, enc, cb) {\n+          cb();\n+        }\n+      });\n   }\n \n   // For supporting legacy API we put the FD here."
        },
        {
            "sha": "165c2c2c575ff55190830c781e61030f3e779b88",
            "filename": "test/parallel/test-dummy-stdio.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/test%2Fparallel%2Ftest-dummy-stdio.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4/test%2Fparallel%2Ftest-dummy-stdio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-dummy-stdio.js?ref=ab6c09b177eca67755a4c1f1d4d35fab9d2bb5d4",
            "patch": "@@ -0,0 +1,27 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const child_process = require('child_process');\n+\n+if (common.isWindows)\n+  common.skip('fs.closeSync(n) does not close stdio on Windows');\n+\n+function runTest(fd, streamName, testOutputStream, expectedName) {\n+  const result = child_process.spawnSync(process.execPath, [\n+    '--expose-internals',\n+    '-e', `\n+    require('internal/process/stdio').resetStdioForTesting();\n+    fs.closeSync(${fd});\n+    const ctorName = process.${streamName}.constructor.name;\n+    process.${testOutputStream}.write(ctorName);\n+    `]);\n+  assert.strictEqual(result[testOutputStream].toString(), expectedName,\n+                     `stdout:\\n${result.stdout}\\nstderr:\\n${result.stderr}\\n` +\n+                     `while running test with fd = ${fd}`);\n+  if (testOutputStream !== 'stderr')\n+    assert.strictEqual(result.stderr.toString(), '');\n+}\n+\n+runTest(0, 'stdin', 'stdout', 'Readable');\n+runTest(1, 'stdout', 'stderr', 'Writable');\n+runTest(2, 'stderr', 'stdout', 'Writable');"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 68,
        "deletions": 26
    }
}