{
    "author": "joyeecheung",
    "message": "console: lazy load process.stderr and process.stdout\n\nThis patch:\n\n- Refactors the Console constructor: moves the property binding code\n  into and the writable streams binding code into two methods defined\n  on the Console.prototype with symbols.\n- Refactors the global console creation: we only need to share the\n  property binding code from the Console constructor. To bind the\n  streams we can lazy load `process.stdio` and `process.stderr`\n  so that we don't create these streams when they are not used.\n  This significantly reduces the number of modules loaded during\n  bootstrap. Also, by calling the refactored-out method directly\n  we can skip the unnecessary typechecks when creating the global\n  console and there is no need to create a temporary Console\n  anymore.\n- Refactors the error handler creation and the `write` method:\n  use a `kUseStdout` symbol to tell the internals which stream\n  should be loaded from the console instance. Also put the\n  `write` method on the Console prototype so it just loads\n  other properties directly off the console instance which simplifies\n  the call sites.\n\nAlso leaves a few TODOs for further refactoring of the console\nbootstrap.\n\nPR-URL: https://github.com/nodejs/node/pull/24534\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "333783643e71aeef3940fae215e7cf52ef00d5f0",
    "files": [
        {
            "sha": "ebd098e9affdff9f6d8492ad37c004eae41f6a39",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 122,
            "deletions": 75,
            "changes": 197,
            "blob_url": "https://github.com/nodejs/node/blob/333783643e71aeef3940fae215e7cf52ef00d5f0/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/333783643e71aeef3940fae215e7cf52ef00d5f0/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=333783643e71aeef3940fae215e7cf52ef00d5f0",
            "patch": "@@ -65,7 +65,15 @@ const kFormatForStdout = Symbol('kFormatForStdout');\n const kGetInspectOptions = Symbol('kGetInspectOptions');\n const kColorMode = Symbol('kColorMode');\n const kIsConsole = Symbol('kIsConsole');\n-\n+const kWriteToConsole = Symbol('kWriteToConsole');\n+const kBindProperties = Symbol('kBindProperties');\n+const kBindStreamsEager = Symbol('kBindStreamsEager');\n+const kBindStreamsLazy = Symbol('kBindStreamsLazy');\n+const kUseStdout = Symbol('kUseStdout');\n+const kUseStderr = Symbol('kUseStderr');\n+\n+// This constructor is not used to construct the global console.\n+// It's exported for backwards compatibility.\n function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n   // We have to test new.target here to see if this function is called\n   // with new, because we need to define a custom instanceof to accommodate\n@@ -74,7 +82,6 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n     return new Console(...arguments);\n   }\n \n-  this[kIsConsole] = true;\n   if (!options || typeof options.write === 'function') {\n     options = {\n       stdout: options,\n@@ -97,37 +104,9 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n     throw new ERR_CONSOLE_WRITABLE_STREAM('stderr');\n   }\n \n-  const prop = {\n-    writable: true,\n-    enumerable: false,\n-    configurable: true\n-  };\n-  Object.defineProperty(this, '_stdout', { ...prop, value: stdout });\n-  Object.defineProperty(this, '_stderr', { ...prop, value: stderr });\n-  Object.defineProperty(this, '_ignoreErrors', {\n-    ...prop,\n-    value: Boolean(ignoreErrors),\n-  });\n-  Object.defineProperty(this, '_times', { ...prop, value: new Map() });\n-  Object.defineProperty(this, '_stdoutErrorHandler', {\n-    ...prop,\n-    value: createWriteErrorHandler(stdout),\n-  });\n-  Object.defineProperty(this, '_stderrErrorHandler', {\n-    ...prop,\n-    value: createWriteErrorHandler(stderr),\n-  });\n-\n   if (typeof colorMode !== 'boolean' && colorMode !== 'auto')\n     throw new ERR_INVALID_ARG_VALUE('colorMode', colorMode);\n \n-  // Corresponds to https://console.spec.whatwg.org/#count-map\n-  this[kCounts] = new Map();\n-  this[kColorMode] = colorMode;\n-\n-  Object.defineProperty(this, kGroupIndent, { writable: true });\n-  this[kGroupIndent] = '';\n-\n   // bind the prototype functions to this Console instance\n   var keys = Object.keys(Console.prototype);\n   for (var v = 0; v < keys.length; v++) {\n@@ -137,14 +116,92 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n     // from the prototype chain of the subclass.\n     this[k] = this[k].bind(this);\n   }\n+\n+  this[kBindStreamsEager](stdout, stderr);\n+  this[kBindProperties](ignoreErrors, colorMode);\n }\n \n+const consolePropAttributes = {\n+  writable: true,\n+  enumerable: false,\n+  configurable: true\n+};\n+\n+// Fixup global.console instanceof global.console.Console\n+Object.defineProperty(Console, Symbol.hasInstance, {\n+  value(instance) {\n+    return instance[kIsConsole];\n+  }\n+});\n+\n+// Eager version for the Console constructor\n+Console.prototype[kBindStreamsEager] = function(stdout, stderr) {\n+  Object.defineProperties(this, {\n+    '_stdout': { ...consolePropAttributes, value: stdout },\n+    '_stderr': { ...consolePropAttributes, value: stderr }\n+  });\n+};\n+\n+// Lazily load the stdout and stderr from an object so we don't\n+// create the stdio streams when they are not even accessed\n+Console.prototype[kBindStreamsLazy] = function(object) {\n+  let stdout;\n+  let stderr;\n+  Object.defineProperties(this, {\n+    '_stdout': {\n+      enumerable: false,\n+      configurable: true,\n+      get() {\n+        if (!stdout) stdout = object.stdout;\n+        return stdout;\n+      },\n+      set(value) { stdout = value; }\n+    },\n+    '_stderr': {\n+      enumerable: false,\n+      configurable: true,\n+      get() {\n+        if (!stderr) { stderr = object.stderr; }\n+        return stderr;\n+      },\n+      set(value) { stderr = value; }\n+    }\n+  });\n+};\n+\n+Console.prototype[kBindProperties] = function(ignoreErrors, colorMode) {\n+  Object.defineProperties(this, {\n+    '_stdoutErrorHandler': {\n+      ...consolePropAttributes,\n+      value: createWriteErrorHandler(this, kUseStdout)\n+    },\n+    '_stderrErrorHandler': {\n+      ...consolePropAttributes,\n+      value: createWriteErrorHandler(this, kUseStderr)\n+    },\n+    '_ignoreErrors': {\n+      ...consolePropAttributes,\n+      value: Boolean(ignoreErrors)\n+    },\n+    '_times': { ...consolePropAttributes, value: new Map() }\n+  });\n+\n+  // TODO(joyeecheung): use consolePropAttributes for these\n+  // Corresponds to https://console.spec.whatwg.org/#count-map\n+  this[kCounts] = new Map();\n+  this[kColorMode] = colorMode;\n+  this[kIsConsole] = true;\n+  this[kGroupIndent] = '';\n+};\n+\n // Make a function that can serve as the callback passed to `stream.write()`.\n-function createWriteErrorHandler(stream) {\n+function createWriteErrorHandler(instance, streamSymbol) {\n   return (err) => {\n     // This conditional evaluates to true if and only if there was an error\n     // that was not already emitted (which happens when the _write callback\n     // is invoked asynchronously).\n+    const stream = streamSymbol === kUseStdout ?\n+      instance._stdout : instance._stderr;\n     if (err !== null && !stream._writableState.errorEmitted) {\n       // If there was an error, it will be emitted on `stream` as\n       // an `error` event. Adding a `once` listener will keep that error\n@@ -158,7 +215,15 @@ function createWriteErrorHandler(stream) {\n   };\n }\n \n-function write(ignoreErrors, stream, string, errorhandler, groupIndent) {\n+Console.prototype[kWriteToConsole] = function(streamSymbol, string) {\n+  const ignoreErrors = this._ignoreErrors;\n+  const groupIndent = this[kGroupIndent];\n+\n+  const useStdout = streamSymbol === kUseStdout;\n+  const stream = useStdout ? this._stdout : this._stderr;\n+  const errorHandler = useStdout ?\n+    this._stdoutErrorHandler : this._stderrErrorHandler;\n+\n   if (groupIndent.length !== 0) {\n     if (string.indexOf('\\n') !== -1) {\n       string = string.replace(/\\n/g, `\\n${groupIndent}`);\n@@ -176,7 +241,7 @@ function write(ignoreErrors, stream, string, errorhandler, groupIndent) {\n     // Add and later remove a noop error handler to catch synchronous errors.\n     stream.once('error', noop);\n \n-    stream.write(string, errorhandler);\n+    stream.write(string, errorHandler);\n   } catch (e) {\n     // console is a debugging utility, so it swallowing errors is not desirable\n     // even in edge cases such as low stack space.\n@@ -186,7 +251,7 @@ function write(ignoreErrors, stream, string, errorhandler, groupIndent) {\n   } finally {\n     stream.removeListener('error', noop);\n   }\n-}\n+};\n \n const kColorInspectOptions = { colors: true };\n const kNoColorInspectOptions = {};\n@@ -212,34 +277,24 @@ Console.prototype[kFormatForStderr] = function(args) {\n };\n \n Console.prototype.log = function log(...args) {\n-  write(this._ignoreErrors,\n-        this._stdout,\n-        this[kFormatForStdout](args),\n-        this._stdoutErrorHandler,\n-        this[kGroupIndent]);\n+  this[kWriteToConsole](kUseStdout, this[kFormatForStdout](args));\n };\n+\n Console.prototype.debug = Console.prototype.log;\n Console.prototype.info = Console.prototype.log;\n Console.prototype.dirxml = Console.prototype.log;\n \n Console.prototype.warn = function warn(...args) {\n-  write(this._ignoreErrors,\n-        this._stderr,\n-        this[kFormatForStderr](args),\n-        this._stderrErrorHandler,\n-        this[kGroupIndent]);\n+  this[kWriteToConsole](kUseStderr, this[kFormatForStderr](args));\n };\n+\n Console.prototype.error = Console.prototype.warn;\n \n Console.prototype.dir = function dir(object, options) {\n   options = Object.assign({\n     customInspect: false\n   }, this[kGetInspectOptions](this._stdout), options);\n-  write(this._ignoreErrors,\n-        this._stdout,\n-        util.inspect(object, options),\n-        this._stdoutErrorHandler,\n-        this[kGroupIndent]);\n+  this[kWriteToConsole](kUseStdout, util.inspect(object, options));\n };\n \n Console.prototype.time = function time(label = 'default') {\n@@ -299,7 +354,7 @@ Console.prototype.trace = function trace(...args) {\n Console.prototype.assert = function assert(expression, ...args) {\n   if (!expression) {\n     args[0] = `Assertion failed${args.length === 0 ? '' : `: ${args[0]}`}`;\n-    this.warn(this[kFormatForStderr](args));\n+    this.warn(...args);  // the arguments will be formatted in warn() again\n   }\n };\n \n@@ -361,7 +416,6 @@ const valuesKey = 'Values';\n const indexKey = '(index)';\n const iterKey = '(iteration index)';\n \n-\n const isArray = (v) => ArrayIsArray(v) || isTypedArray(v) || isBuffer(v);\n \n // https://console.spec.whatwg.org/#table\n@@ -488,37 +542,30 @@ function noop() {}\n // we cannot actually use `new Console` to construct the global console.\n // Therefore, the console.Console.prototype is not\n // in the global console prototype chain anymore.\n+\n+// TODO(joyeecheung):\n+// - Move the Console constructor into internal/console.js\n+// - Move the global console creation code along with the inspector console\n+//   wrapping code in internal/bootstrap/node.js into a separate file.\n+// - Make this file a simple re-export of those two files.\n const globalConsole = Object.create({});\n-const tempConsole = new Console({\n-  stdout: process.stdout,\n-  stderr: process.stderr\n-});\n \n // Since Console is not on the prototype chain of the global console,\n // the symbol properties on Console.prototype have to be looked up from\n-// the global console itself.\n-for (const prop of Object.getOwnPropertySymbols(Console.prototype)) {\n-  globalConsole[prop] = Console.prototype[prop];\n-}\n-\n-// Reflect.ownKeys() is used here for retrieving Symbols\n-for (const prop of Reflect.ownKeys(tempConsole)) {\n-  const desc = { ...(Reflect.getOwnPropertyDescriptor(tempConsole, prop)) };\n-  // Since Console would bind method calls onto the instance,\n-  // make sure the methods are called on globalConsole instead of\n-  // tempConsole.\n-  if (typeof Console.prototype[prop] === 'function') {\n-    desc.value = Console.prototype[prop].bind(globalConsole);\n+// the global console itself. In addition, we need to make the global\n+// console a namespace by binding the console methods directly onto\n+// the global console with the receiver fixed.\n+for (const prop of Reflect.ownKeys(Console.prototype)) {\n+  if (prop === 'constructor') { continue; }\n+  const desc = Reflect.getOwnPropertyDescriptor(Console.prototype, prop);\n+  if (typeof desc.value === 'function') { // fix the receiver\n+    desc.value = desc.value.bind(globalConsole);\n   }\n   Reflect.defineProperty(globalConsole, prop, desc);\n }\n \n-globalConsole.Console = Console;\n-\n-Object.defineProperty(Console, Symbol.hasInstance, {\n-  value(instance) {\n-    return instance[kIsConsole];\n-  }\n-});\n+globalConsole[kBindStreamsLazy](process);\n+globalConsole[kBindProperties](true, 'auto');\n \n module.exports = globalConsole;\n+module.exports.Console = Console;"
        },
        {
            "sha": "272dec40060624567f7edcd1e2e9919da59521ec",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/333783643e71aeef3940fae215e7cf52ef00d5f0/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/333783643e71aeef3940fae215e7cf52ef00d5f0/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=333783643e71aeef3940fae215e7cf52ef00d5f0",
            "patch": "@@ -1,14 +1,16 @@\n-/* eslint-disable node-core/required-modules */\n-\n+// Flags: --expose-internals\n 'use strict';\n \n-// Ordinarily test files must require('common') but that action causes\n-// the global console to be compiled, defeating the purpose of this test.\n-// This makes sure no additional files are added without carefully considering\n-// lazy loading. Please adjust the value if necessary.\n-\n+// This list must be computed before we require any modules to\n+// to eliminate the noise.\n const list = process.moduleLoadList.slice();\n \n+const common = require('../common');\n const assert = require('assert');\n \n-assert(list.length <= 78, list);\n+const isMainThread = common.isMainThread;\n+const kMaxModuleCount = isMainThread ? 56 : 78;\n+\n+assert(list.length <= kMaxModuleCount,\n+       `Total length: ${list.length}\\n` + list.join('\\n')\n+);"
        },
        {
            "sha": "4023b51f479747aee798d8b25ecb1d8feaef867c",
            "filename": "test/pseudo-tty/test-stderr-stdout-handle-sigwinch.out",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/333783643e71aeef3940fae215e7cf52ef00d5f0/test%2Fpseudo-tty%2Ftest-stderr-stdout-handle-sigwinch.out",
            "raw_url": "https://github.com/nodejs/node/raw/333783643e71aeef3940fae215e7cf52ef00d5f0/test%2Fpseudo-tty%2Ftest-stderr-stdout-handle-sigwinch.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-stderr-stdout-handle-sigwinch.out?ref=333783643e71aeef3940fae215e7cf52ef00d5f0",
            "patch": "@@ -1,2 +1,2 @@\n-calling stdout._refreshSize\n calling stderr._refreshSize\n+calling stdout._refreshSize"
        }
    ],
    "stats": {
        "total": 217,
        "additions": 133,
        "deletions": 84
    }
}