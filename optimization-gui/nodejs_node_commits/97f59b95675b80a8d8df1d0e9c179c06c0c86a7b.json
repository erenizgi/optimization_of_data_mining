{
    "author": "joyeecheung",
    "message": "buffer: move initialization of buffer prototype into node.js\n\nInstead of exposing it in `lib/internal/buffer.js` after deleting\nit from the binding and then do the initialization in\n`lib/buffer.js`, which results in an implicit dependency on\nthe order in which these modules are loaded.\n\nPR-URL: https://github.com/nodejs/node/pull/25292\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
    "files": [
        {
            "sha": "b9baae7fefad709e388e3802603d00b3bf07cece",
            "filename": "lib/buffer.js",
            "status": "modified",
            "additions": 32,
            "deletions": 8,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fbuffer.js?ref=97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
            "patch": "@@ -35,7 +35,22 @@ const {\n   swap32: _swap32,\n   swap64: _swap64,\n   kMaxLength,\n-  kStringMaxLength\n+  kStringMaxLength,\n+  zeroFill: bindingZeroFill,\n+\n+  // Additional Buffer methods\n+  asciiSlice,\n+  base64Slice,\n+  latin1Slice,\n+  hexSlice,\n+  ucs2Slice,\n+  utf8Slice,\n+  asciiWrite,\n+  base64Write,\n+  latin1Write,\n+  hexWrite,\n+  ucs2Write,\n+  utf8Write\n } = internalBinding('buffer');\n const {\n   getOwnNonIndexProperties,\n@@ -74,10 +89,6 @@ const { validateString } = require('internal/validators');\n \n const internalBuffer = require('internal/buffer');\n \n-const { setupBufferJS } = internalBuffer;\n-\n-const bindingObj = {};\n-\n class FastBuffer extends Uint8Array {}\n FastBuffer.prototype.constructor = Buffer;\n internalBuffer.FastBuffer = FastBuffer;\n@@ -88,6 +99,19 @@ for (const [name, method] of Object.entries(internalBuffer.readWrites)) {\n   Buffer.prototype[name] = method;\n }\n \n+Buffer.prototype.asciiSlice = asciiSlice;\n+Buffer.prototype.base64Slice = base64Slice;\n+Buffer.prototype.latin1Slice = latin1Slice;\n+Buffer.prototype.hexSlice = hexSlice;\n+Buffer.prototype.ucs2Slice = ucs2Slice;\n+Buffer.prototype.utf8Slice = utf8Slice;\n+Buffer.prototype.asciiWrite = asciiWrite;\n+Buffer.prototype.base64Write = base64Write;\n+Buffer.prototype.latin1Write = latin1Write;\n+Buffer.prototype.hexWrite = hexWrite;\n+Buffer.prototype.ucs2Write = ucs2Write;\n+Buffer.prototype.utf8Write = utf8Write;\n+\n const constants = Object.defineProperties({}, {\n   MAX_LENGTH: {\n     value: kMaxLength,\n@@ -104,11 +128,11 @@ const constants = Object.defineProperties({}, {\n Buffer.poolSize = 8 * 1024;\n let poolSize, poolOffset, allocPool;\n \n-setupBufferJS(Buffer.prototype, bindingObj);\n-\n+// A toggle used to access the zero fill setting of the array buffer allocator\n+// in C++.\n // |zeroFill| can be undefined when running inside an isolate where we\n // do not own the ArrayBuffer allocator.  Zero fill is always on in that case.\n-const zeroFill = bindingObj.zeroFill || [0];\n+const zeroFill = bindingZeroFill || [0];\n \n function createUnsafeBuffer(size) {\n   return new FastBuffer(createUnsafeArrayBuffer(size));"
        },
        {
            "sha": "14aa8d5d3203b9d15125e2061d18f9641dfec93d",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
            "patch": "@@ -592,16 +592,21 @@ function setupGlobalVariables() {\n     }\n   });\n \n-  // This, as side effect, removes `setupBufferJS` from the buffer binding,\n-  // and exposes it on `internal/buffer`.\n-  NativeModule.require('internal/buffer');\n+  const { Buffer } = NativeModule.require('buffer');\n+  const bufferBinding = internalBinding('buffer');\n+\n+  // Only after this point can C++ use Buffer::New()\n+  bufferBinding.setBufferPrototype(Buffer.prototype);\n+  delete bufferBinding.setBufferPrototype;\n+  delete bufferBinding.zeroFill;\n \n   Object.defineProperty(global, 'Buffer', {\n-    value: NativeModule.require('buffer').Buffer,\n+    value: Buffer,\n     enumerable: false,\n     writable: true,\n     configurable: true\n   });\n+\n   process.domain = null;\n   process._exiting = false;\n }"
        },
        {
            "sha": "ee92b57f519827194b20375ef94072ef45ad040e",
            "filename": "lib/internal/buffer.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Finternal%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/lib%2Finternal%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbuffer.js?ref=97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
            "patch": "@@ -1,17 +1,11 @@\n 'use strict';\n \n-const binding = internalBinding('buffer');\n const {\n   ERR_BUFFER_OUT_OF_BOUNDS,\n   ERR_INVALID_ARG_TYPE,\n   ERR_OUT_OF_RANGE\n } = require('internal/errors').codes;\n const { validateNumber } = require('internal/validators');\n-const { setupBufferJS } = binding;\n-\n-// Remove from the binding so that function is only available as exported here.\n-// (That is, for internal use only.)\n-delete binding.setupBufferJS;\n \n // Temporary buffers to convert numbers.\n const float32Array = new Float32Array(1);\n@@ -779,7 +773,6 @@ function writeFloatBackwards(val, offset = 0) {\n \n // FastBuffer wil be inserted here by lib/buffer.js\n module.exports = {\n-  setupBufferJS,\n   // Container to export all read write functions.\n   readWrites: {\n     readUIntLE,"
        },
        {
            "sha": "2f4a4c66619e701f32ef37ac44d34a308909f766",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 28,
            "deletions": 28,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
            "patch": "@@ -1057,38 +1057,12 @@ static void EncodeUtf8String(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-// pass Buffer object to load prototype methods\n-void SetupBufferJS(const FunctionCallbackInfo<Value>& args) {\n+void SetBufferPrototype(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK(args[0]->IsObject());\n   Local<Object> proto = args[0].As<Object>();\n   env->set_buffer_prototype_object(proto);\n-\n-  env->SetMethodNoSideEffect(proto, \"asciiSlice\", StringSlice<ASCII>);\n-  env->SetMethodNoSideEffect(proto, \"base64Slice\", StringSlice<BASE64>);\n-  env->SetMethodNoSideEffect(proto, \"latin1Slice\", StringSlice<LATIN1>);\n-  env->SetMethodNoSideEffect(proto, \"hexSlice\", StringSlice<HEX>);\n-  env->SetMethodNoSideEffect(proto, \"ucs2Slice\", StringSlice<UCS2>);\n-  env->SetMethodNoSideEffect(proto, \"utf8Slice\", StringSlice<UTF8>);\n-\n-  env->SetMethod(proto, \"asciiWrite\", StringWrite<ASCII>);\n-  env->SetMethod(proto, \"base64Write\", StringWrite<BASE64>);\n-  env->SetMethod(proto, \"latin1Write\", StringWrite<LATIN1>);\n-  env->SetMethod(proto, \"hexWrite\", StringWrite<HEX>);\n-  env->SetMethod(proto, \"ucs2Write\", StringWrite<UCS2>);\n-  env->SetMethod(proto, \"utf8Write\", StringWrite<UTF8>);\n-\n-  if (auto zero_fill_field = env->isolate_data()->zero_fill_field()) {\n-    CHECK(args[1]->IsObject());\n-    auto binding_object = args[1].As<Object>();\n-    auto array_buffer = ArrayBuffer::New(env->isolate(),\n-                                         zero_fill_field,\n-                                         sizeof(*zero_fill_field));\n-    auto name = FIXED_ONE_BYTE_STRING(env->isolate(), \"zeroFill\");\n-    auto value = Uint32Array::New(array_buffer, 0, 1);\n-    CHECK(binding_object->Set(env->context(), name, value).FromJust());\n-  }\n }\n \n \n@@ -1098,7 +1072,7 @@ void Initialize(Local<Object> target,\n                 void* priv) {\n   Environment* env = Environment::GetCurrent(context);\n \n-  env->SetMethod(target, \"setupBufferJS\", SetupBufferJS);\n+  env->SetMethod(target, \"setBufferPrototype\", SetBufferPrototype);\n   env->SetMethodNoSideEffect(target, \"createFromString\", CreateFromString);\n \n   env->SetMethodNoSideEffect(target, \"byteLengthUtf8\", ByteLengthUtf8);\n@@ -1123,6 +1097,32 @@ void Initialize(Local<Object> target,\n   target->Set(env->context(),\n               FIXED_ONE_BYTE_STRING(env->isolate(), \"kStringMaxLength\"),\n               Integer::New(env->isolate(), String::kMaxLength)).FromJust();\n+\n+  env->SetMethodNoSideEffect(target, \"asciiSlice\", StringSlice<ASCII>);\n+  env->SetMethodNoSideEffect(target, \"base64Slice\", StringSlice<BASE64>);\n+  env->SetMethodNoSideEffect(target, \"latin1Slice\", StringSlice<LATIN1>);\n+  env->SetMethodNoSideEffect(target, \"hexSlice\", StringSlice<HEX>);\n+  env->SetMethodNoSideEffect(target, \"ucs2Slice\", StringSlice<UCS2>);\n+  env->SetMethodNoSideEffect(target, \"utf8Slice\", StringSlice<UTF8>);\n+\n+  env->SetMethod(target, \"asciiWrite\", StringWrite<ASCII>);\n+  env->SetMethod(target, \"base64Write\", StringWrite<BASE64>);\n+  env->SetMethod(target, \"latin1Write\", StringWrite<LATIN1>);\n+  env->SetMethod(target, \"hexWrite\", StringWrite<HEX>);\n+  env->SetMethod(target, \"ucs2Write\", StringWrite<UCS2>);\n+  env->SetMethod(target, \"utf8Write\", StringWrite<UTF8>);\n+\n+  // It can be a nullptr when running inside an isolate where we\n+  // do not own the ArrayBuffer allocator.\n+  if (uint32_t* zero_fill_field = env->isolate_data()->zero_fill_field()) {\n+    Local<ArrayBuffer> array_buffer = ArrayBuffer::New(\n+        env->isolate(), zero_fill_field, sizeof(*zero_fill_field));\n+    CHECK(target\n+              ->Set(env->context(),\n+                    FIXED_ONE_BYTE_STRING(env->isolate(), \"zeroFill\"),\n+                    Uint32Array::New(array_buffer, 0, 1))\n+              .FromJust());\n+  }\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "55e7d565fceda325601a23d753544e6d516141ed",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/97f59b95675b80a8d8df1d0e9c179c06c0c86a7b/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=97f59b95675b80a8d8df1d0e9c179c06c0c86a7b",
            "patch": "@@ -246,6 +246,7 @@ v8::MaybeLocal<v8::Uint8Array> New(Environment* env,\n                                    size_t byte_offset,\n                                    size_t length) {\n   v8::Local<v8::Uint8Array> ui = v8::Uint8Array::New(ab, byte_offset, length);\n+  CHECK(!env->buffer_prototype_object().IsEmpty());\n   v8::Maybe<bool> mb =\n       ui->SetPrototype(env->context(), env->buffer_prototype_object());\n   if (mb.IsNothing())"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 70,
        "deletions": 47
    }
}