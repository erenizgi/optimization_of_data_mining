{
    "author": "addaleax",
    "message": "events: show inspected error in uncaught 'error' message\n\nIf there is no handler for `.emit('error', value)` and `value`\nis not an `Error` object, we currently just call `.toString()`\non it.\n\nAlmost always, using `util.inspect()` provides better information\nfor diagnostic purposes, so prefer to use that instead.\n\nRefs: https://github.com/nodejs/help/issues/1729\n\nPR-URL: https://github.com/nodejs/node/pull/25621\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>",
    "sha": "eeea0dd1e74487edb0f707e571ddd14ec09686b0",
    "files": [
        {
            "sha": "fab8652ebf04576836171cb716787e6277dbe81c",
            "filename": "lib/events.js",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/eeea0dd1e74487edb0f707e571ddd14ec09686b0/lib%2Fevents.js",
            "raw_url": "https://github.com/nodejs/node/raw/eeea0dd1e74487edb0f707e571ddd14ec09686b0/lib%2Fevents.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fevents.js?ref=eeea0dd1e74487edb0f707e571ddd14ec09686b0",
            "patch": "@@ -172,9 +172,18 @@ EventEmitter.prototype.emit = function emit(type, ...args) {\n       // up in Node's output if this results in an unhandled exception.\n       throw er; // Unhandled 'error' event\n     }\n+\n+    let stringifiedEr;\n+    const { inspect } = require('internal/util/inspect');\n+    try {\n+      stringifiedEr = inspect(er);\n+    } catch {\n+      stringifiedEr = er;\n+    }\n+\n     // At least give some kind of context to the user\n     const errors = lazyErrors();\n-    const err = new errors.ERR_UNHANDLED_ERROR(er);\n+    const err = new errors.ERR_UNHANDLED_ERROR(stringifiedEr);\n     err.context = er;\n     throw err; // Unhandled 'error' event\n   }"
        },
        {
            "sha": "13d3a98d9c0a501bb6ed145f5598965837e6aba0",
            "filename": "test/parallel/test-event-emitter-errors.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/eeea0dd1e74487edb0f707e571ddd14ec09686b0/test%2Fparallel%2Ftest-event-emitter-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/eeea0dd1e74487edb0f707e571ddd14ec09686b0/test%2Fparallel%2Ftest-event-emitter-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-event-emitter-errors.js?ref=eeea0dd1e74487edb0f707e571ddd14ec09686b0",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n const common = require('../common');\n const EventEmitter = require('events');\n+const util = require('util');\n \n const EE = new EventEmitter();\n \n@@ -9,12 +10,24 @@ common.expectsError(\n   {\n     code: 'ERR_UNHANDLED_ERROR',\n     type: Error,\n-    message: 'Unhandled error. (Accepts a string)'\n+    message: \"Unhandled error. ('Accepts a string')\"\n   }\n );\n \n common.expectsError(\n   () => EE.emit('error', { message: 'Error!' }),\n+  {\n+    code: 'ERR_UNHANDLED_ERROR',\n+    type: Error,\n+    message: \"Unhandled error. ({ message: 'Error!' })\"\n+  }\n+);\n+\n+common.expectsError(\n+  () => EE.emit('error', {\n+    message: 'Error!',\n+    [util.inspect.custom]() { throw new Error(); }\n+  }),\n   {\n     code: 'ERR_UNHANDLED_ERROR',\n     type: Error,"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 24,
        "deletions": 2
    }
}