{
    "author": "BridgeAR",
    "message": "util: inspect ArrayBuffers contents as well\n\nInspecting an ArrayBuffer now also shows their binary contents.\n\nPR-URL: https://github.com/nodejs/node/pull/25006\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "aa07dd6248764006d1b201700a18173250b281de",
    "files": [
        {
            "sha": "3cb2c20ed0fdeff0b624cbbf9b4b05ca6c9810df",
            "filename": "doc/api/util.md",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/aa07dd6248764006d1b201700a18173250b281de/doc%2Fapi%2Futil.md",
            "raw_url": "https://github.com/nodejs/node/raw/aa07dd6248764006d1b201700a18173250b281de/doc%2Fapi%2Futil.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Futil.md?ref=aa07dd6248764006d1b201700a18173250b281de",
            "patch": "@@ -388,6 +388,9 @@ stream.write('With ES6');\n <!-- YAML\n added: v0.3.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/25006\n+    description: ArrayBuffers now also show their binary contents.\n   - version: v11.5.0\n     pr-url: https://github.com/nodejs/node/pull/24852\n     description: The `getters` option is supported now."
        },
        {
            "sha": "d78f67c502fda58560994a8357bc0ad06aca7edb",
            "filename": "lib/internal/util/inspect.js",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/aa07dd6248764006d1b201700a18173250b281de/lib%2Finternal%2Futil%2Finspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa07dd6248764006d1b201700a18173250b281de/lib%2Finternal%2Futil%2Finspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil%2Finspect.js?ref=aa07dd6248764006d1b201700a18173250b281de",
            "patch": "@@ -89,6 +89,7 @@ const setValues = uncurryThis(Set.prototype.values);\n const mapEntries = uncurryThis(Map.prototype.entries);\n const dateGetTime = uncurryThis(Date.prototype.getTime);\n const hasOwnProperty = uncurryThis(Object.prototype.hasOwnProperty);\n+let hexSlice;\n \n const inspectDefaultOptions = Object.seal({\n   showHidden: false,\n@@ -494,7 +495,7 @@ function noPrototypeIterator(ctx, value, recurseTimes) {\n // Note: using `formatValue` directly requires the indentation level to be\n // corrected by setting `ctx.indentationLvL += diff` and then to decrease the\n // value afterwards again.\n-function formatValue(ctx, value, recurseTimes) {\n+function formatValue(ctx, value, recurseTimes, typedArray) {\n   // Primitive types cannot have properties.\n   if (typeof value !== 'object' && typeof value !== 'function') {\n     return formatPrimitive(ctx.stylize, value, ctx);\n@@ -542,10 +543,10 @@ function formatValue(ctx, value, recurseTimes) {\n   if (ctx.seen.indexOf(value) !== -1)\n     return ctx.stylize('[Circular]', 'special');\n \n-  return formatRaw(ctx, value, recurseTimes);\n+  return formatRaw(ctx, value, recurseTimes, typedArray);\n }\n \n-function formatRaw(ctx, value, recurseTimes) {\n+function formatRaw(ctx, value, recurseTimes, typedArray) {\n   let keys;\n \n   const constructor = getConstructorName(value, ctx);\n@@ -678,9 +679,12 @@ function formatRaw(ctx, value, recurseTimes) {\n       const arrayType = isArrayBuffer(value) ? 'ArrayBuffer' :\n         'SharedArrayBuffer';\n       const prefix = getPrefix(constructor, tag, arrayType);\n-      if (keys.length === 0)\n+      if (typedArray === undefined) {\n+        formatter = formatArrayBuffer;\n+      } else if (keys.length === 0) {\n         return prefix +\n               `{ byteLength: ${formatNumber(ctx.stylize, value.byteLength)} }`;\n+      }\n       braces[0] = `${prefix}{`;\n       keys.unshift('byteLength');\n     } else if (isDataView(value)) {\n@@ -941,6 +945,18 @@ function formatSpecialArray(ctx, value, recurseTimes, maxLength, output, i) {\n   return output;\n }\n \n+function formatArrayBuffer(ctx, value) {\n+  const buffer = new Uint8Array(value);\n+  if (hexSlice === undefined)\n+    hexSlice = uncurryThis(require('buffer').Buffer.prototype.hexSlice);\n+  let str = hexSlice(buffer, 0, Math.min(ctx.maxArrayLength, buffer.length))\n+    .replace(/(.{2})/g, '$1 ').trim();\n+  const remaining = buffer.length - ctx.maxArrayLength;\n+  if (remaining > 0)\n+    str += ` ... ${remaining} more byte${remaining > 1 ? 's' : ''}`;\n+  return [`${ctx.stylize('[Uint8Contents]', 'special')}: <${str}>`];\n+}\n+\n function formatArray(ctx, value, recurseTimes) {\n   const valLen = value.length;\n   const len = Math.min(Math.max(0, ctx.maxArrayLength), valLen);\n@@ -981,7 +997,7 @@ function formatTypedArray(ctx, value, recurseTimes) {\n       'byteOffset',\n       'buffer'\n     ]) {\n-      const str = formatValue(ctx, value[key], recurseTimes);\n+      const str = formatValue(ctx, value[key], recurseTimes, true);\n       output.push(`[${key}]: ${str}`);\n     }\n     ctx.indentationLvl -= 2;"
        },
        {
            "sha": "27dfad3c91fd16db3aa6a5126f077a4413903265",
            "filename": "test/parallel/test-util-format-shared-arraybuffer.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8d893f213dfd73f960bbf9999cf973b05baad135/test%2Fparallel%2Ftest-util-format-shared-arraybuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/8d893f213dfd73f960bbf9999cf973b05baad135/test%2Fparallel%2Ftest-util-format-shared-arraybuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-format-shared-arraybuffer.js?ref=8d893f213dfd73f960bbf9999cf973b05baad135",
            "patch": "@@ -1,6 +0,0 @@\n-'use strict';\n-require('../common');\n-const assert = require('assert');\n-const util = require('util');\n-const sab = new SharedArrayBuffer(4);\n-assert.strictEqual(util.format(sab), 'SharedArrayBuffer { byteLength: 4 }');"
        },
        {
            "sha": "5dab0177565c106fac12e4ce81961041cfe01392",
            "filename": "test/parallel/test-util-format.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/aa07dd6248764006d1b201700a18173250b281de/test%2Fparallel%2Ftest-util-format.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa07dd6248764006d1b201700a18173250b281de/test%2Fparallel%2Ftest-util-format.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-format.js?ref=aa07dd6248764006d1b201700a18173250b281de",
            "patch": "@@ -341,3 +341,8 @@ assert.strictEqual(\n     '\\u001b[1mnull\\u001b[22m ' +\n     'foobar'\n );\n+\n+assert.strictEqual(\n+  util.format(new SharedArrayBuffer(4)),\n+  'SharedArrayBuffer { [Uint8Contents]: <00 00 00 00>, byteLength: 4 }'\n+);"
        },
        {
            "sha": "e001273409014ae9a3bb11d3df5700e62456230e",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 36,
            "deletions": 19,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/aa07dd6248764006d1b201700a18173250b281de/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa07dd6248764006d1b201700a18173250b281de/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=aa07dd6248764006d1b201700a18173250b281de",
            "patch": "@@ -115,70 +115,86 @@ assert(!/Object/.test(\n   util.inspect({ a: { a: { a: { a: {} } } } }, undefined, null, true)\n ));\n \n-for (const showHidden of [true, false]) {\n-  const ab = new ArrayBuffer(4);\n+{\n+  const showHidden = true;\n+  const ab = new Uint8Array([1, 2, 3, 4]).buffer;\n   const dv = new DataView(ab, 1, 2);\n   assert.strictEqual(\n     util.inspect(ab, showHidden),\n-    'ArrayBuffer { byteLength: 4 }'\n+    'ArrayBuffer { [Uint8Contents]: <01 02 03 04>, byteLength: 4 }'\n   );\n   assert.strictEqual(util.inspect(new DataView(ab, 1, 2), showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4 } }');\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: ' +\n+                       '<01 02 03 04>, byteLength: 4 } }');\n   assert.strictEqual(\n     util.inspect(ab, showHidden),\n-    'ArrayBuffer { byteLength: 4 }'\n+    'ArrayBuffer { [Uint8Contents]: <01 02 03 04>, byteLength: 4 }'\n   );\n   assert.strictEqual(util.inspect(dv, showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4 } }');\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: ' +\n+                       '<01 02 03 04>, byteLength: 4 } }');\n   ab.x = 42;\n   dv.y = 1337;\n   assert.strictEqual(util.inspect(ab, showHidden),\n-                     'ArrayBuffer { byteLength: 4, x: 42 }');\n+                     'ArrayBuffer { [Uint8Contents]: <01 02 03 04>, ' +\n+                       'byteLength: 4, x: 42 }');\n   assert.strictEqual(util.inspect(dv, showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4, x: 42 },\\n' +\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: <01 02 03 04>, ' +\n+                       'byteLength: 4, x: 42 },\\n' +\n                      '  y: 1337 }');\n }\n \n // Now do the same checks but from a different context.\n-for (const showHidden of [true, false]) {\n+{\n+  const showHidden = false;\n   const ab = vm.runInNewContext('new ArrayBuffer(4)');\n   const dv = vm.runInNewContext('new DataView(ab, 1, 2)', { ab });\n   assert.strictEqual(\n     util.inspect(ab, showHidden),\n-    'ArrayBuffer { byteLength: 4 }'\n+    'ArrayBuffer { [Uint8Contents]: <00 00 00 00>, byteLength: 4 }'\n   );\n   assert.strictEqual(util.inspect(new DataView(ab, 1, 2), showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4 } }');\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: <00 00 00 00>, ' +\n+                       'byteLength: 4 } }');\n   assert.strictEqual(\n     util.inspect(ab, showHidden),\n-    'ArrayBuffer { byteLength: 4 }'\n+    'ArrayBuffer { [Uint8Contents]: <00 00 00 00>, byteLength: 4 }'\n   );\n   assert.strictEqual(util.inspect(dv, showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4 } }');\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: <00 00 00 00>, ' +\n+                       'byteLength: 4 } }');\n   ab.x = 42;\n   dv.y = 1337;\n   assert.strictEqual(util.inspect(ab, showHidden),\n-                     'ArrayBuffer { byteLength: 4, x: 42 }');\n+                     'ArrayBuffer { [Uint8Contents]: <00 00 00 00>, ' +\n+                       'byteLength: 4, x: 42 }');\n   assert.strictEqual(util.inspect(dv, showHidden),\n                      'DataView {\\n' +\n                      '  byteLength: 2,\\n' +\n                      '  byteOffset: 1,\\n' +\n-                     '  buffer: ArrayBuffer { byteLength: 4, x: 42 },\\n' +\n+                     '  buffer:\\n' +\n+                     '   ArrayBuffer { [Uint8Contents]: <00 00 00 00>,' +\n+                       ' byteLength: 4, x: 42 },\\n' +\n                      '  y: 1337 }');\n }\n \n@@ -1639,13 +1655,14 @@ assert.strictEqual(util.inspect('\"\\'${a}'), \"'\\\"\\\\'${a}'\");\n   [new Float64Array(2), '[Float64Array: null prototype] [ 0, 0 ]'],\n   [new BigInt64Array(2), '[BigInt64Array: null prototype] [ 0n, 0n ]'],\n   [new BigUint64Array(2), '[BigUint64Array: null prototype] [ 0n, 0n ]'],\n-  [new ArrayBuffer(16), '[ArrayBuffer: null prototype] ' +\n-   '{ byteLength: undefined }'],\n+  [new ArrayBuffer(16), '[ArrayBuffer: null prototype] {\\n' +\n+     '  [Uint8Contents]: <00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00>,\\n' +\n+     '  byteLength: undefined }'],\n   [new DataView(new ArrayBuffer(16)),\n    '[DataView: null prototype] {\\n  byteLength: undefined,\\n  ' +\n-    'byteOffset: undefined,\\n  buffer: undefined }'],\n+     'byteOffset: undefined,\\n  buffer: undefined }'],\n   [new SharedArrayBuffer(2), '[SharedArrayBuffer: null prototype] ' +\n-  '{ byteLength: undefined }'],\n+     '{ [Uint8Contents]: <00 00>, byteLength: undefined }'],\n   [/foobar/, '[RegExp: null prototype] /foobar/']\n ].forEach(([value, expected]) => {\n   assert.strictEqual("
        }
    ],
    "stats": {
        "total": 95,
        "additions": 65,
        "deletions": 30
    }
}