{
    "author": "targos",
    "message": "deps: cherry-pick 2075910 from upstream V8\n\nOriginal commit message:\n\n    [turbofan] Remove optimization of default Promise capability functions.\n\n    The JSCallReducer could in theory inline the default resolve and reject\n    functions passed to the executor in the Promise constructor. But that\n    inlining is almost never triggered because we don't have SFI based feedback\n    in the CallIC. Also the use of the Promise constructor is discouraged,\n    so we shouldn't really need to squeeze the last bit of performance out\n    of this even in the future.\n\n    Getting rid of this optimization will make significantly easier to\n    implement the Swallowed Rejection Hook, as there's less churn on the\n    TurboFan side then.\n\n    Bug: v8:7919\n    Change-Id: If0c54f1c6c7ce95686cd74232be6b8693ac688c9\n    Reviewed-on: https://chromium-review.googlesource.com/1125926\n    Commit-Queue: Benedikt Meurer <bmeurer@chromium.org>\n    Reviewed-by: Jaroslav Sevcik <jarin@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#54210}\n\nRefs: https://github.com/v8/v8/commit/2075910f3d070159bebd80e128dd09fdd87be56e\n\nPR-URL: https://github.com/nodejs/node/pull/21838\nRefs: https://github.com/nodejs/promises-debugging/issues/8\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>",
    "sha": "4ce35fa3399604fb691456ffc85645375eee3e67",
    "files": [
        {
            "sha": "17948b9da3b7c64e5db71e8f4ab40f34ea726f40",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/4ce35fa3399604fb691456ffc85645375eee3e67/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/4ce35fa3399604fb691456ffc85645375eee3e67/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=4ce35fa3399604fb691456ffc85645375eee3e67",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.15',\n+    'v8_embedder_string': '-node.16',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "8e5034cde07d64a91d842894fde40e40ea8a4fde",
            "filename": "deps/v8/src/compiler/js-call-reducer.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 118,
            "changes": 118,
            "blob_url": "https://github.com/nodejs/node/blob/4ce35fa3399604fb691456ffc85645375eee3e67/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4ce35fa3399604fb691456ffc85645375eee3e67/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.cc?ref=4ce35fa3399604fb691456ffc85645375eee3e67",
            "patch": "@@ -3519,10 +3519,6 @@ Reduction JSCallReducer::ReduceJSCall(Node* node,\n       return ReduceAsyncFunctionPromiseCreate(node);\n     case Builtins::kAsyncFunctionPromiseRelease:\n       return ReduceAsyncFunctionPromiseRelease(node);\n-    case Builtins::kPromiseCapabilityDefaultReject:\n-      return ReducePromiseCapabilityDefaultReject(node);\n-    case Builtins::kPromiseCapabilityDefaultResolve:\n-      return ReducePromiseCapabilityDefaultResolve(node);\n     case Builtins::kPromiseInternalConstructor:\n       return ReducePromiseInternalConstructor(node);\n     case Builtins::kPromiseInternalReject:\n@@ -5252,120 +5248,6 @@ Reduction JSCallReducer::ReduceAsyncFunctionPromiseRelease(Node* node) {\n   return Replace(value);\n }\n \n-// ES section #sec-promise-reject-functions\n-Reduction JSCallReducer::ReducePromiseCapabilityDefaultReject(Node* node) {\n-  DCHECK_EQ(IrOpcode::kJSCall, node->opcode());\n-  Node* target = NodeProperties::GetValueInput(node, 0);\n-  Node* resolution = node->op()->ValueInputCount() > 2\n-                         ? NodeProperties::GetValueInput(node, 2)\n-                         : jsgraph()->UndefinedConstant();\n-  Node* frame_state = NodeProperties::GetFrameStateInput(node);\n-  Node* effect = NodeProperties::GetEffectInput(node);\n-  Node* control = NodeProperties::GetControlInput(node);\n-\n-  // We need to execute in the {target}s context.\n-  Node* context = effect = graph()->NewNode(\n-      simplified()->LoadField(AccessBuilder::ForJSFunctionContext()), target,\n-      effect, control);\n-\n-  // Grab the promise closed over by {target}.\n-  Node* promise = effect =\n-      graph()->NewNode(simplified()->LoadField(AccessBuilder::ForContextSlot(\n-                           PromiseBuiltinsAssembler::kPromiseSlot)),\n-                       context, effect, control);\n-\n-  // Check if the {promise} is still pending or already settled.\n-  Node* check = graph()->NewNode(simplified()->ReferenceEqual(), promise,\n-                                 jsgraph()->UndefinedConstant());\n-  Node* branch =\n-      graph()->NewNode(common()->Branch(BranchHint::kFalse), check, control);\n-\n-  Node* if_true = graph()->NewNode(common()->IfTrue(), branch);\n-  Node* etrue = effect;\n-\n-  Node* if_false = graph()->NewNode(common()->IfFalse(), branch);\n-  Node* efalse = effect;\n-  {\n-    // Mark the {promise} as settled.\n-    efalse = graph()->NewNode(\n-        simplified()->StoreField(AccessBuilder::ForContextSlot(\n-            PromiseBuiltinsAssembler::kPromiseSlot)),\n-        context, jsgraph()->UndefinedConstant(), efalse, if_false);\n-\n-    // Check if we should emit a debug event.\n-    Node* debug_event = efalse =\n-        graph()->NewNode(simplified()->LoadField(AccessBuilder::ForContextSlot(\n-                             PromiseBuiltinsAssembler::kDebugEventSlot)),\n-                         context, efalse, if_false);\n-\n-    // Actually reject the {promise}.\n-    efalse =\n-        graph()->NewNode(javascript()->RejectPromise(), promise, resolution,\n-                         debug_event, context, frame_state, efalse, if_false);\n-  }\n-\n-  control = graph()->NewNode(common()->Merge(2), if_true, if_false);\n-  effect = graph()->NewNode(common()->EffectPhi(2), etrue, efalse, control);\n-\n-  Node* value = jsgraph()->UndefinedConstant();\n-  ReplaceWithValue(node, value, effect, control);\n-  return Replace(value);\n-}\n-\n-// ES section #sec-promise-resolve-functions\n-Reduction JSCallReducer::ReducePromiseCapabilityDefaultResolve(Node* node) {\n-  DCHECK_EQ(IrOpcode::kJSCall, node->opcode());\n-  Node* target = NodeProperties::GetValueInput(node, 0);\n-  Node* resolution = node->op()->ValueInputCount() > 2\n-                         ? NodeProperties::GetValueInput(node, 2)\n-                         : jsgraph()->UndefinedConstant();\n-  Node* frame_state = NodeProperties::GetFrameStateInput(node);\n-  Node* effect = NodeProperties::GetEffectInput(node);\n-  Node* control = NodeProperties::GetControlInput(node);\n-\n-  // We need to execute in the {target}s context.\n-  Node* context = effect = graph()->NewNode(\n-      simplified()->LoadField(AccessBuilder::ForJSFunctionContext()), target,\n-      effect, control);\n-\n-  // Grab the promise closed over by {target}.\n-  Node* promise = effect =\n-      graph()->NewNode(simplified()->LoadField(AccessBuilder::ForContextSlot(\n-                           PromiseBuiltinsAssembler::kPromiseSlot)),\n-                       context, effect, control);\n-\n-  // Check if the {promise} is still pending or already settled.\n-  Node* check = graph()->NewNode(simplified()->ReferenceEqual(), promise,\n-                                 jsgraph()->UndefinedConstant());\n-  Node* branch =\n-      graph()->NewNode(common()->Branch(BranchHint::kFalse), check, control);\n-\n-  Node* if_true = graph()->NewNode(common()->IfTrue(), branch);\n-  Node* etrue = effect;\n-\n-  Node* if_false = graph()->NewNode(common()->IfFalse(), branch);\n-  Node* efalse = effect;\n-  {\n-    // Mark the {promise} as settled.\n-    efalse = graph()->NewNode(\n-        simplified()->StoreField(AccessBuilder::ForContextSlot(\n-            PromiseBuiltinsAssembler::kPromiseSlot)),\n-        context, jsgraph()->UndefinedConstant(), efalse, if_false);\n-\n-    // Actually resolve the {promise}.\n-    efalse =\n-        graph()->NewNode(javascript()->ResolvePromise(), promise, resolution,\n-                         context, frame_state, efalse, if_false);\n-  }\n-\n-  control = graph()->NewNode(common()->Merge(2), if_true, if_false);\n-  effect = graph()->NewNode(common()->EffectPhi(2), etrue, efalse, control);\n-\n-  Node* value = jsgraph()->UndefinedConstant();\n-  ReplaceWithValue(node, value, effect, control);\n-  return Replace(value);\n-}\n-\n Node* JSCallReducer::CreateArtificialFrameState(\n     Node* node, Node* outer_frame_state, int parameter_count,\n     BailoutId bailout_id, FrameStateType frame_state_type,"
        },
        {
            "sha": "e2810dc34c74021b8b7a60572205cf9055f14d33",
            "filename": "deps/v8/src/compiler/js-call-reducer.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/4ce35fa3399604fb691456ffc85645375eee3e67/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.h",
            "raw_url": "https://github.com/nodejs/node/raw/4ce35fa3399604fb691456ffc85645375eee3e67/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcompiler%2Fjs-call-reducer.h?ref=4ce35fa3399604fb691456ffc85645375eee3e67",
            "patch": "@@ -130,8 +130,6 @@ class V8_EXPORT_PRIVATE JSCallReducer final : public AdvancedReducer {\n \n   Reduction ReduceAsyncFunctionPromiseCreate(Node* node);\n   Reduction ReduceAsyncFunctionPromiseRelease(Node* node);\n-  Reduction ReducePromiseCapabilityDefaultReject(Node* node);\n-  Reduction ReducePromiseCapabilityDefaultResolve(Node* node);\n   Reduction ReducePromiseConstructor(Node* node);\n   Reduction ReducePromiseInternalConstructor(Node* node);\n   Reduction ReducePromiseInternalReject(Node* node);"
        }
    ],
    "stats": {
        "total": 122,
        "additions": 1,
        "deletions": 121
    }
}