{
    "author": "BridgeAR",
    "message": "async_hooks: lazy loading for startup performance\n\nPR-URL: https://github.com/nodejs/node/pull/20567\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "a3a14082fc7d254d0a8cf93f55b2c02c31afbb83",
    "files": [
        {
            "sha": "6a7489af974a406505392738d03944a05dfc5b3d",
            "filename": "lib/internal/inspector_async_hook.js",
            "status": "modified",
            "additions": 35,
            "deletions": 27,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/a3a14082fc7d254d0a8cf93f55b2c02c31afbb83/lib%2Finternal%2Finspector_async_hook.js",
            "raw_url": "https://github.com/nodejs/node/raw/a3a14082fc7d254d0a8cf93f55b2c02c31afbb83/lib%2Finternal%2Finspector_async_hook.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Finspector_async_hook.js?ref=a3a14082fc7d254d0a8cf93f55b2c02c31afbb83",
            "patch": "@@ -1,49 +1,56 @@\n 'use strict';\n \n-const { createHook } = require('async_hooks');\n const inspector = process.binding('inspector');\n-const config = process.binding('config');\n \n if (!inspector || !inspector.asyncTaskScheduled) {\n   exports.setup = function() {};\n   return;\n }\n \n-const hook = createHook({\n-  init(asyncId, type, triggerAsyncId, resource) {\n+let hook;\n+let config;\n+\n+function lazyHookCreation() {\n+  const { createHook } = require('async_hooks');\n+  config = process.binding('config');\n+\n+  hook = createHook({\n+    init(asyncId, type, triggerAsyncId, resource) {\n     // It's difficult to tell which tasks will be recurring and which won't,\n     // therefore we mark all tasks as recurring. Based on the discussion\n     // in https://github.com/nodejs/node/pull/13870#discussion_r124515293,\n     // this should be fine as long as we call asyncTaskCanceled() too.\n-    const recurring = true;\n-    if (type === 'PROMISE')\n-      this.promiseIds.add(asyncId);\n-    else\n-      inspector.asyncTaskScheduled(type, asyncId, recurring);\n-  },\n+      const recurring = true;\n+      if (type === 'PROMISE')\n+        this.promiseIds.add(asyncId);\n+      else\n+        inspector.asyncTaskScheduled(type, asyncId, recurring);\n+    },\n \n-  before(asyncId) {\n-    if (this.promiseIds.has(asyncId))\n-      return;\n-    inspector.asyncTaskStarted(asyncId);\n-  },\n+    before(asyncId) {\n+      if (this.promiseIds.has(asyncId))\n+        return;\n+      inspector.asyncTaskStarted(asyncId);\n+    },\n \n-  after(asyncId) {\n-    if (this.promiseIds.has(asyncId))\n-      return;\n-    inspector.asyncTaskFinished(asyncId);\n-  },\n+    after(asyncId) {\n+      if (this.promiseIds.has(asyncId))\n+        return;\n+      inspector.asyncTaskFinished(asyncId);\n+    },\n \n-  destroy(asyncId) {\n-    if (this.promiseIds.has(asyncId))\n-      return this.promiseIds.delete(asyncId);\n-    inspector.asyncTaskCanceled(asyncId);\n-  },\n-});\n+    destroy(asyncId) {\n+      if (this.promiseIds.has(asyncId))\n+        return this.promiseIds.delete(asyncId);\n+      inspector.asyncTaskCanceled(asyncId);\n+    },\n+  });\n \n-hook.promiseIds = new Set();\n+  hook.promiseIds = new Set();\n+}\n \n function enable() {\n+  if (hook === undefined) lazyHookCreation();\n   if (config.bits < 64) {\n     // V8 Inspector stores task ids as (void*) pointers.\n     // async_hooks store ids as 64bit numbers.\n@@ -61,6 +68,7 @@ function enable() {\n }\n \n function disable() {\n+  if (hook === undefined) lazyHookCreation();\n   hook.disable();\n }\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 35,
        "deletions": 27
    }
}