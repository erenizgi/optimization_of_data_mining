{
    "author": "BridgeAR",
    "message": "process: fix error handling\n\nThis makes sure the proper error is returned. Right now the error\nis not specific enough.\n\nPR-URL: https://github.com/nodejs/node/pull/19445\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "058e7fb8e66cafae700c5cb437d08572150fa69f",
    "files": [
        {
            "sha": "b735ba2e4b08f00eede4dce70c61e242b099497e",
            "filename": "lib/internal/process.js",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/058e7fb8e66cafae700c5cb437d08572150fa69f/lib%2Finternal%2Fprocess.js",
            "raw_url": "https://github.com/nodejs/node/raw/058e7fb8e66cafae700c5cb437d08572150fa69f/lib%2Finternal%2Fprocess.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess.js?ref=058e7fb8e66cafae700c5cb437d08572150fa69f",
            "patch": "@@ -7,6 +7,7 @@ const {\n     ERR_CPU_USAGE,\n     ERR_INVALID_ARG_TYPE,\n     ERR_INVALID_ARRAY_LENGTH,\n+    ERR_INVALID_OPT_VALUE,\n     ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET,\n     ERR_UNKNOWN_SIGNAL\n   }\n@@ -41,11 +42,24 @@ function setup_cpuUsage() {\n     // If a previous value was passed in, ensure it has the correct shape.\n     if (prevValue) {\n       if (!previousValueIsValid(prevValue.user)) {\n-        throw new ERR_INVALID_ARG_TYPE('preValue.user', 'number');\n+        if (typeof prevValue !== 'object')\n+          throw new ERR_INVALID_ARG_TYPE('prevValue', 'object', prevValue);\n+\n+        if (typeof prevValue.user !== 'number') {\n+          throw new ERR_INVALID_ARG_TYPE('prevValue.user',\n+                                         'number', prevValue.user);\n+        }\n+        throw new ERR_INVALID_OPT_VALUE.RangeError('prevValue.user',\n+                                                   prevValue.user);\n       }\n \n       if (!previousValueIsValid(prevValue.system)) {\n-        throw new ERR_INVALID_ARG_TYPE('preValue.system', 'number');\n+        if (typeof prevValue.system !== 'number') {\n+          throw new ERR_INVALID_ARG_TYPE('prevValue.system',\n+                                         'number', prevValue.system);\n+        }\n+        throw new ERR_INVALID_OPT_VALUE.RangeError('prevValue.system',\n+                                                   prevValue.system);\n       }\n     }\n "
        },
        {
            "sha": "0b1d53978cac5c512f498e9e269afaca92a4e8e5",
            "filename": "test/parallel/test-process-cpuUsage.js",
            "status": "modified",
            "additions": 73,
            "deletions": 58,
            "changes": 131,
            "blob_url": "https://github.com/nodejs/node/blob/058e7fb8e66cafae700c5cb437d08572150fa69f/test%2Fparallel%2Ftest-process-cpuUsage.js",
            "raw_url": "https://github.com/nodejs/node/raw/058e7fb8e66cafae700c5cb437d08572150fa69f/test%2Fparallel%2Ftest-process-cpuUsage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-cpuUsage.js?ref=058e7fb8e66cafae700c5cb437d08572150fa69f",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n+require('../common');\n const assert = require('assert');\n-const common = require('../common');\n const result = process.cpuUsage();\n \n // Validate the result of calling with no previous value argument.\n@@ -31,65 +31,80 @@ for (let i = 0; i < 10; i++) {\n   assert(diffUsage.user >= 0);\n   assert(diffUsage.system >= 0);\n }\n-const invalidUserArgument = common.expectsError({\n-  code: 'ERR_INVALID_ARG_TYPE',\n-  type: TypeError,\n-  message: 'The \"preValue.user\" property must be of type number'\n-}, 8);\n-\n-const invalidSystemArgument = common.expectsError({\n-  code: 'ERR_INVALID_ARG_TYPE',\n-  type: TypeError,\n-  message: 'The \"preValue.system\" property must be of type number'\n-}, 2);\n-\n \n // Ensure that an invalid shape for the previous value argument throws an error.\n-assert.throws(() => {\n-  process.cpuUsage(1);\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({});\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ user: 'a' });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ system: 'b' });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ user: null, system: 'c' });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ user: 'd', system: null });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ user: -1, system: 2 });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({ user: 3, system: -2 });\n-}, invalidSystemArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({\n-    user: Number.POSITIVE_INFINITY,\n-    system: 4\n-  });\n-}, invalidUserArgument);\n-\n-assert.throws(() => {\n-  process.cpuUsage({\n-    user: 5,\n-    system: Number.NEGATIVE_INFINITY\n-  });\n-}, invalidSystemArgument);\n+assert.throws(\n+  () => process.cpuUsage(1),\n+  {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    name: 'TypeError [ERR_INVALID_ARG_TYPE]',\n+    message: 'The \"prevValue\" argument must be of type object. ' +\n+             'Received type number'\n+  }\n+);\n+\n+// Check invalid types.\n+[\n+  {},\n+  { user: 'a' },\n+  { user: null, system: 'c' },\n+].forEach((value) => {\n+  assert.throws(\n+    () => process.cpuUsage(value),\n+    {\n+      code: 'ERR_INVALID_ARG_TYPE',\n+      name: 'TypeError [ERR_INVALID_ARG_TYPE]',\n+      message: 'The \"prevValue.user\" property must be of type number. ' +\n+               `Received type ${typeof value.user}`\n+    }\n+  );\n+});\n+\n+[\n+  { user: 3, system: 'b' },\n+  { user: 3, system: null }\n+].forEach((value) => {\n+  assert.throws(\n+    () => process.cpuUsage(value),\n+    {\n+      code: 'ERR_INVALID_ARG_TYPE',\n+      name: 'TypeError [ERR_INVALID_ARG_TYPE]',\n+      message: 'The \"prevValue.system\" property must be of type number. ' +\n+               `Received type ${typeof value.system}`\n+    }\n+  );\n+});\n+\n+// Check invalid values.\n+[\n+  { user: -1, system: 2 },\n+  { user: Number.POSITIVE_INFINITY, system: 4 }\n+].forEach((value) => {\n+  assert.throws(\n+    () => process.cpuUsage(value),\n+    {\n+      code: 'ERR_INVALID_OPT_VALUE',\n+      name: 'RangeError [ERR_INVALID_OPT_VALUE]',\n+      message: `The value \"${value.user}\" is invalid ` +\n+               'for option \"prevValue.user\"'\n+    }\n+  );\n+});\n+\n+[\n+  { user: 3, system: -2 },\n+  { user: 5, system: Number.NEGATIVE_INFINITY }\n+].forEach((value) => {\n+  assert.throws(\n+    () => process.cpuUsage(value),\n+    {\n+      code: 'ERR_INVALID_OPT_VALUE',\n+      name: 'RangeError [ERR_INVALID_OPT_VALUE]',\n+      message: `The value \"${value.system}\" is invalid ` +\n+               'for option \"prevValue.system\"'\n+    }\n+  );\n+});\n \n // Ensure that the return value is the expected shape.\n function validateResult(result) {"
        }
    ],
    "stats": {
        "total": 149,
        "additions": 89,
        "deletions": 60
    }
}