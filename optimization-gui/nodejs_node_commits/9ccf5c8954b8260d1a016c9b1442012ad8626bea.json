{
    "author": "BridgeAR",
    "message": "test: don't inspect values if not necessary\n\nThe inspection triggered on each assert call eagerly even tough the\nassertion was never triggered. That caused significant CPU overhead.\n\nPR-URL: https://github.com/nodejs/node/pull/22903\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Rich Trott <rtrott@gmail.com>",
    "sha": "9ccf5c8954b8260d1a016c9b1442012ad8626bea",
    "files": [
        {
            "sha": "382d1d3642c959e319f7d86a83e583302f0a4fa4",
            "filename": "test/common/heap.js",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fcommon%2Fheap.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fcommon%2Fheap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fheap.js?ref=9ccf5c8954b8260d1a016c9b1442012ad8626bea",
            "patch": "@@ -33,10 +33,17 @@ class State {\n             (node) => [expectedChild.name, 'Node / ' + expectedChild.name]\n               .includes(node.name);\n \n-          assert(snapshot.some((node) => {\n+          const hasChild = snapshot.some((node) => {\n             return node.outgoingEdges.map((edge) => edge.toNode).some(check);\n-          }), `expected to find child ${util.inspect(expectedChild)} ` +\n-              `in ${util.inspect(snapshot)}`);\n+          });\n+          // Don't use assert with a custom message here. Otherwise the\n+          // inspection in the message is done eagerly and wastes a lot of CPU\n+          // time.\n+          if (!hasChild) {\n+            throw new Error(\n+              'expected to find child ' +\n+              `${util.inspect(expectedChild)} in ${util.inspect(snapshot)}`);\n+          }\n         }\n       }\n     }\n@@ -61,9 +68,15 @@ class State {\n                 node.value.constructor.name === expectedChild.name);\n           };\n \n-          assert(graph.some((node) => node.edges.some(check)),\n-                 `expected to find child ${util.inspect(expectedChild)} ` +\n-                 `in ${util.inspect(snapshot)}`);\n+          // Don't use assert with a custom message here. Otherwise the\n+          // inspection in the message is done eagerly and wastes a lot of CPU\n+          // time.\n+          const hasChild = graph.some((node) => node.edges.some(check));\n+          if (!hasChild) {\n+            throw new Error(\n+              'expected to find child ' +\n+              `${util.inspect(expectedChild)} in ${util.inspect(snapshot)}`);\n+          }\n         }\n       }\n     }"
        },
        {
            "sha": "9e5a0ccb026c1ac3b415fd721c1df9acabef0722",
            "filename": "test/internet/test-trace-events-dns.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Finternet%2Ftest-trace-events-dns.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Finternet%2Ftest-trace-events-dns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Finternet%2Ftest-trace-events-dns.js?ref=9ccf5c8954b8260d1a016c9b1442012ad8626bea",
            "patch": "@@ -49,7 +49,12 @@ for (const tr in tests) {\n                             { encoding: 'utf8' });\n \n   // Make sure the operation is successful.\n-  assert.strictEqual(proc.status, 0, `${tr}:\\n${util.inspect(proc)}`);\n+  // Don't use assert with a custom message here. Otherwise the\n+  // inspection in the message is done eagerly and wastes a lot of CPU\n+  // time.\n+  if (proc.status !== 0) {\n+    throw new Error(`${tr}:\\n${util.inspect(proc)}`);\n+  }\n \n   const file = path.join(tmpdir.path, traceFile);\n "
        },
        {
            "sha": "54222bcb333f51673064bc7d2304ac7e5f8ccf4b",
            "filename": "test/parallel/test-trace-events-fs-sync.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fparallel%2Ftest-trace-events-fs-sync.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fparallel%2Ftest-trace-events-fs-sync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-fs-sync.js?ref=9ccf5c8954b8260d1a016c9b1442012ad8626bea",
            "patch": "@@ -136,7 +136,12 @@ for (const tr in tests) {\n   }\n \n   // Make sure the operation is successful.\n-  assert.strictEqual(proc.status, 0, `${tr}:\\n${util.inspect(proc)}`);\n+  // Don't use assert with a custom message here. Otherwise the\n+  // inspection in the message is done eagerly and wastes a lot of CPU\n+  // time.\n+  if (proc.status !== 0) {\n+    throw new Error(`${tr}:\\n${util.inspect(proc)}`);\n+  }\n \n   // Confirm that trace log file is created.\n   assert(fs.existsSync(traceFile));"
        },
        {
            "sha": "c6f29163dfc6435ee54cde123800ed44e42e1762",
            "filename": "test/parallel/test-worker-message-port-transfer-self.js",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ccf5c8954b8260d1a016c9b1442012ad8626bea/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-transfer-self.js?ref=9ccf5c8954b8260d1a016c9b1442012ad8626bea",
            "patch": "@@ -27,14 +27,18 @@ assert.throws(common.mustCall(() => {\n port2.onmessage = common.mustCall((message) => {\n   assert.strictEqual(message, 2);\n \n-  assert(util.inspect(port1).includes('active: true'), util.inspect(port1));\n-  assert(util.inspect(port2).includes('active: true'), util.inspect(port2));\n+  const inspectedPort1 = util.inspect(port1);\n+  const inspectedPort2 = util.inspect(port2);\n+  assert(inspectedPort1.includes('active: true'), inspectedPort1);\n+  assert(inspectedPort2.includes('active: true'), inspectedPort2);\n \n   port1.close();\n \n   tick(10, () => {\n-    assert(util.inspect(port1).includes('active: false'), util.inspect(port1));\n-    assert(util.inspect(port2).includes('active: false'), util.inspect(port2));\n+    const inspectedPort1 = util.inspect(port1);\n+    const inspectedPort2 = util.inspect(port2);\n+    assert(inspectedPort1.includes('active: false'), inspectedPort1);\n+    assert(inspectedPort2.includes('active: false'), inspectedPort2);\n   });\n });\n port1.postMessage(2);"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 39,
        "deletions": 12
    }
}