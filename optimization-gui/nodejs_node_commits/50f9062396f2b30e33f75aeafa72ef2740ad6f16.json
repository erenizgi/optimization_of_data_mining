{
    "author": "davidben",
    "message": "crypto: don't crash X509ToObject on error\n\nUse MaybeLocal::ToLocal and don't crash X509ToObject on error.\n\nPR-URL: https://github.com/nodejs/node/pull/25717\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "50f9062396f2b30e33f75aeafa72ef2740ad6f16",
    "files": [
        {
            "sha": "25476edde98f3e42faf0eb7fc5b65eb7a305a33c",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 14,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/50f9062396f2b30e33f75aeafa72ef2740ad6f16/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/50f9062396f2b30e33f75aeafa72ef2740ad6f16/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=50f9062396f2b30e33f75aeafa72ef2740ad6f16",
            "patch": "@@ -1640,24 +1640,27 @@ static void AddFingerprintDigest(const unsigned char* md,\n   }\n }\n \n+\n static MaybeLocal<Object> ECPointToBuffer(Environment* env,\n                                           const EC_GROUP* group,\n                                           const EC_POINT* point,\n-                                          point_conversion_form_t form) {\n+                                          point_conversion_form_t form,\n+                                          const char** error) {\n   size_t len = EC_POINT_point2oct(group, point, form, nullptr, 0, nullptr);\n   if (len == 0) {\n-    env->ThrowError(\"Failed to get public key length\");\n+    if (error != nullptr) *error = \"Failed to get public key length\";\n     return MaybeLocal<Object>();\n   }\n   MallocedBuffer<unsigned char> buf(len);\n   len = EC_POINT_point2oct(group, point, form, buf.data, buf.size, nullptr);\n   if (len == 0) {\n-    env->ThrowError(\"Failed to get public key\");\n+    if (error != nullptr) *error = \"Failed to get public key\";\n     return MaybeLocal<Object>();\n   }\n   return Buffer::New(env, buf.release(), len);\n }\n \n+\n static Local<Object> X509ToObject(Environment* env, X509* cert) {\n   EscapableHandleScope scope(env->isolate());\n   Local<Context> context = env->context();\n@@ -1775,10 +1778,11 @@ static Local<Object> X509ToObject(Environment* env, X509* cert) {\n     }\n \n     const EC_POINT* pubkey = EC_KEY_get0_public_key(ec.get());\n-    if (pubkey != nullptr) {\n-      Local<Object> buf =\n-          ECPointToBuffer(env, group, pubkey, EC_KEY_get_conv_form(ec.get()))\n-              .ToLocalChecked();\n+    Local<Object> buf;\n+    if (pubkey != nullptr &&\n+        ECPointToBuffer(\n+            env, group, pubkey, EC_KEY_get_conv_form(ec.get()), nullptr)\n+            .ToLocal(&buf)) {\n       info->Set(context, env->pubkey_string(), buf).FromJust();\n     }\n \n@@ -5275,6 +5279,7 @@ void ECDH::GetPublicKey(const FunctionCallbackInfo<Value>& args) {\n   ECDH* ecdh;\n   ASSIGN_OR_RETURN_UNWRAP(&ecdh, args.Holder());\n \n+  const EC_GROUP* group = EC_KEY_get0_group(ecdh->key_.get());\n   const EC_POINT* pub = EC_KEY_get0_public_key(ecdh->key_.get());\n   if (pub == nullptr)\n     return env->ThrowError(\"Failed to get ECDH public key\");\n@@ -5283,10 +5288,11 @@ void ECDH::GetPublicKey(const FunctionCallbackInfo<Value>& args) {\n   uint32_t val = args[0].As<Uint32>()->Value();\n   point_conversion_form_t form = static_cast<point_conversion_form_t>(val);\n \n-  MaybeLocal<Object> buf =\n-      ECPointToBuffer(env, EC_KEY_get0_group(ecdh->key_.get()), pub, form);\n-  if (buf.IsEmpty()) return;\n-  args.GetReturnValue().Set(buf.ToLocalChecked());\n+  const char* error;\n+  Local<Object> buf;\n+  if (!ECPointToBuffer(env, group, pub, form, &error).ToLocal(&buf))\n+    return env->ThrowError(error);\n+  args.GetReturnValue().Set(buf);\n }\n \n \n@@ -6174,9 +6180,11 @@ void ConvertKey(const FunctionCallbackInfo<Value>& args) {\n   uint32_t val = args[2].As<Uint32>()->Value();\n   point_conversion_form_t form = static_cast<point_conversion_form_t>(val);\n \n-  MaybeLocal<Object> buf = ECPointToBuffer(env, group.get(), pub.get(), form);\n-  if (buf.IsEmpty()) return;\n-  args.GetReturnValue().Set(buf.ToLocalChecked());\n+  const char* error;\n+  Local<Object> buf;\n+  if (!ECPointToBuffer(env, group.get(), pub.get(), form, &error).ToLocal(&buf))\n+    return env->ThrowError(error);\n+  args.GetReturnValue().Set(buf);\n }\n \n "
        }
    ],
    "stats": {
        "total": 36,
        "additions": 22,
        "deletions": 14
    }
}