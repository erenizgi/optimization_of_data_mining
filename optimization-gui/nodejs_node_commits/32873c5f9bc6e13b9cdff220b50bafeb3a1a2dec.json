{
    "author": "ofrobots",
    "message": "src: trace_events: background thread events\n\nV8 uses a thread pool provided by the host to schedule background tasks\nfor concurrent GC and compiation. Emit trace events to identify the\nbackground threads. Ensure that the tracing infrastructure is started\nbefore the thread pool is initialized.\n\nPR-URL: https://github.com/nodejs/node/pull/20823\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec",
    "files": [
        {
            "sha": "27fccca6ee0a41299a5afff12c44ab11fe97c0ba",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec",
            "patch": "@@ -289,11 +289,11 @@ static struct {\n #if NODE_USE_V8_PLATFORM\n   void Initialize(int thread_pool_size) {\n     tracing_agent_.reset(new tracing::Agent(trace_file_pattern));\n-    platform_ = new NodePlatform(thread_pool_size,\n-        tracing_agent_->GetTracingController());\n+    auto controller = tracing_agent_->GetTracingController();\n+    tracing::TraceEventHelper::SetTracingController(controller);\n+    StartTracingAgent();\n+    platform_ = new NodePlatform(thread_pool_size, controller);\n     V8::InitializePlatform(platform_);\n-    tracing::TraceEventHelper::SetTracingController(\n-        tracing_agent_->GetTracingController());\n   }\n \n   void Dispose() {\n@@ -4406,8 +4406,6 @@ int Start(int argc, char** argv) {\n #endif  // HAVE_OPENSSL\n \n   v8_platform.Initialize(v8_thread_pool_size);\n-  // Enable tracing when argv has --trace-events-enabled.\n-  v8_platform.StartTracingAgent();\n   V8::Initialize();\n   performance::performance_v8_start = PERFORMANCE_NOW();\n   v8_initialized = true;"
        },
        {
            "sha": "2885c72ed7121381aa3cdc1a4d5bbb52350afdd4",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec",
            "patch": "@@ -16,8 +16,10 @@ using v8::Platform;\n using v8::Task;\n using v8::TracingController;\n \n-static void BackgroundRunner(void* data) {\n-  TaskQueue<Task>* background_tasks = static_cast<TaskQueue<Task>*>(data);\n+static void BackgroundRunner(void *data) {\n+  TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\", \"name\",\n+                        \"BackgroundTaskRunner\");\n+  TaskQueue<Task> *background_tasks = static_cast<TaskQueue<Task> *>(data);\n   while (std::unique_ptr<Task> task = background_tasks->BlockingPop()) {\n     task->Run();\n     background_tasks->NotifyOfCompletion();"
        },
        {
            "sha": "f43cb56cd3a5b58664cff6162c9cea2edb21f0fd",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec",
            "patch": "@@ -64,12 +64,12 @@ class NodeTestFixture : public ::testing::Test {\n   v8::Isolate* isolate_;\n \n   static void SetUpTestCase() {\n-    platform.reset(new node::NodePlatform(4, nullptr));\n     tracing_controller.reset(new v8::TracingController());\n-    allocator.reset(v8::ArrayBuffer::Allocator::NewDefaultAllocator());\n-    params.array_buffer_allocator = allocator.get();\n     node::tracing::TraceEventHelper::SetTracingController(\n         tracing_controller.get());\n+    platform.reset(new node::NodePlatform(4, nullptr));\n+    allocator.reset(v8::ArrayBuffer::Allocator::NewDefaultAllocator());\n+    params.array_buffer_allocator = allocator.get();\n     CHECK_EQ(0, uv_loop_init(&current_loop));\n     v8::V8::InitializePlatform(platform.get());\n     v8::V8::Initialize();"
        },
        {
            "sha": "eccec1ecf0f1a23015ddd7ef872c397cfd27c97f",
            "filename": "test/parallel/test-trace-events-metadata.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-metadata.js?ref=32873c5f9bc6e13b9cdff220b50bafeb3a1a2dec",
            "patch": "@@ -22,5 +22,8 @@ proc.once('exit', common.mustCall(() => {\n     assert(traces.some((trace) =>\n       trace.cat === '__metadata' && trace.name === 'thread_name' &&\n         trace.args.name === 'JavaScriptMainThread'));\n+    assert(traces.some((trace) =>\n+      trace.cat === '__metadata' && trace.name === 'thread_name' &&\n+        trace.args.name === 'BackgroundTaskRunner'));\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 14,
        "deletions": 11
    }
}