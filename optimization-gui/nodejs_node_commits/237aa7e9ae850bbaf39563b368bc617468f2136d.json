{
    "author": "jasnell",
    "message": "http2: refactor how trailers are done\n\nRather than an option, introduce a method and an event...\n\n```js\nserver.on('stream', (stream) => {\n  stream.respond(undefined, { waitForTrailers: true });\n  stream.on('wantTrailers', () => {\n    stream.sendTrailers({ abc: 'xyz'});\n  });\n  stream.end('hello world');\n});\n```\n\nThis is a breaking change in the API such that the prior\n`options.getTrailers` is no longer supported at all.\nOrdinarily this would be semver-major and require a\ndeprecation but the http2 stuff is still experimental.\n\nPR-URL: https://github.com/nodejs/node/pull/19959\nReviewed-By: Yuta Hiroto <hello@hiroppy.me>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "237aa7e9ae850bbaf39563b368bc617468f2136d",
    "files": [
        {
            "sha": "0ba9b992fd8e2ee33c31791c4fe875cd50de1c5c",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -1017,6 +1017,19 @@ When setting the priority for an HTTP/2 stream, the stream may be marked as\n a dependency for a parent stream. This error code is used when an attempt is\n made to mark a stream and dependent of itself.\n \n+<a id=\"ERR_HTTP2_TRAILERS_ALREADY_SENT\"></a>\n+### ERR_HTTP2_TRAILERS_ALREADY_SENT\n+\n+Trailing headers have already been sent on the `Http2Stream`.\n+\n+<a id=\"ERR_HTTP2_TRAILERS_NOT_READY\"></a>\n+### ERR_HTTP2_TRAILERS_NOT_READY\n+\n+The `http2stream.sendTrailers()` method cannot be called until after the\n+`'wantTrailers'` event is emitted on an `Http2Stream` object. The\n+`'wantTrailers'` event will only be emitted if the `waitForTrailers` option\n+is set for the `Http2Stream`.\n+\n <a id=\"ERR_HTTP2_UNSUPPORTED_PROTOCOL\"></a>\n ### ERR_HTTP2_UNSUPPORTED_PROTOCOL\n "
        },
        {
            "sha": "9a0b5595346307d32b44e444fab15b280a7edc43",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 116,
            "deletions": 75,
            "changes": 191,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -176,13 +176,13 @@ immediately following the `'frameError'` event.\n added: v8.4.0\n -->\n \n-The `'goaway'` event is emitted when a GOAWAY frame is received. When invoked,\n+The `'goaway'` event is emitted when a `GOAWAY` frame is received. When invoked,\n the handler function will receive three arguments:\n \n-* `errorCode` {number} The HTTP/2 error code specified in the GOAWAY frame.\n+* `errorCode` {number} The HTTP/2 error code specified in the `GOAWAY` frame.\n * `lastStreamID` {number} The ID of the last stream the remote peer successfully\n   processed (or `0` if no ID is specified).\n-* `opaqueData` {Buffer} If additional opaque data was included in the GOAWAY\n+* `opaqueData` {Buffer} If additional opaque data was included in the `GOAWAY`\n   frame, a `Buffer` instance will be passed containing that data.\n \n The `Http2Session` instance will be shut down automatically when the `'goaway'`\n@@ -193,7 +193,7 @@ event is emitted.\n added: v8.4.0\n -->\n \n-The `'localSettings'` event is emitted when an acknowledgment SETTINGS frame\n+The `'localSettings'` event is emitted when an acknowledgment `SETTINGS` frame\n has been received. When invoked, the handler function will receive a copy of\n the local settings.\n \n@@ -213,7 +213,7 @@ session.on('localSettings', (settings) => {\n added: v8.4.0\n -->\n \n-The `'remoteSettings'` event is emitted when a new SETTINGS frame is received\n+The `'remoteSettings'` event is emitted when a new `SETTINGS` frame is received\n from the connected peer. When invoked, the handler function will receive a copy\n of the remote settings.\n \n@@ -383,7 +383,7 @@ added: v9.4.0\n * `code` {number} An HTTP/2 error code\n * `lastStreamID` {number} The numeric ID of the last processed `Http2Stream`\n * `opaqueData` {Buffer|TypedArray|DataView} A `TypedArray` or `DataView`\n-  instance containing additional data to be carried within the GOAWAY frame.\n+  instance containing additional data to be carried within the `GOAWAY` frame.\n \n Transmits a `GOAWAY` frame to the connected peer *without* shutting down the\n `Http2Session`.\n@@ -417,7 +417,7 @@ added: v8.4.0\n * {boolean}\n \n Indicates whether or not the `Http2Session` is currently waiting for an\n-acknowledgment for a sent SETTINGS frame. Will be `true` after calling the\n+acknowledgment for a sent `SETTINGS` frame. Will be `true` after calling the\n `http2session.settings()` method. Will be `false` once all sent SETTINGS\n frames have been acknowledged.\n \n@@ -551,9 +551,9 @@ Once called, the `http2session.pendingSettingsAck` property will be `true`\n while the session is waiting for the remote peer to acknowledge the new\n settings.\n \n-The new settings will not become effective until the SETTINGS acknowledgment is\n-received and the `'localSettings'` event is emitted. It is possible to send\n-multiple SETTINGS frames while acknowledgment is still pending.\n+The new settings will not become effective until the `SETTINGS` acknowledgment\n+is received and the `'localSettings'` event is emitted. It is possible to send\n+multiple `SETTINGS` frames while acknowledgment is still pending.\n \n #### http2session.type\n <!-- YAML\n@@ -695,8 +695,8 @@ added: v8.4.0\n   * `weight` {number} Specifies the relative dependency of a stream in relation\n     to other streams with the same `parent`. The value is a number between `1`\n     and `256` (inclusive).\n-  * `getTrailers` {Function} Callback function invoked to collect trailer\n-    headers.\n+  * `waitForTrailers` {boolean} When `true`, the `Http2Stream` will emit the\n+    `'wantTrailers'` event after the final `DATA` frame has been sent.\n \n * Returns: {ClientHttp2Stream}\n \n@@ -723,14 +723,15 @@ req.on('response', (headers) => {\n });\n ```\n \n-When set, the `options.getTrailers()` function is called immediately after\n-queuing the last chunk of payload data to be sent. The callback is passed a\n-single object (with a `null` prototype) that the listener may use to specify\n-the trailing header fields to send to the peer.\n+When the `options.waitForTrailers` option is set, the `'wantTrailers'` event\n+is emitted immediately after queuing the last chunk of payload data to be sent.\n+The `http2stream.sendTrailers()` method can then be called to send trailing\n+headers to the peer.\n \n-The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header\n-fields (e.g. `':method'`, `':path'`, etc). An `'error'` event will be emitted\n-if the `getTrailers` callback attempts to set such header fields.\n+It is important to note that when `options.waitForTrailers` is set, the\n+`Http2Stream` will *not* automatically close when the final `DATA` frame is\n+transmitted. User code *must* call either `http2stream.sendTrailers()` or\n+`http2stream.close()` to close the `Http2Stream`.\n \n The `:method` and `:path` pseudo-headers are not specified within `headers`,\n they respectively default to:\n@@ -875,6 +876,16 @@ stream.on('trailers', (headers, flags) => {\n });\n ```\n \n+#### Event: 'wantTrailers'\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+The `'wantTrailers'` event is emitted when the `Http2Stream` has queued the\n+final `DATA` frame to be sent on a frame and the `Http2Stream` is ready to send\n+trailing headers. When initiating a request or response, the `waitForTrailers`\n+option must be set for this event to be emitted.\n+\n #### http2stream.aborted\n <!-- YAML\n added: v8.4.0\n@@ -1037,6 +1048,35 @@ Provides miscellaneous information about the current state of the\n \n A current state of this `Http2Stream`.\n \n+#### http2stream.sendTrailers(headers)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `headers` {HTTP/2 Headers Object}\n+\n+Sends a trailing `HEADERS` frame to the connected HTTP/2 peer. This method\n+will cause the `Http2Stream` to be immediately closed and must only be\n+called after the `'wantTrailers'`  event has been emitted. When sending a\n+request or sending a response, the `options.waitForTrailers` option must be set\n+in order to keep the `Http2Stream` open after the final `DATA` frame so that\n+trailers can be sent.\n+\n+```js\n+const http2 = require('http2');\n+const server = http2.createServer();\n+server.on('stream', (stream) => {\n+  stream.respond(undefined, { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ xyz: 'abc' });\n+  });\n+  stream.end('Hello World');\n+});\n+```\n+\n+The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header\n+fields (e.g. `':method'`, `':path'`, etc).\n+\n ### Class: ClientHttp2Stream\n <!-- YAML\n added: v8.4.0\n@@ -1201,8 +1241,8 @@ added: v8.4.0\n * `options` {Object}\n   * `endStream` {boolean} Set to `true` to indicate that the response will not\n     include payload data.\n-  * `getTrailers` {Function} Callback function invoked to collect trailer\n-    headers.\n+  * `waitForTrailers` {boolean} When `true`, the `Http2Stream` will emit the\n+    `'wantTrailers'` event after the final `DATA` frame has been sent.\n \n ```js\n const http2 = require('http2');\n@@ -1213,28 +1253,28 @@ server.on('stream', (stream) => {\n });\n ```\n \n-When set, the `options.getTrailers()` function is called immediately after\n-queuing the last chunk of payload data to be sent. The callback is passed a\n-single object (with a `null` prototype) that the listener may use to specify\n-the trailing header fields to send to the peer.\n+When the `options.waitForTrailers` option is set, the `'wantTrailers'` event\n+will be emitted immediately after queuing the last chunk of payload data to be\n+sent. The `http2stream.sendTrailers()` method can then be used to sent trailing\n+header fields to the peer.\n+\n+It is important to note that when `options.waitForTrailers` is set, the\n+`Http2Stream` will *not* automatically close when the final `DATA` frame is\n+transmitted. User code *must* call either `http2stream.sendTrailers()` or\n+`http2stream.close()` to close the `Http2Stream`.\n \n ```js\n const http2 = require('http2');\n const server = http2.createServer();\n server.on('stream', (stream) => {\n-  stream.respond({ ':status': 200 }, {\n-    getTrailers(trailers) {\n-      trailers.ABC = 'some value to send';\n-    }\n+  stream.respond({ ':status': 200 }, { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ ABC: 'some value to send' });\n   });\n   stream.end('some data');\n });\n ```\n \n-The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header\n-fields (e.g. `':status'`, `':path'`, etc). An `'error'` event will be emitted\n-if the `getTrailers` callback attempts to set such header fields.\n-\n #### http2stream.respondWithFD(fd[, headers[, options]])\n <!-- YAML\n added: v8.4.0\n@@ -1249,8 +1289,8 @@ changes:\n * `headers` {HTTP/2 Headers Object}\n * `options` {Object}\n   * `statCheck` {Function}\n-  * `getTrailers` {Function} Callback function invoked to collect trailer\n-    headers.\n+  * `waitForTrailers` {boolean} When `true`, the `Http2Stream` will emit the\n+    `'wantTrailers'` event after the final `DATA` frame has been sent.\n   * `offset` {number} The offset position at which to begin reading.\n   * `length` {number} The amount of data from the fd to send.\n \n@@ -1297,10 +1337,15 @@ Note that using the same file descriptor concurrently for multiple streams\n is not supported and may result in data loss. Re-using a file descriptor\n after a stream has finished is supported.\n \n-When set, the `options.getTrailers()` function is called immediately after\n-queuing the last chunk of payload data to be sent. The callback is passed a\n-single object (with a `null` prototype) that the listener may use to specify\n-the trailing header fields to send to the peer.\n+When the `options.waitForTrailers` option is set, the `'wantTrailers'` event\n+will be emitted immediately after queuing the last chunk of payload data to be\n+sent. The `http2stream.sendTrailers()` method can then be used to sent trailing\n+header fields to the peer.\n+\n+It is important to note that when `options.waitForTrailers` is set, the\n+`Http2Stream` will *not* automatically close when the final `DATA` frame is\n+transmitted. User code *must* call either `http2stream.sendTrailers()` or\n+`http2stream.close()` to close the `Http2Stream`.\n \n ```js\n const http2 = require('http2');\n@@ -1316,20 +1361,15 @@ server.on('stream', (stream) => {\n     'last-modified': stat.mtime.toUTCString(),\n     'content-type': 'text/plain'\n   };\n-  stream.respondWithFD(fd, headers, {\n-    getTrailers(trailers) {\n-      trailers.ABC = 'some value to send';\n-    }\n+  stream.respondWithFD(fd, headers, { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ ABC: 'some value to send' });\n   });\n \n   stream.on('close', () => fs.closeSync(fd));\n });\n ```\n \n-The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header\n-fields (e.g. `':status'`, `':path'`, etc). An `'error'` event will be emitted\n-if the `getTrailers` callback attempts to set such header fields.\n-\n #### http2stream.respondWithFile(path[, headers[, options]])\n <!-- YAML\n added: v8.4.0\n@@ -1346,8 +1386,8 @@ changes:\n   * `statCheck` {Function}\n   * `onError` {Function} Callback function invoked in the case of an\n     Error before send.\n-  * `getTrailers` {Function} Callback function invoked to collect trailer\n-    headers.\n+  * `waitForTrailers` {boolean} When `true`, the `Http2Stream` will emit the\n+    `'wantTrailers'` event after the final `DATA` frame has been sent.\n   * `offset` {number} The offset position at which to begin reading.\n   * `length` {number} The amount of data from the fd to send.\n \n@@ -1421,28 +1461,29 @@ The `options.onError` function may also be used to handle all the errors\n that could happen before the delivery of the file is initiated. The\n default behavior is to destroy the stream.\n \n-When set, the `options.getTrailers()` function is called immediately after\n-queuing the last chunk of payload data to be sent. The callback is passed a\n-single object (with a `null` prototype) that the listener may use to specify\n-the trailing header fields to send to the peer.\n+When the `options.waitForTrailers` option is set, the `'wantTrailers'` event\n+will be emitted immediately after queuing the last chunk of payload data to be\n+sent. The `http2stream.sendTrilers()` method can then be used to sent trailing\n+header fields to the peer.\n+\n+It is important to note that when `options.waitForTrailers` is set, the\n+`Http2Stream` will *not* automatically close when the final `DATA` frame is\n+transmitted. User code *must* call either `http2stream.sendTrailers()` or\n+`http2stream.close()` to close the `Http2Stream`.\n \n ```js\n const http2 = require('http2');\n const server = http2.createServer();\n server.on('stream', (stream) => {\n-  function getTrailers(trailers) {\n-    trailers.ABC = 'some value to send';\n-  }\n   stream.respondWithFile('/some/file',\n                          { 'content-type': 'text/plain' },\n-                         { getTrailers });\n+                         { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ ABC: 'some value to send' });\n+  });\n });\n ```\n \n-The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header\n-fields (e.g. `':status'`, `':path'`, etc). An `'error'` event will be emitted\n-if the `getTrailers` callback attempts to set such header fields.\n-\n ### Class: Http2Server\n <!-- YAML\n added: v8.4.0\n@@ -1709,7 +1750,7 @@ changes:\n     limit to be exceeded, but new `Http2Stream` instances will be rejected\n     while this limit is exceeded. The current number of `Http2Stream` sessions,\n     the current memory use of the header compression tables, current data\n-    queued to be sent, and unacknowledged PING and SETTINGS frames are all\n+    queued to be sent, and unacknowledged `PING` and `SETTINGS` frames are all\n     counted towards the current limit. **Default:** `10`.\n   * `maxHeaderListPairs` {number} Sets the maximum number of header entries.\n     The minimum value is `4`. **Default:** `128`.\n@@ -1720,7 +1761,7 @@ changes:\n     exceed this limit will result in a `'frameError'` event being emitted\n     and the stream being closed and destroyed.\n   * `paddingStrategy` {number} Identifies the strategy used for determining the\n-     amount of padding to use for HEADERS and DATA frames. **Default:**\n+     amount of padding to use for `HEADERS` and `DATA` frames. **Default:**\n      `http2.constants.PADDING_STRATEGY_NONE`. Value may be one of:\n      * `http2.constants.PADDING_STRATEGY_NONE` - Specifies that no padding is\n        to be applied.\n@@ -1738,7 +1779,7 @@ changes:\n        calculated amount needed to ensure alignment, the maximum will be used\n        and the total frame length will *not* necessarily be aligned at 8 bytes.\n   * `peerMaxConcurrentStreams` {number} Sets the maximum number of concurrent\n-    streams for the remote peer as if a SETTINGS frame had been received. Will\n+    streams for the remote peer as if a `SETTINGS` frame had been received. Will\n     be overridden if the remote peer sets its own value for\n     `maxConcurrentStreams`. **Default:** `100`.\n   * `selectPadding` {Function} When `options.paddingStrategy` is equal to\n@@ -1819,7 +1860,7 @@ changes:\n     limit to be exceeded, but new `Http2Stream` instances will be rejected\n     while this limit is exceeded. The current number of `Http2Stream` sessions,\n     the current memory use of the header compression tables, current data\n-    queued to be sent, and unacknowledged PING and SETTINGS frames are all\n+    queued to be sent, and unacknowledged `PING` and `SETTINGS` frames are all\n     counted towards the current limit. **Default:** `10`.\n   * `maxHeaderListPairs` {number} Sets the maximum number of header entries.\n     The minimum value is `4`. **Default:** `128`.\n@@ -1830,7 +1871,7 @@ changes:\n     exceed this limit will result in a `'frameError'` event being emitted\n     and the stream being closed and destroyed.\n   * `paddingStrategy` {number} Identifies the strategy used for determining the\n-     amount of padding to use for HEADERS and DATA frames. **Default:**\n+     amount of padding to use for `HEADERS` and `DATA` frames. **Default:**\n      `http2.constants.PADDING_STRATEGY_NONE`. Value may be one of:\n      * `http2.constants.PADDING_STRATEGY_NONE` - Specifies that no padding is\n        to be applied.\n@@ -1848,7 +1889,7 @@ changes:\n        calculated amount needed to ensure alignment, the maximum will be used\n        and the total frame length will *not* necessarily be aligned at 8 bytes.\n   * `peerMaxConcurrentStreams` {number} Sets the maximum number of concurrent\n-    streams for the remote peer as if a SETTINGS frame had been received. Will\n+    streams for the remote peer as if a `SETTINGS` frame had been received. Will\n     be overridden if the remote peer sets its own value for\n     `maxConcurrentStreams`. **Default:** `100`.\n   * `selectPadding` {Function} When `options.paddingStrategy` is equal to\n@@ -1911,7 +1952,7 @@ changes:\n     limit to be exceeded, but new `Http2Stream` instances will be rejected\n     while this limit is exceeded. The current number of `Http2Stream` sessions,\n     the current memory use of the header compression tables, current data\n-    queued to be sent, and unacknowledged PING and SETTINGS frames are all\n+    queued to be sent, and unacknowledged `PING` and `SETTINGS` frames are all\n     counted towards the current limit. **Default:** `10`.\n   * `maxHeaderListPairs` {number} Sets the maximum number of header entries.\n     The minimum value is `1`. **Default:** `128`.\n@@ -1926,7 +1967,7 @@ changes:\n     exceed this limit will result in a `'frameError'` event being emitted\n     and the stream being closed and destroyed.\n   * `paddingStrategy` {number} Identifies the strategy used for determining the\n-     amount of padding to use for HEADERS and DATA frames. **Default:**\n+     amount of padding to use for `HEADERS` and `DATA` frames. **Default:**\n      `http2.constants.PADDING_STRATEGY_NONE`. Value may be one of:\n      * `http2.constants.PADDING_STRATEGY_NONE` - Specifies that no padding is\n        to be applied.\n@@ -1944,7 +1985,7 @@ changes:\n        calculated amount needed to ensure alignment, the maximum will be used\n        and the total frame length will *not* necessarily be aligned at 8 bytes.\n   * `peerMaxConcurrentStreams` {number} Sets the maximum number of concurrent\n-    streams for the remote peer as if a SETTINGS frame had been received. Will\n+    streams for the remote peer as if a `SETTINGS` frame had been received. Will\n     be overridden if the remote peer sets its own value for\n     `maxConcurrentStreams`. **Default:** `100`.\n   * `selectPadding` {Function} When `options.paddingStrategy` is equal to\n@@ -2115,7 +2156,7 @@ All additional properties on the settings object are ignored.\n When `options.paddingStrategy` is equal to\n `http2.constants.PADDING_STRATEGY_CALLBACK`, the HTTP/2 implementation will\n consult the `options.selectPadding` callback function, if provided, to determine\n-the specific amount of padding to use per HEADERS and DATA frame.\n+the specific amount of padding to use per `HEADERS` and `DATA` frame.\n \n The `options.selectPadding` function receives two numeric arguments,\n `frameLen` and `maxFrameLen` and must return a number `N` such that\n@@ -2131,8 +2172,8 @@ const server = http2.createServer({\n });\n ```\n \n-The `options.selectPadding` function is invoked once for *every* HEADERS and\n-DATA frame. This has a definite noticeable impact on performance.\n+The `options.selectPadding` function is invoked once for *every* `HEADERS` and\n+`DATA` frame. This has a definite noticeable impact on performance.\n \n ### Error Handling\n \n@@ -3093,9 +3134,9 @@ The `name` property of the `PerformanceEntry` will be equal to either\n If `name` is equal to `Http2Stream`, the `PerformanceEntry` will contain the\n following additional properties:\n \n-* `bytesRead` {number} The number of DATA frame bytes received for this\n+* `bytesRead` {number} The number of `DATA` frame bytes received for this\n   `Http2Stream`.\n-* `bytesWritten` {number} The number of DATA frame bytes sent for this\n+* `bytesWritten` {number} The number of `DATA` frame bytes sent for this\n   `Http2Stream`.\n * `id` {number} The identifier of the associated `Http2Stream`\n * `timeToFirstByte` {number} The number of milliseconds elapsed between the"
        },
        {
            "sha": "d2205a4c71b3da7754a358581fbe0131ccb500ad",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -842,6 +842,11 @@ E('ERR_HTTP2_STREAM_CANCEL', 'The pending stream has been canceled', Error);\n E('ERR_HTTP2_STREAM_ERROR', 'Stream closed with error code %s', Error);\n E('ERR_HTTP2_STREAM_SELF_DEPENDENCY',\n   'A stream cannot depend on itself', Error);\n+E('ERR_HTTP2_TRAILERS_ALREADY_SENT',\n+  'Trailing headers have already been sent', Error);\n+E('ERR_HTTP2_TRAILERS_NOT_READY',\n+  'Trailing headers cannot be sent until after the wantTrailers event is ' +\n+  'emitted', Error);\n E('ERR_HTTP2_UNSUPPORTED_PROTOCOL', 'protocol \"%s\" is unsupported.', Error);\n E('ERR_HTTP_HEADERS_SENT',\n   'Cannot %s headers after they are sent to the client', Error);"
        },
        {
            "sha": "0bdbe7b69fdf1009dcdd4e87eae2caea580297c7",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -358,6 +358,10 @@ class Http2ServerRequest extends Readable {\n   }\n }\n \n+function onStreamTrailersReady() {\n+  this[kStream].sendTrailers(this[kTrailers]);\n+}\n+\n class Http2ServerResponse extends Stream {\n   constructor(stream, options) {\n     super(options);\n@@ -377,6 +381,7 @@ class Http2ServerResponse extends Stream {\n     stream.on('drain', onStreamDrain);\n     stream.on('aborted', onStreamAbortedResponse);\n     stream.on('close', this[kFinish].bind(this));\n+    stream.on('wantTrailers', onStreamTrailersReady.bind(this));\n   }\n \n   // User land modules such as finalhandler just check truthiness of this\n@@ -648,7 +653,7 @@ class Http2ServerResponse extends Stream {\n     headers[HTTP2_HEADER_STATUS] = state.statusCode;\n     const options = {\n       endStream: state.ending,\n-      getTrailers: (trailers) => Object.assign(trailers, this[kTrailers])\n+      waitForTrailers: true,\n     };\n     this[kStream].respond(headers, options);\n   }"
        },
        {
            "sha": "495fa60ba39ce33b1939a08888c9bdf6270a5764",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 43,
            "deletions": 42,
            "changes": 85,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -49,6 +49,8 @@ const {\n     ERR_HTTP2_STREAM_CANCEL,\n     ERR_HTTP2_STREAM_ERROR,\n     ERR_HTTP2_STREAM_SELF_DEPENDENCY,\n+    ERR_HTTP2_TRAILERS_ALREADY_SENT,\n+    ERR_HTTP2_TRAILERS_NOT_READY,\n     ERR_HTTP2_UNSUPPORTED_PROTOCOL,\n     ERR_INVALID_ARG_TYPE,\n     ERR_INVALID_CALLBACK,\n@@ -295,25 +297,18 @@ function tryClose(fd) {\n   fs.close(fd, (err) => assert.ifError(err));\n }\n \n-// Called to determine if there are trailers to be sent at the end of a\n-// Stream. The 'getTrailers' callback is invoked and passed a holder object.\n-// The trailers to return are set on that object by the handler. Once the\n-// event handler returns, those are sent off for processing. Note that this\n-// is a necessarily synchronous operation. We need to know immediately if\n-// there are trailing headers to send.\n+// Called when the Http2Stream has finished sending data and is ready for\n+// trailers to be sent. This will only be called if the { hasOptions: true }\n+// option is set.\n function onStreamTrailers() {\n   const stream = this[kOwner];\n+  stream[kState].trailersReady = true;\n   if (stream.destroyed)\n-    return [];\n-  const trailers = Object.create(null);\n-  stream[kState].getTrailers.call(stream, trailers);\n-  const headersList = mapToHeaders(trailers, assertValidPseudoHeaderTrailer);\n-  if (!Array.isArray(headersList)) {\n-    stream.destroy(headersList);\n-    return [];\n+    return;\n+  if (!stream.emit('wantTrailers')) {\n+    // There are no listeners, send empty trailing HEADERS frame and close.\n+    stream.sendTrailers({});\n   }\n-  stream[kSentTrailers] = trailers;\n-  return headersList;\n }\n \n // Submit an RST-STREAM frame to be sent to the remote peer.\n@@ -527,10 +522,8 @@ function requestOnConnect(headers, options) {\n   if (options.endStream)\n     streamOptions |= STREAM_OPTION_EMPTY_PAYLOAD;\n \n-  if (typeof options.getTrailers === 'function') {\n+  if (options.waitForTrailers)\n     streamOptions |= STREAM_OPTION_GET_TRAILERS;\n-    this[kState].getTrailers = options.getTrailers;\n-  }\n \n   // ret will be either the reserved stream ID (if positive)\n   // or an error code (if negative)\n@@ -1408,11 +1401,6 @@ class ClientHttp2Session extends Http2Session {\n       throw new ERR_INVALID_OPT_VALUE('endStream', options.endStream);\n     }\n \n-    if (options.getTrailers !== undefined &&\n-      typeof options.getTrailers !== 'function') {\n-      throw new ERR_INVALID_OPT_VALUE('getTrailers', options.getTrailers);\n-    }\n-\n     const headersList = mapToHeaders(headers);\n     if (!Array.isArray(headersList))\n       throw headersList;\n@@ -1504,7 +1492,8 @@ class Http2Stream extends Duplex {\n     this[kState] = {\n       flags: STREAM_FLAGS_PENDING,\n       rstCode: NGHTTP2_NO_ERROR,\n-      writeQueueSize: 0\n+      writeQueueSize: 0,\n+      trailersReady: false\n     };\n \n     this.on('resume', streamOnResume);\n@@ -1745,6 +1734,33 @@ class Http2Stream extends Duplex {\n     priorityFn();\n   }\n \n+  sendTrailers(headers) {\n+    if (this.destroyed || this.closed)\n+      throw new ERR_HTTP2_INVALID_STREAM();\n+    if (this[kSentTrailers])\n+      throw new ERR_HTTP2_TRAILERS_ALREADY_SENT();\n+    if (!this[kState].trailersReady)\n+      throw new ERR_HTTP2_TRAILERS_NOT_READY();\n+\n+    assertIsObject(headers, 'headers');\n+    headers = Object.assign(Object.create(null), headers);\n+\n+    const session = this[kSession];\n+    debug(`Http2Stream ${this[kID]} [Http2Session ` +\n+    `${sessionName(session[kType])}]: sending trailers`);\n+\n+    this[kUpdateTimer]();\n+\n+    const headersList = mapToHeaders(headers, assertValidPseudoHeaderTrailer);\n+    if (!Array.isArray(headersList))\n+      throw headersList;\n+    this[kSentTrailers] = headers;\n+\n+    const ret = this[kHandle].trailers(headersList);\n+    if (ret < 0)\n+      this.destroy(new NghttpError(ret));\n+  }\n+\n   get closed() {\n     return !!(this[kState].flags & STREAM_FLAGS_CLOSED);\n   }\n@@ -2208,13 +2224,8 @@ class ServerHttp2Stream extends Http2Stream {\n     if (options.endStream)\n       streamOptions |= STREAM_OPTION_EMPTY_PAYLOAD;\n \n-    if (options.getTrailers !== undefined) {\n-      if (typeof options.getTrailers !== 'function') {\n-        throw new ERR_INVALID_OPT_VALUE('getTrailers', options.getTrailers);\n-      }\n+    if (options.waitForTrailers)\n       streamOptions |= STREAM_OPTION_GET_TRAILERS;\n-      state.getTrailers = options.getTrailers;\n-    }\n \n     headers = processHeaders(headers);\n     const statusCode = headers[HTTP2_HEADER_STATUS] |= 0;\n@@ -2274,13 +2285,8 @@ class ServerHttp2Stream extends Http2Stream {\n     }\n \n     let streamOptions = 0;\n-    if (options.getTrailers !== undefined) {\n-      if (typeof options.getTrailers !== 'function') {\n-        throw new ERR_INVALID_OPT_VALUE('getTrailers', options.getTrailers);\n-      }\n+    if (options.waitForTrailers)\n       streamOptions |= STREAM_OPTION_GET_TRAILERS;\n-      this[kState].getTrailers = options.getTrailers;\n-    }\n \n     if (typeof fd !== 'number')\n       throw new ERR_INVALID_ARG_TYPE('fd', 'number', fd);\n@@ -2340,13 +2346,8 @@ class ServerHttp2Stream extends Http2Stream {\n     }\n \n     let streamOptions = 0;\n-    if (options.getTrailers !== undefined) {\n-      if (typeof options.getTrailers !== 'function') {\n-        throw new ERR_INVALID_OPT_VALUE('getTrailers', options.getTrailers);\n-      }\n+    if (options.waitForTrailers)\n       streamOptions |= STREAM_OPTION_GET_TRAILERS;\n-      this[kState].getTrailers = options.getTrailers;\n-    }\n \n     const session = this[kSession];\n     debug(`Http2Stream ${this[kID]} [Http2Session ` +"
        },
        {
            "sha": "1c5c68f09471f3138caf2b4a53d9679be9d99c7b",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 40,
            "deletions": 60,
            "changes": 100,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -1066,16 +1066,6 @@ int Http2Session::OnNghttpError(nghttp2_session* handle,\n   return 0;\n }\n \n-// Once all of the DATA frames for a Stream have been sent, the GetTrailers\n-// method calls out to JavaScript to fetch the trailing headers that need\n-// to be sent.\n-void Http2Session::GetTrailers(Http2Stream* stream, uint32_t* flags) {\n-  if (!stream->IsDestroyed() && stream->HasTrailers()) {\n-    Http2Stream::SubmitTrailers submit_trailers{this, stream, flags};\n-    stream->OnTrailers(submit_trailers);\n-  }\n-}\n-\n uv_buf_t Http2StreamListener::OnStreamAlloc(size_t size) {\n   // See the comments in Http2Session::OnDataChunkReceived\n   // (which is the only possible call site for this method).\n@@ -1111,25 +1101,6 @@ void Http2StreamListener::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n   stream->CallJSOnreadMethod(nread, buffer);\n }\n \n-Http2Stream::SubmitTrailers::SubmitTrailers(\n-    Http2Session* session,\n-    Http2Stream* stream,\n-    uint32_t* flags)\n-  : session_(session), stream_(stream), flags_(flags) { }\n-\n-\n-void Http2Stream::SubmitTrailers::Submit(nghttp2_nv* trailers,\n-                                         size_t length) const {\n-  Http2Scope h2scope(session_);\n-  if (length == 0)\n-    return;\n-  DEBUG_HTTP2SESSION2(session_, \"sending trailers for stream %d, count: %d\",\n-                      stream_->id(), length);\n-  *flags_ |= NGHTTP2_DATA_FLAG_NO_END_STREAM;\n-  CHECK_EQ(\n-      nghttp2_submit_trailer(**session_, stream_->id(), trailers, length), 0);\n-}\n-\n \n // Called by OnFrameReceived to notify JavaScript land that a complete\n // HEADERS frame has been received and processed. This method converts the\n@@ -1725,30 +1696,6 @@ nghttp2_stream* Http2Stream::operator*() {\n   return nghttp2_session_find_stream(**session_, id_);\n }\n \n-\n-// Calls out to JavaScript land to fetch the actual trailer headers to send\n-// for this stream.\n-void Http2Stream::OnTrailers(const SubmitTrailers& submit_trailers) {\n-  DEBUG_HTTP2STREAM(this, \"prompting for trailers\");\n-  CHECK(!this->IsDestroyed());\n-  Isolate* isolate = env()->isolate();\n-  HandleScope scope(isolate);\n-  Local<Context> context = env()->context();\n-  Context::Scope context_scope(context);\n-\n-  Local<Value> ret =\n-      MakeCallback(env()->ontrailers_string(), 0, nullptr).ToLocalChecked();\n-  if (!ret.IsEmpty() && !IsDestroyed()) {\n-    if (ret->IsArray()) {\n-      Local<Array> headers = ret.As<Array>();\n-      if (headers->Length() > 0) {\n-        Headers trailers(isolate, context, headers);\n-        submit_trailers.Submit(*trailers, trailers.length());\n-      }\n-    }\n-  }\n-}\n-\n void Http2Stream::Close(int32_t code) {\n   CHECK(!this->IsDestroyed());\n   flags_ |= NGHTTP2_STREAM_FLAG_CLOSED;\n@@ -1843,6 +1790,26 @@ int Http2Stream::SubmitInfo(nghttp2_nv* nva, size_t len) {\n   return ret;\n }\n \n+void Http2Stream::OnTrailers() {\n+  DEBUG_HTTP2STREAM(this, \"let javascript know we are ready for trailers\");\n+  CHECK(!this->IsDestroyed());\n+  Isolate* isolate = env()->isolate();\n+  HandleScope scope(isolate);\n+  Local<Context> context = env()->context();\n+  Context::Scope context_scope(context);\n+  MakeCallback(env()->ontrailers_string(), 0, nullptr);\n+}\n+\n+// Submit informational headers for a stream.\n+int Http2Stream::SubmitTrailers(nghttp2_nv* nva, size_t len) {\n+  CHECK(!this->IsDestroyed());\n+  Http2Scope h2scope(this);\n+  DEBUG_HTTP2STREAM2(this, \"sending %d trailers\", len);\n+  int ret = nghttp2_submit_trailer(**session_, id_, nva, len);\n+  CHECK_NE(ret, NGHTTP2_ERR_NOMEM);\n+  return ret;\n+}\n+\n // Submit a PRIORITY frame to the connected peer.\n int Http2Stream::SubmitPriority(nghttp2_priority_spec* prispec,\n                                 bool silent) {\n@@ -2068,13 +2035,10 @@ ssize_t Http2Stream::Provider::Stream::OnRead(nghttp2_session* handle,\n   if (stream->queue_.empty() && !stream->IsWritable()) {\n     DEBUG_HTTP2SESSION2(session, \"no more data for stream %d\", id);\n     *flags |= NGHTTP2_DATA_FLAG_EOF;\n-    session->GetTrailers(stream, flags);\n-    // If the stream or session gets destroyed during the GetTrailers\n-    // callback, check that here and close down the stream\n-    if (stream->IsDestroyed())\n-      return NGHTTP2_ERR_TEMPORAL_CALLBACK_FAILURE;\n-    if (session->IsDestroyed())\n-      return NGHTTP2_ERR_CALLBACK_FAILURE;\n+    if (stream->HasTrailers()) {\n+      *flags |= NGHTTP2_DATA_FLAG_NO_END_STREAM;\n+      stream->OnTrailers();\n+    }\n   }\n \n   stream->statistics_.sent_bytes += amount;\n@@ -2361,6 +2325,21 @@ void Http2Stream::Info(const FunctionCallbackInfo<Value>& args) {\n                      headers->Length());\n }\n \n+// Submits trailing headers on the Http2Stream\n+void Http2Stream::Trailers(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Local<Context> context = env->context();\n+  Isolate* isolate = env->isolate();\n+  Http2Stream* stream;\n+  ASSIGN_OR_RETURN_UNWRAP(&stream, args.Holder());\n+\n+  Local<Array> headers = args[0].As<Array>();\n+\n+  Headers list(isolate, context, headers);\n+  args.GetReturnValue().Set(stream->SubmitTrailers(*list, list.length()));\n+  DEBUG_HTTP2STREAM2(stream, \"%d trailing headers sent\", headers->Length());\n+}\n+\n // Grab the numeric id of the Http2Stream\n void Http2Stream::GetID(const FunctionCallbackInfo<Value>& args) {\n   Http2Stream* stream;\n@@ -2706,6 +2685,7 @@ void Initialize(Local<Object> target,\n   env->SetProtoMethod(stream, \"priority\", Http2Stream::Priority);\n   env->SetProtoMethod(stream, \"pushPromise\", Http2Stream::PushPromise);\n   env->SetProtoMethod(stream, \"info\", Http2Stream::Info);\n+  env->SetProtoMethod(stream, \"trailers\", Http2Stream::Trailers);\n   env->SetProtoMethod(stream, \"respond\", Http2Stream::Respond);\n   env->SetProtoMethod(stream, \"rstStream\", Http2Stream::RstStream);\n   env->SetProtoMethod(stream, \"refreshState\", Http2Stream::RefreshState);"
        },
        {
            "sha": "87c929cdea12f9036d58116042062aac07338b58",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 5,
            "deletions": 21,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -581,6 +581,10 @@ class Http2Stream : public AsyncWrap,\n   // Submit informational headers for this stream\n   int SubmitInfo(nghttp2_nv* nva, size_t len);\n \n+  // Submit trailing headers for this stream\n+  int SubmitTrailers(nghttp2_nv* nva, size_t len);\n+  void OnTrailers();\n+\n   // Submit a PRIORITY frame for this stream\n   int SubmitPriority(nghttp2_priority_spec* prispec, bool silent = false);\n \n@@ -670,25 +674,6 @@ class Http2Stream : public AsyncWrap,\n \n   size_t self_size() const override { return sizeof(*this); }\n \n-  // Handling Trailer Headers\n-  class SubmitTrailers {\n-   public:\n-    void Submit(nghttp2_nv* trailers, size_t length) const;\n-\n-    SubmitTrailers(Http2Session* sesion,\n-                   Http2Stream* stream,\n-                   uint32_t* flags);\n-\n-   private:\n-    Http2Session* const session_;\n-    Http2Stream* const stream_;\n-    uint32_t* const flags_;\n-\n-    friend class Http2Stream;\n-  };\n-\n-  void OnTrailers(const SubmitTrailers& submit_trailers);\n-\n   // JavaScript API\n   static void GetID(const FunctionCallbackInfo<Value>& args);\n   static void Destroy(const FunctionCallbackInfo<Value>& args);\n@@ -697,6 +682,7 @@ class Http2Stream : public AsyncWrap,\n   static void PushPromise(const FunctionCallbackInfo<Value>& args);\n   static void RefreshState(const FunctionCallbackInfo<Value>& args);\n   static void Info(const FunctionCallbackInfo<Value>& args);\n+  static void Trailers(const FunctionCallbackInfo<Value>& args);\n   static void Respond(const FunctionCallbackInfo<Value>& args);\n   static void RstStream(const FunctionCallbackInfo<Value>& args);\n \n@@ -859,8 +845,6 @@ class Http2Session : public AsyncWrap, public StreamListener {\n \n   size_t self_size() const override { return sizeof(*this); }\n \n-  void GetTrailers(Http2Stream* stream, uint32_t* flags);\n-\n   // Handle reads/writes from the underlying network transport.\n   void OnStreamRead(ssize_t nread, const uv_buf_t& buf) override;\n   void OnStreamAfterWrite(WriteWrap* w, int status) override;"
        },
        {
            "sha": "d170443f72848e9ed7e22d0e67994b6f07956c6f",
            "filename": "test/parallel/test-http2-client-request-options-errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-client-request-options-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-client-request-options-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-request-options-errors.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -10,7 +10,6 @@ const http2 = require('http2');\n \n const optionsToTest = {\n   endStream: 'boolean',\n-  getTrailers: 'function',\n   weight: 'number',\n   parent: 'number',\n   exclusive: 'boolean',"
        },
        {
            "sha": "735ff1345e1a39e5cf0bd44694925d9377aaeab0",
            "filename": "test/parallel/test-http2-compat-serverrequest-trailers.js",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-compat-serverrequest-trailers.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-compat-serverrequest-trailers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverrequest-trailers.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -50,15 +50,18 @@ server.listen(0, common.mustCall(function() {\n       ':scheme': 'http',\n       ':authority': `localhost:${port}`\n     };\n-    const request = client.request(headers, {\n-      getTrailers(trailers) {\n-        trailers['x-fOo'] = 'xOxOxOx';\n-        trailers['x-foO'] = 'OxOxOxO';\n-        trailers['X-fOo'] = 'xOxOxOx';\n-        trailers['X-foO'] = 'OxOxOxO';\n-        trailers['x-foo-test'] = 'test, test';\n-      }\n+    const request = client.request(headers, { waitForTrailers: true });\n+\n+    request.on('wantTrailers', () => {\n+      request.sendTrailers({\n+        'x-fOo': 'xOxOxOx',\n+        'x-foO': 'OxOxOxO',\n+        'X-fOo': 'xOxOxOx',\n+        'X-foO': 'OxOxOxO',\n+        'x-foo-test': 'test, test'\n+      });\n     });\n+\n     request.resume();\n     request.on('end', common.mustCall(function() {\n       server.close();"
        },
        {
            "sha": "1992d41af69a5d0463c6810acbb7b52425ff4b9d",
            "filename": "test/parallel/test-http2-compat-serverresponse-createpushresponse.js",
            "status": "modified",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-compat-serverresponse-createpushresponse.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-compat-serverresponse-createpushresponse.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-createpushresponse.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -28,6 +28,15 @@ const server = h2.createServer((request, response) => {\n     }\n   );\n \n+  response.stream.on('close', () => {\n+    response.createPushResponse({\n+      ':path': '/pushed',\n+      ':method': 'GET'\n+    }, common.mustCall((error) => {\n+      assert.strictEqual(error.code, 'ERR_HTTP2_INVALID_STREAM');\n+    }));\n+  });\n+\n   response.createPushResponse({\n     ':path': '/pushed',\n     ':method': 'GET'\n@@ -36,16 +45,6 @@ const server = h2.createServer((request, response) => {\n     assert.strictEqual(push.stream.id % 2, 0);\n     push.end(pushExpect);\n     response.end();\n-\n-    // wait for a tick, so the stream is actually closed\n-    setImmediate(function() {\n-      response.createPushResponse({\n-        ':path': '/pushed',\n-        ':method': 'GET'\n-      }, common.mustCall((error) => {\n-        assert.strictEqual(error.code, 'ERR_HTTP2_INVALID_STREAM');\n-      }));\n-    });\n   }));\n });\n "
        },
        {
            "sha": "c1ae37b9a36938e9208724641df91507c83fe87c",
            "filename": "test/parallel/test-http2-misused-pseudoheaders.js",
            "status": "modified",
            "additions": 9,
            "deletions": 14,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -20,16 +20,17 @@ server.on('stream', common.mustCall((stream) => {\n                         });\n   });\n \n-  stream.respond({}, {\n-    getTrailers: common.mustCall((trailers) => {\n-      trailers[':status'] = 'bar';\n-    })\n+  stream.respond({}, { waitForTrailers: true });\n+\n+  stream.on('wantTrailers', () => {\n+    common.expectsError(() => {\n+      stream.sendTrailers({ ':status': 'bar' });\n+    }, {\n+      code: 'ERR_HTTP2_INVALID_PSEUDOHEADER'\n+    });\n+    stream.close();\n   });\n \n-  stream.on('error', common.expectsError({\n-    code: 'ERR_HTTP2_INVALID_PSEUDOHEADER'\n-  }));\n-\n   stream.end('hello world');\n }));\n \n@@ -38,12 +39,6 @@ server.listen(0, common.mustCall(() => {\n   const client = h2.connect(`http://localhost:${server.address().port}`);\n   const req = client.request();\n \n-  req.on('error', common.expectsError({\n-    code: 'ERR_HTTP2_STREAM_ERROR',\n-    type: Error,\n-    message: 'Stream closed with error code NGHTTP2_INTERNAL_ERROR'\n-  }));\n-\n   req.on('response', common.mustCall());\n   req.resume();\n   req.on('end', common.mustCall());"
        },
        {
            "sha": "7ba25d0e491e1582f0d5463641cd49690fef1665",
            "filename": "test/parallel/test-http2-no-wanttrailers-listener.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-no-wanttrailers-listener.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-no-wanttrailers-listener.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-no-wanttrailers-listener.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const h2 = require('http2');\n+\n+const server = h2.createServer();\n+\n+// we use the lower-level API here\n+server.on('stream', common.mustCall(onStream));\n+\n+function onStream(stream, headers, flags) {\n+  stream.respond(undefined, { waitForTrailers: true });\n+  // There is no wantTrailers handler so this should close naturally\n+  // without hanging. If the test completes without timing out, then\n+  // it passes.\n+  stream.end('ok');\n+}\n+\n+server.listen(0);\n+\n+server.on('listening', common.mustCall(function() {\n+  const client = h2.connect(`http://localhost:${this.address().port}`);\n+  const req = client.request();\n+  req.resume();\n+  req.on('trailers', common.mustCall((headers) => {\n+    assert.strictEqual(Object.keys(headers).length, 0);\n+  }));\n+  req.on('close', common.mustCall(() => {\n+    server.close();\n+    client.close();\n+  }));\n+}));"
        },
        {
            "sha": "fa8a98b83f15add8265293033456ec956d03eb8c",
            "filename": "test/parallel/test-http2-respond-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 36,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-errors.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -7,48 +7,13 @@ if (!common.hasCrypto)\n const http2 = require('http2');\n const { Http2Stream } = process.binding('http2');\n \n-const types = {\n-  boolean: true,\n-  function: () => {},\n-  number: 1,\n-  object: {},\n-  array: [],\n-  null: null,\n-  symbol: Symbol('test')\n-};\n-\n const server = http2.createServer();\n \n Http2Stream.prototype.respond = () => 1;\n server.on('stream', common.mustCall((stream) => {\n \n-  // Check for all possible TypeError triggers on options.getTrailers\n-  Object.entries(types).forEach(([type, value]) => {\n-    if (type === 'function') {\n-      return;\n-    }\n-\n-    common.expectsError(\n-      () => stream.respond({\n-        'content-type': 'text/plain'\n-      }, {\n-        ['getTrailers']: value\n-      }),\n-      {\n-        type: TypeError,\n-        code: 'ERR_INVALID_OPT_VALUE',\n-        message: `The value \"${String(value)}\" is invalid ` +\n-                  'for option \"getTrailers\"'\n-      }\n-    );\n-  });\n-\n   // Send headers\n-  stream.respond({\n-    'content-type': 'text/plain'\n-  }, {\n-    ['getTrailers']: () => common.mustCall()\n-  });\n+  stream.respond({ 'content-type': 'text/plain' });\n \n   // Should throw if headers already sent\n   common.expectsError("
        },
        {
            "sha": "96dd579a154fe7022e2ed72eed7c6c64bd4c2781",
            "filename": "test/parallel/test-http2-respond-file-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-file-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-file-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-errors.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -9,8 +9,7 @@ const http2 = require('http2');\n const optionsWithTypeError = {\n   offset: 'number',\n   length: 'number',\n-  statCheck: 'function',\n-  getTrailers: 'function'\n+  statCheck: 'function'\n };\n \n const types = {"
        },
        {
            "sha": "078d0eb11e451d8b9a8a1c84901336cc86fb9b38",
            "filename": "test/parallel/test-http2-respond-file-fd-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-file-fd-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-respond-file-fd-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-fd-errors.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -10,8 +10,7 @@ const fs = require('fs');\n const optionsWithTypeError = {\n   offset: 'number',\n   length: 'number',\n-  statCheck: 'function',\n-  getTrailers: 'function'\n+  statCheck: 'function'\n };\n \n const types = {"
        },
        {
            "sha": "6ec674394336f2a0b55e58acb555f703642185dc",
            "filename": "test/parallel/test-http2-sent-headers.js",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-sent-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-sent-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-sent-headers.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -12,10 +12,9 @@ server.on('stream', common.mustCall((stream) => {\n   stream.additionalHeaders({ ':status': 102 });\n   assert.strictEqual(stream.sentInfoHeaders[0][':status'], 102);\n \n-  stream.respond({ abc: 'xyz' }, {\n-    getTrailers(headers) {\n-      headers.xyz = 'abc';\n-    }\n+  stream.respond({ abc: 'xyz' }, { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ xyz: 'abc' });\n   });\n   assert.strictEqual(stream.sentHeaders.abc, 'xyz');\n   assert.strictEqual(stream.sentHeaders[':status'], 200);"
        },
        {
            "sha": "2b7f6158ca39516794c383267d29c593ebdaea7f",
            "filename": "test/parallel/test-http2-trailers.js",
            "status": "modified",
            "additions": 31,
            "deletions": 9,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-trailers.js",
            "raw_url": "https://github.com/nodejs/node/raw/237aa7e9ae850bbaf39563b368bc617468f2136d/test%2Fparallel%2Ftest-http2-trailers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-trailers.js?ref=237aa7e9ae850bbaf39563b368bc617468f2136d",
            "patch": "@@ -22,28 +22,50 @@ function onStream(stream, headers, flags) {\n   stream.respond({\n     'content-type': 'text/html',\n     ':status': 200\n-  }, {\n-    getTrailers: common.mustCall((trailers) => {\n-      trailers[trailerKey] = trailerValue;\n-    })\n+  }, { waitForTrailers: true });\n+  stream.on('wantTrailers', () => {\n+    stream.sendTrailers({ [trailerKey]: trailerValue });\n+    common.expectsError(\n+      () => stream.sendTrailers({}),\n+      {\n+        code: 'ERR_HTTP2_TRAILERS_ALREADY_SENT',\n+        type: Error\n+      }\n+    );\n   });\n+\n+  common.expectsError(\n+    () => stream.sendTrailers({}),\n+    {\n+      code: 'ERR_HTTP2_TRAILERS_NOT_READY',\n+      type: Error\n+    }\n+  );\n+\n   stream.end(body);\n }\n \n server.listen(0);\n \n server.on('listening', common.mustCall(function() {\n   const client = h2.connect(`http://localhost:${this.address().port}`);\n-  const req = client.request({ ':path': '/', ':method': 'POST' }, {\n-    getTrailers: common.mustCall((trailers) => {\n-      trailers[trailerKey] = trailerValue;\n-    })\n+  const req = client.request({ ':path': '/', ':method': 'POST' },\n+                             { waitForTrailers: true });\n+  req.on('wantTrailers', () => {\n+    req.sendTrailers({ [trailerKey]: trailerValue });\n   });\n   req.on('data', common.mustCall());\n   req.on('trailers', common.mustCall((headers) => {\n     assert.strictEqual(headers[trailerKey], trailerValue);\n   }));\n-  req.on('end', common.mustCall(() => {\n+  req.on('close', common.mustCall(() => {\n+    common.expectsError(\n+      () => req.sendTrailers({}),\n+      {\n+        code: 'ERR_HTTP2_INVALID_STREAM',\n+        type: Error\n+      }\n+    );\n     server.close();\n     client.close();\n   }));"
        }
    ],
    "stats": {
        "total": 614,
        "additions": 329,
        "deletions": 285
    }
}