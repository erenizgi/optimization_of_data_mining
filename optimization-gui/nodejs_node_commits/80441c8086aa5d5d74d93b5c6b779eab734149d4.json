{
    "author": "lundibundi",
    "message": "src,test: fix JSON escaping in node-report\n\nPreviously only simple escape sequences were handled\n(i.e. \\n, \\t, r etc.). This commit adds escaping of other control\nsymbols in the range of 0x00 to 0x20.\n\nAlso, this replaces multiple find+replace calls with a single pass\nreplacer.\n\nPR-URL: https://github.com/nodejs/node/pull/25626\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "80441c8086aa5d5d74d93b5c6b779eab734149d4",
    "files": [
        {
            "sha": "d762b8c30152012b04c0b06797765c2818363eed",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/80441c8086aa5d5d74d93b5c6b779eab734149d4/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/80441c8086aa5d5d74d93b5c6b779eab734149d4/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=80441c8086aa5d5d74d93b5c6b779eab734149d4",
            "patch": "@@ -980,6 +980,7 @@\n         'test/cctest/test_node_postmortem_metadata.cc',\n         'test/cctest/test_environment.cc',\n         'test/cctest/test_platform.cc',\n+        'test/cctest/test_report_util.cc',\n         'test/cctest/test_traced_value.cc',\n         'test/cctest/test_util.cc',\n         'test/cctest/test_url.cc'"
        },
        {
            "sha": "75eb33250a2f987d2c0a2f7fa2a6912e802b9790",
            "filename": "src/node_report_utils.cc",
            "status": "modified",
            "additions": 33,
            "deletions": 20,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/80441c8086aa5d5d74d93b5c6b779eab734149d4/src%2Fnode_report_utils.cc",
            "raw_url": "https://github.com/nodejs/node/raw/80441c8086aa5d5d74d93b5c6b779eab734149d4/src%2Fnode_report_utils.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_report_utils.cc?ref=80441c8086aa5d5d74d93b5c6b779eab734149d4",
            "patch": "@@ -214,28 +214,41 @@ void WalkHandle(uv_handle_t* h, void* arg) {\n   writer->json_end();\n }\n \n-static std::string findAndReplace(const std::string& str,\n-                                  const std::string& old,\n-                                  const std::string& neu) {\n-  std::string ret = str;\n+std::string EscapeJsonChars(const std::string& str) {\n+  const std::string control_symbols[0x20] = {\n+      \"\\\\u0000\", \"\\\\u0001\", \"\\\\u0002\", \"\\\\u0003\", \"\\\\u0004\", \"\\\\u0005\",\n+      \"\\\\u0006\", \"\\\\u0007\", \"\\\\b\", \"\\\\t\", \"\\\\n\", \"\\\\v\", \"\\\\f\", \"\\\\r\",\n+      \"\\\\u000e\", \"\\\\u000f\", \"\\\\u0010\", \"\\\\u0011\", \"\\\\u0012\", \"\\\\u0013\",\n+      \"\\\\u0014\", \"\\\\u0015\", \"\\\\u0016\", \"\\\\u0017\", \"\\\\u0018\", \"\\\\u0019\",\n+      \"\\\\u001a\", \"\\\\u001b\", \"\\\\u001c\", \"\\\\u001d\", \"\\\\u001e\", \"\\\\u001f\"\n+  };\n+\n+  std::string ret = \"\";\n+  size_t last_pos = 0;\n   size_t pos = 0;\n-  while ((pos = ret.find(old, pos)) != std::string::npos) {\n-    ret.replace(pos, old.length(), neu);\n-    pos += neu.length();\n+  for (; pos < str.size(); ++pos) {\n+    std::string replace;\n+    char ch = str[pos];\n+    if (ch == '\\\\') {\n+      replace = \"\\\\\\\\\";\n+    } else if (ch == '\\\"') {\n+      replace = \"\\\\\\\"\";\n+    } else {\n+      size_t num = static_cast<size_t>(ch);\n+      if (num < 0x20) replace = control_symbols[num];\n+    }\n+    if (!replace.empty()) {\n+      if (pos > last_pos) {\n+        ret += str.substr(last_pos, pos - last_pos);\n+      }\n+      last_pos = pos + 1;\n+      ret += replace;\n+    }\n+  }\n+  // Append any remaining symbols.\n+  if (last_pos < str.size()) {\n+    ret += str.substr(last_pos, pos - last_pos);\n   }\n-  return ret;\n-}\n-\n-std::string EscapeJsonChars(const std::string& str) {\n-  std::string ret = str;\n-  ret = findAndReplace(ret, \"\\\\\", \"\\\\\\\\\");\n-  ret = findAndReplace(ret, \"\\\\u\", \"\\\\u\");\n-  ret = findAndReplace(ret, \"\\n\", \"\\\\n\");\n-  ret = findAndReplace(ret, \"\\f\", \"\\\\f\");\n-  ret = findAndReplace(ret, \"\\r\", \"\\\\r\");\n-  ret = findAndReplace(ret, \"\\b\", \"\\\\b\");\n-  ret = findAndReplace(ret, \"\\t\", \"\\\\t\");\n-  ret = findAndReplace(ret, \"\\\"\", \"\\\\\\\"\");\n   return ret;\n }\n "
        },
        {
            "sha": "e32558ef75b5e85aecd3d931e336b4d6088c56cf",
            "filename": "test/cctest/test_report_util.cc",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/80441c8086aa5d5d74d93b5c6b779eab734149d4/test%2Fcctest%2Ftest_report_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/80441c8086aa5d5d74d93b5c6b779eab734149d4/test%2Fcctest%2Ftest_report_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_report_util.cc?ref=80441c8086aa5d5d74d93b5c6b779eab734149d4",
            "patch": "@@ -0,0 +1,26 @@\n+#include \"node_report.h\"\n+\n+#include \"gtest/gtest.h\"\n+\n+TEST(ReportUtilTest, EscapeJsonChars) {\n+  using report::EscapeJsonChars;\n+  EXPECT_EQ(\"abc\", EscapeJsonChars(\"abc\"));\n+  EXPECT_EQ(\"abc\\\\n\", EscapeJsonChars(\"abc\\n\"));\n+  EXPECT_EQ(\"abc\\\\nabc\", EscapeJsonChars(\"abc\\nabc\"));\n+  EXPECT_EQ(\"abc\\\\\\\\\", EscapeJsonChars(\"abc\\\\\"));\n+  EXPECT_EQ(\"abc\\\\\\\"\", EscapeJsonChars(\"abc\\\"\"));\n+\n+  const std::string expected[0x20] = {\n+      \"\\\\u0000\", \"\\\\u0001\", \"\\\\u0002\", \"\\\\u0003\", \"\\\\u0004\", \"\\\\u0005\",\n+      \"\\\\u0006\", \"\\\\u0007\", \"\\\\b\", \"\\\\t\", \"\\\\n\", \"\\\\v\", \"\\\\f\", \"\\\\r\",\n+      \"\\\\u000e\", \"\\\\u000f\", \"\\\\u0010\", \"\\\\u0011\", \"\\\\u0012\", \"\\\\u0013\",\n+      \"\\\\u0014\", \"\\\\u0015\", \"\\\\u0016\", \"\\\\u0017\", \"\\\\u0018\", \"\\\\u0019\",\n+      \"\\\\u001a\", \"\\\\u001b\", \"\\\\u001c\", \"\\\\u001d\", \"\\\\u001e\", \"\\\\u001f\"\n+  };\n+  for (int i = 0; i < 0x20; ++i) {\n+    char symbols[1] = { static_cast<char>(i) };\n+    std::string input(symbols, 1);\n+    EXPECT_EQ(expected[i], EscapeJsonChars(input));\n+    EXPECT_EQ(\"a\" + expected[i], EscapeJsonChars(\"a\" + input));\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 60,
        "deletions": 20
    }
}