{
    "author": "ryzokuken",
    "message": "src: remove calls to deprecated v8 functions (Uint32Value)\n\nRemove all calls to deprecated v8 functions (here:\nValue::Uint32Value) inside the code (src directory only).\n\nPR-URL: https://github.com/nodejs/node/pull/22143\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "37cd10a1165537d25cd73454ffa81a4e964a56f7",
    "files": [
        {
            "sha": "5a21732c35a79812c3b0f3d5037e6cec5217aea5",
            "filename": "lib/buffer.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/lib%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/lib%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fbuffer.js?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -772,7 +772,7 @@ function bidirectionalIndexOf(buffer, val, byteOffset, encoding, dir) {\n   } else if (isUint8Array(val)) {\n     return indexOfBuffer(buffer, val, byteOffset, encoding, dir);\n   } else if (typeof val === 'number') {\n-    return indexOfNumber(buffer, val, byteOffset, dir);\n+    return indexOfNumber(buffer, val >>> 0, byteOffset, dir);\n   }\n \n   throw new ERR_INVALID_ARG_TYPE("
        },
        {
            "sha": "18b9e610750e9337c79d43a81a240b5c9640c197",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -21,6 +21,7 @@ using v8::MaybeLocal;\n using v8::NewStringType;\n using v8::Object;\n using v8::String;\n+using v8::Uint32;\n using v8::Value;\n \n using v8_inspector::StringBuffer;\n@@ -241,7 +242,7 @@ void Open(const FunctionCallbackInfo<Value>& args) {\n   bool wait_for_connect = false;\n \n   if (args.Length() > 0 && args[0]->IsUint32()) {\n-    uint32_t port = args[0]->Uint32Value();\n+    uint32_t port = args[0].As<Uint32>()->Value();\n     agent->options()->host_port.port = port;\n   }\n "
        },
        {
            "sha": "4a29873c34b821e02aed88d02171230b4a63e3fe",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -83,6 +83,7 @@ using v8::Maybe;\n using v8::MaybeLocal;\n using v8::Object;\n using v8::String;\n+using v8::Uint32;\n using v8::Uint32Array;\n using v8::Uint8Array;\n using v8::Value;\n@@ -565,12 +566,15 @@ void Copy(const FunctionCallbackInfo<Value> &args) {\n \n void Fill(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n+  Local<Context> ctx = env->context();\n \n   THROW_AND_RETURN_UNLESS_BUFFER(env, args[0]);\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n \n-  size_t start = args[2]->Uint32Value();\n-  size_t end = args[3]->Uint32Value();\n+  uint32_t start;\n+  if (!args[2]->Uint32Value(ctx).To(&start)) return;\n+  uint32_t end;\n+  if (!args[3]->Uint32Value(ctx).To(&end)) return;\n   size_t fill_length = end - start;\n   Local<String> str_obj;\n   size_t str_length;\n@@ -590,7 +594,9 @@ void Fill(const FunctionCallbackInfo<Value>& args) {\n \n   // Then coerce everything that's not a string.\n   if (!args[1]->IsString()) {\n-    int value = args[1]->Uint32Value() & 255;\n+    uint32_t val;\n+    if (!args[1]->Uint32Value(ctx).To(&val)) return;\n+    int value = val & 255;\n     memset(ts_obj_data + start, value, fill_length);\n     return;\n   }\n@@ -1000,14 +1006,14 @@ void IndexOfBuffer(const FunctionCallbackInfo<Value>& args) {\n }\n \n void IndexOfNumber(const FunctionCallbackInfo<Value>& args) {\n-  CHECK(args[1]->IsNumber());\n+  CHECK(args[1]->IsUint32());\n   CHECK(args[2]->IsNumber());\n   CHECK(args[3]->IsBoolean());\n \n   THROW_AND_RETURN_UNLESS_BUFFER(Environment::GetCurrent(args), args[0]);\n   SPREAD_BUFFER_ARG(args[0], ts_obj);\n \n-  uint32_t needle = args[1]->Uint32Value();\n+  uint32_t needle = args[1].As<Uint32>()->Value();\n   int64_t offset_i64 = args[2]->IntegerValue();\n   bool is_forward = args[3]->IsTrue();\n "
        },
        {
            "sha": "d2eac96db39e8935f2bd47450cffea21fa3ef01e",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -3882,7 +3882,8 @@ void PublicKeyCipher::Cipher(const FunctionCallbackInfo<Value>& args) {\n   char* buf = Buffer::Data(args[1]);\n   ssize_t len = Buffer::Length(args[1]);\n \n-  int padding = args[2]->Uint32Value();\n+  uint32_t padding;\n+  if (!args[2]->Uint32Value(env->context()).To(&padding)) return;\n \n   String::Utf8Value passphrase(args.GetIsolate(), args[3]);\n \n@@ -4447,8 +4448,9 @@ void ECDH::GetPublicKey(const FunctionCallbackInfo<Value>& args) {\n     return env->ThrowError(\"Failed to get ECDH public key\");\n \n   int size;\n-  point_conversion_form_t form =\n-      static_cast<point_conversion_form_t>(args[0]->Uint32Value());\n+  CHECK(args[0]->IsUint32());\n+  uint32_t val = args[0].As<Uint32>()->Value();\n+  point_conversion_form_t form = static_cast<point_conversion_form_t>(val);\n \n   size = EC_POINT_point2oct(ecdh->group_, pub, form, nullptr, 0, nullptr);\n   if (size == 0)\n@@ -5063,8 +5065,9 @@ void ConvertKey(const FunctionCallbackInfo<Value>& args) {\n   if (pub == nullptr)\n     return env->ThrowError(\"Failed to convert Buffer to EC_POINT\");\n \n-  point_conversion_form_t form =\n-      static_cast<point_conversion_form_t>(args[2]->Uint32Value());\n+  CHECK(args[2]->IsUint32());\n+  uint32_t val = args[2].As<Uint32>()->Value();\n+  point_conversion_form_t form = static_cast<point_conversion_form_t>(val);\n \n   int size = EC_POINT_point2oct(\n       group.get(), pub.get(), form, nullptr, 0, nullptr);\n@@ -5163,7 +5166,8 @@ void InitCryptoOnce() {\n void SetEngine(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   CHECK(args.Length() >= 2 && args[0]->IsString());\n-  unsigned int flags = args[1]->Uint32Value();\n+  uint32_t flags;\n+  if (!args[1]->Uint32Value(env->context()).To(&flags)) return;\n \n   ClearErrorOnReturn clear_error_on_return;\n "
        },
        {
            "sha": "9543ab60737912c261637b57e89ad1eb744b915c",
            "filename": "src/node_i18n.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_i18n.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_i18n.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_i18n.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -819,9 +819,9 @@ static void GetStringWidth(const FunctionCallbackInfo<Value>& args) {\n   bool expand_emoji_sequence = args[2]->IsTrue();\n \n   if (args[0]->IsNumber()) {\n-    args.GetReturnValue().Set(\n-        GetColumnWidth(args[0]->Uint32Value(),\n-                       ambiguous_as_full_width));\n+    uint32_t val;\n+    if (!args[0]->Uint32Value(env->context()).To(&val)) return;\n+    args.GetReturnValue().Set(GetColumnWidth(val, ambiguous_as_full_width));\n     return;\n   }\n "
        },
        {
            "sha": "087a7a773eb8c3ef81461dec1ddfa8c9c0f101bb",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -335,7 +335,7 @@ static const char* name_by_gid(gid_t gid) {\n \n static uid_t uid_by_name(Isolate* isolate, Local<Value> value) {\n   if (value->IsUint32()) {\n-    return static_cast<uid_t>(value->Uint32Value());\n+    return static_cast<uid_t>(value.As<Uint32>()->Value());\n   } else {\n     Utf8Value name(isolate, value);\n     return uid_by_name(*name);\n@@ -345,7 +345,7 @@ static uid_t uid_by_name(Isolate* isolate, Local<Value> value) {\n \n static gid_t gid_by_name(Isolate* isolate, Local<Value> value) {\n   if (value->IsUint32()) {\n-    return static_cast<gid_t>(value->Uint32Value());\n+    return static_cast<gid_t>(value.As<Uint32>()->Value());\n   } else {\n     Utf8Value name(isolate, value);\n     return gid_by_name(*name);\n@@ -538,7 +538,7 @@ void InitGroups(const FunctionCallbackInfo<Value>& args) {\n   char* user;\n \n   if (args[0]->IsUint32()) {\n-    user = name_by_uid(args[0]->Uint32Value());\n+    user = name_by_uid(args[0].As<Uint32>()->Value());\n     must_free = true;\n   } else {\n     user = *arg0;"
        },
        {
            "sha": "482375cd6169ba21ea16843fa2be8f508cc7978a",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 31,
            "deletions": 21,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -49,6 +49,7 @@ using v8::Local;\n using v8::Number;\n using v8::Object;\n using v8::String;\n+using v8::Uint32;\n using v8::Uint32Array;\n using v8::Value;\n \n@@ -155,7 +156,11 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n \n     CHECK_EQ(false, args[0]->IsUndefined() && \"must provide flush value\");\n \n-    unsigned int flush = args[0]->Uint32Value();\n+    Environment* env = ctx->env();\n+    Local<Context> context = env->context();\n+\n+    unsigned int flush;\n+    if (!args[0]->Uint32Value(context).To(&flush)) return;\n \n     if (flush != Z_NO_FLUSH &&\n         flush != Z_PARTIAL_FLUSH &&\n@@ -170,8 +175,7 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n \n     Bytef* in;\n     Bytef* out;\n-    size_t in_off, in_len, out_off, out_len;\n-    Environment* env = ctx->env();\n+    uint32_t in_off, in_len, out_off, out_len;\n \n     if (args[1]->IsNull()) {\n       // just a flush\n@@ -181,18 +185,18 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n     } else {\n       CHECK(Buffer::HasInstance(args[1]));\n       Local<Object> in_buf;\n-      in_buf = args[1]->ToObject(env->context()).ToLocalChecked();\n-      in_off = args[2]->Uint32Value();\n-      in_len = args[3]->Uint32Value();\n+      in_buf = args[1]->ToObject(context).ToLocalChecked();\n+      if (!args[2]->Uint32Value(context).To(&in_off)) return;\n+      if (!args[3]->Uint32Value(context).To(&in_len)) return;\n \n       CHECK(Buffer::IsWithinBounds(in_off, in_len, Buffer::Length(in_buf)));\n       in = reinterpret_cast<Bytef *>(Buffer::Data(in_buf) + in_off);\n     }\n \n     CHECK(Buffer::HasInstance(args[4]));\n-    Local<Object> out_buf = args[4]->ToObject(env->context()).ToLocalChecked();\n-    out_off = args[5]->Uint32Value();\n-    out_len = args[6]->Uint32Value();\n+    Local<Object> out_buf = args[4]->ToObject(context).ToLocalChecked();\n+    if (!args[5]->Uint32Value(context).To(&out_off)) return;\n+    if (!args[6]->Uint32Value(context).To(&out_len)) return;\n     CHECK(Buffer::IsWithinBounds(out_off, out_len, Buffer::Length(out_buf)));\n     out = reinterpret_cast<Bytef *>(Buffer::Data(out_buf) + out_off);\n \n@@ -438,32 +442,38 @@ class ZCtx : public AsyncWrap, public ThreadPoolWork {\n     ZCtx* ctx;\n     ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Holder());\n \n+    Local<Context> context = args.GetIsolate()->GetCurrentContext();\n+\n     // windowBits is special. On the compression side, 0 is an invalid value.\n     // But on the decompression side, a value of 0 for windowBits tells zlib\n     // to use the window size in the zlib header of the compressed stream.\n-    int windowBits = args[0]->Uint32Value();\n+    uint32_t windowBits;\n+    if (!args[0]->Uint32Value(context).To(&windowBits)) return;\n+\n     if (!((windowBits == 0) &&\n           (ctx->mode_ == INFLATE ||\n            ctx->mode_ == GUNZIP ||\n            ctx->mode_ == UNZIP))) {\n-      CHECK((windowBits >= Z_MIN_WINDOWBITS &&\n-             windowBits <= Z_MAX_WINDOWBITS) && \"invalid windowBits\");\n+      CHECK(\n+          (windowBits >= Z_MIN_WINDOWBITS && windowBits <= Z_MAX_WINDOWBITS) &&\n+          \"invalid windowBits\");\n     }\n \n     int level = args[1]->Int32Value();\n     CHECK((level >= Z_MIN_LEVEL && level <= Z_MAX_LEVEL) &&\n       \"invalid compression level\");\n \n-    int memLevel = args[2]->Uint32Value();\n+    uint32_t memLevel;\n+    if (!args[2]->Uint32Value(context).To(&memLevel)) return;\n     CHECK((memLevel >= Z_MIN_MEMLEVEL && memLevel <= Z_MAX_MEMLEVEL) &&\n-      \"invalid memlevel\");\n-\n-    int strategy = args[3]->Uint32Value();\n-    CHECK((strategy == Z_FILTERED ||\n-           strategy == Z_HUFFMAN_ONLY ||\n-           strategy == Z_RLE ||\n-           strategy == Z_FIXED ||\n-           strategy == Z_DEFAULT_STRATEGY) && \"invalid strategy\");\n+          \"invalid memlevel\");\n+\n+    uint32_t strategy;\n+    if (!args[3]->Uint32Value(context).To(&strategy)) return;\n+    CHECK((strategy == Z_FILTERED || strategy == Z_HUFFMAN_ONLY ||\n+           strategy == Z_RLE || strategy == Z_FIXED ||\n+           strategy == Z_DEFAULT_STRATEGY) &&\n+          \"invalid strategy\");\n \n     CHECK(args[4]->IsUint32Array());\n     Local<Uint32Array> array = args[4].As<Uint32Array>();"
        },
        {
            "sha": "7b544d153144c92384b86375189cb77646dc9311",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -48,6 +48,7 @@ using v8::Integer;\n using v8::Local;\n using v8::Object;\n using v8::String;\n+using v8::Uint32;\n using v8::Value;\n \n using AsyncHooks = Environment::AsyncHooks;\n@@ -180,7 +181,7 @@ void TCPWrap::SetKeepAlive(const FunctionCallbackInfo<Value>& args) {\n                           args.Holder(),\n                           args.GetReturnValue().Set(UV_EBADF));\n   int enable = args[0]->Int32Value();\n-  unsigned int delay = args[1]->Uint32Value();\n+  unsigned int delay = args[1].As<Uint32>()->Value();\n   int err = uv_tcp_keepalive(&wrap->handle_, enable, delay);\n   args.GetReturnValue().Set(err);\n }\n@@ -277,7 +278,7 @@ void TCPWrap::Connect(const FunctionCallbackInfo<Value>& args) {\n \n   Local<Object> req_wrap_obj = args[0].As<Object>();\n   node::Utf8Value ip_address(env->isolate(), args[1]);\n-  int port = args[2]->Uint32Value();\n+  int port = args[2].As<Uint32>()->Value();\n \n   sockaddr_in addr;\n   int err = uv_ip4_addr(*ip_address, port, &addr);"
        },
        {
            "sha": "27d4c7959c3f8725a17f5e10c389a4d5c25e1469",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/37cd10a1165537d25cd73454ffa81a4e964a56f7/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=37cd10a1165537d25cd73454ffa81a4e964a56f7",
            "patch": "@@ -180,8 +180,11 @@ void UDPWrap::DoBind(const FunctionCallbackInfo<Value>& args, int family) {\n   CHECK_EQ(args.Length(), 3);\n \n   node::Utf8Value address(args.GetIsolate(), args[0]);\n-  const int port = args[1]->Uint32Value();\n-  const int flags = args[2]->Uint32Value();\n+  Local<Context> ctx = args.GetIsolate()->GetCurrentContext();\n+  uint32_t port, flags;\n+  if (!args[1]->Uint32Value(ctx).To(&port) ||\n+      !args[2]->Uint32Value(ctx).To(&flags))\n+    return;\n   char addr[sizeof(sockaddr_in6)];\n   int err;\n \n@@ -353,8 +356,8 @@ void UDPWrap::DoSend(const FunctionCallbackInfo<Value>& args, int family) {\n   Local<Array> chunks = args[1].As<Array>();\n   // it is faster to fetch the length of the\n   // array in js-land\n-  size_t count = args[2]->Uint32Value();\n-  const unsigned short port = args[3]->Uint32Value();\n+  size_t count = args[2].As<Uint32>()->Value();\n+  const unsigned short port = args[3].As<Uint32>()->Value();\n   node::Utf8Value address(env->isolate(), args[4]);\n   const bool have_callback = args[5]->IsTrue();\n "
        }
    ],
    "stats": {
        "total": 117,
        "additions": 71,
        "deletions": 46
    }
}