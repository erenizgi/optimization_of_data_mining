{
    "author": "mafintosh",
    "message": "src: fix external memory usage going negative\n\nPR-URL: https://github.com/nodejs/node/pull/22594\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "1287e524eeba4632decce231da161426efb8fc34",
    "files": [
        {
            "sha": "692978412fc023e4d9d82fa142ae276cad0aa0f2",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1287e524eeba4632decce231da161426efb8fc34/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/1287e524eeba4632decce231da161426efb8fc34/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=1287e524eeba4632decce231da161426efb8fc34",
            "patch": "@@ -198,7 +198,9 @@ class SecureContext : public BaseObject {\n   }\n \n   inline void Reset() {\n-    env()->isolate()->AdjustAmountOfExternalAllocatedMemory(-kExternalSize);\n+    if (ctx_ != nullptr) {\n+      env()->isolate()->AdjustAmountOfExternalAllocatedMemory(-kExternalSize);\n+    }\n     ctx_.reset();\n     cert_.reset();\n     issuer_.reset();"
        },
        {
            "sha": "c19fbbe5088306eacd41ec91fc376eceb8d722d1",
            "filename": "test/parallel/test-gc-tls-external-memory.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/1287e524eeba4632decce231da161426efb8fc34/test%2Fparallel%2Ftest-gc-tls-external-memory.js",
            "raw_url": "https://github.com/nodejs/node/raw/1287e524eeba4632decce231da161426efb8fc34/test%2Fparallel%2Ftest-gc-tls-external-memory.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-tls-external-memory.js?ref=1287e524eeba4632decce231da161426efb8fc34",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+// Flags: --expose-gc\n+\n+// Tests that memoryUsage().external doesn't go negative\n+// when a lot tls connections are opened and closed\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const net = require('net');\n+const tls = require('tls');\n+\n+// Payload doesn't matter. We just need to have the tls\n+// connection try and connect somewhere.\n+const yolo = Buffer.alloc(10000).fill('yolo');\n+const server = net.createServer(function(socket) {\n+  socket.write(yolo);\n+});\n+\n+server.listen(0, common.mustCall(function() {\n+  const { port } = server.address();\n+  let runs = 0;\n+  connect();\n+\n+  function connect() {\n+    global.gc();\n+    assert(process.memoryUsage().external >= 0);\n+    if (runs++ < 512)\n+      tls.connect(port).on('error', connect);\n+    else\n+      server.close();\n+  }\n+}));"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}