{
    "author": "mcollina",
    "message": "http: do not replace .read() in IncomingMessage\n\nRemove the req._consumed property, as its use is completely\nsuperseded and not needed anymore. This was being set in the\noverridden .read().\n\nPR-URL: https://github.com/nodejs/node/pull/18939\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "29be1e5f8426b8f58a390847aa94c1f9a6d103f4",
    "files": [
        {
            "sha": "a84cb64bdb81441620787ff23b8a4bea97a63da7",
            "filename": "lib/_http_incoming.js",
            "status": "modified",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/29be1e5f8426b8f58a390847aa94c1f9a6d103f4/lib%2F_http_incoming.js",
            "raw_url": "https://github.com/nodejs/node/raw/29be1e5f8426b8f58a390847aa94c1f9a6d103f4/lib%2F_http_incoming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_incoming.js?ref=29be1e5f8426b8f58a390847aa94c1f9a6d103f4",
            "patch": "@@ -38,13 +38,6 @@ function readStop(socket) {\n function IncomingMessage(socket) {\n   Stream.Readable.call(this);\n \n-  // Set this to `true` so that stream.Readable won't attempt to read more\n-  // data on `IncomingMessage#push` (see `maybeReadMore` in\n-  // `_stream_readable.js`). This is important for proper tracking of\n-  // `IncomingMessage#_consuming` which is used to dump requests that users\n-  // haven't attempted to read.\n-  this._readableState.readingMore = true;\n-\n   this.socket = socket;\n   this.connection = socket;\n \n@@ -70,9 +63,6 @@ function IncomingMessage(socket) {\n   this.statusMessage = null;\n   this.client = socket;\n \n-  // flag for backwards compatibility grossness.\n-  this._consuming = false;\n-\n   // flag for when we decide that this message cannot possibly be\n   // read by the user, so there's no point continuing to handle it.\n   this._dumped = false;\n@@ -88,15 +78,6 @@ IncomingMessage.prototype.setTimeout = function setTimeout(msecs, callback) {\n };\n \n \n-IncomingMessage.prototype.read = function read(n) {\n-  if (!this._consuming)\n-    this._readableState.readingMore = false;\n-  this._consuming = true;\n-  this.read = Stream.Readable.prototype.read;\n-  return this.read(n);\n-};\n-\n-\n IncomingMessage.prototype._read = function _read(n) {\n   // We actually do almost nothing here, because the parserOnBody\n   // function fills up our internal buffer directly.  However, we"
        },
        {
            "sha": "e87dfee96f433fa61ffa1a2a9c25ac4d0f4fd183",
            "filename": "test/parallel/test-http-dump-req-when-res-ends.js",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/nodejs/node/blob/29be1e5f8426b8f58a390847aa94c1f9a6d103f4/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js",
            "raw_url": "https://github.com/nodejs/node/raw/29be1e5f8426b8f58a390847aa94c1f9a6d103f4/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-dump-req-when-res-ends.js?ref=29be1e5f8426b8f58a390847aa94c1f9a6d103f4",
            "patch": "@@ -0,0 +1,54 @@\n+'use strict';\n+\n+const common = require('../common');\n+const http = require('http');\n+const fs = require('fs');\n+\n+const server = http.createServer(function(req, res) {\n+  // this checks if the request gets dumped\n+  req.on('resume', common.mustCall(function() {\n+    console.log('resume called');\n+\n+    req.on('data', common.mustCallAtLeast(function(d) {\n+      console.log('data', d);\n+    }, 1));\n+  }));\n+\n+  // end is not called as we are just exhausting\n+  // the in-memory buffer\n+  req.on('end', common.mustNotCall);\n+\n+  // this 'data' handler will be removed when dumped\n+  req.on('data', common.mustNotCall);\n+\n+  // start sending the response\n+  res.flushHeaders();\n+\n+  setTimeout(function() {\n+    res.end('hello world');\n+  }, common.platformTimeout(100));\n+});\n+\n+server.listen(0, function() {\n+  const req = http.request({\n+    method: 'POST',\n+    port: server.address().port\n+  });\n+\n+  // Send the http request without waiting\n+  // for the body\n+  req.flushHeaders();\n+\n+  req.on('response', common.mustCall(function(res) {\n+    // pipe the body as soon as we get the headers of the\n+    // response back\n+    fs.createReadStream(__filename).pipe(req);\n+\n+    res.resume();\n+\n+    // wait for the response\n+    res.on('end', function() {\n+      server.close();\n+    });\n+  }));\n+});"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 54,
        "deletions": 19
    }
}