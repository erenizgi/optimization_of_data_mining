{
    "author": "BridgeAR",
    "message": "util: prevent leaking internal properties\n\nThis prevents leaking of the internal `inspect()` properties when\nusing a custom inspect function.\n\nIt also aligns the indentation to the way it was in v8.0.0 since\nthat changed unintentionally. All strings returned by the custom\ninspect function will now be indented appropriately to the current\ndepth.\n\nPR-URL: https://github.com/nodejs/node/pull/24971\nRefs: https://github.com/nodejs/node/issues/24765\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Rich Trott <rtrott@gmail.com>",
    "sha": "7b674697d8005c29391ebaaf562eb4d92ed9b129",
    "files": [
        {
            "sha": "b1d4854997f05303ee7b2484cddcff5cfc2a040c",
            "filename": "doc/api/util.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/7b674697d8005c29391ebaaf562eb4d92ed9b129/doc%2Fapi%2Futil.md",
            "raw_url": "https://github.com/nodejs/node/raw/7b674697d8005c29391ebaaf562eb4d92ed9b129/doc%2Fapi%2Futil.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Futil.md?ref=7b674697d8005c29391ebaaf562eb4d92ed9b129",
            "patch": "@@ -388,6 +388,10 @@ stream.write('With ES6');\n <!-- YAML\n added: v0.3.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/24971\n+    description: Internal properties no longer appear in the context argument\n+                 of a custom inspection function.\n   - version: v11.7.0\n     pr-url: https://github.com/nodejs/node/pull/25006\n     description: ArrayBuffers now also show their binary contents."
        },
        {
            "sha": "9a1a0f9f03bb34390b217f95285daab5f4ad7bcc",
            "filename": "lib/internal/util/inspect.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/7b674697d8005c29391ebaaf562eb4d92ed9b129/lib%2Finternal%2Futil%2Finspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/7b674697d8005c29391ebaaf562eb4d92ed9b129/lib%2Finternal%2Futil%2Finspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil%2Finspect.js?ref=7b674697d8005c29391ebaaf562eb4d92ed9b129",
            "patch": "@@ -516,18 +516,22 @@ function formatValue(ctx, value, recurseTimes, typedArray) {\n         maybeCustom !== inspect &&\n         // Also filter out any prototype objects using the circular check.\n         !(value.constructor && value.constructor.prototype === value)) {\n+      // Remove some internal properties from the options before passing it\n+      // through to the user function. This also prevents option manipulation.\n+      // eslint-disable-next-line no-unused-vars\n+      const { budget, seen, indentationLvl, ...plainCtx } = ctx;\n       // This makes sure the recurseTimes are reported as before while using\n       // a counter internally.\n       const depth = ctx.depth === null ? null : ctx.depth - recurseTimes;\n-      const ret = maybeCustom.call(value, depth, ctx);\n+      const ret = maybeCustom.call(value, depth, plainCtx);\n \n       // If the custom inspection method returned `this`, don't go into\n       // infinite recursion.\n       if (ret !== value) {\n         if (typeof ret !== 'string') {\n           return formatValue(ctx, ret, recurseTimes);\n         }\n-        return ret;\n+        return ret.replace(/\\n/g, `\\n${' '.repeat(ctx.indentationLvl)}`);\n       }\n     }\n   }"
        },
        {
            "sha": "4e9f5ac004ea86b5aa055f55134882efb51b1e11",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/7b674697d8005c29391ebaaf562eb4d92ed9b129/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/7b674697d8005c29391ebaaf562eb4d92ed9b129/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=7b674697d8005c29391ebaaf562eb4d92ed9b129",
            "patch": "@@ -775,9 +775,21 @@ util.inspect({ hasOwnProperty: null });\n \n   assert.strictEqual(util.inspect(subject), \"{ foo: 'bar' }\");\n \n-  subject[util.inspect.custom] = (depth, opts) => {\n-    assert.strictEqual(opts.customInspectOptions, true);\n-  };\n+  subject[util.inspect.custom] = common.mustCall((depth, opts) => {\n+    const clone = { ...opts };\n+    // This might change at some point but for now we keep the stylize function.\n+    // The function should either be documented or an alternative should be\n+    // implemented.\n+    assert.strictEqual(typeof opts.stylize, 'function');\n+    assert.strictEqual(opts.seen, undefined);\n+    assert.strictEqual(opts.budget, undefined);\n+    assert.strictEqual(opts.indentationLvl, undefined);\n+    assert.strictEqual(opts.showHidden, false);\n+    opts.showHidden = true;\n+    return { [util.inspect.custom]: common.mustCall((depth, opts2) => {\n+      assert.deepStrictEqual(clone, opts2);\n+    }) };\n+  });\n \n   util.inspect(subject, { customInspectOptions: true });\n \n@@ -1593,7 +1605,7 @@ util.inspect(process);\n   );\n   const longList = util.inspect(list, { depth: Infinity });\n   const match = longList.match(/next/g);\n-  assert(match.length > 1000 && match.length < 10000);\n+  assert(match.length > 500 && match.length < 10000);\n   assert(longList.includes('[Object: Inspection interrupted ' +\n     'prematurely. Maximum call stack size exceeded.]'));\n }"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 26,
        "deletions": 6
    }
}