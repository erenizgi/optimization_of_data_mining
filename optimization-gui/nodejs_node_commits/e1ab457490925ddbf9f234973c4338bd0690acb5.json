{
    "author": "addaleax",
    "message": "worker: fix nullptr deref after MessagePort deser failure\n\nThis would previously always have crashed when deserializing\na `MessagePort` fails, because there was always at least one\n`nullptr` entry in the vector.\n\nPR-URL: https://github.com/nodejs/node/pull/25076\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>",
    "sha": "e1ab457490925ddbf9f234973c4338bd0690acb5",
    "files": [
        {
            "sha": "ae60187b6f3ec2271601378d55fea31c5b422923",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/e1ab457490925ddbf9f234973c4338bd0690acb5/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e1ab457490925ddbf9f234973c4338bd0690acb5/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=e1ab457490925ddbf9f234973c4338bd0690acb5",
            "patch": "@@ -90,7 +90,8 @@ MaybeLocal<Value> Message::Deserialize(Environment* env,\n     if (ports[i] == nullptr) {\n       for (MessagePort* port : ports) {\n         // This will eventually release the MessagePort object itself.\n-        port->Close();\n+        if (port != nullptr)\n+          port->Close();\n       }\n       return MaybeLocal<Value>();\n     }"
        },
        {
            "sha": "13a30b5c54c6c3160243fba314ad9ff00c51f569",
            "filename": "test/parallel/test-worker-messageport-transfer-terminate.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/e1ab457490925ddbf9f234973c4338bd0690acb5/test%2Fparallel%2Ftest-worker-messageport-transfer-terminate.js",
            "raw_url": "https://github.com/nodejs/node/raw/e1ab457490925ddbf9f234973c4338bd0690acb5/test%2Fparallel%2Ftest-worker-messageport-transfer-terminate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-messageport-transfer-terminate.js?ref=e1ab457490925ddbf9f234973c4338bd0690acb5",
            "patch": "@@ -0,0 +1,18 @@\n+// Flags: --experimental-worker\n+'use strict';\n+require('../common');\n+const { Worker, MessageChannel } = require('worker_threads');\n+\n+// Check the interaction of calling .terminate() while transferring\n+// MessagePort objects; in particular, that it does not crash the process.\n+\n+for (let i = 0; i < 10; ++i) {\n+  const w = new Worker(\n+    \"require('worker_threads').parentPort.on('message', () => {})\",\n+    { eval: true });\n+  setImmediate(() => {\n+    const port = new MessageChannel().port1;\n+    w.postMessage({ port }, [ port ]);\n+    w.terminate();\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 20,
        "deletions": 1
    }
}