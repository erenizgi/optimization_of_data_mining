{
    "author": "jasnell",
    "message": "Revert \"workers,trace_events: set thread name for workers\"\n\nThis reverts commit a24b691c6cfb31bc77f5d0cd64596106dc21d890.\n\nPR-URL: https://github.com/nodejs/node/pull/21363\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>",
    "sha": "b505d2a1cf182d39e224e80a6fa4a179cd788655",
    "files": [
        {
            "sha": "c84fdf0bb8215b0de8036a3c8935883d9acfa049",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=b505d2a1cf182d39e224e80a6fa4a179cd788655",
            "patch": "@@ -598,11 +598,11 @@ inline bool Environment::is_main_thread() const {\n   return thread_id_ == 0;\n }\n \n-inline uint64_t Environment::thread_id() const {\n+inline double Environment::thread_id() const {\n   return thread_id_;\n }\n \n-inline void Environment::set_thread_id(uint64_t id) {\n+inline void Environment::set_thread_id(double id) {\n   thread_id_ = id;\n }\n "
        },
        {
            "sha": "1a96abe106a7528ae3805c3449050432ab92d9a0",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=b505d2a1cf182d39e224e80a6fa4a179cd788655",
            "patch": "@@ -726,8 +726,8 @@ class Environment {\n   bool is_stopping_worker() const;\n \n   inline bool is_main_thread() const;\n-  inline uint64_t thread_id() const;\n-  inline void set_thread_id(uint64_t id);\n+  inline double thread_id() const;\n+  inline void set_thread_id(double id);\n   inline worker::Worker* worker_context() const;\n   inline void set_worker_context(worker::Worker* context);\n   inline void add_sub_worker_context(worker::Worker* context);\n@@ -881,7 +881,7 @@ class Environment {\n   std::unordered_map<std::string, uint64_t> performance_marks_;\n \n   bool can_call_into_js_ = true;\n-  uint64_t thread_id_ = 0;\n+  double thread_id_ = 0;\n   std::unordered_set<worker::Worker*> sub_worker_contexts_;\n \n "
        },
        {
            "sha": "320b6703d40d213967ae01f237d092ce393c2acf",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 12,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=b505d2a1cf182d39e224e80a6fa4a179cd788655",
            "patch": "@@ -9,8 +9,6 @@\n #include \"async_wrap.h\"\n #include \"async_wrap-inl.h\"\n \n-#include <string>\n-\n using v8::ArrayBuffer;\n using v8::Context;\n using v8::Function;\n@@ -32,7 +30,7 @@ namespace worker {\n \n namespace {\n \n-uint64_t next_thread_id = 1;\n+double next_thread_id = 1;\n Mutex next_thread_id_mutex;\n \n }  // anonymous namespace\n@@ -46,8 +44,7 @@ Worker::Worker(Environment* env, Local<Object> wrap)\n   }\n   wrap->Set(env->context(),\n             env->thread_id_string(),\n-            Number::New(env->isolate(),\n-                        static_cast<double>(thread_id_))).FromJust();\n+            Number::New(env->isolate(), thread_id_)).FromJust();\n \n   // Set up everything that needs to be set up in the parent environment.\n   parent_port_ = MessagePort::New(env, env->context());\n@@ -115,11 +112,6 @@ bool Worker::is_stopped() const {\n }\n \n void Worker::Run() {\n-  std::string name = \"WorkerThread \";\n-  name += std::to_string(thread_id_);\n-  TRACE_EVENT_METADATA1(\n-      \"__metadata\", \"thread_name\", \"name\",\n-      TRACE_STR_COPY(name.c_str()));\n   MultiIsolatePlatform* platform = isolate_data_->platform();\n   CHECK_NE(platform, nullptr);\n \n@@ -426,8 +418,7 @@ void InitWorker(Local<Object> target,\n   auto thread_id_string = FIXED_ONE_BYTE_STRING(env->isolate(), \"threadId\");\n   target->Set(env->context(),\n               thread_id_string,\n-              Number::New(env->isolate(),\n-                          static_cast<double>(env->thread_id()))).FromJust();\n+              Number::New(env->isolate(), env->thread_id())).FromJust();\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "0a98d2f11ef00fc472d0e49a20b05d2d372fbea1",
            "filename": "src/node_worker.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fnode_worker.h",
            "raw_url": "https://github.com/nodejs/node/raw/b505d2a1cf182d39e224e80a6fa4a179cd788655/src%2Fnode_worker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.h?ref=b505d2a1cf182d39e224e80a6fa4a179cd788655",
            "patch": "@@ -62,7 +62,7 @@ class Worker : public AsyncWrap {\n \n   bool thread_joined_ = true;\n   int exit_code_ = 0;\n-  uint64_t thread_id_ = -1;\n+  double thread_id_ = -1;\n \n   std::unique_ptr<MessagePortData> child_port_data_;\n "
        },
        {
            "sha": "e1ae323e0c6e7069d3006171e2e4facade09704a",
            "filename": "test/parallel/test-trace-events-worker-metadata.js",
            "status": "removed",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/dcad7c93fbdd6887e76e30ac99bb4d9a159659c8/test%2Fparallel%2Ftest-trace-events-worker-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/dcad7c93fbdd6887e76e30ac99bb4d9a159659c8/test%2Fparallel%2Ftest-trace-events-worker-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-worker-metadata.js?ref=dcad7c93fbdd6887e76e30ac99bb4d9a159659c8",
            "patch": "@@ -1,33 +0,0 @@\n-// Flags: --experimental-worker\n-'use strict';\n-const common = require('../common');\n-const assert = require('assert');\n-const cp = require('child_process');\n-const fs = require('fs');\n-const { isMainThread } = require('worker_threads');\n-\n-if (isMainThread) {\n-  const CODE = 'const { Worker } = require(\\'worker_threads\\'); ' +\n-               `new Worker('${__filename}')`;\n-  const FILE_NAME = 'node_trace.1.log';\n-  const tmpdir = require('../common/tmpdir');\n-  tmpdir.refresh();\n-  process.chdir(tmpdir.path);\n-\n-  const proc = cp.spawn(process.execPath,\n-                        [ '--experimental-worker',\n-                          '--trace-event-categories', 'node',\n-                          '-e', CODE ]);\n-  proc.once('exit', common.mustCall(() => {\n-    assert(common.fileExists(FILE_NAME));\n-    fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n-      const traces = JSON.parse(data.toString()).traceEvents;\n-      assert(traces.length > 0);\n-      assert(traces.some((trace) =>\n-        trace.cat === '__metadata' && trace.name === 'thread_name' &&\n-          trace.args.name === 'WorkerThread 1'));\n-    }));\n-  }));\n-} else {\n-  // Do nothing here.\n-}"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 9,
        "deletions": 51
    }
}