{
    "author": "bnoordhuis",
    "message": "crypto: make ConvertKey clear openssl error stack\n\nFailed ConvertKey() operations should not leave errors on OpenSSL's\nerror stack because that's observable by subsequent cryptographic\noperations. More to the point, it makes said operations fail with\nan unrelated error.\n\nPR-URL: https://github.com/nodejs/node/pull/26153\nFixes: https://github.com/nodejs/node/issues/26133\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "042e2640e68832554733377245a3d6d4f76a7002",
    "files": [
        {
            "sha": "fcc35ce63fdd9a28bf64aae776fe2065c9f5d447",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/042e2640e68832554733377245a3d6d4f76a7002/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/042e2640e68832554733377245a3d6d4f76a7002/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=042e2640e68832554733377245a3d6d4f76a7002",
            "patch": "@@ -6122,6 +6122,7 @@ void ExportChallenge(const FunctionCallbackInfo<Value>& args) {\n \n // Convert the input public key to compressed, uncompressed, or hybrid formats.\n void ConvertKey(const FunctionCallbackInfo<Value>& args) {\n+  MarkPopErrorOnReturn mark_pop_error_on_return;\n   Environment* env = Environment::GetCurrent(args);\n \n   CHECK_EQ(args.Length(), 3);"
        },
        {
            "sha": "52d0fc2b7f0c74775377b55b8443c32dbae62202",
            "filename": "test/parallel/test-crypto-ecdh-convert-key.js",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/042e2640e68832554733377245a3d6d4f76a7002/test%2Fparallel%2Ftest-crypto-ecdh-convert-key.js",
            "raw_url": "https://github.com/nodejs/node/raw/042e2640e68832554733377245a3d6d4f76a7002/test%2Fparallel%2Ftest-crypto-ecdh-convert-key.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-ecdh-convert-key.js?ref=042e2640e68832554733377245a3d6d4f76a7002",
            "patch": "@@ -5,7 +5,7 @@ if (!common.hasCrypto)\n \n const assert = require('assert');\n \n-const { ECDH, getCurves } = require('crypto');\n+const { ECDH, createSign, getCurves } = require('crypto');\n \n // A valid private key for the secp256k1 curve.\n const cafebabeKey = 'cafebabe'.repeat(8);\n@@ -99,3 +99,27 @@ if (getCurves().includes('secp256k1')) {\n   assert.strictEqual(ecdh1.getPublicKey('hex', 'compressed'), compressed);\n   assert.strictEqual(ecdh1.getPublicKey('hex', 'hybrid'), hybrid);\n }\n+\n+// See https://github.com/nodejs/node/issues/26133, failed ConvertKey\n+// operations should not leave errors on OpenSSL's error stack because\n+// that's observable by subsequent operations.\n+{\n+  const privateKey =\n+    '-----BEGIN EC PRIVATE KEY-----\\n' +\n+    'MHcCAQEEIF+jnWY1D5kbVYDNvxxo/Y+ku2uJPDwS0r/VuPZQrjjVoAoGCCqGSM49\\n' +\n+    'AwEHoUQDQgAEurOxfSxmqIRYzJVagdZfMMSjRNNhB8i3mXyIMq704m2m52FdfKZ2\\n' +\n+    'pQhByd5eyj3lgZ7m7jbchtdgyOF8Io/1ng==\\n' +\n+    '-----END EC PRIVATE KEY-----';\n+\n+  const sign = createSign('sha256').update('plaintext');\n+\n+  // TODO(bnoordhuis) This should really bubble up the specific OpenSSL error\n+  // rather than Node's generic error message.\n+  const badKey = 'f'.repeat(128);\n+  assert.throws(\n+    () => ECDH.convertKey(badKey, 'secp256k1', 'hex', 'hex', 'compressed'),\n+    /Failed to convert Buffer to EC_POINT/);\n+\n+  // Next statement should not throw an exception.\n+  sign.sign(privateKey);\n+}"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}