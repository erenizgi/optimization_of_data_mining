{
    "author": "tniessen",
    "message": "crypto: reduce memory usage of SignFinal\n\nThe fixed-size buffer on the stack is unnecessary and way too large\nfor most applications. This change removes it and allocates the\nrequired memory directly instead of copying into heap later.\n\nPR-URL: https://github.com/nodejs/node/pull/23427\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "7bd2912669c8975523b6d77269d29207d3ea9769",
    "files": [
        {
            "sha": "490ec0df28936a38069c09c05f75bfb79c985021",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 38,
            "deletions": 33,
            "changes": 71,
            "blob_url": "https://github.com/nodejs/node/blob/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=7bd2912669c8975523b6d77269d29207d3ea9769",
            "patch": "@@ -43,6 +43,7 @@\n \n #include <algorithm>\n #include <memory>\n+#include <utility>\n #include <vector>\n \n static const int X509_NAME_FLAGS = ASN1_STRFLGS_ESC_CTRL\n@@ -3523,46 +3524,51 @@ void Sign::SignUpdate(const FunctionCallbackInfo<Value>& args) {\n   sign->CheckThrow(err);\n }\n \n-static int Node_SignFinal(EVPMDPointer&& mdctx, unsigned char* md,\n-                          unsigned int* sig_len,\n-                          const EVPKeyPointer& pkey, int padding,\n-                          int pss_salt_len) {\n+static MallocedBuffer<unsigned char> Node_SignFinal(EVPMDPointer&& mdctx,\n+                                                    const EVPKeyPointer& pkey,\n+                                                    int padding,\n+                                                    int pss_salt_len) {\n   unsigned char m[EVP_MAX_MD_SIZE];\n   unsigned int m_len;\n \n-  *sig_len = 0;\n   if (!EVP_DigestFinal_ex(mdctx.get(), m, &m_len))\n-    return 0;\n+    return MallocedBuffer<unsigned char>();\n+\n+  int signed_sig_len = EVP_PKEY_size(pkey.get());\n+  CHECK_GE(signed_sig_len, 0);\n+  size_t sig_len = static_cast<size_t>(signed_sig_len);\n+  MallocedBuffer<unsigned char> sig(sig_len);\n \n-  size_t sltmp = static_cast<size_t>(EVP_PKEY_size(pkey.get()));\n   EVPKeyCtxPointer pkctx(EVP_PKEY_CTX_new(pkey.get(), nullptr));\n   if (pkctx &&\n       EVP_PKEY_sign_init(pkctx.get()) > 0 &&\n       ApplyRSAOptions(pkey, pkctx.get(), padding, pss_salt_len) &&\n       EVP_PKEY_CTX_set_signature_md(pkctx.get(),\n                                     EVP_MD_CTX_md(mdctx.get())) > 0 &&\n-      EVP_PKEY_sign(pkctx.get(), md, &sltmp, m, m_len) > 0) {\n-    *sig_len = sltmp;\n-    return 1;\n+      EVP_PKEY_sign(pkctx.get(), sig.data, &sig_len, m, m_len) > 0) {\n+    sig.Truncate(sig_len);\n+    return sig;\n   }\n-  return 0;\n+\n+  return MallocedBuffer<unsigned char>();\n }\n \n-SignBase::Error Sign::SignFinal(const char* key_pem,\n-                                int key_pem_len,\n-                                const char* passphrase,\n-                                unsigned char* sig,\n-                                unsigned int* sig_len,\n-                                int padding,\n-                                int salt_len) {\n+std::pair<SignBase::Error, MallocedBuffer<unsigned char>> Sign::SignFinal(\n+    const char* key_pem,\n+    int key_pem_len,\n+    const char* passphrase,\n+    int padding,\n+    int salt_len) {\n+  MallocedBuffer<unsigned char> buffer;\n+\n   if (!mdctx_)\n-    return kSignNotInitialised;\n+    return std::make_pair(kSignNotInitialised, std::move(buffer));\n \n   EVPMDPointer mdctx = std::move(mdctx_);\n \n   BIOPointer bp(BIO_new_mem_buf(const_cast<char*>(key_pem), key_pem_len));\n   if (!bp)\n-    return kSignPrivateKey;\n+    return std::make_pair(kSignPrivateKey, std::move(buffer));\n \n   EVPKeyPointer pkey(PEM_read_bio_PrivateKey(bp.get(),\n                                              nullptr,\n@@ -3573,7 +3579,7 @@ SignBase::Error Sign::SignFinal(const char* key_pem,\n   // without `pkey` being set to nullptr;\n   // cf. the test of `test_bad_rsa_privkey.pem` for an example.\n   if (!pkey || 0 != ERR_peek_error())\n-    return kSignPrivateKey;\n+    return std::make_pair(kSignPrivateKey, std::move(buffer));\n \n #ifdef NODE_FIPS_MODE\n   /* Validate DSA2 parameters from FIPS 186-4 */\n@@ -3597,10 +3603,9 @@ SignBase::Error Sign::SignFinal(const char* key_pem,\n   }\n #endif  // NODE_FIPS_MODE\n \n-  if (Node_SignFinal(std::move(mdctx), sig, sig_len, pkey, padding, salt_len))\n-    return kSignOk;\n-  else\n-    return kSignPrivateKey;\n+  buffer = Node_SignFinal(std::move(mdctx), pkey, padding, salt_len);\n+  Error error = buffer.is_empty() ? kSignPrivateKey : kSignOk;\n+  return std::make_pair(error, std::move(buffer));\n }\n \n \n@@ -3624,22 +3629,22 @@ void Sign::SignFinal(const FunctionCallbackInfo<Value>& args) {\n   int salt_len = args[3].As<Int32>()->Value();\n \n   ClearErrorOnReturn clear_error_on_return;\n-  unsigned char md_value[8192];\n-  unsigned int md_len = sizeof(md_value);\n \n-  Error err = sign->SignFinal(\n+  std::pair<Error, MallocedBuffer<unsigned char>> ret = sign->SignFinal(\n       buf,\n       buf_len,\n       len >= 2 && !args[1]->IsNull() ? *passphrase : nullptr,\n-      md_value,\n-      &md_len,\n       padding,\n       salt_len);\n-  if (err != kSignOk)\n-    return sign->CheckThrow(err);\n+\n+  if (std::get<Error>(ret) != kSignOk)\n+    return sign->CheckThrow(std::get<Error>(ret));\n+\n+  MallocedBuffer<unsigned char> sig =\n+      std::move(std::get<MallocedBuffer<unsigned char>>(ret));\n \n   Local<Object> rc =\n-      Buffer::Copy(env, reinterpret_cast<char*>(md_value), md_len)\n+      Buffer::New(env, reinterpret_cast<char*>(sig.release()), sig.size)\n       .ToLocalChecked();\n   args.GetReturnValue().Set(rc);\n }"
        },
        {
            "sha": "9603fcf3b2edb45508a89c92a59fb933652d4f12",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=7bd2912669c8975523b6d77269d29207d3ea9769",
            "patch": "@@ -518,13 +518,12 @@ class Sign : public SignBase {\n  public:\n   static void Initialize(Environment* env, v8::Local<v8::Object> target);\n \n-  Error SignFinal(const char* key_pem,\n-                  int key_pem_len,\n-                  const char* passphrase,\n-                  unsigned char* sig,\n-                  unsigned int* sig_len,\n-                  int padding,\n-                  int saltlen);\n+  std::pair<Error, MallocedBuffer<unsigned char>> SignFinal(\n+      const char* key_pem,\n+      int key_pem_len,\n+      const char* passphrase,\n+      int padding,\n+      int saltlen);\n \n  protected:\n   static void New(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "880408df4d57fdff864dff6cf52f5d0c2d97b037",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/7bd2912669c8975523b6d77269d29207d3ea9769/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=7bd2912669c8975523b6d77269d29207d3ea9769",
            "patch": "@@ -439,9 +439,14 @@ struct MallocedBuffer {\n     return ret;\n   }\n \n+  void Truncate(size_t new_size) {\n+    CHECK(new_size <= size);\n+    size = new_size;\n+  }\n+\n   inline bool is_empty() const { return data == nullptr; }\n \n-  MallocedBuffer() : data(nullptr) {}\n+  MallocedBuffer() : data(nullptr), size(0) {}\n   explicit MallocedBuffer(size_t size) : data(Malloc<T>(size)), size(size) {}\n   MallocedBuffer(T* data, size_t size) : data(data), size(size) {}\n   MallocedBuffer(MallocedBuffer&& other) : data(other.data), size(other.size) {"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 50,
        "deletions": 41
    }
}