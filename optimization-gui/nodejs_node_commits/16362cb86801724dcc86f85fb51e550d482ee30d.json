{
    "author": "addaleax",
    "message": "src: make `StreamPipe::Unpipe()` more resilient\n\nClean up `StreamPipe::Unpipe()` to be more resilient against\nunexpected exceptions, in particular while executing its\n`MakeCallback()` line (which can fail in the presence of\ntermination exceptions), and clean up the getter/setter part\nof the code to match that pattern as well (even though it should\nnot fail as part of regular operations).\n\nPR-URL: https://github.com/nodejs/node/pull/25716\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "16362cb86801724dcc86f85fb51e550d482ee30d",
    "files": [
        {
            "sha": "19d732d6592aaadd9ead8e82436ba34c4f3886d2",
            "filename": "src/stream_pipe.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 17,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/16362cb86801724dcc86f85fb51e550d482ee30d/src%2Fstream_pipe.cc",
            "raw_url": "https://github.com/nodejs/node/raw/16362cb86801724dcc86f85fb51e550d482ee30d/src%2Fstream_pipe.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_pipe.cc?ref=16362cb86801724dcc86f85fb51e550d482ee30d",
            "patch": "@@ -4,6 +4,7 @@\n \n using v8::Context;\n using v8::External;\n+using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n using v8::Local;\n@@ -77,30 +78,35 @@ void StreamPipe::Unpipe() {\n     Context::Scope context_scope(env->context());\n     Local<Object> object = pipe->object();\n \n-    if (object->Has(env->context(), env->onunpipe_string()).FromJust()) {\n-      pipe->MakeCallback(env->onunpipe_string(), 0, nullptr).ToLocalChecked();\n+    Local<Value> onunpipe;\n+    if (!object->Get(env->context(), env->onunpipe_string()).ToLocal(&onunpipe))\n+      return;\n+    if (onunpipe->IsFunction() &&\n+        pipe->MakeCallback(onunpipe.As<Function>(), 0, nullptr).IsEmpty()) {\n+      return;\n     }\n \n     // Set all the links established in the constructor to `null`.\n     Local<Value> null = Null(env->isolate());\n \n     Local<Value> source_v;\n     Local<Value> sink_v;\n-    source_v = object->Get(env->context(), env->source_string())\n-        .ToLocalChecked();\n-    sink_v = object->Get(env->context(), env->sink_string())\n-        .ToLocalChecked();\n-    CHECK(source_v->IsObject());\n-    CHECK(sink_v->IsObject());\n-\n-    object->Set(env->context(), env->source_string(), null).FromJust();\n-    object->Set(env->context(), env->sink_string(), null).FromJust();\n-    source_v.As<Object>()->Set(env->context(),\n-                               env->pipe_target_string(),\n-                               null).FromJust();\n-    sink_v.As<Object>()->Set(env->context(),\n-                             env->pipe_source_string(),\n-                             null).FromJust();\n+    if (!object->Get(env->context(), env->source_string()).ToLocal(&source_v) ||\n+        !object->Get(env->context(), env->sink_string()).ToLocal(&sink_v) ||\n+        !source_v->IsObject() || !sink_v->IsObject()) {\n+      return;\n+    }\n+\n+    if (object->Set(env->context(), env->source_string(), null).IsNothing() ||\n+        object->Set(env->context(), env->sink_string(), null).IsNothing() ||\n+        source_v.As<Object>()\n+            ->Set(env->context(), env->pipe_target_string(), null)\n+            .IsNothing() ||\n+        sink_v.As<Object>()\n+            ->Set(env->context(), env->pipe_source_string(), null)\n+            .IsNothing()) {\n+      return;\n+    }\n   }, static_cast<void*>(this), object());\n }\n "
        }
    ],
    "stats": {
        "total": 40,
        "additions": 23,
        "deletions": 17
    }
}