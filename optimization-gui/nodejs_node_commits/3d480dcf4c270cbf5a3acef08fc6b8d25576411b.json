{
    "author": "apapirovski",
    "message": "http: fix _dump regression\n\nA recent set of changes removed _consuming tracking from server\nincoming messages which ensures that _dump only runs if the\nuser has never attempted to read the incoming data. Fix by\nreintroducing _consuming which tracks whether _read was ever\nsuccessfully called.\n\nPR-URL: https://github.com/nodejs/node/pull/20088\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "3d480dcf4c270cbf5a3acef08fc6b8d25576411b",
    "files": [
        {
            "sha": "55c196399c5e6bf54e4f47466419d19918a96a61",
            "filename": "lib/_http_incoming.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/lib%2F_http_incoming.js",
            "raw_url": "https://github.com/nodejs/node/raw/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/lib%2F_http_incoming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_incoming.js?ref=3d480dcf4c270cbf5a3acef08fc6b8d25576411b",
            "patch": "@@ -38,6 +38,8 @@ function readStop(socket) {\n function IncomingMessage(socket) {\n   Stream.Readable.call(this);\n \n+  this._readableState.readingMore = true;\n+\n   this.socket = socket;\n   this.connection = socket;\n \n@@ -63,6 +65,7 @@ function IncomingMessage(socket) {\n   this.statusMessage = null;\n   this.client = socket;\n \n+  this._consuming = false;\n   // flag for when we decide that this message cannot possibly be\n   // read by the user, so there's no point continuing to handle it.\n   this._dumped = false;\n@@ -79,6 +82,11 @@ IncomingMessage.prototype.setTimeout = function setTimeout(msecs, callback) {\n \n \n IncomingMessage.prototype._read = function _read(n) {\n+  if (!this._consuming) {\n+    this._readableState.readingMore = false;\n+    this._consuming = true;\n+  }\n+\n   // We actually do almost nothing here, because the parserOnBody\n   // function fills up our internal buffer directly.  However, we\n   // do need to unpause the underlying socket so that it flows."
        },
        {
            "sha": "c3abfd37bb5887661becb6156e77732720c3ff43",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=3d480dcf4c270cbf5a3acef08fc6b8d25576411b",
            "patch": "@@ -560,7 +560,7 @@ function resOnFinish(req, res, socket, state, server) {\n   // if the user never called req.read(), and didn't pipe() or\n   // .resume() or .on('data'), then we call req._dump() so that the\n   // bytes will be pulled off the wire.\n-  if (!req._readableState.resumeScheduled)\n+  if (!req._consuming && !req._readableState.resumeScheduled)\n     req._dump();\n \n   res.detachSocket(socket);"
        },
        {
            "sha": "b794634c4893269f2a940a71024b965b77e30d6b",
            "filename": "test/parallel/test-http-pause-no-dump.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/test%2Fparallel%2Ftest-http-pause-no-dump.js",
            "raw_url": "https://github.com/nodejs/node/raw/3d480dcf4c270cbf5a3acef08fc6b8d25576411b/test%2Fparallel%2Ftest-http-pause-no-dump.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-pause-no-dump.js?ref=3d480dcf4c270cbf5a3acef08fc6b8d25576411b",
            "patch": "@@ -0,0 +1,33 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const http = require('http');\n+\n+const server = http.createServer(common.mustCall(function(req, res) {\n+  req.once('data', common.mustCall(() => {\n+    req.pause();\n+    res.writeHead(200);\n+    res.end();\n+    res.on('finish', common.mustCall(() => {\n+      assert(!req._dumped);\n+    }));\n+  }));\n+}));\n+server.listen(0);\n+\n+server.on('listening', common.mustCall(function() {\n+  const req = http.request({\n+    port: this.address().port,\n+    method: 'POST',\n+    path: '/'\n+  }, common.mustCall(function(res) {\n+    assert.strictEqual(res.statusCode, 200);\n+    res.resume();\n+    res.on('end', common.mustCall(() => {\n+      server.close();\n+    }));\n+  }));\n+\n+  req.end(Buffer.allocUnsafe(1024));\n+}));"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 42,
        "deletions": 1
    }
}