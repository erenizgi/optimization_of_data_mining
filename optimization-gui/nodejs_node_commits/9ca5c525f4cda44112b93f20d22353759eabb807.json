{
    "author": "apapirovski",
    "message": "timers: fix priority queue removeAt\n\nPR-URL: https://github.com/nodejs/node/pull/24322\nFixes: https://github.com/nodejs/node/issues/24320\nFixes: https://github.com/nodejs/node/issues/24362\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Weijia Wang <starkwang@126.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "9ca5c525f4cda44112b93f20d22353759eabb807",
    "files": [
        {
            "sha": "ec8bbaea41276161ef1e5baf30e427a01c930af0",
            "filename": "lib/internal/priority_queue.js",
            "status": "modified",
            "additions": 28,
            "deletions": 21,
            "changes": 49,
            "blob_url": "https://github.com/nodejs/node/blob/9ca5c525f4cda44112b93f20d22353759eabb807/lib%2Finternal%2Fpriority_queue.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ca5c525f4cda44112b93f20d22353759eabb807/lib%2Finternal%2Fpriority_queue.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpriority_queue.js?ref=9ca5c525f4cda44112b93f20d22353759eabb807",
            "patch": "@@ -28,25 +28,13 @@ module.exports = class PriorityQueue {\n \n   insert(value) {\n     const heap = this[kHeap];\n-    let pos = ++this[kSize];\n+    const pos = ++this[kSize];\n+    heap[pos] = value;\n \n     if (heap.length === pos)\n       heap.length *= 2;\n \n-    const compare = this[kCompare];\n-    const setPosition = this[kSetPosition];\n-    while (pos > 1) {\n-      const parent = heap[pos / 2 | 0];\n-      if (compare(parent, value) <= 0)\n-        break;\n-      heap[pos] = parent;\n-      if (setPosition !== undefined)\n-        setPosition(parent, pos);\n-      pos = pos / 2 | 0;\n-    }\n-    heap[pos] = value;\n-    if (setPosition !== undefined)\n-      setPosition(value, pos);\n+    this.percolateUp(pos);\n   }\n \n   peek() {\n@@ -77,18 +65,37 @@ module.exports = class PriorityQueue {\n       setPosition(item, pos);\n   }\n \n+  percolateUp(pos) {\n+    const heap = this[kHeap];\n+    const compare = this[kCompare];\n+    const setPosition = this[kSetPosition];\n+    const item = heap[pos];\n+\n+    while (pos > 1) {\n+      const parent = heap[pos / 2 | 0];\n+      if (compare(parent, item) <= 0)\n+        break;\n+      heap[pos] = parent;\n+      if (setPosition !== undefined)\n+        setPosition(parent, pos);\n+      pos = pos / 2 | 0;\n+    }\n+    heap[pos] = item;\n+    if (setPosition !== undefined)\n+      setPosition(item, pos);\n+  }\n+\n   removeAt(pos) {\n     const heap = this[kHeap];\n     const size = --this[kSize];\n     heap[pos] = heap[size + 1];\n     heap[size + 1] = undefined;\n \n-    if (size > 0) {\n-      // If not removing the last item, update the shifted item's position.\n-      if (pos <= size && this[kSetPosition] !== undefined)\n-        this[kSetPosition](heap[pos], pos);\n-\n-      this.percolateDown(1);\n+    if (size > 0 && pos <= size) {\n+      if (pos > 1 && this[kCompare](heap[pos / 2 | 0], heap[pos]) > 0)\n+        this.percolateUp(pos);\n+      else\n+        this.percolateDown(pos);\n     }\n   }\n "
        },
        {
            "sha": "f8526e6521c24bf20a959675e8915069da386507",
            "filename": "test/parallel/test-priority-queue.js",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/9ca5c525f4cda44112b93f20d22353759eabb807/test%2Fparallel%2Ftest-priority-queue.js",
            "raw_url": "https://github.com/nodejs/node/raw/9ca5c525f4cda44112b93f20d22353759eabb807/test%2Fparallel%2Ftest-priority-queue.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-priority-queue.js?ref=9ca5c525f4cda44112b93f20d22353759eabb807",
            "patch": "@@ -131,3 +131,33 @@ const PriorityQueue = require('internal/priority_queue');\n \n   assert.strictEqual(queue.shift(), undefined);\n }\n+\n+\n+{\n+  // Checks that removeAt respects binary heap properties\n+  const queue = new PriorityQueue((a, b) => {\n+    return a.value - b.value;\n+  }, (node, pos) => (node.position = pos));\n+\n+  const i3 = { value: 3, position: null };\n+  const i7 = { value: 7, position: null };\n+  const i8 = { value: 8, position: null };\n+\n+  queue.insert({ value: 1, position: null });\n+  queue.insert({ value: 6, position: null });\n+  queue.insert({ value: 2, position: null });\n+  queue.insert(i7);\n+  queue.insert(i8);\n+  queue.insert(i3);\n+\n+  assert.strictEqual(i7.position, 4);\n+  queue.removeAt(4);\n+\n+  // 3 should percolate up to swap with 6 (up)\n+  assert.strictEqual(i3.position, 2);\n+\n+  queue.removeAt(2);\n+\n+  // 8 should swap places with 6 (down)\n+  assert.strictEqual(i8.position, 4);\n+}"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 58,
        "deletions": 21
    }
}