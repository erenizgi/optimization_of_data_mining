{
    "author": "addaleax",
    "message": "tracing: use ‘real’ atomics\n\nUse actual atomic operations instead of things that are\nnamed as if they were atomics, but aren’t.\n\nRefs: https://github.com/nodejs/node/issues/26100\n\nPR-URL: https://github.com/nodejs/node/pull/26156\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>",
    "sha": "1c71c0cb9a24dd3e3fa1fb2eb191df62746f9031",
    "files": [
        {
            "sha": "590cb592fc054f90ffc85052985087db6c3c3463",
            "filename": "src/tracing/trace_event.h",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/1c71c0cb9a24dd3e3fa1fb2eb191df62746f9031/src%2Ftracing%2Ftrace_event.h",
            "raw_url": "https://github.com/nodejs/node/raw/1c71c0cb9a24dd3e3fa1fb2eb191df62746f9031/src%2Ftracing%2Ftrace_event.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.h?ref=1c71c0cb9a24dd3e3fa1fb2eb191df62746f9031",
            "patch": "@@ -8,6 +8,7 @@\n #include \"node_platform.h\"\n #include \"v8-platform.h\"\n #include \"trace_event_common.h\"\n+#include <atomic>\n \n // This header file defines implementation details of how the trace macros in\n // trace_event_common.h collect and store trace events. Anything not\n@@ -128,9 +129,10 @@ enum CategoryGroupEnabledFlags {\n #define TRACE_EVENT_API_ADD_METADATA_EVENT node::tracing::AddMetadataEvent\n \n // Defines atomic operations used internally by the tracing system.\n-#define TRACE_EVENT_API_ATOMIC_WORD intptr_t\n-#define TRACE_EVENT_API_ATOMIC_LOAD(var) (var)\n-#define TRACE_EVENT_API_ATOMIC_STORE(var, value) (var) = (value)\n+#define TRACE_EVENT_API_ATOMIC_WORD std::atomic<intptr_t>\n+#define TRACE_EVENT_API_ATOMIC_WORD_VALUE intptr_t\n+#define TRACE_EVENT_API_ATOMIC_LOAD(var) (var).load()\n+#define TRACE_EVENT_API_ATOMIC_STORE(var, value) (var).store(value)\n \n ////////////////////////////////////////////////////////////////////////////////\n \n@@ -157,12 +159,12 @@ enum CategoryGroupEnabledFlags {\n     category_group_enabled =                                                 \\\n         TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(category_group);          \\\n     TRACE_EVENT_API_ATOMIC_STORE(                                            \\\n-        atomic, reinterpret_cast<TRACE_EVENT_API_ATOMIC_WORD>(               \\\n+        atomic, reinterpret_cast<TRACE_EVENT_API_ATOMIC_WORD_VALUE>(         \\\n                     category_group_enabled));                                \\\n   }\n \n #define INTERNAL_TRACE_EVENT_GET_CATEGORY_INFO(category_group)             \\\n-  static TRACE_EVENT_API_ATOMIC_WORD INTERNAL_TRACE_EVENT_UID(atomic) = 0; \\\n+  static TRACE_EVENT_API_ATOMIC_WORD INTERNAL_TRACE_EVENT_UID(atomic) {0}; \\\n   const uint8_t* INTERNAL_TRACE_EVENT_UID(category_group_enabled);         \\\n   INTERNAL_TRACE_EVENT_GET_CATEGORY_INFO_CUSTOM_VARIABLES(                 \\\n       category_group, INTERNAL_TRACE_EVENT_UID(atomic),                    \\"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 7,
        "deletions": 5
    }
}