{
    "author": "bnoordhuis",
    "message": "deps: reject interior blanks in Content-Length\n\nOriginal commit message follows:\n\n    Before this commit `Content-Length: 4 2` was accepted as a valid\n    header and recorded as `parser->content_length = 42`.  Now it is\n    a parse error that fails with error `HPE_INVALID_CONTENT_LENGTH`.\n\n    Downstream users that inspect `parser->content_length` and naively\n    parse the string value using `strtoul()` might get confused by the\n    discrepancy between the two values.  Resolve that by simply not\n    letting it happen.\n\nFixes: https://github.com/nodejs-private/security/issues/178\nPR-URL: https://github.com/nodejs-private/http-parser-private/pull/1\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>\nReviewed-By: Fedor Indutny <fedor.indutny@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>",
    "sha": "38b48a62b851f5895b50204dff0df7608b9fa848",
    "files": [
        {
            "sha": "6522618671d09cbc5fc69d3492880a281234fb82",
            "filename": "deps/http_parser/http_parser.c",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/38b48a62b851f5895b50204dff0df7608b9fa848/deps%2Fhttp_parser%2Fhttp_parser.c",
            "raw_url": "https://github.com/nodejs/node/raw/38b48a62b851f5895b50204dff0df7608b9fa848/deps%2Fhttp_parser%2Fhttp_parser.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fhttp_parser%2Fhttp_parser.c?ref=38b48a62b851f5895b50204dff0df7608b9fa848",
            "patch": "@@ -370,6 +370,8 @@ enum header_states\n \n   , h_connection\n   , h_content_length\n+  , h_content_length_num\n+  , h_content_length_ws\n   , h_transfer_encoding\n   , h_upgrade\n \n@@ -1406,6 +1408,7 @@ size_t http_parser_execute (http_parser *parser,\n \n             parser->flags |= F_CONTENTLENGTH;\n             parser->content_length = ch - '0';\n+            parser->header_state = h_content_length_num;\n             break;\n \n           case h_connection:\n@@ -1493,10 +1496,18 @@ size_t http_parser_execute (http_parser *parser,\n               break;\n \n             case h_content_length:\n+              if (ch == ' ') break;\n+              h_state = h_content_length_num;\n+              /* FALLTHROUGH */\n+\n+            case h_content_length_num:\n             {\n               uint64_t t;\n \n-              if (ch == ' ') break;\n+              if (ch == ' ') {\n+                h_state = h_content_length_ws;\n+                break;\n+              }\n \n               if (UNLIKELY(!IS_NUM(ch))) {\n                 SET_ERRNO(HPE_INVALID_CONTENT_LENGTH);\n@@ -1519,6 +1530,12 @@ size_t http_parser_execute (http_parser *parser,\n               break;\n             }\n \n+            case h_content_length_ws:\n+              if (ch == ' ') break;\n+              SET_ERRNO(HPE_INVALID_CONTENT_LENGTH);\n+              parser->header_state = h_state;\n+              goto error;\n+\n             /* Transfer-Encoding: chunked */\n             case h_matching_transfer_encoding_chunked:\n               parser->index++;"
        },
        {
            "sha": "cb445cea86070175cc1129da426fb1bfafb2f08b",
            "filename": "deps/http_parser/test.c",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/38b48a62b851f5895b50204dff0df7608b9fa848/deps%2Fhttp_parser%2Ftest.c",
            "raw_url": "https://github.com/nodejs/node/raw/38b48a62b851f5895b50204dff0df7608b9fa848/deps%2Fhttp_parser%2Ftest.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fhttp_parser%2Ftest.c?ref=38b48a62b851f5895b50204dff0df7608b9fa848",
            "patch": "@@ -4168,6 +4168,27 @@ main (void)\n   test_invalid_header_field_token_error(HTTP_RESPONSE);\n   test_invalid_header_field_content_error(HTTP_RESPONSE);\n \n+  test_simple_type(\n+      \"POST / HTTP/1.1\\r\\n\"\n+      \"Content-Length:  42 \\r\\n\"  // Note the surrounding whitespace.\n+      \"\\r\\n\",\n+      HPE_OK,\n+      HTTP_REQUEST);\n+\n+  test_simple_type(\n+      \"POST / HTTP/1.1\\r\\n\"\n+      \"Content-Length: 4 2\\r\\n\"\n+      \"\\r\\n\",\n+      HPE_INVALID_CONTENT_LENGTH,\n+      HTTP_REQUEST);\n+\n+  test_simple_type(\n+      \"POST / HTTP/1.1\\r\\n\"\n+      \"Content-Length: 13 37\\r\\n\"\n+      \"\\r\\n\",\n+      HPE_INVALID_CONTENT_LENGTH,\n+      HTTP_REQUEST);\n+\n   //// RESPONSES\n \n   test_simple_type(\"HTP/1.1 200 OK\\r\\n\\r\\n\", HPE_INVALID_VERSION, HTTP_RESPONSE);"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 39,
        "deletions": 1
    }
}