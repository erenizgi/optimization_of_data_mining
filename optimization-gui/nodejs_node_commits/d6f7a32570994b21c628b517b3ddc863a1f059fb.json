{
    "author": "danbev",
    "message": "test: make cctest fixture use node::NewIsolate\n\nThis commit updates the gtest fixture to use node::NewIsolate instead of\ncreating a new V8 Isolate using v8::Isolate::New.\n\nThe motivation for this is that without calling node::NewIsolate the\nvarious callbacks set on the isolate, for example AddMessageListener,\nSetFatalErrorHandler etc, would not get set. I don't think this is the\nexpected behaviour and I ran into this when writing a new cctest.\n\nPR-URL: https://github.com/nodejs/node/pull/21419\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "d6f7a32570994b21c628b517b3ddc863a1f059fb",
    "files": [
        {
            "sha": "1fe6ba477bee65758ff74d695ff37314121e8053",
            "filename": "test/cctest/node_test_fixture.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d6f7a32570994b21c628b517b3ddc863a1f059fb/test%2Fcctest%2Fnode_test_fixture.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d6f7a32570994b21c628b517b3ddc863a1f059fb/test%2Fcctest%2Fnode_test_fixture.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.cc?ref=d6f7a32570994b21c628b517b3ddc863a1f059fb",
            "patch": "@@ -1,7 +1,6 @@\n #include \"node_test_fixture.h\"\n \n+ArrayBufferUniquePtr NodeTestFixture::allocator{nullptr, nullptr};\n uv_loop_t NodeTestFixture::current_loop;\n std::unique_ptr<node::NodePlatform> NodeTestFixture::platform;\n-std::unique_ptr<v8::ArrayBuffer::Allocator> NodeTestFixture::allocator;\n std::unique_ptr<v8::TracingController> NodeTestFixture::tracing_controller;\n-v8::Isolate::CreateParams NodeTestFixture::params;"
        },
        {
            "sha": "c9193ffffa76c7500bf0d8848867509004f82fd6",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/d6f7a32570994b21c628b517b3ddc863a1f059fb/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/d6f7a32570994b21c628b517b3ddc863a1f059fb/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=d6f7a32570994b21c628b517b3ddc863a1f059fb",
            "patch": "@@ -53,13 +53,14 @@ struct Argv {\n   int nr_args_;\n };\n \n+using ArrayBufferUniquePtr = std::unique_ptr<node::ArrayBufferAllocator,\n+      decltype(&node::FreeArrayBufferAllocator)>;\n \n class NodeTestFixture : public ::testing::Test {\n  protected:\n-  static std::unique_ptr<v8::ArrayBuffer::Allocator> allocator;\n+  static ArrayBufferUniquePtr allocator;\n   static std::unique_ptr<v8::TracingController> tracing_controller;\n   static std::unique_ptr<node::NodePlatform> platform;\n-  static v8::Isolate::CreateParams params;\n   static uv_loop_t current_loop;\n   v8::Isolate* isolate_;\n \n@@ -68,8 +69,6 @@ class NodeTestFixture : public ::testing::Test {\n     node::tracing::TraceEventHelper::SetTracingController(\n         tracing_controller.get());\n     platform.reset(new node::NodePlatform(4, nullptr));\n-    allocator.reset(v8::ArrayBuffer::Allocator::NewDefaultAllocator());\n-    params.array_buffer_allocator = allocator.get();\n     CHECK_EQ(0, uv_loop_init(&current_loop));\n     v8::V8::InitializePlatform(platform.get());\n     v8::V8::Initialize();\n@@ -85,7 +84,9 @@ class NodeTestFixture : public ::testing::Test {\n   }\n \n   virtual void SetUp() {\n-    isolate_ = v8::Isolate::New(params);\n+    allocator = ArrayBufferUniquePtr(node::CreateArrayBufferAllocator(),\n+                                     &node::FreeArrayBufferAllocator);\n+    isolate_ = NewIsolate(allocator.get());\n     CHECK_NE(isolate_, nullptr);\n   }\n "
        }
    ],
    "stats": {
        "total": 14,
        "additions": 7,
        "deletions": 7
    }
}