{
    "author": "addaleax",
    "message": "test: plug AliasedBuffer cctest memory leak\n\nNo need to heap-allocate values here.\n\nPR-URL: https://github.com/nodejs/node/pull/20665\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "19c9ff5a920b1915aa6868bd5ecfc7c8dd5209cb",
    "files": [
        {
            "sha": "b2f29d3b7cb1abd94432be37d989a37be1ade320",
            "filename": "test/cctest/test_aliased_buffer.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 42,
            "changes": 79,
            "blob_url": "https://github.com/nodejs/node/blob/19c9ff5a920b1915aa6868bd5ecfc7c8dd5209cb/test%2Fcctest%2Ftest_aliased_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/19c9ff5a920b1915aa6868bd5ecfc7c8dd5209cb/test%2Fcctest%2Ftest_aliased_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_aliased_buffer.cc?ref=19c9ff5a920b1915aa6868bd5ecfc7c8dd5209cb",
            "patch": "@@ -8,28 +8,26 @@ using node::AliasedBuffer;\n class AliasBufferTest : public NodeTestFixture {};\n \n template<class NativeT>\n-void CreateOracleValues(NativeT* buf, size_t count) {\n-  for (size_t i = 0, j = count; i < count; i++, j--) {\n-    buf[i] = static_cast<NativeT>(j);\n+void CreateOracleValues(std::vector<NativeT>* buf) {\n+  for (size_t i = 0, j = buf->size(); i < buf->size(); i++, j--) {\n+    (*buf)[i] = static_cast<NativeT>(j);\n   }\n }\n \n template<class NativeT, class V8T>\n void WriteViaOperator(AliasedBuffer<NativeT, V8T>* aliasedBuffer,\n-                      size_t size,\n-                      NativeT* oracle) {\n+                      const std::vector<NativeT>& oracle) {\n   // write through the API\n-  for (size_t i = 0; i < size; i++) {\n+  for (size_t i = 0; i < oracle.size(); i++) {\n     (*aliasedBuffer)[i] = oracle[i];\n   }\n }\n \n template<class NativeT, class V8T>\n void WriteViaSetValue(AliasedBuffer<NativeT, V8T>* aliasedBuffer,\n-                      size_t size,\n-                      NativeT* oracle) {\n+                      const std::vector<NativeT>& oracle) {\n   // write through the API\n-  for (size_t i = 0; i < size; i++) {\n+  for (size_t i = 0; i < oracle.size(); i++) {\n     aliasedBuffer->SetValue(i, oracle[i]);\n   }\n }\n@@ -38,27 +36,26 @@ template<class NativeT, class V8T>\n void ReadAndValidate(v8::Isolate* isolate,\n                      v8::Local<v8::Context> context,\n                      AliasedBuffer<NativeT, V8T>* aliasedBuffer,\n-                     size_t size,\n-                     NativeT* oracle) {\n+                     const std::vector<NativeT>& oracle) {\n   // read through the API\n-  for (size_t i = 0; i < size; i++) {\n+  for (size_t i = 0; i < oracle.size(); i++) {\n     NativeT v1 = (*aliasedBuffer)[i];\n     NativeT v2 = aliasedBuffer->GetValue(i);\n     EXPECT_TRUE(v1 == oracle[i]);\n     EXPECT_TRUE(v2 == oracle[i]);\n   }\n \n   // validate size of JS Buffer\n-  EXPECT_TRUE(aliasedBuffer->GetJSArray()->Length() == size);\n+  EXPECT_TRUE(aliasedBuffer->GetJSArray()->Length() == oracle.size());\n   EXPECT_TRUE(\n     aliasedBuffer->GetJSArray()->ByteLength() ==\n-    (size * sizeof(NativeT)));\n+    (oracle.size() * sizeof(NativeT)));\n \n   // validate operator * and GetBuffer are the same\n   EXPECT_TRUE(aliasedBuffer->GetNativeBuffer() == *(*aliasedBuffer));\n \n   // read through the JS API\n-  for (size_t i = 0; i < size; i++) {\n+  for (size_t i = 0; i < oracle.size(); i++) {\n     v8::Local<V8T> v8TypedArray = aliasedBuffer->GetJSArray();\n     v8::MaybeLocal<v8::Value> v = v8TypedArray->Get(context, i);\n     EXPECT_TRUE(v.IsEmpty() == false);\n@@ -80,21 +77,19 @@ void ReadWriteTest(v8::Isolate* isolate) {\n \n   const size_t size = 100;\n   AliasedBuffer<NativeT, V8T> ab(isolate, size);\n-  NativeT* oracle = new NativeT[size];\n-  CreateOracleValues(oracle, size);\n-  WriteViaOperator(&ab, size, oracle);\n-  ReadAndValidate(isolate, context, &ab, size, oracle);\n+  std::vector<NativeT> oracle(size);\n+  CreateOracleValues(&oracle);\n+  WriteViaOperator(&ab, oracle);\n+  ReadAndValidate(isolate, context, &ab, oracle);\n \n-  WriteViaSetValue(&ab, size, oracle);\n+  WriteViaSetValue(&ab, oracle);\n \n   // validate copy constructor\n   {\n     AliasedBuffer<NativeT, V8T> ab2(ab);\n-    ReadAndValidate(isolate, context, &ab2, size, oracle);\n+    ReadAndValidate(isolate, context, &ab2, oracle);\n   }\n-  ReadAndValidate(isolate, context, &ab, size, oracle);\n-\n-  delete[] oracle;\n+  ReadAndValidate(isolate, context, &ab, oracle);\n }\n \n template<\n@@ -124,28 +119,28 @@ void SharedBufferTest(\n   AliasedBuffer<NativeT_C, V8T_C> ab_C(\n       isolate, sizeInBytes_A + sizeInBytes_B, count_C, rootBuffer);\n \n-  NativeT_A* oracle_A = new NativeT_A[count_A];\n-  NativeT_B* oracle_B = new NativeT_B[count_B];\n-  NativeT_C* oracle_C = new NativeT_C[count_C];\n-  CreateOracleValues(oracle_A, count_A);\n-  CreateOracleValues(oracle_B, count_B);\n-  CreateOracleValues(oracle_C, count_C);\n+  std::vector<NativeT_A> oracle_A(count_A);\n+  std::vector<NativeT_B> oracle_B(count_B);\n+  std::vector<NativeT_C> oracle_C(count_C);\n+  CreateOracleValues(&oracle_A);\n+  CreateOracleValues(&oracle_B);\n+  CreateOracleValues(&oracle_C);\n \n-  WriteViaOperator(&ab_A, count_A, oracle_A);\n-  WriteViaOperator(&ab_B, count_B, oracle_B);\n-  WriteViaOperator(&ab_C, count_C, oracle_C);\n+  WriteViaOperator(&ab_A, oracle_A);\n+  WriteViaOperator(&ab_B, oracle_B);\n+  WriteViaOperator(&ab_C, oracle_C);\n \n-  ReadAndValidate(isolate, context, &ab_A, count_A, oracle_A);\n-  ReadAndValidate(isolate, context, &ab_B, count_B, oracle_B);\n-  ReadAndValidate(isolate, context, &ab_C, count_C, oracle_C);\n+  ReadAndValidate(isolate, context, &ab_A, oracle_A);\n+  ReadAndValidate(isolate, context, &ab_B, oracle_B);\n+  ReadAndValidate(isolate, context, &ab_C, oracle_C);\n \n-  WriteViaSetValue(&ab_A, count_A, oracle_A);\n-  WriteViaSetValue(&ab_B, count_B, oracle_B);\n-  WriteViaSetValue(&ab_C, count_C, oracle_C);\n+  WriteViaSetValue(&ab_A, oracle_A);\n+  WriteViaSetValue(&ab_B, oracle_B);\n+  WriteViaSetValue(&ab_C, oracle_C);\n \n-  ReadAndValidate(isolate, context, &ab_A, count_A, oracle_A);\n-  ReadAndValidate(isolate, context, &ab_B, count_B, oracle_B);\n-  ReadAndValidate(isolate, context, &ab_C, count_C, oracle_C);\n+  ReadAndValidate(isolate, context, &ab_A, oracle_A);\n+  ReadAndValidate(isolate, context, &ab_B, oracle_B);\n+  ReadAndValidate(isolate, context, &ab_C, oracle_C);\n }\n \n TEST_F(AliasBufferTest, Uint8Array) {"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 37,
        "deletions": 42
    }
}