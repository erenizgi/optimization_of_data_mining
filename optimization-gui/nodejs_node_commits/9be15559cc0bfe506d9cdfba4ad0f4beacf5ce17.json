{
    "author": "unknown",
    "message": "build: enabling pgo at configure\n\nThis modification allows for compiling with profiled guided\noptimization (pgo) using the flags\n--enable-pgo-generate and --enable-pgo-use.\n\nRefs: https://github.com/nodejs/node/issues/21583\nRefs: https://github.com/nodejs/node/issues/1409\nPR-URL: https://github.com/nodejs/node/pull/21596\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17",
    "files": [
        {
            "sha": "13bcb6742a81166a0f5791e11eb7755e12f473d5",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17",
            "patch": "@@ -179,9 +179,19 @@\n           }],\n           ['OS==\"linux\"', {\n             'variables': {\n+              'pgo_generate': ' -fprofile-generate ',\n+              'pgo_use': ' -fprofile-use -fprofile-correction ',\n               'lto': ' -flto=4 -fuse-linker-plugin -ffat-lto-objects ',\n             },\n             'conditions': [\n+              ['enable_pgo_generate==\"true\"', {\n+                'cflags': ['<(pgo_generate)'],\n+                'ldflags': ['<(pgo_generate)'],\n+              },],\n+              ['enable_pgo_use==\"true\"', {\n+                'cflags': ['<(pgo_use)'],\n+                'ldflags': ['<(pgo_use)'],\n+              },],\n               ['enable_lto==\"true\"', {\n                 'cflags': ['<(lto)'],\n                 'ldflags': ['<(lto)'],"
        },
        {
            "sha": "c04118e9832b0c1ea45c1a7b380c38c9221b7ddc",
            "filename": "configure",
            "status": "modified",
            "additions": 51,
            "deletions": 10,
            "changes": 61,
            "blob_url": "https://github.com/nodejs/node/blob/9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17/configure",
            "raw_url": "https://github.com/nodejs/node/raw/9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=9be15559cc0bfe506d9cdfba4ad0f4beacf5ce17",
            "patch": "@@ -157,11 +157,23 @@ parser.add_option(\"--enable-vtune-profiling\",\n          \"JavaScript code executed in nodejs. This feature is only available \"\n          \"for x32, x86, and x64 architectures.\")\n \n+parser.add_option(\"--enable-pgo-generate\",\n+    action=\"store_true\",\n+    dest=\"enable_pgo_generate\",\n+    help=\"Enable profiling with pgo of a binary. This feature is only available \"\n+         \"on linux with gcc and g++ 5.4.1 or newer.\")\n+\n+parser.add_option(\"--enable-pgo-use\",\n+    action=\"store_true\",\n+    dest=\"enable_pgo_use\",\n+    help=\"Enable use of the profile generated with --enable-pgo-generate. This \"\n+         \"feature is only available on linux with gcc and g++ 5.4.1 or newer.\")\n+\n parser.add_option(\"--enable-lto\",\n     action=\"store_true\",\n     dest=\"enable_lto\",\n     help=\"Enable compiling with lto of a binary. This feature is only available \"\n-         \"on linux with gcc and g++.\")\n+         \"on linux with gcc and g++ 5.4.1 or newer.\")\n \n parser.add_option(\"--link-module\",\n     action=\"append\",\n@@ -898,6 +910,16 @@ def configure_mips(o):\n   o['variables']['mips_fpu_mode'] = options.mips_fpu_mode\n \n \n+def gcc_version_ge(version_checked):\n+  for compiler in [(CC, 'c'), (CXX, 'c++')]:\n+    ok, is_clang, clang_version, compiler_version = \\\n+      try_check_compiler(compiler[0], compiler[1])\n+    compiler_version_num = tuple(map(int, compiler_version))\n+    if is_clang or compiler_version_num < version_checked:\n+      return False\n+  return True\n+\n+\n def configure_node(o):\n   if options.dest_os == 'android':\n     o['variables']['OS'] = 'android'\n@@ -942,22 +964,41 @@ def configure_node(o):\n   else:\n     o['variables']['node_enable_v8_vtunejit'] = 'false'\n \n+  if flavor != 'linux' and (options.enable_pgo_generate or options.enable_pgo_use):\n+    raise Exception(\n+      'The pgo option is supported only on linux.')\n+\n+  if flavor == 'linux':\n+    if options.enable_pgo_generate or options.enable_pgo_use:\n+      version_checked = (5, 4, 1)\n+      if not gcc_version_ge(version_checked):\n+        version_checked_str = \".\".join(map(str, version_checked))\n+        raise Exception(\n+          'The options --enable-pgo-generate and --enable-pgo-use '\n+          'are supported for gcc and gxx %s or newer only.' % (version_checked_str))\n+\n+    if options.enable_pgo_generate and options.enable_pgo_use:\n+      raise Exception(\n+        'Only one of the --enable-pgo-generate or --enable-pgo-use options '\n+        'can be specified at a time. You would like to use '\n+        '--enable-pgo-generate first, profile node, and then recompile '\n+        'with --enable-pgo-use')\n+\n+  o['variables']['enable_pgo_generate'] = b(options.enable_pgo_generate)\n+  o['variables']['enable_pgo_use']      = b(options.enable_pgo_use)\n+\n   if flavor != 'linux' and (options.enable_lto):\n     raise Exception(\n       'The lto option is supported only on linux.')\n \n   if flavor == 'linux':\n     if options.enable_lto:\n       version_checked = (5, 4, 1)\n-      for compiler in [(CC, 'c'), (CXX, 'c++')]:\n-        ok, is_clang, clang_version, compiler_version = \\\n-          try_check_compiler(compiler[0], compiler[1])\n-        compiler_version_num = tuple(map(int, compiler_version))\n-        if is_clang or compiler_version_num < version_checked:\n-          version_checked_str = \".\".join(map(str, version_checked))\n-          raise Exception(\n-            'The option --enable-lto is supported for gcc and gxx %s'\n-            ' or newer only.' % (version_checked_str))\n+      if not gcc_version_ge(version_checked):\n+        version_checked_str = \".\".join(map(str, version_checked))\n+        raise Exception(\n+          'The option --enable-lto is supported for gcc and gxx %s'\n+          ' or newer only.' % (version_checked_str))\n \n   o['variables']['enable_lto'] = b(options.enable_lto)\n "
        }
    ],
    "stats": {
        "total": 71,
        "additions": 61,
        "deletions": 10
    }
}