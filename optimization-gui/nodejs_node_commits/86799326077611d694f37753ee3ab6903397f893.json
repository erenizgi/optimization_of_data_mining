{
    "author": "addaleax",
    "message": "src: add WeakReference utility\n\nAdd a simple `WeakReference` utility that we can use until the\nlanguage provides something on its own.\n\nPR-URL: https://github.com/nodejs/node/pull/25993\nFixes: https://github.com/nodejs/node/issues/23862\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: Vladimir de Turckheim <vlad2t@hotmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "86799326077611d694f37753ee3ab6903397f893",
    "files": [
        {
            "sha": "4cca0cbb72aed0a54c68d1b159c1375dabb699f3",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/86799326077611d694f37753ee3ab6903397f893/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/86799326077611d694f37753ee3ab6903397f893/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=86799326077611d694f37753ee3ab6903397f893",
            "patch": "@@ -1,6 +1,7 @@\n #include \"node_errors.h\"\n #include \"node_watchdog.h\"\n #include \"util.h\"\n+#include \"base_object-inl.h\"\n \n namespace node {\n namespace util {\n@@ -11,6 +12,7 @@ using v8::Boolean;\n using v8::Context;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n+using v8::FunctionTemplate;\n using v8::IndexFilter;\n using v8::Integer;\n using v8::Isolate;\n@@ -181,6 +183,37 @@ void EnqueueMicrotask(const FunctionCallbackInfo<Value>& args) {\n   isolate->EnqueueMicrotask(args[0].As<Function>());\n }\n \n+class WeakReference : public BaseObject {\n+ public:\n+  WeakReference(Environment* env, Local<Object> object, Local<Object> target)\n+    : BaseObject(env, object) {\n+    MakeWeak();\n+    target_.Reset(env->isolate(), target);\n+    target_.SetWeak();\n+  }\n+\n+  static void New(const FunctionCallbackInfo<Value>& args) {\n+    Environment* env = Environment::GetCurrent(args);\n+    CHECK(args.IsConstructCall());\n+    CHECK(args[0]->IsObject());\n+    new WeakReference(env, args.This(), args[0].As<Object>());\n+  }\n+\n+  static void Get(const FunctionCallbackInfo<Value>& args) {\n+    WeakReference* weak_ref = Unwrap<WeakReference>(args.Holder());\n+    Isolate* isolate = args.GetIsolate();\n+    if (!weak_ref->target_.IsEmpty())\n+      args.GetReturnValue().Set(weak_ref->target_.Get(isolate));\n+  }\n+\n+  SET_MEMORY_INFO_NAME(WeakReference)\n+  SET_SELF_SIZE(WeakReference)\n+  SET_NO_MEMORY_INFO()\n+\n+ private:\n+  Persistent<Object> target_;\n+};\n+\n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n                 Local<Context> context,\n@@ -241,6 +274,16 @@ void Initialize(Local<Object> target,\n                   should_abort_on_uncaught_toggle,\n                   env->should_abort_on_uncaught_toggle().GetJSArray())\n             .FromJust());\n+\n+  Local<String> weak_ref_string =\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"WeakReference\");\n+  Local<FunctionTemplate> weak_ref =\n+      env->NewFunctionTemplate(WeakReference::New);\n+  weak_ref->InstanceTemplate()->SetInternalFieldCount(1);\n+  weak_ref->SetClassName(weak_ref_string);\n+  env->SetProtoMethod(weak_ref, \"get\", WeakReference::Get);\n+  target->Set(context, weak_ref_string,\n+              weak_ref->GetFunction(context).ToLocalChecked()).FromJust();\n }\n \n }  // namespace util"
        },
        {
            "sha": "b48b34fe2309ea76671c6af043e8e5ac60b7f893",
            "filename": "test/parallel/test-internal-util-weakreference.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/86799326077611d694f37753ee3ab6903397f893/test%2Fparallel%2Ftest-internal-util-weakreference.js",
            "raw_url": "https://github.com/nodejs/node/raw/86799326077611d694f37753ee3ab6903397f893/test%2Fparallel%2Ftest-internal-util-weakreference.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-util-weakreference.js?ref=86799326077611d694f37753ee3ab6903397f893",
            "patch": "@@ -0,0 +1,17 @@\n+// Flags: --expose-internals --expose-gc\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+const { internalBinding } = require('internal/test/binding');\n+const { WeakReference } = internalBinding('util');\n+\n+let obj = { hello: 'world' };\n+const ref = new WeakReference(obj);\n+assert.strictEqual(ref.get(), obj);\n+\n+setImmediate(() => {\n+  obj = null;\n+  global.gc();\n+\n+  assert.strictEqual(ref.get(), undefined);\n+});"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 60,
        "deletions": 0
    }
}