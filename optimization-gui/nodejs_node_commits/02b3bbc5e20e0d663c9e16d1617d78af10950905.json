{
    "author": "unknown",
    "message": "deps: update node-inspect to 1.11.3\n\nHighlights:\n\n* Using a random port works (`node inspect --port=0 script.js`)\n* `takeHeapSnapshot()` creates valid snapshots again\n\nPR-URL: https://github.com/nodejs/node/pull/18354\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "02b3bbc5e20e0d663c9e16d1617d78af10950905",
    "files": [
        {
            "sha": "0db3a7842eb15dfcfcd317b5ea3f915cb5e97cb4",
            "filename": "deps/node-inspect/CHANGELOG.md",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2FCHANGELOG.md",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2FCHANGELOG.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2FCHANGELOG.md?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -1,3 +1,12 @@\n+### 1.11.3\n+\n+* [`93caa0f`](https://github.com/nodejs/node-inspect/commit/93caa0f5267c7ab452b258d3b03329a0bb5ac7f7) **docs:** Add missing oc in protocol\n+* [`2d87cbe`](https://github.com/nodejs/node-inspect/commit/2d87cbe76aa968dfc1ac69d9571af1be81abd8e0) **fix:** Make --inspect-port=0 work\n+* [`ebfd02e`](https://github.com/nodejs/node-inspect/commit/ebfd02ece9b642586023f7791da71defeb13d746) **chore:** Bump tap to 10.7\n+* [`c07adb1`](https://github.com/nodejs/node-inspect/commit/c07adb17b164c1cf3da8d38659ea9f5d7ff42e9c) **test:** Use useful break location\n+* [`94f0bf9`](https://github.com/nodejs/node-inspect/commit/94f0bf97d24c376baf3ecced2088d81715a73464) **fix:** Fix `takeHeapSnapshot()` truncation bug\n+\n+\n ### 1.11.2\n \n * [`42e0cd1`](https://github.com/nodejs/node-inspect/commit/42e0cd111d89ed09faba1c0ec45089b0b44de011) **fix:** look for generic hint text"
        },
        {
            "sha": "b52cc188a62f5bdb50e186fbf1a04a7620db901e",
            "filename": "deps/node-inspect/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2FREADME.md?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -10,7 +10,7 @@ node has two options:\n 1. `node --debug <file>`: Start `file` with remote debugging enabled.\n 2. `node debug <file>`: Start an interactive CLI debugger for `<file>`.\n \n-But for the Chrome inspector protol,\n+But for the Chrome inspector protocol,\n there's only one: `node --inspect <file>`.\n \n This project tries to provide the missing second option"
        },
        {
            "sha": "d846efbe6a4a526bd1108e2ec25588c6d1ad5afc",
            "filename": "deps/node-inspect/lib/_inspect.js",
            "status": "modified",
            "additions": 12,
            "deletions": 19,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2F_inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2F_inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Flib%2F_inspect.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -42,18 +42,9 @@ const [ InspectClient, createRepl ] =\n \n const debuglog = util.debuglog('inspect');\n \n-const DEBUG_PORT_PATTERN = /^--(?:debug|inspect)(?:-port|-brk)?=(\\d{1,5})$/;\n-function getDefaultPort() {\n-  for (const arg of process.execArgv) {\n-    const match = arg.match(DEBUG_PORT_PATTERN);\n-    if (match) {\n-      return +match[1];\n-    }\n-  }\n-  return 9229;\n-}\n-\n function portIsFree(host, port, timeout = 2000) {\n+  if (port === 0) return Promise.resolve();  // Binding to a random port.\n+\n   const retryDelay = 150;\n   let didTimeOut = false;\n \n@@ -110,9 +101,11 @@ function runScript(script, scriptArgs, inspectHost, inspectPort, childPrint) {\n         let output = '';\n         function waitForListenHint(text) {\n           output += text;\n-          if (/Debugger listening on/.test(output)) {\n+          if (/Debugger listening on ws:\\/\\/\\[?(.+?)\\]?:(\\d+)\\//.test(output)) {\n+            const host = RegExp.$1;\n+            const port = Number.parseInt(RegExp.$2);\n             child.stderr.removeListener('data', waitForListenHint);\n-            resolve(child);\n+            resolve([child, port, host]);\n           }\n         }\n \n@@ -160,10 +153,11 @@ class NodeInspector {\n                                        options.port,\n                                        this.childPrint.bind(this));\n     } else {\n-      this._runScript = () => Promise.resolve(null);\n+      this._runScript =\n+          () => Promise.resolve([null, options.port, options.host]);\n     }\n \n-    this.client = new InspectClient(options.port, options.host);\n+    this.client = new InspectClient();\n \n     this.domainNames = ['Debugger', 'HeapProfiler', 'Profiler', 'Runtime'];\n     this.domainNames.forEach((domain) => {\n@@ -223,17 +217,16 @@ class NodeInspector {\n \n   run() {\n     this.killChild();\n-    const { host, port } = this.options;\n \n-    return this._runScript().then((child) => {\n+    return this._runScript().then(([child, port, host]) => {\n       this.child = child;\n \n       let connectionAttempts = 0;\n       const attemptConnect = () => {\n         ++connectionAttempts;\n         debuglog('connection attempt #%d', connectionAttempts);\n         this.stdout.write('.');\n-        return this.client.connect()\n+        return this.client.connect(port, host)\n           .then(() => {\n             debuglog('connection established');\n             this.stdout.write(' ok');\n@@ -288,7 +281,7 @@ class NodeInspector {\n \n function parseArgv([target, ...args]) {\n   let host = '127.0.0.1';\n-  let port = getDefaultPort();\n+  let port = 9229;\n   let isRemote = false;\n   let script = target;\n   let scriptArgs = args;"
        },
        {
            "sha": "9b8529de21aae27addd2f10585c54e5fcb3422a7",
            "filename": "deps/node-inspect/lib/internal/inspect_client.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_client.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -164,12 +164,12 @@ function decodeFrameHybi17(data) {\n }\n \n class Client extends EventEmitter {\n-  constructor(port, host) {\n+  constructor() {\n     super();\n     this.handleChunk = this._handleChunk.bind(this);\n \n-    this._port = port;\n-    this._host = host;\n+    this._port = undefined;\n+    this._host = undefined;\n \n     this.reset();\n   }\n@@ -284,7 +284,9 @@ class Client extends EventEmitter {\n     });\n   }\n \n-  connect() {\n+  connect(port, host) {\n+    this._port = port;\n+    this._host = host;\n     return this._discoverWebsocketPath()\n       .then((urlPath) => this._connectWebsocket(urlPath));\n   }"
        },
        {
            "sha": "38fe4684cf6d7162b1eb6aaa757adabae1243c62",
            "filename": "deps/node-inspect/lib/internal/inspect_repl.js",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_repl.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_repl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Flib%2Finternal%2Finspect_repl.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -900,10 +900,8 @@ function createRepl(inspector) {\n         return new Promise((resolve, reject) => {\n           const absoluteFile = Path.resolve(filename);\n           const writer = FS.createWriteStream(absoluteFile);\n-          let totalSize;\n           let sizeWritten = 0;\n           function onProgress({ done, total, finished }) {\n-            totalSize = total;\n             if (finished) {\n               print('Heap snaphost prepared.');\n             } else {\n@@ -913,13 +911,18 @@ function createRepl(inspector) {\n           function onChunk({ chunk }) {\n             sizeWritten += chunk.length;\n             writer.write(chunk);\n-            print(`Writing snapshot: ${sizeWritten}/${totalSize}`, true);\n-            if (sizeWritten >= totalSize) {\n-              writer.end();\n+            print(`Writing snapshot: ${sizeWritten}`, true);\n+          }\n+          function onResolve() {\n+            writer.end(() => {\n               teardown();\n               print(`Wrote snapshot: ${absoluteFile}`);\n               resolve();\n-            }\n+            });\n+          }\n+          function onReject(error) {\n+            teardown();\n+            reject(error);\n           }\n           function teardown() {\n             HeapProfiler.removeListener(\n@@ -932,10 +935,7 @@ function createRepl(inspector) {\n \n           print('Heap snapshot: 0/0', true);\n           HeapProfiler.takeHeapSnapshot({ reportProgress: true })\n-            .then(null, (error) => {\n-              teardown();\n-              reject(error);\n-            });\n+            .then(onResolve, onReject);\n         });\n       },\n "
        },
        {
            "sha": "d25376b5d4bb96e15bfaafdfd89798931327c31c",
            "filename": "deps/node-inspect/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Fpackage.json",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Fpackage.json?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"node-inspect\",\n-  \"version\": \"1.11.2\",\n+  \"version\": \"1.11.3\",\n   \"description\": \"Node Inspect\",\n   \"license\": \"MIT\",\n   \"main\": \"lib/_inspect.js\",\n@@ -29,7 +29,7 @@\n   \"devDependencies\": {\n     \"eslint\": \"^3.10.2\",\n     \"nlm\": \"^3.0.0\",\n-    \"tap\": \"^7.1.2\"\n+    \"tap\": \"^10.7.0\"\n   },\n   \"author\": {\n     \"name\": \"Jan Krems\","
        },
        {
            "sha": "ce8c8d6d7d99bdb6dcd57f4e70462f1120a1a102",
            "filename": "deps/node-inspect/test/cli/break.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fbreak.test.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fbreak.test.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Ftest%2Fcli%2Fbreak.test.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -134,7 +134,7 @@ test('sb before loading file', (t) => {\n \n   return cli.waitForInitialBreak()\n     .then(() => cli.waitForPrompt())\n-    .then(() => cli.command('sb(\"other.js\", 3)'))\n+    .then(() => cli.command('sb(\"other.js\", 2)'))\n     .then(() => {\n       t.match(\n         cli.output,\n@@ -145,7 +145,7 @@ test('sb before loading file', (t) => {\n     .then(() => {\n       t.match(\n         cli.output,\n-        `break in ${otherScript}:3`,\n+        `break in ${otherScript}:2`,\n         'found breakpoint in file that was not loaded yet');\n     })\n     .then(() => cli.quit())"
        },
        {
            "sha": "ebd734e03cb06d1a0bebd40d2c58801c6f0c10bc",
            "filename": "deps/node-inspect/test/cli/heap-profiler.test.js",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fheap-profiler.test.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fheap-profiler.test.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Ftest%2Fcli%2Fheap-profiler.test.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -0,0 +1,34 @@\n+'use strict';\n+const { test } = require('tap');\n+const { readFileSync, unlinkSync } = require('fs');\n+\n+const startCLI = require('./start-cli');\n+const filename = 'node.heapsnapshot';\n+\n+function cleanup() {\n+  try {\n+    unlinkSync(filename);\n+  } catch (_) {\n+    // Ignore.\n+  }\n+}\n+\n+cleanup();\n+\n+test('Heap profiler take snapshot', (t) => {\n+  const cli = startCLI(['examples/empty.js']);\n+\n+  function onFatal(error) {\n+    cli.quit();\n+    throw error;\n+  }\n+\n+  // Check that the snapshot is valid JSON.\n+  return cli.waitForInitialBreak()\n+    .then(() => cli.waitForPrompt())\n+    .then(() => cli.command('takeHeapSnapshot()'))\n+    .then(() => JSON.parse(readFileSync(filename, 'utf8')))\n+    .then(() => cleanup())\n+    .then(() => cli.quit())\n+    .then(null, onFatal);\n+});"
        },
        {
            "sha": "8808d47a08b900ddde1eb10f8258c664a14676e6",
            "filename": "deps/node-inspect/test/cli/launch.test.js",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Flaunch.test.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Flaunch.test.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Ftest%2Fcli%2Flaunch.test.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -26,6 +26,46 @@ test('custom port', (t) => {\n     });\n });\n \n+test('random port', (t) => {\n+  const script = Path.join('examples', 'three-lines.js');\n+\n+  const cli = startCLI(['--port=0', script]);\n+\n+  return cli.waitForInitialBreak()\n+    .then(() => cli.waitForPrompt())\n+    .then(() => {\n+      t.match(cli.output, 'debug>', 'prints a prompt');\n+      t.match(\n+        cli.output,\n+        /< Debugger listening on /,\n+        'forwards child output');\n+    })\n+    .then(() => cli.quit())\n+    .then((code) => {\n+      t.equal(code, 0, 'exits with success');\n+    });\n+});\n+\n+test('random port with --inspect-port=0', (t) => {\n+  const script = Path.join('examples', 'three-lines.js');\n+\n+  const cli = startCLI([script], ['--inspect-port=0']);\n+\n+  return cli.waitForInitialBreak()\n+    .then(() => cli.waitForPrompt())\n+    .then(() => {\n+      t.match(cli.output, 'debug>', 'prints a prompt');\n+      t.match(\n+        cli.output,\n+        /< Debugger listening on /,\n+        'forwards child output');\n+    })\n+    .then(() => cli.quit())\n+    .then((code) => {\n+      t.equal(code, 0, 'exits with success');\n+    });\n+});\n+\n test('examples/three-lines.js', (t) => {\n   const script = Path.join('examples', 'three-lines.js');\n   const cli = startCLI([script]);"
        },
        {
            "sha": "b086dcd8ba218dc5d4046fa0694fc25e538da25c",
            "filename": "deps/node-inspect/test/cli/start-cli.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fstart-cli.js",
            "raw_url": "https://github.com/nodejs/node/raw/02b3bbc5e20e0d663c9e16d1617d78af10950905/deps%2Fnode-inspect%2Ftest%2Fcli%2Fstart-cli.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fnode-inspect%2Ftest%2Fcli%2Fstart-cli.js?ref=02b3bbc5e20e0d663c9e16d1617d78af10950905",
            "patch": "@@ -16,8 +16,8 @@ const BREAK_MESSAGE = new RegExp('(?:' + [\n   'exception', 'other', 'promiseRejection',\n ].join('|') + ') in', 'i');\n \n-function startCLI(args) {\n-  const child = spawn(process.execPath, [CLI, ...args]);\n+function startCLI(args, flags = []) {\n+  const child = spawn(process.execPath, [...flags, CLI, ...args]);\n   let isFirstStdoutChunk = true;\n \n   const outputBuffer = [];"
        }
    ],
    "stats": {
        "total": 158,
        "additions": 118,
        "deletions": 40
    }
}