{
    "author": "ronag",
    "message": "http2: avoid bind and properly clean up in compat\n\nPR-URL: https://github.com/nodejs/node/pull/20374\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "0d762af48ea4cc298d59724ef5c9d06ff2c6a066",
    "files": [
        {
            "sha": "6e25b273018c925289f8405b5b1936073d7e8cf5",
            "filename": "lib/internal/http2/compat.js",
            "status": "modified",
            "additions": 46,
            "deletions": 32,
            "changes": 78,
            "blob_url": "https://github.com/nodejs/node/blob/0d762af48ea4cc298d59724ef5c9d06ff2c6a066/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "raw_url": "https://github.com/nodejs/node/raw/0d762af48ea4cc298d59724ef5c9d06ff2c6a066/lib%2Finternal%2Fhttp2%2Fcompat.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcompat.js?ref=0d762af48ea4cc298d59724ef5c9d06ff2c6a066",
            "patch": "@@ -19,7 +19,6 @@ const {\n } = require('internal/errors').codes;\n const { kSocket } = require('internal/http2/util');\n \n-const kFinish = Symbol('finish');\n const kBeginSend = Symbol('begin-send');\n const kState = Symbol('state');\n const kStream = Symbol('stream');\n@@ -223,6 +222,27 @@ const proxySocketHandler = {\n   }\n };\n \n+function onStreamCloseRequest() {\n+  const req = this[kRequest];\n+\n+  if (req === undefined)\n+    return;\n+\n+  const state = req[kState];\n+  state.closed = true;\n+\n+  req.push(null);\n+  // if the user didn't interact with incoming data and didn't pipe it,\n+  // dump it for compatibility with http1\n+  if (!state.didRead && !req._readableState.resumeScheduled)\n+    req.resume();\n+\n+  this[kProxySocket] = null;\n+  this[kRequest] = undefined;\n+\n+  req.emit('close');\n+}\n+\n class Http2ServerRequest extends Readable {\n   constructor(stream, headers, options, rawHeaders) {\n     super(options);\n@@ -246,7 +266,7 @@ class Http2ServerRequest extends Readable {\n     stream.on('end', onStreamEnd);\n     stream.on('error', onStreamError);\n     stream.on('aborted', onStreamAbortedRequest);\n-    stream.on('close', this[kFinish].bind(this));\n+    stream.on('close', onStreamCloseRequest);\n     this.on('pause', onRequestPause);\n     this.on('resume', onRequestResume);\n   }\n@@ -349,24 +369,30 @@ class Http2ServerRequest extends Readable {\n       return;\n     this[kStream].setTimeout(msecs, callback);\n   }\n-\n-  [kFinish]() {\n-    const state = this[kState];\n-    if (state.closed)\n-      return;\n-    state.closed = true;\n-    this.push(null);\n-    this[kStream][kRequest] = undefined;\n-    // if the user didn't interact with incoming data and didn't pipe it,\n-    // dump it for compatibility with http1\n-    if (!state.didRead && !this._readableState.resumeScheduled)\n-      this.resume();\n-    this.emit('close');\n-  }\n }\n \n function onStreamTrailersReady() {\n-  this[kStream].sendTrailers(this[kTrailers]);\n+  this.sendTrailers(this[kResponse][kTrailers]);\n+}\n+\n+function onStreamCloseResponse() {\n+  const res = this[kResponse];\n+\n+  if (res === undefined)\n+    return;\n+\n+  const state = res[kState];\n+\n+  if (this.headRequest !== state.headRequest)\n+    return;\n+\n+  state.closed = true;\n+\n+  this[kProxySocket] = null;\n+  this[kResponse] = undefined;\n+\n+  res.emit('finish');\n+  res.emit('close');\n }\n \n class Http2ServerResponse extends Stream {\n@@ -387,8 +413,8 @@ class Http2ServerResponse extends Stream {\n     this.writable = true;\n     stream.on('drain', onStreamDrain);\n     stream.on('aborted', onStreamAbortedResponse);\n-    stream.on('close', this[kFinish].bind(this));\n-    stream.on('wantTrailers', onStreamTrailersReady.bind(this));\n+    stream.on('close', onStreamCloseResponse);\n+    stream.on('wantTrailers', onStreamTrailersReady);\n   }\n \n   // User land modules such as finalhandler just check truthiness of this\n@@ -619,7 +645,7 @@ class Http2ServerResponse extends Stream {\n       this.writeHead(this[kState].statusCode);\n \n     if (isFinished)\n-      this[kFinish]();\n+      onStreamCloseResponse.call(stream);\n     else\n       stream.end();\n \n@@ -665,18 +691,6 @@ class Http2ServerResponse extends Stream {\n     this[kStream].respond(headers, options);\n   }\n \n-  [kFinish]() {\n-    const stream = this[kStream];\n-    const state = this[kState];\n-    if (state.closed || stream.headRequest !== state.headRequest)\n-      return;\n-    state.closed = true;\n-    this[kProxySocket] = null;\n-    stream[kResponse] = undefined;\n-    this.emit('finish');\n-    this.emit('close');\n-  }\n-\n   // TODO doesn't support callbacks\n   writeContinue() {\n     const stream = this[kStream];"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 46,
        "deletions": 32
    }
}