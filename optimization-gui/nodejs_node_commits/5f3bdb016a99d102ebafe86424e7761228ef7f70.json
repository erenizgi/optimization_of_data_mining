{
    "author": "TimothyGu",
    "message": "messaging: use actual DOMException for DataCloneError\n\nPR-URL: https://github.com/nodejs/node/pull/21540\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "5f3bdb016a99d102ebafe86424e7761228ef7f70",
    "files": [
        {
            "sha": "5904e5dd0ad5644c63f3751d1525662f572dcb3e",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/5f3bdb016a99d102ebafe86424e7761228ef7f70/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/5f3bdb016a99d102ebafe86424e7761228ef7f70/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=5f3bdb016a99d102ebafe86424e7761228ef7f70",
            "patch": "@@ -125,6 +125,10 @@\n       setupGlobalURL();\n     }\n \n+    if (process.binding('config').experimentalWorker) {\n+      setupDOMException();\n+    }\n+\n     // On OpenBSD process.execPath will be relative unless we\n     // get the full path before process.execPath is used.\n     if (process.platform === 'openbsd') {\n@@ -405,6 +409,11 @@\n     });\n   }\n \n+  function setupDOMException() {\n+    // Registers the constructor with C++.\n+    NativeModule.require('internal/domexception');\n+  }\n+\n   function setupInspector(originalConsole, wrappedConsole, CJSModule) {\n     if (!process.config.variables.v8_enable_inspector) {\n       return;"
        },
        {
            "sha": "fe371e099eb17f4b2290ce9356733f480ce665e6",
            "filename": "lib/internal/domexception.js",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/nodejs/node/blob/5f3bdb016a99d102ebafe86424e7761228ef7f70/lib%2Finternal%2Fdomexception.js",
            "raw_url": "https://github.com/nodejs/node/raw/5f3bdb016a99d102ebafe86424e7761228ef7f70/lib%2Finternal%2Fdomexception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fdomexception.js?ref=5f3bdb016a99d102ebafe86424e7761228ef7f70",
            "patch": "@@ -0,0 +1,83 @@\n+'use strict';\n+\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { registerDOMException } = internalBinding('messaging');\n+const { ERR_INVALID_THIS } = require('internal/errors').codes;\n+\n+const internalsMap = new WeakMap();\n+\n+const nameToCodeMap = new Map();\n+\n+class DOMException extends Error {\n+  constructor(message = '', name = 'Error') {\n+    super();\n+    internalsMap.set(this, {\n+      message: `${message}`,\n+      name: `${name}`\n+    });\n+  }\n+\n+  get name() {\n+    const internals = internalsMap.get(this);\n+    if (internals === undefined) {\n+      throw new ERR_INVALID_THIS('DOMException');\n+    }\n+    return internals.name;\n+  }\n+\n+  get message() {\n+    const internals = internalsMap.get(this);\n+    if (internals === undefined) {\n+      throw new ERR_INVALID_THIS('DOMException');\n+    }\n+    return internals.message;\n+  }\n+\n+  get code() {\n+    const internals = internalsMap.get(this);\n+    if (internals === undefined) {\n+      throw new ERR_INVALID_THIS('DOMException');\n+    }\n+    const code = nameToCodeMap.get(internals.name);\n+    return code === undefined ? 0 : code;\n+  }\n+}\n+\n+for (const [name, codeName, value] of [\n+  ['IndexSizeError', 'INDEX_SIZE_ERR', 1],\n+  ['DOMStringSizeError', 'DOMSTRING_SIZE_ERR', 2],\n+  ['HierarchyRequestError', 'HIERARCHY_REQUEST_ERR', 3],\n+  ['WrongDocumentError', 'WRONG_DOCUMENT_ERR', 4],\n+  ['InvalidCharacterError', 'INVALID_CHARACTER_ERR', 5],\n+  ['NoDataAllowedError', 'NO_DATA_ALLOWED_ERR', 6],\n+  ['NoModificationAllowedError', 'NO_MODIFICATION_ALLOWED_ERR', 7],\n+  ['NotFoundError', 'NOT_FOUND_ERR', 8],\n+  ['NotSupportedError', 'NOT_SUPPORTED_ERR', 9],\n+  ['InUseAttributeError', 'INUSE_ATTRIBUTE_ERR', 10],\n+  ['InvalidStateError', 'INVALID_STATE_ERR', 11],\n+  ['SyntaxError', 'SYNTAX_ERR', 12],\n+  ['InvalidModificationError', 'INVALID_MODIFICATION_ERR', 13],\n+  ['NamespaceError', 'NAMESPACE_ERR', 14],\n+  ['InvalidAccessError', 'INVALID_ACCESS_ERR', 15],\n+  ['ValidationError', 'VALIDATION_ERR', 16],\n+  ['TypeMismatchError', 'TYPE_MISMATCH_ERR', 17],\n+  ['SecurityError', 'SECURITY_ERR', 18],\n+  ['NetworkError', 'NETWORK_ERR', 19],\n+  ['AbortError', 'ABORT_ERR', 20],\n+  ['URLMismatchError', 'URL_MISMATCH_ERR', 21],\n+  ['QuotaExceededError', 'QUOTA_EXCEEDED_ERR', 22],\n+  ['TimeoutError', 'TIMEOUT_ERR', 23],\n+  ['InvalidNodeTypeError', 'INVALID_NODE_TYPE_ERR', 24],\n+  ['DataCloneError', 'DATA_CLONE_ERR', 25]\n+  // There are some more error names, but since they don't have codes assigned,\n+  // we don't need to care about them.\n+]) {\n+  const desc = { enumerable: true, value };\n+  Object.defineProperty(DOMException, codeName, desc);\n+  Object.defineProperty(DOMException.prototype, codeName, desc);\n+  nameToCodeMap.set(name, value);\n+}\n+\n+module.exports = DOMException;\n+\n+registerDOMException(DOMException);"
        },
        {
            "sha": "4b6bc4c108cfb5a8db1e3bf8c47cacdc528aef9e",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5f3bdb016a99d102ebafe86424e7761228ef7f70/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/5f3bdb016a99d102ebafe86424e7761228ef7f70/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=5f3bdb016a99d102ebafe86424e7761228ef7f70",
            "patch": "@@ -106,6 +106,7 @@\n       'lib/internal/constants.js',\n       'lib/internal/dns/promises.js',\n       'lib/internal/dns/utils.js',\n+      'lib/internal/domexception.js',\n       'lib/internal/encoding.js',\n       'lib/internal/errors.js',\n       'lib/internal/error-serdes.js',"
        },
        {
            "sha": "8f2f024eddcd5dbaf92e04719fc7ac35c87c6d35",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5f3bdb016a99d102ebafe86424e7761228ef7f70/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5f3bdb016a99d102ebafe86424e7761228ef7f70/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5f3bdb016a99d102ebafe86424e7761228ef7f70",
            "patch": "@@ -322,6 +322,7 @@ struct PackageConfig {\n   V(buffer_prototype_object, v8::Object)                                      \\\n   V(context, v8::Context)                                                     \\\n   V(domain_callback, v8::Function)                                            \\\n+  V(domexception_function, v8::Function)                                      \\\n   V(fdclose_constructor_template, v8::ObjectTemplate)                         \\\n   V(fd_constructor_template, v8::ObjectTemplate)                              \\\n   V(filehandlereadwrap_template, v8::ObjectTemplate)                          \\"
        },
        {
            "sha": "7ddd3c4165c51173082bbb3a3f5fa4c85b03d3be",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/5f3bdb016a99d102ebafe86424e7761228ef7f70/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5f3bdb016a99d102ebafe86424e7761228ef7f70/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=5f3bdb016a99d102ebafe86424e7761228ef7f70",
            "patch": "@@ -144,6 +144,21 @@ void Message::AddMessagePort(std::unique_ptr<MessagePortData>&& data) {\n \n namespace {\n \n+void ThrowDataCloneError(Environment* env, Local<String> message) {\n+  Local<Value> argv[] = {\n+    message,\n+    FIXED_ONE_BYTE_STRING(env->isolate(), \"DataCloneError\")\n+  };\n+  Local<Value> exception;\n+  Local<Function> domexception_ctor = env->domexception_function();\n+  CHECK(!domexception_ctor.IsEmpty());\n+  if (!domexception_ctor->NewInstance(env->context(), arraysize(argv), argv)\n+          .ToLocal(&exception)) {\n+    return;\n+  }\n+  env->isolate()->ThrowException(exception);\n+}\n+\n // This tells V8 how to serialize objects that it does not understand\n // (e.g. C++ objects) into the output buffer, in a way that our own\n // DeserializerDelegate understands how to unpack.\n@@ -153,7 +168,7 @@ class SerializerDelegate : public ValueSerializer::Delegate {\n       : env_(env), context_(context), msg_(m) {}\n \n   void ThrowDataCloneError(Local<String> message) override {\n-    env_->isolate()->ThrowException(Exception::Error(message));\n+    ThrowDataCloneError(env_, message);\n   }\n \n   Maybe<bool> WriteHostObject(Isolate* isolate, Local<Object> object) override {\n@@ -688,6 +703,13 @@ static void MessageChannel(const FunctionCallbackInfo<Value>& args) {\n       .FromJust();\n }\n \n+static void RegisterDOMException(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsFunction());\n+  env->set_domexception_function(args[0].As<Function>());\n+}\n+\n static void InitMessaging(Local<Object> target,\n                           Local<Value> unused,\n                           Local<Context> context,\n@@ -708,6 +730,8 @@ static void InitMessaging(Local<Object> target,\n               env->message_port_constructor_string(),\n               GetMessagePortConstructor(env, context).ToLocalChecked())\n                   .FromJust();\n+\n+  env->SetMethod(target, \"registerDOMException\", RegisterDOMException);\n }\n \n }  // anonymous namespace"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 119,
        "deletions": 1
    }
}