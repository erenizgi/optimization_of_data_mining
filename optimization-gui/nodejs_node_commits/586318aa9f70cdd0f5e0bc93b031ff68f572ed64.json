{
    "author": "addaleax",
    "message": "src: check HasCaught() in JSStream calls\n\n`MakeCallback` can return an empty `MaybeLocal<>` even if no\nexception has been generated, in particular, if\nwe were already terminating the current thread *before* the `TryCatch`\nscope started, which meant it would not have an exception to report.\n\nPR-URL: https://github.com/nodejs/node/pull/26124\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "586318aa9f70cdd0f5e0bc93b031ff68f572ed64",
    "files": [
        {
            "sha": "ae1aa7cd30e94907db6eba9f24522aed8082f45e",
            "filename": "src/js_stream.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/586318aa9f70cdd0f5e0bc93b031ff68f572ed64/src%2Fjs_stream.cc",
            "raw_url": "https://github.com/nodejs/node/raw/586318aa9f70cdd0f5e0bc93b031ff68f572ed64/src%2Fjs_stream.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.cc?ref=586318aa9f70cdd0f5e0bc93b031ff68f572ed64",
            "patch": "@@ -46,7 +46,7 @@ bool JSStream::IsClosing() {\n   TryCatchScope try_catch(env());\n   Local<Value> value;\n   if (!MakeCallback(env()->isclosing_string(), 0, nullptr).ToLocal(&value)) {\n-    if (!try_catch.HasTerminated())\n+    if (try_catch.HasCaught() && !try_catch.HasTerminated())\n       FatalException(env()->isolate(), try_catch);\n     return true;\n   }\n@@ -62,7 +62,7 @@ int JSStream::ReadStart() {\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onreadstart_string(), 0, nullptr).ToLocal(&value) ||\n       !value->Int32Value(env()->context()).To(&value_int)) {\n-    if (!try_catch.HasTerminated())\n+    if (try_catch.HasCaught() && !try_catch.HasTerminated())\n       FatalException(env()->isolate(), try_catch);\n   }\n   return value_int;\n@@ -77,7 +77,7 @@ int JSStream::ReadStop() {\n   int value_int = UV_EPROTO;\n   if (!MakeCallback(env()->onreadstop_string(), 0, nullptr).ToLocal(&value) ||\n       !value->Int32Value(env()->context()).To(&value_int)) {\n-    if (!try_catch.HasTerminated())\n+    if (try_catch.HasCaught() && !try_catch.HasTerminated())\n       FatalException(env()->isolate(), try_catch);\n   }\n   return value_int;\n@@ -99,7 +99,7 @@ int JSStream::DoShutdown(ShutdownWrap* req_wrap) {\n                     arraysize(argv),\n                     argv).ToLocal(&value) ||\n       !value->Int32Value(env()->context()).To(&value_int)) {\n-    if (!try_catch.HasTerminated())\n+    if (try_catch.HasCaught() && !try_catch.HasTerminated())\n       FatalException(env()->isolate(), try_catch);\n   }\n   return value_int;\n@@ -134,7 +134,7 @@ int JSStream::DoWrite(WriteWrap* w,\n                     arraysize(argv),\n                     argv).ToLocal(&value) ||\n       !value->Int32Value(env()->context()).To(&value_int)) {\n-    if (!try_catch.HasTerminated())\n+    if (try_catch.HasCaught() && !try_catch.HasTerminated())\n       FatalException(env()->isolate(), try_catch);\n   }\n   return value_int;"
        },
        {
            "sha": "234697fb4d26dc333f1840b31067fbc9cf5395cd",
            "filename": "test/parallel/test-worker-http2-generic-streams-terminate.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/586318aa9f70cdd0f5e0bc93b031ff68f572ed64/test%2Fparallel%2Ftest-worker-http2-generic-streams-terminate.js",
            "raw_url": "https://github.com/nodejs/node/raw/586318aa9f70cdd0f5e0bc93b031ff68f572ed64/test%2Fparallel%2Ftest-worker-http2-generic-streams-terminate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-http2-generic-streams-terminate.js?ref=586318aa9f70cdd0f5e0bc93b031ff68f572ed64",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const http2 = require('http2');\n+const { Duplex } = require('stream');\n+const { Worker, workerData } = require('worker_threads');\n+\n+// Tests the interaction between terminating a Worker thread and running\n+// the native SetImmediate queue, which may attempt to perform multiple\n+// calls into JS even though one already terminates the Worker.\n+\n+if (!workerData) {\n+  const counter = new Int32Array(new SharedArrayBuffer(4));\n+  const worker = new Worker(__filename, { workerData: { counter } });\n+  worker.on('exit', common.mustCall(() => {\n+    assert.strictEqual(counter[0], 1);\n+  }));\n+} else {\n+  const { counter } = workerData;\n+\n+  // Start two HTTP/2 connections. This will trigger write()s call from inside\n+  // the SetImmediate queue.\n+  for (let i = 0; i < 2; i++) {\n+    http2.connect('http://localhost', {\n+      createConnection() {\n+        return new Duplex({\n+          write(chunk, enc, cb) {\n+            Atomics.add(counter, 0, 1);\n+            process.exit();\n+          },\n+          read() { }\n+        });\n+      }\n+    });\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 44,
        "deletions": 5
    }
}