{
    "author": "Trott",
    "message": "test: apply promises API to fourth appendFile test\n\nAdd tests for `fs.promises.appendFile()` to the fourth (of five) test\ncase in `test-fs-access`. (The previous test cases already have\npromises API versions.)\n\nPR-URL: https://github.com/nodejs/node/pull/21131\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "97a4ba3d23b44d8e91980ebd641269572f56871a",
    "files": [
        {
            "sha": "2d4c64863fb6acd03b886a31c6469f1cf9d4ad90",
            "filename": "test/parallel/test-fs-append-file.js",
            "status": "modified",
            "additions": 42,
            "deletions": 21,
            "changes": 63,
            "blob_url": "https://github.com/nodejs/node/blob/97a4ba3d23b44d8e91980ebd641269572f56871a/test%2Fparallel%2Ftest-fs-append-file.js",
            "raw_url": "https://github.com/nodejs/node/raw/97a4ba3d23b44d8e91980ebd641269572f56871a/test%2Fparallel%2Ftest-fs-append-file.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-append-file.js?ref=97a4ba3d23b44d8e91980ebd641269572f56871a",
            "patch": "@@ -132,29 +132,51 @@ const throwNextTick = (e) => { process.nextTick(() => { throw e; }); };\n     .catch(throwNextTick);\n }\n \n-// test that appendFile accepts numbers.\n-const filename4 = join(tmpdir.path, 'append4.txt');\n-fs.writeFileSync(filename4, currentFileData);\n+// test that appendFile accepts numbers (callback API)\n+{\n+  const filename = join(tmpdir.path, 'append-numbers.txt');\n+  fs.writeFileSync(filename, currentFileData);\n \n-const m = 0o600;\n-fs.appendFile(filename4, n, { mode: m }, function(e) {\n-  assert.ifError(e);\n+  const m = 0o600;\n+  fs.appendFile(filename, n, { mode: m }, common.mustCall((e) => {\n+    assert.ifError(e);\n \n-  ncallbacks++;\n+    // windows permissions aren't unix\n+    if (!common.isWindows) {\n+      const st = fs.statSync(filename);\n+      assert.strictEqual(st.mode & 0o700, m);\n+    }\n \n-  // windows permissions aren't unix\n-  if (!common.isWindows) {\n-    const st = fs.statSync(filename4);\n-    assert.strictEqual(st.mode & 0o700, m);\n-  }\n+    fs.readFile(filename, common.mustCall((e, buffer) => {\n+      assert.ifError(e);\n+      assert.strictEqual(Buffer.byteLength(String(n)) + currentFileData.length,\n+                         buffer.length);\n+    }));\n+  }));\n+}\n \n-  fs.readFile(filename4, function(e, buffer) {\n-    assert.ifError(e);\n-    ncallbacks++;\n-    assert.strictEqual(Buffer.byteLength(String(n)) + currentFileData.length,\n-                       buffer.length);\n-  });\n-});\n+// test that appendFile accepts numbers (promises API)\n+{\n+  const filename = join(tmpdir.path, 'append-numbers-promises.txt');\n+  fs.writeFileSync(filename, currentFileData);\n+\n+  const m = 0o600;\n+  fs.promises.appendFile(filename, n, { mode: m })\n+    .then(common.mustCall(() => {\n+      // windows permissions aren't unix\n+      if (!common.isWindows) {\n+        const st = fs.statSync(filename);\n+        assert.strictEqual(st.mode & 0o700, m);\n+      }\n+\n+      return fs.promises.readFile(filename);\n+    }))\n+    .then((buffer) => {\n+      assert.strictEqual(Buffer.byteLength(String(n)) + currentFileData.length,\n+                         buffer.length);\n+    })\n+    .catch(throwNextTick);\n+}\n \n // test that appendFile accepts file descriptors\n const filename5 = join(tmpdir.path, 'append5.txt');\n@@ -191,8 +213,7 @@ assert.throws(\n   { code: 'ERR_INVALID_CALLBACK' });\n \n process.on('exit', function() {\n-  assert.strictEqual(ncallbacks, 6);\n+  assert.strictEqual(ncallbacks, 4);\n \n-  fs.unlinkSync(filename4);\n   fs.unlinkSync(filename5);\n });"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 42,
        "deletions": 21
    }
}