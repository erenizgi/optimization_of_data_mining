{
    "author": "sam-github",
    "message": "src: add .code and SSL specific error properties\n\nSSL errors have a long structured message, but lacked the standard .code\nproperty which can be used for stable comparisons. Add a `code`\nproperty, as well as the 3 string components of an SSL error: `reason`,\n`library`, and `function`.\n\nPR-URL: https://github.com/nodejs/node/pull/25093\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a",
    "files": [
        {
            "sha": "fbb64f48b537fa3b67bd9f35c38ccdbd3c5535ee",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a",
            "patch": "@@ -183,6 +183,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(fingerprint_string, \"fingerprint\")                                         \\\n   V(flags_string, \"flags\")                                                     \\\n   V(fragment_string, \"fragment\")                                               \\\n+  V(function_string, \"function\")                                               \\\n   V(get_data_clone_error_string, \"_getDataCloneError\")                         \\\n   V(get_shared_array_buffer_id_string, \"_getSharedArrayBufferId\")              \\\n   V(gid_string, \"gid\")                                                         \\\n@@ -204,6 +205,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(issuercert_string, \"issuerCertificate\")                                    \\\n   V(kill_signal_string, \"killSignal\")                                          \\\n   V(kind_string, \"kind\")                                                       \\\n+  V(library_string, \"library\")                                                 \\\n   V(mac_string, \"mac\")                                                         \\\n   V(main_string, \"main\")                                                       \\\n   V(max_buffer_string, \"maxBuffer\")                                            \\\n@@ -313,7 +315,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(write_host_object_string, \"_writeHostObject\")                              \\\n   V(write_queue_size_string, \"writeQueueSize\")                                 \\\n   V(x_forwarded_string, \"x-forwarded-for\")                                     \\\n-  V(zero_return_string, \"ZERO_RETURN\")\n+  V(zero_return_string, \"ZERO_RETURN\")                                         \\\n \n #define ENVIRONMENT_STRONG_PERSISTENT_PROPERTIES(V)                            \\\n   V(as_external, v8::External)                                                 \\"
        },
        {
            "sha": "b5d6559355cb8792bcbdb895cd1ca13e00ab3326",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 37,
            "deletions": 1,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a",
            "patch": "@@ -41,6 +41,7 @@ using v8::Exception;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n+using v8::Isolate;\n using v8::Local;\n using v8::Object;\n using v8::ReadOnly;\n@@ -347,15 +348,50 @@ Local<Value> TLSWrap::GetSSLError(int status, int* err, std::string* msg) {\n       {\n         CHECK(*err == SSL_ERROR_SSL || *err == SSL_ERROR_SYSCALL);\n \n+        unsigned long ssl_err = ERR_peek_error();  // NOLINT(runtime/int)\n         BIO* bio = BIO_new(BIO_s_mem());\n         ERR_print_errors(bio);\n \n         BUF_MEM* mem;\n         BIO_get_mem_ptr(bio, &mem);\n \n+        Isolate* isolate = env()->isolate();\n+        Local<Context> context = isolate->GetCurrentContext();\n+\n         Local<String> message =\n-            OneByteString(env()->isolate(), mem->data, mem->length);\n+            OneByteString(isolate, mem->data, mem->length);\n         Local<Value> exception = Exception::Error(message);\n+        Local<Object> obj = exception->ToObject(context).ToLocalChecked();\n+\n+        const char* ls = ERR_lib_error_string(ssl_err);\n+        const char* fs = ERR_func_error_string(ssl_err);\n+        const char* rs = ERR_reason_error_string(ssl_err);\n+\n+        if (ls != nullptr)\n+          obj->Set(context, env()->library_string(),\n+                   OneByteString(isolate, ls)).FromJust();\n+        if (fs != nullptr)\n+          obj->Set(context, env()->function_string(),\n+                   OneByteString(isolate, fs)).FromJust();\n+        if (rs != nullptr) {\n+          obj->Set(context, env()->reason_string(),\n+                   OneByteString(isolate, rs)).FromJust();\n+\n+          // SSL has no API to recover the error name from the number, so we\n+          // transform reason strings like \"this error\" to \"ERR_SSL_THIS_ERROR\",\n+          // which ends up being close to the original error macro name.\n+          std::string code(rs);\n+\n+          for (auto& c : code) {\n+            if (c == ' ')\n+              c = '_';\n+            else\n+              c = ::toupper(c);\n+          }\n+          obj->Set(context, env()->code_string(),\n+                   OneByteString(isolate, (\"ERR_SSL_\" + code).c_str()))\n+                     .FromJust();\n+        }\n \n         if (msg != nullptr)\n           msg->assign(mem->data, mem->data + mem->length);"
        },
        {
            "sha": "79d2006d6bd261e4dbf28a0a89980837b972b8f7",
            "filename": "test/parallel/test-tls-alert-handling.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/test%2Fparallel%2Ftest-tls-alert-handling.js",
            "raw_url": "https://github.com/nodejs/node/raw/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/test%2Fparallel%2Ftest-tls-alert-handling.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-alert-handling.js?ref=ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a",
            "patch": "@@ -7,6 +7,7 @@ if (!common.hasCrypto)\n if (!common.opensslCli)\n   common.skip('node compiled without OpenSSL CLI');\n \n+const assert = require('assert');\n const net = require('net');\n const tls = require('tls');\n const fixtures = require('../common/fixtures');\n@@ -29,7 +30,11 @@ const opts = {\n const max_iter = 20;\n let iter = 0;\n \n-const errorHandler = common.mustCall(() => {\n+const errorHandler = common.mustCall((err) => {\n+  assert.strictEqual(err.code, 'ERR_SSL_WRONG_VERSION_NUMBER');\n+  assert.strictEqual(err.library, 'SSL routines');\n+  assert.strictEqual(err.function, 'ssl3_get_record');\n+  assert.strictEqual(err.reason, 'wrong version number');\n   errorReceived = true;\n   if (canCloseServer())\n     server.close();\n@@ -76,5 +81,10 @@ function sendBADTLSRecord() {\n     socket.write(BAD_RECORD);\n     socket.end();\n   }));\n-  client.on('error', common.mustCall());\n+  client.on('error', common.mustCall((err) => {\n+    assert.strictEqual(err.code, 'ERR_SSL_TLSV1_ALERT_PROTOCOL_VERSION');\n+    assert.strictEqual(err.library, 'SSL routines');\n+    assert.strictEqual(err.function, 'ssl3_read_bytes');\n+    assert.strictEqual(err.reason, 'tlsv1 alert protocol version');\n+  }));\n }"
        },
        {
            "sha": "6b856ac59b27b3655521111028dd563d96175ba3",
            "filename": "test/parallel/test-tls-min-max-version.js",
            "status": "modified",
            "additions": 23,
            "deletions": 26,
            "changes": 49,
            "blob_url": "https://github.com/nodejs/node/blob/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "raw_url": "https://github.com/nodejs/node/raw/ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-min-max-version.js?ref=ca9c0c90c28ed012cdd5be4e94a974ad07fd9b9a",
            "patch": "@@ -10,6 +10,7 @@ const {\n const DEFAULT_MIN_VERSION = tls.DEFAULT_MIN_VERSION;\n \n function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n+  assert(expect);\n   connect({\n     client: {\n       checkServerIdentity: (servername, cert) => { },\n@@ -26,23 +27,18 @@ function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n       secureProtocol: sprot,\n     },\n   }, common.mustCall((err, pair, cleanup) => {\n-    if (expect && expect.match(/^ERR/)) {\n-      assert.strictEqual(err.code, expect);\n+    if (err) {\n+      assert.strictEqual(err.code, expect, err + '.code !== ' + expect);\n       return cleanup();\n     }\n \n-    if (expect) {\n-      assert.ifError(pair.server.err);\n-      assert.ifError(pair.client.err);\n-      assert(pair.server.conn);\n-      assert(pair.client.conn);\n-      assert.strictEqual(pair.client.conn.getProtocol(), expect);\n-      assert.strictEqual(pair.server.conn.getProtocol(), expect);\n-      return cleanup();\n-    }\n-\n-    assert(pair.server.err);\n-    assert(pair.client.err);\n+    assert.ifError(err);\n+    assert.ifError(pair.server.err);\n+    assert.ifError(pair.client.err);\n+    assert(pair.server.conn);\n+    assert(pair.client.conn);\n+    assert.strictEqual(pair.client.conn.getProtocol(), expect);\n+    assert.strictEqual(pair.server.conn.getProtocol(), expect);\n     return cleanup();\n   }));\n }\n@@ -83,17 +79,18 @@ test(U, U, 'TLS_method', U, U, 'TLSv1_method', 'TLSv1');\n test(U, U, 'TLSv1_2_method', U, U, 'SSLv23_method', 'TLSv1.2');\n \n if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n-  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', null);\n-  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', null);\n-  test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', null);\n-  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', null);\n+  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method',\n+       'ERR_SSL_VERSION_TOO_LOW');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n }\n \n if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n   test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'TLSv1.1');\n-  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', null);\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', 'ECONNRESET');\n   test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n-  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', null);\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n }\n \n if (DEFAULT_MIN_VERSION === 'TLSv1') {\n@@ -111,18 +108,18 @@ test(U, U, 'TLSv1_method', U, U, 'TLSv1_method', 'TLSv1');\n \n // The default default.\n if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n-  test(U, U, 'TLSv1_1_method', U, U, U, null);\n-  test(U, U, 'TLSv1_method', U, U, U, null);\n-  test(U, U, U, U, U, 'TLSv1_1_method', null);\n-  test(U, U, U, U, U, 'TLSv1_method', null);\n+  test(U, U, 'TLSv1_1_method', U, U, U, 'ECONNRESET');\n+  test(U, U, 'TLSv1_method', U, U, U, 'ECONNRESET');\n+  test(U, U, U, U, U, 'TLSv1_1_method', 'ERR_SSL_VERSION_TOO_LOW');\n+  test(U, U, U, U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n }\n \n // The default with --tls-v1.1.\n if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n   test(U, U, 'TLSv1_1_method', U, U, U, 'TLSv1.1');\n-  test(U, U, 'TLSv1_method', U, U, U, null);\n+  test(U, U, 'TLSv1_method', U, U, U, 'ECONNRESET');\n   test(U, U, U, U, U, 'TLSv1_1_method', 'TLSv1.1');\n-  test(U, U, U, U, U, 'TLSv1_method', null);\n+  test(U, U, U, U, U, 'TLSv1_method', 'ERR_SSL_VERSION_TOO_LOW');\n }\n \n // The default with --tls-v1.0."
        }
    ],
    "stats": {
        "total": 105,
        "additions": 75,
        "deletions": 30
    }
}