{
    "author": "billti",
    "message": "test: add test for loading read-only modules\n\nAdds a test-case to cover loading modules\nthe user does not have permission to write to.\n\nCovers issue logged in https://github.com/nodejs/node/issues/20112\n\nPR-URL: https://github.com/nodejs/node/pull/20138\nRefs: https://github.com/nodejs/node/issues/20112\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>\nReviewed-By: Bartosz Sosnowski <bartosz@janeasystems.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "3ba81e34e86a5c32658e218cb6e65b13e8326bc5",
    "files": [
        {
            "sha": "fa12471a37c31b34642b59896ab699ef62db1378",
            "filename": "test/parallel/test-module-readonly.js",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/3ba81e34e86a5c32658e218cb6e65b13e8326bc5/test%2Fparallel%2Ftest-module-readonly.js",
            "raw_url": "https://github.com/nodejs/node/raw/3ba81e34e86a5c32658e218cb6e65b13e8326bc5/test%2Fparallel%2Ftest-module-readonly.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-readonly.js?ref=3ba81e34e86a5c32658e218cb6e65b13e8326bc5",
            "patch": "@@ -0,0 +1,48 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+if (!common.isWindows) {\n+  // TODO: Similar checks on *nix-like systems (e.g using chmod or the like)\n+  common.skip('test only runs on Windows');\n+}\n+\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+const cp = require('child_process');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+// Create readOnlyMod.js and set to read only\n+const readOnlyMod = path.join(tmpdir.path, 'readOnlyMod');\n+const readOnlyModRelative = path.relative(__dirname, readOnlyMod);\n+const readOnlyModFullPath = `${readOnlyMod}.js`;\n+\n+fs.writeFileSync(readOnlyModFullPath, 'module.exports = 42;');\n+\n+// Removed any inherited ACEs, and any explicitly granted ACEs for the\n+// current user\n+cp.execSync(\n+  `icacls.exe \"${readOnlyModFullPath}\" /inheritance:r /remove \"%USERNAME%\"`);\n+\n+// Grant the current user read & execute only\n+cp.execSync(`icacls.exe \"${readOnlyModFullPath}\" /grant \"%USERNAME%\":RX`);\n+\n+let except = null;\n+try {\n+  // Attempt to load the module. Will fail if write access is required\n+  require(readOnlyModRelative);\n+} catch (err) {\n+  except = err;\n+}\n+\n+// Remove the expliclty granted rights, and reenable inheritance\n+cp.execSync(\n+  `icacls.exe \"${readOnlyModFullPath}\" /remove \"%USERNAME%\" /inheritance:e`);\n+\n+// Delete the test module (note: tmpdir should get cleaned anyway)\n+fs.unlinkSync(readOnlyModFullPath);\n+\n+assert.ifError(except);"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 48,
        "deletions": 0
    }
}