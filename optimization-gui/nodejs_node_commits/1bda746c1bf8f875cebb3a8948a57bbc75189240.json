{
    "author": "bzoz",
    "message": "test: stdio pipe behavior tests\n\nAdd two regression tests for stdio over pipes.\n\ntest-stdio-pipe-access tests if accessing stdio pipe that is being read\nby another process does not deadlocks Node.js. This was reported in\nhttps://github.com/nodejs/node/issues/10836 and was fixed in v8.3.0.\nThe deadlock would happen intermittently, so we run the test 5 times.\n\ntest-stdio-pipe-redirect tests if redirecting one child process stdin to\nanother process stdout does not crash Node as reported in\nhttps://github.com/nodejs/node/issues/17493. It was fixed in\nhttps://github.com/nodejs/node/pull/18019.\n\nPR-URL: https://github.com/nodejs/node/pull/18614\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "1bda746c1bf8f875cebb3a8948a57bbc75189240",
    "files": [
        {
            "sha": "ef84bb83803b2633e51922f5d7ffa05647e09cc9",
            "filename": "test/parallel/test-stdio-pipe-access.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/1bda746c1bf8f875cebb3a8948a57bbc75189240/test%2Fparallel%2Ftest-stdio-pipe-access.js",
            "raw_url": "https://github.com/nodejs/node/raw/1bda746c1bf8f875cebb3a8948a57bbc75189240/test%2Fparallel%2Ftest-stdio-pipe-access.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stdio-pipe-access.js?ref=1bda746c1bf8f875cebb3a8948a57bbc75189240",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+require('../common');\n+\n+// Test if Node handles acessing process.stdin if it is a redirected\n+// pipe without deadlocking\n+const { spawn, spawnSync } = require('child_process');\n+\n+const numTries = 5;\n+const who = process.argv.length <= 2 ? 'runner' : process.argv[2];\n+\n+switch (who) {\n+  case 'runner':\n+    for (let num = 0; num < numTries; ++num) {\n+      spawnSync(process.argv0,\n+                [process.argv[1], 'parent'],\n+                { 'stdio': 'inherit' });\n+    }\n+    break;\n+  case 'parent':\n+    const middle = spawn(process.argv0,\n+                         [process.argv[1], 'middle'],\n+                         { 'stdio': 'pipe' });\n+    middle.stdout.on('data', () => {});\n+    break;\n+  case 'middle':\n+    spawn(process.argv0,\n+          [process.argv[1], 'bottom'],\n+          { 'stdio': [ process.stdin,\n+                       process.stdout,\n+                       process.stderr ] });\n+    break;\n+  case 'bottom':\n+    process.stdin;\n+    break;\n+}"
        },
        {
            "sha": "b47f5b9cf44af51b52da8b21051a443694742fc9",
            "filename": "test/parallel/test-stdio-pipe-redirect.js",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/1bda746c1bf8f875cebb3a8948a57bbc75189240/test%2Fparallel%2Ftest-stdio-pipe-redirect.js",
            "raw_url": "https://github.com/nodejs/node/raw/1bda746c1bf8f875cebb3a8948a57bbc75189240/test%2Fparallel%2Ftest-stdio-pipe-redirect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stdio-pipe-redirect.js?ref=1bda746c1bf8f875cebb3a8948a57bbc75189240",
            "patch": "@@ -0,0 +1,38 @@\n+'use strict';\n+require('../common');\n+\n+// Test if Node handles redirecting one child process stdout to another\n+// process stdin without crashing.\n+const spawn = require('child_process').spawn;\n+\n+const writeSize = 100;\n+const totalDots = 10000;\n+\n+const who = process.argv.length <= 2 ? 'parent' : process.argv[2];\n+\n+switch (who) {\n+  case 'parent':\n+    const consumer = spawn(process.argv0, [process.argv[1], 'consumer'], {\n+      stdio: ['pipe', 'ignore', 'inherit'],\n+    });\n+    const producer = spawn(process.argv0, [process.argv[1], 'producer'], {\n+      stdio: ['pipe', consumer.stdin, 'inherit'],\n+    });\n+    process.stdin.on('data', () => {});\n+    producer.on('exit', process.exit);\n+    break;\n+  case 'producer':\n+    const buffer = Buffer.alloc(writeSize, '.');\n+    let written = 0;\n+    const write = () => {\n+      if (written < totalDots) {\n+        written += writeSize;\n+        process.stdout.write(buffer, write);\n+      }\n+    };\n+    write();\n+    break;\n+  case 'consumer':\n+    process.stdin.on('data', () => {});\n+    break;\n+}"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 73,
        "deletions": 0
    }
}