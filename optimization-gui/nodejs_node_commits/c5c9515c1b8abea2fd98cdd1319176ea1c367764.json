{
    "author": "joyeecheung",
    "message": "fs: fix stack overflow in fs.readdirSync\n\nPreviously, fs.readdirSync calls the function returned by\nenv->push_values_to_array_function() in batch and check the returned\nMaybe right away in C++, which can lead to assertions if the call stack\nalready reaches the maximum size. This patch fixes that by returning\nearly the call fails so the stack overflow error will be properly\nthrown into JS land.\n\nPR-URL: https://github.com/nodejs/node/pull/18647\nFixes: https://github.com/nodejs/node/issues/18645\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "c5c9515c1b8abea2fd98cdd1319176ea1c367764",
    "files": [
        {
            "sha": "9f9c7044f911676209a5966077de186566cfc0c4",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/c5c9515c1b8abea2fd98cdd1319176ea1c367764/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c5c9515c1b8abea2fd98cdd1319176ea1c367764/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=c5c9515c1b8abea2fd98cdd1319176ea1c367764",
            "patch": "@@ -1132,14 +1132,20 @@ static void ReadDir(const FunctionCallbackInfo<Value>& args) {\n       name_v[name_idx++] = filename.ToLocalChecked();\n \n       if (name_idx >= arraysize(name_v)) {\n-        fn->Call(env->context(), names, name_idx, name_v)\n-            .ToLocalChecked();\n+        MaybeLocal<Value> ret = fn->Call(env->context(), names, name_idx,\n+                                         name_v);\n+        if (ret.IsEmpty()) {\n+          return;\n+        }\n         name_idx = 0;\n       }\n     }\n \n     if (name_idx > 0) {\n-      fn->Call(env->context(), names, name_idx, name_v).ToLocalChecked();\n+      MaybeLocal<Value> ret = fn->Call(env->context(), names, name_idx, name_v);\n+      if (ret.IsEmpty()) {\n+        return;\n+      }\n     }\n \n     args.GetReturnValue().Set(names);"
        },
        {
            "sha": "b7dea52cc37ec5e866b9b77746cc6692b44003bc",
            "filename": "test/parallel/test-fs-readdir-stack-overflow.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/c5c9515c1b8abea2fd98cdd1319176ea1c367764/test%2Fparallel%2Ftest-fs-readdir-stack-overflow.js",
            "raw_url": "https://github.com/nodejs/node/raw/c5c9515c1b8abea2fd98cdd1319176ea1c367764/test%2Fparallel%2Ftest-fs-readdir-stack-overflow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-readdir-stack-overflow.js?ref=c5c9515c1b8abea2fd98cdd1319176ea1c367764",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+const fs = require('fs');\n+\n+function recurse() {\n+  fs.readdirSync('.');\n+  recurse();\n+}\n+\n+common.expectsError(\n+  () => recurse(),\n+  {\n+    type: RangeError,\n+    message: 'Maximum call stack size exceeded'\n+  }\n+);"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 27,
        "deletions": 3
    }
}