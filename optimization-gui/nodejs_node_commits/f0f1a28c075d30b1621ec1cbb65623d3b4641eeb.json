{
    "author": "targos",
    "message": "deps: patch V8 to 7.0.276.38\n\nRefs: https://github.com/v8/v8/compare/7.0.276.36...7.0.276.38\n\nPR-URL: https://github.com/nodejs/node/pull/24271\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
    "files": [
        {
            "sha": "63dc5e7a7bab0f1f49d936f26094c5f8b979660a",
            "filename": "deps/v8/include/v8-version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Finclude%2Fv8-version.h",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Finclude%2Fv8-version.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-version.h?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -11,7 +11,7 @@\n #define V8_MAJOR_VERSION 7\n #define V8_MINOR_VERSION 0\n #define V8_BUILD_NUMBER 276\n-#define V8_PATCH_LEVEL 36\n+#define V8_PATCH_LEVEL 38\n \n // Use 1 for candidates and 0 otherwise.\n // (Boolean macro values are not supported by all preprocessors.)"
        },
        {
            "sha": "892a4e980e8b5500d8618e93a75f2ab79c25c6fa",
            "filename": "deps/v8/src/wasm/module-compiler.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 26,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.cc?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -2329,12 +2329,6 @@ void AsyncCompileJob::CancelPendingForegroundTask() {\n   pending_foreground_task_ = nullptr;\n }\n \n-template <typename Step, typename... Args>\n-void AsyncCompileJob::DoSync(Args&&... args) {\n-  NextStep<Step>(std::forward<Args>(args)...);\n-  StartForegroundTask();\n-}\n-\n void AsyncCompileJob::StartBackgroundTask() {\n   auto task = base::make_unique<CompileTask>(this, false);\n \n@@ -2347,6 +2341,18 @@ void AsyncCompileJob::StartBackgroundTask() {\n   }\n }\n \n+template <typename Step, typename... Args>\n+void AsyncCompileJob::DoSync(Args&&... args) {\n+  NextStep<Step>(std::forward<Args>(args)...);\n+  StartForegroundTask();\n+}\n+\n+template <typename Step, typename... Args>\n+void AsyncCompileJob::DoImmediately(Args&&... args) {\n+  NextStep<Step>(std::forward<Args>(args)...);\n+  ExecuteForegroundTaskImmediately();\n+}\n+\n template <typename Step, typename... Args>\n void AsyncCompileJob::DoAsync(Args&&... args) {\n   NextStep<Step>(std::forward<Args>(args)...);\n@@ -2686,11 +2692,10 @@ bool AsyncStreamingProcessor::ProcessCodeSectionHeader(size_t functions_count,\n     FinishAsyncCompileJobWithError(decoder_.FinishDecoding(false));\n     return false;\n   }\n-  job_->NextStep<AsyncCompileJob::PrepareAndStartCompile>(\n-      decoder_.shared_module(), false);\n   // Execute the PrepareAndStartCompile step immediately and not in a separate\n   // task.\n-  job_->ExecuteForegroundTaskImmediately();\n+  job_->DoImmediately<AsyncCompileJob::PrepareAndStartCompile>(\n+      decoder_.shared_module(), false);\n \n   job_->native_module_->compilation_state()->SetNumberOfFunctionsToCompile(\n       functions_count);\n@@ -2734,25 +2739,26 @@ void AsyncStreamingProcessor::OnFinishedChunk() {\n // Finish the processing of the stream.\n void AsyncStreamingProcessor::OnFinishedStream(OwnedVector<uint8_t> bytes) {\n   TRACE_STREAMING(\"Finish stream...\\n\");\n-  if (job_->native_module_) {\n-    job_->wire_bytes_ = ModuleWireBytes(bytes.as_vector());\n-    job_->native_module_->set_wire_bytes(std::move(bytes));\n-  }\n   ModuleResult result = decoder_.FinishDecoding(false);\n   DCHECK(result.ok());\n-  if (job_->DecrementAndCheckFinisherCount()) {\n-    if (job_->native_module_ == nullptr) {\n-      // We are processing a WebAssembly module without code section. We need to\n-      // prepare compilation first before we can finish it.\n-      // {PrepareAndStartCompile} will call {FinishCompile} by itself if there\n-      // is no code section.\n-      job_->DoSync<AsyncCompileJob::PrepareAndStartCompile>(result.val, true);\n-    } else {\n-      HandleScope scope(job_->isolate_);\n-      SaveContext saved_context(job_->isolate_);\n-      job_->isolate_->set_context(*job_->native_context_);\n-      job_->FinishCompile();\n-    }\n+  bool needs_finish = job_->DecrementAndCheckFinisherCount();\n+  if (job_->native_module_ == nullptr) {\n+    // We are processing a WebAssembly module without code section. We need to\n+    // prepare compilation first before we can finish it.\n+    // {PrepareAndStartCompile} will call {FinishCompile} by itself if there\n+    // is no code section.\n+    DCHECK(needs_finish);\n+    needs_finish = false;\n+    job_->DoImmediately<AsyncCompileJob::PrepareAndStartCompile>(result.val,\n+                                                                 true);\n+  }\n+  job_->wire_bytes_ = ModuleWireBytes(bytes.as_vector());\n+  job_->native_module_->set_wire_bytes(std::move(bytes));\n+  if (needs_finish) {\n+    HandleScope scope(job_->isolate_);\n+    SaveContext saved_context(job_->isolate_);\n+    job_->isolate_->set_context(*job_->native_context_);\n+    job_->FinishCompile();\n   }\n }\n "
        },
        {
            "sha": "934c978d491109161cbcb1ad02a3912dd0228f81",
            "filename": "deps/v8/src/wasm/module-compiler.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fwasm%2Fmodule-compiler.h?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -126,6 +126,10 @@ class AsyncCompileJob {\n   template <typename Step, typename... Args>\n   void DoSync(Args&&... args);\n \n+  // Switches to the compilation step {Step} and immediately executes that step.\n+  template <typename Step, typename... Args>\n+  void DoImmediately(Args&&... args);\n+\n   // Switches to the compilation step {Step} and starts a background task to\n   // execute it.\n   template <typename Step, typename... Args>"
        },
        {
            "sha": "990e21590e5a7f7695135c84d785c7ec0f15ea38",
            "filename": "deps/v8/test/mjsunit/regress/regress-897366.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-897366.js",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-897366.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fregress%2Fregress-897366.js?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2018 the V8 project authors. All rights reserved.\n+// Use of this source code is governed by a BSD-style license that can be\n+// found in the LICENSE file.\n+\n+// Flags: --gc-interval=100\n+\n+let xs = [];\n+for (let i = 0; i < 205; ++i) {\n+  xs.push(i);\n+}\n+xs.sort((a, b) => {\n+  xs.shift();\n+  xs[xs.length] = -246;\n+  return a - b;\n+});"
        },
        {
            "sha": "39a339aae63209e37849b33ddbd630d6ccc643be",
            "filename": "deps/v8/test/mjsunit/wasm/async-compile.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Ftest%2Fmjsunit%2Fwasm%2Fasync-compile.js",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Ftest%2Fmjsunit%2Fwasm%2Fasync-compile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fmjsunit%2Fwasm%2Fasync-compile.js?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -70,3 +70,10 @@ assertPromiseResult(async function badFunctionInTheMiddle() {\n   let buffer = builder.toBuffer();\n   await assertCompileError(buffer);\n }());\n+\n+assertPromiseResult(async function importWithoutCode() {\n+  // Regression test for https://crbug.com/898310.\n+  let builder = new WasmModuleBuilder();\n+  builder.addImport('m', 'q', kSig_i_i);\n+  await builder.asyncInstantiate({'m': {'q': i => i}});\n+}());"
        },
        {
            "sha": "65d0b8348bd2106f60f2dfe780cc850a0d4fe77a",
            "filename": "deps/v8/third_party/v8/builtins/array-sort.tq",
            "status": "modified",
            "additions": 42,
            "deletions": 55,
            "changes": 97,
            "blob_url": "https://github.com/nodejs/node/blob/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fthird_party%2Fv8%2Fbuiltins%2Farray-sort.tq",
            "raw_url": "https://github.com/nodejs/node/raw/f0f1a28c075d30b1621ec1cbb65623d3b4641eeb/deps%2Fv8%2Fthird_party%2Fv8%2Fbuiltins%2Farray-sort.tq",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fthird_party%2Fv8%2Fbuiltins%2Farray-sort.tq?ref=f0f1a28c075d30b1621ec1cbb65623d3b4641eeb",
            "patch": "@@ -826,7 +826,7 @@ module array {\n     assert(i >= 0);\n     assert(i == stack_size - 2 || i == stack_size - 3);\n \n-    const elements: HeapObject = ReloadElements(sortState);\n+    let elements: HeapObject = ReloadElements(sortState);\n     const Load: LoadFn = GetLoadFn(sortState);\n \n     const pending_runs: FixedArray =\n@@ -859,6 +859,7 @@ module array {\n       const k: Smi = CallGallopRight(\n           context, sortState, Load, key_right, base_a, length_a, 0, False)\n       otherwise Bailout;\n+      elements = ReloadElements(sortState);\n       assert(k >= 0);\n \n       base_a = base_a + k;\n@@ -874,6 +875,7 @@ module array {\n       length_b = CallGallopLeft(\n           context, sortState, Load, key_left, base_b, length_b, length_b - 1,\n           False) otherwise Bailout;\n+      elements = ReloadElements(sortState);\n       assert(length_b >= 0);\n       if (length_b == 0) return kSuccess;\n \n@@ -893,6 +895,12 @@ module array {\n     }\n   }\n \n+  macro LoadElementsOrTempArray(\n+      useTempArray: Boolean, sortState: FixedArray): HeapObject {\n+    return useTempArray == True ? GetTempArray(sortState) :\n+                                  ReloadElements(sortState);\n+  }\n+\n   // Locates the proper position of key in a sorted array; if the array contains\n   // an element equal to key, return the position immediately to the left of\n   // the leftmost equal element. (GallopRight does the same except returns the\n@@ -916,25 +924,17 @@ module array {\n     assert(length > 0 && base >= 0);\n     assert(0 <= hint && hint < length);\n \n-    // We cannot leave a pointer to elements on the stack (see comment at\n-    // ReloadElements). For this reason we pass a flag whether to reload\n-    // and which array to use.\n-    let elements: HeapObject = useTempArray == True ? GetTempArray(sortState) :\n-                                                      ReloadElements(sortState);\n-\n     let last_ofs: Smi = 0;\n     let offset: Smi = 1;\n \n     try {\n-      const base_hint_element: Object =\n-          CallLoad(context, sortState, Load, elements, base + hint)\n+      const base_hint_element: Object = CallLoad(\n+          context, sortState, Load,\n+          LoadElementsOrTempArray(useTempArray, sortState), base + hint)\n       otherwise Bailout;\n       let order: Number =\n           CallCompareFn(context, sortState, base_hint_element, key)\n       otherwise Bailout;\n-      if (useTempArray == False) {\n-        elements = ReloadElements(sortState);\n-      }\n \n       if (order < 0) {\n         // a[base + hint] < key: gallop right, until\n@@ -943,14 +943,13 @@ module array {\n         // a[base + length - 1] is highest.\n         let max_ofs: Smi = length - hint;\n         while (offset < max_ofs) {\n-          const offset_element: Object =\n-              CallLoad(context, sortState, Load, elements, base + hint + offset)\n+          const offset_element: Object = CallLoad(\n+              context, sortState, Load,\n+              LoadElementsOrTempArray(useTempArray, sortState),\n+              base + hint + offset)\n           otherwise Bailout;\n           order = CallCompareFn(context, sortState, offset_element, key)\n           otherwise Bailout;\n-          if (useTempArray == False) {\n-            elements = ReloadElements(sortState);\n-          }\n \n           // a[base + hint + offset] >= key? Break.\n           if (order >= 0) break;\n@@ -975,14 +974,13 @@ module array {\n         // a[base + hint] is lowest.\n         let max_ofs: Smi = hint + 1;\n         while (offset < max_ofs) {\n-          const offset_element: Object =\n-              CallLoad(context, sortState, Load, elements, base + hint - offset)\n+          const offset_element: Object = CallLoad(\n+              context, sortState, Load,\n+              LoadElementsOrTempArray(useTempArray, sortState),\n+              base + hint - offset)\n           otherwise Bailout;\n           order = CallCompareFn(context, sortState, offset_element, key)\n           otherwise Bailout;\n-          if (useTempArray == False) {\n-            elements = ReloadElements(sortState);\n-          }\n \n           if (order < 0) break;\n \n@@ -1011,14 +1009,12 @@ module array {\n       while (last_ofs < offset) {\n         const m: Smi = last_ofs + ((offset - last_ofs) >>> 1);\n \n-        const base_m_element: Object =\n-            CallLoad(context, sortState, Load, elements, base + m)\n+        const base_m_element: Object = CallLoad(\n+            context, sortState, Load,\n+            LoadElementsOrTempArray(useTempArray, sortState), base + m)\n         otherwise Bailout;\n         order = CallCompareFn(context, sortState, base_m_element, key)\n         otherwise Bailout;\n-        if (useTempArray == False) {\n-          elements = ReloadElements(sortState);\n-        }\n \n         if (order < 0) {\n           last_ofs = m + 1;  // a[base + m] < key.\n@@ -1051,25 +1047,17 @@ module array {\n     assert(length > 0 && base >= 0);\n     assert(0 <= hint && hint < length);\n \n-    // We cannot leave a pointer to elements on the stack (see comment at\n-    // ReloadElements). For this reason we pass a flag whether to reload\n-    // and which array to use.\n-    let elements: HeapObject = useTempArray == True ? GetTempArray(sortState) :\n-                                                      ReloadElements(sortState);\n-\n     let last_ofs: Smi = 0;\n     let offset: Smi = 1;\n \n     try {\n-      const base_hint_element: Object =\n-          CallLoad(context, sortState, Load, elements, base + hint)\n+      const base_hint_element: Object = CallLoad(\n+          context, sortState, Load,\n+          LoadElementsOrTempArray(useTempArray, sortState), base + hint)\n       otherwise Bailout;\n       let order: Number =\n           CallCompareFn(context, sortState, key, base_hint_element)\n       otherwise Bailout;\n-      if (useTempArray == False) {\n-        elements = ReloadElements(sortState);\n-      }\n \n       if (order < 0) {\n         // key < a[base + hint]: gallop left, until\n@@ -1078,14 +1066,13 @@ module array {\n         // a[base + hint] is lowest.\n         let max_ofs: Smi = hint + 1;\n         while (offset < max_ofs) {\n-          const offset_element: Object =\n-              CallLoad(context, sortState, Load, elements, base + hint - offset)\n+          const offset_element: Object = CallLoad(\n+              context, sortState, Load,\n+              LoadElementsOrTempArray(useTempArray, sortState),\n+              base + hint - offset)\n           otherwise Bailout;\n           order = CallCompareFn(context, sortState, key, offset_element)\n           otherwise Bailout;\n-          if (useTempArray == False) {\n-            elements = ReloadElements(sortState);\n-          }\n \n           if (order >= 0) break;\n \n@@ -1109,14 +1096,13 @@ module array {\n         // a[base + length - 1] is highest.\n         let max_ofs: Smi = length - hint;\n         while (offset < max_ofs) {\n-          const offset_element: Object =\n-              CallLoad(context, sortState, Load, elements, base + hint + offset)\n+          const offset_element: Object = CallLoad(\n+              context, sortState, Load,\n+              LoadElementsOrTempArray(useTempArray, sortState),\n+              base + hint + offset)\n           otherwise Bailout;\n           order = CallCompareFn(context, sortState, key, offset_element)\n           otherwise Bailout;\n-          if (useTempArray == False) {\n-            elements = ReloadElements(sortState);\n-          }\n \n           // a[base + hint + ofs] <= key.\n           if (order < 0) break;\n@@ -1144,14 +1130,12 @@ module array {\n       while (last_ofs < offset) {\n         const m: Smi = last_ofs + ((offset - last_ofs) >>> 1);\n \n-        const base_m_element: Object =\n-            CallLoad(context, sortState, Load, elements, base + m)\n+        const base_m_element: Object = CallLoad(\n+            context, sortState, Load,\n+            LoadElementsOrTempArray(useTempArray, sortState), base + m)\n         otherwise Bailout;\n         order = CallCompareFn(context, sortState, key, base_m_element)\n         otherwise Bailout;\n-        if (useTempArray == False) {\n-          elements = ReloadElements(sortState);\n-        }\n \n         if (order < 0) {\n           offset = m;  // key < a[base + m].\n@@ -1288,6 +1272,7 @@ module array {\n           nof_wins_a = CallGallopRight(\n               context, sortState, Load<TempArrayElements>, key_right,\n               cursor_temp, length_a, 0, True) otherwise Bailout;\n+          elements = ReloadElements(sortState);\n           assert(nof_wins_a >= 0);\n \n           if (nof_wins_a > 0) {\n@@ -1313,6 +1298,7 @@ module array {\n               context, sortState, LoadF, temp_array[cursor_temp], cursor_b,\n               length_b, 0, False)\n           otherwise Bailout;\n+          elements = ReloadElements(sortState);\n           assert(nof_wins_b >= 0);\n           if (nof_wins_b > 0) {\n             CallCopyWithinSortArray(\n@@ -1461,6 +1447,7 @@ module array {\n               context, sortState, LoadF, temp_array[cursor_temp], baseA,\n               length_a, length_a - 1, False)\n           otherwise Bailout;\n+          elements = ReloadElements(sortState);\n           assert(k >= 0);\n           nof_wins_a = length_a - k;\n \n@@ -1487,6 +1474,7 @@ module array {\n           k = CallGallopLeft(\n               context, sortState, Load<TempArrayElements>, key, 0, length_b,\n               length_b - 1, True) otherwise Bailout;\n+          elements = ReloadElements(sortState);\n           assert(k >= 0);\n           nof_wins_b = length_b - k;\n \n@@ -1743,8 +1731,7 @@ module array {\n     // 2. Let obj be ? ToObject(this value).\n     const obj: JSReceiver = ToObject(context, receiver);\n \n-    const sort_state: FixedArray =\n-        AllocateZeroedFixedArray(kSortStateSize);\n+    const sort_state: FixedArray = AllocateZeroedFixedArray(kSortStateSize);\n     FillFixedArrayWithSmiZero(sort_state, SmiTag(kSortStateSize));\n \n     sort_state[kReceiverIdx] = obj;"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 101,
        "deletions": 82
    }
}