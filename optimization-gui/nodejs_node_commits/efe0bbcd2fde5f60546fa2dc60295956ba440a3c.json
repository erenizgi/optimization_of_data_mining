{
    "author": "jasnell",
    "message": "http2: add http2stream.endAfterHeaders property\n\nIndicates is the END_STREAM flag was set on the received HEADERS frame\n\nPR-URL: https://github.com/nodejs/node/pull/22843\nFixes: https://github.com/nodejs/node/issues/22497\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "efe0bbcd2fde5f60546fa2dc60295956ba440a3c",
    "files": [
        {
            "sha": "feeb66aa88c108d88a322327c92a8d2b6ee6f6a5",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=efe0bbcd2fde5f60546fa2dc60295956ba440a3c",
            "patch": "@@ -958,6 +958,17 @@ added: v8.4.0\n Set to `true` if the `Http2Stream` instance has been destroyed and is no longer\n usable.\n \n+#### http2stream.endAfterHeaders\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* {boolean}\n+\n+Set the `true` if the `END_STREAM` flag was set in the request or response\n+HEADERS frame received, indicating that no additional data should be received\n+and the readable side of the `Http2Stream` will be closed.\n+\n #### http2stream.pending\n <!-- YAML\n added: v9.4.0"
        },
        {
            "sha": "0b9be932af3479889165aabbf164435f4fe159e9",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=efe0bbcd2fde5f60546fa2dc60295956ba440a3c",
            "patch": "@@ -276,6 +276,8 @@ function onSessionHeaders(handle, id, cat, flags, headers) {\n     } else {\n       stream = new ClientHttp2Stream(session, handle, id, opts);\n     }\n+    if (endOfStream)\n+      stream[kState].endAfterHeaders = true;\n     process.nextTick(emit, session, 'stream', stream, obj, flags, headers);\n   } else {\n     let event;\n@@ -1548,7 +1550,8 @@ class Http2Stream extends Duplex {\n       flags: STREAM_FLAGS_PENDING,\n       rstCode: NGHTTP2_NO_ERROR,\n       writeQueueSize: 0,\n-      trailersReady: false\n+      trailersReady: false,\n+      endAfterHeaders: false\n     };\n \n     this.on('pause', streamOnPause);\n@@ -1594,6 +1597,10 @@ class Http2Stream extends Duplex {\n     return `Http2Stream ${util.format(obj)}`;\n   }\n \n+  get endAfterHeaders() {\n+    return this[kState].endAfterHeaders;\n+  }\n+\n   get sentHeaders() {\n     return this[kSentHeaders];\n   }"
        },
        {
            "sha": "429ffc3188452d65e98b94bd4e197dbe99021f62",
            "filename": "test/parallel/test-http2-endafterheaders.js",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/test%2Fparallel%2Ftest-http2-endafterheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/efe0bbcd2fde5f60546fa2dc60295956ba440a3c/test%2Fparallel%2Ftest-http2-endafterheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-endafterheaders.js?ref=efe0bbcd2fde5f60546fa2dc60295956ba440a3c",
            "patch": "@@ -0,0 +1,50 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const http2 = require('http2');\n+const Countdown = require('../common/countdown');\n+\n+const server = http2.createServer();\n+server.on('stream', common.mustCall((stream, headers) => {\n+  const check = headers[':method'] === 'GET' ? true : false;\n+  assert.strictEqual(stream.endAfterHeaders, check);\n+  stream.on('data', common.mustNotCall());\n+  stream.on('end', common.mustCall());\n+  stream.respond();\n+  stream.end('ok');\n+}, 2));\n+\n+const countdown = new Countdown(2, () => server.close());\n+\n+server.listen(0, common.mustCall(() => {\n+  {\n+    const client = http2.connect(`http://localhost:${server.address().port}`);\n+    const req = client.request();\n+\n+    req.resume();\n+    req.on('response', common.mustCall(() => {\n+      assert.strictEqual(req.endAfterHeaders, false);\n+    }));\n+    req.on('end', common.mustCall(() => {\n+      client.close();\n+      countdown.dec();\n+    }));\n+  }\n+  {\n+    const client = http2.connect(`http://localhost:${server.address().port}`);\n+    const req = client.request({ ':method': 'POST' });\n+\n+    req.resume();\n+    req.end();\n+    req.on('response', common.mustCall(() => {\n+      assert.strictEqual(req.endAfterHeaders, false);\n+    }));\n+    req.on('end', common.mustCall(() => {\n+      client.close();\n+      countdown.dec();\n+    }));\n+  }\n+}));"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 69,
        "deletions": 1
    }
}