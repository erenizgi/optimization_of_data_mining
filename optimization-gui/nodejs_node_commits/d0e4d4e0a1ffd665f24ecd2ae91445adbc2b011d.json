{
    "author": "MylesBorins",
    "message": "deps: patch V8 to 6.4.388.42\n\nPR-URL: https://github.com/nodejs/node/pull/18578\nRefs: https://github.com/v8/v8/compare/6.4.388.41...6.4.388.42\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
    "files": [
        {
            "sha": "8c4bc0237702ed63505e9c231e159437c5f0d40b",
            "filename": "deps/v8/include/v8-version.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Finclude%2Fv8-version.h",
            "raw_url": "https://github.com/nodejs/node/raw/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Finclude%2Fv8-version.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-version.h?ref=d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
            "patch": "@@ -11,7 +11,7 @@\n #define V8_MAJOR_VERSION 6\n #define V8_MINOR_VERSION 4\n #define V8_BUILD_NUMBER 388\n-#define V8_PATCH_LEVEL 41\n+#define V8_PATCH_LEVEL 42\n \n // Use 1 for candidates and 0 otherwise.\n // (Boolean macro values are not supported by all preprocessors.)"
        },
        {
            "sha": "23713197f59d66ab1d272d339f584bd4cd4959e6",
            "filename": "deps/v8/src/frames.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fframes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fframes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fframes.cc?ref=d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
            "patch": "@@ -1013,6 +1013,15 @@ JSFunction* JavaScriptFrame::function() const {\n   return JSFunction::cast(function_slot_object());\n }\n \n+Object* JavaScriptFrame::unchecked_function() const {\n+  // During deoptimization of an optimized function, we may have yet to\n+  // materialize some closures on the stack. The arguments marker object\n+  // marks this case.\n+  DCHECK(function_slot_object()->IsJSFunction() ||\n+         isolate()->heap()->arguments_marker() == function_slot_object());\n+  return function_slot_object();\n+}\n+\n Object* JavaScriptFrame::receiver() const { return GetParameter(-1); }\n \n Object* JavaScriptFrame::context() const {"
        },
        {
            "sha": "e21d62764b30c32e5f4eab05322ce06134dab9ba",
            "filename": "deps/v8/src/frames.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fframes.h",
            "raw_url": "https://github.com/nodejs/node/raw/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fframes.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fframes.h?ref=d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
            "patch": "@@ -684,6 +684,7 @@ class JavaScriptFrame : public StandardFrame {\n \n   // Accessors.\n   virtual JSFunction* function() const;\n+  Object* unchecked_function() const;\n   Object* receiver() const override;\n   Object* context() const override;\n   Script* script() const override;"
        },
        {
            "sha": "51fe8866fa1c190f39f004a601a51310fd9702dc",
            "filename": "deps/v8/src/profiler/sampling-heap-profiler.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fprofiler%2Fsampling-heap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Fsrc%2Fprofiler%2Fsampling-heap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fsampling-heap-profiler.cc?ref=d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
            "patch": "@@ -157,12 +157,21 @@ SamplingHeapProfiler::AllocationNode* SamplingHeapProfiler::AddStack() {\n   std::vector<SharedFunctionInfo*> stack;\n   JavaScriptFrameIterator it(isolate_);\n   int frames_captured = 0;\n+  bool found_arguments_marker_frames = false;\n   while (!it.done() && frames_captured < stack_depth_) {\n     JavaScriptFrame* frame = it.frame();\n-    SharedFunctionInfo* shared = frame->function()->shared();\n-    stack.push_back(shared);\n-\n-    frames_captured++;\n+    // If we are materializing objects during deoptimization, inlined\n+    // closures may not yet be materialized, and this includes the\n+    // closure on the stack. Skip over any such frames (they'll be\n+    // in the top frames of the stack). The allocations made in this\n+    // sensitive moment belong to the formerly optimized frame anyway.\n+    if (frame->unchecked_function()->IsJSFunction()) {\n+      SharedFunctionInfo* shared = frame->function()->shared();\n+      stack.push_back(shared);\n+      frames_captured++;\n+    } else {\n+      found_arguments_marker_frames = true;\n+    }\n     it.Advance();\n   }\n \n@@ -209,6 +218,12 @@ SamplingHeapProfiler::AllocationNode* SamplingHeapProfiler::AddStack() {\n     }\n     node = node->FindOrAddChildNode(name, script_id, shared->start_position());\n   }\n+\n+  if (found_arguments_marker_frames) {\n+    node =\n+        node->FindOrAddChildNode(\"(deopt)\", v8::UnboundScript::kNoScriptId, 0);\n+  }\n+\n   return node;\n }\n "
        },
        {
            "sha": "a0796ccd56c158cc10d82207a695e10ddd1ab3d9",
            "filename": "deps/v8/test/cctest/test-heap-profiler.cc",
            "status": "modified",
            "additions": 47,
            "deletions": 1,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc?ref=d0e4d4e0a1ffd665f24ecd2ae91445adbc2b011d",
            "patch": "@@ -3083,7 +3083,7 @@ TEST(SamplingHeapProfilerPretenuredInlineAllocations) {\n   // Suppress randomness to avoid flakiness in tests.\n   v8::internal::FLAG_sampling_heap_profiler_suppress_randomness = true;\n \n-  // Grow new space unitl maximum capacity reached.\n+  // Grow new space until maximum capacity reached.\n   while (!CcTest::heap()->new_space()->IsAtMaximumCapacity()) {\n     CcTest::heap()->new_space()->Grow();\n   }\n@@ -3138,3 +3138,49 @@ TEST(SamplingHeapProfilerPretenuredInlineAllocations) {\n \n   CHECK_GE(count, 8000);\n }\n+\n+TEST(SamplingHeapProfilerSampleDuringDeopt) {\n+  i::FLAG_allow_natives_syntax = true;\n+\n+  v8::HandleScope scope(v8::Isolate::GetCurrent());\n+  LocalContext env;\n+  v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n+\n+  // Suppress randomness to avoid flakiness in tests.\n+  v8::internal::FLAG_sampling_heap_profiler_suppress_randomness = true;\n+\n+  // Small sample interval to force each object to be sampled.\n+  heap_profiler->StartSamplingHeapProfiler(i::kPointerSize);\n+\n+  // Lazy deopt from runtime call from inlined callback function.\n+  const char* source =\n+      \"var b = \"\n+      \"  [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25];\"\n+      \"(function f() {\"\n+      \"  var result = 0;\"\n+      \"  var lazyDeopt = function(deopt) {\"\n+      \"    var callback = function(v,i,o) {\"\n+      \"      result += i;\"\n+      \"      if (i == 13 && deopt) {\"\n+      \"          %DeoptimizeNow();\"\n+      \"      }\"\n+      \"      return v;\"\n+      \"    };\"\n+      \"    b.map(callback);\"\n+      \"  };\"\n+      \"  lazyDeopt();\"\n+      \"  lazyDeopt();\"\n+      \"  %OptimizeFunctionOnNextCall(lazyDeopt);\"\n+      \"  lazyDeopt();\"\n+      \"  lazyDeopt(true);\"\n+      \"  lazyDeopt();\"\n+      \"})();\";\n+\n+  CompileRun(source);\n+  // Should not crash.\n+\n+  std::unique_ptr<v8::AllocationProfile> profile(\n+      heap_profiler->GetAllocationProfile());\n+  CHECK(profile);\n+  heap_profiler->StopSamplingHeapProfiler();\n+}"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 77,
        "deletions": 6
    }
}