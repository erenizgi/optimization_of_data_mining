{
    "author": "rubys",
    "message": "tools: build all.html by combining generated HTML\n\nCombine the toc and api contents from the generated doc/api/*.html\nfiles. This ensures that the single page version of the documentation\nexactly matches the individual pages.\n\nPR-URL: https://github.com/nodejs/node/pull/21568\nFixes: https://github.com/nodejs/node/issues/20100\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>",
    "sha": "f85962fe4d3afa55aedcfdab3aa61258c5af3e2a",
    "files": [
        {
            "sha": "f407066cf512ad77ddf733d16027119695a3e64f",
            "filename": "Makefile",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f85962fe4d3afa55aedcfdab3aa61258c5af3e2a/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/f85962fe4d3afa55aedcfdab3aa61258c5af3e2a/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=f85962fe4d3afa55aedcfdab3aa61258c5af3e2a",
            "patch": "@@ -650,12 +650,16 @@ gen-json = tools/doc/generate.js --format=json $< > $@\n gen-html = tools/doc/generate.js --node-version=$(FULLVERSION) --format=html \\\n \t\t\t--analytics=$(DOCS_ANALYTICS) $< > $@\n \n-out/doc/api/%.json: doc/api/%.md\n+out/doc/api/%.json: doc/api/%.md tools/doc/generate.js tools/doc/json.js\n \t$(call available-node, $(gen-json))\n \n-out/doc/api/%.html: doc/api/%.md\n+out/doc/api/%.html: doc/api/%.md tools/doc/generate.js tools/doc/html.js\n \t$(call available-node, $(gen-html))\n \n+out/doc/api/all.html: $(filter-out out/doc/api/all.html, $(apidocs_html)) \\\n+\ttools/doc/allhtml.js\n+\t$(call available-node, tools/doc/allhtml.js)\n+\n .PHONY: docopen\n docopen: $(apidocs_html)\n \t@$(PYTHON) -mwebbrowser file://$(PWD)/out/doc/api/all.html"
        },
        {
            "sha": "fad530f1c44245c07474d16dafcaa98e13ee1972",
            "filename": "tools/doc/allhtml.js",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/f85962fe4d3afa55aedcfdab3aa61258c5af3e2a/tools%2Fdoc%2Fallhtml.js",
            "raw_url": "https://github.com/nodejs/node/raw/f85962fe4d3afa55aedcfdab3aa61258c5af3e2a/tools%2Fdoc%2Fallhtml.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fallhtml.js?ref=f85962fe4d3afa55aedcfdab3aa61258c5af3e2a",
            "patch": "@@ -0,0 +1,73 @@\n+'use strict';\n+\n+// Build all.html by combining the generated toc and apicontent from each\n+// of the generated html files.\n+\n+const fs = require('fs');\n+\n+const source = `${__dirname}/../../out/doc/api`;\n+\n+// Get a list of generated API documents.\n+const htmlFiles = fs.readdirSync(source, 'utf8')\n+  .filter((name) => name.includes('.html') && name !== 'all.html');\n+\n+// Read the table of contents.\n+const toc = fs.readFileSync(source + '/_toc.html', 'utf8');\n+\n+// Extract (and concatenate) the toc and apicontent from each document.\n+let contents = '';\n+let apicontent = '';\n+\n+// Identify files that should be skipped. As files are processed, they\n+// are added to this list to prevent dupes.\n+const seen = {\n+  'all.html': true,\n+  'index.html': true\n+};\n+\n+for (const link of toc.match(/<a.*?>/g)) {\n+  const href = /href=\"(.*?)\"/.exec(link)[1];\n+  if (!htmlFiles.includes(href) || seen[href]) continue;\n+  const data = fs.readFileSync(source + '/' + href, 'utf8');\n+\n+  // Split the doc.\n+  const match = /(<\\/ul>\\s*)?<\\/div>\\s*<div id=\"apicontent\">/.exec(data);\n+\n+  contents += data.slice(0, match.index)\n+    .replace(/[\\s\\S]*?<div id=\"toc\">\\s*<h2>.*?<\\/h2>\\s*(<ul>\\s*)?/, '');\n+\n+  apicontent += data.slice(match.index + match[0].length)\n+    .replace(/(<\\/div>\\s*)*\\s*<script[\\s\\S]*/, '')\n+    .replace(/<a href=\"(\\w[^#\"]*)#/g, (match, href) => {\n+      return htmlFiles.includes(href) ? '<a href=\"#' : match;\n+    })\n+    .trim() + '\\n';\n+\n+  // Mark source as seen.\n+  seen[href] = true;\n+}\n+\n+// Replace various mentions of _toc with all.\n+let all = toc.replace(/_toc\\.html/g, 'all.html')\n+  .replace('_toc.json', 'all.json')\n+  .replace('api-section-_toc', 'api-section-all')\n+  .replace('data-id=\"_toc\"', 'data-id=\"all\"');\n+\n+// Clean up the title.\n+all = all.replace(/<title>.*?\\| /, '<title>');\n+\n+// Insert the combined table of contents.\n+const tocStart = /<div id=\"toc\">\\s*<h2>.*?<\\/h2>\\s*/.exec(all);\n+all = all.slice(0, tocStart.index + tocStart[0].length) +\n+  '<ul>\\n' + contents + '</ul>\\n' +\n+  all.slice(tocStart.index + tocStart[0].length);\n+\n+// Replace apicontent with the concatenated set of apicontents from each source.\n+const apiStart = /<div id=\"apicontent\">\\s*/.exec(all);\n+const apiEnd = /(\\s*<\\/div>)*\\s*<script /.exec(all);\n+all = all.slice(0, apiStart.index + apiStart[0].length) +\n+  apicontent +\n+  all.slice(apiEnd.index);\n+\n+// Write results.\n+fs.writeFileSync(source + '/all.html', all, 'utf8');"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 79,
        "deletions": 2
    }
}