{
    "author": "gahaas",
    "message": "src: initialize PerIsolateData eagerly\n\nPR-URL: https://github.com/nodejs/node/pull/21983\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "d5e72944457117913c7ded2caf1f623a25f8726f",
    "files": [
        {
            "sha": "a12502773a83f6b238566548ae0d9790599f0b5c",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -46,7 +46,7 @@ IsolateData::IsolateData(Isolate* isolate,\n     zero_fill_field_(zero_fill_field),\n     platform_(platform) {\n   if (platform_ != nullptr)\n-    platform_->RegisterIsolate(this, event_loop);\n+    platform_->RegisterIsolate(isolate_, event_loop);\n \n   options_.reset(new PerIsolateOptions(*per_process_opts->per_isolate));\n \n@@ -99,7 +99,7 @@ IsolateData::IsolateData(Isolate* isolate,\n \n IsolateData::~IsolateData() {\n   if (platform_ != nullptr)\n-    platform_->UnregisterIsolate(this);\n+    platform_->UnregisterIsolate(isolate_);\n }\n \n "
        },
        {
            "sha": "68f23888799018ea6089b4b6561609162cd33489",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -3105,17 +3105,22 @@ bool AllowWasmCodeGenerationCallback(\n   return wasm_code_gen->IsUndefined() || wasm_code_gen->IsTrue();\n }\n \n-Isolate* NewIsolate(ArrayBufferAllocator* allocator) {\n+Isolate* NewIsolate(ArrayBufferAllocator* allocator, uv_loop_t* event_loop) {\n   Isolate::CreateParams params;\n   params.array_buffer_allocator = allocator;\n #ifdef NODE_ENABLE_VTUNE_PROFILING\n   params.code_event_handler = vTune::GetVtuneCodeEventHandler();\n #endif\n \n-  Isolate* isolate = Isolate::New(params);\n+  Isolate* isolate = Isolate::Allocate();\n   if (isolate == nullptr)\n     return nullptr;\n \n+  // Register the isolate on the platform before the isolate gets initialized,\n+  // so that the isolate can access the platform during initialization.\n+  v8_platform.Platform()->RegisterIsolate(isolate, event_loop);\n+  Isolate::Initialize(isolate, params);\n+\n   isolate->AddMessageListener(OnMessage);\n   isolate->SetAbortOnUncaughtExceptionCallback(ShouldAbortOnUncaughtException);\n   isolate->SetMicrotasksPolicy(MicrotasksPolicy::kExplicit);\n@@ -3130,7 +3135,7 @@ inline int Start(uv_loop_t* event_loop,\n                  const std::vector<std::string>& exec_args) {\n   std::unique_ptr<ArrayBufferAllocator, decltype(&FreeArrayBufferAllocator)>\n       allocator(CreateArrayBufferAllocator(), &FreeArrayBufferAllocator);\n-  Isolate* const isolate = NewIsolate(allocator.get());\n+  Isolate* const isolate = NewIsolate(allocator.get(), event_loop);\n   if (isolate == nullptr)\n     return 12;  // Signal internal error.\n \n@@ -3168,6 +3173,7 @@ inline int Start(uv_loop_t* event_loop,\n   }\n \n   isolate->Dispose();\n+  v8_platform.Platform()->UnregisterIsolate(isolate);\n \n   return exit_code;\n }"
        },
        {
            "sha": "8bd4bd1549bbc3fd2d70b6e5fbc94ec744b078f2",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -246,13 +246,14 @@ class NODE_EXTERN MultiIsolatePlatform : public v8::Platform {\n   virtual void CancelPendingDelayedTasks(v8::Isolate* isolate) = 0;\n \n   // These will be called by the `IsolateData` creation/destruction functions.\n-  virtual void RegisterIsolate(IsolateData* isolate_data,\n+  virtual void RegisterIsolate(v8::Isolate* isolate,\n                                struct uv_loop_s* loop) = 0;\n-  virtual void UnregisterIsolate(IsolateData* isolate_data) = 0;\n+  virtual void UnregisterIsolate(v8::Isolate* isolate) = 0;\n };\n \n // Creates a new isolate with Node.js-specific settings.\n-NODE_EXTERN v8::Isolate* NewIsolate(ArrayBufferAllocator* allocator);\n+NODE_EXTERN v8::Isolate* NewIsolate(ArrayBufferAllocator* allocator,\n+                                    struct uv_loop_s* event_loop);\n \n // Creates a new context with Node.js-specific tweaks.\n NODE_EXTERN v8::Local<v8::Context> NewContext("
        },
        {
            "sha": "1c237159f2d2e9d77bf3c7cedc4cc3dfd2278346",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -259,8 +259,7 @@ NodePlatform::NodePlatform(int thread_pool_size,\n       std::make_shared<WorkerThreadsTaskRunner>(thread_pool_size);\n }\n \n-void NodePlatform::RegisterIsolate(IsolateData* isolate_data, uv_loop_t* loop) {\n-  Isolate* isolate = isolate_data->isolate();\n+void NodePlatform::RegisterIsolate(Isolate* isolate, uv_loop_t* loop) {\n   Mutex::ScopedLock lock(per_isolate_mutex_);\n   std::shared_ptr<PerIsolatePlatformData> existing = per_isolate_[isolate];\n   if (existing) {\n@@ -272,8 +271,7 @@ void NodePlatform::RegisterIsolate(IsolateData* isolate_data, uv_loop_t* loop) {\n   }\n }\n \n-void NodePlatform::UnregisterIsolate(IsolateData* isolate_data) {\n-  Isolate* isolate = isolate_data->isolate();\n+void NodePlatform::UnregisterIsolate(Isolate* isolate) {\n   Mutex::ScopedLock lock(per_isolate_mutex_);\n   std::shared_ptr<PerIsolatePlatformData> existing = per_isolate_[isolate];\n   CHECK(existing);"
        },
        {
            "sha": "9b9720f63804d5ee729cb271daa3637d088699fc",
            "filename": "src/node_platform.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_platform.h",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_platform.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.h?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -141,8 +141,8 @@ class NodePlatform : public MultiIsolatePlatform {\n   v8::TracingController* GetTracingController() override;\n   bool FlushForegroundTasks(v8::Isolate* isolate) override;\n \n-  void RegisterIsolate(IsolateData* isolate_data, uv_loop_t* loop) override;\n-  void UnregisterIsolate(IsolateData* isolate_data) override;\n+  void RegisterIsolate(v8::Isolate* isolate, uv_loop_t* loop) override;\n+  void UnregisterIsolate(v8::Isolate* isolate) override;\n \n   std::shared_ptr<v8::TaskRunner> GetForegroundTaskRunner(\n       v8::Isolate* isolate) override;"
        },
        {
            "sha": "609ae2f34795c0a4fb9c43a789f0a827fa5a51e3",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -67,9 +67,9 @@ Worker::Worker(Environment* env, Local<Object> wrap)\n \n   array_buffer_allocator_.reset(CreateArrayBufferAllocator());\n \n-  isolate_ = NewIsolate(array_buffer_allocator_.get());\n-  CHECK_NE(isolate_, nullptr);\n   CHECK_EQ(uv_loop_init(&loop_), 0);\n+  isolate_ = NewIsolate(array_buffer_allocator_.get(), &loop_);\n+  CHECK_NE(isolate_, nullptr);\n \n   thread_exit_async_.reset(new uv_async_t);\n   thread_exit_async_->data = this;\n@@ -265,6 +265,7 @@ void Worker::DisposeIsolate() {\n   platform->CancelPendingDelayedTasks(isolate_);\n \n   isolate_data_.reset();\n+  platform->UnregisterIsolate(isolate_);\n \n   isolate_->Dispose();\n   isolate_ = nullptr;"
        },
        {
            "sha": "4a729be09c2d0bc6331fb6f97c9e6ff4e3229196",
            "filename": "test/cctest/node_test_fixture.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d5e72944457117913c7ded2caf1f623a25f8726f/test%2Fcctest%2Fnode_test_fixture.h",
            "raw_url": "https://github.com/nodejs/node/raw/d5e72944457117913c7ded2caf1f623a25f8726f/test%2Fcctest%2Fnode_test_fixture.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_test_fixture.h?ref=d5e72944457117913c7ded2caf1f623a25f8726f",
            "patch": "@@ -90,10 +90,13 @@ class NodeTestFixture : public ::testing::Test {\n                                      &node::FreeArrayBufferAllocator);\n     isolate_ = NewIsolate(allocator.get());\n     CHECK_NE(isolate_, nullptr);\n+    platform->RegisterIsolate(isolate_, &current_loop);\n+    v8::Isolate::Initialize(isolate_, params);\n   }\n \n   virtual void TearDown() {\n     isolate_->Dispose();\n+    platform->UnregisterIsolate(isolate_);\n     isolate_ = nullptr;\n   }\n };"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 25,
        "deletions": 16
    }
}