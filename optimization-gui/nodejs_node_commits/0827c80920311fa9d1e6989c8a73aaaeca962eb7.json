{
    "author": "alexkozy",
    "message": "inspector: implemented V8InspectorClient::resourceNameToUrl\n\nThis method is required by inspector to report normalized urls over\nthe protocol.\n\nFixes https://github.com/nodejs/node/issues/22223\nPR-URL: https://github.com/nodejs/node/pull/22251\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "0827c80920311fa9d1e6989c8a73aaaeca962eb7",
    "files": [
        {
            "sha": "2eb9339d3e16412d15b1ea63ad1f1977d7d21a15",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -6,6 +6,7 @@\n #include \"inspector/tracing_agent.h\"\n #include \"node/inspector/protocol/Protocol.h\"\n #include \"node_internals.h\"\n+#include \"node_url.h\"\n #include \"v8-inspector.h\"\n #include \"v8-platform.h\"\n \n@@ -369,6 +370,25 @@ void NotifyClusterWorkersDebugEnabled(Environment* env) {\n   MakeCallback(env->isolate(), process_object, emit_fn.As<Function>(),\n                arraysize(argv), argv, {0, 0});\n }\n+\n+#ifdef _WIN32\n+bool IsFilePath(const std::string& path) {\n+  // '\\\\'\n+  if (path.length() > 2 && path[0] == '\\\\' && path[1] == '\\\\')\n+    return true;\n+  // '[A-Z]:[/\\\\]'\n+  if (path.length() < 3)\n+    return false;\n+  if ((path[0] >= 'A' && path[0] <= 'Z') || (path[0] >= 'a' && path[0] <= 'z'))\n+    return path[1] == ':' && (path[2] == '/' || path[2] == '\\\\');\n+  return false;\n+}\n+#else\n+bool IsFilePath(const std::string& path) {\n+  return path.length() && path[0] == '/';\n+}\n+#endif  // __POSIX__\n+\n }  // namespace\n \n class NodeInspectorClient : public V8InspectorClient {\n@@ -592,6 +612,18 @@ class NodeInspectorClient : public V8InspectorClient {\n     return env_->isolate_data()->platform()->CurrentClockTimeMillis();\n   }\n \n+  std::unique_ptr<StringBuffer> resourceNameToUrl(\n+      const StringView& resource_name_view) override {\n+    std::string resource_name =\n+        protocol::StringUtil::StringViewToUtf8(resource_name_view);\n+    if (!IsFilePath(resource_name))\n+      return nullptr;\n+    node::url::URL url = node::url::URL::FromFilePath(resource_name);\n+    // TODO(ak239spb): replace this code with url.href().\n+    // Refs: https://github.com/nodejs/node/issues/22610\n+    return Utf8ToStringView(url.protocol() + \"//\" + url.path());\n+  }\n+\n   node::Environment* env_;\n   bool running_nested_loop_ = false;\n   std::unique_ptr<V8Inspector> client_;"
        },
        {
            "sha": "ddef534b57485f001c35e4cb7ab2dcbc88694107",
            "filename": "test/cctest/test_url.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fcctest%2Ftest_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fcctest%2Ftest_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_url.cc?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -124,10 +124,6 @@ TEST_F(URLTest, FromFilePath) {\n   file_url = URL::FromFilePath(\"b:\\\\a\\\\%%.js\");\n   EXPECT_EQ(\"file:\", file_url.protocol());\n   EXPECT_EQ(\"/b:/a/%25%25.js\", file_url.path());\n-\n-  file_url = URL::FromFilePath(\"\\\\\\\\host\\\\a\\\\b\\\\c\");\n-  EXPECT_EQ(\"file:\", file_url.protocol());\n-  EXPECT_EQ(\"host/a/b/c\", file_url.path());\n #else\n   file_url = URL::FromFilePath(\"/\");\n   EXPECT_EQ(\"file:\", file_url.protocol());"
        },
        {
            "sha": "92879d3ff3a7dfa6ce6b46324077330df76370a5",
            "filename": "test/parallel/test-inspector-multisession-js.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fparallel%2Ftest-inspector-multisession-js.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fparallel%2Ftest-inspector-multisession-js.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspector-multisession-js.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -1,3 +1,4 @@\n+// Flags: --expose-internals\n 'use strict';\n const common = require('../common');\n \n@@ -6,6 +7,7 @@ common.skipIfInspectorDisabled();\n const assert = require('assert');\n const { Session } = require('inspector');\n const path = require('path');\n+const { pathToFileURL } = require('url');\n \n function debugged() {\n   return 42;\n@@ -32,8 +34,8 @@ async function test() {\n \n   await new Promise((resolve, reject) => {\n     session1.post('Debugger.setBreakpointByUrl', {\n-      'lineNumber': 9,\n-      'url': path.resolve(__dirname, __filename),\n+      'lineNumber': 12,\n+      'url': pathToFileURL(path.resolve(__dirname, __filename)).toString(),\n       'columnNumber': 0,\n       'condition': ''\n     }, (error, result) => {"
        },
        {
            "sha": "91581a5a073460fda420b9a5321b2e6c491346ff",
            "filename": "test/parallel/test-v8-coverage.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fparallel%2Ftest-v8-coverage.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fparallel%2Ftest-v8-coverage.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-v8-coverage.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -97,7 +97,7 @@ function getFixtureCoverage(fixtureFile, coverageDirectory) {\n   for (const coverageFile of coverageFiles) {\n     const coverage = require(path.join(coverageDirectory, coverageFile));\n     for (const fixtureCoverage of coverage.result) {\n-      if (fixtureCoverage.url.indexOf(`${path.sep}${fixtureFile}`) !== -1) {\n+      if (fixtureCoverage.url.indexOf(`/${fixtureFile}`) !== -1) {\n         return fixtureCoverage;\n       }\n     }"
        },
        {
            "sha": "f5583c1d7bc6d6279b12ef6162a5e2393d99beaa",
            "filename": "test/sequential/test-inspector-bindings.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-bindings.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-bindings.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-bindings.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -1,9 +1,11 @@\n+// Flags: --expose-internals\n 'use strict';\n const common = require('../common');\n common.skipIfInspectorDisabled();\n const assert = require('assert');\n const inspector = require('inspector');\n const path = require('path');\n+const { pathToFileURL } = require('url');\n \n // This test case will set a breakpoint 4 lines below\n function debuggedFunction() {\n@@ -84,8 +86,8 @@ function testSampleDebugSession() {\n   }, TypeError);\n   session.post('Debugger.enable', () => cbAsSecondArgCalled = true);\n   session.post('Debugger.setBreakpointByUrl', {\n-    'lineNumber': 12,\n-    'url': path.resolve(__dirname, __filename),\n+    'lineNumber': 14,\n+    'url': pathToFileURL(path.resolve(__dirname, __filename)).toString(),\n     'columnNumber': 0,\n     'condition': ''\n   });"
        },
        {
            "sha": "e7529f786a98598c0ca0fef34f130db893cb46d4",
            "filename": "test/sequential/test-inspector-break-when-eval.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-break-when-eval.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-break-when-eval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-break-when-eval.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -5,6 +5,7 @@ common.skipIfInspectorDisabled();\n const assert = require('assert');\n const { NodeInstance } = require('../common/inspector-helper.js');\n const fixtures = require('../common/fixtures');\n+const { pathToFileURL } = require('url');\n \n const script = fixtures.path('inspector-global-function.js');\n \n@@ -26,7 +27,7 @@ async function breakOnLine(session) {\n   const commands = [\n     { 'method': 'Debugger.setBreakpointByUrl',\n       'params': { 'lineNumber': 9,\n-                  'url': script,\n+                  'url': pathToFileURL(script).toString(),\n                   'columnNumber': 0,\n                   'condition': ''\n       }\n@@ -45,7 +46,7 @@ async function breakOnLine(session) {\n     }\n   ];\n   session.send(commands);\n-  await session.waitForBreakOnLine(9, script);\n+  await session.waitForBreakOnLine(9, pathToFileURL(script).toString());\n }\n \n async function stepOverConsoleStatement(session) {"
        },
        {
            "sha": "d488eea2626584b912824fab5a50eda6de95b22b",
            "filename": "test/sequential/test-inspector-debug-brk-flag.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-debug-brk-flag.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-debug-brk-flag.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-debug-brk-flag.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -24,7 +24,7 @@ async function testBreakpointOnStart(session) {\n   ];\n \n   session.send(commands);\n-  await session.waitForBreakOnLine(0, session.scriptPath());\n+  await session.waitForBreakOnLine(0, session.scriptURL());\n }\n \n async function runTests() {"
        },
        {
            "sha": "a35115b9f5f15f8d7de8066126045156e61ae59f",
            "filename": "test/sequential/test-inspector-exception.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-exception.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -7,6 +7,7 @@ common.skipIfInspectorDisabled();\n \n const assert = require('assert');\n const { NodeInstance } = require('../common/inspector-helper.js');\n+const { pathToFileURL } = require('url');\n \n const script = fixtures.path('throws_error.js');\n \n@@ -29,7 +30,7 @@ async function testBreakpointOnStart(session) {\n   ];\n \n   await session.send(commands);\n-  await session.waitForBreakOnLine(21, script);\n+  await session.waitForBreakOnLine(21, pathToFileURL(script).toString());\n }\n \n "
        },
        {
            "sha": "41a98ba219b24c80adad1430792a9e476bfc62a8",
            "filename": "test/sequential/test-inspector-resource-name-to-url.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-resource-name-to-url.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector-resource-name-to-url.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-resource-name-to-url.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -0,0 +1,40 @@\n+'use strict';\n+const common = require('../common');\n+\n+common.skipIfInspectorDisabled();\n+\n+(async function test() {\n+  const { strictEqual } = require('assert');\n+  const { Session } = require('inspector');\n+  const { promisify } = require('util');\n+  const vm = require('vm');\n+  const session = new Session();\n+  session.connect();\n+  session.post = promisify(session.post);\n+  await session.post('Debugger.enable');\n+  await check('http://example.com', 'http://example.com');\n+  await check(undefined, 'evalmachine.<anonymous>');\n+  await check('file:///foo.js', 'file:///foo.js');\n+  await check('file:///foo.js', 'file:///foo.js');\n+  await check('foo.js', 'foo.js');\n+  await check('[eval]', '[eval]');\n+  await check('%.js', '%.js');\n+\n+  if (common.isWindows) {\n+    await check('C:\\\\foo.js', 'file:///C:/foo.js');\n+    await check('C:\\\\a\\\\b\\\\c\\\\foo.js', 'file:///C:/a/b/c/foo.js');\n+    await check('a:\\\\%.js', 'file:///a:/%25.js');\n+  } else {\n+    await check('/foo.js', 'file:///foo.js');\n+    await check('/a/b/c/d/foo.js', 'file:///a/b/c/d/foo.js');\n+    await check('/%%%.js', 'file:///%25%25%25.js');\n+  }\n+\n+  async function check(filename, expected) {\n+    const promise =\n+      new Promise((resolve) => session.once('inspectorNotification', resolve));\n+    new vm.Script('42', { filename }).runInThisContext();\n+    const { params: { url } } = await promise;\n+    strictEqual(url, expected);\n+  }\n+})();"
        },
        {
            "sha": "5b8921b4ee55253810139ba3b72b3db3cbf81d16",
            "filename": "test/sequential/test-inspector.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector.js",
            "raw_url": "https://github.com/nodejs/node/raw/0827c80920311fa9d1e6989c8a73aaaeca962eb7/test%2Fsequential%2Ftest-inspector.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector.js?ref=0827c80920311fa9d1e6989c8a73aaaeca962eb7",
            "patch": "@@ -69,15 +69,15 @@ async function testBreakpointOnStart(session) {\n   ];\n \n   await session.send(commands);\n-  await session.waitForBreakOnLine(0, session.scriptPath());\n+  await session.waitForBreakOnLine(0, session.scriptURL());\n }\n \n async function testBreakpoint(session) {\n   console.log('[test]', 'Setting a breakpoint and verifying it is hit');\n   const commands = [\n     { 'method': 'Debugger.setBreakpointByUrl',\n       'params': { 'lineNumber': 5,\n-                  'url': session.scriptPath(),\n+                  'url': session.scriptURL(),\n                   'columnNumber': 0,\n                   'condition': ''\n       }\n@@ -92,7 +92,7 @@ async function testBreakpoint(session) {\n          `Script source is wrong: ${scriptSource}`);\n \n   await session.waitForConsoleOutput('log', ['A message', 5]);\n-  const paused = await session.waitForBreakOnLine(5, session.scriptPath());\n+  const paused = await session.waitForBreakOnLine(5, session.scriptURL());\n   const scopeId = paused.params.callFrames[0].scopeChain[0].object.objectId;\n \n   console.log('[test]', 'Verify we can read current application state');"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 90,
        "deletions": 16
    }
}