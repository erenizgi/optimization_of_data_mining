{
    "author": "joyeecheung",
    "message": "src: unify uptime base used across the code base\n\nThis patch joins `per_process::prog_start_time` (a double)\nand `performance::performance_node_start` (a uint64_t) into a\n`per_process::node_start_time` (a uint64_t) which gets initialized\nin `node::Start()`.\n\nPR-URL: https://github.com/nodejs/node/pull/26016\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "fd0a861cdb3088f60ee56a8adef05fd50b71f817",
    "files": [
        {
            "sha": "ce2911251e81aba394ec4a8a4618abdda7d83bff",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -228,9 +228,8 @@ Environment::Environment(IsolateData* isolate_data,\n   performance_state_.reset(new performance::performance_state(isolate()));\n   performance_state_->Mark(\n       performance::NODE_PERFORMANCE_MILESTONE_ENVIRONMENT);\n-  performance_state_->Mark(\n-      performance::NODE_PERFORMANCE_MILESTONE_NODE_START,\n-      performance::performance_node_start);\n+  performance_state_->Mark(performance::NODE_PERFORMANCE_MILESTONE_NODE_START,\n+                           per_process::node_start_time);\n   performance_state_->Mark(\n       performance::NODE_PERFORMANCE_MILESTONE_V8_START,\n       performance::performance_v8_start);"
        },
        {
            "sha": "b3195b73658a7fb95428d7fa8662a14cad795856",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -145,8 +145,8 @@ unsigned int reverted_cve = 0;\n bool v8_initialized = false;\n \n // node_internals.h\n-// process-relative uptime base, initialized at start-up\n-double prog_start_time;\n+// process-relative uptime base in nanoseconds, initialized in node::Start()\n+uint64_t node_start_time;\n // Tells whether --prof is passed.\n bool v8_is_profiling = false;\n \n@@ -611,9 +611,6 @@ int ProcessGlobalArgs(std::vector<std::string>* args,\n int Init(std::vector<std::string>* argv,\n          std::vector<std::string>* exec_argv,\n          std::vector<std::string>* errors) {\n-  // Initialize prog_start_time to get relative uptime.\n-  per_process::prog_start_time = static_cast<double>(uv_now(uv_default_loop()));\n-\n   // Register built-in modules\n   binding::RegisterBuiltinModules();\n \n@@ -891,7 +888,7 @@ inline int Start(uv_loop_t* event_loop,\n int Start(int argc, char** argv) {\n   atexit([] () { uv_tty_reset_mode(); });\n   PlatformInit();\n-  performance::performance_node_start = PERFORMANCE_NOW();\n+  per_process::node_start_time = uv_hrtime();\n \n   CHECK_GT(argc, 0);\n "
        },
        {
            "sha": "367df26c0e74f6c2597bde7b2f8d96e1f9fe1ef4",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -55,7 +55,7 @@ class NativeModuleLoader;\n \n namespace per_process {\n extern Mutex env_var_mutex;\n-extern double prog_start_time;\n+extern uint64_t node_start_time;\n extern bool v8_is_profiling;\n }  // namespace per_process\n "
        },
        {
            "sha": "f63dc6abf0900500fc0aeffb831e665d9df05662",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -46,7 +46,6 @@ using v8::Value;\n const uint64_t timeOrigin = PERFORMANCE_NOW();\n // https://w3c.github.io/hr-time/#dfn-time-origin-timestamp\n const double timeOriginTimestamp = GetCurrentTimeInMicroseconds();\n-uint64_t performance_node_start;\n uint64_t performance_v8_start;\n \n void performance_state::Mark(enum PerformanceMilestone milestone,"
        },
        {
            "sha": "5c972c9841ad503f4bbc56c1c9104f54b6636047",
            "filename": "src/node_perf_common.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_perf_common.h",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_perf_common.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf_common.h?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -18,7 +18,6 @@ namespace performance {\n \n // These occur before the environment is created. Cache them\n // here and add them to the milestones when the env is init'd.\n-extern uint64_t performance_node_start;\n extern uint64_t performance_v8_start;\n \n #define NODE_PERFORMANCE_MILESTONES(V)                                        \\"
        },
        {
            "sha": "dfcc6641a1c5f86699394d9e9436accf39f1d3fb",
            "filename": "src/node_process_methods.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_process_methods.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_process_methods.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process_methods.cc?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -44,6 +44,7 @@ using v8::Isolate;\n using v8::Local;\n using v8::Name;\n using v8::NewStringType;\n+using v8::Number;\n using v8::Object;\n using v8::String;\n using v8::Uint32;\n@@ -58,6 +59,8 @@ Mutex umask_mutex;\n #define MICROS_PER_SEC 1e6\n // used in Hrtime() below\n #define NANOS_PER_SEC 1000000000\n+// Used in Uptime()\n+#define NANOS_PER_MICROS 1e3\n \n #ifdef _WIN32\n /* MAX_PATH is in characters, not bytes. Make sure we have enough headroom. */\n@@ -239,12 +242,12 @@ static void Umask(const FunctionCallbackInfo<Value>& args) {\n \n static void Uptime(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n-  double uptime;\n \n   uv_update_time(env->event_loop());\n-  uptime = uv_now(env->event_loop()) - per_process::prog_start_time;\n-\n-  args.GetReturnValue().Set(uptime / 1000);\n+  double uptime =\n+      static_cast<double>(uv_hrtime() - per_process::node_start_time);\n+  Local<Number> result = Number::New(env->isolate(), uptime / NANOS_PER_MICROS);\n+  args.GetReturnValue().Set(result);\n }\n \n static void GetActiveRequests(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "d4f59de84d8013a579180b0305e029f5a2ca48be",
            "filename": "src/node_report.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_report.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fd0a861cdb3088f60ee56a8adef05fd50b71f817/src%2Fnode_report.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_report.cc?ref=fd0a861cdb3088f60ee56a8adef05fd50b71f817",
            "patch": "@@ -47,6 +47,9 @@\n extern char** environ;\n #endif\n \n+constexpr int NANOS_PER_SEC = 1000 * 1000 * 1000;\n+constexpr double SEC_PER_MICROS = 1e-6;\n+\n namespace report {\n using node::arraysize;\n using node::Environment;\n@@ -489,20 +492,19 @@ static void PrintGCStatistics(JSONWriter* writer, Isolate* isolate) {\n #ifndef _WIN32\n // Report resource usage (Linux/OSX only).\n static void PrintResourceUsage(JSONWriter* writer) {\n-  time_t current_time;  // current time absolute\n-  time(&current_time);\n-  size_t boot_time = static_cast<time_t>(node::per_process::prog_start_time /\n-                                         (1000 * 1000 * 1000));\n-  auto uptime = difftime(current_time, boot_time);\n+  // Get process uptime in seconds\n+  uint64_t uptime =\n+      (uv_hrtime() - node::per_process::node_start_time) / (NANOS_PER_SEC);\n   if (uptime == 0) uptime = 1;  // avoid division by zero.\n \n   // Process and current thread usage statistics\n   struct rusage stats;\n   writer->json_objectstart(\"resourceUsage\");\n   if (getrusage(RUSAGE_SELF, &stats) == 0) {\n-    double user_cpu = stats.ru_utime.tv_sec + 0.000001 * stats.ru_utime.tv_usec;\n+    double user_cpu =\n+        stats.ru_utime.tv_sec + SEC_PER_MICROS * stats.ru_utime.tv_usec;\n     double kernel_cpu =\n-        stats.ru_utime.tv_sec + 0.000001 * stats.ru_utime.tv_usec;\n+        stats.ru_utime.tv_sec + SEC_PER_MICROS * stats.ru_utime.tv_usec;\n     writer->json_keyvalue(\"userCpuSeconds\", user_cpu);\n     writer->json_keyvalue(\"kernelCpuSeconds\", kernel_cpu);\n     double cpu_abs = user_cpu + kernel_cpu;\n@@ -522,9 +524,10 @@ static void PrintResourceUsage(JSONWriter* writer) {\n #ifdef RUSAGE_THREAD\n   if (getrusage(RUSAGE_THREAD, &stats) == 0) {\n     writer->json_objectstart(\"uvthreadResourceUsage\");\n-    double user_cpu = stats.ru_utime.tv_sec + 0.000001 * stats.ru_utime.tv_usec;\n+    double user_cpu =\n+        stats.ru_utime.tv_sec + SEC_PER_MICROS * stats.ru_utime.tv_usec;\n     double kernel_cpu =\n-        stats.ru_utime.tv_sec + 0.000001 * stats.ru_utime.tv_usec;\n+        stats.ru_utime.tv_sec + SEC_PER_MICROS * stats.ru_utime.tv_usec;\n     writer->json_keyvalue(\"userCpuSeconds\", user_cpu);\n     writer->json_keyvalue(\"kernelCpuSeconds\", kernel_cpu);\n     double cpu_abs = user_cpu + kernel_cpu;"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 25,
        "deletions": 25
    }
}