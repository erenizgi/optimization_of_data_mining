{
    "author": "addaleax",
    "message": "src: add helper for before/after scope without JS calls\n\nAdd `AsyncScope` for cases where the async_hooks `before` and\n`after` callbacks should be called, to track async context,\nbut no actual JS is called in between and we can therefore\nskip things like draining the microtask or `nextTick` queues.\n\nPR-URL: https://github.com/nodejs/node/pull/18936\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "f7f1437d44f3e4b745e36540a752065cc58d993b",
    "files": [
        {
            "sha": "c9f12333243092ef10c794ca942a1680aeb70d44",
            "filename": "src/async_wrap-inl.h",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/f7f1437d44f3e4b745e36540a752065cc58d993b/src%2Fasync_wrap-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/f7f1437d44f3e4b745e36540a752065cc58d993b/src%2Fasync_wrap-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap-inl.h?ref=f7f1437d44f3e4b745e36540a752065cc58d993b",
            "patch": "@@ -45,6 +45,22 @@ inline double AsyncWrap::get_trigger_async_id() const {\n }\n \n \n+inline AsyncWrap::AsyncScope::AsyncScope(AsyncWrap* wrap)\n+    : wrap_(wrap) {\n+  Environment* env = wrap->env();\n+  if (env->async_hooks()->fields()[Environment::AsyncHooks::kBefore] == 0)\n+    return;\n+  EmitBefore(env, wrap->get_async_id());\n+}\n+\n+inline AsyncWrap::AsyncScope::~AsyncScope() {\n+  Environment* env = wrap_->env();\n+  if (env->async_hooks()->fields()[Environment::AsyncHooks::kAfter] == 0)\n+    return;\n+  EmitAfter(env, wrap_->get_async_id());\n+}\n+\n+\n inline v8::MaybeLocal<v8::Value> AsyncWrap::MakeCallback(\n     const v8::Local<v8::String> symbol,\n     int argc,"
        },
        {
            "sha": "608764bab5361c3b3c8fc62db3b7ae93aae1c8a8",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/f7f1437d44f3e4b745e36540a752065cc58d993b/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/f7f1437d44f3e4b745e36540a752065cc58d993b/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=f7f1437d44f3e4b745e36540a752065cc58d993b",
            "patch": "@@ -169,6 +169,18 @@ class AsyncWrap : public BaseObject {\n \n   static void WeakCallback(const v8::WeakCallbackInfo<DestroyParam> &info);\n \n+  // This is a simplified version of InternalCallbackScope that only runs\n+  // the `before` and `after` hooks. Only use it when not actually calling\n+  // back into JS; otherwise, use InternalCallbackScope.\n+  class AsyncScope {\n+   public:\n+    explicit inline AsyncScope(AsyncWrap* wrap);\n+    ~AsyncScope();\n+\n+   private:\n+    AsyncWrap* wrap_ = nullptr;\n+  };\n+\n  private:\n   friend class PromiseWrap;\n "
        }
    ],
    "stats": {
        "total": 28,
        "additions": 28,
        "deletions": 0
    }
}