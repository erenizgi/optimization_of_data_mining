{
    "author": "lundibundi",
    "message": "process: fix process.exitCode handling for fatalException\n\n* set process.exitCode before calling 'exit' handlers so that there will\n  not be a situation where process.exitCode !== code in 'exit' callback\n  during uncaughtException handling\n* don't ignore process.exitCode set in 'exit' callback when failed with\n  uncaughtException and there is no uncaughtException listener\n\nPR-URL: https://github.com/nodejs/node/pull/21739\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "35326f27fd9693fcf02a2eab5e22c78b0b702508",
    "files": [
        {
            "sha": "df544e7f0f17b99e9bb569b10023c5b2572cfa24",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -151,9 +151,13 @@ added: v0.1.18\n \n The `'uncaughtException'` event is emitted when an uncaught JavaScript\n exception bubbles all the way back to the event loop. By default, Node.js\n-handles such exceptions by printing the stack trace to `stderr` and exiting.\n+handles such exceptions by printing the stack trace to `stderr` and exiting\n+with code 1, overriding any previously set [`process.exitCode`][].\n Adding a handler for the `'uncaughtException'` event overrides this default\n-behavior.\n+behavior. You may also change the [`process.exitCode`][] in\n+`'uncaughtException'` handler which will result in process exiting with\n+provided exit code, otherwise in the presence of such handler the process will\n+exit with 0.\n \n The listener function is called with the `Error` object passed as the only\n argument."
        },
        {
            "sha": "016c0c5e2304bc8c7736072072015d6c4f0be532",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -475,6 +475,7 @@\n         try {\n           if (!process._exiting) {\n             process._exiting = true;\n+            process.exitCode = 1;\n             process.emit('exit', 1);\n           }\n         } catch {"
        },
        {
            "sha": "bcc864b5b8b33006509d8a0831de0509be52c163",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -454,9 +454,6 @@ function setupChild(evalScript) {\n     debug(`[${threadId}] fatal exception caught = ${caught}`);\n \n     if (!caught) {\n-      // set correct code (uncaughtException) for [kOnExit](code) handler\n-      process.exitCode = 1;\n-\n       let serialized;\n       try {\n         serialized = serializeError(error);"
        },
        {
            "sha": "4c1ee8f18a2dc2cff72caed2081bc45f91f542f5",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -1439,7 +1439,16 @@ void FatalException(Isolate* isolate,\n       exit(7);\n     } else if (caught->IsFalse()) {\n       ReportException(env, error, message);\n-      exit(1);\n+\n+      // fatal_exception_function call before may have set a new exit code ->\n+      // read it again, otherwise use default for uncaughtException 1\n+      Local<String> exit_code = env->exit_code_string();\n+      Local<Value> code;\n+      if (!process_object->Get(env->context(), exit_code).ToLocal(&code) ||\n+          !code->IsInt32()) {\n+        exit(1);\n+      }\n+      exit(code.As<v8::Int32>()->Value());\n     }\n   }\n }"
        },
        {
            "sha": "20004a9d7d6f5818922a8696c1dc16be5b6fae9c",
            "filename": "test/parallel/test-process-exit-code.js",
            "status": "modified",
            "additions": 55,
            "deletions": 1,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-process-exit-code.js",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-process-exit-code.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-exit-code.js?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -34,6 +34,14 @@ switch (process.argv[2]) {\n     return child4();\n   case 'child5':\n     return child5();\n+  case 'child6':\n+    return child6();\n+  case 'child7':\n+    return child7();\n+  case 'child8':\n+    return child8();\n+  case 'child9':\n+    return child9();\n   case undefined:\n     return parent();\n   default:\n@@ -43,13 +51,15 @@ switch (process.argv[2]) {\n function child1() {\n   process.exitCode = 42;\n   process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 42);\n     assert.strictEqual(code, 42);\n   });\n }\n \n function child2() {\n   process.exitCode = 99;\n   process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 42);\n     assert.strictEqual(code, 42);\n   });\n   process.exit(42);\n@@ -58,6 +68,7 @@ function child2() {\n function child3() {\n   process.exitCode = 99;\n   process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 0);\n     assert.strictEqual(code, 0);\n   });\n   process.exit(0);\n@@ -66,7 +77,7 @@ function child3() {\n function child4() {\n   process.exitCode = 99;\n   process.on('exit', function(code) {\n-    if (code !== 1) {\n+    if (code !== 1 || process.exitCode !== 1) {\n       console.log('wrong code! expected 1 for uncaughtException');\n       process.exit(99);\n     }\n@@ -77,11 +88,50 @@ function child4() {\n function child5() {\n   process.exitCode = 95;\n   process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 95);\n     assert.strictEqual(code, 95);\n     process.exitCode = 99;\n   });\n }\n \n+function child6() {\n+  process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 0);\n+    assert.strictEqual(code, 0);\n+  });\n+  process.on('uncaughtException', () => {});\n+  throw new Error('ok');\n+}\n+\n+function child7() {\n+  process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 97);\n+    assert.strictEqual(code, 97);\n+  });\n+  process.on('uncaughtException', () => {\n+    process.exitCode = 97;\n+  });\n+  throw new Error('ok');\n+}\n+\n+function child8() {\n+  process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 98;\n+  });\n+  throw new Error('ok');\n+}\n+\n+function child9() {\n+  process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 0;\n+  });\n+  throw new Error('ok');\n+}\n+\n function parent() {\n   const { spawn } = require('child_process');\n   const node = process.execPath;\n@@ -102,4 +152,8 @@ function parent() {\n   test('child3', 0);\n   test('child4', 1);\n   test('child5', 99);\n+  test('child6', 0);\n+  test('child7', 97);\n+  test('child8', 98);\n+  test('child9', 0);\n }"
        },
        {
            "sha": "0a1e9bb95370ebf90bd8ad2c8ce53afe123c5dcc",
            "filename": "test/parallel/test-worker-exit-code.js",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-worker-exit-code.js",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-worker-exit-code.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-exit-code.js?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -35,6 +35,10 @@ if (!process.env.HAS_STARTED_WORKER) {\n         return child6();\n       case 'child7':\n         return child7();\n+      case 'child8':\n+        return child8();\n+      case 'child9':\n+        return child9();\n       default:\n         throw new Error('invalid');\n     }\n@@ -105,6 +109,24 @@ function child7() {\n   throw new Error('ok');\n }\n \n+function child8() {\n+  process.on('exit', (code) => {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 98;\n+  });\n+  throw new Error('ok');\n+}\n+\n+function child9() {\n+  process.on('exit', function(code) {\n+    assert.strictEqual(process.exitCode, 1);\n+    assert.strictEqual(code, 1);\n+    process.exitCode = 0;\n+  });\n+  throw new Error('ok');\n+}\n+\n function parent() {\n   const test = (arg, exit, error = null) => {\n     const w = new Worker(__filename);\n@@ -116,7 +138,9 @@ function parent() {\n     }));\n     if (error) {\n       w.on('error', common.mustCall((err) => {\n-        assert(error.test(err));\n+        console.log(err);\n+        assert(error.test(err),\n+               `wrong error for ${arg}\\nexpected:${error} but got:${err}`);\n       }));\n     }\n     w.postMessage(arg);\n@@ -129,4 +153,6 @@ function parent() {\n   test('child5', 99);\n   test('child6', 0);\n   test('child7', 97);\n+  test('child8', 98, /^Error: ok$/);\n+  test('child9', 0, /^Error: ok$/);\n }"
        },
        {
            "sha": "8193dccbd1ff2fda8240dc1c8577734844d1876f",
            "filename": "test/parallel/test-worker-uncaught-exception.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/35326f27fd9693fcf02a2eab5e22c78b0b702508/test%2Fparallel%2Ftest-worker-uncaught-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-uncaught-exception.js?ref=35326f27fd9693fcf02a2eab5e22c78b0b702508",
            "patch": "@@ -10,12 +10,22 @@ if (!process.env.HAS_STARTED_WORKER) {\n   const w = new Worker(__filename);\n   w.on('message', common.mustNotCall());\n   w.on('error', common.mustCall((err) => {\n+    console.log(err.message);\n     assert(/^Error: foo$/.test(err));\n   }));\n   w.on('exit', common.mustCall((code) => {\n     // uncaughtException is code 1\n     assert.strictEqual(code, 1);\n   }));\n } else {\n+  // cannot use common.mustCall as it cannot catch this\n+  let called = false;\n+  process.on('exit', (code) => {\n+    if (!called) {\n+      called = true;\n+    } else {\n+      assert.fail('Exit callback called twice in worker');\n+    }\n+  });\n   throw new Error('foo');\n }"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 109,
        "deletions": 8
    }
}