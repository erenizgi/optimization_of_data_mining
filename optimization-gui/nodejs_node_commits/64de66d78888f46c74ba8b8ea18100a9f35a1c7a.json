{
    "author": "unknown",
    "message": "net: emit 'close' when socket ends before connect\n\nDon't set `writable` to true when a socket connects if the socket is\nalready in an ending state.\n\nIn the existing code, afterConnect always set `writable` to true.  This\nhas been the case for a long time, but previous to commit\n9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4, the socket would still be\ndestroyed by `destroySoon` and emit a `'close'` event. Since that\ncommit removed this masking behavior, we have relied on maybeDestroy to\ndestroy the socket when the readble state is ended, and that won't\nhappen if `writable` is set to true.\n\nIf the socket has `allowHalfOpen` set to true, then `destroy` will still\nnot be called and `'close'` will not be emitted.\n\nPR-URL: https://github.com/nodejs/node/pull/21290\nFixes: https://github.com/nodejs/node/issues/21268\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "64de66d78888f46c74ba8b8ea18100a9f35a1c7a",
    "files": [
        {
            "sha": "0f80b4189718bad33766e4c116b533c808a8643a",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/64de66d78888f46c74ba8b8ea18100a9f35a1c7a/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/64de66d78888f46c74ba8b8ea18100a9f35a1c7a/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=64de66d78888f46c74ba8b8ea18100a9f35a1c7a",
            "patch": "@@ -1138,7 +1138,8 @@ function afterConnect(status, handle, req, readable, writable) {\n \n   if (status === 0) {\n     self.readable = readable;\n-    self.writable = writable;\n+    if (!self._writableState.ended)\n+      self.writable = writable;\n     self._unrefTimer();\n \n     self.emit('connect');"
        },
        {
            "sha": "d40c90620e4153924cbd7093609d969afdea9439",
            "filename": "test/parallel/test-net-socket-end-before-connect.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/64de66d78888f46c74ba8b8ea18100a9f35a1c7a/test%2Fparallel%2Ftest-net-socket-end-before-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/64de66d78888f46c74ba8b8ea18100a9f35a1c7a/test%2Fparallel%2Ftest-net-socket-end-before-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-socket-end-before-connect.js?ref=64de66d78888f46c74ba8b8ea18100a9f35a1c7a",
            "patch": "@@ -0,0 +1,13 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+const net = require('net');\n+\n+const server = net.createServer();\n+\n+server.listen(common.mustCall(() => {\n+  const socket = net.createConnection(server.address().port);\n+  socket.on('close', common.mustCall(() => server.close()));\n+  socket.end();\n+}));"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 15,
        "deletions": 1
    }
}