{
    "author": "joyeecheung",
    "message": "process: move POSIX credential accessors into node_credentials.cc\n\nExpose the POSIX credential accessors through\n`internalBinding('credentials')` instead of setting them on the\nprocess or bootstrapper object from C++ directly. Also moves\n`SafeGetEnv` from `internalBinding('util')` to\n`internalBinding('credentials')` since it's closely related to\nthe credentials.\n\nIn the JS land, instead of wrapping the bindings then writing\nto the process object directly in main_thread_only.js, return\nthe wrapped functions back to bootstrap/node.js where they get\nwritten to the process object conditionally for clarity.\n\nRefs: https://github.com/nodejs/node/issues/24961\n\nPR-URL: https://github.com/nodejs/node/pull/25066\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "321e296371383fd63131d21c1121e22163ddeb86",
    "files": [
        {
            "sha": "33d79689d0993f3064fe7b373c876cebdecdb4fa",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -23,8 +23,7 @@ const {\n   _setupPromises, _chdir, _cpuUsage,\n   _hrtime, _hrtimeBigInt,\n   _memoryUsage, _rawDebug,\n-  _umask, _initgroups, _setegid, _seteuid,\n-  _setgid, _setuid, _setgroups,\n+  _umask,\n   _shouldAbortOnUncaughtToggle\n } = bootstrappers;\n const { internalBinding, NativeModule } = loaderExports;\n@@ -72,13 +71,28 @@ function startup() {\n   NativeModule.require('internal/process/warning').setup();\n   NativeModule.require('internal/process/next_tick').setup(_setupNextTick,\n                                                            _setupPromises);\n+  const credentials = internalBinding('credentials');\n+  if (credentials.implementsPosixCredentials) {\n+    process.getuid = credentials.getuid;\n+    process.geteuid = credentials.geteuid;\n+    process.getgid = credentials.getgid;\n+    process.getegid = credentials.getegid;\n+    process.getgroups = credentials.getgroups;\n+\n+    if (isMainThread) {\n+      const wrapped = mainThreadSetup.wrapPosixCredentialSetters(credentials);\n+      process.initgroups = wrapped.initgroups;\n+      process.setgroups = wrapped.setgroups;\n+      process.setegid = wrapped.setegid;\n+      process.seteuid = wrapped.seteuid;\n+      process.setgid = wrapped.setgid;\n+      process.setuid = wrapped.setuid;\n+    }\n+  }\n \n   if (isMainThread) {\n     mainThreadSetup.setupStdio();\n-    mainThreadSetup.setupProcessMethods(\n-      _chdir, _umask, _initgroups, _setegid, _seteuid,\n-      _setgid, _setuid, _setgroups\n-    );\n+    mainThreadSetup.setupProcessMethods(_chdir, _umask);\n   } else {\n     workerThreadSetup.setupStdio();\n   }"
        },
        {
            "sha": "bf6a9d4029c2a517dec940af2a620ecd8f03373f",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -34,7 +34,7 @@ const {\n   internalModuleReadJSON,\n   internalModuleStat\n } = internalBinding('fs');\n-const { safeGetenv } = internalBinding('util');\n+const { safeGetenv } = internalBinding('credentials');\n const {\n   makeRequireFunction,\n   requireDepth,"
        },
        {
            "sha": "5f53f3408406b906ad37078c2805bc0af94ac944",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 35,
            "deletions": 38,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -29,13 +29,7 @@ function setupStdio() {\n \n // Non-POSIX platforms like Windows don't have certain methods.\n // Workers also lack these methods since they change process-global state.\n-function setupProcessMethods(_chdir, _umask, _initgroups, _setegid,\n-                             _seteuid, _setgid, _setuid, _setgroups) {\n-  if (_setgid !== undefined) {\n-    setupPosixMethods(_initgroups, _setegid, _seteuid,\n-                      _setgid, _setuid, _setgroups);\n-  }\n-\n+function setupProcessMethods(_chdir, _umask) {\n   process.chdir = function chdir(directory) {\n     validateString(directory, 'directory');\n     return _chdir(directory);\n@@ -51,10 +45,17 @@ function setupProcessMethods(_chdir, _umask, _initgroups, _setegid,\n   };\n }\n \n-function setupPosixMethods(_initgroups, _setegid, _seteuid,\n-                           _setgid, _setuid, _setgroups) {\n-\n-  process.initgroups = function initgroups(user, extraGroup) {\n+function wrapPosixCredentialSetters(credentials) {\n+  const {\n+    initgroups: _initgroups,\n+    setgroups: _setgroups,\n+    setegid: _setegid,\n+    seteuid: _seteuid,\n+    setgid: _setgid,\n+    setuid: _setuid\n+  } = credentials;\n+\n+  function initgroups(user, extraGroup) {\n     validateId(user, 'user');\n     validateId(extraGroup, 'extraGroup');\n     // Result is 0 on success, 1 if user is unknown, 2 if group is unknown.\n@@ -64,25 +65,9 @@ function setupPosixMethods(_initgroups, _setegid, _seteuid,\n     } else if (result === 2) {\n       throw new ERR_UNKNOWN_CREDENTIAL('Group', extraGroup);\n     }\n-  };\n-\n-  process.setegid = function setegid(id) {\n-    return execId(id, 'Group', _setegid);\n-  };\n-\n-  process.seteuid = function seteuid(id) {\n-    return execId(id, 'User', _seteuid);\n-  };\n-\n-  process.setgid = function setgid(id) {\n-    return execId(id, 'Group', _setgid);\n-  };\n-\n-  process.setuid = function setuid(id) {\n-    return execId(id, 'User', _setuid);\n-  };\n+  }\n \n-  process.setgroups = function setgroups(groups) {\n+  function setgroups(groups) {\n     if (!Array.isArray(groups)) {\n       throw new ERR_INVALID_ARG_TYPE('groups', 'Array', groups);\n     }\n@@ -95,15 +80,17 @@ function setupPosixMethods(_initgroups, _setegid, _seteuid,\n     if (result > 0) {\n       throw new ERR_UNKNOWN_CREDENTIAL('Group', groups[result - 1]);\n     }\n-  };\n+  }\n \n-  function execId(id, type, method) {\n-    validateId(id, 'id');\n-    // Result is 0 on success, 1 if credential is unknown.\n-    const result = method(id);\n-    if (result === 1) {\n-      throw new ERR_UNKNOWN_CREDENTIAL(type, id);\n-    }\n+  function wrapIdSetter(type, method) {\n+    return function(id) {\n+      validateId(id, 'id');\n+      // Result is 0 on success, 1 if credential is unknown.\n+      const result = method(id);\n+      if (result === 1) {\n+        throw new ERR_UNKNOWN_CREDENTIAL(type, id);\n+      }\n+    };\n   }\n \n   function validateId(id, name) {\n@@ -113,6 +100,15 @@ function setupPosixMethods(_initgroups, _setegid, _seteuid,\n       throw new ERR_INVALID_ARG_TYPE(name, ['number', 'string'], id);\n     }\n   }\n+\n+  return {\n+    initgroups,\n+    setgroups,\n+    setegid: wrapIdSetter('Group', _setegid),\n+    seteuid: wrapIdSetter('User', _seteuid),\n+    setgid: wrapIdSetter('Group', _setgid),\n+    setuid: wrapIdSetter('User', _setuid)\n+  };\n }\n \n // Worker threads don't receive signals.\n@@ -181,5 +177,6 @@ module.exports = {\n   setupStdio,\n   setupProcessMethods,\n   setupSignalHandlers,\n-  setupChildProcessIpcChannel\n+  setupChildProcessIpcChannel,\n+  wrapPosixCredentialSetters\n };"
        },
        {
            "sha": "28e1d7797f65dc6efe3dd793c931db28728a4d55",
            "filename": "lib/os.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/lib%2Fos.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/lib%2Fos.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fos.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -21,7 +21,7 @@\n \n 'use strict';\n \n-const { safeGetenv } = internalBinding('util');\n+const { safeGetenv } = internalBinding('credentials');\n const constants = internalBinding('constants').os;\n const { deprecate } = require('internal/util');\n const isWindows = process.platform === 'win32';"
        },
        {
            "sha": "b337de0a422be61644d3f43fee66da42ff7b6909",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -350,6 +350,7 @@\n         'src/node_config.cc',\n         'src/node_constants.cc',\n         'src/node_contextify.cc',\n+        'src/node_credentials.cc',\n         'src/node_domain.cc',\n         'src/node_encoding.cc',\n         'src/node_env_var.cc',"
        },
        {
            "sha": "0a1cfed2109e5ca81ea068fd9c476e0257349f1e",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -147,17 +147,6 @@ void SetupBootstrapObject(Environment* env,\n   BOOTSTRAP_METHOD(_rawDebug, RawDebug);\n   BOOTSTRAP_METHOD(_umask, Umask);\n \n-#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-  if (env->is_main_thread()) {\n-    BOOTSTRAP_METHOD(_initgroups, InitGroups);\n-    BOOTSTRAP_METHOD(_setegid, SetEGid);\n-    BOOTSTRAP_METHOD(_seteuid, SetEUid);\n-    BOOTSTRAP_METHOD(_setgid, SetGid);\n-    BOOTSTRAP_METHOD(_setuid, SetUid);\n-    BOOTSTRAP_METHOD(_setgroups, SetGroups);\n-  }\n-#endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n-\n   Local<String> should_abort_on_uncaught_toggle =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"_shouldAbortOnUncaughtToggle\");\n   CHECK(bootstrapper->Set(env->context(),"
        },
        {
            "sha": "1e65dfdac88ae23e9b12411fa548c2b2a078fb1e",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -225,7 +225,7 @@ Environment::Environment(IsolateData* isolate_data,\n   should_abort_on_uncaught_toggle_[0] = 1;\n \n   std::string debug_cats;\n-  SafeGetenv(\"NODE_DEBUG_NATIVE\", &debug_cats);\n+  credentials::SafeGetenv(\"NODE_DEBUG_NATIVE\", &debug_cats);\n   set_debug_categories(debug_cats, true);\n \n   isolate()->GetHeapProfiler()->AddBuildEmbedderGraphCallback("
        },
        {
            "sha": "58722f23b31253e65d52a0634fb841932ecca4c3",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 46,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -100,12 +100,7 @@ typedef int mode_t;\n #else\n #include <pthread.h>\n #include <sys/resource.h>  // getrlimit, setrlimit\n-#include <unistd.h>  // setuid, getuid\n-#endif\n-\n-#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-#include <pwd.h>  // getpwnam()\n-#include <grp.h>  // getgrnam()\n+#include <unistd.h>        // STDIN_FILENO, STDERR_FILENO\n #endif\n \n namespace node {\n@@ -153,8 +148,6 @@ unsigned int reverted = 0;\n \n bool v8_initialized = false;\n \n-bool linux_at_secure = false;\n-\n // process-relative uptime base, initialized at start-up\n double prog_start_time;\n \n@@ -501,27 +494,6 @@ const char* signo_string(int signo) {\n   }\n }\n \n-// Look up environment variable unless running as setuid root.\n-bool SafeGetenv(const char* key, std::string* text) {\n-#if !defined(__CloudABI__) && !defined(_WIN32)\n-  if (linux_at_secure || getuid() != geteuid() || getgid() != getegid())\n-    goto fail;\n-#endif\n-\n-  {\n-    Mutex::ScopedLock lock(environ_mutex);\n-    if (const char* value = getenv(key)) {\n-      *text = value;\n-      return true;\n-    }\n-  }\n-\n-fail:\n-  text->clear();\n-  return false;\n-}\n-\n-\n void* ArrayBufferAllocator::Allocate(size_t size) {\n   if (zero_fill_field_ || per_process_opts->zero_fill_all_buffers)\n     return UncheckedCalloc(size);\n@@ -1157,14 +1129,6 @@ void SetupProcessObject(Environment* env,\n   env->SetMethod(process, \"dlopen\", binding::DLOpen);\n   env->SetMethod(process, \"reallyExit\", Exit);\n   env->SetMethodNoSideEffect(process, \"uptime\", Uptime);\n-\n-#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-  env->SetMethodNoSideEffect(process, \"getuid\", GetUid);\n-  env->SetMethodNoSideEffect(process, \"geteuid\", GetEUid);\n-  env->SetMethodNoSideEffect(process, \"getgid\", GetGid);\n-  env->SetMethodNoSideEffect(process, \"getegid\", GetEGid);\n-  env->SetMethodNoSideEffect(process, \"getgroups\", GetGroups);\n-#endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n }\n \n \n@@ -1625,37 +1589,40 @@ void Init(std::vector<std::string>* argv,\n   {\n     std::string text;\n     default_env_options->pending_deprecation =\n-        SafeGetenv(\"NODE_PENDING_DEPRECATION\", &text) && text[0] == '1';\n+        credentials::SafeGetenv(\"NODE_PENDING_DEPRECATION\", &text) &&\n+        text[0] == '1';\n   }\n \n   // Allow for environment set preserving symlinks.\n   {\n     std::string text;\n     default_env_options->preserve_symlinks =\n-        SafeGetenv(\"NODE_PRESERVE_SYMLINKS\", &text) && text[0] == '1';\n+        credentials::SafeGetenv(\"NODE_PRESERVE_SYMLINKS\", &text) &&\n+        text[0] == '1';\n   }\n \n   {\n     std::string text;\n     default_env_options->preserve_symlinks_main =\n-        SafeGetenv(\"NODE_PRESERVE_SYMLINKS_MAIN\", &text) && text[0] == '1';\n+        credentials::SafeGetenv(\"NODE_PRESERVE_SYMLINKS_MAIN\", &text) &&\n+        text[0] == '1';\n   }\n \n   if (default_env_options->redirect_warnings.empty()) {\n-    SafeGetenv(\"NODE_REDIRECT_WARNINGS\",\n-               &default_env_options->redirect_warnings);\n+    credentials::SafeGetenv(\"NODE_REDIRECT_WARNINGS\",\n+                            &default_env_options->redirect_warnings);\n   }\n \n #if HAVE_OPENSSL\n   std::string* openssl_config = &per_process_opts->openssl_config;\n   if (openssl_config->empty()) {\n-    SafeGetenv(\"OPENSSL_CONF\", openssl_config);\n+    credentials::SafeGetenv(\"OPENSSL_CONF\", openssl_config);\n   }\n #endif\n \n #if !defined(NODE_WITHOUT_NODE_OPTIONS)\n   std::string node_options;\n-  if (SafeGetenv(\"NODE_OPTIONS\", &node_options)) {\n+  if (credentials::SafeGetenv(\"NODE_OPTIONS\", &node_options)) {\n     std::vector<std::string> env_argv;\n     // [0] is expected to be the program name, fill it in from the real argv.\n     env_argv.push_back(argv->at(0));\n@@ -1687,7 +1654,7 @@ void Init(std::vector<std::string>* argv,\n #if defined(NODE_HAVE_I18N_SUPPORT)\n   // If the parameter isn't given, use the env variable.\n   if (per_process_opts->icu_data_dir.empty())\n-    SafeGetenv(\"NODE_ICU_DATA\", &per_process_opts->icu_data_dir);\n+    credentials::SafeGetenv(\"NODE_ICU_DATA\", &per_process_opts->icu_data_dir);\n   // Initialize ICU.\n   // If icu_data_dir is empty here, it will load the 'minimal' data.\n   if (!i18n::InitializeICUDirectory(per_process_opts->icu_data_dir)) {\n@@ -2095,7 +2062,7 @@ int Start(int argc, char** argv) {\n #if HAVE_OPENSSL\n   {\n     std::string extra_ca_certs;\n-    if (SafeGetenv(\"NODE_EXTRA_CA_CERTS\", &extra_ca_certs))\n+    if (credentials::SafeGetenv(\"NODE_EXTRA_CA_CERTS\", &extra_ca_certs))\n       crypto::UseExtraCaCerts(extra_ca_certs);\n   }\n #ifdef NODE_FIPS_MODE"
        },
        {
            "sha": "1e78f7c17f7db3006b4e042ed8f74f44bc31765b",
            "filename": "src/node_binding.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_binding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_binding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_binding.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -30,6 +30,7 @@\n   V(cares_wrap)                                                                \\\n   V(config)                                                                    \\\n   V(contextify)                                                                \\\n+  V(credentials)                                                               \\\n   V(domain)                                                                    \\\n   V(fs)                                                                        \\\n   V(fs_event_wrap)                                                             \\"
        },
        {
            "sha": "0f202dfb753bf75e8d1e00c4f445b072c9824d88",
            "filename": "src/node_credentials.cc",
            "status": "added",
            "additions": 395,
            "deletions": 0,
            "changes": 395,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_credentials.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_credentials.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_credentials.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -0,0 +1,395 @@\n+#include \"node_internals.h\"\n+\n+#ifdef NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+#include <grp.h>  // getgrnam()\n+#include <pwd.h>  // getpwnam()\n+#endif            // NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+\n+#if !defined(_MSC_VER)\n+#include <unistd.h>  // setuid, getuid\n+#endif\n+\n+namespace node {\n+\n+using v8::Array;\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::Integer;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::Object;\n+using v8::String;\n+using v8::Uint32;\n+using v8::Value;\n+\n+namespace per_process {\n+bool linux_at_secure = false;\n+}  // namespace per_process\n+\n+namespace credentials {\n+\n+// Look up environment variable unless running as setuid root.\n+bool SafeGetenv(const char* key, std::string* text) {\n+#if !defined(__CloudABI__) && !defined(_WIN32)\n+  if (per_process::linux_at_secure || getuid() != geteuid() ||\n+      getgid() != getegid())\n+    goto fail;\n+#endif\n+\n+  {\n+    Mutex::ScopedLock lock(environ_mutex);\n+    if (const char* value = getenv(key)) {\n+      *text = value;\n+      return true;\n+    }\n+  }\n+\n+fail:\n+  text->clear();\n+  return false;\n+}\n+\n+static void SafeGetenv(const FunctionCallbackInfo<Value>& args) {\n+  CHECK(args[0]->IsString());\n+  Isolate* isolate = args.GetIsolate();\n+  Utf8Value strenvtag(isolate, args[0]);\n+  std::string text;\n+  if (!SafeGetenv(*strenvtag, &text)) return;\n+  Local<Value> result =\n+      ToV8Value(isolate->GetCurrentContext(), text).ToLocalChecked();\n+  args.GetReturnValue().Set(result);\n+}\n+\n+#ifdef NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+\n+static const uid_t uid_not_found = static_cast<uid_t>(-1);\n+static const gid_t gid_not_found = static_cast<gid_t>(-1);\n+\n+static uid_t uid_by_name(const char* name) {\n+  struct passwd pwd;\n+  struct passwd* pp;\n+  char buf[8192];\n+\n+  errno = 0;\n+  pp = nullptr;\n+\n+  if (getpwnam_r(name, &pwd, buf, sizeof(buf), &pp) == 0 && pp != nullptr)\n+    return pp->pw_uid;\n+\n+  return uid_not_found;\n+}\n+\n+static char* name_by_uid(uid_t uid) {\n+  struct passwd pwd;\n+  struct passwd* pp;\n+  char buf[8192];\n+  int rc;\n+\n+  errno = 0;\n+  pp = nullptr;\n+\n+  if ((rc = getpwuid_r(uid, &pwd, buf, sizeof(buf), &pp)) == 0 &&\n+      pp != nullptr) {\n+    return strdup(pp->pw_name);\n+  }\n+\n+  if (rc == 0) errno = ENOENT;\n+\n+  return nullptr;\n+}\n+\n+static gid_t gid_by_name(const char* name) {\n+  struct group pwd;\n+  struct group* pp;\n+  char buf[8192];\n+\n+  errno = 0;\n+  pp = nullptr;\n+\n+  if (getgrnam_r(name, &pwd, buf, sizeof(buf), &pp) == 0 && pp != nullptr)\n+    return pp->gr_gid;\n+\n+  return gid_not_found;\n+}\n+\n+#if 0  // For future use.\n+static const char* name_by_gid(gid_t gid) {\n+  struct group pwd;\n+  struct group* pp;\n+  char buf[8192];\n+  int rc;\n+\n+  errno = 0;\n+  pp = nullptr;\n+\n+  if ((rc = getgrgid_r(gid, &pwd, buf, sizeof(buf), &pp)) == 0 &&\n+      pp != nullptr) {\n+    return strdup(pp->gr_name);\n+  }\n+\n+  if (rc == 0)\n+    errno = ENOENT;\n+\n+  return nullptr;\n+}\n+#endif\n+\n+static uid_t uid_by_name(Isolate* isolate, Local<Value> value) {\n+  if (value->IsUint32()) {\n+    return static_cast<uid_t>(value.As<Uint32>()->Value());\n+  } else {\n+    Utf8Value name(isolate, value);\n+    return uid_by_name(*name);\n+  }\n+}\n+\n+static gid_t gid_by_name(Isolate* isolate, Local<Value> value) {\n+  if (value->IsUint32()) {\n+    return static_cast<gid_t>(value.As<Uint32>()->Value());\n+  } else {\n+    Utf8Value name(isolate, value);\n+    return gid_by_name(*name);\n+  }\n+}\n+\n+static void GetUid(const FunctionCallbackInfo<Value>& args) {\n+  // uid_t is an uint32_t on all supported platforms.\n+  args.GetReturnValue().Set(static_cast<uint32_t>(getuid()));\n+}\n+\n+static void GetGid(const FunctionCallbackInfo<Value>& args) {\n+  // gid_t is an uint32_t on all supported platforms.\n+  args.GetReturnValue().Set(static_cast<uint32_t>(getgid()));\n+}\n+\n+static void GetEUid(const FunctionCallbackInfo<Value>& args) {\n+  // uid_t is an uint32_t on all supported platforms.\n+  args.GetReturnValue().Set(static_cast<uint32_t>(geteuid()));\n+}\n+\n+static void GetEGid(const FunctionCallbackInfo<Value>& args) {\n+  // gid_t is an uint32_t on all supported platforms.\n+  args.GetReturnValue().Set(static_cast<uint32_t>(getegid()));\n+}\n+\n+static void SetGid(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(env->is_main_thread());\n+\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsUint32() || args[0]->IsString());\n+\n+  gid_t gid = gid_by_name(env->isolate(), args[0]);\n+\n+  if (gid == gid_not_found) {\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    args.GetReturnValue().Set(1);\n+  } else if (setgid(gid)) {\n+    env->ThrowErrnoException(errno, \"setgid\");\n+  } else {\n+    args.GetReturnValue().Set(0);\n+  }\n+}\n+\n+static void SetEGid(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(env->is_main_thread());\n+\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsUint32() || args[0]->IsString());\n+\n+  gid_t gid = gid_by_name(env->isolate(), args[0]);\n+\n+  if (gid == gid_not_found) {\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    args.GetReturnValue().Set(1);\n+  } else if (setegid(gid)) {\n+    env->ThrowErrnoException(errno, \"setegid\");\n+  } else {\n+    args.GetReturnValue().Set(0);\n+  }\n+}\n+\n+static void SetUid(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(env->is_main_thread());\n+\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsUint32() || args[0]->IsString());\n+\n+  uid_t uid = uid_by_name(env->isolate(), args[0]);\n+\n+  if (uid == uid_not_found) {\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    args.GetReturnValue().Set(1);\n+  } else if (setuid(uid)) {\n+    env->ThrowErrnoException(errno, \"setuid\");\n+  } else {\n+    args.GetReturnValue().Set(0);\n+  }\n+}\n+\n+static void SetEUid(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(env->is_main_thread());\n+\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsUint32() || args[0]->IsString());\n+\n+  uid_t uid = uid_by_name(env->isolate(), args[0]);\n+\n+  if (uid == uid_not_found) {\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    args.GetReturnValue().Set(1);\n+  } else if (seteuid(uid)) {\n+    env->ThrowErrnoException(errno, \"seteuid\");\n+  } else {\n+    args.GetReturnValue().Set(0);\n+  }\n+}\n+\n+static void GetGroups(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  int ngroups = getgroups(0, nullptr);\n+\n+  if (ngroups == -1) return env->ThrowErrnoException(errno, \"getgroups\");\n+\n+  gid_t* groups = new gid_t[ngroups];\n+\n+  ngroups = getgroups(ngroups, groups);\n+\n+  if (ngroups == -1) {\n+    delete[] groups;\n+    return env->ThrowErrnoException(errno, \"getgroups\");\n+  }\n+\n+  Local<Array> groups_list = Array::New(env->isolate(), ngroups);\n+  bool seen_egid = false;\n+  gid_t egid = getegid();\n+\n+  for (int i = 0; i < ngroups; i++) {\n+    groups_list->Set(env->context(), i, Integer::New(env->isolate(), groups[i]))\n+        .FromJust();\n+    if (groups[i] == egid) seen_egid = true;\n+  }\n+\n+  delete[] groups;\n+\n+  if (seen_egid == false)\n+    groups_list\n+        ->Set(env->context(), ngroups, Integer::New(env->isolate(), egid))\n+        .FromJust();\n+\n+  args.GetReturnValue().Set(groups_list);\n+}\n+\n+static void SetGroups(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK_EQ(args.Length(), 1);\n+  CHECK(args[0]->IsArray());\n+\n+  Local<Array> groups_list = args[0].As<Array>();\n+  size_t size = groups_list->Length();\n+  gid_t* groups = new gid_t[size];\n+\n+  for (size_t i = 0; i < size; i++) {\n+    gid_t gid = gid_by_name(\n+        env->isolate(), groups_list->Get(env->context(), i).ToLocalChecked());\n+\n+    if (gid == gid_not_found) {\n+      delete[] groups;\n+      // Tells JS to throw ERR_INVALID_CREDENTIAL\n+      args.GetReturnValue().Set(static_cast<uint32_t>(i + 1));\n+      return;\n+    }\n+\n+    groups[i] = gid;\n+  }\n+\n+  int rc = setgroups(size, groups);\n+  delete[] groups;\n+\n+  if (rc == -1) return env->ThrowErrnoException(errno, \"setgroups\");\n+\n+  args.GetReturnValue().Set(0);\n+}\n+\n+static void InitGroups(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK_EQ(args.Length(), 2);\n+  CHECK(args[0]->IsUint32() || args[0]->IsString());\n+  CHECK(args[1]->IsUint32() || args[1]->IsString());\n+\n+  Utf8Value arg0(env->isolate(), args[0]);\n+  gid_t extra_group;\n+  bool must_free;\n+  char* user;\n+\n+  if (args[0]->IsUint32()) {\n+    user = name_by_uid(args[0].As<Uint32>()->Value());\n+    must_free = true;\n+  } else {\n+    user = *arg0;\n+    must_free = false;\n+  }\n+\n+  if (user == nullptr) {\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    return args.GetReturnValue().Set(1);\n+  }\n+\n+  extra_group = gid_by_name(env->isolate(), args[1]);\n+\n+  if (extra_group == gid_not_found) {\n+    if (must_free) free(user);\n+    // Tells JS to throw ERR_INVALID_CREDENTIAL\n+    return args.GetReturnValue().Set(2);\n+  }\n+\n+  int rc = initgroups(user, extra_group);\n+\n+  if (must_free) free(user);\n+\n+  if (rc) return env->ThrowErrnoException(errno, \"initgroups\");\n+\n+  args.GetReturnValue().Set(0);\n+}\n+\n+#endif  // NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+\n+static void Initialize(Local<Object> target,\n+                       Local<Value> unused,\n+                       Local<Context> context,\n+                       void* priv) {\n+  Environment* env = Environment::GetCurrent(context);\n+  Isolate* isolate = env->isolate();\n+\n+  env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n+\n+#ifdef NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+  READONLY_TRUE_PROPERTY(target, \"implementsPosixCredentials\");\n+  env->SetMethodNoSideEffect(target, \"getuid\", GetUid);\n+  env->SetMethodNoSideEffect(target, \"geteuid\", GetEUid);\n+  env->SetMethodNoSideEffect(target, \"getgid\", GetGid);\n+  env->SetMethodNoSideEffect(target, \"getegid\", GetEGid);\n+  env->SetMethodNoSideEffect(target, \"getgroups\", GetGroups);\n+\n+  if (env->is_main_thread()) {\n+    env->SetMethod(target, \"initgroups\", InitGroups);\n+    env->SetMethod(target, \"setegid\", SetEGid);\n+    env->SetMethod(target, \"seteuid\", SetEUid);\n+    env->SetMethod(target, \"setgid\", SetGid);\n+    env->SetMethod(target, \"setuid\", SetUid);\n+    env->SetMethod(target, \"setgroups\", SetGroups);\n+  }\n+#endif  // NODE_IMPLEMENTS_POSIX_CREDENTIALS\n+}\n+\n+}  // namespace credentials\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(credentials, node::credentials::Initialize)"
        },
        {
            "sha": "2c6aad5b967c3d2f7c2a634d193b0d66b47d85c2",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 5,
            "deletions": 12,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -126,7 +126,6 @@ void RegisterSignalHandler(int signal,\n                            bool reset_handler = false);\n #endif\n \n-bool SafeGetenv(const char* key, std::string* text);\n v8::Local<v8::Object> CreateEnvVarProxy(v8::Local<v8::Context> context,\n                                         v8::Isolate* isolate,\n                                         v8::Local<v8::Value> data);\n@@ -734,19 +733,13 @@ void ProcessTitleSetter(v8::Local<v8::Name> property,\n                         const v8::PropertyCallbackInfo<void>& info);\n \n #if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-void SetGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void SetEGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void SetUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void SetEUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void SetGroups(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void InitGroups(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetEUid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetEGid(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetGroups(const v8::FunctionCallbackInfo<v8::Value>& args);\n+#define NODE_IMPLEMENTS_POSIX_CREDENTIALS 1\n #endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n \n+namespace credentials {\n+bool SafeGetenv(const char* key, std::string* text);\n+}  // namespace credentials\n+\n void DefineZlibConstants(v8::Local<v8::Object> target);\n \n }  // namespace node"
        },
        {
            "sha": "7107aea8c1a45533bec94f9b3b6121b944a09ba3",
            "filename": "src/node_main.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_main.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_main.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_main.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -88,7 +88,9 @@ extern char** environ;\n #endif\n \n namespace node {\n-  extern bool linux_at_secure;\n+namespace per_process {\n+extern bool linux_at_secure;\n+}  // namespace per_process\n }  // namespace node\n \n int main(int argc, char* argv[]) {\n@@ -112,7 +114,7 @@ int main(int argc, char* argv[]) {\n   Elf_auxv_t* auxv = reinterpret_cast<Elf_auxv_t*>(envp);\n   for (; auxv->a_type != AT_NULL; auxv++) {\n     if (auxv->a_type == AT_SECURE) {\n-      node::linux_at_secure = auxv->a_un.a_val;\n+      node::per_process::linux_at_secure = auxv->a_un.a_val;\n       break;\n     }\n   }"
        },
        {
            "sha": "b9376953e241be55b39b59207a98ff6336cf9b5a",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 332,
            "changes": 332,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -24,12 +24,6 @@ typedef int mode_t;\n #include <pthread.h>\n #include <sys/resource.h>  // getrlimit, setrlimit\n #include <termios.h>  // tcgetattr, tcsetattr\n-#include <unistd.h>  // setuid, getuid\n-#endif\n-\n-#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-#include <pwd.h>  // getpwnam()\n-#include <grp.h>  // getgrnam()\n #endif\n \n namespace node {\n@@ -42,7 +36,6 @@ using v8::Float64Array;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::HeapStatistics;\n-using v8::Integer;\n using v8::Isolate;\n using v8::Local;\n using v8::Name;\n@@ -254,331 +247,6 @@ void Uptime(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(uptime / 1000);\n }\n \n-\n-#if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-\n-static const uid_t uid_not_found = static_cast<uid_t>(-1);\n-static const gid_t gid_not_found = static_cast<gid_t>(-1);\n-\n-\n-static uid_t uid_by_name(const char* name) {\n-  struct passwd pwd;\n-  struct passwd* pp;\n-  char buf[8192];\n-\n-  errno = 0;\n-  pp = nullptr;\n-\n-  if (getpwnam_r(name, &pwd, buf, sizeof(buf), &pp) == 0 && pp != nullptr)\n-    return pp->pw_uid;\n-\n-  return uid_not_found;\n-}\n-\n-\n-static char* name_by_uid(uid_t uid) {\n-  struct passwd pwd;\n-  struct passwd* pp;\n-  char buf[8192];\n-  int rc;\n-\n-  errno = 0;\n-  pp = nullptr;\n-\n-  if ((rc = getpwuid_r(uid, &pwd, buf, sizeof(buf), &pp)) == 0 &&\n-      pp != nullptr) {\n-    return strdup(pp->pw_name);\n-  }\n-\n-  if (rc == 0)\n-    errno = ENOENT;\n-\n-  return nullptr;\n-}\n-\n-\n-static gid_t gid_by_name(const char* name) {\n-  struct group pwd;\n-  struct group* pp;\n-  char buf[8192];\n-\n-  errno = 0;\n-  pp = nullptr;\n-\n-  if (getgrnam_r(name, &pwd, buf, sizeof(buf), &pp) == 0 && pp != nullptr)\n-    return pp->gr_gid;\n-\n-  return gid_not_found;\n-}\n-\n-\n-#if 0  // For future use.\n-static const char* name_by_gid(gid_t gid) {\n-  struct group pwd;\n-  struct group* pp;\n-  char buf[8192];\n-  int rc;\n-\n-  errno = 0;\n-  pp = nullptr;\n-\n-  if ((rc = getgrgid_r(gid, &pwd, buf, sizeof(buf), &pp)) == 0 &&\n-      pp != nullptr) {\n-    return strdup(pp->gr_name);\n-  }\n-\n-  if (rc == 0)\n-    errno = ENOENT;\n-\n-  return nullptr;\n-}\n-#endif\n-\n-\n-static uid_t uid_by_name(Isolate* isolate, Local<Value> value) {\n-  if (value->IsUint32()) {\n-    return static_cast<uid_t>(value.As<Uint32>()->Value());\n-  } else {\n-    Utf8Value name(isolate, value);\n-    return uid_by_name(*name);\n-  }\n-}\n-\n-\n-static gid_t gid_by_name(Isolate* isolate, Local<Value> value) {\n-  if (value->IsUint32()) {\n-    return static_cast<gid_t>(value.As<Uint32>()->Value());\n-  } else {\n-    Utf8Value name(isolate, value);\n-    return gid_by_name(*name);\n-  }\n-}\n-\n-void GetUid(const FunctionCallbackInfo<Value>& args) {\n-  // uid_t is an uint32_t on all supported platforms.\n-  args.GetReturnValue().Set(static_cast<uint32_t>(getuid()));\n-}\n-\n-\n-void GetGid(const FunctionCallbackInfo<Value>& args) {\n-  // gid_t is an uint32_t on all supported platforms.\n-  args.GetReturnValue().Set(static_cast<uint32_t>(getgid()));\n-}\n-\n-\n-void GetEUid(const FunctionCallbackInfo<Value>& args) {\n-  // uid_t is an uint32_t on all supported platforms.\n-  args.GetReturnValue().Set(static_cast<uint32_t>(geteuid()));\n-}\n-\n-\n-void GetEGid(const FunctionCallbackInfo<Value>& args) {\n-  // gid_t is an uint32_t on all supported platforms.\n-  args.GetReturnValue().Set(static_cast<uint32_t>(getegid()));\n-}\n-\n-\n-void SetGid(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  CHECK(env->is_main_thread());\n-\n-  CHECK_EQ(args.Length(), 1);\n-  CHECK(args[0]->IsUint32() || args[0]->IsString());\n-\n-  gid_t gid = gid_by_name(env->isolate(), args[0]);\n-\n-  if (gid == gid_not_found) {\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    args.GetReturnValue().Set(1);\n-  } else if (setgid(gid)) {\n-    env->ThrowErrnoException(errno, \"setgid\");\n-  } else {\n-    args.GetReturnValue().Set(0);\n-  }\n-}\n-\n-\n-void SetEGid(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  CHECK(env->is_main_thread());\n-\n-  CHECK_EQ(args.Length(), 1);\n-  CHECK(args[0]->IsUint32() || args[0]->IsString());\n-\n-  gid_t gid = gid_by_name(env->isolate(), args[0]);\n-\n-  if (gid == gid_not_found) {\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    args.GetReturnValue().Set(1);\n-  } else if (setegid(gid)) {\n-    env->ThrowErrnoException(errno, \"setegid\");\n-  } else {\n-    args.GetReturnValue().Set(0);\n-  }\n-}\n-\n-\n-void SetUid(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  CHECK(env->is_main_thread());\n-\n-  CHECK_EQ(args.Length(), 1);\n-  CHECK(args[0]->IsUint32() || args[0]->IsString());\n-\n-  uid_t uid = uid_by_name(env->isolate(), args[0]);\n-\n-  if (uid == uid_not_found) {\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    args.GetReturnValue().Set(1);\n-  } else if (setuid(uid)) {\n-    env->ThrowErrnoException(errno, \"setuid\");\n-  } else {\n-    args.GetReturnValue().Set(0);\n-  }\n-}\n-\n-\n-void SetEUid(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  CHECK(env->is_main_thread());\n-\n-  CHECK_EQ(args.Length(), 1);\n-  CHECK(args[0]->IsUint32() || args[0]->IsString());\n-\n-  uid_t uid = uid_by_name(env->isolate(), args[0]);\n-\n-  if (uid == uid_not_found) {\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    args.GetReturnValue().Set(1);\n-  } else if (seteuid(uid)) {\n-    env->ThrowErrnoException(errno, \"seteuid\");\n-  } else {\n-    args.GetReturnValue().Set(0);\n-  }\n-}\n-\n-\n-void GetGroups(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  int ngroups = getgroups(0, nullptr);\n-\n-  if (ngroups == -1)\n-    return env->ThrowErrnoException(errno, \"getgroups\");\n-\n-  gid_t* groups = new gid_t[ngroups];\n-\n-  ngroups = getgroups(ngroups, groups);\n-\n-  if (ngroups == -1) {\n-    delete[] groups;\n-    return env->ThrowErrnoException(errno, \"getgroups\");\n-  }\n-\n-  Local<Array> groups_list = Array::New(env->isolate(), ngroups);\n-  bool seen_egid = false;\n-  gid_t egid = getegid();\n-\n-  for (int i = 0; i < ngroups; i++) {\n-    groups_list->Set(env->context(),\n-                     i, Integer::New(env->isolate(), groups[i])).FromJust();\n-    if (groups[i] == egid)\n-      seen_egid = true;\n-  }\n-\n-  delete[] groups;\n-\n-  if (seen_egid == false)\n-    groups_list->Set(env->context(),\n-                     ngroups,\n-                     Integer::New(env->isolate(), egid)).FromJust();\n-\n-  args.GetReturnValue().Set(groups_list);\n-}\n-\n-\n-void SetGroups(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  CHECK_EQ(args.Length(), 1);\n-  CHECK(args[0]->IsArray());\n-\n-  Local<Array> groups_list = args[0].As<Array>();\n-  size_t size = groups_list->Length();\n-  gid_t* groups = new gid_t[size];\n-\n-  for (size_t i = 0; i < size; i++) {\n-    gid_t gid = gid_by_name(env->isolate(),\n-                            groups_list->Get(env->context(),\n-                                             i).ToLocalChecked());\n-\n-    if (gid == gid_not_found) {\n-      delete[] groups;\n-      // Tells JS to throw ERR_INVALID_CREDENTIAL\n-      args.GetReturnValue().Set(static_cast<uint32_t>(i + 1));\n-      return;\n-    }\n-\n-    groups[i] = gid;\n-  }\n-\n-  int rc = setgroups(size, groups);\n-  delete[] groups;\n-\n-  if (rc == -1)\n-    return env->ThrowErrnoException(errno, \"setgroups\");\n-\n-  args.GetReturnValue().Set(0);\n-}\n-\n-\n-void InitGroups(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  CHECK_EQ(args.Length(), 2);\n-  CHECK(args[0]->IsUint32() || args[0]->IsString());\n-  CHECK(args[1]->IsUint32() || args[1]->IsString());\n-\n-  Utf8Value arg0(env->isolate(), args[0]);\n-  gid_t extra_group;\n-  bool must_free;\n-  char* user;\n-\n-  if (args[0]->IsUint32()) {\n-    user = name_by_uid(args[0].As<Uint32>()->Value());\n-    must_free = true;\n-  } else {\n-    user = *arg0;\n-    must_free = false;\n-  }\n-\n-  if (user == nullptr) {\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    return args.GetReturnValue().Set(1);\n-  }\n-\n-  extra_group = gid_by_name(env->isolate(), args[1]);\n-\n-  if (extra_group == gid_not_found) {\n-    if (must_free)\n-      free(user);\n-    // Tells JS to throw ERR_INVALID_CREDENTIAL\n-    return args.GetReturnValue().Set(2);\n-  }\n-\n-  int rc = initgroups(user, extra_group);\n-\n-  if (must_free)\n-    free(user);\n-\n-  if (rc)\n-    return env->ThrowErrnoException(errno, \"initgroups\");\n-\n-  args.GetReturnValue().Set(0);\n-}\n-\n-#endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n-\n void ProcessTitleGetter(Local<Name> property,\n                         const PropertyCallbackInfo<Value>& info) {\n   char buffer[512];"
        },
        {
            "sha": "f7412d92bcd8e759e0acc9df173cbac12615a8cf",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -15,7 +15,6 @@ using v8::Integer;\n using v8::Isolate;\n using v8::KeyCollectionMode;\n using v8::Local;\n-using v8::NewStringType;\n using v8::Object;\n using v8::ONLY_CONFIGURABLE;\n using v8::ONLY_ENUMERABLE;\n@@ -172,17 +171,6 @@ void WatchdogHasPendingSigint(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(ret);\n }\n \n-void SafeGetenv(const FunctionCallbackInfo<Value>& args) {\n-  CHECK(args[0]->IsString());\n-  Utf8Value strenvtag(args.GetIsolate(), args[0]);\n-  std::string text;\n-  if (!node::SafeGetenv(*strenvtag, &text)) return;\n-  args.GetReturnValue()\n-      .Set(String::NewFromUtf8(\n-            args.GetIsolate(), text.c_str(),\n-            NewStringType::kNormal).ToLocalChecked());\n-}\n-\n void EnqueueMicrotask(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Isolate* isolate = env->isolate();\n@@ -232,8 +220,6 @@ void Initialize(Local<Object> target,\n   env->SetMethodNoSideEffect(target, \"watchdogHasPendingSigint\",\n                              WatchdogHasPendingSigint);\n \n-  env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n-\n   env->SetMethod(target, \"enqueueMicrotask\", EnqueueMicrotask);\n \n   Local<Object> constants = Object::New(env->isolate());"
        },
        {
            "sha": "5c1693ca89c5db92cd7e30e0155125ed2d91cc69",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -9,7 +9,7 @@ const common = require('../common');\n const assert = require('assert');\n \n const isMainThread = common.isMainThread;\n-const kMaxModuleCount = isMainThread ? 59 : 82;\n+const kMaxModuleCount = isMainThread ? 60 : 82;\n \n assert(list.length <= kMaxModuleCount,\n        `Total length: ${list.length}\\n` + list.join('\\n')"
        },
        {
            "sha": "0bee9971dbb3ebb2a154d9edc841667fc9ddd1a6",
            "filename": "test/parallel/test-safe-get-env.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-safe-get-env.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-safe-get-env.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-safe-get-env.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -0,0 +1,19 @@\n+'use strict';\n+// Flags: --expose_internals\n+\n+require('../common');\n+const assert = require('assert');\n+const { internalBinding } = require('internal/test/binding');\n+const { safeGetenv } = internalBinding('credentials');\n+\n+// FIXME(joyeecheung): this test is not entirely useful. To properly\n+// test this we could create a mismatch between the effective/real\n+// group/user id of a Node.js process and see if the environment variables\n+// are no longer available - but that might be tricky to set up reliably.\n+\n+for (const oneEnv in process.env) {\n+  assert.strictEqual(\n+    safeGetenv(oneEnv),\n+    process.env[oneEnv]\n+  );\n+}"
        },
        {
            "sha": "f16ccfdbdc534f7a95b446c47b28bf80436b1bd3",
            "filename": "test/parallel/test-util-internal.js",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-util-internal.js",
            "raw_url": "https://github.com/nodejs/node/raw/321e296371383fd63131d21c1121e22163ddeb86/test%2Fparallel%2Ftest-util-internal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-internal.js?ref=321e296371383fd63131d21c1121e22163ddeb86",
            "patch": "@@ -9,17 +9,9 @@ const { internalBinding } = require('internal/test/binding');\n const {\n   getHiddenValue,\n   setHiddenValue,\n-  arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex,\n-  safeGetenv\n+  arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex\n } = internalBinding('util');\n \n-for (const oneEnv in process.env) {\n-  assert.strictEqual(\n-    safeGetenv(oneEnv),\n-    process.env[oneEnv]\n-  );\n-}\n-\n assert.strictEqual(\n   getHiddenValue({}, kArrowMessagePrivateSymbolIndex),\n   undefined);"
        }
    ],
    "stats": {
        "total": 972,
        "additions": 498,
        "deletions": 474
    }
}