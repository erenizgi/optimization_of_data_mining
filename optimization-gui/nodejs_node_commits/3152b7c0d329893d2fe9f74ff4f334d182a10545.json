{
    "author": "joyeecheung",
    "message": "src: assign ERR_SCRIPT_EXECUTION_* codes in C++\n\nAlso modifies the error messages so they include more information\nand are more consistent.\n\n- The message of ERR_SCRIPT_EXECUTION_INTERRUPTED now mentions\n  SIGINT and the trailing period is dropped for consistency.\n- Added ERR_SCRIPT_EXECUTION_TIMEOUT and include the timeout\n  in the message.\n\nPR-URL: https://github.com/nodejs/node/pull/20147\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "3152b7c0d329893d2fe9f74ff4f334d182a10545",
    "files": [
        {
            "sha": "ff317f676a888149aa48b9831e93d5a544123080",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -1371,6 +1371,10 @@ An attempt was made to `require()` an [ES6 module][].\n Script execution was interrupted by `SIGINT` (For example, when Ctrl+C was\n pressed).\n \n+### ERR_SCRIPT_EXECUTION_TIMEOUT\n+\n+Script execution timed out, possibly due to bugs in the script being executed.\n+\n <a id=\"ERR_SERVER_ALREADY_LISTEN\"></a>\n ### ERR_SERVER_ALREADY_LISTEN\n "
        },
        {
            "sha": "e7eb3bd133813a1b29d15622c7c17f3175f1ed45",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -952,7 +952,7 @@ E('ERR_NO_LONGER_SUPPORTED', '%s is no longer supported', Error);\n E('ERR_OUT_OF_RANGE', outOfRange, RangeError);\n E('ERR_REQUIRE_ESM', 'Must use import to load ES Module: %s', Error);\n E('ERR_SCRIPT_EXECUTION_INTERRUPTED',\n-  'Script execution was interrupted by `SIGINT`.', Error);\n+  'Script execution was interrupted by `SIGINT`', Error);\n E('ERR_SERVER_ALREADY_LISTEN',\n   'Listen method has been called more than once without closing.', Error);\n E('ERR_SERVER_NOT_RUNNING', 'Server is not running.', Error);"
        },
        {
            "sha": "f88c113ae0b93f7413bdfdbba466dadd775e33ce",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -286,9 +286,9 @@ void ModuleWrap::Evaluate(const FunctionCallbackInfo<Value>& args) {\n     // which this timeout is nested, so check whether one of the watchdogs\n     // from this invocation is responsible for termination.\n     if (timed_out) {\n-      env->ThrowError(\"Script execution timed out.\");\n+      THROW_ERR_SCRIPT_EXECUTION_TIMEOUT(env, timeout);\n     } else if (received_signal) {\n-      env->ThrowError(\"Script execution interrupted.\");\n+      THROW_ERR_SCRIPT_EXECUTION_INTERRUPTED(env);\n     }\n   }\n "
        },
        {
            "sha": "ca58d1897e68b2d40bef20c5872f1dff6156e35f",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -19,6 +19,7 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+#include \"node_errors.h\"\n #include \"node_internals.h\"\n #include \"node_watchdog.h\"\n #include \"base_object-inl.h\"\n@@ -858,9 +859,9 @@ class ContextifyScript : public BaseObject {\n       // which this timeout is nested, so check whether one of the watchdogs\n       // from this invocation is responsible for termination.\n       if (timed_out) {\n-        env->ThrowError(\"Script execution timed out.\");\n+        node::THROW_ERR_SCRIPT_EXECUTION_TIMEOUT(env, timeout);\n       } else if (received_signal) {\n-        env->ThrowError(\"Script execution interrupted.\");\n+        node::THROW_ERR_SCRIPT_EXECUTION_INTERRUPTED(env);\n       }\n     }\n "
        },
        {
            "sha": "eb120c62807cf69df6c52b72fc789bd6831aa5c9",
            "filename": "src/node_errors.h",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fnode_errors.h",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/src%2Fnode_errors.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.h?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -8,6 +8,10 @@\n #include \"env-inl.h\"\n #include \"v8.h\"\n \n+// Use ostringstream to print exact-width integer types\n+// because the format specifiers are not available on AIX.\n+#include <sstream>\n+\n namespace node {\n \n // Helpers to construct errors similar to the ones provided by\n@@ -24,6 +28,8 @@ namespace node {\n   V(ERR_MEMORY_ALLOCATION_FAILED, Error)                                     \\\n   V(ERR_MISSING_ARGS, TypeError)                                             \\\n   V(ERR_MISSING_MODULE, Error)                                               \\\n+  V(ERR_SCRIPT_EXECUTION_INTERRUPTED, Error)                                 \\\n+  V(ERR_SCRIPT_EXECUTION_TIMEOUT, Error)                                     \\\n   V(ERR_STRING_TOO_LONG, Error)                                              \\\n   V(ERR_BUFFER_TOO_LARGE, Error)\n \n@@ -49,7 +55,9 @@ namespace node {\n \n #define PREDEFINED_ERROR_MESSAGES(V)                                         \\\n   V(ERR_INDEX_OUT_OF_RANGE, \"Index out of range\")                            \\\n-  V(ERR_MEMORY_ALLOCATION_FAILED, \"Failed to allocate memory\")\n+  V(ERR_MEMORY_ALLOCATION_FAILED, \"Failed to allocate memory\")               \\\n+  V(ERR_SCRIPT_EXECUTION_INTERRUPTED,                                        \\\n+    \"Script execution was interrupted by `SIGINT`\")\n \n #define V(code, message)                                                     \\\n   inline v8::Local<v8::Value> code(v8::Isolate* isolate) {                   \\\n@@ -62,6 +70,13 @@ namespace node {\n #undef V\n \n // Errors with predefined non-static messages\n+inline void THROW_ERR_SCRIPT_EXECUTION_TIMEOUT(Environment* env,\n+                                               int64_t timeout) {\n+  std::ostringstream message;\n+  message << \"Script execution timed out after \";\n+  message << timeout << \"ms\";\n+  THROW_ERR_SCRIPT_EXECUTION_TIMEOUT(env, message.str().c_str());\n+}\n \n inline v8::Local<v8::Value> ERR_BUFFER_TOO_LARGE(v8::Isolate *isolate) {\n   char message[128];"
        },
        {
            "sha": "ea07393527b82888d84d8fa2190eb2d8865bb8c9",
            "filename": "test/parallel/test-repl-sigint-nested-eval.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-sigint-nested-eval.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-sigint-nested-eval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-sigint-nested-eval.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -34,10 +34,10 @@ child.stdout.once('data', common.mustCall(() => {\n }));\n \n child.on('close', function(code) {\n-  assert.strictEqual(code, 0);\n+  const expected = 'Script execution was interrupted by `SIGINT`';\n   assert.ok(\n-    stdout.includes('Script execution interrupted.'),\n-    `Expected stdout to contain \"Script execution interrupted.\", got ${stdout}`\n+    stdout.includes(expected),\n+    `Expected stdout to contain \"${expected}\", got ${stdout}`\n   );\n   assert.ok(\n     stdout.includes('foobar'),"
        },
        {
            "sha": "14cafd0463709fa3b14d3cef2220579e88532aa0",
            "filename": "test/parallel/test-repl-sigint.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-sigint.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-sigint.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-sigint.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -35,9 +35,10 @@ child.stdout.once('data', common.mustCall(() => {\n \n child.on('close', function(code) {\n   assert.strictEqual(code, 0);\n+  const expected = 'Script execution was interrupted by `SIGINT`';\n   assert.ok(\n-    stdout.includes('Script execution interrupted.\\n'),\n-    `Expected stdout to contain \"Script execution interrupted.\", got ${stdout}`\n+    stdout.includes(expected),\n+    `Expected stdout to contain \"${expected}\", got ${stdout}`\n   );\n   assert.ok(\n     stdout.includes('42042\\n'),"
        },
        {
            "sha": "5a07f5ced14450543f2bb544b406c06de3933bfc",
            "filename": "test/parallel/test-repl-top-level-await.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-top-level-await.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -161,7 +161,7 @@ async function ctrlCTest() {\n   ]), [\n     'await timeout(100000)\\r',\n     'Thrown: Error [ERR_SCRIPT_EXECUTION_INTERRUPTED]: ' +\n-      'Script execution was interrupted by `SIGINT`.',\n+      'Script execution was interrupted by `SIGINT`',\n     PROMPT\n   ]);\n }"
        },
        {
            "sha": "13fccd9637c7fb9421de6b5b2dc8375553d8a59f",
            "filename": "test/parallel/test-vm-sigint-existing-handler.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-sigint-existing-handler.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-sigint-existing-handler.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-sigint-existing-handler.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -36,8 +36,12 @@ if (process.argv[2] === 'child') {\n     [];\n   const options = { breakOnSigint: true };\n \n-  assert.throws(() => { vm[method](script, ...args, options); },\n-                /^Error: Script execution interrupted\\.$/);\n+  common.expectsError(\n+    () => { vm[method](script, ...args, options); },\n+    {\n+      code: 'ERR_SCRIPT_EXECUTION_INTERRUPTED',\n+      message: 'Script execution was interrupted by `SIGINT`'\n+    });\n   assert.strictEqual(firstHandlerCalled, 0);\n   assert.strictEqual(onceHandlerCalled, 0);\n "
        },
        {
            "sha": "0fecfbace68049e470823e20c99eb0c7c6ae4c40",
            "filename": "test/parallel/test-vm-sigint.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-sigint.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-sigint.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-sigint.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -24,8 +24,12 @@ if (process.argv[2] === 'child') {\n   for (let i = 0; i < listeners; i++)\n     process.on('SIGINT', common.mustNotCall());\n \n-  assert.throws(() => { vm[method](script, ...args, options); },\n-                /^Error: Script execution interrupted\\.$/);\n+  common.expectsError(\n+    () => { vm[method](script, ...args, options); },\n+    {\n+      code: 'ERR_SCRIPT_EXECUTION_INTERRUPTED',\n+      message: 'Script execution was interrupted by `SIGINT`'\n+    });\n   return;\n }\n "
        },
        {
            "sha": "426d1e06925514b2729b11e84b6918deadb53dba",
            "filename": "test/parallel/test-vm-timeout.js",
            "status": "modified",
            "additions": 37,
            "deletions": 22,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fparallel%2Ftest-vm-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-timeout.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -25,35 +25,50 @@ const assert = require('assert');\n const vm = require('vm');\n \n // Timeout of 100ms executing endless loop\n-assert.throws(function() {\n-  vm.runInThisContext('while(true) {}', { timeout: 100 });\n-}, /^Error: Script execution timed out\\.$/);\n+assert.throws(\n+  function() {\n+    vm.runInThisContext('while(true) {}', { timeout: 100 });\n+  },\n+  {\n+    code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+    message: 'Script execution timed out after 100ms'\n+  });\n \n // Timeout of 1000ms, script finishes first\n vm.runInThisContext('', { timeout: 1000 });\n \n // Nested vm timeouts, inner timeout propagates out\n-assert.throws(function() {\n-  const context = {\n-    log: console.log,\n-    runInVM: function(timeout) {\n-      vm.runInNewContext('while(true) {}', context, { timeout });\n-    }\n-  };\n-  vm.runInNewContext('runInVM(10)', context, { timeout: 10000 });\n-  throw new Error('Test 5 failed');\n-}, /Script execution timed out\\./);\n+assert.throws(\n+  function() {\n+    const context = {\n+      log: console.log,\n+      runInVM: function(timeout) {\n+        vm.runInNewContext('while(true) {}', context, { timeout });\n+      }\n+    };\n+    vm.runInNewContext('runInVM(10)', context, { timeout: 10000 });\n+    throw new Error('Test 5 failed');\n+  },\n+  {\n+    code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+    message: 'Script execution timed out after 10ms'\n+  });\n \n // Nested vm timeouts, outer timeout is shorter and fires first.\n-assert.throws(function() {\n-  const context = {\n-    runInVM: function(timeout) {\n-      vm.runInNewContext('while(true) {}', context, { timeout });\n-    }\n-  };\n-  vm.runInNewContext('runInVM(10000)', context, { timeout: 100 });\n-  throw new Error('Test 6 failed');\n-}, /Script execution timed out\\./);\n+assert.throws(\n+  function() {\n+    const context = {\n+      runInVM: function(timeout) {\n+        vm.runInNewContext('while(true) {}', context, { timeout });\n+      }\n+    };\n+    vm.runInNewContext('runInVM(10000)', context, { timeout: 100 });\n+    throw new Error('Test 6 failed');\n+  },\n+  {\n+    code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n+    message: 'Script execution timed out after 100ms'\n+  });\n \n // Nested vm timeouts, inner script throws an error.\n assert.throws(function() {"
        },
        {
            "sha": "c38460c4c89925bc29720f3cbd7c91c9cf80bbae",
            "filename": "test/sequential/test-vm-timeout-rethrow.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fsequential%2Ftest-vm-timeout-rethrow.js",
            "raw_url": "https://github.com/nodejs/node/raw/3152b7c0d329893d2fe9f74ff4f334d182a10545/test%2Fsequential%2Ftest-vm-timeout-rethrow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-vm-timeout-rethrow.js?ref=3152b7c0d329893d2fe9f74ff4f334d182a10545",
            "patch": "@@ -39,6 +39,6 @@ if (process.argv[2] === 'child') {\n   });\n \n   process.on('exit', function() {\n-    assert.ok(/Script execution timed out/.test(err));\n+    assert.ok(/Script execution timed out after 1ms/.test(err));\n   });\n }"
        }
    ],
    "stats": {
        "total": 122,
        "additions": 83,
        "deletions": 39
    }
}