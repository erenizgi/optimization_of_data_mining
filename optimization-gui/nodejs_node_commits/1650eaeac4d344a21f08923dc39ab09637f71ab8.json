{
    "author": "joyeecheung",
    "message": "fs: throw fchownSync errors in JS\n\nPR-URL: https://github.com/nodejs/node/pull/19041\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1650eaeac4d344a21f08923dc39ab09637f71ab8",
    "files": [
        {
            "sha": "0671a05ae0068193059dc2bc4fd2ac78c903ad23",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1650eaeac4d344a21f08923dc39ab09637f71ab8/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/1650eaeac4d344a21f08923dc39ab09637f71ab8/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=1650eaeac4d344a21f08923dc39ab09637f71ab8",
            "patch": "@@ -1110,7 +1110,9 @@ fs.fchownSync = function(fd, uid, gid) {\n   validateUint32(uid, 'uid');\n   validateUint32(gid, 'gid');\n \n-  return binding.fchown(fd, uid, gid);\n+  const ctx = {};\n+  binding.fchown(fd, uid, gid, undefined, ctx);\n+  handleErrorFromBinding(ctx);\n };\n \n fs.chown = function(path, uid, gid, callback) {"
        },
        {
            "sha": "61b4ed958731f08a61de2cc489395d17c8f2e631",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/1650eaeac4d344a21f08923dc39ab09637f71ab8/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1650eaeac4d344a21f08923dc39ab09637f71ab8/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=1650eaeac4d344a21f08923dc39ab09637f71ab8",
            "patch": "@@ -1552,20 +1552,27 @@ static void Chown(const FunctionCallbackInfo<Value>& args) {\n static void FChown(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n+  const int argc = args.Length();\n+  CHECK_GE(argc, 3);\n+\n   CHECK(args[0]->IsInt32());\n+  const int fd = args[0].As<Int32>()->Value();\n+\n   CHECK(args[1]->IsUint32());\n-  CHECK(args[2]->IsUint32());\n+  const uv_uid_t uid = static_cast<uv_uid_t>(args[1].As<Uint32>()->Value());\n \n-  int fd = args[0]->Int32Value();\n-  uv_uid_t uid = static_cast<uv_uid_t>(args[1]->Uint32Value());\n-  uv_gid_t gid = static_cast<uv_gid_t>(args[2]->Uint32Value());\n+  CHECK(args[2]->IsUint32());\n+  const uv_gid_t gid = static_cast<uv_gid_t>(args[2].As<Uint32>()->Value());\n \n   FSReqBase* req_wrap = GetReqWrap(env, args[3]);\n-  if (req_wrap != nullptr) {\n+  if (req_wrap != nullptr) {  // fchown(fd, uid, gid, req)\n     AsyncCall(env, req_wrap, args, \"fchown\", UTF8, AfterNoArgs,\n               uv_fs_fchown, fd, uid, gid);\n-  } else {\n-    SYNC_CALL(fchown, 0, fd, uid, gid);\n+  } else {  // fchown(fd, uid, gid, undefined, ctx)\n+    CHECK_EQ(argc, 5);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[4], &req_wrap, \"fchown\",\n+             uv_fs_fchown, fd, uid, gid);\n   }\n }\n "
        },
        {
            "sha": "1aa4e1229499e628e0d8a7e6d4e74f1e175d7d17",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/1650eaeac4d344a21f08923dc39ab09637f71ab8/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/1650eaeac4d344a21f08923dc39ab09637f71ab8/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=1650eaeac4d344a21f08923dc39ab09637f71ab8",
            "patch": "@@ -749,3 +749,24 @@ if (!common.isAIX) {\n     );\n   });\n }\n+\n+// fchown\n+if (!common.isWindows) {\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, fchown');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'fchown');\n+    return true;\n+  };\n+\n+  common.runWithInvalidFD((fd) => {\n+    fs.fchown(fd, process.getuid(), process.getgid(),\n+              common.mustCall(validateError));\n+\n+    assert.throws(\n+      () => fs.fchownSync(fd, process.getuid(), process.getgid()),\n+      validateError\n+    );\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}