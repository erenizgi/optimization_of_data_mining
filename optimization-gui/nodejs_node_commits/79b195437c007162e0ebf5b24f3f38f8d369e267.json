{
    "author": "joyeecheung",
    "message": "fs: throw fchmodSync errors in JS\n\nPR-URL: https://github.com/nodejs/node/pull/19041\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "79b195437c007162e0ebf5b24f3f38f8d369e267",
    "files": [
        {
            "sha": "2cafcefc53d3af43d06d464c301a6d8f30c4aea6",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/79b195437c007162e0ebf5b24f3f38f8d369e267/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/79b195437c007162e0ebf5b24f3f38f8d369e267/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=79b195437c007162e0ebf5b24f3f38f8d369e267",
            "patch": "@@ -1004,7 +1004,9 @@ fs.fchmodSync = function(fd, mode) {\n   validateUint32(mode, 'mode');\n   if (mode < 0 || mode > 0o777)\n     throw new errors.RangeError('ERR_OUT_OF_RANGE', 'mode');\n-  return binding.fchmod(fd, mode);\n+  const ctx = {};\n+  binding.fchmod(fd, mode, undefined, ctx);\n+  handleErrorFromBinding(ctx);\n };\n \n if (constants.O_SYMLINK !== undefined) {"
        },
        {
            "sha": "623da28e81744d71f3bb35c645a6734e178c2323",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/79b195437c007162e0ebf5b24f3f38f8d369e267/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/79b195437c007162e0ebf5b24f3f38f8d369e267/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=79b195437c007162e0ebf5b24f3f38f8d369e267",
            "patch": "@@ -1493,18 +1493,24 @@ static void Chmod(const FunctionCallbackInfo<Value>& args) {\n static void FChmod(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n+  const int argc = args.Length();\n+  CHECK_GE(argc, 2);\n+\n   CHECK(args[0]->IsInt32());\n-  CHECK(args[1]->IsInt32());\n+  const int fd = args[0].As<Int32>()->Value();\n \n-  int fd = args[0]->Int32Value();\n-  int mode = static_cast<int>(args[1]->Int32Value());\n+  CHECK(args[1]->IsInt32());\n+  const int mode = args[1].As<Int32>()->Value();\n \n   FSReqBase* req_wrap = GetReqWrap(env, args[2]);\n-  if (req_wrap != nullptr) {\n+  if (req_wrap != nullptr) {  // fchmod(fd, mode, req)\n     AsyncCall(env, req_wrap, args, \"fchmod\", UTF8, AfterNoArgs,\n               uv_fs_fchmod, fd, mode);\n-  } else {\n-    SYNC_CALL(fchmod, 0, fd, mode);\n+  } else {  // fchmod(fd, mode, undefined, ctx)\n+    CHECK_EQ(argc, 4);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[3], &req_wrap, \"fchmod\",\n+             uv_fs_fchmod, fd, mode);\n   }\n }\n "
        },
        {
            "sha": "d14a5b8effcd455dc63f3ea90fa575a1cc73af9b",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/79b195437c007162e0ebf5b24f3f38f8d369e267/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/79b195437c007162e0ebf5b24f3f38f8d369e267/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=79b195437c007162e0ebf5b24f3f38f8d369e267",
            "patch": "@@ -729,3 +729,23 @@ if (!common.isAIX) {\n     );\n   });\n }\n+\n+// fchmod\n+{\n+  const validateError = (err) => {\n+    assert.strictEqual(err.message, 'EBADF: bad file descriptor, fchmod');\n+    assert.strictEqual(err.errno, uv.UV_EBADF);\n+    assert.strictEqual(err.code, 'EBADF');\n+    assert.strictEqual(err.syscall, 'fchmod');\n+    return true;\n+  };\n+\n+  common.runWithInvalidFD((fd) => {\n+    fs.fchmod(fd, 0o666, common.mustCall(validateError));\n+\n+    assert.throws(\n+      () => fs.fchmodSync(fd, 0o666),\n+      validateError\n+    );\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 35,
        "deletions": 7
    }
}