{
    "author": "guybedford",
    "message": "module: experimental modules runMain separation\n\nPR-URL: https://github.com/nodejs/node/pull/21350\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>",
    "sha": "883e1cd21d00a1ccf347c543c662b362383e86e0",
    "files": [
        {
            "sha": "c218dc2cac2a501e8663e0cd7578fd623012ae7a",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 13,
            "deletions": 14,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/883e1cd21d00a1ccf347c543c662b362383e86e0/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/883e1cd21d00a1ccf347c543c662b362383e86e0/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=883e1cd21d00a1ccf347c543c662b362383e86e0",
            "patch": "@@ -504,19 +504,6 @@ Module._load = function(request, parent, isMain) {\n     debug('Module._load REQUEST %s parent: %s', request, parent.id);\n   }\n \n-  if (experimentalModules && isMain) {\n-    if (asyncESM === undefined) lazyLoadESM();\n-    asyncESM.loaderPromise.then((loader) => {\n-      return loader.import(getURLFromFilePath(request).pathname);\n-    })\n-    .catch((e) => {\n-      decorateErrorStack(e);\n-      console.error(e);\n-      process.exit(1);\n-    });\n-    return;\n-  }\n-\n   var filename = Module._resolveFilename(request, parent, isMain);\n \n   var cachedModule = Module._cache[filename];\n@@ -741,7 +728,19 @@ if (experimentalModules) {\n // bootstrap main module.\n Module.runMain = function() {\n   // Load the main module--the command line argument.\n-  Module._load(process.argv[1], null, true);\n+  if (experimentalModules) {\n+    if (asyncESM === undefined) lazyLoadESM();\n+    asyncESM.loaderPromise.then((loader) => {\n+      return loader.import(getURLFromFilePath(process.argv[1]).pathname);\n+    })\n+    .catch((e) => {\n+      decorateErrorStack(e);\n+      console.error(e);\n+      process.exit(1);\n+    });\n+  } else {\n+    Module._load(process.argv[1], null, true);\n+  }\n   // Handle any nextTicks added in the first tick of the program\n   process._tickCallback();\n };"
        },
        {
            "sha": "8de923d37b18876adf328c55d95ee9e05d599b15",
            "filename": "test/es-module/test-esm-cjs-main.js",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Fes-module%2Ftest-esm-cjs-main.js",
            "raw_url": "https://github.com/nodejs/node/raw/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Fes-module%2Ftest-esm-cjs-main.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-cjs-main.js?ref=883e1cd21d00a1ccf347c543c662b362383e86e0",
            "patch": "@@ -1,6 +1,27 @@\n-// Flags: --experimental-modules\n 'use strict';\n-require('../common');\n+\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+const { spawn } = require('child_process');\n const assert = require('assert');\n-exports.asdf = 'asdf';\n-assert.strictEqual(require.main.exports.asdf, 'asdf');\n+\n+const entry = fixtures.path('/es-modules/cjs.js');\n+\n+const child = spawn(process.execPath, ['--experimental-modules', entry]);\n+let experimentalWarning = false;\n+let validatedExecution = false;\n+child.stderr.on('data', (data) => {\n+  if (!experimentalWarning) {\n+    experimentalWarning = true;\n+    return;\n+  }\n+  throw new Error(data.toString());\n+});\n+child.stdout.on('data', (data) => {\n+  assert.strictEqual(data.toString(), 'executed\\n');\n+  validatedExecution = true;\n+});\n+child.on('close', common.mustCall((code, stdout) => {\n+  assert.strictEqual(validatedExecution, true);\n+  assert.strictEqual(code, 0);\n+}));"
        },
        {
            "sha": "22ffa9abe96a3743d4bba95ab6c04dcb22879e19",
            "filename": "test/es-module/test-esm-error-cache.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Fes-module%2Ftest-esm-error-cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Fes-module%2Ftest-esm-error-cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-error-cache.js?ref=883e1cd21d00a1ccf347c543c662b362383e86e0",
            "patch": "@@ -7,7 +7,7 @@ const assert = require('assert');\n \n common.crashOnUnhandledRejection();\n \n-const file = '../../fixtures/syntax/bad_syntax.js';\n+const file = '../fixtures/syntax/bad_syntax.js';\n \n let error;\n (async () => {"
        },
        {
            "sha": "3a09c83abff9e87eddf8d6714147bf62912c60b7",
            "filename": "test/fixtures/es-modules/cjs.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Ffixtures%2Fes-modules%2Fcjs.js",
            "raw_url": "https://github.com/nodejs/node/raw/883e1cd21d00a1ccf347c543c662b362383e86e0/test%2Ffixtures%2Fes-modules%2Fcjs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Fcjs.js?ref=883e1cd21d00a1ccf347c543c662b362383e86e0",
            "patch": "@@ -0,0 +1,5 @@\n+'use strict';\n+\n+// test we can use commonjs require\n+require('path');\n+console.log('executed');"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 44,
        "deletions": 19
    }
}