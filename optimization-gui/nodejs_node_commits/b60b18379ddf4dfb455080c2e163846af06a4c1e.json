{
    "author": "mafintosh",
    "message": "http2: destroy the socket properly and add tests\n\nFix a bug where the socket wasn't being correctly destroyed and\nadjust existing tests, as well as add additional tests.\n\nPR-URL: https://github.com/nodejs/node/pull/19852\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\n\nCo-authored-by: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "b60b18379ddf4dfb455080c2e163846af06a4c1e",
    "files": [
        {
            "sha": "e7dbf9853fd49a5ed68781bd21fb23cbe1b85cea",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -1175,7 +1175,7 @@ class Http2Session extends EventEmitter {\n     // Otherwise, destroy immediately.\n     if (!socket.destroyed) {\n       if (!error) {\n-        setImmediate(socket.end.bind(socket));\n+        setImmediate(socket.destroy.bind(socket));\n       } else {\n         socket.destroy(error);\n       }"
        },
        {
            "sha": "78db76e001cd3a24860853ba0248e61f65177639",
            "filename": "test/parallel/test-http2-many-writes-and-destroy.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-many-writes-and-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-many-writes-and-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-many-writes-and-destroy.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const http2 = require('http2');\n+\n+{\n+  const server = http2.createServer((req, res) => {\n+    req.pipe(res);\n+  });\n+\n+  server.listen(0, () => {\n+    const url = `http://localhost:${server.address().port}`;\n+    const client = http2.connect(url);\n+    const req = client.request({ ':method': 'POST' });\n+\n+    for (let i = 0; i < 4000; i++) {\n+      req.write(Buffer.alloc(6));\n+    }\n+\n+    req.on('close', common.mustCall(() => {\n+      console.log('(req onclose)');\n+      server.close();\n+      client.close();\n+    }));\n+\n+    req.once('data', common.mustCall(() => req.destroy()));\n+  });\n+}"
        },
        {
            "sha": "d7dd99df91edb5171ecbe153693a08a965acfc37",
            "filename": "test/parallel/test-http2-pipe.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-pipe.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -33,6 +33,7 @@ server.listen(0, common.mustCall(() => {\n   const client = http2.connect(`http://localhost:${server.address().port}`);\n \n   const req = client.request({ ':method': 'POST' });\n+\n   req.on('response', common.mustCall());\n   req.resume();\n "
        },
        {
            "sha": "66887aa62bebe5755f4007ef0e05259d56200cfd",
            "filename": "test/parallel/test-http2-server-close-callback.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-server-close-callback.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-server-close-callback.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-close-callback.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const http2 = require('http2');\n+\n+const server = http2.createServer();\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  client.on('error', (err) => {\n+    if (err.code !== 'ECONNRESET')\n+      throw err;\n+  });\n+}));\n+\n+server.on('session', common.mustCall((s) => {\n+  setImmediate(() => {\n+    server.close(common.mustCall());\n+    s.destroy();\n+  });\n+}));"
        },
        {
            "sha": "ef4f42fe39bc3aba9e57fd2f73d5adf50af5f5b5",
            "filename": "test/parallel/test-http2-server-stream-session-destroy.js",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -44,10 +44,16 @@ server.on('stream', common.mustCall((stream) => {\n \n server.listen(0, common.mustCall(() => {\n   const client = h2.connect(`http://localhost:${server.address().port}`);\n-  client.on('error', () => {});\n+  client.on('error', (err) => {\n+    if (err.code !== 'ECONNRESET')\n+      throw err;\n+  });\n   const req = client.request();\n   req.resume();\n   req.on('end', common.mustCall());\n-  req.on('close', common.mustCall(() => server.close()));\n-  req.on('error', () => {});\n+  req.on('close', common.mustCall(() => server.close(common.mustCall())));\n+  req.on('error', (err) => {\n+    if (err.code !== 'ECONNRESET')\n+      throw err;\n+  });\n }));"
        },
        {
            "sha": "f946c2d3377b874ecde1a033265caea50ebde1ff",
            "filename": "test/parallel/test-http2-session-unref.js",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-session-unref.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fparallel%2Ftest-http2-session-unref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-session-unref.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -34,17 +34,23 @@ server.listen(0, common.mustCall(() => {\n   // unref destroyed client\n   {\n     const client = http2.connect(`http://localhost:${port}`);\n-    client.destroy();\n-    client.unref();\n+\n+    client.on('connect', common.mustCall(() => {\n+      client.destroy();\n+      client.unref();\n+    }));\n   }\n \n   // unref destroyed client\n   {\n     const client = http2.connect(`http://localhost:${port}`, {\n       createConnection: common.mustCall(() => clientSide)\n     });\n-    client.destroy();\n-    client.unref();\n+\n+    client.on('connect', common.mustCall(() => {\n+      client.destroy();\n+      client.unref();\n+    }));\n   }\n }));\n server.emit('connection', serverSide);"
        },
        {
            "sha": "644a20a3c88a501f470a85181b8efb8aad0a0128",
            "filename": "test/sequential/test-http2-max-session-memory.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fsequential%2Ftest-http2-max-session-memory.js",
            "raw_url": "https://github.com/nodejs/node/raw/b60b18379ddf4dfb455080c2e163846af06a4c1e/test%2Fsequential%2Ftest-http2-max-session-memory.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-max-session-memory.js?ref=b60b18379ddf4dfb455080c2e163846af06a4c1e",
            "patch": "@@ -13,6 +13,10 @@ const largeBuffer = Buffer.alloc(1e6);\n const server = http2.createServer({ maxSessionMemory: 1 });\n \n server.on('stream', common.mustCall((stream) => {\n+  stream.on('error', (err) => {\n+    if (err.code !== 'ECONNRESET')\n+      throw err;\n+  });\n   stream.respond();\n   stream.end(largeBuffer);\n }));"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 79,
        "deletions": 8
    }
}