{
    "author": "joyeecheung",
    "message": "fs: refactor stats array to be more generic\n\n- Pass kFsStatsFieldsLength between JS and C++ instead of using the\n  magic number 14\n- Pass the global stats array to the completion callback of\n  asynchronous FSReqWrap similar to how the stats arrays are passed\n  to the FSReqPromise resolvers\n- Abstract the stats converter and take an offset to compute the\n  old stats in fs.watchFile\n- Use templates in node::FillStatsArray and FSReqPromise in preparation\n  for BigInt intergration\n- Put the global stat array filler in node_internals.h because it is\n  shared by node_file.cc and node_stat_watcher.cc\n\nPR-URL: https://github.com/nodejs/node/pull/19714\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
    "files": [
        {
            "sha": "85c939cc4a551e6b785c6d0a5add8874486a25e7",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 11,
            "deletions": 18,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -43,7 +43,7 @@ const {\n } = errors.codes;\n const { Readable, Writable } = require('stream');\n const EventEmitter = require('events');\n-const { FSReqWrap, statValues } = binding;\n+const { FSReqWrap, statValues, kFsStatsFieldsLength } = binding;\n const { FSEvent } = process.binding('fs_event_wrap');\n const internalFS = require('internal/fs');\n const { getPathFromURL } = require('internal/url');\n@@ -56,7 +56,8 @@ const {\n   nullCheck,\n   preprocessSymlinkDestination,\n   Stats,\n-  statsFromValues,\n+  getStatsFromBinding,\n+  getStatsFromGlobalBinding,\n   stringToFlags,\n   stringToSymlinkType,\n   toUnixTimestamp,\n@@ -145,9 +146,9 @@ function makeStatsCallback(cb) {\n     throw new ERR_INVALID_CALLBACK();\n   }\n \n-  return function(err) {\n+  return function(err, stats) {\n     if (err) return cb(err);\n-    cb(err, statsFromValues());\n+    cb(err, getStatsFromBinding(stats));\n   };\n }\n \n@@ -891,7 +892,7 @@ fs.fstatSync = function(fd) {\n   const ctx = { fd };\n   binding.fstat(fd, undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return statsFromValues();\n+  return getStatsFromGlobalBinding();\n };\n \n fs.lstatSync = function(path) {\n@@ -900,7 +901,7 @@ fs.lstatSync = function(path) {\n   const ctx = { path };\n   binding.lstat(pathModule.toNamespacedPath(path), undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return statsFromValues();\n+  return getStatsFromGlobalBinding();\n };\n \n fs.statSync = function(path) {\n@@ -909,7 +910,7 @@ fs.statSync = function(path) {\n   const ctx = { path };\n   binding.stat(pathModule.toNamespacedPath(path), undefined, ctx);\n   handleErrorFromBinding(ctx);\n-  return statsFromValues();\n+  return getStatsFromGlobalBinding();\n };\n \n fs.readlink = function(path, options, callback) {\n@@ -1420,15 +1421,6 @@ function emitStop(self) {\n   self.emit('stop');\n }\n \n-function statsFromPrevValues() {\n-  return new Stats(statValues[14], statValues[15], statValues[16],\n-                   statValues[17], statValues[18], statValues[19],\n-                   statValues[20] < 0 ? undefined : statValues[20],\n-                   statValues[21], statValues[22],\n-                   statValues[23] < 0 ? undefined : statValues[23],\n-                   statValues[24], statValues[25], statValues[26],\n-                   statValues[27]);\n-}\n function StatWatcher() {\n   EventEmitter.call(this);\n \n@@ -1439,13 +1431,14 @@ function StatWatcher() {\n   // the sake of backwards compatibility\n   var oldStatus = -1;\n \n-  this._handle.onchange = function(newStatus) {\n+  this._handle.onchange = function(newStatus, stats) {\n     if (oldStatus === -1 &&\n         newStatus === -1 &&\n         statValues[2/* new nlink */] === statValues[16/* old nlink */]) return;\n \n     oldStatus = newStatus;\n-    self.emit('change', statsFromValues(), statsFromPrevValues());\n+    self.emit('change', getStatsFromBinding(stats),\n+              getStatsFromBinding(stats, kFsStatsFieldsLength));\n   };\n \n   this._handle.onstop = function() {"
        },
        {
            "sha": "7a0389978fdab19a733ea35f0e153971d0500737",
            "filename": "lib/fs/promises.js",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs%2Fpromises.js?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -23,11 +23,11 @@ const { isUint8Array } = require('internal/util/types');\n const {\n   copyObject,\n   getOptions,\n+  getStatsFromBinding,\n   isUint32,\n   modeNum,\n   nullCheck,\n   preprocessSymlinkDestination,\n-  statsFromValues,\n   stringToFlags,\n   stringToSymlinkType,\n   toUnixTimestamp,\n@@ -332,21 +332,24 @@ async function symlink(target, path, type_) {\n \n async function fstat(handle) {\n   validateFileHandle(handle);\n-  return statsFromValues(await binding.fstat(handle.fd, kUsePromises));\n+  const result = await binding.fstat(handle.fd, kUsePromises);\n+  return getStatsFromBinding(result);\n }\n \n async function lstat(path) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  return statsFromValues(\n-    await binding.lstat(pathModule.toNamespacedPath(path), kUsePromises));\n+  const result = await binding.lstat(pathModule.toNamespacedPath(path),\n+                                     kUsePromises);\n+  return getStatsFromBinding(result);\n }\n \n async function stat(path) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  return statsFromValues(\n-    await binding.stat(pathModule.toNamespacedPath(path), kUsePromises));\n+  const result = await binding.stat(pathModule.toNamespacedPath(path),\n+                                    kUsePromises);\n+  return getStatsFromBinding(result);\n }\n \n async function link(existingPath, newPath) {"
        },
        {
            "sha": "6ff4152aa4681460b4c7460dfbd3207ea9773568",
            "filename": "lib/internal/fs.js",
            "status": "modified",
            "additions": 22,
            "deletions": 10,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Finternal%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/lib%2Finternal%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs.js?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -134,6 +134,10 @@ function preprocessSymlinkDestination(path, type, linkPath) {\n   }\n }\n \n+function dateFromNumeric(num) {\n+  return new Date(num + 0.5);\n+}\n+\n // Constructor for file stats.\n function Stats(\n   dev,\n@@ -165,10 +169,10 @@ function Stats(\n   this.mtimeMs = mtim_msec;\n   this.ctimeMs = ctim_msec;\n   this.birthtimeMs = birthtim_msec;\n-  this.atime = new Date(atim_msec + 0.5);\n-  this.mtime = new Date(mtim_msec + 0.5);\n-  this.ctime = new Date(ctim_msec + 0.5);\n-  this.birthtime = new Date(birthtim_msec + 0.5);\n+  this.atime = dateFromNumeric(atim_msec);\n+  this.mtime = dateFromNumeric(mtim_msec);\n+  this.ctime = dateFromNumeric(ctim_msec);\n+  this.birthtime = dateFromNumeric(birthtim_msec);\n }\n \n Stats.prototype._checkModeProperty = function(property) {\n@@ -203,11 +207,18 @@ Stats.prototype.isSocket = function() {\n   return this._checkModeProperty(S_IFSOCK);\n };\n \n-function statsFromValues(stats = statValues) {\n-  return new Stats(stats[0], stats[1], stats[2], stats[3], stats[4], stats[5],\n-                   stats[6] < 0 ? undefined : stats[6], stats[7], stats[8],\n-                   stats[9] < 0 ? undefined : stats[9], stats[10], stats[11],\n-                   stats[12], stats[13]);\n+function getStatsFromBinding(stats, offset = 0) {\n+  return new Stats(stats[0 + offset], stats[1 + offset], stats[2 + offset],\n+                   stats[3 + offset], stats[4 + offset], stats[5 + offset],\n+                   stats[6 + offset] < 0 ? undefined : stats[6 + offset],\n+                   stats[7 + offset], stats[8 + offset],\n+                   stats[9 + offset] < 0 ? undefined : stats[9 + offset],\n+                   stats[10 + offset], stats[11 + offset],\n+                   stats[12 + offset], stats[13 + offset]);\n+}\n+\n+function getStatsFromGlobalBinding(offset = 0) {\n+  return getStatsFromBinding(statValues, offset);\n }\n \n function stringToFlags(flags) {\n@@ -424,7 +435,8 @@ module.exports = {\n   nullCheck,\n   preprocessSymlinkDestination,\n   realpathCacheKey: Symbol('realpathCacheKey'),\n-  statsFromValues,\n+  getStatsFromBinding,\n+  getStatsFromGlobalBinding,\n   stringToFlags,\n   stringToSymlinkType,\n   Stats,"
        },
        {
            "sha": "4be70036e313cf6052db92809a2d0b8cd3825b69",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -104,7 +104,7 @@ Environment::Environment(IsolateData* isolate_data,\n #endif\n       handle_cleanup_waiting_(0),\n       http_parser_buffer_(nullptr),\n-      fs_stats_field_array_(isolate_, kFsStatsFieldsLength),\n+      fs_stats_field_array_(isolate_, kFsStatsFieldsLength * 2),\n       context_(context->GetIsolate(), context) {\n   // We'll be creating new objects so make sure we've entered the context.\n   v8::HandleScope handle_scope(isolate());"
        },
        {
            "sha": "23758c8d123ea60f3f043d3e1203e9915634e321",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -644,6 +644,10 @@ class Environment {\n \n   inline AliasedBuffer<double, v8::Float64Array>* fs_stats_field_array();\n \n+  // stat fields contains twice the number of entries because `fs.StatWatcher`\n+  // needs room to store data for *two* `fs.Stats` instances.\n+  static const int kFsStatsFieldsLength = 14;\n+\n   inline std::vector<std::unique_ptr<fs::FileHandleReadWrap>>&\n       file_handle_read_wrap_freelist();\n \n@@ -822,9 +826,6 @@ class Environment {\n   bool http_parser_buffer_in_use_ = false;\n   std::unique_ptr<http2::http2_state> http2_state_;\n \n-  // stat fields contains twice the number of entries because `fs.StatWatcher`\n-  // needs room to store data for *two* `fs.Stats` instances.\n-  static const int kFsStatsFieldsLength = 2 * 14;\n   AliasedBuffer<double, v8::Float64Array> fs_stats_field_array_;\n \n   std::vector<std::unique_ptr<fs::FileHandleReadWrap>>"
        },
        {
            "sha": "14d908cd6f458f7b6775e079c6d4c7d3d27c7f97",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 107,
            "changes": 126,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -45,42 +45,6 @@\n \n namespace node {\n \n-void FillStatsArray(AliasedBuffer<double, v8::Float64Array>* fields_ptr,\n-                    const uv_stat_t* s, int offset) {\n-  AliasedBuffer<double, v8::Float64Array>& fields = *fields_ptr;\n-  fields[offset + 0] = s->st_dev;\n-  fields[offset + 1] = s->st_mode;\n-  fields[offset + 2] = s->st_nlink;\n-  fields[offset + 3] = s->st_uid;\n-  fields[offset + 4] = s->st_gid;\n-  fields[offset + 5] = s->st_rdev;\n-#if defined(__POSIX__)\n-  fields[offset + 6] = s->st_blksize;\n-#else\n-  fields[offset + 6] = -1;\n-#endif\n-  fields[offset + 7] = s->st_ino;\n-  fields[offset + 8] = s->st_size;\n-#if defined(__POSIX__)\n-  fields[offset + 9] = s->st_blocks;\n-#else\n-  fields[offset + 9] = -1;\n-#endif\n-// Dates.\n-// NO-LINT because the fields are 'long' and we just want to cast to `unsigned`\n-#define X(idx, name)                                                    \\\n-  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n-  fields[offset + idx] = ((unsigned long)(s->st_##name.tv_sec) * 1e3) + \\\n-  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n-                ((unsigned long)(s->st_##name.tv_nsec) / 1e6);          \\\n-\n-  X(10, atim)\n-  X(11, mtim)\n-  X(12, ctim)\n-  X(13, birthtim)\n-#undef X\n-}\n-\n namespace fs {\n \n using v8::Array;\n@@ -432,12 +396,9 @@ void FSReqWrap::Reject(Local<Value> reject) {\n   MakeCallback(env()->oncomplete_string(), 1, &reject);\n }\n \n-void FSReqWrap::FillStatsArray(const uv_stat_t* stat) {\n-  node::FillStatsArray(env()->fs_stats_field_array(), stat);\n-}\n-\n-void FSReqWrap::ResolveStat() {\n-  Resolve(Undefined(env()->isolate()));\n+void FSReqWrap::ResolveStat(const uv_stat_t* stat) {\n+  node::FillGlobalStatsArray(env(), stat);\n+  Resolve(env()->fs_stats_field_array()->GetJSArray());\n }\n \n void FSReqWrap::Resolve(Local<Value> value) {\n@@ -452,65 +413,12 @@ void FSReqWrap::SetReturnValue(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().SetUndefined();\n }\n \n-void FSReqPromise::SetReturnValue(const FunctionCallbackInfo<Value>& args) {\n-  Local<Context> context = env()->context();\n-  args.GetReturnValue().Set(\n-    object()->Get(context, env()->promise_string()).ToLocalChecked()\n-      .As<Promise::Resolver>()->GetPromise());\n-}\n-\n void NewFSReqWrap(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args.IsConstructCall());\n   Environment* env = Environment::GetCurrent(args.GetIsolate());\n   new FSReqWrap(env, args.This());\n }\n \n-FSReqPromise::FSReqPromise(Environment* env)\n-    : FSReqBase(env,\n-                env->fsreqpromise_constructor_template()\n-                    ->NewInstance(env->context()).ToLocalChecked(),\n-                AsyncWrap::PROVIDER_FSREQPROMISE),\n-      stats_field_array_(env->isolate(), 14) {\n-  auto resolver = Promise::Resolver::New(env->context()).ToLocalChecked();\n-  object()->Set(env->context(), env->promise_string(),\n-                resolver).FromJust();\n-}\n-\n-FSReqPromise::~FSReqPromise() {\n-  // Validate that the promise was explicitly resolved or rejected.\n-  CHECK(finished_);\n-}\n-\n-void FSReqPromise::Reject(Local<Value> reject) {\n-  finished_ = true;\n-  HandleScope scope(env()->isolate());\n-  InternalCallbackScope callback_scope(this);\n-  Local<Value> value =\n-      object()->Get(env()->context(),\n-                    env()->promise_string()).ToLocalChecked();\n-  Local<Promise::Resolver> resolver = value.As<Promise::Resolver>();\n-  resolver->Reject(env()->context(), reject).FromJust();\n-}\n-\n-void FSReqPromise::FillStatsArray(const uv_stat_t* stat) {\n-  node::FillStatsArray(&stats_field_array_, stat);\n-}\n-\n-void FSReqPromise::ResolveStat() {\n-  Resolve(stats_field_array_.GetJSArray());\n-}\n-\n-void FSReqPromise::Resolve(Local<Value> value) {\n-  finished_ = true;\n-  HandleScope scope(env()->isolate());\n-  InternalCallbackScope callback_scope(this);\n-  Local<Value> val =\n-      object()->Get(env()->context(),\n-                    env()->promise_string()).ToLocalChecked();\n-  Local<Promise::Resolver> resolver = val.As<Promise::Resolver>();\n-  resolver->Resolve(env()->context(), value).FromJust();\n-}\n-\n FSReqAfterScope::FSReqAfterScope(FSReqBase* wrap, uv_fs_t* req)\n     : wrap_(wrap),\n       req_(req),\n@@ -563,8 +471,7 @@ void AfterStat(uv_fs_t* req) {\n   FSReqAfterScope after(req_wrap, req);\n \n   if (after.Proceed()) {\n-    req_wrap->FillStatsArray(&req->statbuf);\n-    req_wrap->ResolveStat();\n+    req_wrap->ResolveStat(&req->statbuf);\n   }\n }\n \n@@ -751,7 +658,7 @@ inline FSReqBase* GetReqWrap(Environment* env, Local<Value> value) {\n   if (value->IsObject()) {\n     return Unwrap<FSReqBase>(value.As<Object>());\n   } else if (value->StrictEquals(env->fs_use_promises_symbol())) {\n-    return new FSReqPromise(env);\n+    return new FSReqPromise<double, v8::Float64Array>(env);\n   }\n   return nullptr;\n }\n@@ -893,7 +800,7 @@ static void Stat(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   const int argc = args.Length();\n-  CHECK_GE(argc, 1);\n+  CHECK_GE(argc, 2);\n \n   BufferValue path(env->isolate(), args[0]);\n   CHECK_NE(*path, nullptr);\n@@ -907,8 +814,8 @@ static void Stat(const FunctionCallbackInfo<Value>& args) {\n     FSReqWrapSync req_wrap_sync;\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"stat\", uv_fs_stat, *path);\n     if (err == 0) {\n-      FillStatsArray(env->fs_stats_field_array(),\n-                     static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+      node::FillGlobalStatsArray(env,\n+          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     }\n   }\n }\n@@ -917,7 +824,7 @@ static void LStat(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   const int argc = args.Length();\n-  CHECK_GE(argc, 1);\n+  CHECK_GE(argc, 2);\n \n   BufferValue path(env->isolate(), args[0]);\n   CHECK_NE(*path, nullptr);\n@@ -932,8 +839,8 @@ static void LStat(const FunctionCallbackInfo<Value>& args) {\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"lstat\", uv_fs_lstat,\n                        *path);\n     if (err == 0) {\n-      FillStatsArray(env->fs_stats_field_array(),\n-                     static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+      node::FillGlobalStatsArray(env,\n+          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     }\n   }\n }\n@@ -942,7 +849,7 @@ static void FStat(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   const int argc = args.Length();\n-  CHECK_GE(argc, 1);\n+  CHECK_GE(argc, 2);\n \n   CHECK(args[0]->IsInt32());\n   int fd = args[0].As<Int32>()->Value();\n@@ -956,8 +863,8 @@ static void FStat(const FunctionCallbackInfo<Value>& args) {\n     FSReqWrapSync req_wrap_sync;\n     int err = SyncCall(env, args[2], &req_wrap_sync, \"fstat\", uv_fs_fstat, fd);\n     if (err == 0) {\n-      FillStatsArray(env->fs_stats_field_array(),\n-                     static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n+      node::FillGlobalStatsArray(env,\n+          static_cast<const uv_stat_t*>(req_wrap_sync.req.ptr));\n     }\n   }\n }\n@@ -1908,6 +1815,11 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"mkdtemp\", Mkdtemp);\n \n+  target->Set(env->context(),\n+              FIXED_ONE_BYTE_STRING(env->isolate(), \"kFsStatsFieldsLength\"),\n+              Integer::New(env->isolate(), env->kFsStatsFieldsLength))\n+        .FromJust();\n+\n   target->Set(context,\n               FIXED_ONE_BYTE_STRING(env->isolate(), \"statValues\"),\n               env->fs_stats_field_array()->GetJSArray()).FromJust();"
        },
        {
            "sha": "d6c8aa443c39f46a6dcbbcd0f8f2bc70e592cf03",
            "filename": "src/node_file.h",
            "status": "modified",
            "additions": 52,
            "deletions": 12,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_file.h",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_file.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.h?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -61,10 +61,9 @@ class FSReqBase : public ReqWrap<uv_fs_t> {\n     return buffer_;\n   }\n \n-  virtual void FillStatsArray(const uv_stat_t* stat) = 0;\n   virtual void Reject(Local<Value> reject) = 0;\n   virtual void Resolve(Local<Value> value) = 0;\n-  virtual void ResolveStat() = 0;\n+  virtual void ResolveStat(const uv_stat_t* stat) = 0;\n   virtual void SetReturnValue(const FunctionCallbackInfo<Value>& args) = 0;\n \n   const char* syscall() const { return syscall_; }\n@@ -90,31 +89,72 @@ class FSReqWrap : public FSReqBase {\n   FSReqWrap(Environment* env, Local<Object> req)\n       : FSReqBase(env, req, AsyncWrap::PROVIDER_FSREQWRAP) { }\n \n-  void FillStatsArray(const uv_stat_t* stat) override;\n   void Reject(Local<Value> reject) override;\n   void Resolve(Local<Value> value) override;\n-  void ResolveStat() override;\n+  void ResolveStat(const uv_stat_t* stat) override;\n   void SetReturnValue(const FunctionCallbackInfo<Value>& args) override;\n \n  private:\n   DISALLOW_COPY_AND_ASSIGN(FSReqWrap);\n };\n \n+template <typename NativeT = double, typename V8T = v8::Float64Array>\n class FSReqPromise : public FSReqBase {\n  public:\n-  explicit FSReqPromise(Environment* env);\n+  explicit FSReqPromise(Environment* env)\n+      : FSReqBase(env,\n+                  env->fsreqpromise_constructor_template()\n+                      ->NewInstance(env->context()).ToLocalChecked(),\n+                  AsyncWrap::PROVIDER_FSREQPROMISE),\n+        stats_field_array_(env->isolate(), env->kFsStatsFieldsLength) {\n+    auto resolver = Promise::Resolver::New(env->context()).ToLocalChecked();\n+    object()->Set(env->context(), env->promise_string(),\n+                  resolver).FromJust();\n+  }\n \n-  ~FSReqPromise() override;\n+  ~FSReqPromise() override {\n+    // Validate that the promise was explicitly resolved or rejected.\n+    CHECK(finished_);\n+  }\n \n-  void FillStatsArray(const uv_stat_t* stat) override;\n-  void Reject(Local<Value> reject) override;\n-  void Resolve(Local<Value> value) override;\n-  void ResolveStat() override;\n-  void SetReturnValue(const FunctionCallbackInfo<Value>& args) override;\n+  void Reject(Local<Value> reject) override {\n+    finished_ = true;\n+    HandleScope scope(env()->isolate());\n+    InternalCallbackScope callback_scope(this);\n+    Local<Value> value =\n+        object()->Get(env()->context(),\n+                      env()->promise_string()).ToLocalChecked();\n+    Local<Promise::Resolver> resolver = value.As<Promise::Resolver>();\n+    resolver->Reject(env()->context(), reject).FromJust();\n+  }\n+\n+  void Resolve(Local<Value> value) override {\n+    finished_ = true;\n+    HandleScope scope(env()->isolate());\n+    InternalCallbackScope callback_scope(this);\n+    Local<Value> val =\n+        object()->Get(env()->context(),\n+                      env()->promise_string()).ToLocalChecked();\n+    Local<Promise::Resolver> resolver = val.As<Promise::Resolver>();\n+    resolver->Resolve(env()->context(), value).FromJust();\n+  }\n+\n+  void ResolveStat(const uv_stat_t* stat) override {\n+    node::FillStatsArray(&stats_field_array_, stat);\n+    Resolve(stats_field_array_.GetJSArray());\n+  }\n+\n+  void SetReturnValue(const FunctionCallbackInfo<Value>& args) override {\n+    Local<Value> val =\n+        object()->Get(env()->context(),\n+                      env()->promise_string()).ToLocalChecked();\n+    Local<Promise::Resolver> resolver = val.As<Promise::Resolver>();\n+    args.GetReturnValue().Set(resolver->GetPromise());\n+  }\n \n  private:\n   bool finished_ = false;\n-  AliasedBuffer<double, v8::Float64Array> stats_field_array_;\n+  AliasedBuffer<NativeT, V8T> stats_field_array_;\n   DISALLOW_COPY_AND_ASSIGN(FSReqPromise);\n };\n "
        },
        {
            "sha": "8cc1aa1a8fec407907a2d34b837e3b5ad58341aa",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 42,
            "deletions": 2,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -307,8 +307,48 @@ v8::Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                               const char* warning,\n                                               const char* deprecation_code);\n \n-void FillStatsArray(AliasedBuffer<double, v8::Float64Array>* fields_ptr,\n-                    const uv_stat_t* s, int offset = 0);\n+template <typename NativeT, typename V8T>\n+void FillStatsArray(AliasedBuffer<NativeT, V8T>* fields_ptr,\n+                    const uv_stat_t* s, int offset = 0) {\n+  AliasedBuffer<NativeT, V8T>& fields = *fields_ptr;\n+  fields[offset + 0] = s->st_dev;\n+  fields[offset + 1] = s->st_mode;\n+  fields[offset + 2] = s->st_nlink;\n+  fields[offset + 3] = s->st_uid;\n+  fields[offset + 4] = s->st_gid;\n+  fields[offset + 5] = s->st_rdev;\n+#if defined(__POSIX__)\n+  fields[offset + 6] = s->st_blksize;\n+#else\n+  fields[offset + 6] = -1;\n+#endif\n+  fields[offset + 7] = s->st_ino;\n+  fields[offset + 8] = s->st_size;\n+#if defined(__POSIX__)\n+  fields[offset + 9] = s->st_blocks;\n+#else\n+  fields[offset + 9] = -1;\n+#endif\n+// Dates.\n+// NO-LINT because the fields are 'long' and we just want to cast to `unsigned`\n+#define X(idx, name)                                                    \\\n+  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n+  fields[offset + idx] = ((unsigned long)(s->st_##name.tv_sec) * 1e3) + \\\n+  /* NOLINTNEXTLINE(runtime/int) */                                     \\\n+                ((unsigned long)(s->st_##name.tv_nsec) / 1e6);          \\\n+\n+  X(10, atim)\n+  X(11, mtim)\n+  X(12, ctim)\n+  X(13, birthtim)\n+#undef X\n+}\n+\n+inline void FillGlobalStatsArray(Environment* env,\n+                                 const uv_stat_t* s,\n+                                 int offset = 0) {\n+  node::FillStatsArray(env->fs_stats_field_array(), s, offset);\n+}\n \n void SetupProcessObject(Environment* env,\n                         int argc,"
        },
        {
            "sha": "2ff3af633ff35d3c6554a428530ba8ef7cfdf935",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7049a20068dc8a7e904b7cdd3d5b307b595dd3a/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=f7049a20068dc8a7e904b7cdd3d5b307b595dd3a",
            "patch": "@@ -107,10 +107,14 @@ void StatWatcher::Callback(uv_fs_poll_t* handle,\n   HandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(env->context());\n \n-  FillStatsArray(env->fs_stats_field_array(), curr);\n-  FillStatsArray(env->fs_stats_field_array(), prev, 14);\n-  Local<Value> arg = Integer::New(env->isolate(), status);\n-  wrap->MakeCallback(env->onchange_string(), 1, &arg);\n+  node::FillGlobalStatsArray(env, curr);\n+  node::FillGlobalStatsArray(env, prev, env->kFsStatsFieldsLength);\n+\n+  Local<Value> argv[2] {\n+    Integer::New(env->isolate(), status),\n+    env->fs_stats_field_array()->GetJSArray()\n+  };\n+  wrap->MakeCallback(env->onchange_string(), arraysize(argv), argv);\n }\n \n "
        }
    ],
    "stats": {
        "total": 331,
        "additions": 168,
        "deletions": 163
    }
}