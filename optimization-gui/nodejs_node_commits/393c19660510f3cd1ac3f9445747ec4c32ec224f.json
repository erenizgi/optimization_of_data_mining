{
    "author": "addaleax",
    "message": "worker: refactor thread id management\n\n- Assign thread IDs to `Environment` instances, rather than Workers.\n  This is more embedder-friendly than the current system, in which\n  all “main threads” (if there are multiple ones) would get the\n  id `0`.\n- Because that means that `isMainThread === (threadId === 0)` no longer\n  holds, refactor `isMainThread` into a separate entity. Implement it\n  in a way that allows for future extensibility, because we use\n  `isMainThread` in multiple different ways (determining whether there\n  is a parent thread; determining whether the current thread has control\n  of the current process; etc.).\n\nPR-URL: https://github.com/nodejs/node/pull/25796\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>",
    "sha": "393c19660510f3cd1ac3f9445747ec4c32ec224f",
    "files": [
        {
            "sha": "f28f4cd663598185f21494faa89378938bc4ddab",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -31,11 +31,10 @@ const { pathToFileURL } = require('url');\n \n const {\n   Worker: WorkerImpl,\n-  threadId\n+  threadId,\n+  isMainThread\n } = internalBinding('worker');\n \n-const isMainThread = threadId === 0;\n-\n const kHandle = Symbol('kHandle');\n const kPublicPort = Symbol('kPublicPort');\n const kDispose = Symbol('kDispose');"
        },
        {
            "sha": "22938df37cc41d3158620fe03cf065ba072e8e73",
            "filename": "src/api/environment.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fapi%2Fenvironment.cc",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fapi%2Fenvironment.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fapi%2Fenvironment.cc?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -133,7 +133,9 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   // options than the global parse call.\n   std::vector<std::string> args(argv, argv + argc);\n   std::vector<std::string> exec_args(exec_argv, exec_argv + exec_argc);\n-  Environment* env = new Environment(isolate_data, context);\n+  // TODO(addaleax): Provide more sensible flags, in an embedder-accessible way.\n+  Environment* env =\n+      new Environment(isolate_data, context, Environment::kIsMainThread);\n   env->Start(per_process::v8_is_profiling);\n   env->ProcessCliArgs(args, exec_args);\n   return env;"
        },
        {
            "sha": "0a47b7cfcae345a743eac4465dae3300d3f2cafe",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -647,17 +647,13 @@ inline void Environment::set_has_run_bootstrapping_code(bool value) {\n }\n \n inline bool Environment::is_main_thread() const {\n-  return thread_id_ == 0;\n+  return flags_ & kIsMainThread;\n }\n \n inline uint64_t Environment::thread_id() const {\n   return thread_id_;\n }\n \n-inline void Environment::set_thread_id(uint64_t id) {\n-  thread_id_ = id;\n-}\n-\n inline worker::Worker* Environment::worker_context() const {\n   return worker_context_;\n }"
        },
        {
            "sha": "3d4f39026b0ed9900626844a3e3f2ea1c3a3f29d",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -16,6 +16,7 @@\n \n #include <stdio.h>\n #include <algorithm>\n+#include <atomic>\n \n namespace node {\n \n@@ -166,8 +167,11 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n            0, nullptr).ToLocalChecked();\n }\n \n+static std::atomic<uint64_t> next_thread_id{0};\n+\n Environment::Environment(IsolateData* isolate_data,\n-                         Local<Context> context)\n+                         Local<Context> context,\n+                         Flags flags)\n     : isolate_(context->GetIsolate()),\n       isolate_data_(isolate_data),\n       immediate_info_(context->GetIsolate()),\n@@ -176,6 +180,8 @@ Environment::Environment(IsolateData* isolate_data,\n       should_abort_on_uncaught_toggle_(isolate_, 1),\n       trace_category_state_(isolate_, kTraceCategoryCount),\n       stream_base_state_(isolate_, StreamBase::kNumStreamBaseStateFields),\n+      flags_(flags),\n+      thread_id_(next_thread_id++),\n       fs_stats_field_array_(isolate_, kFsStatsBufferLength),\n       fs_stats_field_bigint_array_(isolate_, kFsStatsBufferLength),\n       context_(context->GetIsolate(), context) {"
        },
        {
            "sha": "25f1cd0689b631ad15b48b95532307125ca43ae0",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -595,6 +595,11 @@ class Environment {\n     DISALLOW_COPY_AND_ASSIGN(TickInfo);\n   };\n \n+  enum Flags {\n+    kNoFlags = 0,\n+    kIsMainThread = 1\n+  };\n+\n   static inline Environment* GetCurrent(v8::Isolate* isolate);\n   static inline Environment* GetCurrent(v8::Local<v8::Context> context);\n   static inline Environment* GetCurrent(\n@@ -608,7 +613,8 @@ class Environment {\n   static inline Environment* GetThreadLocalEnv();\n \n   Environment(IsolateData* isolate_data,\n-              v8::Local<v8::Context> context);\n+              v8::Local<v8::Context> context,\n+              Flags flags = Flags());\n   ~Environment();\n \n   void Start(bool start_profiler_idle_notifier);\n@@ -761,7 +767,6 @@ class Environment {\n \n   inline bool is_main_thread() const;\n   inline uint64_t thread_id() const;\n-  inline void set_thread_id(uint64_t id);\n   inline worker::Worker* worker_context() const;\n   inline void set_worker_context(worker::Worker* context);\n   inline void add_sub_worker_context(worker::Worker* context);\n@@ -1005,7 +1010,8 @@ class Environment {\n \n   bool has_run_bootstrapping_code_ = false;\n   bool can_call_into_js_ = true;\n-  uint64_t thread_id_ = 0;\n+  Flags flags_;\n+  uint64_t thread_id_;\n   std::unordered_set<worker::Worker*> sub_worker_contexts_;\n \n   static void* const kNodeContextTagPtr;"
        },
        {
            "sha": "d3a3d299ac52689b015d6feaf065c908c7a3323c",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -743,7 +743,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   HandleScope handle_scope(isolate);\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n-  Environment env(isolate_data, context);\n+  Environment env(isolate_data, context, Environment::kIsMainThread);\n   env.Start(per_process::v8_is_profiling);\n   env.ProcessCliArgs(args, exec_args);\n "
        },
        {
            "sha": "d457ab0c3e1ff249d5ee42f808a155605b47ced8",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 23,
            "deletions": 21,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/393c19660510f3cd1ac3f9445747ec4c32ec224f/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=393c19660510f3cd1ac3f9445747ec4c32ec224f",
            "patch": "@@ -13,6 +13,7 @@\n \n using node::options_parser::kDisallowedInEnvironment;\n using v8::ArrayBuffer;\n+using v8::Boolean;\n using v8::Context;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n@@ -33,9 +34,6 @@ namespace worker {\n \n namespace {\n \n-uint64_t next_thread_id = 1;\n-Mutex next_thread_id_mutex;\n-\n #if NODE_USE_V8_PLATFORM && HAVE_INSPECTOR\n void StartWorkerInspector(Environment* child, const std::string& url) {\n   child->inspector_agent()->Start(url,\n@@ -74,17 +72,7 @@ Worker::Worker(Environment* env,\n                const std::string& url,\n                std::shared_ptr<PerIsolateOptions> per_isolate_opts)\n     : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_WORKER), url_(url) {\n-  // Generate a new thread id.\n-  {\n-    Mutex::ScopedLock next_thread_id_lock(next_thread_id_mutex);\n-    thread_id_ = next_thread_id++;\n-  }\n-\n-  Debug(this, \"Creating worker with id %llu\", thread_id_);\n-  wrap->Set(env->context(),\n-            env->thread_id_string(),\n-            Number::New(env->isolate(),\n-                        static_cast<double>(thread_id_))).FromJust();\n+  Debug(this, \"Creating new worker instance at %p\", static_cast<void*>(this));\n \n   // Set up everything that needs to be set up in the parent environment.\n   parent_port_ = MessagePort::New(env, env->context());\n@@ -130,7 +118,7 @@ Worker::Worker(Environment* env,\n     CHECK_NE(env_, nullptr);\n     env_->set_abort_on_uncaught_exception(false);\n     env_->set_worker_context(this);\n-    env_->set_thread_id(thread_id_);\n+    thread_id_ = env_->thread_id();\n \n     env_->Start(env->profiler_idle_notifier_started());\n     env_->ProcessCliArgs(std::vector<std::string>{},\n@@ -142,7 +130,15 @@ Worker::Worker(Environment* env,\n   // The new isolate won't be bothered on this thread again.\n   isolate_->DiscardThreadSpecificMetadata();\n \n-  Debug(this, \"Set up worker with id %llu\", thread_id_);\n+  wrap->Set(env->context(),\n+            env->thread_id_string(),\n+            Number::New(env->isolate(), static_cast<double>(thread_id_)))\n+      .FromJust();\n+\n+  Debug(this,\n+        \"Set up worker at %p with id %llu\",\n+        static_cast<void*>(this),\n+        thread_id_);\n }\n \n bool Worker::is_stopped() const {\n@@ -562,11 +558,17 @@ void InitWorker(Local<Object> target,\n \n   env->SetMethod(target, \"getEnvMessagePort\", GetEnvMessagePort);\n \n-  auto thread_id_string = FIXED_ONE_BYTE_STRING(env->isolate(), \"threadId\");\n-  target->Set(env->context(),\n-              thread_id_string,\n-              Number::New(env->isolate(),\n-                          static_cast<double>(env->thread_id()))).FromJust();\n+  target\n+      ->Set(env->context(),\n+            env->thread_id_string(),\n+            Number::New(env->isolate(), static_cast<double>(env->thread_id())))\n+      .FromJust();\n+\n+  target\n+      ->Set(env->context(),\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"isMainThread\"),\n+            Boolean::New(env->isolate(), env->is_main_thread()))\n+      .FromJust();\n }\n \n }  // anonymous namespace"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 46,
        "deletions": 35
    }
}