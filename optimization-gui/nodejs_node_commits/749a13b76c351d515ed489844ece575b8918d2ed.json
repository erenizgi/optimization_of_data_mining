{
    "author": "addaleax",
    "message": "worker: support MessagePort passing in messages\n\nSupport passing `MessagePort` instances through other `MessagePort`s,\nas expected by the `MessagePort` spec.\n\nThanks to Stephen Belanger for reviewing this change in its original PR.\n\nRefs: https://github.com/ayojs/ayo/pull/106\n\nPR-URL: https://github.com/nodejs/node/pull/20876\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "749a13b76c351d515ed489844ece575b8918d2ed",
    "files": [
        {
            "sha": "0a49757da3e39e5fe4a5d251ee1efec1b93157c1",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -629,6 +629,12 @@ An operation outside the bounds of a `Buffer` was attempted.\n An attempt has been made to create a `Buffer` larger than the maximum allowed\n size.\n \n+<a id=\"ERR_CANNOT_TRANSFER_OBJECT\"></a>\n+### ERR_CANNOT_TRANSFER_OBJECT\n+\n+The value passed to `postMessage()` contained an object that is not supported\n+for transferring.\n+\n <a id=\"ERR_CANNOT_WATCH_SIGINT\"></a>\n ### ERR_CANNOT_WATCH_SIGINT\n \n@@ -1294,6 +1300,12 @@ strict compliance with the API specification (which in some cases may accept\n `func(undefined)` and `func()` are treated identically, and the\n [`ERR_INVALID_ARG_TYPE`][] error code may be used instead.\n \n+<a id=\"ERR_MISSING_MESSAGE_PORT_IN_TRANSFER_LIST\"></a>\n+### ERR_MISSING_MESSAGE_PORT_IN_TRANSFER_LIST\n+\n+A `MessagePort` was found in the object passed to a `postMessage()` call,\n+but not provided in the `transferList` for that call.\n+\n <a id=\"ERR_MISSING_MODULE\"></a>\n ### ERR_MISSING_MODULE\n "
        },
        {
            "sha": "6a391c5a9e3b19917fa33303ced251ab57be3b5e",
            "filename": "doc/api/worker.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/doc%2Fapi%2Fworker.md",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/doc%2Fapi%2Fworker.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker.md?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -83,7 +83,7 @@ the [HTML structured clone algorithm][]. In particular, it may contain circular\n references and objects like typed arrays that the `JSON` API is not able\n to stringify.\n \n-`transferList` may be a list of `ArrayBuffer` objects.\n+`transferList` may be a list of `ArrayBuffer` and `MessagePort` objects.\n After transferring, they will not be usable on the sending side of the channel\n anymore (even if they are not contained in `value`).\n "
        },
        {
            "sha": "9cadb0e18533cabe33d71dc6d5a5acfc0243553f",
            "filename": "src/node_errors.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_errors.h",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_errors.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.h?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -23,6 +23,7 @@ namespace node {\n #define ERRORS_WITH_CODE(V)                                                  \\\n   V(ERR_BUFFER_OUT_OF_BOUNDS, RangeError)                                    \\\n   V(ERR_BUFFER_TOO_LARGE, Error)                                             \\\n+  V(ERR_CANNOT_TRANSFER_OBJECT, TypeError)                                   \\\n   V(ERR_CLOSED_MESSAGE_PORT, Error)                                          \\\n   V(ERR_CONSTRUCT_CALL_REQUIRED, Error)                                      \\\n   V(ERR_INDEX_OUT_OF_RANGE, RangeError)                                      \\\n@@ -31,6 +32,7 @@ namespace node {\n   V(ERR_INVALID_TRANSFER_OBJECT, TypeError)                                  \\\n   V(ERR_MEMORY_ALLOCATION_FAILED, Error)                                     \\\n   V(ERR_MISSING_ARGS, TypeError)                                             \\\n+  V(ERR_MISSING_MESSAGE_PORT_IN_TRANSFER_LIST, TypeError)                    \\\n   V(ERR_MISSING_MODULE, Error)                                               \\\n   V(ERR_SCRIPT_EXECUTION_INTERRUPTED, Error)                                 \\\n   V(ERR_SCRIPT_EXECUTION_TIMEOUT, Error)                                     \\\n@@ -57,11 +59,14 @@ namespace node {\n // Errors with predefined static messages\n \n #define PREDEFINED_ERROR_MESSAGES(V)                                         \\\n+  V(ERR_CANNOT_TRANSFER_OBJECT, \"Cannot transfer object of unsupported type\")\\\n   V(ERR_CLOSED_MESSAGE_PORT, \"Cannot send data on closed MessagePort\")       \\\n   V(ERR_CONSTRUCT_CALL_REQUIRED, \"Cannot call constructor without `new`\")    \\\n   V(ERR_INDEX_OUT_OF_RANGE, \"Index out of range\")                            \\\n   V(ERR_INVALID_TRANSFER_OBJECT, \"Found invalid object in transferList\")     \\\n   V(ERR_MEMORY_ALLOCATION_FAILED, \"Failed to allocate memory\")               \\\n+  V(ERR_MISSING_MESSAGE_PORT_IN_TRANSFER_LIST,                               \\\n+    \"MessagePort was found in message but not listed in transferList\")       \\\n   V(ERR_SCRIPT_EXECUTION_INTERRUPTED,                                        \\\n     \"Script execution was interrupted by `SIGINT`\")\n "
        },
        {
            "sha": "1c6551e0969f3e488ac8ca4b0fba8e1343f11728",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 76,
            "deletions": 4,
            "changes": 80,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -41,14 +41,27 @@ namespace {\n // `MessagePort`s and `SharedArrayBuffer`s, and make new JS objects out of them.\n class DeserializerDelegate : public ValueDeserializer::Delegate {\n  public:\n-  DeserializerDelegate(Message* m, Environment* env)\n-    : env_(env), msg_(m) {}\n+  DeserializerDelegate(Message* m,\n+                       Environment* env,\n+                       const std::vector<MessagePort*>& message_ports)\n+    : env_(env), msg_(m), message_ports_(message_ports) {}\n+\n+  MaybeLocal<Object> ReadHostObject(Isolate* isolate) override {\n+    // Currently, only MessagePort hosts objects are supported, so identifying\n+    // by the index in the message's MessagePort array is sufficient.\n+    uint32_t id;\n+    if (!deserializer->ReadUint32(&id))\n+      return MaybeLocal<Object>();\n+    CHECK_LE(id, message_ports_.size());\n+    return message_ports_[id]->object();\n+  };\n \n   ValueDeserializer* deserializer = nullptr;\n \n  private:\n   Environment* env_;\n   Message* msg_;\n+  const std::vector<MessagePort*>& message_ports_;\n };\n \n }  // anonymous namespace\n@@ -58,7 +71,23 @@ MaybeLocal<Value> Message::Deserialize(Environment* env,\n   EscapableHandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(context);\n \n-  DeserializerDelegate delegate(this, env);\n+  // Create all necessary MessagePort handles.\n+  std::vector<MessagePort*> ports(message_ports_.size());\n+  for (uint32_t i = 0; i < message_ports_.size(); ++i) {\n+    ports[i] = MessagePort::New(env,\n+                                context,\n+                                std::move(message_ports_[i]));\n+    if (ports[i] == nullptr) {\n+      for (MessagePort* port : ports) {\n+        // This will eventually release the MessagePort object itself.\n+        port->Close();\n+      }\n+      return MaybeLocal<Value>();\n+    }\n+  }\n+  message_ports_.clear();\n+\n+  DeserializerDelegate delegate(this, env, ports);\n   ValueDeserializer deserializer(\n       env->isolate(),\n       reinterpret_cast<const uint8_t*>(main_message_buf_.data),\n@@ -83,6 +112,10 @@ MaybeLocal<Value> Message::Deserialize(Environment* env,\n       deserializer.ReadValue(context).FromMaybe(Local<Value>()));\n }\n \n+void Message::AddMessagePort(std::unique_ptr<MessagePortData>&& data) {\n+  message_ports_.emplace_back(std::move(data));\n+}\n+\n namespace {\n \n // This tells V8 how to serialize objects that it does not understand\n@@ -97,12 +130,43 @@ class SerializerDelegate : public ValueSerializer::Delegate {\n     env_->isolate()->ThrowException(Exception::Error(message));\n   }\n \n+  Maybe<bool> WriteHostObject(Isolate* isolate, Local<Object> object) override {\n+    if (env_->message_port_constructor_template()->HasInstance(object)) {\n+      return WriteMessagePort(Unwrap<MessagePort>(object));\n+    }\n+\n+    THROW_ERR_CANNOT_TRANSFER_OBJECT(env_);\n+    return Nothing<bool>();\n+  }\n+\n+  void Finish() {\n+    // Only close the MessagePort handles and actually transfer them\n+    // once we know that serialization succeeded.\n+    for (MessagePort* port : ports_) {\n+      port->Close();\n+      msg_->AddMessagePort(port->Detach());\n+    }\n+  }\n+\n   ValueSerializer* serializer = nullptr;\n \n  private:\n+  Maybe<bool> WriteMessagePort(MessagePort* port) {\n+    for (uint32_t i = 0; i < ports_.size(); i++) {\n+      if (ports_[i] == port) {\n+        serializer->WriteUint32(i);\n+        return Just(true);\n+      }\n+    }\n+\n+    THROW_ERR_MISSING_MESSAGE_PORT_IN_TRANSFER_LIST(env_);\n+    return Nothing<bool>();\n+  }\n+\n   Environment* env_;\n   Local<Context> context_;\n   Message* msg_;\n+  std::vector<MessagePort*> ports_;\n \n   friend class worker::Message;\n };\n@@ -131,7 +195,7 @@ Maybe<bool> Message::Serialize(Environment* env,\n       Local<Value> entry;\n       if (!transfer_list->Get(context, i).ToLocal(&entry))\n         return Nothing<bool>();\n-      // Currently, we support ArrayBuffers.\n+      // Currently, we support ArrayBuffers and MessagePorts.\n       if (entry->IsArrayBuffer()) {\n         Local<ArrayBuffer> ab = entry.As<ArrayBuffer>();\n         // If we cannot render the ArrayBuffer unusable in this Isolate and\n@@ -144,6 +208,12 @@ Maybe<bool> Message::Serialize(Environment* env,\n         array_buffers.push_back(ab);\n         serializer.TransferArrayBuffer(id, ab);\n         continue;\n+      } else if (env->message_port_constructor_template()\n+                    ->HasInstance(entry)) {\n+        MessagePort* port = Unwrap<MessagePort>(entry.As<Object>());\n+        CHECK_NE(port, nullptr);\n+        delegate.ports_.push_back(port);\n+        continue;\n       }\n \n       THROW_ERR_INVALID_TRANSFER_OBJECT(env);\n@@ -167,6 +237,8 @@ Maybe<bool> Message::Serialize(Environment* env,\n                                contents.ByteLength() });\n   }\n \n+  delegate.Finish();\n+\n   // The serializer gave us a buffer allocated using `malloc()`.\n   std::pair<uint8_t*, size_t> data = serializer.Release();\n   main_message_buf_ ="
        },
        {
            "sha": "074267bb67c2ddb6ca74437ced1ca87d9993684a",
            "filename": "src/node_messaging.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_messaging.h",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/src%2Fnode_messaging.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.h?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -37,9 +37,14 @@ class Message {\n                             v8::Local<v8::Value> input,\n                             v8::Local<v8::Value> transfer_list);\n \n+  // Internal method of Message that is called once serialization finishes\n+  // and that transfers ownership of `data` to this message.\n+  void AddMessagePort(std::unique_ptr<MessagePortData>&& data);\n+\n  private:\n   MallocedBuffer<char> main_message_buf_;\n   std::vector<MallocedBuffer<char>> array_buffer_contents_;\n+  std::vector<std::unique_ptr<MessagePortData>> message_ports_;\n \n   friend class MessagePort;\n };"
        },
        {
            "sha": "a7490b3678ac748d403f05dc47955a8eb92cfd58",
            "filename": "test/parallel/test-message-port-message-port-transferring.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/749a13b76c351d515ed489844ece575b8918d2ed/test%2Fparallel%2Ftest-message-port-message-port-transferring.js",
            "raw_url": "https://github.com/nodejs/node/raw/749a13b76c351d515ed489844ece575b8918d2ed/test%2Fparallel%2Ftest-message-port-message-port-transferring.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-message-port-message-port-transferring.js?ref=749a13b76c351d515ed489844ece575b8918d2ed",
            "patch": "@@ -0,0 +1,23 @@\n+// Flags: --experimental-worker\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+\n+const { MessageChannel } = require('worker');\n+\n+{\n+  const { port1: basePort1, port2: basePort2 } = new MessageChannel();\n+  const {\n+    port1: transferredPort1, port2: transferredPort2\n+  } = new MessageChannel();\n+\n+  basePort1.postMessage({ transferredPort1 }, [ transferredPort1 ]);\n+  basePort2.on('message', common.mustCall(({ transferredPort1 }) => {\n+    transferredPort1.postMessage('foobar');\n+    transferredPort2.on('message', common.mustCall((msg) => {\n+      assert.strictEqual(msg, 'foobar');\n+      transferredPort1.close(common.mustCall());\n+      basePort1.close(common.mustCall());\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 122,
        "deletions": 5
    }
}