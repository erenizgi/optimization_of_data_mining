{
    "author": "joyeecheung",
    "message": "src: move version metadata into node_metadata{.h, .cc}\n\nThis patch moves the computation of version metadata from node.cc\ninto node_metadata{.h, .cc}, and creates a macro that can be\nused to iterate over the available version keys (v8, uv, .etc).\nThis makes the code clearer as now we no longer need to add\nall the headers in node.cc just to compute the versions, and\nmakes it easier to reuse the version definitions.\n\nPR-URL: https://github.com/nodejs/node/pull/24774\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c",
    "files": [
        {
            "sha": "1348ec861daf06f3ed33bc1e452bedb9a53f9752",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c",
            "patch": "@@ -359,6 +359,7 @@\n         'src/node_http2.cc',\n         'src/node_i18n.cc',\n         'src/node_messaging.cc',\n+        'src/node_metadata.cc',\n         'src/node_native_module.cc',\n         'src/node_options.cc',\n         'src/node_os.cc',\n@@ -430,6 +431,7 @@\n         'src/node_i18n.h',\n         'src/node_internals.h',\n         'src/node_messaging.h',\n+        'src/node_metadata.h',\n         'src/node_mutex.h',\n         'src/node_native_module.h',\n         'src/node_object_wrap.h',"
        },
        {
            "sha": "ad0afd437dd4b5e8d58374198ba0c4620df1a149",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 90,
            "changes": 99,
            "blob_url": "https://github.com/nodejs/node/blob/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c",
            "patch": "@@ -25,6 +25,7 @@\n #include \"node_context_data.h\"\n #include \"node_errors.h\"\n #include \"node_internals.h\"\n+#include \"node_metadata.h\"\n #include \"node_native_module.h\"\n #include \"node_perf.h\"\n #include \"node_platform.h\"\n@@ -48,16 +49,9 @@\n #include \"node_dtrace.h\"\n #endif\n \n-#include \"ares.h\"\n #include \"async_wrap-inl.h\"\n #include \"env-inl.h\"\n #include \"handle_wrap.h\"\n-#ifdef NODE_EXPERIMENTAL_HTTP\n-# include \"llhttp.h\"\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n-# include \"http_parser.h\"\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n-#include \"nghttp2/nghttp2ver.h\"\n #include \"req_wrap-inl.h\"\n #include \"string_bytes.h\"\n #include \"tracing/agent.h\"\n@@ -68,7 +62,6 @@\n #include \"libplatform/libplatform.h\"\n #endif  // NODE_USE_V8_PLATFORM\n #include \"v8-profiler.h\"\n-#include \"zlib.h\"\n \n #ifdef NODE_ENABLE_VTUNE_PROFILING\n #include \"../deps/v8/src/third_party/vtune/v8-vtune.h\"\n@@ -156,22 +149,6 @@ using v8::Value;\n \n static bool v8_is_profiling = false;\n \n-#ifdef NODE_EXPERIMENTAL_HTTP\n-static const char llhttp_version[] =\n-    NODE_STRINGIFY(LLHTTP_VERSION_MAJOR)\n-    \".\"\n-    NODE_STRINGIFY(LLHTTP_VERSION_MINOR)\n-    \".\"\n-    NODE_STRINGIFY(LLHTTP_VERSION_PATCH);\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n-static const char http_parser_version[] =\n-    NODE_STRINGIFY(HTTP_PARSER_VERSION_MAJOR)\n-    \".\"\n-    NODE_STRINGIFY(HTTP_PARSER_VERSION_MINOR)\n-    \".\"\n-    NODE_STRINGIFY(HTTP_PARSER_VERSION_PATCH);\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n-\n // Bit flag used to track security reverts (see node_revert.h)\n unsigned int reverted = 0;\n \n@@ -210,27 +187,12 @@ class NodeTraceStateObserver :\n     auto trace_process = tracing::TracedValue::Create();\n     trace_process->BeginDictionary(\"versions\");\n \n-#ifdef NODE_EXPERIMENTAL_HTTP\n-    trace_process->SetString(\"llhttp\", llhttp_version);\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n-    trace_process->SetString(\"http_parser\", http_parser_version);\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n-\n-    const char node_napi_version[] = NODE_STRINGIFY(NAPI_VERSION);\n-    const char node_modules_version[] = NODE_STRINGIFY(NODE_MODULE_VERSION);\n+#define V(key)                                                                 \\\n+  trace_process->SetString(#key, per_process::metadata.versions.key.c_str());\n \n-    trace_process->SetString(\"node\", NODE_VERSION_STRING);\n-    trace_process->SetString(\"v8\", V8::GetVersion());\n-    trace_process->SetString(\"uv\", uv_version_string());\n-    trace_process->SetString(\"zlib\", ZLIB_VERSION);\n-    trace_process->SetString(\"ares\", ARES_VERSION_STR);\n-    trace_process->SetString(\"modules\", node_modules_version);\n-    trace_process->SetString(\"nghttp2\", NGHTTP2_VERSION);\n-    trace_process->SetString(\"napi\", node_napi_version);\n+    NODE_VERSIONS_KEYS(V)\n+#undef V\n \n-#if HAVE_OPENSSL\n-    trace_process->SetString(\"openssl\", crypto::GetOpenSSLVersion());\n-#endif\n     trace_process->EndDictionary();\n \n     trace_process->SetString(\"arch\", NODE_ARCH);\n@@ -943,53 +905,10 @@ void SetupProcessObject(Environment* env,\n   Local<Object> versions = Object::New(env->isolate());\n   READONLY_PROPERTY(process, \"versions\", versions);\n \n-#ifdef NODE_EXPERIMENTAL_HTTP\n-  READONLY_PROPERTY(versions,\n-                    \"llhttp\",\n-                    FIXED_ONE_BYTE_STRING(env->isolate(), llhttp_version));\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n-  READONLY_PROPERTY(versions,\n-                    \"http_parser\",\n-                    FIXED_ONE_BYTE_STRING(env->isolate(), http_parser_version));\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n-\n-  // +1 to get rid of the leading 'v'\n-  READONLY_PROPERTY(versions,\n-                    \"node\",\n-                    OneByteString(env->isolate(), NODE_VERSION + 1));\n-  READONLY_PROPERTY(versions,\n-                    \"v8\",\n-                    OneByteString(env->isolate(), V8::GetVersion()));\n-  READONLY_PROPERTY(versions,\n-                    \"uv\",\n-                    OneByteString(env->isolate(), uv_version_string()));\n-  READONLY_PROPERTY(versions,\n-                    \"zlib\",\n-                    FIXED_ONE_BYTE_STRING(env->isolate(), ZLIB_VERSION));\n-  READONLY_PROPERTY(versions,\n-                    \"ares\",\n-                    FIXED_ONE_BYTE_STRING(env->isolate(), ARES_VERSION_STR));\n-\n-  const char node_modules_version[] = NODE_STRINGIFY(NODE_MODULE_VERSION);\n-  READONLY_PROPERTY(\n-      versions,\n-      \"modules\",\n-      FIXED_ONE_BYTE_STRING(env->isolate(), node_modules_version));\n-  READONLY_PROPERTY(versions,\n-                    \"nghttp2\",\n-                    FIXED_ONE_BYTE_STRING(env->isolate(), NGHTTP2_VERSION));\n-  const char node_napi_version[] = NODE_STRINGIFY(NAPI_VERSION);\n-  READONLY_PROPERTY(\n-      versions,\n-      \"napi\",\n-      FIXED_ONE_BYTE_STRING(env->isolate(), node_napi_version));\n-\n-#if HAVE_OPENSSL\n-  READONLY_PROPERTY(\n-      versions,\n-      \"openssl\",\n-      OneByteString(env->isolate(), crypto::GetOpenSSLVersion().c_str()));\n-#endif\n+#define V(key)                                                                 \\\n+  READONLY_STRING_PROPERTY(versions, #key, per_process::metadata.versions.key);\n+  NODE_VERSIONS_KEYS(V)\n+#undef V\n \n   // process.arch\n   READONLY_PROPERTY(process, \"arch\", OneByteString(env->isolate(), NODE_ARCH));"
        },
        {
            "sha": "1bf2fcfce9561c5c1065522d0399c8f37acdf9e3",
            "filename": "src/node_metadata.cc",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/nodejs/node/blob/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.cc?ref=d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c",
            "patch": "@@ -0,0 +1,49 @@\n+#include \"node_metadata.h\"\n+#include \"ares.h\"\n+#include \"nghttp2/nghttp2ver.h\"\n+#include \"node.h\"\n+#include \"util.h\"\n+#include \"uv.h\"\n+#include \"v8.h\"\n+#include \"zlib.h\"\n+\n+#if HAVE_OPENSSL\n+#include \"node_crypto.h\"\n+#endif\n+\n+#ifdef NODE_EXPERIMENTAL_HTTP\n+#include \"llhttp.h\"\n+#else /* !NODE_EXPERIMENTAL_HTTP */\n+#include \"http_parser.h\"\n+#endif /* NODE_EXPERIMENTAL_HTTP */\n+\n+namespace node {\n+\n+namespace per_process {\n+Metadata metadata;\n+}\n+\n+Metadata::Versions::Versions() {\n+  node = NODE_VERSION_STRING;\n+  v8 = v8::V8::GetVersion();\n+  uv = uv_version_string();\n+  zlib = ZLIB_VERSION;\n+  ares = ARES_VERSION_STR;\n+  modules = NODE_STRINGIFY(NODE_MODULE_VERSION);\n+  nghttp2 = NGHTTP2_VERSION;\n+  napi = NODE_STRINGIFY(NAPI_VERSION);\n+\n+#ifdef NODE_EXPERIMENTAL_HTTP\n+  llhttp = NODE_STRINGIFY(LLHTTP_VERSION_MAJOR) \".\" NODE_STRINGIFY(\n+      LLHTTP_VERSION_MINOR) \".\" NODE_STRINGIFY(LLHTTP_VERSION_PATCH);\n+#else  /* !NODE_EXPERIMENTAL_HTTP */\n+  http_parser = NODE_STRINGIFY(HTTP_PARSER_VERSION_MAJOR) \".\" NODE_STRINGIFY(\n+      HTTP_PARSER_VERSION_MINOR) \".\" NODE_STRINGIFY(HTTP_PARSER_VERSION_PATCH);\n+#endif /* NODE_EXPERIMENTAL_HTTP */\n+\n+#if HAVE_OPENSSL\n+  openssl = crypto::GetOpenSSLVersion();\n+#endif\n+}\n+\n+}  // namespace node"
        },
        {
            "sha": "0f32fcf21d1600bb09015365ce17a4b35db021e8",
            "filename": "src/node_metadata.h",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/nodejs/node/blob/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode_metadata.h",
            "raw_url": "https://github.com/nodejs/node/raw/d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c/src%2Fnode_metadata.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.h?ref=d17d7bdf4e3ba0e2458abcf8056e9b9ab824a04c",
            "patch": "@@ -0,0 +1,57 @@\n+#ifndef SRC_NODE_METADATA_H_\n+#define SRC_NODE_METADATA_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include <string>\n+\n+namespace node {\n+\n+#define NODE_VERSIONS_KEYS_BASE(V)                                             \\\n+  V(node)                                                                      \\\n+  V(v8)                                                                        \\\n+  V(uv)                                                                        \\\n+  V(zlib)                                                                      \\\n+  V(ares)                                                                      \\\n+  V(modules)                                                                   \\\n+  V(nghttp2)                                                                   \\\n+  V(napi)\n+\n+#ifdef NODE_EXPERIMENTAL_HTTP\n+#define NODE_VERSIONS_KEY_HTTP(V) V(llhttp)\n+#else /* !NODE_EXPERIMENTAL_HTTP */\n+#define NODE_VERSIONS_KEY_HTTP(V) V(http_parser)\n+#endif /* NODE_EXPERIMENTAL_HTTP */\n+\n+#if HAVE_OPENSSL\n+#define NODE_VERSIONS_KEY_CRYPTO(V) V(openssl)\n+#else\n+#define NODE_VERSIONS_KEY_CRYPTO(V)\n+#endif\n+\n+#define NODE_VERSIONS_KEYS(V)                                                  \\\n+  NODE_VERSIONS_KEYS_BASE(V)                                                   \\\n+  NODE_VERSIONS_KEY_HTTP(V)                                                    \\\n+  NODE_VERSIONS_KEY_CRYPTO(V)\n+\n+class Metadata {\n+ public:\n+  struct Versions {\n+    Versions();\n+#define V(key) std::string key;\n+    NODE_VERSIONS_KEYS(V)\n+#undef V\n+  };\n+\n+  Versions versions;\n+};\n+\n+// Per-process global\n+namespace per_process {\n+extern Metadata metadata;\n+}\n+\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+#endif  // SRC_NODE_METADATA_H_"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 117,
        "deletions": 90
    }
}