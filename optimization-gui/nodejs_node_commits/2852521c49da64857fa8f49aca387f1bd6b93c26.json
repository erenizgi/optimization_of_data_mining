{
    "author": "pietermees",
    "message": "http2: emit session connect on next tick\n\nPR-URL: https://github.com/nodejs/node/pull/19842\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "2852521c49da64857fa8f49aca387f1bd6b93c26",
    "files": [
        {
            "sha": "0aa9904001a34086667a1e1ba1bcf82fdd1bcca8",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2852521c49da64857fa8f49aca387f1bd6b93c26/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/2852521c49da64857fa8f49aca387f1bd6b93c26/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=2852521c49da64857fa8f49aca387f1bd6b93c26",
            "patch": "@@ -774,7 +774,7 @@ function setupHandle(socket, type, options) {\n   // core will check for session.destroyed before progressing, this\n   // ensures that those at l`east get cleared out.\n   if (this.destroyed) {\n-    this.emit('connect', this, socket);\n+    process.nextTick(emit, this, 'connect', this, socket);\n     return;\n   }\n   debug(`Http2Session ${sessionName(type)}: setting up session handle`);\n@@ -816,7 +816,7 @@ function setupHandle(socket, type, options) {\n     options.settings : {};\n \n   this.settings(settings);\n-  this.emit('connect', this, socket);\n+  process.nextTick(emit, this, 'connect', this, socket);\n }\n \n // Emits a close event followed by an error event if err is truthy. Used"
        },
        {
            "sha": "252efa1229ad85e1fe15fc658edb134553b39e5a",
            "filename": "test/parallel/test-http2-connect.js",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/2852521c49da64857fa8f49aca387f1bd6b93c26/test%2Fparallel%2Ftest-http2-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/2852521c49da64857fa8f49aca387f1bd6b93c26/test%2Fparallel%2Ftest-http2-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-connect.js?ref=2852521c49da64857fa8f49aca387f1bd6b93c26",
            "patch": "@@ -4,6 +4,9 @@ const { mustCall, hasCrypto, skip, expectsError } = require('../common');\n if (!hasCrypto)\n   skip('missing crypto');\n const { createServer, connect } = require('http2');\n+const { connect: netConnect } = require('net');\n+\n+// check for session connect callback and event\n {\n   const server = createServer();\n   server.listen(0, mustCall(() => {\n@@ -30,6 +33,28 @@ const { createServer, connect } = require('http2');\n   }));\n }\n \n+// check for session connect callback on already connected socket\n+{\n+  const server = createServer();\n+  server.listen(0, mustCall(() => {\n+    const { port } = server.address();\n+\n+    const onSocketConnect = () => {\n+      const authority = `http://localhost:${port}`;\n+      const createConnection = mustCall(() => socket);\n+      const options = { createConnection };\n+      connect(authority, options, mustCall(onSessionConnect));\n+    };\n+\n+    const onSessionConnect = (session) => {\n+      session.close();\n+      server.close();\n+    };\n+\n+    const socket = netConnect(port, mustCall(onSocketConnect));\n+  }));\n+}\n+\n // check for https as protocol\n {\n   const authority = 'https://localhost';"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 27,
        "deletions": 2
    }
}