{
    "author": "ofrobots",
    "message": "async_hooks: rename PromiseWrap.parentId\n\nRename the `parentId` property on the PromiseWrap object to a\n`isChainedPromise` property. The former wasn't quite useful as it was\nalways defined to be the same value as the trigger id available in the\ninit hook. Instead rename the property to be closer to the information\nit communicates: whether the promise is a chained promise or not.\n\nPR-URL: https://github.com/nodejs/node/pull/18633\nFixes: https://github.com/nodejs/node/issues/18470\nReviewed-By: Andreas Madsen <amwebdk@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "9f6a56590129370f8b17c133f15a63e3832fa3cc",
    "files": [
        {
            "sha": "a96fd0429300819827e3a5e3a4299f5eecf07476",
            "filename": "doc/api/async_hooks.md",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9f6a56590129370f8b17c133f15a63e3832fa3cc/doc%2Fapi%2Fasync_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/9f6a56590129370f8b17c133f15a63e3832fa3cc/doc%2Fapi%2Fasync_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fasync_hooks.md?ref=9f6a56590129370f8b17c133f15a63e3832fa3cc",
            "patch": "@@ -301,10 +301,10 @@ and document their own resource objects. For example, such a resource object\n could contain the SQL query being executed.\n \n In the case of Promises, the `resource` object will have `promise` property\n-that refers to the Promise that is being initialized, and a `parentId` property\n-set to the `asyncId` of a parent Promise, if there is one, and `undefined`\n+that refers to the Promise that is being initialized, and a `isChainedPromise`\n+property, set to `true` if the promise has a parent promise, and `false`\n otherwise. For example, in the case of `b = a.then(handler)`, `a` is considered\n-a parent Promise of `b`.\n+a parent Promise of `b`. Here, `b` is considered a chained promise.\n \n In some cases the resource object is reused for performance reasons, it is\n thus not safe to use it as a key in a `WeakMap` or add properties to it."
        },
        {
            "sha": "387f3012480c631d99f0d71b2a182243c2a4dc5f",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/9f6a56590129370f8b17c133f15a63e3832fa3cc/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9f6a56590129370f8b17c133f15a63e3832fa3cc/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=9f6a56590129370f8b17c133f15a63e3832fa3cc",
            "patch": "@@ -245,7 +245,7 @@ class PromiseWrap : public AsyncWrap {\n   size_t self_size() const override { return sizeof(*this); }\n \n   static constexpr int kPromiseField = 1;\n-  static constexpr int kParentAsyncIdField = 2;\n+  static constexpr int kIsChainedPromiseField = 2;\n   static constexpr int kInternalFieldCount = 3;\n \n   static PromiseWrap* New(Environment* env,\n@@ -254,8 +254,8 @@ class PromiseWrap : public AsyncWrap {\n                           bool silent);\n   static void GetPromise(Local<String> property,\n                          const PropertyCallbackInfo<Value>& info);\n-  static void getParentAsyncId(Local<String> property,\n-                          const PropertyCallbackInfo<Value>& info);\n+  static void getIsChainedPromise(Local<String> property,\n+                                  const PropertyCallbackInfo<Value>& info);\n };\n \n PromiseWrap* PromiseWrap::New(Environment* env,\n@@ -265,11 +265,10 @@ PromiseWrap* PromiseWrap::New(Environment* env,\n   Local<Object> object = env->promise_wrap_template()\n                             ->NewInstance(env->context()).ToLocalChecked();\n   object->SetInternalField(PromiseWrap::kPromiseField, promise);\n-  if (parent_wrap != nullptr) {\n-    object->SetInternalField(PromiseWrap::kParentAsyncIdField,\n-                             Number::New(env->isolate(),\n-                                         parent_wrap->get_async_id()));\n-  }\n+  object->SetInternalField(PromiseWrap::kIsChainedPromiseField,\n+                           parent_wrap != nullptr ?\n+                              v8::True(env->isolate()) :\n+                              v8::False(env->isolate()));\n   CHECK_EQ(promise->GetAlignedPointerFromInternalField(0), nullptr);\n   promise->SetInternalField(0, object);\n   return new PromiseWrap(env, object, silent);\n@@ -280,10 +279,10 @@ void PromiseWrap::GetPromise(Local<String> property,\n   info.GetReturnValue().Set(info.Holder()->GetInternalField(kPromiseField));\n }\n \n-void PromiseWrap::getParentAsyncId(Local<String> property,\n-                              const PropertyCallbackInfo<Value>& info) {\n+void PromiseWrap::getIsChainedPromise(Local<String> property,\n+                                      const PropertyCallbackInfo<Value>& info) {\n   info.GetReturnValue().Set(\n-    info.Holder()->GetInternalField(kParentAsyncIdField));\n+    info.Holder()->GetInternalField(kIsChainedPromiseField));\n }\n \n static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n@@ -383,8 +382,8 @@ static void SetupHooks(const FunctionCallbackInfo<Value>& args) {\n         FIXED_ONE_BYTE_STRING(env->isolate(), \"promise\"),\n         PromiseWrap::GetPromise);\n     promise_wrap_template->SetAccessor(\n-        FIXED_ONE_BYTE_STRING(env->isolate(), \"parentId\"),\n-        PromiseWrap::getParentAsyncId);\n+        FIXED_ONE_BYTE_STRING(env->isolate(), \"isChainedPromise\"),\n+        PromiseWrap::getIsChainedPromise);\n     env->set_promise_wrap_template(promise_wrap_template);\n   }\n }"
        },
        {
            "sha": "4b36f6026b36c6a9b75a31f00c4444a8f10db324",
            "filename": "test/parallel/test-async-hooks-promise.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/9f6a56590129370f8b17c133f15a63e3832fa3cc/test%2Fparallel%2Ftest-async-hooks-promise.js",
            "raw_url": "https://github.com/nodejs/node/raw/9f6a56590129370f8b17c133f15a63e3832fa3cc/test%2Fparallel%2Ftest-async-hooks-promise.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-async-hooks-promise.js?ref=9f6a56590129370f8b17c133f15a63e3832fa3cc",
            "patch": "@@ -21,8 +21,8 @@ const a = Promise.resolve(42);\n const b = a.then(common.mustCall());\n \n assert.strictEqual(initCalls[0].triggerId, 1);\n-assert.strictEqual(initCalls[0].resource.parentId, undefined);\n+assert.strictEqual(initCalls[0].resource.isChainedPromise, false);\n assert.strictEqual(initCalls[0].resource.promise, a);\n assert.strictEqual(initCalls[1].triggerId, initCalls[0].id);\n-assert.strictEqual(initCalls[1].resource.parentId, initCalls[0].id);\n+assert.strictEqual(initCalls[1].resource.isChainedPromise, true);\n assert.strictEqual(initCalls[1].resource.promise, b);"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 17,
        "deletions": 18
    }
}