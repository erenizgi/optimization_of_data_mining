{
    "author": "hashseed",
    "message": "deps: backport 073073b4f1 from upstream V8\n\nOriginal commit message:\n\n  [profiler] introduce API to enable detailed source positions\n\n  This allows Node.js to enable detailed source positions for optimized code\n  early on, without having to pass a flag string.\n\n  R=petermarshall@chromium.org\n\n  Change-Id: Ie74ea41f600cf6e31acbe802116df4976ccf1c75\n  Reviewed-on: https://chromium-review.googlesource.com/c/1319757\n  Commit-Queue: Yang Guo <yangguo@chromium.org>\n  Reviewed-by: Peter Marshall <petermarshall@chromium.org>\n  Cr-Commit-Position: refs/heads/master@{#57380}\n\nPR-URL: https://github.com/nodejs/node/pull/24274\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Peter Marshall <petermarshall@chromium.org>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
    "files": [
        {
            "sha": "3689a122725f89aa4e9eefc1523f0a714fe0c3dc",
            "filename": "deps/v8/include/v8-profiler.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-profiler.h?ref=715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
            "patch": "@@ -341,6 +341,12 @@ class V8_EXPORT CpuProfiler {\n   V8_DEPRECATED(\"Use Isolate::SetIdle(bool) instead.\",\n                 void SetIdle(bool is_idle));\n \n+  /**\n+   * Generate more detailed source positions to code objects. This results in\n+   * better results when mapping profiling samples to script source.\n+   */\n+  static void UseDetailedSourcePositionsForProfiling(Isolate* isolate);\n+\n  private:\n   CpuProfiler();\n   ~CpuProfiler();"
        },
        {
            "sha": "8f8aaf7bc628ac8980bca49c80b72f8b4bc23677",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
            "patch": "@@ -10132,6 +10132,11 @@ void CpuProfiler::SetIdle(bool is_idle) {\n   isolate->SetIdle(is_idle);\n }\n \n+void CpuProfiler::UseDetailedSourcePositionsForProfiling(Isolate* isolate) {\n+  reinterpret_cast<i::Isolate*>(isolate)\n+      ->set_detailed_source_positions_for_profiling(true);\n+}\n+\n uintptr_t CodeEvent::GetCodeStartAddress() {\n   return reinterpret_cast<i::CodeEvent*>(this)->code_start_address;\n }"
        },
        {
            "sha": "eed52d9c19fb1a949dbb188749965aca10c9fdd4",
            "filename": "deps/v8/src/isolate.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "raw_url": "https://github.com/nodejs/node/raw/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.cc?ref=715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
            "patch": "@@ -3257,7 +3257,8 @@ bool Isolate::use_optimizer() {\n }\n \n bool Isolate::NeedsDetailedOptimizedCodeLineInfo() const {\n-  return NeedsSourcePositionsForProfiling() || FLAG_detailed_line_info;\n+  return NeedsSourcePositionsForProfiling() ||\n+         detailed_source_positions_for_profiling();\n }\n \n bool Isolate::NeedsSourcePositionsForProfiling() const {"
        },
        {
            "sha": "efd479c41ee4a55e8246d7a1810c5b4a2a93d3af",
            "filename": "deps/v8/src/isolate.h",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fisolate.h",
            "raw_url": "https://github.com/nodejs/node/raw/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Fsrc%2Fisolate.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.h?ref=715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
            "patch": "@@ -553,7 +553,8 @@ typedef std::vector<HeapObject*> DebugObjectCache;\n   V(int, last_console_context_id, 0)                                          \\\n   V(v8_inspector::V8Inspector*, inspector, nullptr)                           \\\n   V(bool, next_v8_call_is_safe_for_termination, false)                        \\\n-  V(bool, only_terminate_in_safe_scope, false)\n+  V(bool, only_terminate_in_safe_scope, false)                                \\\n+  V(bool, detailed_source_positions_for_profiling, FLAG_detailed_line_info)\n \n #define THREAD_LOCAL_TOP_ACCESSOR(type, name)                        \\\n   inline void set_##name(type v) { thread_local_top_.name##_ = v; }  \\"
        },
        {
            "sha": "851099607945e6a88cf67ead414f31835c55fdc3",
            "filename": "deps/v8/test/cctest/test-cpu-profiler.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/715bbb9d04a320b4c1a234e1f9d878c116beb3f4/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-cpu-profiler.cc?ref=715bbb9d04a320b4c1a234e1f9d878c116beb3f4",
            "patch": "@@ -40,6 +40,7 @@\n #include \"src/objects-inl.h\"\n #include \"src/profiler/cpu-profiler-inl.h\"\n #include \"src/profiler/profiler-listener.h\"\n+#include \"src/source-position-table.h\"\n #include \"src/utils.h\"\n #include \"test/cctest/cctest.h\"\n #include \"test/cctest/profiler-extension.h\"\n@@ -2544,6 +2545,46 @@ TEST(MultipleProfilers) {\n   profiler2->StopProfiling(\"2\");\n }\n \n+UNINITIALIZED_TEST(DetailedSourcePositionAPI) {\n+  i::FLAG_detailed_line_info = false;\n+  i::FLAG_allow_natives_syntax = true;\n+  v8::Isolate::CreateParams create_params;\n+  create_params.array_buffer_allocator = CcTest::array_buffer_allocator();\n+  v8::Isolate* isolate = v8::Isolate::New(create_params);\n+\n+  const char* source =\n+      \"function fib(i) {\"\n+      \"  if (i <= 1) return 1; \"\n+      \"  return fib(i - 1) +\"\n+      \"         fib(i - 2);\"\n+      \"}\"\n+      \"fib(5);\"\n+      \"%OptimizeFunctionOnNextCall(fib);\"\n+      \"fib(5);\"\n+      \"fib\";\n+  {\n+    v8::Isolate::Scope isolate_scope(isolate);\n+    v8::HandleScope handle_scope(isolate);\n+    v8::Local<v8::Context> context = v8::Context::New(isolate);\n+    v8::Context::Scope context_scope(context);\n+    i::Isolate* i_isolate = reinterpret_cast<i::Isolate*>(isolate);\n+\n+    CHECK(!i_isolate->NeedsDetailedOptimizedCodeLineInfo());\n+\n+    int non_detailed_positions = GetSourcePositionEntryCount(i_isolate, source);\n+\n+    v8::CpuProfiler::UseDetailedSourcePositionsForProfiling(isolate);\n+    CHECK(i_isolate->NeedsDetailedOptimizedCodeLineInfo());\n+\n+    int detailed_positions = GetSourcePositionEntryCount(i_isolate, source);\n+\n+    CHECK((non_detailed_positions == -1 && detailed_positions == -1) ||\n+          non_detailed_positions < detailed_positions);\n+  }\n+\n+  isolate->Dispose();\n+}\n+\n }  // namespace test_cpu_profiler\n }  // namespace internal\n }  // namespace v8"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 56,
        "deletions": 2
    }
}