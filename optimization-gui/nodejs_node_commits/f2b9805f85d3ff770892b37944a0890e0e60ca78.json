{
    "author": "lpinca",
    "message": "stream: add no-half-open enforcer only if needed\n\nThe listener does not do anything if `allowHalfOpen` is enabled. Add it\nonly when `allowHalfOpen` is disabled.\n\nPR-URL: https://github.com/nodejs/node/pull/18953\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f2b9805f85d3ff770892b37944a0890e0e60ca78",
    "files": [
        {
            "sha": "59ce83292789b5606daf71fc72f3488c8f9b8d2a",
            "filename": "lib/_stream_duplex.js",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f2b9805f85d3ff770892b37944a0890e0e60ca78/lib%2F_stream_duplex.js",
            "raw_url": "https://github.com/nodejs/node/raw/f2b9805f85d3ff770892b37944a0890e0e60ca78/lib%2F_stream_duplex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_duplex.js?ref=f2b9805f85d3ff770892b37944a0890e0e60ca78",
            "patch": "@@ -58,10 +58,10 @@ function Duplex(options) {\n     this.writable = false;\n \n   this.allowHalfOpen = true;\n-  if (options && options.allowHalfOpen === false)\n+  if (options && options.allowHalfOpen === false) {\n     this.allowHalfOpen = false;\n-\n-  this.once('end', onend);\n+    this.once('end', onend);\n+  }\n }\n \n Object.defineProperty(Duplex.prototype, 'writableHighWaterMark', {\n@@ -96,9 +96,8 @@ Object.defineProperty(Duplex.prototype, 'writableLength', {\n \n // the no-half-open enforcer\n function onend() {\n-  // if we allow half-open state, or if the writable side ended,\n-  // then we're ok.\n-  if (this.allowHalfOpen || this._writableState.ended)\n+  // If the writable side ended, then we're ok.\n+  if (this._writableState.ended)\n     return;\n \n   // no more data can be written."
        },
        {
            "sha": "f90d235521a6493f2dfa9301d1a6b16ec8cfcc45",
            "filename": "test/parallel/test-http-connect.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f2b9805f85d3ff770892b37944a0890e0e60ca78/test%2Fparallel%2Ftest-http-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/f2b9805f85d3ff770892b37944a0890e0e60ca78/test%2Fparallel%2Ftest-http-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-connect.js?ref=f2b9805f85d3ff770892b37944a0890e0e60ca78",
            "patch": "@@ -34,7 +34,7 @@ server.on('connect', common.mustCall((req, socket, firstBodyChunk) => {\n   assert.strictEqual(socket.listeners('close').length, 0);\n   assert.strictEqual(socket.listeners('drain').length, 0);\n   assert.strictEqual(socket.listeners('data').length, 0);\n-  assert.strictEqual(socket.listeners('end').length, 2);\n+  assert.strictEqual(socket.listeners('end').length, 1);\n   assert.strictEqual(socket.listeners('error').length, 0);\n \n   socket.write('HTTP/1.1 200 Connection established\\r\\n\\r\\n');"
        },
        {
            "sha": "2b2f9a9a0e6265b7db660f6579334f354f16b96d",
            "filename": "test/parallel/test-stream-duplex.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/f2b9805f85d3ff770892b37944a0890e0e60ca78/test%2Fparallel%2Ftest-stream-duplex.js",
            "raw_url": "https://github.com/nodejs/node/raw/f2b9805f85d3ff770892b37944a0890e0e60ca78/test%2Fparallel%2Ftest-stream-duplex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-duplex.js?ref=f2b9805f85d3ff770892b37944a0890e0e60ca78",
            "patch": "@@ -29,6 +29,8 @@ const stream = new Duplex({ objectMode: true });\n assert(Duplex() instanceof Duplex);\n assert(stream._readableState.objectMode);\n assert(stream._writableState.objectMode);\n+assert(stream.allowHalfOpen);\n+assert.strictEqual(stream.listenerCount('end'), 0);\n \n let written;\n let read;"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 8,
        "deletions": 7
    }
}