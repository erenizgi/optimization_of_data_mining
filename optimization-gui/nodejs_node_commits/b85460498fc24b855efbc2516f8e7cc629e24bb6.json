{
    "author": "jasnell",
    "message": "src: remove old process.binding('trace_events').emit\n\nRemove the older emit and categoryGroupEnabled bindings in\nfavor of the new intrinsics\n\nPR-URL: https://github.com/nodejs/node/pull/22127\nReviewed-By: Andreas Madsen <amwebdk@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "b85460498fc24b855efbc2516f8e7cc629e24bb6",
    "files": [
        {
            "sha": "fb51c91e9e3e7e9109414435862fc11f3718f82d",
            "filename": "benchmark/misc/trace.js",
            "status": "modified",
            "additions": 2,
            "deletions": 27,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/b85460498fc24b855efbc2516f8e7cc629e24bb6/benchmark%2Fmisc%2Ftrace.js",
            "raw_url": "https://github.com/nodejs/node/raw/b85460498fc24b855efbc2516f8e7cc629e24bb6/benchmark%2Fmisc%2Ftrace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ftrace.js?ref=b85460498fc24b855efbc2516f8e7cc629e24bb6",
            "patch": "@@ -4,7 +4,7 @@ const common = require('../common.js');\n \n const bench = common.createBenchmark(main, {\n   n: [100000],\n-  method: ['trace', 'emit', 'isTraceCategoryEnabled', 'categoryGroupEnabled']\n+  method: ['trace', 'isTraceCategoryEnabled']\n }, {\n   flags: ['--expose-internals', '--trace-event-categories', 'foo']\n });\n@@ -13,14 +13,6 @@ const {\n   TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN: kBeforeEvent\n } = process.binding('constants').trace;\n \n-function doEmit(n, emit) {\n-  bench.start();\n-  for (var i = 0; i < n; i++) {\n-    emit(kBeforeEvent, 'foo', 'test', 0, 'arg1', 1);\n-  }\n-  bench.end(n);\n-}\n-\n function doTrace(n, trace) {\n   bench.start();\n   for (var i = 0; i < n; i++) {\n@@ -38,39 +30,22 @@ function doIsTraceCategoryEnabled(n, isTraceCategoryEnabled) {\n   bench.end(n);\n }\n \n-function doCategoryGroupEnabled(n, categoryGroupEnabled) {\n-  bench.start();\n-  for (var i = 0; i < n; i++) {\n-    categoryGroupEnabled('foo');\n-    categoryGroupEnabled('bar');\n-  }\n-  bench.end(n);\n-}\n-\n function main({ n, method }) {\n   const { internalBinding } = require('internal/test/binding');\n \n   const {\n     trace,\n-    isTraceCategoryEnabled,\n-    emit,\n-    categoryGroupEnabled\n+    isTraceCategoryEnabled\n   } = internalBinding('trace_events');\n \n   switch (method) {\n     case '':\n     case 'trace':\n       doTrace(n, trace);\n       break;\n-    case 'emit':\n-      doEmit(n, emit);\n-      break;\n     case 'isTraceCategoryEnabled':\n       doIsTraceCategoryEnabled(n, isTraceCategoryEnabled);\n       break;\n-    case 'categoryGroupEnabled':\n-      doCategoryGroupEnabled(n, categoryGroupEnabled);\n-      break;\n     default:\n       throw new Error(`Unexpected method \"${method}\"`);\n   }"
        },
        {
            "sha": "7299e71db52970c46e2afa9ea4d7c10abcfea8bf",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b85460498fc24b855efbc2516f8e7cc629e24bb6/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/b85460498fc24b855efbc2516f8e7cc629e24bb6/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=b85460498fc24b855efbc2516f8e7cc629e24bb6",
            "patch": "@@ -103,7 +103,7 @@\n       const traceEvents = internalBinding('trace_events');\n       const traceEventCategory = 'node,node.async_hooks';\n \n-      if (traceEvents.categoryGroupEnabled(traceEventCategory)) {\n+      if (traceEvents.isTraceCategoryEnabled(traceEventCategory)) {\n         NativeModule.require('internal/trace_events_async_hooks')\n           .setup(traceEvents, traceEventCategory);\n       }"
        },
        {
            "sha": "219e142a319556d07e10424ffd8705ee0ec0c8f2",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 126,
            "changes": 126,
            "blob_url": "https://github.com/nodejs/node/blob/b85460498fc24b855efbc2516f8e7cc629e24bb6/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b85460498fc24b855efbc2516f8e7cc629e24bb6/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=b85460498fc24b855efbc2516f8e7cc629e24bb6",
            "patch": "@@ -13,7 +13,6 @@ using v8::Array;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n-using v8::Int32;\n using v8::Local;\n using v8::Object;\n using v8::String;\n@@ -99,137 +98,12 @@ void GetEnabledCategories(const FunctionCallbackInfo<Value>& args) {\n   }\n }\n \n-// The tracing APIs require category groups to be pointers to long-lived\n-// strings. Those strings are stored here.\n-static std::unordered_set<std::string> category_groups;\n-static Mutex category_groups_mutex;\n-\n-// Gets a pointer to the category-enabled flags for a tracing category group,\n-// if tracing is enabled for it.\n-static const uint8_t* GetCategoryGroupEnabled(const char* category_group) {\n-  CHECK_NOT_NULL(category_group);\n-  return TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(category_group);\n-}\n-\n-static const char* GetCategoryGroup(Environment* env,\n-                                    const Local<Value> category_value) {\n-  CHECK(category_value->IsString());\n-\n-  Utf8Value category(env->isolate(), category_value);\n-  Mutex::ScopedLock lock(category_groups_mutex);\n-  // If the value already exists in the set, insertion.first will point\n-  // to the existing value. Thus, this will maintain a long lived pointer\n-  // to the category c-string.\n-  auto insertion = category_groups.insert(category.out());\n-\n-  // The returned insertion is a pair whose first item is the object that was\n-  // inserted or that blocked the insertion and second item is a boolean\n-  // indicating whether it was inserted.\n-  return insertion.first->c_str();\n-}\n-\n-static void Emit(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  Local<Context> context = env->context();\n-\n-  // Args: [type, category, name, id, argName, argValue]\n-  CHECK_GE(args.Length(), 3);\n-\n-  // Check the category group first, to avoid doing more work if it's not\n-  // enabled.\n-  const char* category_group = GetCategoryGroup(env, args[1]);\n-  const uint8_t* category_group_enabled =\n-      GetCategoryGroupEnabled(category_group);\n-  if (*category_group_enabled == 0) return;\n-\n-  // get trace_event phase\n-  CHECK(args[0]->IsNumber());\n-  char phase = static_cast<char>(args[0]->Int32Value(context).ToChecked());\n-\n-  // get trace_event name\n-  CHECK(args[2]->IsString());\n-  Utf8Value name_value(env->isolate(), args[2]);\n-  const char* name = name_value.out();\n-\n-  // get trace_event id\n-  int64_t id = 0;\n-  bool has_id = false;\n-  if (args.Length() >= 4 && !args[3]->IsUndefined() && !args[3]->IsNull()) {\n-    has_id = true;\n-    CHECK(args[3]->IsNumber());\n-    id = args[3]->IntegerValue(context).ToChecked();\n-  }\n-\n-  // TODO(AndreasMadsen): String values are not supported.\n-  int32_t num_args = 0;\n-  const char* arg_names[2];\n-  uint8_t arg_types[2];\n-  uint64_t arg_values[2];\n-\n-  // Create Utf8Value in the function scope to prevent deallocation.\n-  // The c-string will be copied by TRACE_EVENT_API_ADD_TRACE_EVENT at the end.\n-  Utf8Value arg1NameValue(env->isolate(), args[4]);\n-  Utf8Value arg2NameValue(env->isolate(), args[6]);\n-\n-  if (args.Length() >= 6 &&\n-      (!args[4]->IsUndefined() || !args[5]->IsUndefined())) {\n-    num_args = 1;\n-    arg_types[0] = TRACE_VALUE_TYPE_INT;\n-\n-    CHECK(args[4]->IsString());\n-    arg_names[0] = arg1NameValue.out();\n-\n-    CHECK(args[5]->IsNumber());\n-    arg_values[0] = args[5]->IntegerValue(context).ToChecked();\n-  }\n-\n-  if (args.Length() >= 8 &&\n-      (!args[6]->IsUndefined() || !args[7]->IsUndefined())) {\n-    num_args = 2;\n-    arg_types[1] = TRACE_VALUE_TYPE_INT;\n-\n-    CHECK(args[6]->IsString());\n-    arg_names[1] = arg2NameValue.out();\n-\n-    CHECK(args[7]->IsNumber());\n-    arg_values[1] = args[7]->IntegerValue(context).ToChecked();\n-  }\n-\n-  // The TRACE_EVENT_FLAG_COPY flag indicates that the name and argument\n-  // name should be copied thus they don't need to long-lived pointers.\n-  // The category name still won't be copied and thus need to be a long-lived\n-  // pointer.\n-  uint32_t flags = TRACE_EVENT_FLAG_COPY;\n-  if (has_id) {\n-    flags |= TRACE_EVENT_FLAG_HAS_ID;\n-  }\n-\n-  const char* scope = node::tracing::kGlobalScope;\n-  uint64_t bind_id = node::tracing::kNoId;\n-\n-  TRACE_EVENT_API_ADD_TRACE_EVENT(\n-    phase, category_group_enabled, name, scope, id, bind_id,\n-    num_args, arg_names, arg_types, arg_values,\n-    flags);\n-}\n-\n-static void CategoryGroupEnabled(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  const char* category_group = GetCategoryGroup(env, args[0]);\n-  const uint8_t* category_group_enabled =\n-      GetCategoryGroupEnabled(category_group);\n-  args.GetReturnValue().Set(*category_group_enabled > 0);\n-}\n-\n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n                 Local<Context> context,\n                 void* priv) {\n   Environment* env = Environment::GetCurrent(context);\n \n-  env->SetMethod(target, \"emit\", Emit);\n-  env->SetMethod(target, \"categoryGroupEnabled\", CategoryGroupEnabled);\n   env->SetMethod(target, \"getEnabledCategories\", GetEnabledCategories);\n \n   Local<FunctionTemplate> category_set ="
        },
        {
            "sha": "163d9c4cbd6290b1ca75d6a3dabb1869da2a0276",
            "filename": "test/parallel/test-trace-events-binding.js",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/b85460498fc24b855efbc2516f8e7cc629e24bb6/test%2Fparallel%2Ftest-trace-events-binding.js",
            "raw_url": "https://github.com/nodejs/node/raw/b85460498fc24b855efbc2516f8e7cc629e24bb6/test%2Fparallel%2Ftest-trace-events-binding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-binding.js?ref=b85460498fc24b855efbc2516f8e7cc629e24bb6",
            "patch": "@@ -9,15 +9,14 @@ if (!common.isMainThread)\n \n const CODE = `\n   const { internalBinding } = require('internal/test/binding');\n-  const { emit } = internalBinding('trace_events');\n-  emit('b'.charCodeAt(0), 'custom',\n-       'type-value', 10, 'extra-value', 20);\n-  emit('b'.charCodeAt(0), 'custom',\n-       'type-value', 20, 'first-value', 20, 'second-value', 30);\n-  emit('b'.charCodeAt(0), 'custom',\n-       'type-value', 30);\n-  emit('b'.charCodeAt(0), 'missing',\n-       'type-value', 10, 'extra-value', 20);\n+  const { trace } = internalBinding('trace_events');\n+  trace('b'.charCodeAt(0), 'custom',\n+        'type-value', 10, {'extra-value': 20 });\n+  trace('b'.charCodeAt(0), 'custom',\n+        'type-value', 20, {'first-value': 20, 'second-value': 30 });\n+  trace('b'.charCodeAt(0), 'custom', 'type-value', 30);\n+  trace('b'.charCodeAt(0), 'missing',\n+        'type-value', 10, {'extra-value': 20 });\n `;\n const FILE_NAME = 'node_trace.1.log';\n \n@@ -27,6 +26,7 @@ process.chdir(tmpdir.path);\n \n const proc = cp.spawn(process.execPath,\n                       [ '--trace-event-categories', 'custom',\n+                        '--no-warnings',\n                         '--expose-internals',\n                         '-e', CODE ]);\n \n@@ -42,14 +42,14 @@ proc.once('exit', common.mustCall(() => {\n     assert.strictEqual(traces[0].cat, 'custom');\n     assert.strictEqual(traces[0].name, 'type-value');\n     assert.strictEqual(traces[0].id, '0xa');\n-    assert.deepStrictEqual(traces[0].args, { 'extra-value': 20 });\n+    assert.deepStrictEqual(traces[0].args.data, { 'extra-value': 20 });\n \n     assert.strictEqual(traces[1].pid, proc.pid);\n     assert.strictEqual(traces[1].ph, 'b');\n     assert.strictEqual(traces[1].cat, 'custom');\n     assert.strictEqual(traces[1].name, 'type-value');\n     assert.strictEqual(traces[1].id, '0x14');\n-    assert.deepStrictEqual(traces[1].args, {\n+    assert.deepStrictEqual(traces[1].args.data, {\n       'first-value': 20,\n       'second-value': 30\n     });"
        },
        {
            "sha": "249ccd4aa3a3f3a052ebc06d7a805faa2d3e308b",
            "filename": "test/parallel/test-trace-events-category-used.js",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/b85460498fc24b855efbc2516f8e7cc629e24bb6/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "raw_url": "https://github.com/nodejs/node/raw/b85460498fc24b855efbc2516f8e7cc629e24bb6/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-category-used.js?ref=b85460498fc24b855efbc2516f8e7cc629e24bb6",
            "patch": "@@ -8,9 +8,9 @@ if (!common.isMainThread)\n \n const CODE = `\n   const { internalBinding } = require('internal/test/binding');\n-  const { categoryGroupEnabled } = internalBinding('trace_events');\n+  const { isTraceCategoryEnabled } = internalBinding('trace_events');\n   console.log(\n-    categoryGroupEnabled(\"custom\")\n+    isTraceCategoryEnabled(\"custom\")\n   );\n `;\n \n@@ -21,6 +21,9 @@ process.chdir(tmpdir.path);\n const procEnabled = cp.spawn(\n   process.execPath,\n   [ '--trace-event-categories', 'custom',\n+    // make test less noisy since internal/test/binding\n+    // emits a warning.\n+    '--no-warnings',\n     '--expose-internals',\n     '-e', CODE ]\n );\n@@ -35,6 +38,9 @@ procEnabled.once('exit', common.mustCall(() => {\n const procDisabled = cp.spawn(\n   process.execPath,\n   [ '--trace-event-categories', 'other',\n+    // make test less noisy since internal/test/binding\n+    // emits a warning.\n+    '--no-warnings',\n     '--expose-internals',\n     '-e', CODE ]\n );"
        }
    ],
    "stats": {
        "total": 189,
        "additions": 22,
        "deletions": 167
    }
}