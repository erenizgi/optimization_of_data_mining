{
    "author": "addaleax",
    "message": "perf_hooks: make GC tracking state per-Environment\n\nOtherwise this is global state that may be subject to race\nconditions e.g. when running `perf_hooks` inside of Worker threads.\n\nTracking the GC type is removed entirely since the variable was unused.\n\nPR-URL: https://github.com/nodejs/node/pull/25053\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "8dfd7573372ba49f87f0838191b83ea4c8bd509a",
    "files": [
        {
            "sha": "45d66ad5917ab2abf0d8b39c09647ec187fcc20b",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/8dfd7573372ba49f87f0838191b83ea4c8bd509a/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8dfd7573372ba49f87f0838191b83ea4c8bd509a/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=8dfd7573372ba49f87f0838191b83ea4c8bd509a",
            "patch": "@@ -42,9 +42,6 @@ const double timeOriginTimestamp = GetCurrentTimeInMicroseconds();\n uint64_t performance_node_start;\n uint64_t performance_v8_start;\n \n-uint64_t performance_last_gc_start_mark_ = 0;\n-GCType performance_last_gc_type_ = GCType::kGCTypeAll;\n-\n void performance_state::Mark(enum PerformanceMilestone milestone,\n                              uint64_t ts) {\n   this->milestones[milestone] = ts;\n@@ -268,9 +265,10 @@ void PerformanceGCCallback(Environment* env, void* ptr) {\n // Marks the start of a GC cycle\n void MarkGarbageCollectionStart(Isolate* isolate,\n                                 GCType type,\n-                                GCCallbackFlags flags) {\n-  performance_last_gc_start_mark_ = PERFORMANCE_NOW();\n-  performance_last_gc_type_ = type;\n+                                GCCallbackFlags flags,\n+                                void* data) {\n+  Environment* env = static_cast<Environment*>(data);\n+  env->performance_state()->performance_last_gc_start_mark = PERFORMANCE_NOW();\n }\n \n // Marks the end of a GC cycle\n@@ -279,21 +277,23 @@ void MarkGarbageCollectionEnd(Isolate* isolate,\n                               GCCallbackFlags flags,\n                               void* data) {\n   Environment* env = static_cast<Environment*>(data);\n+  performance_state* state = env->performance_state();\n   // If no one is listening to gc performance entries, do not create them.\n-  if (!env->performance_state()->observers[NODE_PERFORMANCE_ENTRY_TYPE_GC])\n+  if (!state->observers[NODE_PERFORMANCE_ENTRY_TYPE_GC])\n     return;\n   GCPerformanceEntry* entry =\n       new GCPerformanceEntry(env,\n                              static_cast<PerformanceGCKind>(type),\n-                             performance_last_gc_start_mark_,\n+                             state->performance_last_gc_start_mark,\n                              PERFORMANCE_NOW());\n   env->SetUnrefImmediate(PerformanceGCCallback,\n                          entry);\n }\n \n \n inline void SetupGarbageCollectionTracking(Environment* env) {\n-  env->isolate()->AddGCPrologueCallback(MarkGarbageCollectionStart);\n+  env->isolate()->AddGCPrologueCallback(MarkGarbageCollectionStart,\n+                                        static_cast<void*>(env));\n   env->isolate()->AddGCEpilogueCallback(MarkGarbageCollectionEnd,\n                                         static_cast<void*>(env));\n }"
        },
        {
            "sha": "0053ebf611974453106faf722d9a8790fbcfecdc",
            "filename": "src/node_perf_common.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8dfd7573372ba49f87f0838191b83ea4c8bd509a/src%2Fnode_perf_common.h",
            "raw_url": "https://github.com/nodejs/node/raw/8dfd7573372ba49f87f0838191b83ea4c8bd509a/src%2Fnode_perf_common.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf_common.h?ref=8dfd7573372ba49f87f0838191b83ea4c8bd509a",
            "patch": "@@ -75,6 +75,8 @@ class performance_state {\n   AliasedBuffer<double, v8::Float64Array> milestones;\n   AliasedBuffer<uint32_t, v8::Uint32Array> observers;\n \n+  uint64_t performance_last_gc_start_mark = 0;\n+\n   void Mark(enum PerformanceMilestone milestone,\n             uint64_t ts = PERFORMANCE_NOW());\n "
        }
    ],
    "stats": {
        "total": 20,
        "additions": 11,
        "deletions": 9
    }
}