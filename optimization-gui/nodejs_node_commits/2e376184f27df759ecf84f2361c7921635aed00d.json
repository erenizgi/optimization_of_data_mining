{
    "author": "addaleax",
    "message": "fs: fix `createReadStream(â€¦, {end: n})` for non-seekable fds\n\n82bdf8fba2d3f fixed an issue by silently modifying the `start`\noption for the case when only `end` is passed, in order to perform\nreads from a specified range in the file.\n\nHowever, that approach does not work for non-seekable files, since\na numeric `start` option means that positioned reads will be used\nto read data from the file.\n\nThis patch fixes that, and instead ends reading after a specified\nsize by adjusting the read buffer size.\n\nThis way we avoid re-introducing the bug that 82bdf8fba2d3f fixed,\nand align behaviour with the native file stream mechanism\nintroduced in https://github.com/nodejs/node/pull/18936 as well.\n\nPR-URL: https://github.com/nodejs/node/pull/19329\nFixes: https://github.com/nodejs/node/issues/19240\nRefs: https://github.com/nodejs/node/pull/18121\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Chen Gang <gangc.cxy@foxmail.com>",
    "sha": "2e376184f27df759ecf84f2361c7921635aed00d",
    "files": [
        {
            "sha": "352d2fd1ffd12d400a448413a24e0a4ff85a2526",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/2e376184f27df759ecf84f2361c7921635aed00d/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/2e376184f27df759ecf84f2361c7921635aed00d/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=2e376184f27df759ecf84f2361c7921635aed00d",
            "patch": "@@ -1967,8 +1967,7 @@ function ReadStream(path, options) {\n   this.flags = options.flags === undefined ? 'r' : options.flags;\n   this.mode = options.mode === undefined ? 0o666 : options.mode;\n \n-  this.start = typeof this.fd !== 'number' && options.start === undefined ?\n-    0 : options.start;\n+  this.start = options.start;\n   this.end = options.end;\n   this.autoClose = options.autoClose === undefined ? true : options.autoClose;\n   this.pos = undefined;\n@@ -1993,6 +1992,12 @@ function ReadStream(path, options) {\n     this.pos = this.start;\n   }\n \n+  // Backwards compatibility: Make sure `end` is a number regardless of `start`.\n+  // TODO(addaleax): Make the above typecheck not depend on `start` instead.\n+  // (That is a semver-major change).\n+  if (typeof this.end !== 'number')\n+    this.end = Infinity;\n+\n   if (typeof this.fd !== 'number')\n     this.open();\n \n@@ -2047,6 +2052,8 @@ ReadStream.prototype._read = function(n) {\n \n   if (this.pos !== undefined)\n     toRead = Math.min(this.end - this.pos + 1, toRead);\n+  else\n+    toRead = Math.min(this.end - this.bytesRead + 1, toRead);\n \n   // already read everything we were supposed to read!\n   // treat as EOF."
        },
        {
            "sha": "8b92eb1c7aa3043aa7f960695bb99bb1086151c2",
            "filename": "test/parallel/test-fs-read-stream.js",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/2e376184f27df759ecf84f2361c7921635aed00d/test%2Fparallel%2Ftest-fs-read-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/2e376184f27df759ecf84f2361c7921635aed00d/test%2Fparallel%2Ftest-fs-read-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-read-stream.js?ref=2e376184f27df759ecf84f2361c7921635aed00d",
            "patch": "@@ -21,7 +21,9 @@\n \n 'use strict';\n const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n \n+const child_process = require('child_process');\n const assert = require('assert');\n const fs = require('fs');\n const fixtures = require('../common/fixtures');\n@@ -178,6 +180,31 @@ common.expectsError(\n   }));\n }\n \n+if (!common.isWindows) {\n+  // Verify that end works when start is not specified, and we do not try to\n+  // use positioned reads. This makes sure that this keeps working for\n+  // non-seekable file descriptors.\n+  tmpdir.refresh();\n+  const filename = `${tmpdir.path}/foo.pipe`;\n+  const mkfifoResult = child_process.spawnSync('mkfifo', [filename]);\n+  if (!mkfifoResult.error) {\n+    child_process.exec(`echo \"xyz foobar\" > '${filename}'`);\n+    const stream = new fs.createReadStream(filename, { end: 1 });\n+    stream.data = '';\n+\n+    stream.on('data', function(chunk) {\n+      stream.data += chunk;\n+    });\n+\n+    stream.on('end', common.mustCall(function() {\n+      assert.strictEqual('xy', stream.data);\n+      fs.unlinkSync(filename);\n+    }));\n+  } else {\n+    common.printSkipMessage('mkfifo not available');\n+  }\n+}\n+\n {\n   // pause and then resume immediately.\n   const pauseRes = fs.createReadStream(rangeFile);"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 36,
        "deletions": 2
    }
}