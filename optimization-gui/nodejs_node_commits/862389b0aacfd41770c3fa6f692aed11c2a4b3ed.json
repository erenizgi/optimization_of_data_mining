{
    "author": "sethbrenith",
    "message": "http: simplify checkInvalidHeaderChar\n\nIn the spirit of [17399](https://github.com/nodejs/node/pull/17399),\nwe can also simplify checkInvalidHeaderChar to use regex matching\ninstead of a loop. This makes it faster on long matches and slower\non short matches or non-matches. This change also includes some\nsample data from an AcmeAir benchmark run, as a rough proxy for\nreal-world data.\n\nPR-URL: https://github.com/nodejs/node/pull/18381\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Benedikt Meurer <benedikt.meurer@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "862389b0aacfd41770c3fa6f692aed11c2a4b3ed",
    "files": [
        {
            "sha": "c70b0d39db2ffc7158062cca4890afead30feda4",
            "filename": "benchmark/http/check_invalid_header_char.js",
            "status": "modified",
            "additions": 52,
            "deletions": 29,
            "changes": 81,
            "blob_url": "https://github.com/nodejs/node/blob/862389b0aacfd41770c3fa6f692aed11c2a4b3ed/benchmark%2Fhttp%2Fcheck_invalid_header_char.js",
            "raw_url": "https://github.com/nodejs/node/raw/862389b0aacfd41770c3fa6f692aed11c2a4b3ed/benchmark%2Fhttp%2Fcheck_invalid_header_char.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp%2Fcheck_invalid_header_char.js?ref=862389b0aacfd41770c3fa6f692aed11c2a4b3ed",
            "patch": "@@ -3,43 +3,66 @@\n const common = require('../common.js');\n const _checkInvalidHeaderChar = require('_http_common')._checkInvalidHeaderChar;\n \n-// Put it here so the benchmark result lines will not be super long.\n-const LONG_AND_INVALID = 'Here is a value that is really a folded header ' +\n-  'value\\r\\n  this should be supported, but it is not currently';\n+const groupedInputs = {\n+  // Representative set of inputs from an AcmeAir benchmark run:\n+  // all valid strings, average length 14.4, stdev 13.0\n+  group_acmeair: [\n+    'W/\"2-d4cbb29\"', 'OK', 'Express', 'X-HTTP-Method-Override', 'Express',\n+    'application/json', 'application/json; charset=utf-8', '206', 'OK',\n+    'sessionid=; Path=/', 'text/html; charset=utf-8',\n+    'text/html; charset=utf-8', '10', 'W/\"a-eda64de5\"', 'OK', 'Express',\n+    'application/json', 'application/json; charset=utf-8', '2', 'W/\"2-d4cbb29\"',\n+    'OK', 'Express', 'X-HTTP-Method-Override', 'sessionid=; Path=/', 'Express',\n+    'sessionid=; Path=/,sessionid=6b059402-d62f-4e6f-b3dd-ce5b9e487c39; Path=/',\n+    'text/html; charset=utf-8', 'text/html; charset=utf-8', '9', 'OK',\n+    'sessionid=; Path=/', 'text/html; charset=utf-8',\n+    'text/html; charset=utf-8', '10', 'W/\"a-eda64de5\"', 'OK', 'Express',\n+    'Express', 'X-HTTP-Method-Override', 'sessionid=; Path=/',\n+    'application/json'\n+  ],\n+\n+  // Put it here so the benchmark result lines will not be super long.\n+  LONG_AND_INVALID: ['Here is a value that is really a folded header ' +\n+    'value\\r\\n  this should be supported, but it is not currently']\n+};\n+\n+const inputs = [\n+  // Valid\n+  '',\n+  '1',\n+  '\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tFoo bar baz',\n+  'keep-alive',\n+  'close',\n+  'gzip',\n+  '20091',\n+  'private',\n+  'text/html; charset=utf-8',\n+  'text/plain',\n+  'Sat, 07 May 2016 16:54:48 GMT',\n+  'SAMEORIGIN',\n+  'en-US',\n+\n+  // Invalid\n+  '中文呢', // unicode\n+  'foo\\nbar',\n+  '\\x7F'\n+];\n \n const bench = common.createBenchmark(main, {\n-  key: [\n-    // Valid\n-    '',\n-    '1',\n-    '\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tFoo bar baz',\n-    'keep-alive',\n-    'close',\n-    'gzip',\n-    '20091',\n-    'private',\n-    'text/html; charset=utf-8',\n-    'text/plain',\n-    'Sat, 07 May 2016 16:54:48 GMT',\n-    'SAMEORIGIN',\n-    'en-US',\n-\n-    // Invalid\n-    'LONG_AND_INVALID',\n-    '中文呢', // unicode\n-    'foo\\nbar',\n-    '\\x7F'\n-  ],\n+  input: inputs.concat(Object.keys(groupedInputs)),\n   n: [1e6],\n });\n \n-function main({ n, key }) {\n-  if (key === 'LONG_AND_INVALID') {\n-    key = LONG_AND_INVALID;\n+function main({ n, input }) {\n+  let inputs = [input];\n+  if (groupedInputs.hasOwnProperty(input)) {\n+    inputs = groupedInputs[input];\n   }\n+\n+  const len = inputs.length;\n   bench.start();\n   for (var i = 0; i < n; i++) {\n-    _checkInvalidHeaderChar(key);\n+    _checkInvalidHeaderChar(inputs[i % len]);\n   }\n   bench.end(n);\n }"
        },
        {
            "sha": "ffb90407c6217549aa151d07ea708f9b794d9104",
            "filename": "lib/_http_common.js",
            "status": "modified",
            "additions": 2,
            "deletions": 44,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/862389b0aacfd41770c3fa6f692aed11c2a4b3ed/lib%2F_http_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/862389b0aacfd41770c3fa6f692aed11c2a4b3ed/lib%2F_http_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_common.js?ref=862389b0aacfd41770c3fa6f692aed11c2a4b3ed",
            "patch": "@@ -242,57 +242,15 @@ function checkIsHttpToken(val) {\n   return tokenRegExp.test(val);\n }\n \n+const headerCharRegex = /[^\\t\\x20-\\x7e\\x80-\\xff]/;\n /**\n  * True if val contains an invalid field-vchar\n  *  field-value    = *( field-content / obs-fold )\n  *  field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]\n  *  field-vchar    = VCHAR / obs-text\n- *\n- * checkInvalidHeaderChar() is currently designed to be inlinable by v8,\n- * so take care when making changes to the implementation so that the source\n- * code size does not exceed v8's default max_inlined_source_size setting.\n  **/\n-var validHdrChars = [\n-  0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, // 0 - 15\n-  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 16 - 31\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 32 - 47\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 48 - 63\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 64 - 79\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 80 - 95\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 96 - 111\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, // 112 - 127\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 128 ...\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n-  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1  // ... 255\n-];\n function checkInvalidHeaderChar(val) {\n-  val += '';\n-  if (val.length < 1)\n-    return false;\n-  if (!validHdrChars[val.charCodeAt(0)])\n-    return true;\n-  if (val.length < 2)\n-    return false;\n-  if (!validHdrChars[val.charCodeAt(1)])\n-    return true;\n-  if (val.length < 3)\n-    return false;\n-  if (!validHdrChars[val.charCodeAt(2)])\n-    return true;\n-  if (val.length < 4)\n-    return false;\n-  if (!validHdrChars[val.charCodeAt(3)])\n-    return true;\n-  for (var i = 4; i < val.length; ++i) {\n-    if (!validHdrChars[val.charCodeAt(i)])\n-      return true;\n-  }\n-  return false;\n+  return headerCharRegex.test(val);\n }\n \n module.exports = {"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 54,
        "deletions": 73
    }
}