{
    "author": "mcollina",
    "message": "stream: correctly pause and resume after once('readable')\n\nFixes: https://github.com/nodejs/node/issues/24281\n\nPR-URL: https://github.com/nodejs/node/pull/24366\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "69cc58d0ab8af1bb8328e685e967860cfb25474d",
    "files": [
        {
            "sha": "47dbae31b5f2c1e43df882cd3db6f22abf7ca1d3",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/69cc58d0ab8af1bb8328e685e967860cfb25474d/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/69cc58d0ab8af1bb8328e685e967860cfb25474d/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=69cc58d0ab8af1bb8328e685e967860cfb25474d",
            "patch": "@@ -114,6 +114,7 @@ function ReadableState(options, stream, isDuplex) {\n   this.emittedReadable = false;\n   this.readableListening = false;\n   this.resumeScheduled = false;\n+  this.paused = true;\n \n   // Should close be emitted on destroy. Defaults to true.\n   this.emitClose = options.emitClose !== false;\n@@ -862,10 +863,16 @@ Readable.prototype.removeAllListeners = function(ev) {\n };\n \n function updateReadableListening(self) {\n-  self._readableState.readableListening = self.listenerCount('readable') > 0;\n+  const state = self._readableState;\n+  state.readableListening = self.listenerCount('readable') > 0;\n \n-  // crude way to check if we should resume\n-  if (self.listenerCount('data') > 0) {\n+  if (state.resumeScheduled && !state.paused) {\n+    // flowing needs to be set to true now, otherwise\n+    // the upcoming resume will not flow.\n+    state.flowing = true;\n+\n+    // crude way to check if we should resume\n+  } else if (self.listenerCount('data') > 0) {\n     self.resume();\n   }\n }\n@@ -887,6 +894,7 @@ Readable.prototype.resume = function() {\n     state.flowing = !state.readableListening;\n     resume(this, state);\n   }\n+  state.paused = false;\n   return this;\n };\n \n@@ -917,6 +925,7 @@ Readable.prototype.pause = function() {\n     this._readableState.flowing = false;\n     this.emit('pause');\n   }\n+  this._readableState.paused = true;\n   return this;\n };\n "
        },
        {
            "sha": "83cf49333a8d83040b49dd518c93d6dfa49967c8",
            "filename": "test/parallel/test-stream-readable-readable-then-resume.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/69cc58d0ab8af1bb8328e685e967860cfb25474d/test%2Fparallel%2Ftest-stream-readable-readable-then-resume.js",
            "raw_url": "https://github.com/nodejs/node/raw/69cc58d0ab8af1bb8328e685e967860cfb25474d/test%2Fparallel%2Ftest-stream-readable-readable-then-resume.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-readable-then-resume.js?ref=69cc58d0ab8af1bb8328e685e967860cfb25474d",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { Readable } = require('stream');\n+\n+// This test verifies that a stream could be resumed after\n+// removing the readable event in the same tick\n+\n+check(new Readable({\n+  objectMode: true,\n+  highWaterMark: 1,\n+  read() {\n+    if (!this.first) {\n+      this.push('hello');\n+      this.first = true;\n+      return;\n+    }\n+\n+    this.push(null);\n+  }\n+}));\n+\n+function check(s) {\n+  const readableListener = common.mustNotCall();\n+  s.on('readable', readableListener);\n+  s.on('end', common.mustCall());\n+  s.removeListener('readable', readableListener);\n+  s.resume();\n+}"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 41,
        "deletions": 3
    }
}