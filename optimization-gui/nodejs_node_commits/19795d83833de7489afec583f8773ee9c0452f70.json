{
    "author": "mcollina",
    "message": "inspector: expose original console\n\nAdds require('inspector').console, mapping it to the original\nglobal.console of V8. This enables applications to send messages to\nthe inspector console programmatically.\n\nFixes: https://github.com/nodejs/node/issues/21651\n\nPR-URL: https://github.com/nodejs/node/pull/21659\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "19795d83833de7489afec583f8773ee9c0452f70",
    "files": [
        {
            "sha": "8ab827bd1f9145355df1bd3270099ca05a559e9b",
            "filename": "doc/api/inspector.md",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/19795d83833de7489afec583f8773ee9c0452f70/doc%2Fapi%2Finspector.md",
            "raw_url": "https://github.com/nodejs/node/raw/19795d83833de7489afec583f8773ee9c0452f70/doc%2Fapi%2Finspector.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Finspector.md?ref=19795d83833de7489afec583f8773ee9c0452f70",
            "patch": "@@ -28,6 +28,17 @@ started.\n If wait is `true`, will block until a client has connected to the inspect port\n and flow control has been passed to the debugger client.\n \n+### inspector.console\n+\n+An object to send messages to the remote inspector console.\n+\n+```js\n+require('inspector').console.log('a message');\n+```\n+\n+The inspector console does not have API parity with Node.js\n+console.\n+\n ### inspector.close()\n \n Deactivate the inspector. Blocks until there are no active connections."
        },
        {
            "sha": "f4e365b774be79bf2562b73eb3cac274d3e62b72",
            "filename": "lib/inspector.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/19795d83833de7489afec583f8773ee9c0452f70/lib%2Finspector.js",
            "raw_url": "https://github.com/nodejs/node/raw/19795d83833de7489afec583f8773ee9c0452f70/lib%2Finspector.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finspector.js?ref=19795d83833de7489afec583f8773ee9c0452f70",
            "patch": "@@ -11,6 +11,7 @@ const {\n } = require('internal/errors').codes;\n const util = require('util');\n const { Connection, open, url } = process.binding('inspector');\n+const { originalConsole } = require('internal/process/per_thread');\n \n if (!Connection || !require('internal/worker').isMainThread)\n   throw new ERR_INSPECTOR_NOT_AVAILABLE();\n@@ -103,5 +104,6 @@ module.exports = {\n   open: (port, host, wait) => open(port, host, !!wait),\n   close: process._debugEnd,\n   url: url,\n+  console: originalConsole,\n   Session\n };"
        },
        {
            "sha": "e433c67aa42c8b439cbcf271f896caf51035d9b2",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/19795d83833de7489afec583f8773ee9c0452f70/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/19795d83833de7489afec583f8773ee9c0452f70/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=19795d83833de7489afec583f8773ee9c0452f70",
            "patch": "@@ -120,6 +120,8 @@\n \n     const browserGlobals = !process._noBrowserGlobals;\n     if (browserGlobals) {\n+      // we are setting this here to foward it to the inspector later\n+      perThreadSetup.originalConsole = global.console;\n       setupGlobalTimeouts();\n       setupGlobalConsole();\n       setupGlobalURL();"
        },
        {
            "sha": "13726049798f0e09e93c2ea35ce7e2c1fc69f1c6",
            "filename": "test/common/inspector-helper.js",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/19795d83833de7489afec583f8773ee9c0452f70/test%2Fcommon%2Finspector-helper.js",
            "raw_url": "https://github.com/nodejs/node/raw/19795d83833de7489afec583f8773ee9c0452f70/test%2Fcommon%2Finspector-helper.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Finspector-helper.js?ref=19795d83833de7489afec583f8773ee9c0452f70",
            "patch": "@@ -7,6 +7,7 @@ const fixtures = require('../common/fixtures');\n const { spawn } = require('child_process');\n const { parse: parseURL } = require('url');\n const { getURLFromFilePath } = require('internal/url');\n+const { EventEmitter } = require('events');\n \n const _MAINSCRIPT = fixtures.path('loop.js');\n const DEBUG = false;\n@@ -311,10 +312,12 @@ class InspectorSession {\n   }\n }\n \n-class NodeInstance {\n+class NodeInstance extends EventEmitter {\n   constructor(inspectorFlags = ['--inspect-brk=0'],\n               scriptContents = '',\n               scriptFile = _MAINSCRIPT) {\n+    super();\n+\n     this._scriptPath = scriptFile;\n     this._script = scriptFile ? null : scriptContents;\n     this._portCallback = null;\n@@ -326,7 +329,10 @@ class NodeInstance {\n     this._unprocessedStderrLines = [];\n \n     this._process.stdout.on('data', makeBufferingDataCallback(\n-      (line) => console.log('[out]', line)));\n+      (line) => {\n+        this.emit('stdout', line);\n+        console.log('[out]', line);\n+      }));\n \n     this._process.stderr.on('data', makeBufferingDataCallback(\n       (message) => this.onStderrLine(message)));"
        },
        {
            "sha": "6a06c79888165451464f1a8f3e14d32ebe987392",
            "filename": "test/sequential/test-inspector-console.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/19795d83833de7489afec583f8773ee9c0452f70/test%2Fsequential%2Ftest-inspector-console.js",
            "raw_url": "https://github.com/nodejs/node/raw/19795d83833de7489afec583f8773ee9c0452f70/test%2Fsequential%2Ftest-inspector-console.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-console.js?ref=19795d83833de7489afec583f8773ee9c0452f70",
            "patch": "@@ -0,0 +1,39 @@\n+// Flags: --expose-internals\n+'use strict';\n+\n+const common = require('../common');\n+common.skipIfInspectorDisabled();\n+\n+const { NodeInstance } = require('../common/inspector-helper.js');\n+const assert = require('assert');\n+\n+async function runTest() {\n+  const script = 'require(\\'inspector\\').console.log(\\'hello world\\');';\n+  const child = new NodeInstance('--inspect-brk=0', script, '');\n+\n+  let out = '';\n+  child.on('stdout', (line) => out += line);\n+\n+  const session = await child.connectInspectorSession();\n+\n+  const commands = [\n+    { 'method': 'Runtime.enable' },\n+    { 'method': 'Runtime.runIfWaitingForDebugger' }\n+  ];\n+\n+  session.send(commands);\n+\n+  const msg = await session.waitForNotification('Runtime.consoleAPICalled');\n+\n+  assert.strictEqual(msg.params.type, 'log');\n+  assert.deepStrictEqual(msg.params.args, [{\n+    type: 'string',\n+    value: 'hello world'\n+  }]);\n+  assert.strictEqual(out, '');\n+\n+  session.disconnect();\n+}\n+\n+common.crashOnUnhandledRejection();\n+runTest();"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 62,
        "deletions": 2
    }
}