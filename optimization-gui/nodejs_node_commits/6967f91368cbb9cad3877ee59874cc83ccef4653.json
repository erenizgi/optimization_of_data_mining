{
    "author": "joyeecheung",
    "message": "process: split execution into main scripts\n\nThis patch splits the execution mode selection from the environment\nsetup in `lib/internal/bootstrap/node.js`, and split the entry point\nof different execution mode into main scripts under\n`lib/internal/main`:\n\n- `check_syntax.js`: used when `-c`/`--check` which only checks the\n  syntax of the input instead of executing it.\n- `eval_stdin.js`: used when `-e` is passed without value and stdin\n  is not a TTY (e.g. something is piped).\n- `eval_string`: used when `-e` is passed along with a string argument\n- `inspect.js`: for `node inspect`/`node debug`\n- `print_bash_completion.js`: for `--completion-bash`\n- `print_help.js`: for `--help`\n- `prof_process.js`: for `--prof-process`\n- `repl.js`: for the REPL\n- `run_main_module.js`: used when a main module is passed\n- `run_third_party_main.js`: for the legacy `_third_party_main.js`\n  support\n- `worker_thread.js`: for workers\n\nThis makes the entry points easier to navigate and paves the way\nfor customized v8 snapshots (that do not need to deserialize\nexecution mode setup) and better embedder APIs.\n\nAs an example, after this patch, for the most common case where\nNode.js executes a user module as an entry point, it essentially\ngoes through:\n\n- `lib/internal/per_context.js` to setup the v8 Context (which is\n  also run when setting up contexts for the `vm` module)\n- `lib/internal/bootstrap/loaders.js` to set up internal binding\n  and builtin module loaders (that are separate from the loaders\n  accessible in the user land).\n- `lib/internal/bootstrap/node.js`: to set up the rest of the\n  environment, including various globals and the process object\n- `lib/internal/main/run_main_module.js`: which is selected from\n  C++ to prepare execution of the user module.\n\nThis patch also removes `NativeModuleLoader::CompileAndCall` and\nexposes `NativeModuleLoader::LookupAndCompile` directly so that\nwe can handle syntax errors and runtime errors of bootstrap\nscripts differently.\n\nPR-URL: https://github.com/nodejs/node/pull/25667\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "6967f91368cbb9cad3877ee59874cc83ccef4653",
    "files": [
        {
            "sha": "10d5c18334485efe453a352a617a0b7c2de5f1f0",
            "filename": "lib/internal/bootstrap/cache.js",
            "status": "modified",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fcache.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -13,33 +13,32 @@ const { hasTracing, hasInspector } = process.binding('config');\n \n // Modules with source code compiled in js2c that\n // cannot be compiled with the code cache.\n-const cannotUseCache = [\n+const cannotBeRequired = [\n   'sys',  // Deprecated.\n   'internal/v8_prof_polyfill',\n   'internal/v8_prof_processor',\n \n   'internal/per_context',\n \n   'internal/test/binding',\n-  // TODO(joyeecheung): update the C++ side so that\n-  // the code cache is also used when compiling these two files.\n+\n   'internal/bootstrap/loaders',\n   'internal/bootstrap/node'\n ];\n \n // Skip modules that cannot be required when they are not\n // built into the binary.\n if (!hasInspector) {\n-  cannotUseCache.push(\n+  cannotBeRequired.push(\n     'inspector',\n     'internal/util/inspector',\n   );\n }\n if (!hasTracing) {\n-  cannotUseCache.push('trace_events');\n+  cannotBeRequired.push('trace_events');\n }\n if (!process.versions.openssl) {\n-  cannotUseCache.push(\n+  cannotBeRequired.push(\n     'crypto',\n     'https',\n     'http2',\n@@ -67,10 +66,10 @@ if (!process.versions.openssl) {\n \n const cachableBuiltins = [];\n for (const id of NativeModule.map.keys()) {\n-  if (id.startsWith('internal/deps')) {\n-    cannotUseCache.push(id);\n+  if (id.startsWith('internal/deps') || id.startsWith('internal/main')) {\n+    cannotBeRequired.push(id);\n   }\n-  if (!cannotUseCache.includes(id)) {\n+  if (!cannotBeRequired.includes(id)) {\n     cachableBuiltins.push(id);\n   }\n }\n@@ -79,5 +78,5 @@ module.exports = {\n   cachableBuiltins,\n   getCodeCache,\n   compileFunction,\n-  cannotUseCache\n+  cannotBeRequired\n };"
        },
        {
            "sha": "7078707b83adb179b8d8a7829d18d253b61a8737",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -160,7 +160,12 @@ internalBinding('module_wrap').callbackMap = new WeakMap();\n \n // Think of this as module.exports in this file even though it is not\n // written in CommonJS style.\n-const loaderExports = { internalBinding, NativeModule };\n+const loaderExports = {\n+  internalBinding,\n+  NativeModule,\n+  require: nativeModuleRequire\n+};\n+\n const loaderId = 'internal/bootstrap/loaders';\n \n // Set up NativeModule.\n@@ -194,7 +199,7 @@ for (var i = 0; i < moduleIds.length; ++i) {\n   NativeModule.map.set(id, mod);\n }\n \n-NativeModule.require = function(id) {\n+function nativeModuleRequire(id) {\n   if (id === loaderId) {\n     return loaderExports;\n   }\n@@ -218,8 +223,9 @@ NativeModule.require = function(id) {\n   moduleLoadList.push(`NativeModule ${id}`);\n   mod.compile();\n   return mod.exports;\n-};\n+}\n \n+NativeModule.require = nativeModuleRequire;\n NativeModule.exists = function(id) {\n   return NativeModule.map.has(id);\n };"
        },
        {
            "sha": "23d72547ae900f6ce1b5aa70ef78f08cc9d9b8db",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 261,
            "deletions": 532,
            "changes": 793,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -21,546 +21,294 @@ const { internalBinding, NativeModule } = loaderExports;\n const { getOptionValue } = NativeModule.require('internal/options');\n const config = internalBinding('config');\n \n-function startup() {\n-  setupTraceCategoryState();\n-\n-  setupProcessObject();\n-\n-  // TODO(joyeecheung): this does not have to done so early, any fatal errors\n-  // thrown before user code execution should simply crash the process\n-  // and we do not care about any clean up at that point. We don't care\n-  // about emitting any events if the process crash upon bootstrap either.\n-  {\n-    const {\n-      fatalException,\n-      setUncaughtExceptionCaptureCallback,\n-      hasUncaughtExceptionCaptureCallback\n-    } = NativeModule.require('internal/process/execution');\n-\n-    process._fatalException = fatalException;\n-    process.setUncaughtExceptionCaptureCallback =\n-      setUncaughtExceptionCaptureCallback;\n-    process.hasUncaughtExceptionCaptureCallback =\n-      hasUncaughtExceptionCaptureCallback;\n-  }\n-\n-  setupGlobalVariables();\n-\n-  // Bootstrappers for all threads, including worker threads and main thread\n-  const perThreadSetup = NativeModule.require('internal/process/per_thread');\n-  // Bootstrappers for the main thread only\n-  let mainThreadSetup;\n-  // Bootstrappers for the worker threads only\n-  let workerThreadSetup;\n-  if (isMainThread) {\n-    mainThreadSetup = NativeModule.require(\n-      'internal/process/main_thread_only'\n-    );\n-  } else {\n-    workerThreadSetup = NativeModule.require(\n-      'internal/process/worker_thread_only'\n-    );\n-  }\n-\n-  // process.config is serialized config.gypi\n-  process.config = JSON.parse(internalBinding('native_module').config);\n-\n-  const rawMethods = internalBinding('process_methods');\n-  // Set up methods and events on the process object for the main thread\n-  if (isMainThread) {\n-    // This depends on process being an event emitter\n-    mainThreadSetup.setupSignalHandlers(internalBinding);\n-\n-    process.abort = rawMethods.abort;\n-    const wrapped = mainThreadSetup.wrapProcessMethods(rawMethods);\n-    process.umask = wrapped.umask;\n-    process.chdir = wrapped.chdir;\n-\n-    // TODO(joyeecheung): deprecate and remove these underscore methods\n-    process._debugProcess = rawMethods._debugProcess;\n-    process._debugEnd = rawMethods._debugEnd;\n-    process._startProfilerIdleNotifier =\n-      rawMethods._startProfilerIdleNotifier;\n-    process._stopProfilerIdleNotifier = rawMethods._stopProfilerIdleNotifier;\n-  } else {\n-    const wrapped = workerThreadSetup.wrapProcessMethods(rawMethods);\n-\n-    process.umask = wrapped.umask;\n-  }\n+setupTraceCategoryState();\n \n-  // Set up methods on the process object for all threads\n-  {\n-    process.cwd = rawMethods.cwd;\n-    process.dlopen = rawMethods.dlopen;\n-    process.uptime = rawMethods.uptime;\n-\n-    // TODO(joyeecheung): either remove them or make them public\n-    process._getActiveRequests = rawMethods._getActiveRequests;\n-    process._getActiveHandles = rawMethods._getActiveHandles;\n-\n-    // TODO(joyeecheung): remove these\n-    process.reallyExit = rawMethods.reallyExit;\n-    process._kill = rawMethods._kill;\n-\n-    const wrapped = perThreadSetup.wrapProcessMethods(rawMethods);\n-    process._rawDebug = wrapped._rawDebug;\n-    process.hrtime = wrapped.hrtime;\n-    process.hrtime.bigint = wrapped.hrtimeBigInt;\n-    process.cpuUsage = wrapped.cpuUsage;\n-    process.memoryUsage = wrapped.memoryUsage;\n-    process.kill = wrapped.kill;\n-    process.exit = wrapped.exit;\n-  }\n+setupProcessObject();\n \n+// TODO(joyeecheung): this does not have to done so early, any fatal errors\n+// thrown before user code execution should simply crash the process\n+// and we do not care about any clean up at that point. We don't care\n+// about emitting any events if the process crash upon bootstrap either.\n+{\n   const {\n-    onWarning,\n-    emitWarning\n-  } = NativeModule.require('internal/process/warning');\n-  if (!process.noProcessWarnings && process.env.NODE_NO_WARNINGS !== '1') {\n-    process.on('warning', onWarning);\n-  }\n-  process.emitWarning = emitWarning;\n-\n-  const {\n-    nextTick,\n-    runNextTicks\n-  } = NativeModule.require('internal/process/next_tick').setup();\n-\n-  process.nextTick = nextTick;\n-  // Used to emulate a tick manually in the JS land.\n-  // A better name for this function would be `runNextTicks` but\n-  // it has been exposed to the process object so we keep this legacy name\n-  // TODO(joyeecheung): either remove it or make it public\n-  process._tickCallback = runNextTicks;\n-\n-  const credentials = internalBinding('credentials');\n-  if (credentials.implementsPosixCredentials) {\n-    process.getuid = credentials.getuid;\n-    process.geteuid = credentials.geteuid;\n-    process.getgid = credentials.getgid;\n-    process.getegid = credentials.getegid;\n-    process.getgroups = credentials.getgroups;\n-\n-    if (isMainThread) {\n-      const wrapped = mainThreadSetup.wrapPosixCredentialSetters(credentials);\n-      process.initgroups = wrapped.initgroups;\n-      process.setgroups = wrapped.setgroups;\n-      process.setegid = wrapped.setegid;\n-      process.seteuid = wrapped.seteuid;\n-      process.setgid = wrapped.setgid;\n-      process.setuid = wrapped.setuid;\n-    }\n-  }\n-\n-  if (isMainThread) {\n-    const { getStdout, getStdin, getStderr } =\n-      NativeModule.require('internal/process/stdio').getMainThreadStdio();\n-    setupProcessStdio(getStdout, getStdin, getStderr);\n-  } else {\n-    const { getStdout, getStdin, getStderr } =\n-      workerThreadSetup.initializeWorkerStdio();\n-    setupProcessStdio(getStdout, getStdin, getStderr);\n-  }\n-\n-  if (config.hasInspector) {\n-    const {\n-      enable,\n-      disable\n-    } = NativeModule.require('internal/inspector_async_hook');\n-    internalBinding('inspector').registerAsyncHook(enable, disable);\n-  }\n-\n-  // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n-  // spawned by our child_process module, then initialize IPC.\n-  // This attaches some internal event listeners and creates:\n-  // process.send(), process.channel, process.connected,\n-  // process.disconnect()\n-  if (isMainThread && process.env.NODE_CHANNEL_FD) {\n-    mainThreadSetup.setupChildProcessIpcChannel();\n-  }\n-\n-  // TODO(joyeecheung): move this down further to get better snapshotting\n-  const experimentalPolicy = getOptionValue('--experimental-policy');\n-  if (isMainThread && experimentalPolicy) {\n-    process.emitWarning('Policies are experimental.',\n-                        'ExperimentalWarning');\n-    const { pathToFileURL, URL } = NativeModule.require('url');\n-    // URL here as it is slightly different parsing\n-    // no bare specifiers for now\n-    let manifestURL;\n-    if (NativeModule.require('path').isAbsolute(experimentalPolicy)) {\n-      manifestURL = new URL(`file:///${experimentalPolicy}`);\n-    } else {\n-      const cwdURL = pathToFileURL(process.cwd());\n-      cwdURL.pathname += '/';\n-      manifestURL = new URL(experimentalPolicy, cwdURL);\n-    }\n-    const fs = NativeModule.require('fs');\n-    const src = fs.readFileSync(manifestURL, 'utf8');\n-    NativeModule.require('internal/process/policy')\n-      .setup(src, manifestURL.href);\n-  }\n-\n-  const browserGlobals = !process._noBrowserGlobals;\n-  if (browserGlobals) {\n-    setupGlobalTimeouts();\n-    setupGlobalConsole();\n-    setupGlobalURL();\n-    setupGlobalEncoding();\n-    setupQueueMicrotask();\n-  }\n-\n-  setupDOMException();\n-\n-  // On OpenBSD process.execPath will be relative unless we\n-  // get the full path before process.execPath is used.\n-  if (process.platform === 'openbsd') {\n-    const { realpathSync } = NativeModule.require('fs');\n-    process.execPath = realpathSync.native(process.execPath);\n-  }\n-\n-  Object.defineProperty(process, 'argv0', {\n-    enumerable: true,\n-    configurable: false,\n-    value: process.argv[0]\n-  });\n-  process.argv[0] = process.execPath;\n-\n-  // Handle `--debug*` deprecation and invalidation.\n-  if (process._invalidDebug) {\n-    process.emitWarning(\n-      '`node --debug` and `node --debug-brk` are invalid. ' +\n-      'Please use `node --inspect` or `node --inspect-brk` instead.',\n-      'DeprecationWarning', 'DEP0062', startup, true);\n-    process.exit(9);\n-  } else if (process._deprecatedDebugBrk) {\n-    process.emitWarning(\n-      '`node --inspect --debug-brk` is deprecated. ' +\n-      'Please use `node --inspect-brk` instead.',\n-      'DeprecationWarning', 'DEP0062', startup, true);\n-  }\n-\n-  const { deprecate } = NativeModule.require('internal/util');\n-  {\n-    // Install legacy getters on the `util` binding for typechecking.\n-    // TODO(addaleax): Turn into a full runtime deprecation.\n-    const pendingDeprecation = getOptionValue('--pending-deprecation');\n-    const utilBinding = internalBinding('util');\n-    const types = NativeModule.require('internal/util/types');\n-    for (const name of [\n-      'isArrayBuffer', 'isArrayBufferView', 'isAsyncFunction',\n-      'isDataView', 'isDate', 'isExternal', 'isMap', 'isMapIterator',\n-      'isNativeError', 'isPromise', 'isRegExp', 'isSet', 'isSetIterator',\n-      'isTypedArray', 'isUint8Array', 'isAnyArrayBuffer'\n-    ]) {\n-      utilBinding[name] = pendingDeprecation ?\n-        deprecate(types[name],\n-                  'Accessing native typechecking bindings of Node ' +\n-                  'directly is deprecated. ' +\n-                  `Please use \\`util.types.${name}\\` instead.`,\n-                  'DEP0103') :\n-        types[name];\n-    }\n-  }\n+    fatalException,\n+    setUncaughtExceptionCaptureCallback,\n+    hasUncaughtExceptionCaptureCallback\n+  } = NativeModule.require('internal/process/execution');\n+\n+  process._fatalException = fatalException;\n+  process.setUncaughtExceptionCaptureCallback =\n+    setUncaughtExceptionCaptureCallback;\n+  process.hasUncaughtExceptionCaptureCallback =\n+    hasUncaughtExceptionCaptureCallback;\n+}\n \n-  // process.allowedNodeEnvironmentFlags\n-  Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n-    get() {\n-      const flags = perThreadSetup.buildAllowedFlags();\n-      process.allowedNodeEnvironmentFlags = flags;\n-      return process.allowedNodeEnvironmentFlags;\n-    },\n-    // If the user tries to set this to another value, override\n-    // this completely to that value.\n-    set(value) {\n-      Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n-        value,\n-        configurable: true,\n-        enumerable: true,\n-        writable: true\n-      });\n-    },\n-    enumerable: true,\n-    configurable: true\n-  });\n-  // process.assert\n-  process.assert = deprecate(\n-    perThreadSetup.assert,\n-    'process.assert() is deprecated. Please use the `assert` module instead.',\n-    'DEP0100');\n-\n-  // TODO(joyeecheung): this property has not been well-maintained, should we\n-  // deprecate it in favor of a better API?\n-  const { isDebugBuild, hasOpenSSL } = config;\n-  Object.defineProperty(process, 'features', {\n-    enumerable: true,\n-    writable: false,\n-    configurable: false,\n-    value: {\n-      debug: isDebugBuild,\n-      uv: true,\n-      ipv6: true,  // TODO(bnoordhuis) ping libuv\n-      tls_alpn: hasOpenSSL,\n-      tls_sni: hasOpenSSL,\n-      tls_ocsp: hasOpenSSL,\n-      tls: hasOpenSSL\n-    }\n-  });\n+setupGlobalVariables();\n+\n+// Bootstrappers for all threads, including worker threads and main thread\n+const perThreadSetup = NativeModule.require('internal/process/per_thread');\n+// Bootstrappers for the main thread only\n+let mainThreadSetup;\n+// Bootstrappers for the worker threads only\n+let workerThreadSetup;\n+if (isMainThread) {\n+  mainThreadSetup = NativeModule.require(\n+    'internal/process/main_thread_only'\n+  );\n+} else {\n+  workerThreadSetup = NativeModule.require(\n+    'internal/process/worker_thread_only'\n+  );\n+}\n \n-  // User-facing NODE_V8_COVERAGE environment variable that writes\n-  // ScriptCoverage to a specified file.\n-  if (process.env.NODE_V8_COVERAGE) {\n-    const originalReallyExit = process.reallyExit;\n-    const cwd = NativeModule.require('internal/process/execution').tryGetCwd();\n-    const { resolve } = NativeModule.require('path');\n-    // Resolve the coverage directory to an absolute path, and\n-    // overwrite process.env so that the original path gets passed\n-    // to child processes even when they switch cwd.\n-    const coverageDirectory = resolve(cwd, process.env.NODE_V8_COVERAGE);\n-    process.env.NODE_V8_COVERAGE = coverageDirectory;\n-    const {\n-      writeCoverage,\n-      setCoverageDirectory\n-    } = NativeModule.require('internal/coverage-gen/with_profiler');\n-    setCoverageDirectory(coverageDirectory);\n-    process.on('exit', writeCoverage);\n-    process.reallyExit = (code) => {\n-      writeCoverage();\n-      originalReallyExit(code);\n-    };\n-  }\n+// process.config is serialized config.gypi\n+process.config = JSON.parse(internalBinding('native_module').config);\n+\n+const rawMethods = internalBinding('process_methods');\n+// Set up methods and events on the process object for the main thread\n+if (isMainThread) {\n+  // This depends on process being an event emitter\n+  mainThreadSetup.setupSignalHandlers(internalBinding);\n+\n+  process.abort = rawMethods.abort;\n+  const wrapped = mainThreadSetup.wrapProcessMethods(rawMethods);\n+  process.umask = wrapped.umask;\n+  process.chdir = wrapped.chdir;\n+\n+  // TODO(joyeecheung): deprecate and remove these underscore methods\n+  process._debugProcess = rawMethods._debugProcess;\n+  process._debugEnd = rawMethods._debugEnd;\n+  process._startProfilerIdleNotifier =\n+    rawMethods._startProfilerIdleNotifier;\n+  process._stopProfilerIdleNotifier = rawMethods._stopProfilerIdleNotifier;\n+} else {\n+  const wrapped = workerThreadSetup.wrapProcessMethods(rawMethods);\n+\n+  process.umask = wrapped.umask;\n+}\n \n-  const perf = internalBinding('performance');\n-  const {\n-    NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,\n-  } = perf.constants;\n-  perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n+// Set up methods on the process object for all threads\n+{\n+  process.cwd = rawMethods.cwd;\n+  process.dlopen = rawMethods.dlopen;\n+  process.uptime = rawMethods.uptime;\n+\n+  // TODO(joyeecheung): either remove them or make them public\n+  process._getActiveRequests = rawMethods._getActiveRequests;\n+  process._getActiveHandles = rawMethods._getActiveHandles;\n+\n+  // TODO(joyeecheung): remove these\n+  process.reallyExit = rawMethods.reallyExit;\n+  process._kill = rawMethods._kill;\n+\n+  const wrapped = perThreadSetup.wrapProcessMethods(rawMethods);\n+  process._rawDebug = wrapped._rawDebug;\n+  process.hrtime = wrapped.hrtime;\n+  process.hrtime.bigint = wrapped.hrtimeBigInt;\n+  process.cpuUsage = wrapped.cpuUsage;\n+  process.memoryUsage = wrapped.memoryUsage;\n+  process.kill = wrapped.kill;\n+  process.exit = wrapped.exit;\n+}\n \n-  if (getOptionValue('--experimental-report')) {\n-    NativeModule.require('internal/process/report').setup();\n-  }\n+const {\n+  onWarning,\n+  emitWarning\n+} = NativeModule.require('internal/process/warning');\n+if (!process.noProcessWarnings && process.env.NODE_NO_WARNINGS !== '1') {\n+  process.on('warning', onWarning);\n+}\n+process.emitWarning = emitWarning;\n+\n+const {\n+  nextTick,\n+  runNextTicks\n+} = NativeModule.require('internal/process/next_tick').setup();\n+\n+process.nextTick = nextTick;\n+// Used to emulate a tick manually in the JS land.\n+// A better name for this function would be `runNextTicks` but\n+// it has been exposed to the process object so we keep this legacy name\n+// TODO(joyeecheung): either remove it or make it public\n+process._tickCallback = runNextTicks;\n+\n+const credentials = internalBinding('credentials');\n+if (credentials.implementsPosixCredentials) {\n+  process.getuid = credentials.getuid;\n+  process.geteuid = credentials.geteuid;\n+  process.getgid = credentials.getgid;\n+  process.getegid = credentials.getegid;\n+  process.getgroups = credentials.getgroups;\n \n   if (isMainThread) {\n-    return startMainThreadExecution;\n-  } else {\n-    return startWorkerThreadExecution;\n+    const wrapped = mainThreadSetup.wrapPosixCredentialSetters(credentials);\n+    process.initgroups = wrapped.initgroups;\n+    process.setgroups = wrapped.setgroups;\n+    process.setegid = wrapped.setegid;\n+    process.seteuid = wrapped.seteuid;\n+    process.setgid = wrapped.setgid;\n+    process.setuid = wrapped.setuid;\n   }\n }\n \n-function startWorkerThreadExecution() {\n-  // If we are in a worker thread, execute the script sent through the\n-  // message port.\n-  const {\n-    getEnvMessagePort,\n-    threadId\n-  } = internalBinding('worker');\n-  const {\n-    createMessageHandler,\n-    createWorkerFatalExeception\n-  } = NativeModule.require('internal/process/worker_thread_only');\n-\n-  // Set up the message port and start listening\n-  const debug = NativeModule.require('util').debuglog('worker');\n-  debug(`[${threadId}] is setting up worker child environment`);\n-\n-  const port = getEnvMessagePort();\n-  port.on('message', createMessageHandler(\n-    port,\n-    prepareUserCodeExecution));\n-  port.start();\n-\n-  // Overwrite fatalException\n-  process._fatalException = createWorkerFatalExeception(port);\n+if (isMainThread) {\n+  const { getStdout, getStdin, getStderr } =\n+    NativeModule.require('internal/process/stdio').getMainThreadStdio();\n+  setupProcessStdio(getStdout, getStdin, getStderr);\n+} else {\n+  const { getStdout, getStdin, getStderr } =\n+    workerThreadSetup.initializeWorkerStdio();\n+  setupProcessStdio(getStdout, getStdin, getStderr);\n }\n \n-// There are various modes that Node can run in. The most common two\n-// are running from a script and running the REPL - but there are a few\n-// others like the debugger or running --eval arguments. Here we decide\n-// which mode we run in.\n-function startMainThreadExecution(mainScript) {\n-  if (mainScript) {\n-    process.nextTick(() => {\n-      NativeModule.require(mainScript);\n-    });\n-    return;\n-  }\n-\n-  // `node inspect ...` or `node debug ...`\n-  if (process.argv[1] === 'inspect' || process.argv[1] === 'debug') {\n-    if (process.argv[1] === 'debug') {\n-      process.emitWarning(\n-        '`node debug` is deprecated. Please use `node inspect` instead.',\n-        'DeprecationWarning', 'DEP0068');\n-    }\n-\n-    // Start the debugger agent.\n-    process.nextTick(() => {\n-      NativeModule.require('internal/deps/node-inspect/lib/_inspect').start();\n-    });\n-    return;\n-  }\n-\n-  // node --help\n-  if (getOptionValue('--help')) {\n-    NativeModule.require('internal/print_help').print(process.stdout);\n-    return;\n-  }\n-\n-  // e.g. node --completion-bash >> ~/.bashrc\n-  if (getOptionValue('--completion-bash')) {\n-    NativeModule.require('internal/bash_completion').print(process.stdout);\n-    return;\n-  }\n-\n-  // `node --prof-process`\n-  if (getOptionValue('--prof-process')) {\n-    NativeModule.require('internal/v8_prof_processor');\n-    return;\n-  }\n-\n-  // There is user code to be run.\n-  prepareUserCodeExecution();\n-  executeUserCode();\n+if (config.hasInspector) {\n+  const {\n+    enable,\n+    disable\n+  } = NativeModule.require('internal/inspector_async_hook');\n+  internalBinding('inspector').registerAsyncHook(enable, disable);\n }\n \n-function prepareUserCodeExecution() {\n-  // If this is a worker in cluster mode, start up the communication\n-  // channel. This needs to be done before any user code gets executed\n-  // (including preload modules).\n-  if (process.argv[1] && process.env.NODE_UNIQUE_ID) {\n-    const cluster = NativeModule.require('cluster');\n-    cluster._setupWorker();\n-    // Make sure it's not accidentally inherited by child processes.\n-    delete process.env.NODE_UNIQUE_ID;\n-  }\n+// If the process is spawned with env NODE_CHANNEL_FD, it's probably\n+// spawned by our child_process module, then initialize IPC.\n+// This attaches some internal event listeners and creates:\n+// process.send(), process.channel, process.connected,\n+// process.disconnect()\n+if (isMainThread && process.env.NODE_CHANNEL_FD) {\n+  mainThreadSetup.setupChildProcessIpcChannel();\n+}\n \n-  const experimentalModules = getOptionValue('--experimental-modules');\n-  const experimentalVMModules = getOptionValue('--experimental-vm-modules');\n-  if (experimentalModules || experimentalVMModules) {\n-    if (experimentalModules) {\n-      process.emitWarning(\n-        'The ESM module loader is experimental.',\n-        'ExperimentalWarning', undefined);\n-    }\n+const browserGlobals = !process._noBrowserGlobals;\n+if (browserGlobals) {\n+  setupGlobalTimeouts();\n+  setupGlobalConsole();\n+  setupGlobalURL();\n+  setupGlobalEncoding();\n+  setupQueueMicrotask();\n+}\n \n-    const {\n-      setImportModuleDynamicallyCallback,\n-      setInitializeImportMetaObjectCallback\n-    } = internalBinding('module_wrap');\n-    const esm = NativeModule.require('internal/process/esm_loader');\n-    // Setup per-isolate callbacks that locate data or callbacks that we keep\n-    // track of for different ESM modules.\n-    setInitializeImportMetaObjectCallback(esm.initializeImportMetaObject);\n-    setImportModuleDynamicallyCallback(esm.importModuleDynamicallyCallback);\n-    const userLoader = getOptionValue('--loader');\n-    // If --loader is specified, create a loader with user hooks. Otherwise\n-    // create the default loader.\n-    esm.initializeLoader(process.cwd(), userLoader);\n-  }\n+setupDOMException();\n \n-  // For user code, we preload modules if `-r` is passed\n-  const preloadModules = getOptionValue('--require');\n-  if (preloadModules.length) {\n-    const {\n-      _preloadModules\n-    } = NativeModule.require('internal/modules/cjs/loader');\n-    _preloadModules(preloadModules);\n-  }\n+// On OpenBSD process.execPath will be relative unless we\n+// get the full path before process.execPath is used.\n+if (process.platform === 'openbsd') {\n+  const { realpathSync } = NativeModule.require('fs');\n+  process.execPath = realpathSync.native(process.execPath);\n }\n \n-function executeUserCode() {\n-  // User passed `-e` or `--eval` arguments to Node without `-i` or\n-  // `--interactive`.\n-  // Note that the name `forceRepl` is merely an alias of `interactive`\n-  // in code.\n-  if (getOptionValue('[has_eval_string]') && !getOptionValue('--interactive')) {\n-    const {\n-      addBuiltinLibsToObject\n-    } = NativeModule.require('internal/modules/cjs/helpers');\n-    addBuiltinLibsToObject(global);\n-    const source = getOptionValue('--eval');\n-    const { evalScript } = NativeModule.require('internal/process/execution');\n-    evalScript('[eval]', source, process._breakFirstLine);\n-    return;\n-  }\n-\n-  // If the first argument is a file name, run it as a main script\n-  if (process.argv[1] && process.argv[1] !== '-') {\n-    // Expand process.argv[1] into a full path.\n-    const path = NativeModule.require('path');\n-    process.argv[1] = path.resolve(process.argv[1]);\n-\n-    const CJSModule = NativeModule.require('internal/modules/cjs/loader');\n-\n-    // If user passed `-c` or `--check` arguments to Node, check its syntax\n-    // instead of actually running the file.\n-    if (getOptionValue('--check')) {\n-      const fs = NativeModule.require('fs');\n-      // Read the source.\n-      const filename = CJSModule._resolveFilename(process.argv[1]);\n-      const source = fs.readFileSync(filename, 'utf-8');\n-      checkScriptSyntax(source, filename);\n-      process.exit(0);\n-    }\n+Object.defineProperty(process, 'argv0', {\n+  enumerable: true,\n+  configurable: false,\n+  value: process.argv[0]\n+});\n+process.argv[0] = process.execPath;\n+\n+// Handle `--debug*` deprecation and invalidation.\n+if (process._invalidDebug) {\n+  process.emitWarning(\n+    '`node --debug` and `node --debug-brk` are invalid. ' +\n+    'Please use `node --inspect` or `node --inspect-brk` instead.',\n+    'DeprecationWarning', 'DEP0062', undefined, true);\n+  process.exit(9);\n+} else if (process._deprecatedDebugBrk) {\n+  process.emitWarning(\n+    '`node --inspect --debug-brk` is deprecated. ' +\n+    'Please use `node --inspect-brk` instead.',\n+    'DeprecationWarning', 'DEP0062', undefined, true);\n+}\n \n-    // Note: this actually tries to run the module as a ESM first if\n-    // --experimental-modules is on.\n-    // TODO(joyeecheung): can we move that logic to here? Note that this\n-    // is an undocumented method available via `require('module').runMain`\n-    CJSModule.runMain();\n-    return;\n+const { deprecate } = NativeModule.require('internal/util');\n+{\n+  // Install legacy getters on the `util` binding for typechecking.\n+  // TODO(addaleax): Turn into a full runtime deprecation.\n+  const pendingDeprecation = getOptionValue('--pending-deprecation');\n+  const utilBinding = internalBinding('util');\n+  const types = NativeModule.require('internal/util/types');\n+  for (const name of [\n+    'isArrayBuffer', 'isArrayBufferView', 'isAsyncFunction',\n+    'isDataView', 'isDate', 'isExternal', 'isMap', 'isMapIterator',\n+    'isNativeError', 'isPromise', 'isRegExp', 'isSet', 'isSetIterator',\n+    'isTypedArray', 'isUint8Array', 'isAnyArrayBuffer'\n+  ]) {\n+    utilBinding[name] = pendingDeprecation ?\n+      deprecate(types[name],\n+                'Accessing native typechecking bindings of Node ' +\n+                'directly is deprecated. ' +\n+                `Please use \\`util.types.${name}\\` instead.`,\n+                'DEP0103') :\n+      types[name];\n   }\n+}\n \n-  // Create the REPL if `-i` or `--interactive` is passed, or if\n-  // stdin is a TTY.\n-  // Note that the name `forceRepl` is merely an alias of `interactive`\n-  // in code.\n-  if (process._forceRepl || NativeModule.require('tty').isatty(0)) {\n-    const cliRepl = NativeModule.require('internal/repl');\n-    cliRepl.createInternalRepl(process.env, (err, repl) => {\n-      if (err) {\n-        throw err;\n-      }\n-      repl.on('exit', () => {\n-        if (repl._flushing) {\n-          repl.pause();\n-          return repl.once('flushHistory', () => {\n-            process.exit();\n-          });\n-        }\n-        process.exit();\n-      });\n+// process.allowedNodeEnvironmentFlags\n+Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n+  get() {\n+    const flags = perThreadSetup.buildAllowedFlags();\n+    process.allowedNodeEnvironmentFlags = flags;\n+    return process.allowedNodeEnvironmentFlags;\n+  },\n+  // If the user tries to set this to another value, override\n+  // this completely to that value.\n+  set(value) {\n+    Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n+      value,\n+      configurable: true,\n+      enumerable: true,\n+      writable: true\n     });\n-\n-    // User passed '-e' or '--eval' along with `-i` or `--interactive`\n-    if (process._eval != null) {\n-      const { evalScript } = NativeModule.require('internal/process/execution');\n-      evalScript('[eval]', process._eval, process._breakFirstLine);\n-    }\n-    return;\n-  }\n-\n-  // Stdin is not a TTY, we will read it and execute it.\n-  readAndExecuteStdin();\n+  },\n+  enumerable: true,\n+  configurable: true\n+});\n+// process.assert\n+process.assert = deprecate(\n+  perThreadSetup.assert,\n+  'process.assert() is deprecated. Please use the `assert` module instead.',\n+  'DEP0100');\n+\n+// TODO(joyeecheung): this property has not been well-maintained, should we\n+// deprecate it in favor of a better API?\n+const { isDebugBuild, hasOpenSSL } = config;\n+Object.defineProperty(process, 'features', {\n+  enumerable: true,\n+  writable: false,\n+  configurable: false,\n+  value: {\n+    debug: isDebugBuild,\n+    uv: true,\n+    ipv6: true,  // TODO(bnoordhuis) ping libuv\n+    tls_alpn: hasOpenSSL,\n+    tls_sni: hasOpenSSL,\n+    tls_ocsp: hasOpenSSL,\n+    tls: hasOpenSSL\n+  }\n+});\n+\n+// User-facing NODE_V8_COVERAGE environment variable that writes\n+// ScriptCoverage to a specified file.\n+if (process.env.NODE_V8_COVERAGE) {\n+  const originalReallyExit = process.reallyExit;\n+  const cwd = NativeModule.require('internal/process/execution').tryGetCwd();\n+  const { resolve } = NativeModule.require('path');\n+  // Resolve the coverage directory to an absolute path, and\n+  // overwrite process.env so that the original path gets passed\n+  // to child processes even when they switch cwd.\n+  const coverageDirectory = resolve(cwd, process.env.NODE_V8_COVERAGE);\n+  process.env.NODE_V8_COVERAGE = coverageDirectory;\n+  const {\n+    writeCoverage,\n+    setCoverageDirectory\n+  } = NativeModule.require('internal/coverage-gen/with_profiler');\n+  setCoverageDirectory(coverageDirectory);\n+  process.on('exit', writeCoverage);\n+  process.reallyExit = (code) => {\n+    writeCoverage();\n+    originalReallyExit(code);\n+  };\n }\n \n-function readAndExecuteStdin() {\n-  process.stdin.setEncoding('utf8');\n-\n-  let code = '';\n-  process.stdin.on('data', (d) => {\n-    code += d;\n-  });\n-\n-  process.stdin.on('end', () => {\n-    if (process._syntax_check_only != null) {\n-      checkScriptSyntax(code, '[stdin]');\n-    } else {\n-      process._eval = code;\n-      const { evalScript } = NativeModule.require('internal/process/execution');\n-      evalScript('[stdin]', process._eval, process._breakFirstLine);\n-    }\n-  });\n+if (getOptionValue('--experimental-report')) {\n+  NativeModule.require('internal/process/report').setup();\n }\n \n function setupTraceCategoryState() {\n@@ -795,22 +543,3 @@ function setupDOMException() {\n   const { registerDOMException } = internalBinding('messaging');\n   registerDOMException(DOMException);\n }\n-\n-function checkScriptSyntax(source, filename) {\n-  const CJSModule = NativeModule.require('internal/modules/cjs/loader');\n-  const vm = NativeModule.require('vm');\n-  const {\n-    stripShebang, stripBOM\n-  } = NativeModule.require('internal/modules/cjs/helpers');\n-\n-  // Remove Shebang.\n-  source = stripShebang(source);\n-  // Remove BOM.\n-  source = stripBOM(source);\n-  // Wrap it.\n-  source = CJSModule.wrap(source);\n-  // Compile the script, this will throw if it fails.\n-  new vm.Script(source, { displayErrors: true, filename });\n-}\n-\n-return startup();"
        },
        {
            "sha": "798c581a7217359d5950d251a7f7bc1ce7535ad9",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,82 @@\n+'use strict';\n+\n+const { getOptionValue } = require('internal/options');\n+\n+function initializeClusterIPC() {\n+  // If this is a worker in cluster mode, start up the communication\n+  // channel. This needs to be done before any user code gets executed\n+  // (including preload modules).\n+  if (process.argv[1] && process.env.NODE_UNIQUE_ID) {\n+    const cluster = require('cluster');\n+    cluster._setupWorker();\n+    // Make sure it's not accidentally inherited by child processes.\n+    delete process.env.NODE_UNIQUE_ID;\n+  }\n+}\n+\n+function initializePolicy() {\n+  const experimentalPolicy = getOptionValue('--experimental-policy');\n+  if (experimentalPolicy) {\n+    process.emitWarning('Policies are experimental.',\n+                        'ExperimentalWarning');\n+    const { pathToFileURL, URL } = require('url');\n+    // URL here as it is slightly different parsing\n+    // no bare specifiers for now\n+    let manifestURL;\n+    if (require('path').isAbsolute(experimentalPolicy)) {\n+      manifestURL = new URL(`file:///${experimentalPolicy}`);\n+    } else {\n+      const cwdURL = pathToFileURL(process.cwd());\n+      cwdURL.pathname += '/';\n+      manifestURL = new URL(experimentalPolicy, cwdURL);\n+    }\n+    const fs = require('fs');\n+    const src = fs.readFileSync(manifestURL, 'utf8');\n+    require('internal/process/policy')\n+      .setup(src, manifestURL.href);\n+  }\n+}\n+\n+function initializeESMLoader() {\n+  const experimentalModules = getOptionValue('--experimental-modules');\n+  const experimentalVMModules = getOptionValue('--experimental-vm-modules');\n+  if (experimentalModules || experimentalVMModules) {\n+    if (experimentalModules) {\n+      process.emitWarning(\n+        'The ESM module loader is experimental.',\n+        'ExperimentalWarning', undefined);\n+    }\n+\n+    const {\n+      setImportModuleDynamicallyCallback,\n+      setInitializeImportMetaObjectCallback\n+    } = internalBinding('module_wrap');\n+    const esm = require('internal/process/esm_loader');\n+    // Setup per-isolate callbacks that locate data or callbacks that we keep\n+    // track of for different ESM modules.\n+    setInitializeImportMetaObjectCallback(esm.initializeImportMetaObject);\n+    setImportModuleDynamicallyCallback(esm.importModuleDynamicallyCallback);\n+    const userLoader = getOptionValue('--loader');\n+    // If --loader is specified, create a loader with user hooks. Otherwise\n+    // create the default loader.\n+    esm.initializeLoader(process.cwd(), userLoader);\n+  }\n+}\n+\n+function loadPreloadModules() {\n+  // For user code, we preload modules if `-r` is passed\n+  const preloadModules = getOptionValue('--require');\n+  if (preloadModules) {\n+    const {\n+      _preloadModules\n+    } = require('internal/modules/cjs/loader');\n+    _preloadModules(preloadModules);\n+  }\n+}\n+\n+module.exports = {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+};"
        },
        {
            "sha": "dfb75077782301f903f1cb583ef81f3f34896299",
            "filename": "lib/internal/main/.eslintrc.yaml",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2F.eslintrc.yaml",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2F.eslintrc.yaml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2F.eslintrc.yaml?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,2 @@\n+globals:\n+  markBootstrapComplete: true"
        },
        {
            "sha": "5d4d7a04ebd0eba87a35b40f6fcc7068db6c95c2",
            "filename": "lib/internal/main/check_syntax.js",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fcheck_syntax.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,56 @@\n+'use strict';\n+\n+// If user passed `-c` or `--check` arguments to Node, check its syntax\n+// instead of actually running the file.\n+\n+const {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+\n+const {\n+  readStdin\n+} = require('internal/process/execution');\n+\n+const CJSModule = require('internal/modules/cjs/loader');\n+const vm = require('vm');\n+const {\n+  stripShebang, stripBOM\n+} = require('internal/modules/cjs/helpers');\n+\n+// TODO(joyeecheung): not every one of these are necessary\n+initializeClusterIPC();\n+initializePolicy();\n+initializeESMLoader();\n+loadPreloadModules();\n+markBootstrapComplete();\n+\n+if (process.argv[1] && process.argv[1] !== '-') {\n+  // Expand process.argv[1] into a full path.\n+  const path = require('path');\n+  process.argv[1] = path.resolve(process.argv[1]);\n+  // Read the source.\n+  const filename = CJSModule._resolveFilename(process.argv[1]);\n+\n+  const fs = require('fs');\n+  const source = fs.readFileSync(filename, 'utf-8');\n+\n+  checkScriptSyntax(source, filename);\n+} else {\n+  readStdin((code) => {\n+    checkScriptSyntax(code, '[stdin]');\n+  });\n+}\n+\n+function checkScriptSyntax(source, filename) {\n+  // Remove Shebang.\n+  source = stripShebang(source);\n+  // Remove BOM.\n+  source = stripBOM(source);\n+  // Wrap it.\n+  source = CJSModule.wrap(source);\n+  // Compile the script, this will throw if it fails.\n+  new vm.Script(source, { displayErrors: true, filename });\n+}"
        },
        {
            "sha": "ad15fdb93cd49d04766bd42a9b1c7e16b7cc6253",
            "filename": "lib/internal/main/eval_stdin.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Feval_stdin.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Feval_stdin.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Feval_stdin.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+\n+// Stdin is not a TTY, we will read it and execute it.\n+\n+const {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+\n+const {\n+  evalScript,\n+  readStdin\n+} = require('internal/process/execution');\n+\n+initializeClusterIPC();\n+initializePolicy();\n+initializeESMLoader();\n+loadPreloadModules();\n+markBootstrapComplete();\n+\n+readStdin((code) => {\n+  process._eval = code;\n+  evalScript('[stdin]', process._eval, process._breakFirstLine);\n+});"
        },
        {
            "sha": "cd382b48e76663b0c5d65705ef2646fe9ada33cd",
            "filename": "lib/internal/main/eval_string.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Feval_string.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Feval_string.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Feval_string.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+\n+// User passed `-e` or `--eval` arguments to Node without `-i` or\n+// `--interactive`.\n+\n+const {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+const { evalScript } = require('internal/process/execution');\n+const { addBuiltinLibsToObject } = require('internal/modules/cjs/helpers');\n+\n+const source = require('internal/options').getOptionValue('--eval');\n+initializeClusterIPC();\n+initializePolicy();\n+initializeESMLoader();\n+loadPreloadModules();\n+addBuiltinLibsToObject(global);\n+markBootstrapComplete();\n+evalScript('[eval]', source, process._breakFirstLine);"
        },
        {
            "sha": "7376f8984b13e14ebe94380af7b9bff22be96813",
            "filename": "lib/internal/main/inspect.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Finspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Finspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Finspect.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,16 @@\n+'use strict';\n+\n+// `node inspect ...` or `node debug ...`\n+\n+if (process.argv[1] === 'debug') {\n+  process.emitWarning(\n+    '`node debug` is deprecated. Please use `node inspect` instead.',\n+    'DeprecationWarning', 'DEP0068');\n+}\n+\n+markBootstrapComplete();\n+\n+// Start the debugger agent.\n+process.nextTick(() => {\n+  require('internal/deps/node-inspect/lib/_inspect').start();\n+});"
        },
        {
            "sha": "225ed3d2221c0008ef1ee477bef920135f050398",
            "filename": "lib/internal/main/print_bash_completion.js",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprint_bash_completion.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprint_bash_completion.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fprint_bash_completion.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -18,6 +18,6 @@ function print(stream) {\n complete -F _node_complete node node_g`);\n }\n \n-module.exports = {\n-  print\n-};\n+markBootstrapComplete();\n+\n+print(process.stdout);",
            "previous_filename": "lib/internal/bash_completion.js"
        },
        {
            "sha": "ca60994d942c6c49f7d63be20b29c18a4e86f019",
            "filename": "lib/internal/main/print_help.js",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprint_help.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprint_help.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fprint_help.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -172,6 +172,6 @@ function print(stream) {\n   stream.write('\\nDocumentation can be found at https://nodejs.org/\\n');\n }\n \n-module.exports = {\n-  print\n-};\n+markBootstrapComplete();\n+\n+print(process.stdout);",
            "previous_filename": "lib/internal/print_help.js"
        },
        {
            "sha": "a1143cb201e79c64d76c544a72bd8ef7fcbc5451",
            "filename": "lib/internal/main/prof_process.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprof_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fprof_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fprof_process.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,4 @@\n+'use strict';\n+\n+markBootstrapComplete();\n+require('internal/v8_prof_processor');"
        },
        {
            "sha": "4ca328421bcb9a89ba84cbb15141e0326c25155c",
            "filename": "lib/internal/main/repl.js",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frepl.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,44 @@\n+'use strict';\n+\n+// Create the REPL if `-i` or `--interactive` is passed, or if\n+// the main module is not specified and stdin is a TTY.\n+\n+const {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+\n+const {\n+  evalScript\n+} = require('internal/process/execution');\n+\n+initializeClusterIPC();\n+initializePolicy();\n+initializeESMLoader();\n+loadPreloadModules();\n+\n+const cliRepl = require('internal/repl');\n+cliRepl.createInternalRepl(process.env, (err, repl) => {\n+  if (err) {\n+    throw err;\n+  }\n+  repl.on('exit', () => {\n+    if (repl._flushing) {\n+      repl.pause();\n+      return repl.once('flushHistory', () => {\n+        process.exit();\n+      });\n+    }\n+    process.exit();\n+  });\n+});\n+\n+// If user passed '-e' or '--eval' along with `-i` or `--interactive`,\n+// evaluate the code in the current context.\n+if (process._eval != null) {\n+  evalScript('[eval]', process._eval, process._breakFirstLine);\n+}\n+\n+markBootstrapComplete();"
        },
        {
            "sha": "b5049cffc5250cc820b4eb3b6f72682be9a94bae",
            "filename": "lib/internal/main/run_main_module.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frun_main_module.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,27 @@\n+'use strict';\n+\n+const {\n+  initializeClusterIPC,\n+  initializePolicy,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+\n+initializeClusterIPC();\n+initializePolicy();\n+initializeESMLoader();\n+loadPreloadModules();\n+\n+// Expand process.argv[1] into a full path.\n+const path = require('path');\n+process.argv[1] = path.resolve(process.argv[1]);\n+\n+const CJSModule = require('internal/modules/cjs/loader');\n+\n+markBootstrapComplete();\n+\n+// Note: this actually tries to run the module as a ESM first if\n+// --experimental-modules is on.\n+// TODO(joyeecheung): can we move that logic to here? Note that this\n+// is an undocumented method available via `require('module').runMain`\n+CJSModule.runMain();"
        },
        {
            "sha": "c26c1f25f380c8beb44dd4d9a95ff62d2b38a572",
            "filename": "lib/internal/main/run_third_party_main.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frun_third_party_main.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Frun_third_party_main.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frun_third_party_main.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,9 @@\n+'use strict';\n+\n+// Legacy _third_party_main.js support\n+\n+markBootstrapComplete();\n+\n+process.nextTick(() => {\n+  require('_third_party_main');\n+});"
        },
        {
            "sha": "62a4bb1b7dd77ee8e5f19f760f696ae59ce17296",
            "filename": "lib/internal/main/worker_thread.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fworker_thread.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+\n+// In worker threads, execute the script sent through the\n+// message port.\n+\n+const {\n+  initializeClusterIPC,\n+  initializeESMLoader,\n+  loadPreloadModules\n+} = require('internal/bootstrap/pre_execution');\n+\n+const {\n+  getEnvMessagePort,\n+  threadId\n+} = internalBinding('worker');\n+\n+const {\n+  createMessageHandler,\n+  createWorkerFatalExeception\n+} = require('internal/process/worker_thread_only');\n+\n+const debug = require('util').debuglog('worker');\n+debug(`[${threadId}] is setting up worker child environment`);\n+\n+function prepareUserCodeExecution() {\n+  initializeClusterIPC();\n+  initializeESMLoader();\n+  loadPreloadModules();\n+}\n+\n+// Set up the message port and start listening\n+const port = getEnvMessagePort();\n+port.on('message', createMessageHandler(port, prepareUserCodeExecution));\n+port.start();\n+\n+// Overwrite fatalException\n+process._fatalException = createWorkerFatalExeception(port);\n+\n+markBootstrapComplete();"
        },
        {
            "sha": "74d6575e0a9114594e83b289e206b5b28c02bdb3",
            "filename": "lib/internal/process/execution.js",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fprocess%2Fexecution.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/lib%2Finternal%2Fprocess%2Fexecution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fexecution.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -165,7 +165,21 @@ function createFatalException() {\n   };\n }\n \n+function readStdin(callback) {\n+  process.stdin.setEncoding('utf8');\n+\n+  let code = '';\n+  process.stdin.on('data', (d) => {\n+    code += d;\n+  });\n+\n+  process.stdin.on('end', () => {\n+    callback(code);\n+  });\n+}\n+\n module.exports = {\n+  readStdin,\n   tryGetCwd,\n   evalScript,\n   fatalException: createFatalException(),"
        },
        {
            "sha": "c7107f02953c8ad44743a61044e80eb7de1dda6a",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -29,6 +29,7 @@\n       'lib/internal/bootstrap/cache.js',\n       'lib/internal/bootstrap/loaders.js',\n       'lib/internal/bootstrap/node.js',\n+      'lib/internal/bootstrap/pre_execution.js',\n       'lib/async_hooks.js',\n       'lib/assert.js',\n       'lib/buffer.js',\n@@ -85,7 +86,6 @@\n       'lib/zlib.js',\n       'lib/internal/assert.js',\n       'lib/internal/async_hooks.js',\n-      'lib/internal/bash_completion.js',\n       'lib/internal/buffer.js',\n       'lib/internal/cli_table.js',\n       'lib/internal/child_process.js',\n@@ -130,6 +130,17 @@\n       'lib/internal/inspector_async_hook.js',\n       'lib/internal/js_stream_socket.js',\n       'lib/internal/linkedlist.js',\n+      'lib/internal/main/check_syntax.js',\n+      'lib/internal/main/eval_string.js',\n+      'lib/internal/main/eval_stdin.js',\n+      'lib/internal/main/inspect.js',\n+      'lib/internal/main/print_bash_completion.js',\n+      'lib/internal/main/print_help.js',\n+      'lib/internal/main/prof_process.js',\n+      'lib/internal/main/repl.js',\n+      'lib/internal/main/run_main_module.js',\n+      'lib/internal/main/run_third_party_main.js',\n+      'lib/internal/main/worker_thread.js',\n       'lib/internal/modules/cjs/helpers.js',\n       'lib/internal/modules/cjs/loader.js',\n       'lib/internal/modules/esm/loader.js',\n@@ -141,9 +152,8 @@\n       'lib/internal/safe_globals.js',\n       'lib/internal/net.js',\n       'lib/internal/options.js',\n-      'lib/internal/policy/sri.js',\n       'lib/internal/policy/manifest.js',\n-      'lib/internal/print_help.js',\n+      'lib/internal/policy/sri.js',\n       'lib/internal/priority_queue.js',\n       'lib/internal/process/esm_loader.js',\n       'lib/internal/process/execution.js',"
        },
        {
            "sha": "8ecab92df73f1f3901624af987d3083efbbbc9df",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -332,9 +332,20 @@ void Environment::Start(bool start_profiler_idle_notifier) {\n   uv_key_set(&thread_local_env, this);\n }\n \n-MaybeLocal<Object> Environment::CreateProcessObject(\n+MaybeLocal<Object> Environment::ProcessCliArgs(\n     const std::vector<std::string>& args,\n     const std::vector<std::string>& exec_args) {\n+  if (args.size() > 1) {\n+    std::string first_arg = args[1];\n+    if (first_arg == \"inspect\") {\n+      execution_mode_ = ExecutionMode::kInspect;\n+    } else if (first_arg == \"debug\") {\n+      execution_mode_ = ExecutionMode::kDebug;\n+    } else if (first_arg != \"-\") {\n+      execution_mode_ = ExecutionMode::kRunMainModule;\n+    }\n+  }\n+\n   if (*TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n           TRACING_CATEGORY_NODE1(environment)) != 0) {\n     auto traced_value = tracing::TracedValue::Create();"
        },
        {
            "sha": "139694104e1da0fbed46e4491fdc067cdbcce552",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -315,7 +315,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(write_host_object_string, \"_writeHostObject\")                              \\\n   V(write_queue_size_string, \"writeQueueSize\")                                 \\\n   V(x_forwarded_string, \"x-forwarded-for\")                                     \\\n-  V(zero_return_string, \"ZERO_RETURN\")                                         \\\n+  V(zero_return_string, \"ZERO_RETURN\")\n \n #define ENVIRONMENT_STRONG_PERSISTENT_PROPERTIES(V)                            \\\n   V(as_external, v8::External)                                                 \\\n@@ -355,11 +355,13 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(http2session_on_stream_trailers_function, v8::Function)                    \\\n   V(http2settings_constructor_template, v8::ObjectTemplate)                    \\\n   V(http2stream_constructor_template, v8::ObjectTemplate)                      \\\n+  V(internal_binding_loader, v8::Function)                                     \\\n   V(immediate_callback_function, v8::Function)                                 \\\n   V(inspector_console_extension_installer, v8::Function)                       \\\n   V(libuv_stream_wrap_ctor_template, v8::FunctionTemplate)                     \\\n   V(message_port, v8::Object)                                                  \\\n   V(message_port_constructor_template, v8::FunctionTemplate)                   \\\n+  V(native_module_require, v8::Function)                                       \\\n   V(performance_entry_callback, v8::Function)                                  \\\n   V(performance_entry_template, v8::Function)                                  \\\n   V(pipe_constructor_template, v8::FunctionTemplate)                           \\\n@@ -371,7 +373,6 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(script_data_constructor_function, v8::Function)                            \\\n   V(secure_context_constructor_template, v8::FunctionTemplate)                 \\\n   V(shutdown_wrap_template, v8::ObjectTemplate)                                \\\n-  V(start_execution_function, v8::Function)                                    \\\n   V(tcp_constructor_template, v8::FunctionTemplate)                            \\\n   V(tick_callback_function, v8::Function)                                      \\\n   V(timers_callback_function, v8::Function)                                    \\\n@@ -611,7 +612,7 @@ class Environment {\n   ~Environment();\n \n   void Start(bool start_profiler_idle_notifier);\n-  v8::MaybeLocal<v8::Object> CreateProcessObject(\n+  v8::MaybeLocal<v8::Object> ProcessCliArgs(\n       const std::vector<std::string>& args,\n       const std::vector<std::string>& exec_args);\n \n@@ -928,6 +929,24 @@ class Environment {\n   inline std::shared_ptr<EnvironmentOptions> options();\n   inline std::shared_ptr<HostPort> inspector_host_port();\n \n+  enum class ExecutionMode {\n+    kDefault,\n+    kInspect,              // node inspect\n+    kDebug,                // node debug\n+    kPrintHelp,            // node --help\n+    kPrintBashCompletion,  // node --completion-bash\n+    kProfProcess,          // node --prof-process\n+    kEvalString,           // node --eval without --interactive\n+    kCheckSyntax,          // node --check (incompatible with --eval)\n+    kRepl,\n+    kEvalStdin,\n+    kRunMainModule\n+  };\n+\n+  inline ExecutionMode execution_mode() { return execution_mode_; }\n+\n+  inline void set_execution_mode(ExecutionMode mode) { execution_mode_ = mode; }\n+\n  private:\n   inline void CreateImmediate(native_immediate_callback cb,\n                               void* data,\n@@ -937,6 +956,7 @@ class Environment {\n   inline void ThrowError(v8::Local<v8::Value> (*fun)(v8::Local<v8::String>),\n                          const char* errmsg);\n \n+  ExecutionMode execution_mode_ = ExecutionMode::kDefault;\n   std::list<binding::DLib> loaded_addons_;\n   v8::Isolate* const isolate_;\n   IsolateData* const isolate_data_;"
        },
        {
            "sha": "e67b16af83f0dfe0a6ca9d38c0996f618c37b6b1",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 142,
            "deletions": 74,
            "changes": 216,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -100,6 +100,7 @@\n #if defined(_MSC_VER)\n #include <direct.h>\n #include <io.h>\n+#define STDIN_FILENO 0\n #else\n #include <pthread.h>\n #include <sys/resource.h>  // getrlimit, setrlimit\n@@ -114,6 +115,7 @@ using v8::Array;\n using v8::Boolean;\n using v8::Context;\n using v8::DEFAULT;\n+using v8::EscapableHandleScope;\n using v8::Exception;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n@@ -605,8 +607,20 @@ static MaybeLocal<Value> ExecuteBootstrapper(\n     const char* id,\n     std::vector<Local<String>>* parameters,\n     std::vector<Local<Value>>* arguments) {\n-  MaybeLocal<Value> ret = per_process::native_module_loader.CompileAndCall(\n-      env->context(), id, parameters, arguments, env);\n+  EscapableHandleScope scope(env->isolate());\n+  MaybeLocal<Function> maybe_fn =\n+      per_process::native_module_loader.LookupAndCompile(\n+          env->context(), id, parameters, env);\n+\n+  if (maybe_fn.IsEmpty()) {\n+    return MaybeLocal<Value>();\n+  }\n+\n+  Local<Function> fn = maybe_fn.ToLocalChecked();\n+  MaybeLocal<Value> result = fn->Call(env->context(),\n+                                      Undefined(env->isolate()),\n+                                      arguments->size(),\n+                                      arguments->data());\n \n   // If there was an error during bootstrap then it was either handled by the\n   // FatalException handler or it's unrecoverable (e.g. max call stack\n@@ -615,44 +629,17 @@ static MaybeLocal<Value> ExecuteBootstrapper(\n   // There are only two ways to have a stack size > 1: 1) the user manually\n   // called MakeCallback or 2) user awaited during bootstrap, which triggered\n   // _tickCallback().\n-  if (ret.IsEmpty()) {\n+  if (result.IsEmpty()) {\n     env->async_hooks()->clear_async_id_stack();\n   }\n \n-  return ret;\n-}\n-\n-void LoadEnvironment(Environment* env) {\n-  RunBootstrapping(env);\n-\n-  // To allow people to extend Node in different ways, this hook allows\n-  // one to drop a file lib/_third_party_main.js into the build\n-  // directory which will be executed instead of Node's normal loading.\n-  if (per_process::native_module_loader.Exists(\"_third_party_main\")) {\n-    StartExecution(env, \"_third_party_main\");\n-  } else {\n-    // TODO(joyeecheung): create different scripts for different\n-    // execution modes:\n-    // - `main_thread_main.js` when env->is_main_thread()\n-    // - `worker_thread_main.js` when !env->is_main_thread()\n-    // - `run_third_party_main.js` for `_third_party_main`\n-    // - `inspect_main.js` for `node inspect`\n-    // - `mkcodecache_main.js` for the code cache generator\n-    // - `print_help_main.js` for --help\n-    // - `bash_completion_main.js` for --completion-bash\n-    // - `internal/v8_prof_processor` for --prof-process\n-    // And leave bootstrap/node.js dedicated to the setup of the environment.\n-    // We may want to move this switch out of LoadEnvironment, especially for\n-    // the per-process options.\n-    StartExecution(env, nullptr);\n-  }\n+  return scope.EscapeMaybe(result);\n }\n \n-void RunBootstrapping(Environment* env) {\n+MaybeLocal<Value> RunBootstrapping(Environment* env) {\n   CHECK(!env->has_run_bootstrapping_code());\n-  env->set_has_run_bootstrapping_code(true);\n \n-  HandleScope handle_scope(env->isolate());\n+  EscapableHandleScope scope(env->isolate());\n   Isolate* isolate = env->isolate();\n   Local<Context> context = env->context();\n \n@@ -702,58 +689,132 @@ void RunBootstrapping(Environment* env) {\n       Boolean::New(isolate,\n                    env->options()->expose_internals)};\n \n-  MaybeLocal<Value> loader_exports;\n   // Bootstrap internal loaders\n-  loader_exports = ExecuteBootstrapper(\n+  MaybeLocal<Value> loader_exports = ExecuteBootstrapper(\n       env, \"internal/bootstrap/loaders\", &loaders_params, &loaders_args);\n   if (loader_exports.IsEmpty()) {\n-    return;\n+    return MaybeLocal<Value>();\n   }\n \n+  Local<Object> loader_exports_obj =\n+      loader_exports.ToLocalChecked().As<Object>();\n+  Local<Value> internal_binding_loader =\n+      loader_exports_obj->Get(context, env->internal_binding_string())\n+          .ToLocalChecked();\n+  env->set_internal_binding_loader(internal_binding_loader.As<Function>());\n+\n+  Local<Value> require =\n+      loader_exports_obj->Get(context, env->require_string()).ToLocalChecked();\n+  env->set_native_module_require(require.As<Function>());\n+\n   // process, loaderExports, isMainThread\n   std::vector<Local<String>> node_params = {\n       env->process_string(),\n       FIXED_ONE_BYTE_STRING(isolate, \"loaderExports\"),\n       FIXED_ONE_BYTE_STRING(isolate, \"isMainThread\")};\n   std::vector<Local<Value>> node_args = {\n       process,\n-      loader_exports.ToLocalChecked(),\n+      loader_exports_obj,\n       Boolean::New(isolate, env->is_main_thread())};\n \n-  Local<Value> start_execution;\n-  if (!ExecuteBootstrapper(\n-          env, \"internal/bootstrap/node\", &node_params, &node_args)\n-          .ToLocal(&start_execution)) {\n-    return;\n-  }\n+  MaybeLocal<Value> result = ExecuteBootstrapper(\n+      env, \"internal/bootstrap/node\", &node_params, &node_args);\n \n-  if (start_execution->IsFunction())\n-    env->set_start_execution_function(start_execution.As<Function>());\n+  env->set_has_run_bootstrapping_code(true);\n+\n+  return scope.EscapeMaybe(result);\n }\n \n-void StartExecution(Environment* env, const char* main_script_id) {\n-  HandleScope handle_scope(env->isolate());\n-  // We have to use Local<>::New because of the optimized way in which we access\n-  // the object in the env->...() getters, which does not play well with\n-  // resetting the handle while we're accessing the object through the Local<>.\n-  Local<Function> start_execution =\n-      Local<Function>::New(env->isolate(), env->start_execution_function());\n-  env->set_start_execution_function(Local<Function>());\n-\n-  if (start_execution.IsEmpty()) return;\n-\n-  Local<Value> main_script_v;\n-  if (main_script_id == nullptr) {\n-    // TODO(joyeecheung): make this mandatory - we may also create an overload\n-    // for main_script that is a Local<Function>.\n-    main_script_v = Undefined(env->isolate());\n-  } else {\n-    main_script_v = OneByteString(env->isolate(), main_script_id);\n+void MarkBootstrapComplete(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  env->performance_state()->Mark(\n+      performance::NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n+}\n+\n+MaybeLocal<Value> StartExecution(Environment* env, const char* main_script_id) {\n+  EscapableHandleScope scope(env->isolate());\n+  CHECK_NE(main_script_id, nullptr);\n+\n+  std::vector<Local<String>> parameters = {\n+      env->process_string(),\n+      env->require_string(),\n+      env->internal_binding_string(),\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"markBootstrapComplete\")};\n+\n+  std::vector<Local<Value>> arguments = {\n+      env->process_object(),\n+      env->native_module_require(),\n+      env->internal_binding_loader(),\n+      env->NewFunctionTemplate(MarkBootstrapComplete)\n+          ->GetFunction(env->context())\n+          .ToLocalChecked()};\n+\n+  MaybeLocal<Value> result =\n+      ExecuteBootstrapper(env, main_script_id, &parameters, &arguments);\n+  return scope.EscapeMaybe(result);\n+}\n+\n+MaybeLocal<Value> StartMainThreadExecution(Environment* env) {\n+  // To allow people to extend Node in different ways, this hook allows\n+  // one to drop a file lib/_third_party_main.js into the build\n+  // directory which will be executed instead of Node's normal loading.\n+  if (per_process::native_module_loader.Exists(\"_third_party_main\")) {\n+    return StartExecution(env, \"internal/main/run_third_party_main\");\n+  }\n+\n+  if (env->execution_mode() == Environment::ExecutionMode::kInspect ||\n+      env->execution_mode() == Environment::ExecutionMode::kDebug) {\n+    return StartExecution(env, \"internal/main/inspect\");\n+  }\n+\n+  if (per_process::cli_options->print_help) {\n+    env->set_execution_mode(Environment::ExecutionMode::kPrintHelp);\n+    return StartExecution(env, \"internal/main/print_help\");\n+  }\n+\n+  if (per_process::cli_options->print_bash_completion) {\n+    env->set_execution_mode(Environment::ExecutionMode::kPrintBashCompletion);\n+    return StartExecution(env, \"internal/main/print_bash_completion\");\n+  }\n+\n+  if (env->options()->prof_process) {\n+    env->set_execution_mode(Environment::ExecutionMode::kPrintBashCompletion);\n+    return StartExecution(env, \"internal/main/prof_process\");\n+  }\n+\n+  // -e/--eval without -i/--interactive\n+  if (env->options()->has_eval_string && !env->options()->force_repl) {\n+    env->set_execution_mode(Environment::ExecutionMode::kEvalString);\n+    return StartExecution(env, \"internal/main/eval_string\");\n+  }\n+\n+  if (env->options()->syntax_check_only) {\n+    env->set_execution_mode(Environment::ExecutionMode::kCheckSyntax);\n+    return StartExecution(env, \"internal/main/check_syntax\");\n+  }\n+\n+  if (env->execution_mode() == Environment::ExecutionMode::kRunMainModule) {\n+    return StartExecution(env, \"internal/main/run_main_module\");\n+  }\n+\n+  if (env->options()->force_repl || uv_guess_handle(STDIN_FILENO) == UV_TTY) {\n+    env->set_execution_mode(Environment::ExecutionMode::kRepl);\n+    return StartExecution(env, \"internal/main/repl\");\n   }\n \n-  Local<Value> argv[] = {main_script_v};\n-  USE(start_execution->Call(\n-      env->context(), Undefined(env->isolate()), arraysize(argv), argv));\n+  env->set_execution_mode(Environment::ExecutionMode::kEvalStdin);\n+  return StartExecution(env, \"internal/main/eval_stdin\");\n+}\n+\n+void LoadEnvironment(Environment* env) {\n+  CHECK(env->is_main_thread());\n+  // TODO(joyeecheung): Not all of the execution modes in\n+  // StartMainThreadExecution() make sense for embedders. Pick the\n+  // useful ones out, and allow embedders to customize the entry\n+  // point more directly without using _third_party_main.js\n+  if (!RunBootstrapping(env).IsEmpty()) {\n+    USE(StartMainThreadExecution(env));\n+  }\n }\n \n \n@@ -1180,7 +1241,7 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   std::vector<std::string> exec_args(exec_argv, exec_argv + exec_argc);\n   Environment* env = new Environment(isolate_data, context);\n   env->Start(per_process::v8_is_profiling);\n-  env->CreateProcessObject(args, exec_args);\n+  env->ProcessCliArgs(args, exec_args);\n   return env;\n }\n \n@@ -1220,7 +1281,7 @@ void FreePlatform(MultiIsolatePlatform* platform) {\n \n Local<Context> NewContext(Isolate* isolate,\n                           Local<ObjectTemplate> object_template) {\n-  auto context = Context::New(isolate, nullptr, object_template);\n+  Local<Context> context = Context::New(isolate, nullptr, object_template);\n   if (context.IsEmpty()) return context;\n   HandleScope handle_scope(isolate);\n \n@@ -1233,12 +1294,19 @@ Local<Context> NewContext(Isolate* isolate,\n \n     std::vector<Local<String>> parameters = {\n         FIXED_ONE_BYTE_STRING(isolate, \"global\")};\n-    std::vector<Local<Value>> arguments = {context->Global()};\n-    MaybeLocal<Value> result = per_process::native_module_loader.CompileAndCall(\n-        context, \"internal/per_context\", &parameters, &arguments, nullptr);\n+    Local<Value> arguments[] = {context->Global()};\n+    MaybeLocal<Function> maybe_fn =\n+        per_process::native_module_loader.LookupAndCompile(\n+            context, \"internal/per_context\", &parameters, nullptr);\n+    if (maybe_fn.IsEmpty()) {\n+      return Local<Context>();\n+    }\n+    Local<Function> fn = maybe_fn.ToLocalChecked();\n+    MaybeLocal<Value> result =\n+        fn->Call(context, Undefined(isolate), arraysize(arguments), arguments);\n+    // Execution failed during context creation.\n+    // TODO(joyeecheung): deprecate this signature and return a MaybeLocal.\n     if (result.IsEmpty()) {\n-      // Execution failed during context creation.\n-      // TODO(joyeecheung): deprecate this signature and return a MaybeLocal.\n       return Local<Context>();\n     }\n   }\n@@ -1255,7 +1323,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Context::Scope context_scope(context);\n   Environment env(isolate_data, context);\n   env.Start(per_process::v8_is_profiling);\n-  env.CreateProcessObject(args, exec_args);\n+  env.ProcessCliArgs(args, exec_args);\n \n #if HAVE_INSPECTOR && NODE_USE_V8_PLATFORM\n   CHECK(!env.inspector_agent()->IsListening());"
        },
        {
            "sha": "bf66c77e6f043c17a1f9f32b15e83cc765ce44a9",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -268,8 +268,9 @@ bool SafeGetenv(const char* key, std::string* text);\n \n void DefineZlibConstants(v8::Local<v8::Object> target);\n \n-void RunBootstrapping(Environment* env);\n-void StartExecution(Environment* env, const char* main_script_id);\n+v8::MaybeLocal<v8::Value> RunBootstrapping(Environment* env);\n+v8::MaybeLocal<v8::Value> StartExecution(Environment* env,\n+                                         const char* main_script_id);\n \n }  // namespace node\n "
        },
        {
            "sha": "675495e34bff5a9fefb5399df658643a52aefbb4",
            "filename": "src/node_native_module.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_native_module.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_native_module.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.cc?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -175,26 +175,6 @@ void NativeModuleLoader::CompileFunction(\n   }\n }\n \n-// TODO(joyeecheung): it should be possible to generate the argument names\n-// from some special comments for the bootstrapper case.\n-MaybeLocal<Value> NativeModuleLoader::CompileAndCall(\n-    Local<Context> context,\n-    const char* id,\n-    std::vector<Local<String>>* parameters,\n-    std::vector<Local<Value>>* arguments,\n-    Environment* optional_env) {\n-  Isolate* isolate = context->GetIsolate();\n-  MaybeLocal<Function> compiled =\n-      per_process::native_module_loader.LookupAndCompile(\n-          context, id, parameters, nullptr);\n-  if (compiled.IsEmpty()) {\n-    return MaybeLocal<Value>();\n-  }\n-  Local<Function> fn = compiled.ToLocalChecked().As<Function>();\n-  return fn->Call(\n-      context, v8::Null(isolate), arguments->size(), arguments->data());\n-}\n-\n MaybeLocal<Function> NativeModuleLoader::CompileAsModule(Environment* env,\n                                                          const char* id) {\n   std::vector<Local<String>> parameters = {env->exports_string(),"
        },
        {
            "sha": "be1fc92a7672f38dff6213df081800e4e6b99ad1",
            "filename": "src/node_native_module.h",
            "status": "modified",
            "additions": 6,
            "deletions": 18,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_native_module.h",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_native_module.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.h?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -42,20 +42,17 @@ class NativeModuleLoader {\n   // Returns config.gypi as a JSON string\n   v8::Local<v8::String> GetConfigString(v8::Isolate* isolate) const;\n \n-  // Run a script with JS source bundled inside the binary as if it's wrapped\n-  // in a function called with a null receiver and arguments specified in C++.\n-  // The returned value is empty if an exception is encountered.\n-  // JS code run with this method can assume that their top-level\n-  // declarations won't affect the global scope.\n-  v8::MaybeLocal<v8::Value> CompileAndCall(\n+  bool Exists(const char* id);\n+\n+  // For bootstrappers optional_env may be a nullptr.\n+  // If an exception is encountered (e.g. source code contains\n+  // syntax error), the returned value is empty.\n+  v8::MaybeLocal<v8::Function> LookupAndCompile(\n       v8::Local<v8::Context> context,\n       const char* id,\n       std::vector<v8::Local<v8::String>>* parameters,\n-      std::vector<v8::Local<v8::Value>>* arguments,\n       Environment* optional_env);\n \n-  bool Exists(const char* id);\n-\n  private:\n   static void GetCacheUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n   // Passing ids of builtin module source code into JS land as\n@@ -87,15 +84,6 @@ class NativeModuleLoader {\n   static v8::MaybeLocal<v8::Function> CompileAsModule(Environment* env,\n                                                       const char* id);\n \n-  // For bootstrappers optional_env may be a nullptr.\n-  // If an exception is encountered (e.g. source code contains\n-  // syntax error), the returned value is empty.\n-  v8::MaybeLocal<v8::Function> LookupAndCompile(\n-      v8::Local<v8::Context> context,\n-      const char* id,\n-      std::vector<v8::Local<v8::String>>* parameters,\n-      Environment* optional_env);\n-\n   NativeModuleRecordMap source_;\n   NativeModuleCacheMap code_cache_;\n   UnionBytes config_;"
        },
        {
            "sha": "4b78d653929d4b00f38339334bcaedc08b2503cd",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -133,8 +133,8 @@ Worker::Worker(Environment* env,\n     env_->set_thread_id(thread_id_);\n \n     env_->Start(env->profiler_idle_notifier_started());\n-    env_->CreateProcessObject(std::vector<std::string>{},\n-                              std::vector<std::string>{});\n+    env_->ProcessCliArgs(std::vector<std::string>{},\n+                            std::vector<std::string>{});\n     // Done while on the parent thread\n     AddWorkerInspector(env, env_.get(), thread_id_, url_);\n   }\n@@ -192,10 +192,10 @@ void Worker::Run() {\n         HandleScope handle_scope(isolate_);\n         Environment::AsyncCallbackScope callback_scope(env_.get());\n         env_->async_hooks()->push_async_ids(1, 0);\n-        RunBootstrapping(env_.get());\n-        // TODO(joyeecheung): create a main script for worker threads\n-        // that starts listening on the message port.\n-        StartExecution(env_.get(), nullptr);\n+        if (!RunBootstrapping(env_.get()).IsEmpty()) {\n+          USE(StartExecution(env_.get(), \"internal/main/worker_thread\"));\n+        }\n+\n         env_->async_hooks()->pop_async_id(1);\n \n         Debug(this, \"Loaded environment for worker %llu\", thread_id_);"
        },
        {
            "sha": "6232f1ae61b324fc80193048e9172a11bc6551f0",
            "filename": "test/code-cache/test-code-cache.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fcode-cache%2Ftest-code-cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fcode-cache%2Ftest-code-cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache.js?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -9,7 +9,7 @@ const { isMainThread } = require('../common');\n const assert = require('assert');\n const {\n   cachableBuiltins,\n-  cannotUseCache\n+  cannotBeRequired\n } = require('internal/bootstrap/cache');\n \n const {\n@@ -60,7 +60,7 @@ if (process.config.variables.node_code_cache_path === undefined) {\n   );\n \n   for (const key of loadedModules) {\n-    if (cannotUseCache.includes(key)) {\n+    if (cannotBeRequired.includes(key)) {\n       assert(compiledWithoutCache.has(key),\n              `\"${key}\" should've been compiled without code cache`);\n     } else {"
        },
        {
            "sha": "0457670d6a317c4dee55829fc5a9652f254ff9a9",
            "filename": "test/message/assert_throws_stack.out",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fassert_throws_stack.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fassert_throws_stack.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fassert_throws_stack.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -17,4 +17,3 @@ AssertionError [ERR_ASSERTION]: Expected values to be strictly deep-equal:\n     at *\n     at *\n     at *\n-    at *"
        },
        {
            "sha": "0336e5b451651e5041564d4367ea947559547c40",
            "filename": "test/message/core_line_numbers.out",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fcore_line_numbers.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fcore_line_numbers.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fcore_line_numbers.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -12,4 +12,4 @@ RangeError: Invalid input\n     at tryModuleLoad (internal/modules/cjs/loader.js:*:*)\n     at Function.Module._load (internal/modules/cjs/loader.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "3364210099ca754dc429183a6b1f1be5742481dc",
            "filename": "test/message/error_exit.out",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Ferror_exit.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Ferror_exit.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Ferror_exit.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -14,5 +14,4 @@ AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:\n     at tryModuleLoad (internal/modules/cjs/loader.js:*:*)\n     at Function.Module._load (internal/modules/cjs/loader.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "0d2e68f3d79b041e43286092e2921cdc32e778c2",
            "filename": "test/message/eval_messages.out",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Feval_messages.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Feval_messages.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Feval_messages.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -9,8 +9,7 @@ SyntaxError: Strict mode code may not include a with statement\n     at Object.<anonymous> ([eval]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/eval_string.js:*:*\n 42\n 42\n [eval]:1\n@@ -24,8 +23,7 @@ Error: hello\n     at Object.<anonymous> ([eval]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/eval_string.js:*:*\n \n [eval]:1\n throw new Error(\"hello\")\n@@ -38,8 +36,7 @@ Error: hello\n     at Object.<anonymous> ([eval]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/eval_string.js:*:*\n 100\n [eval]:1\n var x = 100; y = x;\n@@ -52,8 +49,7 @@ ReferenceError: y is not defined\n     at Object.<anonymous> ([eval]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/eval_string.js:*:*\n \n [eval]:1\n var ______________________________________________; throw 10"
        },
        {
            "sha": "0d64143c67f8657c4bfddcb93362bc9636e44743",
            "filename": "test/message/events_unhandled_error_common_trace.out",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_common_trace.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_common_trace.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_common_trace.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -12,11 +12,10 @@ Error: foo:bar\n     at tryModuleLoad (internal/modules/cjs/loader.js:*:*)\n     at Function.Module._load (internal/modules/cjs/loader.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*\n Emitted 'error' event at:\n     at quux (*events_unhandled_error_common_trace.js:*:*)\n     at Object.<anonymous> (*events_unhandled_error_common_trace.js:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     [... lines matching original stack trace ...]\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "4132ae9f3bc1bea64325c2e14b45a5763d0a390d",
            "filename": "test/message/events_unhandled_error_nexttick.out",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_nexttick.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_nexttick.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -10,12 +10,10 @@ Error\n     at tryModuleLoad (internal/modules/cjs/loader.js:*:*)\n     at Function.Module._load (internal/modules/cjs/loader.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*\n Emitted 'error' event at:\n     at process.nextTick (*events_unhandled_error_nexttick.js:*:*)\n     at processTicksAndRejections (internal/process/next_tick.js:*:*)\n     at process.runNextTicks [as _tickCallback] (internal/process/next_tick.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "f877b254aafe97bebd5f10a38e7311a6b167cab3",
            "filename": "test/message/events_unhandled_error_sameline.out",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fevents_unhandled_error_sameline.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fevents_unhandled_error_sameline.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -10,10 +10,9 @@ Error\n     at tryModuleLoad (internal/modules/cjs/loader.js:*:*)\n     at Function.Module._load (internal/modules/cjs/loader.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*\n Emitted 'error' event at:\n     at Object.<anonymous> (*events_unhandled_error_sameline.js:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     [... lines matching original stack trace ...]\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "7aa38a0424bd9983e99c0453f6aa54532435f671",
            "filename": "test/message/nexttick_throw.out",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fnexttick_throw.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fnexttick_throw.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fnexttick_throw.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -7,5 +7,4 @@ ReferenceError: undefined_reference_error_maker is not defined\n     at processTicksAndRejections (internal/process/next_tick.js:*:*)\n     at process.runNextTicks [as _tickCallback] (internal/process/next_tick.js:*:*)\n     at Function.Module.runMain (internal/modules/cjs/loader.js:*:*)\n-    at executeUserCode (internal/bootstrap/node.js:*:*)\n-    at startMainThreadExecution (internal/bootstrap/node.js:*:*)\n+    at internal/main/run_main_module.js:*:*"
        },
        {
            "sha": "837e9017d7f947f96cf6ef11cd6ba77cd3d2c2ce",
            "filename": "test/message/stdin_messages.out",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fstdin_messages.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Fstdin_messages.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fstdin_messages.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -2,17 +2,18 @@\n [stdin]:1\n with(this){__filename}\n ^^^^\n+\n SyntaxError: Strict mode code may not include a with statement\n     at new Script (vm.js:*)\n     at createScript (vm.js:*)\n     at Object.runInThisContext (vm.js:*)\n     at Object.<anonymous> ([stdin]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at Socket.process.stdin.on (internal/bootstrap/node.js:*:*)\n+    at readStdin (internal/main/eval_stdin.js:*:*)\n+    at Socket.process.stdin.on (internal/process/execution.js:*:*)\n     at Socket.emit (events.js:*:*)\n     at endReadableNT (_stream_readable.js:*:*)\n-    at processTicksAndRejections (internal/process/next_tick.js:*:*)\n 42\n 42\n [stdin]:1\n@@ -26,10 +27,10 @@ Error: hello\n     at Object.<anonymous> ([stdin]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at Socket.process.stdin.on (internal/bootstrap/node.js:*:*)\n+    at readStdin (internal/main/eval_stdin.js:*:*)\n+    at Socket.process.stdin.on (internal/process/execution.js:*:*)\n     at Socket.emit (events.js:*:*)\n     at endReadableNT (_stream_readable.js:*:*)\n-    at processTicksAndRejections (internal/process/next_tick.js:*:*)\n [stdin]:1\n throw new Error(\"hello\")\n ^\n@@ -41,10 +42,10 @@ Error: hello\n     at Object.<anonymous> ([stdin]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at Socket.process.stdin.on (internal/bootstrap/node.js:*:*)\n+    at readStdin (internal/main/eval_stdin.js:*:*)\n+    at Socket.process.stdin.on (internal/process/execution.js:*:*)\n     at Socket.emit (events.js:*:*)\n     at endReadableNT (_stream_readable.js:*:*)\n-    at processTicksAndRejections (internal/process/next_tick.js:*:*)\n 100\n [stdin]:1\n var x = 100; y = x;\n@@ -57,10 +58,10 @@ ReferenceError: y is not defined\n     at Object.<anonymous> ([stdin]-wrapper:*:*)\n     at Module._compile (internal/modules/cjs/loader.js:*:*)\n     at evalScript (internal/process/execution.js:*:*)\n-    at Socket.process.stdin.on (internal/bootstrap/node.js:*:*)\n+    at readStdin (internal/main/eval_stdin.js:*:*)\n+    at Socket.process.stdin.on (internal/process/execution.js:*:*)\n     at Socket.emit (events.js:*:*)\n     at endReadableNT (_stream_readable.js:*:*)\n-    at processTicksAndRejections (internal/process/next_tick.js:*:*)\n \n [stdin]:1\n var ______________________________________________; throw 10"
        },
        {
            "sha": "60c08805f5cd54ad4262efd4d300e77eeb927307",
            "filename": "test/message/unhandled_promise_trace_warnings.out",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Funhandled_promise_trace_warnings.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Funhandled_promise_trace_warnings.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Funhandled_promise_trace_warnings.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -13,8 +13,6 @@\n     at *\n     at *\n     at *\n-    at *\n-    at *\n (node:*) Error: This was rejected\n     at * (*test*message*unhandled_promise_trace_warnings.js:*)\n     at *\n@@ -24,7 +22,6 @@\n     at *\n     at *\n     at *\n-    at *\n (node:*) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\n     at *\n     at *\n@@ -33,7 +30,6 @@\n     at *\n     at *\n     at *\n-    at *\n (node:*) PromiseRejectionHandledWarning: Promise rejection was handled asynchronously (rejection id: 1)\n     at handledRejection (internal/process/promises.js:*)\n     at promiseRejectHandler (internal/process/promises.js:*)"
        },
        {
            "sha": "31b65eb2e2bf3c6a66494e7a4c4c9dcff7d4edb5",
            "filename": "test/message/util_inspect_error.out",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Futil_inspect_error.out",
            "raw_url": "https://github.com/nodejs/node/raw/6967f91368cbb9cad3877ee59874cc83ccef4653/test%2Fmessage%2Futil_inspect_error.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Futil_inspect_error.out?ref=6967f91368cbb9cad3877ee59874cc83ccef4653",
            "patch": "@@ -9,7 +9,6 @@\n        at *\n        at *\n        at *\n-       at *\n   nested:\n    { err:\n       Error: foo\n@@ -22,7 +21,6 @@\n           at *\n           at *\n           at *\n-          at * } }\n {\n   err: Error: foo\n   bar\n@@ -34,7 +32,6 @@\n       at *\n       at *\n       at *\n-      at *,\n   nested: {\n     err: Error: foo\n     bar\n@@ -46,7 +43,6 @@\n         at *\n         at *\n         at *\n-        at *\n   }\n }\n { Error: foo\n@@ -59,5 +55,4 @@ bar\n     at *\n     at *\n     at *\n-    at *\n   foo: 'bar' }"
        }
    ],
    "stats": {
        "total": 1576,
        "additions": 855,
        "deletions": 721
    }
}