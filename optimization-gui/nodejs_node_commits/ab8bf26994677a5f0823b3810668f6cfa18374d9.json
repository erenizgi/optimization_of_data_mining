{
    "author": "targos",
    "message": "fs,cluster,net: assign error codes to remaining errors\n\nAfter this commit, all errors thrown from JS code in lib have an error\ncode.\n\nPR-URL: https://github.com/nodejs/node/pull/19373\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "ab8bf26994677a5f0823b3810668f6cfa18374d9",
    "files": [
        {
            "sha": "62a62d766562239875ba9e149e9d03610a6b1c59",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -777,6 +777,12 @@ Encoding provided to `util.TextDecoder()` API was not one of the\n A `Promise` that was callbackified via `util.callbackify()` was rejected with a\n falsy value.\n \n+<a id=\"ERR_FS_FILE_TOO_LARGE\"></a>\n+### ERR_FS_FILE_TOO_LARGE\n+\n+An attempt has been made to read a file whose size is larger than the maximum\n+allowed size for a `Buffer`.\n+\n <a id=\"ERR_FS_INVALID_SYMLINK_TYPE\"></a>\n ### ERR_FS_INVALID_SYMLINK_TYPE\n "
        },
        {
            "sha": "ec4a1e9a9fb9d9312c5b27bb072cc3c9b533202c",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -36,6 +36,7 @@ const fs = exports;\n const { Buffer } = require('buffer');\n const errors = require('internal/errors');\n const {\n+  ERR_FS_FILE_TOO_LARGE,\n   ERR_INVALID_ARG_TYPE,\n   ERR_INVALID_CALLBACK,\n   ERR_OUT_OF_RANGE\n@@ -347,8 +348,7 @@ function readFileAfterStat(err) {\n   }\n \n   if (size > kMaxLength) {\n-    err = new RangeError('File size is greater than possible Buffer: ' +\n-                         `0x${kMaxLength.toString(16)} bytes`);\n+    err = new ERR_FS_FILE_TOO_LARGE(size);\n     return context.close(err);\n   }\n \n@@ -421,6 +421,9 @@ function tryCreateBuffer(size, fd, isUserFd) {\n   var threw = true;\n   var buffer;\n   try {\n+    if (size > kMaxLength) {\n+      throw new ERR_FS_FILE_TOO_LARGE(size);\n+    }\n     buffer = Buffer.allocUnsafe(size);\n     threw = false;\n   } finally {"
        },
        {
            "sha": "a36d845d5177fabca5312fcbf95969d75527d6ec",
            "filename": "lib/fs/promises.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs%2Fpromises.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -13,7 +13,7 @@ const {\n const binding = process.binding('fs');\n const { Buffer, kMaxLength } = require('buffer');\n const {\n-  ERR_BUFFER_TOO_LARGE,\n+  ERR_FS_FILE_TOO_LARGE,\n   ERR_INVALID_ARG_TYPE,\n   ERR_METHOD_NOT_IMPLEMENTED,\n   ERR_OUT_OF_RANGE\n@@ -143,7 +143,7 @@ async function readFileHandle(filehandle, options) {\n     return Buffer.alloc(0);\n \n   if (size > kMaxLength)\n-    throw new ERR_BUFFER_TOO_LARGE();\n+    throw new ERR_FS_FILE_TOO_LARGE(size);\n \n   const chunks = [];\n   const chunkSize = Math.min(size, 16384);"
        },
        {
            "sha": "7ee43689c4c725ddfee726d485522330957e0c52",
            "filename": "lib/internal/cluster/master.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Finternal%2Fcluster%2Fmaster.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Finternal%2Fcluster%2Fmaster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcluster%2Fmaster.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -8,6 +8,7 @@ const RoundRobinHandle = require('internal/cluster/round_robin_handle');\n const SharedHandle = require('internal/cluster/shared_handle');\n const Worker = require('internal/cluster/worker');\n const { internal, sendHelper, handles } = require('internal/cluster/utils');\n+const { ERR_SOCKET_BAD_PORT } = require('internal/errors').codes;\n const keys = Object.keys;\n const cluster = new EventEmitter();\n const intercom = new EventEmitter();\n@@ -115,8 +116,7 @@ function createWorkerProcess(id, env) {\n         inspectPort = cluster.settings.inspectPort;\n \n       if (!isLegalPort(inspectPort)) {\n-        throw new TypeError('cluster.settings.inspectPort' +\n-          ' is invalid');\n+        throw new ERR_SOCKET_BAD_PORT(inspectPort);\n       }\n     } else {\n       inspectPort = process.debugPort + debugPortOffset;"
        },
        {
            "sha": "f7eeb946b645efac47d67ca7defd196542d628d3",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -651,6 +651,9 @@ E('ERR_ENCODING_INVALID_ENCODED_DATA',\n E('ERR_ENCODING_NOT_SUPPORTED', 'The \"%s\" encoding is not supported',\n   RangeError);\n E('ERR_FALSY_VALUE_REJECTION', 'Promise was rejected with falsy value', Error);\n+E('ERR_FS_FILE_TOO_LARGE', 'File size (%s) is greater than possible Buffer: ' +\n+    `${kMaxLength} bytes`,\n+  RangeError);\n E('ERR_FS_INVALID_SYMLINK_TYPE',\n   'Symlink type must be one of \"dir\", \"file\", or \"junction\". Received \"%s\"',\n   Error); // Switch to TypeError. The current implementation does not seem right"
        },
        {
            "sha": "3693aeb69016d899ac72e781985c573f32bafb33",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -928,7 +928,7 @@ function internalConnect(\n       localAddress = localAddress || '::';\n       err = self._handle.bind6(localAddress, localPort);\n     } else {\n-      self.destroy(new TypeError('Invalid addressType: ' + addressType));\n+      self.destroy(new ERR_INVALID_ADDRESS_FAMILY(addressType));\n       return;\n     }\n     debug('binding to localAddress: %s and localPort: %d (addressType: %d)',"
        },
        {
            "sha": "dfaf59c711cd1326a4fd9e91511b0f5ce4d6e47b",
            "filename": "test/sequential/test-inspector-port-cluster.js",
            "status": "modified",
            "additions": 13,
            "deletions": 12,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/ab8bf26994677a5f0823b3810668f6cfa18374d9/test%2Fsequential%2Ftest-inspector-port-cluster.js",
            "raw_url": "https://github.com/nodejs/node/raw/ab8bf26994677a5f0823b3810668f6cfa18374d9/test%2Fsequential%2Ftest-inspector-port-cluster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-port-cluster.js?ref=ab8bf26994677a5f0823b3810668f6cfa18374d9",
            "patch": "@@ -207,6 +207,7 @@ function testRunnerMain() {\n function masterProcessMain() {\n   const workers = JSON.parse(process.env.workers);\n   const clusterSettings = JSON.parse(process.env.clusterSettings);\n+  const badPortError = { type: RangeError, code: 'ERR_SOCKET_BAD_PORT' };\n   let debugPort = process.debugPort;\n \n   for (const worker of workers) {\n@@ -234,36 +235,36 @@ function masterProcessMain() {\n         clusterSettings.inspectPort = 'string';\n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       } else if (clusterSettings.inspectPort === 'null') {\n         clusterSettings.inspectPort = null;\n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       } else if (clusterSettings.inspectPort === 'bignumber') {\n         clusterSettings.inspectPort = 1293812;\n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       } else if (clusterSettings.inspectPort === 'negativenumber') {\n         clusterSettings.inspectPort = -9776;\n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       } else if (clusterSettings.inspectPort === 'bignumberfunc') {\n@@ -274,9 +275,9 @@ function masterProcessMain() {\n \n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       } else if (clusterSettings.inspectPort === 'strfunc') {\n@@ -287,9 +288,9 @@ function masterProcessMain() {\n \n         cluster.setupMaster(clusterSettings);\n \n-        assert.throws(() => {\n+        common.expectsError(() => {\n           cluster.fork(params).on('exit', common.mustCall(checkExitCode));\n-        }, TypeError);\n+        }, badPortError);\n \n         return;\n       }"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 32,
        "deletions": 19
    }
}