{
    "author": "joyeecheung",
    "message": "process: start coverage collection before bootstrap\n\nThis patch moves the dispatch of `Profiler.takePreciseCoverage`\nto a point before the bootstrap scripts are run to ensure that\nwe can collect coverage data for all the scripts run after\nthe inspector agent is ready.\n\nBefore this patch `lib/internal/bootstrap/primordials.js` was not\ncovered by `make coverage`, after this patch it is.\n\nPR-URL: https://github.com/nodejs/node/pull/26006\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Coe <bencoe@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
    "files": [
        {
            "sha": "28f7f5277b9ee090a062f06c6ef2dfd1829289be",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -311,18 +311,5 @@ NativeModule.prototype.compile = function() {\n   }\n };\n \n-// Coverage must be turned on early, so that we can collect\n-// it for Node.js' own internal libraries.\n-if (process.env.NODE_V8_COVERAGE) {\n-  if (internalBinding('config').hasInspector) {\n-    const coverage =\n-      NativeModule.require('internal/coverage-gen/with_profiler');\n-    // Inform the profiler to start collecting coverage\n-    coverage.startCoverageCollection();\n-  } else {\n-    process._rawDebug('NODE_V8_COVERAGE cannot be used without inspector');\n-  }\n-}\n-\n // This will be passed to internal/bootstrap/node.js.\n return loaderExports;"
        },
        {
            "sha": "573d2c3712b281ed4c815db07d041eca57cee965",
            "filename": "lib/internal/coverage-gen/with_profiler.js",
            "status": "modified",
            "additions": 6,
            "deletions": 40,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/lib%2Finternal%2Fcoverage-gen%2Fwith_profiler.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/lib%2Finternal%2Fcoverage-gen%2Fwith_profiler.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcoverage-gen%2Fwith_profiler.js?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -3,14 +3,9 @@\n // Implements coverage collection exposed by the `NODE_V8_COVERAGE`\n // environment variable which can also be used in the user land.\n \n-let coverageConnection = null;\n let coverageDirectory;\n \n function writeCoverage() {\n-  if (!coverageConnection && coverageDirectory) {\n-    return;\n-  }\n-\n   const { join } = require('path');\n   const { mkdirSync, writeFileSync } = require('fs');\n   const { threadId } = require('internal/worker');\n@@ -28,21 +23,14 @@ function writeCoverage() {\n   const target = join(coverageDirectory, filename);\n   try {\n     disableAllAsyncHooks();\n-    let msg;\n-    coverageConnection._coverageCallback = function(_msg) {\n-      msg = _msg;\n-    };\n-    coverageConnection.dispatch(JSON.stringify({\n-      id: 3,\n-      method: 'Profiler.takePreciseCoverage'\n-    }));\n-    const coverageInfo = JSON.parse(msg).result;\n-    writeFileSync(target, JSON.stringify(coverageInfo));\n+    internalBinding('coverage').end((msg) => {\n+      const coverageInfo = JSON.parse(msg).result;\n+      if (coverageInfo) {\n+        writeFileSync(target, JSON.stringify(coverageInfo));\n+      }\n+    });\n   } catch (err) {\n     console.error(err);\n-  } finally {\n-    coverageConnection.disconnect();\n-    coverageConnection = null;\n   }\n }\n \n@@ -52,33 +40,11 @@ function disableAllAsyncHooks() {\n   hooks_array.forEach((hook) => { hook.disable(); });\n }\n \n-function startCoverageCollection() {\n-  const { Connection } = internalBinding('inspector');\n-  coverageConnection = new Connection((res) => {\n-    if (coverageConnection._coverageCallback) {\n-      coverageConnection._coverageCallback(res);\n-    }\n-  });\n-  coverageConnection.dispatch(JSON.stringify({\n-    id: 1,\n-    method: 'Profiler.enable'\n-  }));\n-  coverageConnection.dispatch(JSON.stringify({\n-    id: 2,\n-    method: 'Profiler.startPreciseCoverage',\n-    params: {\n-      callCount: true,\n-      detailed: true\n-    }\n-  }));\n-}\n-\n function setCoverageDirectory(dir) {\n   coverageDirectory = dir;\n }\n \n module.exports = {\n-  startCoverageCollection,\n   writeCoverage,\n   setCoverageDirectory\n };"
        },
        {
            "sha": "b892eac26bb51404e75c1cbf3d30bea1b771a84b",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -331,6 +331,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(async_wrap_ctor_template, v8::FunctionTemplate)                            \\\n   V(async_wrap_object_ctor_template, v8::FunctionTemplate)                     \\\n   V(buffer_prototype_object, v8::Object)                                       \\\n+  V(coverage_connection, v8::Object)                                           \\\n   V(context, v8::Context)                                                      \\\n   V(crypto_key_object_constructor, v8::Function)                               \\\n   V(domain_callback, v8::Function)                                             \\\n@@ -366,6 +367,7 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n   V(message_event_object_template, v8::ObjectTemplate)                         \\\n   V(message_port_constructor_template, v8::FunctionTemplate)                   \\\n   V(native_module_require, v8::Function)                                       \\\n+  V(on_coverage_message_function, v8::Function)                                \\\n   V(performance_entry_callback, v8::Function)                                  \\\n   V(performance_entry_template, v8::Function)                                  \\\n   V(pipe_constructor_template, v8::FunctionTemplate)                           \\\n@@ -450,9 +452,10 @@ struct ContextInfo {\n \n // Listing the AsyncWrap provider types first enables us to cast directly\n // from a provider type to a debug category.\n-#define DEBUG_CATEGORY_NAMES(V) \\\n-    NODE_ASYNC_PROVIDER_TYPES(V) \\\n-    V(INSPECTOR_SERVER)\n+#define DEBUG_CATEGORY_NAMES(V)                                                \\\n+  NODE_ASYNC_PROVIDER_TYPES(V)                                                 \\\n+  V(INSPECTOR_SERVER)                                                          \\\n+  V(COVERAGE)\n \n enum class DebugCategory {\n #define V(name) name,"
        },
        {
            "sha": "9483a0712e22bdb43374d0691b9ce7b82003d0bb",
            "filename": "src/inspector/node_inspector.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Finspector%2Fnode_inspector.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Finspector%2Fnode_inspector.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector%2Fnode_inspector.gypi?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -45,6 +45,7 @@\n     '../../src/inspector_io.cc',\n     '../../src/inspector_agent.h',\n     '../../src/inspector_io.h',\n+    '../../src/inspector_coverage.cc',\n     '../../src/inspector_js_api.cc',\n     '../../src/inspector_socket.cc',\n     '../../src/inspector_socket.h',"
        },
        {
            "sha": "8cbec586fba718576a4d8984c42e5d63ff6169fb",
            "filename": "src/inspector_coverage.cc",
            "status": "added",
            "additions": 168,
            "deletions": 0,
            "changes": 168,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Finspector_coverage.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Finspector_coverage.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_coverage.cc?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -0,0 +1,168 @@\n+#include \"base_object-inl.h\"\n+#include \"debug_utils.h\"\n+#include \"inspector_agent.h\"\n+#include \"node_internals.h\"\n+#include \"v8-inspector.h\"\n+\n+namespace node {\n+namespace coverage {\n+\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::HandleScope;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::MaybeLocal;\n+using v8::NewStringType;\n+using v8::Object;\n+using v8::ObjectTemplate;\n+using v8::String;\n+using v8::Value;\n+\n+using v8_inspector::StringBuffer;\n+using v8_inspector::StringView;\n+\n+std::unique_ptr<StringBuffer> ToProtocolString(Isolate* isolate,\n+                                               Local<Value> value) {\n+  TwoByteValue buffer(isolate, value);\n+  return StringBuffer::create(StringView(*buffer, buffer.length()));\n+}\n+\n+class V8CoverageConnection : public BaseObject {\n+ public:\n+  class V8CoverageSessionDelegate : public inspector::InspectorSessionDelegate {\n+   public:\n+    explicit V8CoverageSessionDelegate(V8CoverageConnection* connection)\n+        : connection_(connection) {}\n+\n+    void SendMessageToFrontend(\n+        const v8_inspector::StringView& message) override {\n+      Environment* env = connection_->env();\n+      Local<Function> fn = connection_->env()->on_coverage_message_function();\n+      bool ending = !fn.IsEmpty();\n+      Debug(env,\n+            DebugCategory::COVERAGE,\n+            \"Sending message to frontend, ending = %s\\n\",\n+            ending ? \"true\" : \"false\");\n+      if (!ending) {\n+        return;\n+      }\n+      Isolate* isolate = env->isolate();\n+\n+      HandleScope handle_scope(isolate);\n+      Context::Scope context_scope(env->context());\n+      MaybeLocal<String> v8string =\n+          String::NewFromTwoByte(isolate,\n+                                 message.characters16(),\n+                                 NewStringType::kNormal,\n+                                 message.length());\n+      Local<Value> args[] = {v8string.ToLocalChecked().As<Value>()};\n+      USE(MakeCallback(isolate,\n+                       connection_->object(),\n+                       fn,\n+                       arraysize(args),\n+                       args,\n+                       async_context{0, 0}));\n+    }\n+\n+   private:\n+    V8CoverageConnection* connection_;\n+  };\n+\n+  SET_MEMORY_INFO_NAME(V8CoverageConnection)\n+  SET_SELF_SIZE(V8CoverageConnection)\n+\n+  void MemoryInfo(MemoryTracker* tracker) const override {\n+    tracker->TrackFieldWithSize(\n+        \"session\", sizeof(*session_), \"InspectorSession\");\n+  }\n+\n+  explicit V8CoverageConnection(Environment* env)\n+      : BaseObject(env, env->coverage_connection()), session_(nullptr) {\n+    inspector::Agent* inspector = env->inspector_agent();\n+    std::unique_ptr<inspector::InspectorSession> session = inspector->Connect(\n+        std::make_unique<V8CoverageSessionDelegate>(this), false);\n+    session_ = std::move(session);\n+    MakeWeak();\n+  }\n+\n+  void Start() {\n+    Debug(this->env(),\n+          DebugCategory::COVERAGE,\n+          \"Sending Profiler.startPreciseCoverage\\n\");\n+    Isolate* isolate = this->env()->isolate();\n+    Local<Value> enable = FIXED_ONE_BYTE_STRING(\n+        isolate, \"{\\\"id\\\": 1, \\\"method\\\": \\\"Profiler.enable\\\"}\");\n+    Local<Value> start = FIXED_ONE_BYTE_STRING(\n+        isolate,\n+        \"{\"\n+        \"\\\"id\\\": 2,\"\n+        \"\\\"method\\\": \\\"Profiler.startPreciseCoverage\\\",\"\n+        \"\\\"params\\\": {\\\"callCount\\\": true, \\\"detailed\\\": true}\"\n+        \"}\");\n+    session_->Dispatch(ToProtocolString(isolate, enable)->string());\n+    session_->Dispatch(ToProtocolString(isolate, start)->string());\n+  }\n+\n+  void End() {\n+    Debug(this->env(),\n+          DebugCategory::COVERAGE,\n+          \"Sending Profiler.takePreciseCoverage\\n\");\n+    Isolate* isolate = this->env()->isolate();\n+    Local<Value> end =\n+        FIXED_ONE_BYTE_STRING(isolate,\n+                              \"{\"\n+                              \"\\\"id\\\": 3,\"\n+                              \"\\\"method\\\": \\\"Profiler.takePreciseCoverage\\\"\"\n+                              \"}\");\n+    session_->Dispatch(ToProtocolString(isolate, end)->string());\n+  }\n+\n+  friend class V8CoverageSessionDelegate;\n+\n+ private:\n+  std::unique_ptr<inspector::InspectorSession> session_;\n+};\n+\n+bool StartCoverageCollection(Environment* env) {\n+  HandleScope scope(env->isolate());\n+\n+  Local<ObjectTemplate> t = ObjectTemplate::New(env->isolate());\n+  t->SetInternalFieldCount(1);\n+  Local<Object> obj;\n+  if (!t->NewInstance(env->context()).ToLocal(&obj)) {\n+    return false;\n+  }\n+\n+  obj->SetAlignedPointerInInternalField(0, nullptr);\n+\n+  CHECK(env->coverage_connection().IsEmpty());\n+  env->set_coverage_connection(obj);\n+  V8CoverageConnection* connection = new V8CoverageConnection(env);\n+  connection->Start();\n+  return true;\n+}\n+\n+static void EndCoverageCollection(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(args[0]->IsFunction());\n+  Debug(env, DebugCategory::COVERAGE, \"Ending coverage collection\\n\");\n+  env->set_on_coverage_message_function(args[0].As<Function>());\n+  V8CoverageConnection* connection =\n+      Unwrap<V8CoverageConnection>(env->coverage_connection());\n+  CHECK_NOT_NULL(connection);\n+  connection->End();\n+}\n+\n+static void Initialize(Local<Object> target,\n+                       Local<Value> unused,\n+                       Local<Context> context,\n+                       void* priv) {\n+  Environment* env = Environment::GetCurrent(context);\n+  env->SetMethod(target, \"end\", EndCoverageCollection);\n+}\n+}  // namespace coverage\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(coverage, node::coverage::Initialize)"
        },
        {
            "sha": "82282e202bec48574585aff35bd70791f758fb05",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -19,6 +19,7 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+#include \"debug_utils.h\"\n #include \"node_binding.h\"\n #include \"node_buffer.h\"\n #include \"node_constants.h\"\n@@ -230,6 +231,18 @@ MaybeLocal<Value> RunBootstrapping(Environment* env) {\n   Isolate* isolate = env->isolate();\n   Local<Context> context = env->context();\n \n+  std::string coverage;\n+  bool rc = credentials::SafeGetenv(\"NODE_V8_COVERAGE\", &coverage);\n+  if (rc && !coverage.empty()) {\n+#if HAVE_INSPECTOR\n+    if (!coverage::StartCoverageCollection(env)) {\n+      return MaybeLocal<Value>();\n+    }\n+#else\n+    fprintf(stderr, \"NODE_V8_COVERAGE cannot be used without inspector\");\n+#endif  // HAVE_INSPECTOR\n+  }\n+\n   // Add a reference to the global object\n   Local<Object> global = context->Global();\n "
        },
        {
            "sha": "c9ff7be46f80fc44586a231eb8b305040365f47c",
            "filename": "src/node_binding.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode_binding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode_binding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_binding.cc?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -21,6 +21,12 @@\n #define NODE_BUILTIN_REPORT_MODULES(V)\n #endif\n \n+#if HAVE_INSPECTOR\n+#define NODE_BUILTIN_COVERAGE_MODULES(V) V(coverage)\n+#else\n+#define NODE_BUILTIN_COVERAGE_MODULES(V)\n+#endif\n+\n // A list of built-in modules. In order to do module registration\n // in node::Init(), need to add built-in modules in the following list.\n // Then in binding::RegisterBuiltinModules(), it calls modules' registration\n@@ -77,7 +83,8 @@\n   NODE_BUILTIN_STANDARD_MODULES(V)                                             \\\n   NODE_BUILTIN_OPENSSL_MODULES(V)                                              \\\n   NODE_BUILTIN_ICU_MODULES(V)                                                  \\\n-  NODE_BUILTIN_REPORT_MODULES(V)\n+  NODE_BUILTIN_REPORT_MODULES(V)                                               \\\n+  NODE_BUILTIN_COVERAGE_MODULES(V)\n \n // This is used to load built-in modules. Instead of using\n // __attribute__((constructor)), we call the _register_<modname>"
        },
        {
            "sha": "01ebd8b40af3a22ab29a80d6e0578b3a58f6d228",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/2ae45d3b17f9c51fccffc4041e195e04b4b18c15/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=2ae45d3b17f9c51fccffc4041e195e04b4b18c15",
            "patch": "@@ -269,7 +269,9 @@ void DefineZlibConstants(v8::Local<v8::Object> target);\n v8::MaybeLocal<v8::Value> RunBootstrapping(Environment* env);\n v8::MaybeLocal<v8::Value> StartExecution(Environment* env,\n                                          const char* main_script_id);\n-\n+namespace coverage {\n+bool StartCoverageCollection(Environment* env);\n+}\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 205,
        "deletions": 58
    }
}