{
    "author": "richardlau",
    "message": "tools: add script to lint first PR commit message\n\nDecouple first commit in pull request linting from Travis by using\nthe GitHub API to work out the first commit.\n\nThe shell script obtains the pull request number in one of the\nfollowing ways:\n 1) supplied on the command line (use this to test against any PR)\n 2) derived from the HEAD commit via the GitHub API\n\nPR-URL: https://github.com/nodejs/node/pull/24030\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>",
    "sha": "7489ee8b6f4502d20f60b9276a1cfe86856340f2",
    "files": [
        {
            "sha": "dce15b7ab16851b78437d70ee71ec9cf5d5a8285",
            "filename": ".travis.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/7489ee8b6f4502d20f60b9276a1cfe86856340f2/.travis.yml",
            "raw_url": "https://github.com/nodejs/node/raw/7489ee8b6f4502d20f60b9276a1cfe86856340f2/.travis.yml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/.travis.yml?ref=7489ee8b6f4502d20f60b9276a1cfe86856340f2",
            "patch": "@@ -11,7 +11,7 @@ matrix:\n       script:\n         - make lint\n         # Lint the first commit in the PR.\n-        - \\[ -z \"$TRAVIS_COMMIT_RANGE\" \\] || (echo -e '\\nLinting the commit message according to the guidelines at https://goo.gl/p2fr5Q\\n' && git log $TRAVIS_COMMIT_RANGE --pretty=format:'%h' --no-merges | tail -1 | xargs npx -q core-validate-commit --no-validate-metadata)\n+        - \\[ \"${TRAVIS_PULL_REQUEST}\" != \"false\" \\] && PR_ID=${TRAVIS_PULL_REQUEST}; bash tools/lint-pr-commit-message.sh ${PR_ID}\n     - name: \"Test Suite\"\n       addons:\n         apt:"
        },
        {
            "sha": "1998026a16ae39ed4bd0e63f6982ec04f6cc5ee2",
            "filename": "tools/lint-pr-commit-message.sh",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/7489ee8b6f4502d20f60b9276a1cfe86856340f2/tools%2Flint-pr-commit-message.sh",
            "raw_url": "https://github.com/nodejs/node/raw/7489ee8b6f4502d20f60b9276a1cfe86856340f2/tools%2Flint-pr-commit-message.sh",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Flint-pr-commit-message.sh?ref=7489ee8b6f4502d20f60b9276a1cfe86856340f2",
            "patch": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+\n+# Shell script to lint the message of the first commit in a pull request.\n+#\n+# Depends on curl, git, node, npm and npx being in $PATH.\n+#\n+# The pull request is either:\n+# 1) supplied as an argument to this shell script\n+# 2) derived from the HEAD commit via the GitHub API\n+\n+GH_API_URL=\"https://api.github.com\"\n+PR_ID=$1;\n+if [ -z \"${PR_ID}\" ]; then\n+  # Attempt to work out the PR number based on current HEAD\n+  if HEAD_COMMIT=\"$( git rev-parse HEAD )\"; then\n+    if SEARCH_RESULTS=\"$( curl -s ${GH_API_URL}/search/issues?q=sha:${HEAD_COMMIT}+type:pr+repo:nodejs/node )\"; then\n+      if FOUND_PR=\"$( node -p 'JSON.parse(process.argv[1]).items[0].number' \"${SEARCH_RESULTS}\" 2> /dev/null )\"; then\n+        PR_ID=${FOUND_PR}\n+      fi\n+    fi\n+  fi\n+fi\n+if [ -z \"${PR_ID}\" ]; then\n+  echo \"Unable to determine the pull request number to check. Please specify, \"\n+  echo \" e.g. $0 <PR_NUMBER>\"\n+  exit 1\n+fi\n+# Retrieve the first commit of the pull request via GitHub API\n+# TODO: If we teach core-validate-commit to ignore \"fixup!\" and \"squash!\"\n+#       commits and lint messages for all commits in the pull request\n+#       we could simplify the following to:\n+#         npx -q core-validate-commit --no-validate-metadata ${GH_API_URL}/repos/nodejs/node/pulls/${PR_ID}/commits\n+if PR_COMMITS=\"$( curl -s ${GH_API_URL}/repos/nodejs/node/pulls/${PR_ID}/commits )\"; then\n+  if FIRST_COMMIT=\"$( node -p 'JSON.parse(process.argv[1])[0].url' \"${PR_COMMITS}\" 2> /dev/null )\"; then\n+    echo \"Linting the first commit message for pull request ${PR_ID}\"\n+    echo \"according to the guidelines at https://goo.gl/p2fr5Q.\"\n+    # Print the commit message to make it more obvious what is being checked.\n+    echo \"Commit message for ${FIRST_COMMIT##*/} is:\"\n+    node -p 'JSON.parse(process.argv[1])[0].commit.message' \"${PR_COMMITS}\" 2> /dev/null\n+    npx -q core-validate-commit --no-validate-metadata \"${FIRST_COMMIT}\"\n+  else\n+    echo \"Unable to determine the first commit for pull request ${PR_ID}.\"\n+    exit 1\n+  fi\n+fi"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 46,
        "deletions": 1
    }
}