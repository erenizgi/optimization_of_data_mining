{
    "author": "cjihrig",
    "message": "test: consolidate triggerReport() tests\n\nPR-URL: https://github.com/nodejs/node/pull/26268\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "cae7232e7aa82ad57c81b55b0f8852ea3e70c5b3",
    "files": [
        {
            "sha": "6e7195d6ab84f78f9231e236f3c040db1957d30a",
            "filename": "test/node-report/test-api-nohooks.js",
            "status": "modified",
            "additions": 54,
            "deletions": 4,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/cae7232e7aa82ad57c81b55b0f8852ea3e70c5b3/test%2Fnode-report%2Ftest-api-nohooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/cae7232e7aa82ad57c81b55b0f8852ea3e70c5b3/test%2Fnode-report%2Ftest-api-nohooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-nohooks.js?ref=cae7232e7aa82ad57c81b55b0f8852ea3e70c5b3",
            "patch": "@@ -5,6 +5,8 @@\n const common = require('../common');\n common.skipIfReportDisabled();\n const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n const helper = require('../common/report');\n const tmpdir = require('../common/tmpdir');\n \n@@ -13,7 +15,55 @@ common.expectWarning('ExperimentalWarning',\n                      'change at any time');\n tmpdir.refresh();\n process.report.setOptions({ path: tmpdir.path });\n-process.report.triggerReport();\n-const reports = helper.findReports(process.pid, tmpdir.path);\n-assert.strictEqual(reports.length, 1);\n-helper.validate(reports[0]);\n+\n+function validate() {\n+  const reports = helper.findReports(process.pid, tmpdir.path);\n+  assert.strictEqual(reports.length, 1);\n+  helper.validate(reports[0]);\n+  fs.unlinkSync(reports[0]);\n+  return reports[0];\n+}\n+\n+{\n+  // Test with no arguments.\n+  process.report.triggerReport();\n+  validate();\n+}\n+\n+{\n+  // Test with an error argument.\n+  process.report.triggerReport(new Error('test error'));\n+  validate();\n+}\n+\n+{\n+  // Test with a file argument.\n+  const file = process.report.triggerReport('custom-name-1.json');\n+  const absolutePath = path.join(tmpdir.path, file);\n+  assert.strictEqual(helper.findReports(process.pid, tmpdir.path).length, 0);\n+  assert.strictEqual(file, 'custom-name-1.json');\n+  helper.validate(absolutePath);\n+  fs.unlinkSync(absolutePath);\n+}\n+\n+{\n+  // Test with file and error arguments.\n+  const file = process.report.triggerReport('custom-name-2.json',\n+                                            new Error('test error'));\n+  const absolutePath = path.join(tmpdir.path, file);\n+  assert.strictEqual(helper.findReports(process.pid, tmpdir.path).length, 0);\n+  assert.strictEqual(file, 'custom-name-2.json');\n+  helper.validate(absolutePath);\n+  fs.unlinkSync(absolutePath);\n+}\n+\n+{\n+  // Test with a filename option.\n+  const filename = path.join(tmpdir.path, 'custom-name-3.json');\n+  process.report.setOptions({ filename });\n+  const file = process.report.triggerReport();\n+  assert.strictEqual(helper.findReports(process.pid, tmpdir.path).length, 0);\n+  assert.strictEqual(file, filename);\n+  helper.validate(filename);\n+  fs.unlinkSync(filename);\n+}"
        },
        {
            "sha": "9bf59ec425c3a827caa5932172db9a75f2e9c2e1",
            "filename": "test/node-report/test-api-pass-error.js",
            "status": "removed",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-pass-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-pass-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-pass-error.js?ref=d64aea059902efb32f01c46c9ac0467662d93628",
            "patch": "@@ -1,30 +0,0 @@\n-'use strict';\n-\n-// Testcase for passing an error object to the API call.\n-const common = require('../common');\n-common.skipIfReportDisabled();\n-const assert = require('assert');\n-if (process.argv[2] === 'child') {\n-  try {\n-    throw new Error('Testing error handling');\n-  } catch (err) {\n-    process.report.triggerReport(err);\n-  }\n-} else {\n-  const helper = require('../common/report.js');\n-  const spawn = require('child_process').spawn;\n-  const tmpdir = require('../common/tmpdir');\n-  tmpdir.refresh();\n-  const child = spawn(process.execPath, ['--experimental-report',\n-                                         __filename, 'child'],\n-                      { cwd: tmpdir.path });\n-  child.on('exit', common.mustCall((code) => {\n-    const report_msg = 'No reports found';\n-    const process_msg = 'Process exited unexpectedly';\n-    assert.strictEqual(code, 0, process_msg);\n-    const reports = helper.findReports(child.pid, tmpdir.path);\n-    assert.strictEqual(reports.length, 1, report_msg);\n-    const report = reports[0];\n-    helper.validate(report);\n-  }));\n-}"
        },
        {
            "sha": "8603c0a7c31b680691b28ac6d9f137779f30eeb6",
            "filename": "test/node-report/test-api-trigger-with-filename.js",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-trigger-with-filename.js",
            "raw_url": "https://github.com/nodejs/node/raw/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-trigger-with-filename.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-trigger-with-filename.js?ref=d64aea059902efb32f01c46c9ac0467662d93628",
            "patch": "@@ -1,29 +0,0 @@\n-'use strict';\n-\n-// Tests when a report is triggered with a given filename.\n-const common = require('../common');\n-common.skipIfReportDisabled();\n-const filename = 'myreport.json';\n-if (process.argv[2] === 'child') {\n-  process.report.triggerReport(filename);\n-} else {\n-  const helper = require('../common/report.js');\n-  const spawn = require('child_process').spawn;\n-  const assert = require('assert');\n-  const { join } = require('path');\n-  const tmpdir = require('../common/tmpdir');\n-  tmpdir.refresh();\n-\n-  const child = spawn(process.execPath,\n-                      ['--experimental-report', __filename, 'child'],\n-                      { cwd: tmpdir.path });\n-  child.on('exit', common.mustCall((code) => {\n-    const process_msg = 'Process exited unexpectedly';\n-    assert.strictEqual(code, 0, process_msg + ':' + code);\n-    const reports = helper.findReports(child.pid, tmpdir.path);\n-    assert.strictEqual(reports.length, 0,\n-                       `Found unexpected report ${reports[0]}`);\n-    const report = join(tmpdir.path, filename);\n-    helper.validate(report);\n-  }));\n-}"
        },
        {
            "sha": "a236fa1305bf46e0bf67b71a0c370acc764cf320",
            "filename": "test/node-report/test-api-trigger-with-options.js",
            "status": "removed",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-trigger-with-options.js",
            "raw_url": "https://github.com/nodejs/node/raw/d64aea059902efb32f01c46c9ac0467662d93628/test%2Fnode-report%2Ftest-api-trigger-with-options.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-api-trigger-with-options.js?ref=d64aea059902efb32f01c46c9ac0467662d93628",
            "patch": "@@ -1,30 +0,0 @@\n-'use strict';\n-\n-// Tests when a report is triggered with options set.\n-const common = require('../common');\n-common.skipIfReportDisabled();\n-const filename = 'myreport.json';\n-if (process.argv[2] === 'child') {\n-  process.report.setOptions({ filename: filename });\n-  process.report.triggerReport();\n-} else {\n-  const helper = require('../common/report.js');\n-  const spawn = require('child_process').spawn;\n-  const assert = require('assert');\n-  const { join } = require('path');\n-  const tmpdir = require('../common/tmpdir');\n-  tmpdir.refresh();\n-\n-  const child = spawn(process.execPath,\n-                      ['--experimental-report', __filename, 'child'],\n-                      { cwd: tmpdir.path });\n-  child.on('exit', common.mustCall((code) => {\n-    const process_msg = 'Process exited unexpectedly';\n-    assert.strictEqual(code, 0, process_msg + ':' + code);\n-    const reports = helper.findReports(child.pid, tmpdir.path);\n-    assert.strictEqual(reports.length, 0,\n-                       `Found unexpected report ${reports[0]}`);\n-    const report = join(tmpdir.path, filename);\n-    helper.validate(report);\n-  }));\n-}"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 54,
        "deletions": 93
    }
}