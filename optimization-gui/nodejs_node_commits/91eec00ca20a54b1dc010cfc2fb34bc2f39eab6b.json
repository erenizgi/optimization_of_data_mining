{
    "author": "mcollina",
    "message": "tty: make _read throw ERR_TTY_WRITABLE_NOT_READABLE\n\nThis change avoid an 'read ENOTCONN' error introduced by libuv 1.20.0\nwhen trying to read from a TTY WriteStream. Instead, we are throwing\na more actionable ERR_TTY_WRITABLE_NOT_READABLE.\n\nFixes: https://github.com/nodejs/node/issues/21203\n\nPR-URL: https://github.com/nodejs/node/pull/21654\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b",
    "files": [
        {
            "sha": "72e61c49bb970a085aa89773dc45708f8a9530f1",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b",
            "patch": "@@ -1694,6 +1694,12 @@ A `Transform` stream finished with data still in the write buffer.\n \n The initialization of a TTY failed due to a system error.\n \n+<a id=\"ERR_TTY_WRITABLE_NOT_READABLE\"></a>\n+### ERR_TTY_WRITABLE_NOT_READABLE\n+\n+This `Error` is thrown when a read is attempted on a TTY `WriteStream`,\n+such as `process.stdout.on('data')`.\n+\n <a id=\"ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET\"></a>\n ### ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET\n "
        },
        {
            "sha": "0520fbbc6f66681e108856460d680b069cf522a1",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b",
            "patch": "@@ -828,6 +828,9 @@ E('ERR_TRANSFORM_ALREADY_TRANSFORMING',\n E('ERR_TRANSFORM_WITH_LENGTH_0',\n   'Calling transform done when writableState.length != 0', Error);\n E('ERR_TTY_INIT_FAILED', 'TTY initialization failed', SystemError);\n+E('ERR_TTY_WRITABLE_NOT_READABLE',\n+  'The Writable side of a TTY is not Readable',\n+  Error);\n E('ERR_UNCAUGHT_EXCEPTION_CAPTURE_ALREADY_SET',\n   '`process.setupUncaughtExceptionCapture()` was called while a capture ' +\n     'callback was already active',"
        },
        {
            "sha": "5e0e528c7e45932c442196c99818068c876495d0",
            "filename": "lib/tty.js",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/lib%2Ftty.js",
            "raw_url": "https://github.com/nodejs/node/raw/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/lib%2Ftty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftty.js?ref=91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b",
            "patch": "@@ -25,7 +25,11 @@ const { inherits, _extend } = require('util');\n const net = require('net');\n const { TTY, isTTY } = process.binding('tty_wrap');\n const errors = require('internal/errors');\n-const { ERR_INVALID_FD, ERR_TTY_INIT_FAILED } = errors.codes;\n+const {\n+  ERR_INVALID_FD,\n+  ERR_TTY_INIT_FAILED,\n+  ERR_TTY_WRITABLE_NOT_READABLE\n+} = errors.codes;\n const { getColorDepth } = require('internal/tty');\n \n // Lazy loaded for startup performance.\n@@ -122,6 +126,13 @@ WriteStream.prototype._refreshSize = function() {\n   }\n };\n \n+// A WriteStream is not readable from, so _read become a no-op.\n+// this method could still be called because net.Socket()\n+// is a duplex\n+WriteStream.prototype._read = function() {\n+  this.destroy(new ERR_TTY_WRITABLE_NOT_READABLE());\n+};\n+\n // Backwards-compat\n WriteStream.prototype.cursorTo = function(x, y) {\n   if (readline === undefined) readline = require('readline');"
        },
        {
            "sha": "12ec1df45ad59806c055c4445a8bfe75b32b918b",
            "filename": "test/pseudo-tty/test-tty-write-stream-resume-crash.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.js",
            "raw_url": "https://github.com/nodejs/node/raw/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.js?ref=91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b",
            "patch": "@@ -0,0 +1,17 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { WriteStream } = require('tty');\n+const fd = common.getTTYfd();\n+\n+// Calling resume on a tty.WriteStream should be a no-op\n+// Ref: https://github.com/nodejs/node/issues/21203\n+\n+const stream = new WriteStream(fd);\n+stream.resume();\n+\n+stream.on('error', common.expectsError({\n+  code: 'ERR_TTY_WRITABLE_NOT_READABLE',\n+  type: Error,\n+  message: 'The Writable side of a TTY is not Readable'\n+}));"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-tty-write-stream-resume-crash.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.out",
            "raw_url": "https://github.com/nodejs/node/raw/91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-tty-write-stream-resume-crash.out?ref=91eec00ca20a54b1dc010cfc2fb34bc2f39eab6b"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 38,
        "deletions": 1
    }
}