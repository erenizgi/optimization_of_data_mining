{
    "author": "TimothyGu",
    "message": "url: reuse existing context in href setter\n\nCorrectness-wise, this removes side effects in the href setter if\nparsing fails. Style-wise, this allows removing the parse() wrapper\nfunction around C++ _parse().\n\nAlso fix an existing bug with whitespace trimming in C++ that was\npreviously circumvented by additionally trimming the input in\nJavaScript.\n\nFixes: https://github.com/nodejs/node/issues/24345\nRefs: https://github.com/nodejs/node/pull/24218#issuecomment-438476591\n\nPR-URL: https://github.com/nodejs/node/pull/24495\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Daijiro Wachi <daijiro.wachi@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f2be20b7353baacf0094c78693b8b4ffd7e94530",
    "files": [
        {
            "sha": "3ef8e272f906e73f42c7b0d1050b8de684c7ea3d",
            "filename": "lib/internal/url.js",
            "status": "modified",
            "additions": 17,
            "deletions": 21,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/f2be20b7353baacf0094c78693b8b4ffd7e94530/lib%2Finternal%2Furl.js",
            "raw_url": "https://github.com/nodejs/node/raw/f2be20b7353baacf0094c78693b8b4ffd7e94530/lib%2Finternal%2Furl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Furl.js?ref=f2be20b7353baacf0094c78693b8b4ffd7e94530",
            "patch": "@@ -43,7 +43,7 @@ const {\n   domainToUnicode: _domainToUnicode,\n   encodeAuth,\n   toUSVString: _toUSVString,\n-  parse: _parse,\n+  parse,\n   setURLConstructor,\n   URL_FLAGS_CANNOT_BE_BASE,\n   URL_FLAGS_HAS_FRAGMENT,\n@@ -243,14 +243,6 @@ function onParseError(flags, input) {\n   throw error;\n }\n \n-// Reused by URL constructor and URL#href setter.\n-function parse(url, input, base) {\n-  const base_context = base ? base[context] : undefined;\n-  url[context] = new URLContext();\n-  _parse(input.trim(), -1, base_context, undefined,\n-         onParseComplete.bind(url), onParseError);\n-}\n-\n function onParseProtocolComplete(flags, protocol, username, password,\n                                  host, port, path, query, fragment) {\n   const ctx = this[context];\n@@ -319,10 +311,13 @@ class URL {\n   constructor(input, base) {\n     // toUSVString is not needed.\n     input = `${input}`;\n+    let base_context;\n     if (base !== undefined) {\n-      base = new URL(base);\n+      base_context = new URL(base)[context];\n     }\n-    parse(this, input, base);\n+    this[context] = new URLContext();\n+    parse(input, -1, base_context, undefined, onParseComplete.bind(this),\n+          onParseError);\n   }\n \n   get [special]() {\n@@ -445,7 +440,8 @@ Object.defineProperties(URL.prototype, {\n     set(input) {\n       // toUSVString is not needed.\n       input = `${input}`;\n-      parse(this, input);\n+      parse(input, -1, undefined, undefined, onParseComplete.bind(this),\n+            onParseError);\n     }\n   },\n   origin: {  // readonly\n@@ -491,8 +487,8 @@ Object.defineProperties(URL.prototype, {\n           (ctx.host === '' || ctx.host === null)) {\n         return;\n       }\n-      _parse(scheme, kSchemeStart, null, ctx,\n-             onParseProtocolComplete.bind(this));\n+      parse(scheme, kSchemeStart, null, ctx,\n+            onParseProtocolComplete.bind(this));\n     }\n   },\n   username: {\n@@ -555,7 +551,7 @@ Object.defineProperties(URL.prototype, {\n         // Cannot set the host if cannot-be-base is set\n         return;\n       }\n-      _parse(host, kHost, null, ctx, onParseHostComplete.bind(this));\n+      parse(host, kHost, null, ctx, onParseHostComplete.bind(this));\n     }\n   },\n   hostname: {\n@@ -572,7 +568,7 @@ Object.defineProperties(URL.prototype, {\n         // Cannot set the host if cannot-be-base is set\n         return;\n       }\n-      _parse(host, kHostname, null, ctx, onParseHostnameComplete.bind(this));\n+      parse(host, kHostname, null, ctx, onParseHostnameComplete.bind(this));\n     }\n   },\n   port: {\n@@ -592,7 +588,7 @@ Object.defineProperties(URL.prototype, {\n         ctx.port = null;\n         return;\n       }\n-      _parse(port, kPort, null, ctx, onParsePortComplete.bind(this));\n+      parse(port, kPort, null, ctx, onParsePortComplete.bind(this));\n     }\n   },\n   pathname: {\n@@ -611,8 +607,8 @@ Object.defineProperties(URL.prototype, {\n       path = `${path}`;\n       if (this[cannotBeBase])\n         return;\n-      _parse(path, kPathStart, null, this[context],\n-             onParsePathComplete.bind(this));\n+      parse(path, kPathStart, null, this[context],\n+            onParsePathComplete.bind(this));\n     }\n   },\n   search: {\n@@ -635,7 +631,7 @@ Object.defineProperties(URL.prototype, {\n         ctx.query = '';\n         ctx.flags |= URL_FLAGS_HAS_QUERY;\n         if (search) {\n-          _parse(search, kQuery, null, ctx, onParseSearchComplete.bind(this));\n+          parse(search, kQuery, null, ctx, onParseSearchComplete.bind(this));\n         }\n       }\n       initSearchParams(this[searchParams], search);\n@@ -669,7 +665,7 @@ Object.defineProperties(URL.prototype, {\n       if (hash[0] === '#') hash = hash.slice(1);\n       ctx.fragment = '';\n       ctx.flags |= URL_FLAGS_HAS_FRAGMENT;\n-      _parse(hash, kFragment, null, ctx, onParseHashComplete.bind(this));\n+      parse(hash, kFragment, null, ctx, onParseHashComplete.bind(this));\n     }\n   },\n   toJSON: {"
        },
        {
            "sha": "57be5418aa533f8dc32b8f20ff5764d20c128b94",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/f2be20b7353baacf0094c78693b8b4ffd7e94530/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f2be20b7353baacf0094c78693b8b4ffd7e94530/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=f2be20b7353baacf0094c78693b8b4ffd7e94530",
            "patch": "@@ -1376,6 +1376,7 @@ void URL::Parse(const char* input,\n       else\n         break;\n     }\n+    input = p;\n     len = end - p;\n   }\n "
        },
        {
            "sha": "f161f6bbe9546ef06e4f05922d3d2694046e6e74",
            "filename": "test/parallel/test-whatwg-url-custom-href-side-effect.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f2be20b7353baacf0094c78693b8b4ffd7e94530/test%2Fparallel%2Ftest-whatwg-url-custom-href-side-effect.js",
            "raw_url": "https://github.com/nodejs/node/raw/f2be20b7353baacf0094c78693b8b4ffd7e94530/test%2Fparallel%2Ftest-whatwg-url-custom-href-side-effect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-url-custom-href-side-effect.js?ref=f2be20b7353baacf0094c78693b8b4ffd7e94530",
            "patch": "@@ -0,0 +1,15 @@\n+'use strict';\n+\n+// Tests below are not from WPT.\n+const common = require('../common');\n+const assert = require('assert');\n+\n+const ref = new URL('http://example.com/path');\n+const url = new URL('http://example.com/path');\n+common.expectsError(() => {\n+  url.href = '';\n+}, {\n+  type: TypeError\n+});\n+\n+assert.deepStrictEqual(url, ref);"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 33,
        "deletions": 21
    }
}