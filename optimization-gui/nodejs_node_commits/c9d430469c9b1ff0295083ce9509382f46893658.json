{
    "author": "mcollina",
    "message": "http2: check if stream is not destroyed before sending trailers\n\nFixes: https://github.com/nodejs/node/issues/22855\nPR-URL: https://github.com/nodejs/node/pull/22896\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "c9d430469c9b1ff0295083ce9509382f46893658",
    "files": [
        {
            "sha": "27fe4f26e31757654c4d4541437a1494ae9b472a",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/c9d430469c9b1ff0295083ce9509382f46893658/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9d430469c9b1ff0295083ce9509382f46893658/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=c9d430469c9b1ff0295083ce9509382f46893658",
            "patch": "@@ -1464,6 +1464,14 @@ function afterShutdown() {\n }\n \n function finishSendTrailers(stream, headersList) {\n+  // The stream might be destroyed and in that case\n+  // there is nothing to do.\n+  // This can happen because finishSendTrailers is\n+  // scheduled via setImmediate.\n+  if (stream.destroyed) {\n+    return;\n+  }\n+\n   stream[kState].flags &= ~STREAM_FLAGS_HAS_TRAILERS;\n \n   const ret = stream[kHandle].trailers(headersList);"
        },
        {
            "sha": "62405047d8266e4ef3ca38958f61d8d1619f5139",
            "filename": "test/parallel/test-http2-compat-socket-destroy-delayed.js",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/c9d430469c9b1ff0295083ce9509382f46893658/test%2Fparallel%2Ftest-http2-compat-socket-destroy-delayed.js",
            "raw_url": "https://github.com/nodejs/node/raw/c9d430469c9b1ff0295083ce9509382f46893658/test%2Fparallel%2Ftest-http2-compat-socket-destroy-delayed.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-socket-destroy-delayed.js?ref=c9d430469c9b1ff0295083ce9509382f46893658",
            "patch": "@@ -0,0 +1,42 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { mustCall } = common;\n+\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const http2 = require('http2');\n+const assert = require('assert');\n+\n+const {\n+  HTTP2_HEADER_PATH,\n+  HTTP2_HEADER_METHOD,\n+} = http2.constants;\n+\n+// This tests verifies that calling `req.socket.destroy()` via\n+// setImmediate does not crash.\n+// Fixes https://github.com/nodejs/node/issues/22855.\n+\n+const app = http2.createServer(mustCall((req, res) => {\n+  res.end('hello');\n+  setImmediate(() => req.socket.destroy());\n+}));\n+\n+app.listen(0, mustCall(() => {\n+  const session = http2.connect(`http://localhost:${app.address().port}`);\n+  const request = session.request({\n+    [HTTP2_HEADER_PATH]: '/',\n+    [HTTP2_HEADER_METHOD]: 'get'\n+  });\n+  request.once('response', mustCall((headers, flags) => {\n+    let data = '';\n+    request.on('data', (chunk) => { data += chunk; });\n+    request.on('end', mustCall(() => {\n+      assert.strictEqual(data, 'hello');\n+      session.close();\n+      app.close();\n+    }));\n+  }));\n+  request.end();\n+}));"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 50,
        "deletions": 0
    }
}