{
    "author": "mcollina",
    "message": "deps,http: http_parser set max header size to 8KB\n\nCVE-2018-12121\n\nPR-URL: https://github.com/nodejs-private/node-private/pull/143\nRef: https://github.com/nodejs-private/security/issues/139\nRef: https://github.com/nodejs-private/http-parser-private/pull/2\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "186035243fad247e3955fa0c202987cae99e82db",
    "files": [
        {
            "sha": "4364f73d1f4548298ea4092371e6586f0c18744b",
            "filename": "deps/http_parser/http_parser.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/186035243fad247e3955fa0c202987cae99e82db/deps%2Fhttp_parser%2Fhttp_parser.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/186035243fad247e3955fa0c202987cae99e82db/deps%2Fhttp_parser%2Fhttp_parser.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fhttp_parser%2Fhttp_parser.gyp?ref=186035243fad247e3955fa0c202987cae99e82db",
            "patch": "@@ -56,7 +56,7 @@\n         'defines': [ 'HTTP_PARSER_STRICT=0' ],\n         'include_dirs': [ '.' ],\n       },\n-      'defines': [ 'HTTP_PARSER_STRICT=0' ],\n+      'defines': [ 'HTTP_MAX_HEADER_SIZE=8192', 'HTTP_PARSER_STRICT=0' ],\n       'sources': [ './http_parser.c', ],\n       'conditions': [\n         ['OS==\"win\"', {\n@@ -79,7 +79,7 @@\n         'defines': [ 'HTTP_PARSER_STRICT=1' ],\n         'include_dirs': [ '.' ],\n       },\n-      'defines': [ 'HTTP_PARSER_STRICT=1' ],\n+      'defines': [ 'HTTP_MAX_HEADER_SIZE=8192', 'HTTP_PARSER_STRICT=1' ],\n       'sources': [ './http_parser.c', ],\n       'conditions': [\n         ['OS==\"win\"', {"
        },
        {
            "sha": "9fcfe316e392ff50cf38edd5bce1d4f31e0d842c",
            "filename": "test/parallel/test-http-max-headers-count.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/186035243fad247e3955fa0c202987cae99e82db/test%2Fparallel%2Ftest-http-max-headers-count.js",
            "raw_url": "https://github.com/nodejs/node/raw/186035243fad247e3955fa0c202987cae99e82db/test%2Fparallel%2Ftest-http-max-headers-count.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-max-headers-count.js?ref=186035243fad247e3955fa0c202987cae99e82db",
            "patch": "@@ -28,14 +28,14 @@ let requests = 0;\n let responses = 0;\n \n const headers = {};\n-const N = 2000;\n+const N = 100;\n for (let i = 0; i < N; ++i) {\n   headers[`key${i}`] = i;\n }\n \n const maxAndExpected = [ // for server\n   [50, 50],\n-  [1500, 1500],\n+  [1500, 102],\n   [0, N + 2] // Host and Connection\n ];\n let max = maxAndExpected[requests][0];\n@@ -56,7 +56,7 @@ server.maxHeadersCount = max;\n server.listen(0, function() {\n   const maxAndExpected = [ // for client\n     [20, 20],\n-    [1200, 1200],\n+    [1200, 103],\n     [0, N + 3] // Connection, Date and Transfer-Encoding\n   ];\n   doRequest();"
        },
        {
            "sha": "12aaaa9cd3ad84d887aac9e394c82026b8a090f4",
            "filename": "test/parallel/test-https-max-headers-count.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/186035243fad247e3955fa0c202987cae99e82db/test%2Fparallel%2Ftest-https-max-headers-count.js",
            "raw_url": "https://github.com/nodejs/node/raw/186035243fad247e3955fa0c202987cae99e82db/test%2Fparallel%2Ftest-https-max-headers-count.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-max-headers-count.js?ref=186035243fad247e3955fa0c202987cae99e82db",
            "patch": "@@ -17,14 +17,14 @@ let requests = 0;\n let responses = 0;\n \n const headers = {};\n-const N = 2000;\n+const N = 100;\n for (let i = 0; i < N; ++i) {\n   headers[`key${i}`] = i;\n }\n \n const maxAndExpected = [ // for server\n   [50, 50],\n-  [1500, 1500],\n+  [1500, 102],\n   [0, N + 2] // Host and Connection\n ];\n let max = maxAndExpected[requests][0];\n@@ -45,7 +45,7 @@ server.maxHeadersCount = max;\n server.listen(0, common.mustCall(() => {\n   const maxAndExpected = [ // for client\n     [20, 20],\n-    [1200, 1200],\n+    [1200, 103],\n     [0, N + 3] // Connection, Date and Transfer-Encoding\n   ];\n   const doRequest = common.mustCall(() => {"
        },
        {
            "sha": "155b75fb076ae150b27821fa6e95af3d29eaef39",
            "filename": "test/sequential/test-http-max-http-headers.js",
            "status": "added",
            "additions": 154,
            "deletions": 0,
            "changes": 154,
            "blob_url": "https://github.com/nodejs/node/blob/186035243fad247e3955fa0c202987cae99e82db/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/186035243fad247e3955fa0c202987cae99e82db/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-max-http-headers.js?ref=186035243fad247e3955fa0c202987cae99e82db",
            "patch": "@@ -0,0 +1,154 @@\n+'use strict';\n+\n+const assert = require('assert');\n+const common = require('../common');\n+const http = require('http');\n+const net = require('net');\n+const MAX = 8 * 1024; // 8KB\n+\n+// Verify that we cannot receive more than 8KB of headers.\n+\n+function once(cb) {\n+  let called = false;\n+  return () => {\n+    if (!called) {\n+      called = true;\n+      cb();\n+    }\n+  };\n+}\n+\n+function finished(client, callback) {\n+  'abort error end'.split(' ').forEach((e) => {\n+    client.on(e, once(() => setImmediate(callback)));\n+  });\n+}\n+\n+function fillHeaders(headers, currentSize, valid = false) {\n+  // Generate valid headers\n+  if (valid) {\n+    // TODO(mcollina): understand why -9 is needed instead of -1\n+    headers = headers.slice(0, -9);\n+  }\n+  return headers + '\\r\\n\\r\\n';\n+}\n+\n+const timeout = common.platformTimeout(10);\n+\n+function writeHeaders(socket, headers) {\n+  const array = [];\n+\n+  // this is off from 1024 so that \\r\\n does not get split\n+  const chunkSize = 1000;\n+  let last = 0;\n+\n+  for (let i = 0; i < headers.length / chunkSize; i++) {\n+    const current = (i + 1) * chunkSize;\n+    array.push(headers.slice(last, current));\n+    last = current;\n+  }\n+\n+  // safety check we are chunking correctly\n+  assert.strictEqual(array.join(''), headers);\n+\n+  next();\n+\n+  function next() {\n+    if (socket.write(array.shift())) {\n+      if (array.length === 0) {\n+        socket.end();\n+      } else {\n+        setTimeout(next, timeout);\n+      }\n+    } else {\n+      socket.once('drain', next);\n+    }\n+  }\n+}\n+\n+function test1() {\n+  let headers =\n+    'HTTP/1.1 200 OK\\r\\n' +\n+    'Content-Length: 0\\r\\n' +\n+    'X-CRASH: ';\n+\n+  // OK, Content-Length, 0, X-CRASH, aaa...\n+  const currentSize = 2 + 14 + 1 + 7;\n+  headers = fillHeaders(headers, currentSize);\n+\n+  const server = net.createServer((sock) => {\n+    sock.once('data', (chunk) => {\n+      writeHeaders(sock, headers);\n+      sock.resume();\n+    });\n+  });\n+\n+  server.listen(0, common.mustCall(() => {\n+    const port = server.address().port;\n+    const client = http.get({ port: port }, common.mustNotCall(() => {}));\n+\n+    client.on('error', common.mustCall((err) => {\n+      assert.strictEqual(err.code, 'HPE_HEADER_OVERFLOW');\n+      server.close();\n+      setImmediate(test2);\n+    }));\n+  }));\n+}\n+\n+const test2 = common.mustCall(() => {\n+  let headers =\n+    'GET / HTTP/1.1\\r\\n' +\n+    'Host: localhost\\r\\n' +\n+    'Agent: node\\r\\n' +\n+    'X-CRASH: ';\n+\n+  // /, Host, localhost, Agent, node, X-CRASH, a...\n+  const currentSize = 1 + 4 + 9 + 5 + 4 + 7;\n+  headers = fillHeaders(headers, currentSize);\n+\n+  const server = http.createServer(common.mustNotCall());\n+\n+  server.on('clientError', common.mustCall((err) => {\n+    assert.strictEqual(err.code, 'HPE_HEADER_OVERFLOW');\n+  }));\n+\n+  server.listen(0, common.mustCall(() => {\n+    const client = net.connect(server.address().port);\n+    client.on('connect', () => {\n+      writeHeaders(client, headers);\n+      client.resume();\n+    });\n+\n+    finished(client, common.mustCall((err) => {\n+      server.close();\n+      setImmediate(test3);\n+    }));\n+  }));\n+});\n+\n+const test3 = common.mustCall(() => {\n+  let headers =\n+    'GET / HTTP/1.1\\r\\n' +\n+    'Host: localhost\\r\\n' +\n+    'Agent: node\\r\\n' +\n+    'X-CRASH: ';\n+\n+  // /, Host, localhost, Agent, node, X-CRASH, a...\n+  const currentSize = 1 + 4 + 9 + 5 + 4 + 7;\n+  headers = fillHeaders(headers, currentSize, true);\n+\n+  const server = http.createServer(common.mustCall((req, res) => {\n+    res.end('hello world');\n+    setImmediate(server.close.bind(server));\n+  }));\n+\n+  server.listen(0, common.mustCall(() => {\n+    const client = net.connect(server.address().port);\n+    client.on('connect', () => {\n+      writeHeaders(client, headers);\n+      client.resume();\n+    });\n+  }));\n+});\n+\n+test1();"
        }
    ],
    "stats": {
        "total": 170,
        "additions": 162,
        "deletions": 8
    }
}