{
    "author": "jasnell",
    "message": "trace_events: add more process metadata\n\nNow that TracedValue has landed, add more detailed\nprocess `__metadata` including versions, arch, platform,\nrelease detail, and argv/execArgv to the trace event\nlog.\n\nPR-URL: https://github.com/nodejs/node/pull/21785\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "ededb4b510d37fa73582f71d7bd6d3a5bb046be2",
    "files": [
        {
            "sha": "005b17c27618ea30478608dec51ab7d99da37fc1",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 96,
            "deletions": 14,
            "changes": 110,
            "blob_url": "https://github.com/nodejs/node/blob/ededb4b510d37fa73582f71d7bd6d3a5bb046be2/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ededb4b510d37fa73582f71d7bd6d3a5bb046be2/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=ededb4b510d37fa73582f71d7bd6d3a5bb046be2",
            "patch": "@@ -30,6 +30,7 @@\n #include \"node_debug_options.h\"\n #include \"node_perf.h\"\n #include \"node_context_data.h\"\n+#include \"tracing/traced_value.h\"\n \n #if defined HAVE_PERFCTR\n #include \"node_counters.h\"\n@@ -289,11 +290,106 @@ static v8::Isolate* node_isolate;\n \n DebugOptions debug_options;\n \n+// Ensures that __metadata trace events are only emitted\n+// when tracing is enabled.\n+class NodeTraceStateObserver :\n+    public v8::TracingController::TraceStateObserver {\n+ public:\n+  void OnTraceEnabled() override {\n+    char name_buffer[512];\n+    if (uv_get_process_title(name_buffer, sizeof(name_buffer)) == 0) {\n+      // Only emit the metadata event if the title can be retrieved\n+      // successfully. Ignore it otherwise.\n+      TRACE_EVENT_METADATA1(\"__metadata\", \"process_name\",\n+                            \"name\", TRACE_STR_COPY(name_buffer));\n+    }\n+    TRACE_EVENT_METADATA1(\"__metadata\", \"version\",\n+                          \"node\", NODE_VERSION_STRING);\n+    TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\",\n+                          \"name\", \"JavaScriptMainThread\");\n+\n+    auto trace_process = tracing::TracedValue::Create();\n+    trace_process->BeginDictionary(\"versions\");\n+\n+    const char http_parser_version[] =\n+        NODE_STRINGIFY(HTTP_PARSER_VERSION_MAJOR)\n+        \".\"\n+        NODE_STRINGIFY(HTTP_PARSER_VERSION_MINOR)\n+        \".\"\n+        NODE_STRINGIFY(HTTP_PARSER_VERSION_PATCH);\n+\n+    const char node_napi_version[] = NODE_STRINGIFY(NAPI_VERSION);\n+    const char node_modules_version[] = NODE_STRINGIFY(NODE_MODULE_VERSION);\n+\n+    trace_process->SetString(\"http_parser\", http_parser_version);\n+    trace_process->SetString(\"node\", NODE_VERSION_STRING);\n+    trace_process->SetString(\"v8\", V8::GetVersion());\n+    trace_process->SetString(\"uv\", uv_version_string());\n+    trace_process->SetString(\"zlib\", ZLIB_VERSION);\n+    trace_process->SetString(\"ares\", ARES_VERSION_STR);\n+    trace_process->SetString(\"modules\", node_modules_version);\n+    trace_process->SetString(\"nghttp2\", NGHTTP2_VERSION);\n+    trace_process->SetString(\"napi\", node_napi_version);\n+\n+#if HAVE_OPENSSL\n+    // Stupid code to slice out the version string.\n+    {  // NOLINT(whitespace/braces)\n+      size_t i, j, k;\n+      int c;\n+      for (i = j = 0, k = sizeof(OPENSSL_VERSION_TEXT) - 1; i < k; ++i) {\n+        c = OPENSSL_VERSION_TEXT[i];\n+        if ('0' <= c && c <= '9') {\n+          for (j = i + 1; j < k; ++j) {\n+            c = OPENSSL_VERSION_TEXT[j];\n+            if (c == ' ')\n+              break;\n+          }\n+          break;\n+        }\n+      }\n+      trace_process->SetString(\"openssl\",\n+                              std::string(&OPENSSL_VERSION_TEXT[i], j - i));\n+    }\n+#endif\n+    trace_process->EndDictionary();\n+\n+    trace_process->SetString(\"arch\", NODE_ARCH);\n+    trace_process->SetString(\"platform\", NODE_PLATFORM);\n+\n+    trace_process->BeginDictionary(\"release\");\n+    trace_process->SetString(\"name\", NODE_RELEASE);\n+#if NODE_VERSION_IS_LTS\n+    trace_process->SetString(\"lts\", NODE_VERSION_LTS_CODENAME);\n+#endif\n+    trace_process->EndDictionary();\n+    TRACE_EVENT_METADATA1(\"__metadata\", \"node\",\n+                          \"process\", std::move(trace_process));\n+\n+    // This only runs the first time tracing is enabled\n+    controller_->RemoveTraceStateObserver(this);\n+    delete this;\n+  }\n+\n+  void OnTraceDisabled() override {\n+    // Do nothing here. This should never be called because the\n+    // observer removes itself when OnTraceEnabled() is called.\n+    UNREACHABLE();\n+  }\n+\n+  explicit NodeTraceStateObserver(v8::TracingController* controller) :\n+      controller_(controller) {}\n+  ~NodeTraceStateObserver() override {}\n+\n+ private:\n+  v8::TracingController* controller_;\n+};\n+\n static struct {\n #if NODE_USE_V8_PLATFORM\n   void Initialize(int thread_pool_size) {\n     tracing_agent_.reset(new tracing::Agent(trace_file_pattern));\n     auto controller = tracing_agent_->GetTracingController();\n+    controller->AddTraceStateObserver(new NodeTraceStateObserver(controller));\n     tracing::TraceEventHelper::SetTracingController(controller);\n     StartTracingAgent();\n     platform_ = new NodePlatform(thread_pool_size, controller);\n@@ -1993,7 +2089,6 @@ void SetupProcessObject(Environment* env,\n   READONLY_PROPERTY(versions,\n                     \"http_parser\",\n                     FIXED_ONE_BYTE_STRING(env->isolate(), http_parser_version));\n-\n   // +1 to get rid of the leading 'v'\n   READONLY_PROPERTY(versions,\n                     \"node\",\n@@ -2016,11 +2111,9 @@ void SetupProcessObject(Environment* env,\n       versions,\n       \"modules\",\n       FIXED_ONE_BYTE_STRING(env->isolate(), node_modules_version));\n-\n   READONLY_PROPERTY(versions,\n                     \"nghttp2\",\n                     FIXED_ONE_BYTE_STRING(env->isolate(), NGHTTP2_VERSION));\n-\n   const char node_napi_version[] = NODE_STRINGIFY(NAPI_VERSION);\n   READONLY_PROPERTY(\n       versions,\n@@ -3547,17 +3640,6 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   Environment env(isolate_data, context, v8_platform.GetTracingAgent());\n   env.Start(argc, argv, exec_argc, exec_argv, v8_is_profiling);\n \n-  char name_buffer[512];\n-  if (uv_get_process_title(name_buffer, sizeof(name_buffer)) == 0) {\n-    // Only emit the metadata event if the title can be retrieved successfully.\n-    // Ignore it otherwise.\n-    TRACE_EVENT_METADATA1(\"__metadata\", \"process_name\", \"name\",\n-                          TRACE_STR_COPY(name_buffer));\n-  }\n-  TRACE_EVENT_METADATA1(\"__metadata\", \"version\", \"node\", NODE_VERSION_STRING);\n-  TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\", \"name\",\n-                        \"JavaScriptMainThread\");\n-\n   const char* path = argc > 1 ? argv[1] : nullptr;\n   StartInspector(&env, path, debug_options);\n "
        },
        {
            "sha": "01e019c1906956ef00326223e2a583060b59f30b",
            "filename": "test/parallel/test-trace-events-metadata.js",
            "status": "modified",
            "additions": 36,
            "deletions": 8,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/ededb4b510d37fa73582f71d7bd6d3a5bb046be2/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/ededb4b510d37fa73582f71d7bd6d3a5bb046be2/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-metadata.js?ref=ededb4b510d37fa73582f71d7bd6d3a5bb046be2",
            "patch": "@@ -23,25 +23,53 @@ const proc = cp.spawn(process.execPath,\n proc.once('exit', common.mustCall(() => {\n   assert(common.fileExists(FILE_NAME));\n   fs.readFile(FILE_NAME, common.mustCall((err, data) => {\n-    const traces = JSON.parse(data.toString()).traceEvents;\n+    const traces = JSON.parse(data.toString()).traceEvents\n+      .filter((trace) => trace.cat === '__metadata');\n     assert(traces.length > 0);\n     assert(traces.some((trace) =>\n-      trace.cat === '__metadata' && trace.name === 'thread_name' &&\n+      trace.name === 'thread_name' &&\n         trace.args.name === 'JavaScriptMainThread'));\n     assert(traces.some((trace) =>\n-      trace.cat === '__metadata' && trace.name === 'thread_name' &&\n+      trace.name === 'thread_name' &&\n         trace.args.name === 'BackgroundTaskRunner'));\n     assert(traces.some((trace) =>\n-      trace.cat === '__metadata' && trace.name === 'version' &&\n+      trace.name === 'version' &&\n         trace.args.node === process.versions.node));\n+\n+    assert(traces.some((trace) =>\n+      trace.name === 'node' &&\n+        trace.args.process.versions.http_parser ===\n+          process.versions.http_parser &&\n+        trace.args.process.versions.node ===\n+          process.versions.node &&\n+        trace.args.process.versions.v8 ===\n+          process.versions.v8 &&\n+        trace.args.process.versions.uv ===\n+          process.versions.uv &&\n+        trace.args.process.versions.zlib ===\n+          process.versions.zlib &&\n+        trace.args.process.versions.ares ===\n+          process.versions.ares &&\n+        trace.args.process.versions.modules ===\n+          process.versions.modules &&\n+        trace.args.process.versions.nghttp2 ===\n+          process.versions.nghttp2 &&\n+        trace.args.process.versions.napi ===\n+          process.versions.napi &&\n+        trace.args.process.versions.openssl ===\n+          process.versions.openssl &&\n+        trace.args.process.arch === process.arch &&\n+        trace.args.process.platform === process.platform &&\n+        trace.args.process.release.name === process.release.name &&\n+        (!process.release.lts ||\n+          trace.args.process.release.lts === process.release.lts)));\n+\n     if (!common.isSunOS) {\n       // Changing process.title is currently unsupported on SunOS/SmartOS\n       assert(traces.some((trace) =>\n-        trace.cat === '__metadata' && trace.name === 'process_name' &&\n-          trace.args.name === 'foo'));\n+        trace.name === 'process_name' && trace.args.name === 'foo'));\n       assert(traces.some((trace) =>\n-        trace.cat === '__metadata' && trace.name === 'process_name' &&\n-          trace.args.name === 'bar'));\n+        trace.name === 'process_name' && trace.args.name === 'bar'));\n     }\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 154,
        "additions": 132,
        "deletions": 22
    }
}