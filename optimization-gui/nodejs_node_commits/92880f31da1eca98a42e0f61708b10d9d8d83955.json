{
    "author": "cjihrig",
    "message": "os: add os.{get,set}Priority()\n\nPR-URL: https://github.com/nodejs/node/pull/22407\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "92880f31da1eca98a42e0f61708b10d9d8d83955",
    "files": [
        {
            "sha": "4557bb6b7d369af8f4defbcf23e53141830ca5c8",
            "filename": "doc/api/os.md",
            "status": "modified",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/doc%2Fapi%2Fos.md",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/doc%2Fapi%2Fos.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fos.md?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -192,6 +192,19 @@ added: v0.3.3\n The `os.freemem()` method returns the amount of free system memory in bytes as\n an integer.\n \n+## os.getPriority([pid])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `pid` {integer} The process ID to retrieve scheduling priority for.\n+  **Default** `0`.\n+* Returns: {integer}\n+\n+The `os.getPriority()` method returns the scheduling priority for the process\n+specified by `pid`. If `pid` is not provided, or is `0`, the priority of the\n+current process is returned.\n+\n ## os.homedir()\n <!-- YAML\n added: v2.3.0\n@@ -338,6 +351,26 @@ On POSIX systems, the operating system release is determined by calling\n [uname(3)][]. On Windows, `GetVersionExW()` is used. Please see\n https://en.wikipedia.org/wiki/Uname#Examples for more information.\n \n+## os.setPriority([pid, ]priority)\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* `pid` {integer} The process ID to set scheduling priority for.\n+  **Default** `0`.\n+* `priority` {integer} The scheduling priority to assign to the process.\n+\n+The `os.setPriority()` method attempts to set the scheduling priority for the\n+process specified by `pid`. If `pid` is not provided, or is `0`, the priority\n+of the current process is used.\n+\n+The `priority` input must be an integer between `-20` (high priority) and `19`\n+(low priority). Due to differences between Unix priority levels and Windows\n+priority classes, `priority` is mapped to one of six priority constants in\n+`os.constants.priority`. When retrieving a process priority level, this range\n+mapping may cause the return value to be slightly different on Windows. To avoid\n+confusion, it is recommended to set `priority` to one of the priority constants.\n+\n ## os.tmpdir()\n <!-- YAML\n added: v0.9.9\n@@ -1208,6 +1241,60 @@ information.\n   </tr>\n </table>\n \n+### Priority Constants\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+The following process scheduling constants are exported by\n+`os.constants.priority`:\n+\n+<table>\n+  <tr>\n+    <th>Constant</th>\n+    <th>Description</th>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_LOW</code></td>\n+    <td>The lowest process scheduling priority. This corresponds to\n+    <code>IDLE_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>19</code> on all other platforms.</td>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_BELOW_NORMAL</code></td>\n+    <td>The process scheduling priority above <code>PRIORITY_LOW</code> and\n+    below <code>PRIORITY_NORMAL</code>. This corresponds to\n+    <code>BELOW_NORMAL_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>10</code> on all other platforms.</td>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_NORMAL</code></td>\n+    <td>The default process scheduling priority. This corresponds to\n+    <code>NORMAL_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>0</code> on all other platforms.</td>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_ABOVE_NORMAL</code></td>\n+    <td>The process scheduling priority above <code>PRIORITY_NORMAL</code> and\n+    below <code>PRIORITY_HIGH</code>. This corresponds to\n+    <code>ABOVE_NORMAL_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>-7</code> on all other platforms.</td>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_HIGH</code></td>\n+    <td>The process scheduling priority above <code>PRIORITY_ABOVE_NORMAL</code>\n+    and below <code>PRIORITY_HIGHEST</code>. This corresponds to\n+    <code>HIGH_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>-14</code> on all other platforms.</td>\n+  </tr>\n+  <tr>\n+    <td><code>PRIORITY_HIGHEST</code></td>\n+    <td>The highest process scheduling priority. This corresponds to\n+    <code>REALTIME_PRIORITY_CLASS</code> on Windows, and a nice value of\n+    <code>-20</code> on all other platforms.</td>\n+  </tr>\n+</table>\n+\n ### libuv Constants\n \n <table>"
        },
        {
            "sha": "a4c2ca6fb38ba80288e0fb542397fc7895b1010a",
            "filename": "lib/constants.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/lib%2Fconstants.js",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/lib%2Fconstants.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconstants.js?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -29,6 +29,7 @@ const constants = process.binding('constants');\n Object.assign(exports,\n               constants.os.dlopen,\n               constants.os.errno,\n+              constants.os.priority,\n               constants.os.signals,\n               constants.fs,\n               constants.crypto);"
        },
        {
            "sha": "09a70d2f7b19e57fd5f6174777f10085519c9243",
            "filename": "lib/os.js",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/lib%2Fos.js",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/lib%2Fos.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fos.js?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -27,6 +27,7 @@ const { deprecate } = require('internal/util');\n const isWindows = process.platform === 'win32';\n \n const { codes: { ERR_SYSTEM_ERROR } } = require('internal/errors');\n+const { validateInt32 } = require('internal/validators');\n \n const {\n   getCPUs,\n@@ -37,10 +38,12 @@ const {\n   getLoadAvg,\n   getOSRelease: _getOSRelease,\n   getOSType: _getOSType,\n+  getPriority: _getPriority,\n   getTotalMem,\n   getUserInfo: _getUserInfo,\n   getUptime,\n-  isBigEndian\n+  isBigEndian,\n+  setPriority: _setPriority\n } = process.binding('os');\n \n function getCheckedFunction(fn) {\n@@ -206,17 +209,49 @@ function networkInterfaces() {\n   return interfaceAddresses;\n }\n \n+function setPriority(pid, priority) {\n+  if (priority === undefined) {\n+    priority = pid;\n+    pid = 0;\n+  }\n+\n+  validateInt32(pid, 'pid');\n+  validateInt32(priority, 'priority', -20, 19);\n+\n+  const ctx = {};\n+\n+  if (_setPriority(pid, priority, ctx) !== 0)\n+    throw new ERR_SYSTEM_ERROR(ctx);\n+}\n+\n+function getPriority(pid) {\n+  if (pid === undefined)\n+    pid = 0;\n+  else\n+    validateInt32(pid, 'pid');\n+\n+  const ctx = {};\n+  const priority = _getPriority(pid, ctx);\n+\n+  if (priority === undefined)\n+    throw new ERR_SYSTEM_ERROR(ctx);\n+\n+  return priority;\n+}\n+\n module.exports = {\n   arch,\n   cpus,\n   endianness,\n   freemem: getFreeMem,\n+  getPriority,\n   homedir: getHomeDirectory,\n   hostname: getHostname,\n   loadavg,\n   networkInterfaces,\n   platform,\n   release: getOSRelease,\n+  setPriority,\n   tmpdir,\n   totalmem: getTotalMem,\n   type: getOSType,"
        },
        {
            "sha": "f1468ff7ca03f254df8d63a9b0118241ab3b86e0",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -758,6 +758,44 @@ void DefineSignalConstants(Local<Object> target) {\n #endif\n }\n \n+void DefinePriorityConstants(Local<Object> target) {\n+#ifdef UV_PRIORITY_LOW\n+# define PRIORITY_LOW UV_PRIORITY_LOW\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_LOW);\n+# undef PRIORITY_LOW\n+#endif\n+\n+#ifdef UV_PRIORITY_BELOW_NORMAL\n+# define PRIORITY_BELOW_NORMAL UV_PRIORITY_BELOW_NORMAL\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_BELOW_NORMAL);\n+# undef PRIORITY_BELOW_NORMAL\n+#endif\n+\n+#ifdef UV_PRIORITY_NORMAL\n+# define PRIORITY_NORMAL UV_PRIORITY_NORMAL\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_NORMAL);\n+# undef PRIORITY_NORMAL\n+#endif\n+\n+#ifdef UV_PRIORITY_ABOVE_NORMAL\n+# define PRIORITY_ABOVE_NORMAL UV_PRIORITY_ABOVE_NORMAL\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_ABOVE_NORMAL);\n+# undef PRIORITY_ABOVE_NORMAL\n+#endif\n+\n+#ifdef UV_PRIORITY_HIGH\n+# define PRIORITY_HIGH UV_PRIORITY_HIGH\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_HIGH);\n+# undef PRIORITY_HIGH\n+#endif\n+\n+#ifdef UV_PRIORITY_HIGHEST\n+# define PRIORITY_HIGHEST UV_PRIORITY_HIGHEST\n+  NODE_DEFINE_CONSTANT(target, PRIORITY_HIGHEST);\n+# undef PRIORITY_HIGHEST\n+#endif\n+}\n+\n void DefineOpenSSLConstants(Local<Object> target) {\n #ifdef OPENSSL_VERSION_NUMBER\n     NODE_DEFINE_CONSTANT(target, OPENSSL_VERSION_NUMBER);\n@@ -1338,6 +1376,10 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   CHECK(sig_constants->SetPrototype(env->context(),\n                                     Null(env->isolate())).FromJust());\n \n+  Local<Object> priority_constants = Object::New(isolate);\n+  CHECK(priority_constants->SetPrototype(env->context(),\n+                                         Null(env->isolate())).FromJust());\n+\n   Local<Object> fs_constants = Object::New(isolate);\n   CHECK(fs_constants->SetPrototype(env->context(),\n                                    Null(env->isolate())).FromJust());\n@@ -1361,6 +1403,7 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   DefineErrnoConstants(err_constants);\n   DefineWindowsErrorConstants(err_constants);\n   DefineSignalConstants(sig_constants);\n+  DefinePriorityConstants(priority_constants);\n   DefineSystemConstants(fs_constants);\n   DefineOpenSSLConstants(crypto_constants);\n   DefineCryptoConstants(crypto_constants);\n@@ -1374,6 +1417,7 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   os_constants->Set(OneByteString(isolate, \"dlopen\"), dlopen_constants);\n   os_constants->Set(OneByteString(isolate, \"errno\"), err_constants);\n   os_constants->Set(OneByteString(isolate, \"signals\"), sig_constants);\n+  os_constants->Set(OneByteString(isolate, \"priority\"), priority_constants);\n   target->Set(OneByteString(isolate, \"os\"), os_constants);\n   target->Set(OneByteString(isolate, \"fs\"), fs_constants);\n   target->Set(OneByteString(isolate, \"crypto\"), crypto_constants);"
        },
        {
            "sha": "d3e9460f473122dfea64324f8981c1713b01eef9",
            "filename": "src/node_os.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/src%2Fnode_os.cc",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/src%2Fnode_os.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_os.cc?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -52,6 +52,7 @@ using v8::Context;\n using v8::Float64Array;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n+using v8::Int32;\n using v8::Integer;\n using v8::Local;\n using v8::MaybeLocal;\n@@ -405,6 +406,46 @@ static void GetUserInfo(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n+static void SetPriority(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK_EQ(args.Length(), 3);\n+  CHECK(args[0]->IsInt32());\n+  CHECK(args[1]->IsInt32());\n+\n+  const int pid = args[0].As<Int32>()->Value();\n+  const int priority = args[1].As<Int32>()->Value();\n+  const int err = uv_os_setpriority(pid, priority);\n+\n+  if (err) {\n+    CHECK(args[2]->IsObject());\n+    env->CollectUVExceptionInfo(args[2], err, \"uv_os_setpriority\");\n+  }\n+\n+  args.GetReturnValue().Set(err);\n+}\n+\n+\n+static void GetPriority(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK_EQ(args.Length(), 2);\n+  CHECK(args[0]->IsInt32());\n+\n+  const int pid = args[0].As<Int32>()->Value();\n+  int priority;\n+  const int err = uv_os_getpriority(pid, &priority);\n+\n+  if (err) {\n+    CHECK(args[1]->IsObject());\n+    env->CollectUVExceptionInfo(args[1], err, \"uv_os_getpriority\");\n+    return;\n+  }\n+\n+  args.GetReturnValue().Set(priority);\n+}\n+\n+\n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n                 Local<Context> context) {\n@@ -420,6 +461,8 @@ void Initialize(Local<Object> target,\n   env->SetMethod(target, \"getInterfaceAddresses\", GetInterfaceAddresses);\n   env->SetMethod(target, \"getHomeDirectory\", GetHomeDirectory);\n   env->SetMethod(target, \"getUserInfo\", GetUserInfo);\n+  env->SetMethod(target, \"setPriority\", SetPriority);\n+  env->SetMethod(target, \"getPriority\", GetPriority);\n   target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"isBigEndian\"),\n               Boolean::New(env->isolate(), IsBigEndian()));\n }"
        },
        {
            "sha": "9855af19422882d38c52c174e0571f1c5ef3221e",
            "filename": "test/parallel/test-binding-constants.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/test%2Fparallel%2Ftest-binding-constants.js",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/test%2Fparallel%2Ftest-binding-constants.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-binding-constants.js?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -10,7 +10,7 @@ assert.deepStrictEqual(\n \n assert.deepStrictEqual(\n   Object.keys(constants.os).sort(), ['UV_UDP_REUSEADDR', 'dlopen', 'errno',\n-                                     'signals']\n+                                     'priority', 'signals']\n );\n \n // Make sure all the constants objects don't inherit from Object.prototype"
        },
        {
            "sha": "9d66cfc49bc27a22594837d051818fe0ac932bc0",
            "filename": "test/parallel/test-os-process-priority.js",
            "status": "added",
            "additions": 131,
            "deletions": 0,
            "changes": 131,
            "blob_url": "https://github.com/nodejs/node/blob/92880f31da1eca98a42e0f61708b10d9d8d83955/test%2Fparallel%2Ftest-os-process-priority.js",
            "raw_url": "https://github.com/nodejs/node/raw/92880f31da1eca98a42e0f61708b10d9d8d83955/test%2Fparallel%2Ftest-os-process-priority.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-os-process-priority.js?ref=92880f31da1eca98a42e0f61708b10d9d8d83955",
            "patch": "@@ -0,0 +1,131 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const os = require('os');\n+const {\n+  PRIORITY_LOW,\n+  PRIORITY_BELOW_NORMAL,\n+  PRIORITY_NORMAL,\n+  PRIORITY_ABOVE_NORMAL,\n+  PRIORITY_HIGH,\n+  PRIORITY_HIGHEST\n+} = os.constants.priority;\n+\n+// Validate priority constants.\n+assert.strictEqual(typeof PRIORITY_LOW, 'number');\n+assert.strictEqual(typeof PRIORITY_BELOW_NORMAL, 'number');\n+assert.strictEqual(typeof PRIORITY_NORMAL, 'number');\n+assert.strictEqual(typeof PRIORITY_ABOVE_NORMAL, 'number');\n+assert.strictEqual(typeof PRIORITY_HIGH, 'number');\n+assert.strictEqual(typeof PRIORITY_HIGHEST, 'number');\n+\n+// Test pid type validation.\n+[null, true, false, 'foo', {}, [], /x/].forEach((pid) => {\n+  const errObj = {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    message: /The \"pid\" argument must be of type number\\./\n+  };\n+\n+  common.expectsError(() => {\n+    os.setPriority(pid, PRIORITY_NORMAL);\n+  }, errObj);\n+\n+  common.expectsError(() => {\n+    os.getPriority(pid);\n+  }, errObj);\n+});\n+\n+// Test pid range validation.\n+[NaN, Infinity, -Infinity, 3.14, 2 ** 32].forEach((pid) => {\n+  const errObj = {\n+    code: 'ERR_OUT_OF_RANGE',\n+    message: /The value of \"pid\" is out of range\\./\n+  };\n+\n+  common.expectsError(() => {\n+    os.setPriority(pid, PRIORITY_NORMAL);\n+  }, errObj);\n+\n+  common.expectsError(() => {\n+    os.getPriority(pid);\n+  }, errObj);\n+});\n+\n+// Test priority type validation.\n+[null, true, false, 'foo', {}, [], /x/].forEach((priority) => {\n+  common.expectsError(() => {\n+    os.setPriority(0, priority);\n+  }, {\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    message: /The \"priority\" argument must be of type number\\./\n+  });\n+});\n+\n+// Test priority range validation.\n+[\n+  NaN,\n+  Infinity,\n+  -Infinity,\n+  3.14,\n+  2 ** 32,\n+  PRIORITY_HIGHEST - 1,\n+  PRIORITY_LOW + 1\n+].forEach((priority) => {\n+  common.expectsError(() => {\n+    os.setPriority(0, priority);\n+  }, {\n+    code: 'ERR_OUT_OF_RANGE',\n+    message: /The value of \"priority\" is out of range\\./\n+  });\n+});\n+\n+// Verify that valid values work.\n+for (let i = PRIORITY_HIGHEST; i <= PRIORITY_LOW; i++) {\n+  // A pid of 0 corresponds to the current process.\n+  try {\n+    os.setPriority(0, i);\n+  } catch (err) {\n+    // The current user might not have sufficient permissions to set this\n+    // specific priority level. Skip this priority, but keep trying lower\n+    // priorities.\n+    if (err.info.code === 'EACCES')\n+      continue;\n+\n+    assert(err);\n+  }\n+\n+  checkPriority(0, i);\n+\n+  // An undefined pid corresponds to the current process.\n+  os.setPriority(i);\n+  checkPriority(undefined, i);\n+\n+  // Specifying the actual pid works.\n+  os.setPriority(process.pid, i);\n+  checkPriority(process.pid, i);\n+}\n+\n+\n+function checkPriority(pid, expected) {\n+  const priority = os.getPriority(pid);\n+\n+  // Verify that the priority values match on Unix, and are range mapped on\n+  // Windows.\n+  if (!common.isWindows) {\n+    assert.strictEqual(priority, expected);\n+    return;\n+  }\n+\n+  if (expected < PRIORITY_HIGH)\n+    assert.strictEqual(priority, PRIORITY_HIGHEST);\n+  else if (expected < PRIORITY_ABOVE_NORMAL)\n+    assert.strictEqual(priority, PRIORITY_HIGH);\n+  else if (expected < PRIORITY_NORMAL)\n+    assert.strictEqual(priority, PRIORITY_ABOVE_NORMAL);\n+  else if (expected < PRIORITY_BELOW_NORMAL)\n+    assert.strictEqual(priority, PRIORITY_NORMAL);\n+  else if (expected < PRIORITY_LOW)\n+    assert.strictEqual(priority, PRIORITY_BELOW_NORMAL);\n+  else\n+    assert.strictEqual(priority, PRIORITY_LOW);\n+}"
        }
    ],
    "stats": {
        "total": 345,
        "additions": 343,
        "deletions": 2
    }
}