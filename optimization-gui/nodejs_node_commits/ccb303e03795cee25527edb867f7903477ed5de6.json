{
    "author": "BridgeAR",
    "message": "repl: improve error output\n\n1) Currently extra properties on an error will be ignored, if thrown.\n   This information will from now on be visible.\n2) In case someone threw a non error object it would have resulted in\n   `[object Object]`. Instead, the full object will now be visible.\n3) Some cases were not detected properly as error before and \"Thrown: \"\n   was visible before. That is now fixed.\n\nPR-URL: https://github.com/nodejs/node/pull/22436\nRefs: https://github.com/nodejs/node/issues/20253\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "ccb303e03795cee25527edb867f7903477ed5de6",
    "files": [
        {
            "sha": "ad1a4bab913fa9aea3493b8ccca07c405b7d7d1e",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 41,
            "deletions": 20,
            "changes": 61,
            "blob_url": "https://github.com/nodejs/node/blob/ccb303e03795cee25527edb867f7903477ed5de6/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/ccb303e03795cee25527edb867f7903477ed5de6/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=ccb303e03795cee25527edb867f7903477ed5de6",
            "patch": "@@ -410,29 +410,50 @@ function REPLServer(prompt,\n \n   self._domain.on('error', function debugDomainError(e) {\n     debug('domain error');\n-    const top = replMap.get(self);\n-    const pstrace = Error.prepareStackTrace;\n-    Error.prepareStackTrace = prepareStackTrace(pstrace);\n-    if (typeof e === 'object')\n+    let errStack = '';\n+\n+    if (typeof e === 'object' && e !== null) {\n+      const pstrace = Error.prepareStackTrace;\n+      Error.prepareStackTrace = prepareStackTrace(pstrace);\n       internalUtil.decorateErrorStack(e);\n-    Error.prepareStackTrace = pstrace;\n-    const isError = internalUtil.isError(e);\n-    if (!self.underscoreErrAssigned)\n-      self.lastError = e;\n-    if (e instanceof SyntaxError && e.stack) {\n-      // remove repl:line-number and stack trace\n-      e.stack = e.stack\n-        .replace(/^repl:\\d+\\r?\\n/, '')\n-        .replace(/^\\s+at\\s.*\\n?/gm, '');\n-    } else if (isError && self.replMode === exports.REPL_MODE_STRICT) {\n-      e.stack = e.stack.replace(/(\\s+at\\s+repl:)(\\d+)/,\n-                                (_, pre, line) => pre + (line - 1));\n+      Error.prepareStackTrace = pstrace;\n+\n+      if (e.domainThrown) {\n+        delete e.domain;\n+        delete e.domainThrown;\n+      }\n+\n+      if (internalUtil.isError(e)) {\n+        if (e.stack) {\n+          if (e.name === 'SyntaxError') {\n+            // Remove stack trace.\n+            e.stack = e.stack\n+              .replace(/^repl:\\d+\\r?\\n/, '')\n+              .replace(/^\\s+at\\s.*\\n?/gm, '');\n+          } else if (self.replMode === exports.REPL_MODE_STRICT) {\n+            e.stack = e.stack.replace(/(\\s+at\\s+repl:)(\\d+)/,\n+                                      (_, pre, line) => pre + (line - 1));\n+          }\n+        }\n+        errStack = util.inspect(e);\n+\n+        // Remove one line error braces to keep the old style in place.\n+        if (errStack[errStack.length - 1] === ']') {\n+          errStack = errStack.slice(1, -1);\n+        }\n+      }\n     }\n-    if (isError && e.stack) {\n-      top.outputStream.write(`${e.stack}\\n`);\n-    } else {\n-      top.outputStream.write(`Thrown: ${String(e)}\\n`);\n+\n+    if (errStack === '') {\n+      errStack = `Thrown: ${util.inspect(e)}`;\n     }\n+\n+    if (!self.underscoreErrAssigned) {\n+      self.lastError = e;\n+    }\n+\n+    const top = replMap.get(self);\n+    top.outputStream.write(`${errStack}\\n`);\n     top.clearBufferedCommand();\n     top.lines.level = [];\n     top.displayPrompt();"
        },
        {
            "sha": "9194c4a449007fbee276dee376083ee4f9596a7f",
            "filename": "test/parallel/test-repl-top-level-await.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "raw_url": "https://github.com/nodejs/node/raw/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-top-level-await.js?ref=ccb303e03795cee25527edb867f7903477ed5de6",
            "patch": "@@ -159,7 +159,7 @@ async function ctrlCTest() {\n     { ctrl: true, name: 'c' }\n   ]), [\n     'await timeout(100000)\\r',\n-    'Thrown: Error [ERR_SCRIPT_EXECUTION_INTERRUPTED]: ' +\n+    'Error [ERR_SCRIPT_EXECUTION_INTERRUPTED]: ' +\n       'Script execution was interrupted by `SIGINT`',\n     PROMPT\n   ]);"
        },
        {
            "sha": "dea2ed43704dfd28036c7090129f1c1dbaf286b5",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=ccb303e03795cee25527edb867f7903477ed5de6",
            "patch": "@@ -177,8 +177,12 @@ function testError() {\n       '[Error: foo]',\n \n       // The sync error, with individual property echoes\n-      /Error: ENOENT: no such file or directory, scandir '.*nonexistent.*'/,\n+      /^{ Error: ENOENT: no such file or directory, scandir '.*nonexistent.*'/,\n       /Object\\.readdirSync/,\n+      /^  errno: -(2|4058),$/,\n+      \"  syscall: 'scandir',\",\n+      \"  code: 'ENOENT',\",\n+      \"  path: '/nonexistent?' }\",\n       \"'ENOENT'\",\n       \"'scandir'\",\n "
        },
        {
            "sha": "49e718da0f0683bca363ffe16f848ea8300fa804",
            "filename": "test/parallel/test-repl.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl.js",
            "raw_url": "https://github.com/nodejs/node/raw/ccb303e03795cee25527edb867f7903477ed5de6/test%2Fparallel%2Ftest-repl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl.js?ref=ccb303e03795cee25527edb867f7903477ed5de6",
            "patch": "@@ -132,7 +132,11 @@ const errorTests = [\n   // Uncaught error throws and prints out\n   {\n     send: 'throw new Error(\\'test error\\');',\n-    expect: /^Error: test error/\n+    expect: 'Error: test error'\n+  },\n+  {\n+    send: \"throw { foo: 'bar' };\",\n+    expect: \"Thrown: { foo: 'bar' }\"\n   },\n   // Common syntax error is treated as multiline command\n   {\n@@ -526,7 +530,7 @@ const errorTests = [\n   {\n     send: 'require(\"internal/repl\")',\n     expect: [\n-      /^Error: Cannot find module 'internal\\/repl'/,\n+      /^{ Error: Cannot find module 'internal\\/repl'/,\n       /^    at .*/,\n       /^    at .*/,\n       /^    at .*/,"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 53,
        "deletions": 24
    }
}