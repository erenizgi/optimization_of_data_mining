{
    "author": "joyeecheung",
    "message": "src: remove code cache integrity check\n\nIn preparation of sharing code cache among different threads -\nwe simply rely on v8 to reject invalid cache, since there isn't\nany serious consequence when the cache is invalid anyway.\n\nPR-URL: https://github.com/nodejs/node/pull/24950\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "ceb66352236240498a9263500c7bde74e58c71fa",
    "files": [
        {
            "sha": "4fffa8e0c29557106ec59cbe11cb02a9590c69a9",
            "filename": "src/node_code_cache_stub.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_code_cache_stub.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_code_cache_stub.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_code_cache_stub.cc?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -11,9 +11,5 @@ namespace native_module {\n // into native_module_loader.code_cache_.\n void NativeModuleLoader::LoadCodeCache() {}\n \n-// The generated source code would instert <std::string, std::string> pairs\n-// into native_module_loader.code_cache_hash_.\n-void NativeModuleLoader::LoadCodeCacheHash() {}\n-\n }  // namespace native_module\n }  // namespace node"
        },
        {
            "sha": "98cc128b735cca42a2a61d1ab4a8a51d201cb9d5",
            "filename": "src/node_native_module.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_native_module.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_native_module.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.cc?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -105,9 +105,7 @@ Local<String> NativeModuleLoader::GetSource(Isolate* isolate,\n \n NativeModuleLoader::NativeModuleLoader() : config_(GetConfig()) {\n   LoadJavaScriptSource();\n-  LoadJavaScriptHash();\n   LoadCodeCache();\n-  LoadCodeCacheHash();\n }\n \n void NativeModuleLoader::CompileCodeCache(\n@@ -168,29 +166,6 @@ MaybeLocal<Value> NativeModuleLoader::CompileAsModule(\n       env->context(), id, &parameters, result, env);\n }\n \n-// Currently V8 only checks that the length of the source code is the\n-// same as the code used to generate the hash, so we add an additional\n-// check here:\n-// 1. During compile time, when generating node_javascript.cc and\n-//    node_code_cache.cc, we compute and include the hash of the\n-//    JavaScript source in both.\n-// 2. At runtime, we check that the hash of the code being compiled\n-//   and the hash of the code used to generate the cache\n-//   (without the parameters) is the same.\n-// This is based on the assumptions:\n-// 1. `code_cache_hash` must be in sync with `code_cache`\n-//     (both defined in node_code_cache.cc)\n-// 2. `source_hash` must be in sync with `source`\n-//     (both defined in node_javascript.cc)\n-// 3. If `source_hash` is in sync with `code_cache_hash`,\n-//    then the source code used to generate `code_cache`\n-//    should be in sync with the source code in `source`\n-// The only variable left, then, are the parameters passed to the\n-// CompileFunctionInContext. If the parameters used generate the cache\n-// is different from the one used to compile modules at run time, then\n-// there could be false postivies, but that should be rare and should fail\n-// early in the bootstrap process so it should be easy to detect and fix.\n-\n // Returns nullptr if there is no code cache corresponding to the id\n ScriptCompiler::CachedData* NativeModuleLoader::GetCachedData(\n     const char* id) const {\n@@ -204,22 +179,6 @@ ScriptCompiler::CachedData* NativeModuleLoader::GetCachedData(\n   const uint8_t* code_cache_value = it->second.one_bytes_data();\n   size_t code_cache_length = it->second.length();\n \n-  const auto it2 = code_cache_hash_.find(id);\n-  CHECK_NE(it2, code_cache_hash_.end());\n-  const std::string& code_cache_hash_value = it2->second;\n-\n-  const auto it3 = source_hash_.find(id);\n-  CHECK_NE(it3, source_hash_.end());\n-  const std::string& source_hash_value = it3->second;\n-\n-  // It may fail when any of the inputs of the `node_js2c` target in\n-  // node.gyp is modified but the tools/generate_code_cache.js\n-  // is not re run.\n-  // FIXME(joyeecheung): Figure out how to resolve the dependency issue.\n-  // When the code cache was introduced we were at a point where refactoring\n-  // node.gyp may not be worth the effort.\n-  CHECK_EQ(code_cache_hash_value, source_hash_value);\n-\n   return new ScriptCompiler::CachedData(code_cache_value, code_cache_length);\n }\n "
        },
        {
            "sha": "54c5f388f7480f2f9459c512cf6027b4f7a9fdcb",
            "filename": "src/node_native_module.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_native_module.h",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/src%2Fnode_native_module.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.h?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -75,14 +75,12 @@ class NativeModuleLoader {\n \n   // Generated by tools/js2c.py as node_javascript.cc\n   void LoadJavaScriptSource();  // Loads data into source_\n-  void LoadJavaScriptHash();    // Loads data into source_hash_\n   UnionBytes GetConfig();       // Return data for config.gypi\n \n   // Generated by tools/generate_code_cache.js as node_code_cache.cc when\n   // the build is configured with --code-cache-path=.... They are noops\n   // in node_code_cache_stub.cc\n   void LoadCodeCache();      // Loads data into code_cache_\n-  void LoadCodeCacheHash();  // Loads data into code_cache_hash_\n \n   v8::ScriptCompiler::CachedData* GetCachedData(const char* id) const;\n \n@@ -105,9 +103,6 @@ class NativeModuleLoader {\n   NativeModuleRecordMap source_;\n   NativeModuleRecordMap code_cache_;\n   UnionBytes config_;\n-\n-  NativeModuleHashMap source_hash_;\n-  NativeModuleHashMap code_cache_hash_;\n };\n \n }  // namespace native_module"
        },
        {
            "sha": "78a2b1c9a639a064736b20f797aa7abfcae5b35c",
            "filename": "test/code-cache/test-code-cache-generator.js",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/test%2Fcode-cache%2Ftest-code-cache-generator.js",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/test%2Fcode-cache%2Ftest-code-cache-generator.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache-generator.js?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -31,7 +31,6 @@ if (child.status !== 0) {\n \n // Verifies that:\n // - node::LoadCodeCache()\n-// - node::LoadCodeCacheHash()\n // are defined in the generated code.\n // See src/node_native_module.h for explanations.\n \n@@ -41,18 +40,13 @@ const rl = readline.createInterface({\n });\n \n let hasCacheDef = false;\n-let hasHashDef = false;\n \n rl.on('line', common.mustCallAtLeast((line) => {\n   if (line.includes('LoadCodeCache(')) {\n     hasCacheDef = true;\n   }\n-  if (line.includes('LoadCodeCacheHash(')) {\n-    hasHashDef = true;\n-  }\n }, 2));\n \n rl.on('close', common.mustCall(() => {\n   assert.ok(hasCacheDef);\n-  assert.ok(hasHashDef);\n }));"
        },
        {
            "sha": "3e21743f2c71b63b77706a87ed839499d80ec517",
            "filename": "tools/generate_code_cache.js",
            "status": "modified",
            "additions": 3,
            "deletions": 24,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/tools%2Fgenerate_code_cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/tools%2Fgenerate_code_cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fgenerate_code_cache.js?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -8,7 +8,6 @@\n // of `configure`.\n \n const {\n-  getSource,\n   getCodeCache,\n   cachableBuiltins\n } = require('internal/bootstrap/cache');\n@@ -19,13 +18,6 @@ const {\n   }\n } = require('util');\n \n-function hash(str) {\n-  if (process.versions.openssl) {\n-    return require('crypto').createHash('sha256').update(str).digest('hex');\n-  }\n-  return '';\n-}\n-\n const fs = require('fs');\n \n const resultPath = process.argv[2];\n@@ -65,26 +57,18 @@ function getInitalizer(key, cache) {\n   const defName = `${key.replace(/\\//g, '_').replace(/-/g, '_')}_raw`;\n   const definition = `static const uint8_t ${defName}[] = {\\n` +\n                      `${cache.join(',')}\\n};`;\n-  const source = getSource(key);\n-  const sourceHash = hash(source);\n   const initializer =\n     'code_cache_.emplace(\\n' +\n     `  \"${key}\",\\n` +\n     `  UnionBytes(${defName}, arraysize(${defName}))\\n` +\n     ');';\n-  const hashIntializer =\n-    'code_cache_hash_.emplace(\\n' +\n-    `  \"${key}\",\\n` +\n-    `  \"${sourceHash}\"\\n` +\n-    ');';\n   return {\n-    definition, initializer, hashIntializer, sourceHash\n+    definition, initializer\n   };\n }\n \n const cacheDefinitions = [];\n const cacheInitializers = [];\n-const cacheHashInitializers = [];\n let totalCacheSize = 0;\n \n function lexical(a, b) {\n@@ -107,13 +91,12 @@ for (const key of cachableBuiltins.sort(lexical)) {\n   const size = cachedData.byteLength;\n   totalCacheSize += size;\n   const {\n-    definition, initializer, hashIntializer, sourceHash\n+    definition, initializer,\n   } = getInitalizer(key, cachedData);\n   cacheDefinitions.push(definition);\n   cacheInitializers.push(initializer);\n-  cacheHashInitializers.push(hashIntializer);\n   console.log(`Generated cache for '${key}', size = ${formatSize(size)}` +\n-              `, hash = ${sourceHash}, total = ${formatSize(totalCacheSize)}`);\n+              `, total = ${formatSize(totalCacheSize)}`);\n }\n \n const result = `#include \"node_native_module.h\"\n@@ -131,10 +114,6 @@ void NativeModuleLoader::LoadCodeCache() {\n   ${cacheInitializers.join('\\n  ')}\n }\n \n-void NativeModuleLoader::LoadCodeCacheHash() {\n-  ${cacheHashInitializers.join('\\n  ')}\n-}\n-\n }  // namespace native_module\n }  // namespace node\n `;"
        },
        {
            "sha": "46cf918ba977f61bd2382d836debea6f972bf744",
            "filename": "tools/js2c.py",
            "status": "modified",
            "additions": 1,
            "deletions": 20,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/ceb66352236240498a9263500c7bde74e58c71fa/tools%2Fjs2c.py",
            "raw_url": "https://github.com/nodejs/node/raw/ceb66352236240498a9263500c7bde74e58c71fa/tools%2Fjs2c.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fjs2c.py?ref=ceb66352236240498a9263500c7bde74e58c71fa",
            "patch": "@@ -189,10 +189,6 @@ def ReadMacros(lines):\n   {initializers}\n }}\n \n-void NativeModuleLoader::LoadJavaScriptHash() {{\n-  {hash_initializers}\n-}}\n-\n UnionBytes NativeModuleLoader::GetConfig() {{\n   return UnionBytes(config_raw, arraysize(config_raw));  // config.gypi\n }}\n@@ -218,13 +214,6 @@ def ReadMacros(lines):\n );\n \"\"\"\n \n-HASH_INITIALIZER = \"\"\"\\\n-source_hash_.emplace(\n-    \"{module}\",\n-    \"{hash_value}\"\n-);\n-\"\"\"\n-\n DEPRECATED_DEPS = \"\"\"\\\n 'use strict';\n process.emitWarning(\n@@ -251,8 +240,6 @@ def JS2C(source, target):\n   # Build source code lines\n   definitions = []\n   initializers = []\n-  hash_initializers = []\n-  config_initializers = []\n \n   def GetDefinition(var, source):\n     # Treat non-ASCII as UTF-8 and convert it to UTF-16.\n@@ -267,15 +254,11 @@ def GetDefinition(var, source):\n \n   def AddModule(module, source):\n     var = '%s_raw' % (module.replace('-', '_').replace('/', '_'))\n-    source_hash = hashlib.sha256(source).hexdigest()\n     definition = GetDefinition(var, source)\n     initializer = INITIALIZER.format(module=module,\n                                      var=var)\n-    hash_initializer = HASH_INITIALIZER.format(module=module,\n-                                               hash_value=source_hash)\n     definitions.append(definition)\n     initializers.append(initializer)\n-    hash_initializers.append(hash_initializer)\n \n   for name in modules:\n     lines = ReadFile(str(name))\n@@ -320,9 +303,7 @@ def AddModule(module, source):\n   output = open(str(target[0]), \"w\")\n   output.write(\n     TEMPLATE.format(definitions=''.join(definitions),\n-                    initializers=''.join(initializers),\n-                    hash_initializers=''.join(hash_initializers),\n-                    config_initializers=''.join(config_initializers)))\n+                    initializers=''.join(initializers)))\n   output.close()\n \n def main():"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 4,
        "deletions": 100
    }
}