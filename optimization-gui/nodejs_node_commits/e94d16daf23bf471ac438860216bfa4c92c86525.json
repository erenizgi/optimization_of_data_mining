{
    "author": "jasnell",
    "message": "http2: throw from mapToHeaders\n\nPR-URL: https://github.com/nodejs/node/pull/24063\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nNote: Landed with one collaborator approval after PR\n      was open for 18 days",
    "sha": "e94d16daf23bf471ac438860216bfa4c92c86525",
    "files": [
        {
            "sha": "53a141a9632723e35cc3f1efaa030b489b3a6292",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/e94d16daf23bf471ac438860216bfa4c92c86525/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/e94d16daf23bf471ac438860216bfa4c92c86525/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=e94d16daf23bf471ac438860216bfa4c92c86525",
            "patch": "@@ -1484,8 +1484,6 @@ class ClientHttp2Session extends Http2Session {\n     }\n \n     const headersList = mapToHeaders(headers);\n-    if (!Array.isArray(headersList))\n-      throw headersList;\n \n     const stream = new ClientHttp2Stream(this, undefined, undefined, {});\n     stream[kSentHeaders] = headers;\n@@ -1890,8 +1888,6 @@ class Http2Stream extends Duplex {\n     this[kUpdateTimer]();\n \n     const headersList = mapToHeaders(headers, assertValidPseudoHeaderTrailer);\n-    if (!Array.isArray(headersList))\n-      throw headersList;\n     this[kSentTrailers] = headers;\n \n     // Send the trailers in setImmediate so we don't do it on nghttp2 stack.\n@@ -2058,12 +2054,14 @@ function processRespondWithFD(self, fd, headers, offset = 0, length = -1,\n   const state = self[kState];\n   state.flags |= STREAM_FLAGS_HEADERS_SENT;\n \n-  const headersList = mapToHeaders(headers, assertValidPseudoHeaderResponse);\n-  self[kSentHeaders] = headers;\n-  if (!Array.isArray(headersList)) {\n-    self.destroy(headersList);\n+  let headersList;\n+  try {\n+    headersList = mapToHeaders(headers, assertValidPseudoHeaderResponse);\n+  } catch (err) {\n+    self.destroy(err);\n     return;\n   }\n+  self[kSentHeaders] = headers;\n \n   // Close the writable side of the stream, but only as far as the writable\n   // stream implementation is concerned.\n@@ -2287,8 +2285,6 @@ class ServerHttp2Stream extends Http2Stream {\n     options.readable = false;\n \n     const headersList = mapToHeaders(headers);\n-    if (!Array.isArray(headersList))\n-      throw headersList;\n \n     const streamOptions = options.endStream ? STREAM_OPTION_EMPTY_PAYLOAD : 0;\n \n@@ -2365,8 +2361,6 @@ class ServerHttp2Stream extends Http2Stream {\n     }\n \n     const headersList = mapToHeaders(headers, assertValidPseudoHeaderResponse);\n-    if (!Array.isArray(headersList))\n-      throw headersList;\n     this[kSentHeaders] = headers;\n \n     state.flags |= STREAM_FLAGS_HEADERS_SENT;\n@@ -2527,8 +2521,6 @@ class ServerHttp2Stream extends Http2Stream {\n     this[kUpdateTimer]();\n \n     const headersList = mapToHeaders(headers, assertValidPseudoHeaderResponse);\n-    if (!Array.isArray(headersList))\n-      throw headersList;\n     if (!this[kInfoHeaders])\n       this[kInfoHeaders] = [headers];\n     else"
        },
        {
            "sha": "9dc8be6e83ddeb952f2f0c723c2881baca87b184",
            "filename": "lib/internal/http2/util.js",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/e94d16daf23bf471ac438860216bfa4c92c86525/lib%2Finternal%2Fhttp2%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/e94d16daf23bf471ac438860216bfa4c92c86525/lib%2Finternal%2Fhttp2%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Futil.js?ref=e94d16daf23bf471ac438860216bfa4c92c86525",
            "patch": "@@ -406,22 +406,22 @@ function assertValidPseudoHeader(key) {\n   if (!kValidPseudoHeaders.has(key)) {\n     const err = new ERR_HTTP2_INVALID_PSEUDOHEADER(key);\n     Error.captureStackTrace(err, assertValidPseudoHeader);\n-    return err;\n+    throw err;\n   }\n }\n \n function assertValidPseudoHeaderResponse(key) {\n   if (key !== ':status') {\n     const err = new ERR_HTTP2_INVALID_PSEUDOHEADER(key);\n     Error.captureStackTrace(err, assertValidPseudoHeaderResponse);\n-    return err;\n+    throw err;\n   }\n }\n \n function assertValidPseudoHeaderTrailer(key) {\n   const err = new ERR_HTTP2_INVALID_PSEUDOHEADER(key);\n   Error.captureStackTrace(err, assertValidPseudoHeaderTrailer);\n-  return err;\n+  throw err;\n }\n \n function mapToHeaders(map,\n@@ -454,26 +454,26 @@ function mapToHeaders(map,\n           break;\n         default:\n           if (isSingleValueHeader)\n-            return new ERR_HTTP2_HEADER_SINGLE_VALUE(key);\n+            throw new ERR_HTTP2_HEADER_SINGLE_VALUE(key);\n       }\n     } else {\n       value = String(value);\n     }\n     if (isSingleValueHeader) {\n       if (singles.has(key))\n-        return new ERR_HTTP2_HEADER_SINGLE_VALUE(key);\n+        throw new ERR_HTTP2_HEADER_SINGLE_VALUE(key);\n       singles.add(key);\n     }\n     if (key[0] === ':') {\n       err = assertValuePseudoHeader(key);\n       if (err !== undefined)\n-        return err;\n+        throw err;\n       ret = `${key}\\0${value}\\0${ret}`;\n       count++;\n       continue;\n     }\n     if (isIllegalConnectionSpecificHeader(key, value)) {\n-      return new ERR_HTTP2_INVALID_CONNECTION_HEADERS(key);\n+      throw new ERR_HTTP2_INVALID_CONNECTION_HEADERS(key);\n     }\n     if (isArray) {\n       for (var k = 0; k < value.length; k++) {"
        },
        {
            "sha": "b0d7ac0e58f1d5a1f9b1ac8309f4f1864eaa7aed",
            "filename": "test/parallel/test-http2-util-assert-valid-pseudoheader.js",
            "status": "modified",
            "additions": 11,
            "deletions": 19,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/e94d16daf23bf471ac438860216bfa4c92c86525/test%2Fparallel%2Ftest-http2-util-assert-valid-pseudoheader.js",
            "raw_url": "https://github.com/nodejs/node/raw/e94d16daf23bf471ac438860216bfa4c92c86525/test%2Fparallel%2Ftest-http2-util-assert-valid-pseudoheader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-util-assert-valid-pseudoheader.js?ref=e94d16daf23bf471ac438860216bfa4c92c86525",
            "patch": "@@ -8,24 +8,16 @@ const common = require('../common');\n // have to test it through mapToHeaders\n \n const { mapToHeaders } = require('internal/http2/util');\n-const assert = require('assert');\n \n-function isNotError(val) {\n-  assert(!(val instanceof Error));\n-}\n+// These should not throw\n+mapToHeaders({ ':status': 'a' });\n+mapToHeaders({ ':path': 'a' });\n+mapToHeaders({ ':authority': 'a' });\n+mapToHeaders({ ':scheme': 'a' });\n+mapToHeaders({ ':method': 'a' });\n \n-function isError(val) {\n-  common.expectsError({\n-    code: 'ERR_HTTP2_INVALID_PSEUDOHEADER',\n-    type: TypeError,\n-    message: '\":foo\" is an invalid pseudoheader or is used incorrectly'\n-  })(val);\n-}\n-\n-isNotError(mapToHeaders({ ':status': 'a' }));\n-isNotError(mapToHeaders({ ':path': 'a' }));\n-isNotError(mapToHeaders({ ':authority': 'a' }));\n-isNotError(mapToHeaders({ ':scheme': 'a' }));\n-isNotError(mapToHeaders({ ':method': 'a' }));\n-\n-isError(mapToHeaders({ ':foo': 'a' }));\n+common.expectsError(() => mapToHeaders({ ':foo': 'a' }), {\n+  code: 'ERR_HTTP2_INVALID_PSEUDOHEADER',\n+  type: TypeError,\n+  message: '\":foo\" is an invalid pseudoheader or is used incorrectly'\n+});"
        },
        {
            "sha": "2814613df2c770655d30064ab6dcc25d549bd762",
            "filename": "test/parallel/test-http2-util-headers-list.js",
            "status": "modified",
            "additions": 18,
            "deletions": 16,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/e94d16daf23bf471ac438860216bfa4c92c86525/test%2Fparallel%2Ftest-http2-util-headers-list.js",
            "raw_url": "https://github.com/nodejs/node/raw/e94d16daf23bf471ac438860216bfa4c92c86525/test%2Fparallel%2Ftest-http2-util-headers-list.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-util-headers-list.js?ref=e94d16daf23bf471ac438860216bfa4c92c86525",
            "patch": "@@ -175,11 +175,11 @@ const {\n     ':statuS': 204,\n   };\n \n-  common.expectsError({\n+  common.expectsError(() => mapToHeaders(headers), {\n     code: 'ERR_HTTP2_HEADER_SINGLE_VALUE',\n     type: TypeError,\n     message: 'Header field \":status\" must only have a single value'\n-  })(mapToHeaders(headers));\n+  });\n }\n \n // The following are not allowed to have multiple values\n@@ -224,10 +224,10 @@ const {\n   HTTP2_HEADER_X_CONTENT_TYPE_OPTIONS\n ].forEach((name) => {\n   const msg = `Header field \"${name}\" must only have a single value`;\n-  common.expectsError({\n+  common.expectsError(() => mapToHeaders({ [name]: [1, 2, 3] }), {\n     code: 'ERR_HTTP2_HEADER_SINGLE_VALUE',\n     message: msg\n-  })(mapToHeaders({ [name]: [1, 2, 3] }));\n+  });\n });\n \n [\n@@ -281,30 +281,32 @@ const {\n   'Proxy-Connection',\n   'Keep-Alive'\n ].forEach((name) => {\n-  common.expectsError({\n+  common.expectsError(() => mapToHeaders({ [name]: 'abc' }), {\n     code: 'ERR_HTTP2_INVALID_CONNECTION_HEADERS',\n     name: 'TypeError [ERR_HTTP2_INVALID_CONNECTION_HEADERS]',\n     message: 'HTTP/1 Connection specific headers are forbidden: ' +\n              `\"${name.toLowerCase()}\"`\n-  })(mapToHeaders({ [name]: 'abc' }));\n+  });\n });\n \n-common.expectsError({\n+common.expectsError(() => mapToHeaders({ [HTTP2_HEADER_TE]: ['abc'] }), {\n   code: 'ERR_HTTP2_INVALID_CONNECTION_HEADERS',\n   name: 'TypeError [ERR_HTTP2_INVALID_CONNECTION_HEADERS]',\n   message: 'HTTP/1 Connection specific headers are forbidden: ' +\n            `\"${HTTP2_HEADER_TE}\"`\n-})(mapToHeaders({ [HTTP2_HEADER_TE]: ['abc'] }));\n+});\n \n-common.expectsError({\n-  code: 'ERR_HTTP2_INVALID_CONNECTION_HEADERS',\n-  name: 'TypeError [ERR_HTTP2_INVALID_CONNECTION_HEADERS]',\n-  message: 'HTTP/1 Connection specific headers are forbidden: ' +\n-           `\"${HTTP2_HEADER_TE}\"`\n-})(mapToHeaders({ [HTTP2_HEADER_TE]: ['abc', 'trailers'] }));\n+common.expectsError(\n+  () => mapToHeaders({ [HTTP2_HEADER_TE]: ['abc', 'trailers'] }), {\n+    code: 'ERR_HTTP2_INVALID_CONNECTION_HEADERS',\n+    name: 'TypeError [ERR_HTTP2_INVALID_CONNECTION_HEADERS]',\n+    message: 'HTTP/1 Connection specific headers are forbidden: ' +\n+             `\"${HTTP2_HEADER_TE}\"`\n+  });\n \n-assert(!(mapToHeaders({ te: 'trailers' }) instanceof Error));\n-assert(!(mapToHeaders({ te: ['trailers'] }) instanceof Error));\n+// These should not throw\n+mapToHeaders({ te: 'trailers' });\n+mapToHeaders({ te: ['trailers'] });\n \n \n {"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 42,
        "deletions": 56
    }
}