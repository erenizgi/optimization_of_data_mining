{
    "author": "addaleax",
    "message": "report: refactor JSON writer\n\n- Support non-string entry types\n- Prefer single-character writes over string writes\n- Rename the state constants and adjust style to match more\n  common Node.js style\n\nPR-URL: https://github.com/nodejs/node/pull/25651\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Beth Griggs <Bethany.Griggs@uk.ibm.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "08e9111696577c59b50cd8c9b4c3e2acf9710030",
    "files": [
        {
            "sha": "ac4b304b77d4884c82f60ce0d69a1660945d8774",
            "filename": "src/node_report.h",
            "status": "modified",
            "additions": 59,
            "deletions": 42,
            "changes": 101,
            "blob_url": "https://github.com/nodejs/node/blob/08e9111696577c59b50cd8c9b4c3e2acf9710030/src%2Fnode_report.h",
            "raw_url": "https://github.com/nodejs/node/raw/08e9111696577c59b50cd8c9b4c3e2acf9710030/src%2Fnode_report.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_report.h?ref=08e9111696577c59b50cd8c9b4c3e2acf9710030",
            "patch": "@@ -19,6 +19,7 @@\n #include <iomanip>\n #include <iostream>\n #include <sstream>\n+#include <limits>\n \n #ifdef _WIN32\n #include <time.h>\n@@ -67,93 +68,109 @@ extern double prog_start_time;\n // JSON compiler definitions.\n class JSONWriter {\n  public:\n-  explicit JSONWriter(std::ostream& out)\n-      : out_(out), indent_(0), state_(JSONOBJECT) {}\n+  explicit JSONWriter(std::ostream& out) : out_(out) {}\n \n   inline void indent() { indent_ += 2; }\n   inline void deindent() { indent_ -= 2; }\n   inline void advance() {\n-    for (int i = 0; i < indent_; i++) out_ << \" \";\n+    for (int i = 0; i < indent_; i++) out_ << ' ';\n   }\n \n   inline void json_start() {\n-    if (state_ == JSONVALUE) out_ << \",\";\n-    out_ << \"\\n\";\n+    if (state_ == kAfterValue) out_ << ',';\n+    out_ << '\\n';\n     advance();\n-    out_ << \"{\";\n+    out_ << '{';\n     indent();\n-    state_ = JSONOBJECT;\n+    state_ = kObjectStart;\n   }\n \n   inline void json_end() {\n-    out_ << \"\\n\";\n+    out_ << '\\n';\n     deindent();\n     advance();\n-    out_ << \"}\";\n-    state_ = JSONVALUE;\n+    out_ << '}';\n+    state_ = kAfterValue;\n   }\n   template <typename T>\n   inline void json_objectstart(T key) {\n-    if (state_ == JSONVALUE) out_ << \",\";\n-    out_ << \"\\n\";\n+    if (state_ == kAfterValue) out_ << ',';\n+    out_ << '\\n';\n     advance();\n-    out_ << \"\\\"\" << key << \"\\\"\"\n-         << \": {\";\n+    write_string(key);\n+    out_ << \": {\";\n     indent();\n-    state_ = JSONOBJECT;\n+    state_ = kObjectStart;\n   }\n \n   template <typename T>\n   inline void json_arraystart(T key) {\n-    if (state_ == JSONVALUE) out_ << \",\";\n-    out_ << \"\\n\";\n+    if (state_ == kAfterValue) out_ << ',';\n+    out_ << '\\n';\n     advance();\n-    out_ << \"\\\"\" << key << \"\\\"\"\n-         << \": [\";\n+    write_string(key);\n+    out_ << \": [\";\n     indent();\n-    state_ = JSONOBJECT;\n+    state_ = kObjectStart;\n   }\n   inline void json_objectend() {\n-    out_ << \"\\n\";\n+    out_ << '\\n';\n     deindent();\n     advance();\n-    out_ << \"}\";\n-    state_ = JSONVALUE;\n+    out_ << '}';\n+    state_ = kAfterValue;\n   }\n \n   inline void json_arrayend() {\n-    out_ << \"\\n\";\n+    out_ << '\\n';\n     deindent();\n     advance();\n-    out_ << \"]\";\n-    state_ = JSONVALUE;\n+    out_ << ']';\n+    state_ = kAfterValue;\n   }\n   template <typename T, typename U>\n-  inline void json_keyvalue(T key, U value) {\n-    if (state_ == JSONVALUE) out_ << \",\";\n-    out_ << \"\\n\";\n+  inline void json_keyvalue(const T& key, const U& value) {\n+    if (state_ == kAfterValue) out_ << ',';\n+    out_ << '\\n';\n     advance();\n-    out_ << \"\\\"\" << key << \"\\\"\"\n-         << \": \"\n-         << \"\\\"\";\n-    out_ << EscapeJsonChars(value) << \"\\\"\";\n-    state_ = JSONVALUE;\n+    write_string(key);\n+    out_ << \": \";\n+    write_value(value);\n+    state_ = kAfterValue;\n   }\n \n   template <typename U>\n-  inline void json_element(U value) {\n-    if (state_ == JSONVALUE) out_ << \",\";\n-    out_ << \"\\n\";\n+  inline void json_element(const U& value) {\n+    if (state_ == kAfterValue) out_ << ',';\n+    out_ << '\\n';\n     advance();\n-    out_ << \"\\\"\" << EscapeJsonChars(value) << \"\\\"\";\n-    state_ = JSONVALUE;\n+    write_value(value);\n+    state_ = kAfterValue;\n   }\n \n  private:\n-  enum JSONState { JSONOBJECT, JSONVALUE };\n+  template <typename T,\n+            typename test_for_number = typename std::\n+                enable_if<std::numeric_limits<T>::is_specialized, bool>::type>\n+  inline void write_value(T number) {\n+    if (std::is_same<T, bool>::value)\n+      out_ << (number ? \"true\" : \"false\");\n+    else\n+      out_ << number;\n+  }\n+\n+  inline void write_value(const char* str) { write_string(str); }\n+  inline void write_value(const std::string& str) { write_string(str); }\n+\n+  inline void write_string(const std::string& str) {\n+    out_ << '\"' << EscapeJsonChars(str) << '\"';\n+  }\n+  inline void write_string(const char* str) { write_string(std::string(str)); }\n+\n+  enum JSONState { kObjectStart, kAfterValue };\n   std::ostream& out_;\n-  int indent_;\n-  int state_;\n+  int indent_ = 0;\n+  int state_ = kObjectStart;\n };\n \n }  // namespace report"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 59,
        "deletions": 42
    }
}