{
    "author": "addaleax",
    "message": "test: verify `performance.timerify()` works w/ non-Node Contexts\n\nPR-URL: https://github.com/nodejs/node/pull/23784\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a3cad3e2ff95eb7474b4baefafc969211657a896",
    "files": [
        {
            "sha": "d3ee881f59d25729b5e3b4a79d0f1473aecc93a9",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/a3cad3e2ff95eb7474b4baefafc969211657a896/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a3cad3e2ff95eb7474b4baefafc969211657a896/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=a3cad3e2ff95eb7474b4baefafc969211657a896",
            "patch": "@@ -310,7 +310,7 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n   HandleScope scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  CHECK_NOT_NULL(env);  // TODO(addaleax): Verify that this is correct.\n+  CHECK_NOT_NULL(env);\n   Local<Context> context = env->context();\n   Local<Function> fn = args.Data().As<Function>();\n   size_t count = args.Length();"
        },
        {
            "sha": "324f5c5a1ef16f56159bca6a9258c5fb70c92826",
            "filename": "test/addons/non-node-context/binding.cc",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fnon-node-context%2Fbinding.cc?ref=a3cad3e2ff95eb7474b4baefafc969211657a896",
            "patch": "@@ -0,0 +1,55 @@\n+#include <node.h>\n+#include <assert.h>\n+\n+namespace {\n+\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionTemplate;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::MaybeLocal;\n+using v8::NewStringType;\n+using v8::Object;\n+using v8::Script;\n+using v8::String;\n+using v8::Value;\n+\n+inline void RunInNewContext(\n+    const v8::FunctionCallbackInfo<v8::Value>& args) {\n+  Isolate* isolate = args.GetIsolate();\n+  Local<Context> context = Context::New(isolate);\n+  Context::Scope context_scope(context);\n+\n+  context->Global()->Set(\n+      context,\n+      String::NewFromUtf8(isolate, \"data\", NewStringType::kNormal)\n+          .ToLocalChecked(),\n+      args[1]).FromJust();\n+\n+  assert(args[0]->IsString());  // source code\n+  Local<Script> script;\n+  Local<Value> ret;\n+  if (!Script::Compile(context, args[0].As<String>()).ToLocal(&script) ||\n+      !script->Run(context).ToLocal(&ret)) {\n+    return;\n+  }\n+\n+  args.GetReturnValue().Set(ret);\n+}\n+\n+inline void Initialize(Local<Object> exports,\n+                       Local<Value> module,\n+                       Local<Context> context) {\n+  Isolate* isolate = context->GetIsolate();\n+  Local<String> key = String::NewFromUtf8(\n+      isolate, \"runInNewContext\", NewStringType::kNormal).ToLocalChecked();\n+  Local<Function> value = FunctionTemplate::New(isolate, RunInNewContext)\n+                   ->GetFunction(context)\n+                   .ToLocalChecked();\n+  assert(exports->Set(context, key, value).IsJust());\n+}\n+\n+}  // anonymous namespace\n+\n+NODE_MODULE_CONTEXT_AWARE(NODE_GYP_MODULE_NAME, Initialize)"
        },
        {
            "sha": "b83bae308260f2a9936739b39a03d2679c1fd0ec",
            "filename": "test/addons/non-node-context/binding.gyp",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fnon-node-context%2Fbinding.gyp?ref=a3cad3e2ff95eb7474b4baefafc969211657a896",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  'targets': [\n+    {\n+      'target_name': 'binding',\n+      'sources': ['binding.cc']\n+    },\n+  ]\n+}"
        },
        {
            "sha": "10a9ab8064227eb671701da8902cc75846369304",
            "filename": "test/addons/non-node-context/test-perf-hooks-timerify.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Ftest-perf-hooks-timerify.js",
            "raw_url": "https://github.com/nodejs/node/raw/a3cad3e2ff95eb7474b4baefafc969211657a896/test%2Faddons%2Fnon-node-context%2Ftest-perf-hooks-timerify.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fnon-node-context%2Ftest-perf-hooks-timerify.js?ref=a3cad3e2ff95eb7474b4baefafc969211657a896",
            "patch": "@@ -0,0 +1,17 @@\n+'use strict';\n+\n+const common = require('../../common');\n+const assert = require('assert');\n+const { runInNewContext } = require(`./build/${common.buildType}/binding`);\n+const { performance } = require('perf_hooks');\n+\n+// Check that performance.timerify() works when called from another context,\n+// for a function created in another context.\n+\n+const check = runInNewContext(`\n+const { performance, assert } = data;\n+const timerified = performance.timerify(function() { return []; });\n+assert.strictEqual(timerified().constructor, Array);\n+'success';\n+`, { performance, assert });\n+assert.strictEqual(check, 'success');"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 81,
        "deletions": 1
    }
}