{
    "author": "joyeecheung",
    "message": "fs: remove watcher state errors for fs.watch\n\n- Remove ERR_FS_WATCHER_ALREADY_STARTED and\n  ERR_FS_WATCHER_NOT_STARTED because those two situations should\n  result in noop instead of errors for consistency with the\n  documented behavior of fs.watchFile.\n  This partially reverts https://github.com/nodejs/node/pull/19089\n- Update comments about this behavior.\n\nRefs: https://github.com/nodejs/node/pull/19089\n\nPR-URL: https://github.com/nodejs/node/pull/19345\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "301f6cc553bd73cfa345ae7de6ee81655efc57d0",
    "files": [
        {
            "sha": "5c38dde4130b2b72aef2e08f2c9db510eb0e3ef0",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/301f6cc553bd73cfa345ae7de6ee81655efc57d0/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/301f6cc553bd73cfa345ae7de6ee81655efc57d0/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=301f6cc553bd73cfa345ae7de6ee81655efc57d0",
            "patch": "@@ -783,18 +783,6 @@ falsy value.\n An invalid symlink type was passed to the [`fs.symlink()`][] or\n [`fs.symlinkSync()`][] methods.\n \n-<a id=\"ERR_FS_WATCHER_ALREADY_STARTED\"></a>\n-### ERR_FS_WATCHER_ALREADY_STARTED\n-\n-An attempt was made to start a watcher returned by `fs.watch()` that has\n-already been started.\n-\n-<a id=\"ERR_FS_WATCHER_NOT_STARTED\"></a>\n-### ERR_FS_WATCHER_NOT_STARTED\n-\n-An attempt was made to initiate operations on a watcher returned by\n-`fs.watch()` that has not yet been started.\n-\n <a id=\"ERR_HTTP_HEADERS_SENT\"></a>\n ### ERR_HTTP_HEADERS_SENT\n "
        },
        {
            "sha": "b4c2d5cdbb170037050488c41de8bfa7e912c917",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/301f6cc553bd73cfa345ae7de6ee81655efc57d0/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/301f6cc553bd73cfa345ae7de6ee81655efc57d0/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=301f6cc553bd73cfa345ae7de6ee81655efc57d0",
            "patch": "@@ -36,8 +36,6 @@ const fs = exports;\n const { Buffer } = require('buffer');\n const errors = require('internal/errors');\n const {\n-  ERR_FS_WATCHER_ALREADY_STARTED,\n-  ERR_FS_WATCHER_NOT_STARTED,\n   ERR_INVALID_ARG_TYPE,\n   ERR_INVALID_CALLBACK,\n   ERR_OUT_OF_RANGE\n@@ -1342,25 +1340,26 @@ util.inherits(FSWatcher, EventEmitter);\n \n // FIXME(joyeecheung): this method is not documented.\n // At the moment if filename is undefined, we\n-// 1. Throw an Error from C++ land if it's the first time .start() is called\n-// 2. Return silently from C++ land if .start() has already been called\n+// 1. Throw an Error if it's the first time .start() is called\n+// 2. Return silently if .start() has already been called\n //    on a valid filename and the wrap has been initialized\n+// This method is a noop if the watcher has already been started.\n FSWatcher.prototype.start = function(filename,\n                                      persistent,\n                                      recursive,\n                                      encoding) {\n   lazyAssert()(this._handle instanceof FSEvent, 'handle must be a FSEvent');\n   if (this._handle.initialized) {\n-    throw new ERR_FS_WATCHER_ALREADY_STARTED();\n+    return;\n   }\n \n   filename = getPathFromURL(filename);\n   validatePath(filename, 'filename');\n \n-  var err = this._handle.start(pathModule.toNamespacedPath(filename),\n-                               persistent,\n-                               recursive,\n-                               encoding);\n+  const err = this._handle.start(pathModule.toNamespacedPath(filename),\n+                                 persistent,\n+                                 recursive,\n+                                 encoding);\n   if (err) {\n     const error = errors.uvException({\n       errno: err,\n@@ -1372,10 +1371,11 @@ FSWatcher.prototype.start = function(filename,\n   }\n };\n \n+// This method is a noop if the watcher has not been started.\n FSWatcher.prototype.close = function() {\n   lazyAssert()(this._handle instanceof FSEvent, 'handle must be a FSEvent');\n   if (!this._handle.initialized) {\n-    throw new ERR_FS_WATCHER_NOT_STARTED();\n+    return;\n   }\n   this._handle.close();\n };"
        },
        {
            "sha": "d5260bd501faab655d2c1b7d70294da99eb5fac4",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/301f6cc553bd73cfa345ae7de6ee81655efc57d0/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/301f6cc553bd73cfa345ae7de6ee81655efc57d0/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=301f6cc553bd73cfa345ae7de6ee81655efc57d0",
            "patch": "@@ -654,10 +654,6 @@ E('ERR_FALSY_VALUE_REJECTION', 'Promise was rejected with falsy value', Error);\n E('ERR_FS_INVALID_SYMLINK_TYPE',\n   'Symlink type must be one of \"dir\", \"file\", or \"junction\". Received \"%s\"',\n   Error); // Switch to TypeError. The current implementation does not seem right\n-E('ERR_FS_WATCHER_ALREADY_STARTED',\n-  'The watcher has already been started', Error);\n-E('ERR_FS_WATCHER_NOT_STARTED',\n-  'The watcher has not been started', Error);\n E('ERR_HTTP2_ALTSVC_INVALID_ORIGIN',\n   'HTTP/2 ALTSVC frames require a valid origin', TypeError);\n E('ERR_HTTP2_ALTSVC_LENGTH',"
        },
        {
            "sha": "24600b79ceb010e13ddf5cdb462007b1e0bd7218",
            "filename": "test/parallel/test-fs-watch.js",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/301f6cc553bd73cfa345ae7de6ee81655efc57d0/test%2Fparallel%2Ftest-fs-watch.js",
            "raw_url": "https://github.com/nodejs/node/raw/301f6cc553bd73cfa345ae7de6ee81655efc57d0/test%2Fparallel%2Ftest-fs-watch.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-watch.js?ref=301f6cc553bd73cfa345ae7de6ee81655efc57d0",
            "patch": "@@ -65,16 +65,10 @@ for (const testCase of cases) {\n       assert.strictEqual(eventType, 'change');\n     assert.strictEqual(argFilename, testCase.fileName);\n \n-    common.expectsError(() => watcher.start(), {\n-      code: 'ERR_FS_WATCHER_ALREADY_STARTED',\n-      message: 'The watcher has already been started'\n-    });\n+    watcher.start();  // starting a started watcher should be a noop\n     // end of test case\n     watcher.close();\n-    common.expectsError(() => watcher.close(), {\n-      code: 'ERR_FS_WATCHER_NOT_STARTED',\n-      message: 'The watcher has not been started'\n-    });\n+    watcher.close(); // closing a closed watcher should be a noop\n   }));\n \n   // long content so it's actually flushed. toUpperCase so there's real change."
        }
    ],
    "stats": {
        "total": 46,
        "additions": 12,
        "deletions": 34
    }
}