{
    "author": "santigimeno",
    "message": "test: fix flaky http-server-keep-alive-timeout\n\nMake sure the connection is not closed until the 3 requests and the\n`timeout` event are received.\nSome code refactoring to avoid duplicated code.\n\nFixes: https://github.com/nodejs/node/issues/20013\nPR-URL: https://github.com/nodejs/node/pull/20093\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "998e174ce18f348096d9dd62ed6b2f1737df2855",
    "files": [
        {
            "sha": "3a604b5b8a450670585bbd47a43a2a3e710a86f3",
            "filename": "test/parallel/test-http-server-keep-alive-timeout.js",
            "status": "modified",
            "additions": 24,
            "deletions": 25,
            "changes": 49,
            "blob_url": "https://github.com/nodejs/node/blob/998e174ce18f348096d9dd62ed6b2f1737df2855/test%2Fparallel%2Ftest-http-server-keep-alive-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/998e174ce18f348096d9dd62ed6b2f1737df2855/test%2Fparallel%2Ftest-http-server-keep-alive-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-server-keep-alive-timeout.js?ref=998e174ce18f348096d9dd62ed6b2f1737df2855",
            "patch": "@@ -18,15 +18,28 @@ function run() {\n   if (fn) fn(run);\n }\n \n-test(function serverEndKeepAliveTimeoutWithPipeline(cb) {\n+function done(server, socket, cb) {\n+  socket.destroy();\n+  server.close(cb);\n+}\n+\n+function serverTest(withPipeline, cb) {\n+  let gotAll = false;\n+  let timedout = false;\n   const server = http.createServer(common.mustCall((req, res) => {\n-    res.end();\n+    if (withPipeline)\n+      res.end();\n+    if (req.url === '/3') {\n+      gotAll = true;\n+      if (timedout)\n+        done(server, req.socket, cb);\n+    }\n   }, 3));\n-  server.setTimeout(500, common.mustCall((socket) => {\n+  server.setTimeout(500, common.mustCallAtLeast((socket) => {\n     // End this test and call `run()` for the next test (if any).\n-    socket.destroy();\n-    server.close();\n-    cb();\n+    timedout = true;\n+    if (gotAll)\n+      done(server, socket, cb);\n   }));\n   server.keepAliveTimeout = 50;\n   server.listen(0, common.mustCall(() => {\n@@ -40,26 +53,12 @@ test(function serverEndKeepAliveTimeoutWithPipeline(cb) {\n       c.write('GET /3 HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n');\n     });\n   }));\n+}\n+\n+test(function serverEndKeepAliveTimeoutWithPipeline(cb) {\n+  serverTest(true, cb);\n });\n \n test(function serverNoEndKeepAliveTimeoutWithPipeline(cb) {\n-  const server = http.createServer(common.mustCall(3));\n-  server.setTimeout(500, common.mustCall((socket) => {\n-    // End this test and call `run()` for the next test (if any).\n-    socket.destroy();\n-    server.close();\n-    cb();\n-  }));\n-  server.keepAliveTimeout = 50;\n-  server.listen(0, common.mustCall(() => {\n-    const options = {\n-      port: server.address().port,\n-      allowHalfOpen: true\n-    };\n-    const c = net.connect(options, () => {\n-      c.write('GET /1 HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n');\n-      c.write('GET /2 HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n');\n-      c.write('GET /3 HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n');\n-    });\n-  }));\n+  serverTest(false, cb);\n });"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 24,
        "deletions": 25
    }
}