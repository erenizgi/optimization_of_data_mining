{
    "author": "jasnell",
    "message": "trace_events,async_hooks: use intrinsic trace\n\nSwitch to using the intrinsic trace event method for async_hooks.\n\nThis is a breaking change because of the switch to a nested data\nargument for exec id and trigger id values.\n\nPR-URL: https://github.com/nodejs/node/pull/22127\nReviewed-By: Andreas Madsen <amwebdk@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "c85933cbd07ec3e32fdb27c4c4ef1aeadc609345",
    "files": [
        {
            "sha": "f687f1ced8e15588cf2894e34dea83951ac285a1",
            "filename": "lib/internal/trace_events_async_hooks.js",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/lib%2Finternal%2Ftrace_events_async_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftrace_events_async_hooks.js?ref=c85933cbd07ec3e32fdb27c4c4ef1aeadc609345",
            "patch": "@@ -1,6 +1,7 @@\n 'use strict';\n \n exports.setup = function(traceEvents, traceEventCategory) {\n+  const { trace } = traceEvents;\n   const async_wrap = process.binding('async_wrap');\n   const async_hooks = require('async_hooks');\n \n@@ -27,34 +28,33 @@ exports.setup = function(traceEvents, traceEventCategory) {\n       if (nativeProviders.has(type)) return;\n \n       typeMemory.set(asyncId, type);\n-      traceEvents.emit(BEFORE_EVENT, traceEventCategory,\n-                       type, asyncId,\n-                       'triggerAsyncId', triggerAsyncId,\n-                       'executionAsyncId', async_hooks.executionAsyncId());\n+      trace(BEFORE_EVENT, traceEventCategory,\n+            type, asyncId,\n+            {\n+              triggerAsyncId,\n+              executionAsyncId: async_hooks.executionAsyncId()\n+            });\n     },\n \n     before(asyncId) {\n       const type = typeMemory.get(asyncId);\n       if (type === undefined) return;\n \n-      traceEvents.emit(BEFORE_EVENT, traceEventCategory,\n-                       type + '_CALLBACK', asyncId);\n+      trace(BEFORE_EVENT, traceEventCategory, `${type}_CALLBACK`, asyncId);\n     },\n \n     after(asyncId) {\n       const type = typeMemory.get(asyncId);\n       if (type === undefined) return;\n \n-      traceEvents.emit(END_EVENT, traceEventCategory,\n-                       type + '_CALLBACK', asyncId);\n+      trace(END_EVENT, traceEventCategory, `${type}_CALLBACK`, asyncId);\n     },\n \n     destroy(asyncId) {\n       const type = typeMemory.get(asyncId);\n       if (type === undefined) return;\n \n-      traceEvents.emit(END_EVENT, traceEventCategory,\n-                       type, asyncId);\n+      trace(END_EVENT, traceEventCategory, type, asyncId);\n \n       // cleanup asyncId to type map\n       typeMemory.delete(asyncId);"
        },
        {
            "sha": "51072bb8c9c8e9ac4568207c0e107743ab9b0d64",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=c85933cbd07ec3e32fdb27c4c4ef1aeadc609345",
            "patch": "@@ -23,6 +23,7 @@\n #include \"env-inl.h\"\n #include \"node_internals.h\"\n #include \"util-inl.h\"\n+#include \"tracing/traced_value.h\"\n \n #include \"v8.h\"\n #include \"v8-profiler.h\"\n@@ -608,13 +609,18 @@ void AsyncWrap::AsyncReset(double execution_async_id, bool silent) {\n   switch (provider_type()) {\n #define V(PROVIDER)                                                           \\\n     case PROVIDER_ ## PROVIDER:                                               \\\n-      TRACE_EVENT_NESTABLE_ASYNC_BEGIN2(                                      \\\n-        TRACING_CATEGORY_NODE1(async_hooks),                                  \\\n-        #PROVIDER, static_cast<int64_t>(get_async_id()),                      \\\n-        \"executionAsyncId\",                                                   \\\n-        static_cast<int64_t>(env()->execution_async_id()),                    \\\n-        \"triggerAsyncId\",                                                     \\\n-        static_cast<int64_t>(get_trigger_async_id()));                        \\\n+      if (*TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(                        \\\n+          TRACING_CATEGORY_NODE1(async_hooks))) {                             \\\n+        auto data = tracing::TracedValue::Create();                           \\\n+        data->SetInteger(\"executionAsyncId\",                                  \\\n+                         static_cast<int64_t>(env()->execution_async_id()));  \\\n+        data->SetInteger(\"triggerAsyncId\",                                    \\\n+                         static_cast<int64_t>(get_trigger_async_id()));       \\\n+        TRACE_EVENT_NESTABLE_ASYNC_BEGIN1(                                    \\\n+          TRACING_CATEGORY_NODE1(async_hooks),                                \\\n+          #PROVIDER, static_cast<int64_t>(get_async_id()),                    \\\n+          \"data\", std::move(data));                                           \\\n+        }                                                                     \\\n       break;\n     NODE_ASYNC_PROVIDER_TYPES(V)\n #undef V"
        },
        {
            "sha": "7c82eb9364a27e26ac09ba6d888965eee1d91c2a",
            "filename": "test/parallel/test-trace-events-async-hooks.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/c85933cbd07ec3e32fdb27c4c4ef1aeadc609345/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-async-hooks.js?ref=c85933cbd07ec3e32fdb27c4c4ef1aeadc609345",
            "patch": "@@ -61,8 +61,8 @@ proc.once('exit', common.mustCall(() => {\n       return (trace.ph === 'b' && !trace.name.includes('_CALLBACK'));\n     });\n     assert.ok(initEvents.every((trace) => {\n-      return (trace.args.executionAsyncId > 0 &&\n-              trace.args.triggerAsyncId > 0);\n+      return (trace.args.data.executionAsyncId > 0 &&\n+              trace.args.data.triggerAsyncId > 0);\n     }), `Unexpected initEvents format: ${util.inspect(initEvents)}`);\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 25,
        "deletions": 19
    }
}