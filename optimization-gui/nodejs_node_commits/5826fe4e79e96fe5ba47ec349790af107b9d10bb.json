{
    "author": "TimothyGu",
    "message": "process: doc-only deprecate non-string env value\n\nPR-URL: https://github.com/nodejs/node/pull/18990\nRefs: https://github.com/nodejs/node/pull/15089\nRefs: https://github.com/nodejs/node/pull/18158\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gibson Fahnestock <gibfahn@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "5826fe4e79e96fe5ba47ec349790af107b9d10bb",
    "files": [
        {
            "sha": "b3b316f1a35e57c95f4c65c96a940905b9e4d42f",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -915,7 +915,6 @@ Type: Runtime\n \n This was never a documented feature.\n \n-\n <a id=\"DEP0101\"></a>\n ### DEP0101: --with-lttng\n \n@@ -940,6 +939,17 @@ Type: Documentation-only (supports [`--pending-deprecation`][])\n Using `process.binding()` in general should be avoided. The type checking\n methods in particular can be replaced by using [`util.types`][].\n \n+<a id=\"DEP0104\"></a>\n+### DEP0104: process.env string coercion\n+\n+Type: Documentation-only (supports [`--pending-deprecation`][])\n+\n+Currently when assigning a property to [`process.env`][], the assigned value is\n+implicitly converted to a string if it is not a string. This behavior is\n+deprecated if the assigned value is not a string, boolean, or number. In the\n+future, such assignment may result in a thrown error. Please convert the\n+property to a string before assigning it to `process.env`.\n+\n [`--pending-deprecation`]: cli.html#cli_pending_deprecation\n [`Buffer.allocUnsafeSlow(size)`]: buffer.html#buffer_class_method_buffer_allocunsafeslow_size\n [`Buffer.from(array)`]: buffer.html#buffer_class_method_buffer_from_array\n@@ -976,6 +986,7 @@ methods in particular can be replaced by using [`util.types`][].\n [`fs.stat()`]: fs.html#fs_fs_stat_path_callback\n [`os.networkInterfaces`]: os.html#os_os_networkinterfaces\n [`os.tmpdir()`]: os.html#os_os_tmpdir\n+[`process.env`]: process.html#process_process_env\n [`punycode`]: punycode.html\n [`require.extensions`]: modules.html#modules_require_extensions\n [`setInterval()`]: timers.html#timers_setinterval_callback_delay_args"
        },
        {
            "sha": "e89e5c0281a23befa0f81b9f6f07af76a593cc8e",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -836,6 +836,10 @@ emitMyWarning();\n ## process.env\n <!-- YAML\n added: v0.1.27\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18990\n+    description: Implicit conversion of variable value to string is deprecated.\n -->\n \n * {Object}\n@@ -877,7 +881,8 @@ console.log(process.env.foo);\n ```\n \n Assigning a property on `process.env` will implicitly convert the value\n-to a string.\n+to a string. **This behavior is deprecated.** Future versions of Node.js may\n+throw an error when the value is not a string, number, or boolean.\n \n Example:\n "
        },
        {
            "sha": "a91ef578c8a04a37fbd23290a32c24cb053cf464",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -330,6 +330,7 @@ inline Environment::Environment(IsolateData* isolate_data,\n       trace_sync_io_(false),\n       abort_on_uncaught_exception_(false),\n       emit_napi_warning_(true),\n+      emit_env_nonstring_warning_(true),\n       makecallback_cntr_(0),\n       should_abort_on_uncaught_toggle_(isolate_, 1),\n #if HAVE_INSPECTOR"
        },
        {
            "sha": "8c73b8b206e6ec8e126f1478a591994f14c669db",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -725,6 +725,11 @@ class Environment {\n   void AddPromiseHook(promise_hook_func fn, void* arg);\n   bool RemovePromiseHook(promise_hook_func fn, void* arg);\n   bool EmitNapiWarning();\n+  inline bool EmitProcessEnvWarning() {\n+    bool current_value = emit_env_nonstring_warning_;\n+    emit_env_nonstring_warning_ = false;\n+    return current_value;\n+  }\n \n   typedef void (*native_immediate_callback)(Environment* env, void* data);\n   // cb will be called as cb(env, data) on the next event loop iteration.\n@@ -779,6 +784,7 @@ class Environment {\n   bool trace_sync_io_;\n   bool abort_on_uncaught_exception_;\n   bool emit_napi_warning_;\n+  bool emit_env_nonstring_warning_;\n   size_t makecallback_cntr_;\n   std::vector<double> destroy_async_id_list_;\n "
        },
        {
            "sha": "9a1c4eeb6a72e6c22d6abaa372eca16b44cb58c7",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -2659,6 +2659,17 @@ static void EnvGetter(Local<Name> property,\n static void EnvSetter(Local<Name> property,\n                       Local<Value> value,\n                       const PropertyCallbackInfo<Value>& info) {\n+  Environment* env = Environment::GetCurrent(info);\n+  if (config_pending_deprecation && env->EmitProcessEnvWarning() &&\n+      !value->IsString() && !value->IsNumber() && !value->IsBoolean()) {\n+    if (ProcessEmitDeprecationWarning(\n+          env,\n+          \"Assigning any value other than a string, number, or boolean to a \"\n+          \"process.env property is deprecated. Please make sure to convert the \"\n+          \"value to a string before setting process.env with it.\",\n+          \"DEP00XX\").IsNothing())\n+      return;\n+  }\n #ifdef __POSIX__\n   node::Utf8Value key(info.GetIsolate(), property);\n   node::Utf8Value val(info.GetIsolate(), value);"
        },
        {
            "sha": "c3b9ea6da37a23ed0ac47f9b08e6a035c156069c",
            "filename": "test/parallel/test-process-env-deprecation.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/5826fe4e79e96fe5ba47ec349790af107b9d10bb/test%2Fparallel%2Ftest-process-env-deprecation.js",
            "raw_url": "https://github.com/nodejs/node/raw/5826fe4e79e96fe5ba47ec349790af107b9d10bb/test%2Fparallel%2Ftest-process-env-deprecation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-deprecation.js?ref=5826fe4e79e96fe5ba47ec349790af107b9d10bb",
            "patch": "@@ -0,0 +1,16 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+\n+// Flags: --pending-deprecation\n+\n+common.expectWarning(\n+  'DeprecationWarning',\n+  'Assigning any value other than a string, number, or boolean to a ' +\n+  'process.env property is deprecated. Please make sure to convert the value ' +\n+  'to a string before setting process.env with it.',\n+  'DEP00XX'\n+);\n+\n+process.env.ABC = undefined;\n+assert.strictEqual(process.env.ABC, 'undefined');"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 52,
        "deletions": 2
    }
}