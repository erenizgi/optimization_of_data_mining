{
    "author": "addaleax",
    "message": "test: refactor test-gc-tls-external-memory\n\n- Don’t use network connections, we don’t need them and\n  they add more native objects into the mix when we care\n  about other kinds of native objects.\n- Run GC only once every 64 iterations – this cuts down\n  running time from 4 s to 400 ms.\n- Use `common.mustCall()` for the `connect()` handler.\n- Make sure that the TLS sockets do get garbage collected,\n  since the test would otherwise also pass if they remain\n  alive indefinitely.\n\nPR-URL: https://github.com/nodejs/node/pull/22651\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: George Adams <george.adams@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "d4cdb2ce662e9521d0671058a0f129ccad3f7e03",
    "files": [
        {
            "sha": "d77553b15730094aa1398746927cc7a156087fb6",
            "filename": "test/parallel/test-gc-tls-external-memory.js",
            "status": "modified",
            "additions": 30,
            "deletions": 16,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/d4cdb2ce662e9521d0671058a0f129ccad3f7e03/test%2Fparallel%2Ftest-gc-tls-external-memory.js",
            "raw_url": "https://github.com/nodejs/node/raw/d4cdb2ce662e9521d0671058a0f129ccad3f7e03/test%2Fparallel%2Ftest-gc-tls-external-memory.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-tls-external-memory.js?ref=d4cdb2ce662e9521d0671058a0f129ccad3f7e03",
            "patch": "@@ -8,28 +8,42 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+const makeDuplexPair = require('../common/duplexpair');\n+const onGC = require('../common/ongc');\n const assert = require('assert');\n-const net = require('net');\n const tls = require('tls');\n \n // Payload doesn't matter. We just need to have the tls\n // connection try and connect somewhere.\n-const yolo = Buffer.alloc(10000).fill('yolo');\n-const server = net.createServer(function(socket) {\n-  socket.write(yolo);\n-});\n+const dummyPayload = Buffer.alloc(10000, 'yolo');\n \n-server.listen(0, common.mustCall(function() {\n-  const { port } = server.address();\n-  let runs = 0;\n-  connect();\n+let runs = 0;\n \n-  function connect() {\n+// Count garbage-collected TLS sockets.\n+let gced = 0;\n+function ongc() { gced++; }\n+\n+connect();\n+\n+function connect() {\n+  if (runs % 64 === 0)\n     global.gc();\n-    assert(process.memoryUsage().external >= 0);\n-    if (runs++ < 512)\n-      tls.connect(port).on('error', connect);\n-    else\n-      server.close();\n+  const externalMemoryUsage = process.memoryUsage().external;\n+  assert(externalMemoryUsage >= 0, `${externalMemoryUsage} < 0`);\n+  if (runs++ === 512) {\n+    // Make sure at least half the TLS sockets have been gargbage collected\n+    // (so that this test can actually check what it's testing):\n+    assert(gced >= 256, `${gced} < 256`);\n+    return;\n   }\n-}));\n+\n+  const { clientSide, serverSide } = makeDuplexPair();\n+\n+  const tlsSocket = tls.connect({ socket: clientSide });\n+  tlsSocket.on('error', common.mustCall(connect));\n+  onGC(tlsSocket, { ongc });\n+\n+  // Use setImmediate so that we don't trigger the error within the same\n+  // event loop tick.\n+  setImmediate(() => serverSide.write(dummyPayload));\n+}"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 30,
        "deletions": 16
    }
}