{
    "author": "xaviergonz",
    "message": "src: fix async hooks crashing when there is no node context\n\nPR-URL: https://github.com/nodejs/node/pull/19134\nFixes: https://github.com/nodejs/node/issues/19104\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "fb87d8aa12c8e891857c46e632d37970533f4e92",
    "files": [
        {
            "sha": "a294066bb5aa0d6c2fae62d5984403f95f735b67",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=fb87d8aa12c8e891857c46e632d37970533f4e92",
            "patch": "@@ -282,6 +282,9 @@ inline void Environment::AssignToContext(v8::Local<v8::Context> context,\n                                          const ContextInfo& info) {\n   context->SetAlignedPointerInEmbedderData(\n       ContextEmbedderIndex::kEnvironment, this);\n+  // Used by EnvPromiseHook to know that we are on a node context.\n+  context->SetAlignedPointerInEmbedderData(\n+    ContextEmbedderIndex::kContextTag, Environment::kNodeContextTagPtr);\n #if HAVE_INSPECTOR\n   inspector_agent()->ContextCreated(context, info);\n #endif  // HAVE_INSPECTOR"
        },
        {
            "sha": "8362ce85c78cd2363003c91f9af35697bd73758e",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=fb87d8aa12c8e891857c46e632d37970533f4e92",
            "patch": "@@ -4,6 +4,7 @@\n #include \"node_buffer.h\"\n #include \"node_platform.h\"\n #include \"node_file.h\"\n+#include \"node_context_data.h\"\n #include \"node_worker.h\"\n #include \"tracing/agent.h\"\n \n@@ -30,6 +31,10 @@ using v8::TryCatch;\n using v8::Value;\n using worker::Worker;\n \n+int const Environment::kNodeContextTag = 0x6e6f64;\n+void* Environment::kNodeContextTagPtr = const_cast<void*>(\n+    static_cast<const void*>(&Environment::kNodeContextTag));\n+\n IsolateData::IsolateData(Isolate* isolate,\n                          uv_loop_t* event_loop,\n                          MultiIsolatePlatform* platform,\n@@ -439,7 +444,20 @@ bool Environment::RemovePromiseHook(promise_hook_func fn, void* arg) {\n void Environment::EnvPromiseHook(v8::PromiseHookType type,\n                                  v8::Local<v8::Promise> promise,\n                                  v8::Local<v8::Value> parent) {\n-  Environment* env = Environment::GetCurrent(promise->CreationContext());\n+  Local<v8::Context> context = promise->CreationContext();\n+\n+  // Grow the embedder data if necessary to make sure we are not out of bounds\n+  // when reading the magic number.\n+  context->SetAlignedPointerInEmbedderData(\n+      ContextEmbedderIndex::kContextTagBoundary, nullptr);\n+  int* magicNumberPtr = reinterpret_cast<int*>(\n+      context->GetAlignedPointerFromEmbedderData(\n+          ContextEmbedderIndex::kContextTag));\n+  if (magicNumberPtr != Environment::kNodeContextTagPtr) {\n+    return;\n+  }\n+\n+  Environment* env = Environment::GetCurrent(context);\n   for (const PromiseHookCallback& hook : env->promise_hooks_) {\n     hook.cb_(type, promise, parent, hook.arg_);\n   }"
        },
        {
            "sha": "acbdd013285d6c8d382b6841e53849b68a3baf5f",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=fb87d8aa12c8e891857c46e632d37970533f4e92",
            "patch": "@@ -905,6 +905,8 @@ class Environment {\n   uint64_t thread_id_ = 0;\n   std::unordered_set<worker::Worker*> sub_worker_contexts_;\n \n+  static void* kNodeContextTagPtr;\n+  static int const kNodeContextTag;\n \n #if HAVE_INSPECTOR\n   std::unique_ptr<inspector::Agent> inspector_agent_;"
        },
        {
            "sha": "3892b31354027df8fe07d24fa1e232e7ca58aeb7",
            "filename": "src/node_context_data.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fnode_context_data.h",
            "raw_url": "https://github.com/nodejs/node/raw/fb87d8aa12c8e891857c46e632d37970533f4e92/src%2Fnode_context_data.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_context_data.h?ref=fb87d8aa12c8e891857c46e632d37970533f4e92",
            "patch": "@@ -19,10 +19,20 @@ namespace node {\n #define NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX 34\n #endif\n \n+#ifndef NODE_CONTEXT_TAG\n+#define NODE_CONTEXT_TAG 35\n+#endif\n+\n+#ifndef NODE_CONTEXT_TAG_BOUNDARY\n+#define NODE_CONTEXT_TAG_BOUNDARY 36\n+#endif\n+\n enum ContextEmbedderIndex {\n   kEnvironment = NODE_CONTEXT_EMBEDDER_DATA_INDEX,\n   kSandboxObject = NODE_CONTEXT_SANDBOX_OBJECT_INDEX,\n   kAllowWasmCodeGeneration = NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX,\n+  kContextTag = NODE_CONTEXT_TAG,\n+  kContextTagBoundary = NODE_CONTEXT_TAG_BOUNDARY,\n };\n \n }  // namespace node"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 34,
        "deletions": 1
    }
}