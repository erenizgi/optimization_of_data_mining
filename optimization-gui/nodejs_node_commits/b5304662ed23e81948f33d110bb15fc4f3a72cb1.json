{
    "author": "davidben",
    "message": "tls: fix malloc mismatch in SSL_set_tlsext_status_ocsp_resp call\n\nSSL_set_tlsext_status_ocsp_resp expects the data to be allocated with\nOPENSSL_malloc, not libc malloc, so use OpenSSLMalloc.\n\nAdditionally, though OpenSSL doesn't type-check due to it being a macro,\nthe function is documented to take an unsigned char pointer:\nhttps://www.openssl.org/docs/man1.1.0/ssl/SSL_set_tlsext_status_ocsp_resp.html\n\n(By default, OPENSSL_malloc is the same as libc malloc, but it is\npossible to customize this.)\n\nPR-URL: https://github.com/nodejs/node/pull/25706\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "b5304662ed23e81948f33d110bb15fc4f3a72cb1",
    "files": [
        {
            "sha": "270f74153aeb3022fd9b78dae08b35f51652af16",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/b5304662ed23e81948f33d110bb15fc4f3a72cb1/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b5304662ed23e81948f33d110bb15fc4f3a72cb1/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=b5304662ed23e81948f33d110bb15fc4f3a72cb1",
            "patch": "@@ -326,6 +326,14 @@ bool EntropySource(unsigned char* buffer, size_t length) {\n }\n \n \n+template <typename T>\n+static T* MallocOpenSSL(size_t count) {\n+  void* mem = OPENSSL_malloc(MultiplyWithOverflowCheck(count, sizeof(T)));\n+  CHECK_IMPLIES(mem == nullptr, count == 0);\n+  return static_cast<T*>(mem);\n+}\n+\n+\n void SecureContext::Initialize(Environment* env, Local<Object> target) {\n   Local<FunctionTemplate> t = env->NewFunctionTemplate(New);\n   t->InstanceTemplate()->SetInternalFieldCount(1);\n@@ -2473,11 +2481,11 @@ int SSLWrap<Base>::TLSExtStatusCallback(SSL* s, void* arg) {\n     size_t len = Buffer::Length(obj);\n \n     // OpenSSL takes control of the pointer after accepting it\n-    char* data = node::Malloc(len);\n+    unsigned char* data = MallocOpenSSL<unsigned char>(len);\n     memcpy(data, resp, len);\n \n     if (!SSL_set_tlsext_status_ocsp_resp(s, data, len))\n-      free(data);\n+      OPENSSL_free(data);\n     w->ocsp_response_.Reset();\n \n     return SSL_TLSEXT_ERR_OK;\n@@ -2699,13 +2707,6 @@ static bool IsSupportedAuthenticatedMode(const EVP_CIPHER_CTX* ctx) {\n   return IsSupportedAuthenticatedMode(cipher);\n }\n \n-template <typename T>\n-static T* MallocOpenSSL(size_t count) {\n-  void* mem = OPENSSL_malloc(MultiplyWithOverflowCheck(count, sizeof(T)));\n-  CHECK_IMPLIES(mem == nullptr, count == 0);\n-  return static_cast<T*>(mem);\n-}\n-\n enum class ParsePublicKeyResult {\n   kParsePublicOk,\n   kParsePublicNotRecognized,"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 10,
        "deletions": 9
    }
}