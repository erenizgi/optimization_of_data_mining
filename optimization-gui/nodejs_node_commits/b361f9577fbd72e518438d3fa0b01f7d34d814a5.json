{
    "author": "lpinca",
    "message": "test: refactor two http client timeout tests\n\nRefactor test-http-client-set-timeout and\ntest-http-client-timeout-option-with-agent.\n\nPR-URL: https://github.com/nodejs/node/pull/25473\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "b361f9577fbd72e518438d3fa0b01f7d34d814a5",
    "files": [
        {
            "sha": "15aae7023bf3f1ecd50757471afb9dbf0820e02c",
            "filename": "test/parallel/test-http-client-set-timeout.js",
            "status": "modified",
            "additions": 36,
            "deletions": 34,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/b361f9577fbd72e518438d3fa0b01f7d34d814a5/test%2Fparallel%2Ftest-http-client-set-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/b361f9577fbd72e518438d3fa0b01f7d34d814a5/test%2Fparallel%2Ftest-http-client-set-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-set-timeout.js?ref=b361f9577fbd72e518438d3fa0b01f7d34d814a5",
            "patch": "@@ -1,46 +1,48 @@\n 'use strict';\n-const common = require('../common');\n \n-// Test that `req.setTimeout` will fired exactly once.\n+// Test that the `'timeout'` event is emitted exactly once if the `timeout`\n+// option and `request.setTimeout()` are used together.\n \n-const assert = require('assert');\n-const http = require('http');\n+const { expectsError, mustCall } = require('../common');\n+const { strictEqual } = require('assert');\n+const { createServer, get } = require('http');\n \n-const HTTP_CLIENT_TIMEOUT = 2000;\n-\n-const options = {\n-  method: 'GET',\n-  port: undefined,\n-  host: '127.0.0.1',\n-  path: '/',\n-  timeout: HTTP_CLIENT_TIMEOUT,\n-};\n-\n-const server = http.createServer(() => {\n+const server = createServer(() => {\n   // Never respond.\n });\n \n-server.listen(0, options.host, function() {\n-  doRequest();\n-});\n-\n-function doRequest() {\n-  options.port = server.address().port;\n-  const req = http.request(options);\n-  req.setTimeout(HTTP_CLIENT_TIMEOUT / 2);\n-  req.on('error', () => {\n-    // This space is intentionally left blank.\n+server.listen(0, mustCall(() => {\n+  const req = get({\n+    port: server.address().port,\n+    timeout: 2000,\n   });\n-  req.on('close', common.mustCall(() => server.close()));\n \n-  let timeout_events = 0;\n-  req.on('timeout', common.mustCall(() => {\n-    timeout_events += 1;\n+  req.setTimeout(1000);\n+\n+  req.on('socket', mustCall((socket) => {\n+    strictEqual(socket.timeout, 2000);\n+\n+    socket.on('connect', mustCall(() => {\n+      strictEqual(socket.timeout, 1000);\n+\n+      // Reschedule the timer to not wait 1 sec and make the test finish faster.\n+      socket.setTimeout(10);\n+      strictEqual(socket.timeout, 10);\n+    }));\n+  }));\n+\n+  req.on('error', expectsError({\n+    type: Error,\n+    code: 'ECONNRESET',\n+    message: 'socket hang up'\n   }));\n-  req.end();\n \n-  setTimeout(function() {\n+  req.on('close', mustCall(() => {\n+    server.close();\n+  }));\n+\n+  req.on('timeout', mustCall(() => {\n+    strictEqual(req.socket.listenerCount('timeout'), 0);\n     req.destroy();\n-    assert.strictEqual(timeout_events, 1);\n-  }, common.platformTimeout(HTTP_CLIENT_TIMEOUT));\n-}\n+  }));\n+}));"
        },
        {
            "sha": "594dd1215f43e5cbdf60d2d2178b6338297206ff",
            "filename": "test/parallel/test-http-client-timeout-option-with-agent.js",
            "status": "modified",
            "additions": 15,
            "deletions": 50,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/b361f9577fbd72e518438d3fa0b01f7d34d814a5/test%2Fparallel%2Ftest-http-client-timeout-option-with-agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/b361f9577fbd72e518438d3fa0b01f7d34d814a5/test%2Fparallel%2Ftest-http-client-timeout-option-with-agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-timeout-option-with-agent.js?ref=b361f9577fbd72e518438d3fa0b01f7d34d814a5",
            "patch": "@@ -1,58 +1,23 @@\n 'use strict';\n-const common = require('../common');\n \n-// Test that when http request uses both timeout and agent,\n-// timeout will work as expected.\n+// Test that the request `timeout` option has precedence over the agent\n+// `timeout` option.\n \n-const assert = require('assert');\n-const http = require('http');\n+const { mustCall } = require('../common');\n+const { Agent, get } = require('http');\n+const { strictEqual } = require('assert');\n \n-const HTTP_AGENT_TIMEOUT = 1000;\n-const HTTP_CLIENT_TIMEOUT = 3000;\n-\n-const agent = new http.Agent({ timeout: HTTP_AGENT_TIMEOUT });\n-const options = {\n-  method: 'GET',\n-  port: undefined,\n-  host: '127.0.0.1',\n-  path: '/',\n-  timeout: HTTP_CLIENT_TIMEOUT,\n-  agent,\n-};\n-\n-const server = http.createServer(() => {\n-  // Never respond.\n-});\n-\n-server.listen(0, options.host, () => {\n-  doRequest();\n+const request = get({\n+  agent: new Agent({ timeout: 50 }),\n+  lookup: () => {},\n+  timeout: 100\n });\n \n-function doRequest() {\n-  options.port = server.address().port;\n-  const start = process.hrtime.bigint();\n-  const req = http.request(options);\n-  req.on('error', () => {\n-    // This space is intentionally left blank.\n-  });\n-  req.on('close', common.mustCall(() => server.close()));\n+request.on('socket', mustCall((socket) => {\n+  strictEqual(socket.timeout, 100);\n \n-  let timeout_events = 0;\n-  req.on('timeout', common.mustCall(() => {\n-    timeout_events += 1;\n-    const duration = process.hrtime.bigint() - start;\n-    // The timeout event cannot be precisely timed. It will delay\n-    // some number of milliseconds.\n-    assert.ok(\n-      duration >= BigInt(HTTP_CLIENT_TIMEOUT * 1e6),\n-      `duration ${duration}ms less than timeout ${HTTP_CLIENT_TIMEOUT}ms`\n-    );\n-  }));\n-  req.end();\n+  const listeners = socket.listeners('timeout');\n \n-  setTimeout(() => {\n-    req.destroy();\n-    assert.strictEqual(timeout_events, 1);\n-    // Ensure the `timeout` event fired only once.\n-  }, common.platformTimeout(HTTP_CLIENT_TIMEOUT * 2));\n-}\n+  strictEqual(listeners.length, 1);\n+  strictEqual(listeners[0], request.timeoutCb);\n+}));"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 51,
        "deletions": 84
    }
}