{
    "author": "BridgeAR",
    "message": "assert: make sure throws is able to handle primitives\n\nThis fixes some possible issues with `assert.throws` and\n`assert.rejects` in combination with an validation object. It will\nnow properly handle primitive values being thrown as error.\n\nIt also makes sure the `generatedMessage` property is properly set\nif `assert.throws` or `assert.rejects` is used in combination with\nan validation object and improves the error performance in such cases\nby only creating the error once.\n\nIn addition it will fix detecting regular expressions from a different\ncontext such as n-api that are passed through as validator for\n`assert.throws` or `assert.rejects`. Until now those were not tested.\n\nPR-URL: https://github.com/nodejs/node/pull/20482\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "560925fe22bfc23860b04704ff4cae21e4dd19ff",
    "files": [
        {
            "sha": "8bcdc8cdacb3eed3761a723997ac04b58db10965",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 25,
            "deletions": 5,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/560925fe22bfc23860b04704ff4cae21e4dd19ff/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/560925fe22bfc23860b04704ff4cae21e4dd19ff/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=560925fe22bfc23860b04704ff4cae21e4dd19ff",
            "patch": "@@ -382,16 +382,16 @@ function compareExceptionKey(actual, expected, key, message, keys) {\n       const a = new Comparison(actual, keys);\n       const b = new Comparison(expected, keys, actual);\n \n-      const tmpLimit = Error.stackTraceLimit;\n-      Error.stackTraceLimit = 0;\n       const err = new AssertionError({\n         actual: a,\n         expected: b,\n         operator: 'deepStrictEqual',\n         stackStartFn: assert.throws\n       });\n-      Error.stackTraceLimit = tmpLimit;\n-      message = err.message;\n+      err.actual = actual;\n+      err.expected = expected;\n+      err.operator = 'throws';\n+      throw err;\n     }\n     innerFail({\n       actual,\n@@ -405,14 +405,34 @@ function compareExceptionKey(actual, expected, key, message, keys) {\n \n function expectedException(actual, expected, msg) {\n   if (typeof expected !== 'function') {\n-    if (expected instanceof RegExp)\n+    if (isRegExp(expected))\n       return expected.test(actual);\n     // assert.doesNotThrow does not accept objects.\n     if (arguments.length === 2) {\n       throw new ERR_INVALID_ARG_TYPE(\n         'expected', ['Function', 'RegExp'], expected\n       );\n     }\n+\n+    // TODO: Disallow primitives as error argument.\n+    // This is here to prevent a breaking change.\n+    if (typeof expected !== 'object') {\n+      return true;\n+    }\n+\n+    // Handle primitives properly.\n+    if (typeof actual !== 'object' || actual === null) {\n+      const err = new AssertionError({\n+        actual,\n+        expected,\n+        message: msg,\n+        operator: 'deepStrictEqual',\n+        stackStartFn: assert.throws\n+      });\n+      err.operator = 'throws';\n+      throw err;\n+    }\n+\n     const keys = Object.keys(expected);\n     // Special handle errors to make sure the name and the message are compared\n     // as well."
        },
        {
            "sha": "3d5f4de4cf26a69525901d9056cf40d9add27f27",
            "filename": "test/message/assert_throws_stack.out",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/560925fe22bfc23860b04704ff4cae21e4dd19ff/test%2Fmessage%2Fassert_throws_stack.out",
            "raw_url": "https://github.com/nodejs/node/raw/560925fe22bfc23860b04704ff4cae21e4dd19ff/test%2Fmessage%2Fassert_throws_stack.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fassert_throws_stack.out?ref=560925fe22bfc23860b04704ff4cae21e4dd19ff",
            "patch": "@@ -1,6 +1,6 @@\n assert.js:*\n-  throw new AssertionError(obj);\n-  ^\n+      throw err;\n+      ^\n \n AssertionError [ERR_ASSERTION]: Input A expected to strictly deep-equal input B:\n + expected - actual"
        },
        {
            "sha": "dba40c0a0e3c423b2af96cf0c35cad6a0b58b07a",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/560925fe22bfc23860b04704ff4cae21e4dd19ff/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/560925fe22bfc23860b04704ff4cae21e4dd19ff/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=560925fe22bfc23860b04704ff4cae21e4dd19ff",
            "patch": "@@ -740,7 +740,9 @@ common.expectsError(\n     const frames = err.stack.split('\\n');\n     const [, filename, line, column] = frames[1].match(/\\((.+):(\\d+):(\\d+)\\)/);\n     // Reset the cache to check again\n+    const size = errorCache.size;\n     errorCache.delete(`${filename}${line - 1}${column - 1}`);\n+    assert.strictEqual(errorCache.size, size - 1);\n     const data = `${'\\n'.repeat(line - 1)}${' '.repeat(column - 1)}` +\n                  'ok(failed(badly));';\n     try {\n@@ -849,6 +851,7 @@ common.expectsError(\n     {\n       name: 'AssertionError [ERR_ASSERTION]',\n       code: 'ERR_ASSERTION',\n+      generatedMessage: true,\n       message: `${start}\\n${actExp}\\n\\n` +\n                \"  Comparison {\\n    name: 'Error',\\n-   message: 'foo'\" +\n                \"\\n+   message: ''\\n  }\"\n@@ -940,3 +943,45 @@ assert.throws(\n              '  }'\n   }\n );\n+\n+{\n+  let actual = null;\n+  const expected = { message: 'foo' };\n+  assert.throws(\n+    () => assert.throws(\n+      () => { throw actual; },\n+      expected\n+    ),\n+    {\n+      operator: 'throws',\n+      actual,\n+      expected,\n+      generatedMessage: true,\n+      message: `${start}\\n${actExp}\\n\\n` +\n+              '- null\\n' +\n+              '+ {\\n' +\n+              \"+   message: 'foo'\\n\" +\n+              '+ }'\n+    }\n+  );\n+\n+  actual = 'foobar';\n+  const message = 'message';\n+  assert.throws(\n+    () => assert.throws(\n+      () => { throw actual; },\n+      { message: 'foobar' },\n+      message\n+    ),\n+    {\n+      actual,\n+      message,\n+      operator: 'throws',\n+      generatedMessage: false\n+    }\n+  );\n+}\n+\n+// TODO: This case is only there to make sure there is no breaking change.\n+// eslint-disable-next-line no-restricted-syntax, no-throw-literal\n+assert.throws(() => { throw 4; }, 4);"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 72,
        "deletions": 7
    }
}