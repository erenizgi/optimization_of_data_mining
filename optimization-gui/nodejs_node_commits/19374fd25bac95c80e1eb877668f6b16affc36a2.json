{
    "author": "ryzokuken",
    "message": "fs: improve argument handling for ReadStream\n\nImprove handling of erratic arguments in fs.ReadStream\n\nRefs: https://github.com/nodejs/node/pull/19732\nPR-URL: https://github.com/nodejs/node/pull/19898\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ron Korving <ron@ronkorving.nl>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "19374fd25bac95c80e1eb877668f6b16affc36a2",
    "files": [
        {
            "sha": "b0c1d5fa63d4d84522d95ff8fda064d5c40c9ae5",
            "filename": "doc/api/fs.md",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/19374fd25bac95c80e1eb877668f6b16affc36a2/doc%2Fapi%2Ffs.md",
            "raw_url": "https://github.com/nodejs/node/raw/19374fd25bac95c80e1eb877668f6b16affc36a2/doc%2Fapi%2Ffs.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ffs.md?ref=19374fd25bac95c80e1eb877668f6b16affc36a2",
            "patch": "@@ -1299,6 +1299,11 @@ fs.copyFileSync('source.txt', 'destination.txt', COPYFILE_EXCL);\n <!-- YAML\n added: v0.1.31\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19898\n+    description: Impose new restrictions on `start` and `end`, throwing\n+                 more appropriate errors in cases when we cannot reasonably\n+                 handle the input values.\n   - version: v7.6.0\n     pr-url: https://github.com/nodejs/node/pull/10739\n     description: The `path` parameter can be a WHATWG `URL` object using"
        },
        {
            "sha": "31e78e95ac35e6e10e13ca9f6fc84d91eb2fb0ba",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 38,
            "deletions": 17,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/19374fd25bac95c80e1eb877668f6b16affc36a2/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/19374fd25bac95c80e1eb877668f6b16affc36a2/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=19374fd25bac95c80e1eb877668f6b16affc36a2",
            "patch": "@@ -2031,30 +2031,51 @@ function ReadStream(path, options) {\n   this.closed = false;\n \n   if (this.start !== undefined) {\n-    if (typeof this.start !== 'number' || Number.isNaN(this.start)) {\n-      throw new ERR_INVALID_ARG_TYPE('start', 'number', this.start);\n-    }\n-    if (this.end === undefined) {\n-      this.end = Infinity;\n-    } else if (typeof this.end !== 'number' || Number.isNaN(this.end)) {\n-      throw new ERR_INVALID_ARG_TYPE('end', 'number', this.end);\n+    if (!Number.isSafeInteger(this.start)) {\n+      if (typeof this.start !== 'number')\n+        throw new ERR_INVALID_ARG_TYPE('start', 'number', this.start);\n+      if (!Number.isInteger(this.start))\n+        throw new ERR_OUT_OF_RANGE('start', 'an integer', this.start);\n+      throw new ERR_OUT_OF_RANGE(\n+        'start',\n+        '>= 0 and <= 2 ** 53 - 1',\n+        this.start\n+      );\n     }\n-\n-    if (this.start > this.end) {\n-      const errVal = `{start: ${this.start}, end: ${this.end}}`;\n-      throw new ERR_OUT_OF_RANGE('start', '<= \"end\"', errVal);\n+    if (this.start < 0) {\n+      throw new ERR_OUT_OF_RANGE(\n+        'start',\n+        '>= 0 and <= 2 ** 53 - 1',\n+        this.start\n+      );\n     }\n \n     this.pos = this.start;\n   }\n \n-  // Backwards compatibility: Make sure `end` is a number regardless of `start`.\n-  // TODO(addaleax): Make the above typecheck not depend on `start` instead.\n-  // (That is a semver-major change).\n-  if (typeof this.end !== 'number')\n+  if (this.end === undefined) {\n     this.end = Infinity;\n-  else if (Number.isNaN(this.end))\n-    throw new ERR_INVALID_ARG_TYPE('end', 'number', this.end);\n+  } else if (this.end !== Infinity) {\n+    if (!Number.isSafeInteger(this.end)) {\n+      if (typeof this.end !== 'number')\n+        throw new ERR_INVALID_ARG_TYPE('end', 'number', this.end);\n+      if (!Number.isInteger(this.end))\n+        throw new ERR_OUT_OF_RANGE('end', 'an integer', this.end);\n+      throw new ERR_OUT_OF_RANGE('end', '>= 0 and <= 2 ** 53 - 1', this.end);\n+    }\n+\n+    if (this.end < 0) {\n+      throw new ERR_OUT_OF_RANGE('end', '>= 0 and <= 2 ** 53 - 1', this.end);\n+    }\n+\n+    if (this.start !== undefined && this.start > this.end) {\n+      throw new ERR_OUT_OF_RANGE(\n+        'start',\n+        `<= \"end\" (here: ${this.end})`,\n+        this.start\n+      );\n+    }\n+  }\n \n   if (typeof this.fd !== 'number')\n     this.open();"
        },
        {
            "sha": "a081302cc5a0f136e207cf6c0041e9dc5f891951",
            "filename": "test/parallel/test-fs-read-stream-inherit.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream-inherit.js",
            "raw_url": "https://github.com/nodejs/node/raw/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream-inherit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-read-stream-inherit.js?ref=19374fd25bac95c80e1eb877668f6b16affc36a2",
            "patch": "@@ -110,8 +110,8 @@ const rangeFile = fixtures.path('x.txt');\n \n {\n   const message =\n-    'The value of \"start\" is out of range. It must be <= \"end\". ' +\n-    'Received {start: 10, end: 2}';\n+    'The value of \"start\" is out of range. It must be <= \"end\" (here: 2).' +\n+    ' Received 10';\n \n   common.expectsError(\n     () => {"
        },
        {
            "sha": "9886b3c9a46d97bc4f6e9d85cd709170bbe523f9",
            "filename": "test/parallel/test-fs-read-stream-throw-type-error.js",
            "status": "modified",
            "additions": 49,
            "deletions": 17,
            "changes": 66,
            "blob_url": "https://github.com/nodejs/node/blob/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream-throw-type-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream-throw-type-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-read-stream-throw-type-error.js?ref=19374fd25bac95c80e1eb877668f6b16affc36a2",
            "patch": "@@ -13,23 +13,55 @@ fs.createReadStream(example, null);\n fs.createReadStream(example, 'utf8');\n fs.createReadStream(example, { encoding: 'utf8' });\n \n-const createReadStreamErr = (path, opt) => {\n-  common.expectsError(\n-    () => {\n-      fs.createReadStream(path, opt);\n-    },\n-    {\n-      code: 'ERR_INVALID_ARG_TYPE',\n-      type: TypeError\n-    });\n+const createReadStreamErr = (path, opt, error) => {\n+  common.expectsError(() => {\n+    fs.createReadStream(path, opt);\n+  }, error);\n };\n \n-createReadStreamErr(example, 123);\n-createReadStreamErr(example, 0);\n-createReadStreamErr(example, true);\n-createReadStreamErr(example, false);\n+const typeError = {\n+  code: 'ERR_INVALID_ARG_TYPE',\n+  type: TypeError\n+};\n+\n+const rangeError = {\n+  code: 'ERR_OUT_OF_RANGE',\n+  type: RangeError\n+};\n+\n+[123, 0, true, false].forEach((opts) =>\n+  createReadStreamErr(example, opts, typeError)\n+);\n+\n+// Case 0: Should not throw if either start or end is undefined\n+[{}, { start: 0 }, { end: Infinity }].forEach((opts) =>\n+  fs.createReadStream(example, opts)\n+);\n+\n+// Case 1: Should throw TypeError if either start or end is not of type 'number'\n+[\n+  { start: 'invalid' },\n+  { end: 'invalid' },\n+  { start: 'invalid', end: 'invalid' }\n+].forEach((opts) => createReadStreamErr(example, opts, typeError));\n+\n+// Case 2: Should throw RangeError if either start or end is NaN\n+[{ start: NaN }, { end: NaN }, { start: NaN, end: NaN }].forEach((opts) =>\n+  createReadStreamErr(example, opts, rangeError)\n+);\n+\n+// Case 3: Should throw RangeError if either start or end is negative\n+[{ start: -1 }, { end: -1 }, { start: -1, end: -1 }].forEach((opts) =>\n+  createReadStreamErr(example, opts, rangeError)\n+);\n+\n+// Case 4: Should throw RangeError if either start or end is fractional\n+[{ start: 0.1 }, { end: 0.1 }, { start: 0.1, end: 0.1 }].forEach((opts) =>\n+  createReadStreamErr(example, opts, rangeError)\n+);\n+\n+// Case 5: Should not throw if both start and end are whole numbers\n+fs.createReadStream(example, { start: 1, end: 5 });\n \n-// createReadSteam _should_ throw on NaN\n-createReadStreamErr(example, { start: NaN });\n-createReadStreamErr(example, { end: NaN });\n-createReadStreamErr(example, { start: NaN, end: NaN });\n+// Case 6: Should throw RangeError if start is greater than end\n+createReadStreamErr(example, { start: 5, end: 1 }, rangeError);"
        },
        {
            "sha": "793b474c9b8292a5ae1d8553b48a36fc02021151",
            "filename": "test/parallel/test-fs-read-stream.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/19374fd25bac95c80e1eb877668f6b16affc36a2/test%2Fparallel%2Ftest-fs-read-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-read-stream.js?ref=19374fd25bac95c80e1eb877668f6b16affc36a2",
            "patch": "@@ -148,8 +148,8 @@ common.expectsError(\n   },\n   {\n     code: 'ERR_OUT_OF_RANGE',\n-    message: 'The value of \"start\" is out of range. It must be <= \"end\". ' +\n-             'Received {start: 10, end: 2}',\n+    message: 'The value of \"start\" is out of range. It must be <= \"end\"' +\n+             ' (here: 2). Received 10',\n     type: RangeError\n   });\n "
        }
    ],
    "stats": {
        "total": 134,
        "additions": 96,
        "deletions": 38
    }
}