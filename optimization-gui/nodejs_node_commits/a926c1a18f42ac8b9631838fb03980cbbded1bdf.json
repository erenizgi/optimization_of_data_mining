{
    "author": "trivikr",
    "message": "test: http2 compat response.write() error checks\n\nPR-URL: https://github.com/nodejs/node/pull/18859\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a926c1a18f42ac8b9631838fb03980cbbded1bdf",
    "files": [
        {
            "sha": "a62bb1b0ac78f126196a8b6bc844ad793e6351b8",
            "filename": "test/parallel/test-http2-compat-serverresponse-write-no-cb.js",
            "status": "removed",
            "additions": 0,
            "deletions": 95,
            "changes": 95,
            "blob_url": "https://github.com/nodejs/node/blob/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-compat-serverresponse-write-no-cb.js",
            "raw_url": "https://github.com/nodejs/node/raw/5782c51dfb729a1331e223e14ee3c9a5d0a19113/test%2Fparallel%2Ftest-http2-compat-serverresponse-write-no-cb.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-write-no-cb.js?ref=5782c51dfb729a1331e223e14ee3c9a5d0a19113",
            "patch": "@@ -1,95 +0,0 @@\n-'use strict';\n-\n-const { mustCall,\n-        mustNotCall,\n-        expectsError,\n-        hasCrypto, skip } = require('../common');\n-if (!hasCrypto)\n-  skip('missing crypto');\n-const { createServer, connect } = require('http2');\n-\n-// Http2ServerResponse.write does not imply there is a callback\n-\n-{\n-  const server = createServer();\n-  server.listen(0, mustCall(() => {\n-    const port = server.address().port;\n-    const url = `http://localhost:${port}`;\n-    const client = connect(url, mustCall(() => {\n-      const request = client.request();\n-      request.resume();\n-      request.on('end', mustCall());\n-      request.on('close', mustCall(() => {\n-        client.close();\n-      }));\n-    }));\n-\n-    server.once('request', mustCall((request, response) => {\n-      client.destroy();\n-      response.stream.session.on('close', mustCall(() => {\n-        response.on('error', mustNotCall());\n-        expectsError(\n-          () => { response.write('muahaha'); },\n-          {\n-            code: 'ERR_HTTP2_INVALID_STREAM'\n-          }\n-        );\n-        server.close();\n-      }));\n-    }));\n-  }));\n-}\n-\n-{\n-  const server = createServer();\n-  server.listen(0, mustCall(() => {\n-    const port = server.address().port;\n-    const url = `http://localhost:${port}`;\n-    const client = connect(url, mustCall(() => {\n-      const request = client.request();\n-      request.resume();\n-      request.on('end', mustCall());\n-      request.on('close', mustCall(() => client.close()));\n-    }));\n-\n-    server.once('request', mustCall((request, response) => {\n-      client.destroy();\n-      response.stream.session.on('close', mustCall(() => {\n-        expectsError(\n-          () => response.write('muahaha'),\n-          {\n-            code: 'ERR_HTTP2_INVALID_STREAM'\n-          }\n-        );\n-        server.close();\n-      }));\n-    }));\n-  }));\n-}\n-\n-{\n-  const server = createServer();\n-  server.listen(0, mustCall(() => {\n-    const port = server.address().port;\n-    const url = `http://localhost:${port}`;\n-    const client = connect(url, mustCall(() => {\n-      const request = client.request();\n-      request.resume();\n-      request.on('end', mustCall());\n-      request.on('close', mustCall(() => client.close()));\n-    }));\n-\n-    server.once('request', mustCall((request, response) => {\n-      response.stream.session.on('close', mustCall(() => {\n-        expectsError(\n-          () => response.write('muahaha', 'utf8'),\n-          {\n-            code: 'ERR_HTTP2_INVALID_STREAM'\n-          }\n-        );\n-        server.close();\n-      }));\n-      client.destroy();\n-    }));\n-  }));\n-}"
        },
        {
            "sha": "af3029835eaecbdc606be2e1b763b5a1d370b1ea",
            "filename": "test/parallel/test-http2-compat-serverresponse-write.js",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/a926c1a18f42ac8b9631838fb03980cbbded1bdf/test%2Fparallel%2Ftest-http2-compat-serverresponse-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/a926c1a18f42ac8b9631838fb03980cbbded1bdf/test%2Fparallel%2Ftest-http2-compat-serverresponse-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-write.js?ref=a926c1a18f42ac8b9631838fb03980cbbded1bdf",
            "patch": "@@ -0,0 +1,52 @@\n+'use strict';\n+\n+const {\n+  mustCall,\n+  mustNotCall,\n+  expectsError,\n+  hasCrypto,\n+  skip\n+} = require('../common');\n+if (!hasCrypto)\n+  skip('missing crypto');\n+const { createServer, connect } = require('http2');\n+const assert = require('assert');\n+\n+const server = createServer();\n+server.listen(0, mustCall(() => {\n+  const port = server.address().port;\n+  const url = `http://localhost:${port}`;\n+  const client = connect(url, mustCall(() => {\n+    const request = client.request();\n+    request.resume();\n+    request.on('end', mustCall());\n+    request.on('close', mustCall(() => {\n+      client.close();\n+    }));\n+  }));\n+\n+  server.once('request', mustCall((request, response) => {\n+    // response.write() returns true\n+    assert(response.write('muahaha', 'utf8', mustCall()));\n+\n+    response.stream.close(0, mustCall(() => {\n+      response.on('error', mustNotCall());\n+\n+      // response.write() without cb returns error\n+      expectsError(\n+        () => { response.write('muahaha'); },\n+        {\n+          type: Error,\n+          code: 'ERR_HTTP2_INVALID_STREAM',\n+          message: 'The stream has been destroyed'\n+        }\n+      );\n+\n+      // response.write() with cb returns falsy value\n+      assert(!response.write('muahaha', mustCall()));\n+\n+      client.destroy();\n+      server.close();\n+    }));\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 52,
        "deletions": 95
    }
}