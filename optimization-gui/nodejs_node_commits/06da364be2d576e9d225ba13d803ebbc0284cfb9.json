{
    "author": "addaleax",
    "message": "src: avoid race condition in tracing code\n\n`json_trace_writer_` is protected by `stream_mutex_`,\nbut one access to it was not guarded by a lock on said mutex.\n\nRefs: https://github.com/nodejs/node/issues/25512\n\nPR-URL: https://github.com/nodejs/node/pull/25624\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "06da364be2d576e9d225ba13d803ebbc0284cfb9",
    "files": [
        {
            "sha": "5979810668c5f52162558a1a403880260ed716bc",
            "filename": "src/tracing/node_trace_writer.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/06da364be2d576e9d225ba13d803ebbc0284cfb9/src%2Ftracing%2Fnode_trace_writer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/06da364be2d576e9d225ba13d803ebbc0284cfb9/src%2Ftracing%2Fnode_trace_writer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.cc?ref=06da364be2d576e9d225ba13d803ebbc0284cfb9",
            "patch": "@@ -138,8 +138,13 @@ void NodeTraceWriter::FlushPrivate() {\n \n void NodeTraceWriter::Flush(bool blocking) {\n   Mutex::ScopedLock scoped_lock(request_mutex_);\n-  if (!json_trace_writer_) {\n-    return;\n+  {\n+    // We need to lock the mutexes here in a nested fashion; stream_mutex_\n+    // protects json_trace_writer_, and without request_mutex_ there might be\n+    // a time window in which the stream state changes?\n+    Mutex::ScopedLock stream_mutex_lock(stream_mutex_);\n+    if (!json_trace_writer_)\n+      return;\n   }\n   int request_id = ++num_write_requests_;\n   int err = uv_async_send(&flush_signal_);"
        },
        {
            "sha": "f412587ab93219089f875c6a4f62636521ac4731",
            "filename": "src/tracing/node_trace_writer.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/06da364be2d576e9d225ba13d803ebbc0284cfb9/src%2Ftracing%2Fnode_trace_writer.h",
            "raw_url": "https://github.com/nodejs/node/raw/06da364be2d576e9d225ba13d803ebbc0284cfb9/src%2Ftracing%2Fnode_trace_writer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.h?ref=06da364be2d576e9d225ba13d803ebbc0284cfb9",
            "patch": "@@ -45,9 +45,11 @@ class NodeTraceWriter : public AsyncTraceWriter {\n   // Triggers callback to close async objects, ending the tracing thread.\n   uv_async_t exit_signal_;\n   // Prevents concurrent R/W on state related to serialized trace data\n-  // before it's written to disk, namely stream_ and total_traces_.\n+  // before it's written to disk, namely stream_ and total_traces_\n+  // as well as json_trace_writer_.\n   Mutex stream_mutex_;\n   // Prevents concurrent R/W on state related to write requests.\n+  // If both mutexes are locked, request_mutex_ has to be locked first.\n   Mutex request_mutex_;\n   // Allows blocking calls to Flush() to wait on a condition for\n   // trace events to be written to disk."
        }
    ],
    "stats": {
        "total": 13,
        "additions": 10,
        "deletions": 3
    }
}