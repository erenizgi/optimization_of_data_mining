{
    "author": "addaleax",
    "message": "worker: only stop inspector if started\n\nThis may fix some flakiness with tests that use `worker.terminate()`.\nIn particular, the following failure seems like it could be related\n(no consistent reproduction available, though):\n\n```\n15:30:14 not ok 187 parallel/test-heapdump-worker\n15:30:14   ---\n15:30:14   duration_ms: 2.499\n15:30:14   severity: fail\n15:30:14   exitcode: 134\n15:30:14   stack: |-\n15:30:14     npm[6904]: src\\inspector_agent.cc:729: Assertion `(client_) != nullptr' failed.\n```\n\nFrom https://ci.nodejs.org/job/node-test-binary-windows/20041/COMPILED_BY=vs2017,RUNNER=win2016,RUN_SUBSET=2/console\n\nRefs: https://github.com/nodejs/node/pull/22769\n\nPR-URL: https://github.com/nodejs/node/pull/22927\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>",
    "sha": "e6d0ced7bbe9f48aa1e4e30be8f88b1db0235a62",
    "files": [
        {
            "sha": "675c3e03a056e6e806c70fec594143af7d55902c",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/e6d0ced7bbe9f48aa1e4e30be8f88b1db0235a62/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e6d0ced7bbe9f48aa1e4e30be8f88b1db0235a62/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=e6d0ced7bbe9f48aa1e4e30be8f88b1db0235a62",
            "patch": "@@ -150,6 +150,7 @@ void Worker::Run() {\n       TRACE_STR_COPY(name.c_str()));\n   MultiIsolatePlatform* platform = isolate_data_->platform();\n   CHECK_NE(platform, nullptr);\n+  bool inspector_started = false;\n \n   Debug(this, \"Starting worker with id %llu\", thread_id_);\n   {\n@@ -177,6 +178,9 @@ void Worker::Run() {\n       }\n \n       if (!is_stopped()) {\n+        StartWorkerInspector(env_.get(), url_);\n+        inspector_started = true;\n+\n         HandleScope handle_scope(isolate_);\n         Environment::AsyncCallbackScope callback_scope(env_.get());\n         env_->async_hooks()->push_async_ids(1, 0);\n@@ -185,7 +189,6 @@ void Worker::Run() {\n         env_->async_hooks()->pop_async_id(1);\n \n         Debug(this, \"Loaded environment for worker %llu\", thread_id_);\n-        StartWorkerInspector(env_.get(), url_);\n       }\n \n       {\n@@ -246,7 +249,8 @@ void Worker::Run() {\n       env_->stop_sub_worker_contexts();\n       env_->RunCleanup();\n       RunAtExit(env_.get());\n-      WaitForWorkerInspectorToStop(env_.get());\n+      if (inspector_started)\n+        WaitForWorkerInspectorToStop(env_.get());\n \n       {\n         Mutex::ScopedLock stopped_lock(stopped_mutex_);"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 6,
        "deletions": 2
    }
}