{
    "author": "BridgeAR",
    "message": "test: remove common.globalCheck\n\nThis flag is partially used in tests where it was not necessary and\nit is always possible to replace this flag with\n`common.allowGlobals`. This makes sure all globals are truly tested\nfor.\n\nPR-URL: https://github.com/nodejs/node/pull/20717\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "becc3ec372baeef0a4b89923968d874010966c49",
    "files": [
        {
            "sha": "111ce45b00360ca9113320b07f977926ab566c9c",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -150,11 +150,6 @@ Attempts to get a valid TTY file descriptor. Returns `-1` if it fails.\n \n The TTY file descriptor is assumed to be capable of being writable.\n \n-### globalCheck\n-* [&lt;boolean>]\n-\n-Set to `false` if the test should not check for global leaks.\n-\n ### hasCrypto\n * [&lt;boolean>]\n "
        },
        {
            "sha": "85d11ec093414c8f2ad523d754ab79c0fee0b63a",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -366,21 +366,15 @@ function leakedGlobals() {\n }\n exports.leakedGlobals = leakedGlobals;\n \n-// Turn this off if the test should not check for global leaks.\n-exports.globalCheck = true;\n-\n process.on('exit', function() {\n-  if (!exports.globalCheck) return;\n   const leaked = leakedGlobals();\n   if (leaked.length > 0) {\n     assert.fail(`Unexpected global(s) found: ${leaked.join(', ')}`);\n   }\n });\n \n-\n const mustCallChecks = [];\n \n-\n function runCallChecks(exitCode) {\n   if (exitCode !== 0) return;\n "
        },
        {
            "sha": "b7ac556bca52c34a404f16cab56bc5bedc3b7104",
            "filename": "test/common/index.mjs",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2Findex.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fcommon%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.mjs?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -63,11 +63,7 @@ export function leakedGlobals() {\n   }\n }\n \n-// Turn this off if the test should not check for global leaks.\n-export let globalCheck = true;  // eslint-disable-line\n-\n process.on('exit', function() {\n-  if (!globalCheck) return;\n   const leaked = leakedGlobals();\n   if (leaked.length > 0) {\n     assert.fail(`Unexpected global(s) found: ${leaked.join(', ')}`);"
        },
        {
            "sha": "26ee6b888efb2d64d8260c648e3d37dd49967bf3",
            "filename": "test/parallel/test-domain-crypto.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-domain-crypto.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-domain-crypto.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-domain-crypto.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -29,7 +29,7 @@ if (!common.hasCrypto)\n const crypto = require('crypto');\n \n // Pollution of global is intentional as part of test.\n-common.globalCheck = false;\n+common.allowGlobals(require('domain'));\n // See https://github.com/nodejs/node/commit/d1eff9ab\n global.domain = require('domain');\n "
        },
        {
            "sha": "b139a6287488d2c730edf090ef336e463c3b5118",
            "filename": "test/parallel/test-global.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-global.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-global.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-global.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -28,7 +28,7 @@ const fixtures = require('../common/fixtures');\n \n const assert = require('assert');\n \n-common.globalCheck = false;\n+common.allowGlobals('bar', 'foo');\n \n baseFoo = 'foo'; // eslint-disable-line no-undef\n global.baseBar = 'bar';"
        },
        {
            "sha": "024dd971bf44e1c8d0ba535331df1b0bf3a8cb7b",
            "filename": "test/parallel/test-repl-autolibs.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-autolibs.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-autolibs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-autolibs.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -25,9 +25,6 @@ const assert = require('assert');\n const util = require('util');\n const repl = require('repl');\n \n-// This test adds global variables\n-common.globalCheck = false;\n-\n const putIn = new common.ArrayStream();\n repl.start('', putIn, null, true);\n \n@@ -65,6 +62,7 @@ function test2() {\n   };\n   const val = {};\n   global.url = val;\n+  common.allowGlobals(val);\n   assert(!gotWrite);\n   putIn.run(['url']);\n   assert(gotWrite);"
        },
        {
            "sha": "d6a45a664fa3b70cdd3ab0e307dbb70bad1d27ea",
            "filename": "test/parallel/test-repl-envvars.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-envvars.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-envvars.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-envvars.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -2,7 +2,7 @@\n \n // Flags: --expose-internals\n \n-const common = require('../common');\n+require('../common');\n const stream = require('stream');\n const REPL = require('internal/repl');\n const assert = require('assert');\n@@ -47,9 +47,6 @@ function run(test) {\n   REPL.createInternalRepl(env, opts, function(err, repl) {\n     assert.ifError(err);\n \n-    // The REPL registers 'module' and 'require' globals\n-    common.allowGlobals(repl.context.module, repl.context.require);\n-\n     assert.strictEqual(expected.terminal, repl.terminal,\n                        `Expected ${inspect(expected)} with ${inspect(env)}`);\n     assert.strictEqual(expected.useColors, repl.useColors,"
        },
        {
            "sha": "03ce1435d9ba4e4bccbf440de89c754948553516",
            "filename": "test/parallel/test-repl-history-perm.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-history-perm.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-history-perm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-history-perm.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -38,9 +38,6 @@ const replHistoryPath = path.join(tmpdir.path, '.node_repl_history');\n const checkResults = common.mustCall(function(err, r) {\n   assert.ifError(err);\n \n-  // The REPL registers 'module' and 'require' globals\n-  common.allowGlobals(r.context.module, r.context.require);\n-\n   r.input.end();\n   const stat = fs.statSync(replHistoryPath);\n   const fileMode = stat.mode & 0o777;"
        },
        {
            "sha": "bb10085eccfcf6fd812b8de5eb8fa3a1db481ed1",
            "filename": "test/parallel/test-repl-persistent-history.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-persistent-history.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-persistent-history.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-persistent-history.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -216,9 +216,6 @@ function runTest(assertCleaned) {\n       throw err;\n     }\n \n-    // The REPL registers 'module' and 'require' globals\n-    common.allowGlobals(repl.context.module, repl.context.require);\n-\n     repl.once('close', () => {\n       if (repl._flushing) {\n         repl.once('flushHistory', onClose);"
        },
        {
            "sha": "96d1d199af34c9ac6350fe583e025932bb432a07",
            "filename": "test/parallel/test-repl-reset-event.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-reset-event.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-reset-event.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-reset-event.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -26,6 +26,8 @@ const assert = require('assert');\n const repl = require('repl');\n const util = require('util');\n \n+common.allowGlobals(42);\n+\n // Create a dummy stream that does nothing\n const dummy = new common.ArrayStream();\n "
        },
        {
            "sha": "947adc7f255035882db5479c99d2b2a07a0188b2",
            "filename": "test/parallel/test-repl-use-global.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-use-global.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl-use-global.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-use-global.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -18,9 +18,6 @@ const globalTest = (useGlobal, cb, output) => (err, repl) => {\n   if (err)\n     return cb(err);\n \n-  // The REPL registers 'module' and 'require' globals\n-  common.allowGlobals(repl.context.module, repl.context.require);\n-\n   let str = '';\n   output.on('data', (data) => (str += data));\n   global.lunch = 'tacos';"
        },
        {
            "sha": "9aaf366c6807f0b1f1ee75696de89103679456bf",
            "filename": "test/parallel/test-repl.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-repl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -26,7 +26,6 @@ const assert = require('assert');\n const net = require('net');\n const repl = require('repl');\n \n-common.globalCheck = false;\n common.crashOnUnhandledRejection();\n \n const message = 'Read, Eval, Print Loop';\n@@ -41,7 +40,6 @@ global.invoke_me = function(arg) {\n   return `invoked ${arg}`;\n };\n \n-\n // Helpers for describing the expected output:\n const kArrow = /^ *\\^+ *$/;  // Arrow of ^ pointing to syntax error location\n const kSource = Symbol('kSource');  // Placeholder standing for input readback\n@@ -779,6 +777,7 @@ const tcpTests = [\n \n     socket.end();\n   }\n+  common.allowGlobals(...Object.values(global));\n })();\n \n function startTCPRepl() {"
        },
        {
            "sha": "80bf66d7f6b74f5d397038a2dfa33a9b2a393955",
            "filename": "test/parallel/test-require-deps-deprecation.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-require-deps-deprecation.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-require-deps-deprecation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-require-deps-deprecation.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -2,8 +2,6 @@\n \n const common = require('../common');\n const assert = require('assert');\n-// The v8 modules when imported leak globals. Disable global check.\n-common.globalCheck = false;\n \n const deprecatedModules = [\n   'node-inspect/lib/_inspect',\n@@ -53,3 +51,6 @@ for (const m of deps) {\n   }\n   assert.notStrictEqual(path, m);\n }\n+\n+// The V8 modules add the WebInspector to the globals.\n+common.allowGlobals(global.WebInspector);"
        },
        {
            "sha": "b0f52db1b713d35e4d554a9e63a2728e7feaeecd",
            "filename": "test/parallel/test-timer-immediate.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-timer-immediate.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-timer-immediate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timer-immediate.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -1,5 +1,5 @@\n 'use strict';\n const common = require('../common');\n-common.globalCheck = false;\n global.process = {};  // Boom!\n+common.allowGlobals(global.process);\n setImmediate(common.mustCall());"
        },
        {
            "sha": "2c0c21690e182161157bb7f6aba01227f4db443e",
            "filename": "test/parallel/test-vm-new-script-this-context.js",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-new-script-this-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-new-script-this-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-new-script-this-context.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -24,8 +24,6 @@ const common = require('../common');\n const assert = require('assert');\n const Script = require('vm').Script;\n \n-common.globalCheck = false;\n-\n // Run a string\n let script = new Script('\\'passed\\';');\n const result = script.runInThisContext(script);\n@@ -60,3 +58,11 @@ global.f = function() { global.foo = 100; };\n script = new Script('f()');\n script.runInThisContext(script);\n assert.strictEqual(100, global.foo);\n+\n+common.allowGlobals(\n+  global.hello,\n+  global.code,\n+  global.foo,\n+  global.obj,\n+  global.f\n+);"
        },
        {
            "sha": "e844cd6816bba30e68254a28c48223f1155f45b2",
            "filename": "test/parallel/test-vm-run-in-new-context.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-run-in-new-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-run-in-new-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-run-in-new-context.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -29,8 +29,6 @@ const vm = require('vm');\n assert.strictEqual(typeof global.gc, 'function',\n                    'Run this test with --expose-gc');\n \n-common.globalCheck = false;\n-\n // Run a string\n const result = vm.runInNewContext('\\'passed\\';');\n assert.strictEqual(result, 'passed');\n@@ -93,3 +91,10 @@ fn();\n     return true;\n   });\n }\n+\n+common.allowGlobals(\n+  global.hello,\n+  global.code,\n+  global.foo,\n+  global.obj\n+);"
        },
        {
            "sha": "d4530604dc06f0886f01f4a5ddf632dab526d508",
            "filename": "test/parallel/test-vm-static-this.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-static-this.js",
            "raw_url": "https://github.com/nodejs/node/raw/becc3ec372baeef0a4b89923968d874010966c49/test%2Fparallel%2Ftest-vm-static-this.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-static-this.js?ref=becc3ec372baeef0a4b89923968d874010966c49",
            "patch": "@@ -24,8 +24,6 @@ const common = require('../common');\n const assert = require('assert');\n const vm = require('vm');\n \n-common.globalCheck = false;\n-\n // Run a string\n const result = vm.runInThisContext('\\'passed\\';');\n assert.strictEqual('passed', result);\n@@ -58,3 +56,10 @@ assert.strictEqual(1, global.foo);\n global.f = function() { global.foo = 100; };\n vm.runInThisContext('f()');\n assert.strictEqual(100, global.foo);\n+\n+common.allowGlobals(\n+  global.hello,\n+  global.foo,\n+  global.obj,\n+  global.f\n+);"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 33,
        "deletions": 44
    }
}