{
    "author": "yhwang",
    "message": "crypto: allocate more memory for cipher.update()\n\nFor key wrapping algorithms, calling EVP_CipherUpdate() with null output\ncould obtain the size for the ciphertext. Then use the returned size to\nallocate output buffer. Also add a test case to verify des3-wrap.\n\nSigned-off-by: Yihong Wang <yh.wang@ibm.com>\n\nPR-URL: https://github.com/nodejs/node/pull/20370\nFixes: https://github.com/nodejs/node/issues/19655\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "f7cdeba5486ac6c36bee59580832994aadfd264a",
    "files": [
        {
            "sha": "9dfe0ca43c2c5ba95714606bc81c5f19d8436a1e",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/f7cdeba5486ac6c36bee59580832994aadfd264a/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7cdeba5486ac6c36bee59580832994aadfd264a/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=f7cdeba5486ac6c36bee59580832994aadfd264a",
            "patch": "@@ -3023,14 +3023,28 @@ CipherBase::UpdateResult CipherBase::Update(const char* data,\n     auth_tag_set_ = true;\n   }\n \n-  *out_len = len + EVP_CIPHER_CTX_block_size(ctx_);\n-  *out = Malloc<unsigned char>(static_cast<size_t>(*out_len));\n+  *out_len = 0;\n+  int buff_len = len + EVP_CIPHER_CTX_block_size(ctx_);\n+  // For key wrapping algorithms, get output size by calling\n+  // EVP_CipherUpdate() with null output.\n+  if (mode == EVP_CIPH_WRAP_MODE &&\n+      EVP_CipherUpdate(ctx_,\n+                       nullptr,\n+                       &buff_len,\n+                       reinterpret_cast<const unsigned char*>(data),\n+                       len) != 1) {\n+    return kErrorState;\n+  }\n+\n+  *out = Malloc<unsigned char>(buff_len);\n   int r = EVP_CipherUpdate(ctx_,\n                            *out,\n                            out_len,\n                            reinterpret_cast<const unsigned char*>(data),\n                            len);\n \n+  CHECK_LE(*out_len, buff_len);\n+\n   // When in CCM mode, EVP_CipherUpdate will fail if the authentication tag is\n   // invalid. In that case, remember the error and throw in final().\n   if (!r && kind_ == kDecipher && mode == EVP_CIPH_CCM_MODE) {"
        },
        {
            "sha": "75c8cd574fd6626c1d8fcc72016837108c3609ab",
            "filename": "test/parallel/test-crypto-des3-wrap.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/f7cdeba5486ac6c36bee59580832994aadfd264a/test%2Fparallel%2Ftest-crypto-des3-wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7cdeba5486ac6c36bee59580832994aadfd264a/test%2Fparallel%2Ftest-crypto-des3-wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-des3-wrap.js?ref=f7cdeba5486ac6c36bee59580832994aadfd264a",
            "patch": "@@ -0,0 +1,25 @@\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const crypto = require('crypto');\n+\n+// Test case for des-ede3 wrap/unwrap. des3-wrap needs extra 2x blocksize\n+// then plaintext to store ciphertext.\n+const test = {\n+  key: Buffer.from('3c08e25be22352910671cfe4ba3652b1220a8a7769b490ba', 'hex'),\n+  iv: Buffer.alloc(0),\n+  plaintext: '32|RmVZZkFUVmpRRkp0TmJaUm56ZU9qcnJkaXNNWVNpTTU*|iXmckfRWZBG' +\n+    'WWELweCBsThSsfUHLeRe0KCsK8ooHgxie0zOINpXxfZi/oNG7uq9JWFVCk70gfzQH8ZU' +\n+    'JjAfaFg**'\n+};\n+\n+const cipher = crypto.createCipheriv('des3-wrap', test.key, test.iv);\n+const ciphertext = cipher.update(test.plaintext, 'utf8');\n+\n+const decipher = crypto.createDecipheriv('des3-wrap', test.key, test.iv);\n+const msg = decipher.update(ciphertext, 'buffer', 'utf8');\n+\n+assert.strictEqual(msg, test.plaintext);"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 41,
        "deletions": 2
    }
}