{
    "author": "joyeecheung",
    "message": "build: speed up startup with V8 code cache\n\nThis patch speeds up the startup time and reduce the startup memory\nfootprint by using V8 code cache when comiling builtin modules.\n\nThe current approach is demonstrated in the `with-code-cache`\nMakefile target (no corresponding Windows target at the moment).\n\n1. Build the binary normally (`src/node_code_cache_stub.cc` is used),\n  by now `internalBinding('code_cache')` is an empty object\n2. Run `tools/generate_code_cache.js` with the binary, which generates\n  the code caches by reading source code of builtin modules off source\n  code exposed by `require('internal/bootstrap/cache').builtinSource`\n  and then generate a C++ file containing static char arrays of the\n  code cache, using a format similar to `node_javascript.cc`\n3. Run `configure` with the `--code-cache-path` option so that\n  the newly generated C++ file will be used when compiling the\n  new binary. The generated C++ file will put the cache into\n  the `internalBinding('code_cache')` object with the module\n  ids as keys\n4. The new binary tries to read the code cache from\n  `internalBinding('code_cache')` and use it to compile\n  builtin modules. If the cache is used, it will put the id\n  into `require('internal/bootstrap/cache').compiledWithCache`\n  for bookkeeping, otherwise the id will be pushed into\n  `require('internal/bootstrap/cache').compiledWithoutCache`\n\nThis patch also added tests that verify the code cache is\ngenerated and used when compiling builtin modules.\n\nThe binary with code cache:\n\n- Is ~1MB bigger than the binary without code cahe\n- Consumes ~1MB less memory during start up\n- Starts up about 60% faster\n\nPR-URL: https://github.com/nodejs/node/pull/21405\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "4750ce26f2e6079b5fee92bdee5356c279171d22",
    "files": [
        {
            "sha": "99e89692213e8e0b21093257dcbfc1e67d48e19f",
            "filename": "Makefile",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -91,6 +91,22 @@ $(NODE_G_EXE): config.gypi out/Makefile\n \t$(MAKE) -C out BUILDTYPE=Debug V=$(V)\n \tif [ ! -r $@ -o ! -L $@ ]; then ln -fs out/Debug/$(NODE_EXE) $@; fi\n \n+CODE_CACHE_DIR ?= out/$(BUILDTYPE)/obj/gen\n+CODE_CACHE_FILE ?= $(CODE_CACHE_DIR)/node_code_cache.cc\n+\n+.PHONY: with-code-cache\n+with-code-cache:\n+\t$(PYTHON) ./configure\n+\t$(MAKE)\n+\tmkdir -p $(CODE_CACHE_DIR)\n+\tout/$(BUILDTYPE)/$(NODE_EXE) --expose-internals tools/generate_code_cache.js $(CODE_CACHE_FILE)\n+\t$(PYTHON) ./configure --code-cache-path $(CODE_CACHE_FILE)\n+\t$(MAKE)\n+\n+.PHONY: test-code-cache\n+test-code-cache: with-code-cache\n+\t$(PYTHON) tools/test.py $(PARALLEL_ARGS) --mode=$(BUILDTYPE_LOWER) code-cache\n+\n out/Makefile: common.gypi deps/uv/uv.gyp deps/http_parser/http_parser.gyp \\\n               deps/zlib/zlib.gyp deps/v8/gypfiles/toolchain.gypi \\\n               deps/v8/gypfiles/features.gypi deps/v8/gypfiles/v8.gyp node.gyp \\"
        },
        {
            "sha": "efb92701e2606ff3ac392c9e481613557b68d7ad",
            "filename": "configure",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/configure",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -491,6 +491,12 @@ parser.add_option('--without-snapshot',\n     dest='without_snapshot',\n     help=optparse.SUPPRESS_HELP)\n \n+parser.add_option('--code-cache-path',\n+    action='store',\n+    dest='code_cache_path',\n+    help='Use a file generated by tools/generate_code_cache.js to compile the'\n+         ' code cache for builtin modules into the binary')\n+\n parser.add_option('--without-ssl',\n     action='store_true',\n     dest='without_ssl',\n@@ -983,6 +989,8 @@ def configure_node(o):\n     o['variables']['debug_nghttp2'] = 'false'\n \n   o['variables']['node_no_browser_globals'] = b(options.no_browser_globals)\n+  if options.code_cache_path:\n+    o['variables']['node_code_cache_path'] = options.code_cache_path\n   o['variables']['node_shared'] = b(options.shared)\n   node_module_version = getmoduleversion.get_version()\n "
        },
        {
            "sha": "a3d22ba020979e8b2c287b5d254a562a3b1b90ac",
            "filename": "lib/internal/bootstrap/cache.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fcache.js?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+// This is only exposed for internal build steps and testing purposes.\n+// We create new copies of the source and the code cache\n+// so the resources eventually used to compile builtin modules\n+// cannot be tampered with even with --expose-internals\n+\n+const {\n+  NativeModule, internalBinding\n+} = require('internal/bootstrap/loaders');\n+\n+module.exports = {\n+  builtinSource: Object.assign({}, NativeModule._source),\n+  codeCache: internalBinding('code_cache'),\n+  compiledWithoutCache: NativeModule.compiledWithoutCache,\n+  compiledWithCache: NativeModule.compiledWithCache,\n+  nativeModuleWrap(script) {\n+    return NativeModule.wrap(script);\n+  },\n+  // Modules with source code compiled in js2c that\n+  // cannot be compiled with the code cache\n+  cannotUseCache: [\n+    'config',\n+    // TODO(joyeecheung): update the C++ side so that\n+    // the code cache is also used when compiling these\n+    // two files.\n+    'internal/bootstrap/loaders',\n+    'internal/bootstrap/node'\n+  ]\n+};"
        },
        {
            "sha": "c141c9adcff9b2c73b249e45f235d7f320307ec3",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -125,10 +125,15 @@\n \n   const config = getBinding('config');\n \n+  const codeCache = getInternalBinding('code_cache');\n+  const compiledWithoutCache = NativeModule.compiledWithoutCache = [];\n+  const compiledWithCache = NativeModule.compiledWithCache = [];\n+\n   // Think of this as module.exports in this file even though it is not\n   // written in CommonJS style.\n   const loaderExports = { internalBinding, NativeModule };\n   const loaderId = 'internal/bootstrap/loaders';\n+\n   NativeModule.require = function(id) {\n     if (id === loaderId) {\n       return loaderExports;\n@@ -229,7 +234,29 @@\n     this.loading = true;\n \n     try {\n-      const script = new ContextifyScript(source, this.filename);\n+      // (code, filename, lineOffset, columnOffset\n+      // cachedData, produceCachedData, parsingContext)\n+      const script = new ContextifyScript(\n+        source, this.filename, 0, 0,\n+        codeCache[this.id], false, undefined\n+      );\n+\n+      // One of these conditions may be false when any of the inputs\n+      // of the `node_js2c` target in node.gyp is modified.\n+      // FIXME(joyeecheung):\n+      // 1. Figure out how to resolve the dependency issue. When the\n+      //    code cache was introduced we were at a point where refactoring\n+      //    node.gyp may not be worth the effort.\n+      // 2. Calculate checksums in both js2c and generate_code_cache.js\n+      //    and compare them before compiling the native modules since\n+      //    V8 only checks the length of the source to decide whether to\n+      //    reject the cache.\n+      if (!codeCache[this.id] || script.cachedDataRejected) {\n+        compiledWithoutCache.push(this.id);\n+      } else {\n+        compiledWithCache.push(this.id);\n+      }\n+\n       // Arguments: timeout, displayErrors, breakOnSigint\n       const fn = script.runInThisContext(-1, true, false);\n       const requireFn = this.id.startsWith('internal/deps/') ?"
        },
        {
            "sha": "f11b022e6790e044654570d7fdef940c4e90bc6e",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -6,6 +6,7 @@\n     'node_use_etw%': 'false',\n     'node_use_perfctr%': 'false',\n     'node_no_browser_globals%': 'false',\n+    'node_code_cache_path%': '',\n     'node_use_v8_platform%': 'true',\n     'node_use_bundled_v8%': 'true',\n     'node_shared%': 'false',\n@@ -24,6 +25,7 @@\n     'node_lib_target_name%': 'node_lib',\n     'node_intermediate_lib_type%': 'static_library',\n     'library_files': [\n+      'lib/internal/bootstrap/cache.js',\n       'lib/internal/bootstrap/loaders.js',\n       'lib/internal/bootstrap/node.js',\n       'lib/async_hooks.js',\n@@ -396,6 +398,7 @@\n         'src/module_wrap.h',\n         'src/node.h',\n         'src/node_buffer.h',\n+        'src/node_code_cache.h',\n         'src/node_constants.h',\n         'src/node_contextify.h',\n         'src/node_debug_options.h',\n@@ -459,6 +462,11 @@\n         'NODE_OPENSSL_SYSTEM_CERT_PATH=\"<(openssl_system_ca_path)\"',\n       ],\n       'conditions': [\n+        [ 'node_code_cache_path!=\"\"', {\n+          'sources': [ '<(node_code_cache_path)' ]\n+        }, {\n+          'sources': [ 'src/node_code_cache_stub.cc' ]\n+        }],\n         [ 'node_shared==\"true\" and node_module_version!=\"\" and OS!=\"win\"', {\n           'product_extension': '<(shlib_suffix)',\n           'xcode_settings': {"
        },
        {
            "sha": "acc5ab3a1e78e9b28fb7b7c84ee44356a24c4d4f",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -22,6 +22,7 @@\n #include \"node_buffer.h\"\n #include \"node_constants.h\"\n #include \"node_javascript.h\"\n+#include \"node_code_cache.h\"\n #include \"node_platform.h\"\n #include \"node_version.h\"\n #include \"node_internals.h\"\n@@ -1596,10 +1597,18 @@ static void GetInternalBinding(const FunctionCallbackInfo<Value>& args) {\n \n   Local<String> module = args[0].As<String>();\n   node::Utf8Value module_v(env->isolate(), module);\n+  Local<Object> exports;\n \n   node_module* mod = get_internal_module(*module_v);\n-  if (mod == nullptr) return ThrowIfNoSuchModule(env, *module_v);\n-  Local<Object> exports = InitModule(env, mod, module);\n+  if (mod != nullptr) {\n+    exports = InitModule(env, mod, module);\n+  } else if (!strcmp(*module_v, \"code_cache\")) {\n+    // internalBinding('code_cache')\n+    exports = Object::New(env->isolate());\n+    DefineCodeCache(env, exports);\n+  } else {\n+    return ThrowIfNoSuchModule(env, *module_v);\n+  }\n \n   args.GetReturnValue().Set(exports);\n }"
        },
        {
            "sha": "d4775a2b65e0225eaac1df019e187ca0547fe0a2",
            "filename": "src/node_code_cache.h",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode_code_cache.h",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode_code_cache.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_code_cache.h?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,16 @@\n+#ifndef SRC_NODE_CODE_CACHE_H_\n+#define SRC_NODE_CODE_CACHE_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include \"node_internals.h\"\n+\n+namespace node {\n+\n+void DefineCodeCache(Environment* env, v8::Local<v8::Object> target);\n+\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#endif  // SRC_NODE_CODE_CACHE_H_"
        },
        {
            "sha": "3e9e5960c1bebe3004f051e6a872b2760edc6e64",
            "filename": "src/node_code_cache_stub.cc",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode_code_cache_stub.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/src%2Fnode_code_cache_stub.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_code_cache_stub.cc?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,14 @@\n+\n+#include \"node_code_cache.h\"\n+\n+// This is supposed to be generated by tools/generate_code_cache.js\n+// The stub here is used when configure is run without `--code-cache-path`\n+\n+namespace node {\n+void DefineCodeCache(Environment* env, v8::Local<v8::Object> target) {\n+  // When we do not produce code cache for builtin modules,\n+  // `internalBinding('code_cache')` returns an empty object\n+  // (here as `target`) so this is a noop.\n+}\n+\n+}  // namespace node"
        },
        {
            "sha": "26eb66ea2d1d2c1585401d7297e85d1ca351a556",
            "filename": "test/code-cache/code-cache.status",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Fcode-cache.status",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Fcode-cache.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Fcode-cache.status?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,21 @@\n+prefix code-cache\n+\n+# To mark a test as flaky, list the test name in the appropriate section\n+# below, without \".js\", followed by \": PASS,FLAKY\". Example:\n+# sample-test                        : PASS,FLAKY\n+\n+[true] # This section applies to all platforms\n+\n+[$system==win32]\n+\n+[$system==linux]\n+\n+[$system==macos]\n+\n+[$arch==arm || $arch==arm64]\n+\n+[$system==solaris] # Also applies to SmartOS\n+\n+[$system==freebsd]\n+\n+[$system==aix]"
        },
        {
            "sha": "a4378343010ee61382dd31a1c6370b5529bbcf0a",
            "filename": "test/code-cache/test-code-cache.js",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Ftest-code-cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Ftest-code-cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache.js?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,42 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+// This test verifies that the binary is compiled with code cache and the\n+// cache is used when built in modules are compiled.\n+\n+require('../common');\n+const assert = require('assert');\n+const {\n+  types: {\n+    isUint8Array\n+  }\n+} = require('util');\n+const {\n+  builtinSource,\n+  codeCache,\n+  cannotUseCache,\n+  compiledWithCache,\n+  compiledWithoutCache\n+} = require('internal/bootstrap/cache');\n+\n+assert.strictEqual(\n+  typeof process.config.variables.node_code_cache_path,\n+  'string'\n+);\n+\n+assert.deepStrictEqual(compiledWithoutCache, []);\n+\n+const loadedModules = process.moduleLoadList\n+  .filter((m) => m.startsWith('NativeModule'))\n+  .map((m) => m.replace('NativeModule ', ''));\n+\n+for (const key of loadedModules) {\n+  assert(compiledWithCache.includes(key),\n+         `\"${key}\" should've been compiled with code cache`);\n+}\n+\n+for (const key of Object.keys(builtinSource)) {\n+  if (cannotUseCache.includes(key)) continue;\n+  assert(isUint8Array(codeCache[key]) && codeCache[key].length > 0,\n+         `Code cache for \"${key}\" should've been generated`);\n+}"
        },
        {
            "sha": "0e0035dfed477b5964e1786e5bfcdb8f288dc004",
            "filename": "test/code-cache/testcfg.py",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Ftestcfg.py",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/test%2Fcode-cache%2Ftestcfg.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftestcfg.py?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,6 @@\n+import sys, os\n+sys.path.append(os.path.join(os.path.dirname(__file__), '..'))\n+import testpy\n+\n+def GetConfiguration(context, root):\n+  return testpy.ParallelTestConfiguration(context, root, 'code-cache')"
        },
        {
            "sha": "8aab6bc286d288ecc1da67d0d67663ea3d933b34",
            "filename": "tools/generate_code_cache.js",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/tools%2Fgenerate_code_cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/tools%2Fgenerate_code_cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fgenerate_code_cache.js?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -0,0 +1,124 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+\n+// This file generates the code cache for builtin modules and\n+// writes them into static char arrays of a C++ file that can be\n+// compiled into the binary using the `--code-cache-path` option\n+// of `configure`.\n+\n+const {\n+  nativeModuleWrap,\n+  builtinSource,\n+  cannotUseCache\n+} = require('internal/bootstrap/cache');\n+\n+const vm = require('vm');\n+const fs = require('fs');\n+\n+const resultPath = process.argv[2];\n+if (!resultPath) {\n+  console.error(`Usage: ${process.argv[0]} ${process.argv[1]}` +\n+                'path/to/node_code_cache.cc');\n+  process.exit(1);\n+}\n+\n+/**\n+ * Format a number of a size in bytes into human-readable strings\n+ * @param {number} num\n+ * @return {string}\n+ */\n+function formatSize(num) {\n+  if (num < 1024) {\n+    return `${(num).toFixed(2)}B`;\n+  } else if (num < 1024 ** 2) {\n+    return `${(num / 1024).toFixed(2)}KB`;\n+  } else if (num < 1024 ** 3) {\n+    return `${(num / (1024 ** 2)).toFixed(2)}MB`;\n+  } else {\n+    return `${(num / (1024 ** 3)).toFixed(2)}GB`;\n+  }\n+}\n+\n+/**\n+ * Generates the source code of definitions of the char arrays\n+ * that contains the code cache and the source code of the\n+ * initializers of the code cache.\n+ *\n+ * @param {string} key ID of the builtin module\n+ * @param {Buffer} cache Code cache of the builtin module\n+ * @return { definition: string, initializer: string }\n+ */\n+function getInitalizer(key, cache) {\n+  const defName = key.replace(/\\//g, '_').replace(/-/g, '_');\n+  const definition = `static uint8_t ${defName}_raw[] = {\\n` +\n+                     `${cache.join(',')}\\n};`;\n+  const initializer = `\n+  v8::Local<v8::ArrayBuffer> ${defName}_ab =\n+    v8::ArrayBuffer::New(isolate, ${defName}_raw, ${cache.length});\n+  v8::Local<v8::Uint8Array> ${defName}_array =\n+    v8::Uint8Array::New(${defName}_ab, 0, ${cache.length});\n+  target->Set(context,\n+              FIXED_ONE_BYTE_STRING(isolate, \"${key}\"),\n+              ${defName}_array).FromJust();\n+  `;\n+  return {\n+    definition, initializer\n+  };\n+}\n+\n+const cacheDefinitions = [];\n+const cacheInitializers = [];\n+let totalCacheSize = 0;\n+\n+\n+for (const key of Object.keys(builtinSource)) {\n+  if (cannotUseCache.includes(key)) continue;\n+  const code = nativeModuleWrap(builtinSource[key]);\n+\n+  // Note that this must corresponds to the code in\n+  // NativeModule.prototype.compile\n+  const script = new vm.Script(code, {\n+    filename: `${key}.js`,\n+    produceCachedData: true\n+  });\n+\n+  if (!script.cachedData) {\n+    console.error(`Failed to generate code cache for '${key}'`);\n+    process.exit(1);\n+  }\n+\n+  const length = script.cachedData.length;\n+  totalCacheSize += length;\n+  const { definition, initializer } = getInitalizer(key, script.cachedData);\n+  cacheDefinitions.push(definition);\n+  cacheInitializers.push(initializer);\n+  console.log(`Generated cache for '${key}', size = ${formatSize(length)}` +\n+              `, total = ${formatSize(totalCacheSize)}`);\n+}\n+\n+const result = `#include \"node.h\"\n+#include \"node_code_cache.h\"\n+#include \"v8.h\"\n+#include \"env.h\"\n+#include \"env-inl.h\"\n+\n+// This file is generated by tools/generate_code_cache.js\n+// and is used when configure is run with \\`--code-cache-path\\`\n+\n+namespace node {\n+\n+${cacheDefinitions.join('\\n\\n')}\n+\n+// The target here will be returned as \\`internalBinding('code_cache')\\`\n+void DefineCodeCache(Environment* env, v8::Local<v8::Object> target) {\n+  v8::Isolate* isolate = env->isolate();\n+  v8::Local<v8::Context> context = env->context();\n+  ${cacheInitializers.join('\\n')}\n+}\n+\n+}  // namespace node\n+`;\n+\n+fs.writeFileSync(resultPath, result);\n+console.log(`Generated code cache C++ file to ${resultPath}`);"
        },
        {
            "sha": "c963196c69a5f3fb5781c7620ba2face6f2fb8c2",
            "filename": "tools/test.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4750ce26f2e6079b5fee92bdee5356c279171d22/tools%2Ftest.py",
            "raw_url": "https://github.com/nodejs/node/raw/4750ce26f2e6079b5fee92bdee5356c279171d22/tools%2Ftest.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Ftest.py?ref=4750ce26f2e6079b5fee92bdee5356c279171d22",
            "patch": "@@ -1549,6 +1549,7 @@ def PrintCrashed(code):\n IGNORED_SUITES = [\n   'addons',\n   'addons-napi',\n+  'code-cache',\n   'doctool',\n   'gc',\n   'internet',"
        }
    ],
    "stats": {
        "total": 328,
        "additions": 325,
        "deletions": 3
    }
}