{
    "author": "joyeecheung",
    "message": "src: move more process methods initialization in bootstrap/node.js\n\nInstead of:\n\n- Writing methods onto the process directly in C++ during\n  `SetupProcessObject()` and overwrite with argument checks later\n- Or, wrapping and writing them in `internal/process/*.js`\n\nDo:\n\n- Move the C++ implementations in node_process.cc and mark them static\n  wherever possible\n- Expose the C++ methods through a new\n  `internalBinding('process_methods')`\n- Wrap the methods in `internal/process/*.js` in a\n  side-effect-free manner and return them back to\n  `internal/bootstrap/node.js`\n- Centralize the write to the process object based on conditions\n  in `bootstrap/node.js`\n\nSo it's easier to see what methods are attached to the process object\nduring bootstrap under what condition and in what order.\n\nThe eventual goal is to figure out the dependency of process methods\nand the write/read access to the process object during bootstrap, group\nthese access properly and remove the process properties that should not\nbe exposed to users this way.\n\nAlso correct the NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE milestone\nwhich should be marked before code execution.\n\nRefs: https://github.com/nodejs/node/issues/24961\n\nPR-URL: https://github.com/nodejs/node/pull/25127\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
    "files": [
        {
            "sha": "c375374164138706f8fed198aef1f107fe4cd878",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 77,
            "deletions": 23,
            "changes": 100,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -20,11 +20,7 @@\n const {\n   _setupTraceCategoryState,\n   _setupNextTick,\n-  _setupPromises, _chdir, _cpuUsage,\n-  _hrtime, _hrtimeBigInt,\n-  _memoryUsage, _rawDebug,\n-  _umask,\n-  _shouldAbortOnUncaughtToggle\n+  _setupPromises\n } = bootstrappers;\n const { internalBinding, NativeModule } = loaderExports;\n \n@@ -57,15 +53,57 @@ function startup() {\n     );\n   }\n \n-  perThreadSetup.setupAssert();\n-  perThreadSetup.setupConfig();\n+  // process.config is serialized config.gypi\n+  process.config = JSON.parse(internalBinding('native_module').config);\n \n+  const rawMethods = internalBinding('process_methods');\n+  // Set up methods and events on the process object for the main thread\n   if (isMainThread) {\n+    // This depends on process being an event emitter\n     mainThreadSetup.setupSignalHandlers(internalBinding);\n+\n+    process.abort = rawMethods.abort;\n+    const wrapped = mainThreadSetup.wrapProcessMethods(rawMethods);\n+    process.umask = wrapped.umask;\n+    process.chdir = wrapped.chdir;\n+\n+    // TODO(joyeecheung): deprecate and remove these underscore methods\n+    process._debugProcess = rawMethods._debugProcess;\n+    process._debugEnd = rawMethods._debugEnd;\n+    process._startProfilerIdleNotifier =\n+      rawMethods._startProfilerIdleNotifier;\n+    process._stopProfilerIdleNotifier = rawMethods._stopProfilerIdleNotifier;\n   }\n \n-  perThreadSetup.setupUncaughtExceptionCapture(exceptionHandlerState,\n-                                               _shouldAbortOnUncaughtToggle);\n+  // Set up methods on the process object for all threads\n+  {\n+    process.cwd = rawMethods.cwd;\n+    process.dlopen = rawMethods.dlopen;\n+    process.uptime = rawMethods.uptime;\n+\n+    // TODO(joyeecheung): either remove them or make them public\n+    process._getActiveRequests = rawMethods._getActiveRequests;\n+    process._getActiveHandles = rawMethods._getActiveHandles;\n+\n+    // TODO(joyeecheung): remove these\n+    process.reallyExit = rawMethods.reallyExit;\n+    process._kill = rawMethods._kill;\n+\n+    const wrapped = perThreadSetup.wrapProcessMethods(\n+      rawMethods, exceptionHandlerState\n+    );\n+    process._rawDebug = wrapped._rawDebug;\n+    process.hrtime = wrapped.hrtime;\n+    process.hrtime.bigint = wrapped.hrtimeBigInt;\n+    process.cpuUsage = wrapped.cpuUsage;\n+    process.memoryUsage = wrapped.memoryUsage;\n+    process.kill = wrapped.kill;\n+    process.exit = wrapped.exit;\n+    process.setUncaughtExceptionCaptureCallback =\n+      wrapped.setUncaughtExceptionCaptureCallback;\n+    process.hasUncaughtExceptionCaptureCallback =\n+      wrapped.hasUncaughtExceptionCaptureCallback;\n+  }\n \n   NativeModule.require('internal/process/warning').setup();\n   NativeModule.require('internal/process/next_tick').setup(_setupNextTick,\n@@ -91,22 +129,10 @@ function startup() {\n \n   if (isMainThread) {\n     mainThreadSetup.setupStdio();\n-    mainThreadSetup.setupProcessMethods(_chdir, _umask);\n   } else {\n     workerThreadSetup.setupStdio();\n   }\n \n-  const perf = internalBinding('performance');\n-  const {\n-    NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,\n-  } = perf.constants;\n-\n-  perThreadSetup.setupRawDebug(_rawDebug);\n-  perThreadSetup.setupHrtime(_hrtime, _hrtimeBigInt);\n-  perThreadSetup.setupCpuUsage(_cpuUsage);\n-  perThreadSetup.setupMemoryUsage(_memoryUsage);\n-  perThreadSetup.setupKillAndExit();\n-\n   if (global.__coverage__)\n     NativeModule.require('internal/process/write-coverage').setup();\n \n@@ -209,9 +235,37 @@ function startup() {\n     }\n   }\n \n-  perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n+  // process.allowedNodeEnvironmentFlags\n+  Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n+    get() {\n+      const flags = perThreadSetup.buildAllowedFlags();\n+      process.allowedNodeEnvironmentFlags = flags;\n+      return process.allowedNodeEnvironmentFlags;\n+    },\n+    // If the user tries to set this to another value, override\n+    // this completely to that value.\n+    set(value) {\n+      Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n+        value,\n+        configurable: true,\n+        enumerable: true,\n+        writable: true\n+      });\n+    },\n+    enumerable: true,\n+    configurable: true\n+  });\n+  // process.assert\n+  process.assert = deprecate(\n+    perThreadSetup.assert,\n+    'process.assert() is deprecated. Please use the `assert` module instead.',\n+    'DEP0100');\n \n-  perThreadSetup.setupAllowedFlags();\n+  const perf = internalBinding('performance');\n+  const {\n+    NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE,\n+  } = perf.constants;\n+  perf.markMilestone(NODE_PERFORMANCE_MILESTONE_BOOTSTRAP_COMPLETE);\n \n   startExecution();\n }"
        },
        {
            "sha": "1db693f1ec716d597111ca3168b0330899acab78",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -27,21 +27,25 @@ function setupStdio() {\n   setupProcessStdio(getMainThreadStdio());\n }\n \n-// Non-POSIX platforms like Windows don't have certain methods.\n-// Workers also lack these methods since they change process-global state.\n-function setupProcessMethods(_chdir, _umask) {\n-  process.chdir = function chdir(directory) {\n+// The execution of this function itself should not cause any side effects.\n+function wrapProcessMethods(binding) {\n+  function chdir(directory) {\n     validateString(directory, 'directory');\n-    return _chdir(directory);\n-  };\n+    return binding.chdir(directory);\n+  }\n \n-  process.umask = function umask(mask) {\n+  function umask(mask) {\n     if (mask === undefined) {\n       // Get the mask\n-      return _umask(mask);\n+      return binding.umask(mask);\n     }\n     mask = validateMode(mask, 'mask');\n-    return _umask(mask);\n+    return binding.umask(mask);\n+  }\n+\n+  return {\n+    chdir,\n+    umask\n   };\n }\n \n@@ -175,7 +179,7 @@ function setupChildProcessIpcChannel() {\n \n module.exports = {\n   setupStdio,\n-  setupProcessMethods,\n+  wrapProcessMethods,\n   setupSignalHandlers,\n   setupChildProcessIpcChannel,\n   wrapPosixCredentialSetters"
        },
        {
            "sha": "f1629e3a97c33608deb8c7c8d44a36dd463a36f9",
            "filename": "lib/internal/process/per_thread.js",
            "status": "modified",
            "additions": 56,
            "deletions": 85,
            "changes": 141,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/lib%2Finternal%2Fprocess%2Fper_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fper_thread.js?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -18,25 +18,30 @@ const {\n } = require('internal/errors');\n const util = require('util');\n const constants = internalBinding('constants').os.signals;\n-const { deprecate } = require('internal/util');\n-\n-function setupAssert() {\n-  process.assert = deprecate(\n-    function(x, msg) {\n-      if (!x) throw new ERR_ASSERTION(msg || 'assertion error');\n-    },\n-    'process.assert() is deprecated. Please use the `assert` module instead.',\n-    'DEP0100');\n+\n+function assert(x, msg) {\n+  if (!x) throw new ERR_ASSERTION(msg || 'assertion error');\n }\n \n-// Set up the process.cpuUsage() function.\n-function setupCpuUsage(_cpuUsage) {\n+// The execution of this function itself should not cause any side effects.\n+function wrapProcessMethods(binding, exceptionHandlerState) {\n+  const {\n+    hrtime: _hrtime,\n+    hrtimeBigInt: _hrtimeBigInt,\n+    cpuUsage: _cpuUsage,\n+    memoryUsage: _memoryUsage\n+  } = binding;\n+\n+  function _rawDebug(...args) {\n+    binding._rawDebug(util.format.apply(null, args));\n+  }\n+\n   // Create the argument array that will be passed to the native function.\n   const cpuValues = new Float64Array(2);\n \n   // Replace the native function with the JS version that calls the native\n   // function.\n-  process.cpuUsage = function cpuUsage(prevValue) {\n+  function cpuUsage(prevValue) {\n     // If a previous value was passed in, ensure it has the correct shape.\n     if (prevValue) {\n       if (!previousValueIsValid(prevValue.user)) {\n@@ -80,7 +85,7 @@ function setupCpuUsage(_cpuUsage) {\n       user: cpuValues[0],\n       system: cpuValues[1]\n     };\n-  };\n+  }\n \n   // Ensure that a previously passed in value is valid. Currently, the native\n   // implementation always returns numbers <= Number.MAX_SAFE_INTEGER.\n@@ -89,15 +94,13 @@ function setupCpuUsage(_cpuUsage) {\n         num <= Number.MAX_SAFE_INTEGER &&\n         num >= 0;\n   }\n-}\n \n-// The 3 entries filled in by the original process.hrtime contains\n-// the upper/lower 32 bits of the second part of the value,\n-// and the remaining nanoseconds of the value.\n-function setupHrtime(_hrtime, _hrtimeBigInt) {\n+  // The 3 entries filled in by the original process.hrtime contains\n+  // the upper/lower 32 bits of the second part of the value,\n+  // and the remaining nanoseconds of the value.\n   const hrValues = new Uint32Array(3);\n \n-  process.hrtime = function hrtime(time) {\n+  function hrtime(time) {\n     _hrtime(hrValues);\n \n     if (time !== undefined) {\n@@ -118,51 +121,39 @@ function setupHrtime(_hrtime, _hrtimeBigInt) {\n       hrValues[0] * 0x100000000 + hrValues[1],\n       hrValues[2]\n     ];\n-  };\n+  }\n \n   // Use a BigUint64Array in the closure because V8 does not have an API for\n   // creating a BigInt out of a uint64_t yet.\n   const hrBigintValues = new BigUint64Array(1);\n-  process.hrtime.bigint = function() {\n+  function hrtimeBigInt() {\n     _hrtimeBigInt(hrBigintValues);\n     return hrBigintValues[0];\n-  };\n-}\n+  }\n \n-function setupMemoryUsage(_memoryUsage) {\n   const memValues = new Float64Array(4);\n-\n-  process.memoryUsage = function memoryUsage() {\n+  function memoryUsage() {\n     _memoryUsage(memValues);\n     return {\n       rss: memValues[0],\n       heapTotal: memValues[1],\n       heapUsed: memValues[2],\n       external: memValues[3]\n     };\n-  };\n-}\n-\n-function setupConfig() {\n-  // Serialized config.gypi\n-  process.config = JSON.parse(internalBinding('native_module').config);\n-}\n-\n-\n-function setupKillAndExit() {\n+  }\n \n-  process.exit = function(code) {\n+  function exit(code) {\n     if (code || code === 0)\n       process.exitCode = code;\n \n     if (!process._exiting) {\n       process._exiting = true;\n       process.emit('exit', process.exitCode || 0);\n     }\n-    process.reallyExit(process.exitCode || 0);\n-  };\n+    binding.reallyExit(process.exitCode || 0);\n+  }\n \n-  process.kill = function(pid, sig) {\n+  function kill(pid, sig) {\n     var err;\n     if (process.env.NODE_V8_COVERAGE) {\n       const { writeCoverage } = require('internal/process/coverage');\n@@ -176,6 +167,8 @@ function setupKillAndExit() {\n \n     // preserve null signal\n     if (sig === (sig | 0)) {\n+      // XXX(joyeecheung): we have to use process._kill here because\n+      // it's monkey-patched by tests.\n       err = process._kill(pid, sig);\n     } else {\n       sig = sig || 'SIGTERM';\n@@ -190,22 +183,13 @@ function setupKillAndExit() {\n       throw errnoException(err, 'kill');\n \n     return true;\n-  };\n-}\n-\n-function setupRawDebug(_rawDebug) {\n-  process._rawDebug = function() {\n-    _rawDebug(util.format.apply(null, arguments));\n-  };\n-}\n-\n+  }\n \n-function setupUncaughtExceptionCapture(exceptionHandlerState,\n-                                       shouldAbortOnUncaughtToggle) {\n   // shouldAbortOnUncaughtToggle is a typed array for faster\n   // communication with JS.\n+  const { shouldAbortOnUncaughtToggle } = binding;\n \n-  process.setUncaughtExceptionCaptureCallback = function(fn) {\n+  function setUncaughtExceptionCaptureCallback(fn) {\n     if (fn === null) {\n       exceptionHandlerState.captureFn = fn;\n       shouldAbortOnUncaughtToggle[0] = 1;\n@@ -219,10 +203,22 @@ function setupUncaughtExceptionCapture(exceptionHandlerState,\n     }\n     exceptionHandlerState.captureFn = fn;\n     shouldAbortOnUncaughtToggle[0] = 0;\n-  };\n+  }\n \n-  process.hasUncaughtExceptionCaptureCallback = function() {\n+  function hasUncaughtExceptionCaptureCallback() {\n     return exceptionHandlerState.captureFn !== null;\n+  }\n+\n+  return {\n+    _rawDebug,\n+    hrtime,\n+    hrtimeBigInt,\n+    cpuUsage,\n+    memoryUsage,\n+    kill,\n+    exit,\n+    setUncaughtExceptionCaptureCallback,\n+    hasUncaughtExceptionCaptureCallback\n   };\n }\n \n@@ -326,38 +322,13 @@ function buildAllowedFlags() {\n   Object.freeze(NodeEnvironmentFlagsSet.prototype.constructor);\n   Object.freeze(NodeEnvironmentFlagsSet.prototype);\n \n-  return process.allowedNodeEnvironmentFlags = Object.freeze(\n-    new NodeEnvironmentFlagsSet(\n-      allowedNodeEnvironmentFlags\n-    ));\n-}\n-\n-function setupAllowedFlags() {\n-  Object.defineProperty(process, 'allowedNodeEnvironmentFlags', {\n-    get: buildAllowedFlags,\n-    set(value) {\n-      // If the user tries to set this to another value, override\n-      // this completely to that value.\n-      Object.defineProperty(this, 'allowedNodeEnvironmentFlags', {\n-        value,\n-        configurable: true,\n-        enumerable: true,\n-        writable: true\n-      });\n-    },\n-    enumerable: true,\n-    configurable: true\n-  });\n+  return Object.freeze(new NodeEnvironmentFlagsSet(\n+    allowedNodeEnvironmentFlags\n+  ));\n }\n \n module.exports = {\n-  setupAllowedFlags,\n-  setupAssert,\n-  setupCpuUsage,\n-  setupHrtime,\n-  setupMemoryUsage,\n-  setupConfig,\n-  setupKillAndExit,\n-  setupRawDebug,\n-  setupUncaughtExceptionCapture\n+  assert,\n+  buildAllowedFlags,\n+  wrapProcessMethods\n };"
        },
        {
            "sha": "60c05a58a6f47f25e7773a155a7df3d4a164f4da",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -139,20 +139,6 @@ void SetupBootstrapObject(Environment* env,\n   BOOTSTRAP_METHOD(_setupTraceCategoryState, SetupTraceCategoryState);\n   BOOTSTRAP_METHOD(_setupNextTick, SetupNextTick);\n   BOOTSTRAP_METHOD(_setupPromises, SetupPromises);\n-  BOOTSTRAP_METHOD(_chdir, Chdir);\n-  BOOTSTRAP_METHOD(_cpuUsage, CPUUsage);\n-  BOOTSTRAP_METHOD(_hrtime, Hrtime);\n-  BOOTSTRAP_METHOD(_hrtimeBigInt, HrtimeBigInt);\n-  BOOTSTRAP_METHOD(_memoryUsage, MemoryUsage);\n-  BOOTSTRAP_METHOD(_rawDebug, RawDebug);\n-  BOOTSTRAP_METHOD(_umask, Umask);\n-\n-  Local<String> should_abort_on_uncaught_toggle =\n-      FIXED_ONE_BYTE_STRING(env->isolate(), \"_shouldAbortOnUncaughtToggle\");\n-  CHECK(bootstrapper->Set(env->context(),\n-                       should_abort_on_uncaught_toggle,\n-                       env->should_abort_on_uncaught_toggle().GetJSArray())\n-                           .FromJust());\n }\n #undef BOOTSTRAP_METHOD\n "
        },
        {
            "sha": "9bd2ac9ff6f920a2ac8195a747f39c160fca39f1",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 154,
            "changes": 155,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -95,8 +95,6 @@\n #if defined(_MSC_VER)\n #include <direct.h>\n #include <io.h>\n-#define umask _umask\n-typedef int mode_t;\n #else\n #include <pthread.h>\n #include <sys/resource.h>  // getrlimit, setrlimit\n@@ -689,8 +687,7 @@ static void WaitForInspectorDisconnect(Environment* env) {\n #endif\n }\n \n-\n-static void Exit(const FunctionCallbackInfo<Value>& args) {\n+void Exit(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   WaitForInspectorDisconnect(env);\n   v8_platform.StopTracingAgent();\n@@ -1114,29 +1111,6 @@ void SetupProcessObject(Environment* env,\n                              DebugPortGetter,\n                              env->is_main_thread() ? DebugPortSetter : nullptr,\n                              env->as_external()).FromJust());\n-\n-  // define various internal methods\n-  if (env->is_main_thread()) {\n-    env->SetMethod(process, \"_debugProcess\", DebugProcess);\n-    env->SetMethod(process, \"_debugEnd\", DebugEnd);\n-    env->SetMethod(process,\n-                   \"_startProfilerIdleNotifier\",\n-                   StartProfilerIdleNotifier);\n-    env->SetMethod(process,\n-                   \"_stopProfilerIdleNotifier\",\n-                   StopProfilerIdleNotifier);\n-    env->SetMethod(process, \"abort\", Abort);\n-    env->SetMethod(process, \"chdir\", Chdir);\n-    env->SetMethod(process, \"umask\", Umask);\n-  }\n-  env->SetMethod(process, \"_getActiveRequests\", GetActiveRequests);\n-  env->SetMethod(process, \"_getActiveHandles\", GetActiveHandles);\n-  env->SetMethod(process, \"_kill\", Kill);\n-\n-  env->SetMethodNoSideEffect(process, \"cwd\", Cwd);\n-  env->SetMethod(process, \"dlopen\", binding::DLOpen);\n-  env->SetMethod(process, \"reallyExit\", Exit);\n-  env->SetMethodNoSideEffect(process, \"uptime\", Uptime);\n }\n \n \n@@ -1278,135 +1252,8 @@ void RegisterSignalHandler(int signal,\n   CHECK_EQ(sigaction(signal, &sa, nullptr), 0);\n }\n \n-\n-void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  if (args.Length() != 1) {\n-    return env->ThrowError(\"Invalid number of arguments.\");\n-  }\n-\n-  CHECK(args[0]->IsNumber());\n-  pid_t pid = args[0].As<Integer>()->Value();\n-  int r = kill(pid, SIGUSR1);\n-\n-  if (r != 0) {\n-    return env->ThrowErrnoException(errno, \"kill\");\n-  }\n-}\n #endif  // __POSIX__\n \n-\n-#ifdef _WIN32\n-static int GetDebugSignalHandlerMappingName(DWORD pid, wchar_t* buf,\n-    size_t buf_len) {\n-  return _snwprintf(buf, buf_len, L\"node-debug-handler-%u\", pid);\n-}\n-\n-\n-static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  Isolate* isolate = args.GetIsolate();\n-\n-  if (args.Length() != 1) {\n-    env->ThrowError(\"Invalid number of arguments.\");\n-    return;\n-  }\n-\n-  HANDLE process = nullptr;\n-  HANDLE thread = nullptr;\n-  HANDLE mapping = nullptr;\n-  wchar_t mapping_name[32];\n-  LPTHREAD_START_ROUTINE* handler = nullptr;\n-  DWORD pid = 0;\n-\n-  OnScopeLeave cleanup([&]() {\n-    if (process != nullptr)\n-      CloseHandle(process);\n-    if (thread != nullptr)\n-      CloseHandle(thread);\n-    if (handler != nullptr)\n-      UnmapViewOfFile(handler);\n-    if (mapping != nullptr)\n-      CloseHandle(mapping);\n-  });\n-\n-  CHECK(args[0]->IsNumber());\n-  pid = args[0].As<Integer>()->Value();\n-\n-  process = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION |\n-                            PROCESS_VM_OPERATION | PROCESS_VM_WRITE |\n-                            PROCESS_VM_READ,\n-                        FALSE,\n-                        pid);\n-  if (process == nullptr) {\n-    isolate->ThrowException(\n-        WinapiErrnoException(isolate, GetLastError(), \"OpenProcess\"));\n-    return;\n-  }\n-\n-  if (GetDebugSignalHandlerMappingName(pid,\n-                                       mapping_name,\n-                                       arraysize(mapping_name)) < 0) {\n-    env->ThrowErrnoException(errno, \"sprintf\");\n-    return;\n-  }\n-\n-  mapping = OpenFileMappingW(FILE_MAP_READ, FALSE, mapping_name);\n-  if (mapping == nullptr) {\n-    isolate->ThrowException(WinapiErrnoException(isolate,\n-                                             GetLastError(),\n-                                             \"OpenFileMappingW\"));\n-    return;\n-  }\n-\n-  handler = reinterpret_cast<LPTHREAD_START_ROUTINE*>(\n-      MapViewOfFile(mapping,\n-                    FILE_MAP_READ,\n-                    0,\n-                    0,\n-                    sizeof *handler));\n-  if (handler == nullptr || *handler == nullptr) {\n-    isolate->ThrowException(\n-        WinapiErrnoException(isolate, GetLastError(), \"MapViewOfFile\"));\n-    return;\n-  }\n-\n-  thread = CreateRemoteThread(process,\n-                              nullptr,\n-                              0,\n-                              *handler,\n-                              nullptr,\n-                              0,\n-                              nullptr);\n-  if (thread == nullptr) {\n-    isolate->ThrowException(WinapiErrnoException(isolate,\n-                                                 GetLastError(),\n-                                                 \"CreateRemoteThread\"));\n-    return;\n-  }\n-\n-  // Wait for the thread to terminate\n-  if (WaitForSingleObject(thread, INFINITE) != WAIT_OBJECT_0) {\n-    isolate->ThrowException(WinapiErrnoException(isolate,\n-                                                 GetLastError(),\n-                                                 \"WaitForSingleObject\"));\n-    return;\n-  }\n-}\n-#endif  // _WIN32\n-\n-\n-static void DebugEnd(const FunctionCallbackInfo<Value>& args) {\n-#if HAVE_INSPECTOR\n-  Environment* env = Environment::GetCurrent(args);\n-  if (env->inspector_agent()->IsListening()) {\n-    env->inspector_agent()->Stop();\n-  }\n-#endif\n-}\n-\n-\n inline void PlatformInit() {\n #ifdef __POSIX__\n #if HAVE_INSPECTOR"
        },
        {
            "sha": "46ae5f6840f658708ec27c00abc1ee7db634d542",
            "filename": "src/node_binding.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_binding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_binding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_binding.cc?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -44,6 +44,7 @@\n   V(performance)                                                               \\\n   V(pipe_wrap)                                                                 \\\n   V(process_wrap)                                                              \\\n+  V(process_methods)                                                           \\\n   V(serdes)                                                                    \\\n   V(signal_wrap)                                                               \\\n   V(spawn_sync)                                                                \\"
        },
        {
            "sha": "99498a6218d35a11ac255ce980b1ef4eabadcb37",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 14,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -119,6 +119,7 @@ void GetSockOrPeerName(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   args.GetReturnValue().Set(err);\n }\n \n+void Exit(const v8::FunctionCallbackInfo<v8::Value>& args);\n void SignalExit(int signo);\n #ifdef __POSIX__\n void RegisterSignalHandler(int signal,\n@@ -698,21 +699,7 @@ static inline const char* errno_string(int errorno) {\n \n extern double prog_start_time;\n \n-void Abort(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Chdir(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void CPUUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Cwd(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetActiveHandles(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void GetActiveRequests(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Hrtime(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void HrtimeBigInt(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Kill(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void MemoryUsage(const v8::FunctionCallbackInfo<v8::Value>& args);\n void RawDebug(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void StartProfilerIdleNotifier(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void StopProfilerIdleNotifier(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Umask(const v8::FunctionCallbackInfo<v8::Value>& args);\n-void Uptime(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n void DebugPortGetter(v8::Local<v8::Name> property,\n                      const v8::PropertyCallbackInfo<v8::Value>& info);"
        },
        {
            "sha": "477ac2adc8eb6c1292aa9baa2a91bb20e1b312bf",
            "filename": "src/node_process.cc",
            "status": "modified",
            "additions": 171,
            "deletions": 16,
            "changes": 187,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_process.cc",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/src%2Fnode_process.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process.cc?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -8,6 +8,8 @@\n #include \"uv.h\"\n #include \"v8.h\"\n \n+#include <vector>\n+\n #if HAVE_INSPECTOR\n #include \"inspector_io.h\"\n #endif\n@@ -36,10 +38,12 @@ using v8::Float64Array;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::HeapStatistics;\n+using v8::Integer;\n using v8::Isolate;\n using v8::Local;\n using v8::Name;\n using v8::NewStringType;\n+using v8::Object;\n using v8::PropertyCallbackInfo;\n using v8::String;\n using v8::Uint32;\n@@ -61,11 +65,11 @@ Mutex environ_mutex;\n #define CHDIR_BUFSIZE (PATH_MAX)\n #endif\n \n-void Abort(const FunctionCallbackInfo<Value>& args) {\n+static void Abort(const FunctionCallbackInfo<Value>& args) {\n   Abort();\n }\n \n-void Chdir(const FunctionCallbackInfo<Value>& args) {\n+static void Chdir(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   CHECK(env->is_main_thread());\n \n@@ -88,7 +92,7 @@ void Chdir(const FunctionCallbackInfo<Value>& args) {\n // which are uv_timeval_t structs (long tv_sec, long tv_usec).\n // Returns those values as Float64 microseconds in the elements of the array\n // passed to the function.\n-void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n+static void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n   uv_rusage_t rusage;\n \n   // Call libuv to get the values we'll return.\n@@ -111,7 +115,7 @@ void CPUUsage(const FunctionCallbackInfo<Value>& args) {\n   fields[1] = MICROS_PER_SEC * rusage.ru_stime.tv_sec + rusage.ru_stime.tv_usec;\n }\n \n-void Cwd(const FunctionCallbackInfo<Value>& args) {\n+static void Cwd(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   char buf[CHDIR_BUFSIZE];\n   size_t cwd_len = sizeof(buf);\n@@ -138,7 +142,7 @@ void Cwd(const FunctionCallbackInfo<Value>& args) {\n // broken into the upper/lower 32 bits to be converted back in JS,\n // because there is no Uint64Array in JS.\n // The third entry contains the remaining nanosecond part of the value.\n-void Hrtime(const FunctionCallbackInfo<Value>& args) {\n+static void Hrtime(const FunctionCallbackInfo<Value>& args) {\n   uint64_t t = uv_hrtime();\n \n   Local<ArrayBuffer> ab = args[0].As<Uint32Array>()->Buffer();\n@@ -149,13 +153,13 @@ void Hrtime(const FunctionCallbackInfo<Value>& args) {\n   fields[2] = t % NANOS_PER_SEC;\n }\n \n-void HrtimeBigInt(const FunctionCallbackInfo<Value>& args) {\n+static void HrtimeBigInt(const FunctionCallbackInfo<Value>& args) {\n   Local<ArrayBuffer> ab = args[0].As<BigUint64Array>()->Buffer();\n   uint64_t* fields = static_cast<uint64_t*>(ab->GetContents().Data());\n   fields[0] = uv_hrtime();\n }\n \n-void Kill(const FunctionCallbackInfo<Value>& args) {\n+static void Kill(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Local<Context> context = env->context();\n \n@@ -170,8 +174,7 @@ void Kill(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(err);\n }\n \n-\n-void MemoryUsage(const FunctionCallbackInfo<Value>& args) {\n+static void MemoryUsage(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   size_t rss;\n@@ -209,18 +212,17 @@ void RawDebug(const FunctionCallbackInfo<Value>& args) {\n   fflush(stderr);\n }\n \n-void StartProfilerIdleNotifier(const FunctionCallbackInfo<Value>& args) {\n+static void StartProfilerIdleNotifier(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   env->StartProfilerIdleNotifier();\n }\n \n-\n-void StopProfilerIdleNotifier(const FunctionCallbackInfo<Value>& args) {\n+static void StopProfilerIdleNotifier(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   env->StopProfilerIdleNotifier();\n }\n \n-void Umask(const FunctionCallbackInfo<Value>& args) {\n+static void Umask(const FunctionCallbackInfo<Value>& args) {\n   uint32_t old;\n \n   CHECK_EQ(args.Length(), 1);\n@@ -237,7 +239,7 @@ void Umask(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(old);\n }\n \n-void Uptime(const FunctionCallbackInfo<Value>& args) {\n+static void Uptime(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   double uptime;\n \n@@ -255,7 +257,6 @@ void ProcessTitleGetter(Local<Name> property,\n       NewStringType::kNormal).ToLocalChecked());\n }\n \n-\n void ProcessTitleSetter(Local<Name> property,\n                         Local<Value> value,\n                         const PropertyCallbackInfo<void>& info) {\n@@ -270,7 +271,7 @@ void GetParentProcessId(Local<Name> property,\n   info.GetReturnValue().Set(uv_os_getppid());\n }\n \n-void GetActiveRequests(const FunctionCallbackInfo<Value>& args) {\n+static void GetActiveRequests(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   std::vector<Local<Value>> request_v;\n@@ -315,5 +316,159 @@ void DebugPortSetter(Local<Name> property,\n   env->inspector_host_port()->set_port(static_cast<int>(port));\n }\n \n+#ifdef __POSIX__\n+static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  if (args.Length() != 1) {\n+    return env->ThrowError(\"Invalid number of arguments.\");\n+  }\n+\n+  CHECK(args[0]->IsNumber());\n+  pid_t pid = args[0].As<Integer>()->Value();\n+  int r = kill(pid, SIGUSR1);\n+\n+  if (r != 0) {\n+    return env->ThrowErrnoException(errno, \"kill\");\n+  }\n+}\n+#endif  // __POSIX__\n+\n+#ifdef _WIN32\n+static int GetDebugSignalHandlerMappingName(DWORD pid,\n+                                            wchar_t* buf,\n+                                            size_t buf_len) {\n+  return _snwprintf(buf, buf_len, L\"node-debug-handler-%u\", pid);\n+}\n+\n+static void DebugProcess(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = args.GetIsolate();\n+\n+  if (args.Length() != 1) {\n+    env->ThrowError(\"Invalid number of arguments.\");\n+    return;\n+  }\n+\n+  HANDLE process = nullptr;\n+  HANDLE thread = nullptr;\n+  HANDLE mapping = nullptr;\n+  wchar_t mapping_name[32];\n+  LPTHREAD_START_ROUTINE* handler = nullptr;\n+  DWORD pid = 0;\n+\n+  OnScopeLeave cleanup([&]() {\n+    if (process != nullptr) CloseHandle(process);\n+    if (thread != nullptr) CloseHandle(thread);\n+    if (handler != nullptr) UnmapViewOfFile(handler);\n+    if (mapping != nullptr) CloseHandle(mapping);\n+  });\n+\n+  CHECK(args[0]->IsNumber());\n+  pid = args[0].As<Integer>()->Value();\n+\n+  process =\n+      OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION |\n+                      PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ,\n+                  FALSE,\n+                  pid);\n+  if (process == nullptr) {\n+    isolate->ThrowException(\n+        WinapiErrnoException(isolate, GetLastError(), \"OpenProcess\"));\n+    return;\n+  }\n+\n+  if (GetDebugSignalHandlerMappingName(\n+          pid, mapping_name, arraysize(mapping_name)) < 0) {\n+    env->ThrowErrnoException(errno, \"sprintf\");\n+    return;\n+  }\n+\n+  mapping = OpenFileMappingW(FILE_MAP_READ, FALSE, mapping_name);\n+  if (mapping == nullptr) {\n+    isolate->ThrowException(\n+        WinapiErrnoException(isolate, GetLastError(), \"OpenFileMappingW\"));\n+    return;\n+  }\n+\n+  handler = reinterpret_cast<LPTHREAD_START_ROUTINE*>(\n+      MapViewOfFile(mapping, FILE_MAP_READ, 0, 0, sizeof *handler));\n+  if (handler == nullptr || *handler == nullptr) {\n+    isolate->ThrowException(\n+        WinapiErrnoException(isolate, GetLastError(), \"MapViewOfFile\"));\n+    return;\n+  }\n+\n+  thread =\n+      CreateRemoteThread(process, nullptr, 0, *handler, nullptr, 0, nullptr);\n+  if (thread == nullptr) {\n+    isolate->ThrowException(\n+        WinapiErrnoException(isolate, GetLastError(), \"CreateRemoteThread\"));\n+    return;\n+  }\n+\n+  // Wait for the thread to terminate\n+  if (WaitForSingleObject(thread, INFINITE) != WAIT_OBJECT_0) {\n+    isolate->ThrowException(\n+        WinapiErrnoException(isolate, GetLastError(), \"WaitForSingleObject\"));\n+    return;\n+  }\n+}\n+#endif  // _WIN32\n+\n+static void DebugEnd(const FunctionCallbackInfo<Value>& args) {\n+#if HAVE_INSPECTOR\n+  Environment* env = Environment::GetCurrent(args);\n+  if (env->inspector_agent()->IsListening()) {\n+    env->inspector_agent()->Stop();\n+  }\n+#endif\n+}\n+\n+static void InitializeProcessMethods(Local<Object> target,\n+                                     Local<Value> unused,\n+                                     Local<Context> context,\n+                                     void* priv) {\n+  Environment* env = Environment::GetCurrent(context);\n+\n+  // define various internal methods\n+  if (env->is_main_thread()) {\n+    env->SetMethod(target, \"_debugProcess\", DebugProcess);\n+    env->SetMethod(target, \"_debugEnd\", DebugEnd);\n+    env->SetMethod(\n+        target, \"_startProfilerIdleNotifier\", StartProfilerIdleNotifier);\n+    env->SetMethod(\n+        target, \"_stopProfilerIdleNotifier\", StopProfilerIdleNotifier);\n+    env->SetMethod(target, \"abort\", Abort);\n+    env->SetMethod(target, \"chdir\", Chdir);\n+    env->SetMethod(target, \"umask\", Umask);\n+  }\n+\n+  env->SetMethod(target, \"_rawDebug\", RawDebug);\n+  env->SetMethod(target, \"memoryUsage\", MemoryUsage);\n+  env->SetMethod(target, \"cpuUsage\", CPUUsage);\n+  env->SetMethod(target, \"hrtime\", Hrtime);\n+  env->SetMethod(target, \"hrtimeBigInt\", HrtimeBigInt);\n+\n+  env->SetMethod(target, \"_getActiveRequests\", GetActiveRequests);\n+  env->SetMethod(target, \"_getActiveHandles\", GetActiveHandles);\n+  env->SetMethod(target, \"_kill\", Kill);\n+\n+  env->SetMethodNoSideEffect(target, \"cwd\", Cwd);\n+  env->SetMethod(target, \"dlopen\", binding::DLOpen);\n+  env->SetMethod(target, \"reallyExit\", Exit);\n+  env->SetMethodNoSideEffect(target, \"uptime\", Uptime);\n+\n+  Local<String> should_abort_on_uncaught_toggle =\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"shouldAbortOnUncaughtToggle\");\n+  CHECK(target\n+            ->Set(env->context(),\n+                  should_abort_on_uncaught_toggle,\n+                  env->should_abort_on_uncaught_toggle().GetJSArray())\n+            .FromJust());\n+}\n \n }  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(process_methods,\n+                                   node::InitializeProcessMethods)"
        },
        {
            "sha": "3f67144f5fb2ce52bf9ca05cf549149cc946bb73",
            "filename": "test/parallel/test-bootstrap-modules.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/75d0a9335f2f9bab72cdcbe9297d5617133a1d9c/test%2Fparallel%2Ftest-bootstrap-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-bootstrap-modules.js?ref=75d0a9335f2f9bab72cdcbe9297d5617133a1d9c",
            "patch": "@@ -9,7 +9,7 @@ const common = require('../common');\n const assert = require('assert');\n \n const isMainThread = common.isMainThread;\n-const kMaxModuleCount = isMainThread ? 60 : 82;\n+const kMaxModuleCount = isMainThread ? 61 : 83;\n \n assert(list.length <= kMaxModuleCount,\n        `Total length: ${list.length}\\n` + list.join('\\n')"
        }
    ],
    "stats": {
        "total": 639,
        "additions": 322,
        "deletions": 317
    }
}