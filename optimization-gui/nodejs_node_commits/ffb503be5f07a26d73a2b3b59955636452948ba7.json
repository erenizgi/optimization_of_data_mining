{
    "author": "ronag",
    "message": "http: fix client response close & aborted\n\nFixes: https://github.com/nodejs/node/issues/20102\nFixes: https://github.com/nodejs/node/issues/20101\nFixes: https://github.com/nodejs/node/issues/1735\n\n- Response should always emit close.\n- Response should always emit aborted if aborted.\n- Response should always emit close after request has emitted close.\n\nPR-URL: https://github.com/nodejs/node/pull/20075\nFixes: https://github.com/nodejs/node/issues/17352\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "ffb503be5f07a26d73a2b3b59955636452948ba7",
    "files": [
        {
            "sha": "92c2954d0c745e19c4534923cd8c99cea4fc48dd",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 23,
            "deletions": 16,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/ffb503be5f07a26d73a2b3b59955636452948ba7/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/ffb503be5f07a26d73a2b3b59955636452948ba7/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=ffb503be5f07a26d73a2b3b59955636452948ba7",
            "patch": "@@ -340,26 +340,33 @@ function socketCloseListener() {\n \n   // NOTE: It's important to get parser here, because it could be freed by\n   // the `socketOnData`.\n-  var parser = socket.parser;\n-  if (req.res && req.res.readable) {\n+  const parser = socket.parser;\n+  const res = req.res;\n+  if (res) {\n     // Socket closed before we emitted 'end' below.\n-    if (!req.res.complete) {\n-      req.res.aborted = true;\n-      req.res.emit('aborted');\n+    if (!res.complete) {\n+      res.aborted = true;\n+      res.emit('aborted');\n     }\n-    var res = req.res;\n-    res.on('end', function() {\n+    req.emit('close');\n+    if (res.readable) {\n+      res.on('end', function() {\n+        this.emit('close');\n+      });\n+      res.push(null);\n+    } else {\n       res.emit('close');\n-    });\n-    res.push(null);\n-  } else if (!req.res && !req.socket._hadError) {\n-    // This socket error fired before we started to\n-    // receive a response. The error needs to\n-    // fire on the request.\n-    req.socket._hadError = true;\n-    req.emit('error', createHangUpError());\n+    }\n+  } else {\n+    if (!req.socket._hadError) {\n+      // This socket error fired before we started to\n+      // receive a response. The error needs to\n+      // fire on the request.\n+      req.socket._hadError = true;\n+      req.emit('error', createHangUpError());\n+    }\n+    req.emit('close');\n   }\n-  req.emit('close');\n \n   // Too bad.  That output wasn't getting written.\n   // This is pretty terrible that it doesn't raise an error."
        },
        {
            "sha": "4c36003357980b854ba4b3fc48593ea1c83871e1",
            "filename": "test/parallel/test-http-response-close.js",
            "status": "modified",
            "additions": 46,
            "deletions": 25,
            "changes": 71,
            "blob_url": "https://github.com/nodejs/node/blob/ffb503be5f07a26d73a2b3b59955636452948ba7/test%2Fparallel%2Ftest-http-response-close.js",
            "raw_url": "https://github.com/nodejs/node/raw/ffb503be5f07a26d73a2b3b59955636452948ba7/test%2Fparallel%2Ftest-http-response-close.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-response-close.js?ref=ffb503be5f07a26d73a2b3b59955636452948ba7",
            "patch": "@@ -23,29 +23,50 @@\n const common = require('../common');\n const http = require('http');\n \n-const server = http.createServer(common.mustCall(function(req, res) {\n-  res.writeHead(200);\n-  res.write('a');\n+{\n+  const server = http.createServer(\n+    common.mustCall((req, res) => {\n+      res.writeHead(200);\n+      res.write('a');\n+    })\n+  );\n+  server.listen(\n+    0,\n+    common.mustCall(() => {\n+      http.get(\n+        { port: server.address().port },\n+        common.mustCall((res) => {\n+          res.on('data', common.mustCall(() => {\n+            res.destroy();\n+          }));\n+          res.on('close', common.mustCall(() => {\n+            server.close();\n+          }));\n+        })\n+      );\n+    })\n+  );\n+}\n \n-  req.on('close', common.mustCall(function() {\n-    console.error('request aborted');\n-  }));\n-  res.on('close', common.mustCall(function() {\n-    console.error('response aborted');\n-  }));\n-}));\n-server.listen(0);\n-\n-server.on('listening', function() {\n-  console.error('make req');\n-  http.get({\n-    port: this.address().port\n-  }, function(res) {\n-    console.error('got res');\n-    res.on('data', function(data) {\n-      console.error('destroy res');\n-      res.destroy();\n-      server.close();\n-    });\n-  });\n-});\n+{\n+  const server = http.createServer(\n+    common.mustCall((req, res) => {\n+      res.writeHead(200);\n+      res.end('a');\n+    })\n+  );\n+  server.listen(\n+    0,\n+    common.mustCall(() => {\n+      http.get(\n+        { port: server.address().port },\n+        common.mustCall((res) => {\n+          res.on('close', common.mustCall(() => {\n+            server.close();\n+          }));\n+          res.resume();\n+        })\n+      );\n+    })\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 69,
        "deletions": 41
    }
}