{
    "author": "joyeecheung",
    "message": "fs: throw fs.chownSync errors in JS land\n\nPR-URL: https://github.com/nodejs/node/pull/18871\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "8fb5a6cd81a893dc4929a290206ac0b10c068487",
    "files": [
        {
            "sha": "e86360fc1a21582963b72f60308f5c6d50164d1e",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8fb5a6cd81a893dc4929a290206ac0b10c068487/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fb5a6cd81a893dc4929a290206ac0b10c068487/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=8fb5a6cd81a893dc4929a290206ac0b10c068487",
            "patch": "@@ -1124,7 +1124,9 @@ fs.chownSync = function(path, uid, gid) {\n   validatePath(path);\n   validateUint32(uid, 'uid');\n   validateUint32(gid, 'gid');\n-  return binding.chown(pathModule.toNamespacedPath(path), uid, gid);\n+  const ctx = { path };\n+  binding.chown(pathModule.toNamespacedPath(path), uid, gid, undefined, ctx);\n+  handleErrorFromBinding(ctx);\n };\n \n // exported for unit tests, not for public consumption"
        },
        {
            "sha": "6e23846d471256a565971bb88908558b3771063b",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/8fb5a6cd81a893dc4929a290206ac0b10c068487/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8fb5a6cd81a893dc4929a290206ac0b10c068487/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=8fb5a6cd81a893dc4929a290206ac0b10c068487",
            "patch": "@@ -102,6 +102,7 @@ using v8::ObjectTemplate;\n using v8::Promise;\n using v8::String;\n using v8::Symbol;\n+using v8::Uint32;\n using v8::Undefined;\n using v8::Value;\n \n@@ -1508,23 +1509,27 @@ static void FChmod(const FunctionCallbackInfo<Value>& args) {\n static void Chown(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  int len = args.Length();\n-  CHECK_GE(len, 3);\n-  CHECK(args[1]->IsUint32());\n-  CHECK(args[2]->IsUint32());\n+  const int argc = args.Length();\n+  CHECK_GE(argc, 3);\n \n   BufferValue path(env->isolate(), args[0]);\n   CHECK_NE(*path, nullptr);\n \n-  uv_uid_t uid = static_cast<uv_uid_t>(args[1]->Uint32Value());\n-  uv_gid_t gid = static_cast<uv_gid_t>(args[2]->Uint32Value());\n+  CHECK(args[1]->IsUint32());\n+  const uv_uid_t uid = static_cast<uv_uid_t>(args[1].As<Uint32>()->Value());\n+\n+  CHECK(args[2]->IsUint32());\n+  const uv_gid_t gid = static_cast<uv_gid_t>(args[2].As<Uint32>()->Value());\n \n   FSReqBase* req_wrap = GetReqWrap(env, args[3]);\n-  if (req_wrap != nullptr) {\n+  if (req_wrap != nullptr) {  // chown(path, uid, gid, req)\n     AsyncCall(env, req_wrap, args, \"chown\", UTF8, AfterNoArgs,\n               uv_fs_chown, *path, uid, gid);\n-  } else {\n-    SYNC_CALL(chown, *path, *path, uid, gid);\n+  } else {  // chown(path, uid, gid, undefined, ctx)\n+    CHECK_EQ(argc, 5);\n+    fs_req_wrap req_wrap;\n+    SyncCall(env, args[4], &req_wrap, \"chown\",\n+             uv_fs_chown, *path, uid, gid);\n   }\n }\n "
        },
        {
            "sha": "b91d65538464a9b0c858265f1fe321a4383d306c",
            "filename": "test/parallel/test-fs-error-messages.js",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/8fb5a6cd81a893dc4929a290206ac0b10c068487/test%2Fparallel%2Ftest-fs-error-messages.js",
            "raw_url": "https://github.com/nodejs/node/raw/8fb5a6cd81a893dc4929a290206ac0b10c068487/test%2Fparallel%2Ftest-fs-error-messages.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-error-messages.js?ref=8fb5a6cd81a893dc4929a290206ac0b10c068487",
            "patch": "@@ -562,3 +562,26 @@ function re(literals, ...values) {\n     );\n   });\n }\n+\n+// chown\n+if (!common.isWindows) {\n+  const validateError = (err) => {\n+    assert.strictEqual(nonexistentFile, err.path);\n+    assert.strictEqual(\n+      err.message,\n+      `ENOENT: no such file or directory, chown '${nonexistentFile}'`);\n+    assert.strictEqual(err.errno, uv.UV_ENOENT);\n+    assert.strictEqual(err.code, 'ENOENT');\n+    assert.strictEqual(err.syscall, 'chown');\n+    return true;\n+  };\n+\n+  fs.chown(nonexistentFile, process.getuid(), process.getgid(),\n+           common.mustCall(validateError));\n+\n+  assert.throws(\n+    () => fs.chownSync(nonexistentFile,\n+                       process.getuid(), process.getgid()),\n+    validateError\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 40,
        "deletions": 10
    }
}