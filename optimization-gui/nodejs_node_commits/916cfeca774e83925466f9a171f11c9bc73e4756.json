{
    "author": "j0t3x",
    "message": "lib,src: audit process.env in lib/ for setuid binary\n\nWrap SafeGetenv() in util binding with the purpose of protecting\nthe cases when env vars are accessed with the privileges of another\nuser in jsland.\n\nPR-URL: https://github.com/nodejs/node/pull/18511\nFixes: https://github.com/nodejs/node/issues/9160\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "916cfeca774e83925466f9a171f11c9bc73e4756",
    "files": [
        {
            "sha": "42da5c01ce8d6f427e79539aebab1344006594ef",
            "filename": "lib/module.js",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/916cfeca774e83925466f9a171f11c9bc73e4756/lib%2Fmodule.js",
            "raw_url": "https://github.com/nodejs/node/raw/916cfeca774e83925466f9a171f11c9bc73e4756/lib%2Fmodule.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fmodule.js?ref=916cfeca774e83925466f9a171f11c9bc73e4756",
            "patch": "@@ -34,6 +34,7 @@ const {\n   internalModuleReadJSON,\n   internalModuleStat\n } = process.binding('fs');\n+const { safeGetenv } = process.binding('util');\n const internalModule = require('internal/module');\n const preserveSymlinks = !!process.binding('config').preserveSymlinks;\n const experimentalModules = !!process.binding('config').experimentalModules;\n@@ -697,10 +698,13 @@ Module._initPaths = function() {\n   const isWindows = process.platform === 'win32';\n \n   var homeDir;\n+  var nodePath;\n   if (isWindows) {\n     homeDir = process.env.USERPROFILE;\n+    nodePath = process.env.NODE_PATH;\n   } else {\n-    homeDir = process.env.HOME;\n+    homeDir = safeGetenv('HOME');\n+    nodePath = safeGetenv('NODE_PATH');\n   }\n \n   // $PREFIX/lib/node, where $PREFIX is the root of the Node.js installation.\n@@ -719,7 +723,6 @@ Module._initPaths = function() {\n     paths.unshift(path.resolve(homeDir, '.node_modules'));\n   }\n \n-  var nodePath = process.env.NODE_PATH;\n   if (nodePath) {\n     paths = nodePath.split(path.delimiter).filter(function(path) {\n       return !!path;"
        },
        {
            "sha": "eb13139dba9a9cd6fed89454f3998b8153249b54",
            "filename": "lib/os.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/916cfeca774e83925466f9a171f11c9bc73e4756/lib%2Fos.js",
            "raw_url": "https://github.com/nodejs/node/raw/916cfeca774e83925466f9a171f11c9bc73e4756/lib%2Fos.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fos.js?ref=916cfeca774e83925466f9a171f11c9bc73e4756",
            "patch": "@@ -21,7 +21,7 @@\n \n 'use strict';\n \n-const { pushValToArrayMax } = process.binding('util');\n+const { pushValToArrayMax, safeGetenv } = process.binding('util');\n const constants = process.binding('constants').os;\n const { deprecate } = require('internal/util');\n const { getCIDRSuffix } = require('internal/os');\n@@ -127,9 +127,9 @@ function tmpdir() {\n     if (path.length > 1 && path.endsWith('\\\\') && !path.endsWith(':\\\\'))\n       path = path.slice(0, -1);\n   } else {\n-    path = process.env.TMPDIR ||\n-           process.env.TMP ||\n-           process.env.TEMP ||\n+    path = safeGetenv('TMPDIR') ||\n+           safeGetenv('TMP') ||\n+           safeGetenv('TEMP') ||\n            '/tmp';\n     if (path.length > 1 && path.endsWith('/'))\n       path = path.slice(0, -1);"
        },
        {
            "sha": "1542b533f3484d3dbc49ef41e13439bff009b182",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/916cfeca774e83925466f9a171f11c9bc73e4756/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/916cfeca774e83925466f9a171f11c9bc73e4756/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=916cfeca774e83925466f9a171f11c9bc73e4756",
            "patch": "@@ -14,6 +14,7 @@ using v8::Object;\n using v8::Private;\n using v8::Promise;\n using v8::Proxy;\n+using v8::String;\n using v8::Value;\n \n \n@@ -174,6 +175,16 @@ void PromiseReject(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(ret.FromMaybe(false));\n }\n \n+void SafeGetenv(const FunctionCallbackInfo<Value>& args) {\n+  CHECK(args[0]->IsString());\n+  Utf8Value strenvtag(args.GetIsolate(), args[0]);\n+  std::string text;\n+  if (!node::SafeGetenv(*strenvtag, &text)) return;\n+  args.GetReturnValue()\n+      .Set(String::NewFromUtf8(\n+            args.GetIsolate(), text.c_str(),\n+            v8::NewStringType::kNormal).ToLocalChecked());\n+}\n \n void Initialize(Local<Object> target,\n                 Local<Value> unused,\n@@ -225,6 +236,8 @@ void Initialize(Local<Object> target,\n   env->SetMethod(target, \"createPromise\", CreatePromise);\n   env->SetMethod(target, \"promiseResolve\", PromiseResolve);\n   env->SetMethod(target, \"promiseReject\", PromiseReject);\n+\n+  env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n }\n \n }  // namespace util"
        },
        {
            "sha": "ac7cf12229487a1daddafc36dcd7a7346479f5b8",
            "filename": "test/parallel/test-util-internal.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/916cfeca774e83925466f9a171f11c9bc73e4756/test%2Fparallel%2Ftest-util-internal.js",
            "raw_url": "https://github.com/nodejs/node/raw/916cfeca774e83925466f9a171f11c9bc73e4756/test%2Fparallel%2Ftest-util-internal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-internal.js?ref=916cfeca774e83925466f9a171f11c9bc73e4756",
            "patch": "@@ -8,9 +8,17 @@ const fixtures = require('../common/fixtures');\n const {\n   getHiddenValue,\n   setHiddenValue,\n-  arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex\n+  arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex,\n+  safeGetenv\n } = process.binding('util');\n \n+for (const oneEnv in process.env) {\n+  assert.strictEqual(\n+    safeGetenv(oneEnv),\n+    process.env[oneEnv]\n+  );\n+}\n+\n assert.strictEqual(\n   getHiddenValue({}, kArrowMessagePrivateSymbolIndex),\n   undefined);"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 31,
        "deletions": 7
    }
}