{
    "author": "boingoing",
    "message": "n-api,test: add a new.target test to addons-napi\n\nAdded a N-API test to verify new.target behavior.\n\nPR-URL: https://github.com/nodejs/node/pull/19236\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "a03c90b661f69200f124718b56b55b0cb3506c71",
    "files": [
        {
            "sha": "a74d4bb2f877beee35cdf013b429333bff1c0fa8",
            "filename": "test/addons-napi/test_new_target/binding.c",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/nodejs/node/blob/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Fbinding.c",
            "raw_url": "https://github.com/nodejs/node/raw/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Fbinding.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_new_target%2Fbinding.c?ref=a03c90b661f69200f124718b56b55b0cb3506c71",
            "patch": "@@ -0,0 +1,69 @@\n+#include <node_api.h>\n+#include \"../common.h\"\n+\n+napi_value BaseClass(napi_env env, napi_callback_info info) {\n+  napi_value newTargetArg;\n+  NAPI_CALL(env, napi_get_new_target(env, info, &newTargetArg));\n+  napi_value thisArg;\n+  NAPI_CALL(env, napi_get_cb_info(env, info, NULL, NULL, &thisArg, NULL));\n+  napi_value undefined;\n+  NAPI_CALL(env, napi_get_undefined(env, &undefined));\n+\n+  // this !== new.target since we are being invoked through super()\n+  bool result;\n+  NAPI_CALL(env, napi_strict_equals(env, newTargetArg, thisArg, &result));\n+  NAPI_ASSERT(env, !result, \"this !== new.target\");\n+\n+  // new.target !== undefined because we should be called as a new expression\n+  NAPI_ASSERT(env, newTargetArg != NULL, \"newTargetArg != NULL\");\n+  NAPI_CALL(env, napi_strict_equals(env, newTargetArg, undefined, &result));\n+  NAPI_ASSERT(env, !result, \"new.target !== undefined\");\n+\n+  return thisArg;\n+}\n+\n+napi_value Constructor(napi_env env, napi_callback_info info) {\n+  bool result;\n+  napi_value newTargetArg;\n+  NAPI_CALL(env, napi_get_new_target(env, info, &newTargetArg));\n+  size_t argc = 1;\n+  napi_value argv;\n+  napi_value thisArg;\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, &argv, &thisArg, NULL));\n+  napi_value undefined;\n+  NAPI_CALL(env, napi_get_undefined(env, &undefined));\n+\n+  // new.target !== undefined because we should be called as a new expression\n+  NAPI_ASSERT(env, newTargetArg != NULL, \"newTargetArg != NULL\");\n+  NAPI_CALL(env, napi_strict_equals(env, newTargetArg, undefined, &result));\n+  NAPI_ASSERT(env, !result, \"new.target !== undefined\");\n+\n+  // arguments[0] should be Constructor itself (test harness passed it)\n+  NAPI_CALL(env, napi_strict_equals(env, newTargetArg, argv, &result));\n+  NAPI_ASSERT(env, result, \"new.target === Constructor\");\n+\n+  return thisArg;\n+}\n+\n+napi_value OrdinaryFunction(napi_env env, napi_callback_info info) {\n+  napi_value newTargetArg;\n+  NAPI_CALL(env, napi_get_new_target(env, info, &newTargetArg));\n+\n+  NAPI_ASSERT(env, newTargetArg == NULL, \"newTargetArg == NULL\");\n+\n+  napi_value _true;\n+  NAPI_CALL(env, napi_get_boolean(env, true, &_true));\n+  return _true;\n+}\n+\n+napi_value Init(napi_env env, napi_value exports) {\n+  const napi_property_descriptor desc[] = {\n+    DECLARE_NAPI_PROPERTY(\"BaseClass\", BaseClass),\n+    DECLARE_NAPI_PROPERTY(\"OrdinaryFunction\", OrdinaryFunction),\n+    DECLARE_NAPI_PROPERTY(\"Constructor\", Constructor)\n+  };\n+  NAPI_CALL(env, napi_define_properties(env, exports, 3, desc));\n+  return exports;\n+}\n+\n+NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)"
        },
        {
            "sha": "23daf507916ff6649e5abfe4c082daa2dcc8010b",
            "filename": "test/addons-napi/test_new_target/binding.gyp",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_new_target%2Fbinding.gyp?ref=a03c90b661f69200f124718b56b55b0cb3506c71",
            "patch": "@@ -0,0 +1,9 @@\n+{\n+  'targets': [\n+    {\n+      'target_name': 'binding',\n+      'defines': [ 'V8_DEPRECATION_WARNINGS=1' ],\n+      'sources': [ 'binding.c' ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "702e8ca8b4387db3ef9741c57ea9d0c02deef699",
            "filename": "test/addons-napi/test_new_target/test.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/a03c90b661f69200f124718b56b55b0cb3506c71/test%2Faddons-napi%2Ftest_new_target%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_new_target%2Ftest.js?ref=a03c90b661f69200f124718b56b55b0cb3506c71",
            "patch": "@@ -0,0 +1,21 @@\n+'use strict';\n+\n+const common = require('../../common');\n+const assert = require('assert');\n+const binding = require(`./build/${common.buildType}/binding`);\n+\n+class Class extends binding.BaseClass {\n+  constructor() {\n+    super();\n+    this.method();\n+  }\n+  method() {\n+    this.ok = true;\n+  }\n+}\n+\n+assert.ok(new Class() instanceof binding.BaseClass);\n+assert.ok(new Class().ok);\n+assert.ok(binding.OrdinaryFunction());\n+assert.ok(\n+  new binding.Constructor(binding.Constructor) instanceof binding.Constructor);"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 99,
        "deletions": 0
    }
}