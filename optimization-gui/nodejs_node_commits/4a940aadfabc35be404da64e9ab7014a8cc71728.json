{
    "author": "lpinca",
    "message": "http: do not rely on the 'agentRemove' event\n\nDo not use the `'agentRemove'` event to null `socket._httpMessage` as\nthat event is public and can be used to not keep a request in the agent.\n\nPR-URL: https://github.com/nodejs/node/pull/20786\nFixes: https://github.com/nodejs/node/issues/20690\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "4a940aadfabc35be404da64e9ab7014a8cc71728",
    "files": [
        {
            "sha": "67f3d667b28169203c53a69ac5dff4b88107f36b",
            "filename": "lib/_http_agent.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4a940aadfabc35be404da64e9ab7014a8cc71728/lib%2F_http_agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/4a940aadfabc35be404da64e9ab7014a8cc71728/lib%2F_http_agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_agent.js?ref=4a940aadfabc35be404da64e9ab7014a8cc71728",
            "patch": "@@ -276,7 +276,6 @@ function installListeners(agent, s, options) {\n     s.removeListener('close', onClose);\n     s.removeListener('free', onFree);\n     s.removeListener('agentRemove', onRemove);\n-    s._httpMessage = null;\n   }\n   s.on('agentRemove', onRemove);\n }"
        },
        {
            "sha": "4542a81cf0e9a1599b6d1b8cf5fa586d78c6bf9e",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4a940aadfabc35be404da64e9ab7014a8cc71728/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/4a940aadfabc35be404da64e9ab7014a8cc71728/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=4a940aadfabc35be404da64e9ab7014a8cc71728",
            "patch": "@@ -467,6 +467,7 @@ function socketOnData(d) {\n       socket.removeListener('close', socketCloseListener);\n       socket.removeListener('error', socketErrorListener);\n \n+      socket._httpMessage = null;\n       socket.readableFlowing = null;\n \n       req.emit(eventName, res, socket, bodyHead);"
        },
        {
            "sha": "24fc7fcb8282fefb813c41ba4f040794f494d517",
            "filename": "test/parallel/test-http-agent-remove.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/4a940aadfabc35be404da64e9ab7014a8cc71728/test%2Fparallel%2Ftest-http-agent-remove.js",
            "raw_url": "https://github.com/nodejs/node/raw/4a940aadfabc35be404da64e9ab7014a8cc71728/test%2Fparallel%2Ftest-http-agent-remove.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-remove.js?ref=4a940aadfabc35be404da64e9ab7014a8cc71728",
            "patch": "@@ -0,0 +1,21 @@\n+'use strict';\n+const { mustCall } = require('../common');\n+\n+const http = require('http');\n+const { strictEqual } = require('assert');\n+\n+const server = http.createServer(mustCall((req, res) => {\n+  res.flushHeaders();\n+}));\n+\n+server.listen(0, mustCall(() => {\n+  const req = http.get({\n+    port: server.address().port\n+  }, mustCall(() => {\n+    const { socket } = req;\n+    socket.emit('agentRemove');\n+    strictEqual(socket._httpMessage, req);\n+    socket.destroy();\n+    server.close();\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 22,
        "deletions": 1
    }
}