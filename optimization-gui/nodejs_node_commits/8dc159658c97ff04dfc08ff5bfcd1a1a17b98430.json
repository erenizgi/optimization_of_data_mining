{
    "author": "targos",
    "message": "deps: cherry-pick c608122 from upstream V8\n\nOriginal commit message:\n\n    [api][keys] Allow skipping indices for Proxies with GetPropertyNames\n\n    Bug: v8:7942\n    Change-Id: I7b3740b04cbcaa56dc809150900ab8d821b054ce\n    Reviewed-on: https://chromium-review.googlesource.com/1156544\n    Reviewed-by: Toon Verwaest <verwaest@chromium.org>\n    Commit-Queue: Camillo Bruni <cbruni@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#54821}\n\nRefs: https://github.com/v8/v8/commit/c608122b85238397a43910246f5ff218eb43fb24\n\nPR-URL: https://github.com/nodejs/node/pull/21983\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Ujjwal Sharma <usharma1998@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
    "files": [
        {
            "sha": "4dd3bf632f2f377779a8dd246fd785e4c313be0e",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
            "patch": "@@ -29,7 +29,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.3',\n+    'v8_embedder_string': '-node.4',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "689f4ac3dfeb8d3980946884c57237778724e132",
            "filename": "deps/v8/src/keys.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 18,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fkeys.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fkeys.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fkeys.cc?ref=8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
            "patch": "@@ -38,10 +38,10 @@ static bool ContainsOnlyValidKeys(Handle<FixedArray> array) {\n // static\n MaybeHandle<FixedArray> KeyAccumulator::GetKeys(\n     Handle<JSReceiver> object, KeyCollectionMode mode, PropertyFilter filter,\n-    GetKeysConversion keys_conversion, bool is_for_in) {\n+    GetKeysConversion keys_conversion, bool is_for_in, bool skip_indices) {\n   Isolate* isolate = object->GetIsolate();\n-  FastKeyAccumulator accumulator(isolate, object, mode, filter);\n-  accumulator.set_is_for_in(is_for_in);\n+  FastKeyAccumulator accumulator(isolate, object, mode, filter, is_for_in,\n+                                 skip_indices);\n   return accumulator.GetKeys(keys_conversion);\n }\n \n@@ -355,7 +355,8 @@ Handle<FixedArray> GetFastEnumPropertyKeys(Isolate* isolate,\n template <bool fast_properties>\n MaybeHandle<FixedArray> GetOwnKeysWithElements(Isolate* isolate,\n                                                Handle<JSObject> object,\n-                                               GetKeysConversion convert) {\n+                                               GetKeysConversion convert,\n+                                               bool skip_indices) {\n   Handle<FixedArray> keys;\n   ElementsAccessor* accessor = object->GetElementsAccessor();\n   if (fast_properties) {\n@@ -364,8 +365,14 @@ MaybeHandle<FixedArray> GetOwnKeysWithElements(Isolate* isolate,\n     // TODO(cbruni): preallocate big enough array to also hold elements.\n     keys = KeyAccumulator::GetOwnEnumPropertyKeys(isolate, object);\n   }\n-  MaybeHandle<FixedArray> result =\n-      accessor->PrependElementIndices(object, keys, convert, ONLY_ENUMERABLE);\n+\n+  MaybeHandle<FixedArray> result;\n+  if (skip_indices) {\n+    result = keys;\n+  } else {\n+    result =\n+        accessor->PrependElementIndices(object, keys, convert, ONLY_ENUMERABLE);\n+  }\n \n   if (FLAG_trace_for_in_enumerate) {\n     PrintF(\"| strings=%d symbols=0 elements=%u || prototypes>=1 ||\\n\",\n@@ -403,7 +410,8 @@ MaybeHandle<FixedArray> FastKeyAccumulator::GetKeysFast(\n \n   // Do not try to use the enum-cache for dict-mode objects.\n   if (map->is_dictionary_map()) {\n-    return GetOwnKeysWithElements<false>(isolate_, object, keys_conversion);\n+    return GetOwnKeysWithElements<false>(isolate_, object, keys_conversion,\n+                                         skip_indices_);\n   }\n   int enum_length = receiver_->map()->EnumLength();\n   if (enum_length == kInvalidEnumCacheSentinel) {\n@@ -421,7 +429,8 @@ MaybeHandle<FixedArray> FastKeyAccumulator::GetKeysFast(\n   }\n   // The properties-only case failed because there were probably elements on the\n   // receiver.\n-  return GetOwnKeysWithElements<true>(isolate_, object, keys_conversion);\n+  return GetOwnKeysWithElements<true>(isolate_, object, keys_conversion,\n+                                      skip_indices_);\n }\n \n MaybeHandle<FixedArray>\n@@ -450,6 +459,7 @@ MaybeHandle<FixedArray> FastKeyAccumulator::GetKeysSlow(\n     GetKeysConversion keys_conversion) {\n   KeyAccumulator accumulator(isolate_, mode_, filter_);\n   accumulator.set_is_for_in(is_for_in_);\n+  accumulator.set_skip_indices(skip_indices_);\n   accumulator.set_last_non_empty_prototype(last_non_empty_prototype_);\n \n   MAYBE_RETURN(accumulator.CollectKeys(receiver_, receiver_),\n@@ -699,13 +709,15 @@ Maybe<bool> KeyAccumulator::CollectOwnPropertyNames(Handle<JSReceiver> receiver,\n Maybe<bool> KeyAccumulator::CollectAccessCheckInterceptorKeys(\n     Handle<AccessCheckInfo> access_check_info, Handle<JSReceiver> receiver,\n     Handle<JSObject> object) {\n-  MAYBE_RETURN((CollectInterceptorKeysInternal(\n-                   receiver, object,\n-                   handle(InterceptorInfo::cast(\n-                              access_check_info->indexed_interceptor()),\n-                          isolate_),\n-                   this, kIndexed)),\n-               Nothing<bool>());\n+  if (!skip_indices_) {\n+    MAYBE_RETURN((CollectInterceptorKeysInternal(\n+                     receiver, object,\n+                     handle(InterceptorInfo::cast(\n+                                access_check_info->indexed_interceptor()),\n+                            isolate_),\n+                     this, kIndexed)),\n+                 Nothing<bool>());\n+  }\n   MAYBE_RETURN(\n       (CollectInterceptorKeysInternal(\n           receiver, object,\n@@ -942,9 +954,9 @@ Maybe<bool> KeyAccumulator::CollectOwnJSProxyTargetKeys(\n   Handle<FixedArray> keys;\n   ASSIGN_RETURN_ON_EXCEPTION_VALUE(\n       isolate_, keys,\n-      KeyAccumulator::GetKeys(target, KeyCollectionMode::kOwnOnly,\n-                              ALL_PROPERTIES,\n-                              GetKeysConversion::kConvertToString, is_for_in_),\n+      KeyAccumulator::GetKeys(\n+          target, KeyCollectionMode::kOwnOnly, ALL_PROPERTIES,\n+          GetKeysConversion::kConvertToString, is_for_in_, skip_indices_),\n       Nothing<bool>());\n   Maybe<bool> result = AddKeysFromJSProxy(proxy, keys);\n   return result;"
        },
        {
            "sha": "5abbaac5cd0e5af2d9dca0d41d927b4b72c626ec",
            "filename": "deps/v8/src/keys.h",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fkeys.h",
            "raw_url": "https://github.com/nodejs/node/raw/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fkeys.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fkeys.h?ref=8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
            "patch": "@@ -40,7 +40,7 @@ class KeyAccumulator final BASE_EMBEDDED {\n   static MaybeHandle<FixedArray> GetKeys(\n       Handle<JSReceiver> object, KeyCollectionMode mode, PropertyFilter filter,\n       GetKeysConversion keys_conversion = GetKeysConversion::kKeepNumbers,\n-      bool is_for_in = false);\n+      bool is_for_in = false, bool skip_indices = false);\n \n   Handle<FixedArray> GetKeys(\n       GetKeysConversion convert = GetKeysConversion::kKeepNumbers);\n@@ -128,14 +128,19 @@ class KeyAccumulator final BASE_EMBEDDED {\n class FastKeyAccumulator {\n  public:\n   FastKeyAccumulator(Isolate* isolate, Handle<JSReceiver> receiver,\n-                     KeyCollectionMode mode, PropertyFilter filter)\n-      : isolate_(isolate), receiver_(receiver), mode_(mode), filter_(filter) {\n+                     KeyCollectionMode mode, PropertyFilter filter,\n+                     bool is_for_in = false, bool skip_indices = false)\n+      : isolate_(isolate),\n+        receiver_(receiver),\n+        mode_(mode),\n+        filter_(filter),\n+        is_for_in_(is_for_in),\n+        skip_indices_(skip_indices) {\n     Prepare();\n   }\n \n   bool is_receiver_simple_enum() { return is_receiver_simple_enum_; }\n   bool has_empty_prototype() { return has_empty_prototype_; }\n-  void set_is_for_in(bool value) { is_for_in_ = value; }\n \n   MaybeHandle<FixedArray> GetKeys(\n       GetKeysConversion convert = GetKeysConversion::kKeepNumbers);\n@@ -153,6 +158,7 @@ class FastKeyAccumulator {\n   KeyCollectionMode mode_;\n   PropertyFilter filter_;\n   bool is_for_in_ = false;\n+  bool skip_indices_ = false;\n   bool is_receiver_simple_enum_ = false;\n   bool has_empty_prototype_ = false;\n "
        },
        {
            "sha": "ed1e2260602f42d1dba93d0f26357a30a19bc29f",
            "filename": "deps/v8/src/runtime/runtime-forin.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-forin.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-forin.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-forin.cc?ref=8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
            "patch": "@@ -26,8 +26,7 @@ MaybeHandle<HeapObject> Enumerate(Isolate* isolate,\n   JSObject::MakePrototypesFast(receiver, kStartAtReceiver, isolate);\n   FastKeyAccumulator accumulator(isolate, receiver,\n                                  KeyCollectionMode::kIncludePrototypes,\n-                                 ENUMERABLE_STRINGS);\n-  accumulator.set_is_for_in(true);\n+                                 ENUMERABLE_STRINGS, true);\n   // Test if we have an enum cache for {receiver}.\n   if (!accumulator.is_receiver_simple_enum()) {\n     Handle<FixedArray> keys;"
        },
        {
            "sha": "a018e12853199aaff9d4aa914429baa03501a830",
            "filename": "deps/v8/test/cctest/test-api.cc",
            "status": "modified",
            "additions": 95,
            "deletions": 2,
            "changes": 97,
            "blob_url": "https://github.com/nodejs/node/blob/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8dc159658c97ff04dfc08ff5bfcd1a1a17b98430/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc?ref=8dc159658c97ff04dfc08ff5bfcd1a1a17b98430",
            "patch": "@@ -15360,14 +15360,107 @@ THREADED_TEST(PropertyEnumeration2) {\n   }\n }\n \n-THREADED_TEST(PropertyNames) {\n+THREADED_TEST(GetPropertyNames) {\n   LocalContext context;\n   v8::Isolate* isolate = context->GetIsolate();\n   v8::HandleScope scope(isolate);\n   v8::Local<v8::Value> result = CompileRun(\n       \"var result = {0: 0, 1: 1, a: 2, b: 3};\"\n       \"result[Symbol('symbol')] = true;\"\n-      \"result.__proto__ = {2: 4, 3: 5, c: 6, d: 7};\"\n+      \"result.__proto__ = {__proto__:null, 2: 4, 3: 5, c: 6, d: 7};\"\n+      \"result;\");\n+  v8::Local<v8::Object> object = result.As<v8::Object>();\n+  v8::PropertyFilter default_filter =\n+      static_cast<v8::PropertyFilter>(v8::ONLY_ENUMERABLE | v8::SKIP_SYMBOLS);\n+  v8::PropertyFilter include_symbols_filter = v8::ONLY_ENUMERABLE;\n+\n+  v8::Local<v8::Array> properties =\n+      object->GetPropertyNames(context.local()).ToLocalChecked();\n+  const char* expected_properties1[] = {\"0\", \"1\", \"a\", \"b\", \"2\", \"3\", \"c\", \"d\"};\n+  CheckStringArray(isolate, properties, 8, expected_properties1);\n+\n+  properties =\n+      object\n+          ->GetPropertyNames(context.local(),\n+                             v8::KeyCollectionMode::kIncludePrototypes,\n+                             default_filter, v8::IndexFilter::kIncludeIndices)\n+          .ToLocalChecked();\n+  CheckStringArray(isolate, properties, 8, expected_properties1);\n+\n+  properties = object\n+                   ->GetPropertyNames(context.local(),\n+                                      v8::KeyCollectionMode::kIncludePrototypes,\n+                                      include_symbols_filter,\n+                                      v8::IndexFilter::kIncludeIndices)\n+                   .ToLocalChecked();\n+  const char* expected_properties1_1[] = {\"0\", \"1\", \"a\", \"b\", nullptr,\n+                                          \"2\", \"3\", \"c\", \"d\"};\n+  CheckStringArray(isolate, properties, 9, expected_properties1_1);\n+  CheckIsSymbolAt(isolate, properties, 4, \"symbol\");\n+\n+  properties =\n+      object\n+          ->GetPropertyNames(context.local(),\n+                             v8::KeyCollectionMode::kIncludePrototypes,\n+                             default_filter, v8::IndexFilter::kSkipIndices)\n+          .ToLocalChecked();\n+  const char* expected_properties2[] = {\"a\", \"b\", \"c\", \"d\"};\n+  CheckStringArray(isolate, properties, 4, expected_properties2);\n+\n+  properties = object\n+                   ->GetPropertyNames(context.local(),\n+                                      v8::KeyCollectionMode::kIncludePrototypes,\n+                                      include_symbols_filter,\n+                                      v8::IndexFilter::kSkipIndices)\n+                   .ToLocalChecked();\n+  const char* expected_properties2_1[] = {\"a\", \"b\", nullptr, \"c\", \"d\"};\n+  CheckStringArray(isolate, properties, 5, expected_properties2_1);\n+  CheckIsSymbolAt(isolate, properties, 2, \"symbol\");\n+\n+  properties =\n+      object\n+          ->GetPropertyNames(context.local(), v8::KeyCollectionMode::kOwnOnly,\n+                             default_filter, v8::IndexFilter::kIncludeIndices)\n+          .ToLocalChecked();\n+  const char* expected_properties3[] = {\"0\", \"1\", \"a\", \"b\"};\n+  CheckStringArray(isolate, properties, 4, expected_properties3);\n+\n+  properties = object\n+                   ->GetPropertyNames(\n+                       context.local(), v8::KeyCollectionMode::kOwnOnly,\n+                       include_symbols_filter, v8::IndexFilter::kIncludeIndices)\n+                   .ToLocalChecked();\n+  const char* expected_properties3_1[] = {\"0\", \"1\", \"a\", \"b\", nullptr};\n+  CheckStringArray(isolate, properties, 5, expected_properties3_1);\n+  CheckIsSymbolAt(isolate, properties, 4, \"symbol\");\n+\n+  properties =\n+      object\n+          ->GetPropertyNames(context.local(), v8::KeyCollectionMode::kOwnOnly,\n+                             default_filter, v8::IndexFilter::kSkipIndices)\n+          .ToLocalChecked();\n+  const char* expected_properties4[] = {\"a\", \"b\"};\n+  CheckStringArray(isolate, properties, 2, expected_properties4);\n+\n+  properties = object\n+                   ->GetPropertyNames(\n+                       context.local(), v8::KeyCollectionMode::kOwnOnly,\n+                       include_symbols_filter, v8::IndexFilter::kSkipIndices)\n+                   .ToLocalChecked();\n+  const char* expected_properties4_1[] = {\"a\", \"b\", nullptr};\n+  CheckStringArray(isolate, properties, 3, expected_properties4_1);\n+  CheckIsSymbolAt(isolate, properties, 2, \"symbol\");\n+}\n+\n+THREADED_TEST(ProxyGetPropertyNames) {\n+  LocalContext context;\n+  v8::Isolate* isolate = context->GetIsolate();\n+  v8::HandleScope scope(isolate);\n+  v8::Local<v8::Value> result = CompileRun(\n+      \"var target = {0: 0, 1: 1, a: 2, b: 3};\"\n+      \"target[Symbol('symbol')] = true;\"\n+      \"target.__proto__ = {__proto__:null, 2: 4, 3: 5, c: 6, d: 7};\"\n+      \"var result = new Proxy(target, {});\"\n       \"result;\");\n   v8::Local<v8::Object> object = result.As<v8::Object>();\n   v8::PropertyFilter default_filter ="
        }
    ],
    "stats": {
        "total": 164,
        "additions": 137,
        "deletions": 27
    }
}