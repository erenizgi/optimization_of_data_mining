{
    "author": "addaleax",
    "message": "worker: fix deadlock when calling terminate from exit handler\n\nJust before we call the `'exit'` handlers of a Worker, we drain\nthe public port’s message queue to ensure proper ordering.\nPreviously, we held the Worker’s `mutex_` during the\nexit handler call, so calling `terminate()` on the worker\ncould lead to a deadlock if called from one of those message\nhandlers.\n\nThis fixes flakiness in the `parallel/test-worker-dns-terminate` test.\n\nPR-URL: https://github.com/nodejs/node/pull/22073\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e3bae655839ea7f0019f7e6bd33fe941a5f6be62",
    "files": [
        {
            "sha": "06edb96804119be61e20a1133c9d3771424d9f67",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 12,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/e3bae655839ea7f0019f7e6bd33fe941a5f6be62/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e3bae655839ea7f0019f7e6bd33fe941a5f6be62/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=e3bae655839ea7f0019f7e6bd33fe941a5f6be62",
            "patch": "@@ -287,22 +287,21 @@ void Worker::JoinThread() {\n }\n \n void Worker::OnThreadStopped() {\n-  Mutex::ScopedLock lock(mutex_);\n-  scheduled_on_thread_stopped_ = false;\n+  {\n+    Mutex::ScopedLock lock(mutex_);\n+    scheduled_on_thread_stopped_ = false;\n \n-  Debug(this, \"Worker %llu thread stopped\", thread_id_);\n+    Debug(this, \"Worker %llu thread stopped\", thread_id_);\n \n-  {\n-    Mutex::ScopedLock stopped_lock(stopped_mutex_);\n-    CHECK(stopped_);\n-  }\n+    {\n+      Mutex::ScopedLock stopped_lock(stopped_mutex_);\n+      CHECK(stopped_);\n+    }\n \n-  CHECK_EQ(child_port_, nullptr);\n-  parent_port_ = nullptr;\n+    CHECK_EQ(child_port_, nullptr);\n+    parent_port_ = nullptr;\n+  }\n \n-  // It's okay to join the thread while holding the mutex because\n-  // OnThreadStopped means it's no longer doing any work that might grab it\n-  // and really just silently exiting.\n   JoinThread();\n \n   {\n@@ -369,6 +368,7 @@ void Worker::StopThread(const FunctionCallbackInfo<Value>& args) {\n   Worker* w;\n   ASSIGN_OR_RETURN_UNWRAP(&w, args.This());\n \n+  Debug(w, \"Worker %llu is getting stopped by parent\", w->thread_id_);\n   w->Exit(1);\n   w->JoinThread();\n }"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 12,
        "deletions": 12
    }
}