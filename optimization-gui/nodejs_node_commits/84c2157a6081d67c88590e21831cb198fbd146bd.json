{
    "author": "rvagg",
    "message": "tools: check for git tag before promoting release\n\nPR-URL: https://github.com/nodejs/node/pull/24670\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "84c2157a6081d67c88590e21831cb198fbd146bd",
    "files": [
        {
            "sha": "c828162f0ca54c9299c3394669558950ceccd00e",
            "filename": "tools/release.sh",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/84c2157a6081d67c88590e21831cb198fbd146bd/tools%2Frelease.sh",
            "raw_url": "https://github.com/nodejs/node/raw/84c2157a6081d67c88590e21831cb198fbd146bd/tools%2Frelease.sh",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Frelease.sh?ref=84c2157a6081d67c88590e21831cb198fbd146bd",
            "patch": "@@ -81,6 +81,14 @@ fi\n echo \"Using GPG key: $gpgkey\"\n echo \"  Fingerprint: $gpgfing\"\n \n+function checktag {\n+  local version=$1\n+\n+  if ! git tag -v $version 2>&1 | grep \"${gpgkey}\" | grep key > /dev/null; then\n+    echo \"Could not find signed tag for \\\"${version}\\\" or GPG key is not yours\"\n+    exit 1\n+  fi\n+}\n \n ################################################################################\n ## Create and sign checksums file for a given version\n@@ -90,11 +98,6 @@ function sign {\n \n   local version=$1\n \n-  if ! git tag -v $version 2>&1 | grep \"${gpgkey}\" | grep key > /dev/null; then\n-    echo \"Could not find signed tag for \\\"${version}\\\" or GPG key is not yours\"\n-    exit 1\n-  fi\n-\n   ghtaggedversion=$(curl -sL https://raw.githubusercontent.com/nodejs/node/${version}/src/node_version.h \\\n       | awk '/define NODE_(MAJOR|MINOR|PATCH)_VERSION/{ v = v \".\" $3 } END{ v = \"v\" substr(v, 2); print v }')\n   if [ \"${version}\" != \"${ghtaggedversion}\" ]; then\n@@ -150,7 +153,8 @@ function sign {\n \n \n if [ -n \"${signversion}\" ]; then\n-    sign ${signversion}\n+\t\tchecktag $signversion\n+    sign $signversion\n     exit 0\n fi\n \n@@ -192,6 +196,8 @@ for version in $versions; do\n       continue\n     fi\n \n+\t\tchecktag $version\n+\n     echo -e \"\\n# Promoting ${version}...\"\n \n     ssh ${customsshkey} ${webuser}@${webhost} $promotecmd nodejs $version"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 12,
        "deletions": 6
    }
}