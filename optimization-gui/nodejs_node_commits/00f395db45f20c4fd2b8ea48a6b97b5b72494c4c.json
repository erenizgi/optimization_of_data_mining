{
    "author": "addaleax",
    "message": "src: make `AsyncResource` destructor virtual\n\n`AsyncResource` is intended to be a base class, and since we don’t\nknow what API consumers will do with it in their own code,\nit’s good practice to make its destructor virtual.\n\nThis should not be ABI-breaking since all class methods are inline.\n\nPR-URL: https://github.com/nodejs/node/pull/20633\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "00f395db45f20c4fd2b8ea48a6b97b5b72494c4c",
    "files": [
        {
            "sha": "5d6aa8dadfc8c4c22513b1072cd2b2798e1f358e",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=00f395db45f20c4fd2b8ea48a6b97b5b72494c4c",
            "patch": "@@ -712,7 +712,7 @@ class AsyncResource {\n                                      trigger_async_id);\n     }\n \n-    ~AsyncResource() {\n+    virtual ~AsyncResource() {\n       EmitAsyncDestroy(isolate_, async_context_);\n     }\n "
        },
        {
            "sha": "ab33858c233dd03ef28f88e7354d90a781286610",
            "filename": "test/addons/async-resource/binding.cc",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/test%2Faddons%2Fasync-resource%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/test%2Faddons%2Fasync-resource%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fasync-resource%2Fbinding.cc?ref=00f395db45f20c4fd2b8ea48a6b97b5b72494c4c",
            "patch": "@@ -17,6 +17,17 @@ using v8::Object;\n using v8::String;\n using v8::Value;\n \n+int custom_async_resource_destructor_calls = 0;\n+\n+class CustomAsyncResource : public AsyncResource {\n+ public:\n+  CustomAsyncResource(Isolate* isolate, Local<Object> resource)\n+      : AsyncResource(isolate, resource, \"CustomAsyncResource\") {}\n+  ~CustomAsyncResource() {\n+    custom_async_resource_destructor_calls++;\n+  }\n+};\n+\n void CreateAsyncResource(const FunctionCallbackInfo<Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n   assert(args[0]->IsObject());\n@@ -98,6 +109,16 @@ void GetResource(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(r->get_resource());\n }\n \n+void RunSubclassTest(const FunctionCallbackInfo<Value>& args) {\n+  Isolate* isolate = args.GetIsolate();\n+  Local<Object> obj = Object::New(isolate);\n+\n+  assert(custom_async_resource_destructor_calls == 0);\n+  CustomAsyncResource* resource = new CustomAsyncResource(isolate, obj);\n+  delete static_cast<AsyncResource*>(resource);\n+  assert(custom_async_resource_destructor_calls == 1);\n+}\n+\n void Initialize(Local<Object> exports) {\n   NODE_SET_METHOD(exports, \"createAsyncResource\", CreateAsyncResource);\n   NODE_SET_METHOD(exports, \"destroyAsyncResource\", DestroyAsyncResource);\n@@ -107,6 +128,7 @@ void Initialize(Local<Object> exports) {\n   NODE_SET_METHOD(exports, \"getAsyncId\", GetAsyncId);\n   NODE_SET_METHOD(exports, \"getTriggerAsyncId\", GetTriggerAsyncId);\n   NODE_SET_METHOD(exports, \"getResource\", GetResource);\n+  NODE_SET_METHOD(exports, \"runSubclassTest\", RunSubclassTest);\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "c37d4df83d010328de81ae00ca97937d4218cca1",
            "filename": "test/addons/async-resource/test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/test%2Faddons%2Fasync-resource%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/00f395db45f20c4fd2b8ea48a6b97b5b72494c4c/test%2Faddons%2Fasync-resource%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fasync-resource%2Ftest.js?ref=00f395db45f20c4fd2b8ea48a6b97b5b72494c4c",
            "patch": "@@ -5,6 +5,8 @@ const assert = require('assert');\n const binding = require(`./build/${common.buildType}/binding`);\n const async_hooks = require('async_hooks');\n \n+binding.runSubclassTest();\n+\n const kObjectTag = Symbol('kObjectTag');\n const rootAsyncId = async_hooks.executionAsyncId();\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 25,
        "deletions": 1
    }
}