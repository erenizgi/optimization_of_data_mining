{
    "author": "Jimbly",
    "message": "child_process: allow 'http_parser' monkey patching again\n\nLazy load _http_common and HTTPParser so that the 'http_parser' binding\ncan be monkey patched before any internal modules require it. This also\nprobably improves startup performance minimally for programs that never\nrequire the HTTP stack.\n\nFixes: https://github.com/nodejs/node/issues/23716\nFixes: https://github.com/creationix/http-parser-js/issues/57\n\nPR-URL: https://github.com/nodejs/node/pull/24006\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "7d86a5324bc29c21afce8cba3dba508b78d48cd5",
    "files": [
        {
            "sha": "2f19f28b591cd52b450ad7333ba2ee69a7d233aa",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/7d86a5324bc29c21afce8cba3dba508b78d48cd5/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d86a5324bc29c21afce8cba3dba508b78d48cd5/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=7d86a5324bc29c21afce8cba3dba508b78d48cd5",
            "patch": "@@ -38,8 +38,6 @@ const { owner_symbol } = require('internal/async_hooks').symbols;\n const { convertToValidSignal } = require('internal/util');\n const { isArrayBufferView } = require('internal/util/types');\n const spawn_sync = internalBinding('spawn_sync');\n-const { HTTPParser } = internalBinding('http_parser');\n-const { freeParser } = require('_http_common');\n const { kStateSymbol } = require('internal/dgram');\n \n const {\n@@ -57,6 +55,10 @@ const { SocketListSend, SocketListReceive } = SocketList;\n \n // Lazy loaded for startup performance.\n let StringDecoder;\n+// Lazy loaded for startup performance and to allow monkey patching of\n+// internalBinding('http_parser').HTTPParser.\n+let freeParser;\n+let HTTPParser;\n \n const MAX_HANDLE_RETRANSMISSIONS = 3;\n \n@@ -121,6 +123,12 @@ const handleConversion = {\n         handle.onread = nop;\n         socket._handle = null;\n         socket.setTimeout(0);\n+\n+        if (freeParser === undefined)\n+          freeParser = require('_http_common').freeParser;\n+        if (HTTPParser === undefined)\n+          HTTPParser = internalBinding('http_parser').HTTPParser;\n+\n         // In case of an HTTP connection socket, release the associated\n         // resources\n         if (socket.parser && socket.parser instanceof HTTPParser) {"
        },
        {
            "sha": "c1eb29fb163d0036d5e683c7ac5008a7e4e5b27a",
            "filename": "test/parallel/test-http-parser-lazy-loaded.js",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/7d86a5324bc29c21afce8cba3dba508b78d48cd5/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js",
            "raw_url": "https://github.com/nodejs/node/raw/7d86a5324bc29c21afce8cba3dba508b78d48cd5/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js?ref=7d86a5324bc29c21afce8cba3dba508b78d48cd5",
            "patch": "@@ -0,0 +1,37 @@\n+// Flags: --expose-internals\n+\n+'use strict';\n+\n+const { internalBinding } = require('internal/test/binding');\n+\n+// Monkey patch before requiring anything\n+class DummyParser {\n+  constructor(type) {\n+    this.test_type = type;\n+  }\n+}\n+DummyParser.REQUEST = Symbol();\n+internalBinding('http_parser').HTTPParser = DummyParser;\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const { spawn } = require('child_process');\n+const { parsers } = require('_http_common');\n+\n+// Test _http_common was not loaded before monkey patching\n+const parser = parsers.alloc();\n+assert.strictEqual(parser instanceof DummyParser, true);\n+assert.strictEqual(parser.test_type, DummyParser.REQUEST);\n+\n+if (process.argv[2] !== 'child') {\n+  // Also test in a child process with IPC (specific case of https://github.com/nodejs/node/issues/23716)\n+  const child = spawn(process.execPath, [\n+    '--expose-internals', __filename, 'child'\n+  ], {\n+    stdio: ['inherit', 'inherit', 'inherit', 'ipc']\n+  });\n+  child.on('exit', common.mustCall((code, signal) => {\n+    assert.strictEqual(code, 0);\n+    assert.strictEqual(signal, null);\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 47,
        "deletions": 2
    }
}