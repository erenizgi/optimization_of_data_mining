{
    "author": "BridgeAR",
    "message": "repl: indicate if errors are thrown or not\n\nCurrently an error is printed identical, no matter if it is just\ninspected or if the error is thrown inside of the REPL. This makes\nsure we are able to distinguish these cases.\n\nPR-URL: https://github.com/nodejs/node/pull/25253\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "edde0651912aca116f7e23c548bc5b56407a8056",
    "files": [
        {
            "sha": "30812c232b7639bfcffedb0c7ca5236d3f32a34d",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -435,15 +435,18 @@ function REPLServer(prompt,\n     }\n \n     if (errStack === '') {\n-      errStack = `Thrown: ${util.inspect(e)}`;\n+      errStack = `Thrown: ${util.inspect(e)}\\n`;\n+    } else {\n+      const ln = errStack.endsWith('\\n') ? '' : '\\n';\n+      errStack = `Thrown:\\n${errStack}${ln}`;\n     }\n \n     if (!self.underscoreErrAssigned) {\n       self.lastError = e;\n     }\n \n     const top = replMap.get(self);\n-    top.outputStream.write(`${errStack}\\n`);\n+    top.outputStream.write(errStack);\n     top.clearBufferedCommand();\n     top.lines.level = [];\n     top.displayPrompt();"
        },
        {
            "sha": "6686e63fe028ed62ace85eadbbcce764192f9aa6",
            "filename": "test/parallel/test-repl-harmony.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-harmony.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-harmony.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-harmony.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -30,7 +30,7 @@ const child = spawn(process.execPath, args);\n const input = '(function(){\"use strict\"; const y=1;y=2})()\\n';\n // This message will vary based on JavaScript engine, so don't check the message\n // contents beyond confirming that the `Error` is a `TypeError`.\n-const expectOut = /^> TypeError: /;\n+const expectOut = /^> Thrown:\\nTypeError: /;\n \n child.stderr.setEncoding('utf8');\n child.stderr.on('data', function(c) {"
        },
        {
            "sha": "a37cf04263433db29289ba2f4bc686d4c1e2535a",
            "filename": "test/parallel/test-repl-pretty-custom-stack.js",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -46,25 +46,26 @@ const tests = [\n   {\n     // test .load for a file that throws\n     command: `.load ${fixtures.path('repl-pretty-stack.js')}`,\n-    expected: 'Error: Whoops!--->\\nrepl:9:24--->\\nd (repl:12:3)--->\\nc ' +\n-              '(repl:9:3)--->\\nb (repl:6:3)--->\\na (repl:3:3)\\n'\n+    expected: 'Thrown:\\nError: Whoops!--->\\nrepl:9:24--->\\nd (repl:12:3)' +\n+              '--->\\nc (repl:9:3)--->\\nb (repl:6:3)--->\\na (repl:3:3)\\n'\n   },\n   {\n     command: 'let x y;',\n-    expected: 'let x y;\\n      ^\\n\\nSyntaxError: Unexpected identifier\\n'\n+    expected: 'Thrown:\\n' +\n+              'let x y;\\n      ^\\n\\nSyntaxError: Unexpected identifier\\n'\n   },\n   {\n     command: 'throw new Error(\\'Whoops!\\')',\n-    expected: 'Error: Whoops!\\n'\n+    expected: 'Thrown:\\nError: Whoops!\\n'\n   },\n   {\n     command: 'foo = bar;',\n-    expected: 'ReferenceError: bar is not defined\\n'\n+    expected: 'Thrown:\\nReferenceError: bar is not defined\\n'\n   },\n   // test anonymous IIFE\n   {\n     command: '(function() { throw new Error(\\'Whoops!\\'); })()',\n-    expected: 'Error: Whoops!--->\\nrepl:1:21\\n'\n+    expected: 'Thrown:\\nError: Whoops!--->\\nrepl:1:21\\n'\n   }\n ];\n "
        },
        {
            "sha": "e4137b84a4c2b58dfaa53317c68247264c8ea8ff",
            "filename": "test/parallel/test-repl-pretty-stack.js",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-stack.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -31,25 +31,27 @@ const tests = [\n   {\n     // test .load for a file that throws\n     command: `.load ${fixtures.path('repl-pretty-stack.js')}`,\n-    expected: 'Error: Whoops!\\n    at repl:9:24\\n    at d (repl:12:3)\\n    ' +\n-              'at c (repl:9:3)\\n    at b (repl:6:3)\\n    at a (repl:3:3)\\n'\n+    expected: 'Thrown:\\nError: Whoops!\\n    at repl:9:24\\n' +\n+              '    at d (repl:12:3)\\n    at c (repl:9:3)\\n' +\n+              '    at b (repl:6:3)\\n    at a (repl:3:3)\\n'\n   },\n   {\n     command: 'let x y;',\n-    expected: 'let x y;\\n      ^\\n\\nSyntaxError: Unexpected identifier\\n\\n'\n+    expected: 'Thrown:\\n' +\n+              'let x y;\\n      ^\\n\\nSyntaxError: Unexpected identifier\\n'\n   },\n   {\n     command: 'throw new Error(\\'Whoops!\\')',\n-    expected: 'Error: Whoops!\\n'\n+    expected: 'Thrown:\\nError: Whoops!\\n'\n   },\n   {\n     command: 'foo = bar;',\n-    expected: 'ReferenceError: bar is not defined\\n'\n+    expected: 'Thrown:\\nReferenceError: bar is not defined\\n'\n   },\n   // test anonymous IIFE\n   {\n     command: '(function() { throw new Error(\\'Whoops!\\'); })()',\n-    expected: 'Error: Whoops!\\n    at repl:1:21\\n'\n+    expected: 'Thrown:\\nError: Whoops!\\n    at repl:1:21\\n'\n   }\n ];\n "
        },
        {
            "sha": "58d0a1332fb193bd1ed4f145b672b15335ced7d1",
            "filename": "test/parallel/test-repl-tab-complete-no-warn.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-tab-complete-no-warn.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-tab-complete-no-warn.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-tab-complete-no-warn.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -5,8 +5,7 @@ const ArrayStream = require('../common/arraystream');\n const repl = require('repl');\n const DEFAULT_MAX_LISTENERS = require('events').defaultMaxListeners;\n \n-ArrayStream.prototype.write = () => {\n-};\n+ArrayStream.prototype.write = () => {};\n \n const putIn = new ArrayStream();\n const testMe = repl.start('', putIn);"
        },
        {
            "sha": "73023df038b2c9b6e9724961a49d7a0bfaf3a02b",
            "filename": "test/parallel/test-repl-top-level-await.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-top-level-await.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -118,15 +118,15 @@ async function ordinaryTests() {\n     [ 'if (await true) { function bar() {}; }', 'undefined' ],\n     [ 'bar', '[Function: bar]' ],\n     [ 'if (await true) { class Bar {}; }', 'undefined' ],\n-    [ 'Bar', 'ReferenceError: Bar is not defined', { line: 0 } ],\n+    [ 'Bar', 'ReferenceError: Bar is not defined', { line: 1 } ],\n     [ 'await 0; function* gen(){}', 'undefined' ],\n     [ 'for (var i = 0; i < 10; ++i) { await i; }', 'undefined' ],\n     [ 'i', '10' ],\n     [ 'for (let j = 0; j < 5; ++j) { await j; }', 'undefined' ],\n-    [ 'j', 'ReferenceError: j is not defined', { line: 0 } ],\n+    [ 'j', 'ReferenceError: j is not defined', { line: 1 } ],\n     [ 'gen', '[GeneratorFunction: gen]' ],\n     [ 'return 42; await 5;', 'SyntaxError: Illegal return statement',\n-      { line: 3 } ],\n+      { line: 4 } ],\n     [ 'let o = await 1, p', 'undefined' ],\n     [ 'p', 'undefined' ],\n     [ 'let q = 1, s = await 2', 'undefined' ],\n@@ -160,6 +160,7 @@ async function ctrlCTest() {\n     { ctrl: true, name: 'c' }\n   ]), [\n     'await timeout(100000)\\r',\n+    'Thrown:',\n     'Error [ERR_SCRIPT_EXECUTION_INTERRUPTED]: ' +\n       'Script execution was interrupted by `SIGINT`',\n     PROMPT"
        },
        {
            "sha": "cbf62c3b6e03083e775109d22776b7e6181b9247",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -173,10 +173,12 @@ function testError() {\n       'undefined',\n \n       // The error, both from the original throw and the `_error` echo.\n+      'Thrown:',\n       'Error: foo',\n       '[Error: foo]',\n \n       // The sync error, with individual property echoes\n+      'Thrown:',\n       /^{ Error: ENOENT: no such file or directory, scandir '.*nonexistent.*'/,\n       /Object\\.readdirSync/,\n       /^  errno: -(2|4058),$/,\n@@ -191,6 +193,7 @@ function testError() {\n       'undefined',\n \n       // The message from the original throw\n+      'Thrown:',\n       'Error: baz',\n       /setImmediate/,\n       /^    at/,\n@@ -217,6 +220,7 @@ function testError() {\n       \"'baz'\",\n       'Expression assignment to _error now disabled.',\n       '0',\n+      'Thrown:',\n       'Error: quux',\n       '0'\n     ]);"
        },
        {
            "sha": "89370b0f7ad464861a0c35ed2260756836a731f8",
            "filename": "test/parallel/test-repl.js",
            "status": "modified",
            "additions": 53,
            "deletions": 43,
            "changes": 96,
            "blob_url": "https://github.com/nodejs/node/blob/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl.js",
            "raw_url": "https://github.com/nodejs/node/raw/edde0651912aca116f7e23c548bc5b56407a8056/test%2Fparallel%2Ftest-repl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl.js?ref=edde0651912aca116f7e23c548bc5b56407a8056",
            "patch": "@@ -25,6 +25,7 @@ const fixtures = require('../common/fixtures');\n const assert = require('assert');\n const net = require('net');\n const repl = require('repl');\n+const { inspect } = require('util');\n \n const message = 'Read, Eval, Print Loop';\n const prompt_unix = 'node via Unix socket> ';\n@@ -58,7 +59,7 @@ async function runReplTests(socket, prompt, tests) {\n         expectedLine = send;\n \n       while (!lineBuffer.includes('\\n')) {\n-        lineBuffer += await event(socket, 'data');\n+        lineBuffer += await event(socket, expect);\n \n         // Cut away the initial prompt\n         while (lineBuffer.startsWith(prompt))\n@@ -124,15 +125,15 @@ const unixTests = [\n const strictModeTests = [\n   {\n     send: 'ref = 1',\n-    expect: /^ReferenceError:\\s/\n+    expect: ['Thrown:', /^ReferenceError:\\s/]\n   }\n ];\n \n const errorTests = [\n   // Uncaught error throws and prints out\n   {\n     send: 'throw new Error(\\'test error\\');',\n-    expect: 'Error: test error'\n+    expect: ['Thrown:', 'Error: test error']\n   },\n   {\n     send: \"throw { foo: 'bar' };\",\n@@ -151,7 +152,7 @@ const errorTests = [\n   // But passing the same string to eval() should throw\n   {\n     send: 'eval(\"function test_func() {\")',\n-    expect: /^SyntaxError: /\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // Can handle multiline template literals\n   {\n@@ -208,90 +209,90 @@ const errorTests = [\n   // should throw\n   {\n     send: 'JSON.parse(\\'{invalid: \\\\\\'json\\\\\\'}\\');',\n-    expect: [/^SyntaxError: /, '']\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // End of input to JSON.parse error is special case of syntax error,\n   // should throw\n   {\n     send: 'JSON.parse(\\'066\\');',\n-    expect: [/^SyntaxError: /, '']\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // should throw\n   {\n     send: 'JSON.parse(\\'{\\');',\n-    expect: [/^SyntaxError: /, '']\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // invalid RegExps are a special case of syntax error,\n   // should throw\n   {\n     send: '/(/;',\n-    expect: /^SyntaxError: /\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // invalid RegExp modifiers are a special case of syntax error,\n   // should throw (GH-4012)\n   {\n     send: 'new RegExp(\"foo\", \"wrong modifier\");',\n-    expect: [/^SyntaxError: /, '']\n+    expect: ['Thrown:', /^SyntaxError: /]\n   },\n   // Strict mode syntax errors should be caught (GH-5178)\n   {\n     send: '(function() { \"use strict\"; return 0755; })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(function(a, a, b) { \"use strict\"; return a + b + c; })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(function() { \"use strict\"; with (this) {} })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(function() { \"use strict\"; var x; delete x; })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(function() { \"use strict\"; eval = 17; })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(function() { \"use strict\"; if (true) function f() { } })()',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   // Named functions can be used:\n@@ -396,11 +397,11 @@ const errorTests = [\n   {\n     send: '[] \\\\',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   // Do not fail when a String is created with line continuation\n@@ -530,6 +531,7 @@ const errorTests = [\n   {\n     send: 'require(\"internal/repl\")',\n     expect: [\n+      'Thrown:',\n       /^{ Error: Cannot find module 'internal\\/repl'/,\n       /^    at .*/,\n       /^    at .*/,\n@@ -563,11 +565,11 @@ const errorTests = [\n   {\n     send: 'a = 3.5e',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   // Mitigate https://github.com/nodejs/node/issues/548\n@@ -583,22 +585,22 @@ const errorTests = [\n   {\n     send: 'a = 3.5e',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   // Avoid emitting stack trace\n   {\n     send: 'a = 3.5e',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n \n@@ -663,11 +665,11 @@ const errorTests = [\n   {\n     send: '...[]',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   // bring back the repl to prompt\n@@ -678,31 +680,31 @@ const errorTests = [\n   {\n     send: 'console.log(\"Missing comma in arg list\" process.version)',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: 'x = {\\nfield\\n{',\n     expect: [\n-      '... ... {',\n+      '... ... Thrown:',\n+      '{',\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n     send: '(2 + 3))',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n   {\n@@ -716,11 +718,11 @@ const errorTests = [\n   {\n     send: '} else {',\n     expect: [\n+      'Thrown:',\n       kSource,\n       kArrow,\n       '',\n-      /^SyntaxError: /,\n-      ''\n+      /^SyntaxError: /\n     ]\n   },\n ];\n@@ -844,8 +846,16 @@ function startUnixRepl() {\n   ]);\n }\n \n-function event(ee, eventName) {\n-  return new Promise((resolve) => {\n-    ee.once(eventName, common.mustCall(resolve));\n+function event(ee, expected) {\n+  return new Promise((resolve, reject) => {\n+    const timeout = setTimeout(() => {\n+      const data = inspect(expected, { compact: false });\n+      const msg = `The REPL did not reply as expected for:\\n\\n${data}`;\n+      reject(new Error(msg));\n+    }, 500);\n+    ee.once('data', common.mustCall((...args) => {\n+      clearTimeout(timeout);\n+      resolve(...args);\n+    }));\n   });\n }"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 83,
        "deletions": 63
    }
}