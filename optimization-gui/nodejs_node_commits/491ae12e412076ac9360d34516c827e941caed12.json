{
    "author": "apapirovski",
    "message": "tls: cleanup onhandshakestart callback\n\nRe-arrange and cleanup the flow of the onhandshakestart to be\nmore clear and less repetitive. Exit early in the case of a\nfirst ever handshake for a given connection.\n\nPR-URL: https://github.com/nodejs/node/pull/20466\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "491ae12e412076ac9360d34516c827e941caed12",
    "files": [
        {
            "sha": "65c684abfe89a32d64e2cc5066455307e6492733",
            "filename": "lib/_tls_wrap.js",
            "status": "modified",
            "additions": 15,
            "deletions": 19,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/491ae12e412076ac9360d34516c827e941caed12/lib%2F_tls_wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/491ae12e412076ac9360d34516c827e941caed12/lib%2F_tls_wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_wrap.js?ref=491ae12e412076ac9360d34516c827e941caed12",
            "patch": "@@ -62,32 +62,28 @@ const noop = () => {};\n function onhandshakestart(now) {\n   debug('onhandshakestart');\n \n-  assert(now >= this.lastHandshakeTime);\n+  const { lastHandshakeTime } = this;\n+  assert(now >= lastHandshakeTime);\n \n-  const owner = this.owner;\n+  this.lastHandshakeTime = now;\n \n-  if ((now - this.lastHandshakeTime) >= tls.CLIENT_RENEG_WINDOW * 1000) {\n-    this.handshakes = 0;\n-  }\n+  // If this is the first handshake we can skip the rest of the checks.\n+  if (lastHandshakeTime === 0)\n+    return;\n \n-  const first = (this.lastHandshakeTime === 0);\n-  this.lastHandshakeTime = now;\n-  if (first) return;\n+  if ((now - lastHandshakeTime) >= tls.CLIENT_RENEG_WINDOW * 1000)\n+    this.handshakes = 1;\n+  else\n+    this.handshakes++;\n \n-  if (++this.handshakes > tls.CLIENT_RENEG_LIMIT) {\n-    // Defer the error event to the next tick. We're being called from OpenSSL's\n-    // state machine and OpenSSL is not re-entrant. We cannot allow the user's\n-    // callback to destroy the connection right now, it would crash and burn.\n-    setImmediate(emitSessionAttackError, owner);\n+  const { owner } = this;\n+  if (this.handshakes > tls.CLIENT_RENEG_LIMIT) {\n+    owner._emitTLSError(new ERR_TLS_SESSION_ATTACK());\n+    return;\n   }\n \n-  if (owner[kDisableRenegotiation] && this.handshakes > 0) {\n+  if (owner[kDisableRenegotiation])\n     owner._emitTLSError(new ERR_TLS_RENEGOTIATION_DISABLED());\n-  }\n-}\n-\n-function emitSessionAttackError(socket) {\n-  socket._emitTLSError(new ERR_TLS_SESSION_ATTACK());\n }\n \n function onhandshakedone() {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 15,
        "deletions": 19
    }
}