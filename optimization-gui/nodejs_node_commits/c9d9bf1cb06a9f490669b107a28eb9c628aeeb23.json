{
    "author": "bzoz",
    "message": "win, build: add documentation support to vcbuild\n\nAdds `doc` option to vcbuild.bat which will install node-doc-generator\ndependencies and build the documentation in the %config%\\doc folder.\n\nAdds `lint-md-build` option which will download markdown linter.\n\nAdds `lint-md` option, included by default in `lint` and `test` options\nwhich will run linter on the markdown files in the doc folder.\n\nPR-URL: https://github.com/nodejs/node/pull/19663\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "c9d9bf1cb06a9f490669b107a28eb9c628aeeb23",
    "files": [
        {
            "sha": "49ff50f60e4a36707714881ea72cef043036ecd2",
            "filename": "vcbuild.bat",
            "status": "modified",
            "additions": 91,
            "deletions": 11,
            "changes": 102,
            "blob_url": "https://github.com/nodejs/node/blob/c9d9bf1cb06a9f490669b107a28eb9c628aeeb23/vcbuild.bat",
            "raw_url": "https://github.com/nodejs/node/raw/c9d9bf1cb06a9f490669b107a28eb9c628aeeb23/vcbuild.bat",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/vcbuild.bat?ref=c9d9bf1cb06a9f490669b107a28eb9c628aeeb23",
            "patch": "@@ -28,6 +28,8 @@ set upload=\n set licensertf=\n set lint_js=\n set lint_cpp=\n+set lint_md=\n+set lint_md_build=\n set build_testgc_addon=\n set noetw=\n set noetw_msi_arg=\n@@ -53,6 +55,7 @@ set nghttp2_debug=\n set link_module=\n set no_cctest=\n set openssl_no_asm=\n+set doc=\n \n :next-arg\n if \"%1\"==\"\" goto args-done\n@@ -71,7 +74,7 @@ if /i \"%1\"==\"nosnapshot\"    set nosnapshot=1&goto arg-ok\n if /i \"%1\"==\"noetw\"         set noetw=1&goto arg-ok\n if /i \"%1\"==\"noperfctr\"     set noperfctr=1&goto arg-ok\n if /i \"%1\"==\"licensertf\"    set licensertf=1&goto arg-ok\n-if /i \"%1\"==\"test\"          set test_args=%test_args% -J %common_test_suites%&set lint_cpp=1&set lint_js=1&goto arg-ok\n+if /i \"%1\"==\"test\"          set test_args=%test_args% -J %common_test_suites%&set lint_cpp=1&set lint_js=1&set lint_md=1&goto arg-ok\n if /i \"%1\"==\"test-ci\"       set test_args=%test_args% %test_ci_args% -p tap --logfile test.tap %common_test_suites%&set cctest_args=%cctest_args% --gtest_output=tap:cctest.tap&goto arg-ok\n if /i \"%1\"==\"build-addons\"   set build_addons=1&goto arg-ok\n if /i \"%1\"==\"build-addons-napi\"   set build_addons_napi=1&goto arg-ok\n@@ -98,7 +101,9 @@ if /i \"%1\"==\"lint-js\"       set lint_js=1&goto arg-ok\n if /i \"%1\"==\"jslint\"        set lint_js=1&echo Please use lint-js instead of jslint&goto arg-ok\n if /i \"%1\"==\"lint-js-ci\"    set lint_js_ci=1&goto arg-ok\n if /i \"%1\"==\"jslint-ci\"     set lint_js_ci=1&echo Please use lint-js-ci instead of jslint-ci&goto arg-ok\n-if /i \"%1\"==\"lint\"          set lint_cpp=1&set lint_js=1&goto arg-ok\n+if /i \"%1\"==\"lint-md\"       set lint_md=1&goto arg-ok\n+if /i \"%1\"==\"lint-md-build\" set lint_md_build=1&goto arg-ok\n+if /i \"%1\"==\"lint\"          set lint_cpp=1&set lint_js=1&set lint_md=1&goto arg-ok\n if /i \"%1\"==\"lint-ci\"       set lint_cpp=1&set lint_js_ci=1&goto arg-ok\n if /i \"%1\"==\"package\"       set package=1&goto arg-ok\n if /i \"%1\"==\"msi\"           set msi=1&set licensertf=1&set download_arg=\"--download=all\"&set i18n_arg=small-icu&goto arg-ok\n@@ -118,6 +123,7 @@ if /i \"%1\"==\"debug-nghttp2\" set debug_nghttp2=1&goto arg-ok\n if /i \"%1\"==\"link-module\"   set \"link_module= --link-module=%2%link_module%\"&goto arg-ok-2\n if /i \"%1\"==\"no-cctest\"     set no_cctest=1&goto arg-ok\n if /i \"%1\"==\"openssl-no-asm\"   set openssl_no_asm=1&goto arg-ok\n+if /i \"%1\"==\"doc\"           set doc=1&goto arg-ok\n \n echo Error: invalid command line option `%1`.\n exit /b 1\n@@ -146,6 +152,7 @@ if defined build_release (\n :: assign path to node_exe\n set \"node_exe=%config%\\node.exe\"\n set \"node_gyp_exe=\"%node_exe%\" deps\\npm\\node_modules\\node-gyp\\bin\\node-gyp\"\n+set \"npm_exe=\"%~dp0%node_exe%\" %~dp0deps\\npm\\bin\\npm-cli.js\"\n if \"%target_env%\"==\"vs2017\" set \"node_gyp_exe=%node_gyp_exe% --msvs_version=2017\"\n \n if \"%config%\"==\"Debug\"      set configure_flags=%configure_flags% --debug\n@@ -179,7 +186,11 @@ call :getnodeversion || exit /b 1\n \n if defined TAG set configure_flags=%configure_flags% --tag=%TAG%\n \n-if \"%target%\"==\"Clean\" rmdir /Q /S \"%~dp0%config%\\node-v%FULLVERSION%-win-%target_arch%\" > nul 2> nul\n+if not \"%target%\"==\"Clean\" goto skip-clean\n+rmdir /Q /S \"%~dp0%config%\\node-v%FULLVERSION%-win-%target_arch%\" > nul 2> nul\n+rmdir /Q /S \"%~dp0tools\\remark-cli\\node_modules\"\n+rmdir /Q /S \"%~dp0tools\\remark-preset-lint-node\\node_modules\"\n+:skip-clean\n \n if defined noprojgen if defined nobuild if not defined sign if not defined msi goto licensertf\n \n@@ -235,7 +246,7 @@ goto exit\n \n :wix-not-found\n echo Build skipped. To generate installer, you need to install Wix.\n-goto run\n+goto build-doc\n \n :msbuild-found\n \n@@ -342,7 +353,7 @@ exit /b 1\n \n :msi\n @rem Skip msi generation if not requested\n-if not defined msi goto run\n+if not defined msi goto build-doc\n \n :msibuild\n echo Building node-v%FULLVERSION%-%target_arch%.msi\n@@ -357,7 +368,7 @@ if errorlevel 1 echo Failed to sign msi&goto exit\n \n :upload\n @rem Skip upload if not requested\n-if not defined upload goto run\n+if not defined upload goto build-doc\n \n if not defined SSHCONFIG (\n   echo SSHCONFIG is not set for upload\n@@ -385,6 +396,30 @@ ssh -F %SSHCONFIG% %STAGINGSERVER% \"touch nodejs/%DISTTYPEDIR%/v%FULLVERSION%/no\n if errorlevel 1 goto exit\n \n \n+:build-doc\n+@rem Build documentation if requested\n+if not defined doc goto run\n+if not exist %node_exe% (\n+  echo Failed to find node.exe\n+  goto run\n+)\n+mkdir %config%\\doc\n+robocopy /e doc\\api %config%\\doc\\api\n+robocopy /e doc\\api_assets %config%\\doc\\api\\assets\n+\n+if exist \"tools\\doc\\node_modules\\js-yaml\\package.json\" goto doc-skip-js-yaml\n+SETLOCAL\n+cd tools\\doc\n+%npm_exe% install\n+cd ..\\..\n+if errorlevel 1 goto exit\n+ENDLOCAL\n+:doc-skip-js-yaml\n+for %%F in (%config%\\doc\\api\\*.md) do (\n+  %node_exe% tools\\doc\\generate.js --format=json %%F > %%~dF%%~pF%%~nF.json\n+  %node_exe% tools\\doc\\generate.js --node-version=v%FULLVERSION% --format=html --analytics=%DOCS_ANALYTICS% %%F > %%~dF%%~pF%%~nF.html\n+)\n+\n :run\n @rem Run tests if requested.\n \n@@ -528,28 +563,73 @@ goto exit\n \n :lint-js\n if defined lint_js_ci goto lint-js-ci\n-if not defined lint_js goto exit\n+if not defined lint_js goto lint-md-build\n if not exist tools\\node_modules\\eslint goto no-lint\n echo running lint-js\n %config%\\node tools\\node_modules\\eslint\\bin\\eslint.js --cache --rule \"linebreak-style: 0\" --ext=.js,.mjs,.md .eslintrc.js benchmark doc lib test tools\n-goto exit\n+goto lint-md-build\n \n :lint-js-ci\n echo running lint-js-ci\n %config%\\node tools\\lint-js.js -J -f tap -o test-eslint.tap benchmark doc lib test tools\n-goto exit\n+goto lint-md-build\n \n :no-lint\n echo Linting is not available through the source tarball.\n echo Use the git repo instead: $ git clone https://github.com/nodejs/node.git\n+goto lint-md-build\n+\n+:lint-md-build\n+if not defined lint_md_build goto lint-md\n+SETLOCAL\n+echo Markdown linter: installing remark-cli into tools\\\n+cd tools\\remark-cli\n+%npm_exe% install\n+cd ..\\..\n+if errorlevel 1 goto lint-md-build-failed\n+echo Markdown linter: installing remark-preset-lint-node into tools\\\n+cd tools\\remark-preset-lint-node\n+%npm_exe% install\n+cd ..\\..\n+if errorlevel 1 goto lint-md-build-failed\n+ENDLOCAL\n+goto lint-md\n+\n+:if errorlevel 1 goto lint-md-build-failed\n+ENDLOCAL\n+echo Failed to install markdown linter\n+exit /b 1\n+\n+:lint-md\n+if not defined lint_md goto exit\n+if not exist tools\\remark-cli\\node_modules goto lint-md-no-tools\n+if not exist tools\\remark-preset-lint-node\\node_modules goto lint-md-no-tools\n+echo Running Markdown linter on docs...\n+SETLOCAL ENABLEDELAYEDEXPANSION\n+set lint_md_files=\n+cd doc\n+for /D %%D IN (*) do (\n+  for %%F IN (%%D\\*.md) do (\n+    set \"lint_md_files=\"doc\\%%F\" !lint_md_files!\"\n+  )\n+)\n+cd ..\n+%config%\\node tools\\remark-cli\\cli.js -q -f %lint_md_files%\n+ENDLOCAL\n goto exit\n \n+:lint-md-no-tools\n+echo The markdown linter is not installed.\n+echo To install (requires internet access) run: vcbuild lint-md-build\n+goto exit\n+\n+\n :create-msvs-files-failed\n echo Failed to create vc project files.\n goto exit\n \n :help\n-echo vcbuild.bat [debug/release] [msi] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n+echo vcbuild.bat [debug/release] [msi] [doc] [test/test-ci/test-all/test-addons/test-addons-napi/test-internet/test-pummel/test-simple/test-message/test-gc/test-tick-processor/test-known-issues/test-node-inspect/test-check-deopts/test-npm/test-async-hooks/test-v8/test-v8-intl/test-v8-benchmarks/test-v8-all] [ignore-flaky] [static/dll] [noprojgen] [small-icu/full-icu/without-intl] [nobuild] [nosnapshot] [noetw] [noperfctr] [licensetf] [sign] [ia32/x86/x64] [vs2017] [download-all] [enable-vtune] [lint/lint-ci/lint-js/lint-js-ci/lint-md] [lint-md-build] [package] [build-release] [upload] [no-NODE-OPTIONS] [link-module path-to-module] [debug-http2] [debug-nghttp2] [clean] [no-cctest] [openssl-no-asm]\n echo Examples:\n echo   vcbuild.bat                          : builds release build\n echo   vcbuild.bat debug                    : builds debug build\n@@ -558,7 +638,7 @@ echo   vcbuild.bat test                     : builds debug build and runs tests\n echo   vcbuild.bat build-release            : builds the release distribution as used by nodejs.org\n echo   vcbuild.bat enable-vtune             : builds nodejs with Intel VTune profiling support to profile JavaScript\n echo   vcbuild.bat link-module my_module.js : bundles my_module as built-in module\n-echo   vcbuild.bat lint                     : runs the C++ and JavaScript linter\n+echo   vcbuild.bat lint                     : runs the C++, documentation and JavaScript linter\n echo   vcbuild.bat no-cctest                : skip building cctest.exe\n goto exit\n "
        }
    ],
    "stats": {
        "total": 102,
        "additions": 91,
        "deletions": 11
    }
}