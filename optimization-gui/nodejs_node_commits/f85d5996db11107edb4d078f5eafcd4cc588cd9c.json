{
    "author": "BridgeAR",
    "message": "test: improve common.expectsError\n\nThe output is now improved by showing most properties all at once.\nBesides that this adds a warning to use `assert.throws` instead\ndue to a better output.\n\nPR-URL: https://github.com/nodejs/node/pull/19797\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "f85d5996db11107edb4d078f5eafcd4cc588cd9c",
    "files": [
        {
            "sha": "95bb8dd804881fb8c0404e62d0d4ff778f824692",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 50,
            "deletions": 23,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=f85d5996db11107edb4d078f5eafcd4cc588cd9c",
            "patch": "@@ -690,52 +690,79 @@ Object.defineProperty(exports, 'hasSmallICU', {\n   }\n });\n \n+class Comparison {\n+  constructor(obj, keys) {\n+    for (const key of keys) {\n+      if (key in obj)\n+        this[key] = obj[key];\n+    }\n+  }\n+}\n+\n // Useful for testing expected internal/error objects\n exports.expectsError = function expectsError(fn, settings, exact) {\n   if (typeof fn !== 'function') {\n     exact = settings;\n     settings = fn;\n     fn = undefined;\n   }\n+\n   function innerFn(error) {\n     const descriptor = Object.getOwnPropertyDescriptor(error, 'message');\n     assert.strictEqual(descriptor.enumerable,\n                        false, 'The error message should be non-enumerable');\n+\n+    let innerSettings = settings;\n     if ('type' in settings) {\n       const type = settings.type;\n       if (type !== Error && !Error.isPrototypeOf(type)) {\n         throw new TypeError('`settings.type` must inherit from `Error`');\n       }\n-      assert(error instanceof type,\n-             `${error.name} is not instance of ${type.name}`);\n-      let typeName = error.constructor.name;\n-      if (typeName === 'NodeError' && type.name !== 'NodeError') {\n-        typeName = Object.getPrototypeOf(error.constructor).name;\n+      let constructor = error.constructor;\n+      if (constructor.name === 'NodeError' && type.name !== 'NodeError') {\n+        constructor = Object.getPrototypeOf(error.constructor);\n       }\n-      assert.strictEqual(typeName, type.name);\n+      // Add the `type` to the error to properly compare and visualize it.\n+      if (!('type' in error))\n+        error.type = constructor;\n     }\n-    if ('info' in settings) {\n-      assert.deepStrictEqual(error.info, settings.info);\n-    }\n-    if ('message' in settings) {\n-      const message = settings.message;\n-      if (typeof message === 'string') {\n-        assert.strictEqual(error.message, message);\n-      } else {\n-        assert(message.test(error.message),\n-               `${error.message} does not match ${message}`);\n-      }\n+\n+    if ('message' in settings &&\n+        typeof settings.message === 'object' &&\n+        settings.message.test(error.message)) {\n+      // Make a copy so we are able to modify the settings.\n+      innerSettings = Object.create(\n+        settings, Object.getOwnPropertyDescriptors(settings));\n+      // Visualize the message as identical in case of other errors.\n+      innerSettings.message = error.message;\n     }\n \n     // Check all error properties.\n     const keys = Object.keys(settings);\n     for (const key of keys) {\n-      if (key === 'message' || key === 'type' || key === 'info')\n-        continue;\n-      const actual = error[key];\n-      const expected = settings[key];\n-      assert.strictEqual(actual, expected,\n-                         `${key}: expected ${expected}, not ${actual}`);\n+      if (!util.isDeepStrictEqual(error[key], innerSettings[key])) {\n+        // Create placeholder objects to create a nice output.\n+        const a = new Comparison(error, keys);\n+        const b = new Comparison(innerSettings, keys);\n+\n+        const tmpLimit = Error.stackTraceLimit;\n+        Error.stackTraceLimit = 0;\n+        const err = new assert.AssertionError({\n+          actual: a,\n+          expected: b,\n+          operator: 'strictEqual',\n+          stackStartFn: assert.throws\n+        });\n+        Error.stackTraceLimit = tmpLimit;\n+\n+        throw new assert.AssertionError({\n+          actual: error,\n+          expected: settings,\n+          operator: 'common.expectsError',\n+          message: err.message\n+        });\n+      }\n+\n     }\n     return true;\n   }"
        },
        {
            "sha": "1021307b3c5f228979c6b9d6dbebf1a4bef73db2",
            "filename": "test/parallel/test-console-assign-undefined.js",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fparallel%2Ftest-console-assign-undefined.js",
            "raw_url": "https://github.com/nodejs/node/raw/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fparallel%2Ftest-console-assign-undefined.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-console-assign-undefined.js?ref=f85d5996db11107edb4d078f5eafcd4cc588cd9c",
            "patch": "@@ -6,19 +6,17 @@\n const tmp = global.console;\n global.console = 42;\n \n-const common = require('../common');\n+require('../common');\n const assert = require('assert');\n \n // Originally the console had a getter. Test twice to verify it had no side\n // effect.\n assert.strictEqual(global.console, 42);\n assert.strictEqual(global.console, 42);\n \n-common.expectsError(\n+assert.throws(\n   () => console.log('foo'),\n-  {\n-    type: TypeError\n-  }\n+  { name: 'TypeError' }\n );\n \n global.console = 1;"
        },
        {
            "sha": "cd2028c0f29b95c07b6c501abf1fe19a30e5aaca",
            "filename": "test/parallel/test-internal-errors.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fparallel%2Ftest-internal-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/f85d5996db11107edb4d078f5eafcd4cc588cd9c/test%2Fparallel%2Ftest-internal-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-errors.js?ref=f85d5996db11107edb4d078f5eafcd4cc588cd9c",
            "patch": "@@ -77,7 +77,7 @@ common.expectsError(() => {\n   }, { code: 'TEST_ERROR_1', type: RangeError });\n }, {\n   code: 'ERR_ASSERTION',\n-  message: /^.+ is not instance of \\S/\n+  message: /-   type: \\[Function: TypeError]\\n\\+   type: \\[Function: RangeError]/\n });\n \n common.expectsError(() => {\n@@ -89,7 +89,7 @@ common.expectsError(() => {\n }, {\n   code: 'ERR_ASSERTION',\n   type: assert.AssertionError,\n-  message: /.+ does not match \\S/\n+  message: /-   message: 'Error for testing purposes: a'\\n\\+   message: \\/\\^Error/\n });\n \n // Test ERR_INVALID_FD_TYPE"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 55,
        "deletions": 30
    }
}