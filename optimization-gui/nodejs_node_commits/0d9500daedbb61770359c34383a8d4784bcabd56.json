{
    "author": "Trott",
    "message": "test: add promise API test for appendFile()\n\nApply the first of five test cases in test-fs-append-file to the\npromise-based API in addition to the callback-based API.\n\nPR-URL: https://github.com/nodejs/node/pull/20739\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "0d9500daedbb61770359c34383a8d4784bcabd56",
    "files": [
        {
            "sha": "0b0cf5cdb2f11908be2296ce3690f86aaaab0284",
            "filename": "test/parallel/test-fs-append-file.js",
            "status": "modified",
            "additions": 25,
            "deletions": 13,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/0d9500daedbb61770359c34383a8d4784bcabd56/test%2Fparallel%2Ftest-fs-append-file.js",
            "raw_url": "https://github.com/nodejs/node/raw/0d9500daedbb61770359c34383a8d4784bcabd56/test%2Fparallel%2Ftest-fs-append-file.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-append-file.js?ref=0d9500daedbb61770359c34383a8d4784bcabd56",
            "patch": "@@ -27,8 +27,6 @@ const join = require('path').join;\n \n const tmpdir = require('../common/tmpdir');\n \n-const filename = join(tmpdir.path, 'append.txt');\n-\n const currentFileData = 'ABCD';\n \n const n = 220;\n@@ -44,18 +42,33 @@ let ncallbacks = 0;\n \n tmpdir.refresh();\n \n-// test that empty file will be created and have content added\n-fs.appendFile(filename, s, function(e) {\n-  assert.ifError(e);\n+const throwNextTick = (e) => { process.nextTick(() => { throw e; }); };\n \n-  ncallbacks++;\n+// test that empty file will be created and have content added (callback API)\n+{\n+  const filename = join(tmpdir.path, 'append.txt');\n \n-  fs.readFile(filename, function(e, buffer) {\n+  fs.appendFile(filename, s, common.mustCall(function(e) {\n     assert.ifError(e);\n-    ncallbacks++;\n-    assert.strictEqual(Buffer.byteLength(s), buffer.length);\n-  });\n-});\n+\n+    fs.readFile(filename, common.mustCall(function(e, buffer) {\n+      assert.ifError(e);\n+      assert.strictEqual(Buffer.byteLength(s), buffer.length);\n+    }));\n+  }));\n+}\n+\n+// test that empty file will be created and have content added (promise API)\n+{\n+  const filename = join(tmpdir.path, 'append-promise.txt');\n+\n+  fs.promises.appendFile(filename, s)\n+    .then(common.mustCall(() => fs.promises.readFile(filename)))\n+    .then((buffer) => {\n+      assert.strictEqual(Buffer.byteLength(s), buffer.length);\n+    })\n+    .catch(throwNextTick);\n+}\n \n // test that appends data to a non empty file\n const filename2 = join(tmpdir.path, 'append2.txt');\n@@ -151,9 +164,8 @@ assert.throws(\n   { code: 'ERR_INVALID_CALLBACK' });\n \n process.on('exit', function() {\n-  assert.strictEqual(12, ncallbacks);\n+  assert.strictEqual(10, ncallbacks);\n \n-  fs.unlinkSync(filename);\n   fs.unlinkSync(filename2);\n   fs.unlinkSync(filename3);\n   fs.unlinkSync(filename4);"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 25,
        "deletions": 13
    }
}