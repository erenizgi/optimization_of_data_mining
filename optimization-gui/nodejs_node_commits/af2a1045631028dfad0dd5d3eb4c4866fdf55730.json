{
    "author": "apapirovski",
    "message": "child_process: swallow errors in internal communication\n\nMuch like with NODE_HANDLE_ACK, the internal protocol for communication\nabout the sent socket should not expose its errors to the users when\nthose async calls are not initiated by them.\n\nPR-URL: https://github.com/nodejs/node/pull/21108\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "af2a1045631028dfad0dd5d3eb4c4866fdf55730",
    "files": [
        {
            "sha": "d12686e1de107d579d53b4275eef5ee752cadf9f",
            "filename": "lib/internal/socket_list.js",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/af2a1045631028dfad0dd5d3eb4c4866fdf55730/lib%2Finternal%2Fsocket_list.js",
            "raw_url": "https://github.com/nodejs/node/raw/af2a1045631028dfad0dd5d3eb4c4866fdf55730/lib%2Finternal%2Fsocket_list.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fsocket_list.js?ref=af2a1045631028dfad0dd5d3eb4c4866fdf55730",
            "patch": "@@ -13,11 +13,11 @@ class SocketListSend extends EventEmitter {\n     child.once('exit', () => this.emit('exit', this));\n   }\n \n-  _request(msg, cmd, callback) {\n+  _request(msg, cmd, swallowErrors, callback) {\n     var self = this;\n \n     if (!this.child.connected) return onclose();\n-    this.child.send(msg);\n+    this.child._send(msg, undefined, swallowErrors);\n \n     function onclose() {\n       self.child.removeListener('internalMessage', onreply);\n@@ -40,14 +40,14 @@ class SocketListSend extends EventEmitter {\n     this._request({\n       cmd: 'NODE_SOCKET_NOTIFY_CLOSE',\n       key: this.key\n-    }, 'NODE_SOCKET_ALL_CLOSED', callback);\n+    }, 'NODE_SOCKET_ALL_CLOSED', true, callback);\n   }\n \n   getConnections(callback) {\n     this._request({\n       cmd: 'NODE_SOCKET_GET_COUNT',\n       key: this.key\n-    }, 'NODE_SOCKET_COUNT', function(err, msg) {\n+    }, 'NODE_SOCKET_COUNT', false, function(err, msg) {\n       if (err) return callback(err);\n       callback(null, msg.count);\n     });\n@@ -67,10 +67,10 @@ class SocketListReceive extends EventEmitter {\n     function onempty(self) {\n       if (!self.child.connected) return;\n \n-      self.child.send({\n+      self.child._send({\n         cmd: 'NODE_SOCKET_ALL_CLOSED',\n         key: self.key\n-      });\n+      }, undefined, true);\n     }\n \n     this.child.on('internalMessage', (msg) => {\n@@ -84,7 +84,7 @@ class SocketListReceive extends EventEmitter {\n         this.once('empty', onempty);\n       } else if (msg.cmd === 'NODE_SOCKET_GET_COUNT') {\n         if (!this.child.connected) return;\n-        this.child.send({\n+        this.child._send({\n           cmd: 'NODE_SOCKET_COUNT',\n           key: this.key,\n           count: this.connections"
        },
        {
            "sha": "6f4c13a96f96ee4de469353a277795bd819e7a30",
            "filename": "test/parallel/parallel.status",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Fparallel.status",
            "raw_url": "https://github.com/nodejs/node/raw/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Fparallel.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Fparallel.status?ref=af2a1045631028dfad0dd5d3eb4c4866fdf55730",
            "patch": "@@ -7,7 +7,6 @@ prefix parallel\n [true] # This section applies to all platforms\n \n [$system==win32]\n-test-child-process-fork-net-socket: PASS,FLAKY\n \n [$system==linux]\n "
        },
        {
            "sha": "e7e64887600f594d8efe3a466a5c30f470503524",
            "filename": "test/parallel/test-internal-socket-list-receive.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Ftest-internal-socket-list-receive.js",
            "raw_url": "https://github.com/nodejs/node/raw/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Ftest-internal-socket-list-receive.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-socket-list-receive.js?ref=af2a1045631028dfad0dd5d3eb4c4866fdf55730",
            "patch": "@@ -12,7 +12,7 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: false,\n-    send: common.mustNotCall()\n+    _send: common.mustNotCall()\n   });\n \n   const list = new SocketListReceive(child, key);\n@@ -24,7 +24,7 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: common.mustCall((msg) => {\n+    _send: common.mustCall((msg) => {\n       assert.strictEqual(msg.cmd, 'NODE_SOCKET_ALL_CLOSED');\n       assert.strictEqual(msg.key, key);\n     })\n@@ -38,7 +38,7 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: common.mustCall((msg) => {\n+    _send: common.mustCall((msg) => {\n       assert.strictEqual(msg.cmd, 'NODE_SOCKET_COUNT');\n       assert.strictEqual(msg.key, key);\n       assert.strictEqual(msg.count, 0);"
        },
        {
            "sha": "2e69edcedffd9f4306f847f6c76d4308b2a1269d",
            "filename": "test/parallel/test-internal-socket-list-send.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Ftest-internal-socket-list-send.js",
            "raw_url": "https://github.com/nodejs/node/raw/af2a1045631028dfad0dd5d3eb4c4866fdf55730/test%2Fparallel%2Ftest-internal-socket-list-send.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-socket-list-send.js?ref=af2a1045631028dfad0dd5d3eb4c4866fdf55730",
            "patch": "@@ -16,7 +16,7 @@ const key = 'test-key';\n \n   const list = new SocketListSend(child, 'test');\n \n-  list._request('msg', 'cmd', common.mustCall((err) => {\n+  list._request('msg', 'cmd', false, common.mustCall((err) => {\n     common.expectsError({\n       code: 'ERR_CHILD_CLOSED_BEFORE_REPLY',\n       type: Error,\n@@ -30,7 +30,7 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: function(msg) {\n+    _send: function(msg) {\n       process.nextTick(() =>\n         this.emit('internalMessage', { key, cmd: 'cmd' })\n       );\n@@ -39,7 +39,7 @@ const key = 'test-key';\n \n   const list = new SocketListSend(child, key);\n \n-  list._request('msg', 'cmd', common.mustCall((err, msg) => {\n+  list._request('msg', 'cmd', false, common.mustCall((err, msg) => {\n     assert.strictEqual(err, null);\n     assert.strictEqual(msg.cmd, 'cmd');\n     assert.strictEqual(msg.key, key);\n@@ -53,12 +53,12 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: function(msg) { process.nextTick(() => this.emit('disconnect')); }\n+    _send: function(msg) { process.nextTick(() => this.emit('disconnect')); }\n   });\n \n   const list = new SocketListSend(child, key);\n \n-  list._request('msg', 'cmd', common.mustCall((err) => {\n+  list._request('msg', 'cmd', false, common.mustCall((err) => {\n     common.expectsError({\n       code: 'ERR_CHILD_CLOSED_BEFORE_REPLY',\n       type: Error,\n@@ -73,7 +73,7 @@ const key = 'test-key';\n {\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: function(msg) {\n+    _send: function(msg) {\n       assert.strictEqual(msg.cmd, 'NODE_SOCKET_NOTIFY_CLOSE');\n       assert.strictEqual(msg.key, key);\n       process.nextTick(() =>\n@@ -98,7 +98,7 @@ const key = 'test-key';\n   const count = 1;\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: function(msg) {\n+    _send: function(msg) {\n       assert.strictEqual(msg.cmd, 'NODE_SOCKET_GET_COUNT');\n       assert.strictEqual(msg.key, key);\n       process.nextTick(() =>\n@@ -127,7 +127,7 @@ const key = 'test-key';\n   const count = 1;\n   const child = Object.assign(new EventEmitter(), {\n     connected: true,\n-    send: function() {\n+    _send: function() {\n       process.nextTick(() => {\n         this.emit('disconnect');\n         this.emit('internalMessage', { key, count, cmd: 'NODE_SOCKET_COUNT' });"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 18,
        "deletions": 19
    }
}