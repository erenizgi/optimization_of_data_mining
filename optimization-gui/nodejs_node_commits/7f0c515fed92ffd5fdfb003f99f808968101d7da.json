{
    "author": "addaleax",
    "message": "worker: do not add removed methods to MessagePort\n\nDo not put the `.stop()` and `.drain()` methods on the\n`MessagePort` prototype if we are going to remove them\nlater on anyway.\n\nPR-URL: https://github.com/nodejs/node/pull/26109\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "7f0c515fed92ffd5fdfb003f99f808968101d7da",
    "files": [
        {
            "sha": "e88991aaaba0f0c43788867e7fa865d8359c8023",
            "filename": "lib/internal/worker/io.js",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/7f0c515fed92ffd5fdfb003f99f808968101d7da/lib%2Finternal%2Fworker%2Fio.js",
            "raw_url": "https://github.com/nodejs/node/raw/7f0c515fed92ffd5fdfb003f99f808968101d7da/lib%2Finternal%2Fworker%2Fio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker%2Fio.js?ref=7f0c515fed92ffd5fdfb003f99f808968101d7da",
            "patch": "@@ -6,7 +6,9 @@ const {\n } = internalBinding('symbols');\n const {\n   MessagePort,\n-  MessageChannel\n+  MessageChannel,\n+  drainMessagePort,\n+  stopMessagePort\n } = internalBinding('messaging');\n const { threadId } = internalBinding('worker');\n \n@@ -33,13 +35,6 @@ const messageTypes = {\n   LOAD_SCRIPT: 'loadScript'\n };\n \n-// Original drain from C++\n-const originalDrain = MessagePort.prototype.drain;\n-\n-function drainMessagePort(port) {\n-  return originalDrain.call(port);\n-}\n-\n // We have to mess with the MessagePort prototype a bit, so that a) we can make\n // it inherit from EventEmitter, even though it is a C++ class, and b) we do\n // not provide methods that are not present in the Browser and not documented\n@@ -51,9 +46,8 @@ const MessagePortPrototype = Object.create(\n // Set up the new inheritance chain.\n Object.setPrototypeOf(MessagePort, EventEmitter);\n Object.setPrototypeOf(MessagePort.prototype, EventEmitter.prototype);\n-// Finally, purge methods we don't want to be public.\n-delete MessagePort.prototype.stop;\n-delete MessagePort.prototype.drain;\n+// Copy methods that are inherited from HandleWrap, because\n+// changing the prototype of MessagePort.prototype implicitly removed them.\n MessagePort.prototype.ref = MessagePortPrototype.ref;\n MessagePort.prototype.unref = MessagePortPrototype.unref;\n \n@@ -84,7 +78,7 @@ Object.defineProperty(MessagePort.prototype, 'onmessage', {\n       MessagePortPrototype.start.call(this);\n     } else {\n       this.unref();\n-      MessagePortPrototype.stop.call(this);\n+      stopMessagePort(this);\n     }\n   }\n });\n@@ -152,7 +146,7 @@ function setupPortReferencing(port, eventEmitter, eventName) {\n   });\n   eventEmitter.on('removeListener', (name) => {\n     if (name === eventName && eventEmitter.listenerCount(eventName) === 0) {\n-      MessagePortPrototype.stop.call(port);\n+      stopMessagePort(port);\n       port.unref();\n     }\n   });"
        },
        {
            "sha": "50d84f01d679d4424cb831b39b1c6beeadf29c66",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/7f0c515fed92ffd5fdfb003f99f808968101d7da/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7f0c515fed92ffd5fdfb003f99f808968101d7da/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=7f0c515fed92ffd5fdfb003f99f808968101d7da",
            "patch": "@@ -741,7 +741,8 @@ void MessagePort::Start(const FunctionCallbackInfo<Value>& args) {\n void MessagePort::Stop(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   MessagePort* port;\n-  ASSIGN_OR_RETURN_UNWRAP(&port, args.This());\n+  CHECK(args[0]->IsObject());\n+  ASSIGN_OR_RETURN_UNWRAP(&port, args[0].As<Object>());\n   if (!port->data_) {\n     THROW_ERR_CLOSED_MESSAGE_PORT(env);\n     return;\n@@ -751,7 +752,8 @@ void MessagePort::Stop(const FunctionCallbackInfo<Value>& args) {\n \n void MessagePort::Drain(const FunctionCallbackInfo<Value>& args) {\n   MessagePort* port;\n-  ASSIGN_OR_RETURN_UNWRAP(&port, args.This());\n+  CHECK(args[0]->IsObject());\n+  ASSIGN_OR_RETURN_UNWRAP(&port, args[0].As<Object>());\n   port->OnMessage();\n }\n \n@@ -781,8 +783,6 @@ MaybeLocal<Function> GetMessagePortConstructor(\n \n     env->SetProtoMethod(m, \"postMessage\", MessagePort::PostMessage);\n     env->SetProtoMethod(m, \"start\", MessagePort::Start);\n-    env->SetProtoMethod(m, \"stop\", MessagePort::Stop);\n-    env->SetProtoMethod(m, \"drain\", MessagePort::Drain);\n \n     env->set_message_port_constructor_template(m);\n \n@@ -848,6 +848,11 @@ static void InitMessaging(Local<Object> target,\n                   .FromJust();\n \n   env->SetMethod(target, \"registerDOMException\", RegisterDOMException);\n+\n+  // These are not methods on the MessagePort prototype, because\n+  // the browser equivalents do not provide them.\n+  env->SetMethod(target, \"stopMessagePort\", MessagePort::Stop);\n+  env->SetMethod(target, \"drainMessagePort\", MessagePort::Drain);\n }\n \n }  // anonymous namespace"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 16,
        "deletions": 17
    }
}