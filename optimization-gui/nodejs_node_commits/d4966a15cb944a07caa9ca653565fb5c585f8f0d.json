{
    "author": "Flarna",
    "message": "http2: pass incoming set-cookie header as array\n\nIncoming set-cookie headers should be passed to user as array like in\nhttp module.\n\nBesides improving compatibility between http and http2 it avoids the\nneed to check if the type is an array or not in user code.\n\nPR-URL: https://github.com/nodejs/node/pull/21360\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "d4966a15cb944a07caa9ca653565fb5c585f8f0d",
    "files": [
        {
            "sha": "3e1850a6790b94612c7b168ea23dd5b64e07e53c",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d4966a15cb944a07caa9ca653565fb5c585f8f0d/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/d4966a15cb944a07caa9ca653565fb5c585f8f0d/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=d4966a15cb944a07caa9ca653565fb5c585f8f0d",
            "patch": "@@ -2130,8 +2130,7 @@ For incoming headers:\n `proxy-authorization`, `range`, `referer`,`retry-after`, `tk`,\n `upgrade-insecure-requests`, `user-agent` or `x-content-type-options` are\n discarded.\n-* `set-cookie` is a string if present once or an array in case duplicates\n-are present.\n+* `set-cookie` is always an array. Duplicates are added to the array.\n * `cookie`: the values are joined together with '; '.\n * For all other headers, the values are joined together with ', '.\n "
        },
        {
            "sha": "bc93662a70239da04ed1251a86b98925a495c032",
            "filename": "lib/internal/http2/util.js",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d4966a15cb944a07caa9ca653565fb5c585f8f0d/lib%2Finternal%2Fhttp2%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/d4966a15cb944a07caa9ca653565fb5c585f8f0d/lib%2Finternal%2Fhttp2%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Futil.js?ref=d4966a15cb944a07caa9ca653565fb5c585f8f0d",
            "patch": "@@ -509,7 +509,7 @@ function toHeaderObject(headers) {\n       value |= 0;\n     var existing = obj[name];\n     if (existing === undefined) {\n-      obj[name] = value;\n+      obj[name] = name === HTTP2_HEADER_SET_COOKIE ? [value] : value;\n     } else if (!kSingleValueHeaders.has(name)) {\n       switch (name) {\n         case HTTP2_HEADER_COOKIE:\n@@ -528,10 +528,7 @@ function toHeaderObject(headers) {\n           // fields with the same name.  Since it cannot be combined into a\n           // single field-value, recipients ought to handle \"Set-Cookie\" as a\n           // special case while processing header fields.\"\n-          if (Array.isArray(existing))\n-            existing.push(value);\n-          else\n-            obj[name] = [existing, value];\n+          existing.push(value);\n           break;\n         default:\n           // https://tools.ietf.org/html/rfc7230#section-3.2.2"
        },
        {
            "sha": "7b83883553197726724972eba05cb78cc0a34345",
            "filename": "test/parallel/test-http2-util-headers-list.js",
            "status": "modified",
            "additions": 41,
            "deletions": 3,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/d4966a15cb944a07caa9ca653565fb5c585f8f0d/test%2Fparallel%2Ftest-http2-util-headers-list.js",
            "raw_url": "https://github.com/nodejs/node/raw/d4966a15cb944a07caa9ca653565fb5c585f8f0d/test%2Fparallel%2Ftest-http2-util-headers-list.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-util-headers-list.js?ref=d4966a15cb944a07caa9ca653565fb5c585f8f0d",
            "patch": "@@ -1,14 +1,14 @@\n // Flags: --expose-internals\n 'use strict';\n \n-// Tests the internal utility function that is used to prepare headers\n-// to pass to the internal binding layer.\n+// Tests the internal utility functions that are used to prepare headers\n+// to pass to the internal binding layer and to build a header object.\n \n const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n const assert = require('assert');\n-const { mapToHeaders } = require('internal/http2/util');\n+const { mapToHeaders, toHeaderObject } = require('internal/http2/util');\n \n const {\n   HTTP2_HEADER_STATUS,\n@@ -305,3 +305,41 @@ common.expectsError({\n \n assert(!(mapToHeaders({ te: 'trailers' }) instanceof Error));\n assert(!(mapToHeaders({ te: ['trailers'] }) instanceof Error));\n+\n+\n+{\n+  const rawHeaders = [\n+    ':status', '200',\n+    'cookie', 'foo',\n+    'set-cookie', 'sc1',\n+    'age', '10',\n+    'x-multi', 'first'\n+  ];\n+  const headers = toHeaderObject(rawHeaders);\n+  assert.strictEqual(headers[':status'], 200);\n+  assert.strictEqual(headers.cookie, 'foo');\n+  assert.deepStrictEqual(headers['set-cookie'], ['sc1']);\n+  assert.strictEqual(headers.age, '10');\n+  assert.strictEqual(headers['x-multi'], 'first');\n+}\n+\n+{\n+  const rawHeaders = [\n+    ':status', '200',\n+    ':status', '400',\n+    'cookie', 'foo',\n+    'cookie', 'bar',\n+    'set-cookie', 'sc1',\n+    'set-cookie', 'sc2',\n+    'age', '10',\n+    'age', '20',\n+    'x-multi', 'first',\n+    'x-multi', 'second'\n+  ];\n+  const headers = toHeaderObject(rawHeaders);\n+  assert.strictEqual(headers[':status'], 200);\n+  assert.strictEqual(headers.cookie, 'foo; bar');\n+  assert.deepStrictEqual(headers['set-cookie'], ['sc1', 'sc2']);\n+  assert.strictEqual(headers.age, '10');\n+  assert.strictEqual(headers['x-multi'], 'first, second');\n+}"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 44,
        "deletions": 10
    }
}