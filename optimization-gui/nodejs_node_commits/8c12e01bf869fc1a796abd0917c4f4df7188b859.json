{
    "author": "ulan",
    "message": "src: create per-isolate strings after platform setup\n\nAllocation of strings may cause a garbage collection that uses\nthe platform to post tasks.\n\nPR-URL: https://github.com/nodejs/node/pull/20175\nFixes: https://github.com/nodejs/node/issues/20171\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "8c12e01bf869fc1a796abd0917c4f4df7188b859",
    "files": [
        {
            "sha": "08d719a51011d13ca4f9537255655aeabcec0812",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 34,
            "deletions": 32,
            "changes": 66,
            "blob_url": "https://github.com/nodejs/node/blob/8c12e01bf869fc1a796abd0917c4f4df7188b859/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8c12e01bf869fc1a796abd0917c4f4df7188b859/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=8c12e01bf869fc1a796abd0917c4f4df7188b859",
            "patch": "@@ -28,44 +28,46 @@ IsolateData::IsolateData(Isolate* isolate,\n                          uv_loop_t* event_loop,\n                          MultiIsolatePlatform* platform,\n                          uint32_t* zero_fill_field) :\n-\n-// Create string and private symbol properties as internalized one byte strings.\n-//\n-// Internalized because it makes property lookups a little faster and because\n-// the string is created in the old space straight away.  It's going to end up\n-// in the old space sooner or later anyway but now it doesn't go through\n-// v8::Eternal's new space handling first.\n-//\n-// One byte because our strings are ASCII and we can safely skip V8's UTF-8\n-// decoding step.  It's a one-time cost, but why pay it when you don't have to?\n-#define V(PropertyName, StringValue)                                          \\\n-    PropertyName ## _(                                                        \\\n-        isolate,                                                              \\\n-        Private::New(                                                         \\\n-            isolate,                                                          \\\n-            String::NewFromOneByte(                                           \\\n-                isolate,                                                      \\\n-                reinterpret_cast<const uint8_t*>(StringValue),                \\\n-                v8::NewStringType::kInternalized,                             \\\n-                sizeof(StringValue) - 1).ToLocalChecked())),\n-  PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(V)\n-#undef V\n-#define V(PropertyName, StringValue)                                          \\\n-    PropertyName ## _(                                                        \\\n-        isolate,                                                              \\\n-        String::NewFromOneByte(                                               \\\n-            isolate,                                                          \\\n-            reinterpret_cast<const uint8_t*>(StringValue),                    \\\n-            v8::NewStringType::kInternalized,                                 \\\n-            sizeof(StringValue) - 1).ToLocalChecked()),\n-    PER_ISOLATE_STRING_PROPERTIES(V)\n-#undef V\n     isolate_(isolate),\n     event_loop_(event_loop),\n     zero_fill_field_(zero_fill_field),\n     platform_(platform) {\n   if (platform_ != nullptr)\n     platform_->RegisterIsolate(this, event_loop);\n+\n+  // Create string and private symbol properties as internalized one byte\n+  // strings after the platform is properly initialized.\n+  //\n+  // Internalized because it makes property lookups a little faster and\n+  // because the string is created in the old space straight away.  It's going\n+  // to end up in the old space sooner or later anyway but now it doesn't go\n+  // through v8::Eternal's new space handling first.\n+  //\n+  // One byte because our strings are ASCII and we can safely skip V8's UTF-8\n+  // decoding step.\n+\n+#define V(PropertyName, StringValue)                                        \\\n+    PropertyName ## _.Set(                                                  \\\n+        isolate,                                                            \\\n+        Private::New(                                                       \\\n+            isolate,                                                        \\\n+            String::NewFromOneByte(                                         \\\n+                isolate,                                                    \\\n+                reinterpret_cast<const uint8_t*>(StringValue),              \\\n+                v8::NewStringType::kInternalized,                           \\\n+                sizeof(StringValue) - 1).ToLocalChecked()));\n+  PER_ISOLATE_PRIVATE_SYMBOL_PROPERTIES(V)\n+#undef V\n+#define V(PropertyName, StringValue)                                        \\\n+    PropertyName ## _.Set(                                                  \\\n+        isolate,                                                            \\\n+        String::NewFromOneByte(                                             \\\n+            isolate,                                                        \\\n+            reinterpret_cast<const uint8_t*>(StringValue),                  \\\n+            v8::NewStringType::kInternalized,                               \\\n+            sizeof(StringValue) - 1).ToLocalChecked());\n+  PER_ISOLATE_STRING_PROPERTIES(V)\n+#undef V\n }\n \n IsolateData::~IsolateData() {"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 34,
        "deletions": 32
    }
}