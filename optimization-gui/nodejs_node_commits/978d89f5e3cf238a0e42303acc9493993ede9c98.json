{
    "author": "unknown",
    "message": "n-api: create functions directly\n\nAvoid using `v8::FunctionTemplate::New()` when using\n`v8::Function::New()` suffices. This ensures that individual functions\ncan be gc-ed and that functions can be created dynamically without\nrunning out of memory.\n\nPR-URL: https://github.com/nodejs/node/pull/21688\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Kyle Farnung <kfarnung@microsoft.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "978d89f5e3cf238a0e42303acc9493993ede9c98",
    "files": [
        {
            "sha": "1d42435264cfec4052ae307c38d96eba0dce26e4",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/978d89f5e3cf238a0e42303acc9493993ede9c98/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/978d89f5e3cf238a0e42303acc9493993ede9c98/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=978d89f5e3cf238a0e42303acc9493993ede9c98",
            "patch": "@@ -1025,11 +1025,11 @@ napi_status napi_create_function(napi_env env,\n \n   RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n \n-  v8::Local<v8::FunctionTemplate> tpl = v8::FunctionTemplate::New(\n-      isolate, v8impl::FunctionCallbackWrapper::Invoke, cbdata);\n-\n   v8::Local<v8::Context> context = isolate->GetCurrentContext();\n-  v8::MaybeLocal<v8::Function> maybe_function = tpl->GetFunction(context);\n+  v8::MaybeLocal<v8::Function> maybe_function =\n+      v8::Function::New(context,\n+                        v8impl::FunctionCallbackWrapper::Invoke,\n+                        cbdata);\n   CHECK_MAYBE_EMPTY(env, maybe_function, napi_generic_failure);\n \n   return_value = scope.Escape(maybe_function.ToLocalChecked());\n@@ -1491,13 +1491,17 @@ napi_status napi_define_properties(napi_env env,\n       v8::Local<v8::Value> cbdata =\n           v8impl::CreateFunctionCallbackData(env, p->method, p->data);\n \n-      RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n+      CHECK_MAYBE_EMPTY(env, cbdata, napi_generic_failure);\n+\n+      v8::MaybeLocal<v8::Function> maybe_fn =\n+          v8::Function::New(context,\n+                            v8impl::FunctionCallbackWrapper::Invoke,\n+                            cbdata);\n \n-      v8::Local<v8::FunctionTemplate> t = v8::FunctionTemplate::New(\n-          isolate, v8impl::FunctionCallbackWrapper::Invoke, cbdata);\n+      CHECK_MAYBE_EMPTY(env, maybe_fn, napi_generic_failure);\n \n       auto define_maybe = obj->DefineOwnProperty(\n-        context, property_name, t->GetFunction(), attributes);\n+        context, property_name, maybe_fn.ToLocalChecked(), attributes);\n \n       if (!define_maybe.FromMaybe(false)) {\n         return napi_set_last_error(env, napi_generic_failure);"
        },
        {
            "sha": "6f0f1681752a2c50e9314d57a3a2f011f7e5e452",
            "filename": "test/addons-napi/test_function/test.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/978d89f5e3cf238a0e42303acc9493993ede9c98/test%2Faddons-napi%2Ftest_function%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/978d89f5e3cf238a0e42303acc9493993ede9c98/test%2Faddons-napi%2Ftest_function%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_function%2Ftest.js?ref=978d89f5e3cf238a0e42303acc9493993ede9c98",
            "patch": "@@ -1,11 +1,12 @@\n 'use strict';\n+// Flags: --expose-gc\n+\n const common = require('../../common');\n const assert = require('assert');\n \n // testing api calls for function\n const test_function = require(`./build/${common.buildType}/test_function`);\n \n-\n function func1() {\n   return 1;\n }\n@@ -29,3 +30,8 @@ assert.strictEqual(test_function.TestCall(func4, 1), 2);\n \n assert.strictEqual(test_function.TestName.name, 'Name');\n assert.strictEqual(test_function.TestNameShort.name, 'Name_');\n+\n+let tracked_function = test_function.MakeTrackedFunction(common.mustCall());\n+assert(!!tracked_function);\n+tracked_function = null;\n+global.gc();"
        },
        {
            "sha": "068999a6e5bc5c8a2b3618f477b7b091c6f7b786",
            "filename": "test/addons-napi/test_function/test_function.c",
            "status": "modified",
            "additions": 84,
            "deletions": 0,
            "changes": 84,
            "blob_url": "https://github.com/nodejs/node/blob/978d89f5e3cf238a0e42303acc9493993ede9c98/test%2Faddons-napi%2Ftest_function%2Ftest_function.c",
            "raw_url": "https://github.com/nodejs/node/raw/978d89f5e3cf238a0e42303acc9493993ede9c98/test%2Faddons-napi%2Ftest_function%2Ftest_function.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_function%2Ftest_function.c?ref=978d89f5e3cf238a0e42303acc9493993ede9c98",
            "patch": "@@ -30,6 +30,78 @@ static napi_value TestFunctionName(napi_env env, napi_callback_info info) {\n   return NULL;\n }\n \n+static void finalize_function(napi_env env, void* data, void* hint) {\n+  napi_ref ref = data;\n+\n+  // Retrieve the JavaScript undefined value.\n+  napi_value undefined;\n+  NAPI_CALL_RETURN_VOID(env, napi_get_undefined(env, &undefined));\n+\n+  // Retrieve the JavaScript function we must call.\n+  napi_value js_function;\n+  NAPI_CALL_RETURN_VOID(env, napi_get_reference_value(env, ref, &js_function));\n+\n+  // Call the JavaScript function to indicate that the generated JavaScript\n+  // function is about to be gc-ed.\n+  NAPI_CALL_RETURN_VOID(env, napi_call_function(env,\n+                                                undefined,\n+                                                js_function,\n+                                                0,\n+                                                NULL,\n+                                                NULL));\n+\n+  // Destroy the persistent reference to the function we just called so as to\n+  // properly clean up.\n+  NAPI_CALL_RETURN_VOID(env, napi_delete_reference(env, ref));\n+}\n+\n+static napi_value MakeTrackedFunction(napi_env env, napi_callback_info info) {\n+  size_t argc = 1;\n+  napi_value js_finalize_cb;\n+  napi_valuetype arg_type;\n+\n+  // Retrieve and validate from the arguments the function we will use to\n+  // indicate to JavaScript that the function we are about to create is about to\n+  // be gc-ed.\n+  NAPI_CALL(env, napi_get_cb_info(env,\n+                                  info,\n+                                  &argc,\n+                                  &js_finalize_cb,\n+                                  NULL,\n+                                  NULL));\n+  NAPI_ASSERT(env, argc == 1, \"Wrong number of arguments\");\n+  NAPI_CALL(env, napi_typeof(env, js_finalize_cb, &arg_type));\n+  NAPI_ASSERT(env, arg_type == napi_function, \"Argument must be a function\");\n+\n+  // Dynamically create a function.\n+  napi_value result;\n+  NAPI_CALL(env, napi_create_function(env,\n+                                      \"TrackedFunction\",\n+                                      NAPI_AUTO_LENGTH,\n+                                      TestFunctionName,\n+                                      NULL,\n+                                      &result));\n+\n+  // Create a strong reference to the function we will call when the tracked\n+  // function is about to be gc-ed.\n+  napi_ref js_finalize_cb_ref;\n+  NAPI_CALL(env, napi_create_reference(env,\n+                                       js_finalize_cb,\n+                                       1,\n+                                       &js_finalize_cb_ref));\n+\n+  // Attach a finalizer to the dynamically created function and pass it the\n+  // strong reference we created in the previous step.\n+  NAPI_CALL(env, napi_wrap(env,\n+                           result,\n+                           js_finalize_cb_ref,\n+                           finalize_function,\n+                           NULL,\n+                           NULL));\n+\n+  return result;\n+}\n+\n static napi_value Init(napi_env env, napi_value exports) {\n   napi_value fn1;\n   NAPI_CALL(env, napi_create_function(\n@@ -43,9 +115,21 @@ static napi_value Init(napi_env env, napi_value exports) {\n   NAPI_CALL(env, napi_create_function(\n       env, \"Name_extra\", 5, TestFunctionName, NULL, &fn3));\n \n+  napi_value fn4;\n+  NAPI_CALL(env, napi_create_function(env,\n+                                      \"MakeTrackedFunction\",\n+                                      NAPI_AUTO_LENGTH,\n+                                      MakeTrackedFunction,\n+                                      NULL,\n+                                      &fn4));\n+\n   NAPI_CALL(env, napi_set_named_property(env, exports, \"TestCall\", fn1));\n   NAPI_CALL(env, napi_set_named_property(env, exports, \"TestName\", fn2));\n   NAPI_CALL(env, napi_set_named_property(env, exports, \"TestNameShort\", fn3));\n+  NAPI_CALL(env, napi_set_named_property(env,\n+                                         exports,\n+                                         \"MakeTrackedFunction\",\n+                                         fn4));\n \n   return exports;\n }"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 103,
        "deletions": 9
    }
}