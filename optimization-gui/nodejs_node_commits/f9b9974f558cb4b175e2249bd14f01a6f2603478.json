{
    "author": "tniessen",
    "message": "crypto: support authTagLength in GCM encryption\n\nThe authTagLength option can now be used to produce GCM authentication\ntags with a specific length.\n\nPR-URL: https://github.com/nodejs/node/pull/20235\nRefs: https://github.com/nodejs/node/pull/20039\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Yihong Wang <yh.wang@ibm.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "f9b9974f558cb4b175e2249bd14f01a6f2603478",
    "files": [
        {
            "sha": "6d99978110141d23a08a552d3b7ebe13b708915b",
            "filename": "doc/api/crypto.md",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/f9b9974f558cb4b175e2249bd14f01a6f2603478/doc%2Fapi%2Fcrypto.md",
            "raw_url": "https://github.com/nodejs/node/raw/f9b9974f558cb4b175e2249bd14f01a6f2603478/doc%2Fapi%2Fcrypto.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcrypto.md?ref=f9b9974f558cb4b175e2249bd14f01a6f2603478",
            "patch": "@@ -1321,6 +1321,11 @@ This property is deprecated. Please use `crypto.setFips()` and\n <!-- YAML\n added: v0.1.94\n deprecated: v10.0.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/20235\n+    description: The `authTagLength` option can now be used to produce shorter\n+                 authentication tags in GCM mode and defaults to 16 bytes.\n -->\n \n > Stability: 0 - Deprecated: Use [`crypto.createCipheriv()`][] instead.\n@@ -1336,7 +1341,9 @@ Creates and returns a `Cipher` object that uses the given `algorithm` and\n The `options` argument controls stream behavior and is optional except when a\n cipher in CCM mode is used (e.g. `'aes-128-ccm'`). In that case, the\n `authTagLength` option is required and specifies the length of the\n-authentication tag in bytes, see [CCM mode][].\n+authentication tag in bytes, see [CCM mode][]. In GCM mode, the `authTagLength`\n+option is not required but can be used to set the length of the authentication\n+tag that will be returned by `getAuthTag()` and defaults to 16 bytes.\n \n The `algorithm` is dependent on OpenSSL, examples are `'aes192'`, etc. On\n recent OpenSSL releases, `openssl list-cipher-algorithms` will display the\n@@ -1366,6 +1373,10 @@ Adversaries][] for details.\n <!-- YAML\n added: v0.1.94\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/20235\n+    description: The `authTagLength` option can now be used to produce shorter\n+                 authentication tags in GCM mode and defaults to 16 bytes.\n   - version: v9.9.0\n     pr-url: https://github.com/nodejs/node/pull/18644\n     description: The `iv` parameter may now be `null` for ciphers which do not\n@@ -1383,7 +1394,9 @@ initialization vector (`iv`).\n The `options` argument controls stream behavior and is optional except when a\n cipher in CCM mode is used (e.g. `'aes-128-ccm'`). In that case, the\n `authTagLength` option is required and specifies the length of the\n-authentication tag in bytes, see [CCM mode][].\n+authentication tag in bytes, see [CCM mode][]. In GCM mode, the `authTagLength`\n+option is not required but can be used to set the length of the authentication\n+tag that will be returned by `getAuthTag()` and defaults to 16 bytes.\n \n The `algorithm` is dependent on OpenSSL, examples are `'aes192'`, etc. On\n recent OpenSSL releases, `openssl list-cipher-algorithms` will display the"
        },
        {
            "sha": "42f4d4035d6632189a412219675c1187b9f3de33",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/f9b9974f558cb4b175e2249bd14f01a6f2603478/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f9b9974f558cb4b175e2249bd14f01a6f2603478/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=f9b9974f558cb4b175e2249bd14f01a6f2603478",
            "patch": "@@ -3106,9 +3106,10 @@ bool CipherBase::Final(unsigned char** out, int *out_len) {\n     ok = EVP_CipherFinal_ex(ctx_, *out, out_len) == 1;\n \n     if (ok && kind_ == kCipher && IsAuthenticatedMode()) {\n-      // For GCM, the tag length is static (16 bytes), while the CCM tag length\n-      // must be specified in advance.\n-      if (mode == EVP_CIPH_GCM_MODE)\n+      // In GCM mode, the authentication tag length can be specified in advance,\n+      // but defaults to 16 bytes when encrypting. In CCM mode, it must always\n+      // be given by the user.\n+      if (mode == EVP_CIPH_GCM_MODE && auth_tag_len_ == kNoAuthTagLength)\n         auth_tag_len_ = sizeof(auth_tag_);\n       // TOOD(tniessen) Use EVP_CTRL_AEAP_GET_TAG in OpenSSL 1.1.0\n       static_assert(EVP_CTRL_CCM_GET_TAG == EVP_CTRL_GCM_GET_TAG,"
        },
        {
            "sha": "e915db4e9d0991ee5ce2d561efc6ce9b74836132",
            "filename": "test/parallel/test-crypto-authenticated.js",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/f9b9974f558cb4b175e2249bd14f01a6f2603478/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "raw_url": "https://github.com/nodejs/node/raw/f9b9974f558cb4b175e2249bd14f01a6f2603478/test%2Fparallel%2Ftest-crypto-authenticated.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-authenticated.js?ref=f9b9974f558cb4b175e2249bd14f01a6f2603478",
            "patch": "@@ -727,6 +727,18 @@ for (const test of TEST_CASES) {\n       message: `Invalid GCM authentication tag length: ${length}`\n     });\n \n+    common.expectsError(() => {\n+      crypto.createCipheriv('aes-256-gcm',\n+                            'FxLKsqdmv0E9xrQhp0b1ZgI0K7JFZJM8',\n+                            'qkuZpJWCewa6Szih',\n+                            {\n+                              authTagLength: length\n+                            });\n+    }, {\n+      type: Error,\n+      message: `Invalid GCM authentication tag length: ${length}`\n+    });\n+\n     common.expectsError(() => {\n       crypto.createDecipheriv('aes-256-gcm',\n                               'FxLKsqdmv0E9xrQhp0b1ZgI0K7JFZJM8',\n@@ -741,6 +753,23 @@ for (const test of TEST_CASES) {\n   }\n }\n \n+// Test that GCM can produce shorter authentication tags than 16 bytes.\n+{\n+  const fullTag = '1debb47b2c91ba2cea16fad021703070';\n+  for (const [authTagLength, e] of [[undefined, 16], [12, 12], [4, 4]]) {\n+    const cipher = crypto.createCipheriv('aes-256-gcm',\n+                                         'FxLKsqdmv0E9xrQhp0b1ZgI0K7JFZJM8',\n+                                         'qkuZpJWCewa6Szih', {\n+                                           authTagLength\n+                                         });\n+    cipher.setAAD(Buffer.from('abcd'));\n+    cipher.update('01234567', 'hex');\n+    cipher.final();\n+    const tag = cipher.getAuthTag();\n+    assert.strictEqual(tag.toString('hex'), fullTag.substr(0, 2 * e));\n+  }\n+}\n+\n // Test that users can manually restrict the GCM tag length to a single value.\n {\n   const decipher = crypto.createDecipheriv('aes-256-gcm',"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 48,
        "deletions": 5
    }
}