{
    "author": "ofrobots",
    "message": "src: ready background workers before bootstrap\n\nMake sure background workers are ready before proceeding with the\nbootstrap or post-bootstrap execution of any code that may trigger\n`process.exit()`.\n\nFixes: https://github.com/nodejs/node/issues/23065\n\nPR-URL: https://github.com/nodejs/node/pull/23233\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "e273abc01be9f04511e44cacea20c4f4935b970f",
    "files": [
        {
            "sha": "b583ce85423fb1e9a082abd2a5d11c7d0de07bbd",
            "filename": "src/node_platform.cc",
            "status": "modified",
            "additions": 35,
            "deletions": 2,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/e273abc01be9f04511e44cacea20c4f4935b970f/src%2Fnode_platform.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e273abc01be9f04511e44cacea20c4f4935b970f/src%2Fnode_platform.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.cc?ref=e273abc01be9f04511e44cacea20c4f4935b970f",
            "patch": "@@ -18,10 +18,29 @@ using v8::TracingController;\n \n namespace {\n \n+struct PlatformWorkerData {\n+  TaskQueue<Task>* task_queue;\n+  Mutex* platform_workers_mutex;\n+  ConditionVariable* platform_workers_ready;\n+  int* pending_platform_workers;\n+  int id;\n+};\n+\n static void PlatformWorkerThread(void* data) {\n+  std::unique_ptr<PlatformWorkerData>\n+      worker_data(static_cast<PlatformWorkerData*>(data));\n+\n+  TaskQueue<Task>* pending_worker_tasks = worker_data->task_queue;\n   TRACE_EVENT_METADATA1(\"__metadata\", \"thread_name\", \"name\",\n                         \"PlatformWorkerThread\");\n-  TaskQueue<Task>* pending_worker_tasks = static_cast<TaskQueue<Task>*>(data);\n+\n+  // Notify the main thread that the platform worker is ready.\n+  {\n+    Mutex::ScopedLock lock(*worker_data->platform_workers_mutex);\n+    (*worker_data->pending_platform_workers)--;\n+    worker_data->platform_workers_ready->Signal(lock);\n+  }\n+\n   while (std::unique_ptr<Task> task = pending_worker_tasks->BlockingPop()) {\n     task->Run();\n     pending_worker_tasks->NotifyOfCompletion();\n@@ -148,17 +167,31 @@ class WorkerThreadsTaskRunner::DelayedTaskScheduler {\n };\n \n WorkerThreadsTaskRunner::WorkerThreadsTaskRunner(int thread_pool_size) {\n+  Mutex::ScopedLock lock(platform_workers_mutex_);\n+  pending_platform_workers_ = thread_pool_size;\n+\n   delayed_task_scheduler_.reset(\n       new DelayedTaskScheduler(&pending_worker_tasks_));\n   threads_.push_back(delayed_task_scheduler_->Start());\n+\n   for (int i = 0; i < thread_pool_size; i++) {\n+    PlatformWorkerData* worker_data = new PlatformWorkerData{\n+      &pending_worker_tasks_, &platform_workers_mutex_,\n+      &platform_workers_ready_, &pending_platform_workers_, i\n+    };\n     std::unique_ptr<uv_thread_t> t { new uv_thread_t() };\n     if (uv_thread_create(t.get(), PlatformWorkerThread,\n-                         &pending_worker_tasks_) != 0) {\n+                         worker_data) != 0) {\n       break;\n     }\n     threads_.push_back(std::move(t));\n   }\n+\n+  // Wait for platform workers to initialize before continuing with the\n+  // bootstrap.\n+  while (pending_platform_workers_ > 0) {\n+    platform_workers_ready_.Wait(lock);\n+  }\n }\n \n void WorkerThreadsTaskRunner::PostTask(std::unique_ptr<Task> task) {"
        },
        {
            "sha": "197d5cee3968a71f9d3e7e8f29d9e8613174ac7a",
            "filename": "src/node_platform.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e273abc01be9f04511e44cacea20c4f4935b970f/src%2Fnode_platform.h",
            "raw_url": "https://github.com/nodejs/node/raw/e273abc01be9f04511e44cacea20c4f4935b970f/src%2Fnode_platform.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.h?ref=e273abc01be9f04511e44cacea20c4f4935b970f",
            "patch": "@@ -116,6 +116,10 @@ class WorkerThreadsTaskRunner {\n   std::unique_ptr<DelayedTaskScheduler> delayed_task_scheduler_;\n \n   std::vector<std::unique_ptr<uv_thread_t>> threads_;\n+\n+  Mutex platform_workers_mutex_;\n+  ConditionVariable platform_workers_ready_;\n+  int pending_platform_workers_;\n };\n \n class NodePlatform : public MultiIsolatePlatform {"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 39,
        "deletions": 2
    }
}