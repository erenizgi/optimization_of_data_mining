{
    "author": "bnoordhuis",
    "message": "crypto: DRY type checking\n\nFactor out some common code.  The `checkUint()` function will also be\nused in a follow-up commit that adds scrypt support to core.\n\nPR-URL: https://github.com/nodejs/node/pull/20816\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "58176e352c7b4fe6042fc31283a79d8de4cdb569",
    "files": [
        {
            "sha": "fa004f6c21f409ef62df83fb5df6e8952c8bd3f6",
            "filename": "lib/internal/crypto/pbkdf2.js",
            "status": "modified",
            "additions": 7,
            "deletions": 21,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Fpbkdf2.js",
            "raw_url": "https://github.com/nodejs/node/raw/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Fpbkdf2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fpbkdf2.js?ref=58176e352c7b4fe6042fc31283a79d8de4cdb569",
            "patch": "@@ -4,19 +4,15 @@ const {\n   ERR_INVALID_ARG_TYPE,\n   ERR_INVALID_CALLBACK,\n   ERR_CRYPTO_INVALID_DIGEST,\n-  ERR_OUT_OF_RANGE\n } = require('internal/errors').codes;\n const {\n   checkIsArrayBufferView,\n+  checkIsUint,\n   getDefaultEncoding,\n-  toBuf\n } = require('internal/crypto/util');\n const {\n   PBKDF2\n } = process.binding('crypto');\n-const {\n-  INT_MAX\n-} = process.binding('constants').crypto;\n \n function pbkdf2(password, salt, iterations, keylen, digest, callback) {\n   if (typeof digest === 'function') {\n@@ -39,22 +35,12 @@ function _pbkdf2(password, salt, iterations, keylen, digest, callback) {\n   if (digest !== null && typeof digest !== 'string')\n     throw new ERR_INVALID_ARG_TYPE('digest', ['string', 'null'], digest);\n \n-  password = checkIsArrayBufferView('password', toBuf(password));\n-  salt = checkIsArrayBufferView('salt', toBuf(salt));\n-\n-  if (typeof iterations !== 'number')\n-    throw new ERR_INVALID_ARG_TYPE('iterations', 'number', iterations);\n-\n-  if (iterations < 0)\n-    throw new ERR_OUT_OF_RANGE('iterations',\n-                               'a non-negative number',\n-                               iterations);\n-\n-  if (typeof keylen !== 'number')\n-    throw new ERR_INVALID_ARG_TYPE('keylen', 'number', keylen);\n-\n-  if (keylen < 0 || !Number.isInteger(keylen) || keylen > INT_MAX)\n-    throw new ERR_OUT_OF_RANGE('keylen', `>= 0 && <= ${INT_MAX}`, keylen);\n+  password = checkIsArrayBufferView('password', password);\n+  salt = checkIsArrayBufferView('salt', salt);\n+  // FIXME(bnoordhuis) The error message is in fact wrong since |iterations|\n+  // cannot be > INT_MAX.  Adjust in the next major release.\n+  iterations = checkIsUint('iterations', iterations, 'a non-negative number');\n+  keylen = checkIsUint('keylen', keylen);\n \n   const encoding = getDefaultEncoding();\n "
        },
        {
            "sha": "fa440eb6a3475cc088bc2bf8566e9e0845ce8d22",
            "filename": "lib/internal/crypto/sig.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Fsig.js",
            "raw_url": "https://github.com/nodejs/node/raw/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Fsig.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fsig.js?ref=58176e352c7b4fe6042fc31283a79d8de4cdb569",
            "patch": "@@ -77,7 +77,7 @@ Sign.prototype.sign = function sign(options, encoding) {\n \n   var pssSaltLength = getSaltLength(options);\n \n-  key = checkIsArrayBufferView('key', toBuf(key));\n+  key = checkIsArrayBufferView('key', key);\n \n   var ret = this._handle.sign(key, passphrase, rsaPadding, pssSaltLength);\n \n@@ -114,7 +114,7 @@ Verify.prototype.verify = function verify(options, signature, sigEncoding) {\n \n   var pssSaltLength = getSaltLength(options);\n \n-  key = checkIsArrayBufferView('key', toBuf(key));\n+  key = checkIsArrayBufferView('key', key);\n \n   signature = checkIsArrayBufferView('signature',\n                                      toBuf(signature, sigEncoding));"
        },
        {
            "sha": "cda973addcfe76f7051da25e0c03973098fff93f",
            "filename": "lib/internal/crypto/util.js",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/58176e352c7b4fe6042fc31283a79d8de4cdb569/lib%2Finternal%2Fcrypto%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Futil.js?ref=58176e352c7b4fe6042fc31283a79d8de4cdb569",
            "patch": "@@ -15,7 +15,8 @@ const {\n const {\n   ERR_CRYPTO_ENGINE_UNKNOWN,\n   ERR_CRYPTO_TIMING_SAFE_EQUAL_LENGTH,\n-  ERR_INVALID_ARG_TYPE\n+  ERR_INVALID_ARG_TYPE,\n+  ERR_OUT_OF_RANGE,\n } = require('internal/errors').codes;\n const { Buffer } = require('buffer');\n const {\n@@ -25,6 +26,9 @@ const {\n const {\n   isArrayBufferView\n } = require('internal/util/types');\n+const {\n+  INT_MAX\n+} = process.binding('constants').crypto;\n \n var defaultEncoding = 'buffer';\n \n@@ -84,6 +88,7 @@ function timingSafeEqual(buf1, buf2) {\n }\n \n function checkIsArrayBufferView(name, buffer) {\n+  buffer = toBuf(buffer);\n   if (!isArrayBufferView(buffer)) {\n     throw new ERR_INVALID_ARG_TYPE(\n       name,\n@@ -94,8 +99,19 @@ function checkIsArrayBufferView(name, buffer) {\n   return buffer;\n }\n \n+function checkIsUint(name, value, errmsg = `>= 0 && <= ${INT_MAX}`) {\n+  if (typeof value !== 'number')\n+    throw new ERR_INVALID_ARG_TYPE(name, 'number', value);\n+\n+  if (value < 0 || !Number.isInteger(value) || value > INT_MAX)\n+    throw new ERR_OUT_OF_RANGE(name, errmsg, value);\n+\n+  return value;\n+}\n+\n module.exports = {\n   checkIsArrayBufferView,\n+  checkIsUint,\n   getCiphers,\n   getCurves,\n   getDefaultEncoding,"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 26,
        "deletions": 24
    }
}