{
    "author": "apapirovski",
    "message": "src: refactor timers to remove TimerWrap\n\nRefactor Timers to behave more similarly to Immediates by having\na single uv_timer_t handle which is stored on the Environment.\n\nNo longer expose timers in a public binding and instead make\nit part of the internalBinding.\n\nPR-URL: https://github.com/nodejs/node/pull/20894\nFixes: https://github.com/nodejs/node/issues/10154\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "2930bd1317d15d12738a4896c0a6c05700411b47",
    "files": [
        {
            "sha": "6e3b0827d55bb401151d0de0c23c4f4dbbbe2138",
            "filename": "doc/api/async_hooks.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/doc%2Fapi%2Fasync_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/doc%2Fapi%2Fasync_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fasync_hooks.md?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -238,7 +238,7 @@ resource's constructor.\n ```text\n FSEVENTWRAP, FSREQWRAP, GETADDRINFOREQWRAP, GETNAMEINFOREQWRAP, HTTPPARSER,\n JSSTREAM, PIPECONNECTWRAP, PIPEWRAP, PROCESSWRAP, QUERYWRAP, SHUTDOWNWRAP,\n-SIGNALWRAP, STATWATCHER, TCPCONNECTWRAP, TCPSERVER, TCPWRAP, TIMERWRAP, TTYWRAP,\n+SIGNALWRAP, STATWATCHER, TCPCONNECTWRAP, TCPSERVER, TCPWRAP, TTYWRAP,\n UDPSENDWRAP, UDPWRAP, WRITEWRAP, ZLIB, SSLCONNECTION, PBKDF2REQUEST,\n RANDOMBYTESREQUEST, TLSWRAP, Timeout, Immediate, TickObject\n ```"
        },
        {
            "sha": "c7d9d1750e9821975c28c9eeaf90c36698dcfcee",
            "filename": "lib/internal/timers.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/lib%2Finternal%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/lib%2Finternal%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftimers.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -6,6 +6,7 @@ const {\n   initHooksExist,\n   emitInit\n } = require('internal/async_hooks');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n // Symbols for storing async id state.\n const async_id_symbol = Symbol('asyncId');\n const trigger_async_id_symbol = Symbol('triggerId');\n@@ -30,7 +31,8 @@ module.exports = {\n   kRefed,\n   initAsyncResource,\n   setUnrefTimeout,\n-  validateTimerDuration\n+  validateTimerDuration,\n+  getLibuvNow: internalBinding('timers').getLibuvNow,\n };\n \n var timers;"
        },
        {
            "sha": "ad2d89d7bfe0727119b98f6eccccbcff6fc54bab",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 25,
            "deletions": 39,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -21,10 +21,15 @@\n \n 'use strict';\n \n+const { internalBinding } = require('internal/bootstrap/loaders');\n const {\n-  Timer: TimerWrap,\n+  getLibuvNow,\n   setupTimers,\n-} = process.binding('timer_wrap');\n+  scheduleTimer,\n+  toggleTimerRef,\n+  immediateInfo,\n+  toggleImmediateRef\n+} = internalBinding('timers');\n const L = require('internal/linkedlist');\n const PriorityQueue = require('internal/priority_queue');\n const {\n@@ -53,8 +58,9 @@ const kCount = 0;\n const kRefCount = 1;\n const kHasOutstanding = 2;\n \n-const [immediateInfo, toggleImmediateRef] =\n-  setupTimers(processImmediate, processTimers);\n+// Call into C++ to assign callbacks that are responsible for processing\n+// Immediates and TimerLists.\n+setupTimers(processImmediate, processTimers);\n \n // HOW and WHY the timers implementation works the way it does.\n //\n@@ -156,47 +162,38 @@ function setPosition(node, pos) {\n   node.priorityQueuePosition = pos;\n }\n \n-let handle = null;\n let nextExpiry = Infinity;\n \n let timerListId = Number.MIN_SAFE_INTEGER;\n let refCount = 0;\n \n function incRefCount() {\n   if (refCount++ === 0)\n-    handle.ref();\n+    toggleTimerRef(true);\n }\n \n function decRefCount() {\n   if (--refCount === 0)\n-    handle.unref();\n-}\n-\n-function createHandle(refed) {\n-  debug('initial run, creating TimerWrap handle');\n-  handle = new TimerWrap();\n-  if (!refed)\n-    handle.unref();\n+    toggleTimerRef(false);\n }\n \n // Schedule or re-schedule a timer.\n // The item must have been enroll()'d first.\n const active = exports.active = function(item) {\n-  insert(item, true, TimerWrap.now());\n+  insert(item, true, getLibuvNow());\n };\n \n // Internal APIs that need timeouts should use `_unrefActive()` instead of\n // `active()` so that they do not unnecessarily keep the process open.\n exports._unrefActive = function(item) {\n-  insert(item, false, TimerWrap.now());\n+  insert(item, false, getLibuvNow());\n };\n \n \n // The underlying logic for scheduling or re-scheduling a timer.\n //\n // Appends a timer onto the end of an existing timers list, or creates a new\n-// TimerWrap backed list if one does not already exist for the specified timeout\n-// duration.\n+// list if one does not already exist for the specified timeout duration.\n function insert(item, refed, start) {\n   const msecs = item._idleTimeout;\n   if (msecs < 0 || msecs === undefined)\n@@ -213,9 +210,7 @@ function insert(item, refed, start) {\n     queue.insert(list);\n \n     if (nextExpiry > expiry) {\n-      if (handle === null)\n-        createHandle(refed);\n-      handle.start(msecs);\n+      scheduleTimer(msecs);\n       nextExpiry = expiry;\n     }\n   }\n@@ -252,32 +247,23 @@ function processTimers(now) {\n \n   let list, ran;\n   while (list = queue.peek()) {\n-    if (list.expiry > now)\n-      break;\n+    if (list.expiry > now) {\n+      nextExpiry = list.expiry;\n+      return refCount > 0 ? nextExpiry : -nextExpiry;\n+    }\n     if (ran)\n       runNextTicks();\n+    else\n+      ran = true;\n     listOnTimeout(list, now);\n-    ran = true;\n   }\n-\n-  if (refCount > 0)\n-    handle.ref();\n-  else\n-    handle.unref();\n-\n-  if (list !== undefined) {\n-    nextExpiry = list.expiry;\n-    handle.start(Math.max(nextExpiry - TimerWrap.now(), 1));\n-  }\n-\n-  return true;\n+  return 0;\n }\n \n function listOnTimeout(list, now) {\n   const msecs = list.msecs;\n \n   debug('timeout callback %d', msecs);\n-  debug('now: %d', now);\n \n   var diff, timer;\n   while (timer = L.peek(list)) {\n@@ -336,7 +322,7 @@ function listOnTimeout(list, now) {\n // 4.7) what is in this smaller function.\n function tryOnTimeout(timer, start) {\n   if (start === undefined && timer._repeat)\n-    start = TimerWrap.now();\n+    start = getLibuvNow();\n   try {\n     ontimeout(timer);\n   } finally {\n@@ -474,7 +460,7 @@ function ontimeout(timer) {\n }\n \n function rearm(timer, start) {\n-  // // Do not re-arm unenroll'd or closed timers.\n+  // Do not re-arm unenroll'd or closed timers.\n   if (timer._idleTimeout === -1)\n     return;\n "
        },
        {
            "sha": "b16c9466fe47d40c32072098daa707816a0ef73b",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -371,7 +371,7 @@\n         'src/stream_pipe.cc',\n         'src/stream_wrap.cc',\n         'src/tcp_wrap.cc',\n-        'src/timer_wrap.cc',\n+        'src/timers.cc',\n         'src/tracing/agent.cc',\n         'src/tracing/node_trace_buffer.cc',\n         'src/tracing/node_trace_writer.cc',"
        },
        {
            "sha": "64b74ac209607b16d97a7eee6ffc8c7fc2a635aa",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -63,7 +63,6 @@ namespace node {\n   V(TCPCONNECTWRAP)                                                           \\\n   V(TCPSERVERWRAP)                                                            \\\n   V(TCPWRAP)                                                                  \\\n-  V(TIMERWRAP)                                                                \\\n   V(TTYWRAP)                                                                  \\\n   V(UDPSENDWRAP)                                                              \\\n   V(UDPWRAP)                                                                  \\"
        },
        {
            "sha": "40fa5dfa6857a18972f45a8d0dfa5fec8197ac04",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -334,6 +334,14 @@ inline tracing::Agent* Environment::tracing_agent() const {\n   return tracing_agent_;\n }\n \n+inline Environment* Environment::from_timer_handle(uv_timer_t* handle) {\n+  return ContainerOf(&Environment::timer_handle_, handle);\n+}\n+\n+inline uv_timer_t* Environment::timer_handle() {\n+  return &timer_handle_;\n+}\n+\n inline Environment* Environment::from_immediate_check_handle(\n     uv_check_t* handle) {\n   return ContainerOf(&Environment::immediate_check_handle_, handle);"
        },
        {
            "sha": "f940c18d16ecebe0c1ba02c8c90111b2a2bbea29",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -13,6 +13,7 @@\n namespace node {\n \n using v8::Context;\n+using v8::Function;\n using v8::FunctionTemplate;\n using v8::HandleScope;\n using v8::Integer;\n@@ -25,6 +26,7 @@ using v8::StackFrame;\n using v8::StackTrace;\n using v8::String;\n using v8::Symbol;\n+using v8::TryCatch;\n using v8::Value;\n using worker::Worker;\n \n@@ -173,6 +175,9 @@ void Environment::Start(int argc,\n   HandleScope handle_scope(isolate());\n   Context::Scope context_scope(context());\n \n+  CHECK_EQ(0, uv_timer_init(event_loop(), timer_handle()));\n+  uv_unref(reinterpret_cast<uv_handle_t*>(timer_handle()));\n+\n   uv_check_init(event_loop(), immediate_check_handle());\n   uv_unref(reinterpret_cast<uv_handle_t*>(immediate_check_handle()));\n \n@@ -227,6 +232,10 @@ void Environment::RegisterHandleCleanups() {\n     env->CloseHandle(handle, [](uv_handle_t* handle) {});\n   };\n \n+  RegisterHandleCleanup(\n+      reinterpret_cast<uv_handle_t*>(timer_handle()),\n+      close_and_finish,\n+      nullptr);\n   RegisterHandleCleanup(\n       reinterpret_cast<uv_handle_t*>(immediate_check_handle()),\n       close_and_finish,\n@@ -470,6 +479,78 @@ void Environment::RunAndClearNativeImmediates() {\n }\n \n \n+void Environment::ScheduleTimer(int64_t duration_ms) {\n+  uv_timer_start(timer_handle(), RunTimers, duration_ms, 0);\n+}\n+\n+void Environment::ToggleTimerRef(bool ref) {\n+  if (ref) {\n+    uv_ref(reinterpret_cast<uv_handle_t*>(timer_handle()));\n+  } else {\n+    uv_unref(reinterpret_cast<uv_handle_t*>(timer_handle()));\n+  }\n+}\n+\n+void Environment::RunTimers(uv_timer_t* handle) {\n+  Environment* env = Environment::from_timer_handle(handle);\n+\n+  if (!env->can_call_into_js())\n+    return;\n+\n+  HandleScope handle_scope(env->isolate());\n+  Context::Scope context_scope(env->context());\n+\n+  Local<Object> process = env->process_object();\n+  InternalCallbackScope scope(env, process, {0, 0});\n+\n+  Local<Function> cb = env->timers_callback_function();\n+  MaybeLocal<Value> ret;\n+  Local<Value> arg = env->GetNow();\n+  // This code will loop until all currently due timers will process. It is\n+  // impossible for us to end up in an infinite loop due to how the JS-side\n+  // is structured.\n+  do {\n+    TryCatch try_catch(env->isolate());\n+    try_catch.SetVerbose(true);\n+    ret = cb->Call(env->context(), process, 1, &arg);\n+  } while (ret.IsEmpty() && env->can_call_into_js());\n+\n+  // NOTE(apapirovski): If it ever becomes possibble that `call_into_js` above\n+  // is reset back to `true` after being previously set to `false` then this\n+  // code becomes invalid and needs to be rewritten. Otherwise catastrophic\n+  // timers corruption will occurr and all timers behaviour will become\n+  // entirely unpredictable.\n+  if (ret.IsEmpty())\n+    return;\n+\n+  // To allow for less JS-C++ boundary crossing, the value returned from JS\n+  // serves a few purposes:\n+  // 1. If it's 0, no more timers exist and the handle should be unrefed\n+  // 2. If it's > 0, the value represents the next timer's expiry and there\n+  //    is at least one timer remaining that is refed.\n+  // 3. If it's < 0, the absolute value represents the next timer's expiry\n+  //    and there are no timers that are refed.\n+  int64_t expiry_ms =\n+      ret.ToLocalChecked()->IntegerValue(env->context()).FromJust();\n+\n+  uv_handle_t* h = reinterpret_cast<uv_handle_t*>(handle);\n+\n+  if (expiry_ms != 0) {\n+    int64_t duration_ms =\n+        llabs(expiry_ms) - (uv_now(env->event_loop()) - env->timer_base());\n+\n+    env->ScheduleTimer(duration_ms > 0 ? duration_ms : 1);\n+\n+    if (expiry_ms > 0)\n+      uv_ref(h);\n+    else\n+      uv_unref(h);\n+  } else {\n+    uv_unref(h);\n+  }\n+}\n+\n+\n void Environment::CheckImmediate(uv_check_t* handle) {\n   Environment* env = Environment::from_immediate_check_handle(handle);\n "
        },
        {
            "sha": "8f4c5ea1a6916ef050ddc9328b76eca365e2a74d",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -628,6 +628,9 @@ class Environment {\n   inline uv_loop_t* event_loop() const;\n   inline uint32_t watched_providers() const;\n \n+  static inline Environment* from_timer_handle(uv_timer_t* handle);\n+  inline uv_timer_t* timer_handle();\n+\n   static inline Environment* from_immediate_check_handle(uv_check_t* handle);\n   inline uv_check_t* immediate_check_handle();\n   inline uv_idle_t* immediate_idle_handle();\n@@ -840,6 +843,8 @@ class Environment {\n   static inline Environment* ForAsyncHooks(AsyncHooks* hooks);\n \n   v8::Local<v8::Value> GetNow();\n+  void ScheduleTimer(int64_t duration);\n+  void ToggleTimerRef(bool ref);\n \n   inline void AddCleanupHook(void (*fn)(void*), void* arg);\n   inline void RemoveCleanupHook(void (*fn)(void*), void* arg);\n@@ -857,6 +862,7 @@ class Environment {\n   v8::Isolate* const isolate_;\n   IsolateData* const isolate_data_;\n   tracing::Agent* const tracing_agent_;\n+  uv_timer_t timer_handle_;\n   uv_check_t immediate_check_handle_;\n   uv_idle_t immediate_idle_handle_;\n   uv_prepare_t idle_prepare_handle_;\n@@ -919,6 +925,8 @@ class Environment {\n \n   worker::Worker* worker_context_ = nullptr;\n \n+  static void RunTimers(uv_timer_t* handle);\n+\n   struct ExitCallback {\n     void (*cb_)(void* arg);\n     void* arg_;"
        },
        {
            "sha": "860566e314cb982280c90d187d16489add7a4336",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -129,7 +129,7 @@ struct sockaddr;\n     V(string_decoder)                                                         \\\n     V(symbols)                                                                \\\n     V(tcp_wrap)                                                               \\\n-    V(timer_wrap)                                                             \\\n+    V(timers)                                                             \\\n     V(trace_events)                                                           \\\n     V(tty_wrap)                                                               \\\n     V(types)                                                                  \\"
        },
        {
            "sha": "e9daf8d37cae92bd483186546c51f0f6f73f3ccc",
            "filename": "src/timers.cc",
            "status": "added",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Ftimers.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/src%2Ftimers.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftimers.cc?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -0,0 +1,64 @@\n+#include \"node_internals.h\"\n+\n+#include <stdint.h>\n+\n+namespace node {\n+namespace {\n+\n+using v8::Array;\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::Integer;\n+using v8::Local;\n+using v8::Object;\n+using v8::Value;\n+\n+void SetupTimers(const FunctionCallbackInfo<Value>& args) {\n+  CHECK(args[0]->IsFunction());\n+  CHECK(args[1]->IsFunction());\n+  auto env = Environment::GetCurrent(args);\n+\n+  env->set_immediate_callback_function(args[0].As<Function>());\n+  env->set_timers_callback_function(args[1].As<Function>());\n+}\n+\n+void GetLibuvNow(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  args.GetReturnValue().Set(env->GetNow());\n+}\n+\n+void ScheduleTimer(const FunctionCallbackInfo<Value>& args) {\n+  auto env = Environment::GetCurrent(args);\n+  env->ScheduleTimer(args[0]->IntegerValue(env->context()).FromJust());\n+}\n+\n+void ToggleTimerRef(const FunctionCallbackInfo<Value>& args) {\n+  Environment::GetCurrent(args)->ToggleTimerRef(args[0]->IsTrue());\n+}\n+\n+void ToggleImmediateRef(const FunctionCallbackInfo<Value>& args) {\n+  Environment::GetCurrent(args)->ToggleImmediateRef(args[0]->IsTrue());\n+}\n+\n+void Initialize(Local<Object> target,\n+                       Local<Value> unused,\n+                       Local<Context> context) {\n+  Environment* env = Environment::GetCurrent(context);\n+\n+  env->SetMethod(target, \"getLibuvNow\", GetLibuvNow);\n+  env->SetMethod(target, \"setupTimers\", SetupTimers);\n+  env->SetMethod(target, \"scheduleTimer\", ScheduleTimer);\n+  env->SetMethod(target, \"toggleTimerRef\", ToggleTimerRef);\n+  env->SetMethod(target, \"toggleImmediateRef\", ToggleImmediateRef);\n+\n+  target->Set(env->context(),\n+              FIXED_ONE_BYTE_STRING(env->isolate(), \"immediateInfo\"),\n+              env->immediate_info()->fields().GetJSArray()).FromJust();\n+}\n+\n+\n+}  // anonymous namespace\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(timers, node::Initialize)"
        },
        {
            "sha": "f948103de1f4ececa6186a1eddb11dcadb0e0ec9",
            "filename": "test/addons-napi/test_make_callback_recurse/test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Faddons-napi%2Ftest_make_callback_recurse%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Faddons-napi%2Ftest_make_callback_recurse%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_make_callback_recurse%2Ftest.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -78,9 +78,8 @@ assert.throws(function() {\n         }));\n       });\n     } else if (arg === 2) {\n-      // setTimeout runs via the TimerWrap, which runs through\n-      // AsyncWrap::MakeCallback(). Make sure there are no conflicts using\n-      // node::MakeCallback() within it.\n+      // Make sure there are no conflicts using node::MakeCallback()\n+      // within timers.\n       setTimeout(common.mustCall(function() {\n         verifyExecutionOrder(3);\n       }), 10);"
        },
        {
            "sha": "a3ea399a4967c8be38dd179ed093aacc589551a8",
            "filename": "test/addons/make-callback-recurse/test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Faddons%2Fmake-callback-recurse%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Faddons%2Fmake-callback-recurse%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback-recurse%2Ftest.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -79,9 +79,8 @@ assert.throws(function() {\n         }));\n       });\n     } else if (arg === 2) {\n-      // setTimeout runs via the TimerWrap, which runs through\n-      // AsyncWrap::MakeCallback(). Make sure there are no conflicts using\n-      // node::MakeCallback() within it.\n+      // Make sure there are no conflicts using node::MakeCallback()\n+      // within timers.\n       setTimeout(common.mustCall(function() {\n         verifyExecutionOrder(3);\n       }), 10);"
        },
        {
            "sha": "7352c4a84001f8d8ba7fd71bd306df0bac3c33b9",
            "filename": "test/async-hooks/coverage.md",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Fcoverage.md",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Fcoverage.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Fcoverage.md?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -23,7 +23,6 @@ Showing which kind of async resource is covered by which test:\n | STATWATCHER          | test-statwatcher.js                    |\n | TCPCONNECTWRAP       | test-tcpwrap.js                        |\n | TCPWRAP              | test-tcpwrap.js                        |\n-| TIMERWRAP            | test-timerwrap.set{Timeout,Interval}.js|\n | TLSWRAP              | test-tlswrap.js                        |\n | TTYWRAP              | test-ttywrap.{read,write}stream.js     |\n | UDPSENDWRAP          | test-udpsendwrap.js                    |"
        },
        {
            "sha": "b18bc7453c0fa222c4a3a7231abbdc703ff49556",
            "filename": "test/async-hooks/test-graph.http.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.http.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.http.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-graph.http.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -43,7 +43,6 @@ process.on('exit', function() {\n         triggerAsyncId: 'tcpserver:1' },\n       { type: 'TCPWRAP', id: 'tcp:2', triggerAsyncId: 'tcpserver:1' },\n       { type: 'Timeout', id: 'timeout:1', triggerAsyncId: 'tcp:2' },\n-      { type: 'TIMERWRAP', id: 'timer:1', triggerAsyncId: 'tcp:2' },\n       { type: 'HTTPPARSER',\n         id: 'httpparser:3',\n         triggerAsyncId: 'tcp:2' },\n@@ -53,9 +52,6 @@ process.on('exit', function() {\n       { type: 'Timeout',\n         id: 'timeout:2',\n         triggerAsyncId: 'httpparser:4' },\n-      { type: 'TIMERWRAP',\n-        id: 'timer:2',\n-        triggerAsyncId: 'httpparser:4' },\n       { type: 'SHUTDOWNWRAP',\n         id: 'shutdown:1',\n         triggerAsyncId: 'tcp:2' } ]"
        },
        {
            "sha": "8aa46ab07b54712ac35497e36ce0bc3e56a41299",
            "filename": "test/async-hooks/test-graph.intervals.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.intervals.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.intervals.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-graph.intervals.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -30,8 +30,6 @@ function onexit() {\n   verifyGraph(\n     hooks,\n     [ { type: 'Timeout', id: 'timeout:1', triggerAsyncId: null },\n-      { type: 'TIMERWRAP', id: 'timer:1', triggerAsyncId: null },\n-      { type: 'Timeout', id: 'timeout:2', triggerAsyncId: 'timeout:1' },\n-      { type: 'TIMERWRAP', id: 'timer:2', triggerAsyncId: 'timeout:1' } ]\n+      { type: 'Timeout', id: 'timeout:2', triggerAsyncId: 'timeout:1' }]\n   );\n }"
        },
        {
            "sha": "2ec1420f0c03b1515c67f86af499a8a054e1e0c7",
            "filename": "test/async-hooks/test-graph.timeouts.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.timeouts.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.timeouts.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-graph.timeouts.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -26,10 +26,7 @@ function onexit() {\n   verifyGraph(\n     hooks,\n     [ { type: 'Timeout', id: 'timeout:1', triggerAsyncId: null },\n-      { type: 'TIMERWRAP', id: 'timer:1', triggerAsyncId: null },\n       { type: 'Timeout', id: 'timeout:2', triggerAsyncId: 'timeout:1' },\n-      { type: 'TIMERWRAP', id: 'timer:2', triggerAsyncId: 'timeout:1' },\n-      { type: 'Timeout', id: 'timeout:3', triggerAsyncId: 'timeout:2' },\n-      { type: 'TIMERWRAP', id: 'timer:3', triggerAsyncId: 'timeout:2' } ]\n+      { type: 'Timeout', id: 'timeout:3', triggerAsyncId: 'timeout:2' }]\n   );\n }"
        },
        {
            "sha": "2ea03283e4c861e0f913b98c91d2bfffd4f797c9",
            "filename": "test/async-hooks/test-graph.tls-write.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.tls-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fasync-hooks%2Ftest-graph.tls-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-graph.tls-write.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -65,7 +65,6 @@ function onexit() {\n       { type: 'WRITEWRAP', id: 'write:1', triggerAsyncId: 'tcpconnect:1' },\n       { type: 'TCPWRAP', id: 'tcp:2', triggerAsyncId: 'tcpserver:1' },\n       { type: 'TLSWRAP', id: 'tls:2', triggerAsyncId: 'tcpserver:1' },\n-      { type: 'TIMERWRAP', id: 'timer:1', triggerAsyncId: 'tcpserver:1' },\n       { type: 'WRITEWRAP', id: 'write:2', triggerAsyncId: null },\n       { type: 'WRITEWRAP', id: 'write:3', triggerAsyncId: null },\n       { type: 'WRITEWRAP', id: 'write:4', triggerAsyncId: null },"
        },
        {
            "sha": "eab19be1df10f0d18f39cc4d10db1bbd82e53216",
            "filename": "test/async-hooks/test-timerwrap.setInterval.js",
            "status": "removed",
            "additions": 0,
            "deletions": 56,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fasync-hooks%2Ftest-timerwrap.setInterval.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fasync-hooks%2Ftest-timerwrap.setInterval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-timerwrap.setInterval.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,56 +0,0 @@\n-'use strict';\n-\n-const common = require('../common');\n-const assert = require('assert');\n-const tick = require('./tick');\n-const initHooks = require('./init-hooks');\n-const { checkInvocations } = require('./hook-checks');\n-const TIMEOUT = 1;\n-\n-const hooks = initHooks();\n-hooks.enable();\n-\n-let count = 0;\n-const iv = setInterval(common.mustCall(oninterval, 3), TIMEOUT);\n-\n-const as = hooks.activitiesOfTypes('TIMERWRAP');\n-assert.strictEqual(as.length, 1);\n-const t = as[0];\n-assert.strictEqual(t.type, 'TIMERWRAP');\n-assert.strictEqual(typeof t.uid, 'number');\n-assert.strictEqual(typeof t.triggerAsyncId, 'number');\n-checkInvocations(t, { init: 1 }, 't: when first timer installed');\n-\n-function oninterval() {\n-  count++;\n-  assert.strictEqual(as.length, 1);\n-  switch (count) {\n-    case 1: {\n-      checkInvocations(t, { init: 1, before: 1 },\n-                       't: when first timer triggered first time');\n-      break;\n-    }\n-    case 2: {\n-      checkInvocations(t, { init: 1, before: 2, after: 1 },\n-                       't: when first timer triggered second time');\n-      break;\n-    }\n-    case 3: {\n-      clearInterval(iv);\n-      checkInvocations(t, { init: 1, before: 3, after: 2 },\n-                       't: when first timer triggered third time');\n-      tick(2);\n-      break;\n-    }\n-  }\n-}\n-\n-process.on('exit', onexit);\n-\n-function onexit() {\n-  hooks.disable();\n-  hooks.sanityCheck('TIMERWRAP');\n-\n-  checkInvocations(t, { init: 1, before: 3, after: 3 },\n-                   't: when process exits');\n-}"
        },
        {
            "sha": "fcaf6bfc0aabc3e3c7a7ed9c9496e7f8ea0dc4f1",
            "filename": "test/async-hooks/test-timerwrap.setTimeout.js",
            "status": "removed",
            "additions": 0,
            "deletions": 59,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fasync-hooks%2Ftest-timerwrap.setTimeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fasync-hooks%2Ftest-timerwrap.setTimeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-timerwrap.setTimeout.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,59 +0,0 @@\n-'use strict';\n-\n-const common = require('../common');\n-const assert = require('assert');\n-const tick = require('./tick');\n-const initHooks = require('./init-hooks');\n-const { checkInvocations } = require('./hook-checks');\n-const TIMEOUT = common.platformTimeout(100);\n-\n-const hooks = initHooks();\n-hooks.enable();\n-\n-// install first timeout\n-setTimeout(common.mustCall(ontimeout), TIMEOUT);\n-const as = hooks.activitiesOfTypes('TIMERWRAP');\n-assert.strictEqual(as.length, 1);\n-const t1 = as[0];\n-assert.strictEqual(t1.type, 'TIMERWRAP');\n-assert.strictEqual(typeof t1.uid, 'number');\n-assert.strictEqual(typeof t1.triggerAsyncId, 'number');\n-checkInvocations(t1, { init: 1 }, 't1: when first timer installed');\n-\n-function ontimeout() {\n-  checkInvocations(t1, { init: 1, before: 1 }, 't1: when first timer fired');\n-\n-  setTimeout(onsecondTimeout, TIMEOUT);\n-  const as = hooks.activitiesOfTypes('TIMERWRAP');\n-  assert.strictEqual(as.length, 1);\n-  checkInvocations(t1, { init: 1, before: 1 },\n-                   't1: when second timer installed');\n-}\n-\n-function onsecondTimeout() {\n-  const as = hooks.activitiesOfTypes('TIMERWRAP');\n-  assert.strictEqual(as.length, 1);\n-  checkInvocations(t1, { init: 1, before: 2, after: 1 },\n-                   't1: when second timer fired');\n-\n-  // install third timeout with different TIMEOUT\n-  setTimeout(onthirdTimeout, TIMEOUT + 1);\n-  checkInvocations(t1, { init: 1, before: 2, after: 1 },\n-                   't1: when third timer installed');\n-}\n-\n-function onthirdTimeout() {\n-  checkInvocations(t1, { init: 1, before: 3, after: 2 },\n-                   't1: when third timer fired');\n-  tick(2);\n-}\n-\n-process.on('exit', onexit);\n-\n-function onexit() {\n-  hooks.disable();\n-  hooks.sanityCheck('TIMERWRAP');\n-\n-  checkInvocations(t1, { init: 1, before: 3, after: 3 },\n-                   't1: when process exits');\n-}"
        },
        {
            "sha": "b911a92c0de10b2bd707763a0dc204a144579ad4",
            "filename": "test/cctest/test_node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fcctest%2Ftest_node_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_node_postmortem_metadata.cc?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -42,7 +42,7 @@ class TestHandleWrap : public node::HandleWrap {\n       : node::HandleWrap(env,\n                          object,\n                          reinterpret_cast<uv_handle_t*>(handle),\n-                         node::AsyncWrap::PROVIDER_TIMERWRAP) {}\n+                         node::AsyncWrap::PROVIDER_TCPWRAP) {}\n };\n \n \n@@ -53,7 +53,7 @@ class TestReqWrap : public node::ReqWrap<uv_req_t> {\n   TestReqWrap(node::Environment* env, v8::Local<v8::Object> object)\n       : node::ReqWrap<uv_req_t>(env,\n                                 object,\n-                                node::AsyncWrap::PROVIDER_TIMERWRAP) {}\n+                                node::AsyncWrap::PROVIDER_FSREQWRAP) {}\n };\n \n TEST_F(DebugSymbolsTest, ContextEmbedderEnvironmentIndex) {"
        },
        {
            "sha": "904e5a8ef379faf2ce9b134aec85640fd6edafb8",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -29,7 +29,6 @@ const os = require('os');\n const { exec, execSync, spawn, spawnSync } = require('child_process');\n const stream = require('stream');\n const util = require('util');\n-const Timer = process.binding('timer_wrap').Timer;\n const { hasTracing } = process.binding('config');\n const { fixturesDir } = require('./fixtures');\n const tmpdir = require('./tmpdir');\n@@ -600,9 +599,9 @@ exports.nodeProcessAborted = function nodeProcessAborted(exitCode, signal) {\n };\n \n exports.busyLoop = function busyLoop(time) {\n-  const startTime = Timer.now();\n+  const startTime = Date.now();\n   const stopTime = startTime + time;\n-  while (Timer.now() < stopTime) {}\n+  while (Date.now() < stopTime) {}\n };\n \n exports.isAlive = function isAlive(pid) {"
        },
        {
            "sha": "210f2661e248f33668634604af430a1405903b8c",
            "filename": "test/message/timeout_throw.out",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fmessage%2Ftimeout_throw.out",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fmessage%2Ftimeout_throw.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Ftimeout_throw.out?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -6,4 +6,4 @@ ReferenceError: undefined_reference_error_maker is not defined\n     at ontimeout (timers.js:*:*)\n     at tryOnTimeout (timers.js:*:*)\n     at listOnTimeout (timers.js:*:*)\n-    at Timer.processTimers (timers.js:*:*)\n+    at processTimers (timers.js:*:*)"
        },
        {
            "sha": "d6d864cc350e192caeb5f42bba533bedd903ccec",
            "filename": "test/parallel/test-handle-wrap-isrefed.js",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-handle-wrap-isrefed.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-handle-wrap-isrefed.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-handle-wrap-isrefed.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -110,25 +110,4 @@ const dgram = require('dgram');\n }\n \n \n-// timers\n-{\n-  const { Timer } = process.binding('timer_wrap');\n-  strictEqual(process._getActiveHandles().filter(\n-    (handle) => (handle instanceof Timer)).length, 0);\n-  const timer = setTimeout(() => {}, 500);\n-  const handles = process._getActiveHandles().filter(\n-    (handle) => (handle instanceof Timer));\n-  strictEqual(handles.length, 1);\n-  const handle = handles[0];\n-  strictEqual(Object.getPrototypeOf(handle).hasOwnProperty('hasRef'),\n-              true, 'timer_wrap: hasRef() missing');\n-  strictEqual(handle.hasRef(), true);\n-  timer.unref();\n-  strictEqual(handle.hasRef(),\n-              false, 'timer_wrap: unref() ineffective');\n-  timer.ref();\n-  strictEqual(handle.hasRef(),\n-              true, 'timer_wrap: ref() ineffective');\n-}\n-\n // see also test/pseudo-tty/test-handle-wrap-isrefed-tty.js"
        },
        {
            "sha": "7cbb4325709ecb283db8b8a62ca8cbf07fecdaed",
            "filename": "test/parallel/test-inspector-tracing-domain.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-inspector-tracing-domain.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-inspector-tracing-domain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspector-tracing-domain.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -28,7 +28,7 @@ function post(message, data) {\n \n function generateTrace() {\n   return new Promise((resolve) => setTimeout(() => {\n-    for (let i = 0; i << 1000000; i++) {\n+    for (let i = 0; i < 1000000; i++) {\n       'test' + i;\n     }\n     resolve();\n@@ -52,7 +52,7 @@ async function test() {\n                         'node.perf.timerify', 'v8'],\n                        categories);\n \n-  const traceConfig = { includedCategories: ['node'] };\n+  const traceConfig = { includedCategories: ['v8'] };\n   await post('NodeTracing.start', { traceConfig });\n \n   for (let i = 0; i < 5; i++)"
        },
        {
            "sha": "1b8277f3b819bfe3448e8700fadcf040c09d6237",
            "filename": "test/parallel/test-timer-close.js",
            "status": "removed",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fparallel%2Ftest-timer-close.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fparallel%2Ftest-timer-close.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timer-close.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,11 +0,0 @@\n-'use strict';\n-const common = require('../common');\n-\n-// Make sure handle._handle.close(callback) is idempotent by closing a timer\n-// twice. The first function should be called, the second one should not.\n-\n-const Timer = process.binding('timer_wrap').Timer;\n-const t = new Timer();\n-\n-t.close(common.mustCall());\n-t.close(common.mustNotCall());"
        },
        {
            "sha": "bd8faaa6c732ccc47042a184770f1f4935dcbdb7",
            "filename": "test/parallel/test-timers-now.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-timers-now.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-timers-now.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-now.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -1,8 +1,9 @@\n 'use strict';\n+// Flags: --expose-internals\n \n require('../common');\n const assert = require('assert');\n+const { getLibuvNow } = require('internal/timers');\n \n-// Return value of Timer.now() should easily fit in a SMI right after start-up.\n-const Timer = process.binding('timer_wrap').Timer;\n-assert(Timer.now() < 0x3ffffff);\n+// Return value of getLibuvNow() should easily fit in a SMI after start-up.\n+assert(getLibuvNow() < 0x3ffffff);"
        },
        {
            "sha": "d9629e0319067902eb15d2a7069916290d684397",
            "filename": "test/parallel/test-timers-ordering.js",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-timers-ordering.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-timers-ordering.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-ordering.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -19,11 +19,13 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+// Flags: --expose-internals\n+\n 'use strict';\n require('../common');\n const assert = require('assert');\n+const { getLibuvNow } = require('internal/timers');\n \n-const Timer = process.binding('timer_wrap').Timer;\n const N = 30;\n \n let last_i = 0;\n@@ -36,8 +38,7 @@ function f(i) {\n     last_i = i;\n \n     // check that this iteration is fired at least 1ms later than the previous\n-    const now = Timer.now();\n-    console.log(i, now);\n+    const now = getLibuvNow();\n     assert(now >= last_ts + 1,\n            `current ts ${now} < prev ts ${last_ts} + 1`);\n     last_ts = now;\n@@ -46,4 +47,4 @@ function f(i) {\n     setTimeout(f, 1, i + 1);\n   }\n }\n-f(1);\n+setTimeout(f, 1, 1);"
        },
        {
            "sha": "0015318c4bad8d1592e1af21ea882342cdb708c5",
            "filename": "test/parallel/test-timers-unref-call.js",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fparallel%2Ftest-timers-unref-call.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fparallel%2Ftest-timers-unref-call.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-unref-call.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,13 +0,0 @@\n-'use strict';\n-\n-require('../common');\n-\n-const Timer = process.binding('timer_wrap').Timer;\n-Timer.now = function() { return ++Timer.now.ticks; };\n-Timer.now.ticks = 0;\n-\n-const t = setInterval(() => {}, 1);\n-const o = { _idleStart: 0, _idleTimeout: 1 };\n-t.unref.call(o);\n-\n-setTimeout(clearInterval.bind(null, t), 2);"
        },
        {
            "sha": "82dd4eac5a7624aca796a46b6d2c27fe90faecfe",
            "filename": "test/parallel/test-trace-events-all.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-all.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-all.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-all.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -40,8 +40,6 @@ proc.once('exit', common.mustCall(() => {\n         return false;\n       if (trace.cat !== 'node,node.async_hooks')\n         return false;\n-      if (trace.name !== 'TIMERWRAP')\n-        return false;\n       return true;\n     }));\n "
        },
        {
            "sha": "9b49cd1aeb70d367cc9498a57635b40331ad5812",
            "filename": "test/parallel/test-trace-events-async-hooks.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-async-hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-async-hooks.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -42,8 +42,6 @@ proc.once('exit', common.mustCall(() => {\n         return false;\n       if (trace.cat !== 'node,node.async_hooks')\n         return false;\n-      if (trace.name !== 'TIMERWRAP')\n-        return false;\n       return true;\n     }));\n "
        },
        {
            "sha": "baabaa78f3984b3956f54284a0cae77b12fd9ea3",
            "filename": "test/parallel/test-trace-events-v8.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-v8.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fparallel%2Ftest-trace-events-v8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-v8.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -42,8 +42,6 @@ proc.once('exit', common.mustCall(() => {\n         return false;\n       if (trace.cat !== 'node.async_hooks')\n         return false;\n-      if (trace.name !== 'TIMERWRAP')\n-        return false;\n       return true;\n     }));\n "
        },
        {
            "sha": "847781b3f270974a3f4c839ff16f63d5e9ec1ef8",
            "filename": "test/pummel/test-timer-wrap.js",
            "status": "removed",
            "additions": 0,
            "deletions": 35,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fpummel%2Ftest-timer-wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fpummel%2Ftest-timer-wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpummel%2Ftest-timer-wrap.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,35 +0,0 @@\n-// Copyright Joyent, Inc. and other Node contributors.\n-//\n-// Permission is hereby granted, free of charge, to any person obtaining a\n-// copy of this software and associated documentation files (the\n-// \"Software\"), to deal in the Software without restriction, including\n-// without limitation the rights to use, copy, modify, merge, publish,\n-// distribute, sublicense, and/or sell copies of the Software, and to permit\n-// persons to whom the Software is furnished to do so, subject to the\n-// following conditions:\n-//\n-// The above copyright notice and this permission notice shall be included\n-// in all copies or substantial portions of the Software.\n-//\n-// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n-// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n-// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n-// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n-// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n-// USE OR OTHER DEALINGS IN THE SOFTWARE.\n-\n-'use strict';\n-const common = require('../common');\n-\n-const Timer = process.binding('timer_wrap').Timer;\n-const kOnTimeout = Timer.kOnTimeout;\n-\n-const t = new Timer();\n-\n-t.start(1000);\n-\n-t[kOnTimeout] = common.mustCall(function() {\n-  console.log('timeout');\n-  t.close();\n-});"
        },
        {
            "sha": "965f0aeef8d93b11a6160edc4276106eab9b7fc6",
            "filename": "test/pummel/test-timer-wrap2.js",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fpummel%2Ftest-timer-wrap2.js",
            "raw_url": "https://github.com/nodejs/node/raw/6f63f8d730c8c3b19de7a591c35d376d428a4d56/test%2Fpummel%2Ftest-timer-wrap2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpummel%2Ftest-timer-wrap2.js?ref=6f63f8d730c8c3b19de7a591c35d376d428a4d56",
            "patch": "@@ -1,29 +0,0 @@\n-// Copyright Joyent, Inc. and other Node contributors.\n-//\n-// Permission is hereby granted, free of charge, to any person obtaining a\n-// copy of this software and associated documentation files (the\n-// \"Software\"), to deal in the Software without restriction, including\n-// without limitation the rights to use, copy, modify, merge, publish,\n-// distribute, sublicense, and/or sell copies of the Software, and to permit\n-// persons to whom the Software is furnished to do so, subject to the\n-// following conditions:\n-//\n-// The above copyright notice and this permission notice shall be included\n-// in all copies or substantial portions of the Software.\n-//\n-// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n-// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n-// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n-// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n-// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n-// USE OR OTHER DEALINGS IN THE SOFTWARE.\n-\n-'use strict';\n-require('../common');\n-\n-// Test that allocating a timer does not increase the loop's reference\n-// count.\n-\n-const Timer = process.binding('timer_wrap').Timer;\n-new Timer();"
        },
        {
            "sha": "cae156f790cef637e9818939a6bd69eb156c7ee2",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -256,12 +256,6 @@ if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n }\n \n \n-{\n-  const TimerWrap = process.binding('timer_wrap').Timer;\n-  testInitialized(new TimerWrap(), 'Timer');\n-}\n-\n-\n if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n   const { TCP, constants: TCPConstants } = process.binding('tcp_wrap');\n   const tcp = new TCP(TCPConstants.SOCKET);"
        },
        {
            "sha": "3d05a538ea5f6b2fa1b67e8a9d27a51a7e71c31f",
            "filename": "test/sequential/test-timers-blocking-callback.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-timers-blocking-callback.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-timers-blocking-callback.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-timers-blocking-callback.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -25,7 +25,6 @@\n \n const common = require('../common');\n const assert = require('assert');\n-const Timer = process.binding('timer_wrap').Timer;\n \n const TIMEOUT = 100;\n \n@@ -49,7 +48,7 @@ function blockingCallback(retry, callback) {\n   ++nbBlockingCallbackCalls;\n \n   if (nbBlockingCallbackCalls > 1) {\n-    latestDelay = Timer.now() - timeCallbackScheduled;\n+    latestDelay = Date.now() - timeCallbackScheduled;\n     // Even if timers can fire later than when they've been scheduled\n     // to fire, they shouldn't generally be more than 100% late in this case.\n     // But they are guaranteed to be at least 100ms late given the bug in\n@@ -68,7 +67,7 @@ function blockingCallback(retry, callback) {\n     // block by busy-looping to trigger the issue\n     common.busyLoop(TIMEOUT);\n \n-    timeCallbackScheduled = Timer.now();\n+    timeCallbackScheduled = Date.now();\n     setTimeout(blockingCallback.bind(null, retry, callback), TIMEOUT);\n   }\n }"
        },
        {
            "sha": "be9f491b92cc172b9e0a37c0ebf920da372fb82c",
            "filename": "test/sequential/test-timers-set-interval-excludes-callback-duration.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-timers-set-interval-excludes-callback-duration.js",
            "raw_url": "https://github.com/nodejs/node/raw/2930bd1317d15d12738a4896c0a6c05700411b47/test%2Fsequential%2Ftest-timers-set-interval-excludes-callback-duration.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-timers-set-interval-excludes-callback-duration.js?ref=2930bd1317d15d12738a4896c0a6c05700411b47",
            "patch": "@@ -1,6 +1,5 @@\n 'use strict';\n const common = require('../common');\n-const Timer = process.binding('timer_wrap').Timer;\n const assert = require('assert');\n \n let cntr = 0;\n@@ -11,9 +10,9 @@ const t = setInterval(() => {\n     common.busyLoop(100);\n     // ensure that the event loop passes before the second interval\n     setImmediate(() => assert.strictEqual(cntr, 1));\n-    first = Timer.now();\n+    first = Date.now();\n   } else if (cntr === 2) {\n-    assert(Timer.now() - first < 100);\n+    assert(Date.now() - first < 100);\n     clearInterval(t);\n   }\n }, 100);"
        }
    ],
    "stats": {
        "total": 538,
        "additions": 218,
        "deletions": 320
    }
}