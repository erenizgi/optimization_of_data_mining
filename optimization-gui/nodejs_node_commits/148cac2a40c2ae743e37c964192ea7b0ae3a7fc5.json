{
    "author": "Fishrock123",
    "message": "test: rewrite fs {f}utimes test file\n\nPreviously this test silently swallowed some errors.\n\nRefactored to use `common.mustCall()` & `assert()`s.\n\nAlso, this adds a couple of extra error-checking cases.\n\nPR-URL: https://github.com/nodejs/node/pull/25656\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "148cac2a40c2ae743e37c964192ea7b0ae3a7fc5",
    "files": [
        {
            "sha": "93932e27d7e777ebca8bbe311712b5b2b2051873",
            "filename": "test/parallel/test-fs-utimes.js",
            "status": "modified",
            "additions": 101,
            "deletions": 106,
            "changes": 207,
            "blob_url": "https://github.com/nodejs/node/blob/148cac2a40c2ae743e37c964192ea7b0ae3a7fc5/test%2Fparallel%2Ftest-fs-utimes.js",
            "raw_url": "https://github.com/nodejs/node/raw/148cac2a40c2ae743e37c964192ea7b0ae3a7fc5/test%2Fparallel%2Ftest-fs-utimes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-utimes.js?ref=148cac2a40c2ae743e37c964192ea7b0ae3a7fc5",
            "patch": "@@ -28,9 +28,6 @@ const fs = require('fs');\n const tmpdir = require('../common/tmpdir');\n tmpdir.refresh();\n \n-let tests_ok = 0;\n-let tests_run = 0;\n-\n function stat_resource(resource) {\n   if (typeof resource === 'string') {\n     return fs.statSync(resource);\n@@ -49,71 +46,46 @@ function check_mtime(resource, mtime) {\n   mtime = fs._toUnixTimestamp(mtime);\n   const stats = stat_resource(resource);\n   const real_mtime = fs._toUnixTimestamp(stats.mtime);\n-  // check up to single-second precision\n-  // sub-second precision is OS and fs dependant\n-  return mtime - real_mtime < 2;\n+  return mtime - real_mtime;\n }\n \n function expect_errno(syscall, resource, err, errno) {\n-  if (err && (err.code === errno || err.code === 'ENOSYS')) {\n-    tests_ok++;\n-  } else {\n-    console.log('FAILED:', 'expect_errno', util.inspect(arguments));\n-  }\n+  assert(\n+    err && (err.code === errno || err.code === 'ENOSYS'),\n+    `FAILED: expect_errno ${util.inspect(arguments)}`\n+  );\n }\n \n function expect_ok(syscall, resource, err, atime, mtime) {\n-  if (!err && check_mtime(resource, mtime) ||\n-      err && err.code === 'ENOSYS') {\n-    tests_ok++;\n-  } else {\n-    console.log('FAILED:', 'expect_ok', util.inspect(arguments));\n-  }\n+  const mtime_diff = check_mtime(resource, mtime);\n+  assert(\n+    // check up to single-second precision\n+    // sub-second precision is OS and fs dependant\n+    !err && (mtime_diff < 2) || err && err.code === 'ENOSYS',\n+    `FAILED: expect_ok ${util.inspect(arguments)}\n+     check_mtime: ${mtime_diff}`\n+  );\n }\n \n-function testIt(atime, mtime, callback) {\n-\n-  let fd;\n-  //\n-  // test synchronized code paths, these functions throw on failure\n-  //\n-  function syncTests() {\n-    fs.utimesSync(tmpdir.path, atime, mtime);\n-    expect_ok('utimesSync', tmpdir.path, undefined, atime, mtime);\n-    tests_run++;\n-\n-    // some systems don't have futimes\n-    // if there's an error, it should be ENOSYS\n-    try {\n-      tests_run++;\n-      fs.futimesSync(fd, atime, mtime);\n-      expect_ok('futimesSync', fd, undefined, atime, mtime);\n-    } catch (ex) {\n-      expect_errno('futimesSync', fd, ex, 'ENOSYS');\n-    }\n-\n-    let err;\n-    try {\n-      fs.utimesSync('foobarbaz', atime, mtime);\n-    } catch (ex) {\n-      err = ex;\n-    }\n-    expect_errno('utimesSync', 'foobarbaz', err, 'ENOENT');\n-    tests_run++;\n+const stats = fs.statSync(tmpdir.path);\n \n-    err = undefined;\n-    common.expectsError(\n-      () => fs.futimesSync(-1, atime, mtime),\n-      {\n-        code: 'ERR_OUT_OF_RANGE',\n-        type: RangeError,\n-        message: 'The value of \"fd\" is out of range. ' +\n-                'It must be >= 0 && < 4294967296. Received -1'\n-      }\n-    );\n-    tests_run++;\n-  }\n+const cases = [\n+  new Date('1982-09-10 13:37'),\n+  new Date(),\n+  123456.789,\n+  stats.mtime,\n+  ['123456', -1],\n+  new Date('2017-04-08T17:59:38.008Z')\n+];\n+runTests(cases.values());\n+\n+function runTests(iter) {\n+  const { value, done } = iter.next();\n+  if (done) return;\n+  // Support easy setting same or different atime / mtime values\n+  const [atime, mtime] = Array.isArray(value) ? value : [value, value];\n \n+  let fd;\n   //\n   // test async code paths\n   //\n@@ -133,54 +105,40 @@ function testIt(atime, mtime, callback) {\n       fs.futimes(fd, atime, mtime, common.mustCall((err) => {\n         expect_ok('futimes', fd, err, atime, mtime);\n \n-        common.expectsError(\n-          () => fs.futimes(-1, atime, mtime, common.mustNotCall()),\n-          {\n-            code: 'ERR_OUT_OF_RANGE',\n-            type: RangeError,\n-            message: 'The value of \"fd\" is out of range. ' +\n-                    'It must be >= 0 && < 4294967296. Received -1'\n-          }\n-        );\n-\n         syncTests();\n \n-        tests_run++;\n+        setImmediate(common.mustCall(runTests), iter);\n       }));\n-      tests_run++;\n     }));\n-    tests_run++;\n   }));\n-  tests_run++;\n-}\n \n-const stats = fs.statSync(tmpdir.path);\n+  //\n+  // test synchronized code paths, these functions throw on failure\n+  //\n+  function syncTests() {\n+    fs.utimesSync(tmpdir.path, atime, mtime);\n+    expect_ok('utimesSync', tmpdir.path, undefined, atime, mtime);\n \n-// Run tests\n-const runTest = common.mustCall(testIt, 1);\n-\n-runTest(new Date('1982-09-10 13:37'), new Date('1982-09-10 13:37'), () => {\n-  runTest(new Date(), new Date(), () => {\n-    runTest(123456.789, 123456.789, () => {\n-      runTest(stats.mtime, stats.mtime, () => {\n-        runTest('123456', -1, () => {\n-          runTest(\n-            new Date('2017-04-08T17:59:38.008Z'),\n-            new Date('2017-04-08T17:59:38.008Z'),\n-            common.mustCall(() => {\n-              // Done\n-            })\n-          );\n-        });\n-      });\n-    });\n-  });\n-});\n+    // some systems don't have futimes\n+    // if there's an error, it should be ENOSYS\n+    try {\n+      fs.futimesSync(fd, atime, mtime);\n+      expect_ok('futimesSync', fd, undefined, atime, mtime);\n+    } catch (ex) {\n+      expect_errno('futimesSync', fd, ex, 'ENOSYS');\n+    }\n \n-process.on('exit', () => {\n-  assert.strictEqual(tests_ok, tests_run - 2);\n-});\n+    let err;\n+    try {\n+      fs.utimesSync('foobarbaz', atime, mtime);\n+    } catch (ex) {\n+      err = ex;\n+    }\n+    expect_errno('utimesSync', 'foobarbaz', err, 'ENOENT');\n \n+    err = undefined;\n+  }\n+}\n \n // Ref: https://github.com/nodejs/node/issues/13255\n const path = `${tmpdir.path}/test-utimes-precision`;\n@@ -212,19 +170,56 @@ if (common.isWindows) {\n   assert.strictEqual(overflow_mtime, overflow_stats.mtime.getTime());\n }\n \n-[false, 0, {}, [], null, undefined].forEach((i) => {\n+const expectTypeError = {\n+  code: 'ERR_INVALID_ARG_TYPE',\n+  type: TypeError\n+};\n+// utimes-only error cases\n+{\n+  common.expectsError(\n+    () => fs.utimes(0, new Date(), new Date(), common.mustNotCall()),\n+    expectTypeError\n+  );\n+  common.expectsError(\n+    () => fs.utimesSync(0, new Date(), new Date()),\n+    expectTypeError\n+  );\n+}\n+\n+// shared error cases\n+[false, {}, [], null, undefined].forEach((i) => {\n   common.expectsError(\n     () => fs.utimes(i, new Date(), new Date(), common.mustNotCall()),\n-    {\n-      code: 'ERR_INVALID_ARG_TYPE',\n-      type: TypeError\n-    }\n+    expectTypeError\n   );\n   common.expectsError(\n     () => fs.utimesSync(i, new Date(), new Date()),\n-    {\n-      code: 'ERR_INVALID_ARG_TYPE',\n-      type: TypeError\n-    }\n+    expectTypeError\n+  );\n+  common.expectsError(\n+    () => fs.futimes(i, new Date(), new Date(), common.mustNotCall()),\n+    expectTypeError\n+  );\n+  common.expectsError(\n+    () => fs.futimesSync(i, new Date(), new Date()),\n+    expectTypeError\n   );\n });\n+\n+const expectRangeError = {\n+  code: 'ERR_OUT_OF_RANGE',\n+  type: RangeError,\n+  message: 'The value of \"fd\" is out of range. ' +\n+           'It must be >= 0 && < 4294967296. Received -1'\n+};\n+// futimes-only error cases\n+{\n+  common.expectsError(\n+    () => fs.futimes(-1, new Date(), new Date(), common.mustNotCall()),\n+    expectRangeError\n+  );\n+  common.expectsError(\n+    () => fs.futimesSync(-1, new Date(), new Date()),\n+    expectRangeError\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 101,
        "deletions": 106
    }
}