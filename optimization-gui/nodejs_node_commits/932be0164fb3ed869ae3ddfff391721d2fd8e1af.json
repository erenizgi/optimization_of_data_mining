{
    "author": "jasnell",
    "message": "util: make TextEncoder/TextDecoder global\n\nFixes: https://github.com/nodejs/node/issues/20365\n\nPR-URL: https://github.com/nodejs/node/pull/22281\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "932be0164fb3ed869ae3ddfff391721d2fd8e1af",
    "files": [
        {
            "sha": "99cef88669ba799d9636ddcde626ad89d455efdc",
            "filename": ".eslintrc.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/.eslintrc.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/.eslintrc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/.eslintrc.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -271,6 +271,8 @@ module.exports = {\n     DTRACE_HTTP_SERVER_REQUEST: false,\n     DTRACE_HTTP_SERVER_RESPONSE: false,\n     DTRACE_NET_SERVER_CONNECTION: false,\n-    DTRACE_NET_STREAM_END: false\n+    DTRACE_NET_STREAM_END: false,\n+    TextEncoder: false,\n+    TextDecoder: false\n   },\n };"
        },
        {
            "sha": "7e77d84ed086651c44784c78a407f686ab455b96",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -794,13 +794,13 @@ The stack trace is extended to include the point in time at which the\n <a id=\"ERR_ENCODING_INVALID_ENCODED_DATA\"></a>\n ### ERR_ENCODING_INVALID_ENCODED_DATA\n \n-Data provided to `util.TextDecoder()` API was invalid according to the encoding\n+Data provided to `TextDecoder()` API was invalid according to the encoding\n provided.\n \n <a id=\"ERR_ENCODING_NOT_SUPPORTED\"></a>\n ### ERR_ENCODING_NOT_SUPPORTED\n \n-Encoding provided to `util.TextDecoder()` API was not one of the\n+Encoding provided to `TextDecoder()` API was not one of the\n [WHATWG Supported Encodings][].\n \n <a id=\"ERR_FALSY_VALUE_REJECTION\"></a>"
        },
        {
            "sha": "af0bf3ee674c16c407af6af4a4a36b8e577d4269",
            "filename": "doc/api/globals.md",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Fglobals.md",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Fglobals.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fglobals.md?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -138,6 +138,25 @@ added: v0.0.1\n \n [`setTimeout`] is described in the [timers][] section.\n \n+## TextDecoder\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+<!-- type=global -->\n+\n+The WHATWG `TextDecoder` class. See the [`TextDecoder`][] section.\n+\n+## TextEncoder\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+<!-- type=global -->\n+\n+The WHATWG `TextEncoder` class. See the [`TextEncoder`][] section.\n+\n+\n ## URL\n <!-- YAML\n added: v10.0.0\n@@ -169,6 +188,8 @@ The WHATWG `URLSearchParams` class. See the [`URLSearchParams`][] section.\n [`setImmediate`]: timers.html#timers_setimmediate_callback_args\n [`setInterval`]: timers.html#timers_setinterval_callback_delay_args\n [`setTimeout`]: timers.html#timers_settimeout_callback_delay_args\n+[`TextDecoder`]: util.html#util_class_util_textdecoder\n+[`TextEncoder`]: util.html#util_class_util_textencoder\n [`URL`]: url.html#url_class_url\n [`URLSearchParams`]: url.html#url_class_urlsearchparams\n [buffer section]: buffer.html"
        },
        {
            "sha": "267bab85ae58fd1a16d76f5ef16f51aa533e7bf2",
            "filename": "doc/api/util.md",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Futil.md",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/doc%2Fapi%2Futil.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Futil.md?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -878,6 +878,13 @@ The `'iso-8859-16'` encoding listed in the [WHATWG Encoding Standard][]\n is not supported.\n \n ### new TextDecoder([encoding[, options]])\n+<!-- YAML\n+added: v8.3.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: REPLACEME\n+    description: The class is now available on the global object.\n+-->\n \n * `encoding` {string} Identifies the `encoding` that this `TextDecoder` instance\n   supports. **Default:** `'utf-8'`.\n@@ -893,6 +900,8 @@ is not supported.\n Creates an new `TextDecoder` instance. The `encoding` may specify one of the\n supported encodings or an alias.\n \n+The `TextDecoder` class is also available on the global object.\n+\n ### textDecoder.decode([input[, options]])\n \n * `input` {ArrayBuffer|DataView|TypedArray} An `ArrayBuffer`, `DataView` or\n@@ -932,6 +941,10 @@ mark.\n ## Class: util.TextEncoder\n <!-- YAML\n added: v8.3.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: REPLACEME\n+    description: The class is now available on the global object.\n -->\n \n An implementation of the [WHATWG Encoding Standard][] `TextEncoder` API. All\n@@ -942,6 +955,8 @@ const encoder = new TextEncoder();\n const uint8array = encoder.encode('this is some data');\n ```\n \n+The `TextEncoder` class is also available on the global object.\n+\n ### textEncoder.encode([input])\n \n * `input` {string} The text to encode. **Default:** an empty string."
        },
        {
            "sha": "fc8d8a2809b76d033d5742310b5ebf3a37f7ebf2",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -127,6 +127,7 @@\n       setupGlobalTimeouts();\n       setupGlobalConsole();\n       setupGlobalURL();\n+      setupGlobalEncoding();\n     }\n \n     if (process.binding('config').experimentalWorker) {\n@@ -476,6 +477,24 @@\n     });\n   }\n \n+  function setupGlobalEncoding() {\n+    const { TextEncoder, TextDecoder } = NativeModule.require('util');\n+    Object.defineProperties(global, {\n+      TextEncoder: {\n+        value: TextEncoder,\n+        writable: true,\n+        configurable: true,\n+        enumerable: false\n+      },\n+      TextDecoder: {\n+        value: TextDecoder,\n+        writable: true,\n+        configurable: true,\n+        enumerable: false\n+      }\n+    });\n+  }\n+\n   function setupDOMException() {\n     // Registers the constructor with C++.\n     NativeModule.require('internal/domexception');"
        },
        {
            "sha": "0e98bc806ca5bc43611ea49cb5d09b142d51b356",
            "filename": "test/parallel/test-global-encoder.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-global-encoder.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-global-encoder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-global-encoder.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -0,0 +1,8 @@\n+'use strict';\n+\n+require('../common');\n+const { strictEqual } = require('assert');\n+const util = require('util');\n+\n+strictEqual(TextDecoder, util.TextDecoder);\n+strictEqual(TextEncoder, util.TextEncoder);"
        },
        {
            "sha": "ddedb483624331bb2716614bfc1933667fe01245",
            "filename": "test/parallel/test-whatwg-encoding-fatal-streaming.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-fatal-streaming.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-fatal-streaming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-fatal-streaming.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -8,10 +8,6 @@ if (!common.hasIntl)\n   common.skip('missing Intl');\n \n const assert = require('assert');\n-const {\n-  TextDecoder\n-} = require('util');\n-\n \n {\n   ["
        },
        {
            "sha": "fd66a1e02e50a80d5ffde33a2d27b71fb81a1a7f",
            "filename": "test/parallel/test-whatwg-encoding-surrogates-utf8.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-surrogates-utf8.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-surrogates-utf8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-surrogates-utf8.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -5,10 +5,6 @@\n require('../common');\n \n const assert = require('assert');\n-const {\n-  TextDecoder,\n-  TextEncoder\n-} = require('util');\n \n const badStrings = [\n   {"
        },
        {
            "sha": "be37f5097c504ef6b25c8e5ba94b8c4200fbee7e",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-fatal.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-fatal.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-fatal.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-fatal.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -8,9 +8,6 @@ if (!common.hasIntl)\n   common.skip('missing Intl');\n \n const assert = require('assert');\n-const {\n-  TextDecoder\n-} = require('util');\n \n const bad = [\n   { encoding: 'utf-8', input: [0xFF], name: 'invalid code' },"
        },
        {
            "sha": "72fe498cd056d93d65c2df6c0b0e116229d0ce74",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-ignorebom.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-ignorebom.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -5,9 +5,6 @@\n const common = require('../common');\n \n const assert = require('assert');\n-const {\n-  TextDecoder\n-} = require('util');\n \n const cases = [\n   {"
        },
        {
            "sha": "69186accb5770d6988763f99e128322b2c17aacf",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-streaming.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-streaming.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -5,9 +5,6 @@\n const common = require('../common');\n \n const assert = require('assert');\n-const {\n-  TextDecoder\n-} = require('util');\n \n const string =\n   '\\x00123ABCabc\\x80\\xFF\\u0100\\u1000\\uFFFD\\uD800\\uDC00\\uDBFF\\uDFFF';"
        },
        {
            "sha": "163cccf9bb2b889af564b4b43d95fa4feed0e7d2",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder-utf16-surrogates.js",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-utf16-surrogates.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-utf16-surrogates.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder-utf16-surrogates.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -8,9 +8,6 @@ if (!common.hasIntl)\n   common.skip('missing Intl');\n \n const assert = require('assert');\n-const {\n-  TextDecoder\n-} = require('util');\n \n const bad = [\n   {"
        },
        {
            "sha": "37fbe12757134e3d76f8246b1519d63ce2838244",
            "filename": "test/parallel/test-whatwg-encoding-textdecoder.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textdecoder.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -4,7 +4,6 @@\n const common = require('../common');\n \n const assert = require('assert');\n-const { TextDecoder, TextEncoder } = require('util');\n const { customInspectSymbol: inspect } = require('internal/util');\n \n const buf = Buffer.from([0xef, 0xbb, 0xbf, 0x74, 0x65,"
        },
        {
            "sha": "808acf31eb134b0fb77d1da8ab406d08be8af8eb",
            "filename": "test/parallel/test-whatwg-encoding-textencoder-utf16-surrogates.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textencoder-utf16-surrogates.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -5,10 +5,6 @@\n require('../common');\n \n const assert = require('assert');\n-const {\n-  TextDecoder,\n-  TextEncoder\n-} = require('util');\n \n const bad = [\n   {"
        },
        {
            "sha": "9022477229c0de1a6806955dfb5309fff757789d",
            "filename": "test/parallel/test-whatwg-encoding-textencoder.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textencoder.js",
            "raw_url": "https://github.com/nodejs/node/raw/932be0164fb3ed869ae3ddfff391721d2fd8e1af/test%2Fparallel%2Ftest-whatwg-encoding-textencoder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-encoding-textencoder.js?ref=932be0164fb3ed869ae3ddfff391721d2fd8e1af",
            "patch": "@@ -4,7 +4,6 @@\n const common = require('../common');\n \n const assert = require('assert');\n-const { TextDecoder, TextEncoder } = require('util');\n const { customInspectSymbol: inspect } = require('internal/util');\n \n const encoded = Buffer.from([0xef, 0xbb, 0xbf, 0x74, 0x65,"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 68,
        "deletions": 29
    }
}