{
    "author": "Trott",
    "message": "test: fix flaky test-http2-settings-flood\n\nThe test is unreliable on some Windows platforms in its current form.\nMake it more robust by using `setInterval()` to repeat the flooding\nuntil an error is triggered.\n\nFixes: https://github.com/nodejs/node/issues/18251\n\nPR-URL: https://github.com/nodejs/node/pull/19349\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>",
    "sha": "879f521c654fffd34360be432a6280936ba94071",
    "files": [
        {
            "sha": "ab1fb5e12bf56cb0f312e93d81146042d889f916",
            "filename": "test/sequential/sequential.status",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/879f521c654fffd34360be432a6280936ba94071/test%2Fsequential%2Fsequential.status",
            "raw_url": "https://github.com/nodejs/node/raw/879f521c654fffd34360be432a6280936ba94071/test%2Fsequential%2Fsequential.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Fsequential.status?ref=879f521c654fffd34360be432a6280936ba94071",
            "patch": "@@ -12,7 +12,6 @@ test-inspector-bindings               : PASS, FLAKY\n test-inspector-debug-end              : PASS, FLAKY\n test-inspector-async-hook-setup-at-signal:  PASS, FLAKY\n test-http2-ping-flood                 : PASS, FLAKY\n-test-http2-settings-flood             : PASS, FLAKY\n \n [$system==linux]\n "
        },
        {
            "sha": "15b3696b9c298ed5684669fbfb6febc7a1608fda",
            "filename": "test/sequential/test-http2-settings-flood.js",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/879f521c654fffd34360be432a6280936ba94071/test%2Fsequential%2Ftest-http2-settings-flood.js",
            "raw_url": "https://github.com/nodejs/node/raw/879f521c654fffd34360be432a6280936ba94071/test%2Fsequential%2Ftest-http2-settings-flood.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-settings-flood.js?ref=879f521c654fffd34360be432a6280936ba94071",
            "patch": "@@ -4,8 +4,10 @@ const common = require('../common');\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n+const assert = require('assert');\n const http2 = require('http2');\n const net = require('net');\n+\n const http2util = require('../common/http2');\n \n // Test that settings flooding causes the session to be torn down\n@@ -14,13 +16,16 @@ const kSettings = new http2util.SettingsFrame();\n \n const server = http2.createServer();\n \n+let interval;\n+\n server.on('stream', common.mustNotCall());\n server.on('session', common.mustCall((session) => {\n-  session.on('error', common.expectsError({\n-    code: 'ERR_HTTP2_ERROR',\n-    message:\n-      'Flooding was detected in this HTTP/2 session, and it must be closed'\n-  }));\n+  session.on('error', (e) => {\n+    assert.strictEqual(e.code, 'ERR_HTTP2_ERROR');\n+    assert(e.message.includes('Flooding was detected'));\n+    clearInterval(interval);\n+  });\n+\n   session.on('close', common.mustCall(() => {\n     server.close();\n   }));\n@@ -30,18 +35,18 @@ server.listen(0, common.mustCall(() => {\n   const client = net.connect(server.address().port);\n \n   // nghttp2 uses a limit of 10000 items in it's outbound queue.\n-  // If this number is exceeded, a flooding error is raised. Set\n-  // this lim higher to account for the ones that nghttp2 is\n-  // successfully able to respond to.\n+  // If this number is exceeded, a flooding error is raised.\n   // TODO(jasnell): Unfortunately, this test is inherently flaky because\n   // it is entirely dependent on how quickly the server is able to handle\n   // the inbound frames and whether those just happen to overflow nghttp2's\n   // outbound queue. The threshold at which the flood error occurs can vary\n   // from one system to another, and from one test run to another.\n   client.on('connect', common.mustCall(() => {\n     client.write(http2util.kClientMagic, () => {\n-      for (let n = 0; n < 35000; n++)\n-        client.write(kSettings.data);\n+      interval = setInterval(() => {\n+        for (let n = 0; n < 10000; n++)\n+          client.write(kSettings.data);\n+      }, 1);\n     });\n   }));\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 15,
        "deletions": 11
    }
}