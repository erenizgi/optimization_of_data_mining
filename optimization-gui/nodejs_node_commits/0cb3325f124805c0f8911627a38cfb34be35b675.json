{
    "author": "addaleax",
    "message": "tls: fix SSL write error handling\n\nFix an use-after-free bug in the TLS implementation.\n\nIf we return from `DoWrite()` with an early error, we should\nnot be storing the `WriteWrap` object and complete it\nagain at a later point, when it has already been freed\n(because of the write error).\n\nThis issue was reported by Jordan Zebor at F5 Networks,\nwho also helped with investigating this bug and coming\nup with a reproduction.\n\nThis fixes CVE-2018-7162.\n\nFixes: https://github.com/nodejs-private/security/issues/189\nPR-URL: https://github.com/nodejs-private/node-private/pull/127\nReviewed-By: Evan Lucas <evanlucas@me.com>",
    "sha": "0cb3325f124805c0f8911627a38cfb34be35b675",
    "files": [
        {
            "sha": "bbb95bf86158eecc30673a0f61266d59e7b515ad",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0cb3325f124805c0f8911627a38cfb34be35b675/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0cb3325f124805c0f8911627a38cfb34be35b675/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=0cb3325f124805c0f8911627a38cfb34be35b675",
            "patch": "@@ -387,6 +387,7 @@ void ReportWritesToJSStreamListener::OnStreamAfterReqFinished(\n   AsyncWrap* async_wrap = req_wrap->GetAsyncWrap();\n   HandleScope handle_scope(env->isolate());\n   Context::Scope context_scope(env->context());\n+  CHECK(!async_wrap->persistent().IsEmpty());\n   Local<Object> req_wrap_obj = async_wrap->object();\n \n   Local<Value> argv[] = {"
        },
        {
            "sha": "4c4360358c7a41072db7a4f1e8a6ce0d7e886fd2",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0cb3325f124805c0f8911627a38cfb34be35b675/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0cb3325f124805c0f8911627a38cfb34be35b675/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=0cb3325f124805c0f8911627a38cfb34be35b675",
            "patch": "@@ -620,8 +620,10 @@ int TLSWrap::DoWrite(WriteWrap* w,\n   if (i != count) {\n     int err;\n     Local<Value> arg = GetSSLError(written, &err, &error_);\n-    if (!arg.IsEmpty())\n+    if (!arg.IsEmpty()) {\n+      current_write_ = nullptr;\n       return UV_EPROTO;\n+    }\n \n     pending_cleartext_input_.insert(pending_cleartext_input_.end(),\n                                     &bufs[i],"
        }
    ],
    "stats": {
        "total": 5,
        "additions": 4,
        "deletions": 1
    }
}