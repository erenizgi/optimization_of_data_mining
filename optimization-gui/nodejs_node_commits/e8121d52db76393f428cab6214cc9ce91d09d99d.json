{
    "author": "davedoesdev",
    "message": "http2: set nghttp2_option_set_no_closed_streams\n\nPR-URL: https://github.com/nodejs/node/pull/23134\nFixes: https://github.com/nodejs/node/issues/23116\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e8121d52db76393f428cab6214cc9ce91d09d99d",
    "files": [
        {
            "sha": "09662b08a4f0221ad6fd22c4cc7cdcc7883e411d",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e8121d52db76393f428cab6214cc9ce91d09d99d/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e8121d52db76393f428cab6214cc9ce91d09d99d/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=e8121d52db76393f428cab6214cc9ce91d09d99d",
            "patch": "@@ -98,6 +98,10 @@ Http2Scope::~Http2Scope() {\n Http2Options::Http2Options(Environment* env, nghttp2_session_type type) {\n   nghttp2_option_new(&options_);\n \n+  // Make sure closed connections aren't kept around, taking up memory.\n+  // Note that this breaks the priority tree, which we don't use.\n+  nghttp2_option_set_no_closed_streams(options_, 1);\n+\n   // We manually handle flow control within a session in order to\n   // implement backpressure -- that is, we only send WINDOW_UPDATE\n   // frames to the remote peer as data is actually consumed by user"
        },
        {
            "sha": "c0b3bcd819140c3dd7f962b3bbd999885590f2e0",
            "filename": "test/parallel/test-http2-forget-closed-streams.js",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/e8121d52db76393f428cab6214cc9ce91d09d99d/test%2Fparallel%2Ftest-http2-forget-closed-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8121d52db76393f428cab6214cc9ce91d09d99d/test%2Fparallel%2Ftest-http2-forget-closed-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-forget-closed-streams.js?ref=e8121d52db76393f428cab6214cc9ce91d09d99d",
            "patch": "@@ -0,0 +1,53 @@\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto) {\n+  common.skip('missing crypto');\n+}\n+\n+// Issue #23116\n+// nghttp2 keeps closed stream structures around in memory (couple of hundred\n+// bytes each) until a session is closed. It does this to maintain the priority\n+// tree. However, it limits the number of requests that can be made in a\n+// session before our memory tracking (correctly) kicks in.\n+// The fix is to tell nghttp2 to forget about closed streams. We don't make use\n+// of priority anyway.\n+// Without the fix, this test fails at ~40k requests with an exception:\n+// Error [ERR_HTTP2_STREAM_ERROR]: Stream closed with error code\n+// NGHTTP2_ENHANCE_YOUR_CALM\n+\n+const http2 = require('http2');\n+const assert = require('assert');\n+\n+const server = http2.createServer({ maxSessionMemory: 1 });\n+\n+server.on('session', function(session) {\n+  session.on('stream', function(stream) {\n+    stream.on('end', common.mustCall(function() {\n+      this.respond({\n+        ':status': 200\n+      }, {\n+        endStream: true\n+      });\n+    }));\n+    stream.resume();\n+  });\n+});\n+\n+server.listen(0, function() {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+\n+  function next(i) {\n+    if (i === 10000) {\n+      client.close();\n+      return server.close();\n+    }\n+    const stream = client.request({ ':method': 'POST' });\n+    stream.on('response', common.mustCall(function(headers) {\n+      assert.strictEqual(headers[':status'], 200);\n+      this.on('close', common.mustCall(() => next(i + 1)));\n+    }));\n+    stream.end();\n+  }\n+\n+  next(0);\n+});"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 57,
        "deletions": 0
    }
}