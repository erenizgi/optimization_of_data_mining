{
    "author": "guybedford",
    "message": "module: fix main lookup regression from #18728\n\nPR-URL: https://github.com/nodejs/node/pull/18788\nRefs: https://github.com/nodejs/node/pull/18728\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "7748865cd3322ff9421458ccc862291eb26cec62",
    "files": [
        {
            "sha": "71f0bbe074841a95b0734d5425be4d825ce53dbb",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/7748865cd3322ff9421458ccc862291eb26cec62/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7748865cd3322ff9421458ccc862291eb26cec62/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=7748865cd3322ff9421458ccc862291eb26cec62",
            "patch": "@@ -544,7 +544,7 @@ const PackageConfig& GetPackageConfig(Environment* env,\n   }\n \n   auto entry = env->package_json_cache.emplace(path,\n-      PackageConfig { Exists::Yes, IsValid::Yes, has_main, \"\" });\n+      PackageConfig { Exists::Yes, IsValid::Yes, has_main, main_std });\n   return entry.first->second;\n }\n \n@@ -585,13 +585,15 @@ Maybe<URL> ResolveMain(Environment* env, const URL& search) {\n       GetPackageConfig(env, pkg.ToFilePath());\n   // Note invalid package.json should throw in resolver\n   // currently we silently ignore which is incorrect\n-  if (!pjson.exists || !pjson.is_valid || !pjson.has_main) {\n+  if (pjson.exists == Exists::No ||\n+      pjson.is_valid == IsValid::No ||\n+      pjson.has_main == HasMain::No) {\n     return Nothing<URL>();\n   }\n   if (!ShouldBeTreatedAsRelativeOrAbsolutePath(pjson.main)) {\n-    return Resolve(env, \"./\" + pjson.main, search);\n+    return Resolve(env, \"./\" + pjson.main, search, IgnoreMain);\n   }\n-  return Resolve(env, pjson.main, search);\n+  return Resolve(env, pjson.main, search, IgnoreMain);\n }\n \n Maybe<URL> ResolveModule(Environment* env,\n@@ -602,7 +604,7 @@ Maybe<URL> ResolveModule(Environment* env,\n   do {\n     dir = parent;\n     Maybe<URL> check =\n-        Resolve(env, \"./node_modules/\" + specifier, dir, IgnoreMain);\n+        Resolve(env, \"./node_modules/\" + specifier, dir, CheckMain);\n     if (!check.IsNothing()) {\n       const size_t limit = specifier.find('/');\n       const size_t spec_len ="
        },
        {
            "sha": "7c81cb647cff389c075a4947522204d2cb83b8b5",
            "filename": "test/es-module/test-esm-main-lookup.mjs",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/7748865cd3322ff9421458ccc862291eb26cec62/test%2Fes-module%2Ftest-esm-main-lookup.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/7748865cd3322ff9421458ccc862291eb26cec62/test%2Fes-module%2Ftest-esm-main-lookup.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-main-lookup.mjs?ref=7748865cd3322ff9421458ccc862291eb26cec62",
            "patch": "@@ -0,0 +1,6 @@\n+// Flags: --experimental-modules\n+/* eslint-disable required-modules */\n+import assert from 'assert';\n+import main from '../fixtures/es-modules/pjson-main';\n+\n+assert.strictEqual(main, 'main');"
        },
        {
            "sha": "dfdd47b877319c291140aa46cccda428c3e90ba4",
            "filename": "test/fixtures/es-modules/pjson-main/main.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/7748865cd3322ff9421458ccc862291eb26cec62/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fmain.js",
            "raw_url": "https://github.com/nodejs/node/raw/7748865cd3322ff9421458ccc862291eb26cec62/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fmain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fmain.js?ref=7748865cd3322ff9421458ccc862291eb26cec62",
            "patch": "@@ -0,0 +1 @@\n+module.exports = 'main';"
        },
        {
            "sha": "c13b8cf6acfd3344bc2c7969a31d930d933fdf22",
            "filename": "test/fixtures/es-modules/pjson-main/package.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/7748865cd3322ff9421458ccc862291eb26cec62/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fpackage.json",
            "raw_url": "https://github.com/nodejs/node/raw/7748865cd3322ff9421458ccc862291eb26cec62/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Fpjson-main%2Fpackage.json?ref=7748865cd3322ff9421458ccc862291eb26cec62",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"main\": \"main.js\"\n+}"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 17,
        "deletions": 5
    }
}