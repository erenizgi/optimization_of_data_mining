{
    "author": "addaleax",
    "message": "src: use ObjectTemplate for creating stream req objs\n\nThis allows V8 to avoid preparing a execution context\nfor the constructor, to give a (kinda) small but noticeable\nperf gain.\n\nBenchmarks (only this commit):\n\n    $ ./node benchmark/compare.js --new ./node --old ./node-master --filter net-c2s.js --set len=10 --set type=asc --runs 360 net | Rscript benchmark/compare.R\n    [01:15:27|% 100| 1/1 files | 720/720 runs | 1/1 configs]: Done\n                                             confidence improvement accuracy (*)   (**)  (***)\n     net/net-c2s.js dur=5 type='asc' len=10        ***      0.69 %       ±0.31% ±0.41% ±0.53%\n\nPR-URL: https://github.com/nodejs/node/pull/18936\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "d93c48bf61d6b74bc080da8568df6f2eac44f275",
    "files": [
        {
            "sha": "868f3e9f212f67974b10f67bd4774ca92af69ea4",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=d93c48bf61d6b74bc080da8568df6f2eac44f275",
            "patch": "@@ -329,7 +329,7 @@ struct PackageConfig {\n   V(script_context_constructor_template, v8::FunctionTemplate)                \\\n   V(script_data_constructor_function, v8::Function)                           \\\n   V(secure_context_constructor_template, v8::FunctionTemplate)                \\\n-  V(shutdown_wrap_constructor_function, v8::Function)                         \\\n+  V(shutdown_wrap_template, v8::ObjectTemplate)                               \\\n   V(tcp_constructor_template, v8::FunctionTemplate)                           \\\n   V(tick_callback_function, v8::Function)                                     \\\n   V(timers_callback_function, v8::Function)                                   \\\n@@ -338,7 +338,7 @@ struct PackageConfig {\n   V(udp_constructor_function, v8::Function)                                   \\\n   V(vm_parsing_context_symbol, v8::Symbol)                                    \\\n   V(url_constructor_function, v8::Function)                                   \\\n-  V(write_wrap_constructor_function, v8::Function)                            \\\n+  V(write_wrap_template, v8::ObjectTemplate)                                  \\\n   V(fs_use_promises_symbol, v8::Symbol)\n \n class Environment;"
        },
        {
            "sha": "f4c228d7c5956fada862bf4763bce9b915e19cc2",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=d93c48bf61d6b74bc080da8568df6f2eac44f275",
            "patch": "@@ -164,8 +164,9 @@ inline int StreamBase::Shutdown(v8::Local<v8::Object> req_wrap_obj) {\n \n   if (req_wrap_obj.IsEmpty()) {\n     req_wrap_obj =\n-        env->shutdown_wrap_constructor_function()\n+        env->shutdown_wrap_template()\n             ->NewInstance(env->context()).ToLocalChecked();\n+    StreamReq::ResetObject(req_wrap_obj);\n   }\n \n   AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(GetAsyncWrap());\n@@ -203,8 +204,9 @@ inline StreamWriteResult StreamBase::Write(\n \n   if (req_wrap_obj.IsEmpty()) {\n     req_wrap_obj =\n-        env->write_wrap_constructor_function()\n+        env->write_wrap_template()\n             ->NewInstance(env->context()).ToLocalChecked();\n+    StreamReq::ResetObject(req_wrap_obj);\n   }\n \n   AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(GetAsyncWrap());\n@@ -427,6 +429,15 @@ inline void StreamReq::Done(int status, const char* error_str) {\n   OnDone(status);\n }\n \n+inline void StreamReq::ResetObject(v8::Local<v8::Object> obj) {\n+#ifdef DEBUG\n+  CHECK_GT(obj->InternalFieldCount(), StreamReq::kStreamReqField);\n+#endif\n+  ClearWrap(obj);\n+  obj->SetAlignedPointerInInternalField(StreamReq::kStreamReqField, nullptr);\n+}\n+\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "3267e544a04195f2aab97acbf8be68d3c4fcdb03",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=d93c48bf61d6b74bc080da8568df6f2eac44f275",
            "patch": "@@ -46,6 +46,13 @@ class StreamReq {\n \n   static StreamReq* FromObject(v8::Local<v8::Object> req_wrap_obj);\n \n+  // Sets all internal fields of `req_wrap_obj` to `nullptr`.\n+  // This is what the `WriteWrap` and `ShutdownWrap` JS constructors do,\n+  // and what we use in C++ after creating these objects from their\n+  // v8::ObjectTemplates, to avoid the overhead of calling the\n+  // constructor explicitly.\n+  static inline void ResetObject(v8::Local<v8::Object> req_wrap_obj);\n+\n  protected:\n   virtual void OnDone(int status) = 0;\n "
        },
        {
            "sha": "c696404849c9cc9bf2b5e7a7e7a6258d35cb2b03",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d93c48bf61d6b74bc080da8568df6f2eac44f275/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=d93c48bf61d6b74bc080da8568df6f2eac44f275",
            "patch": "@@ -60,9 +60,7 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n   auto is_construct_call_callback =\n       [](const FunctionCallbackInfo<Value>& args) {\n     CHECK(args.IsConstructCall());\n-    ClearWrap(args.This());\n-    args.This()->SetAlignedPointerInInternalField(\n-        StreamReq::kStreamReqField, nullptr);\n+    StreamReq::ResetObject(args.This());\n   };\n   Local<FunctionTemplate> sw =\n       FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n@@ -72,7 +70,7 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n   sw->SetClassName(wrapString);\n   AsyncWrap::AddWrapMethods(env, sw);\n   target->Set(wrapString, sw->GetFunction());\n-  env->set_shutdown_wrap_constructor_function(sw->GetFunction());\n+  env->set_shutdown_wrap_template(sw->InstanceTemplate());\n \n   Local<FunctionTemplate> ww =\n       FunctionTemplate::New(env->isolate(), is_construct_call_callback);\n@@ -82,7 +80,7 @@ void LibuvStreamWrap::Initialize(Local<Object> target,\n   ww->SetClassName(writeWrapString);\n   AsyncWrap::AddWrapMethods(env, ww);\n   target->Set(writeWrapString, ww->GetFunction());\n-  env->set_write_wrap_constructor_function(ww->GetFunction());\n+  env->set_write_wrap_template(ww->InstanceTemplate());\n }\n \n "
        }
    ],
    "stats": {
        "total": 34,
        "additions": 25,
        "deletions": 9
    }
}