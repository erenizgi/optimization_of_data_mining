{
    "author": "mafintosh",
    "message": "n-api: add napi_fatal_exception\n\nAdd function to trigger and uncaught exception.\nUseful if an async callback throws an exception with\nno way to recover.\n\nPR-URL: https://github.com/nodejs/node/pull/19337\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "c1695d8bad09fc61922ec91101736debb2d165db",
    "files": [
        {
            "sha": "a6257416035d51dd9e991da6ad95ab83a52ca0c0",
            "filename": "doc/api/n-api.md",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/doc%2Fapi%2Fn-api.md",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/doc%2Fapi%2Fn-api.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fn-api.md?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -541,6 +541,20 @@ This API returns true if an exception is pending.\n \n This API can be called even if there is a pending JavaScript exception.\n \n+#### napi_fatal_exception\n+<!-- YAML\n+added: REPLACEME\n+-->\n+```C\n+napi_status napi_fatal_exception(napi_env env, napi_value err);\n+```\n+\n+- `[in] env`: The environment that the API is invoked under.\n+- `[in] err`: The error you want to pass to `uncaughtException`.\n+\n+Trigger an `uncaughtException` in JavaScript. Useful if an async\n+callback throws an exception with no way to recover.\n+\n ### Fatal Errors\n \n In the event of an unrecoverable error in a native module, a fatal error can be"
        },
        {
            "sha": "16e0a3e18b4fc357751a0bc8840a7f6e2408538c",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -157,6 +157,7 @@ struct napi_env__ {\n     (out) = v8::type::New((buffer), (byte_offset), (length));                  \\\n   } while (0)\n \n+\n namespace {\n namespace v8impl {\n \n@@ -279,6 +280,13 @@ v8::Local<v8::Value> V8LocalValueFromJsValue(napi_value v) {\n   return local;\n }\n \n+static inline void trigger_fatal_exception(\n+    napi_env env, v8::Local<v8::Value> local_err) {\n+  v8::Local<v8::Message> local_msg =\n+    v8::Exception::CreateMessage(env->isolate, local_err);\n+  node::FatalException(env->isolate, local_err, local_msg);\n+}\n+\n static inline napi_status V8NameFromPropertyDescriptor(napi_env env,\n                                          const napi_property_descriptor* p,\n                                          v8::Local<v8::Name>* result) {\n@@ -944,6 +952,16 @@ napi_status napi_get_last_error_info(napi_env env,\n   return napi_ok;\n }\n \n+napi_status napi_fatal_exception(napi_env env, napi_value err) {\n+  NAPI_PREAMBLE(env);\n+  CHECK_ARG(env, err);\n+\n+  v8::Local<v8::Value> local_err = v8impl::V8LocalValueFromJsValue(err);\n+  v8impl::trigger_fatal_exception(env, local_err);\n+\n+  return napi_clear_last_error(env);\n+}\n+\n NAPI_NO_RETURN void napi_fatal_error(const char* location,\n                                      size_t location_len,\n                                      const char* message,\n@@ -3348,10 +3366,9 @@ class Work : public node::AsyncResource {\n       // report it as a fatal exception. (There is no JavaScript on the\n       // callstack that can possibly handle it.)\n       if (!env->last_exception.IsEmpty()) {\n-        v8::TryCatch try_catch(env->isolate);\n-        env->isolate->ThrowException(\n-          v8::Local<v8::Value>::New(env->isolate, env->last_exception));\n-        node::FatalException(env->isolate, try_catch);\n+        v8::Local<v8::Value> local_err = v8::Local<v8::Value>::New(\n+          env->isolate, env->last_exception);\n+        v8impl::trigger_fatal_exception(env, local_err);\n       }\n     }\n   }"
        },
        {
            "sha": "aaf002b7584449dfa5cb8d9fd9491843f6cb2440",
            "filename": "src/node_api.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_api.h",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_api.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.h?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -103,6 +103,8 @@ NAPI_EXTERN napi_status\n napi_get_last_error_info(napi_env env,\n                          const napi_extended_error_info** result);\n \n+NAPI_EXTERN napi_status napi_fatal_exception(napi_env env, napi_value err);\n+\n NAPI_EXTERN NAPI_NO_RETURN void napi_fatal_error(const char* location,\n                                                  size_t location_len,\n                                                  const char* message,"
        },
        {
            "sha": "6439ccc7a2da076726eb35b6822a9a3530680c0c",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -251,6 +251,11 @@ void GetSockOrPeerName(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   args.GetReturnValue().Set(err);\n }\n \n+void FatalException(v8::Isolate* isolate,\n+                    v8::Local<v8::Value> error,\n+                    v8::Local<v8::Message> message);\n+\n+\n void SignalExit(int signo);\n #ifdef __POSIX__\n void RegisterSignalHandler(int signal,"
        },
        {
            "sha": "fdcb3203f544107848ee5c14f05cb4788fc61e85",
            "filename": "test/addons-napi/test_async/test-uncaught.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_async%2Ftest-uncaught.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_async%2Ftest-uncaught.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_async%2Ftest-uncaught.js?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -0,0 +1,18 @@\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const test_async = require(`./build/${common.buildType}/test_async`);\n+\n+process.on('uncaughtException', common.mustCall(function(err) {\n+  try {\n+    throw new Error('should not fail');\n+  } catch (err) {\n+    assert.strictEqual(err.message, 'should not fail');\n+  }\n+  assert.strictEqual(err.message, 'uncaught');\n+}));\n+\n+// Successful async execution and completion callback.\n+test_async.Test(5, {}, common.mustCall(function() {\n+  throw new Error('uncaught');\n+}));"
        },
        {
            "sha": "f4dc0a71ea2817627c0c41c706b90d4f4f4bdfba",
            "filename": "test/addons-napi/test_fatal_exception/binding.gyp",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_fatal_exception%2Fbinding.gyp?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"targets\": [\n+    {\n+      \"target_name\": \"test_fatal_exception\",\n+      \"sources\": [ \"test_fatal_exception.c\" ]\n+    }\n+  ]\n+}"
        },
        {
            "sha": "f02b9bce1e81699aecf5e99be44a76f0b526e527",
            "filename": "test/addons-napi/test_fatal_exception/test.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest.js?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -0,0 +1,11 @@\n+'use strict';\n+const common = require('../../common');\n+const assert = require('assert');\n+const test_fatal = require(`./build/${common.buildType}/test_fatal_exception`);\n+\n+process.on('uncaughtException', common.mustCall(function(err) {\n+  assert.strictEqual(err.message, 'fatal error');\n+}));\n+\n+const err = new Error('fatal error');\n+test_fatal.Test(err);"
        },
        {
            "sha": "fd81c56d856db8808988373172bee3bb219c6ebc",
            "filename": "test/addons-napi/test_fatal_exception/test_fatal_exception.c",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest_fatal_exception.c",
            "raw_url": "https://github.com/nodejs/node/raw/c1695d8bad09fc61922ec91101736debb2d165db/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest_fatal_exception.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_fatal_exception%2Ftest_fatal_exception.c?ref=c1695d8bad09fc61922ec91101736debb2d165db",
            "patch": "@@ -0,0 +1,26 @@\n+#include <node_api.h>\n+#include \"../common.h\"\n+\n+napi_value Test(napi_env env, napi_callback_info info) {\n+  napi_value err;\n+  size_t argc = 1;\n+\n+  NAPI_CALL(env, napi_get_cb_info(env, info, &argc, &err, NULL, NULL));\n+\n+  NAPI_CALL(env, napi_fatal_exception(env, err));\n+\n+  return NULL;\n+}\n+\n+napi_value Init(napi_env env, napi_value exports) {\n+  napi_property_descriptor properties[] = {\n+    DECLARE_NAPI_PROPERTY(\"Test\", Test),\n+  };\n+\n+  NAPI_CALL(env, napi_define_properties(\n+      env, exports, sizeof(properties) / sizeof(*properties), properties));\n+\n+  return exports;\n+}\n+\n+NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 105,
        "deletions": 4
    }
}