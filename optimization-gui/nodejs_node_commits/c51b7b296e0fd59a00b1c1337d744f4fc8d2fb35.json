{
    "author": "shigeki",
    "message": "tls: fix getEphemeralKeyInfo to support X25519\n\n`EVP_PKEY_EC` only covers ANSI X9.62 curves not IETF ones(curve25519\nand curve448). This fixes to add support of X25519 in\n`tlsSocket.getEphemeralKeyInfo()`.\nX448 should be added in the future upgrade to OpenSSL-1.1.1.\n\nPR-URL: https://github.com/nodejs/node/pull/20273\nFixes: https://github.com/nodejs/node/issues/20262\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35",
    "files": [
        {
            "sha": "01b6b5c8ea7fb59009ebf8eb81eeb5ab710bdc65",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35",
            "patch": "@@ -2098,27 +2098,38 @@ void SSLWrap<Base>::GetEphemeralKeyInfo(\n   EVP_PKEY* key;\n \n   if (SSL_get_server_tmp_key(w->ssl_, &key)) {\n-    switch (EVP_PKEY_id(key)) {\n+    int kid = EVP_PKEY_id(key);\n+    switch (kid) {\n       case EVP_PKEY_DH:\n         info->Set(context, env->type_string(),\n                   FIXED_ONE_BYTE_STRING(env->isolate(), \"DH\")).FromJust();\n         info->Set(context, env->size_string(),\n                   Integer::New(env->isolate(), EVP_PKEY_bits(key))).FromJust();\n         break;\n       case EVP_PKEY_EC:\n+      // TODO(shigeki) Change this to EVP_PKEY_X25519 and add EVP_PKEY_X448\n+      // after upgrading to 1.1.1.\n+      case NID_X25519:\n         {\n-          EC_KEY* ec = EVP_PKEY_get1_EC_KEY(key);\n-          int nid = EC_GROUP_get_curve_name(EC_KEY_get0_group(ec));\n-          EC_KEY_free(ec);\n+          const char* curve_name;\n+          if (kid == EVP_PKEY_EC) {\n+            EC_KEY* ec = EVP_PKEY_get1_EC_KEY(key);\n+            int nid = EC_GROUP_get_curve_name(EC_KEY_get0_group(ec));\n+            curve_name = OBJ_nid2sn(nid);\n+            EC_KEY_free(ec);\n+          } else {\n+            curve_name = OBJ_nid2sn(kid);\n+          }\n           info->Set(context, env->type_string(),\n                     FIXED_ONE_BYTE_STRING(env->isolate(), \"ECDH\")).FromJust();\n           info->Set(context, env->name_string(),\n                     OneByteString(args.GetIsolate(),\n-                                  OBJ_nid2sn(nid))).FromJust();\n+                                  curve_name)).FromJust();\n           info->Set(context, env->size_string(),\n                     Integer::New(env->isolate(),\n                                  EVP_PKEY_bits(key))).FromJust();\n         }\n+        break;\n     }\n     EVP_PKEY_free(key);\n   }"
        },
        {
            "sha": "3963f7050f2982f6e0d2bcf68ccd6a4b2966d237",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35",
            "patch": "@@ -44,6 +44,8 @@\n #endif  // !OPENSSL_NO_ENGINE\n #include <openssl/err.h>\n #include <openssl/evp.h>\n+// TODO(shigeki) Remove this after upgrading to 1.1.1\n+#include <openssl/obj_mac.h>\n #include <openssl/pem.h>\n #include <openssl/x509.h>\n #include <openssl/x509v3.h>"
        },
        {
            "sha": "9432a277ac0fd045eb96c773578405b182abbceb",
            "filename": "test/parallel/test-tls-client-getephemeralkeyinfo.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js",
            "raw_url": "https://github.com/nodejs/node/raw/c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-client-getephemeralkeyinfo.js?ref=c51b7b296e0fd59a00b1c1337d744f4fc8d2fb35",
            "patch": "@@ -82,13 +82,18 @@ function testECDHE256() {\n }\n \n function testECDHE512() {\n-  test(521, 'ECDH', 'secp521r1', null);\n+  test(521, 'ECDH', 'secp521r1', testX25519);\n+  ntests++;\n+}\n+\n+function testX25519() {\n+  test(253, 'ECDH', 'X25519', null);\n   ntests++;\n }\n \n testNOT_PFS();\n \n process.on('exit', function() {\n   assert.strictEqual(ntests, nsuccess);\n-  assert.strictEqual(ntests, 5);\n+  assert.strictEqual(ntests, 6);\n });"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 25,
        "deletions": 7
    }
}