{
    "author": "addaleax",
    "message": "tls: do not free cert in `.getCertificate()`\n\nThe documentation of `SSL_get_certificate` states that it returns\nan internal pointer that must not be freed by the caller.\n\nTherefore, using a smart pointer to take ownership is incorrect.\n\nRefs: https://man.openbsd.org/SSL_get_certificate.3\nRefs: https://github.com/nodejs/node/pull/24261\nFixes: https://github.com/nodejs-private/security/issues/217\n\nPR-URL: https://github.com/nodejs/node/pull/25490\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "e888f667f5acae55b4604e101f0570e08da8236a",
    "files": [
        {
            "sha": "3ff95484871fceac0679494efa6fb86d02ffc515",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/e888f667f5acae55b4604e101f0570e08da8236a/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e888f667f5acae55b4604e101f0570e08da8236a/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=e888f667f5acae55b4604e101f0570e08da8236a",
            "patch": "@@ -1962,10 +1962,10 @@ void SSLWrap<Base>::GetCertificate(\n \n   Local<Object> result;\n \n-  X509Pointer cert(SSL_get_certificate(w->ssl_.get()));\n+  X509* cert = SSL_get_certificate(w->ssl_.get());\n \n-  if (cert)\n-    result = X509ToObject(env, cert.get());\n+  if (cert != nullptr)\n+    result = X509ToObject(env, cert);\n \n   args.GetReturnValue().Set(result);\n }"
        },
        {
            "sha": "5105a60dacd6de88788679540a9e390860699399",
            "filename": "test/parallel/test-tls-pfx-authorizationerror.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/e888f667f5acae55b4604e101f0570e08da8236a/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/e888f667f5acae55b4604e101f0570e08da8236a/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js?ref=e888f667f5acae55b4604e101f0570e08da8236a",
            "patch": "@@ -37,8 +37,13 @@ const server = tls\n         rejectUnauthorized: false\n       },\n       function() {\n-        assert.strictEqual(client.getCertificate().serialNumber,\n-                           'ECC9B856270DA9A8');\n+        for (let i = 0; i < 10; ++i) {\n+          // Calling this repeatedly is a regression test that verifies\n+          // that .getCertificate() does not accidentally decrease the\n+          // reference count of the X509* certificate on the native side.\n+          assert.strictEqual(client.getCertificate().serialNumber,\n+                             'ECC9B856270DA9A8');\n+        }\n         client.end();\n         server.close();\n       }"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 10,
        "deletions": 5
    }
}