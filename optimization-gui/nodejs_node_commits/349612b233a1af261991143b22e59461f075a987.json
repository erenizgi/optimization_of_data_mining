{
    "author": "camillobruni",
    "message": "deps: cherry-pick e1a7699 from upstream V8\n\nOriginal commit message:\n\n    [api][runtime]  Support all-in ctors of {Named,Indexed}PropertyHandlerConfiguration\n\n    - Explicitly allows construction of\n    {Named,Indexed}PropertyHandlerConfiguration with all the members filled.\n\n    Bug: v8:7612\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: I426ea33846b5dbf2b3482c722c963a6e4b0abded\n    Reviewed-on: https://chromium-review.googlesource.com/1163882\n    Reviewed-by: Toon Verwaest <verwaest@chromium.org>\n    Reviewed-by: Adam Klein <adamk@chromium.org>\n    Commit-Queue: Camillo Bruni <cbruni@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#55142}\n\nPR-URL: https://github.com/nodejs/node/pull/22390\nFixes: https://github.com/nodejs/node/issues/17480\nFixes: https://github.com/nodejs/node/issues/17481\nRefs: https://github.com/v8/v8/commit/e1a76995ef311eb3ca66e12ef1941ed596034d59\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "349612b233a1af261991143b22e59461f075a987",
    "files": [
        {
            "sha": "35d09b75011b7c8c36b5c93bb50c22e92b08f256",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/349612b233a1af261991143b22e59461f075a987/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/349612b233a1af261991143b22e59461f075a987/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=349612b233a1af261991143b22e59461f075a987",
            "patch": "@@ -29,7 +29,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.17',\n+    'v8_embedder_string': '-node.18',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "b5bb85ca8a4ba47cb04dfb1f2977de857cf328f6",
            "filename": "deps/v8/include/v8.h",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Finclude%2Fv8.h",
            "raw_url": "https://github.com/nodejs/node/raw/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Finclude%2Fv8.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8.h?ref=349612b233a1af261991143b22e59461f075a987",
            "patch": "@@ -5878,6 +5878,26 @@ enum class PropertyHandlerFlags {\n };\n \n struct NamedPropertyHandlerConfiguration {\n+  NamedPropertyHandlerConfiguration(\n+      GenericNamedPropertyGetterCallback getter,\n+      GenericNamedPropertySetterCallback setter,\n+      GenericNamedPropertyQueryCallback query,\n+      GenericNamedPropertyDeleterCallback deleter,\n+      GenericNamedPropertyEnumeratorCallback enumerator,\n+      GenericNamedPropertyDefinerCallback definer,\n+      GenericNamedPropertyDescriptorCallback descriptor,\n+      Local<Value> data = Local<Value>(),\n+      PropertyHandlerFlags flags = PropertyHandlerFlags::kNone)\n+      : getter(getter),\n+        setter(setter),\n+        query(query),\n+        deleter(deleter),\n+        enumerator(enumerator),\n+        definer(definer),\n+        descriptor(descriptor),\n+        data(data),\n+        flags(flags) {}\n+\n   NamedPropertyHandlerConfiguration(\n       /** Note: getter is required */\n       GenericNamedPropertyGetterCallback getter = 0,\n@@ -5929,6 +5949,25 @@ struct NamedPropertyHandlerConfiguration {\n \n \n struct IndexedPropertyHandlerConfiguration {\n+  IndexedPropertyHandlerConfiguration(\n+      IndexedPropertyGetterCallback getter,\n+      IndexedPropertySetterCallback setter, IndexedPropertyQueryCallback query,\n+      IndexedPropertyDeleterCallback deleter,\n+      IndexedPropertyEnumeratorCallback enumerator,\n+      IndexedPropertyDefinerCallback definer,\n+      IndexedPropertyDescriptorCallback descriptor,\n+      Local<Value> data = Local<Value>(),\n+      PropertyHandlerFlags flags = PropertyHandlerFlags::kNone)\n+      : getter(getter),\n+        setter(setter),\n+        query(query),\n+        deleter(deleter),\n+        enumerator(enumerator),\n+        definer(definer),\n+        descriptor(descriptor),\n+        data(data),\n+        flags(flags) {}\n+\n   IndexedPropertyHandlerConfiguration(\n       /** Note: getter is required */\n       IndexedPropertyGetterCallback getter = 0,"
        },
        {
            "sha": "fbd0dbc043be0fa3e614360a0a4ab28c6bdb0c45",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=349612b233a1af261991143b22e59461f075a987",
            "patch": "@@ -1811,10 +1811,6 @@ static i::Handle<i::InterceptorInfo> CreateInterceptorInfo(\n     i::Isolate* isolate, Getter getter, Setter setter, Query query,\n     Descriptor descriptor, Deleter remover, Enumerator enumerator,\n     Definer definer, Local<Value> data, PropertyHandlerFlags flags) {\n-  // Either intercept attributes or descriptor.\n-  DCHECK(query == nullptr || descriptor == nullptr);\n-  // Only use descriptor callback with definer callback.\n-  DCHECK(query == nullptr || definer == nullptr);\n   auto obj = i::Handle<i::InterceptorInfo>::cast(\n       isolate->factory()->NewStruct(i::INTERCEPTOR_INFO_TYPE, i::TENURED));\n   obj->set_flags(0);"
        },
        {
            "sha": "6913e68ed9a5f979da27be4f37c2f5409e46cdce",
            "filename": "deps/v8/src/objects.cc",
            "status": "modified",
            "additions": 32,
            "deletions": 31,
            "changes": 63,
            "blob_url": "https://github.com/nodejs/node/blob/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Fsrc%2Fobjects.cc",
            "raw_url": "https://github.com/nodejs/node/raw/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Fsrc%2Fobjects.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fobjects.cc?ref=349612b233a1af261991143b22e59461f075a987",
            "patch": "@@ -7672,41 +7672,42 @@ Maybe<bool> GetPropertyDescriptorWithInterceptor(LookupIterator* it,\n     }\n   }\n \n-  if (it->state() == LookupIterator::INTERCEPTOR) {\n-    Isolate* isolate = it->isolate();\n-    Handle<InterceptorInfo> interceptor = it->GetInterceptor();\n-    if (!interceptor->descriptor()->IsUndefined(isolate)) {\n-      Handle<Object> result;\n-      Handle<JSObject> holder = it->GetHolder<JSObject>();\n+  if (it->state() != LookupIterator::INTERCEPTOR) return Just(false);\n \n-      Handle<Object> receiver = it->GetReceiver();\n-      if (!receiver->IsJSReceiver()) {\n-        ASSIGN_RETURN_ON_EXCEPTION_VALUE(\n-            isolate, receiver, Object::ConvertReceiver(isolate, receiver),\n-            Nothing<bool>());\n-      }\n+  Isolate* isolate = it->isolate();\n+  Handle<InterceptorInfo> interceptor = it->GetInterceptor();\n+  if (interceptor->descriptor()->IsUndefined(isolate)) return Just(false);\n \n-      PropertyCallbackArguments args(isolate, interceptor->data(), *receiver,\n-                                     *holder, kDontThrow);\n-      if (it->IsElement()) {\n-        result = args.CallIndexedDescriptor(interceptor, it->index());\n-      } else {\n-        result = args.CallNamedDescriptor(interceptor, it->name());\n-      }\n-      if (!result.is_null()) {\n-        // Request successfully intercepted, try to set the property\n-        // descriptor.\n-        Utils::ApiCheck(\n-            PropertyDescriptor::ToPropertyDescriptor(isolate, result, desc),\n-            it->IsElement() ? \"v8::IndexedPropertyDescriptorCallback\"\n-                            : \"v8::NamedPropertyDescriptorCallback\",\n-            \"Invalid property descriptor.\");\n+  Handle<Object> result;\n+  Handle<JSObject> holder = it->GetHolder<JSObject>();\n \n-        return Just(true);\n-      }\n-      it->Next();\n-    }\n+  Handle<Object> receiver = it->GetReceiver();\n+  if (!receiver->IsJSReceiver()) {\n+    ASSIGN_RETURN_ON_EXCEPTION_VALUE(isolate, receiver,\n+                                     Object::ConvertReceiver(isolate, receiver),\n+                                     Nothing<bool>());\n+  }\n+\n+  PropertyCallbackArguments args(isolate, interceptor->data(), *receiver,\n+                                 *holder, kDontThrow);\n+  if (it->IsElement()) {\n+    result = args.CallIndexedDescriptor(interceptor, it->index());\n+  } else {\n+    result = args.CallNamedDescriptor(interceptor, it->name());\n   }\n+  if (!result.is_null()) {\n+    // Request successfully intercepted, try to set the property\n+    // descriptor.\n+    Utils::ApiCheck(\n+        PropertyDescriptor::ToPropertyDescriptor(isolate, result, desc),\n+        it->IsElement() ? \"v8::IndexedPropertyDescriptorCallback\"\n+                        : \"v8::NamedPropertyDescriptorCallback\",\n+        \"Invalid property descriptor.\");\n+\n+    return Just(true);\n+  }\n+\n+  it->Next();\n   return Just(false);\n }\n }  // namespace"
        },
        {
            "sha": "b13384f18adfefe69dc5be232a5f620a7efd8ba7",
            "filename": "deps/v8/test/unittests/api/interceptor-unittest.cc",
            "status": "modified",
            "additions": 176,
            "deletions": 0,
            "changes": 176,
            "blob_url": "https://github.com/nodejs/node/blob/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Ftest%2Funittests%2Fapi%2Finterceptor-unittest.cc",
            "raw_url": "https://github.com/nodejs/node/raw/349612b233a1af261991143b22e59461f075a987/deps%2Fv8%2Ftest%2Funittests%2Fapi%2Finterceptor-unittest.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Funittests%2Fapi%2Finterceptor-unittest.cc?ref=349612b233a1af261991143b22e59461f075a987",
            "patch": "@@ -29,4 +29,180 @@ TEST_F(InterceptorTest, FreezeApiObjectWithInterceptor) {\n }\n \n }  // namespace\n+\n+namespace internal {\n+namespace {\n+\n+class InterceptorLoggingTest : public TestWithNativeContext {\n+ public:\n+  InterceptorLoggingTest() {}\n+\n+  static const int kTestIndex = 0;\n+\n+  static void NamedPropertyGetter(Local<v8::Name> name,\n+                                  const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"named getter\");\n+  }\n+\n+  static void NamedPropertySetter(Local<v8::Name> name, Local<v8::Value> value,\n+                                  const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"named setter\");\n+  }\n+\n+  static void NamedPropertyQuery(\n+      Local<v8::Name> name, const v8::PropertyCallbackInfo<v8::Integer>& info) {\n+    LogCallback(info, \"named query\");\n+  }\n+\n+  static void NamedPropertyDeleter(\n+      Local<v8::Name> name, const v8::PropertyCallbackInfo<v8::Boolean>& info) {\n+    LogCallback(info, \"named deleter\");\n+  }\n+\n+  static void NamedPropertyEnumerator(\n+      const v8::PropertyCallbackInfo<Array>& info) {\n+    LogCallback(info, \"named enumerator\");\n+  }\n+\n+  static void NamedPropertyDefiner(\n+      Local<v8::Name> name, const v8::PropertyDescriptor& desc,\n+      const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"named definer\");\n+  }\n+\n+  static void NamedPropertyDescriptor(\n+      Local<v8::Name> name, const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"named descriptor\");\n+  }\n+\n+  static void IndexedPropertyGetter(\n+      uint32_t index, const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"indexed getter\");\n+  }\n+\n+  static void IndexedPropertySetter(\n+      uint32_t index, Local<v8::Value> value,\n+      const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"indexed setter\");\n+  }\n+\n+  static void IndexedPropertyQuery(\n+      uint32_t index, const v8::PropertyCallbackInfo<v8::Integer>& info) {\n+    LogCallback(info, \"indexed query\");\n+  }\n+\n+  static void IndexedPropertyDeleter(\n+      uint32_t index, const v8::PropertyCallbackInfo<v8::Boolean>& info) {\n+    LogCallback(info, \"indexed deleter\");\n+  }\n+\n+  static void IndexedPropertyEnumerator(\n+      const v8::PropertyCallbackInfo<Array>& info) {\n+    LogCallback(info, \"indexed enumerator\");\n+  }\n+\n+  static void IndexedPropertyDefiner(\n+      uint32_t index, const v8::PropertyDescriptor& desc,\n+      const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"indexed definer\");\n+  }\n+\n+  static void IndexedPropertyDescriptor(\n+      uint32_t index, const v8::PropertyCallbackInfo<Value>& info) {\n+    LogCallback(info, \"indexed descriptor\");\n+  }\n+\n+  template <class T>\n+  static void LogCallback(const v8::PropertyCallbackInfo<T>& info,\n+                          const char* callback_name) {\n+    InterceptorLoggingTest* test = reinterpret_cast<InterceptorLoggingTest*>(\n+        info.This()->GetAlignedPointerFromInternalField(kTestIndex));\n+    test->Log(callback_name);\n+  }\n+\n+  void Log(const char* callback_name) {\n+    if (log_is_empty_) {\n+      log_is_empty_ = false;\n+    } else {\n+      log_ << \", \";\n+    }\n+    log_ << callback_name;\n+  }\n+\n+ protected:\n+  void SetUp() override {\n+    // Set up the object that supports full interceptors.\n+    v8::Local<v8::ObjectTemplate> templ = v8::ObjectTemplate::New(v8_isolate());\n+    templ->SetInternalFieldCount(1);\n+    templ->SetHandler(v8::NamedPropertyHandlerConfiguration(\n+        NamedPropertyGetter, NamedPropertySetter, NamedPropertyQuery,\n+        NamedPropertyDeleter, NamedPropertyEnumerator, NamedPropertyDefiner,\n+        NamedPropertyDescriptor));\n+    templ->SetHandler(v8::IndexedPropertyHandlerConfiguration(\n+        IndexedPropertyGetter, IndexedPropertySetter, IndexedPropertyQuery,\n+        IndexedPropertyDeleter, IndexedPropertyEnumerator,\n+        IndexedPropertyDefiner, IndexedPropertyDescriptor));\n+    v8::Local<v8::Object> instance =\n+        templ->NewInstance(context()).ToLocalChecked();\n+    instance->SetAlignedPointerInInternalField(kTestIndex, this);\n+    SetGlobalProperty(\"obj\", instance);\n+  }\n+\n+  std::string Run(const char* script) {\n+    log_is_empty_ = true;\n+    log_.str(std::string());\n+    log_.clear();\n+\n+    RunJS(script);\n+    return log_.str();\n+  }\n+\n+ private:\n+  bool log_is_empty_ = false;\n+  std::stringstream log_;\n+};\n+\n+TEST_F(InterceptorLoggingTest, DispatchTest) {\n+  EXPECT_EQ(Run(\"for (var p in obj) {}\"),\n+            \"indexed enumerator, named enumerator\");\n+  EXPECT_EQ(Run(\"Object.keys(obj)\"), \"indexed enumerator, named enumerator\");\n+\n+  EXPECT_EQ(Run(\"obj.foo\"), \"named getter\");\n+  EXPECT_EQ(Run(\"obj[42]\"), \"indexed getter\");\n+\n+  EXPECT_EQ(Run(\"obj.foo = null\"), \"named setter\");\n+  EXPECT_EQ(Run(\"obj[42] = null\"), \"indexed setter\");\n+\n+  EXPECT_EQ(Run(\"Object.getOwnPropertyDescriptor(obj, 'foo')\"),\n+            \"named descriptor\");\n+\n+  EXPECT_EQ(Run(\"Object.getOwnPropertyDescriptor(obj, 42)\"),\n+            \"indexed descriptor\");\n+\n+  EXPECT_EQ(Run(\"Object.defineProperty(obj, 'foo', {value: 42})\"),\n+            \"named descriptor, named definer, named setter\");\n+  EXPECT_EQ(Run(\"Object.defineProperty(obj, 'foo', {get(){} })\"),\n+            \"named descriptor, named definer\");\n+  EXPECT_EQ(Run(\"Object.defineProperty(obj, 'foo', {set(value){}})\"),\n+            \"named descriptor, named definer\");\n+  EXPECT_EQ(Run(\"Object.defineProperty(obj, 'foo', {get(){}, set(value){}})\"),\n+            \"named descriptor, named definer\");\n+\n+  EXPECT_EQ(Run(\"Object.defineProperty(obj, 42, {value: 'foo'})\"),\n+            \"indexed descriptor, \"\n+            // then attempt definer first and fallback to setter.\n+            \"indexed definer, indexed setter\");\n+\n+  EXPECT_EQ(Run(\"Object.prototype.propertyIsEnumerable.call(obj, 'a')\"),\n+            \"named query\");\n+  EXPECT_EQ(Run(\"Object.prototype.propertyIsEnumerable.call(obj, 42)\"),\n+            \"indexed query\");\n+\n+  EXPECT_EQ(Run(\"Object.prototype.hasOwnProperty.call(obj, 'a')\"),\n+            \"named query\");\n+  // TODO(cbruni): Fix once hasOnwProperty is fixed (https://crbug.com/872628)\n+  EXPECT_EQ(Run(\"Object.prototype.hasOwnProperty.call(obj, '42')\"), \"\");\n+}\n+}  // namespace\n+}  // namespace internal\n }  // namespace v8"
        }
    ],
    "stats": {
        "total": 284,
        "additions": 248,
        "deletions": 36
    }
}