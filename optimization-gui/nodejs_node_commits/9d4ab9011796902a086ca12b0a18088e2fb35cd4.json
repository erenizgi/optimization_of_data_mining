{
    "author": "addaleax",
    "message": "buffer: do deprecation warning outside `node_modules`\n\nIn addition to `--pending-deprecation`, emit a deprecation warning\nfor usage of the `Buffer()` constructor for call sites that are outside\nof `node_modules`.\n\nThe goal of this is to better target developers, rather than\nburdening users with an omnipresent and quickly ignored warning.\n\nThis implements the result of a TSC meeting discussion\nfrom March 22, 2018.\n\nPR-URL: https://github.com/nodejs/node/pull/19524\nRefs: https://github.com/nodejs/node/issues/19079#issuecomment-375121443\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Gibson Fahnestock <gibfahn@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Evan Lucas <evanlucas@me.com>\nReviewed-By: Myles Borins <myles.borins@gmail.com>",
    "sha": "9d4ab9011796902a086ca12b0a18088e2fb35cd4",
    "files": [
        {
            "sha": "fbd7ace6b63a3a240c9d3baecb9c1ed3f0819d64",
            "filename": "doc/api/buffer.md",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/doc%2Fapi%2Fbuffer.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/doc%2Fapi%2Fbuffer.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fbuffer.md?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -304,6 +304,10 @@ It can be constructed in a variety of ways.\n <!-- YAML\n deprecated: v6.0.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19524\n+    description: Calling this constructor emits a deprecation warning when\n+                 run from code outside the `node_modules` directory.\n   - version: v7.2.1\n     pr-url: https://github.com/nodejs/node/pull/9529\n     description: Calling this constructor no longer emits a deprecation warning.\n@@ -328,6 +332,10 @@ const buf = new Buffer([0x62, 0x75, 0x66, 0x66, 0x65, 0x72]);\n added: v3.0.0\n deprecated: v6.0.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19524\n+    description: Calling this constructor emits a deprecation warning when\n+                 run from code outside the `node_modules` directory.\n   - version: v7.2.1\n     pr-url: https://github.com/nodejs/node/pull/9529\n     description: Calling this constructor no longer emits a deprecation warning.\n@@ -380,6 +388,10 @@ console.log(buf);\n <!-- YAML\n deprecated: v6.0.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19524\n+    description: Calling this constructor emits a deprecation warning when\n+                 run from code outside the `node_modules` directory.\n   - version: v7.2.1\n     pr-url: https://github.com/nodejs/node/pull/9529\n     description: Calling this constructor no longer emits a deprecation warning.\n@@ -410,6 +422,10 @@ console.log(buf2.toString());\n <!-- YAML\n deprecated: v6.0.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19524\n+    description: Calling this constructor emits a deprecation warning when\n+                 run from code outside the `node_modules` directory.\n   - version: v8.0.0\n     pr-url: https://github.com/nodejs/node/pull/12141\n     description: new Buffer(size) will return zero-filled memory by default.\n@@ -447,6 +463,10 @@ console.log(buf);\n <!-- YAML\n deprecated: v6.0.0\n changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/19524\n+    description: Calling this constructor emits a deprecation warning when\n+                 run from code outside the `node_modules` directory.\n   - version: v7.2.1\n     pr-url: https://github.com/nodejs/node/pull/9529\n     description: Calling this constructor no longer emits a deprecation warning."
        },
        {
            "sha": "b78244b5d5b01582618be73436e9ca8396206929",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -72,7 +72,7 @@ be used.\n <a id=\"DEP0005\"></a>\n ### DEP0005: Buffer() constructor\n \n-Type: Documentation-only (supports [`--pending-deprecation`][])\n+Type: Runtime (supports [`--pending-deprecation`][])\n \n The `Buffer()` function and `new Buffer()` constructor are deprecated due to\n API usability issues that can potentially lead to accidental security issues.\n@@ -93,6 +93,10 @@ is strongly recommended:\n * [`Buffer.from(string[, encoding])`][from_string_encoding] - Create a `Buffer`\n   that copies `string`.\n \n+As of REPLACEME, a deprecation warning is printed at runtime when\n+`--pending-deprecation` is used or when the calling code is\n+outside `node_modules` in order to better target developers, rather than users.\n+\n <a id=\"DEP0006\"></a>\n ### DEP0006: child\\_process options.customFds\n "
        },
        {
            "sha": "0737b8eccc5584939029273e3e5668a0228079f8",
            "filename": "lib/buffer.js",
            "status": "modified",
            "additions": 18,
            "deletions": 13,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/lib%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/lib%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fbuffer.js?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -48,6 +48,7 @@ try {\n }\n const {\n   customInspectSymbol,\n+  isInsideNodeModules,\n   normalizeEncoding,\n   kIsEncodingSymbol\n } = require('internal/util');\n@@ -139,25 +140,29 @@ function alignPool() {\n   }\n }\n \n-var bufferWarn = true;\n+let bufferWarningAlreadyEmitted = false;\n+let nodeModulesCheckCounter = 0;\n const bufferWarning = 'Buffer() is deprecated due to security and usability ' +\n                       'issues. Please use the Buffer.alloc(), ' +\n                       'Buffer.allocUnsafe(), or Buffer.from() methods instead.';\n \n function showFlaggedDeprecation() {\n-  if (bufferWarn) {\n-    // This is a *pending* deprecation warning. It is not emitted by\n-    // default unless the --pending-deprecation command-line flag is\n-    // used or the NODE_PENDING_DEPRECATION=1 env var is set.\n-    process.emitWarning(bufferWarning, 'DeprecationWarning', 'DEP0005');\n-    bufferWarn = false;\n+  if (bufferWarningAlreadyEmitted ||\n+      ++nodeModulesCheckCounter > 10000 ||\n+      (!pendingDeprecation &&\n+       isInsideNodeModules())) {\n+    // We don't emit a warning, because we either:\n+    // - Already did so, or\n+    // - Already checked too many times whether a call is coming\n+    //   from node_modules and want to stop slowing down things, or\n+    // - We aren't running with `--pending-deprecation` enabled,\n+    //   and the code is inside `node_modules`.\n+    return;\n   }\n-}\n \n-const doFlaggedDeprecation =\n-  pendingDeprecation ?\n-    showFlaggedDeprecation :\n-    function() {};\n+  process.emitWarning(bufferWarning, 'DeprecationWarning', 'DEP0005');\n+  bufferWarningAlreadyEmitted = true;\n+}\n \n /**\n  * The Buffer() constructor is deprecated in documentation and should not be\n@@ -170,7 +175,7 @@ const doFlaggedDeprecation =\n  * Deprecation Code: DEP0005\n  */\n function Buffer(arg, encodingOrOffset, length) {\n-  doFlaggedDeprecation();\n+  showFlaggedDeprecation();\n   // Common case.\n   if (typeof arg === 'number') {\n     if (typeof encodingOrOffset === 'string') {"
        },
        {
            "sha": "b92e4c5b5884792b0b0216abe9e15f54dd2da8b2",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -366,6 +366,61 @@ function spliceOne(list, index) {\n   list.pop();\n }\n \n+const kNodeModulesRE = /^(.*)[\\\\/]node_modules[\\\\/]/;\n+\n+let getStructuredStack;\n+let mainPrefix;\n+\n+function isInsideNodeModules() {\n+  // Match the prefix of the main file, if it is inside a `node_modules` folder,\n+  // up to and including the innermost `/node_modules/` bit, so that\n+  // we can later ignore files which are at the same node_modules level.\n+  // For example, having the main script at `/c/node_modules/d/d.js`\n+  // would match all code coming from `/c/node_modules/`.\n+  if (mainPrefix === undefined) {\n+    const match = process.mainModule &&\n+                  process.mainModule.filename &&\n+                  process.mainModule.filename.match(kNodeModulesRE);\n+    mainPrefix = match ? match[0] : '';\n+  }\n+\n+  if (getStructuredStack === undefined) {\n+    // Lazy-load to avoid a circular dependency.\n+    const { runInNewContext } = require('vm');\n+    // Use `runInNewContext()` to get something tamper-proof and\n+    // side-effect-free. Since this is currently only used for a deprecated API,\n+    // the perf implications should be okay.\n+    getStructuredStack = runInNewContext('(' + function() {\n+      Error.prepareStackTrace = function(err, trace) {\n+        err.stack = trace;\n+      };\n+      Error.stackTraceLimit = Infinity;\n+\n+      return function structuredStack() {\n+        // eslint-disable-next-line no-restricted-syntax\n+        return new Error().stack;\n+      };\n+    } + ')()', {}, { filename: 'structured-stack' });\n+  }\n+\n+  const stack = getStructuredStack();\n+\n+  // Iterate over all stack frames and look for the first one not coming\n+  // from inside Node.js itself:\n+  for (const frame of stack) {\n+    const filename = frame.getFileName();\n+    // If a filename does not start with / or contain \\,\n+    // it's likely from Node.js core.\n+    if (!/^\\/|\\\\/.test(filename))\n+      continue;\n+    const match = filename.match(kNodeModulesRE);\n+    return !!match && match[0] !== mainPrefix;\n+  }\n+\n+  return false;  // This should be unreachable.\n+}\n+\n+\n module.exports = {\n   assertCrypto,\n   cachedResult,\n@@ -379,6 +434,7 @@ module.exports = {\n   getSystemErrorName,\n   getIdentificationOf,\n   isError,\n+  isInsideNodeModules,\n   join,\n   normalizeEncoding,\n   objectToString,"
        },
        {
            "sha": "717f7835114f0d836d091289f2fed5b201aff282",
            "filename": "test/parallel/test-buffer-constructor-node-modules-paths.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/test%2Fparallel%2Ftest-buffer-constructor-node-modules-paths.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/test%2Fparallel%2Ftest-buffer-constructor-node-modules-paths.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-constructor-node-modules-paths.js?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+const child_process = require('child_process');\n+const assert = require('assert');\n+const common = require('../common');\n+\n+if (process.env.NODE_PENDING_DEPRECATION)\n+  common.skip('test does not work when NODE_PENDING_DEPRECATION is set');\n+\n+function test(main, callSite, expected) {\n+  const { stderr } = child_process.spawnSync(process.execPath, ['-p', `\n+  process.mainModule = { filename: ${JSON.stringify(main)} };\n+\n+  vm.runInNewContext('new Buffer(10)', { Buffer }, {\n+    filename: ${JSON.stringify(callSite)}\n+  });`], { encoding: 'utf8' });\n+  if (expected)\n+    assert(stderr.includes('[DEP0005] DeprecationWarning'), stderr);\n+  else\n+    assert.strictEqual(stderr.trim(), '');\n+}\n+\n+test('/a/node_modules/b.js', '/a/node_modules/x.js', true);\n+test('/a/node_modules/b.js', '/a/node_modules/foo/node_modules/x.js', false);\n+test('/a/node_modules/foo/node_modules/b.js', '/a/node_modules/x.js', false);\n+test('/node_modules/foo/b.js', '/node_modules/foo/node_modules/x.js', false);\n+test('/a.js', '/b.js', true);\n+test('/a.js', '/node_modules/b.js', false);\n+test('c:\\\\a\\\\node_modules\\\\b.js', 'c:\\\\a\\\\node_modules\\\\x.js', true);\n+test('c:\\\\a\\\\node_modules\\\\b.js',\n+     'c:\\\\a\\\\node_modules\\\\foo\\\\node_modules\\\\x.js', false);\n+test('c:\\\\node_modules\\\\foo\\\\b.js',\n+     'c:\\\\node_modules\\\\foo\\\\node_modules\\\\x.js', false);\n+test('c:\\\\a.js', 'c:\\\\b.js', true);\n+test('c:\\\\a.js', 'c:\\\\node_modules\\\\b.js', false);"
        },
        {
            "sha": "1a1e146f2dd9d773094d27a6dcaaf6089ca10170",
            "filename": "test/parallel/test-buffer-constructor-outside-node-modules.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/9d4ab9011796902a086ca12b0a18088e2fb35cd4/test%2Fparallel%2Ftest-buffer-constructor-outside-node-modules.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d4ab9011796902a086ca12b0a18088e2fb35cd4/test%2Fparallel%2Ftest-buffer-constructor-outside-node-modules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-constructor-outside-node-modules.js?ref=9d4ab9011796902a086ca12b0a18088e2fb35cd4",
            "patch": "@@ -0,0 +1,29 @@\n+// Flags: --no-warnings\n+'use strict';\n+\n+const vm = require('vm');\n+const assert = require('assert');\n+const common = require('../common');\n+\n+if (new Error().stack.includes('node_modules'))\n+  common.skip('test does not work when inside `node_modules` directory');\n+if (process.env.NODE_PENDING_DEPRECATION)\n+  common.skip('test does not work when NODE_PENDING_DEPRECATION is set');\n+\n+const bufferWarning = 'Buffer() is deprecated due to security and usability ' +\n+                      'issues. Please use the Buffer.alloc(), ' +\n+                      'Buffer.allocUnsafe(), or Buffer.from() methods instead.';\n+\n+process.addListener('warning', common.mustCall((warning) => {\n+  assert(warning.stack.includes('this_should_emit_a_warning'), warning.stack);\n+}));\n+\n+vm.runInNewContext('new Buffer(10)', { Buffer }, {\n+  filename: '/a/node_modules/b'\n+});\n+\n+common.expectWarning('DeprecationWarning', bufferWarning, 'DEP0005');\n+\n+vm.runInNewContext('new Buffer(10)', { Buffer }, {\n+  filename: '/this_should_emit_a_warning'\n+});"
        }
    ],
    "stats": {
        "total": 177,
        "additions": 163,
        "deletions": 14
    }
}