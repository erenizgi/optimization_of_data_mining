{
    "author": "ofrobots",
    "message": "test: fix test-fs-watch-system-limit\n\nOn some systems the default inotify limits might be too high for the\ntest to actually fail. Detect and skip the test in such environments.\n\nPR-URL: https://github.com/nodejs/node/pull/23986\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "a03165a5fd5ab0325eec506e346f6ec5db46780d",
    "files": [
        {
            "sha": "8b9cb62ad0a0078b68318b350810cc3db1be4ca5",
            "filename": "test/sequential/test-fs-watch-system-limit.js",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/a03165a5fd5ab0325eec506e346f6ec5db46780d/test%2Fsequential%2Ftest-fs-watch-system-limit.js",
            "raw_url": "https://github.com/nodejs/node/raw/a03165a5fd5ab0325eec506e346f6ec5db46780d/test%2Fsequential%2Ftest-fs-watch-system-limit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-fs-watch-system-limit.js?ref=a03165a5fd5ab0325eec506e346f6ec5db46780d",
            "patch": "@@ -2,13 +2,28 @@\n const common = require('../common');\n const assert = require('assert');\n const child_process = require('child_process');\n+const fs = require('fs');\n const stream = require('stream');\n \n if (!common.isLinux)\n   common.skip('The fs watch limit is OS-dependent');\n if (!common.enoughTestCpu)\n   common.skip('This test is resource-intensive');\n \n+try {\n+  // Ensure inotify limit is low enough for the test to actually exercise the\n+  // limit with small enough resources.\n+  const limit = Number(\n+    fs.readFileSync('/proc/sys/fs/inotify/max_user_watches', 'utf8'));\n+  if (limit > 16384)\n+    common.skip('inotify limit is quite large');\n+} catch (e) {\n+  if (e.code === 'ENOENT')\n+    common.skip('the inotify /proc subsystem does not exist');\n+  // Fail on other errors.\n+  throw e;\n+}\n+\n const processes = [];\n const gatherStderr = new stream.PassThrough();\n gatherStderr.setEncoding('utf8');"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 15,
        "deletions": 0
    }
}