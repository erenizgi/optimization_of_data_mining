{
    "author": "jasnell",
    "message": "perf_hooks,trace_events: emit perf milestone trace events\n\nEmit the perf_hooks node timing milestones as trace events.\n\nPR-URL: https://github.com/nodejs/node/pull/19175\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "96cb4fb795808aa2774e842974aeb411c5d3dd94",
    "files": [
        {
            "sha": "b53197b8109c830bb18e514af8ee208f0532cd15",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -16,6 +16,7 @@ The available categories are:\n \n * `node`\n * `node.async_hooks` - Enables capture of detailed async_hooks trace data.\n+* `node.bootstrap` - Enables capture of Node.js bootstrap milestones.\n * `node.perf` - Enables capture of [Performance API] measurements.\n   * `node.perf.usertiming` - Enables capture of only Performance API User Timing\n     measures and marks."
        },
        {
            "sha": "c876103972fe92db4342d8cdcfa58344e02093a1",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -115,15 +115,14 @@ Environment::Environment(IsolateData* isolate_data,\n \n   destroy_async_id_list_.reserve(512);\n   performance_state_.reset(new performance::performance_state(isolate()));\n-  performance_state_->milestones[\n-      performance::NODE_PERFORMANCE_MILESTONE_ENVIRONMENT] =\n-          PERFORMANCE_NOW();\n-  performance_state_->milestones[\n-    performance::NODE_PERFORMANCE_MILESTONE_NODE_START] =\n-        performance::performance_node_start;\n-  performance_state_->milestones[\n-    performance::NODE_PERFORMANCE_MILESTONE_V8_START] =\n-        performance::performance_v8_start;\n+  performance_state_->Mark(\n+      performance::NODE_PERFORMANCE_MILESTONE_ENVIRONMENT);\n+  performance_state_->Mark(\n+      performance::NODE_PERFORMANCE_MILESTONE_NODE_START,\n+      performance::performance_node_start);\n+  performance_state_->Mark(\n+      performance::NODE_PERFORMANCE_MILESTONE_V8_START,\n+      performance::performance_v8_start);\n \n   // By default, always abort when --abort-on-uncaught-exception was passed.\n   should_abort_on_uncaught_toggle_[0] = 1;"
        },
        {
            "sha": "e7dd66693470325bbd7d5af25fd03c523dc6e14a",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -4474,7 +4474,8 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   {\n     SealHandleScope seal(isolate);\n     bool more;\n-    PERFORMANCE_MARK(&env, LOOP_START);\n+    env.performance_state()->Mark(\n+        node::performance::NODE_PERFORMANCE_MILESTONE_LOOP_START);\n     do {\n       uv_run(env.event_loop(), UV_RUN_DEFAULT);\n \n@@ -4490,7 +4491,8 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n       // event, or after running some callbacks.\n       more = uv_loop_alive(env.event_loop());\n     } while (more == true);\n-    PERFORMANCE_MARK(&env, LOOP_EXIT);\n+    env.performance_state()->Mark(\n+        node::performance::NODE_PERFORMANCE_MILESTONE_LOOP_EXIT);\n   }\n \n   env.set_trace_sync_io(false);"
        },
        {
            "sha": "8b476890e190a99682230ad17d3a857877213611",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -40,6 +40,15 @@ uint64_t performance_v8_start;\n uint64_t performance_last_gc_start_mark_ = 0;\n v8::GCType performance_last_gc_type_ = v8::GCType::kGCTypeAll;\n \n+void performance_state::Mark(enum PerformanceMilestone milestone,\n+                             uint64_t ts) {\n+  this->milestones[milestone] = ts;\n+  TRACE_EVENT_INSTANT_WITH_TIMESTAMP0(\n+      TRACING_CATEGORY_NODE1(bootstrap),\n+      GetPerformanceMilestoneName(milestone),\n+      TRACE_EVENT_SCOPE_THREAD, ts);\n+}\n+\n double GetCurrentTimeInMicroseconds() {\n #ifdef _WIN32\n // The difference between the Unix Epoch and the Windows Epoch in 100-ns ticks.\n@@ -200,14 +209,11 @@ void Measure(const FunctionCallbackInfo<Value>& args) {\n void MarkMilestone(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Local<Context> context = env->context();\n-  AliasedBuffer<double, v8::Float64Array>& milestones =\n-      env->performance_state()->milestones;\n   PerformanceMilestone milestone =\n       static_cast<PerformanceMilestone>(\n           args[0]->Int32Value(context).ToChecked());\n-  if (milestone != NODE_PERFORMANCE_MILESTONE_INVALID) {\n-    milestones[milestone] = PERFORMANCE_NOW();\n-  }\n+  if (milestone != NODE_PERFORMANCE_MILESTONE_INVALID)\n+    env->performance_state()->Mark(milestone);\n }\n \n "
        },
        {
            "sha": "703ef81ce48def2677fb66fa68d1984bf0fc9a1f",
            "filename": "src/node_perf.h",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf.h",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.h?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -27,6 +27,18 @@ extern const uint64_t timeOrigin;\n \n double GetCurrentTimeInMicroseconds();\n \n+static inline const char* GetPerformanceMilestoneName(\n+    enum PerformanceMilestone milestone) {\n+  switch (milestone) {\n+#define V(name, label) case NODE_PERFORMANCE_MILESTONE_##name: return label;\n+  NODE_PERFORMANCE_MILESTONES(V)\n+#undef V\n+    default:\n+      UNREACHABLE();\n+      return 0;\n+  }\n+}\n+\n static inline PerformanceMilestone ToPerformanceMilestoneEnum(const char* str) {\n #define V(name, label)                                                        \\\n   if (strcmp(str, label) == 0) return NODE_PERFORMANCE_MILESTONE_##name;\n@@ -44,12 +56,6 @@ static inline PerformanceEntryType ToPerformanceEntryTypeEnum(\n   return NODE_PERFORMANCE_ENTRY_TYPE_INVALID;\n }\n \n-NODE_EXTERN inline void MarkPerformanceMilestone(\n-    Environment* env,\n-    PerformanceMilestone milestone) {\n-  env->performance_state()->milestones[milestone] = PERFORMANCE_NOW();\n-}\n-\n class PerformanceEntry {\n  public:\n   static void Notify(Environment* env,"
        },
        {
            "sha": "9754e1e66f3a51f7f7b12ad737011cad0021aa0c",
            "filename": "src/node_perf_common.h",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf_common.h",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/src%2Fnode_perf_common.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf_common.h?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -56,12 +56,6 @@ enum PerformanceEntryType {\n   NODE_PERFORMANCE_ENTRY_TYPE_INVALID\n };\n \n-#define PERFORMANCE_MARK(env, n)                                              \\\n-  do {                                                                        \\\n-    node::performance::MarkPerformanceMilestone(env,                          \\\n-                         node::performance::NODE_PERFORMANCE_MILESTONE_##n);  \\\n-  } while (0);\n-\n class performance_state {\n  public:\n   explicit performance_state(v8::Isolate* isolate) :\n@@ -86,6 +80,9 @@ class performance_state {\n   AliasedBuffer<double, v8::Float64Array> milestones;\n   AliasedBuffer<uint32_t, v8::Uint32Array> observers;\n \n+  void Mark(enum PerformanceMilestone milestone,\n+            uint64_t ts = PERFORMANCE_NOW());\n+\n  private:\n   struct performance_state_internal {\n     // doubles first so that they are always sizeof(double)-aligned"
        },
        {
            "sha": "6693291664ef6701756125e279840e90c921cda7",
            "filename": "test/parallel/test-trace-events-bootstrap.js",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/96cb4fb795808aa2774e842974aeb411c5d3dd94/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/96cb4fb795808aa2774e842974aeb411c5d3dd94/test%2Fparallel%2Ftest-trace-events-bootstrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-bootstrap.js?ref=96cb4fb795808aa2774e842974aeb411c5d3dd94",
            "patch": "@@ -0,0 +1,53 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+\n+const names = [\n+  'environment',\n+  'nodeStart',\n+  'v8Start',\n+  'loopStart',\n+  'loopExit',\n+  'bootstrapComplete',\n+  'thirdPartyMainStart',\n+  'thirdPartyMainEnd',\n+  'clusterSetupStart',\n+  'clusterSetupEnd',\n+  'moduleLoadStart',\n+  'moduleLoadEnd',\n+  'preloadModulesLoadStart',\n+  'preloadModulesLoadEnd'\n+];\n+\n+if (process.argv[2] === 'child') {\n+  1 + 1;\n+} else {\n+  tmpdir.refresh();\n+  process.chdir(tmpdir.path);\n+\n+  const proc = cp.fork(__filename,\n+                       [ 'child' ], {\n+                         execArgv: [\n+                           '--trace-events-enabled',\n+                           '--trace-event-categories',\n+                           'node.bootstrap'\n+                         ]\n+                       });\n+\n+  proc.once('exit', common.mustCall(() => {\n+    const file = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+    assert(common.fileExists(file));\n+    fs.readFile(file, common.mustCall((err, data) => {\n+      const traces = JSON.parse(data.toString()).traceEvents;\n+      traces.forEach((trace) => {\n+        assert.strictEqual(trace.pid, proc.pid);\n+        assert(names.includes(trace.name));\n+      });\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 92,
        "deletions": 28
    }
}