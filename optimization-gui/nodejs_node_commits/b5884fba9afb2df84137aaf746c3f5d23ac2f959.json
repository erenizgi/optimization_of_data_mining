{
    "author": "vsemozhetbyt",
    "message": "test: amplify and optimize doctool/test-make-doc\n\nPR-URL: https://github.com/nodejs/node/pull/19581\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "b5884fba9afb2df84137aaf746c3f5d23ac2f959",
    "files": [
        {
            "sha": "b2bc7a05f6899b6fe7e09a73f9bba276e5e19ef3",
            "filename": "test/doctool/test-make-doc.js",
            "status": "modified",
            "additions": 27,
            "deletions": 19,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/b5884fba9afb2df84137aaf746c3f5d23ac2f959/test%2Fdoctool%2Ftest-make-doc.js",
            "raw_url": "https://github.com/nodejs/node/raw/b5884fba9afb2df84137aaf746c3f5d23ac2f959/test%2Fdoctool%2Ftest-make-doc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fdoctool%2Ftest-make-doc.js?ref=b5884fba9afb2df84137aaf746c3f5d23ac2f959",
            "patch": "@@ -12,32 +12,40 @@ const fs = require('fs');\n const path = require('path');\n \n const apiPath = path.resolve(__dirname, '..', '..', 'out', 'doc', 'api');\n-const docs = fs.readdirSync(apiPath);\n-assert.ok(docs.includes('_toc.html'));\n+const allDocs = fs.readdirSync(apiPath);\n+assert.ok(allDocs.includes('_toc.html'));\n+\n+const filter = ['assets', '_toc.html', '.md'];\n+const actualDocs = allDocs.filter(\n+  (name) => !filter.some((str) => name.includes(str))\n+);\n \n const toc = fs.readFileSync(path.resolve(apiPath, '_toc.html'), 'utf8');\n const re = /href=\"([^/]+\\.html)\"/;\n const globalRe = new RegExp(re, 'g');\n const links = toc.match(globalRe);\n assert.notStrictEqual(links, null);\n \n-// Test that all the relative links in the TOC of the documentation\n-// work and all the generated documents are linked in TOC.\n-const linkedHtmls = links.map((link) => link.match(re)[1]);\n-for (const html of linkedHtmls) {\n-  assert.ok(docs.includes(html), `${html} does not exist`);\n+// Filter out duplicate links, leave just filenames, add expected JSON files.\n+const linkedHtmls = [...new Set(links)].map((link) => link.match(re)[1]);\n+const expectedJsons = linkedHtmls\n+                       .map((name) => name.replace('.html', '.json'))\n+                       .concat('_toc.json');\n+const expectedDocs = linkedHtmls.concat(expectedJsons);\n+\n+// Test that all the relative links in the TOC match to the actual documents.\n+for (const expectedDoc of expectedDocs) {\n+  assert.ok(actualDocs.includes(expectedDoc), `${expectedDoc} does not exist`);\n }\n \n-const excludes = ['.json', '.md', '_toc', 'assets'];\n-const generatedHtmls = docs.filter(function(doc) {\n-  for (const exclude of excludes) {\n-    if (doc.includes(exclude)) {\n-      return false;\n-    }\n-  }\n-  return true;\n-});\n-\n-for (const html of generatedHtmls) {\n-  assert.ok(linkedHtmls.includes(html), `${html} is not linked in toc`);\n+// Test that all the actual documents match to the relative links in the TOC\n+// and that they are not empty files.\n+for (const actualDoc of actualDocs) {\n+  assert.ok(\n+    expectedDocs.includes(actualDoc), `${actualDoc} does not not match TOC`);\n+\n+  assert.ok(\n+    fs.statSync(path.join(apiPath, actualDoc)).size !== 0,\n+    `${actualDoc} is empty`\n+  );\n }"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 27,
        "deletions": 19
    }
}